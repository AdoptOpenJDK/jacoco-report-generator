<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BMPMetadata.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.imageio.plugins.bmp</a> &gt; <span class="el_source">BMPMetadata.java</span></div><h1>BMPMetadata.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, 2004, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.imageio.plugins.bmp;

import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import javax.imageio.ImageTypeSpecifier;
import javax.imageio.metadata.IIOMetadata;
import javax.imageio.metadata.IIOMetadataNode;
import javax.imageio.metadata.IIOMetadataFormat;
import javax.imageio.metadata.IIOMetadataFormatImpl;
import org.w3c.dom.Node;
import com.sun.imageio.plugins.common.I18N;

import com.sun.imageio.plugins.common.ImageUtil;

public class BMPMetadata extends IIOMetadata implements BMPConstants {
    public static final String nativeMetadataFormatName =
        &quot;javax_imageio_bmp_1.0&quot;;

    // Fields for Image Descriptor
    public String bmpVersion;
    public int width ;
    public int height;
    public short bitsPerPixel;
    public int compression;
    public int imageSize;

    // Fields for PixelsPerMeter
    public int xPixelsPerMeter;
    public int yPixelsPerMeter;

    public int colorsUsed;
    public int colorsImportant;

    // Fields for BI_BITFIELDS compression(Mask)
    public int redMask;
    public int greenMask;
    public int blueMask;
    public int alphaMask;

    public int colorSpace;

    // Fields for CIE XYZ for the LCS_CALIBRATED_RGB color space
    public double redX;
    public double redY;
    public double redZ;
    public double greenX;
    public double greenY;
    public double greenZ;
    public double blueX;
    public double blueY;
    public double blueZ;

    // Fields for Gamma values for the LCS_CALIBRATED_RGB color space
    public int gammaRed;
    public int gammaGreen;
    public int gammaBlue;

    public int intent;

    // Fields for the Palette and Entries
<span class="nc" id="L88">    public byte[] palette = null;</span>
    public int paletteSize;
    public int red;
    public int green;
    public int blue;

    // Fields from CommentExtension
    // List of byte[]
<span class="nc" id="L96">    public List comments = null; // new ArrayList();</span>

    public BMPMetadata() {
<span class="nc" id="L99">        super(true,</span>
              nativeMetadataFormatName,
              &quot;com.sun.imageio.plugins.bmp.BMPMetadataFormat&quot;,
              null, null);
<span class="nc" id="L103">    }</span>

    public boolean isReadOnly() {
<span class="nc" id="L106">        return true;</span>
    }

    public Node getAsTree(String formatName) {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (formatName.equals(nativeMetadataFormatName)) {</span>
<span class="nc" id="L111">            return getNativeTree();</span>
<span class="nc" id="L112">        } else if (formatName.equals</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                   (IIOMetadataFormatImpl.standardMetadataFormatName)) {</span>
<span class="nc" id="L114">            return getStandardTree();</span>
        } else {
<span class="nc" id="L116">            throw new IllegalArgumentException(I18N.getString(&quot;BMPMetadata0&quot;));</span>
        }
    }

    private String toISO8859(byte[] data) {
        try {
<span class="nc" id="L122">            return new String(data, &quot;ISO-8859-1&quot;);</span>
<span class="nc" id="L123">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L124">            return &quot;&quot;;</span>
        }
    }

    private Node getNativeTree() {
<span class="nc" id="L129">        IIOMetadataNode root =</span>
            new IIOMetadataNode(nativeMetadataFormatName);

<span class="nc" id="L132">        addChildNode(root, &quot;BMPVersion&quot;, bmpVersion);</span>
<span class="nc" id="L133">        addChildNode(root, &quot;Width&quot;, new Integer(width));</span>
<span class="nc" id="L134">        addChildNode(root, &quot;Height&quot;, new Integer(height));</span>
<span class="nc" id="L135">        addChildNode(root, &quot;BitsPerPixel&quot;, new Short(bitsPerPixel));</span>
<span class="nc" id="L136">        addChildNode(root, &quot;Compression&quot;, new Integer(compression));</span>
<span class="nc" id="L137">        addChildNode(root, &quot;ImageSize&quot;, new Integer(imageSize));</span>

<span class="nc" id="L139">        IIOMetadataNode node = addChildNode(root, &quot;PixelsPerMeter&quot;, null);</span>
<span class="nc" id="L140">        addChildNode(node, &quot;X&quot;, new Integer(xPixelsPerMeter));</span>
<span class="nc" id="L141">        addChildNode(node, &quot;Y&quot;, new Integer(yPixelsPerMeter));</span>

<span class="nc" id="L143">        addChildNode(root, &quot;ColorsUsed&quot;, new Integer(colorsUsed));</span>
<span class="nc" id="L144">        addChildNode(root, &quot;ColorsImportant&quot;, new Integer(colorsImportant));</span>

<span class="nc" id="L146">        int version = 0;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        for (int i = 0; i &lt; bmpVersion.length(); i++)</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">            if (Character.isDigit(bmpVersion.charAt(i)))</span>
<span class="nc" id="L149">                version = bmpVersion.charAt(i) -'0';</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (version &gt;= 4) {</span>
<span class="nc" id="L152">            node = addChildNode(root, &quot;Mask&quot;, null);</span>
<span class="nc" id="L153">            addChildNode(node, &quot;Red&quot;, new Integer(redMask));</span>
<span class="nc" id="L154">            addChildNode(node, &quot;Green&quot;, new Integer(greenMask));</span>
<span class="nc" id="L155">            addChildNode(node, &quot;Blue&quot;, new Integer(blueMask));</span>
<span class="nc" id="L156">            addChildNode(node, &quot;Alpha&quot;, new Integer(alphaMask));</span>

<span class="nc" id="L158">            addChildNode(root, &quot;ColorSpaceType&quot;, new Integer(colorSpace));</span>

<span class="nc" id="L160">            node = addChildNode(root, &quot;CIEXYZEndPoints&quot;, null);</span>
<span class="nc" id="L161">            addXYZPoints(node, &quot;Red&quot;, redX, redY, redZ);</span>
<span class="nc" id="L162">            addXYZPoints(node, &quot;Green&quot;, greenX, greenY, greenZ);</span>
<span class="nc" id="L163">            addXYZPoints(node, &quot;Blue&quot;, blueX, blueY, blueZ);</span>

<span class="nc" id="L165">            node = addChildNode(root, &quot;Intent&quot;, new Integer(intent));</span>
        }

        // Palette
<span class="nc bnc" id="L169" title="All 4 branches missed.">        if ((palette != null) &amp;&amp; (paletteSize &gt; 0)) {</span>
<span class="nc" id="L170">            node = addChildNode(root, &quot;Palette&quot;, null);</span>
<span class="nc" id="L171">            int numComps = palette.length / paletteSize;</span>

<span class="nc bnc" id="L173" title="All 2 branches missed.">            for (int i = 0, j = 0; i &lt; paletteSize; i++) {</span>
<span class="nc" id="L174">                IIOMetadataNode entry =</span>
<span class="nc" id="L175">                    addChildNode(node, &quot;PaletteEntry&quot;, null);</span>
<span class="nc" id="L176">                red = palette[j++] &amp; 0xff;</span>
<span class="nc" id="L177">                green = palette[j++] &amp; 0xff;</span>
<span class="nc" id="L178">                blue = palette[j++] &amp; 0xff;</span>
<span class="nc" id="L179">                addChildNode(entry, &quot;Red&quot;, new Byte((byte)red));</span>
<span class="nc" id="L180">                addChildNode(entry, &quot;Green&quot;, new Byte((byte)green));</span>
<span class="nc" id="L181">                addChildNode(entry, &quot;Blue&quot;, new Byte((byte)blue));</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                if (numComps == 4)</span>
<span class="nc" id="L183">                    addChildNode(entry, &quot;Alpha&quot;,</span>
                                 new Byte((byte)(palette[j++] &amp; 0xff)));
            }
        }

<span class="nc" id="L188">        return root;</span>
    }

    // Standard tree node methods
    protected IIOMetadataNode getStandardChromaNode() {

<span class="nc bnc" id="L194" title="All 4 branches missed.">        if ((palette != null) &amp;&amp; (paletteSize &gt; 0)) {</span>
<span class="nc" id="L195">            IIOMetadataNode node = new IIOMetadataNode(&quot;Chroma&quot;);</span>
<span class="nc" id="L196">            IIOMetadataNode subNode = new IIOMetadataNode(&quot;Palette&quot;);</span>
<span class="nc" id="L197">            int numComps = palette.length / paletteSize;</span>
<span class="nc" id="L198">            subNode.setAttribute(&quot;value&quot;, &quot;&quot; + numComps);</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">            for (int i = 0, j = 0; i &lt; paletteSize; i++) {</span>
<span class="nc" id="L201">                IIOMetadataNode subNode1 = new IIOMetadataNode(&quot;PaletteEntry&quot;);</span>
<span class="nc" id="L202">                subNode1.setAttribute(&quot;index&quot;, &quot;&quot;+i);</span>
<span class="nc" id="L203">                subNode1.setAttribute(&quot;red&quot;, &quot;&quot; + palette[j++]);</span>
<span class="nc" id="L204">                subNode1.setAttribute(&quot;green&quot;, &quot;&quot; + palette[j++]);</span>
<span class="nc" id="L205">                subNode1.setAttribute(&quot;blue&quot;, &quot;&quot; + palette[j++]);</span>
<span class="nc bnc" id="L206" title="All 4 branches missed.">                if (numComps == 4 &amp;&amp; palette[j] != 0)</span>
<span class="nc" id="L207">                    subNode1.setAttribute(&quot;alpha&quot;, &quot;&quot; + palette[j++]);</span>
<span class="nc" id="L208">                subNode.appendChild(subNode1);</span>
            }
<span class="nc" id="L210">            node.appendChild(subNode);</span>
<span class="nc" id="L211">            return node;</span>
        }

<span class="nc" id="L214">        return null;</span>
    }

    protected IIOMetadataNode getStandardCompressionNode() {
<span class="nc" id="L218">        IIOMetadataNode node = new IIOMetadataNode(&quot;Compression&quot;);</span>

        // CompressionTypeName
<span class="nc" id="L221">        IIOMetadataNode subNode = new IIOMetadataNode(&quot;CompressionTypeName&quot;);</span>
<span class="nc" id="L222">        subNode.setAttribute(&quot;value&quot;, BMPCompressionTypes.getName(compression));</span>
<span class="nc" id="L223">        node.appendChild(subNode);</span>
<span class="nc" id="L224">        return node;</span>
    }

    protected IIOMetadataNode getStandardDataNode() {
<span class="nc" id="L228">        IIOMetadataNode node = new IIOMetadataNode(&quot;Data&quot;);</span>

<span class="nc" id="L230">        String bits = &quot;&quot;;</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (bitsPerPixel == 24)</span>
<span class="nc" id="L232">            bits = &quot;8 8 8 &quot;;</span>
<span class="nc bnc" id="L233" title="All 4 branches missed.">        else if (bitsPerPixel == 16 || bitsPerPixel == 32) {</span>
<span class="nc" id="L234">            bits = &quot;&quot; + countBits(redMask) + &quot; &quot; + countBits(greenMask) +</span>
<span class="nc" id="L235">                  countBits(blueMask) + &quot;&quot; + countBits(alphaMask);</span>
        }

<span class="nc" id="L238">        IIOMetadataNode subNode = new IIOMetadataNode(&quot;BitsPerSample&quot;);</span>
<span class="nc" id="L239">        subNode.setAttribute(&quot;value&quot;, bits);</span>
<span class="nc" id="L240">        node.appendChild(subNode);</span>

<span class="nc" id="L242">        return node;</span>
    }

    protected IIOMetadataNode getStandardDimensionNode() {
<span class="nc bnc" id="L246" title="All 4 branches missed.">        if (yPixelsPerMeter &gt; 0.0F &amp;&amp; xPixelsPerMeter &gt; 0.0F) {</span>
<span class="nc" id="L247">            IIOMetadataNode node = new IIOMetadataNode(&quot;Dimension&quot;);</span>
<span class="nc" id="L248">            float ratio = yPixelsPerMeter / xPixelsPerMeter;</span>
<span class="nc" id="L249">            IIOMetadataNode subNode = new IIOMetadataNode(&quot;PixelAspectRatio&quot;);</span>
<span class="nc" id="L250">            subNode.setAttribute(&quot;value&quot;, &quot;&quot; + ratio);</span>
<span class="nc" id="L251">            node.appendChild(subNode);</span>

<span class="nc" id="L253">            subNode = new IIOMetadataNode(&quot;HorizontalPhysicalPixelSpacing&quot;);</span>
<span class="nc" id="L254">            subNode.setAttribute(&quot;value&quot;, &quot;&quot; + (1 / xPixelsPerMeter * 1000));</span>
<span class="nc" id="L255">            node.appendChild(subNode);</span>

<span class="nc" id="L257">            subNode = new IIOMetadataNode(&quot;VerticalPhysicalPixelSpacing&quot;);</span>
<span class="nc" id="L258">            subNode.setAttribute(&quot;value&quot;, &quot;&quot; + (1 / yPixelsPerMeter * 1000));</span>
<span class="nc" id="L259">            node.appendChild(subNode);</span>

<span class="nc" id="L261">            return node;</span>
        }
<span class="nc" id="L263">        return null;</span>
    }

    public void setFromTree(String formatName, Node root) {
<span class="nc" id="L267">        throw new IllegalStateException(I18N.getString(&quot;BMPMetadata1&quot;));</span>
    }

    public void mergeTree(String formatName, Node root) {
<span class="nc" id="L271">        throw new IllegalStateException(I18N.getString(&quot;BMPMetadata1&quot;));</span>
    }

    public void reset() {
<span class="nc" id="L275">        throw new IllegalStateException(I18N.getString(&quot;BMPMetadata1&quot;));</span>
    }

    private String countBits(int num) {
<span class="nc" id="L279">        int count = 0;</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        while(num &gt; 0) {</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            if ((num &amp; 1) == 1)</span>
<span class="nc" id="L282">                count++;</span>
<span class="nc" id="L283">            num &gt;&gt;&gt;= 1;</span>
        }

<span class="nc bnc" id="L286" title="All 2 branches missed.">        return count == 0 ? &quot;&quot; : &quot;&quot; + count;</span>
    }

    private void addXYZPoints(IIOMetadataNode root, String name, double x, double y, double z) {
<span class="nc" id="L290">        IIOMetadataNode node = addChildNode(root, name, null);</span>
<span class="nc" id="L291">        addChildNode(node, &quot;X&quot;, new Double(x));</span>
<span class="nc" id="L292">        addChildNode(node, &quot;Y&quot;, new Double(y));</span>
<span class="nc" id="L293">        addChildNode(node, &quot;Z&quot;, new Double(z));</span>
<span class="nc" id="L294">    }</span>

    private IIOMetadataNode addChildNode(IIOMetadataNode root,
                                         String name,
                                         Object object) {
<span class="nc" id="L299">        IIOMetadataNode child = new IIOMetadataNode(name);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (object != null) {</span>
<span class="nc" id="L301">            child.setUserObject(object);</span>
<span class="nc" id="L302">            child.setNodeValue(ImageUtil.convertObjectToString(object));</span>
        }
<span class="nc" id="L304">        root.appendChild(child);</span>
<span class="nc" id="L305">        return child;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>