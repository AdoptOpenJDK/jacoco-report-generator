<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>RegistryContextFactory.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.jndi.rmi.registry</a> &gt; <span class="el_source">RegistryContextFactory.java</span></div><h1>RegistryContextFactory.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.jndi.rmi.registry;


import java.util.Enumeration;
import java.util.Hashtable;

import javax.naming.*;
import javax.naming.spi.*;

import com.sun.jndi.url.rmi.rmiURLContextFactory;

/**
 * A RegistryContextFactory takes an RMI registry reference, and
 * creates the corresponding RMI object or registry context.  In
 * addition, it serves as the initial context factory when using an
 * RMI registry as an initial context.
 *&lt;p&gt;
 * When an initial context is being created, the environment
 * property &quot;java.naming.provider.url&quot; should contain the RMI URL of
 * the appropriate registry.  Otherwise, the default URL &quot;rmi:&quot; is used.
 *&lt;p&gt;
 * An RMI registry reference contains one or more StringRefAddrs of
 * type &quot;URL&quot;, each containing a single RMI URL.  Other addresses
 * are ignored.  Multiple URLs represent alternative addresses for the
 * same logical resource.  The order of the addresses is not significant.
 *
 * @author Scott Seligman
 */


<span class="nc" id="L56">public class RegistryContextFactory</span>
        implements ObjectFactory, InitialContextFactory
{
    /**
     * The type of each address in an RMI registry reference.
     */
    public final static String ADDRESS_TYPE = &quot;URL&quot;;

    public Context getInitialContext(Hashtable&lt;?,?&gt; env) throws NamingException {

<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (env != null) {</span>
<span class="nc" id="L67">            env = (Hashtable) env.clone();</span>
        }
<span class="nc" id="L69">        return URLToContext(getInitCtxURL(env), env);</span>
    }

    public Object getObjectInstance(Object ref, Name name, Context nameCtx,
                                    Hashtable&lt;?,?&gt; env)
            throws NamingException
    {
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (!isRegistryRef(ref)) {</span>
<span class="nc" id="L77">            return null;</span>
        }
        /*
         * No need to clone env here.  If getObjectInstance()
         * returns something other than a RegistryContext (which
         * happens if you're looking up an object bound in the
         * registry, as opposed to looking up the registry itself),
         * then the context is GCed right away and there's no need to
         * clone the environment.  If getObjectInstance() returns a
         * RegistryContext, then it still goes through
         * GenericURLContext, which calls RegistryContext.lookup()
         * with an empty name, which clones the environment.
         */
<span class="nc" id="L90">        Object obj = URLsToObject(getURLs((Reference)ref), env);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (obj instanceof RegistryContext) {</span>
<span class="nc" id="L92">            RegistryContext ctx = (RegistryContext)obj;</span>
<span class="nc" id="L93">            ctx.reference = (Reference)ref;</span>
        }
<span class="nc" id="L95">        return obj;</span>
    }

    private static Context URLToContext(String url, Hashtable&lt;?,?&gt; env)
            throws NamingException
    {
<span class="nc" id="L101">        rmiURLContextFactory factory = new rmiURLContextFactory();</span>
<span class="nc" id="L102">        Object obj = factory.getObjectInstance(url, null, null, env);</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (obj instanceof Context) {</span>
<span class="nc" id="L105">            return (Context)obj;</span>
        } else {
<span class="nc" id="L107">            throw (new NotContextException(url));</span>
        }
    }

    private static Object URLsToObject(String[] urls, Hashtable&lt;?,?&gt; env)
            throws NamingException
    {
<span class="nc" id="L114">        rmiURLContextFactory factory = new rmiURLContextFactory();</span>
<span class="nc" id="L115">        return factory.getObjectInstance(urls, null, null, env);</span>
    }

    /**
     * Reads environment to find URL of initial context.
     * The default URL is &quot;rmi:&quot;.
     */
    private static String getInitCtxURL(Hashtable&lt;?,?&gt; env) {

        final String defaultURL = &quot;rmi:&quot;;

<span class="nc" id="L126">        String url = null;</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (env != null) {</span>
<span class="nc" id="L128">            url = (String)env.get(Context.PROVIDER_URL);</span>
        }
<span class="nc bnc" id="L130" title="All 2 branches missed.">        return ((url != null) ? url : defaultURL);</span>
    }

    /**
     * Returns true if argument is an RMI registry reference.
     */
    private static boolean isRegistryRef(Object obj) {

<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (!(obj instanceof Reference)) {</span>
<span class="nc" id="L139">            return false;</span>
        }
<span class="nc" id="L141">        String thisClassName = RegistryContextFactory.class.getName();</span>
<span class="nc" id="L142">        Reference ref = (Reference)obj;</span>

<span class="nc" id="L144">        return thisClassName.equals(ref.getFactoryClassName());</span>
    }

    /**
     * Returns the URLs contained within an RMI registry reference.
     */
    private static String[] getURLs(Reference ref) throws NamingException {

<span class="nc" id="L152">        int size = 0;   // number of URLs</span>
<span class="nc" id="L153">        String[] urls = new String[ref.size()];</span>

<span class="nc" id="L155">        Enumeration&lt;RefAddr&gt; addrs = ref.getAll();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        while (addrs.hasMoreElements()) {</span>
<span class="nc" id="L157">            RefAddr addr = addrs.nextElement();</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">            if ((addr instanceof StringRefAddr) &amp;&amp;</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                addr.getType().equals(ADDRESS_TYPE)) {</span>

<span class="nc" id="L162">                urls[size++] = (String)addr.getContent();</span>
            }
<span class="nc" id="L164">        }</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (size == 0) {</span>
<span class="nc" id="L166">            throw (new ConfigurationException(</span>
                    &quot;Reference contains no valid addresses&quot;));
        }

        // Trim URL array down to size.
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (size == ref.size()) {</span>
<span class="nc" id="L172">            return urls;</span>
        }
<span class="nc" id="L174">        String[] urls2 = new String[size];</span>
<span class="nc" id="L175">        System.arraycopy(urls, 0, urls2, 0, size);</span>
<span class="nc" id="L176">        return urls2;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>