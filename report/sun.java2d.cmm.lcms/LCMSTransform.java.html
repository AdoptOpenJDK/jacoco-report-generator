<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>LCMSTransform.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.java2d.cmm.lcms</a> &gt; <span class="el_source">LCMSTransform.java</span></div><h1>LCMSTransform.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

/**********************************************************************
 **********************************************************************
 **********************************************************************
 *** COPYRIGHT (c) Eastman Kodak Company, 1997                      ***
 *** As  an unpublished  work pursuant to Title 17 of the United    ***
 *** States Code.  All rights reserved.                             ***
 **********************************************************************
 **********************************************************************
 **********************************************************************/

package sun.java2d.cmm.lcms;

import java.awt.color.ICC_Profile;
import java.awt.color.ProfileDataException;
import java.awt.color.CMMException;
import java.awt.color.ColorSpace;
import java.awt.image.BufferedImage;
import java.awt.image.Raster;
import java.awt.image.WritableRaster;
import java.awt.image.ColorModel;
import java.awt.image.DirectColorModel;
import java.awt.image.ComponentColorModel;
import java.awt.image.SampleModel;
import java.awt.image.DataBuffer;
import java.awt.image.SinglePixelPackedSampleModel;
import java.awt.image.ComponentSampleModel;
import sun.java2d.cmm.*;
import sun.java2d.cmm.lcms.*;
import static sun.java2d.cmm.lcms.LCMSImageLayout.ImageLayoutException;


public class LCMSTransform implements ColorTransform {
    long ID;
<span class="nc" id="L59">    private int inFormatter = 0;</span>
<span class="nc" id="L60">    private boolean isInIntPacked = false;</span>
<span class="nc" id="L61">    private int outFormatter = 0;</span>
<span class="nc" id="L62">    private boolean isOutIntPacked = false;</span>

    ICC_Profile[] profiles;
    LCMSProfile[] lcmsProfiles;
    int renderType;
    int transformType;

<span class="nc" id="L69">    private int numInComponents = -1;</span>
<span class="nc" id="L70">    private int numOutComponents = -1;</span>

<span class="nc" id="L72">    private Object disposerReferent = new Object();</span>

    /* the class initializer */
    static {
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (ProfileDeferralMgr.deferring) {</span>
<span class="nc" id="L77">            ProfileDeferralMgr.activateProfiles();</span>
        }
<span class="nc" id="L79">    }</span>

    public LCMSTransform(ICC_Profile profile, int renderType,
                         int transformType)
<span class="nc" id="L83">    {</span>
        /* Actually, it is not a complete transform but just part of it */
<span class="nc" id="L85">        profiles = new ICC_Profile[1];</span>
<span class="nc" id="L86">        profiles[0] = profile;</span>
<span class="nc" id="L87">        lcmsProfiles = new LCMSProfile[1];</span>
<span class="nc" id="L88">        lcmsProfiles[0] = LCMS.getProfileID(profile);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        this.renderType = (renderType == ColorTransform.Any)?</span>
                              ICC_Profile.icPerceptual : renderType;
<span class="nc" id="L91">        this.transformType = transformType;</span>

        /* Note that ICC_Profile.getNumComponents() is quite expensive
         * (it may results in a reading of the profile header).
         * So, here we cache the number of components of input and
         * output profiles for further usage.
         */
<span class="nc" id="L98">        numInComponents = profiles[0].getNumComponents();</span>
<span class="nc" id="L99">        numOutComponents = profiles[profiles.length - 1].getNumComponents();</span>
<span class="nc" id="L100">    }</span>

<span class="nc" id="L102">    public LCMSTransform (ColorTransform[] transforms) {</span>
<span class="nc" id="L103">        int size = 0;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        for (int i=0; i &lt; transforms.length; i++) {</span>
<span class="nc" id="L105">            size+=((LCMSTransform)transforms[i]).profiles.length;</span>
        }
<span class="nc" id="L107">        profiles = new ICC_Profile[size];</span>
<span class="nc" id="L108">        lcmsProfiles = new LCMSProfile[size];</span>
<span class="nc" id="L109">        int j = 0;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        for (int i=0; i &lt; transforms.length; i++) {</span>
<span class="nc" id="L111">            LCMSTransform curTrans = (LCMSTransform)transforms[i];</span>
<span class="nc" id="L112">            System.arraycopy(curTrans.profiles, 0, profiles, j,</span>
                             curTrans.profiles.length);
<span class="nc" id="L114">            System.arraycopy(curTrans.lcmsProfiles, 0, lcmsProfiles, j,</span>
                             curTrans.lcmsProfiles.length);
<span class="nc" id="L116">            j += curTrans.profiles.length;</span>
        }
<span class="nc" id="L118">        renderType = ((LCMSTransform)transforms[0]).renderType;</span>

        /* Note that ICC_Profile.getNumComponents() is quite expensive
         * (it may results in a reading of the profile header).
         * So, here we cache the number of components of input and
         * output profiles for further usage.
         */
<span class="nc" id="L125">        numInComponents = profiles[0].getNumComponents();</span>
<span class="nc" id="L126">        numOutComponents = profiles[profiles.length - 1].getNumComponents();</span>
<span class="nc" id="L127">    }</span>

    public int getNumInComponents() {
<span class="nc" id="L130">        return numInComponents;</span>
    }

    public int getNumOutComponents() {
<span class="nc" id="L134">        return numOutComponents;</span>
    }

    private synchronized void doTransform(LCMSImageLayout in,
                                          LCMSImageLayout out) {
        // update native transfrom if needed
<span class="nc bnc" id="L140" title="All 10 branches missed.">        if (ID == 0L ||</span>
            inFormatter != in.pixelType || isInIntPacked != in.isIntPacked ||
            outFormatter != out.pixelType || isOutIntPacked != out.isIntPacked)
        {

<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (ID != 0L) {</span>
                // Disposer will destroy forgotten transform
<span class="nc" id="L147">                disposerReferent = new Object();</span>
            }
<span class="nc" id="L149">            inFormatter = in.pixelType;</span>
<span class="nc" id="L150">            isInIntPacked = in.isIntPacked;</span>

<span class="nc" id="L152">            outFormatter = out.pixelType;</span>
<span class="nc" id="L153">            isOutIntPacked = out.isIntPacked;</span>

<span class="nc" id="L155">            ID = LCMS.createTransform(lcmsProfiles, renderType,</span>
                                            inFormatter, isInIntPacked,
                                            outFormatter, isOutIntPacked,
                                            disposerReferent);
        }

<span class="nc" id="L161">        LCMS.colorConvert(this, in, out);</span>
<span class="nc" id="L162">    }</span>

    public void colorConvert(BufferedImage src, BufferedImage dst) {
        LCMSImageLayout srcIL, dstIL;
        try {
<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (!dst.getColorModel().hasAlpha()) {</span>
<span class="nc" id="L168">                dstIL = LCMSImageLayout.createImageLayout(dst);</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">                if (dstIL != null) {</span>
<span class="nc" id="L171">                    srcIL = LCMSImageLayout.createImageLayout(src);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                    if (srcIL != null) {</span>
<span class="nc" id="L173">                        doTransform(srcIL, dstIL);</span>
<span class="nc" id="L174">                        return;</span>
                    }
                }
            }
<span class="nc" id="L178">        }  catch (ImageLayoutException e) {</span>
<span class="nc" id="L179">            throw new CMMException(&quot;Unable to convert images&quot;);</span>
<span class="nc" id="L180">        }</span>

<span class="nc" id="L182">        Raster srcRas = src.getRaster();</span>
<span class="nc" id="L183">        WritableRaster dstRas = dst.getRaster();</span>
<span class="nc" id="L184">        ColorModel srcCM = src.getColorModel();</span>
<span class="nc" id="L185">        ColorModel dstCM = dst.getColorModel();</span>
<span class="nc" id="L186">        int w = src.getWidth();</span>
<span class="nc" id="L187">        int h = src.getHeight();</span>
<span class="nc" id="L188">        int srcNumComp = srcCM.getNumColorComponents();</span>
<span class="nc" id="L189">        int dstNumComp = dstCM.getNumColorComponents();</span>
<span class="nc" id="L190">        int precision = 8;</span>
<span class="nc" id="L191">        float maxNum = 255.0f;</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        for (int i = 0; i &lt; srcNumComp; i++) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (srcCM.getComponentSize(i) &gt; 8) {</span>
<span class="nc" id="L194">                 precision = 16;</span>
<span class="nc" id="L195">                 maxNum = 65535.0f;</span>
             }
        }
<span class="nc bnc" id="L198" title="All 2 branches missed.">        for (int i = 0; i &lt; dstNumComp; i++) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if (dstCM.getComponentSize(i) &gt; 8) {</span>
<span class="nc" id="L200">                 precision = 16;</span>
<span class="nc" id="L201">                 maxNum = 65535.0f;</span>
             }
        }
<span class="nc" id="L204">        float[] srcMinVal = new float[srcNumComp];</span>
<span class="nc" id="L205">        float[] srcInvDiffMinMax = new float[srcNumComp];</span>
<span class="nc" id="L206">        ColorSpace cs = srcCM.getColorSpace();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        for (int i = 0; i &lt; srcNumComp; i++) {</span>
<span class="nc" id="L208">            srcMinVal[i] = cs.getMinValue(i);</span>
<span class="nc" id="L209">            srcInvDiffMinMax[i] = maxNum / (cs.getMaxValue(i) - srcMinVal[i]);</span>
        }
<span class="nc" id="L211">        cs = dstCM.getColorSpace();</span>
<span class="nc" id="L212">        float[] dstMinVal = new float[dstNumComp];</span>
<span class="nc" id="L213">        float[] dstDiffMinMax = new float[dstNumComp];</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        for (int i = 0; i &lt; dstNumComp; i++) {</span>
<span class="nc" id="L215">            dstMinVal[i] = cs.getMinValue(i);</span>
<span class="nc" id="L216">            dstDiffMinMax[i] = (cs.getMaxValue(i) - dstMinVal[i]) / maxNum;</span>
        }
<span class="nc" id="L218">        boolean dstHasAlpha = dstCM.hasAlpha();</span>
<span class="nc bnc" id="L219" title="All 4 branches missed.">        boolean needSrcAlpha = srcCM.hasAlpha() &amp;&amp; dstHasAlpha;</span>
        float[] dstColor;
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (dstHasAlpha) {</span>
<span class="nc" id="L222">            dstColor = new float[dstNumComp + 1];</span>
        } else {
<span class="nc" id="L224">            dstColor = new float[dstNumComp];</span>
        }
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (precision == 8) {</span>
<span class="nc" id="L227">            byte[] srcLine = new byte[w * srcNumComp];</span>
<span class="nc" id="L228">            byte[] dstLine = new byte[w * dstNumComp];</span>
            Object pixel;
            float[] color;
<span class="nc" id="L231">            float[] alpha = null;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (needSrcAlpha) {</span>
<span class="nc" id="L233">                alpha = new float[w];</span>
            }
            int idx;
            // TODO check for src npixels = dst npixels
            try {
<span class="nc" id="L238">                srcIL = new LCMSImageLayout(</span>
<span class="nc" id="L239">                        srcLine, srcLine.length/getNumInComponents(),</span>
<span class="nc" id="L240">                        LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |</span>
<span class="nc" id="L241">                        LCMSImageLayout.BYTES_SH(1), getNumInComponents());</span>
<span class="nc" id="L242">                dstIL = new LCMSImageLayout(</span>
<span class="nc" id="L243">                        dstLine, dstLine.length/getNumOutComponents(),</span>
<span class="nc" id="L244">                        LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |</span>
<span class="nc" id="L245">                        LCMSImageLayout.BYTES_SH(1), getNumOutComponents());</span>
<span class="nc" id="L246">            } catch (ImageLayoutException e) {</span>
<span class="nc" id="L247">                throw new CMMException(&quot;Unable to convert images&quot;);</span>
<span class="nc" id="L248">            }</span>
            // process each scanline
<span class="nc bnc" id="L250" title="All 2 branches missed.">            for (int y = 0; y &lt; h; y++) {</span>
                // convert src scanline
<span class="nc" id="L252">                pixel = null;</span>
<span class="nc" id="L253">                color = null;</span>
<span class="nc" id="L254">                idx = 0;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                for (int x = 0; x &lt; w; x++) {</span>
<span class="nc" id="L256">                    pixel = srcRas.getDataElements(x, y, pixel);</span>
<span class="nc" id="L257">                    color = srcCM.getNormalizedComponents(pixel, color, 0);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                    for (int i = 0; i &lt; srcNumComp; i++) {</span>
<span class="nc" id="L259">                        srcLine[idx++] = (byte)</span>
                            ((color[i] - srcMinVal[i]) * srcInvDiffMinMax[i] +
                             0.5f);
                    }
<span class="nc bnc" id="L263" title="All 2 branches missed.">                    if (needSrcAlpha) {</span>
<span class="nc" id="L264">                        alpha[x] = color[srcNumComp];</span>
                    }
                }
                // color convert srcLine to dstLine
<span class="nc" id="L268">                doTransform(srcIL, dstIL);</span>

                // convert dst scanline
<span class="nc" id="L271">                pixel = null;</span>
<span class="nc" id="L272">                idx = 0;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                for (int x = 0; x &lt; w; x++) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                    for (int i = 0; i &lt; dstNumComp; i++) {</span>
<span class="nc" id="L275">                        dstColor[i] = ((float) (dstLine[idx++] &amp; 0xff)) *</span>
                                      dstDiffMinMax[i] + dstMinVal[i];
                    }
<span class="nc bnc" id="L278" title="All 2 branches missed.">                    if (needSrcAlpha) {</span>
<span class="nc" id="L279">                        dstColor[dstNumComp] = alpha[x];</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">                    } else if (dstHasAlpha) {</span>
<span class="nc" id="L281">                        dstColor[dstNumComp] = 1.0f;</span>
                    }
<span class="nc" id="L283">                    pixel = dstCM.getDataElements(dstColor, 0, pixel);</span>
<span class="nc" id="L284">                    dstRas.setDataElements(x, y, pixel);</span>
                }
            }
<span class="nc" id="L287">        } else {</span>
<span class="nc" id="L288">            short[] srcLine = new short[w * srcNumComp];</span>
<span class="nc" id="L289">            short[] dstLine = new short[w * dstNumComp];</span>
            Object pixel;
            float[] color;
<span class="nc" id="L292">            float[] alpha = null;</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (needSrcAlpha) {</span>
<span class="nc" id="L294">                alpha = new float[w];</span>
            }
            int idx;
            try {
<span class="nc" id="L298">                srcIL = new LCMSImageLayout(</span>
<span class="nc" id="L299">                    srcLine, srcLine.length/getNumInComponents(),</span>
<span class="nc" id="L300">                    LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |</span>
<span class="nc" id="L301">                    LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);</span>

<span class="nc" id="L303">                dstIL = new LCMSImageLayout(</span>
<span class="nc" id="L304">                    dstLine, dstLine.length/getNumOutComponents(),</span>
<span class="nc" id="L305">                    LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |</span>
<span class="nc" id="L306">                    LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);</span>
<span class="nc" id="L307">            } catch (ImageLayoutException e) {</span>
<span class="nc" id="L308">                throw new CMMException(&quot;Unable to convert images&quot;);</span>
<span class="nc" id="L309">            }</span>
            // process each scanline
<span class="nc bnc" id="L311" title="All 2 branches missed.">            for (int y = 0; y &lt; h; y++) {</span>
                // convert src scanline
<span class="nc" id="L313">                pixel = null;</span>
<span class="nc" id="L314">                color = null;</span>
<span class="nc" id="L315">                idx = 0;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                for (int x = 0; x &lt; w; x++) {</span>
<span class="nc" id="L317">                    pixel = srcRas.getDataElements(x, y, pixel);</span>
<span class="nc" id="L318">                    color = srcCM.getNormalizedComponents(pixel, color, 0);</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                    for (int i = 0; i &lt; srcNumComp; i++) {</span>
<span class="nc" id="L320">                        srcLine[idx++] = (short)</span>
                            ((color[i] - srcMinVal[i]) * srcInvDiffMinMax[i] +
                             0.5f);
                    }
<span class="nc bnc" id="L324" title="All 2 branches missed.">                    if (needSrcAlpha) {</span>
<span class="nc" id="L325">                        alpha[x] = color[srcNumComp];</span>
                    }
                }
                // color convert srcLine to dstLine
<span class="nc" id="L329">                doTransform(srcIL, dstIL);</span>

                // convert dst scanline
<span class="nc" id="L332">                pixel = null;</span>
<span class="nc" id="L333">                idx = 0;</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">                for (int x = 0; x &lt; w; x++) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">                    for (int i = 0; i &lt; dstNumComp; i++) {</span>
<span class="nc" id="L336">                        dstColor[i] = ((float) (dstLine[idx++] &amp; 0xffff)) *</span>
                                      dstDiffMinMax[i] + dstMinVal[i];
                    }
<span class="nc bnc" id="L339" title="All 2 branches missed.">                    if (needSrcAlpha) {</span>
<span class="nc" id="L340">                        dstColor[dstNumComp] = alpha[x];</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">                    } else if (dstHasAlpha) {</span>
<span class="nc" id="L342">                        dstColor[dstNumComp] = 1.0f;</span>
                    }
<span class="nc" id="L344">                    pixel = dstCM.getDataElements(dstColor, 0, pixel);</span>
<span class="nc" id="L345">                    dstRas.setDataElements(x, y, pixel);</span>
                }
            }
        }
<span class="nc" id="L349">    }</span>

    public void colorConvert(Raster src, WritableRaster dst,
                             float[] srcMinVal, float[]srcMaxVal,
                             float[] dstMinVal, float[]dstMaxVal) {
        LCMSImageLayout srcIL, dstIL;

        // Can't pass src and dst directly to CMM, so process per scanline
<span class="nc" id="L357">        SampleModel srcSM = src.getSampleModel();</span>
<span class="nc" id="L358">        SampleModel dstSM = dst.getSampleModel();</span>
<span class="nc" id="L359">        int srcTransferType = src.getTransferType();</span>
<span class="nc" id="L360">        int dstTransferType = dst.getTransferType();</span>
        boolean srcIsFloat, dstIsFloat;
<span class="nc bnc" id="L362" title="All 4 branches missed.">        if ((srcTransferType == DataBuffer.TYPE_FLOAT) ||</span>
            (srcTransferType == DataBuffer.TYPE_DOUBLE)) {
<span class="nc" id="L364">            srcIsFloat = true;</span>
        } else {
<span class="nc" id="L366">            srcIsFloat = false;</span>
        }
<span class="nc bnc" id="L368" title="All 4 branches missed.">        if ((dstTransferType == DataBuffer.TYPE_FLOAT) ||</span>
            (dstTransferType == DataBuffer.TYPE_DOUBLE)) {
<span class="nc" id="L370">            dstIsFloat = true;</span>
        } else {
<span class="nc" id="L372">            dstIsFloat = false;</span>
        }
<span class="nc" id="L374">        int w = src.getWidth();</span>
<span class="nc" id="L375">        int h = src.getHeight();</span>
<span class="nc" id="L376">        int srcNumBands = src.getNumBands();</span>
<span class="nc" id="L377">        int dstNumBands = dst.getNumBands();</span>
<span class="nc" id="L378">        float[] srcScaleFactor = new float[srcNumBands];</span>
<span class="nc" id="L379">        float[] dstScaleFactor = new float[dstNumBands];</span>
<span class="nc" id="L380">        float[] srcUseMinVal = new float[srcNumBands];</span>
<span class="nc" id="L381">        float[] dstUseMinVal = new float[dstNumBands];</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">        for (int i = 0; i &lt; srcNumBands; i++) {</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            if (srcIsFloat) {</span>
<span class="nc" id="L384">                srcScaleFactor[i] =  65535.0f / (srcMaxVal[i] - srcMinVal[i]);</span>
<span class="nc" id="L385">                srcUseMinVal[i] = srcMinVal[i];</span>
            } else {
<span class="nc bnc" id="L387" title="All 2 branches missed.">                if (srcTransferType == DataBuffer.TYPE_SHORT) {</span>
<span class="nc" id="L388">                    srcScaleFactor[i] = 65535.0f / 32767.0f;</span>
                } else {
<span class="nc" id="L390">                    srcScaleFactor[i] = 65535.0f /</span>
<span class="nc" id="L391">                        ((float) ((1 &lt;&lt; srcSM.getSampleSize(i)) - 1));</span>
                }
<span class="nc" id="L393">                srcUseMinVal[i] = 0.0f;</span>
            }
        }
<span class="nc bnc" id="L396" title="All 2 branches missed.">        for (int i = 0; i &lt; dstNumBands; i++) {</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">            if (dstIsFloat) {</span>
<span class="nc" id="L398">                dstScaleFactor[i] = (dstMaxVal[i] - dstMinVal[i]) / 65535.0f;</span>
<span class="nc" id="L399">                dstUseMinVal[i] = dstMinVal[i];</span>
            } else {
<span class="nc bnc" id="L401" title="All 2 branches missed.">                if (dstTransferType == DataBuffer.TYPE_SHORT) {</span>
<span class="nc" id="L402">                    dstScaleFactor[i] = 32767.0f / 65535.0f;</span>
                } else {
<span class="nc" id="L404">                    dstScaleFactor[i] =</span>
<span class="nc" id="L405">                        ((float) ((1 &lt;&lt; dstSM.getSampleSize(i)) - 1)) /</span>
                        65535.0f;
                }
<span class="nc" id="L408">                dstUseMinVal[i] = 0.0f;</span>
            }
        }
<span class="nc" id="L411">        int ys = src.getMinY();</span>
<span class="nc" id="L412">        int yd = dst.getMinY();</span>
        int xs, xd;
        float sample;
<span class="nc" id="L415">        short[] srcLine = new short[w * srcNumBands];</span>
<span class="nc" id="L416">        short[] dstLine = new short[w * dstNumBands];</span>
        int idx;
        try {
<span class="nc" id="L419">            srcIL = new LCMSImageLayout(</span>
<span class="nc" id="L420">                    srcLine, srcLine.length/getNumInComponents(),</span>
<span class="nc" id="L421">                    LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |</span>
<span class="nc" id="L422">                    LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);</span>

<span class="nc" id="L424">            dstIL = new LCMSImageLayout(</span>
<span class="nc" id="L425">                    dstLine, dstLine.length/getNumOutComponents(),</span>
<span class="nc" id="L426">                    LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |</span>
<span class="nc" id="L427">                    LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);</span>
<span class="nc" id="L428">        } catch (ImageLayoutException e) {</span>
<span class="nc" id="L429">            throw new CMMException(&quot;Unable to convert rasters&quot;);</span>
<span class="nc" id="L430">        }</span>
        // process each scanline
<span class="nc bnc" id="L432" title="All 2 branches missed.">        for (int y = 0; y &lt; h; y++, ys++, yd++) {</span>
            // get src scanline
<span class="nc" id="L434">            xs = src.getMinX();</span>
<span class="nc" id="L435">            idx = 0;</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">            for (int x = 0; x &lt; w; x++, xs++) {</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">                for (int i = 0; i &lt; srcNumBands; i++) {</span>
<span class="nc" id="L438">                    sample = src.getSampleFloat(xs, ys, i);</span>
<span class="nc" id="L439">                    srcLine[idx++] = (short)</span>
                        ((sample - srcUseMinVal[i]) * srcScaleFactor[i] + 0.5f);
                }
            }

            // color convert srcLine to dstLine
<span class="nc" id="L445">            doTransform(srcIL, dstIL);</span>

            // store dst scanline
<span class="nc" id="L448">            xd = dst.getMinX();</span>
<span class="nc" id="L449">            idx = 0;</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">            for (int x = 0; x &lt; w; x++, xd++) {</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">                for (int i = 0; i &lt; dstNumBands; i++) {</span>
<span class="nc" id="L452">                    sample = ((dstLine[idx++] &amp; 0xffff) * dstScaleFactor[i]) +</span>
                             dstUseMinVal[i];
<span class="nc" id="L454">                    dst.setSample(xd, yd, i, sample);</span>
                }
            }
        }
<span class="nc" id="L458">    }</span>

    public void colorConvert(Raster src, WritableRaster dst) {

        LCMSImageLayout srcIL, dstIL;
<span class="nc" id="L463">        dstIL = LCMSImageLayout.createImageLayout(dst);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (dstIL != null) {</span>
<span class="nc" id="L465">            srcIL = LCMSImageLayout.createImageLayout(src);</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">            if (srcIL != null) {</span>
<span class="nc" id="L467">                doTransform(srcIL, dstIL);</span>
<span class="nc" id="L468">                return;</span>
            }
        }
        // Can't pass src and dst directly to CMM, so process per scanline
<span class="nc" id="L472">        SampleModel srcSM = src.getSampleModel();</span>
<span class="nc" id="L473">        SampleModel dstSM = dst.getSampleModel();</span>
<span class="nc" id="L474">        int srcTransferType = src.getTransferType();</span>
<span class="nc" id="L475">        int dstTransferType = dst.getTransferType();</span>
<span class="nc" id="L476">        int w = src.getWidth();</span>
<span class="nc" id="L477">        int h = src.getHeight();</span>
<span class="nc" id="L478">        int srcNumBands = src.getNumBands();</span>
<span class="nc" id="L479">        int dstNumBands = dst.getNumBands();</span>
<span class="nc" id="L480">        int precision = 8;</span>
<span class="nc" id="L481">        float maxNum = 255.0f;</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">        for (int i = 0; i &lt; srcNumBands; i++) {</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">            if (srcSM.getSampleSize(i) &gt; 8) {</span>
<span class="nc" id="L484">                 precision = 16;</span>
<span class="nc" id="L485">                 maxNum = 65535.0f;</span>
             }
        }
<span class="nc bnc" id="L488" title="All 2 branches missed.">        for (int i = 0; i &lt; dstNumBands; i++) {</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">            if (dstSM.getSampleSize(i) &gt; 8) {</span>
<span class="nc" id="L490">                 precision = 16;</span>
<span class="nc" id="L491">                 maxNum = 65535.0f;</span>
             }
        }
<span class="nc" id="L494">        float[] srcScaleFactor = new float[srcNumBands];</span>
<span class="nc" id="L495">        float[] dstScaleFactor = new float[dstNumBands];</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">        for (int i = 0; i &lt; srcNumBands; i++) {</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">            if (srcTransferType == DataBuffer.TYPE_SHORT) {</span>
<span class="nc" id="L498">                srcScaleFactor[i] = maxNum / 32767.0f;</span>
            } else {
<span class="nc" id="L500">                srcScaleFactor[i] = maxNum /</span>
<span class="nc" id="L501">                    ((float) ((1 &lt;&lt; srcSM.getSampleSize(i)) - 1));</span>
            }
        }
<span class="nc bnc" id="L504" title="All 2 branches missed.">        for (int i = 0; i &lt; dstNumBands; i++) {</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">            if (dstTransferType == DataBuffer.TYPE_SHORT) {</span>
<span class="nc" id="L506">                dstScaleFactor[i] = 32767.0f / maxNum;</span>
            } else {
<span class="nc" id="L508">                dstScaleFactor[i] =</span>
<span class="nc" id="L509">                    ((float) ((1 &lt;&lt; dstSM.getSampleSize(i)) - 1)) / maxNum;</span>
            }
        }
<span class="nc" id="L512">        int ys = src.getMinY();</span>
<span class="nc" id="L513">        int yd = dst.getMinY();</span>
        int xs, xd;
        int sample;
<span class="nc bnc" id="L516" title="All 2 branches missed.">        if (precision == 8) {</span>
<span class="nc" id="L517">            byte[] srcLine = new byte[w * srcNumBands];</span>
<span class="nc" id="L518">            byte[] dstLine = new byte[w * dstNumBands];</span>
            int idx;
            // TODO check for src npixels = dst npixels
            try {
<span class="nc" id="L522">                srcIL = new LCMSImageLayout(</span>
<span class="nc" id="L523">                        srcLine, srcLine.length/getNumInComponents(),</span>
<span class="nc" id="L524">                        LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |</span>
<span class="nc" id="L525">                        LCMSImageLayout.BYTES_SH(1), getNumInComponents());</span>
<span class="nc" id="L526">                dstIL = new LCMSImageLayout(</span>
<span class="nc" id="L527">                        dstLine, dstLine.length/getNumOutComponents(),</span>
<span class="nc" id="L528">                        LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |</span>
<span class="nc" id="L529">                        LCMSImageLayout.BYTES_SH(1), getNumOutComponents());</span>
<span class="nc" id="L530">            } catch (ImageLayoutException e) {</span>
<span class="nc" id="L531">                throw new CMMException(&quot;Unable to convert rasters&quot;);</span>
<span class="nc" id="L532">            }</span>
            // process each scanline
<span class="nc bnc" id="L534" title="All 2 branches missed.">            for (int y = 0; y &lt; h; y++, ys++, yd++) {</span>
                // get src scanline
<span class="nc" id="L536">                xs = src.getMinX();</span>
<span class="nc" id="L537">                idx = 0;</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">                for (int x = 0; x &lt; w; x++, xs++) {</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">                    for (int i = 0; i &lt; srcNumBands; i++) {</span>
<span class="nc" id="L540">                        sample = src.getSample(xs, ys, i);</span>
<span class="nc" id="L541">                        srcLine[idx++] = (byte)</span>
                            ((sample * srcScaleFactor[i]) + 0.5f);
                    }
                }

                // color convert srcLine to dstLine
<span class="nc" id="L547">                doTransform(srcIL, dstIL);</span>

                // store dst scanline
<span class="nc" id="L550">                xd = dst.getMinX();</span>
<span class="nc" id="L551">                idx = 0;</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">                for (int x = 0; x &lt; w; x++, xd++) {</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">                    for (int i = 0; i &lt; dstNumBands; i++) {</span>
<span class="nc" id="L554">                        sample = (int) (((dstLine[idx++] &amp; 0xff) *</span>
                                         dstScaleFactor[i]) + 0.5f);
<span class="nc" id="L556">                        dst.setSample(xd, yd, i, sample);</span>
                    }
                }
            }
<span class="nc" id="L560">        } else {</span>
<span class="nc" id="L561">            short[] srcLine = new short[w * srcNumBands];</span>
<span class="nc" id="L562">            short[] dstLine = new short[w * dstNumBands];</span>
            int idx;

            try {
<span class="nc" id="L566">                srcIL = new LCMSImageLayout(</span>
<span class="nc" id="L567">                        srcLine, srcLine.length/getNumInComponents(),</span>
<span class="nc" id="L568">                        LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |</span>
<span class="nc" id="L569">                        LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);</span>

<span class="nc" id="L571">                dstIL = new LCMSImageLayout(</span>
<span class="nc" id="L572">                        dstLine, dstLine.length/getNumOutComponents(),</span>
<span class="nc" id="L573">                        LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |</span>
<span class="nc" id="L574">                        LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);</span>
<span class="nc" id="L575">            } catch (ImageLayoutException e) {</span>
<span class="nc" id="L576">                throw new CMMException(&quot;Unable to convert rasters&quot;);</span>
<span class="nc" id="L577">            }</span>
            // process each scanline
<span class="nc bnc" id="L579" title="All 2 branches missed.">            for (int y = 0; y &lt; h; y++, ys++, yd++) {</span>
                // get src scanline
<span class="nc" id="L581">                xs = src.getMinX();</span>
<span class="nc" id="L582">                idx = 0;</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">                for (int x = 0; x &lt; w; x++, xs++) {</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">                    for (int i = 0; i &lt; srcNumBands; i++) {</span>
<span class="nc" id="L585">                        sample = src.getSample(xs, ys, i);</span>
<span class="nc" id="L586">                        srcLine[idx++] = (short)</span>
                            ((sample * srcScaleFactor[i]) + 0.5f);
                    }
                }

                // color convert srcLine to dstLine
<span class="nc" id="L592">                doTransform(srcIL, dstIL);</span>

                // store dst scanline
<span class="nc" id="L595">                xd = dst.getMinX();</span>
<span class="nc" id="L596">                idx = 0;</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                for (int x = 0; x &lt; w; x++, xd++) {</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                    for (int i = 0; i &lt; dstNumBands; i++) {</span>
<span class="nc" id="L599">                        sample = (int) (((dstLine[idx++] &amp; 0xffff) *</span>
                                         dstScaleFactor[i]) + 0.5f);
<span class="nc" id="L601">                        dst.setSample(xd, yd, i, sample);</span>
                    }
                }
            }
        }
<span class="nc" id="L606">    }</span>

    /* convert an array of colors in short format */
    /* each color is a contiguous set of array elements */
    /* the number of colors is (size of the array) / (number of input/output
       components */
    public short[] colorConvert(short[] src, short[] dst) {

<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (dst == null) {</span>
<span class="nc" id="L615">            dst = new short [(src.length/getNumInComponents())*getNumOutComponents()];</span>
        }

        try {
<span class="nc" id="L619">            LCMSImageLayout srcIL = new LCMSImageLayout(</span>
<span class="nc" id="L620">                    src, src.length/getNumInComponents(),</span>
<span class="nc" id="L621">                    LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |</span>
<span class="nc" id="L622">                    LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);</span>

<span class="nc" id="L624">            LCMSImageLayout dstIL = new LCMSImageLayout(</span>
<span class="nc" id="L625">                    dst, dst.length/getNumOutComponents(),</span>
<span class="nc" id="L626">                    LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |</span>
<span class="nc" id="L627">                    LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);</span>

<span class="nc" id="L629">            doTransform(srcIL, dstIL);</span>

<span class="nc" id="L631">            return dst;</span>
<span class="nc" id="L632">        } catch (ImageLayoutException e) {</span>
<span class="nc" id="L633">            throw new CMMException(&quot;Unable to convert data&quot;);</span>
        }
    }

    public byte[] colorConvert(byte[] src, byte[] dst) {
<span class="nc bnc" id="L638" title="All 2 branches missed.">        if (dst == null) {</span>
<span class="nc" id="L639">            dst = new byte [(src.length/getNumInComponents())*getNumOutComponents()];</span>
        }

        try {
<span class="nc" id="L643">            LCMSImageLayout srcIL = new LCMSImageLayout(</span>
<span class="nc" id="L644">                    src, src.length/getNumInComponents(),</span>
<span class="nc" id="L645">                    LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |</span>
<span class="nc" id="L646">                    LCMSImageLayout.BYTES_SH(1), getNumInComponents());</span>

<span class="nc" id="L648">            LCMSImageLayout dstIL = new LCMSImageLayout(</span>
<span class="nc" id="L649">                    dst, dst.length/getNumOutComponents(),</span>
<span class="nc" id="L650">                    LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |</span>
<span class="nc" id="L651">                    LCMSImageLayout.BYTES_SH(1), getNumOutComponents());</span>

<span class="nc" id="L653">            doTransform(srcIL, dstIL);</span>

<span class="nc" id="L655">            return dst;</span>
<span class="nc" id="L656">        } catch (ImageLayoutException e) {</span>
<span class="nc" id="L657">            throw new CMMException(&quot;Unable to convert data&quot;);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>