<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CompositionArea.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.awt.im</a> &gt; <span class="el_source">CompositionArea.java</span></div><h1>CompositionArea.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.awt.im;

import java.awt.AWTEvent;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.FontMetrics;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.Toolkit;
import java.awt.event.InputMethodEvent;
import java.awt.event.InputMethodListener;
import java.awt.event.WindowEvent;
import java.awt.event.WindowAdapter;
import java.awt.font.FontRenderContext;
import java.awt.font.TextHitInfo;
import java.awt.font.TextLayout;
import java.awt.geom.Rectangle2D;
import java.awt.im.InputMethodRequests;
import java.text.AttributedCharacterIterator;
import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.border.LineBorder;

/**
 * A composition area is used to display text that's being composed
 * using an input method in its own user interface environment,
 * typically in a root window.
 *
 * @author JavaSoft International
 */

// This class is final due to the 6607310 fix. Refer to the CR for details.
public final class CompositionArea extends JPanel implements InputMethodListener {

    private CompositionAreaHandler handler;

    private TextLayout composedTextLayout;
<span class="nc" id="L65">    private TextHitInfo caret = null;</span>
    private JFrame compositionWindow;
    private final static int TEXT_ORIGIN_X = 5;
    private final static int TEXT_ORIGIN_Y = 15;
    private final static int PASSIVE_WIDTH = 480;
    private final static int WIDTH_MARGIN=10;
    private final static int HEIGHT_MARGIN=3;

<span class="nc" id="L73">    CompositionArea() {</span>
        // create composition window with localized title
<span class="nc" id="L75">        String windowTitle = Toolkit.getProperty(&quot;AWT.CompositionWindowTitle&quot;, &quot;Input Window&quot;);</span>
<span class="nc" id="L76">        compositionWindow =</span>
<span class="nc" id="L77">            (JFrame)InputMethodContext.createInputMethodWindow(windowTitle, null, true);</span>

<span class="nc" id="L79">        setOpaque(true);</span>
<span class="nc" id="L80">        setBorder(LineBorder.createGrayLineBorder());</span>
<span class="nc" id="L81">        setForeground(Color.black);</span>
<span class="nc" id="L82">        setBackground(Color.white);</span>

        // if we get the focus, we still want to let the client's
        // input context handle the event
<span class="nc" id="L86">        enableInputMethods(true);</span>
<span class="nc" id="L87">        enableEvents(AWTEvent.KEY_EVENT_MASK);</span>

<span class="nc" id="L89">        compositionWindow.getContentPane().add(this);</span>
<span class="nc" id="L90">        compositionWindow.addWindowListener(new FrameWindowAdapter());</span>
<span class="nc" id="L91">        addInputMethodListener(this);</span>
<span class="nc" id="L92">        compositionWindow.enableInputMethods(false);</span>
<span class="nc" id="L93">        compositionWindow.pack();</span>
<span class="nc" id="L94">        Dimension windowSize = compositionWindow.getSize();</span>
<span class="nc" id="L95">        Dimension screenSize = (getToolkit()).getScreenSize();</span>
<span class="nc" id="L96">        compositionWindow.setLocation(screenSize.width - windowSize.width-20,</span>
                                    screenSize.height - windowSize.height-100);
<span class="nc" id="L98">        compositionWindow.setVisible(false);</span>
<span class="nc" id="L99">    }</span>

    /**
     * Sets the composition area handler that currently owns this
     * composition area, and its input context.
     */
    synchronized void setHandlerInfo(CompositionAreaHandler handler, InputContext inputContext) {
<span class="nc" id="L106">        this.handler = handler;</span>
<span class="nc" id="L107">        ((InputMethodWindow) compositionWindow).setInputContext(inputContext);</span>
<span class="nc" id="L108">    }</span>

    /**
     * @see java.awt.Component#getInputMethodRequests
     */
    public InputMethodRequests getInputMethodRequests() {
<span class="nc" id="L114">        return handler;</span>
    }

    // returns a 0-width rectangle
    private Rectangle getCaretRectangle(TextHitInfo caret) {
<span class="nc" id="L119">        int caretLocation = 0;</span>
<span class="nc" id="L120">        TextLayout layout = composedTextLayout;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (layout != null) {</span>
<span class="nc" id="L122">            caretLocation = Math.round(layout.getCaretInfo(caret)[0]);</span>
        }
<span class="nc" id="L124">        Graphics g = getGraphics();</span>
<span class="nc" id="L125">        FontMetrics metrics = null;</span>
        try {
<span class="nc" id="L127">            metrics = g.getFontMetrics();</span>
        } finally {
<span class="nc" id="L129">            g.dispose();</span>
<span class="nc" id="L130">        }</span>
<span class="nc" id="L131">        return new Rectangle(TEXT_ORIGIN_X + caretLocation,</span>
<span class="nc" id="L132">                             TEXT_ORIGIN_Y - metrics.getAscent(),</span>
<span class="nc" id="L133">                             0, metrics.getAscent() + metrics.getDescent());</span>
    }

    public void paint(Graphics g) {
<span class="nc" id="L137">        super.paint(g);</span>
<span class="nc" id="L138">        g.setColor(getForeground());</span>
<span class="nc" id="L139">        TextLayout layout = composedTextLayout;</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (layout != null) {</span>
<span class="nc" id="L141">            layout.draw((Graphics2D) g, TEXT_ORIGIN_X, TEXT_ORIGIN_Y);</span>
        }
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (caret != null) {</span>
<span class="nc" id="L144">            Rectangle rectangle = getCaretRectangle(caret);</span>
<span class="nc" id="L145">            g.setXORMode(getBackground());</span>
<span class="nc" id="L146">            g.fillRect(rectangle.x, rectangle.y, 1, rectangle.height);</span>
<span class="nc" id="L147">            g.setPaintMode();</span>
        }
<span class="nc" id="L149">    }</span>

    // shows/hides the composition window
    void setCompositionAreaVisible(boolean visible) {
<span class="nc" id="L153">        compositionWindow.setVisible(visible);</span>
<span class="nc" id="L154">    }</span>

    // returns true if composition area is visible
    boolean isCompositionAreaVisible() {
<span class="nc" id="L158">        return compositionWindow.isVisible();</span>
    }

    // workaround for the Solaris focus lost problem
<span class="nc" id="L162">    class FrameWindowAdapter extends WindowAdapter {</span>
        public void windowActivated(WindowEvent e) {
<span class="nc" id="L164">            requestFocus();</span>
<span class="nc" id="L165">        }</span>
    }

    // InputMethodListener methods - just forward to the current handler
    public void inputMethodTextChanged(InputMethodEvent event) {
<span class="nc" id="L170">        handler.inputMethodTextChanged(event);</span>
<span class="nc" id="L171">    }</span>

    public void caretPositionChanged(InputMethodEvent event) {
<span class="nc" id="L174">        handler.caretPositionChanged(event);</span>
<span class="nc" id="L175">    }</span>

    /**
     * Sets the text and caret to be displayed in this composition area.
     * Shows the window if it contains text, hides it if not.
     */
    void setText(AttributedCharacterIterator composedText, TextHitInfo caret) {
<span class="nc" id="L182">        composedTextLayout = null;</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (composedText == null) {</span>
            // there's no composed text to display, so hide the window
<span class="nc" id="L185">            compositionWindow.setVisible(false);</span>
<span class="nc" id="L186">            this.caret = null;</span>
        } else {
            /* since we have composed text, make sure the window is shown.
               This is necessary to get a valid graphics object. See 6181385.
            */
<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (!compositionWindow.isVisible()) {</span>
<span class="nc" id="L192">                compositionWindow.setVisible(true);</span>
            }

<span class="nc" id="L195">            Graphics g = getGraphics();</span>

<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (g == null) {</span>
<span class="nc" id="L198">                return;</span>
            }

            try {
<span class="nc" id="L202">                updateWindowLocation();</span>

<span class="nc" id="L204">                FontRenderContext context = ((Graphics2D)g).getFontRenderContext();</span>
<span class="nc" id="L205">                composedTextLayout = new TextLayout(composedText, context);</span>
<span class="nc" id="L206">                Rectangle2D bounds = composedTextLayout.getBounds();</span>

<span class="nc" id="L208">                this.caret = caret;</span>

                // Resize the composition area to just fit the text.
<span class="nc" id="L211">                FontMetrics metrics = g.getFontMetrics();</span>
<span class="nc" id="L212">                Rectangle2D maxCharBoundsRec = metrics.getMaxCharBounds(g);</span>
<span class="nc" id="L213">                int newHeight = (int)maxCharBoundsRec.getHeight() + HEIGHT_MARGIN;</span>
<span class="nc" id="L214">                int newFrameHeight = newHeight +compositionWindow.getInsets().top</span>
<span class="nc" id="L215">                                               +compositionWindow.getInsets().bottom;</span>
                // If it's a passive client, set the width always to PASSIVE_WIDTH (480px)
<span class="nc" id="L217">                InputMethodRequests req = handler.getClientInputMethodRequests();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                int newWidth = (req==null) ? PASSIVE_WIDTH : (int)bounds.getWidth() + WIDTH_MARGIN;</span>
<span class="nc" id="L219">                int newFrameWidth = newWidth + compositionWindow.getInsets().left</span>
<span class="nc" id="L220">                                             + compositionWindow.getInsets().right;</span>
<span class="nc" id="L221">                setPreferredSize(new Dimension(newWidth, newHeight));</span>
<span class="nc" id="L222">                compositionWindow.setSize(new Dimension(newFrameWidth, newFrameHeight));</span>

                // show the composed text
<span class="nc" id="L225">                paint(g);</span>
            }
            finally {
<span class="nc" id="L228">                g.dispose();</span>
<span class="nc" id="L229">            }</span>
        }
<span class="nc" id="L231">    }</span>

    /**
     * Sets the caret to be displayed in this composition area.
     * The text is not changed.
     */
    void setCaret(TextHitInfo caret) {
<span class="nc" id="L238">        this.caret = caret;</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (compositionWindow.isVisible()) {</span>
<span class="nc" id="L240">            Graphics g = getGraphics();</span>
            try {
<span class="nc" id="L242">                paint(g);</span>
            } finally {
<span class="nc" id="L244">                g.dispose();</span>
<span class="nc" id="L245">            }</span>
        }
<span class="nc" id="L247">    }</span>

    /**
     * Positions the composition window near (usually below) the
     * insertion point in the client component if the client
     * component is an active client (below-the-spot input).
     */
    void updateWindowLocation() {
<span class="nc" id="L255">        InputMethodRequests req = handler.getClientInputMethodRequests();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (req == null) {</span>
            // not an active client
<span class="nc" id="L258">            return;</span>
        }

<span class="nc" id="L261">        Point windowLocation = new Point();</span>

<span class="nc" id="L263">        Rectangle caretRect = req.getTextLocation(null);</span>
<span class="nc" id="L264">        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();</span>
<span class="nc" id="L265">        Dimension windowSize = compositionWindow.getSize();</span>
        final int SPACING = 2;

<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (caretRect.x + windowSize.width &gt; screenSize.width) {</span>
<span class="nc" id="L269">            windowLocation.x = screenSize.width - windowSize.width;</span>
        } else {
<span class="nc" id="L271">            windowLocation.x = caretRect.x;</span>
        }

<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (caretRect.y + caretRect.height + SPACING + windowSize.height &gt; screenSize.height) {</span>
<span class="nc" id="L275">            windowLocation.y = caretRect.y - SPACING - windowSize.height;</span>
        } else {
<span class="nc" id="L277">            windowLocation.y = caretRect.y + caretRect.height + SPACING;</span>
        }

<span class="nc" id="L280">        compositionWindow.setLocation(windowLocation);</span>
<span class="nc" id="L281">    }</span>

    // support for InputMethodRequests methods
    Rectangle getTextLocation(TextHitInfo offset) {
<span class="nc" id="L285">        Rectangle rectangle = getCaretRectangle(offset);</span>
<span class="nc" id="L286">        Point location = getLocationOnScreen();</span>
<span class="nc" id="L287">        rectangle.translate(location.x, location.y);</span>
<span class="nc" id="L288">        return rectangle;</span>
    }

   TextHitInfo getLocationOffset(int x, int y) {
<span class="nc" id="L292">        TextLayout layout = composedTextLayout;</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (layout == null) {</span>
<span class="nc" id="L294">            return null;</span>
        } else {
<span class="nc" id="L296">            Point location = getLocationOnScreen();</span>
<span class="nc" id="L297">            x -= location.x + TEXT_ORIGIN_X;</span>
<span class="nc" id="L298">            y -= location.y + TEXT_ORIGIN_Y;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            if (layout.getBounds().contains(x, y)) {</span>
<span class="nc" id="L300">                return layout.hitTestChar(x, y);</span>
            } else {
<span class="nc" id="L302">                return null;</span>
            }
        }
    }

    // Disables or enables decorations of the composition window
    void setCompositionAreaUndecorated(boolean setUndecorated){
<span class="nc bnc" id="L309" title="All 2 branches missed.">          if (compositionWindow.isDisplayable()){</span>
<span class="nc" id="L310">              compositionWindow.removeNotify();</span>
          }
<span class="nc" id="L312">          compositionWindow.setUndecorated(setUndecorated);</span>
<span class="nc" id="L313">          compositionWindow.pack();</span>
<span class="nc" id="L314">    }</span>

    // Proclaim serial compatibility with 1.7.0
    private static final long serialVersionUID = -1057247068746557444L;

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>