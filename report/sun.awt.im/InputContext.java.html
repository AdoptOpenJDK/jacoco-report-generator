<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>InputContext.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.awt.im</a> &gt; <span class="el_source">InputContext.java</span></div><h1>InputContext.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.awt.im;

import java.awt.AWTEvent;
import java.awt.AWTKeyStroke;
import java.awt.Component;
import java.awt.EventQueue;
import java.awt.Frame;
import java.awt.Rectangle;
import java.awt.Toolkit;
import java.awt.Window;
import java.awt.event.ComponentEvent;
import java.awt.event.ComponentListener;
import java.awt.event.FocusEvent;
import java.awt.event.InputEvent;
import java.awt.event.InputMethodEvent;
import java.awt.event.KeyEvent;
import java.awt.event.WindowEvent;
import java.awt.event.WindowListener;
import java.awt.im.InputMethodRequests;
import java.awt.im.spi.InputMethod;
import java.lang.Character.Subset;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.text.MessageFormat;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Locale;
import java.util.prefs.BackingStoreException;
import java.util.prefs.Preferences;
import sun.util.logging.PlatformLogger;
import sun.awt.SunToolkit;

/**
 * This InputContext class contains parts of the implementation of
 * java.text.im.InputContext. These parts have been moved
 * here to avoid exposing protected members that are needed by the
 * subclass InputMethodContext.
 *
 * @see java.awt.im.InputContext
 * @author JavaSoft Asia/Pacific
 */

public class InputContext extends java.awt.im.InputContext
                          implements ComponentListener, WindowListener {
<span class="nc" id="L70">    private static final PlatformLogger log = PlatformLogger.getLogger(&quot;sun.awt.im.InputContext&quot;);</span>
    // The current input method is represented by two objects:
    // a locator is used to keep information about the selected
    // input method and locale until we actually need a real input
    // method; only then the input method itself is created.
    // Once there is an input method, the input method's locale
    // takes precedence over locale information in the locator.
    private InputMethodLocator inputMethodLocator;
    private InputMethod inputMethod;
    private boolean inputMethodCreationFailed;

    // holding bin for previously used input method instances, but not the current one
    private HashMap&lt;InputMethodLocator, InputMethod&gt; usedInputMethods;

    // the current client component is kept until the user focusses on a different
    // client component served by the same input context. When that happens, we call
    // endComposition so that text doesn't jump from one component to another.
    private Component currentClientComponent;
    private Component awtFocussedComponent;
    private boolean   isInputMethodActive;
<span class="nc" id="L90">    private Subset[]  characterSubsets = null;</span>

    // true if composition area has been set to invisible when focus was lost
<span class="nc" id="L93">    private boolean compositionAreaHidden = false;</span>

    // The input context for whose input method we may have to call hideWindows
    private static InputContext inputMethodWindowContext;

    // Previously active input method to decide whether we need to call
    // InputMethodAdapter.stopListening() on activateInputMethod()
<span class="nc" id="L100">    private static InputMethod previousInputMethod = null;</span>

    // true if the current input method requires client window change notification
<span class="nc" id="L103">    private boolean clientWindowNotificationEnabled = false;</span>
    // client window to which this input context is listening
    private Window clientWindowListened;
    // cache location notification
<span class="nc" id="L107">    private Rectangle clientWindowLocation = null;</span>
    // holding the state of clientWindowNotificationEnabled of only non-current input methods
    private HashMap&lt;InputMethod, Boolean&gt; perInputMethodState;

    // Input Method selection hot key stuff
    private static AWTKeyStroke inputMethodSelectionKey;
<span class="nc" id="L113">    private static boolean inputMethodSelectionKeyInitialized = false;</span>
    private static final String inputMethodSelectionKeyPath = &quot;/java/awt/im/selectionKey&quot;;
    private static final String inputMethodSelectionKeyCodeName = &quot;keyCode&quot;;
    private static final String inputMethodSelectionKeyModifiersName = &quot;modifiers&quot;;

    /**
     * Constructs an InputContext.
     */
<span class="nc" id="L121">    protected InputContext() {</span>
<span class="nc" id="L122">        InputMethodManager imm = InputMethodManager.getInstance();</span>
<span class="nc" id="L123">        synchronized (InputContext.class) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (!inputMethodSelectionKeyInitialized) {</span>
<span class="nc" id="L125">                inputMethodSelectionKeyInitialized = true;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                if (imm.hasMultipleInputMethods()) {</span>
<span class="nc" id="L127">                    initializeInputMethodSelectionKey();</span>
                }
            }
<span class="nc" id="L130">        }</span>
<span class="nc" id="L131">        selectInputMethod(imm.getDefaultKeyboardLocale());</span>
<span class="nc" id="L132">    }</span>

    /**
     * @see java.awt.im.InputContext#selectInputMethod
     * @exception NullPointerException when the locale is null.
     */
    public synchronized boolean selectInputMethod(Locale locale) {
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (locale == null) {</span>
<span class="nc" id="L140">            throw new NullPointerException();</span>
        }

        // see whether the current input method supports the locale
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (inputMethod.setLocale(locale)) {</span>
<span class="nc" id="L146">                return true;</span>
            }
<span class="nc bnc" id="L148" title="All 2 branches missed.">        } else if (inputMethodLocator != null) {</span>
            // This is not 100% correct, since the input method
            // may support the locale without advertising it.
            // But before we try instantiations and setLocale,
            // we look for an input method that's more confident.
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (inputMethodLocator.isLocaleAvailable(locale)) {</span>
<span class="nc" id="L154">                inputMethodLocator = inputMethodLocator.deriveLocator(locale);</span>
<span class="nc" id="L155">                return true;</span>
            }
        }

        // see whether there's some other input method that supports the locale
<span class="nc" id="L160">        InputMethodLocator newLocator = InputMethodManager.getInstance().findInputMethod(locale);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (newLocator != null) {</span>
<span class="nc" id="L162">            changeInputMethod(newLocator);</span>
<span class="nc" id="L163">            return true;</span>
        }

        // make one last desperate effort with the current input method
        // ??? is this good? This is pretty high cost for something that's likely to fail.
<span class="nc bnc" id="L168" title="All 4 branches missed.">        if (inputMethod == null &amp;&amp; inputMethodLocator != null) {</span>
<span class="nc" id="L169">            inputMethod = getInputMethod();</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (inputMethod != null) {</span>
<span class="nc" id="L171">                return inputMethod.setLocale(locale);</span>
            }
        }
<span class="nc" id="L174">        return false;</span>
    }

    /**
     * @see java.awt.im.InputContext#getLocale
     */
    public Locale getLocale() {
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc" id="L182">            return inputMethod.getLocale();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        } else if (inputMethodLocator != null) {</span>
<span class="nc" id="L184">            return inputMethodLocator.getLocale();</span>
        } else {
<span class="nc" id="L186">            return null;</span>
        }
    }

    /**
     * @see java.awt.im.InputContext#setCharacterSubsets
     */
    public void setCharacterSubsets(Subset[] subsets) {
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (subsets == null) {</span>
<span class="nc" id="L195">            characterSubsets = null;</span>
        } else {
<span class="nc" id="L197">            characterSubsets = new Subset[subsets.length];</span>
<span class="nc" id="L198">            System.arraycopy(subsets, 0,</span>
                             characterSubsets, 0, characterSubsets.length);
        }
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc" id="L202">            inputMethod.setCharacterSubsets(subsets);</span>
        }
<span class="nc" id="L204">    }</span>

    /**
     * @see java.awt.im.InputContext#reconvert
     * @since 1.3
     * @exception UnsupportedOperationException when input method is null
     */
    public synchronized void reconvert() {
<span class="nc" id="L212">        InputMethod inputMethod = getInputMethod();</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (inputMethod == null) {</span>
<span class="nc" id="L214">            throw new UnsupportedOperationException();</span>
        }
<span class="nc" id="L216">        inputMethod.reconvert();</span>
<span class="nc" id="L217">    }</span>

    /**
     * @see java.awt.im.InputContext#dispatchEvent
     */
    @SuppressWarnings(&quot;fallthrough&quot;)
    public void dispatchEvent(AWTEvent event) {

<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (event instanceof InputMethodEvent) {</span>
<span class="nc" id="L226">            return;</span>
        }

        // Ignore focus events that relate to the InputMethodWindow of this context.
        // This is a workaround.  Should be removed after 4452384 is fixed.
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (event instanceof FocusEvent) {</span>
<span class="nc" id="L232">            Component opposite = ((FocusEvent)event).getOppositeComponent();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">            if ((opposite != null) &amp;&amp;</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                (getComponentWindow(opposite) instanceof InputMethodWindow) &amp;&amp;</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                (opposite.getInputContext() == this)) {</span>
<span class="nc" id="L236">                return;</span>
            }
        }

<span class="nc" id="L240">        InputMethod inputMethod = getInputMethod();</span>
<span class="nc" id="L241">        int id = event.getID();</span>

<span class="nc bnc" id="L243" title="All 4 branches missed.">        switch (id) {</span>
        case FocusEvent.FOCUS_GAINED:
<span class="nc" id="L245">            focusGained((Component) event.getSource());</span>
<span class="nc" id="L246">            break;</span>

        case FocusEvent.FOCUS_LOST:
<span class="nc" id="L249">            focusLost((Component) event.getSource(), ((FocusEvent) event).isTemporary());</span>
<span class="nc" id="L250">            break;</span>

        case KeyEvent.KEY_PRESSED:
<span class="nc bnc" id="L253" title="All 2 branches missed.">            if (checkInputMethodSelectionKey((KeyEvent)event)) {</span>
                // pop up the input method selection menu
<span class="nc" id="L255">                InputMethodManager.getInstance().notifyChangeRequestByHotKey((Component)event.getSource());</span>
<span class="nc" id="L256">                break;</span>
            }

            // fall through

        default:
<span class="nc bnc" id="L262" title="All 4 branches missed.">            if ((inputMethod != null) &amp;&amp; (event instanceof InputEvent)) {</span>
<span class="nc" id="L263">                inputMethod.dispatchEvent(event);</span>
            }
        }
<span class="nc" id="L266">    }</span>

    /**
     * Handles focus gained events for any component that's using
     * this input context.
     * These events are generated by AWT when the keyboard focus
     * moves to a component.
     * Besides actual client components, the source components
     * may also be the composition area or any component in an
     * input method window.
     * &lt;p&gt;
     * When handling the focus event for a client component, this
     * method checks whether the input context was previously
     * active for a different client component, and if so, calls
     * endComposition for the previous client component.
     *
     * @param source the component gaining the focus
     */
    private void focusGained(Component source) {

        /*
         * NOTE: When a Container is removing its Component which
         * invokes this.removeNotify(), the Container has the global
         * Component lock. It is possible to happen that an
         * application thread is calling this.removeNotify() while an
         * AWT event queue thread is dispatching a focus event via
         * this.dispatchEvent(). If an input method uses AWT
         * components (e.g., IIIMP status window), it causes deadlock,
         * for example, Component.show()/hide() in this situation
         * because hide/show tried to obtain the lock.  Therefore,
         * it's necessary to obtain the global Component lock before
         * activating or deactivating an input method.
         */
<span class="nc" id="L299">        synchronized (source.getTreeLock()) {</span>
<span class="nc" id="L300">            synchronized (this) {</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                if (&quot;sun.awt.im.CompositionArea&quot;.equals(source.getClass().getName())) {</span>
                    // no special handling for this one
<span class="nc bnc" id="L303" title="All 2 branches missed.">                } else if (getComponentWindow(source) instanceof InputMethodWindow) {</span>
                    // no special handling for this one either
                } else {
<span class="nc bnc" id="L306" title="All 2 branches missed.">                    if (!source.isDisplayable()) {</span>
                        // Component is being disposed
<span class="nc" id="L308">                        return;</span>
                    }

                    // Focus went to a real client component.
                    // Check whether we're switching between client components
                    // that share an input context. We can't do that earlier
                    // than here because we don't want to end composition
                    // until we really know we're switching to a different component
<span class="nc bnc" id="L316" title="All 2 branches missed.">                    if (inputMethod != null) {</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">                        if (currentClientComponent != null &amp;&amp; currentClientComponent != source) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">                            if (!isInputMethodActive) {</span>
<span class="nc" id="L319">                                activateInputMethod(false);</span>
                            }
<span class="nc" id="L321">                            endComposition();</span>
<span class="nc" id="L322">                            deactivateInputMethod(false);</span>
                        }
                    }

<span class="nc" id="L326">                    currentClientComponent = source;</span>
                }

<span class="nc" id="L329">                awtFocussedComponent = source;</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">                if (inputMethod instanceof InputMethodAdapter) {</span>
<span class="nc" id="L331">                    ((InputMethodAdapter) inputMethod).setAWTFocussedComponent(source);</span>
                }

                // it's possible that the input method is still active because
                // we suppressed a deactivate cause by an input method window
                // coming up
<span class="nc bnc" id="L337" title="All 2 branches missed.">                if (!isInputMethodActive) {</span>
<span class="nc" id="L338">                    activateInputMethod(true);</span>
                }


                // If the client component is an active client with the below-the-spot
                // input style, then make the composition window undecorated without a title bar.
<span class="nc" id="L344">                InputMethodContext inputContext = ((InputMethodContext)this);</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                if (!inputContext.isCompositionAreaVisible()) {</span>
<span class="nc" id="L346">                      InputMethodRequests req = source.getInputMethodRequests();</span>
<span class="nc bnc" id="L347" title="All 4 branches missed.">                      if (req != null &amp;&amp; inputContext.useBelowTheSpotInput()) {</span>
<span class="nc" id="L348">                          inputContext.setCompositionAreaUndecorated(true);</span>
                      } else {
<span class="nc" id="L350">                          inputContext.setCompositionAreaUndecorated(false);</span>
                      }
                }
                // restores the composition area if it was set to invisible
                // when focus got lost
<span class="nc bnc" id="L355" title="All 2 branches missed.">                if (compositionAreaHidden == true) {</span>
<span class="nc" id="L356">                    ((InputMethodContext)this).setCompositionAreaVisible(true);</span>
<span class="nc" id="L357">                    compositionAreaHidden = false;</span>
                }
<span class="nc" id="L359">            }</span>
<span class="nc" id="L360">        }</span>
<span class="nc" id="L361">    }</span>

    /**
     * Activates the current input method of this input context, and grabs
     * the composition area for use by this input context.
     * If updateCompositionArea is true, the text in the composition area
     * is updated (set to false if the text is going to change immediately
     * to avoid screen flicker).
     */
    private void activateInputMethod(boolean updateCompositionArea) {
        // call hideWindows() if this input context uses a different
        // input method than the previously activated one
<span class="nc bnc" id="L373" title="All 6 branches missed.">        if (inputMethodWindowContext != null &amp;&amp; inputMethodWindowContext != this &amp;&amp;</span>
                inputMethodWindowContext.inputMethodLocator != null &amp;&amp;
<span class="nc bnc" id="L375" title="All 4 branches missed.">                !inputMethodWindowContext.inputMethodLocator.sameInputMethod(inputMethodLocator) &amp;&amp;</span>
                inputMethodWindowContext.inputMethod != null) {
<span class="nc" id="L377">            inputMethodWindowContext.inputMethod.hideWindows();</span>
        }
<span class="nc" id="L379">        inputMethodWindowContext = this;</span>

<span class="nc bnc" id="L381" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc bnc" id="L382" title="All 4 branches missed.">            if (previousInputMethod != inputMethod &amp;&amp;</span>
                    previousInputMethod instanceof InputMethodAdapter) {
                // let the host adapter pass through the input events for the
                // new input method
<span class="nc" id="L386">                ((InputMethodAdapter) previousInputMethod).stopListening();</span>
            }
<span class="nc" id="L388">            previousInputMethod = null;</span>

<span class="nc bnc" id="L390" title="All 2 branches missed.">            if (log.isLoggable(PlatformLogger.Level.FINE)) {</span>
<span class="nc" id="L391">                log.fine(&quot;Current client component &quot; + currentClientComponent);</span>
            }
<span class="nc bnc" id="L393" title="All 2 branches missed.">            if (inputMethod instanceof InputMethodAdapter) {</span>
<span class="nc" id="L394">                ((InputMethodAdapter) inputMethod).setClientComponent(currentClientComponent);</span>
            }
<span class="nc" id="L396">            inputMethod.activate();</span>
<span class="nc" id="L397">            isInputMethodActive = true;</span>

<span class="nc bnc" id="L399" title="All 2 branches missed.">            if (perInputMethodState != null) {</span>
<span class="nc" id="L400">                Boolean state = perInputMethodState.remove(inputMethod);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                if (state != null) {</span>
<span class="nc" id="L402">                    clientWindowNotificationEnabled = state.booleanValue();</span>
                }
            }
<span class="nc bnc" id="L405" title="All 2 branches missed.">            if (clientWindowNotificationEnabled) {</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">                if (!addedClientWindowListeners()) {</span>
<span class="nc" id="L407">                    addClientWindowListeners();</span>
                }
<span class="nc" id="L409">                synchronized(this) {</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                    if (clientWindowListened != null) {</span>
<span class="nc" id="L411">                        notifyClientWindowChange(clientWindowListened);</span>
                    }
<span class="nc" id="L413">                }</span>
            } else {
<span class="nc bnc" id="L415" title="All 2 branches missed.">                if (addedClientWindowListeners()) {</span>
<span class="nc" id="L416">                    removeClientWindowListeners();</span>
                }
            }
        }
<span class="nc" id="L420">        InputMethodManager.getInstance().setInputContext(this);</span>

<span class="nc" id="L422">        ((InputMethodContext) this).grabCompositionArea(updateCompositionArea);</span>
<span class="nc" id="L423">    }</span>

    static Window getComponentWindow(Component component) {
        while (true) {
<span class="nc bnc" id="L427" title="All 2 branches missed.">            if (component == null) {</span>
<span class="nc" id="L428">                return null;</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">            } else if (component instanceof Window) {</span>
<span class="nc" id="L430">                return (Window) component;</span>
            } else {
<span class="nc" id="L432">                component = component.getParent();</span>
            }
        }
    }

    /**
     * Handles focus lost events for any component that's using
     * this input context.
     * These events are generated by AWT when the keyboard focus
     * moves away from a component.
     * Besides actual client components, the source components
     * may also be the composition area or any component in an
     * input method window.
     *
     * @param source the component losing the focus
     * @isTemporary whether the focus change is temporary
     */
    private void focusLost(Component source, boolean isTemporary) {

        // see the note on synchronization in focusGained
<span class="nc" id="L452">        synchronized (source.getTreeLock()) {</span>
<span class="nc" id="L453">            synchronized (this) {</span>

                // We need to suppress deactivation if removeNotify has been called earlier.
                // This is indicated by isInputMethodActive == false.
<span class="nc bnc" id="L457" title="All 2 branches missed.">                if (isInputMethodActive) {</span>
<span class="nc" id="L458">                    deactivateInputMethod(isTemporary);</span>
                }

<span class="nc" id="L461">                awtFocussedComponent = null;</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                if (inputMethod instanceof InputMethodAdapter) {</span>
<span class="nc" id="L463">                    ((InputMethodAdapter) inputMethod).setAWTFocussedComponent(null);</span>
                }

                // hides the composition area if currently it is visible
<span class="nc" id="L467">                InputMethodContext inputContext = ((InputMethodContext)this);</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                if (inputContext.isCompositionAreaVisible()) {</span>
<span class="nc" id="L469">                    inputContext.setCompositionAreaVisible(false);</span>
<span class="nc" id="L470">                    compositionAreaHidden = true;</span>
                }
<span class="nc" id="L472">            }</span>
<span class="nc" id="L473">        }</span>
<span class="nc" id="L474">    }</span>

    /**
     * Checks the key event is the input method selection key or not.
     */
    private boolean checkInputMethodSelectionKey(KeyEvent event) {
<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (inputMethodSelectionKey != null) {</span>
<span class="nc" id="L481">            AWTKeyStroke aKeyStroke = AWTKeyStroke.getAWTKeyStrokeForEvent(event);</span>
<span class="nc" id="L482">            return inputMethodSelectionKey.equals(aKeyStroke);</span>
        } else {
<span class="nc" id="L484">            return false;</span>
        }
    }

    private void deactivateInputMethod(boolean isTemporary) {
<span class="nc" id="L489">        InputMethodManager.getInstance().setInputContext(null);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc" id="L491">            isInputMethodActive = false;</span>
<span class="nc" id="L492">            inputMethod.deactivate(isTemporary);</span>
<span class="nc" id="L493">            previousInputMethod = inputMethod;</span>
        }
<span class="nc" id="L495">    }</span>

    /**
     * Switches from the current input method to the one described by newLocator.
     * The current input method, if any, is asked to end composition, deactivated,
     * and saved for future use. The newLocator is made the current locator. If
     * the input context is active, an input method instance for the new locator
     * is obtained; otherwise this is deferred until required.
     */
    synchronized void changeInputMethod(InputMethodLocator newLocator) {
        // If we don't have a locator yet, this must be a new input context.
        // If we created a new input method here, we might get into an
        // infinite loop: create input method -&gt; create some input method window -&gt;
        // create new input context -&gt; add input context to input method manager's context list -&gt;
        // call changeInputMethod on it.
        // So, just record the locator. dispatchEvent will create the input method when needed.
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (inputMethodLocator == null) {</span>
<span class="nc" id="L512">            inputMethodLocator = newLocator;</span>
<span class="nc" id="L513">            inputMethodCreationFailed = false;</span>
<span class="nc" id="L514">            return;</span>
        }

        // If the same input method is specified, just keep it.
        // Adjust the locale if necessary.
<span class="nc bnc" id="L519" title="All 2 branches missed.">        if (inputMethodLocator.sameInputMethod(newLocator)) {</span>
<span class="nc" id="L520">            Locale newLocale = newLocator.getLocale();</span>
<span class="nc bnc" id="L521" title="All 4 branches missed.">            if (newLocale != null &amp;&amp; inputMethodLocator.getLocale() != newLocale) {</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                if (inputMethod != null) {</span>
<span class="nc" id="L523">                    inputMethod.setLocale(newLocale);</span>
                }
<span class="nc" id="L525">                inputMethodLocator = newLocator;</span>
            }
<span class="nc" id="L527">            return;</span>
        }

        // Switch out the old input method
<span class="nc" id="L531">        Locale savedLocale = inputMethodLocator.getLocale();</span>
<span class="nc" id="L532">        boolean wasInputMethodActive = isInputMethodActive;</span>
<span class="nc" id="L533">        boolean wasCompositionEnabledSupported = false;</span>
<span class="nc" id="L534">        boolean wasCompositionEnabled = false;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (inputMethod != null) {</span>
            try {
<span class="nc" id="L537">                wasCompositionEnabled = inputMethod.isCompositionEnabled();</span>
<span class="nc" id="L538">                wasCompositionEnabledSupported = true;</span>
<span class="nc" id="L539">            } catch (UnsupportedOperationException e) { }</span>

<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (currentClientComponent != null) {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                if (!isInputMethodActive) {</span>
<span class="nc" id="L543">                    activateInputMethod(false);</span>
                }
<span class="nc" id="L545">                endComposition();</span>
<span class="nc" id="L546">                deactivateInputMethod(false);</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                if (inputMethod instanceof InputMethodAdapter) {</span>
<span class="nc" id="L548">                    ((InputMethodAdapter) inputMethod).setClientComponent(null);</span>
                }
            }
<span class="nc" id="L551">            savedLocale = inputMethod.getLocale();</span>

            // keep the input method instance around for future use
<span class="nc bnc" id="L554" title="All 2 branches missed.">            if (usedInputMethods == null) {</span>
<span class="nc" id="L555">                usedInputMethods = new HashMap&lt;&gt;(5);</span>
            }
<span class="nc bnc" id="L557" title="All 2 branches missed.">            if (perInputMethodState == null) {</span>
<span class="nc" id="L558">                perInputMethodState = new HashMap&lt;&gt;(5);</span>
            }
<span class="nc" id="L560">            usedInputMethods.put(inputMethodLocator.deriveLocator(null), inputMethod);</span>
<span class="nc" id="L561">            perInputMethodState.put(inputMethod,</span>
<span class="nc" id="L562">                                    Boolean.valueOf(clientWindowNotificationEnabled));</span>
<span class="nc" id="L563">            enableClientWindowNotification(inputMethod, false);</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">            if (this == inputMethodWindowContext) {</span>
<span class="nc" id="L565">                inputMethod.hideWindows();</span>
<span class="nc" id="L566">                inputMethodWindowContext = null;</span>
            }
<span class="nc" id="L568">            inputMethodLocator = null;</span>
<span class="nc" id="L569">            inputMethod = null;</span>
<span class="nc" id="L570">            inputMethodCreationFailed = false;</span>
        }

        // Switch in the new input method
<span class="nc bnc" id="L574" title="All 4 branches missed.">        if (newLocator.getLocale() == null &amp;&amp; savedLocale != null &amp;&amp;</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">                newLocator.isLocaleAvailable(savedLocale)) {</span>
<span class="nc" id="L576">            newLocator = newLocator.deriveLocator(savedLocale);</span>
        }
<span class="nc" id="L578">        inputMethodLocator = newLocator;</span>
<span class="nc" id="L579">        inputMethodCreationFailed = false;</span>

        // activate the new input method if the old one was active
<span class="nc bnc" id="L582" title="All 2 branches missed.">        if (wasInputMethodActive) {</span>
<span class="nc" id="L583">            inputMethod = getInputMethodInstance();</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">            if (inputMethod instanceof InputMethodAdapter) {</span>
<span class="nc" id="L585">                ((InputMethodAdapter) inputMethod).setAWTFocussedComponent(awtFocussedComponent);</span>
            }
<span class="nc" id="L587">            activateInputMethod(true);</span>
        }

        // enable/disable composition if the old one supports querying enable/disable
<span class="nc bnc" id="L591" title="All 2 branches missed.">        if (wasCompositionEnabledSupported) {</span>
<span class="nc" id="L592">            inputMethod = getInputMethod();</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">            if (inputMethod != null) {</span>
                try {
<span class="nc" id="L595">                    inputMethod.setCompositionEnabled(wasCompositionEnabled);</span>
<span class="nc" id="L596">                } catch (UnsupportedOperationException e) { }</span>
            }
        }
<span class="nc" id="L599">    }</span>

    /**
     * Returns the client component.
     */
    Component getClientComponent() {
<span class="nc" id="L605">        return currentClientComponent;</span>
    }

    /**
     * @see java.awt.im.InputContext#removeNotify
     * @exception NullPointerException when the component is null.
     */
    public synchronized void removeNotify(Component component) {
<span class="nc bnc" id="L613" title="All 2 branches missed.">        if (component == null) {</span>
<span class="nc" id="L614">            throw new NullPointerException();</span>
        }

<span class="nc bnc" id="L617" title="All 2 branches missed.">        if (inputMethod == null) {</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">            if (component == currentClientComponent) {</span>
<span class="nc" id="L619">                currentClientComponent = null;</span>
            }
<span class="nc" id="L621">            return;</span>
        }

        // We may or may not get a FOCUS_LOST event for this component,
        // so do the deactivation stuff here too.
<span class="nc bnc" id="L626" title="All 2 branches missed.">        if (component == awtFocussedComponent) {</span>
<span class="nc" id="L627">            focusLost(component, false);</span>
        }

<span class="nc bnc" id="L630" title="All 2 branches missed.">        if (component == currentClientComponent) {</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">            if (isInputMethodActive) {</span>
                // component wasn't the one that had the focus
<span class="nc" id="L633">                deactivateInputMethod(false);</span>
            }
<span class="nc" id="L635">            inputMethod.removeNotify();</span>
<span class="nc bnc" id="L636" title="All 4 branches missed.">            if (clientWindowNotificationEnabled &amp;&amp; addedClientWindowListeners()) {</span>
<span class="nc" id="L637">                removeClientWindowListeners();</span>
            }
<span class="nc" id="L639">            currentClientComponent = null;</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">            if (inputMethod instanceof InputMethodAdapter) {</span>
<span class="nc" id="L641">                ((InputMethodAdapter) inputMethod).setClientComponent(null);</span>
            }

            // removeNotify() can be issued from a thread other than the event dispatch
            // thread.  In that case, avoid possible deadlock between Component.AWTTreeLock
            // and InputMethodContext.compositionAreaHandlerLock by releasing the composition
            // area on the event dispatch thread.
<span class="nc bnc" id="L648" title="All 2 branches missed.">            if (EventQueue.isDispatchThread()) {</span>
<span class="nc" id="L649">                ((InputMethodContext)this).releaseCompositionArea();</span>
            } else {
<span class="nc" id="L651">                EventQueue.invokeLater(new Runnable() {</span>
                    public void run() {
<span class="nc" id="L653">                        ((InputMethodContext)InputContext.this).releaseCompositionArea();</span>
<span class="nc" id="L654">                    }</span>
                });
            }
        }
<span class="nc" id="L658">    }</span>

    /**
     * @see java.awt.im.InputContext#dispose
     * @exception IllegalStateException when the currentClientComponent is not null
     */
    public synchronized void dispose() {
<span class="nc bnc" id="L665" title="All 2 branches missed.">        if (currentClientComponent != null) {</span>
<span class="nc" id="L666">            throw new IllegalStateException(&quot;Can't dispose InputContext while it's active&quot;);</span>
        }
<span class="nc bnc" id="L668" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">            if (this == inputMethodWindowContext) {</span>
<span class="nc" id="L670">                inputMethod.hideWindows();</span>
<span class="nc" id="L671">                inputMethodWindowContext = null;</span>
            }
<span class="nc bnc" id="L673" title="All 2 branches missed.">            if (inputMethod == previousInputMethod) {</span>
<span class="nc" id="L674">                previousInputMethod = null;</span>
            }
<span class="nc bnc" id="L676" title="All 2 branches missed.">            if (clientWindowNotificationEnabled) {</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">                if (addedClientWindowListeners()) {</span>
<span class="nc" id="L678">                    removeClientWindowListeners();</span>
                }
<span class="nc" id="L680">                clientWindowNotificationEnabled = false;</span>
            }
<span class="nc" id="L682">            inputMethod.dispose();</span>

            // in case the input method enabled the client window
            // notification in dispose(), which shouldn't happen, it
            // needs to be cleaned up again.
<span class="nc bnc" id="L687" title="All 2 branches missed.">            if (clientWindowNotificationEnabled) {</span>
<span class="nc" id="L688">                enableClientWindowNotification(inputMethod, false);</span>
            }

<span class="nc" id="L691">            inputMethod = null;</span>
        }
<span class="nc" id="L693">        inputMethodLocator = null;</span>
<span class="nc bnc" id="L694" title="All 4 branches missed.">        if (usedInputMethods != null &amp;&amp; !usedInputMethods.isEmpty()) {</span>
<span class="nc" id="L695">            Iterator&lt;InputMethod&gt; iterator = usedInputMethods.values().iterator();</span>
<span class="nc" id="L696">            usedInputMethods = null;</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">            while (iterator.hasNext()) {</span>
<span class="nc" id="L698">                iterator.next().dispose();</span>
            }
        }

        // cleanup client window notification variables
<span class="nc" id="L703">        clientWindowNotificationEnabled = false;</span>
<span class="nc" id="L704">        clientWindowListened = null;</span>
<span class="nc" id="L705">        perInputMethodState = null;</span>
<span class="nc" id="L706">    }</span>

    /**
     * @see java.awt.im.InputContext#getInputMethodControlObject
     */
    public synchronized Object getInputMethodControlObject() {
<span class="nc" id="L712">        InputMethod inputMethod = getInputMethod();</span>

<span class="nc bnc" id="L714" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc" id="L715">            return inputMethod.getControlObject();</span>
        } else {
<span class="nc" id="L717">            return null;</span>
        }
    }

    /**
     * @see java.awt.im.InputContext#setCompositionEnabled(boolean)
     * @exception UnsupportedOperationException when input method is null
     */
    public void setCompositionEnabled(boolean enable) {
<span class="nc" id="L726">        InputMethod inputMethod = getInputMethod();</span>

<span class="nc bnc" id="L728" title="All 2 branches missed.">        if (inputMethod == null) {</span>
<span class="nc" id="L729">            throw new UnsupportedOperationException();</span>
        }
<span class="nc" id="L731">        inputMethod.setCompositionEnabled(enable);</span>
<span class="nc" id="L732">    }</span>

    /**
     * @see java.awt.im.InputContext#isCompositionEnabled
     * @exception UnsupportedOperationException when input method is null
     */
    public boolean isCompositionEnabled() {
<span class="nc" id="L739">        InputMethod inputMethod = getInputMethod();</span>

<span class="nc bnc" id="L741" title="All 2 branches missed.">        if (inputMethod == null) {</span>
<span class="nc" id="L742">            throw new UnsupportedOperationException();</span>
        }
<span class="nc" id="L744">        return inputMethod.isCompositionEnabled();</span>
    }

    /**
     * @return a string with information about the current input method.
     * @exception UnsupportedOperationException when input method is null
     */
    public String getInputMethodInfo() {
<span class="nc" id="L752">        InputMethod inputMethod = getInputMethod();</span>

<span class="nc bnc" id="L754" title="All 2 branches missed.">        if (inputMethod == null) {</span>
<span class="nc" id="L755">            throw new UnsupportedOperationException(&quot;Null input method&quot;);</span>
        }

<span class="nc" id="L758">        String inputMethodInfo = null;</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">        if (inputMethod instanceof InputMethodAdapter) {</span>
            // returns the information about the host native input method.
<span class="nc" id="L761">            inputMethodInfo = ((InputMethodAdapter)inputMethod).</span>
<span class="nc" id="L762">                getNativeInputMethodInfo();</span>
        }

        // extracts the information from the InputMethodDescriptor
        // associated with the current java input method.
<span class="nc bnc" id="L767" title="All 4 branches missed.">        if (inputMethodInfo == null &amp;&amp; inputMethodLocator != null) {</span>
<span class="nc" id="L768">            inputMethodInfo = inputMethodLocator.getDescriptor().</span>
<span class="nc" id="L769">                getInputMethodDisplayName(getLocale(), SunToolkit.</span>
<span class="nc" id="L770">                                          getStartupLocale());</span>
        }

<span class="nc bnc" id="L773" title="All 4 branches missed.">        if (inputMethodInfo != null &amp;&amp; !inputMethodInfo.equals(&quot;&quot;)) {</span>
<span class="nc" id="L774">            return inputMethodInfo;</span>
        }

        // do our best to return something useful.
<span class="nc" id="L778">        return inputMethod.toString() + &quot;-&quot; + inputMethod.getLocale().toString();</span>
    }

    /**
     * Turns off the native IM. The native IM is diabled when
     * the deactive method of InputMethod is called. It is
     * delayed until the active method is called on a different
     * peer component. This method is provided to explicitly disable
     * the native IM.
     */
    public void disableNativeIM() {
<span class="nc" id="L789">        InputMethod inputMethod = getInputMethod();</span>
<span class="nc bnc" id="L790" title="All 4 branches missed.">        if (inputMethod != null &amp;&amp; inputMethod instanceof InputMethodAdapter) {</span>
<span class="nc" id="L791">            ((InputMethodAdapter)inputMethod).stopListening();</span>
        }
<span class="nc" id="L793">    }</span>


    private synchronized InputMethod getInputMethod() {
<span class="nc bnc" id="L797" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc" id="L798">            return inputMethod;</span>
        }

<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (inputMethodCreationFailed) {</span>
<span class="nc" id="L802">            return null;</span>
        }

<span class="nc" id="L805">        inputMethod = getInputMethodInstance();</span>
<span class="nc" id="L806">        return inputMethod;</span>
    }

    /**
     * Returns an instance of the input method described by
     * the current input method locator. This may be an input
     * method that was previously used and switched out of,
     * or a new instance. The locale, character subsets, and
     * input method context of the input method are set.
     *
     * The inputMethodCreationFailed field is set to true if the
     * instantiation failed.
     *
     * @return an InputMethod instance
     * @see java.awt.im.spi.InputMethod#setInputMethodContext
     * @see java.awt.im.spi.InputMethod#setLocale
     * @see java.awt.im.spi.InputMethod#setCharacterSubsets
     */
    private InputMethod getInputMethodInstance() {
<span class="nc" id="L825">        InputMethodLocator locator = inputMethodLocator;</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">        if (locator == null) {</span>
<span class="nc" id="L827">            inputMethodCreationFailed = true;</span>
<span class="nc" id="L828">            return null;</span>
        }

<span class="nc" id="L831">        Locale locale = locator.getLocale();</span>
<span class="nc" id="L832">        InputMethod inputMethodInstance = null;</span>

        // see whether we have a previously used input method
<span class="nc bnc" id="L835" title="All 2 branches missed.">        if (usedInputMethods != null) {</span>
<span class="nc" id="L836">            inputMethodInstance = usedInputMethods.remove(locator.deriveLocator(null));</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            if (inputMethodInstance != null) {</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">                if (locale != null) {</span>
<span class="nc" id="L839">                    inputMethodInstance.setLocale(locale);</span>
                }
<span class="nc" id="L841">                inputMethodInstance.setCharacterSubsets(characterSubsets);</span>
<span class="nc" id="L842">                Boolean state = perInputMethodState.remove(inputMethodInstance);</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">                if (state != null) {</span>
<span class="nc" id="L844">                    enableClientWindowNotification(inputMethodInstance, state.booleanValue());</span>
                }
<span class="nc bnc" id="L846" title="All 2 branches missed.">                ((InputMethodContext) this).setInputMethodSupportsBelowTheSpot(</span>
                        (!(inputMethodInstance instanceof InputMethodAdapter)) ||
<span class="nc bnc" id="L848" title="All 2 branches missed.">                        ((InputMethodAdapter) inputMethodInstance).supportsBelowTheSpot());</span>
<span class="nc" id="L849">                return inputMethodInstance;</span>
            }
        }

        // need to create new instance
        try {
<span class="nc" id="L855">            inputMethodInstance = locator.getDescriptor().createInputMethod();</span>

<span class="nc bnc" id="L857" title="All 2 branches missed.">            if (locale != null) {</span>
<span class="nc" id="L858">                inputMethodInstance.setLocale(locale);</span>
            }
<span class="nc" id="L860">            inputMethodInstance.setInputMethodContext((InputMethodContext) this);</span>
<span class="nc" id="L861">            inputMethodInstance.setCharacterSubsets(characterSubsets);</span>

<span class="nc" id="L863">        } catch (Exception e) {</span>
<span class="nc" id="L864">            logCreationFailed(e);</span>

            // there are a number of bad things that can happen while creating
            // the input method. In any case, we just continue without an
            // input method.
<span class="nc" id="L869">            inputMethodCreationFailed = true;</span>

            // if the instance has been created, then it means either
            // setLocale() or setInputMethodContext() failed.
<span class="nc bnc" id="L873" title="All 2 branches missed.">            if (inputMethodInstance != null) {</span>
<span class="nc" id="L874">                inputMethodInstance = null;</span>
            }
<span class="nc" id="L876">        } catch (LinkageError e) {</span>
<span class="nc" id="L877">            logCreationFailed(e);</span>

            // same as above
<span class="nc" id="L880">            inputMethodCreationFailed = true;</span>
<span class="nc" id="L881">        }</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">        ((InputMethodContext) this).setInputMethodSupportsBelowTheSpot(</span>
                (!(inputMethodInstance instanceof InputMethodAdapter)) ||
<span class="nc bnc" id="L884" title="All 2 branches missed.">                ((InputMethodAdapter) inputMethodInstance).supportsBelowTheSpot());</span>
<span class="nc" id="L885">        return inputMethodInstance;</span>
    }

    private void logCreationFailed(Throwable throwable) {
<span class="nc" id="L889">        PlatformLogger logger = PlatformLogger.getLogger(&quot;sun.awt.im&quot;);</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">        if (logger.isLoggable(PlatformLogger.Level.CONFIG)) {</span>
<span class="nc" id="L891">            String errorTextFormat = Toolkit.getProperty(&quot;AWT.InputMethodCreationFailed&quot;,</span>
                                                         &quot;Could not create {0}. Reason: {1}&quot;);
<span class="nc" id="L893">            Object[] args =</span>
<span class="nc" id="L894">                {inputMethodLocator.getDescriptor().getInputMethodDisplayName(null, Locale.getDefault()),</span>
<span class="nc" id="L895">                 throwable.getLocalizedMessage()};</span>
<span class="nc" id="L896">            MessageFormat mf = new MessageFormat(errorTextFormat);</span>
<span class="nc" id="L897">            logger.config(mf.format(args));</span>
        }
<span class="nc" id="L899">    }</span>

    InputMethodLocator getInputMethodLocator() {
<span class="nc bnc" id="L902" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc" id="L903">            return inputMethodLocator.deriveLocator(inputMethod.getLocale());</span>
        }
<span class="nc" id="L905">        return inputMethodLocator;</span>
    }

    /**
     * @see java.awt.im.InputContext#endComposition
     */
    public synchronized void endComposition() {
<span class="nc bnc" id="L912" title="All 2 branches missed.">        if (inputMethod != null) {</span>
<span class="nc" id="L913">            inputMethod.endComposition();</span>
        }
<span class="nc" id="L915">    }</span>

    /**
     * @see java.awt.im.spi.InputMethodContext#enableClientWindowNotification
     */
    synchronized void enableClientWindowNotification(InputMethod requester,
                                                     boolean enable) {
        // in case this request is not from the current input method,
        // store the request and handle it when this requesting input
        // method becomes the current one.
<span class="nc bnc" id="L925" title="All 2 branches missed.">        if (requester != inputMethod) {</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">            if (perInputMethodState == null) {</span>
<span class="nc" id="L927">                perInputMethodState = new HashMap&lt;&gt;(5);</span>
            }
<span class="nc" id="L929">            perInputMethodState.put(requester, Boolean.valueOf(enable));</span>
<span class="nc" id="L930">            return;</span>
        }

<span class="nc bnc" id="L933" title="All 2 branches missed.">        if (clientWindowNotificationEnabled != enable) {</span>
<span class="nc" id="L934">            clientWindowLocation = null;</span>
<span class="nc" id="L935">            clientWindowNotificationEnabled = enable;</span>
        }
<span class="nc bnc" id="L937" title="All 2 branches missed.">        if (clientWindowNotificationEnabled) {</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">            if (!addedClientWindowListeners()) {</span>
<span class="nc" id="L939">                addClientWindowListeners();</span>
            }
<span class="nc bnc" id="L941" title="All 2 branches missed.">            if (clientWindowListened != null) {</span>
<span class="nc" id="L942">                clientWindowLocation = null;</span>
<span class="nc" id="L943">                notifyClientWindowChange(clientWindowListened);</span>
            }
        } else {
<span class="nc bnc" id="L946" title="All 2 branches missed.">            if (addedClientWindowListeners()) {</span>
<span class="nc" id="L947">                removeClientWindowListeners();</span>
            }
        }
<span class="nc" id="L950">    }</span>

    private synchronized void notifyClientWindowChange(Window window) {
<span class="nc bnc" id="L953" title="All 2 branches missed.">        if (inputMethod == null) {</span>
<span class="nc" id="L954">            return;</span>
        }

        // if the window is invisible or iconified, send null to the input method.
<span class="nc bnc" id="L958" title="All 4 branches missed.">        if (!window.isVisible() ||</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">            ((window instanceof Frame) &amp;&amp; ((Frame)window).getState() == Frame.ICONIFIED)) {</span>
<span class="nc" id="L960">            clientWindowLocation = null;</span>
<span class="nc" id="L961">            inputMethod.notifyClientWindowChange(null);</span>
<span class="nc" id="L962">            return;</span>
        }
<span class="nc" id="L964">        Rectangle location = window.getBounds();</span>
<span class="nc bnc" id="L965" title="All 4 branches missed.">        if (clientWindowLocation == null || !clientWindowLocation.equals(location)) {</span>
<span class="nc" id="L966">            clientWindowLocation = location;</span>
<span class="nc" id="L967">            inputMethod.notifyClientWindowChange(clientWindowLocation);</span>
        }
<span class="nc" id="L969">    }</span>

    private synchronized void addClientWindowListeners() {
<span class="nc" id="L972">        Component client = getClientComponent();</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">        if (client == null) {</span>
<span class="nc" id="L974">            return;</span>
        }
<span class="nc" id="L976">        Window window = getComponentWindow(client);</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">        if (window == null) {</span>
<span class="nc" id="L978">            return;</span>
        }
<span class="nc" id="L980">        window.addComponentListener(this);</span>
<span class="nc" id="L981">        window.addWindowListener(this);</span>
<span class="nc" id="L982">        clientWindowListened = window;</span>
<span class="nc" id="L983">    }</span>

    private synchronized void removeClientWindowListeners() {
<span class="nc" id="L986">        clientWindowListened.removeComponentListener(this);</span>
<span class="nc" id="L987">        clientWindowListened.removeWindowListener(this);</span>
<span class="nc" id="L988">        clientWindowListened = null;</span>
<span class="nc" id="L989">    }</span>

    /**
     * Returns true if listeners have been set up for client window
     * change notification.
     */
    private boolean addedClientWindowListeners() {
<span class="nc bnc" id="L996" title="All 2 branches missed.">        return clientWindowListened != null;</span>
    }

    /*
     * ComponentListener and WindowListener implementation
     */
    public void componentResized(ComponentEvent e) {
<span class="nc" id="L1003">        notifyClientWindowChange((Window)e.getComponent());</span>
<span class="nc" id="L1004">    }</span>

    public void componentMoved(ComponentEvent e) {
<span class="nc" id="L1007">        notifyClientWindowChange((Window)e.getComponent());</span>
<span class="nc" id="L1008">    }</span>

    public void componentShown(ComponentEvent e) {
<span class="nc" id="L1011">        notifyClientWindowChange((Window)e.getComponent());</span>
<span class="nc" id="L1012">    }</span>

    public void componentHidden(ComponentEvent e) {
<span class="nc" id="L1015">        notifyClientWindowChange((Window)e.getComponent());</span>
<span class="nc" id="L1016">    }</span>

<span class="nc" id="L1018">    public void windowOpened(WindowEvent e) {}</span>
<span class="nc" id="L1019">    public void windowClosing(WindowEvent e) {}</span>
<span class="nc" id="L1020">    public void windowClosed(WindowEvent e) {}</span>

    public void windowIconified(WindowEvent e) {
<span class="nc" id="L1023">        notifyClientWindowChange(e.getWindow());</span>
<span class="nc" id="L1024">    }</span>

    public void windowDeiconified(WindowEvent e) {
<span class="nc" id="L1027">        notifyClientWindowChange(e.getWindow());</span>
<span class="nc" id="L1028">    }</span>

<span class="nc" id="L1030">    public void windowActivated(WindowEvent e) {}</span>
<span class="nc" id="L1031">    public void windowDeactivated(WindowEvent e) {}</span>

    /**
     * Initializes the input method selection key definition in preference trees
     */
    private void initializeInputMethodSelectionKey() {
<span class="nc" id="L1037">        AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() {</span>
            public Object run() {
                // Look in user's tree
<span class="nc" id="L1040">                Preferences root = Preferences.userRoot();</span>
<span class="nc" id="L1041">                inputMethodSelectionKey = getInputMethodSelectionKeyStroke(root);</span>

<span class="nc bnc" id="L1043" title="All 2 branches missed.">                if (inputMethodSelectionKey == null) {</span>
                    // Look in system's tree
<span class="nc" id="L1045">                    root = Preferences.systemRoot();</span>
<span class="nc" id="L1046">                    inputMethodSelectionKey = getInputMethodSelectionKeyStroke(root);</span>
                }
<span class="nc" id="L1048">                return null;</span>
            }
        });
<span class="nc" id="L1051">    }</span>

    private AWTKeyStroke getInputMethodSelectionKeyStroke(Preferences root) {
        try {
<span class="nc bnc" id="L1055" title="All 2 branches missed.">            if (root.nodeExists(inputMethodSelectionKeyPath)) {</span>
<span class="nc" id="L1056">                Preferences node = root.node(inputMethodSelectionKeyPath);</span>
<span class="nc" id="L1057">                int keyCode = node.getInt(inputMethodSelectionKeyCodeName, KeyEvent.VK_UNDEFINED);</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">                if (keyCode != KeyEvent.VK_UNDEFINED) {</span>
<span class="nc" id="L1059">                    int modifiers = node.getInt(inputMethodSelectionKeyModifiersName, 0);</span>
<span class="nc" id="L1060">                    return AWTKeyStroke.getAWTKeyStroke(keyCode, modifiers);</span>
                }
            }
<span class="nc" id="L1063">        } catch (BackingStoreException bse) {</span>
<span class="nc" id="L1064">        }</span>

<span class="nc" id="L1066">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>