<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>ExecutableInputMethodManager.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.awt.im</a> &gt; <span class="el_source">ExecutableInputMethodManager.java</span></div><h1>ExecutableInputMethodManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1998, 2003, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.awt.im;

import java.awt.AWTException;
import java.awt.CheckboxMenuItem;
import java.awt.Component;
import java.awt.Dialog;
import java.awt.EventQueue;
import java.awt.Frame;
import java.awt.PopupMenu;
import java.awt.Menu;
import java.awt.MenuItem;
import java.awt.Toolkit;
import sun.awt.AppContext;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.InvocationEvent;
import java.awt.im.spi.InputMethodDescriptor;
import java.lang.reflect.InvocationTargetException;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.security.PrivilegedActionException;
import java.security.PrivilegedExceptionAction;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.Locale;
import java.util.ServiceLoader;
import java.util.Vector;
import java.util.Set;
import java.util.prefs.BackingStoreException;
import java.util.prefs.Preferences;
import sun.awt.InputMethodSupport;
import sun.awt.SunToolkit;

/**
 * &lt;code&gt;ExecutableInputMethodManager&lt;/code&gt; is the implementation of the
 * &lt;code&gt;InputMethodManager&lt;/code&gt; class. It is runnable as a separate
 * thread in the AWT environment.&amp;nbsp;
 * &lt;code&gt;InputMethodManager.getInstance()&lt;/code&gt; creates an instance of
 * &lt;code&gt;ExecutableInputMethodManager&lt;/code&gt; and executes it as a deamon
 * thread.
 *
 * @see InputMethodManager
 */
class ExecutableInputMethodManager extends InputMethodManager
                                   implements Runnable
{
    // the input context that's informed about selections from the user interface
    private InputContext currentInputContext;

    // Menu item string for the trigger menu.
    private String triggerMenuString;

    // popup menu for selecting an input method
    private InputMethodPopupMenu selectionMenu;
    private static String selectInputMethodMenuTitle;

    // locator and name of host adapter
    private InputMethodLocator hostAdapterLocator;

    // locators for Java input methods
    private int javaInputMethodCount;         // number of Java input methods found
    private Vector&lt;InputMethodLocator&gt; javaInputMethodLocatorList;

    // component that is requesting input method switch
    // must be Frame or Dialog
    private Component requestComponent;

    // input context that is requesting input method switch
    private InputContext requestInputContext;

    // IM preference stuff
    private static final String preferredIMNode = &quot;/sun/awt/im/preferredInputMethod&quot;;
    private static final String descriptorKey = &quot;descriptor&quot;;
<span class="nc" id="L99">    private Hashtable&lt;String, InputMethodLocator&gt; preferredLocatorCache = new Hashtable&lt;&gt;();</span>
    private Preferences userRoot;

<span class="nc" id="L102">    ExecutableInputMethodManager() {</span>

        // set up host adapter locator
<span class="nc" id="L105">        Toolkit toolkit = Toolkit.getDefaultToolkit();</span>
        try {
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (toolkit instanceof InputMethodSupport) {</span>
<span class="nc" id="L108">                InputMethodDescriptor hostAdapterDescriptor =</span>
                    ((InputMethodSupport)toolkit)
<span class="nc" id="L110">                    .getInputMethodAdapterDescriptor();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                if (hostAdapterDescriptor != null) {</span>
<span class="nc" id="L112">                    hostAdapterLocator = new InputMethodLocator(hostAdapterDescriptor, null, null);</span>
                }
            }
<span class="nc" id="L115">        } catch (AWTException e) {</span>
            // if we can't get a descriptor, we'll just have to do without native input methods
<span class="nc" id="L117">        }</span>

<span class="nc" id="L119">        javaInputMethodLocatorList = new Vector&lt;InputMethodLocator&gt;();</span>
<span class="nc" id="L120">        initializeInputMethodLocatorList();</span>
<span class="nc" id="L121">    }</span>

    synchronized void initialize() {
<span class="nc" id="L124">        selectInputMethodMenuTitle = Toolkit.getProperty(&quot;AWT.InputMethodSelectionMenu&quot;, &quot;Select Input Method&quot;);</span>

<span class="nc" id="L126">        triggerMenuString = selectInputMethodMenuTitle;</span>
<span class="nc" id="L127">    }</span>

    public void run() {
        // If there are no multiple input methods to choose from, wait forever
<span class="nc bnc" id="L131" title="All 2 branches missed.">        while (!hasMultipleInputMethods()) {</span>
            try {
<span class="nc" id="L133">                synchronized (this) {</span>
<span class="nc" id="L134">                    wait();</span>
<span class="nc" id="L135">                }</span>
<span class="nc" id="L136">            } catch (InterruptedException e) {</span>
<span class="nc" id="L137">            }</span>
        }

        // Loop for processing input method change requests
        while (true) {
<span class="nc" id="L142">            waitForChangeRequest();</span>
<span class="nc" id="L143">            initializeInputMethodLocatorList();</span>
            try {
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (requestComponent != null) {</span>
<span class="nc" id="L146">                    showInputMethodMenuOnRequesterEDT(requestComponent);</span>
                } else {
                    // show the popup menu within the event thread
<span class="nc" id="L149">                    EventQueue.invokeAndWait(new Runnable() {</span>
                        public void run() {
<span class="nc" id="L151">                            showInputMethodMenu();</span>
<span class="nc" id="L152">                        }</span>
                    });
                }
<span class="nc" id="L155">            } catch (InterruptedException ie) {</span>
<span class="nc" id="L156">            } catch (InvocationTargetException ite) {</span>
                // should we do anything under these exceptions?
<span class="nc" id="L158">            }</span>
        }
    }

    // Shows Input Method Menu on the EDT of requester component
    // to avoid side effects. See 6544309.
    private void showInputMethodMenuOnRequesterEDT(Component requester)
        throws InterruptedException, InvocationTargetException {

<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (requester == null){</span>
<span class="nc" id="L168">            return;</span>
        }

<span class="nc" id="L171">        class AWTInvocationLock {}</span>
<span class="nc" id="L172">        Object lock = new AWTInvocationLock();</span>

<span class="nc" id="L174">        InvocationEvent event =</span>
                new InvocationEvent(requester,
<span class="nc" id="L176">                                    new Runnable() {</span>
                                        public void run() {
<span class="nc" id="L178">                                            showInputMethodMenu();</span>
<span class="nc" id="L179">                                        }</span>
                                    },
                                    lock,
                                    true);

<span class="nc" id="L184">        AppContext requesterAppContext = SunToolkit.targetToAppContext(requester);</span>
<span class="nc" id="L185">        synchronized (lock) {</span>
<span class="nc" id="L186">            SunToolkit.postEvent(requesterAppContext, event);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            while (!event.isDispatched()) {</span>
<span class="nc" id="L188">                lock.wait();</span>
            }
<span class="nc" id="L190">        }</span>

<span class="nc" id="L192">        Throwable eventThrowable = event.getThrowable();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (eventThrowable != null) {</span>
<span class="nc" id="L194">            throw new InvocationTargetException(eventThrowable);</span>
        }
<span class="nc" id="L196">    }</span>

    void setInputContext(InputContext inputContext) {
<span class="nc bnc" id="L199" title="All 4 branches missed.">        if (currentInputContext != null &amp;&amp; inputContext != null) {</span>
            // don't throw this exception until 4237852 is fixed
            // throw new IllegalStateException(&quot;Can't have two active InputContext at the same time&quot;);
        }
<span class="nc" id="L203">        currentInputContext = inputContext;</span>
<span class="nc" id="L204">    }</span>

    public synchronized void notifyChangeRequest(Component comp) {
<span class="nc bnc" id="L207" title="All 4 branches missed.">        if (!(comp instanceof Frame || comp instanceof Dialog))</span>
<span class="nc" id="L208">            return;</span>

        // if busy with the current request, ignore this request.
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (requestComponent != null)</span>
<span class="nc" id="L212">            return;</span>

<span class="nc" id="L214">        requestComponent = comp;</span>
<span class="nc" id="L215">        notify();</span>
<span class="nc" id="L216">    }</span>

    public synchronized void notifyChangeRequestByHotKey(Component comp) {
<span class="nc bnc" id="L219" title="All 4 branches missed.">        while (!(comp instanceof Frame || comp instanceof Dialog)) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (comp == null) {</span>
                // no Frame or Dialog found in containment hierarchy.
<span class="nc" id="L222">                return;</span>
            }
<span class="nc" id="L224">            comp = comp.getParent();</span>
        }

<span class="nc" id="L227">        notifyChangeRequest(comp);</span>
<span class="nc" id="L228">    }</span>

    public String getTriggerMenuString() {
<span class="nc" id="L231">        return triggerMenuString;</span>
    }

    /*
     * Returns true if the environment indicates there are multiple input methods
     */
    boolean hasMultipleInputMethods() {
<span class="nc bnc" id="L238" title="All 6 branches missed.">        return ((hostAdapterLocator != null) &amp;&amp; (javaInputMethodCount &gt; 0)</span>
                || (javaInputMethodCount &gt; 1));
    }

    private synchronized void waitForChangeRequest() {
        try {
<span class="nc bnc" id="L244" title="All 2 branches missed.">            while (requestComponent == null) {</span>
<span class="nc" id="L245">                wait();</span>
            }
<span class="nc" id="L247">        } catch (InterruptedException e) {</span>
<span class="nc" id="L248">        }</span>
<span class="nc" id="L249">    }</span>

    /*
     * initializes the input method locator list for all
     * installed input method descriptors.
     */
    private void initializeInputMethodLocatorList() {
<span class="nc" id="L256">        synchronized (javaInputMethodLocatorList) {</span>
<span class="nc" id="L257">            javaInputMethodLocatorList.clear();</span>
            try {
<span class="nc" id="L259">                AccessController.doPrivileged(new PrivilegedExceptionAction&lt;Object&gt;() {</span>
                    public Object run() {
                        for (InputMethodDescriptor descriptor :
<span class="nc bnc" id="L262" title="All 2 branches missed.">                            ServiceLoader.loadInstalled(InputMethodDescriptor.class)) {</span>
<span class="nc" id="L263">                            ClassLoader cl = descriptor.getClass().getClassLoader();</span>
<span class="nc" id="L264">                            javaInputMethodLocatorList.add(new InputMethodLocator(descriptor, cl, null));</span>
<span class="nc" id="L265">                        }</span>
<span class="nc" id="L266">                        return null;</span>
                    }
                });
<span class="nc" id="L269">            }  catch (PrivilegedActionException e) {</span>
<span class="nc" id="L270">                e.printStackTrace();</span>
<span class="nc" id="L271">            }</span>
<span class="nc" id="L272">            javaInputMethodCount = javaInputMethodLocatorList.size();</span>
<span class="nc" id="L273">        }</span>

<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (hasMultipleInputMethods()) {</span>
            // initialize preferences
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (userRoot == null) {</span>
<span class="nc" id="L278">                userRoot = getUserRoot();</span>
            }
        } else {
            // indicate to clients not to offer the menu
<span class="nc" id="L282">            triggerMenuString = null;</span>
        }
<span class="nc" id="L284">    }</span>

    private void showInputMethodMenu() {

<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (!hasMultipleInputMethods()) {</span>
<span class="nc" id="L289">            requestComponent = null;</span>
<span class="nc" id="L290">            return;</span>
        }

        // initialize pop-up menu
<span class="nc" id="L294">        selectionMenu = InputMethodPopupMenu.getInstance(requestComponent, selectInputMethodMenuTitle);</span>

        // we have to rebuild the menu each time because
        // some input methods (such as IIIMP) may change
        // their list of supported locales dynamically
<span class="nc" id="L299">        selectionMenu.removeAll();</span>

        // get information about the currently selected input method
        // ??? if there's no current input context, what's the point
        // of showing the menu?
<span class="nc" id="L304">        String currentSelection = getCurrentSelection();</span>

        // Add menu item for host adapter
<span class="nc bnc" id="L307" title="All 2 branches missed.">        if (hostAdapterLocator != null) {</span>
<span class="nc" id="L308">            selectionMenu.addOneInputMethodToMenu(hostAdapterLocator, currentSelection);</span>
<span class="nc" id="L309">            selectionMenu.addSeparator();</span>
        }

        // Add menu items for other input methods
<span class="nc bnc" id="L313" title="All 2 branches missed.">        for (int i = 0; i &lt; javaInputMethodLocatorList.size(); i++) {</span>
<span class="nc" id="L314">            InputMethodLocator locator = javaInputMethodLocatorList.get(i);</span>
<span class="nc" id="L315">            selectionMenu.addOneInputMethodToMenu(locator, currentSelection);</span>
        }

<span class="nc" id="L318">        synchronized (this) {</span>
<span class="nc" id="L319">            selectionMenu.addToComponent(requestComponent);</span>
<span class="nc" id="L320">            requestInputContext = currentInputContext;</span>
<span class="nc" id="L321">            selectionMenu.show(requestComponent, 60, 80); // TODO: get proper x, y...</span>
<span class="nc" id="L322">            requestComponent = null;</span>
<span class="nc" id="L323">        }</span>
<span class="nc" id="L324">    }</span>

    private String getCurrentSelection() {
<span class="nc" id="L327">        InputContext inputContext = currentInputContext;</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (inputContext != null) {</span>
<span class="nc" id="L329">            InputMethodLocator locator = inputContext.getInputMethodLocator();</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if (locator != null) {</span>
<span class="nc" id="L331">                return locator.getActionCommandString();</span>
            }
        }
<span class="nc" id="L334">        return null;</span>
    }

    synchronized void changeInputMethod(String choice) {
<span class="nc" id="L338">        InputMethodLocator locator = null;</span>

<span class="nc" id="L340">        String inputMethodName = choice;</span>
<span class="nc" id="L341">        String localeString = null;</span>
<span class="nc" id="L342">        int index = choice.indexOf('\n');</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (index != -1) {</span>
<span class="nc" id="L344">            localeString = choice.substring(index + 1);</span>
<span class="nc" id="L345">            inputMethodName = choice.substring(0, index);</span>
        }
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (hostAdapterLocator.getActionCommandString().equals(inputMethodName)) {</span>
<span class="nc" id="L348">            locator = hostAdapterLocator;</span>
        } else {
<span class="nc bnc" id="L350" title="All 2 branches missed.">            for (int i = 0; i &lt; javaInputMethodLocatorList.size(); i++) {</span>
<span class="nc" id="L351">                InputMethodLocator candidate = javaInputMethodLocatorList.get(i);</span>
<span class="nc" id="L352">                String name = candidate.getActionCommandString();</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                if (name.equals(inputMethodName)) {</span>
<span class="nc" id="L354">                    locator = candidate;</span>
<span class="nc" id="L355">                    break;</span>
                }
            }
        }

<span class="nc bnc" id="L360" title="All 4 branches missed.">        if (locator != null &amp;&amp; localeString != null) {</span>
<span class="nc" id="L361">            String language = &quot;&quot;, country = &quot;&quot;, variant = &quot;&quot;;</span>
<span class="nc" id="L362">            int postIndex = localeString.indexOf('_');</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">            if (postIndex == -1) {</span>
<span class="nc" id="L364">                language = localeString;</span>
            } else {
<span class="nc" id="L366">                language = localeString.substring(0, postIndex);</span>
<span class="nc" id="L367">                int preIndex = postIndex + 1;</span>
<span class="nc" id="L368">                postIndex = localeString.indexOf('_', preIndex);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">                if (postIndex == -1) {</span>
<span class="nc" id="L370">                    country = localeString.substring(preIndex);</span>
                } else {
<span class="nc" id="L372">                    country = localeString.substring(preIndex, postIndex);</span>
<span class="nc" id="L373">                    variant = localeString.substring(postIndex + 1);</span>
                }
            }
<span class="nc" id="L376">            Locale locale = new Locale(language, country, variant);</span>
<span class="nc" id="L377">            locator = locator.deriveLocator(locale);</span>
        }

<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (locator == null)</span>
<span class="nc" id="L381">            return;</span>

        // tell the input context about the change
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (requestInputContext != null) {</span>
<span class="nc" id="L385">            requestInputContext.changeInputMethod(locator);</span>
<span class="nc" id="L386">            requestInputContext = null;</span>

            // remember the selection
<span class="nc" id="L389">            putPreferredInputMethod(locator);</span>
        }
<span class="nc" id="L391">    }</span>

    InputMethodLocator findInputMethod(Locale locale) {
        // look for preferred input method first
<span class="nc" id="L395">        InputMethodLocator locator = getPreferredInputMethod(locale);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">        if (locator != null) {</span>
<span class="nc" id="L397">            return locator;</span>
        }

<span class="nc bnc" id="L400" title="All 4 branches missed.">        if (hostAdapterLocator != null &amp;&amp; hostAdapterLocator.isLocaleAvailable(locale)) {</span>
<span class="nc" id="L401">            return hostAdapterLocator.deriveLocator(locale);</span>
        }

        // Update the locator list
<span class="nc" id="L405">        initializeInputMethodLocatorList();</span>

<span class="nc bnc" id="L407" title="All 2 branches missed.">        for (int i = 0; i &lt; javaInputMethodLocatorList.size(); i++) {</span>
<span class="nc" id="L408">            InputMethodLocator candidate = javaInputMethodLocatorList.get(i);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">            if (candidate.isLocaleAvailable(locale)) {</span>
<span class="nc" id="L410">                return candidate.deriveLocator(locale);</span>
            }
        }
<span class="nc" id="L413">        return null;</span>
    }

    Locale getDefaultKeyboardLocale() {
<span class="nc" id="L417">        Toolkit toolkit = Toolkit.getDefaultToolkit();</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (toolkit instanceof InputMethodSupport) {</span>
<span class="nc" id="L419">            return ((InputMethodSupport)toolkit).getDefaultKeyboardLocale();</span>
        } else {
<span class="nc" id="L421">            return Locale.getDefault();</span>
        }
    }

    /**
     * Returns a InputMethodLocator object that the
     * user prefers for the given locale.
     *
     * @param locale Locale for which the user prefers the input method.
     */
    private synchronized InputMethodLocator getPreferredInputMethod(Locale locale) {
<span class="nc" id="L432">        InputMethodLocator preferredLocator = null;</span>

<span class="nc bnc" id="L434" title="All 2 branches missed.">        if (!hasMultipleInputMethods()) {</span>
            // No need to look for a preferred Java input method
<span class="nc" id="L436">            return null;</span>
        }

        // look for the cached preference first.
<span class="nc" id="L440">        preferredLocator = preferredLocatorCache.get(locale.toString().intern());</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (preferredLocator != null) {</span>
<span class="nc" id="L442">            return preferredLocator;</span>
        }

        // look for the preference in the user preference tree
<span class="nc" id="L446">        String nodePath = findPreferredInputMethodNode(locale);</span>
<span class="nc" id="L447">        String descriptorName = readPreferredInputMethod(nodePath);</span>
        Locale advertised;

        // get the locator object
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (descriptorName != null) {</span>
            // check for the host adapter first
<span class="nc bnc" id="L453" title="All 2 branches missed.">            if (hostAdapterLocator != null &amp;&amp;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                hostAdapterLocator.getDescriptor().getClass().getName().equals(descriptorName)) {</span>
<span class="nc" id="L455">                advertised = getAdvertisedLocale(hostAdapterLocator, locale);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                if (advertised != null) {</span>
<span class="nc" id="L457">                    preferredLocator = hostAdapterLocator.deriveLocator(advertised);</span>
<span class="nc" id="L458">                    preferredLocatorCache.put(locale.toString().intern(), preferredLocator);</span>
                }
<span class="nc" id="L460">                return preferredLocator;</span>
            }
            // look for Java input methods
<span class="nc bnc" id="L463" title="All 2 branches missed.">            for (int i = 0; i &lt; javaInputMethodLocatorList.size(); i++) {</span>
<span class="nc" id="L464">                InputMethodLocator locator = javaInputMethodLocatorList.get(i);</span>
<span class="nc" id="L465">                InputMethodDescriptor descriptor = locator.getDescriptor();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">                if (descriptor.getClass().getName().equals(descriptorName)) {</span>
<span class="nc" id="L467">                    advertised = getAdvertisedLocale(locator, locale);</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                    if (advertised != null) {</span>
<span class="nc" id="L469">                        preferredLocator = locator.deriveLocator(advertised);</span>
<span class="nc" id="L470">                        preferredLocatorCache.put(locale.toString().intern(), preferredLocator);</span>
                    }
<span class="nc" id="L472">                    return preferredLocator;</span>
                }
            }

            // maybe preferred input method information is bogus.
<span class="nc" id="L477">            writePreferredInputMethod(nodePath, null);</span>
        }

<span class="nc" id="L480">        return null;</span>
    }

    private String findPreferredInputMethodNode(Locale locale) {
<span class="nc bnc" id="L484" title="All 2 branches missed.">        if (userRoot == null) {</span>
<span class="nc" id="L485">            return null;</span>
        }

        // create locale node relative path
<span class="nc" id="L489">        String nodePath = preferredIMNode + &quot;/&quot; + createLocalePath(locale);</span>

        // look for the descriptor
<span class="nc bnc" id="L492" title="All 2 branches missed.">        while (!nodePath.equals(preferredIMNode)) {</span>
            try {
<span class="nc bnc" id="L494" title="All 2 branches missed.">                if (userRoot.nodeExists(nodePath)) {</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">                    if (readPreferredInputMethod(nodePath) != null) {</span>
<span class="nc" id="L496">                        return nodePath;</span>
                    }
                }
<span class="nc" id="L499">            } catch (BackingStoreException bse) {</span>
<span class="nc" id="L500">            }</span>

            // search at parent's node
<span class="nc" id="L503">            nodePath = nodePath.substring(0, nodePath.lastIndexOf('/'));</span>
        }

<span class="nc" id="L506">        return null;</span>
    }

    private String readPreferredInputMethod(String nodePath) {
<span class="nc bnc" id="L510" title="All 4 branches missed.">        if ((userRoot == null) || (nodePath == null)) {</span>
<span class="nc" id="L511">            return null;</span>
        }

<span class="nc" id="L514">        return userRoot.node(nodePath).get(descriptorKey, null);</span>
    }

    /**
     * Writes the preferred input method descriptor class name into
     * the user's Preferences tree in accordance with the given locale.
     *
     * @param inputMethodLocator input method locator to remember.
     */
    private synchronized void putPreferredInputMethod(InputMethodLocator locator) {
<span class="nc" id="L524">        InputMethodDescriptor descriptor = locator.getDescriptor();</span>
<span class="nc" id="L525">        Locale preferredLocale = locator.getLocale();</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (preferredLocale == null) {</span>
            // check available locales of the input method
            try {
<span class="nc" id="L530">                Locale[] availableLocales = descriptor.getAvailableLocales();</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">                if (availableLocales.length == 1) {</span>
<span class="nc" id="L532">                    preferredLocale = availableLocales[0];</span>
                } else {
                    // there is no way to know which locale is the preferred one, so do nothing.
<span class="nc" id="L535">                    return;</span>
                }
<span class="nc" id="L537">            } catch (AWTException ae) {</span>
                // do nothing here, either.
<span class="nc" id="L539">                return;</span>
<span class="nc" id="L540">            }</span>
        }

        // for regions that have only one language, we need to regard
        // &quot;xx_YY&quot; as &quot;xx&quot; when putting the preference into tree
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (preferredLocale.equals(Locale.JAPAN)) {</span>
<span class="nc" id="L546">            preferredLocale = Locale.JAPANESE;</span>
        }
<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (preferredLocale.equals(Locale.KOREA)) {</span>
<span class="nc" id="L549">            preferredLocale = Locale.KOREAN;</span>
        }
<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (preferredLocale.equals(new Locale(&quot;th&quot;, &quot;TH&quot;))) {</span>
<span class="nc" id="L552">            preferredLocale = new Locale(&quot;th&quot;);</span>
        }

        // obtain node
<span class="nc" id="L556">        String path = preferredIMNode + &quot;/&quot; + createLocalePath(preferredLocale);</span>

        // write in the preference tree
<span class="nc" id="L559">        writePreferredInputMethod(path, descriptor.getClass().getName());</span>
<span class="nc" id="L560">        preferredLocatorCache.put(preferredLocale.toString().intern(),</span>
<span class="nc" id="L561">            locator.deriveLocator(preferredLocale));</span>

<span class="nc" id="L563">        return;</span>
    }

    private String createLocalePath(Locale locale) {
<span class="nc" id="L567">        String language = locale.getLanguage();</span>
<span class="nc" id="L568">        String country = locale.getCountry();</span>
<span class="nc" id="L569">        String variant = locale.getVariant();</span>
<span class="nc" id="L570">        String localePath = null;</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">        if (!variant.equals(&quot;&quot;)) {</span>
<span class="nc" id="L572">            localePath = &quot;_&quot; + language + &quot;/_&quot; + country + &quot;/_&quot; + variant;</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">        } else if (!country.equals(&quot;&quot;)) {</span>
<span class="nc" id="L574">            localePath = &quot;_&quot; + language + &quot;/_&quot; + country;</span>
        } else {
<span class="nc" id="L576">            localePath = &quot;_&quot; + language;</span>
        }

<span class="nc" id="L579">        return localePath;</span>
    }

    private void writePreferredInputMethod(String path, String descriptorName) {
<span class="nc bnc" id="L583" title="All 2 branches missed.">        if (userRoot != null) {</span>
<span class="nc" id="L584">            Preferences node = userRoot.node(path);</span>

            // record it
<span class="nc bnc" id="L587" title="All 2 branches missed.">            if (descriptorName != null) {</span>
<span class="nc" id="L588">                node.put(descriptorKey, descriptorName);</span>
            } else {
<span class="nc" id="L590">                node.remove(descriptorKey);</span>
            }
        }
<span class="nc" id="L593">    }</span>

    private Preferences getUserRoot() {
<span class="nc" id="L596">        return AccessController.doPrivileged(new PrivilegedAction&lt;Preferences&gt;() {</span>
            public Preferences run() {
<span class="nc" id="L598">                return Preferences.userRoot();</span>
            }
        });
    }

    private Locale getAdvertisedLocale(InputMethodLocator locator, Locale locale) {
<span class="nc" id="L604">        Locale advertised = null;</span>

<span class="nc bnc" id="L606" title="All 2 branches missed.">        if (locator.isLocaleAvailable(locale)) {</span>
<span class="nc" id="L607">            advertised = locale;</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">        } else if (locale.getLanguage().equals(&quot;ja&quot;)) {</span>
            // for Japanese, Korean, and Thai, check whether the input method supports
            // language or language_COUNTRY.
<span class="nc bnc" id="L611" title="All 2 branches missed.">            if (locator.isLocaleAvailable(Locale.JAPAN)) {</span>
<span class="nc" id="L612">                advertised = Locale.JAPAN;</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">            } else if (locator.isLocaleAvailable(Locale.JAPANESE)) {</span>
<span class="nc" id="L614">                advertised = Locale.JAPANESE;</span>
            }
<span class="nc bnc" id="L616" title="All 2 branches missed.">        } else if (locale.getLanguage().equals(&quot;ko&quot;)) {</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">            if (locator.isLocaleAvailable(Locale.KOREA)) {</span>
<span class="nc" id="L618">                advertised = Locale.KOREA;</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">            } else if (locator.isLocaleAvailable(Locale.KOREAN)) {</span>
<span class="nc" id="L620">                advertised = Locale.KOREAN;</span>
            }
<span class="nc bnc" id="L622" title="All 2 branches missed.">        } else if (locale.getLanguage().equals(&quot;th&quot;)) {</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">            if (locator.isLocaleAvailable(new Locale(&quot;th&quot;, &quot;TH&quot;))) {</span>
<span class="nc" id="L624">                advertised = new Locale(&quot;th&quot;, &quot;TH&quot;);</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">            } else if (locator.isLocaleAvailable(new Locale(&quot;th&quot;))) {</span>
<span class="nc" id="L626">                advertised = new Locale(&quot;th&quot;);</span>
            }
        }

<span class="nc" id="L630">        return advertised;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>