<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>GSSNameElement.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.jgss.wrapper</a> &gt; <span class="el_source">GSSNameElement.java</span></div><h1>GSSNameElement.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.jgss.wrapper;

import org.ietf.jgss.*;
import java.security.Provider;
import java.security.Security;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import sun.security.jgss.GSSUtil;
import sun.security.util.ObjectIdentifier;
import sun.security.util.DerInputStream;
import sun.security.util.DerOutputStream;
import sun.security.jgss.GSSUtil;
import sun.security.jgss.GSSExceptionImpl;
import sun.security.jgss.spi.GSSNameSpi;

/**
 * This class is essentially a wrapper class for the gss_name_t
 * structure of the native GSS library.
 * @author Valerie Peng
 * @since 1.6
 */

<span class="fc bfc" id="L48" title="All 2 branches covered.">public class GSSNameElement implements GSSNameSpi {</span>

<span class="fc" id="L50">    long pName = 0; // Pointer to the gss_name_t structure</span>
    private String printableName;
    private Oid printableType;
    private GSSLibStub cStub;

<span class="fc" id="L55">    static final GSSNameElement DEF_ACCEPTOR = new GSSNameElement();</span>

    private static Oid getNativeNameType(Oid nameType, GSSLibStub stub) {
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">        if (GSSUtil.NT_GSS_KRB5_PRINCIPAL.equals(nameType)) {</span>
<span class="nc" id="L59">            Oid[] supportedNTs = null;</span>
            try {
<span class="nc" id="L61">                supportedNTs = stub.inquireNamesForMech();</span>
<span class="nc" id="L62">            } catch (GSSException ge) {</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">                if (ge.getMajor() == GSSException.BAD_MECH &amp;&amp;</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">                    GSSUtil.isSpNegoMech(stub.getMech())) {</span>
                    // Workaround known Heimdal issue and retry with KRB5
                    try {
<span class="nc" id="L67">                        stub = GSSLibStub.getInstance</span>
<span class="nc" id="L68">                            (GSSUtil.GSS_KRB5_MECH_OID);</span>
<span class="nc" id="L69">                        supportedNTs = stub.inquireNamesForMech();</span>
<span class="nc" id="L70">                    } catch (GSSException ge2) {</span>
                        // Should never happen
<span class="nc" id="L72">                        SunNativeProvider.debug(&quot;Name type list unavailable: &quot; +</span>
<span class="nc" id="L73">                            ge2.getMajorString());</span>
<span class="nc" id="L74">                    }</span>
                } else {
<span class="nc" id="L76">                    SunNativeProvider.debug(&quot;Name type list unavailable: &quot; +</span>
<span class="nc" id="L77">                        ge.getMajorString());</span>
                }
<span class="nc" id="L79">            }</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (supportedNTs != null) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                for (int i = 0; i &lt; supportedNTs.length; i++) {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                    if (supportedNTs[i].equals(nameType)) return nameType;</span>
                }
                // Special handling the specified name type
<span class="nc" id="L85">                SunNativeProvider.debug(&quot;Override &quot; + nameType +</span>
                    &quot; with mechanism default(null)&quot;);
<span class="nc" id="L87">                return null; // Use mechanism specific default</span>
            }
        }
<span class="fc" id="L90">        return nameType;</span>
    }

<span class="fc" id="L93">    private GSSNameElement() {</span>
<span class="fc" id="L94">        printableName = &quot;&lt;DEFAULT ACCEPTOR&gt;&quot;;</span>
<span class="fc" id="L95">    }</span>

<span class="fc" id="L97">    GSSNameElement(long pNativeName, GSSLibStub stub) throws GSSException {</span>
<span class="pc bpc" id="L98" title="3 of 4 branches missed.">        assert(stub != null);</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">        if (pNativeName == 0) {</span>
<span class="nc" id="L100">            throw new GSSException(GSSException.BAD_NAME);</span>
        }
        // Note: pNativeName is assumed to be a MN.
<span class="fc" id="L103">        pName = pNativeName;</span>
<span class="fc" id="L104">        cStub = stub;</span>
<span class="fc" id="L105">        setPrintables();</span>
<span class="fc" id="L106">    }</span>

    GSSNameElement(byte[] nameBytes, Oid nameType, GSSLibStub stub)
<span class="fc" id="L109">        throws GSSException {</span>
<span class="pc bpc" id="L110" title="2 of 4 branches missed.">        assert(stub != null);</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        if (nameBytes == null) {</span>
<span class="nc" id="L112">            throw new GSSException(GSSException.BAD_NAME);</span>
        }
<span class="fc" id="L114">        cStub = stub;</span>
<span class="fc" id="L115">        byte[] name = nameBytes;</span>

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (nameType != null) {</span>
            // Special handling the specified name type if
            // necessary
<span class="fc" id="L120">            nameType = getNativeNameType(nameType, stub);</span>

<span class="pc bpc" id="L122" title="1 of 2 branches missed.">            if (GSSName.NT_EXPORT_NAME.equals(nameType)) {</span>
                // Need to add back the mech Oid portion (stripped
                // off by GSSNameImpl class prior to calling this
                // method) for &quot;NT_EXPORT_NAME&quot;
<span class="nc" id="L126">                byte[] mechBytes = null;</span>
<span class="nc" id="L127">                DerOutputStream dout = new DerOutputStream();</span>
<span class="nc" id="L128">                Oid mech = cStub.getMech();</span>
                try {
<span class="nc" id="L130">                    dout.putOID(new ObjectIdentifier(mech.toString()));</span>
<span class="nc" id="L131">                } catch (IOException e) {</span>
<span class="nc" id="L132">                    throw new GSSExceptionImpl(GSSException.FAILURE, e);</span>
<span class="nc" id="L133">                }</span>
<span class="nc" id="L134">                mechBytes = dout.toByteArray();</span>
<span class="nc" id="L135">                name = new byte[2 + 2 + mechBytes.length + 4 + nameBytes.length];</span>
<span class="nc" id="L136">                int pos = 0;</span>
<span class="nc" id="L137">                name[pos++] = 0x04;</span>
<span class="nc" id="L138">                name[pos++] = 0x01;</span>
<span class="nc" id="L139">                name[pos++] = (byte) (mechBytes.length&gt;&gt;&gt;8);</span>
<span class="nc" id="L140">                name[pos++] = (byte) mechBytes.length;</span>
<span class="nc" id="L141">                System.arraycopy(mechBytes, 0, name, pos, mechBytes.length);</span>
<span class="nc" id="L142">                pos += mechBytes.length;</span>
<span class="nc" id="L143">                name[pos++] = (byte) (nameBytes.length&gt;&gt;&gt;24);</span>
<span class="nc" id="L144">                name[pos++] = (byte) (nameBytes.length&gt;&gt;&gt;16);</span>
<span class="nc" id="L145">                name[pos++] = (byte) (nameBytes.length&gt;&gt;&gt;8);</span>
<span class="nc" id="L146">                name[pos++] = (byte) nameBytes.length;</span>
<span class="nc" id="L147">                System.arraycopy(nameBytes, 0, name, pos, nameBytes.length);</span>
            }
        }
<span class="fc" id="L150">        pName = cStub.importName(name, nameType);</span>
<span class="fc" id="L151">        setPrintables();</span>

<span class="fc" id="L153">        SunNativeProvider.debug(&quot;Imported &quot; + printableName + &quot; w/ type &quot; +</span>
                                printableType);
<span class="fc" id="L155">    }</span>

    private void setPrintables() throws GSSException {
<span class="fc" id="L158">        Object[] printables = null;</span>
<span class="fc" id="L159">        printables = cStub.displayName(pName);</span>
<span class="pc bpc" id="L160" title="2 of 6 branches missed.">        assert((printables != null) &amp;&amp; (printables.length == 2));</span>
<span class="fc" id="L161">        printableName = (String) printables[0];</span>
<span class="pc bpc" id="L162" title="1 of 4 branches missed.">        assert(printableName != null);</span>
<span class="fc" id="L163">        printableType = (Oid) printables[1];</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        if (printableType == null) {</span>
<span class="nc" id="L165">            printableType = GSSName.NT_USER_NAME;</span>
        }
<span class="fc" id="L167">    }</span>

    // Need to be public for GSSUtil.getSubject()
    public String getKrbName() throws GSSException {
<span class="nc" id="L171">        long mName = 0;</span>
<span class="nc" id="L172">        GSSLibStub stub = cStub;</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (!GSSUtil.isKerberosMech(cStub.getMech())) {</span>
<span class="nc" id="L174">            stub = GSSLibStub.getInstance(GSSUtil.GSS_KRB5_MECH_OID);</span>
        }
<span class="nc" id="L176">        mName = stub.canonicalizeName(pName);</span>
<span class="nc" id="L177">        Object[] printables2 = stub.displayName(mName);</span>
<span class="nc" id="L178">        stub.releaseName(mName);</span>
<span class="nc" id="L179">        SunNativeProvider.debug(&quot;Got kerberized name: &quot; + printables2[0]);</span>
<span class="nc" id="L180">        return (String) printables2[0];</span>
    }

    public Provider getProvider() {
<span class="nc" id="L184">        return SunNativeProvider.INSTANCE;</span>
    }

    public boolean equals(GSSNameSpi other) throws GSSException {
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if (!(other instanceof GSSNameElement)) {</span>
<span class="nc" id="L189">            return false;</span>
        }
<span class="fc" id="L191">        return cStub.compareName(pName, ((GSSNameElement)other).pName);</span>
    }

    public boolean equals(Object other) {
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (!(other instanceof GSSNameElement)) {</span>
<span class="nc" id="L196">            return false;</span>
        }
        try {
<span class="nc" id="L199">            return equals((GSSNameElement) other);</span>
<span class="nc" id="L200">        } catch (GSSException ex) {</span>
<span class="nc" id="L201">            return false;</span>
        }
    }

    public int hashCode() {
<span class="nc" id="L206">        return new Long(pName).hashCode();</span>
    }

    public byte[] export() throws GSSException {
<span class="nc" id="L210">        byte[] nameVal = cStub.exportName(pName);</span>

        // Need to strip off the mech Oid portion of the exported
        // bytes since GSSNameImpl class will subsequently add it.
<span class="nc" id="L214">        int pos = 0;</span>
<span class="nc bnc" id="L215" title="All 4 branches missed.">        if ((nameVal[pos++] != 0x04) ||</span>
            (nameVal[pos++] != 0x01))
<span class="nc" id="L217">            throw new GSSException(GSSException.BAD_NAME);</span>

<span class="nc" id="L219">        int mechOidLen  = (((0xFF &amp; nameVal[pos++]) &lt;&lt; 8) |</span>
                           (0xFF &amp; nameVal[pos++]));
<span class="nc" id="L221">        ObjectIdentifier temp = null;</span>
        try {
<span class="nc" id="L223">            DerInputStream din = new DerInputStream(nameVal, pos,</span>
                                                    mechOidLen);
<span class="nc" id="L225">            temp = new ObjectIdentifier(din);</span>
<span class="nc" id="L226">        } catch (IOException e) {</span>
<span class="nc" id="L227">            throw new GSSExceptionImpl(GSSException.BAD_NAME, e);</span>
<span class="nc" id="L228">        }</span>
<span class="nc" id="L229">        Oid mech2 = new Oid(temp.toString());</span>
<span class="nc bnc" id="L230" title="All 4 branches missed.">        assert(mech2.equals(getMechanism()));</span>
<span class="nc" id="L231">        pos += mechOidLen;</span>
<span class="nc" id="L232">        int mechPortionLen = (((0xFF &amp; nameVal[pos++]) &lt;&lt; 24) |</span>
                              ((0xFF &amp; nameVal[pos++]) &lt;&lt; 16) |
                              ((0xFF &amp; nameVal[pos++]) &lt;&lt; 8) |
                              (0xFF &amp; nameVal[pos++]));
<span class="nc" id="L236">        byte[] mechPortion = new byte[mechPortionLen];</span>
<span class="nc" id="L237">        System.arraycopy(nameVal, pos, mechPortion, 0, mechPortionLen);</span>
<span class="nc" id="L238">        return mechPortion;</span>
    }

    public Oid getMechanism() {
<span class="nc" id="L242">        return cStub.getMech();</span>
    }

    public String toString() {
<span class="nc" id="L246">        return printableName;</span>
    }

    public Oid getStringNameType() {
<span class="nc" id="L250">        return printableType;</span>
    }

    public boolean isAnonymousName() {
<span class="nc" id="L254">        return (GSSName.NT_ANONYMOUS.equals(printableType));</span>
    }

    public void dispose() {
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">        if (pName != 0) {</span>
<span class="fc" id="L259">            cStub.releaseName(pName);</span>
<span class="fc" id="L260">            pName = 0;</span>
        }
<span class="fc" id="L262">    }</span>

    protected void finalize() throws Throwable {
<span class="fc" id="L265">        dispose();</span>
<span class="fc" id="L266">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>