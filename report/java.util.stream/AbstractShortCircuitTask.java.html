<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>AbstractShortCircuitTask.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">java.util.stream</a> &gt; <span class="el_source">AbstractShortCircuitTask.java</span></div><h1>AbstractShortCircuitTask.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2012, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package java.util.stream;

import java.util.Spliterator;
import java.util.concurrent.atomic.AtomicReference;

/**
 * Abstract class for fork-join tasks used to implement short-circuiting
 * stream ops, which can produce a result without processing all elements of the
 * stream.
 *
 * @param &lt;P_IN&gt; type of input elements to the pipeline
 * @param &lt;P_OUT&gt; type of output elements from the pipeline
 * @param &lt;R&gt; type of intermediate result, may be different from operation
 *        result type
 * @param &lt;K&gt; type of child and sibling tasks
 * @since 1.8
 */
@SuppressWarnings(&quot;serial&quot;)
abstract class AbstractShortCircuitTask&lt;P_IN, P_OUT, R,
                                        K extends AbstractShortCircuitTask&lt;P_IN, P_OUT, R, K&gt;&gt;
        extends AbstractTask&lt;P_IN, P_OUT, R, K&gt; {
    /**
     * The result for this computation; this is shared among all tasks and set
     * exactly once
     */
    protected final AtomicReference&lt;R&gt; sharedResult;

    /**
     * Indicates whether this task has been canceled.  Tasks may cancel other
     * tasks in the computation under various conditions, such as in a
     * find-first operation, a task that finds a value will cancel all tasks
     * that are later in the encounter order.
     */
    protected volatile boolean canceled;

    /**
     * Constructor for root tasks.
     *
     * @param helper the {@code PipelineHelper} describing the stream pipeline
     *               up to this operation
     * @param spliterator the {@code Spliterator} describing the source for this
     *                    pipeline
     */
    protected AbstractShortCircuitTask(PipelineHelper&lt;P_OUT&gt; helper,
                                       Spliterator&lt;P_IN&gt; spliterator) {
<span class="fc" id="L70">        super(helper, spliterator);</span>
<span class="fc" id="L71">        sharedResult = new AtomicReference&lt;&gt;(null);</span>
<span class="fc" id="L72">    }</span>

    /**
     * Constructor for non-root nodes.
     *
     * @param parent parent task in the computation tree
     * @param spliterator the {@code Spliterator} for the portion of the
     *                    computation tree described by this task
     */
    protected AbstractShortCircuitTask(K parent,
                                       Spliterator&lt;P_IN&gt; spliterator) {
<span class="nc" id="L83">        super(parent, spliterator);</span>
<span class="nc" id="L84">        sharedResult = parent.sharedResult;</span>
<span class="nc" id="L85">    }</span>

    /**
     * Returns the value indicating the computation completed with no task
     * finding a short-circuitable result.  For example, for a &quot;find&quot; operation,
     * this might be null or an empty {@code Optional}.
     *
     * @return the result to return when no task finds a result
     */
    protected abstract R getEmptyResult();

    /**
     * Overrides AbstractTask version to include checks for early
     * exits while splitting or computing.
     */
    @Override
    public void compute() {
<span class="fc" id="L102">        Spliterator&lt;P_IN&gt; rs = spliterator, ls;</span>
<span class="fc" id="L103">        long sizeEstimate = rs.estimateSize();</span>
<span class="fc" id="L104">        long sizeThreshold = getTargetSize(sizeEstimate);</span>
<span class="fc" id="L105">        boolean forkRight = false;</span>
<span class="fc" id="L106">        @SuppressWarnings(&quot;unchecked&quot;) K task = (K) this;</span>
<span class="fc" id="L107">        AtomicReference&lt;R&gt; sr = sharedResult;</span>
        R result;
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        while ((result = sr.get()) == null) {</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">            if (task.taskCanceled()) {</span>
<span class="nc" id="L111">                result = task.getEmptyResult();</span>
<span class="nc" id="L112">                break;</span>
            }
<span class="pc bpc" id="L114" title="3 of 4 branches missed.">            if (sizeEstimate &lt;= sizeThreshold || (ls = rs.trySplit()) == null) {</span>
<span class="nc" id="L115">                result = task.doLeaf();</span>
<span class="nc" id="L116">                break;</span>
            }
            K leftChild, rightChild, taskToFork;
<span class="nc" id="L119">            task.leftChild  = leftChild = task.makeChild(ls);</span>
<span class="nc" id="L120">            task.rightChild = rightChild = task.makeChild(rs);</span>
<span class="nc" id="L121">            task.setPendingCount(1);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (forkRight) {</span>
<span class="nc" id="L123">                forkRight = false;</span>
<span class="nc" id="L124">                rs = ls;</span>
<span class="nc" id="L125">                task = leftChild;</span>
<span class="nc" id="L126">                taskToFork = rightChild;</span>
            }
            else {
<span class="nc" id="L129">                forkRight = true;</span>
<span class="nc" id="L130">                task = rightChild;</span>
<span class="nc" id="L131">                taskToFork = leftChild;</span>
            }
<span class="nc" id="L133">            taskToFork.fork();</span>
<span class="nc" id="L134">            sizeEstimate = rs.estimateSize();</span>
<span class="nc" id="L135">        }</span>
<span class="nc" id="L136">        task.setLocalResult(result);</span>
<span class="nc" id="L137">        task.tryComplete();</span>
<span class="nc" id="L138">    }</span>


    /**
     * Declares that a globally valid result has been found.  If another task has
     * not already found the answer, the result is installed in
     * {@code sharedResult}.  The {@code compute()} method will check
     * {@code sharedResult} before proceeding with computation, so this causes
     * the computation to terminate early.
     *
     * @param result the result found
     */
    protected void shortCircuit(R result) {
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (result != null)</span>
<span class="nc" id="L152">            sharedResult.compareAndSet(null, result);</span>
<span class="nc" id="L153">    }</span>

    /**
     * Sets a local result for this task.  If this task is the root, set the
     * shared result instead (if not already set).
     *
     * @param localResult The result to set for this task
     */
    @Override
    protected void setLocalResult(R localResult) {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (isRoot()) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (localResult != null)</span>
<span class="nc" id="L165">                sharedResult.compareAndSet(null, localResult);</span>
        }
        else
<span class="nc" id="L168">            super.setLocalResult(localResult);</span>
<span class="nc" id="L169">    }</span>

    /**
     * Retrieves the local result for this task
     */
    @Override
    public R getRawResult() {
<span class="nc" id="L176">        return getLocalResult();</span>
    }

    /**
     * Retrieves the local result for this task.  If this task is the root,
     * retrieves the shared result instead.
     */
    @Override
    public R getLocalResult() {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (isRoot()) {</span>
<span class="nc" id="L186">            R answer = sharedResult.get();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            return (answer == null) ? getEmptyResult() : answer;</span>
        }
        else
<span class="nc" id="L190">            return super.getLocalResult();</span>
    }

    /**
     * Mark this task as canceled
     */
    protected void cancel() {
<span class="nc" id="L197">        canceled = true;</span>
<span class="nc" id="L198">    }</span>

    /**
     * Queries whether this task is canceled.  A task is considered canceled if
     * it or any of its parents have been canceled.
     *
     * @return {@code true} if this task or any parent is canceled.
     */
    protected boolean taskCanceled() {
<span class="fc" id="L207">        boolean cancel = canceled;</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (!cancel) {</span>
<span class="pc bpc" id="L209" title="2 of 4 branches missed.">            for (K parent = getParent(); !cancel &amp;&amp; parent != null; parent = parent.getParent())</span>
<span class="nc" id="L210">                cancel = parent.canceled;</span>
        }

<span class="fc" id="L213">        return cancel;</span>
    }

    /**
     * Cancels all tasks which succeed this one in the encounter order.  This
     * includes canceling all the current task's right sibling, as well as the
     * later right siblings of all its parents.
     */
    protected void cancelLaterNodes() {
        // Go up the tree, cancel right siblings of this node and all parents
<span class="nc" id="L223">        for (@SuppressWarnings(&quot;unchecked&quot;) K parent = getParent(), node = (K) this;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">             parent != null;</span>
<span class="nc" id="L225">             node = parent, parent = parent.getParent()) {</span>
            // If node is a left child of parent, then has a right sibling
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (parent.leftChild == node) {</span>
<span class="nc" id="L228">                K rightSibling = parent.rightChild;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                if (!rightSibling.canceled)</span>
<span class="nc" id="L230">                    rightSibling.cancel();</span>
            }
        }
<span class="nc" id="L233">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>