<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>JavaValueArray.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.tools.hat.internal.model</a> &gt; <span class="el_source">JavaValueArray.java</span></div><h1>JavaValueArray.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */


/*
 * The Original Code is HAT. The Initial Developer of the
 * Original Code is Bill JDKte, with contributions from others
 * at JavaSoft/Sun.
 */

package com.sun.tools.hat.internal.model;

import com.sun.tools.hat.internal.parser.ReadBuffer;
import java.io.IOException;

/**
 * An array of values, that is, an array of ints, boolean, floats or the like.
 *
 * @author      Bill JDKte
 */
public class JavaValueArray extends JavaLazyReadObject
                /*imports*/ implements ArrayTypeCodes {

    private static String arrayTypeName(byte sig) {
<span class="nc bnc" id="L47" title="All 9 branches missed.">        switch (sig) {</span>
            case 'B':
<span class="nc" id="L49">                return &quot;byte[]&quot;;</span>
            case 'Z':
<span class="nc" id="L51">                return &quot;boolean[]&quot;;</span>
            case 'C':
<span class="nc" id="L53">                return &quot;char[]&quot;;</span>
            case 'S':
<span class="nc" id="L55">                return &quot;short[]&quot;;</span>
            case 'I':
<span class="nc" id="L57">                return &quot;int[]&quot;;</span>
            case 'F':
<span class="nc" id="L59">                return &quot;float[]&quot;;</span>
            case 'J':
<span class="nc" id="L61">                return &quot;long[]&quot;;</span>
            case 'D':
<span class="nc" id="L63">                return &quot;double[]&quot;;</span>
            default:
<span class="nc" id="L65">                throw new RuntimeException(&quot;invalid array element sig: &quot; + sig);</span>
        }
    }

    private static int elementSize(byte type) {
<span class="nc bnc" id="L70" title="All 5 branches missed.">        switch (type) {</span>
            case T_BYTE:
            case T_BOOLEAN:
<span class="nc" id="L73">                return 1;</span>
            case T_CHAR:
            case T_SHORT:
<span class="nc" id="L76">                return 2;</span>
            case T_INT:
            case T_FLOAT:
<span class="nc" id="L79">                return 4;</span>
            case T_LONG:
            case T_DOUBLE:
<span class="nc" id="L82">                return 8;</span>
            default:
<span class="nc" id="L84">                throw new RuntimeException(&quot;invalid array element type: &quot; + type);</span>
        }
    }

    /*
     * Java primitive array record (HPROF_GC_PRIM_ARRAY_DUMP) looks
     * as below:
     *
     *    object ID
     *    stack trace serial number (int)
     *    length of the instance data (int)
     *    element type (byte)
     *    array data
     */
    protected final int readValueLength() throws IOException {
<span class="nc" id="L99">        JavaClass cl = getClazz();</span>
<span class="nc" id="L100">        ReadBuffer buf = cl.getReadBuffer();</span>
<span class="nc" id="L101">        int idSize = cl.getIdentifierSize();</span>
<span class="nc" id="L102">        long offset = getOffset() + idSize + 4;</span>
        // length of the array
<span class="nc" id="L104">        int len = buf.getInt(offset);</span>
        // typecode of array element type
<span class="nc" id="L106">        byte type = buf.getByte(offset + 4);</span>
<span class="nc" id="L107">        return len * elementSize(type);</span>
    }

    protected final byte[] readValue() throws IOException {
<span class="nc" id="L111">        JavaClass cl = getClazz();</span>
<span class="nc" id="L112">        ReadBuffer buf = cl.getReadBuffer();</span>
<span class="nc" id="L113">        int idSize = cl.getIdentifierSize();</span>
<span class="nc" id="L114">        long offset = getOffset() + idSize + 4;</span>
        // length of the array
<span class="nc" id="L116">        int length = buf.getInt(offset);</span>
        // typecode of array element type
<span class="nc" id="L118">        byte type = buf.getByte(offset + 4);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (length == 0) {</span>
<span class="nc" id="L120">            return Snapshot.EMPTY_BYTE_ARRAY;</span>
        } else {
<span class="nc" id="L122">            length *= elementSize(type);</span>
<span class="nc" id="L123">            byte[] res = new byte[length];</span>
<span class="nc" id="L124">            buf.get(offset + 5, res);</span>
<span class="nc" id="L125">            return res;</span>
        }
    }

    // JavaClass set only after resolve.
    private JavaClass clazz;

    // This field contains elementSignature byte and
    // divider to be used to calculate length. Note that
    // length of content byte[] is not same as array length.
    // Actual array length is (byte[].length / divider)
    private int data;

    // First 8 bits of data is used for element signature
    private static final int SIGNATURE_MASK = 0x0FF;

    // Next 8 bits of data is used for length divider
    private static final int LENGTH_DIVIDER_MASK = 0x0FF00;

    // Number of bits to shift to get length divider
    private static final int LENGTH_DIVIDER_SHIFT = 8;

    public JavaValueArray(byte elementSignature, long offset) {
<span class="nc" id="L148">        super(offset);</span>
<span class="nc" id="L149">        this.data = (elementSignature &amp; SIGNATURE_MASK);</span>
<span class="nc" id="L150">    }</span>

    public JavaClass getClazz() {
<span class="nc" id="L153">        return clazz;</span>
    }

    public void visitReferencedObjects(JavaHeapObjectVisitor v) {
<span class="nc" id="L157">        super.visitReferencedObjects(v);</span>
<span class="nc" id="L158">    }</span>

    public void resolve(Snapshot snapshot) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (clazz instanceof JavaClass) {</span>
<span class="nc" id="L162">            return;</span>
        }
<span class="nc" id="L164">        byte elementSig = getElementType();</span>
<span class="nc" id="L165">        clazz = snapshot.findClass(arrayTypeName(elementSig));</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (clazz == null) {</span>
<span class="nc" id="L167">            clazz = snapshot.getArrayClass(&quot;&quot; + ((char) elementSig));</span>
        }
<span class="nc" id="L169">        getClazz().addInstance(this);</span>
<span class="nc" id="L170">        super.resolve(snapshot);</span>
<span class="nc" id="L171">    }</span>

    public int getLength() {
<span class="nc" id="L174">        int divider = (data &amp; LENGTH_DIVIDER_MASK) &gt;&gt;&gt; LENGTH_DIVIDER_SHIFT;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (divider == 0) {</span>
<span class="nc" id="L176">            byte elementSignature = getElementType();</span>
<span class="nc bnc" id="L177" title="All 5 branches missed.">            switch (elementSignature) {</span>
            case 'B':
            case 'Z':
<span class="nc" id="L180">                divider = 1;</span>
<span class="nc" id="L181">                break;</span>
            case 'C':
            case 'S':
<span class="nc" id="L184">                divider = 2;</span>
<span class="nc" id="L185">                break;</span>
            case 'I':
            case 'F':
<span class="nc" id="L188">                divider = 4;</span>
<span class="nc" id="L189">                break;</span>
            case 'J':
            case 'D':
<span class="nc" id="L192">                divider = 8;</span>
<span class="nc" id="L193">                break;</span>
            default:
<span class="nc" id="L195">                throw new RuntimeException(&quot;unknown primitive type: &quot; +</span>
                                elementSignature);
            }
<span class="nc" id="L198">            data |= (divider &lt;&lt; LENGTH_DIVIDER_SHIFT);</span>
        }
<span class="nc" id="L200">        return (getValueLength() / divider);</span>
    }

    public Object getElements() {
<span class="nc" id="L204">        final int len = getLength();</span>
<span class="nc" id="L205">        final byte et = getElementType();</span>
<span class="nc" id="L206">        byte[] data = getValue();</span>
<span class="nc" id="L207">        int index = 0;</span>
<span class="nc bnc" id="L208" title="All 9 branches missed.">        switch (et) {</span>
            case 'Z': {
<span class="nc" id="L210">                boolean[] res = new boolean[len];</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L212">                    res[i] = booleanAt(index, data);</span>
<span class="nc" id="L213">                    index++;</span>
                }
<span class="nc" id="L215">                return res;</span>
            }
            case 'B': {
<span class="nc" id="L218">                byte[] res = new byte[len];</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L220">                    res[i] = byteAt(index, data);</span>
<span class="nc" id="L221">                    index++;</span>
                }
<span class="nc" id="L223">                return res;</span>
            }
            case 'C': {
<span class="nc" id="L226">                char[] res = new char[len];</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L228">                    res[i] = charAt(index, data);</span>
<span class="nc" id="L229">                    index += 2;</span>
                }
<span class="nc" id="L231">                return res;</span>
            }
            case 'S': {
<span class="nc" id="L234">                short[] res = new short[len];</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L236">                    res[i] = shortAt(index, data);</span>
<span class="nc" id="L237">                    index += 2;</span>
                }
<span class="nc" id="L239">                return res;</span>
            }
            case 'I': {
<span class="nc" id="L242">                int[] res = new int[len];</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L244">                    res[i] = intAt(index, data);</span>
<span class="nc" id="L245">                    index += 4;</span>
                }
<span class="nc" id="L247">                return res;</span>
            }
            case 'J': {
<span class="nc" id="L250">                long[] res = new long[len];</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L252">                    res[i] = longAt(index, data);</span>
<span class="nc" id="L253">                    index += 8;</span>
                }
<span class="nc" id="L255">                return res;</span>
            }
            case 'F': {
<span class="nc" id="L258">                float[] res = new float[len];</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L260">                    res[i] = floatAt(index, data);</span>
<span class="nc" id="L261">                    index += 4;</span>
                }
<span class="nc" id="L263">                return res;</span>
            }
            case 'D': {
<span class="nc" id="L266">                double[] res = new double[len];</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L268">                    res[i] = doubleAt(index, data);</span>
<span class="nc" id="L269">                    index += 8;</span>
                }
<span class="nc" id="L271">                return res;</span>
            }
            default: {
<span class="nc" id="L274">                throw new RuntimeException(&quot;unknown primitive type?&quot;);</span>
            }
        }
    }

    public byte getElementType() {
<span class="nc" id="L280">        return (byte) (data &amp; SIGNATURE_MASK);</span>
    }

    private void checkIndex(int index) {
<span class="nc bnc" id="L284" title="All 4 branches missed.">        if (index &lt; 0 || index &gt;= getLength()) {</span>
<span class="nc" id="L285">            throw new ArrayIndexOutOfBoundsException(index);</span>
        }
<span class="nc" id="L287">    }</span>

    private void requireType(char type) {
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (getElementType() != type) {</span>
<span class="nc" id="L291">            throw new RuntimeException(&quot;not of type : &quot; + type);</span>
        }
<span class="nc" id="L293">    }</span>

    public boolean getBooleanAt(int index) {
<span class="nc" id="L296">        checkIndex(index);</span>
<span class="nc" id="L297">        requireType('Z');</span>
<span class="nc" id="L298">        return booleanAt(index, getValue());</span>
    }

    public byte getByteAt(int index) {
<span class="nc" id="L302">        checkIndex(index);</span>
<span class="nc" id="L303">        requireType('B');</span>
<span class="nc" id="L304">        return byteAt(index, getValue());</span>
    }

    public char getCharAt(int index) {
<span class="nc" id="L308">        checkIndex(index);</span>
<span class="nc" id="L309">        requireType('C');</span>
<span class="nc" id="L310">        return charAt(index &lt;&lt; 1, getValue());</span>
    }

    public short getShortAt(int index) {
<span class="nc" id="L314">        checkIndex(index);</span>
<span class="nc" id="L315">        requireType('S');</span>
<span class="nc" id="L316">        return shortAt(index &lt;&lt; 1, getValue());</span>
    }

    public int getIntAt(int index) {
<span class="nc" id="L320">        checkIndex(index);</span>
<span class="nc" id="L321">        requireType('I');</span>
<span class="nc" id="L322">        return intAt(index &lt;&lt; 2, getValue());</span>
    }

    public long getLongAt(int index) {
<span class="nc" id="L326">        checkIndex(index);</span>
<span class="nc" id="L327">        requireType('J');</span>
<span class="nc" id="L328">        return longAt(index &lt;&lt; 3, getValue());</span>
    }

    public float getFloatAt(int index) {
<span class="nc" id="L332">        checkIndex(index);</span>
<span class="nc" id="L333">        requireType('F');</span>
<span class="nc" id="L334">        return floatAt(index &lt;&lt; 2, getValue());</span>
    }

    public double getDoubleAt(int index) {
<span class="nc" id="L338">        checkIndex(index);</span>
<span class="nc" id="L339">        requireType('D');</span>
<span class="nc" id="L340">        return doubleAt(index &lt;&lt; 3, getValue());</span>
    }

    public String valueString() {
<span class="nc" id="L344">        return valueString(true);</span>
    }

    public String valueString(boolean bigLimit) {
        // Char arrays deserve special treatment
        StringBuffer result;
<span class="nc" id="L350">        byte[] value = getValue();</span>
<span class="nc" id="L351">        int max = value.length;</span>
<span class="nc" id="L352">        byte elementSignature = getElementType();</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">        if (elementSignature == 'C')  {</span>
<span class="nc" id="L354">            result = new StringBuffer();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            for (int i = 0; i &lt; value.length; ) {</span>
<span class="nc" id="L356">                char val = charAt(i, value);</span>
<span class="nc" id="L357">                result.append(val);</span>
<span class="nc" id="L358">                i += 2;</span>
<span class="nc" id="L359">            }</span>
        } else {
<span class="nc" id="L361">            int limit = 8;</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">            if (bigLimit) {</span>
<span class="nc" id="L363">                limit = 1000;</span>
            }
<span class="nc" id="L365">            result = new StringBuffer(&quot;{&quot;);</span>
<span class="nc" id="L366">            int num = 0;</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">            for (int i = 0; i &lt; value.length; ) {</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">                if (num &gt; 0) {</span>
<span class="nc" id="L369">                    result.append(&quot;, &quot;);</span>
                }
<span class="nc bnc" id="L371" title="All 2 branches missed.">                if (num &gt;= limit) {</span>
<span class="nc" id="L372">                    result.append(&quot;... &quot;);</span>
<span class="nc" id="L373">                    break;</span>
                }
<span class="nc" id="L375">                num++;</span>
<span class="nc bnc" id="L376" title="All 8 branches missed.">                switch (elementSignature) {</span>
                    case 'Z': {
<span class="nc" id="L378">                        boolean val = booleanAt(i, value);</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">                        if (val) {</span>
<span class="nc" id="L380">                            result.append(&quot;true&quot;);</span>
                        } else {
<span class="nc" id="L382">                            result.append(&quot;false&quot;);</span>
                        }
<span class="nc" id="L384">                        i++;</span>
<span class="nc" id="L385">                        break;</span>
                    }
                    case 'B': {
<span class="nc" id="L388">                        int val = 0xFF &amp; byteAt(i, value);</span>
<span class="nc" id="L389">                        result.append(&quot;0x&quot; + Integer.toString(val, 16));</span>
<span class="nc" id="L390">                        i++;</span>
<span class="nc" id="L391">                        break;</span>
                    }
                    case 'S': {
<span class="nc" id="L394">                        short val = shortAt(i, value);</span>
<span class="nc" id="L395">                        i += 2;</span>
<span class="nc" id="L396">                        result.append(&quot;&quot; + val);</span>
<span class="nc" id="L397">                        break;</span>
                    }
                    case 'I': {
<span class="nc" id="L400">                        int val = intAt(i, value);</span>
<span class="nc" id="L401">                        i += 4;</span>
<span class="nc" id="L402">                        result.append(&quot;&quot; + val);</span>
<span class="nc" id="L403">                        break;</span>
                    }
                    case 'J': {         // long
<span class="nc" id="L406">                        long val = longAt(i, value);</span>
<span class="nc" id="L407">                        result.append(&quot;&quot; + val);</span>
<span class="nc" id="L408">                        i += 8;</span>
<span class="nc" id="L409">                        break;</span>
                    }
                    case 'F': {
<span class="nc" id="L412">                        float val = floatAt(i, value);</span>
<span class="nc" id="L413">                        result.append(&quot;&quot; + val);</span>
<span class="nc" id="L414">                        i += 4;</span>
<span class="nc" id="L415">                        break;</span>
                    }
                    case 'D': {         // double
<span class="nc" id="L418">                        double val = doubleAt(i, value);</span>
<span class="nc" id="L419">                        result.append(&quot;&quot; + val);</span>
<span class="nc" id="L420">                        i += 8;</span>
<span class="nc" id="L421">                        break;</span>
                    }
                    default: {
<span class="nc" id="L424">                        throw new RuntimeException(&quot;unknown primitive type?&quot;);</span>
                    }
                }
            }
<span class="nc" id="L428">            result.append(&quot;}&quot;);</span>
        }
<span class="nc" id="L430">        return result.toString();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>