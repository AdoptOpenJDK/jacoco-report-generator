<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>GraphicsPrimitive.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.java2d.loops</a> &gt; <span class="el_source">GraphicsPrimitive.java</span></div><h1>GraphicsPrimitive.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

/*
 * @author Charlton Innovations, Inc.
 */

package sun.java2d.loops;

import java.awt.image.BufferedImage;
import java.awt.AlphaComposite;
import java.awt.Rectangle;
import sun.awt.image.BufImgSurfaceData;
import sun.java2d.SurfaceData;
import sun.java2d.pipe.Region;
import java.lang.reflect.Field;
import java.util.StringTokenizer;
import java.util.Iterator;
import java.util.HashMap;
import java.util.Map;
import java.io.PrintStream;
import java.io.OutputStream;
import java.io.FileOutputStream;
import java.io.FileNotFoundException;
import java.security.AccessController;
import java.security.PrivilegedAction;
import sun.security.action.GetPropertyAction;

/**
 * defines interface for primitives which can be placed into
 * the graphic component manager framework
 */
public abstract class GraphicsPrimitive {

    protected static interface GeneralBinaryOp {
        /**
         * This method allows the setupGeneralBinaryOp method to set
         * the converters into the General version of the Primitive.
         */
        public void setPrimitives(Blit srcconverter,
                                  Blit dstconverter,
                                  GraphicsPrimitive genericop,
                                  Blit resconverter);

        /**
         * These 4 methods are implemented automatically for any
         * GraphicsPrimitive.  They are used by setupGeneralBinaryOp
         * to retrieve the information needed to find the right
         * converter primitives.
         */
        public SurfaceType getSourceType();
        public CompositeType getCompositeType();
        public SurfaceType getDestType();
        public String getSignature();
        public int getPrimTypeID();
    }

    protected static interface GeneralUnaryOp {
        /**
         * This method allows the setupGeneralUnaryOp method to set
         * the converters into the General version of the Primitive.
         */
        public void setPrimitives(Blit dstconverter,
                                  GraphicsPrimitive genericop,
                                  Blit resconverter);

        /**
         * These 3 methods are implemented automatically for any
         * GraphicsPrimitive.  They are used by setupGeneralUnaryOp
         * to retrieve the information needed to find the right
         * converter primitives.
         */
        public CompositeType getCompositeType();
        public SurfaceType getDestType();
        public String getSignature();
        public int getPrimTypeID();
    }

    /**
    *  INSTANCE DATA MEMBERS DESCRIBING CHARACTERISTICS OF THIS PRIMITIVE
    **/

    // Making these be instance data members (instead of virtual methods
    // overridden by subclasses) is actually cheaper, since each class
    // is a singleton.  As instance data members with final accessors,
    // accesses can be inlined.
    private String methodSignature;
    private int uniqueID;
<span class="nc" id="L111">    private static int unusedPrimID = 1;</span>

    private SurfaceType sourceType;
    private CompositeType compositeType;
    private SurfaceType destType;

    private long pNativePrim;   // Native blit loop info

    public synchronized static final int makePrimTypeID() {
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (unusedPrimID &gt; 255) {</span>
<span class="nc" id="L121">            throw new InternalError(&quot;primitive id overflow&quot;);</span>
        }
<span class="nc" id="L123">        return unusedPrimID++;</span>
    }

    public synchronized static final int makeUniqueID(int primTypeID,
                                                      SurfaceType src,
                                                      CompositeType cmp,
                                                      SurfaceType dst)
    {
<span class="nc" id="L131">        return (primTypeID &lt;&lt; 24) |</span>
<span class="nc" id="L132">            (dst.getUniqueID() &lt;&lt; 16) |</span>
<span class="nc" id="L133">            (cmp.getUniqueID() &lt;&lt; 8)  |</span>
<span class="nc" id="L134">            (src.getUniqueID());</span>
    }

    /**
     * Create a new GraphicsPrimitive with all of the required
     * descriptive information.
     */
    protected GraphicsPrimitive(String methodSignature,
                                int primTypeID,
                                SurfaceType sourceType,
                                CompositeType compositeType,
                                SurfaceType destType)
<span class="nc" id="L146">    {</span>
<span class="nc" id="L147">        this.methodSignature = methodSignature;</span>
<span class="nc" id="L148">        this.sourceType = sourceType;</span>
<span class="nc" id="L149">        this.compositeType = compositeType;</span>
<span class="nc" id="L150">        this.destType = destType;</span>

<span class="nc bnc" id="L152" title="All 6 branches missed.">        if(sourceType == null || compositeType == null || destType == null) {</span>
<span class="nc" id="L153">            this.uniqueID = primTypeID &lt;&lt; 24;</span>
        } else {
<span class="nc" id="L155">            this.uniqueID = GraphicsPrimitive.makeUniqueID(primTypeID,</span>
                                                           sourceType,
                                                           compositeType,
                                                           destType);
        }
<span class="nc" id="L160">    }</span>

    /**
     * Create a new GraphicsPrimitive for native invocation
     * with all of the required descriptive information.
     */
    protected GraphicsPrimitive(long pNativePrim,
                                String methodSignature,
                                int primTypeID,
                                SurfaceType sourceType,
                                CompositeType compositeType,
                                SurfaceType destType)
<span class="nc" id="L172">    {</span>
<span class="nc" id="L173">        this.pNativePrim = pNativePrim;</span>
<span class="nc" id="L174">        this.methodSignature = methodSignature;</span>
<span class="nc" id="L175">        this.sourceType = sourceType;</span>
<span class="nc" id="L176">        this.compositeType = compositeType;</span>
<span class="nc" id="L177">        this.destType = destType;</span>

<span class="nc bnc" id="L179" title="All 6 branches missed.">        if(sourceType == null || compositeType == null || destType == null) {</span>
<span class="nc" id="L180">            this.uniqueID = primTypeID &lt;&lt; 24;</span>
        } else {
<span class="nc" id="L182">            this.uniqueID = GraphicsPrimitive.makeUniqueID(primTypeID,</span>
                                                           sourceType,
                                                           compositeType,
                                                           destType);
        }
<span class="nc" id="L187">    }</span>

    /**
    *   METHODS TO DESCRIBE THE SURFACES PRIMITIVES
    *   CAN OPERATE ON AND THE FUNCTIONALITY THEY IMPLEMENT
    **/

    /**
     * Gets instance ID of this graphics primitive.
     *
     * Instance ID is comprised of four distinct ids (ORed together)
     * that uniquely identify each instance of a GraphicsPrimitive
     * object. The four ids making up instance ID are:
     * 1. primitive id - identifier shared by all primitives of the
     * same type (eg. all Blits have the same primitive id)
     * 2. sourcetype id - identifies source surface type
     * 3. desttype id - identifies destination surface type
     * 4. compositetype id - identifies composite used
     *
     * @return instance ID
     */
    public final int getUniqueID() {
<span class="nc" id="L209">        return uniqueID;</span>
    }

    /**
     */
    public final String getSignature() {
<span class="nc" id="L215">        return methodSignature;</span>
    }

    /**
     * Gets unique id for this GraphicsPrimitive type.
     *
     * This id is used to identify the TYPE of primitive (Blit vs. BlitBg)
     * as opposed to INSTANCE of primitive.
     *
     * @return primitive ID
     */
    public final int getPrimTypeID() {
<span class="nc" id="L227">        return uniqueID &gt;&gt;&gt; 24;</span>
    }

    /**
     */
    public final long getNativePrim() {
<span class="nc" id="L233">        return pNativePrim;</span>
    }

    /**
     */
    public final SurfaceType getSourceType() {
<span class="nc" id="L239">        return sourceType;</span>
    }

    /**
     */
    public final CompositeType getCompositeType() {
<span class="nc" id="L245">        return compositeType;</span>
    }

    /**
     */
    public final SurfaceType getDestType() {
<span class="nc" id="L251">        return destType;</span>
    }

    /**
     * Return true if this primitive can be used for the given signature
     * surfaces, and composite.
     *
     * @param signature The signature of the given operation.  Must be
     *          == (not just .equals) the signature string given by the
     *          abstract class that declares the operation.
     * @param srctype The surface type for the source of the operation
     * @param comptype The composite type for the operation
     * @param dsttype The surface type for the destination of the operation
     */
    public final boolean satisfies(String signature,
                                   SurfaceType srctype,
                                   CompositeType comptype,
                                   SurfaceType dsttype)
    {
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (signature != methodSignature) {</span>
<span class="nc" id="L271">            return false;</span>
        }
        while (true) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (srctype == null) {</span>
<span class="nc" id="L275">                return false;</span>
            }
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (srctype.equals(sourceType)) {</span>
<span class="nc" id="L278">                break;</span>
            }
<span class="nc" id="L280">            srctype = srctype.getSuperType();</span>
        }
        while (true) {
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (comptype == null) {</span>
<span class="nc" id="L284">                return false;</span>
            }
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (comptype.equals(compositeType)) {</span>
<span class="nc" id="L287">                break;</span>
            }
<span class="nc" id="L289">            comptype = comptype.getSuperType();</span>
        }
        while (true) {
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if (dsttype == null) {</span>
<span class="nc" id="L293">                return false;</span>
            }
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (dsttype.equals(destType)) {</span>
<span class="nc" id="L296">                break;</span>
            }
<span class="nc" id="L298">            dsttype = dsttype.getSuperType();</span>
        }
<span class="nc" id="L300">        return true;</span>
    }

    //
    // A version of satisfies used for regression testing
    //
    final boolean satisfiesSameAs(GraphicsPrimitive other) {
<span class="nc bnc" id="L307" title="All 2 branches missed.">        return (methodSignature == other.methodSignature &amp;&amp;</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                sourceType.equals(other.sourceType) &amp;&amp;</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">                compositeType.equals(other.compositeType) &amp;&amp;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                destType.equals(other.destType));</span>
    }

    public abstract GraphicsPrimitive makePrimitive(SurfaceType srctype,
                                                    CompositeType comptype,
                                                    SurfaceType dsttype);

    public abstract GraphicsPrimitive traceWrap();

    static HashMap traceMap;

    public static int traceflags;
    public static String tracefile;
    public static PrintStream traceout;

    public static final int TRACELOG = 1;
    public static final int TRACETIMESTAMP = 2;
    public static final int TRACECOUNTS = 4;

    static {
<span class="nc" id="L330">        GetPropertyAction gpa = new GetPropertyAction(&quot;sun.java2d.trace&quot;);</span>
<span class="nc" id="L331">        String trace = AccessController.doPrivileged(gpa);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (trace != null) {</span>
<span class="nc" id="L333">            boolean verbose = false;</span>
<span class="nc" id="L334">            int traceflags = 0;</span>
<span class="nc" id="L335">            StringTokenizer st = new StringTokenizer(trace, &quot;,&quot;);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">            while (st.hasMoreTokens()) {</span>
<span class="nc" id="L337">                String tok = st.nextToken();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                if (tok.equalsIgnoreCase(&quot;count&quot;)) {</span>
<span class="nc" id="L339">                    traceflags |= GraphicsPrimitive.TRACECOUNTS;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                } else if (tok.equalsIgnoreCase(&quot;log&quot;)) {</span>
<span class="nc" id="L341">                    traceflags |= GraphicsPrimitive.TRACELOG;</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                } else if (tok.equalsIgnoreCase(&quot;timestamp&quot;)) {</span>
<span class="nc" id="L343">                    traceflags |= GraphicsPrimitive.TRACETIMESTAMP;</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                } else if (tok.equalsIgnoreCase(&quot;verbose&quot;)) {</span>
<span class="nc" id="L345">                    verbose = true;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                } else if (tok.regionMatches(true, 0, &quot;out:&quot;, 0, 4)) {</span>
<span class="nc" id="L347">                    tracefile = tok.substring(4);</span>
                } else {
<span class="nc bnc" id="L349" title="All 2 branches missed.">                    if (!tok.equalsIgnoreCase(&quot;help&quot;)) {</span>
<span class="nc" id="L350">                        System.err.println(&quot;unrecognized token: &quot;+tok);</span>
                    }
<span class="nc" id="L352">                    System.err.println(&quot;usage: -Dsun.java2d.trace=&quot;+</span>
                                       &quot;[log[,timestamp]],[count],&quot;+
                                       &quot;[out:&lt;filename&gt;],[help],[verbose]&quot;);
                }
<span class="nc" id="L356">            }</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            if (verbose) {</span>
<span class="nc" id="L358">                System.err.print(&quot;GraphicsPrimitive logging &quot;);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                if ((traceflags &amp; GraphicsPrimitive.TRACELOG) != 0) {</span>
<span class="nc" id="L360">                    System.err.println(&quot;enabled&quot;);</span>
<span class="nc" id="L361">                    System.err.print(&quot;GraphicsPrimitive timetamps &quot;);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                    if ((traceflags &amp; GraphicsPrimitive.TRACETIMESTAMP) != 0) {</span>
<span class="nc" id="L363">                        System.err.println(&quot;enabled&quot;);</span>
                    } else {
<span class="nc" id="L365">                        System.err.println(&quot;disabled&quot;);</span>
                    }
                } else {
<span class="nc" id="L368">                    System.err.println(&quot;[and timestamps] disabled&quot;);</span>
                }
<span class="nc" id="L370">                System.err.print(&quot;GraphicsPrimitive invocation counts &quot;);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                if ((traceflags &amp; GraphicsPrimitive.TRACECOUNTS) != 0) {</span>
<span class="nc" id="L372">                    System.err.println(&quot;enabled&quot;);</span>
                } else {
<span class="nc" id="L374">                    System.err.println(&quot;disabled&quot;);</span>
                }
<span class="nc" id="L376">                System.err.print(&quot;GraphicsPrimitive trace output to &quot;);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                if (tracefile == null) {</span>
<span class="nc" id="L378">                    System.err.println(&quot;System.err&quot;);</span>
                } else {
<span class="nc" id="L380">                    System.err.println(&quot;file '&quot;+tracefile+&quot;'&quot;);</span>
                }
            }
<span class="nc" id="L383">            GraphicsPrimitive.traceflags = traceflags;</span>
        }
<span class="nc" id="L385">    }</span>

    public static boolean tracingEnabled() {
<span class="nc bnc" id="L388" title="All 2 branches missed.">        return (traceflags != 0);</span>
    }

    private static PrintStream getTraceOutputFile() {
<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (traceout == null) {</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">            if (tracefile != null) {</span>
<span class="nc" id="L394">                FileOutputStream o = AccessController.doPrivileged(</span>
<span class="nc" id="L395">                    new PrivilegedAction&lt;FileOutputStream&gt;() {</span>
                        public FileOutputStream run() {
                            try {
<span class="nc" id="L398">                                return new FileOutputStream(tracefile);</span>
<span class="nc" id="L399">                            } catch (FileNotFoundException e) {</span>
<span class="nc" id="L400">                                return null;</span>
                            }
                        }
                    });
<span class="nc bnc" id="L404" title="All 2 branches missed.">                if (o != null) {</span>
<span class="nc" id="L405">                    traceout = new PrintStream(o);</span>
                } else {
<span class="nc" id="L407">                    traceout = System.err;</span>
                }
<span class="nc" id="L409">            } else {</span>
<span class="nc" id="L410">                traceout = System.err;</span>
            }
        }
<span class="nc" id="L413">        return traceout;</span>
    }

<span class="nc" id="L416">    public static class TraceReporter extends Thread {</span>
        public static void setShutdownHook() {
<span class="nc" id="L418">            AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span>
                public Void run() {
<span class="nc" id="L420">                    TraceReporter t = new TraceReporter();</span>
<span class="nc" id="L421">                    t.setContextClassLoader(null);</span>
<span class="nc" id="L422">                    Runtime.getRuntime().addShutdownHook(t);</span>
<span class="nc" id="L423">                    return null;</span>
                }
            });
<span class="nc" id="L426">        }</span>

        public void run() {
<span class="nc" id="L429">            PrintStream ps = getTraceOutputFile();</span>
<span class="nc" id="L430">            Iterator iterator = traceMap.entrySet().iterator();</span>
<span class="nc" id="L431">            long total = 0;</span>
<span class="nc" id="L432">            int numprims = 0;</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">            while (iterator.hasNext()) {</span>
<span class="nc" id="L434">                Map.Entry me = (Map.Entry) iterator.next();</span>
<span class="nc" id="L435">                Object prim = me.getKey();</span>
<span class="nc" id="L436">                int[] count = (int[]) me.getValue();</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">                if (count[0] == 1) {</span>
<span class="nc" id="L438">                    ps.print(&quot;1 call to &quot;);</span>
                } else {
<span class="nc" id="L440">                    ps.print(count[0]+&quot; calls to &quot;);</span>
                }
<span class="nc" id="L442">                ps.println(prim);</span>
<span class="nc" id="L443">                numprims++;</span>
<span class="nc" id="L444">                total += count[0];</span>
<span class="nc" id="L445">            }</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (numprims == 0) {</span>
<span class="nc" id="L447">                ps.println(&quot;No graphics primitives executed&quot;);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">            } else if (numprims &gt; 1) {</span>
<span class="nc" id="L449">                ps.println(total+&quot; total calls to &quot;+</span>
                           numprims+&quot; different primitives&quot;);
            }
<span class="nc" id="L452">        }</span>
    }

    public synchronized static void tracePrimitive(Object prim) {
<span class="nc bnc" id="L456" title="All 2 branches missed.">        if ((traceflags &amp; TRACECOUNTS) != 0) {</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">            if (traceMap == null) {</span>
<span class="nc" id="L458">                traceMap = new HashMap();</span>
<span class="nc" id="L459">                TraceReporter.setShutdownHook();</span>
            }
<span class="nc" id="L461">            Object o = traceMap.get(prim);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">            if (o == null) {</span>
<span class="nc" id="L463">                o = new int[1];</span>
<span class="nc" id="L464">                traceMap.put(prim, o);</span>
            }
<span class="nc" id="L466">            ((int[]) o)[0]++;</span>
        }
<span class="nc bnc" id="L468" title="All 2 branches missed.">        if ((traceflags &amp; TRACELOG) != 0) {</span>
<span class="nc" id="L469">            PrintStream ps = getTraceOutputFile();</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">            if ((traceflags &amp; TRACETIMESTAMP) != 0) {</span>
<span class="nc" id="L471">                ps.print(System.currentTimeMillis()+&quot;: &quot;);</span>
            }
<span class="nc" id="L473">            ps.println(prim);</span>
        }
<span class="nc" id="L475">    }</span>

    protected void setupGeneralBinaryOp(GeneralBinaryOp gbo) {
<span class="nc" id="L478">        int primID = gbo.getPrimTypeID();</span>
<span class="nc" id="L479">        String methodSignature = gbo.getSignature();</span>
<span class="nc" id="L480">        SurfaceType srctype = gbo.getSourceType();</span>
<span class="nc" id="L481">        CompositeType comptype = gbo.getCompositeType();</span>
<span class="nc" id="L482">        SurfaceType dsttype = gbo.getDestType();</span>
        Blit convertsrc, convertdst, convertres;
        GraphicsPrimitive performop;

<span class="nc" id="L486">        convertsrc = createConverter(srctype, SurfaceType.IntArgb);</span>
<span class="nc" id="L487">        performop = GraphicsPrimitiveMgr.locatePrim(primID,</span>
                                                    SurfaceType.IntArgb,
                                                    comptype, dsttype);
<span class="nc bnc" id="L490" title="All 2 branches missed.">        if (performop != null) {</span>
<span class="nc" id="L491">            convertdst = null;</span>
<span class="nc" id="L492">            convertres = null;</span>
        } else {
<span class="nc" id="L494">            performop = getGeneralOp(primID, comptype);</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">            if (performop == null) {</span>
<span class="nc" id="L496">                throw new InternalError(&quot;Cannot construct general op for &quot;+</span>
                                        methodSignature+&quot; &quot;+comptype);
            }
<span class="nc" id="L499">            convertdst = createConverter(dsttype, SurfaceType.IntArgb);</span>
<span class="nc" id="L500">            convertres = createConverter(SurfaceType.IntArgb, dsttype);</span>
        }

<span class="nc" id="L503">        gbo.setPrimitives(convertsrc, convertdst, performop, convertres);</span>
<span class="nc" id="L504">    }</span>

    protected void setupGeneralUnaryOp(GeneralUnaryOp guo) {
<span class="nc" id="L507">        int primID = guo.getPrimTypeID();</span>
<span class="nc" id="L508">        String methodSignature = guo.getSignature();</span>
<span class="nc" id="L509">        CompositeType comptype = guo.getCompositeType();</span>
<span class="nc" id="L510">        SurfaceType dsttype = guo.getDestType();</span>

<span class="nc" id="L512">        Blit convertdst = createConverter(dsttype, SurfaceType.IntArgb);</span>
<span class="nc" id="L513">        GraphicsPrimitive performop = getGeneralOp(primID, comptype);</span>
<span class="nc" id="L514">        Blit convertres = createConverter(SurfaceType.IntArgb, dsttype);</span>
<span class="nc bnc" id="L515" title="All 6 branches missed.">        if (convertdst == null || performop == null || convertres == null) {</span>
<span class="nc" id="L516">            throw new InternalError(&quot;Cannot construct binary op for &quot;+</span>
                                    comptype+&quot; &quot;+dsttype);
        }

<span class="nc" id="L520">        guo.setPrimitives(convertdst, performop, convertres);</span>
<span class="nc" id="L521">    }</span>

    protected static Blit createConverter(SurfaceType srctype,
                                          SurfaceType dsttype)
    {
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (srctype.equals(dsttype)) {</span>
<span class="nc" id="L527">            return null;</span>
        }
<span class="nc" id="L529">        Blit cv = Blit.getFromCache(srctype, CompositeType.SrcNoEa, dsttype);</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (cv == null) {</span>
<span class="nc" id="L531">            throw new InternalError(&quot;Cannot construct converter for &quot;+</span>
                                    srctype+&quot;=&gt;&quot;+dsttype);
        }
<span class="nc" id="L534">        return cv;</span>
    }

    protected static SurfaceData convertFrom(Blit ob, SurfaceData srcData,
                                             int srcX, int srcY, int w, int h,
                                             SurfaceData dstData)
    {
<span class="nc" id="L541">        return convertFrom(ob, srcData,</span>
                           srcX, srcY, w, h, dstData,
                           BufferedImage.TYPE_INT_ARGB);
    }

    protected static SurfaceData convertFrom(Blit ob, SurfaceData srcData,
                                             int srcX, int srcY, int w, int h,
                                             SurfaceData dstData, int type)
    {
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (dstData != null) {</span>
<span class="nc" id="L551">            Rectangle r = dstData.getBounds();</span>
<span class="nc bnc" id="L552" title="All 4 branches missed.">            if (w &gt; r.width || h &gt; r.height) {</span>
<span class="nc" id="L553">                dstData = null;</span>
            }
        }
<span class="nc bnc" id="L556" title="All 2 branches missed.">        if (dstData == null) {</span>
<span class="nc" id="L557">            BufferedImage dstBI = new BufferedImage(w, h, type);</span>
<span class="nc" id="L558">            dstData = BufImgSurfaceData.createData(dstBI);</span>
        }
<span class="nc" id="L560">        ob.Blit(srcData, dstData, AlphaComposite.Src, null,</span>
                srcX, srcY, 0, 0, w, h);
<span class="nc" id="L562">        return dstData;</span>
    }

    protected static void convertTo(Blit ob,
                                    SurfaceData srcImg, SurfaceData dstImg,
                                    Region clip,
                                    int dstX, int dstY, int w, int h)
    {
<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (ob != null) {</span>
<span class="nc" id="L571">            ob.Blit(srcImg, dstImg, AlphaComposite.Src, clip,</span>
                    0, 0, dstX, dstY, w, h);
        }
<span class="nc" id="L574">    }</span>

    protected static GraphicsPrimitive getGeneralOp(int primID,
                                                    CompositeType comptype)
    {
<span class="nc" id="L579">        return GraphicsPrimitiveMgr.locatePrim(primID,</span>
                                               SurfaceType.IntArgb,
                                               comptype,
                                               SurfaceType.IntArgb);
    }

    public static String simplename(Field[] fields, Object o) {
<span class="nc bnc" id="L586" title="All 2 branches missed.">        for (int i = 0; i &lt; fields.length; i++) {</span>
<span class="nc" id="L587">            Field f = fields[i];</span>
            try {
<span class="nc bnc" id="L589" title="All 2 branches missed.">                if (o == f.get(null)) {</span>
<span class="nc" id="L590">                    return f.getName();</span>
                }
<span class="nc" id="L592">            } catch (Exception e) {</span>
<span class="nc" id="L593">            }</span>
        }
<span class="nc" id="L595">        return &quot;\&quot;&quot;+o.toString()+&quot;\&quot;&quot;;</span>
    }

    public static String simplename(SurfaceType st) {
<span class="nc" id="L599">        return simplename(SurfaceType.class.getDeclaredFields(), st);</span>
    }

    public static String simplename(CompositeType ct) {
<span class="nc" id="L603">        return simplename(CompositeType.class.getDeclaredFields(), ct);</span>
    }

    private String cachedname;

    public String toString() {
<span class="nc bnc" id="L609" title="All 2 branches missed.">        if (cachedname == null) {</span>
<span class="nc" id="L610">            String sig = methodSignature;</span>
<span class="nc" id="L611">            int index = sig.indexOf('(');</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">            if (index &gt;= 0) {</span>
<span class="nc" id="L613">                sig = sig.substring(0, index);</span>
            }
<span class="nc" id="L615">            cachedname = (getClass().getName()+&quot;::&quot;+</span>
                          sig+&quot;(&quot;+
<span class="nc" id="L617">                          simplename(sourceType)+&quot;, &quot;+</span>
<span class="nc" id="L618">                          simplename(compositeType)+&quot;, &quot;+</span>
<span class="nc" id="L619">                          simplename(destType)+&quot;)&quot;);</span>
        }
<span class="nc" id="L621">        return cachedname;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>