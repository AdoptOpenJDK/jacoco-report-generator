<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>GraphicsPrimitiveMgr.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.java2d.loops</a> &gt; <span class="el_source">GraphicsPrimitiveMgr.java</span></div><h1>GraphicsPrimitiveMgr.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2006, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

/*
 * @author Charlton Innovations, Inc.
 */

package sun.java2d.loops;

import java.util.Comparator;
import java.util.Arrays;
import sun.java2d.SunGraphics2D;

/**
 *   GraphicsComponentMgr provides services to
 *   1. register primitives for later use
 *   2. locate an instance of a primitve based on characteristics
 */
public final class GraphicsPrimitiveMgr {

    private static final boolean debugTrace = false;
    private static GraphicsPrimitive primitives[];
    private static GraphicsPrimitive generalPrimitives[];
<span class="nc" id="L46">    private static boolean needssort = true;</span>

    private static native void initIDs(Class GP, Class ST, Class CT,
                                       Class SG2D, Class Color, Class AT,
                                       Class XORComp, Class AlphaComp,
                                       Class Path2D, Class Path2DFloat,
                                       Class SHints);
    private static native void registerNativeLoops();

    static {
<span class="nc" id="L56">        initIDs(GraphicsPrimitive.class,</span>
                SurfaceType.class,
                CompositeType.class,
                SunGraphics2D.class,
                java.awt.Color.class,
                java.awt.geom.AffineTransform.class,
                XORComposite.class,
                java.awt.AlphaComposite.class,
                java.awt.geom.Path2D.class,
                java.awt.geom.Path2D.Float.class,
                sun.awt.SunHints.class);
<span class="nc" id="L67">        CustomComponent.register();</span>
<span class="nc" id="L68">        GeneralRenderer.register();</span>
<span class="nc" id="L69">        registerNativeLoops();</span>
    }

<span class="nc" id="L72">    private static class PrimitiveSpec {</span>
        public int uniqueID;
    }

<span class="nc" id="L76">    private static Comparator primSorter = new Comparator() {</span>
        public int compare(Object o1, Object o2) {
<span class="nc" id="L78">            int id1 = ((GraphicsPrimitive) o1).getUniqueID();</span>
<span class="nc" id="L79">            int id2 = ((GraphicsPrimitive) o2).getUniqueID();</span>

<span class="nc bnc" id="L81" title="All 4 branches missed.">            return (id1 == id2 ? 0 : (id1 &lt; id2 ? -1 : 1));</span>
        }
    };

<span class="nc" id="L85">    private static Comparator primFinder = new Comparator() {</span>
        public int compare(Object o1, Object o2) {
<span class="nc" id="L87">            int id1 = ((GraphicsPrimitive) o1).getUniqueID();</span>
<span class="nc" id="L88">            int id2 = ((PrimitiveSpec) o2).uniqueID;</span>

<span class="nc bnc" id="L90" title="All 4 branches missed.">            return (id1 == id2 ? 0 : (id1 &lt; id2 ? -1 : 1));</span>
        }
    };

    /**
     * Ensure that noone can instantiate this class.
     */
<span class="nc" id="L97">    private GraphicsPrimitiveMgr() {</span>
<span class="nc" id="L98">    }</span>

    public synchronized static void register(GraphicsPrimitive[] newPrimitives)
    {
<span class="nc" id="L102">        GraphicsPrimitive[] devCollection = primitives;</span>
<span class="nc" id="L103">        int oldSize = 0;</span>
<span class="nc" id="L104">        int newSize = newPrimitives.length;</span>
        if (debugTrace) {
            writeLog(&quot;Registering &quot; + newSize + &quot; primitives&quot;);
            for (int i = 0; i &lt; newSize; i++) {
                writeLog(newPrimitives[i].toString());
            }
        }
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (devCollection != null) {</span>
<span class="nc" id="L112">            oldSize = devCollection.length;</span>
        }
<span class="nc" id="L114">        GraphicsPrimitive[] temp = new GraphicsPrimitive[oldSize + newSize];</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (devCollection != null) {</span>
<span class="nc" id="L116">            System.arraycopy(devCollection, 0, temp, 0, oldSize);</span>
        }
<span class="nc" id="L118">        System.arraycopy(newPrimitives, 0, temp, oldSize, newSize);</span>
<span class="nc" id="L119">        needssort = true;</span>
<span class="nc" id="L120">        primitives = temp;</span>
<span class="nc" id="L121">    }</span>

    public synchronized static void registerGeneral(GraphicsPrimitive gen) {
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (generalPrimitives == null) {</span>
<span class="nc" id="L125">            generalPrimitives = new GraphicsPrimitive[] {gen};</span>
<span class="nc" id="L126">            return;</span>
        }
<span class="nc" id="L128">        int len = generalPrimitives.length;</span>
<span class="nc" id="L129">        GraphicsPrimitive[] newGen = new GraphicsPrimitive[len + 1];</span>
<span class="nc" id="L130">        System.arraycopy(generalPrimitives, 0, newGen, 0, len);</span>
<span class="nc" id="L131">        newGen[len] = gen;</span>
<span class="nc" id="L132">        generalPrimitives = newGen;</span>
<span class="nc" id="L133">    }</span>

    public synchronized static GraphicsPrimitive locate(int primTypeID,
                                                        SurfaceType dsttype)
    {
<span class="nc" id="L138">        return locate(primTypeID,</span>
                      SurfaceType.OpaqueColor,
                      CompositeType.Src,
                      dsttype);
    }

    public synchronized static GraphicsPrimitive locate(int primTypeID,
                                                        SurfaceType srctype,
                                                        CompositeType comptype,
                                                        SurfaceType dsttype)
    {
        /*
          System.out.println(&quot;Looking for:&quot;);
          System.out.println(&quot;    method: &quot;+signature);
          System.out.println(&quot;    from:   &quot;+srctype);
          System.out.println(&quot;    by:     &quot;+comptype);
          System.out.println(&quot;    to:     &quot;+dsttype);
        */
<span class="nc" id="L156">        GraphicsPrimitive prim = locatePrim(primTypeID,</span>
                                            srctype, comptype, dsttype);

<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (prim == null) {</span>
            //System.out.println(&quot;Trying general loop&quot;);
<span class="nc" id="L161">            prim = locateGeneral(primTypeID);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (prim != null) {</span>
<span class="nc" id="L163">                prim = prim.makePrimitive(srctype, comptype, dsttype);</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">                if (prim != null &amp;&amp; GraphicsPrimitive.traceflags != 0) {</span>
<span class="nc" id="L165">                    prim = prim.traceWrap();</span>
                }
            }
        }
<span class="nc" id="L169">        return prim;</span>
    }

    public synchronized static GraphicsPrimitive
        locatePrim(int primTypeID,
                   SurfaceType srctype,
                   CompositeType comptype,
                   SurfaceType dsttype)
    {
        /*
          System.out.println(&quot;Looking for:&quot;);
          System.out.println(&quot;    method: &quot;+signature);
          System.out.println(&quot;    from:   &quot;+srctype);
          System.out.println(&quot;    by:     &quot;+comptype);
          System.out.println(&quot;    to:     &quot;+dsttype);
        */
        SurfaceType src, dst;
        CompositeType cmp;
        GraphicsPrimitive prim;
<span class="nc" id="L188">        PrimitiveSpec spec = new PrimitiveSpec();</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">        for (dst = dsttype; dst != null; dst = dst.getSuperType()) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            for (src = srctype; src != null; src = src.getSuperType()) {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                for (cmp = comptype; cmp != null; cmp = cmp.getSuperType()) {</span>
                    /*
                      System.out.println(&quot;Trying:&quot;);
                      System.out.println(&quot;    method: &quot;+spec.methodSignature);
                      System.out.println(&quot;    from:   &quot;+spec.sourceType);
                      System.out.println(&quot;    by:     &quot;+spec.compType);
                      System.out.println(&quot;    to:     &quot;+spec.destType);
                    */

<span class="nc" id="L201">                    spec.uniqueID =</span>
<span class="nc" id="L202">                        GraphicsPrimitive.makeUniqueID(primTypeID, src, cmp, dst);</span>
<span class="nc" id="L203">                    prim = locate(spec);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                    if (prim != null) {</span>
                        //System.out.println(&quot;&lt;GPMgr&gt; Found: &quot; + prim + &quot; in &quot; + i + &quot; steps&quot;);
<span class="nc" id="L206">                        return prim;</span>
                    }
                }
            }
        }
<span class="nc" id="L211">        return null;</span>
    }

    private static GraphicsPrimitive locateGeneral(int primTypeID) {
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (generalPrimitives == null) {</span>
<span class="nc" id="L216">            return null;</span>
        }
<span class="nc bnc" id="L218" title="All 2 branches missed.">        for (int i = 0; i &lt; generalPrimitives.length; i++) {</span>
<span class="nc" id="L219">            GraphicsPrimitive prim = generalPrimitives[i];</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (prim.getPrimTypeID() == primTypeID) {</span>
<span class="nc" id="L221">                return prim;</span>
            }
        }
<span class="nc" id="L224">        return null;</span>
        //throw new InternalError(&quot;No general handler registered for&quot;+signature);
    }

    private static GraphicsPrimitive locate(PrimitiveSpec spec) {
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (needssort) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (GraphicsPrimitive.traceflags != 0) {</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                for (int i = 0; i &lt; primitives.length; i++) {</span>
<span class="nc" id="L232">                    primitives[i] = primitives[i].traceWrap();</span>
                }
            }
<span class="nc" id="L235">            Arrays.sort(primitives, primSorter);</span>
<span class="nc" id="L236">            needssort = false;</span>
        }
<span class="nc" id="L238">        GraphicsPrimitive[] devCollection = primitives;</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (devCollection == null) {</span>
<span class="nc" id="L240">            return null;</span>
        }
<span class="nc" id="L242">        int index = Arrays.binarySearch(devCollection, spec, primFinder);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (index &gt;= 0) {</span>
<span class="nc" id="L244">            GraphicsPrimitive prim = devCollection[index];</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (prim instanceof GraphicsPrimitiveProxy) {</span>
<span class="nc" id="L246">                prim = ((GraphicsPrimitiveProxy) prim).instantiate();</span>
<span class="nc" id="L247">                devCollection[index] = prim;</span>
                if (debugTrace) {
                    writeLog(&quot;Instantiated graphics primitive &quot; + prim);
                }
            }
            if (debugTrace) {
                writeLog(&quot;Lookup found[&quot; + index + &quot;][&quot;+ prim + &quot;]&quot;);
            }
<span class="nc" id="L255">            return prim;</span>
        }
        if (debugTrace) {
            writeLog(&quot;Lookup found nothing for:&quot;);
            writeLog(&quot; &quot; + spec.uniqueID);
        }
<span class="nc" id="L261">        return null;</span>
    }

    private static void writeLog(String str) {
        if (debugTrace) {
            System.err.println(str);
        }
<span class="nc" id="L268">    }</span>

    /**
     * Test that all of the GraphicsPrimitiveProxy objects actually
     * resolve to something.  Throws a RuntimeException if anything
     * is wrong, an has no effect if all is well.
     */
    // This is only really meant to be called from GraphicsPrimitiveProxyTest
    // in the regression tests directory, but it has to be here because
    // it needs access to a private data structure.  It is not very
    // big, though.
    public static void testPrimitiveInstantiation() {
<span class="nc" id="L280">        testPrimitiveInstantiation(false);</span>
<span class="nc" id="L281">    }</span>

    public static void testPrimitiveInstantiation(boolean verbose) {
<span class="nc" id="L284">        int resolved = 0;</span>
<span class="nc" id="L285">        int unresolved = 0;</span>
<span class="nc" id="L286">        GraphicsPrimitive[] prims = primitives;</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">        for (int j = 0; j &lt; prims.length; j++) {</span>
<span class="nc" id="L288">            GraphicsPrimitive p = prims[j];</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (p instanceof GraphicsPrimitiveProxy) {</span>
<span class="nc" id="L290">                GraphicsPrimitive r = ((GraphicsPrimitiveProxy) p).instantiate();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">                if (!r.getSignature().equals(p.getSignature()) ||</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                    r.getUniqueID() != p.getUniqueID()) {</span>
<span class="nc" id="L293">                    System.out.println(&quot;r.getSignature == &quot;+r.getSignature());</span>
<span class="nc" id="L294">                    System.out.println(&quot;r.getUniqueID == &quot; + r.getUniqueID());</span>
<span class="nc" id="L295">                    System.out.println(&quot;p.getSignature == &quot;+p.getSignature());</span>
<span class="nc" id="L296">                    System.out.println(&quot;p.getUniqueID == &quot; + p.getUniqueID());</span>
<span class="nc" id="L297">                    throw new RuntimeException(&quot;Primitive &quot; + p</span>
                                               + &quot; returns wrong signature for &quot;
<span class="nc" id="L299">                                               + r.getClass());</span>
                }
                // instantiate checks that p.satisfiesSameAs(r)
<span class="nc" id="L302">                unresolved++;</span>
<span class="nc" id="L303">                p = r;</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                if (verbose) {</span>
<span class="nc" id="L305">                    System.out.println(p);</span>
                }
<span class="nc" id="L307">            } else {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                if (verbose) {</span>
<span class="nc" id="L309">                    System.out.println(p + &quot; (not proxied).&quot;);</span>
                }
<span class="nc" id="L311">                resolved++;</span>
            }
        }
<span class="nc" id="L314">        System.out.println(resolved+</span>
                           &quot; graphics primitives were not proxied.&quot;);
<span class="nc" id="L316">        System.out.println(unresolved+</span>
                           &quot; proxied graphics primitives resolved correctly.&quot;);
<span class="nc" id="L318">        System.out.println(resolved+unresolved+</span>
                           &quot; total graphics primitives&quot;);
<span class="nc" id="L320">    }</span>

    public static void main(String argv[]) {
        // REMIND: Should trigger loading of platform primitives somehow...
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (needssort) {</span>
<span class="nc" id="L325">            Arrays.sort(primitives, primSorter);</span>
<span class="nc" id="L326">            needssort = false;</span>
        }
<span class="nc bnc" id="L328" title="All 2 branches missed.">        testPrimitiveInstantiation(argv.length &gt; 0);</span>
<span class="nc" id="L329">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>