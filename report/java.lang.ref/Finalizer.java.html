<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Finalizer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">java.lang.ref</a> &gt; <span class="el_source">Finalizer.java</span></div><h1>Finalizer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package java.lang.ref;

import java.security.PrivilegedAction;
import java.security.AccessController;
import sun.misc.JavaLangAccess;
import sun.misc.SharedSecrets;
import sun.misc.VM;

final class Finalizer extends FinalReference&lt;Object&gt; { /* Package-private; must be in
                                                          same package as the Reference
                                                          class */

<span class="fc" id="L38">    private static ReferenceQueue&lt;Object&gt; queue = new ReferenceQueue&lt;&gt;();</span>
<span class="fc" id="L39">    private static Finalizer unfinalized = null;</span>
<span class="fc" id="L40">    private static final Object lock = new Object();</span>

<span class="fc" id="L42">    private Finalizer</span>
        next = null,
        prev = null;

    private boolean hasBeenFinalized() {
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">        return (next == this);</span>
    }

    private void add() {
<span class="fc" id="L51">        synchronized (lock) {</span>
<span class="fc bfc" id="L52" title="All 2 branches covered.">            if (unfinalized != null) {</span>
<span class="fc" id="L53">                this.next = unfinalized;</span>
<span class="fc" id="L54">                unfinalized.prev = this;</span>
            }
<span class="fc" id="L56">            unfinalized = this;</span>
<span class="pc" id="L57">        }</span>
<span class="fc" id="L58">    }</span>

    private void remove() {
<span class="fc" id="L61">        synchronized (lock) {</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">            if (unfinalized == this) {</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">                if (this.next != null) {</span>
<span class="fc" id="L64">                    unfinalized = this.next;</span>
                } else {
<span class="nc" id="L66">                    unfinalized = this.prev;</span>
                }
            }
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">            if (this.next != null) {</span>
<span class="fc" id="L70">                this.next.prev = this.prev;</span>
            }
<span class="fc bfc" id="L72" title="All 2 branches covered.">            if (this.prev != null) {</span>
<span class="fc" id="L73">                this.prev.next = this.next;</span>
            }
<span class="fc" id="L75">            this.next = this;   /* Indicates that this has been finalized */</span>
<span class="fc" id="L76">            this.prev = this;</span>
<span class="pc" id="L77">        }</span>
<span class="fc" id="L78">    }</span>

    private Finalizer(Object finalizee) {
<span class="fc" id="L81">        super(finalizee, queue);</span>
<span class="fc" id="L82">        add();</span>
<span class="fc" id="L83">    }</span>

    /* Invoked by VM */
    static void register(Object finalizee) {
<span class="fc" id="L87">        new Finalizer(finalizee);</span>
<span class="fc" id="L88">    }</span>

    private void runFinalizer(JavaLangAccess jla) {
<span class="fc" id="L91">        synchronized (this) {</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">            if (hasBeenFinalized()) return;</span>
<span class="fc" id="L93">            remove();</span>
<span class="pc" id="L94">        }</span>
        try {
<span class="fc" id="L96">            Object finalizee = this.get();</span>
<span class="pc bpc" id="L97" title="1 of 4 branches missed.">            if (finalizee != null &amp;&amp; !(finalizee instanceof java.lang.Enum)) {</span>
<span class="fc" id="L98">                jla.invokeFinalize(finalizee);</span>

                /* Clear stack slot containing this variable, to decrease
                   the chances of false retention with a conservative GC */
<span class="fc" id="L102">                finalizee = null;</span>
            }
<span class="fc" id="L104">        } catch (Throwable x) { }</span>
<span class="fc" id="L105">        super.clear();</span>
<span class="fc" id="L106">    }</span>

    /* Create a privileged secondary finalizer thread in the system thread
       group for the given Runnable, and wait for it to complete.

       This method is used by both runFinalization and runFinalizersOnExit.
       The former method invokes all pending finalizers, while the latter
       invokes all uninvoked finalizers if on-exit finalization has been
       enabled.

       These two methods could have been implemented by offloading their work
       to the regular finalizer thread and waiting for that thread to finish.
       The advantage of creating a fresh thread, however, is that it insulates
       invokers of these methods from a stalled or deadlocked finalizer thread.
     */
    private static void forkSecondaryFinalizer(final Runnable proc) {
<span class="fc" id="L122">        AccessController.doPrivileged(</span>
<span class="fc" id="L123">            new PrivilegedAction&lt;Void&gt;() {</span>
                public Void run() {
<span class="fc" id="L125">                ThreadGroup tg = Thread.currentThread().getThreadGroup();</span>
<span class="fc" id="L126">                for (ThreadGroup tgn = tg;</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">                     tgn != null;</span>
<span class="fc" id="L128">                     tg = tgn, tgn = tg.getParent());</span>
<span class="fc" id="L129">                Thread sft = new Thread(tg, proc, &quot;Secondary finalizer&quot;);</span>
<span class="fc" id="L130">                sft.start();</span>
                try {
<span class="fc" id="L132">                    sft.join();</span>
<span class="nc" id="L133">                } catch (InterruptedException x) {</span>
                    /* Ignore */
<span class="fc" id="L135">                }</span>
<span class="fc" id="L136">                return null;</span>
                }});
<span class="fc" id="L138">    }</span>

    /* Called by Runtime.runFinalization() */
    static void runFinalization() {
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (!VM.isBooted()) {</span>
<span class="nc" id="L143">            return;</span>
        }

<span class="fc" id="L146">        forkSecondaryFinalizer(new Runnable() {</span>
            private volatile boolean running;
            public void run() {
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">                if (running)</span>
<span class="nc" id="L150">                    return;</span>
<span class="fc" id="L151">                final JavaLangAccess jla = SharedSecrets.getJavaLangAccess();</span>
<span class="fc" id="L152">                running = true;</span>
                for (;;) {
<span class="fc" id="L154">                    Finalizer f = (Finalizer)queue.poll();</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">                    if (f == null) break;</span>
<span class="fc" id="L156">                    f.runFinalizer(jla);</span>
<span class="fc" id="L157">                }</span>
<span class="fc" id="L158">            }</span>
        });
<span class="fc" id="L160">    }</span>

    /* Invoked by java.lang.Shutdown */
    static void runAllFinalizers() {
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!VM.isBooted()) {</span>
<span class="nc" id="L165">            return;</span>
        }

<span class="nc" id="L168">        forkSecondaryFinalizer(new Runnable() {</span>
            private volatile boolean running;
            public void run() {
<span class="nc bnc" id="L171" title="All 2 branches missed.">                if (running)</span>
<span class="nc" id="L172">                    return;</span>
<span class="nc" id="L173">                final JavaLangAccess jla = SharedSecrets.getJavaLangAccess();</span>
<span class="nc" id="L174">                running = true;</span>
                for (;;) {
                    Finalizer f;
<span class="nc" id="L177">                    synchronized (lock) {</span>
<span class="nc" id="L178">                        f = unfinalized;</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                        if (f == null) break;</span>
<span class="nc" id="L180">                        unfinalized = f.next;</span>
<span class="nc" id="L181">                    }</span>
<span class="nc" id="L182">                    f.runFinalizer(jla);</span>
<span class="nc" id="L183">                }}});</span>
<span class="nc" id="L184">    }</span>

    private static class FinalizerThread extends Thread {
        private volatile boolean running;
        FinalizerThread(ThreadGroup g) {
<span class="fc" id="L189">            super(g, &quot;Finalizer&quot;);</span>
<span class="fc" id="L190">        }</span>
        public void run() {
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            if (running)</span>
<span class="nc" id="L193">                return;</span>

            // Finalizer thread starts before System.initializeSystemClass
            // is called.  Wait until JavaLangAccess is available
<span class="fc bfc" id="L197" title="All 2 branches covered.">            while (!VM.isBooted()) {</span>
                // delay until VM completes initialization
                try {
<span class="fc" id="L200">                    VM.awaitBooted();</span>
<span class="nc" id="L201">                } catch (InterruptedException x) {</span>
                    // ignore and continue
<span class="pc" id="L203">                }</span>
            }
<span class="fc" id="L205">            final JavaLangAccess jla = SharedSecrets.getJavaLangAccess();</span>
<span class="fc" id="L206">            running = true;</span>
            for (;;) {
                try {
<span class="fc" id="L209">                    Finalizer f = (Finalizer)queue.remove();</span>
<span class="fc" id="L210">                    f.runFinalizer(jla);</span>
<span class="nc" id="L211">                } catch (InterruptedException x) {</span>
                    // ignore and continue
<span class="pc" id="L213">                }</span>
            }
        }
    }

    static {
<span class="fc" id="L219">        ThreadGroup tg = Thread.currentThread().getThreadGroup();</span>
<span class="fc" id="L220">        for (ThreadGroup tgn = tg;</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">             tgn != null;</span>
<span class="fc" id="L222">             tg = tgn, tgn = tg.getParent());</span>
<span class="fc" id="L223">        Thread finalizer = new FinalizerThread(tg);</span>
<span class="fc" id="L224">        finalizer.setPriority(Thread.MAX_PRIORITY - 2);</span>
<span class="fc" id="L225">        finalizer.setDaemon(true);</span>
<span class="fc" id="L226">        finalizer.start();</span>
<span class="fc" id="L227">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>