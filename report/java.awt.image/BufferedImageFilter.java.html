<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BufferedImageFilter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">java.awt.image</a> &gt; <span class="el_source">BufferedImageFilter.java</span></div><h1>BufferedImageFilter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2000, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package java.awt.image;

import java.util.Hashtable;
import java.awt.image.ImageConsumer;
import java.awt.image.ImageFilter;

/**
 * The &lt;code&gt;BufferedImageFilter&lt;/code&gt; class subclasses an
 * &lt;code&gt;ImageFilter&lt;/code&gt; to provide a simple means of
 * using a single-source/single-destination image operator
 * ({@link BufferedImageOp}) to filter a &lt;code&gt;BufferedImage&lt;/code&gt;
 * in the Image Producer/Consumer/Observer
 * paradigm. Examples of these image operators are: {@link ConvolveOp},
 * {@link AffineTransformOp} and {@link LookupOp}.
 *
 * @see ImageFilter
 * @see BufferedImage
 * @see BufferedImageOp
 */

public class BufferedImageFilter extends ImageFilter implements Cloneable {
    BufferedImageOp bufferedImageOp;
    ColorModel model;
    int width;
    int height;
    byte[] bytePixels;
    int[] intPixels;

    /**
     * Constructs a &lt;code&gt;BufferedImageFilter&lt;/code&gt; with the
     * specified single-source/single-destination operator.
     * @param op the specified &lt;code&gt;BufferedImageOp&lt;/code&gt; to
     *           use to filter a &lt;code&gt;BufferedImage&lt;/code&gt;
     * @throws NullPointerException if op is null
     */
    public BufferedImageFilter (BufferedImageOp op) {
<span class="nc" id="L62">        super();</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (op == null) {</span>
<span class="nc" id="L64">            throw new NullPointerException(&quot;Operation cannot be null&quot;);</span>
        }
<span class="nc" id="L66">        bufferedImageOp = op;</span>
<span class="nc" id="L67">    }</span>

    /**
     * Returns the &lt;code&gt;BufferedImageOp&lt;/code&gt;.
     * @return the operator of this &lt;code&gt;BufferedImageFilter&lt;/code&gt;.
     */
    public BufferedImageOp getBufferedImageOp() {
<span class="nc" id="L74">        return bufferedImageOp;</span>
    }

    /**
     * Filters the information provided in the
     * {@link ImageConsumer#setDimensions(int, int) setDimensions } method
     * of the {@link ImageConsumer} interface.
     * &lt;p&gt;
     * Note: This method is intended to be called by the
     * {@link ImageProducer} of the &lt;code&gt;Image&lt;/code&gt; whose pixels are
     * being filtered. Developers using this class to retrieve pixels from
     * an image should avoid calling this method directly since that
     * operation could result in problems with retrieving the requested
     * pixels.
     * &lt;p&gt;
     * @param width the width to which to set the width of this
     *        &lt;code&gt;BufferedImageFilter&lt;/code&gt;
     * @param height the height to which to set the height of this
     *        &lt;code&gt;BufferedImageFilter&lt;/code&gt;
     * @see ImageConsumer#setDimensions
     */
    public void setDimensions(int width, int height) {
<span class="nc bnc" id="L96" title="All 4 branches missed.">        if (width &lt;= 0 || height &lt;= 0) {</span>
<span class="nc" id="L97">            imageComplete(STATICIMAGEDONE);</span>
<span class="nc" id="L98">            return;</span>
        }
<span class="nc" id="L100">        this.width  = width;</span>
<span class="nc" id="L101">        this.height = height;</span>
<span class="nc" id="L102">    }</span>

    /**
     * Filters the information provided in the
     * {@link ImageConsumer#setColorModel(ColorModel) setColorModel} method
     * of the &lt;code&gt;ImageConsumer&lt;/code&gt; interface.
     * &lt;p&gt;
     * If &lt;code&gt;model&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;, this
     * method clears the current &lt;code&gt;ColorModel&lt;/code&gt; of this
     * &lt;code&gt;BufferedImageFilter&lt;/code&gt;.
     * &lt;p&gt;
     * Note: This method is intended to be called by the
     * &lt;code&gt;ImageProducer&lt;/code&gt; of the &lt;code&gt;Image&lt;/code&gt;
     * whose pixels are being filtered.  Developers using this
     * class to retrieve pixels from an image
     * should avoid calling this method directly since that
     * operation could result in problems with retrieving the
     * requested pixels.
     * @param model the {@link ColorModel} to which to set the
     *        &lt;code&gt;ColorModel&lt;/code&gt; of this &lt;code&gt;BufferedImageFilter&lt;/code&gt;
     * @see ImageConsumer#setColorModel
     */
    public void setColorModel(ColorModel model) {
<span class="nc" id="L125">        this.model = model;</span>
<span class="nc" id="L126">    }</span>

    private void convertToRGB() {
<span class="nc" id="L129">        int size = width * height;</span>
<span class="nc" id="L130">        int newpixels[] = new int[size];</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (bytePixels != null) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            for (int i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L133">                newpixels[i] = this.model.getRGB(bytePixels[i] &amp; 0xff);</span>
            }
<span class="nc bnc" id="L135" title="All 2 branches missed.">        } else if (intPixels != null) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            for (int i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L137">                newpixels[i] = this.model.getRGB(intPixels[i]);</span>
            }
        }
<span class="nc" id="L140">        bytePixels = null;</span>
<span class="nc" id="L141">        intPixels = newpixels;</span>
<span class="nc" id="L142">        this.model = ColorModel.getRGBdefault();</span>
<span class="nc" id="L143">    }</span>

    /**
     * Filters the information provided in the &lt;code&gt;setPixels&lt;/code&gt;
     * method of the &lt;code&gt;ImageConsumer&lt;/code&gt; interface which takes
     * an array of bytes.
     * &lt;p&gt;
     * Note: This method is intended to be called by the
     * &lt;code&gt;ImageProducer&lt;/code&gt; of the &lt;code&gt;Image&lt;/code&gt; whose pixels
     * are being filtered.  Developers using
     * this class to retrieve pixels from an image should avoid calling
     * this method directly since that operation could result in problems
     * with retrieving the requested pixels.
     * @throws IllegalArgumentException if width or height are less than
     * zero.
     * @see ImageConsumer#setPixels(int, int, int, int, ColorModel, byte[],
                                    int, int)
     */
    public void setPixels(int x, int y, int w, int h,
                          ColorModel model, byte pixels[], int off,
                          int scansize) {
        // Fix 4184230
<span class="nc bnc" id="L165" title="All 4 branches missed.">        if (w &lt; 0 || h &lt; 0) {</span>
<span class="nc" id="L166">            throw new IllegalArgumentException(&quot;Width (&quot;+w+</span>
                                                &quot;) and height (&quot;+h+
                                                &quot;) must be &gt; 0&quot;);
        }
        // Nothing to do
<span class="nc bnc" id="L171" title="All 4 branches missed.">        if (w == 0 || h == 0) {</span>
<span class="nc" id="L172">            return;</span>
        }
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (y &lt; 0) {</span>
<span class="nc" id="L175">            int diff = -y;</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (diff &gt;= h) {</span>
<span class="nc" id="L177">                return;</span>
            }
<span class="nc" id="L179">            off += scansize * diff;</span>
<span class="nc" id="L180">            y += diff;</span>
<span class="nc" id="L181">            h -= diff;</span>
        }
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (y + h &gt; height) {</span>
<span class="nc" id="L184">            h = height - y;</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (h &lt;= 0) {</span>
<span class="nc" id="L186">                return;</span>
            }
        }
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (x &lt; 0) {</span>
<span class="nc" id="L190">            int diff = -x;</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (diff &gt;= w) {</span>
<span class="nc" id="L192">                return;</span>
            }
<span class="nc" id="L194">            off += diff;</span>
<span class="nc" id="L195">            x += diff;</span>
<span class="nc" id="L196">            w -= diff;</span>
        }
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (x + w &gt; width) {</span>
<span class="nc" id="L199">            w = width - x;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (w &lt;= 0) {</span>
<span class="nc" id="L201">                return;</span>
            }
        }
<span class="nc" id="L204">        int dstPtr = y*width + x;</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (intPixels == null) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (bytePixels == null) {</span>
<span class="nc" id="L207">                bytePixels = new byte[width*height];</span>
<span class="nc" id="L208">                this.model = model;</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            } else if (this.model != model) {</span>
<span class="nc" id="L210">                convertToRGB();</span>
            }
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (bytePixels != null) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                for (int sh = h; sh &gt; 0; sh--) {</span>
<span class="nc" id="L214">                    System.arraycopy(pixels, off, bytePixels, dstPtr, w);</span>
<span class="nc" id="L215">                    off += scansize;</span>
<span class="nc" id="L216">                    dstPtr += width;</span>
                }
            }
        }
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (intPixels != null) {</span>
<span class="nc" id="L221">            int dstRem = width - w;</span>
<span class="nc" id="L222">            int srcRem = scansize - w;</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            for (int sh = h; sh &gt; 0; sh--) {</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                for (int sw = w; sw &gt; 0; sw--) {</span>
<span class="nc" id="L225">                    intPixels[dstPtr++] = model.getRGB(pixels[off++]&amp;0xff);</span>
                }
<span class="nc" id="L227">                off    += srcRem;</span>
<span class="nc" id="L228">                dstPtr += dstRem;</span>
            }
        }
<span class="nc" id="L231">    }</span>
    /**
     * Filters the information provided in the &lt;code&gt;setPixels&lt;/code&gt;
     * method of the &lt;code&gt;ImageConsumer&lt;/code&gt; interface which takes
     * an array of integers.
     * &lt;p&gt;
     * Note: This method is intended to be called by the
     * &lt;code&gt;ImageProducer&lt;/code&gt; of the &lt;code&gt;Image&lt;/code&gt; whose
     * pixels are being filtered.  Developers using this class to
     * retrieve pixels from an image should avoid calling this method
     * directly since that operation could result in problems
     * with retrieving the requested pixels.
     * @throws IllegalArgumentException if width or height are less than
     * zero.
     * @see ImageConsumer#setPixels(int, int, int, int, ColorModel, int[],
                                    int, int)
     */
    public void setPixels(int x, int y, int w, int h,
                          ColorModel model, int pixels[], int off,
                          int scansize) {
        // Fix 4184230
<span class="nc bnc" id="L252" title="All 4 branches missed.">        if (w &lt; 0 || h &lt; 0) {</span>
<span class="nc" id="L253">            throw new IllegalArgumentException(&quot;Width (&quot;+w+</span>
                                                &quot;) and height (&quot;+h+
                                                &quot;) must be &gt; 0&quot;);
        }
        // Nothing to do
<span class="nc bnc" id="L258" title="All 4 branches missed.">        if (w == 0 || h == 0) {</span>
<span class="nc" id="L259">            return;</span>
        }
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (y &lt; 0) {</span>
<span class="nc" id="L262">            int diff = -y;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (diff &gt;= h) {</span>
<span class="nc" id="L264">                return;</span>
            }
<span class="nc" id="L266">            off += scansize * diff;</span>
<span class="nc" id="L267">            y += diff;</span>
<span class="nc" id="L268">            h -= diff;</span>
        }
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (y + h &gt; height) {</span>
<span class="nc" id="L271">            h = height - y;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (h &lt;= 0) {</span>
<span class="nc" id="L273">                return;</span>
            }
        }
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (x &lt; 0) {</span>
<span class="nc" id="L277">            int diff = -x;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">            if (diff &gt;= w) {</span>
<span class="nc" id="L279">                return;</span>
            }
<span class="nc" id="L281">            off += diff;</span>
<span class="nc" id="L282">            x += diff;</span>
<span class="nc" id="L283">            w -= diff;</span>
        }
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (x + w &gt; width) {</span>
<span class="nc" id="L286">            w = width - x;</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">            if (w &lt;= 0) {</span>
<span class="nc" id="L288">                return;</span>
            }
        }

<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (intPixels == null) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (bytePixels == null) {</span>
<span class="nc" id="L294">                intPixels = new int[width * height];</span>
<span class="nc" id="L295">                this.model = model;</span>
            } else {
<span class="nc" id="L297">                convertToRGB();</span>
            }
        }
<span class="nc" id="L300">        int dstPtr = y*width + x;</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (this.model == model) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            for (int sh = h; sh &gt; 0; sh--) {</span>
<span class="nc" id="L303">                System.arraycopy(pixels, off, intPixels, dstPtr, w);</span>
<span class="nc" id="L304">                off += scansize;</span>
<span class="nc" id="L305">                dstPtr += width;</span>
            }
        } else {
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if (this.model != ColorModel.getRGBdefault()) {</span>
<span class="nc" id="L309">                convertToRGB();</span>
            }
<span class="nc" id="L311">            int dstRem = width - w;</span>
<span class="nc" id="L312">            int srcRem = scansize - w;</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            for (int sh = h; sh &gt; 0; sh--) {</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                for (int sw = w; sw &gt; 0; sw--) {</span>
<span class="nc" id="L315">                    intPixels[dstPtr++] = model.getRGB(pixels[off++]);</span>
                }
<span class="nc" id="L317">                off += srcRem;</span>
<span class="nc" id="L318">                dstPtr += dstRem;</span>
            }
        }
<span class="nc" id="L321">    }</span>

    /**
     * Filters the information provided in the &lt;code&gt;imageComplete&lt;/code&gt;
     * method of the &lt;code&gt;ImageConsumer&lt;/code&gt; interface.
     * &lt;p&gt;
     * Note: This method is intended to be called by the
     * &lt;code&gt;ImageProducer&lt;/code&gt; of the &lt;code&gt;Image&lt;/code&gt; whose pixels
     * are being filtered.  Developers using
     * this class to retrieve pixels from an image should avoid calling
     * this method directly since that operation could result in problems
     * with retrieving the requested pixels.
     * @param status the status of image loading
     * @throws ImagingOpException if there was a problem calling the filter
     * method of the &lt;code&gt;BufferedImageOp&lt;/code&gt; associated with this
     * instance.
     * @see ImageConsumer#imageComplete
     */
    public void imageComplete(int status) {
        WritableRaster wr;
<span class="nc bnc" id="L341" title="All 3 branches missed.">        switch(status) {</span>
        case IMAGEERROR:
        case IMAGEABORTED:
            // reinitialize the params
<span class="nc" id="L345">            model  = null;</span>
<span class="nc" id="L346">            width  = -1;</span>
<span class="nc" id="L347">            height = -1;</span>
<span class="nc" id="L348">            intPixels  = null;</span>
<span class="nc" id="L349">            bytePixels = null;</span>
<span class="nc" id="L350">            break;</span>

        case SINGLEFRAMEDONE:
        case STATICIMAGEDONE:
<span class="nc bnc" id="L354" title="All 4 branches missed.">            if (width &lt;= 0 || height &lt;= 0) break;</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            if (model instanceof DirectColorModel) {</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                if (intPixels == null) break;</span>
<span class="nc" id="L357">                wr = createDCMraster();</span>
            }
<span class="nc bnc" id="L359" title="All 2 branches missed.">            else if (model instanceof IndexColorModel) {</span>
<span class="nc" id="L360">                int[] bandOffsets = {0};</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                if (bytePixels == null) break;</span>
<span class="nc" id="L362">                DataBufferByte db = new DataBufferByte(bytePixels,</span>
                                                       width*height);
<span class="nc" id="L364">                wr = Raster.createInterleavedRaster(db, width, height, width,</span>
                                                    1, bandOffsets, null);
<span class="nc" id="L366">            }</span>
            else {
<span class="nc" id="L368">                convertToRGB();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">                if (intPixels == null) break;</span>
<span class="nc" id="L370">                wr = createDCMraster();</span>
            }
<span class="nc" id="L372">            BufferedImage bi = new BufferedImage(model, wr,</span>
<span class="nc" id="L373">                                                 model.isAlphaPremultiplied(),</span>
                                                 null);
<span class="nc" id="L375">            bi = bufferedImageOp.filter(bi, null);</span>
<span class="nc" id="L376">            WritableRaster r = bi.getRaster();</span>
<span class="nc" id="L377">            ColorModel cm = bi.getColorModel();</span>
<span class="nc" id="L378">            int w = r.getWidth();</span>
<span class="nc" id="L379">            int h = r.getHeight();</span>
<span class="nc" id="L380">            consumer.setDimensions(w, h);</span>
<span class="nc" id="L381">            consumer.setColorModel(cm);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (cm instanceof DirectColorModel) {</span>
<span class="nc" id="L383">                DataBufferInt db = (DataBufferInt) r.getDataBuffer();</span>
<span class="nc" id="L384">                consumer.setPixels(0, 0, w, h,</span>
<span class="nc" id="L385">                                   cm, db.getData(), 0, w);</span>
<span class="nc" id="L386">            }</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">            else if (cm instanceof IndexColorModel) {</span>
<span class="nc" id="L388">                DataBufferByte db = (DataBufferByte) r.getDataBuffer();</span>
<span class="nc" id="L389">                consumer.setPixels(0, 0, w, h,</span>
<span class="nc" id="L390">                                   cm, db.getData(), 0, w);</span>
<span class="nc" id="L391">            }</span>
            else {
<span class="nc" id="L393">                throw new InternalError(&quot;Unknown color model &quot;+cm);</span>
            }
            break;
        }
<span class="nc" id="L397">        consumer.imageComplete(status);</span>
<span class="nc" id="L398">    }</span>

    private final WritableRaster createDCMraster() {
        WritableRaster wr;
<span class="nc" id="L402">        DirectColorModel dcm = (DirectColorModel) model;</span>
<span class="nc" id="L403">        boolean hasAlpha = model.hasAlpha();</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">        int[] bandMasks = new int[3+(hasAlpha ? 1 : 0)];</span>
<span class="nc" id="L405">        bandMasks[0] = dcm.getRedMask();</span>
<span class="nc" id="L406">        bandMasks[1] = dcm.getGreenMask();</span>
<span class="nc" id="L407">        bandMasks[2] = dcm.getBlueMask();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (hasAlpha) {</span>
<span class="nc" id="L409">            bandMasks[3] = dcm.getAlphaMask();</span>
        }
<span class="nc" id="L411">        DataBufferInt db = new DataBufferInt(intPixels, width*height);</span>
<span class="nc" id="L412">        wr = Raster.createPackedRaster(db, width, height, width,</span>
                                       bandMasks, null);
<span class="nc" id="L414">        return wr;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>