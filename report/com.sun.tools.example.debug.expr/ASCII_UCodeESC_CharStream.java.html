<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ASCII_UCodeESC_CharStream.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.tools.example.debug.expr</a> &gt; <span class="el_source">ASCII_UCodeESC_CharStream.java</span></div><h1>ASCII_UCodeESC_CharStream.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

/*
 * This source code is provided to illustrate the usage of a given feature
 * or technique and has been deliberately simplified. Additional steps
 * required for a production-quality application, such as security checks,
 * input validation and proper error handling, might not be present in
 * this sample code.
 */


/* Generated By:JavaCC: Do not edit this line. ASCII_UCodeESC_CharStream.java Version 0.7pre6 */

package com.sun.tools.example.debug.expr;

/**
 * An implementation of interface CharStream, where the stream is assumed to
 * contain only ASCII characters (with java-like unicode escape processing).
 */

public final class ASCII_UCodeESC_CharStream
{
  public static final boolean staticFlag = false;
  static final int hexval(char c) throws java.io.IOException {
<span class="nc bnc" id="L48" title="All 17 branches missed.">    switch(c)</span>
    {
       case '0' :
<span class="nc" id="L51">          return 0;</span>
       case '1' :
<span class="nc" id="L53">          return 1;</span>
       case '2' :
<span class="nc" id="L55">          return 2;</span>
       case '3' :
<span class="nc" id="L57">          return 3;</span>
       case '4' :
<span class="nc" id="L59">          return 4;</span>
       case '5' :
<span class="nc" id="L61">          return 5;</span>
       case '6' :
<span class="nc" id="L63">          return 6;</span>
       case '7' :
<span class="nc" id="L65">          return 7;</span>
       case '8' :
<span class="nc" id="L67">          return 8;</span>
       case '9' :
<span class="nc" id="L69">          return 9;</span>

       case 'a' :
       case 'A' :
<span class="nc" id="L73">          return 10;</span>
       case 'b' :
       case 'B' :
<span class="nc" id="L76">          return 11;</span>
       case 'c' :
       case 'C' :
<span class="nc" id="L79">          return 12;</span>
       case 'd' :
       case 'D' :
<span class="nc" id="L82">          return 13;</span>
       case 'e' :
       case 'E' :
<span class="nc" id="L85">          return 14;</span>
       case 'f' :
       case 'F' :
<span class="nc" id="L88">          return 15;</span>
    }

<span class="nc" id="L91">    throw new java.io.IOException(); // Should never come here</span>
  }

<span class="nc" id="L94">  public int bufpos = -1;</span>
  int bufsize;
  int available;
  int tokenBegin;
  private int bufline[];
  private int bufcolumn[];

<span class="nc" id="L101">  private int column = 0;</span>
<span class="nc" id="L102">  private int line = 1;</span>

  private java.io.InputStream inputStream;

<span class="nc" id="L106">  private boolean prevCharIsCR = false;</span>
<span class="nc" id="L107">  private boolean prevCharIsLF = false;</span>

  private byte[] nextCharBuf;
  private char[] buffer;
<span class="nc" id="L111">  private int maxNextCharInd = 0;</span>
<span class="nc" id="L112">  private int nextCharInd = -1;</span>
<span class="nc" id="L113">  private int inBuf = 0;</span>

  private final void ExpandBuff(boolean wrapAround)
  {
<span class="nc" id="L117">     char[] newbuffer = new char[bufsize + 2048];</span>
<span class="nc" id="L118">     int newbufline[] = new int[bufsize + 2048];</span>
<span class="nc" id="L119">     int newbufcolumn[] = new int[bufsize + 2048];</span>

     try
     {
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (wrapAround)</span>
        {
<span class="nc" id="L125">           System.arraycopy(buffer, tokenBegin, newbuffer, 0, bufsize - tokenBegin);</span>
<span class="nc" id="L126">           System.arraycopy(buffer, 0, newbuffer,</span>
                                             bufsize - tokenBegin, bufpos);
<span class="nc" id="L128">           buffer = newbuffer;</span>

<span class="nc" id="L130">           System.arraycopy(bufline, tokenBegin, newbufline, 0, bufsize - tokenBegin);</span>
<span class="nc" id="L131">           System.arraycopy(bufline, 0, newbufline, bufsize - tokenBegin, bufpos);</span>
<span class="nc" id="L132">           bufline = newbufline;</span>

<span class="nc" id="L134">           System.arraycopy(bufcolumn, tokenBegin, newbufcolumn, 0, bufsize - tokenBegin);</span>
<span class="nc" id="L135">           System.arraycopy(bufcolumn, 0, newbufcolumn, bufsize - tokenBegin, bufpos);</span>
<span class="nc" id="L136">           bufcolumn = newbufcolumn;</span>

<span class="nc" id="L138">           bufpos += (bufsize - tokenBegin);</span>
        }
        else
        {
<span class="nc" id="L142">           System.arraycopy(buffer, tokenBegin, newbuffer, 0, bufsize - tokenBegin);</span>
<span class="nc" id="L143">           buffer = newbuffer;</span>

<span class="nc" id="L145">           System.arraycopy(bufline, tokenBegin, newbufline, 0, bufsize - tokenBegin);</span>
<span class="nc" id="L146">           bufline = newbufline;</span>

<span class="nc" id="L148">           System.arraycopy(bufcolumn, tokenBegin, newbufcolumn, 0, bufsize - tokenBegin);</span>
<span class="nc" id="L149">           bufcolumn = newbufcolumn;</span>

<span class="nc" id="L151">           bufpos -= tokenBegin;</span>
        }
     }
<span class="nc" id="L154">     catch (Throwable t)</span>
     {
<span class="nc" id="L156">        throw new Error(t.getMessage());</span>
<span class="nc" id="L157">     }</span>

<span class="nc" id="L159">     available = (bufsize += 2048);</span>
<span class="nc" id="L160">     tokenBegin = 0;</span>
<span class="nc" id="L161">  }</span>

  private final void FillBuff() throws java.io.IOException
  {
     int i;
<span class="nc bnc" id="L166" title="All 2 branches missed.">     if (maxNextCharInd == 4096)</span>
<span class="nc" id="L167">        maxNextCharInd = nextCharInd = 0;</span>

     try {
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if ((i = inputStream.read(nextCharBuf, maxNextCharInd,</span>
                                            4096 - maxNextCharInd)) == -1)
        {
<span class="nc" id="L173">           inputStream.close();</span>
<span class="nc" id="L174">           throw new java.io.IOException();</span>
        }
        else
<span class="nc" id="L177">           maxNextCharInd += i;</span>
<span class="nc" id="L178">        return;</span>
     }
<span class="nc" id="L180">     catch(java.io.IOException e) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (bufpos != 0)</span>
        {
<span class="nc" id="L183">           --bufpos;</span>
<span class="nc" id="L184">           backup(0);</span>
        }
        else
        {
<span class="nc" id="L188">           bufline[bufpos] = line;</span>
<span class="nc" id="L189">           bufcolumn[bufpos] = column;</span>
        }
<span class="nc" id="L191">        throw e;</span>
     }
  }

  private final byte ReadByte() throws java.io.IOException
  {
<span class="nc bnc" id="L197" title="All 2 branches missed.">     if (++nextCharInd &gt;= maxNextCharInd)</span>
<span class="nc" id="L198">        FillBuff();</span>

<span class="nc" id="L200">     return nextCharBuf[nextCharInd];</span>
  }

  public final char BeginToken() throws java.io.IOException
  {
<span class="nc bnc" id="L205" title="All 2 branches missed.">     if (inBuf &gt; 0)</span>
     {
<span class="nc" id="L207">        --inBuf;</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        return buffer[tokenBegin = (bufpos == bufsize - 1) ? (bufpos = 0)</span>
                                                           : ++bufpos];
     }

<span class="nc" id="L212">     tokenBegin = 0;</span>
<span class="nc" id="L213">     bufpos = -1;</span>

<span class="nc" id="L215">     return readChar();</span>
  }

  private final void AdjustBuffSize()
  {
<span class="nc bnc" id="L220" title="All 2 branches missed.">     if (available == bufsize)</span>
     {
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (tokenBegin &gt; 2048)</span>
        {
<span class="nc" id="L224">           bufpos = 0;</span>
<span class="nc" id="L225">           available = tokenBegin;</span>
        }
        else
<span class="nc" id="L228">           ExpandBuff(false);</span>
     }
<span class="nc bnc" id="L230" title="All 2 branches missed.">     else if (available &gt; tokenBegin)</span>
<span class="nc" id="L231">        available = bufsize;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">     else if ((tokenBegin - available) &lt; 2048)</span>
<span class="nc" id="L233">        ExpandBuff(true);</span>
     else
<span class="nc" id="L235">        available = tokenBegin;</span>
<span class="nc" id="L236">  }</span>

  private final void UpdateLineColumn(char c)
  {
<span class="nc" id="L240">     column++;</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">     if (prevCharIsLF)</span>
     {
<span class="nc" id="L244">        prevCharIsLF = false;</span>
<span class="nc" id="L245">        line += (column = 1);</span>
     }
<span class="nc bnc" id="L247" title="All 2 branches missed.">     else if (prevCharIsCR)</span>
     {
<span class="nc" id="L249">        prevCharIsCR = false;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (c == '\n')</span>
        {
<span class="nc" id="L252">           prevCharIsLF = true;</span>
        }
        else
<span class="nc" id="L255">           line += (column = 1);</span>
     }

<span class="nc bnc" id="L258" title="All 4 branches missed.">     switch (c)</span>
     {
        case '\r' :
<span class="nc" id="L261">           prevCharIsCR = true;</span>
<span class="nc" id="L262">           break;</span>
        case '\n' :
<span class="nc" id="L264">           prevCharIsLF = true;</span>
<span class="nc" id="L265">           break;</span>
        case '\t' :
<span class="nc" id="L267">           column--;</span>
<span class="nc" id="L268">           column += (8 - (column &amp; 07));</span>
<span class="nc" id="L269">           break;</span>
        default :
           break;
     }

<span class="nc" id="L274">     bufline[bufpos] = line;</span>
<span class="nc" id="L275">     bufcolumn[bufpos] = column;</span>
<span class="nc" id="L276">  }</span>

  public final char readChar() throws java.io.IOException
  {
<span class="nc bnc" id="L280" title="All 2 branches missed.">     if (inBuf &gt; 0)</span>
     {
<span class="nc" id="L282">        --inBuf;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        return buffer[(bufpos == bufsize - 1) ? (bufpos = 0) : ++bufpos];</span>
     }

     char c;

<span class="nc bnc" id="L288" title="All 2 branches missed.">     if (++bufpos == available)</span>
<span class="nc" id="L289">        AdjustBuffSize();</span>

<span class="nc bnc" id="L291" title="All 2 branches missed.">     if (((buffer[bufpos] = c = (char)((char)0xff &amp; ReadByte())) == '\\'))</span>
     {
<span class="nc" id="L293">        UpdateLineColumn(c);</span>

<span class="nc" id="L295">        int backSlashCnt = 1;</span>

        for (;;) // Read all the backslashes
        {
<span class="nc bnc" id="L299" title="All 2 branches missed.">           if (++bufpos == available)</span>
<span class="nc" id="L300">              AdjustBuffSize();</span>

           try
           {
<span class="nc bnc" id="L304" title="All 2 branches missed.">              if ((buffer[bufpos] = c = (char)((char)0xff &amp; ReadByte())) != '\\')</span>
              {
<span class="nc" id="L306">                 UpdateLineColumn(c);</span>
                 // found a non-backslash char.
<span class="nc bnc" id="L308" title="All 4 branches missed.">                 if ((c == 'u') &amp;&amp; ((backSlashCnt &amp; 1) == 1))</span>
                 {
<span class="nc bnc" id="L310" title="All 2 branches missed.">                    if (--bufpos &lt; 0)</span>
<span class="nc" id="L311">                       bufpos = bufsize - 1;</span>

<span class="nc" id="L313">                    break;</span>
                 }

<span class="nc" id="L316">                 backup(backSlashCnt);</span>
<span class="nc" id="L317">                 return '\\';</span>
              }
           }
<span class="nc" id="L320">           catch(java.io.IOException e)</span>
           {
<span class="nc bnc" id="L322" title="All 2 branches missed.">              if (backSlashCnt &gt; 1)</span>
<span class="nc" id="L323">                 backup(backSlashCnt);</span>

<span class="nc" id="L325">              return '\\';</span>
<span class="nc" id="L326">           }</span>

<span class="nc" id="L328">           UpdateLineColumn(c);</span>
<span class="nc" id="L329">           backSlashCnt++;</span>
        }

        // Here, we have seen an odd number of backslash's followed by a 'u'
        try
        {
<span class="nc bnc" id="L335" title="All 2 branches missed.">           while ((c = (char)((char)0xff &amp; ReadByte())) == 'u')</span>
<span class="nc" id="L336">              ++column;</span>

<span class="nc" id="L338">           buffer[bufpos] = c = (char)(hexval(c) &lt;&lt; 12 |</span>
<span class="nc" id="L339">                                       hexval((char)((char)0xff &amp; ReadByte())) &lt;&lt; 8 |</span>
<span class="nc" id="L340">                                       hexval((char)((char)0xff &amp; ReadByte())) &lt;&lt; 4 |</span>
<span class="nc" id="L341">                                       hexval((char)((char)0xff &amp; ReadByte())));</span>

<span class="nc" id="L343">           column += 4;</span>
        }
<span class="nc" id="L345">        catch(java.io.IOException e)</span>
        {
<span class="nc" id="L347">           throw new Error(&quot;Invalid escape character at line &quot; + line +</span>
                                         &quot; column &quot; + column + &quot;.&quot;);
<span class="nc" id="L349">        }</span>

<span class="nc bnc" id="L351" title="All 2 branches missed.">        if (backSlashCnt == 1)</span>
<span class="nc" id="L352">           return c;</span>
        else
        {
<span class="nc" id="L355">           backup(backSlashCnt - 1);</span>
<span class="nc" id="L356">           return '\\';</span>
        }
     }
     else
     {
<span class="nc" id="L361">        UpdateLineColumn(c);</span>
<span class="nc" id="L362">        return (c);</span>
     }
  }

  /**
   * @deprecated
   * @see #getEndColumn
   */
    @Deprecated
  public final int getColumn() {
<span class="nc" id="L372">     return bufcolumn[bufpos];</span>
  }

  /**
   * @deprecated
   * @see #getEndLine
   */
    @Deprecated
  public final int getLine() {
<span class="nc" id="L381">     return bufline[bufpos];</span>
  }

  public final int getEndColumn() {
<span class="nc" id="L385">     return bufcolumn[bufpos];</span>
  }

  public final int getEndLine() {
<span class="nc" id="L389">     return bufline[bufpos];</span>
  }

  public final int getBeginColumn() {
<span class="nc" id="L393">     return bufcolumn[tokenBegin];</span>
  }

  public final int getBeginLine() {
<span class="nc" id="L397">     return bufline[tokenBegin];</span>
  }

  public final void backup(int amount) {

<span class="nc" id="L402">    inBuf += amount;</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">    if ((bufpos -= amount) &lt; 0)</span>
<span class="nc" id="L404">       bufpos += bufsize;</span>
<span class="nc" id="L405">  }</span>

  public ASCII_UCodeESC_CharStream(java.io.InputStream dstream,
                 int startline, int startcolumn, int buffersize)
<span class="nc" id="L409">  {</span>
<span class="nc" id="L410">    inputStream = dstream;</span>
<span class="nc" id="L411">    line = startline;</span>
<span class="nc" id="L412">    column = startcolumn - 1;</span>

<span class="nc" id="L414">    available = bufsize = buffersize;</span>
<span class="nc" id="L415">    buffer = new char[buffersize];</span>
<span class="nc" id="L416">    bufline = new int[buffersize];</span>
<span class="nc" id="L417">    bufcolumn = new int[buffersize];</span>
<span class="nc" id="L418">    nextCharBuf = new byte[4096];</span>
<span class="nc" id="L419">  }</span>

  public ASCII_UCodeESC_CharStream(java.io.InputStream dstream,
                                        int startline, int startcolumn)
  {
<span class="nc" id="L424">     this(dstream, startline, startcolumn, 4096);</span>
<span class="nc" id="L425">  }</span>
  public void ReInit(java.io.InputStream dstream,
                 int startline, int startcolumn, int buffersize)
  {
<span class="nc" id="L429">    inputStream = dstream;</span>
<span class="nc" id="L430">    line = startline;</span>
<span class="nc" id="L431">    column = startcolumn - 1;</span>

<span class="nc bnc" id="L433" title="All 4 branches missed.">    if (buffer == null || buffersize != buffer.length)</span>
    {
<span class="nc" id="L435">      available = bufsize = buffersize;</span>
<span class="nc" id="L436">      buffer = new char[buffersize];</span>
<span class="nc" id="L437">      bufline = new int[buffersize];</span>
<span class="nc" id="L438">      bufcolumn = new int[buffersize];</span>
<span class="nc" id="L439">      nextCharBuf = new byte[4096];</span>
    }
<span class="nc" id="L441">    prevCharIsLF = prevCharIsCR = false;</span>
<span class="nc" id="L442">    tokenBegin = inBuf = maxNextCharInd = 0;</span>
<span class="nc" id="L443">    nextCharInd = bufpos = -1;</span>
<span class="nc" id="L444">  }</span>

  public void ReInit(java.io.InputStream dstream,
                                        int startline, int startcolumn)
  {
<span class="nc" id="L449">     ReInit(dstream, startline, startcolumn, 4096);</span>
<span class="nc" id="L450">  }</span>

  public final String GetImage()
  {
<span class="nc bnc" id="L454" title="All 2 branches missed.">     if (bufpos &gt;= tokenBegin)</span>
<span class="nc" id="L455">        return new String(buffer, tokenBegin, bufpos - tokenBegin + 1);</span>
     else
<span class="nc" id="L457">        return new String(buffer, tokenBegin, bufsize - tokenBegin) +</span>
                              new String(buffer, 0, bufpos + 1);
  }

  public final char[] GetSuffix(int len)
  {
<span class="nc" id="L463">     char[] ret = new char[len];</span>

<span class="nc bnc" id="L465" title="All 2 branches missed.">     if ((bufpos + 1) &gt;= len)</span>
<span class="nc" id="L466">        System.arraycopy(buffer, bufpos - len + 1, ret, 0, len);</span>
     else
     {
<span class="nc" id="L469">        System.arraycopy(buffer, bufsize - (len - bufpos - 1), ret, 0,</span>
                                                          len - bufpos - 1);
<span class="nc" id="L471">        System.arraycopy(buffer, 0, ret, len - bufpos - 1, bufpos + 1);</span>
     }

<span class="nc" id="L474">     return ret;</span>
  }

  public void Done()
  {
<span class="nc" id="L479">     nextCharBuf = null;</span>
<span class="nc" id="L480">     buffer = null;</span>
<span class="nc" id="L481">     bufline = null;</span>
<span class="nc" id="L482">     bufcolumn = null;</span>
<span class="nc" id="L483">  }</span>

  /**
   * Method to adjust line and column numbers for the start of a token.&lt;BR&gt;
   */
  public void adjustBeginLineColumn(int newLine, int newCol)
  {
<span class="nc" id="L490">     int start = tokenBegin;</span>
     int len;

<span class="nc bnc" id="L493" title="All 2 branches missed.">     if (bufpos &gt;= tokenBegin)</span>
     {
<span class="nc" id="L495">        len = bufpos - tokenBegin + inBuf + 1;</span>
     }
     else
     {
<span class="nc" id="L499">        len = bufsize - tokenBegin + bufpos + 1 + inBuf;</span>
     }

<span class="nc" id="L502">     int i = 0, j = 0, k = 0;</span>
<span class="nc" id="L503">     int nextColDiff = 0, columnDiff = 0;</span>

<span class="nc bnc" id="L505" title="All 4 branches missed.">     while (i &lt; len &amp;&amp;</span>
            bufline[j = start % bufsize] == bufline[k = ++start % bufsize])
     {
<span class="nc" id="L508">        bufline[j] = newLine;</span>
<span class="nc" id="L509">        nextColDiff = columnDiff + bufcolumn[k] - bufcolumn[j];</span>
<span class="nc" id="L510">        bufcolumn[j] = newCol + columnDiff;</span>
<span class="nc" id="L511">        columnDiff = nextColDiff;</span>
<span class="nc" id="L512">        i++;</span>
     }

<span class="nc bnc" id="L515" title="All 2 branches missed.">     if (i &lt; len)</span>
     {
<span class="nc" id="L517">        bufline[j] = newLine++;</span>
<span class="nc" id="L518">        bufcolumn[j] = newCol + columnDiff;</span>

<span class="nc bnc" id="L520" title="All 2 branches missed.">        while (i++ &lt; len)</span>
        {
<span class="nc bnc" id="L522" title="All 2 branches missed.">           if (bufline[j = start % bufsize] != bufline[++start % bufsize])</span>
<span class="nc" id="L523">              bufline[j] = newLine++;</span>
           else
<span class="nc" id="L525">              bufline[j] = newLine;</span>
        }
     }

<span class="nc" id="L529">     line = bufline[j];</span>
<span class="nc" id="L530">     column = bufcolumn[j];</span>
<span class="nc" id="L531">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>