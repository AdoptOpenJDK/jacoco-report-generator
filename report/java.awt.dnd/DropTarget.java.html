<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DropTarget.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">java.awt.dnd</a> &gt; <span class="el_source">DropTarget.java</span></div><h1>DropTarget.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package java.awt.dnd;

import java.util.TooManyListenersException;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.Serializable;

import java.awt.Component;
import java.awt.Dimension;
import java.awt.GraphicsEnvironment;
import java.awt.HeadlessException;
import java.awt.Insets;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.datatransfer.FlavorMap;
import java.awt.datatransfer.SystemFlavorMap;
import javax.swing.Timer;
import java.awt.peer.ComponentPeer;
import java.awt.peer.LightweightPeer;
import java.awt.dnd.peer.DropTargetPeer;


/**
 * The &lt;code&gt;DropTarget&lt;/code&gt; is associated
 * with a &lt;code&gt;Component&lt;/code&gt; when that &lt;code&gt;Component&lt;/code&gt;
 * wishes
 * to accept drops during Drag and Drop operations.
 * &lt;P&gt;
 *  Each
 * &lt;code&gt;DropTarget&lt;/code&gt; is associated with a &lt;code&gt;FlavorMap&lt;/code&gt;.
 * The default &lt;code&gt;FlavorMap&lt;/code&gt; hereafter designates the
 * &lt;code&gt;FlavorMap&lt;/code&gt; returned by &lt;code&gt;SystemFlavorMap.getDefaultFlavorMap()&lt;/code&gt;.
 *
 * @since 1.2
 */

public class DropTarget implements DropTargetListener, Serializable {

    private static final long serialVersionUID = -6283860791671019047L;

    /**
     * Creates a new DropTarget given the &lt;code&gt;Component&lt;/code&gt;
     * to associate itself with, an &lt;code&gt;int&lt;/code&gt; representing
     * the default acceptable action(s) to
     * support, a &lt;code&gt;DropTargetListener&lt;/code&gt;
     * to handle event processing, a &lt;code&gt;boolean&lt;/code&gt; indicating
     * if the &lt;code&gt;DropTarget&lt;/code&gt; is currently accepting drops, and
     * a &lt;code&gt;FlavorMap&lt;/code&gt; to use (or null for the default &lt;CODE&gt;FlavorMap&lt;/CODE&gt;).
     * &lt;P&gt;
     * The Component will receive drops only if it is enabled.
     * @param c         The &lt;code&gt;Component&lt;/code&gt; with which this &lt;code&gt;DropTarget&lt;/code&gt; is associated
     * @param ops       The default acceptable actions for this &lt;code&gt;DropTarget&lt;/code&gt;
     * @param dtl       The &lt;code&gt;DropTargetListener&lt;/code&gt; for this &lt;code&gt;DropTarget&lt;/code&gt;
     * @param act       Is the &lt;code&gt;DropTarget&lt;/code&gt; accepting drops.
     * @param fm        The &lt;code&gt;FlavorMap&lt;/code&gt; to use, or null for the default &lt;CODE&gt;FlavorMap&lt;/CODE&gt;
     * @exception HeadlessException if GraphicsEnvironment.isHeadless()
     *            returns true
     * @see java.awt.GraphicsEnvironment#isHeadless
     */
    public DropTarget(Component c, int ops, DropTargetListener dtl,
                      boolean act, FlavorMap fm)
        throws HeadlessException
<span class="nc" id="L93">    {</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (GraphicsEnvironment.isHeadless()) {</span>
<span class="nc" id="L95">            throw new HeadlessException();</span>
        }

<span class="nc" id="L98">        component = c;</span>

<span class="nc" id="L100">        setDefaultActions(ops);</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (dtl != null) try {</span>
<span class="nc" id="L103">            addDropTargetListener(dtl);</span>
<span class="nc" id="L104">        } catch (TooManyListenersException tmle) {</span>
            // do nothing!
<span class="nc" id="L106">        }</span>

<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (c != null) {</span>
<span class="nc" id="L109">            c.setDropTarget(this);</span>
<span class="nc" id="L110">            setActive(act);</span>
        }

<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (fm != null) {</span>
<span class="nc" id="L114">            flavorMap = fm;</span>
        } else {
<span class="nc" id="L116">            flavorMap = SystemFlavorMap.getDefaultFlavorMap();</span>
        }
<span class="nc" id="L118">    }</span>

    /**
     * Creates a &lt;code&gt;DropTarget&lt;/code&gt; given the &lt;code&gt;Component&lt;/code&gt;
     * to associate itself with, an &lt;code&gt;int&lt;/code&gt; representing
     * the default acceptable action(s)
     * to support, a &lt;code&gt;DropTargetListener&lt;/code&gt;
     * to handle event processing, and a &lt;code&gt;boolean&lt;/code&gt; indicating
     * if the &lt;code&gt;DropTarget&lt;/code&gt; is currently accepting drops.
     * &lt;P&gt;
     * The Component will receive drops only if it is enabled.
     * @param c         The &lt;code&gt;Component&lt;/code&gt; with which this &lt;code&gt;DropTarget&lt;/code&gt; is associated
     * @param ops       The default acceptable actions for this &lt;code&gt;DropTarget&lt;/code&gt;
     * @param dtl       The &lt;code&gt;DropTargetListener&lt;/code&gt; for this &lt;code&gt;DropTarget&lt;/code&gt;
     * @param act       Is the &lt;code&gt;DropTarget&lt;/code&gt; accepting drops.
     * @exception HeadlessException if GraphicsEnvironment.isHeadless()
     *            returns true
     * @see java.awt.GraphicsEnvironment#isHeadless
     */
    public DropTarget(Component c, int ops, DropTargetListener dtl,
                      boolean act)
        throws HeadlessException
    {
<span class="nc" id="L141">        this(c, ops, dtl, act, null);</span>
<span class="nc" id="L142">    }</span>

    /**
     * Creates a &lt;code&gt;DropTarget&lt;/code&gt;.
     * @exception HeadlessException if GraphicsEnvironment.isHeadless()
     *            returns true
     * @see java.awt.GraphicsEnvironment#isHeadless
     */
    public DropTarget() throws HeadlessException {
<span class="nc" id="L151">        this(null, DnDConstants.ACTION_COPY_OR_MOVE, null, true, null);</span>
<span class="nc" id="L152">    }</span>

    /**
     * Creates a &lt;code&gt;DropTarget&lt;/code&gt; given the &lt;code&gt;Component&lt;/code&gt;
     * to associate itself with, and the &lt;code&gt;DropTargetListener&lt;/code&gt;
     * to handle event processing.
     * &lt;P&gt;
     * The Component will receive drops only if it is enabled.
     * @param c         The &lt;code&gt;Component&lt;/code&gt; with which this &lt;code&gt;DropTarget&lt;/code&gt; is associated
     * @param dtl       The &lt;code&gt;DropTargetListener&lt;/code&gt; for this &lt;code&gt;DropTarget&lt;/code&gt;
     * @exception HeadlessException if GraphicsEnvironment.isHeadless()
     *            returns true
     * @see java.awt.GraphicsEnvironment#isHeadless
     */
    public DropTarget(Component c, DropTargetListener dtl)
        throws HeadlessException
    {
<span class="nc" id="L169">        this(c, DnDConstants.ACTION_COPY_OR_MOVE, dtl, true, null);</span>
<span class="nc" id="L170">    }</span>

    /**
     * Creates a &lt;code&gt;DropTarget&lt;/code&gt; given the &lt;code&gt;Component&lt;/code&gt;
     * to associate itself with, an &lt;code&gt;int&lt;/code&gt; representing
     * the default acceptable action(s) to support, and a
     * &lt;code&gt;DropTargetListener&lt;/code&gt; to handle event processing.
     * &lt;P&gt;
     * The Component will receive drops only if it is enabled.
     * @param c         The &lt;code&gt;Component&lt;/code&gt; with which this &lt;code&gt;DropTarget&lt;/code&gt; is associated
     * @param ops       The default acceptable actions for this &lt;code&gt;DropTarget&lt;/code&gt;
     * @param dtl       The &lt;code&gt;DropTargetListener&lt;/code&gt; for this &lt;code&gt;DropTarget&lt;/code&gt;
     * @exception HeadlessException if GraphicsEnvironment.isHeadless()
     *            returns true
     * @see java.awt.GraphicsEnvironment#isHeadless
     */
    public DropTarget(Component c, int ops, DropTargetListener dtl)
        throws HeadlessException
    {
<span class="nc" id="L189">        this(c, ops, dtl, true);</span>
<span class="nc" id="L190">    }</span>

    /**
     * Note: this interface is required to permit the safe association
     * of a DropTarget with a Component in one of two ways, either:
     * &lt;code&gt; component.setDropTarget(droptarget); &lt;/code&gt;
     * or &lt;code&gt; droptarget.setComponent(component); &lt;/code&gt;
     * &lt;P&gt;
     * The Component will receive drops only if it is enabled.
     * @param c The new &lt;code&gt;Component&lt;/code&gt; this &lt;code&gt;DropTarget&lt;/code&gt;
     * is to be associated with.&lt;P&gt;
     */

    public synchronized void setComponent(Component c) {
<span class="nc bnc" id="L204" title="All 6 branches missed.">        if (component == c || component != null &amp;&amp; component.equals(c))</span>
<span class="nc" id="L205">            return;</span>

        Component     old;
<span class="nc" id="L208">        ComponentPeer oldPeer = null;</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">        if ((old = component) != null) {</span>
<span class="nc" id="L211">            clearAutoscroll();</span>

<span class="nc" id="L213">            component = null;</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (componentPeer != null) {</span>
<span class="nc" id="L216">                oldPeer = componentPeer;</span>
<span class="nc" id="L217">                removeNotify(componentPeer);</span>
            }

<span class="nc" id="L220">            old.setDropTarget(null);</span>

        }

<span class="nc bnc" id="L224" title="All 2 branches missed.">        if ((component = c) != null) try {</span>
<span class="nc" id="L225">            c.setDropTarget(this);</span>
<span class="nc" id="L226">        } catch (Exception e) { // undo the change</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (old != null) {</span>
<span class="nc" id="L228">                old.setDropTarget(this);</span>
<span class="nc" id="L229">                addNotify(oldPeer);</span>
            }
<span class="nc" id="L231">        }</span>
<span class="nc" id="L232">    }</span>

    /**
     * Gets the &lt;code&gt;Component&lt;/code&gt; associated
     * with this &lt;code&gt;DropTarget&lt;/code&gt;.
     * &lt;P&gt;
     * @return the current &lt;code&gt;Component&lt;/code&gt;
     */

    public synchronized Component getComponent() {
<span class="nc" id="L242">        return component;</span>
    }

    /**
     * Sets the default acceptable actions for this &lt;code&gt;DropTarget&lt;/code&gt;
     * &lt;P&gt;
     * @param ops the default actions
     * &lt;P&gt;
     * @see java.awt.dnd.DnDConstants
     */

    public void setDefaultActions(int ops) {
<span class="nc" id="L254">        getDropTargetContext().setTargetActions(ops &amp; (DnDConstants.ACTION_COPY_OR_MOVE | DnDConstants.ACTION_REFERENCE));</span>
<span class="nc" id="L255">    }</span>

    /*
     * Called by DropTargetContext.setTargetActions()
     * with appropriate synchronization.
     */
    void doSetDefaultActions(int ops) {
<span class="nc" id="L262">        actions = ops;</span>
<span class="nc" id="L263">    }</span>

    /**
     * Gets an &lt;code&gt;int&lt;/code&gt; representing the
     * current action(s) supported by this &lt;code&gt;DropTarget&lt;/code&gt;.
     * &lt;P&gt;
     * @return the current default actions
     */

    public int getDefaultActions() {
<span class="nc" id="L273">        return actions;</span>
    }

    /**
     * Sets the DropTarget active if &lt;code&gt;true&lt;/code&gt;,
     * inactive if &lt;code&gt;false&lt;/code&gt;.
     * &lt;P&gt;
     * @param isActive sets the &lt;code&gt;DropTarget&lt;/code&gt; (in)active.
     */

    public synchronized void setActive(boolean isActive) {
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (isActive != active) {</span>
<span class="nc" id="L285">            active = isActive;</span>
        }

<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (!active) clearAutoscroll();</span>
<span class="nc" id="L289">    }</span>

    /**
     * Reports whether or not
     * this &lt;code&gt;DropTarget&lt;/code&gt;
     * is currently active (ready to accept drops).
     * &lt;P&gt;
     * @return &lt;CODE&gt;true&lt;/CODE&gt; if active, &lt;CODE&gt;false&lt;/CODE&gt; if not
     */

    public boolean isActive() {
<span class="nc" id="L300">        return active;</span>
    }

    /**
     * Adds a new &lt;code&gt;DropTargetListener&lt;/code&gt; (UNICAST SOURCE).
     * &lt;P&gt;
     * @param dtl The new &lt;code&gt;DropTargetListener&lt;/code&gt;
     * &lt;P&gt;
     * @throws TooManyListenersException if a
     * &lt;code&gt;DropTargetListener&lt;/code&gt; is already added to this
     * &lt;code&gt;DropTarget&lt;/code&gt;.
     */

    public synchronized void addDropTargetListener(DropTargetListener dtl) throws TooManyListenersException {
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (dtl == null) return;</span>

<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (equals(dtl)) throw new IllegalArgumentException(&quot;DropTarget may not be its own Listener&quot;);</span>

<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (dtListener == null)</span>
<span class="nc" id="L319">            dtListener = dtl;</span>
        else
<span class="nc" id="L321">            throw new TooManyListenersException();</span>
<span class="nc" id="L322">    }</span>

    /**
     * Removes the current &lt;code&gt;DropTargetListener&lt;/code&gt; (UNICAST SOURCE).
     * &lt;P&gt;
     * @param dtl the DropTargetListener to deregister.
     */

    public synchronized void removeDropTargetListener(DropTargetListener dtl) {
<span class="nc bnc" id="L331" title="All 4 branches missed.">        if (dtl != null &amp;&amp; dtListener != null) {</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">            if(dtListener.equals(dtl))</span>
<span class="nc" id="L333">                dtListener = null;</span>
            else
<span class="nc" id="L335">                throw new IllegalArgumentException(&quot;listener mismatch&quot;);</span>
        }
<span class="nc" id="L337">    }</span>

    /**
     * Calls &lt;code&gt;dragEnter&lt;/code&gt; on the registered
     * &lt;code&gt;DropTargetListener&lt;/code&gt; and passes it
     * the specified &lt;code&gt;DropTargetDragEvent&lt;/code&gt;.
     * Has no effect if this &lt;code&gt;DropTarget&lt;/code&gt;
     * is not active.
     *
     * @param dtde the &lt;code&gt;DropTargetDragEvent&lt;/code&gt;
     *
     * @throws NullPointerException if this &lt;code&gt;DropTarget&lt;/code&gt;
     *         is active and &lt;code&gt;dtde&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;
     *
     * @see #isActive
     */
    public synchronized void dragEnter(DropTargetDragEvent dtde) {
<span class="nc" id="L354">        isDraggingInside = true;</span>

<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (!active) return;</span>

<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (dtListener != null) {</span>
<span class="nc" id="L359">            dtListener.dragEnter(dtde);</span>
        } else
<span class="nc" id="L361">            dtde.getDropTargetContext().setTargetActions(DnDConstants.ACTION_NONE);</span>

<span class="nc" id="L363">        initializeAutoscrolling(dtde.getLocation());</span>
<span class="nc" id="L364">    }</span>

    /**
     * Calls &lt;code&gt;dragOver&lt;/code&gt; on the registered
     * &lt;code&gt;DropTargetListener&lt;/code&gt; and passes it
     * the specified &lt;code&gt;DropTargetDragEvent&lt;/code&gt;.
     * Has no effect if this &lt;code&gt;DropTarget&lt;/code&gt;
     * is not active.
     *
     * @param dtde the &lt;code&gt;DropTargetDragEvent&lt;/code&gt;
     *
     * @throws NullPointerException if this &lt;code&gt;DropTarget&lt;/code&gt;
     *         is active and &lt;code&gt;dtde&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;
     *
     * @see #isActive
     */
    public synchronized void dragOver(DropTargetDragEvent dtde) {
<span class="nc bnc" id="L381" title="All 2 branches missed.">        if (!active) return;</span>

<span class="nc bnc" id="L383" title="All 4 branches missed.">        if (dtListener != null &amp;&amp; active) dtListener.dragOver(dtde);</span>

<span class="nc" id="L385">        updateAutoscroll(dtde.getLocation());</span>
<span class="nc" id="L386">    }</span>

    /**
     * Calls &lt;code&gt;dropActionChanged&lt;/code&gt; on the registered
     * &lt;code&gt;DropTargetListener&lt;/code&gt; and passes it
     * the specified &lt;code&gt;DropTargetDragEvent&lt;/code&gt;.
     * Has no effect if this &lt;code&gt;DropTarget&lt;/code&gt;
     * is not active.
     *
     * @param dtde the &lt;code&gt;DropTargetDragEvent&lt;/code&gt;
     *
     * @throws NullPointerException if this &lt;code&gt;DropTarget&lt;/code&gt;
     *         is active and &lt;code&gt;dtde&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;
     *
     * @see #isActive
     */
    public synchronized void dropActionChanged(DropTargetDragEvent dtde) {
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (!active) return;</span>

<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (dtListener != null) dtListener.dropActionChanged(dtde);</span>

<span class="nc" id="L407">        updateAutoscroll(dtde.getLocation());</span>
<span class="nc" id="L408">    }</span>

    /**
     * Calls &lt;code&gt;dragExit&lt;/code&gt; on the registered
     * &lt;code&gt;DropTargetListener&lt;/code&gt; and passes it
     * the specified &lt;code&gt;DropTargetEvent&lt;/code&gt;.
     * Has no effect if this &lt;code&gt;DropTarget&lt;/code&gt;
     * is not active.
     * &lt;p&gt;
     * This method itself does not throw any exception
     * for null parameter but for exceptions thrown by
     * the respective method of the listener.
     *
     * @param dte the &lt;code&gt;DropTargetEvent&lt;/code&gt;
     *
     * @see #isActive
     */
    public synchronized void dragExit(DropTargetEvent dte) {
<span class="nc" id="L426">        isDraggingInside = false;</span>

<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (!active) return;</span>

<span class="nc bnc" id="L430" title="All 4 branches missed.">        if (dtListener != null &amp;&amp; active) dtListener.dragExit(dte);</span>

<span class="nc" id="L432">        clearAutoscroll();</span>
<span class="nc" id="L433">    }</span>

    /**
     * Calls &lt;code&gt;drop&lt;/code&gt; on the registered
     * &lt;code&gt;DropTargetListener&lt;/code&gt; and passes it
     * the specified &lt;code&gt;DropTargetDropEvent&lt;/code&gt;
     * if this &lt;code&gt;DropTarget&lt;/code&gt; is active.
     *
     * @param dtde the &lt;code&gt;DropTargetDropEvent&lt;/code&gt;
     *
     * @throws NullPointerException if &lt;code&gt;dtde&lt;/code&gt; is null
     *         and at least one of the following is true: this
     *         &lt;code&gt;DropTarget&lt;/code&gt; is not active, or there is
     *         no a &lt;code&gt;DropTargetListener&lt;/code&gt; registered.
     *
     * @see #isActive
     */
    public synchronized void drop(DropTargetDropEvent dtde) {
<span class="nc" id="L451">        isDraggingInside = false;</span>

<span class="nc" id="L453">        clearAutoscroll();</span>

<span class="nc bnc" id="L455" title="All 4 branches missed.">        if (dtListener != null &amp;&amp; active)</span>
<span class="nc" id="L456">            dtListener.drop(dtde);</span>
        else { // we should'nt get here ...
<span class="nc" id="L458">            dtde.rejectDrop();</span>
        }
<span class="nc" id="L460">    }</span>

    /**
     * Gets the &lt;code&gt;FlavorMap&lt;/code&gt;
     * associated with this &lt;code&gt;DropTarget&lt;/code&gt;.
     * If no &lt;code&gt;FlavorMap&lt;/code&gt; has been set for this
     * &lt;code&gt;DropTarget&lt;/code&gt;, it is associated with the default
     * &lt;code&gt;FlavorMap&lt;/code&gt;.
     * &lt;P&gt;
     * @return the FlavorMap for this DropTarget
     */

<span class="nc" id="L472">    public FlavorMap getFlavorMap() { return flavorMap; }</span>

    /**
     * Sets the &lt;code&gt;FlavorMap&lt;/code&gt; associated
     * with this &lt;code&gt;DropTarget&lt;/code&gt;.
     * &lt;P&gt;
     * @param fm the new &lt;code&gt;FlavorMap&lt;/code&gt;, or null to
     * associate the default FlavorMap with this DropTarget.
     */

    public void setFlavorMap(FlavorMap fm) {
<span class="nc bnc" id="L483" title="All 2 branches missed.">        flavorMap = fm == null ? SystemFlavorMap.getDefaultFlavorMap() : fm;</span>
<span class="nc" id="L484">    }</span>

    /**
     * Notify the DropTarget that it has been associated with a Component
     *
     **********************************************************************
     * This method is usually called from java.awt.Component.addNotify() of
     * the Component associated with this DropTarget to notify the DropTarget
     * that a ComponentPeer has been associated with that Component.
     *
     * Calling this method, other than to notify this DropTarget of the
     * association of the ComponentPeer with the Component may result in
     * a malfunction of the DnD system.
     **********************************************************************
     * &lt;P&gt;
     * @param peer The Peer of the Component we are associated with!
     *
     */

    public void addNotify(ComponentPeer peer) {
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (peer == componentPeer) return;</span>

<span class="nc" id="L506">        componentPeer = peer;</span>

<span class="nc" id="L508">        for (Component c = component;</span>
<span class="nc bnc" id="L509" title="All 4 branches missed.">             c != null &amp;&amp; peer instanceof LightweightPeer; c = c.getParent()) {</span>
<span class="nc" id="L510">            peer = c.getPeer();</span>
        }

<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (peer instanceof DropTargetPeer) {</span>
<span class="nc" id="L514">            nativePeer = peer;</span>
<span class="nc" id="L515">            ((DropTargetPeer)peer).addDropTarget(this);</span>
        } else {
<span class="nc" id="L517">            nativePeer = null;</span>
        }
<span class="nc" id="L519">    }</span>

    /**
     * Notify the DropTarget that it has been disassociated from a Component
     *
     **********************************************************************
     * This method is usually called from java.awt.Component.removeNotify() of
     * the Component associated with this DropTarget to notify the DropTarget
     * that a ComponentPeer has been disassociated with that Component.
     *
     * Calling this method, other than to notify this DropTarget of the
     * disassociation of the ComponentPeer from the Component may result in
     * a malfunction of the DnD system.
     **********************************************************************
     * &lt;P&gt;
     * @param peer The Peer of the Component we are being disassociated from!
     */

    public void removeNotify(ComponentPeer peer) {
<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (nativePeer != null)</span>
<span class="nc" id="L539">            ((DropTargetPeer)nativePeer).removeDropTarget(this);</span>

<span class="nc" id="L541">        componentPeer = nativePeer = null;</span>

<span class="nc" id="L543">        synchronized (this) {</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">            if (isDraggingInside) {</span>
<span class="nc" id="L545">                dragExit(new DropTargetEvent(getDropTargetContext()));</span>
            }
<span class="nc" id="L547">        }</span>
<span class="nc" id="L548">    }</span>

    /**
     * Gets the &lt;code&gt;DropTargetContext&lt;/code&gt; associated
     * with this &lt;code&gt;DropTarget&lt;/code&gt;.
     * &lt;P&gt;
     * @return the &lt;code&gt;DropTargetContext&lt;/code&gt; associated with this &lt;code&gt;DropTarget&lt;/code&gt;.
     */

    public DropTargetContext getDropTargetContext() {
<span class="nc" id="L558">        return dropTargetContext;</span>
    }

    /**
     * Creates the DropTargetContext associated with this DropTarget.
     * Subclasses may override this method to instantiate their own
     * DropTargetContext subclass.
     *
     * This call is typically *only* called by the platform's
     * DropTargetContextPeer as a drag operation encounters this
     * DropTarget. Accessing the Context while no Drag is current
     * has undefined results.
     */

    protected DropTargetContext createDropTargetContext() {
<span class="nc" id="L573">        return new DropTargetContext(this);</span>
    }

    /**
     * Serializes this &lt;code&gt;DropTarget&lt;/code&gt;. Performs default serialization,
     * and then writes out this object's &lt;code&gt;DropTargetListener&lt;/code&gt; if and
     * only if it can be serialized. If not, &lt;code&gt;null&lt;/code&gt; is written
     * instead.
     *
     * @serialData The default serializable fields, in alphabetical order,
     *             followed by either a &lt;code&gt;DropTargetListener&lt;/code&gt;
     *             instance, or &lt;code&gt;null&lt;/code&gt;.
     * @since 1.4
     */
    private void writeObject(ObjectOutputStream s) throws IOException {
<span class="nc" id="L588">        s.defaultWriteObject();</span>

<span class="nc bnc" id="L590" title="All 2 branches missed.">        s.writeObject(SerializationTester.test(dtListener)</span>
                      ? dtListener : null);
<span class="nc" id="L592">    }</span>

    /**
     * Deserializes this &lt;code&gt;DropTarget&lt;/code&gt;. This method first performs
     * default deserialization for all non-&lt;code&gt;transient&lt;/code&gt; fields. An
     * attempt is then made to deserialize this object's
     * &lt;code&gt;DropTargetListener&lt;/code&gt; as well. This is first attempted by
     * deserializing the field &lt;code&gt;dtListener&lt;/code&gt;, because, in releases
     * prior to 1.4, a non-&lt;code&gt;transient&lt;/code&gt; field of this name stored the
     * &lt;code&gt;DropTargetListener&lt;/code&gt;. If this fails, the next object in the
     * stream is used instead.
     *
     * @since 1.4
     */
    private void readObject(ObjectInputStream s)
        throws ClassNotFoundException, IOException
    {
<span class="nc" id="L609">        ObjectInputStream.GetField f = s.readFields();</span>

        try {
<span class="nc" id="L612">            dropTargetContext =</span>
<span class="nc" id="L613">                (DropTargetContext)f.get(&quot;dropTargetContext&quot;, null);</span>
<span class="nc" id="L614">        } catch (IllegalArgumentException e) {</span>
            // Pre-1.4 support. 'dropTargetContext' was previously transient
<span class="nc" id="L616">        }</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">        if (dropTargetContext == null) {</span>
<span class="nc" id="L618">            dropTargetContext = createDropTargetContext();</span>
        }

<span class="nc" id="L621">        component = (Component)f.get(&quot;component&quot;, null);</span>
<span class="nc" id="L622">        actions = f.get(&quot;actions&quot;, DnDConstants.ACTION_COPY_OR_MOVE);</span>
<span class="nc" id="L623">        active = f.get(&quot;active&quot;, true);</span>

        // Pre-1.4 support. 'dtListener' was previously non-transient
        try {
<span class="nc" id="L627">            dtListener = (DropTargetListener)f.get(&quot;dtListener&quot;, null);</span>
<span class="nc" id="L628">        } catch (IllegalArgumentException e) {</span>
            // 1.4-compatible byte stream. 'dtListener' was written explicitly
<span class="nc" id="L630">            dtListener = (DropTargetListener)s.readObject();</span>
<span class="nc" id="L631">        }</span>
<span class="nc" id="L632">    }</span>

    /*********************************************************************/

    /**
     * this protected nested class implements autoscrolling
     */

    protected static class DropTargetAutoScroller implements ActionListener {

        /**
         * construct a DropTargetAutoScroller
         * &lt;P&gt;
         * @param c the &lt;code&gt;Component&lt;/code&gt;
         * @param p the &lt;code&gt;Point&lt;/code&gt;
         */

        protected DropTargetAutoScroller(Component c, Point p) {
<span class="nc" id="L650">            super();</span>

<span class="nc" id="L652">            component  = c;</span>
<span class="nc" id="L653">            autoScroll = (Autoscroll)component;</span>

<span class="nc" id="L655">            Toolkit t  = Toolkit.getDefaultToolkit();</span>

<span class="nc" id="L657">            Integer    initial  = Integer.valueOf(100);</span>
<span class="nc" id="L658">            Integer    interval = Integer.valueOf(100);</span>

            try {
<span class="nc" id="L661">                initial = (Integer)t.getDesktopProperty(&quot;DnD.Autoscroll.initialDelay&quot;);</span>
<span class="nc" id="L662">            } catch (Exception e) {</span>
                // ignore
<span class="nc" id="L664">            }</span>

            try {
<span class="nc" id="L667">                interval = (Integer)t.getDesktopProperty(&quot;DnD.Autoscroll.interval&quot;);</span>
<span class="nc" id="L668">            } catch (Exception e) {</span>
                // ignore
<span class="nc" id="L670">            }</span>

<span class="nc" id="L672">            timer  = new Timer(interval.intValue(), this);</span>

<span class="nc" id="L674">            timer.setCoalesce(true);</span>
<span class="nc" id="L675">            timer.setInitialDelay(initial.intValue());</span>

<span class="nc" id="L677">            locn = p;</span>
<span class="nc" id="L678">            prev = p;</span>

            try {
<span class="nc" id="L681">                hysteresis = ((Integer)t.getDesktopProperty(&quot;DnD.Autoscroll.cursorHysteresis&quot;)).intValue();</span>
<span class="nc" id="L682">            } catch (Exception e) {</span>
                // ignore
<span class="nc" id="L684">            }</span>

<span class="nc" id="L686">            timer.start();</span>
<span class="nc" id="L687">        }</span>

        /**
         * update the geometry of the autoscroll region
         */

        private void updateRegion() {
<span class="nc" id="L694">           Insets    i    = autoScroll.getAutoscrollInsets();</span>
<span class="nc" id="L695">           Dimension size = component.getSize();</span>

<span class="nc bnc" id="L697" title="All 4 branches missed.">           if (size.width != outer.width || size.height != outer.height)</span>
<span class="nc" id="L698">                outer.reshape(0, 0, size.width, size.height);</span>

<span class="nc bnc" id="L700" title="All 4 branches missed.">           if (inner.x != i.left || inner.y != i.top)</span>
<span class="nc" id="L701">                inner.setLocation(i.left, i.top);</span>

<span class="nc" id="L703">           int newWidth  = size.width -  (i.left + i.right);</span>
<span class="nc" id="L704">           int newHeight = size.height - (i.top  + i.bottom);</span>

<span class="nc bnc" id="L706" title="All 4 branches missed.">           if (newWidth != inner.width || newHeight != inner.height)</span>
<span class="nc" id="L707">                inner.setSize(newWidth, newHeight);</span>

<span class="nc" id="L709">        }</span>

        /**
         * cause autoscroll to occur
         * &lt;P&gt;
         * @param newLocn the &lt;code&gt;Point&lt;/code&gt;
         */

        protected synchronized void updateLocation(Point newLocn) {
<span class="nc" id="L718">            prev = locn;</span>
<span class="nc" id="L719">            locn = newLocn;</span>

<span class="nc bnc" id="L721" title="All 2 branches missed.">            if (Math.abs(locn.x - prev.x) &gt; hysteresis ||</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">                Math.abs(locn.y - prev.y) &gt; hysteresis) {</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">                if (timer.isRunning()) timer.stop();</span>
            } else {
<span class="nc bnc" id="L725" title="All 2 branches missed.">                if (!timer.isRunning()) timer.start();</span>
            }
<span class="nc" id="L727">        }</span>

        /**
         * cause autoscrolling to stop
         */

<span class="nc" id="L733">        protected void stop() { timer.stop(); }</span>

        /**
         * cause autoscroll to occur
         * &lt;P&gt;
         * @param e the &lt;code&gt;ActionEvent&lt;/code&gt;
         */

        public synchronized void actionPerformed(ActionEvent e) {
<span class="nc" id="L742">            updateRegion();</span>

<span class="nc bnc" id="L744" title="All 4 branches missed.">            if (outer.contains(locn) &amp;&amp; !inner.contains(locn))</span>
<span class="nc" id="L745">                autoScroll.autoscroll(locn);</span>
<span class="nc" id="L746">        }</span>

        /*
         * fields
         */

        private Component  component;
        private Autoscroll autoScroll;

        private Timer      timer;

        private Point      locn;
        private Point      prev;

<span class="nc" id="L760">        private Rectangle  outer = new Rectangle();</span>
<span class="nc" id="L761">        private Rectangle  inner = new Rectangle();</span>

<span class="nc" id="L763">        private int        hysteresis = 10;</span>
    }

    /*********************************************************************/

    /**
     * create an embedded autoscroller
     * &lt;P&gt;
     * @param c the &lt;code&gt;Component&lt;/code&gt;
     * @param p the &lt;code&gt;Point&lt;/code&gt;
     */

    protected DropTargetAutoScroller createDropTargetAutoScroller(Component c, Point p) {
<span class="nc" id="L776">        return new DropTargetAutoScroller(c, p);</span>
    }

    /**
     * initialize autoscrolling
     * &lt;P&gt;
     * @param p the &lt;code&gt;Point&lt;/code&gt;
     */

    protected void initializeAutoscrolling(Point p) {
<span class="nc bnc" id="L786" title="All 4 branches missed.">        if (component == null || !(component instanceof Autoscroll)) return;</span>

<span class="nc" id="L788">        autoScroller = createDropTargetAutoScroller(component, p);</span>
<span class="nc" id="L789">    }</span>

    /**
     * update autoscrolling with current cursor location
     * &lt;P&gt;
     * @param dragCursorLocn the &lt;code&gt;Point&lt;/code&gt;
     */

    protected void updateAutoscroll(Point dragCursorLocn) {
<span class="nc bnc" id="L798" title="All 2 branches missed.">        if (autoScroller != null) autoScroller.updateLocation(dragCursorLocn);</span>
<span class="nc" id="L799">    }</span>

    /**
     * clear autoscrolling
     */

    protected void clearAutoscroll() {
<span class="nc bnc" id="L806" title="All 2 branches missed.">        if (autoScroller != null) {</span>
<span class="nc" id="L807">            autoScroller.stop();</span>
<span class="nc" id="L808">            autoScroller = null;</span>
        }
<span class="nc" id="L810">    }</span>

    /**
     * The DropTargetContext associated with this DropTarget.
     *
     * @serial
     */
<span class="nc" id="L817">    private DropTargetContext dropTargetContext = createDropTargetContext();</span>

    /**
     * The Component associated with this DropTarget.
     *
     * @serial
     */
    private Component component;

    /*
     * That Component's  Peer
     */
    private transient ComponentPeer componentPeer;

    /*
     * That Component's &quot;native&quot; Peer
     */
    private transient ComponentPeer nativePeer;


    /**
     * Default permissible actions supported by this DropTarget.
     *
     * @see #setDefaultActions
     * @see #getDefaultActions
     * @serial
     */
<span class="nc" id="L844">    int     actions = DnDConstants.ACTION_COPY_OR_MOVE;</span>

    /**
     * &lt;code&gt;true&lt;/code&gt; if the DropTarget is accepting Drag &amp;amp; Drop operations.
     *
     * @serial
     */
<span class="nc" id="L851">    boolean active = true;</span>

    /*
     * the auto scrolling object
     */

    private transient DropTargetAutoScroller autoScroller;

    /*
     * The delegate
     */

    private transient DropTargetListener dtListener;

    /*
     * The FlavorMap
     */

    private transient FlavorMap flavorMap;

    /*
     * If the dragging is currently inside this drop target
     */
    private transient boolean isDraggingInside;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>