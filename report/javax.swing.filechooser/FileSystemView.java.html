<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FileSystemView.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.filechooser</a> &gt; <span class="el_source">FileSystemView.java</span></div><h1>FileSystemView.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1998, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing.filechooser;


import javax.swing.*;

import java.awt.Image;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.text.MessageFormat;
import java.util.List;
import java.util.ArrayList;
import java.lang.ref.WeakReference;
import java.beans.PropertyChangeListener;
import java.beans.PropertyChangeEvent;
import java.security.AccessController;
import java.security.PrivilegedAction;

import sun.awt.shell.*;

/**
 * FileSystemView is JFileChooser's gateway to the
 * file system. Since the JDK1.1 File API doesn't allow
 * access to such information as root partitions, file type
 * information, or hidden file bits, this class is designed
 * to intuit as much OS-specific file system information as
 * possible.
 *
 * &lt;p&gt;
 *
 * Java Licensees may want to provide a different implementation of
 * FileSystemView to better handle a given operating system.
 *
 * @author Jeff Dinkins
 */

// PENDING(jeff) - need to provide a specification for
// how Mac/OS2/BeOS/etc file systems can modify FileSystemView
// to handle their particular type of file system.

public abstract class FileSystemView {

<span class="nc" id="L68">    static FileSystemView windowsFileSystemView = null;</span>
<span class="nc" id="L69">    static FileSystemView unixFileSystemView = null;</span>
    //static FileSystemView macFileSystemView = null;
<span class="nc" id="L71">    static FileSystemView genericFileSystemView = null;</span>

<span class="nc" id="L73">    private boolean useSystemExtensionHiding =</span>
<span class="nc" id="L74">            UIManager.getDefaults().getBoolean(&quot;FileChooser.useSystemExtensionHiding&quot;);</span>

    public static FileSystemView getFileSystemView() {
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if(File.separatorChar == '\\') {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if(windowsFileSystemView == null) {</span>
<span class="nc" id="L79">                windowsFileSystemView = new WindowsFileSystemView();</span>
            }
<span class="nc" id="L81">            return windowsFileSystemView;</span>
        }

<span class="nc bnc" id="L84" title="All 2 branches missed.">        if(File.separatorChar == '/') {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if(unixFileSystemView == null) {</span>
<span class="nc" id="L86">                unixFileSystemView = new UnixFileSystemView();</span>
            }
<span class="nc" id="L88">            return unixFileSystemView;</span>
        }

        // if(File.separatorChar == ':') {
        //    if(macFileSystemView == null) {
        //      macFileSystemView = new MacFileSystemView();
        //    }
        //    return macFileSystemView;
        //}

<span class="nc bnc" id="L98" title="All 2 branches missed.">        if(genericFileSystemView == null) {</span>
<span class="nc" id="L99">            genericFileSystemView = new GenericFileSystemView();</span>
        }
<span class="nc" id="L101">        return genericFileSystemView;</span>
    }

<span class="nc" id="L104">    public FileSystemView() {</span>
<span class="nc" id="L105">        final WeakReference&lt;FileSystemView&gt; weakReference = new WeakReference&lt;FileSystemView&gt;(this);</span>

<span class="nc" id="L107">        UIManager.addPropertyChangeListener(new PropertyChangeListener() {</span>
            public void propertyChange(PropertyChangeEvent evt) {
<span class="nc" id="L109">                FileSystemView fileSystemView = weakReference.get();</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">                if (fileSystemView == null) {</span>
                    // FileSystemView was destroyed
<span class="nc" id="L113">                    UIManager.removePropertyChangeListener(this);</span>
                } else {
<span class="nc bnc" id="L115" title="All 2 branches missed.">                    if (evt.getPropertyName().equals(&quot;lookAndFeel&quot;)) {</span>
<span class="nc" id="L116">                        fileSystemView.useSystemExtensionHiding =</span>
<span class="nc" id="L117">                                UIManager.getDefaults().getBoolean(&quot;FileChooser.useSystemExtensionHiding&quot;);</span>
                    }
                }
<span class="nc" id="L120">            }</span>
        });
<span class="nc" id="L122">    }</span>

    /**
     * Determines if the given file is a root in the navigable tree(s).
     * Examples: Windows 98 has one root, the Desktop folder. DOS has one root
     * per drive letter, &lt;code&gt;C:\&lt;/code&gt;, &lt;code&gt;D:\&lt;/code&gt;, etc. Unix has one root,
     * the &lt;code&gt;&quot;/&quot;&lt;/code&gt; directory.
     *
     * The default implementation gets information from the &lt;code&gt;ShellFolder&lt;/code&gt; class.
     *
     * @param f a &lt;code&gt;File&lt;/code&gt; object representing a directory
     * @return &lt;code&gt;true&lt;/code&gt; if &lt;code&gt;f&lt;/code&gt; is a root in the navigable tree.
     * @see #isFileSystemRoot
     */
    public boolean isRoot(File f) {
<span class="nc bnc" id="L137" title="All 4 branches missed.">        if (f == null || !f.isAbsolute()) {</span>
<span class="nc" id="L138">            return false;</span>
        }

<span class="nc" id="L141">        File[] roots = getRoots();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        for (File root : roots) {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (root.equals(f)) {</span>
<span class="nc" id="L144">                return true;</span>
            }
        }
<span class="nc" id="L147">        return false;</span>
    }

    /**
     * Returns true if the file (directory) can be visited.
     * Returns false if the directory cannot be traversed.
     *
     * @param f the &lt;code&gt;File&lt;/code&gt;
     * @return &lt;code&gt;true&lt;/code&gt; if the file/directory can be traversed, otherwise &lt;code&gt;false&lt;/code&gt;
     * @see JFileChooser#isTraversable
     * @see FileView#isTraversable
     * @since 1.4
     */
    public Boolean isTraversable(File f) {
<span class="nc" id="L161">        return Boolean.valueOf(f.isDirectory());</span>
    }

    /**
     * Name of a file, directory, or folder as it would be displayed in
     * a system file browser. Example from Windows: the &quot;M:\&quot; directory
     * displays as &quot;CD-ROM (M:)&quot;
     *
     * The default implementation gets information from the ShellFolder class.
     *
     * @param f a &lt;code&gt;File&lt;/code&gt; object
     * @return the file name as it would be displayed by a native file chooser
     * @see JFileChooser#getName
     * @since 1.4
     */
    public String getSystemDisplayName(File f) {
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (f == null) {</span>
<span class="nc" id="L178">            return null;</span>
        }

<span class="nc" id="L181">        String name = f.getName();</span>

<span class="nc bnc" id="L183" title="All 6 branches missed.">        if (!name.equals(&quot;..&quot;) &amp;&amp; !name.equals(&quot;.&quot;) &amp;&amp;</span>
<span class="nc bnc" id="L184" title="All 6 branches missed.">                (useSystemExtensionHiding || !isFileSystem(f) || isFileSystemRoot(f)) &amp;&amp;</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                (f instanceof ShellFolder || f.exists())) {</span>

            try {
<span class="nc" id="L188">                name = getShellFolder(f).getDisplayName();</span>
<span class="nc" id="L189">            } catch (FileNotFoundException e) {</span>
<span class="nc" id="L190">                return null;</span>
<span class="nc" id="L191">            }</span>

<span class="nc bnc" id="L193" title="All 4 branches missed.">            if (name == null || name.length() == 0) {</span>
<span class="nc" id="L194">                name = f.getPath(); // e.g. &quot;/&quot;</span>
            }
        }

<span class="nc" id="L198">        return name;</span>
    }

    /**
     * Type description for a file, directory, or folder as it would be displayed in
     * a system file browser. Example from Windows: the &quot;Desktop&quot; folder
     * is described as &quot;Desktop&quot;.
     *
     * Override for platforms with native ShellFolder implementations.
     *
     * @param f a &lt;code&gt;File&lt;/code&gt; object
     * @return the file type description as it would be displayed by a native file chooser
     * or null if no native information is available.
     * @see JFileChooser#getTypeDescription
     * @since 1.4
     */
    public String getSystemTypeDescription(File f) {
<span class="nc" id="L215">        return null;</span>
    }

    /**
     * Icon for a file, directory, or folder as it would be displayed in
     * a system file browser. Example from Windows: the &quot;M:\&quot; directory
     * displays a CD-ROM icon.
     *
     * The default implementation gets information from the ShellFolder class.
     *
     * @param f a &lt;code&gt;File&lt;/code&gt; object
     * @return an icon as it would be displayed by a native file chooser
     * @see JFileChooser#getIcon
     * @since 1.4
     */
    public Icon getSystemIcon(File f) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (f == null) {</span>
<span class="nc" id="L232">            return null;</span>
        }

        ShellFolder sf;

        try {
<span class="nc" id="L238">            sf = getShellFolder(f);</span>
<span class="nc" id="L239">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L240">            return null;</span>
<span class="nc" id="L241">        }</span>

<span class="nc" id="L243">        Image img = sf.getIcon(false);</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (img != null) {</span>
<span class="nc" id="L246">            return new ImageIcon(img, sf.getFolderType());</span>
        } else {
<span class="nc bnc" id="L248" title="All 2 branches missed.">            return UIManager.getIcon(f.isDirectory() ? &quot;FileView.directoryIcon&quot; : &quot;FileView.fileIcon&quot;);</span>
        }
    }

    /**
     * On Windows, a file can appear in multiple folders, other than its
     * parent directory in the filesystem. Folder could for example be the
     * &quot;Desktop&quot; folder which is not the same as file.getParentFile().
     *
     * @param folder a &lt;code&gt;File&lt;/code&gt; object representing a directory or special folder
     * @param file a &lt;code&gt;File&lt;/code&gt; object
     * @return &lt;code&gt;true&lt;/code&gt; if &lt;code&gt;folder&lt;/code&gt; is a directory or special folder and contains &lt;code&gt;file&lt;/code&gt;.
     * @since 1.4
     */
    public boolean isParent(File folder, File file) {
<span class="nc bnc" id="L263" title="All 4 branches missed.">        if (folder == null || file == null) {</span>
<span class="nc" id="L264">            return false;</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        } else if (folder instanceof ShellFolder) {</span>
<span class="nc" id="L266">                File parent = file.getParentFile();</span>
<span class="nc bnc" id="L267" title="All 4 branches missed.">                if (parent != null &amp;&amp; parent.equals(folder)) {</span>
<span class="nc" id="L268">                    return true;</span>
                }
<span class="nc" id="L270">            File[] children = getFiles(folder, false);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">            for (File child : children) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                if (file.equals(child)) {</span>
<span class="nc" id="L273">                    return true;</span>
                }
            }
<span class="nc" id="L276">            return false;</span>
        } else {
<span class="nc" id="L278">            return folder.equals(file.getParentFile());</span>
        }
    }

    /**
     *
     * @param parent a &lt;code&gt;File&lt;/code&gt; object representing a directory or special folder
     * @param fileName a name of a file or folder which exists in &lt;code&gt;parent&lt;/code&gt;
     * @return a File object. This is normally constructed with &lt;code&gt;new
     * File(parent, fileName)&lt;/code&gt; except when parent and child are both
     * special folders, in which case the &lt;code&gt;File&lt;/code&gt; is a wrapper containing
     * a &lt;code&gt;ShellFolder&lt;/code&gt; object.
     * @since 1.4
     */
    public File getChild(File parent, String fileName) {
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (parent instanceof ShellFolder) {</span>
<span class="nc" id="L294">            File[] children = getFiles(parent, false);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            for (File child : children) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                if (child.getName().equals(fileName)) {</span>
<span class="nc" id="L297">                    return child;</span>
                }
            }
        }
<span class="nc" id="L301">        return createFileObject(parent, fileName);</span>
    }


    /**
     * Checks if &lt;code&gt;f&lt;/code&gt; represents a real directory or file as opposed to a
     * special folder such as &lt;code&gt;&quot;Desktop&quot;&lt;/code&gt;. Used by UI classes to decide if
     * a folder is selectable when doing directory choosing.
     *
     * @param f a &lt;code&gt;File&lt;/code&gt; object
     * @return &lt;code&gt;true&lt;/code&gt; if &lt;code&gt;f&lt;/code&gt; is a real file or directory.
     * @since 1.4
     */
    public boolean isFileSystem(File f) {
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (f instanceof ShellFolder) {</span>
<span class="nc" id="L316">            ShellFolder sf = (ShellFolder)f;</span>
            // Shortcuts to directories are treated as not being file system objects,
            // so that they are never returned by JFileChooser.
<span class="nc bnc" id="L319" title="All 6 branches missed.">            return sf.isFileSystem() &amp;&amp; !(sf.isLink() &amp;&amp; sf.isDirectory());</span>
        } else {
<span class="nc" id="L321">            return true;</span>
        }
    }

    /**
     * Creates a new folder with a default folder name.
     */
    public abstract File createNewFolder(File containingDir) throws IOException;

    /**
     * Returns whether a file is hidden or not.
     */
    public boolean isHiddenFile(File f) {
<span class="nc" id="L334">        return f.isHidden();</span>
    }


    /**
     * Is dir the root of a tree in the file system, such as a drive
     * or partition. Example: Returns true for &quot;C:\&quot; on Windows 98.
     *
     * @param dir a &lt;code&gt;File&lt;/code&gt; object representing a directory
     * @return &lt;code&gt;true&lt;/code&gt; if &lt;code&gt;f&lt;/code&gt; is a root of a filesystem
     * @see #isRoot
     * @since 1.4
     */
    public boolean isFileSystemRoot(File dir) {
<span class="nc" id="L348">        return ShellFolder.isFileSystemRoot(dir);</span>
    }

    /**
     * Used by UI classes to decide whether to display a special icon
     * for drives or partitions, e.g. a &quot;hard disk&quot; icon.
     *
     * The default implementation has no way of knowing, so always returns false.
     *
     * @param dir a directory
     * @return &lt;code&gt;false&lt;/code&gt; always
     * @since 1.4
     */
    public boolean isDrive(File dir) {
<span class="nc" id="L362">        return false;</span>
    }

    /**
     * Used by UI classes to decide whether to display a special icon
     * for a floppy disk. Implies isDrive(dir).
     *
     * The default implementation has no way of knowing, so always returns false.
     *
     * @param dir a directory
     * @return &lt;code&gt;false&lt;/code&gt; always
     * @since 1.4
     */
    public boolean isFloppyDrive(File dir) {
<span class="nc" id="L376">        return false;</span>
    }

    /**
     * Used by UI classes to decide whether to display a special icon
     * for a computer node, e.g. &quot;My Computer&quot; or a network server.
     *
     * The default implementation has no way of knowing, so always returns false.
     *
     * @param dir a directory
     * @return &lt;code&gt;false&lt;/code&gt; always
     * @since 1.4
     */
    public boolean isComputerNode(File dir) {
<span class="nc" id="L390">        return ShellFolder.isComputerNode(dir);</span>
    }


    /**
     * Returns all root partitions on this system. For example, on
     * Windows, this would be the &quot;Desktop&quot; folder, while on DOS this
     * would be the A: through Z: drives.
     */
    public File[] getRoots() {
        // Don't cache this array, because filesystem might change
<span class="nc" id="L401">        File[] roots = (File[])ShellFolder.get(&quot;roots&quot;);</span>

<span class="nc bnc" id="L403" title="All 2 branches missed.">        for (int i = 0; i &lt; roots.length; i++) {</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (isFileSystemRoot(roots[i])) {</span>
<span class="nc" id="L405">                roots[i] = createFileSystemRoot(roots[i]);</span>
            }
        }
<span class="nc" id="L408">        return roots;</span>
    }


    // Providing default implementations for the remaining methods
    // because most OS file systems will likely be able to use this
    // code. If a given OS can't, override these methods in its
    // implementation.

    public File getHomeDirectory() {
<span class="nc" id="L418">        return createFileObject(System.getProperty(&quot;user.home&quot;));</span>
    }

    /**
     * Return the user's default starting directory for the file chooser.
     *
     * @return a &lt;code&gt;File&lt;/code&gt; object representing the default
     *         starting folder
     * @since 1.4
     */
    public File getDefaultDirectory() {
<span class="nc" id="L429">        File f = (File)ShellFolder.get(&quot;fileChooserDefaultFolder&quot;);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (isFileSystemRoot(f)) {</span>
<span class="nc" id="L431">            f = createFileSystemRoot(f);</span>
        }
<span class="nc" id="L433">        return f;</span>
    }

    /**
     * Returns a File object constructed in dir from the given filename.
     */
    public File createFileObject(File dir, String filename) {
<span class="nc bnc" id="L440" title="All 2 branches missed.">        if(dir == null) {</span>
<span class="nc" id="L441">            return new File(filename);</span>
        } else {
<span class="nc" id="L443">            return new File(dir, filename);</span>
        }
    }

    /**
     * Returns a File object constructed from the given path string.
     */
    public File createFileObject(String path) {
<span class="nc" id="L451">        File f = new File(path);</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (isFileSystemRoot(f)) {</span>
<span class="nc" id="L453">            f = createFileSystemRoot(f);</span>
        }
<span class="nc" id="L455">        return f;</span>
    }


    /**
     * Gets the list of shown (i.e. not hidden) files.
     */
    public File[] getFiles(File dir, boolean useFileHiding) {
<span class="nc" id="L463">        List&lt;File&gt; files = new ArrayList&lt;File&gt;();</span>

        // add all files in dir
<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (!(dir instanceof ShellFolder)) {</span>
            try {
<span class="nc" id="L468">                dir = getShellFolder(dir);</span>
<span class="nc" id="L469">            } catch (FileNotFoundException e) {</span>
<span class="nc" id="L470">                return new File[0];</span>
<span class="nc" id="L471">            }</span>
        }

<span class="nc bnc" id="L474" title="All 2 branches missed.">        File[] names = ((ShellFolder) dir).listFiles(!useFileHiding);</span>

<span class="nc bnc" id="L476" title="All 2 branches missed.">        if (names == null) {</span>
<span class="nc" id="L477">            return new File[0];</span>
        }

<span class="nc bnc" id="L480" title="All 2 branches missed.">        for (File f : names) {</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">            if (Thread.currentThread().isInterrupted()) {</span>
<span class="nc" id="L482">                break;</span>
            }

<span class="nc bnc" id="L485" title="All 2 branches missed.">            if (!(f instanceof ShellFolder)) {</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">                if (isFileSystemRoot(f)) {</span>
<span class="nc" id="L487">                    f = createFileSystemRoot(f);</span>
                }
                try {
<span class="nc" id="L490">                    f = ShellFolder.getShellFolder(f);</span>
<span class="nc" id="L491">                } catch (FileNotFoundException e) {</span>
                    // Not a valid file (wouldn't show in native file chooser)
                    // Example: C:\pagefile.sys
<span class="nc" id="L494">                    continue;</span>
<span class="nc" id="L495">                } catch (InternalError e) {</span>
                    // Not a valid file (wouldn't show in native file chooser)
                    // Example C:\Winnt\Profiles\joe\history\History.IE5
<span class="nc" id="L498">                    continue;</span>
<span class="nc" id="L499">                }</span>
            }
<span class="nc bnc" id="L501" title="All 4 branches missed.">            if (!useFileHiding || !isHiddenFile(f)) {</span>
<span class="nc" id="L502">                files.add(f);</span>
            }
        }

<span class="nc" id="L506">        return files.toArray(new File[files.size()]);</span>
    }



    /**
     * Returns the parent directory of &lt;code&gt;dir&lt;/code&gt;.
     * @param dir the &lt;code&gt;File&lt;/code&gt; being queried
     * @return the parent directory of &lt;code&gt;dir&lt;/code&gt;, or
     *   &lt;code&gt;null&lt;/code&gt; if &lt;code&gt;dir&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;
     */
    public File getParentDirectory(File dir) {
<span class="nc bnc" id="L518" title="All 4 branches missed.">        if (dir == null || !dir.exists()) {</span>
<span class="nc" id="L519">            return null;</span>
        }

        ShellFolder sf;

        try {
<span class="nc" id="L525">            sf = getShellFolder(dir);</span>
<span class="nc" id="L526">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L527">            return null;</span>
<span class="nc" id="L528">        }</span>

<span class="nc" id="L530">        File psf = sf.getParentFile();</span>

<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (psf == null) {</span>
<span class="nc" id="L533">            return null;</span>
        }

<span class="nc bnc" id="L536" title="All 2 branches missed.">        if (isFileSystem(psf)) {</span>
<span class="nc" id="L537">            File f = psf;</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">            if (!f.exists()) {</span>
                // This could be a node under &quot;Network Neighborhood&quot;.
<span class="nc" id="L540">                File ppsf = psf.getParentFile();</span>
<span class="nc bnc" id="L541" title="All 4 branches missed.">                if (ppsf == null || !isFileSystem(ppsf)) {</span>
                    // We're mostly after the exists() override for windows below.
<span class="nc" id="L543">                    f = createFileSystemRoot(f);</span>
                }
            }
<span class="nc" id="L546">            return f;</span>
        } else {
<span class="nc" id="L548">            return psf;</span>
        }
    }

    /**
     * Throws {@code FileNotFoundException} if file not found or current thread was interrupted
     */
    ShellFolder getShellFolder(File f) throws FileNotFoundException {
<span class="nc bnc" id="L556" title="All 6 branches missed.">        if (!(f instanceof ShellFolder) &amp;&amp; !(f instanceof FileSystemRoot) &amp;&amp; isFileSystemRoot(f)) {</span>
<span class="nc" id="L557">            f = createFileSystemRoot(f);</span>
        }

        try {
<span class="nc" id="L561">            return ShellFolder.getShellFolder(f);</span>
<span class="nc" id="L562">        } catch (InternalError e) {</span>
<span class="nc" id="L563">            System.err.println(&quot;FileSystemView.getShellFolder: f=&quot;+f);</span>
<span class="nc" id="L564">            e.printStackTrace();</span>
<span class="nc" id="L565">            return null;</span>
        }
    }

    /**
     * Creates a new &lt;code&gt;File&lt;/code&gt; object for &lt;code&gt;f&lt;/code&gt; with correct
     * behavior for a file system root directory.
     *
     * @param f a &lt;code&gt;File&lt;/code&gt; object representing a file system root
     *          directory, for example &quot;/&quot; on Unix or &quot;C:\&quot; on Windows.
     * @return a new &lt;code&gt;File&lt;/code&gt; object
     * @since 1.4
     */
    protected File createFileSystemRoot(File f) {
<span class="nc" id="L579">        return new FileSystemRoot(f);</span>
    }




    static class FileSystemRoot extends File {
        public FileSystemRoot(File f) {
<span class="nc" id="L587">            super(f,&quot;&quot;);</span>
<span class="nc" id="L588">        }</span>

        public FileSystemRoot(String s) {
<span class="nc" id="L591">            super(s);</span>
<span class="nc" id="L592">        }</span>

        public boolean isDirectory() {
<span class="nc" id="L595">            return true;</span>
        }

        public String getName() {
<span class="nc" id="L599">            return getPath();</span>
        }
    }
}

/**
 * FileSystemView that handles some specific unix-isms.
 */
<span class="nc" id="L607">class UnixFileSystemView extends FileSystemView {</span>

<span class="nc" id="L609">    private static final String newFolderString =</span>
<span class="nc" id="L610">            UIManager.getString(&quot;FileChooser.other.newFolder&quot;);</span>
<span class="nc" id="L611">    private static final String newFolderNextString  =</span>
<span class="nc" id="L612">            UIManager.getString(&quot;FileChooser.other.newFolder.subsequent&quot;);</span>

    /**
     * Creates a new folder with a default folder name.
     */
    public File createNewFolder(File containingDir) throws IOException {
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if(containingDir == null) {</span>
<span class="nc" id="L619">            throw new IOException(&quot;Containing directory is null:&quot;);</span>
        }
        File newFolder;
        // Unix - using OpenWindows' default folder name. Can't find one for Motif/CDE.
<span class="nc" id="L623">        newFolder = createFileObject(containingDir, newFolderString);</span>
<span class="nc" id="L624">        int i = 1;</span>
<span class="nc bnc" id="L625" title="All 4 branches missed.">        while (newFolder.exists() &amp;&amp; i &lt; 100) {</span>
<span class="nc" id="L626">            newFolder = createFileObject(containingDir, MessageFormat.format(</span>
                    newFolderNextString, new Integer(i)));
<span class="nc" id="L628">            i++;</span>
        }

<span class="nc bnc" id="L631" title="All 2 branches missed.">        if(newFolder.exists()) {</span>
<span class="nc" id="L632">            throw new IOException(&quot;Directory already exists:&quot; + newFolder.getAbsolutePath());</span>
        } else {
<span class="nc" id="L634">            newFolder.mkdirs();</span>
        }

<span class="nc" id="L637">        return newFolder;</span>
    }

    public boolean isFileSystemRoot(File dir) {
<span class="nc bnc" id="L641" title="All 4 branches missed.">        return dir != null &amp;&amp; dir.getAbsolutePath().equals(&quot;/&quot;);</span>
    }

    public boolean isDrive(File dir) {
<span class="nc" id="L645">        return isFloppyDrive(dir);</span>
    }

    public boolean isFloppyDrive(File dir) {
        // Could be looking at the path for Solaris, but wouldn't be reliable.
        // For example:
        // return (dir != null &amp;&amp; dir.getAbsolutePath().toLowerCase().startsWith(&quot;/floppy&quot;));
<span class="nc" id="L652">        return false;</span>
    }

    public boolean isComputerNode(File dir) {
<span class="nc bnc" id="L656" title="All 2 branches missed.">        if (dir != null) {</span>
<span class="nc" id="L657">            String parent = dir.getParent();</span>
<span class="nc bnc" id="L658" title="All 4 branches missed.">            if (parent != null &amp;&amp; parent.equals(&quot;/net&quot;)) {</span>
<span class="nc" id="L659">                return true;</span>
            }
        }
<span class="nc" id="L662">        return false;</span>
    }
}


/**
 * FileSystemView that handles some specific windows concepts.
 */
<span class="nc" id="L670">class WindowsFileSystemView extends FileSystemView {</span>

<span class="nc" id="L672">    private static final String newFolderString =</span>
<span class="nc" id="L673">            UIManager.getString(&quot;FileChooser.win32.newFolder&quot;);</span>
<span class="nc" id="L674">    private static final String newFolderNextString  =</span>
<span class="nc" id="L675">            UIManager.getString(&quot;FileChooser.win32.newFolder.subsequent&quot;);</span>

    public Boolean isTraversable(File f) {
<span class="nc bnc" id="L678" title="All 6 branches missed.">        return Boolean.valueOf(isFileSystemRoot(f) || isComputerNode(f) || f.isDirectory());</span>
    }

    public File getChild(File parent, String fileName) {
<span class="nc bnc" id="L682" title="All 2 branches missed.">        if (fileName.startsWith(&quot;\\&quot;)</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">            &amp;&amp; !fileName.startsWith(&quot;\\\\&quot;)</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">            &amp;&amp; isFileSystem(parent)) {</span>

            //Path is relative to the root of parent's drive
<span class="nc" id="L687">            String path = parent.getAbsolutePath();</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">            if (path.length() &gt;= 2</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">                &amp;&amp; path.charAt(1) == ':'</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                &amp;&amp; Character.isLetter(path.charAt(0))) {</span>

<span class="nc" id="L692">                return createFileObject(path.substring(0, 2) + fileName);</span>
            }
        }
<span class="nc" id="L695">        return super.getChild(parent, fileName);</span>
    }

    /**
     * Type description for a file, directory, or folder as it would be displayed in
     * a system file browser. Example from Windows: the &quot;Desktop&quot; folder
     * is described as &quot;Desktop&quot;.
     *
     * The Windows implementation gets information from the ShellFolder class.
     */
    public String getSystemTypeDescription(File f) {
<span class="nc bnc" id="L706" title="All 2 branches missed.">        if (f == null) {</span>
<span class="nc" id="L707">            return null;</span>
        }

        try {
<span class="nc" id="L711">            return getShellFolder(f).getFolderType();</span>
<span class="nc" id="L712">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L713">            return null;</span>
        }
    }

    /**
     * @return the Desktop folder.
     */
    public File getHomeDirectory() {
<span class="nc" id="L721">        return getRoots()[0];</span>
    }

    /**
     * Creates a new folder with a default folder name.
     */
    public File createNewFolder(File containingDir) throws IOException {
<span class="nc bnc" id="L728" title="All 2 branches missed.">        if(containingDir == null) {</span>
<span class="nc" id="L729">            throw new IOException(&quot;Containing directory is null:&quot;);</span>
        }
        // Using NT's default folder name
<span class="nc" id="L732">        File newFolder = createFileObject(containingDir, newFolderString);</span>
<span class="nc" id="L733">        int i = 2;</span>
<span class="nc bnc" id="L734" title="All 4 branches missed.">        while (newFolder.exists() &amp;&amp; i &lt; 100) {</span>
<span class="nc" id="L735">            newFolder = createFileObject(containingDir, MessageFormat.format(</span>
                newFolderNextString, new Integer(i)));
<span class="nc" id="L737">            i++;</span>
        }

<span class="nc bnc" id="L740" title="All 2 branches missed.">        if(newFolder.exists()) {</span>
<span class="nc" id="L741">            throw new IOException(&quot;Directory already exists:&quot; + newFolder.getAbsolutePath());</span>
        } else {
<span class="nc" id="L743">            newFolder.mkdirs();</span>
        }

<span class="nc" id="L746">        return newFolder;</span>
    }

    public boolean isDrive(File dir) {
<span class="nc" id="L750">        return isFileSystemRoot(dir);</span>
    }

    public boolean isFloppyDrive(final File dir) {
<span class="nc" id="L754">        String path = AccessController.doPrivileged(new PrivilegedAction&lt;String&gt;() {</span>
            public String run() {
<span class="nc" id="L756">                return dir.getAbsolutePath();</span>
            }
        });

<span class="nc bnc" id="L760" title="All 6 branches missed.">        return path != null &amp;&amp; (path.equals(&quot;A:\\&quot;) || path.equals(&quot;B:\\&quot;));</span>
    }

    /**
     * Returns a File object constructed from the given path string.
     */
    public File createFileObject(String path) {
        // Check for missing backslash after drive letter such as &quot;C:&quot; or &quot;C:filename&quot;
<span class="nc bnc" id="L768" title="All 6 branches missed.">        if (path.length() &gt;= 2 &amp;&amp; path.charAt(1) == ':' &amp;&amp; Character.isLetter(path.charAt(0))) {</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">            if (path.length() == 2) {</span>
<span class="nc" id="L770">                path += &quot;\\&quot;;</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            } else if (path.charAt(2) != '\\') {</span>
<span class="nc" id="L772">                path = path.substring(0, 2) + &quot;\\&quot; + path.substring(2);</span>
            }
        }
<span class="nc" id="L775">        return super.createFileObject(path);</span>
    }

    protected File createFileSystemRoot(File f) {
        // Problem: Removable drives on Windows return false on f.exists()
        // Workaround: Override exists() to always return true.
<span class="nc" id="L781">        return new FileSystemRoot(f) {</span>
            public boolean exists() {
<span class="nc" id="L783">                return true;</span>
            }
        };
    }

}

/**
 * Fallthrough FileSystemView in case we can't determine the OS.
 */
<span class="nc" id="L793">class GenericFileSystemView extends FileSystemView {</span>

<span class="nc" id="L795">    private static final String newFolderString =</span>
<span class="nc" id="L796">            UIManager.getString(&quot;FileChooser.other.newFolder&quot;);</span>

    /**
     * Creates a new folder with a default folder name.
     */
    public File createNewFolder(File containingDir) throws IOException {
<span class="nc bnc" id="L802" title="All 2 branches missed.">        if(containingDir == null) {</span>
<span class="nc" id="L803">            throw new IOException(&quot;Containing directory is null:&quot;);</span>
        }
        // Using NT's default folder name
<span class="nc" id="L806">        File newFolder = createFileObject(containingDir, newFolderString);</span>

<span class="nc bnc" id="L808" title="All 2 branches missed.">        if(newFolder.exists()) {</span>
<span class="nc" id="L809">            throw new IOException(&quot;Directory already exists:&quot; + newFolder.getAbsolutePath());</span>
        } else {
<span class="nc" id="L811">            newFolder.mkdirs();</span>
        }

<span class="nc" id="L814">        return newFolder;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>