<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GSSUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.jgss</a> &gt; <span class="el_source">GSSUtil.java</span></div><h1>GSSUtil.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.jgss;

import com.sun.security.auth.callback.TextCallbackHandler;
import javax.security.auth.Subject;
import javax.security.auth.kerberos.KerberosPrincipal;
import javax.security.auth.kerberos.KerberosTicket;
import javax.security.auth.kerberos.KerberosKey;
import org.ietf.jgss.*;
import sun.security.jgss.spi.GSSNameSpi;
import sun.security.jgss.spi.GSSCredentialSpi;
import sun.security.action.GetPropertyAction;
import sun.security.jgss.krb5.Krb5NameElement;
import sun.security.jgss.spnego.SpNegoCredElement;
import java.util.Set;
import java.util.HashSet;
import java.util.Vector;
import java.util.Iterator;
import java.security.AccessController;
import java.security.AccessControlContext;
import java.security.PrivilegedExceptionAction;
import java.security.PrivilegedActionException;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.login.LoginContext;
import javax.security.auth.login.LoginException;
import sun.security.action.GetBooleanAction;

/**
 * The GSSUtilImplementation that knows how to work with the internals of
 * the GSS-API.
 */
<span class="pc bfc" id="L56" title="All 2 branches covered.">public class GSSUtil {</span>

<span class="fc" id="L58">    public static final Oid GSS_KRB5_MECH_OID =</span>
<span class="fc" id="L59">                GSSUtil.createOid(&quot;1.2.840.113554.1.2.2&quot;);</span>
<span class="fc" id="L60">    public static final Oid GSS_KRB5_MECH_OID2 =</span>
<span class="fc" id="L61">                GSSUtil.createOid(&quot;1.3.5.1.5.2&quot;);</span>

<span class="fc" id="L63">    public static final Oid GSS_SPNEGO_MECH_OID =</span>
<span class="fc" id="L64">                GSSUtil.createOid(&quot;1.3.6.1.5.5.2&quot;);</span>

<span class="fc" id="L66">    public static final Oid NT_GSS_KRB5_PRINCIPAL =</span>
<span class="fc" id="L67">                GSSUtil.createOid(&quot;1.2.840.113554.1.2.2.1&quot;);</span>

    private static final String DEFAULT_HANDLER =
            &quot;auth.login.defaultCallbackHandler&quot;;

    static final boolean DEBUG;
    static {
<span class="fc" id="L74">        DEBUG = (AccessController.doPrivileged</span>
<span class="fc" id="L75">                        (new GetBooleanAction(&quot;sun.security.jgss.debug&quot;))).</span>
<span class="fc" id="L76">                                booleanValue();</span>
<span class="fc" id="L77">    }</span>

    static void debug(String message) {
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if (DEBUG) {</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">            assert(message != null);</span>
<span class="nc" id="L82">            System.out.println(message);</span>
        }
<span class="fc" id="L84">    }</span>

    // NOTE: this method is only for creating Oid objects with
    // known to be valid &lt;code&gt;oidStr&lt;/code&gt; given it ignores
    // the GSSException
    public static Oid createOid(String oidStr) {
        try {
<span class="fc" id="L91">            return new Oid(oidStr);</span>
<span class="nc" id="L92">        } catch (GSSException e) {</span>
<span class="nc" id="L93">            debug(&quot;Ignored invalid OID: &quot; + oidStr);</span>
<span class="nc" id="L94">            return null;</span>
        }
    }

    public static boolean isSpNegoMech(Oid oid) {
<span class="fc" id="L99">        return (GSS_SPNEGO_MECH_OID.equals(oid));</span>
    }

    public static boolean isKerberosMech(Oid oid) {
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        return (GSS_KRB5_MECH_OID.equals(oid) ||</span>
<span class="pc bnc" id="L104" title="All 2 branches missed.">                GSS_KRB5_MECH_OID2.equals(oid));</span>

    }

    public static String getMechStr(Oid oid) {
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (isSpNegoMech(oid)) {</span>
<span class="fc" id="L110">            return &quot;SPNEGO&quot;;</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        } else if (isKerberosMech(oid)) {</span>
<span class="fc" id="L112">            return &quot;Kerberos V5&quot;;</span>
        } else {
<span class="nc" id="L114">            return oid.toString();</span>
        }
    }

    /**
     * Note: The current impl only works with Sun's impl of
     * GSSName and GSSCredential since it depends on package
     * private APIs.
     */
    public static Subject getSubject(GSSName name,
                                     GSSCredential creds) {

<span class="nc" id="L126">        HashSet&lt;Object&gt; privCredentials = null;</span>
<span class="nc" id="L127">        HashSet&lt;Object&gt; pubCredentials = new HashSet&lt;Object&gt;(); // empty Set</span>

<span class="nc" id="L129">        Set&lt;GSSCredentialSpi&gt; gssCredentials = null;</span>

<span class="nc" id="L131">        Set&lt;KerberosPrincipal&gt; krb5Principals =</span>
                                new HashSet&lt;KerberosPrincipal&gt;();

<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (name instanceof GSSNameImpl) {</span>
            try {
<span class="nc" id="L136">                GSSNameSpi ne = ((GSSNameImpl) name).getElement</span>
<span class="nc" id="L137">                    (GSS_KRB5_MECH_OID);</span>
<span class="nc" id="L138">                String krbName = ne.toString();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                if (ne instanceof Krb5NameElement) {</span>
<span class="nc" id="L140">                    krbName =</span>
<span class="nc" id="L141">                        ((Krb5NameElement) ne).getKrb5PrincipalName().getName();</span>
                }
<span class="nc" id="L143">                KerberosPrincipal krbPrinc = new KerberosPrincipal(krbName);</span>
<span class="nc" id="L144">                krb5Principals.add(krbPrinc);</span>
<span class="nc" id="L145">            } catch (GSSException ge) {</span>
<span class="nc" id="L146">                debug(&quot;Skipped name &quot; + name + &quot; due to &quot; + ge);</span>
<span class="nc" id="L147">            }</span>
        }

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (creds instanceof GSSCredentialImpl) {</span>
<span class="nc" id="L151">            gssCredentials = ((GSSCredentialImpl) creds).getElements();</span>
<span class="nc" id="L152">            privCredentials = new HashSet&lt;Object&gt;(gssCredentials.size());</span>
<span class="nc" id="L153">            populateCredentials(privCredentials, gssCredentials);</span>
        } else {
<span class="nc" id="L155">            privCredentials = new HashSet&lt;Object&gt;(); // empty Set</span>
        }
<span class="nc" id="L157">        debug(&quot;Created Subject with the following&quot;);</span>
<span class="nc" id="L158">        debug(&quot;principals=&quot; + krb5Principals);</span>
<span class="nc" id="L159">        debug(&quot;public creds=&quot; + pubCredentials);</span>
<span class="nc" id="L160">        debug(&quot;private creds=&quot; + privCredentials);</span>

<span class="nc" id="L162">        return new Subject(false, krb5Principals, pubCredentials,</span>
                           privCredentials);

    }

    /**
     * Populates the set credentials with elements from gssCredentials. At
     * the same time, it converts any subclasses of KerberosTicket
     * into KerberosTicket instances and any subclasses of KerberosKey into
     * KerberosKey instances. (It is not desirable to expose the customer
     * to sun.security.jgss.krb5.Krb5InitCredential which extends
     * KerberosTicket and sun.security.jgss.krb5.Kbr5AcceptCredential which
     * extends KerberosKey.)
     */
    private static void populateCredentials(Set&lt;Object&gt; credentials,
                                            Set&lt;?&gt; gssCredentials) {

        Object cred;

<span class="nc" id="L181">        Iterator&lt;?&gt; elements = gssCredentials.iterator();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        while (elements.hasNext()) {</span>

<span class="nc" id="L184">            cred = elements.next();</span>

            // Retrieve the internal cred out of SpNegoCredElement
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (cred instanceof SpNegoCredElement) {</span>
<span class="nc" id="L188">                cred = ((SpNegoCredElement) cred).getInternalCred();</span>
            }

<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (cred instanceof KerberosTicket) {</span>
<span class="nc" id="L192">                if (!cred.getClass().getName().equals</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                    (&quot;javax.security.auth.kerberos.KerberosTicket&quot;)) {</span>
<span class="nc" id="L194">                    KerberosTicket tempTkt = (KerberosTicket) cred;</span>
<span class="nc" id="L195">                    cred = new KerberosTicket(tempTkt.getEncoded(),</span>
<span class="nc" id="L196">                                              tempTkt.getClient(),</span>
<span class="nc" id="L197">                                              tempTkt.getServer(),</span>
<span class="nc" id="L198">                                              tempTkt.getSessionKey().getEncoded(),</span>
<span class="nc" id="L199">                                              tempTkt.getSessionKeyType(),</span>
<span class="nc" id="L200">                                              tempTkt.getFlags(),</span>
<span class="nc" id="L201">                                              tempTkt.getAuthTime(),</span>
<span class="nc" id="L202">                                              tempTkt.getStartTime(),</span>
<span class="nc" id="L203">                                              tempTkt.getEndTime(),</span>
<span class="nc" id="L204">                                              tempTkt.getRenewTill(),</span>
<span class="nc" id="L205">                                              tempTkt.getClientAddresses());</span>
                }
<span class="nc" id="L207">                credentials.add(cred);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            } else if (cred instanceof KerberosKey) {</span>
<span class="nc" id="L209">                if (!cred.getClass().getName().equals</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                    (&quot;javax.security.auth.kerberos.KerberosKey&quot;)) {</span>
<span class="nc" id="L211">                    KerberosKey tempKey = (KerberosKey) cred;</span>
<span class="nc" id="L212">                    cred = new KerberosKey(tempKey.getPrincipal(),</span>
<span class="nc" id="L213">                                           tempKey.getEncoded(),</span>
<span class="nc" id="L214">                                           tempKey.getKeyType(),</span>
<span class="nc" id="L215">                                           tempKey.getVersionNumber());</span>
                }
<span class="nc" id="L217">                credentials.add(cred);</span>
            } else {
                // Ignore non-KerberosTicket and non-KerberosKey elements
<span class="nc" id="L220">                debug(&quot;Skipped cred element: &quot; + cred);</span>
            }
        }
<span class="nc" id="L223">    }</span>

    /**
     * Authenticate using the login module from the specified
     * configuration entry.
     *
     * @param caller the caller of JAAS Login
     * @param mech the mech to be used
     * @return the authenticated subject
     */
    public static Subject login(GSSCaller caller, Oid mech) throws LoginException {

<span class="fc" id="L235">        CallbackHandler cb = null;</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">        if (caller instanceof HttpCaller) {</span>
<span class="nc" id="L237">            cb = new sun.net.www.protocol.http.spnego.NegotiateCallbackHandler(</span>
<span class="nc" id="L238">                    ((HttpCaller)caller).info());</span>
        } else {
<span class="fc" id="L240">            String defaultHandler =</span>
<span class="fc" id="L241">                    java.security.Security.getProperty(DEFAULT_HANDLER);</span>
            // get the default callback handler
<span class="pc bpc" id="L243" title="1 of 4 branches missed.">            if ((defaultHandler != null) &amp;&amp; (defaultHandler.length() != 0)) {</span>
<span class="fc" id="L244">                cb = null;</span>
            } else {
<span class="fc" id="L246">                cb = new TextCallbackHandler();</span>
            }
        }

        // New instance of LoginConfigImpl must be created for each login,
        // since the entry name is not passed as the first argument, but
        // generated with caller and mech inside LoginConfigImpl
<span class="fc" id="L253">        LoginContext lc = new LoginContext(&quot;&quot;, null, cb,</span>
                new LoginConfigImpl(caller, mech));
<span class="fc" id="L255">        lc.login();</span>
<span class="fc" id="L256">        return lc.getSubject();</span>
    }

    /**
     * Determines if the application doesn't mind if the mechanism obtains
     * the required credentials from outside of the current Subject. Our
     * Kerberos v5 mechanism would do a JAAS login on behalf of the
     * application if this were the case.
     *
     * The application indicates this by explicitly setting the system
     * property javax.security.auth.useSubjectCredsOnly to false.
     */
    public static boolean useSubjectCredsOnly(GSSCaller caller) {

        // HTTP/SPNEGO doesn't use the standard JAAS framework. Instead, it
        // uses the java.net.Authenticator style, therefore always return
        // false here.
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">        if (caller instanceof HttpCaller) {</span>
<span class="nc" id="L274">            return false;</span>
        }
        /*
         * Don't use GetBooleanAction because the default value in the JRE
         * (when this is unset) has to treated as true.
         */
<span class="fc" id="L280">        String propValue = AccessController.doPrivileged(</span>
                new GetPropertyAction(&quot;javax.security.auth.useSubjectCredsOnly&quot;,
                &quot;true&quot;));
        /*
         * This property has to be explicitly set to &quot;false&quot;. Invalid
         * values should be ignored and the default &quot;true&quot; assumed.
         */
<span class="fc bfc" id="L287" title="All 2 branches covered.">        return (!propValue.equalsIgnoreCase(&quot;false&quot;));</span>
    }

    /**
     * Determines the SPNEGO interoperability mode with Microsoft;
     * by default it is set to true.
     *
     * To disable it, the application indicates this by explicitly setting
     * the system property sun.security.spnego.interop to false.
     */
    public static boolean useMSInterop() {
        /*
         * Don't use GetBooleanAction because the default value in the JRE
         * (when this is unset) has to treated as true.
         */
<span class="nc" id="L302">        String propValue = AccessController.doPrivileged(</span>
                new GetPropertyAction(&quot;sun.security.spnego.msinterop&quot;,
                &quot;true&quot;));
        /*
         * This property has to be explicitly set to &quot;false&quot;. Invalid
         * values should be ignored and the default &quot;true&quot; assumed.
         */
<span class="nc bnc" id="L309" title="All 2 branches missed.">        return (!propValue.equalsIgnoreCase(&quot;false&quot;));</span>
    }

    /**
     * Searches the private credentials of current Subject with the
     * specified criteria and returns the matching GSSCredentialSpi
     * object out of Sun's impl of GSSCredential. Returns null if
     * no Subject present or a Vector which contains 0 or more
     * matching GSSCredentialSpi objects.
     */
    public static &lt;T extends GSSCredentialSpi&gt; Vector&lt;T&gt;
            searchSubject(final GSSNameSpi name,
                          final Oid mech,
                          final boolean initiate,
                          final Class&lt;? extends T&gt; credCls) {
<span class="fc bfc" id="L324" title="All 4 branches covered.">        debug(&quot;Search Subject for &quot; + getMechStr(mech) +</span>
              (initiate? &quot; INIT&quot; : &quot; ACCEPT&quot;) + &quot; cred (&quot; +
<span class="fc" id="L326">              (name == null? &quot;&lt;&lt;DEF&gt;&gt;&quot; : name.toString()) + &quot;, &quot; +</span>
<span class="fc" id="L327">              credCls.getName() + &quot;)&quot;);</span>
<span class="fc" id="L328">        final AccessControlContext acc = AccessController.getContext();</span>
        try {
<span class="fc" id="L330">            Vector&lt;T&gt; creds =</span>
                AccessController.doPrivileged
<span class="fc" id="L332">                (new PrivilegedExceptionAction&lt;Vector&lt;T&gt;&gt;() {</span>
                    public Vector&lt;T&gt; run() throws Exception {
<span class="fc" id="L334">                        Subject accSubj = Subject.getSubject(acc);</span>
<span class="fc" id="L335">                        Vector&lt;T&gt; result = null;</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">                        if (accSubj != null) {</span>
<span class="fc" id="L337">                            result = new Vector&lt;T&gt;();</span>
<span class="fc" id="L338">                            Iterator&lt;GSSCredentialImpl&gt; iterator =</span>
                                accSubj.getPrivateCredentials
<span class="fc" id="L340">                                (GSSCredentialImpl.class).iterator();</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">                            while (iterator.hasNext()) {</span>
<span class="nc" id="L342">                                GSSCredentialImpl cred = iterator.next();</span>
<span class="nc" id="L343">                                debug(&quot;...Found cred&quot; + cred);</span>
                                try {
<span class="nc" id="L345">                                    GSSCredentialSpi ce =</span>
<span class="nc" id="L346">                                        cred.getElement(mech, initiate);</span>
<span class="nc" id="L347">                                    debug(&quot;......Found element: &quot; + ce);</span>
<span class="nc bnc" id="L348" title="All 4 branches missed.">                                    if (ce.getClass().equals(credCls) &amp;&amp;</span>
                                        (name == null ||
<span class="nc bnc" id="L350" title="All 2 branches missed.">                                         name.equals((Object) ce.getName()))) {</span>
<span class="nc" id="L351">                                        result.add(credCls.cast(ce));</span>
                                    } else {
<span class="nc" id="L353">                                        debug(&quot;......Discard element&quot;);</span>
                                    }
<span class="nc" id="L355">                                } catch (GSSException ge) {</span>
<span class="nc" id="L356">                                    debug(&quot;...Discard cred (&quot; + ge + &quot;)&quot;);</span>
<span class="nc" id="L357">                                }</span>
<span class="nc" id="L358">                            }</span>
<span class="fc" id="L359">                        } else debug(&quot;No Subject&quot;);</span>
<span class="fc" id="L360">                        return result;</span>
                    }
                });
<span class="fc" id="L363">            return creds;</span>
<span class="nc" id="L364">        } catch (PrivilegedActionException pae) {</span>
<span class="nc" id="L365">            debug(&quot;Unexpected exception when searching Subject:&quot;);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">            if (DEBUG) pae.printStackTrace();</span>
<span class="nc" id="L367">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>