<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>GSSCredentialImpl.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.jgss</a> &gt; <span class="el_source">GSSCredentialImpl.java</span></div><h1>GSSCredentialImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.jgss;

import org.ietf.jgss.*;
import sun.security.jgss.spi.*;
import java.util.*;
import com.sun.security.jgss.*;
import sun.security.jgss.spnego.SpNegoCredElement;

public class GSSCredentialImpl implements ExtendedGSSCredential {

<span class="fc" id="L36">    private GSSManagerImpl gssManager = null;</span>
<span class="fc" id="L37">    private boolean destroyed = false;</span>

    /*
     * We store all elements in a hashtable, using &lt;oid, usage&gt; as the
     * key. This makes it easy to locate the specific kind of credential we
     * need. The implementation needs to be optimized for the case where
     * there is just one element (tempCred).
     */
<span class="fc" id="L45">    private Hashtable&lt;SearchKey, GSSCredentialSpi&gt; hashtable = null;</span>

    // XXX Optimization for single mech usage
<span class="fc" id="L48">    private GSSCredentialSpi tempCred = null;</span>

    GSSCredentialImpl(GSSManagerImpl gssManager, int usage)
        throws GSSException {
<span class="nc" id="L52">        this(gssManager, null, GSSCredential.DEFAULT_LIFETIME,</span>
             (Oid[]) null, usage);
<span class="nc" id="L54">    }</span>

    GSSCredentialImpl(GSSManagerImpl gssManager, GSSName name,
                             int lifetime, Oid mech, int usage)
<span class="fc" id="L58">        throws GSSException {</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (mech == null) mech = ProviderList.DEFAULT_MECH_OID;</span>

<span class="fc" id="L61">        init(gssManager);</span>
<span class="fc" id="L62">        add(name, lifetime, lifetime, mech, usage);</span>
<span class="fc" id="L63">    }</span>

    GSSCredentialImpl(GSSManagerImpl gssManager, GSSName name,
                      int lifetime, Oid mechs[], int usage)
<span class="fc" id="L67">        throws GSSException {</span>
<span class="fc" id="L68">        init(gssManager);</span>
<span class="fc" id="L69">        boolean defaultList = false;</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">        if (mechs == null) {</span>
<span class="fc" id="L71">            mechs = gssManager.getMechs();</span>
<span class="fc" id="L72">            defaultList = true;</span>
        }

<span class="fc bfc" id="L75" title="All 2 branches covered.">        for (int i = 0; i &lt; mechs.length; i++) {</span>
            try {
<span class="nc" id="L77">                add(name, lifetime, lifetime, mechs[i], usage);</span>
<span class="fc" id="L78">            } catch (GSSException e) {</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">                if (defaultList) {</span>
                    // Try the next mechanism
<span class="fc" id="L81">                    GSSUtil.debug(&quot;Ignore &quot; + e + &quot; while acquring cred for &quot;</span>
                        + mechs[i]);
                    //e.printStackTrace();
<span class="nc" id="L84">                } else throw e; // else try the next mechanism</span>
<span class="nc" id="L85">            }</span>
        }
<span class="pc bpc" id="L87" title="3 of 4 branches missed.">        if ((hashtable.size() == 0) || (usage != getUsage()))</span>
<span class="fc" id="L88">            throw new GSSException(GSSException.NO_CRED);</span>
<span class="nc" id="L89">    }</span>

    // Wrap a mech cred into a GSS cred
    public GSSCredentialImpl(GSSManagerImpl gssManager,
<span class="fc" id="L93">                      GSSCredentialSpi mechElement) throws GSSException {</span>

<span class="fc" id="L95">        init(gssManager);</span>
<span class="fc" id="L96">        int usage = GSSCredential.ACCEPT_ONLY;</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">        if (mechElement.isInitiatorCredential()) {</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">            if (mechElement.isAcceptorCredential()) {</span>
<span class="nc" id="L99">                usage = GSSCredential.INITIATE_AND_ACCEPT;</span>
            } else {
<span class="fc" id="L101">                usage = GSSCredential.INITIATE_ONLY;</span>
            }
        }
<span class="fc" id="L104">        SearchKey key = new SearchKey(mechElement.getMechanism(),</span>
                                        usage);
<span class="fc" id="L106">        tempCred = mechElement;</span>
<span class="fc" id="L107">        hashtable.put(key, tempCred);</span>
        // More mechs that can use this cred, say, SPNEGO
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        if (!GSSUtil.isSpNegoMech(mechElement.getMechanism())) {</span>
<span class="fc" id="L110">            key = new SearchKey(GSSUtil.GSS_SPNEGO_MECH_OID, usage);</span>
<span class="fc" id="L111">            hashtable.put(key, new SpNegoCredElement(mechElement));</span>
        }
<span class="fc" id="L113">    }</span>

    void init(GSSManagerImpl gssManager) {
<span class="fc" id="L116">        this.gssManager = gssManager;</span>
<span class="fc" id="L117">        hashtable = new Hashtable&lt;SearchKey, GSSCredentialSpi&gt;(</span>
<span class="fc" id="L118">                                                gssManager.getMechs().length);</span>
<span class="fc" id="L119">    }</span>

    public void dispose() throws GSSException {
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (!destroyed) {</span>
            GSSCredentialSpi element;
<span class="nc" id="L124">            Enumeration&lt;GSSCredentialSpi&gt; values = hashtable.elements();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            while (values.hasMoreElements()) {</span>
<span class="nc" id="L126">                element = values.nextElement();</span>
<span class="nc" id="L127">                element.dispose();</span>
            }
<span class="nc" id="L129">            destroyed = true;</span>
        }
<span class="nc" id="L131">    }</span>

    public GSSCredential impersonate(GSSName name) throws GSSException {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L135">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }
<span class="nc" id="L138">        Oid mech = tempCred.getMechanism();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        GSSNameSpi nameElement = (name == null ? null :</span>
<span class="nc" id="L140">                                  ((GSSNameImpl)name).getElement(mech));</span>
<span class="nc" id="L141">        GSSCredentialSpi cred = tempCred.impersonate(nameElement);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        return (cred == null ?</span>
            null : new GSSCredentialImpl(gssManager, cred));
    }

    public GSSName getName() throws GSSException {
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L148">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }
<span class="fc" id="L151">        return GSSNameImpl.wrapElement(gssManager, tempCred.getName());</span>
    }

    public GSSName getName(Oid mech) throws GSSException {

<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L157">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

<span class="nc" id="L161">        SearchKey key = null;</span>
<span class="nc" id="L162">        GSSCredentialSpi element = null;</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (mech == null) mech = ProviderList.DEFAULT_MECH_OID;</span>

<span class="nc" id="L166">        key = new SearchKey(mech, GSSCredential.INITIATE_ONLY);</span>
<span class="nc" id="L167">        element = hashtable.get(key);</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (element == null) {</span>
<span class="nc" id="L170">            key = new SearchKey(mech, GSSCredential.ACCEPT_ONLY);</span>
<span class="nc" id="L171">            element = hashtable.get(key);</span>
        }

<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (element == null) {</span>
<span class="nc" id="L175">            key = new SearchKey(mech, GSSCredential.INITIATE_AND_ACCEPT);</span>
<span class="nc" id="L176">            element = hashtable.get(key);</span>
        }

<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (element == null) {</span>
<span class="nc" id="L180">            throw new GSSExceptionImpl(GSSException.BAD_MECH, mech);</span>
        }

<span class="nc" id="L183">        return GSSNameImpl.wrapElement(gssManager, element.getName());</span>

    }

    /**
     * Returns the remaining lifetime of this credential. The remaining
     * lifetime is defined as the minimum lifetime, either for initiate or
     * for accept, across all elements contained in it. Not terribly
     * useful, but required by GSS-API.
     */
    public int getRemainingLifetime() throws GSSException {

<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L196">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

        SearchKey tempKey;
        GSSCredentialSpi tempCred;
<span class="nc" id="L202">        int tempLife = 0, tempInitLife = 0, tempAcceptLife = 0;</span>
<span class="nc" id="L203">        int min = INDEFINITE_LIFETIME;</span>

<span class="nc" id="L205">        for (Enumeration&lt;SearchKey&gt; e = hashtable.keys();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                                        e.hasMoreElements(); ) {</span>
<span class="nc" id="L207">            tempKey = e.nextElement();</span>
<span class="nc" id="L208">            tempCred = hashtable.get(tempKey);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (tempKey.getUsage() == INITIATE_ONLY)</span>
<span class="nc" id="L210">                tempLife = tempCred.getInitLifetime();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            else if (tempKey.getUsage() == ACCEPT_ONLY)</span>
<span class="nc" id="L212">                tempLife = tempCred.getAcceptLifetime();</span>
            else {
<span class="nc" id="L214">                tempInitLife = tempCred.getInitLifetime();</span>
<span class="nc" id="L215">                tempAcceptLife = tempCred.getAcceptLifetime();</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                tempLife = (tempInitLife &lt; tempAcceptLife ?</span>
                            tempInitLife:
                            tempAcceptLife);
            }
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (min &gt; tempLife)</span>
<span class="nc" id="L221">                min = tempLife;</span>
        }

<span class="nc" id="L224">        return min;</span>
    }

    public int getRemainingInitLifetime(Oid mech) throws GSSException {

<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L230">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

<span class="nc" id="L234">        GSSCredentialSpi element = null;</span>
<span class="nc" id="L235">        SearchKey key = null;</span>
<span class="nc" id="L236">        boolean found = false;</span>
<span class="nc" id="L237">        int max = 0;</span>

<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (mech == null) mech = ProviderList.DEFAULT_MECH_OID;</span>

<span class="nc" id="L241">        key = new SearchKey(mech, GSSCredential.INITIATE_ONLY);</span>
<span class="nc" id="L242">        element = hashtable.get(key);</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (element != null) {</span>
<span class="nc" id="L245">            found = true;</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (max &lt; element.getInitLifetime())</span>
<span class="nc" id="L247">                max = element.getInitLifetime();</span>
        }

<span class="nc" id="L250">        key = new SearchKey(mech, GSSCredential.INITIATE_AND_ACCEPT);</span>
<span class="nc" id="L251">        element = hashtable.get(key);</span>

<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (element != null) {</span>
<span class="nc" id="L254">            found = true;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">            if (max &lt; element.getInitLifetime())</span>
<span class="nc" id="L256">                max = element.getInitLifetime();</span>
        }

<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (!found) {</span>
<span class="nc" id="L260">            throw new GSSExceptionImpl(GSSException.BAD_MECH, mech);</span>
        }

<span class="nc" id="L263">        return max;</span>

    }

    public int getRemainingAcceptLifetime(Oid mech) throws GSSException {

<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L270">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

<span class="nc" id="L274">        GSSCredentialSpi element = null;</span>
<span class="nc" id="L275">        SearchKey key = null;</span>
<span class="nc" id="L276">        boolean found = false;</span>
<span class="nc" id="L277">        int max = 0;</span>

<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (mech == null) mech = ProviderList.DEFAULT_MECH_OID;</span>

<span class="nc" id="L281">        key = new SearchKey(mech, GSSCredential.ACCEPT_ONLY);</span>
<span class="nc" id="L282">        element = hashtable.get(key);</span>

<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (element != null) {</span>
<span class="nc" id="L285">            found = true;</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (max &lt; element.getAcceptLifetime())</span>
<span class="nc" id="L287">                max = element.getAcceptLifetime();</span>
        }

<span class="nc" id="L290">        key = new SearchKey(mech, GSSCredential.INITIATE_AND_ACCEPT);</span>
<span class="nc" id="L291">        element = hashtable.get(key);</span>

<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (element != null) {</span>
<span class="nc" id="L294">            found = true;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (max &lt; element.getAcceptLifetime())</span>
<span class="nc" id="L296">                max = element.getAcceptLifetime();</span>
        }

<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (!found) {</span>
<span class="nc" id="L300">            throw new GSSExceptionImpl(GSSException.BAD_MECH, mech);</span>
        }

<span class="nc" id="L303">        return max;</span>

    }

    /**
     * Returns the usage mode for this credential. Returns
     * INITIATE_AND_ACCEPT if any one element contained in it supports
     * INITIATE_AND_ACCEPT or if two different elements exist where one
     * support INITIATE_ONLY and the other supports ACCEPT_ONLY.
     */
    public int getUsage() throws GSSException {

<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L316">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

        SearchKey tempKey;
<span class="nc" id="L321">        boolean initiate = false;</span>
<span class="nc" id="L322">        boolean accept = false;</span>

<span class="nc" id="L324">        for (Enumeration&lt;SearchKey&gt; e = hashtable.keys();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                                        e.hasMoreElements(); ) {</span>
<span class="nc" id="L326">            tempKey = e.nextElement();</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">            if (tempKey.getUsage() == INITIATE_ONLY)</span>
<span class="nc" id="L328">                initiate = true;</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">            else if (tempKey.getUsage() == ACCEPT_ONLY)</span>
<span class="nc" id="L330">                accept = true;</span>
            else
<span class="nc" id="L332">                return INITIATE_AND_ACCEPT;</span>
        }
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (initiate) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (accept)</span>
<span class="nc" id="L336">                return INITIATE_AND_ACCEPT;</span>
            else
<span class="nc" id="L338">                return INITIATE_ONLY;</span>
        } else
<span class="nc" id="L340">            return ACCEPT_ONLY;</span>
    }

    public int getUsage(Oid mech) throws GSSException {

<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L346">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

<span class="nc" id="L350">        GSSCredentialSpi element = null;</span>
<span class="nc" id="L351">        SearchKey key = null;</span>
<span class="nc" id="L352">        boolean initiate = false;</span>
<span class="nc" id="L353">        boolean accept = false;</span>

<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (mech == null) mech = ProviderList.DEFAULT_MECH_OID;</span>

<span class="nc" id="L357">        key = new SearchKey(mech, GSSCredential.INITIATE_ONLY);</span>
<span class="nc" id="L358">        element = hashtable.get(key);</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (element != null) {</span>
<span class="nc" id="L361">            initiate = true;</span>
        }

<span class="nc" id="L364">        key = new SearchKey(mech, GSSCredential.ACCEPT_ONLY);</span>
<span class="nc" id="L365">        element = hashtable.get(key);</span>

<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (element != null) {</span>
<span class="nc" id="L368">            accept = true;</span>
        }

<span class="nc" id="L371">        key = new SearchKey(mech, GSSCredential.INITIATE_AND_ACCEPT);</span>
<span class="nc" id="L372">        element = hashtable.get(key);</span>

<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (element != null) {</span>
<span class="nc" id="L375">            initiate = true;</span>
<span class="nc" id="L376">            accept = true;</span>
        }

<span class="nc bnc" id="L379" title="All 4 branches missed.">        if (initiate &amp;&amp; accept)</span>
<span class="nc" id="L380">            return GSSCredential.INITIATE_AND_ACCEPT;</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">        else if (initiate)</span>
<span class="nc" id="L382">            return GSSCredential.INITIATE_ONLY;</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">        else if (accept)</span>
<span class="nc" id="L384">            return GSSCredential.ACCEPT_ONLY;</span>
        else {
<span class="nc" id="L386">            throw new GSSExceptionImpl(GSSException.BAD_MECH, mech);</span>
        }
    }

    public Oid[] getMechs() throws GSSException {

<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L393">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }
<span class="nc" id="L396">        Vector&lt;Oid&gt; result = new Vector&lt;Oid&gt;(hashtable.size());</span>

<span class="nc" id="L398">        for (Enumeration&lt;SearchKey&gt; e = hashtable.keys();</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">                                                e.hasMoreElements(); ) {</span>
<span class="nc" id="L400">            SearchKey tempKey = e.nextElement();</span>
<span class="nc" id="L401">            result.addElement(tempKey.getMech());</span>
<span class="nc" id="L402">        }</span>
<span class="nc" id="L403">        return result.toArray(new Oid[0]);</span>
    }

    public void add(GSSName name, int initLifetime, int acceptLifetime,
                    Oid mech, int usage) throws GSSException {

<span class="pc bpc" id="L409" title="1 of 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L410">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">        if (mech == null) mech = ProviderList.DEFAULT_MECH_OID;</span>

<span class="fc" id="L415">        SearchKey key = new SearchKey(mech, usage);</span>
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">        if (hashtable.containsKey(key)) {</span>
<span class="nc" id="L417">            throw new GSSExceptionImpl(GSSException.DUPLICATE_ELEMENT,</span>
                                       &quot;Duplicate element found: &quot; +
<span class="nc" id="L419">                                       getElementStr(mech, usage));</span>
        }

        // XXX If not instance of GSSNameImpl then throw exception
        // Application mixing GSS implementations
<span class="fc bfc" id="L424" title="All 2 branches covered.">        GSSNameSpi nameElement = (name == null ? null :</span>
<span class="fc" id="L425">                                  ((GSSNameImpl)name).getElement(mech));</span>

<span class="fc" id="L427">        tempCred = gssManager.getCredentialElement(nameElement,</span>
                                                   initLifetime,
                                                   acceptLifetime,
                                                   mech,
                                                   usage);
        /*
         * Not all mechanisms support the concept of one credential element
         * that can be used for both initiating and accepting a context. In
         * the event that an application requests usage INITIATE_AND_ACCEPT
         * for a credential from such a mechanism, the GSS framework will
         * need to obtain two different credential elements from the
         * mechanism, one that will have usage INITIATE_ONLY and another
         * that will have usage ACCEPT_ONLY. The mechanism will help the
         * GSS-API realize this by returning a credential element with
         * usage INITIATE_ONLY or ACCEPT_ONLY prompting it to make another
         * call to getCredentialElement, this time with the other usage
         * mode.
         */

<span class="pc bpc" id="L446" title="1 of 2 branches missed.">        if (tempCred != null) {</span>
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">            if (usage == GSSCredential.INITIATE_AND_ACCEPT &amp;&amp;</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">                (!tempCred.isAcceptorCredential() ||</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">                !tempCred.isInitiatorCredential())) {</span>

                int currentUsage;
                int desiredUsage;

<span class="nc bnc" id="L454" title="All 2 branches missed.">                if (!tempCred.isInitiatorCredential()) {</span>
<span class="nc" id="L455">                    currentUsage = GSSCredential.ACCEPT_ONLY;</span>
<span class="nc" id="L456">                    desiredUsage = GSSCredential.INITIATE_ONLY;</span>
                } else {
<span class="nc" id="L458">                    currentUsage = GSSCredential.INITIATE_ONLY;</span>
<span class="nc" id="L459">                    desiredUsage = GSSCredential.ACCEPT_ONLY;</span>
                }

<span class="nc" id="L462">                key = new SearchKey(mech, currentUsage);</span>
<span class="nc" id="L463">                hashtable.put(key, tempCred);</span>

<span class="nc" id="L465">                tempCred = gssManager.getCredentialElement(nameElement,</span>
                                                        initLifetime,
                                                        acceptLifetime,
                                                        mech,
                                                        desiredUsage);

<span class="nc" id="L471">                key = new SearchKey(mech, desiredUsage);</span>
<span class="nc" id="L472">                hashtable.put(key, tempCred);</span>
<span class="nc" id="L473">            } else {</span>
<span class="fc" id="L474">                hashtable.put(key, tempCred);</span>
            }
        }
<span class="fc" id="L477">    }</span>

    public boolean equals(Object another) {

<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L482">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (this == another) {</span>
<span class="nc" id="L487">            return true;</span>
        }

<span class="nc bnc" id="L490" title="All 2 branches missed.">        if (!(another instanceof GSSCredentialImpl)) {</span>
<span class="nc" id="L491">            return false;</span>
        }

        // NOTE: The specification does not define the criteria to compare
        // credentials.
        /*
         * XXX
         * The RFC says: &quot;Tests if this GSSCredential refers to the same
         * entity as the supplied object.  The two credentials must be
         * acquired over the same mechanisms and must refer to the same
         * principal.  Returns &quot;true&quot; if the two GSSCredentials refer to
         * the same entity; &quot;false&quot; otherwise.&quot;
         *
         * Well, when do two credentials refer to the same principal? Do
         * they need to have one GSSName in common for the different
         * GSSName's that the credential elements return? Or do all
         * GSSName's have to be in common when the names are exported with
         * their respective mechanisms for the credential elements?
         */
<span class="nc" id="L510">        return false;</span>

    }

    /**
     * Returns a hashcode value for this GSSCredential.
     *
     * @return a hashCode value
     */
    public int hashCode() {

<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L522">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

        // NOTE: The specification does not define the criteria to compare
        // credentials.
        /*
         * XXX
         * Decide on a criteria for equals first then do this.
         */
<span class="nc" id="L532">        return 1;</span>
    }

    /**
     * Returns the specified mechanism's credential-element.
     *
     * @param mechOid - the oid for mechanism to retrieve
     * @param throwExcep - boolean indicating if the function is
     *    to throw exception or return null when element is not
     *    found.
     * @return mechanism credential object
     * @exception GSSException of invalid mechanism
     */
    public GSSCredentialSpi getElement(Oid mechOid, boolean initiate)
        throws GSSException {

<span class="pc bpc" id="L548" title="1 of 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L549">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

        SearchKey key;
        GSSCredentialSpi element;

<span class="pc bpc" id="L556" title="1 of 2 branches missed.">        if (mechOid == null) {</span>
            /*
             * First see if the default mechanism satisfies the
             * desired usage.
             */
<span class="nc" id="L561">            mechOid = ProviderList.DEFAULT_MECH_OID;</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">            key = new SearchKey(mechOid,</span>
                                 initiate? INITIATE_ONLY : ACCEPT_ONLY);
<span class="nc" id="L564">            element = hashtable.get(key);</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">            if (element == null) {</span>
<span class="nc" id="L566">                key = new SearchKey(mechOid, INITIATE_AND_ACCEPT);</span>
<span class="nc" id="L567">                element = hashtable.get(key);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">                if (element == null) {</span>
                    /*
                     * Now just return any element that satisfies the
                     * desired usage.
                     */
<span class="nc" id="L573">                    Object[] elements = hashtable.entrySet().toArray();</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">                    for (int i = 0; i &lt; elements.length; i++) {</span>
<span class="nc" id="L575">                        element = (GSSCredentialSpi)</span>
<span class="nc" id="L576">                            ((Map.Entry)elements[i]).getValue();</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">                        if (element.isInitiatorCredential() == initiate)</span>
<span class="nc" id="L578">                            break;</span>
                    } // for loop
<span class="nc" id="L580">                }</span>
            }
        } else {

<span class="fc bfc" id="L584" title="All 2 branches covered.">            if (initiate)</span>
<span class="fc" id="L585">                key = new SearchKey(mechOid, INITIATE_ONLY);</span>
            else
<span class="fc" id="L587">                key = new SearchKey(mechOid, ACCEPT_ONLY);</span>

<span class="fc" id="L589">            element = hashtable.get(key);</span>

<span class="pc bpc" id="L591" title="1 of 2 branches missed.">            if (element == null) {</span>
<span class="nc" id="L592">                key = new SearchKey(mechOid, INITIATE_AND_ACCEPT);</span>
<span class="nc" id="L593">                element = hashtable.get(key);</span>
            }
        }

<span class="pc bpc" id="L597" title="1 of 2 branches missed.">        if (element == null)</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">            throw new GSSExceptionImpl(GSSException.NO_CRED,</span>
                                       &quot;No credential found for: &quot; +
<span class="nc" id="L600">                                       getElementStr(mechOid,</span>
                                       initiate? INITIATE_ONLY : ACCEPT_ONLY));
<span class="fc" id="L602">        return element;</span>
    }

    Set&lt;GSSCredentialSpi&gt; getElements() {
<span class="nc" id="L606">        HashSet&lt;GSSCredentialSpi&gt; retVal =</span>
<span class="nc" id="L607">                        new HashSet&lt;GSSCredentialSpi&gt;(hashtable.size());</span>
<span class="nc" id="L608">        Enumeration&lt;GSSCredentialSpi&gt; values = hashtable.elements();</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">        while (values.hasMoreElements()) {</span>
<span class="nc" id="L610">            GSSCredentialSpi o = values.nextElement();</span>
<span class="nc" id="L611">            retVal.add(o);</span>
<span class="nc" id="L612">        }</span>
<span class="nc" id="L613">        return retVal;</span>
    }

    private static String getElementStr(Oid mechOid, int usage) {
<span class="nc" id="L617">        String displayString = mechOid.toString();</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (usage == GSSCredential.INITIATE_ONLY) {</span>
<span class="nc" id="L619">            displayString =</span>
<span class="nc" id="L620">                displayString.concat(&quot; usage: Initiate&quot;);</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">        } else if (usage == GSSCredential.ACCEPT_ONLY) {</span>
<span class="nc" id="L622">            displayString =</span>
<span class="nc" id="L623">                displayString.concat(&quot; usage: Accept&quot;);</span>
        } else {
<span class="nc" id="L625">            displayString =</span>
<span class="nc" id="L626">                displayString.concat(&quot; usage: Initiate and Accept&quot;);</span>
        }
<span class="nc" id="L628">        return displayString;</span>
    }

    public String toString() {

<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (destroyed) {</span>
<span class="nc" id="L634">            throw new IllegalStateException(&quot;This credential is &quot; +</span>
                                        &quot;no longer valid&quot;);
        }

<span class="nc" id="L638">        GSSCredentialSpi element = null;</span>
<span class="nc" id="L639">        StringBuffer buffer = new StringBuffer(&quot;[GSSCredential: &quot;);</span>
<span class="nc" id="L640">        Object[] elements = hashtable.entrySet().toArray();</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">        for (int i = 0; i &lt; elements.length; i++) {</span>
            try {
<span class="nc" id="L643">                buffer.append('\n');</span>
<span class="nc" id="L644">                element = (GSSCredentialSpi)</span>
<span class="nc" id="L645">                    ((Map.Entry)elements[i]).getValue();</span>
<span class="nc" id="L646">                buffer.append(element.getName());</span>
<span class="nc" id="L647">                buffer.append(' ');</span>
<span class="nc" id="L648">                buffer.append(element.getMechanism());</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">                buffer.append(element.isInitiatorCredential() ?</span>
                              &quot; Initiate&quot; : &quot;&quot;);
<span class="nc bnc" id="L651" title="All 2 branches missed.">                buffer.append(element.isAcceptorCredential() ?</span>
                              &quot; Accept&quot; : &quot;&quot;);
<span class="nc" id="L653">                buffer.append(&quot; [&quot;);</span>
<span class="nc" id="L654">                buffer.append(element.getClass());</span>
<span class="nc" id="L655">                buffer.append(']');</span>
<span class="nc" id="L656">            } catch (GSSException e) {</span>
                // skip to next element
<span class="nc" id="L658">            }</span>
        }
<span class="nc" id="L660">        buffer.append(']');</span>
<span class="nc" id="L661">        return buffer.toString();</span>
    }

    static class SearchKey {
<span class="fc" id="L665">        private Oid mechOid = null;</span>
<span class="fc" id="L666">        private int usage = GSSCredential.INITIATE_AND_ACCEPT;</span>
<span class="fc" id="L667">        public SearchKey(Oid mechOid, int usage) {</span>

<span class="fc" id="L669">            this.mechOid = mechOid;</span>
<span class="fc" id="L670">            this.usage = usage;</span>
<span class="fc" id="L671">        }</span>
        public Oid getMech() {
<span class="nc" id="L673">            return mechOid;</span>
        }
        public int getUsage() {
<span class="nc" id="L676">            return usage;</span>
        }
        public boolean equals(Object other) {
<span class="pc bpc" id="L679" title="1 of 2 branches missed.">            if (! (other instanceof SearchKey))</span>
<span class="nc" id="L680">                return false;</span>
<span class="fc" id="L681">            SearchKey that = (SearchKey) other;</span>
<span class="pc bpc" id="L682" title="2 of 4 branches missed.">            return ((this.mechOid.equals(that.mechOid)) &amp;&amp;</span>
                    (this.usage == that.usage));
        }
        public int hashCode() {
<span class="fc" id="L686">            return mechOid.hashCode();</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>