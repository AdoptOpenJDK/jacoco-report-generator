<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>NameImpl.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">javax.naming</a> &gt; <span class="el_source">NameImpl.java</span></div><h1>NameImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.naming;

import java.util.Locale;
import java.util.Vector;
import java.util.Enumeration;
import java.util.Properties;
import java.util.NoSuchElementException;

/**
  * The implementation class for CompoundName and CompositeName.
  * This class is package private.
  *
  * @author Rosanna Lee
  * @author Scott Seligman
  * @author Aravindan Ranganathan
  * @since 1.3
  */

class NameImpl {
    private static final byte LEFT_TO_RIGHT = 1;
    private static final byte RIGHT_TO_LEFT = 2;
    private static final byte FLAT = 0;

    private Vector&lt;String&gt; components;

<span class="fc" id="L51">    private byte syntaxDirection = LEFT_TO_RIGHT;</span>
<span class="fc" id="L52">    private String syntaxSeparator = &quot;/&quot;;</span>
<span class="fc" id="L53">    private String syntaxSeparator2 = null;</span>
<span class="fc" id="L54">    private boolean syntaxCaseInsensitive = false;</span>
<span class="fc" id="L55">    private boolean syntaxTrimBlanks = false;</span>
<span class="fc" id="L56">    private String syntaxEscape = &quot;\\&quot;;</span>
<span class="fc" id="L57">    private String syntaxBeginQuote1 = &quot;\&quot;&quot;;</span>
<span class="fc" id="L58">    private String syntaxEndQuote1 = &quot;\&quot;&quot;;</span>
<span class="fc" id="L59">    private String syntaxBeginQuote2 = &quot;'&quot;;</span>
<span class="fc" id="L60">    private String syntaxEndQuote2 = &quot;'&quot;;</span>
<span class="fc" id="L61">    private String syntaxAvaSeparator = null;</span>
<span class="fc" id="L62">    private String syntaxTypevalSeparator = null;</span>

    // escapingStyle gives the method used at creation time for
    // quoting or escaping characters in the name.  It is set to the
    // first style of quote or escape encountered if and when the name
    // is parsed.
    private static final int STYLE_NONE = 0;
    private static final int STYLE_QUOTE1 = 1;
    private static final int STYLE_QUOTE2 = 2;
    private static final int STYLE_ESCAPE = 3;
<span class="fc" id="L72">    private int escapingStyle = STYLE_NONE;</span>

    // Returns true if &quot;match&quot; is not null, and n contains &quot;match&quot; at
    // position i.
    private final boolean isA(String n, int i, String match) {
<span class="fc bfc" id="L77" title="All 4 branches covered.">        return (match != null &amp;&amp; n.startsWith(match, i));</span>
    }

    private final boolean isMeta(String n, int i) {
<span class="nc bnc" id="L81" title="All 2 branches missed.">        return (isA(n, i, syntaxEscape) ||</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                isA(n, i, syntaxBeginQuote1) ||</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                isA(n, i, syntaxBeginQuote2) ||</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                isSeparator(n, i));</span>
    }

    private final boolean isSeparator(String n, int i) {
<span class="fc bfc" id="L88" title="All 2 branches covered.">        return (isA(n, i, syntaxSeparator) ||</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">                isA(n, i, syntaxSeparator2));</span>
    }

    private final int skipSeparator(String name, int i) {
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        if (isA(name, i, syntaxSeparator)) {</span>
<span class="fc" id="L94">            i += syntaxSeparator.length();</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        } else if (isA(name, i, syntaxSeparator2)) {</span>
<span class="nc" id="L96">            i += syntaxSeparator2.length();</span>
        }
<span class="fc" id="L98">        return (i);</span>
    }

    private final int extractComp(String name, int i, int len, Vector&lt;String&gt; comps)
    throws InvalidNameException {
        String beginQuote;
        String endQuote;
<span class="fc" id="L105">        boolean start = true;</span>
<span class="fc" id="L106">        boolean one = false;</span>
<span class="fc" id="L107">        StringBuffer answer = new StringBuffer(len);</span>

<span class="fc bfc" id="L109" title="All 2 branches covered.">        while (i &lt; len) {</span>
            // handle quoted strings
<span class="pc bpc" id="L111" title="1 of 4 branches missed.">            if (start &amp;&amp; ((one = isA(name, i, syntaxBeginQuote1)) ||</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">                          isA(name, i, syntaxBeginQuote2))) {</span>

                // record choice of quote chars being used
<span class="nc bnc" id="L115" title="All 2 branches missed.">                beginQuote = one ? syntaxBeginQuote1 : syntaxBeginQuote2;</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                endQuote = one ? syntaxEndQuote1 : syntaxEndQuote2;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (escapingStyle == STYLE_NONE) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                    escapingStyle = one ? STYLE_QUOTE1 : STYLE_QUOTE2;</span>
                }

                // consume string until matching quote
<span class="nc" id="L122">                for (i += beginQuote.length();</span>
<span class="nc bnc" id="L123" title="All 4 branches missed.">                     ((i &lt; len) &amp;&amp; !name.startsWith(endQuote, i));</span>
<span class="nc" id="L124">                     i++) {</span>
                    // skip escape character if it is escaping ending quote
                    // otherwise leave as is.
<span class="nc bnc" id="L127" title="All 2 branches missed.">                    if (isA(name, i, syntaxEscape) &amp;&amp;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                        isA(name, i + syntaxEscape.length(), endQuote)) {</span>
<span class="nc" id="L129">                        i += syntaxEscape.length();</span>
                    }
<span class="nc" id="L131">                    answer.append(name.charAt(i));  // copy char</span>
                }

                // no ending quote found
<span class="nc bnc" id="L135" title="All 2 branches missed.">                if (i &gt;= len)</span>
<span class="nc" id="L136">                    throw</span>
                        new InvalidNameException(name + &quot;: no close quote&quot;);
//                      new Exception(&quot;no close quote&quot;);

<span class="nc" id="L140">                i += endQuote.length();</span>

                // verify that end-quote occurs at separator or end of string
<span class="nc bnc" id="L143" title="All 4 branches missed.">                if (i == len || isSeparator(name, i)) {</span>
<span class="nc" id="L144">                    break;</span>
                }
//              throw (new Exception(
<span class="nc" id="L147">                throw (new InvalidNameException(name +</span>
                    &quot;: close quote appears before end of component&quot;));

<span class="fc bfc" id="L150" title="All 2 branches covered.">            } else if (isSeparator(name, i)) {</span>
<span class="fc" id="L151">                break;</span>

<span class="pc bpc" id="L153" title="1 of 2 branches missed.">            } else if (isA(name, i, syntaxEscape)) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                if (isMeta(name, i + syntaxEscape.length())) {</span>
                    // if escape precedes meta, consume escape and let
                    // meta through
<span class="nc" id="L157">                    i += syntaxEscape.length();</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                    if (escapingStyle == STYLE_NONE) {</span>
<span class="nc" id="L159">                        escapingStyle = STYLE_ESCAPE;</span>
                    }
<span class="nc bnc" id="L161" title="All 2 branches missed.">                } else if (i + syntaxEscape.length() &gt;= len) {</span>
<span class="nc" id="L162">                    throw (new InvalidNameException(name +</span>
                        &quot;: unescaped &quot; + syntaxEscape + &quot; at end of component&quot;));
                }
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">            } else if (isA(name, i, syntaxTypevalSeparator) &amp;&amp;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        ((one = isA(name, i+syntaxTypevalSeparator.length(), syntaxBeginQuote1)) ||</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            isA(name, i+syntaxTypevalSeparator.length(), syntaxBeginQuote2))) {</span>
                // Handle quote occurring after typeval separator
<span class="nc bnc" id="L169" title="All 2 branches missed.">                beginQuote = one ? syntaxBeginQuote1 : syntaxBeginQuote2;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                endQuote = one ? syntaxEndQuote1 : syntaxEndQuote2;</span>

<span class="nc" id="L172">                i += syntaxTypevalSeparator.length();</span>
<span class="nc" id="L173">                answer.append(syntaxTypevalSeparator+beginQuote); // add back</span>

                // consume string until matching quote
<span class="nc" id="L176">                for (i += beginQuote.length();</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">                     ((i &lt; len) &amp;&amp; !name.startsWith(endQuote, i));</span>
<span class="nc" id="L178">                     i++) {</span>
                    // skip escape character if it is escaping ending quote
                    // otherwise leave as is.
<span class="nc bnc" id="L181" title="All 2 branches missed.">                    if (isA(name, i, syntaxEscape) &amp;&amp;</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                        isA(name, i + syntaxEscape.length(), endQuote)) {</span>
<span class="nc" id="L183">                        i += syntaxEscape.length();</span>
                    }
<span class="nc" id="L185">                    answer.append(name.charAt(i));  // copy char</span>
                }

                // no ending quote found
<span class="nc bnc" id="L189" title="All 2 branches missed.">                if (i &gt;= len)</span>
<span class="nc" id="L190">                    throw</span>
                        new InvalidNameException(name + &quot;: typeval no close quote&quot;);

<span class="nc" id="L193">                i += endQuote.length();</span>
<span class="nc" id="L194">                answer.append(endQuote); // add back</span>

                // verify that end-quote occurs at separator or end of string
<span class="nc bnc" id="L197" title="All 4 branches missed.">                if (i == len || isSeparator(name, i)) {</span>
<span class="nc" id="L198">                    break;</span>
                }
<span class="nc" id="L200">                throw (new InvalidNameException(name.substring(i) +</span>
                    &quot;: typeval close quote appears before end of component&quot;));
            }

<span class="fc" id="L204">            answer.append(name.charAt(i++));</span>
<span class="fc" id="L205">            start = false;</span>
        }

<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (syntaxDirection == RIGHT_TO_LEFT)</span>
<span class="nc" id="L209">            comps.insertElementAt(answer.toString(), 0);</span>
        else
<span class="fc" id="L211">            comps.addElement(answer.toString());</span>
<span class="fc" id="L212">        return i;</span>
    }

    private static boolean getBoolean(Properties p, String name) {
<span class="nc" id="L216">        return toBoolean(p.getProperty(name));</span>
    }

    private static boolean toBoolean(String name) {
<span class="nc bnc" id="L220" title="All 2 branches missed.">        return ((name != null) &amp;&amp;</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            name.toLowerCase(Locale.ENGLISH).equals(&quot;true&quot;));</span>
    }

    private final void recordNamingConvention(Properties p) {
<span class="nc" id="L225">        String syntaxDirectionStr =</span>
<span class="nc" id="L226">            p.getProperty(&quot;jndi.syntax.direction&quot;, &quot;flat&quot;);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (syntaxDirectionStr.equals(&quot;left_to_right&quot;)) {</span>
<span class="nc" id="L228">            syntaxDirection = LEFT_TO_RIGHT;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">        } else if (syntaxDirectionStr.equals(&quot;right_to_left&quot;)) {</span>
<span class="nc" id="L230">            syntaxDirection = RIGHT_TO_LEFT;</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">        } else if (syntaxDirectionStr.equals(&quot;flat&quot;)) {</span>
<span class="nc" id="L232">            syntaxDirection = FLAT;</span>
        } else {
<span class="nc" id="L234">            throw new IllegalArgumentException(syntaxDirectionStr +</span>
                &quot;is not a valid value for the jndi.syntax.direction property&quot;);
        }

<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (syntaxDirection != FLAT) {</span>
<span class="nc" id="L239">            syntaxSeparator = p.getProperty(&quot;jndi.syntax.separator&quot;);</span>
<span class="nc" id="L240">            syntaxSeparator2 = p.getProperty(&quot;jndi.syntax.separator2&quot;);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            if (syntaxSeparator == null) {</span>
<span class="nc" id="L242">                throw new IllegalArgumentException(</span>
                    &quot;jndi.syntax.separator property required for non-flat syntax&quot;);
            }
        } else {
<span class="nc" id="L246">            syntaxSeparator = null;</span>
        }
<span class="nc" id="L248">        syntaxEscape = p.getProperty(&quot;jndi.syntax.escape&quot;);</span>

<span class="nc" id="L250">        syntaxCaseInsensitive = getBoolean(p, &quot;jndi.syntax.ignorecase&quot;);</span>
<span class="nc" id="L251">        syntaxTrimBlanks = getBoolean(p, &quot;jndi.syntax.trimblanks&quot;);</span>

<span class="nc" id="L253">        syntaxBeginQuote1 = p.getProperty(&quot;jndi.syntax.beginquote&quot;);</span>
<span class="nc" id="L254">        syntaxEndQuote1 = p.getProperty(&quot;jndi.syntax.endquote&quot;);</span>
<span class="nc bnc" id="L255" title="All 4 branches missed.">        if (syntaxEndQuote1 == null &amp;&amp; syntaxBeginQuote1 != null)</span>
<span class="nc" id="L256">            syntaxEndQuote1 = syntaxBeginQuote1;</span>
<span class="nc bnc" id="L257" title="All 4 branches missed.">        else if (syntaxBeginQuote1 == null &amp;&amp; syntaxEndQuote1 != null)</span>
<span class="nc" id="L258">            syntaxBeginQuote1 = syntaxEndQuote1;</span>
<span class="nc" id="L259">        syntaxBeginQuote2 = p.getProperty(&quot;jndi.syntax.beginquote2&quot;);</span>
<span class="nc" id="L260">        syntaxEndQuote2 = p.getProperty(&quot;jndi.syntax.endquote2&quot;);</span>
<span class="nc bnc" id="L261" title="All 4 branches missed.">        if (syntaxEndQuote2 == null &amp;&amp; syntaxBeginQuote2 != null)</span>
<span class="nc" id="L262">            syntaxEndQuote2 = syntaxBeginQuote2;</span>
<span class="nc bnc" id="L263" title="All 4 branches missed.">        else if (syntaxBeginQuote2 == null &amp;&amp; syntaxEndQuote2 != null)</span>
<span class="nc" id="L264">            syntaxBeginQuote2 = syntaxEndQuote2;</span>

<span class="nc" id="L266">        syntaxAvaSeparator = p.getProperty(&quot;jndi.syntax.separator.ava&quot;);</span>
<span class="nc" id="L267">        syntaxTypevalSeparator =</span>
<span class="nc" id="L268">            p.getProperty(&quot;jndi.syntax.separator.typeval&quot;);</span>
<span class="nc" id="L269">    }</span>

<span class="fc" id="L271">    NameImpl(Properties syntax) {</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">        if (syntax != null) {</span>
<span class="nc" id="L273">            recordNamingConvention(syntax);</span>
        }
<span class="fc" id="L275">        components = new Vector&lt;&gt;();</span>
<span class="fc" id="L276">    }</span>

    NameImpl(Properties syntax, String n) throws InvalidNameException {
<span class="fc" id="L279">        this(syntax);</span>

<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        boolean rToL = (syntaxDirection == RIGHT_TO_LEFT);</span>
<span class="fc" id="L282">        boolean compsAllEmpty = true;</span>
<span class="fc" id="L283">        int len = n.length();</span>

<span class="fc bfc" id="L285" title="All 2 branches covered.">        for (int i = 0; i &lt; len; ) {</span>
<span class="fc" id="L286">            i = extractComp(n, i, len, components);</span>

<span class="pc bpc" id="L288" title="1 of 2 branches missed.">            String comp = rToL</span>
<span class="pc" id="L289">                ? components.firstElement()</span>
<span class="fc" id="L290">                : components.lastElement();</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">            if (comp.length() &gt;= 1) {</span>
<span class="fc" id="L292">                compsAllEmpty = false;</span>
            }

<span class="fc bfc" id="L295" title="All 2 branches covered.">            if (i &lt; len) {</span>
<span class="fc" id="L296">                i = skipSeparator(n, i);</span>
<span class="pc bpc" id="L297" title="2 of 4 branches missed.">                if ((i == len) &amp;&amp; !compsAllEmpty) {</span>
                    // Trailing separator found.  Add an empty component.
<span class="nc bnc" id="L299" title="All 2 branches missed.">                    if (rToL) {</span>
<span class="nc" id="L300">                        components.insertElementAt(&quot;&quot;, 0);</span>
                    } else {
<span class="nc" id="L302">                        components.addElement(&quot;&quot;);</span>
                    }
                }
            }
<span class="fc" id="L306">        }</span>
<span class="fc" id="L307">    }</span>

    NameImpl(Properties syntax, Enumeration&lt;String&gt; comps) {
<span class="fc" id="L310">        this(syntax);</span>

        // %% comps could shrink in the middle.
<span class="fc bfc" id="L313" title="All 2 branches covered.">        while (comps.hasMoreElements())</span>
<span class="fc" id="L314">            components.addElement(comps.nextElement());</span>
<span class="fc" id="L315">    }</span>
/*
    // Determines whether this component needs any escaping.
    private final boolean escapingNeeded(String comp) {
        int len = comp.length();
        for (int i = 0; i &lt; len; i++) {
            if (i == 0) {
                if (isA(comp, 0, syntaxBeginQuote1) ||
                    isA(comp, 0, syntaxBeginQuote2)) {
                    return (true);
                }
            }
            if (isSeparator(comp, i)) {
                return (true);
            }
            if (isA(comp, i, syntaxEscape)) {
                i += syntaxEscape.length();
                if (i &gt;= len || isMeta(comp, i)) {
                    return (true);
                }
            }
        }
        return (false);
    }
*/
    private final String stringifyComp(String comp) {
<span class="fc" id="L341">        int len = comp.length();</span>
<span class="fc" id="L342">        boolean escapeSeparator = false, escapeSeparator2 = false;</span>
<span class="fc" id="L343">        String beginQuote = null, endQuote = null;</span>
<span class="fc" id="L344">        StringBuffer strbuf = new StringBuffer(len);</span>

        // determine whether there are any separators; if so escape
        // or quote them
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">        if (syntaxSeparator != null &amp;&amp;</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">            comp.indexOf(syntaxSeparator) &gt;= 0) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">            if (syntaxBeginQuote1 != null) {</span>
<span class="nc" id="L351">                beginQuote = syntaxBeginQuote1;</span>
<span class="nc" id="L352">                endQuote = syntaxEndQuote1;</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">            } else if (syntaxBeginQuote2 != null) {</span>
<span class="nc" id="L354">                beginQuote = syntaxBeginQuote2;</span>
<span class="nc" id="L355">                endQuote = syntaxEndQuote2;</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">            } else if (syntaxEscape != null)</span>
<span class="nc" id="L357">                escapeSeparator = true;</span>
        }
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">        if (syntaxSeparator2 != null &amp;&amp;</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            comp.indexOf(syntaxSeparator2) &gt;= 0) {</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">            if (syntaxBeginQuote1 != null) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                if (beginQuote == null) {</span>
<span class="nc" id="L363">                    beginQuote = syntaxBeginQuote1;</span>
<span class="nc" id="L364">                    endQuote = syntaxEndQuote1;</span>
                }
<span class="nc bnc" id="L366" title="All 2 branches missed.">            } else if (syntaxBeginQuote2 != null) {</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                if (beginQuote == null) {</span>
<span class="nc" id="L368">                    beginQuote = syntaxBeginQuote2;</span>
<span class="nc" id="L369">                    endQuote = syntaxEndQuote2;</span>
                }
<span class="nc bnc" id="L371" title="All 2 branches missed.">            } else if (syntaxEscape != null)</span>
<span class="nc" id="L372">                escapeSeparator2 = true;</span>
        }

        // if quoting component,
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">        if (beginQuote != null) {</span>

            // start string off with opening quote
<span class="nc" id="L379">            strbuf = strbuf.append(beginQuote);</span>

            // component is being quoted, so we only need to worry about
            // escaping end quotes that occur in component
<span class="nc bnc" id="L383" title="All 2 branches missed.">            for (int i = 0; i &lt; len; ) {</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">                if (comp.startsWith(endQuote, i)) {</span>
                    // end-quotes must be escaped when inside a quoted string
<span class="nc" id="L386">                    strbuf.append(syntaxEscape).append(endQuote);</span>
<span class="nc" id="L387">                    i += endQuote.length();</span>
                } else {
                    // no special treatment required
<span class="nc" id="L390">                    strbuf.append(comp.charAt(i++));</span>
                }
            }

            // end with closing quote
<span class="nc" id="L395">            strbuf.append(endQuote);</span>

        } else {

            // When component is not quoted, add escape for:
            // 1. leading quote
            // 2. an escape preceding any meta char
            // 3. an escape at the end of a component
            // 4. separator

            // go through characters in component and escape where necessary
<span class="fc" id="L406">            boolean start = true;</span>
<span class="fc bfc" id="L407" title="All 2 branches covered.">            for (int i = 0; i &lt; len; ) {</span>
                // leading quote must be escaped
<span class="pc bpc" id="L409" title="1 of 4 branches missed.">                if (start &amp;&amp; isA(comp, i, syntaxBeginQuote1)) {</span>
<span class="nc" id="L410">                    strbuf.append(syntaxEscape).append(syntaxBeginQuote1);</span>
<span class="nc" id="L411">                    i += syntaxBeginQuote1.length();</span>
<span class="pc bpc" id="L412" title="1 of 4 branches missed.">                } else if (start &amp;&amp; isA(comp, i, syntaxBeginQuote2)) {</span>
<span class="nc" id="L413">                    strbuf.append(syntaxEscape).append(syntaxBeginQuote2);</span>
<span class="nc" id="L414">                    i += syntaxBeginQuote2.length();</span>
                } else

                // Escape an escape preceding meta characters, or at end.
                // Other escapes pass through.
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">                if (isA(comp, i, syntaxEscape)) {</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">                    if (i + syntaxEscape.length() &gt;= len) {</span>
                        // escape an ending escape
<span class="nc" id="L422">                        strbuf.append(syntaxEscape);</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">                    } else if (isMeta(comp, i + syntaxEscape.length())) {</span>
                        // escape meta strings
<span class="nc" id="L425">                        strbuf.append(syntaxEscape);</span>
                    }
<span class="nc" id="L427">                    strbuf.append(syntaxEscape);</span>
<span class="nc" id="L428">                    i += syntaxEscape.length();</span>
                } else

                // escape unescaped separator
<span class="pc bpc" id="L432" title="3 of 4 branches missed.">                if (escapeSeparator &amp;&amp; comp.startsWith(syntaxSeparator, i)) {</span>
                    // escape separator
<span class="nc" id="L434">                    strbuf.append(syntaxEscape).append(syntaxSeparator);</span>
<span class="nc" id="L435">                    i += syntaxSeparator.length();</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">                } else if (escapeSeparator2 &amp;&amp;</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">                           comp.startsWith(syntaxSeparator2, i)) {</span>
                    // escape separator2
<span class="nc" id="L439">                    strbuf.append(syntaxEscape).append(syntaxSeparator2);</span>
<span class="nc" id="L440">                    i += syntaxSeparator2.length();</span>
                } else {
                    // no special treatment required
<span class="fc" id="L443">                    strbuf.append(comp.charAt(i++));</span>
                }
<span class="fc" id="L445">                start = false;</span>
            }
        }
<span class="fc" id="L448">        return (strbuf.toString());</span>
    }

    public String toString() {
<span class="fc" id="L452">        StringBuffer answer = new StringBuffer();</span>
        String comp;
<span class="fc" id="L454">        boolean compsAllEmpty = true;</span>
<span class="fc" id="L455">        int size = components.size();</span>

<span class="fc bfc" id="L457" title="All 2 branches covered.">        for (int i = 0; i &lt; size; i++) {</span>
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">            if (syntaxDirection == RIGHT_TO_LEFT) {</span>
<span class="nc" id="L459">                comp =</span>
<span class="nc" id="L460">                    stringifyComp(components.elementAt(size - 1 - i));</span>
            } else {
<span class="fc" id="L462">                comp = stringifyComp(components.elementAt(i));</span>
            }
<span class="pc bpc" id="L464" title="3 of 4 branches missed.">            if ((i != 0) &amp;&amp; (syntaxSeparator != null))</span>
<span class="nc" id="L465">                answer.append(syntaxSeparator);</span>
<span class="pc bpc" id="L466" title="1 of 2 branches missed.">            if (comp.length() &gt;= 1)</span>
<span class="fc" id="L467">                compsAllEmpty = false;</span>
<span class="fc" id="L468">            answer = answer.append(comp);</span>
        }
<span class="pc bpc" id="L470" title="5 of 6 branches missed.">        if (compsAllEmpty &amp;&amp; (size &gt;= 1) &amp;&amp; (syntaxSeparator != null))</span>
<span class="nc" id="L471">            answer = answer.append(syntaxSeparator);</span>
<span class="fc" id="L472">        return (answer.toString());</span>
    }

    public boolean equals(Object obj) {
<span class="nc bnc" id="L476" title="All 4 branches missed.">        if ((obj != null) &amp;&amp; (obj instanceof NameImpl)) {</span>
<span class="nc" id="L477">            NameImpl target = (NameImpl)obj;</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">            if (target.size() ==  this.size()) {</span>
<span class="nc" id="L479">                Enumeration&lt;String&gt; mycomps = getAll();</span>
<span class="nc" id="L480">                Enumeration&lt;String&gt; comps = target.getAll();</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">                while (mycomps.hasMoreElements()) {</span>
                    // %% comps could shrink in the middle.
<span class="nc" id="L483">                    String my = mycomps.nextElement();</span>
<span class="nc" id="L484">                    String his = comps.nextElement();</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                    if (syntaxTrimBlanks) {</span>
<span class="nc" id="L486">                        my = my.trim();</span>
<span class="nc" id="L487">                        his = his.trim();</span>
                    }
<span class="nc bnc" id="L489" title="All 2 branches missed.">                    if (syntaxCaseInsensitive) {</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">                        if (!(my.equalsIgnoreCase(his)))</span>
<span class="nc" id="L491">                            return false;</span>
                    } else {
<span class="nc bnc" id="L493" title="All 2 branches missed.">                        if (!(my.equals(his)))</span>
<span class="nc" id="L494">                            return false;</span>
                    }
<span class="nc" id="L496">                }</span>
<span class="nc" id="L497">                return true;</span>
            }
        }
<span class="nc" id="L500">        return false;</span>
    }

    /**
      * Compares obj to this NameImpl to determine ordering.
      * Takes into account syntactic properties such as
      * elimination of blanks, case-ignore, etc, if relevant.
      *
      * Note: using syntax of this NameImpl and ignoring
      * that of comparison target.
      */
    public int compareTo(NameImpl obj) {
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (this == obj) {</span>
<span class="nc" id="L513">            return 0;</span>
        }

<span class="nc" id="L516">        int len1 = size();</span>
<span class="nc" id="L517">        int len2 = obj.size();</span>
<span class="nc" id="L518">        int n = Math.min(len1, len2);</span>

<span class="nc" id="L520">        int index1 = 0, index2 = 0;</span>

<span class="nc bnc" id="L522" title="All 2 branches missed.">        while (n-- != 0) {</span>
<span class="nc" id="L523">            String comp1 = get(index1++);</span>
<span class="nc" id="L524">            String comp2 = obj.get(index2++);</span>

            // normalize according to syntax
<span class="nc bnc" id="L527" title="All 2 branches missed.">            if (syntaxTrimBlanks) {</span>
<span class="nc" id="L528">                comp1 = comp1.trim();</span>
<span class="nc" id="L529">                comp2 = comp2.trim();</span>
            }

            int local;
<span class="nc bnc" id="L533" title="All 2 branches missed.">            if (syntaxCaseInsensitive) {</span>
<span class="nc" id="L534">                local = comp1.compareToIgnoreCase(comp2);</span>
            } else {
<span class="nc" id="L536">                local = comp1.compareTo(comp2);</span>
            }

<span class="nc bnc" id="L539" title="All 2 branches missed.">            if (local != 0) {</span>
<span class="nc" id="L540">                return local;</span>
            }
<span class="nc" id="L542">        }</span>

<span class="nc" id="L544">        return len1 - len2;</span>
    }

    public int size() {
<span class="fc" id="L548">        return (components.size());</span>
    }

    public Enumeration&lt;String&gt; getAll() {
<span class="fc" id="L552">        return components.elements();</span>
    }

    public String get(int posn) {
<span class="fc" id="L556">        return components.elementAt(posn);</span>
    }

    public Enumeration&lt;String&gt; getPrefix(int posn) {
<span class="pc bpc" id="L560" title="2 of 4 branches missed.">        if (posn &lt; 0 || posn &gt; size()) {</span>
<span class="nc" id="L561">            throw new ArrayIndexOutOfBoundsException(posn);</span>
        }
<span class="fc" id="L563">        return new NameImplEnumerator(components, 0, posn);</span>
    }

    public Enumeration&lt;String&gt; getSuffix(int posn) {
<span class="fc" id="L567">        int cnt = size();</span>
<span class="pc bpc" id="L568" title="2 of 4 branches missed.">        if (posn &lt; 0 || posn &gt; cnt) {</span>
<span class="nc" id="L569">            throw new ArrayIndexOutOfBoundsException(posn);</span>
        }
<span class="fc" id="L571">        return new NameImplEnumerator(components, posn, cnt);</span>
    }

    public boolean isEmpty() {
<span class="fc" id="L575">        return (components.isEmpty());</span>
    }

    public boolean startsWith(int posn, Enumeration&lt;String&gt; prefix) {
<span class="nc bnc" id="L579" title="All 4 branches missed.">        if (posn &lt; 0 || posn &gt; size()) {</span>
<span class="nc" id="L580">            return false;</span>
        }
        try {
<span class="nc" id="L583">            Enumeration&lt;String&gt; mycomps = getPrefix(posn);</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">            while (mycomps.hasMoreElements()) {</span>
<span class="nc" id="L585">                String my = mycomps.nextElement();</span>
<span class="nc" id="L586">                String his = prefix.nextElement();</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">                if (syntaxTrimBlanks) {</span>
<span class="nc" id="L588">                    my = my.trim();</span>
<span class="nc" id="L589">                    his = his.trim();</span>
                }
<span class="nc bnc" id="L591" title="All 2 branches missed.">                if (syntaxCaseInsensitive) {</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">                    if (!(my.equalsIgnoreCase(his)))</span>
<span class="nc" id="L593">                        return false;</span>
                } else {
<span class="nc bnc" id="L595" title="All 2 branches missed.">                    if (!(my.equals(his)))</span>
<span class="nc" id="L596">                        return false;</span>
                }
<span class="nc" id="L598">            }</span>
<span class="nc" id="L599">        } catch (NoSuchElementException e) {</span>
<span class="nc" id="L600">            return false;</span>
<span class="nc" id="L601">        }</span>
<span class="nc" id="L602">        return true;</span>
    }

    public boolean endsWith(int posn, Enumeration&lt;String&gt; suffix) {
        // posn is number of elements in suffix
        // startIndex is the starting position in this name
        // at which to start the comparison. It is calculated by
        // subtracting 'posn' from size()
<span class="nc" id="L610">        int startIndex = size() - posn;</span>
<span class="nc bnc" id="L611" title="All 4 branches missed.">        if (startIndex &lt; 0 || startIndex &gt; size()) {</span>
<span class="nc" id="L612">            return false;</span>
        }
        try {
<span class="nc" id="L615">            Enumeration&lt;String&gt; mycomps = getSuffix(startIndex);</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">            while (mycomps.hasMoreElements()) {</span>
<span class="nc" id="L617">                String my = mycomps.nextElement();</span>
<span class="nc" id="L618">                String his = suffix.nextElement();</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">                if (syntaxTrimBlanks) {</span>
<span class="nc" id="L620">                    my = my.trim();</span>
<span class="nc" id="L621">                    his = his.trim();</span>
                }
<span class="nc bnc" id="L623" title="All 2 branches missed.">                if (syntaxCaseInsensitive) {</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                    if (!(my.equalsIgnoreCase(his)))</span>
<span class="nc" id="L625">                        return false;</span>
                } else {
<span class="nc bnc" id="L627" title="All 2 branches missed.">                    if (!(my.equals(his)))</span>
<span class="nc" id="L628">                        return false;</span>
                }
<span class="nc" id="L630">            }</span>
<span class="nc" id="L631">        } catch (NoSuchElementException e) {</span>
<span class="nc" id="L632">            return false;</span>
<span class="nc" id="L633">        }</span>
<span class="nc" id="L634">        return true;</span>
    }

    public boolean addAll(Enumeration&lt;String&gt; comps) throws InvalidNameException {
<span class="nc" id="L638">        boolean added = false;</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">        while (comps.hasMoreElements()) {</span>
            try {
<span class="nc" id="L641">                String comp = comps.nextElement();</span>
<span class="nc bnc" id="L642" title="All 4 branches missed.">                if (size() &gt; 0 &amp;&amp; syntaxDirection == FLAT) {</span>
<span class="nc" id="L643">                    throw new InvalidNameException(</span>
                        &quot;A flat name can only have a single component&quot;);
                }
<span class="nc" id="L646">                components.addElement(comp);</span>
<span class="nc" id="L647">                added = true;</span>
<span class="nc" id="L648">            } catch (NoSuchElementException e) {</span>
<span class="nc" id="L649">                break;  // &quot;comps&quot; has shrunk.</span>
<span class="nc" id="L650">            }</span>
        }
<span class="nc" id="L652">        return added;</span>
    }

    public boolean addAll(int posn, Enumeration&lt;String&gt; comps)
    throws InvalidNameException {
<span class="nc" id="L657">        boolean added = false;</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">        for (int i = posn; comps.hasMoreElements(); i++) {</span>
            try {
<span class="nc" id="L660">                String comp = comps.nextElement();</span>
<span class="nc bnc" id="L661" title="All 4 branches missed.">                if (size() &gt; 0 &amp;&amp; syntaxDirection == FLAT) {</span>
<span class="nc" id="L662">                    throw new InvalidNameException(</span>
                        &quot;A flat name can only have a single component&quot;);
                }
<span class="nc" id="L665">                components.insertElementAt(comp, i);</span>
<span class="nc" id="L666">                added = true;</span>
<span class="nc" id="L667">            } catch (NoSuchElementException e) {</span>
<span class="nc" id="L668">                break;  // &quot;comps&quot; has shrunk.</span>
<span class="nc" id="L669">            }</span>
        }
<span class="nc" id="L671">        return added;</span>
    }

    public void add(String comp) throws InvalidNameException {
<span class="pc bpc" id="L675" title="3 of 4 branches missed.">        if (size() &gt; 0 &amp;&amp; syntaxDirection == FLAT) {</span>
<span class="nc" id="L676">            throw new InvalidNameException(</span>
                &quot;A flat name can only have a single component&quot;);
        }
<span class="fc" id="L679">        components.addElement(comp);</span>
<span class="fc" id="L680">    }</span>

    public void add(int posn, String comp) throws InvalidNameException {
<span class="nc bnc" id="L683" title="All 4 branches missed.">        if (size() &gt; 0 &amp;&amp; syntaxDirection == FLAT) {</span>
<span class="nc" id="L684">            throw new InvalidNameException(</span>
                &quot;A flat name can only zero or one component&quot;);
        }
<span class="nc" id="L687">        components.insertElementAt(comp, posn);</span>
<span class="nc" id="L688">    }</span>

    public Object remove(int posn) {
<span class="nc" id="L691">        Object r = components.elementAt(posn);</span>
<span class="nc" id="L692">        components.removeElementAt(posn);</span>
<span class="nc" id="L693">        return r;</span>
    }

    public int hashCode() {
<span class="nc" id="L697">        int hash = 0;</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">        for (Enumeration&lt;String&gt; e = getAll(); e.hasMoreElements();) {</span>
<span class="nc" id="L699">            String comp = e.nextElement();</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">            if (syntaxTrimBlanks) {</span>
<span class="nc" id="L701">                comp = comp.trim();</span>
            }
<span class="nc bnc" id="L703" title="All 2 branches missed.">            if (syntaxCaseInsensitive) {</span>
<span class="nc" id="L704">                comp = comp.toLowerCase(Locale.ENGLISH);</span>
            }

<span class="nc" id="L707">            hash += comp.hashCode();</span>
<span class="nc" id="L708">        }</span>
<span class="nc" id="L709">        return hash;</span>
    }
}

final
class NameImplEnumerator implements Enumeration&lt;String&gt; {
    Vector&lt;String&gt; vector;
    int count;
    int limit;

<span class="fc" id="L719">    NameImplEnumerator(Vector&lt;String&gt; v, int start, int lim) {</span>
<span class="fc" id="L720">        vector = v;</span>
<span class="fc" id="L721">        count = start;</span>
<span class="fc" id="L722">        limit = lim;</span>
<span class="fc" id="L723">    }</span>

    public boolean hasMoreElements() {
<span class="fc bfc" id="L726" title="All 2 branches covered.">        return count &lt; limit;</span>
    }

    public String nextElement() {
<span class="pc bpc" id="L730" title="1 of 2 branches missed.">        if (count &lt; limit) {</span>
<span class="fc" id="L731">            return vector.elementAt(count++);</span>
        }
<span class="nc" id="L733">        throw new NoSuchElementException(&quot;NameImplEnumerator&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>