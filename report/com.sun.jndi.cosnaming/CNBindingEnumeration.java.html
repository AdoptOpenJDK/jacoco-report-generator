<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CNBindingEnumeration.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.jndi.cosnaming</a> &gt; <span class="el_source">CNBindingEnumeration.java</span></div><h1>CNBindingEnumeration.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.jndi.cosnaming;

import javax.naming.*;
import javax.naming.spi.NamingManager;

import java.util.NoSuchElementException;
import java.util.Hashtable;

import org.omg.CosNaming.*;

/**
  * Implements the JNDI NamingEnumeration interface for COS
  * Naming. Gets hold of a list of bindings from the COS Naming Server
  * and allows the client to iterate through them.
  *
  * @author Raj Krishnamurthy
  * @author Rosanna Lee
  */

final class CNBindingEnumeration
        implements NamingEnumeration&lt;javax.naming.Binding&gt; {

    private static final int DEFAULT_BATCHSIZE = 100;
    private BindingListHolder _bindingList; // list of bindings
    private BindingIterator _bindingIter;   // iterator for getting list of bindings
    private int counter;                    // pointer in _bindingList
<span class="nc" id="L52">    private int batchsize = DEFAULT_BATCHSIZE;  // how many to ask for each time</span>
    private CNCtx _ctx;                     // ctx to list
    private Hashtable&lt;?,?&gt; _env;            // environment for getObjectInstance
<span class="nc" id="L55">    private boolean more = false;           // iterator done?</span>
<span class="nc" id="L56">    private boolean isLookedUpCtx = false;  // iterating on a context beneath this context ?</span>

    /**
     * Creates a CNBindingEnumeration object.
     * @param ctx Context to enumerate
     */
<span class="nc" id="L62">    CNBindingEnumeration(CNCtx ctx, boolean isLookedUpCtx, Hashtable&lt;?,?&gt; env) {</span>
        // Get batch size to use
<span class="nc bnc" id="L64" title="All 2 branches missed.">        String batch = (env != null ?</span>
<span class="nc" id="L65">            (String)env.get(javax.naming.Context.BATCHSIZE) : null);</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (batch != null) {</span>
            try {
<span class="nc" id="L68">                batchsize = Integer.parseInt(batch);</span>
<span class="nc" id="L69">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L70">                throw new IllegalArgumentException(&quot;Batch size not numeric: &quot; + batch);</span>
<span class="nc" id="L71">            }</span>
        }
<span class="nc" id="L73">        _ctx = ctx;</span>
<span class="nc" id="L74">        _ctx.incEnumCount();</span>
<span class="nc" id="L75">        this.isLookedUpCtx = isLookedUpCtx;</span>
<span class="nc" id="L76">        _env = env;</span>
<span class="nc" id="L77">        _bindingList = new BindingListHolder();</span>
<span class="nc" id="L78">        BindingIteratorHolder _bindingIterH = new BindingIteratorHolder();</span>

        // Perform listing and request that bindings be returned in _bindingIter
        // Upon return,_bindingList returns a zero length list
<span class="nc" id="L82">        _ctx._nc.list(0, _bindingList, _bindingIterH);</span>

<span class="nc" id="L84">        _bindingIter = _bindingIterH.value;</span>

        // Get first batch using _bindingIter
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (_bindingIter != null) {</span>
<span class="nc" id="L88">            more = _bindingIter.next_n(batchsize, _bindingList);</span>
        } else {
<span class="nc" id="L90">            more = false;</span>
        }
<span class="nc" id="L92">        counter = 0;</span>
<span class="nc" id="L93">    }</span>

    /**
     * Returns the next binding in the list.
     * @exception NamingException any naming exception.
     */

    public javax.naming.Binding next() throws NamingException {
<span class="nc bnc" id="L101" title="All 4 branches missed.">        if (more &amp;&amp; counter &gt;= _bindingList.value.length) {</span>
<span class="nc" id="L102">            getMore();</span>
        }
<span class="nc bnc" id="L104" title="All 4 branches missed.">        if (more &amp;&amp; counter &lt; _bindingList.value.length) {</span>
<span class="nc" id="L105">            org.omg.CosNaming.Binding bndg = _bindingList.value[counter];</span>
<span class="nc" id="L106">            counter++;</span>
<span class="nc" id="L107">            return mapBinding(bndg);</span>
        } else {
<span class="nc" id="L109">            throw new NoSuchElementException();</span>
        }
    }


    /**
    * Returns true or false depending on whether there are more bindings.
    * @return boolean value
    */

    public boolean hasMore() throws NamingException {
        // If there's more, check whether current bindingList has been exhausted,
        // and if so, try to get more.
        // If no more, just say so.
<span class="nc bnc" id="L123" title="All 6 branches missed.">        return more ? (counter &lt; _bindingList.value.length || getMore()) : false;</span>
    }

    /**
     * Returns true or false depending on whether there are more bindings.
     * Need to define this to satisfy the Enumeration api requirement.
     * @return boolean value
     */

    public boolean hasMoreElements() {
        try {
<span class="nc" id="L134">            return hasMore();</span>
<span class="nc" id="L135">        } catch (NamingException e) {</span>
<span class="nc" id="L136">            return false;</span>
        }
    }

    /**
    * Returns the next binding in the list.
    * @exception NoSuchElementException Thrown when the end of the
    * list is reached.
    */

    public javax.naming.Binding nextElement() {
        try {
<span class="nc" id="L148">            return next();</span>
<span class="nc" id="L149">        } catch (NamingException ne) {</span>
<span class="nc" id="L150">            throw new NoSuchElementException();</span>
        }
    }

    public void close() throws NamingException {
<span class="nc" id="L155">        more = false;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (_bindingIter != null) {</span>
<span class="nc" id="L157">            _bindingIter.destroy();</span>
<span class="nc" id="L158">            _bindingIter = null;</span>
        }
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (_ctx != null) {</span>
<span class="nc" id="L161">            _ctx.decEnumCount();</span>

            /**
             * context was obtained by CNCtx, the user doesn't have a handle to
             * it, close it as we are done enumerating through the context
             */
<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (isLookedUpCtx) {</span>
<span class="nc" id="L168">                _ctx.close();</span>
            }
<span class="nc" id="L170">            _ctx = null;</span>
        }
<span class="nc" id="L172">    }</span>

    protected void finalize() {
        try {
<span class="nc" id="L176">            close();</span>
<span class="nc" id="L177">        } catch (NamingException e) {</span>
            // ignore failures
<span class="nc" id="L179">        }</span>
<span class="nc" id="L180">    }</span>

    /**
     * Get the next batch using _bindingIter. Update the 'more' field.
     */
    private boolean getMore() throws NamingException {
        try {
<span class="nc" id="L187">            more = _bindingIter.next_n(batchsize, _bindingList);</span>
<span class="nc" id="L188">            counter = 0; // reset</span>
<span class="nc" id="L189">        } catch (Exception e) {</span>
<span class="nc" id="L190">            more = false;</span>
<span class="nc" id="L191">            NamingException ne = new NamingException(</span>
                &quot;Problem getting binding list&quot;);
<span class="nc" id="L193">            ne.setRootCause(e);</span>
<span class="nc" id="L194">            throw ne;</span>
<span class="nc" id="L195">        }</span>
<span class="nc" id="L196">        return more;</span>
    }

    /**
    * Constructs a JNDI Binding object from the COS Naming binding
    * object.
    * @exception NameNotFound No objects under the name.
    * @exception CannotProceed Unable to obtain a continuation context
    * @exception InvalidName Name not understood.
    * @exception NamingException One of the above.
    */

    private javax.naming.Binding mapBinding(org.omg.CosNaming.Binding bndg)
                throws NamingException {
<span class="nc" id="L210">        java.lang.Object obj = _ctx.callResolve(bndg.binding_name);</span>

<span class="nc" id="L212">        Name cname = CNNameParser.cosNameToName(bndg.binding_name);</span>

        try {
<span class="nc" id="L215">            obj = NamingManager.getObjectInstance(obj, cname, _ctx, _env);</span>
<span class="nc" id="L216">        } catch (NamingException e) {</span>
<span class="nc" id="L217">            throw e;</span>
<span class="nc" id="L218">        } catch (Exception e) {</span>
<span class="nc" id="L219">            NamingException ne = new NamingException(</span>
                        &quot;problem generating object using object factory&quot;);
<span class="nc" id="L221">            ne.setRootCause(e);</span>
<span class="nc" id="L222">            throw ne;</span>
<span class="nc" id="L223">        }</span>

        // Use cname.toString() instead of bindingName because the name
        // in the binding should be a composite name
<span class="nc" id="L227">        String cnameStr = cname.toString();</span>
<span class="nc" id="L228">        javax.naming.Binding jbndg = new javax.naming.Binding(cnameStr, obj);</span>

<span class="nc" id="L230">        NameComponent[] comps = _ctx.makeFullName(bndg.binding_name);</span>
<span class="nc" id="L231">        String fullName = CNNameParser.cosNameToInsString(comps);</span>
<span class="nc" id="L232">        jbndg.setNameInNamespace(fullName);</span>
<span class="nc" id="L233">        return jbndg;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>