<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>Main.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.tools.jarsigner</a> &gt; <span class="el_source">Main.java</span></div><h1>Main.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.tools.jarsigner;

import java.io.*;
import java.util.*;
import java.util.zip.*;
import java.util.jar.*;
import java.math.BigInteger;
import java.net.URI;
import java.net.URISyntaxException;
import java.text.Collator;
import java.text.MessageFormat;
import java.security.cert.Certificate;
import java.security.cert.X509Certificate;
import java.security.cert.CertificateException;
import java.security.*;
import java.lang.reflect.Constructor;

import com.sun.jarsigner.ContentSigner;
import com.sun.jarsigner.ContentSignerParameters;
import java.net.SocketTimeoutException;
import java.net.URL;
import java.net.URLClassLoader;
import java.security.cert.CertPath;
import java.security.cert.CertPathValidator;
import java.security.cert.CertificateExpiredException;
import java.security.cert.CertificateFactory;
import java.security.cert.CertificateNotYetValidException;
import java.security.cert.PKIXParameters;
import java.security.cert.TrustAnchor;
import java.util.Map.Entry;
import sun.security.tools.KeyStoreUtil;
import sun.security.tools.PathList;
import sun.security.x509.*;
import sun.security.util.*;
import java.util.Base64;


/**
 * &lt;p&gt;The jarsigner utility.
 *
 * The exit codes for the main method are:
 *
 * 0: success
 * 1: any error that the jar cannot be signed or verified, including:
 *      keystore loading error
 *      TSP communication error
 *      jarsigner command line error...
 * otherwise: error codes from -strict
 *
 * @author Roland Schemers
 * @author Jan Luehe
 */

<span class="nc" id="L79">public class Main {</span>

    // for i18n
<span class="nc" id="L82">    private static final java.util.ResourceBundle rb =</span>
        java.util.ResourceBundle.getBundle
<span class="nc" id="L84">        (&quot;sun.security.tools.jarsigner.Resources&quot;);</span>
<span class="nc" id="L85">    private static final Collator collator = Collator.getInstance();</span>
    static {
        // this is for case insensitive string comparisions
<span class="nc" id="L88">        collator.setStrength(Collator.PRIMARY);</span>
    }

    private static final String META_INF = &quot;META-INF/&quot;;

    // prefix for new signature-related files in META-INF directory
    private static final String SIG_PREFIX = META_INF + &quot;SIG-&quot;;

<span class="nc" id="L96">    private static final Class&lt;?&gt;[] PARAM_STRING = { String.class };</span>

    private static final String NONE = &quot;NONE&quot;;
    private static final String P11KEYSTORE = &quot;PKCS11&quot;;

    private static final long SIX_MONTHS = 180*24*60*60*1000L; //milliseconds

    // Attention:
    // This is the entry that get launched by the security tool jarsigner.
    public static void main(String args[]) throws Exception {
<span class="nc" id="L106">        Main js = new Main();</span>
<span class="nc" id="L107">        js.run(args);</span>
<span class="nc" id="L108">    }</span>

    static final String VERSION = &quot;1.0&quot;;

    static final int IN_KEYSTORE = 0x01;        // signer is in keystore
    static final int IN_SCOPE = 0x02;
    static final int NOT_ALIAS = 0x04;          // alias list is NOT empty and
                                                // signer is not in alias list
    static final int SIGNED_BY_ALIAS = 0x08;    // signer is in alias list

    X509Certificate[] certChain;    // signer's cert chain (when composing)
    PrivateKey privateKey;          // private key
    KeyStore store;                 // the keystore specified by -keystore
                                    // or the default keystore, never null

    String keystore; // key store file
<span class="nc" id="L124">    boolean nullStream = false; // null keystore input stream (NONE)</span>
<span class="nc" id="L125">    boolean token = false; // token-based keystore</span>
    String jarfile;  // jar files to sign or verify
    String alias;    // alias to sign jar with
<span class="nc" id="L128">    List&lt;String&gt; ckaliases = new ArrayList&lt;&gt;(); // aliases in -verify</span>
    char[] storepass; // keystore password
    boolean protectedPath; // protected authentication path
    String storetype; // keystore type
    String providerName; // provider name
<span class="nc" id="L133">    Vector&lt;String&gt; providers = null; // list of providers</span>
    // arguments for provider constructors
<span class="nc" id="L135">    HashMap&lt;String,String&gt; providerArgs = new HashMap&lt;&gt;();</span>
    char[] keypass; // private key password
    String sigfile; // name of .SF file
    String sigalg; // name of signature algorithm
<span class="nc" id="L139">    String digestalg = &quot;SHA-256&quot;; // name of digest algorithm</span>
    String signedjar; // output filename
    String tsaUrl; // location of the Timestamping Authority
    String tsaAlias; // alias for the Timestamping Authority's certificate
    String altCertChain; // file to read alternative cert chain from
    String tSAPolicyID;
<span class="nc" id="L145">    boolean verify = false; // verify the jar</span>
<span class="nc" id="L146">    String verbose = null; // verbose output when signing/verifying</span>
<span class="nc" id="L147">    boolean showcerts = false; // show certs when verifying</span>
<span class="nc" id="L148">    boolean debug = false; // debug</span>
<span class="nc" id="L149">    boolean signManifest = true; // &quot;sign&quot; the whole manifest</span>
<span class="nc" id="L150">    boolean externalSF = true; // leave the .SF out of the PKCS7 block</span>
<span class="nc" id="L151">    boolean strict = false;  // treat warnings as error</span>

    // read zip entry raw bytes
<span class="nc" id="L154">    private ByteArrayOutputStream baos = new ByteArrayOutputStream(2048);</span>
<span class="nc" id="L155">    private byte[] buffer = new byte[8192];</span>
<span class="nc" id="L156">    private ContentSigner signingMechanism = null;</span>
<span class="nc" id="L157">    private String altSignerClass = null;</span>
<span class="nc" id="L158">    private String altSignerClasspath = null;</span>
<span class="nc" id="L159">    private ZipFile zipFile = null;</span>

<span class="nc" id="L161">    private boolean hasExpiredCert = false;</span>
<span class="nc" id="L162">    private boolean hasExpiringCert = false;</span>
<span class="nc" id="L163">    private boolean notYetValidCert = false;</span>
<span class="nc" id="L164">    private boolean chainNotValidated = false;</span>
<span class="nc" id="L165">    private boolean notSignedByAlias = false;</span>
<span class="nc" id="L166">    private boolean aliasNotInStore = false;</span>
<span class="nc" id="L167">    private boolean hasUnsignedEntry = false;</span>
<span class="nc" id="L168">    private boolean badKeyUsage = false;</span>
<span class="nc" id="L169">    private boolean badExtendedKeyUsage = false;</span>
<span class="nc" id="L170">    private boolean badNetscapeCertType = false;</span>

    CertificateFactory certificateFactory;
    CertPathValidator validator;
    PKIXParameters pkixParameters;

    public void run(String args[]) {
        try {
<span class="nc" id="L178">            parseArgs(args);</span>

            // Try to load and install the specified providers
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (providers != null) {</span>
<span class="nc" id="L182">                ClassLoader cl = ClassLoader.getSystemClassLoader();</span>
<span class="nc" id="L183">                Enumeration&lt;String&gt; e = providers.elements();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                while (e.hasMoreElements()) {</span>
<span class="nc" id="L185">                    String provName = e.nextElement();</span>
                    Class&lt;?&gt; provClass;
<span class="nc bnc" id="L187" title="All 2 branches missed.">                    if (cl != null) {</span>
<span class="nc" id="L188">                        provClass = cl.loadClass(provName);</span>
                    } else {
<span class="nc" id="L190">                        provClass = Class.forName(provName);</span>
                    }

<span class="nc" id="L193">                    String provArg = providerArgs.get(provName);</span>
                    Object obj;
<span class="nc bnc" id="L195" title="All 2 branches missed.">                    if (provArg == null) {</span>
<span class="nc" id="L196">                        obj = provClass.newInstance();</span>
                    } else {
<span class="nc" id="L198">                        Constructor&lt;?&gt; c =</span>
<span class="nc" id="L199">                                provClass.getConstructor(PARAM_STRING);</span>
<span class="nc" id="L200">                        obj = c.newInstance(provArg);</span>
                    }

<span class="nc bnc" id="L203" title="All 2 branches missed.">                    if (!(obj instanceof Provider)) {</span>
<span class="nc" id="L204">                        MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L205">                            (&quot;provName.not.a.provider&quot;));</span>
<span class="nc" id="L206">                        Object[] source = {provName};</span>
<span class="nc" id="L207">                        throw new Exception(form.format(source));</span>
                    }
<span class="nc" id="L209">                    Security.addProvider((Provider)obj);</span>
<span class="nc" id="L210">                }</span>
            }

<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (verify) {</span>
                try {
<span class="nc" id="L215">                    loadKeyStore(keystore, false);</span>
<span class="nc" id="L216">                } catch (Exception e) {</span>
<span class="nc bnc" id="L217" title="All 4 branches missed.">                    if ((keystore != null) || (storepass != null)) {</span>
<span class="nc" id="L218">                        System.out.println(rb.getString(&quot;jarsigner.error.&quot;) +</span>
<span class="nc" id="L219">                                        e.getMessage());</span>
<span class="nc" id="L220">                        System.exit(1);</span>
                    }
<span class="nc" id="L222">                }</span>
                /*              if (debug) {
                    SignatureFileVerifier.setDebug(true);
                    ManifestEntryVerifier.setDebug(true);
                }
                */
<span class="nc" id="L228">                verifyJar(jarfile);</span>
            } else {
<span class="nc" id="L230">                loadKeyStore(keystore, true);</span>
<span class="nc" id="L231">                getAliasInfo(alias);</span>

                // load the alternative signing mechanism
<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (altSignerClass != null) {</span>
<span class="nc" id="L235">                    signingMechanism = loadSigningMechanism(altSignerClass,</span>
                        altSignerClasspath);
                }
<span class="nc" id="L238">                signJar(jarfile, alias, args);</span>
            }
<span class="nc" id="L240">        } catch (Exception e) {</span>
<span class="nc" id="L241">            System.out.println(rb.getString(&quot;jarsigner.error.&quot;) + e);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L243">                e.printStackTrace();</span>
            }
<span class="nc" id="L245">            System.exit(1);</span>
        } finally {
            // zero-out private key password
<span class="nc bnc" id="L248" title="All 6 branches missed.">            if (keypass != null) {</span>
<span class="nc" id="L249">                Arrays.fill(keypass, ' ');</span>
<span class="nc" id="L250">                keypass = null;</span>
            }
            // zero-out keystore password
<span class="nc bnc" id="L253" title="All 6 branches missed.">            if (storepass != null) {</span>
<span class="nc" id="L254">                Arrays.fill(storepass, ' ');</span>
<span class="nc" id="L255">                storepass = null;</span>
            }
        }

<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (strict) {</span>
<span class="nc" id="L260">            int exitCode = 0;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (hasExpiringCert) {</span>
<span class="nc" id="L262">                exitCode |= 2;</span>
            }
<span class="nc bnc" id="L264" title="All 6 branches missed.">            if (chainNotValidated || hasExpiredCert || notYetValidCert) {</span>
<span class="nc" id="L265">                exitCode |= 4;</span>
            }
<span class="nc bnc" id="L267" title="All 6 branches missed.">            if (badKeyUsage || badExtendedKeyUsage || badNetscapeCertType) {</span>
<span class="nc" id="L268">                exitCode |= 8;</span>
            }
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (hasUnsignedEntry) {</span>
<span class="nc" id="L271">                exitCode |= 16;</span>
            }
<span class="nc bnc" id="L273" title="All 4 branches missed.">            if (notSignedByAlias || aliasNotInStore) {</span>
<span class="nc" id="L274">                exitCode |= 32;</span>
            }
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if (exitCode != 0) {</span>
<span class="nc" id="L277">                System.exit(exitCode);</span>
            }
        }
<span class="nc" id="L280">    }</span>

    /*
     * Parse command line arguments.
     */
    void parseArgs(String args[]) {
        /* parse flags */
<span class="nc" id="L287">        int n = 0;</span>

<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (args.length == 0) fullusage();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">        for (n=0; n &lt; args.length; n++) {</span>

<span class="nc" id="L292">            String flags = args[n];</span>
<span class="nc" id="L293">            String modifier = null;</span>

<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (flags.startsWith(&quot;-&quot;)) {</span>
<span class="nc" id="L296">                int pos = flags.indexOf(':');</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">                if (pos &gt; 0) {</span>
<span class="nc" id="L298">                    modifier = flags.substring(pos+1);</span>
<span class="nc" id="L299">                    flags = flags.substring(0, pos);</span>
                }
            }

<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (!flags.startsWith(&quot;-&quot;)) {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                if (jarfile == null) {</span>
<span class="nc" id="L305">                    jarfile = flags;</span>
                } else {
<span class="nc" id="L307">                    alias = flags;</span>
<span class="nc" id="L308">                    ckaliases.add(alias);</span>
                }
<span class="nc bnc" id="L310" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-keystore&quot;) == 0) {</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L312">                keystore = args[n];</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-storepass&quot;) ==0) {</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L315">                storepass = getPass(modifier, args[n]);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-storetype&quot;) ==0) {</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L318">                storetype = args[n];</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-providerName&quot;) ==0) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L321">                providerName = args[n];</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            } else if ((collator.compare(flags, &quot;-provider&quot;) == 0) ||</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                        (collator.compare(flags, &quot;-providerClass&quot;) == 0)) {</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                if (providers == null) {</span>
<span class="nc" id="L326">                    providers = new Vector&lt;String&gt;(3);</span>
                }
<span class="nc" id="L328">                providers.add(args[n]);</span>

<span class="nc bnc" id="L330" title="All 2 branches missed.">                if (args.length &gt; (n+1)) {</span>
<span class="nc" id="L331">                    flags = args[n+1];</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                    if (collator.compare(flags, &quot;-providerArg&quot;) == 0) {</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                        if (args.length == (n+2)) usageNoArg();</span>
<span class="nc" id="L334">                        providerArgs.put(args[n], args[n+2]);</span>
<span class="nc" id="L335">                        n += 2;</span>
                    }
                }
<span class="nc bnc" id="L338" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-protected&quot;) ==0) {</span>
<span class="nc" id="L339">                protectedPath = true;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-certchain&quot;) ==0) {</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L342">                altCertChain = args[n];</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-tsapolicyid&quot;) ==0) {</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L345">                tSAPolicyID = args[n];</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-debug&quot;) ==0) {</span>
<span class="nc" id="L347">                debug = true;</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-keypass&quot;) ==0) {</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L350">                keypass = getPass(modifier, args[n]);</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-sigfile&quot;) ==0) {</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L353">                sigfile = args[n];</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-signedjar&quot;) ==0) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L356">                signedjar = args[n];</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-tsa&quot;) ==0) {</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L359">                tsaUrl = args[n];</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-tsacert&quot;) ==0) {</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L362">                tsaAlias = args[n];</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-altsigner&quot;) ==0) {</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L365">                altSignerClass = args[n];</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-altsignerpath&quot;) ==0) {</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L368">                altSignerClasspath = args[n];</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-sectionsonly&quot;) ==0) {</span>
<span class="nc" id="L370">                signManifest = false;</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-internalsf&quot;) ==0) {</span>
<span class="nc" id="L372">                externalSF = false;</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-verify&quot;) ==0) {</span>
<span class="nc" id="L374">                verify = true;</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-verbose&quot;) ==0) {</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                verbose = (modifier != null) ? modifier : &quot;all&quot;;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-sigalg&quot;) ==0) {</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L379">                sigalg = args[n];</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-digestalg&quot;) ==0) {</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">                if (++n == args.length) usageNoArg();</span>
<span class="nc" id="L382">                digestalg = args[n];</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-certs&quot;) ==0) {</span>
<span class="nc" id="L384">                showcerts = true;</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-strict&quot;) ==0) {</span>
<span class="nc" id="L386">                strict = true;</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-h&quot;) == 0 ||</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                        collator.compare(flags, &quot;-help&quot;) == 0) {</span>
<span class="nc" id="L389">                fullusage();</span>
            } else {
<span class="nc" id="L391">                System.err.println(</span>
<span class="nc" id="L392">                        rb.getString(&quot;Illegal.option.&quot;) + flags);</span>
<span class="nc" id="L393">                usage();</span>
            }
        }

        // -certs must always be specified with -verbose
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (verbose == null) showcerts = false;</span>

<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (jarfile == null) {</span>
<span class="nc" id="L401">            System.err.println(rb.getString(&quot;Please.specify.jarfile.name&quot;));</span>
<span class="nc" id="L402">            usage();</span>
        }
<span class="nc bnc" id="L404" title="All 4 branches missed.">        if (!verify &amp;&amp; alias == null) {</span>
<span class="nc" id="L405">            System.err.println(rb.getString(&quot;Please.specify.alias.name&quot;));</span>
<span class="nc" id="L406">            usage();</span>
        }
<span class="nc bnc" id="L408" title="All 4 branches missed.">        if (!verify &amp;&amp; ckaliases.size() &gt; 1) {</span>
<span class="nc" id="L409">            System.err.println(rb.getString(&quot;Only.one.alias.can.be.specified&quot;));</span>
<span class="nc" id="L410">            usage();</span>
        }

<span class="nc bnc" id="L413" title="All 2 branches missed.">        if (storetype == null) {</span>
<span class="nc" id="L414">            storetype = KeyStore.getDefaultType();</span>
        }
<span class="nc" id="L416">        storetype = KeyStoreUtil.niceStoreTypeName(storetype);</span>

        try {
<span class="nc bnc" id="L419" title="All 4 branches missed.">            if (signedjar != null &amp;&amp; new File(signedjar).getCanonicalPath().equals(</span>
<span class="nc" id="L420">                    new File(jarfile).getCanonicalPath())) {</span>
<span class="nc" id="L421">                signedjar = null;</span>
            }
<span class="nc" id="L423">        } catch (IOException ioe) {</span>
            // File system error?
            // Just ignore it.
<span class="nc" id="L426">        }</span>

<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (P11KEYSTORE.equalsIgnoreCase(storetype) ||</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                KeyStoreUtil.isWindowsKeyStore(storetype)) {</span>
<span class="nc" id="L430">            token = true;</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">            if (keystore == null) {</span>
<span class="nc" id="L432">                keystore = NONE;</span>
            }
        }

<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (NONE.equals(keystore)) {</span>
<span class="nc" id="L437">            nullStream = true;</span>
        }

<span class="nc bnc" id="L440" title="All 4 branches missed.">        if (token &amp;&amp; !nullStream) {</span>
<span class="nc" id="L441">            System.err.println(MessageFormat.format(rb.getString</span>
<span class="nc" id="L442">                (&quot;.keystore.must.be.NONE.if.storetype.is.{0}&quot;), storetype));</span>
<span class="nc" id="L443">            usage();</span>
        }

<span class="nc bnc" id="L446" title="All 4 branches missed.">        if (token &amp;&amp; keypass != null) {</span>
<span class="nc" id="L447">            System.err.println(MessageFormat.format(rb.getString</span>
<span class="nc" id="L448">                (&quot;.keypass.can.not.be.specified.if.storetype.is.{0}&quot;), storetype));</span>
<span class="nc" id="L449">            usage();</span>
        }

<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (protectedPath) {</span>
<span class="nc bnc" id="L453" title="All 4 branches missed.">            if (storepass != null || keypass != null) {</span>
<span class="nc" id="L454">                System.err.println(rb.getString</span>
<span class="nc" id="L455">                        (&quot;If.protected.is.specified.then.storepass.and.keypass.must.not.be.specified&quot;));</span>
<span class="nc" id="L456">                usage();</span>
            }
        }
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (KeyStoreUtil.isWindowsKeyStore(storetype)) {</span>
<span class="nc bnc" id="L460" title="All 4 branches missed.">            if (storepass != null || keypass != null) {</span>
<span class="nc" id="L461">                System.err.println(rb.getString</span>
<span class="nc" id="L462">                        (&quot;If.keystore.is.not.password.protected.then.storepass.and.keypass.must.not.be.specified&quot;));</span>
<span class="nc" id="L463">                usage();</span>
            }
        }
<span class="nc" id="L466">    }</span>

    static char[] getPass(String modifier, String arg) {
<span class="nc" id="L469">        char[] output = KeyStoreUtil.getPassWithModifier(modifier, arg, rb);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (output != null) return output;</span>
<span class="nc" id="L471">        usage();</span>
<span class="nc" id="L472">        return null;    // Useless, usage() already exit</span>
    }

    static void usageNoArg() {
<span class="nc" id="L476">        System.out.println(rb.getString(&quot;Option.lacks.argument&quot;));</span>
<span class="nc" id="L477">        usage();</span>
<span class="nc" id="L478">    }</span>

    static void usage() {
<span class="nc" id="L481">        System.out.println();</span>
<span class="nc" id="L482">        System.out.println(rb.getString(&quot;Please.type.jarsigner.help.for.usage&quot;));</span>
<span class="nc" id="L483">        System.exit(1);</span>
<span class="nc" id="L484">    }</span>

    static void fullusage() {
<span class="nc" id="L487">        System.out.println(rb.getString</span>
<span class="nc" id="L488">                (&quot;Usage.jarsigner.options.jar.file.alias&quot;));</span>
<span class="nc" id="L489">        System.out.println(rb.getString</span>
<span class="nc" id="L490">                (&quot;.jarsigner.verify.options.jar.file.alias.&quot;));</span>
<span class="nc" id="L491">        System.out.println();</span>
<span class="nc" id="L492">        System.out.println(rb.getString</span>
<span class="nc" id="L493">                (&quot;.keystore.url.keystore.location&quot;));</span>
<span class="nc" id="L494">        System.out.println();</span>
<span class="nc" id="L495">        System.out.println(rb.getString</span>
<span class="nc" id="L496">                (&quot;.storepass.password.password.for.keystore.integrity&quot;));</span>
<span class="nc" id="L497">        System.out.println();</span>
<span class="nc" id="L498">        System.out.println(rb.getString</span>
<span class="nc" id="L499">                (&quot;.storetype.type.keystore.type&quot;));</span>
<span class="nc" id="L500">        System.out.println();</span>
<span class="nc" id="L501">        System.out.println(rb.getString</span>
<span class="nc" id="L502">                (&quot;.keypass.password.password.for.private.key.if.different.&quot;));</span>
<span class="nc" id="L503">        System.out.println();</span>
<span class="nc" id="L504">        System.out.println(rb.getString</span>
<span class="nc" id="L505">                (&quot;.certchain.file.name.of.alternative.certchain.file&quot;));</span>
<span class="nc" id="L506">        System.out.println();</span>
<span class="nc" id="L507">        System.out.println(rb.getString</span>
<span class="nc" id="L508">                (&quot;.sigfile.file.name.of.SF.DSA.file&quot;));</span>
<span class="nc" id="L509">        System.out.println();</span>
<span class="nc" id="L510">        System.out.println(rb.getString</span>
<span class="nc" id="L511">                (&quot;.signedjar.file.name.of.signed.JAR.file&quot;));</span>
<span class="nc" id="L512">        System.out.println();</span>
<span class="nc" id="L513">        System.out.println(rb.getString</span>
<span class="nc" id="L514">                (&quot;.digestalg.algorithm.name.of.digest.algorithm&quot;));</span>
<span class="nc" id="L515">        System.out.println();</span>
<span class="nc" id="L516">        System.out.println(rb.getString</span>
<span class="nc" id="L517">                (&quot;.sigalg.algorithm.name.of.signature.algorithm&quot;));</span>
<span class="nc" id="L518">        System.out.println();</span>
<span class="nc" id="L519">        System.out.println(rb.getString</span>
<span class="nc" id="L520">                (&quot;.verify.verify.a.signed.JAR.file&quot;));</span>
<span class="nc" id="L521">        System.out.println();</span>
<span class="nc" id="L522">        System.out.println(rb.getString</span>
<span class="nc" id="L523">                (&quot;.verbose.suboptions.verbose.output.when.signing.verifying.&quot;));</span>
<span class="nc" id="L524">        System.out.println(rb.getString</span>
<span class="nc" id="L525">                (&quot;.suboptions.can.be.all.grouped.or.summary&quot;));</span>
<span class="nc" id="L526">        System.out.println();</span>
<span class="nc" id="L527">        System.out.println(rb.getString</span>
<span class="nc" id="L528">                (&quot;.certs.display.certificates.when.verbose.and.verifying&quot;));</span>
<span class="nc" id="L529">        System.out.println();</span>
<span class="nc" id="L530">        System.out.println(rb.getString</span>
<span class="nc" id="L531">                (&quot;.tsa.url.location.of.the.Timestamping.Authority&quot;));</span>
<span class="nc" id="L532">        System.out.println();</span>
<span class="nc" id="L533">        System.out.println(rb.getString</span>
<span class="nc" id="L534">                (&quot;.tsacert.alias.public.key.certificate.for.Timestamping.Authority&quot;));</span>
<span class="nc" id="L535">        System.out.println();</span>
<span class="nc" id="L536">        System.out.println(rb.getString</span>
<span class="nc" id="L537">                (&quot;.tsapolicyid.tsapolicyid.for.Timestamping.Authority&quot;));</span>
<span class="nc" id="L538">        System.out.println();</span>
<span class="nc" id="L539">        System.out.println(rb.getString</span>
<span class="nc" id="L540">                (&quot;.altsigner.class.class.name.of.an.alternative.signing.mechanism&quot;));</span>
<span class="nc" id="L541">        System.out.println();</span>
<span class="nc" id="L542">        System.out.println(rb.getString</span>
<span class="nc" id="L543">                (&quot;.altsignerpath.pathlist.location.of.an.alternative.signing.mechanism&quot;));</span>
<span class="nc" id="L544">        System.out.println();</span>
<span class="nc" id="L545">        System.out.println(rb.getString</span>
<span class="nc" id="L546">                (&quot;.internalsf.include.the.SF.file.inside.the.signature.block&quot;));</span>
<span class="nc" id="L547">        System.out.println();</span>
<span class="nc" id="L548">        System.out.println(rb.getString</span>
<span class="nc" id="L549">                (&quot;.sectionsonly.don.t.compute.hash.of.entire.manifest&quot;));</span>
<span class="nc" id="L550">        System.out.println();</span>
<span class="nc" id="L551">        System.out.println(rb.getString</span>
<span class="nc" id="L552">                (&quot;.protected.keystore.has.protected.authentication.path&quot;));</span>
<span class="nc" id="L553">        System.out.println();</span>
<span class="nc" id="L554">        System.out.println(rb.getString</span>
<span class="nc" id="L555">                (&quot;.providerName.name.provider.name&quot;));</span>
<span class="nc" id="L556">        System.out.println();</span>
<span class="nc" id="L557">        System.out.println(rb.getString</span>
<span class="nc" id="L558">                (&quot;.providerClass.class.name.of.cryptographic.service.provider.s&quot;));</span>
<span class="nc" id="L559">        System.out.println(rb.getString</span>
<span class="nc" id="L560">                (&quot;.providerArg.arg.master.class.file.and.constructor.argument&quot;));</span>
<span class="nc" id="L561">        System.out.println();</span>
<span class="nc" id="L562">        System.out.println(rb.getString</span>
<span class="nc" id="L563">                (&quot;.strict.treat.warnings.as.errors&quot;));</span>
<span class="nc" id="L564">        System.out.println();</span>

<span class="nc" id="L566">        System.exit(0);</span>
<span class="nc" id="L567">    }</span>

    void verifyJar(String jarName)
        throws Exception
    {
<span class="nc" id="L572">        boolean anySigned = false;  // if there exists entry inside jar signed</span>
<span class="nc" id="L573">        JarFile jf = null;</span>

        try {
<span class="nc" id="L576">            jf = new JarFile(jarName, true);</span>
<span class="nc" id="L577">            Vector&lt;JarEntry&gt; entriesVec = new Vector&lt;&gt;();</span>
<span class="nc" id="L578">            byte[] buffer = new byte[8192];</span>

<span class="nc" id="L580">            Enumeration&lt;JarEntry&gt; entries = jf.entries();</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">            while (entries.hasMoreElements()) {</span>
<span class="nc" id="L582">                JarEntry je = entries.nextElement();</span>
<span class="nc" id="L583">                entriesVec.addElement(je);</span>
<span class="nc" id="L584">                InputStream is = null;</span>
                try {
<span class="nc" id="L586">                    is = jf.getInputStream(je);</span>
                    int n;
<span class="nc bnc" id="L588" title="All 2 branches missed.">                    while ((n = is.read(buffer, 0, buffer.length)) != -1) {</span>
                        // we just read. this will throw a SecurityException
                        // if  a signature/digest check fails.
                    }
                } finally {
<span class="nc bnc" id="L593" title="All 4 branches missed.">                    if (is != null) {</span>
<span class="nc" id="L594">                        is.close();</span>
                    }
                }
<span class="nc" id="L597">            }</span>

<span class="nc" id="L599">            Manifest man = jf.getManifest();</span>

            // The map to record display info, only used when -verbose provided
            //      key: signer info string
            //      value: the list of files with common key
<span class="nc" id="L604">            Map&lt;String,List&lt;String&gt;&gt; output = new LinkedHashMap&lt;&gt;();</span>

<span class="nc bnc" id="L606" title="All 2 branches missed.">            if (man != null) {</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">                if (verbose != null) System.out.println();</span>
<span class="nc" id="L608">                Enumeration&lt;JarEntry&gt; e = entriesVec.elements();</span>

<span class="nc" id="L610">                String tab = rb.getString(&quot;6SPACE&quot;);</span>

<span class="nc bnc" id="L612" title="All 2 branches missed.">                while (e.hasMoreElements()) {</span>
<span class="nc" id="L613">                    JarEntry je = e.nextElement();</span>
<span class="nc" id="L614">                    String name = je.getName();</span>
<span class="nc" id="L615">                    CodeSigner[] signers = je.getCodeSigners();</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                    boolean isSigned = (signers != null);</span>
<span class="nc" id="L617">                    anySigned |= isSigned;</span>
<span class="nc bnc" id="L618" title="All 4 branches missed.">                    hasUnsignedEntry |= !je.isDirectory() &amp;&amp; !isSigned</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">                                        &amp;&amp; !signatureRelated(name);</span>

<span class="nc" id="L621">                    int inStoreOrScope = inKeyStore(signers);</span>

<span class="nc bnc" id="L623" title="All 2 branches missed.">                    boolean inStore = (inStoreOrScope &amp; IN_KEYSTORE) != 0;</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                    boolean inScope = (inStoreOrScope &amp; IN_SCOPE) != 0;</span>

<span class="nc bnc" id="L626" title="All 2 branches missed.">                    notSignedByAlias |= (inStoreOrScope &amp; NOT_ALIAS) != 0;</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                    if (keystore != null) {</span>
<span class="nc bnc" id="L628" title="All 6 branches missed.">                        aliasNotInStore |= isSigned &amp;&amp; (!inStore &amp;&amp; !inScope);</span>
                    }

                    // Only used when -verbose provided
<span class="nc" id="L632">                    StringBuffer sb = null;</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">                    if (verbose != null) {</span>
<span class="nc" id="L634">                        sb = new StringBuffer();</span>
<span class="nc" id="L635">                        boolean inManifest =</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                            ((man.getAttributes(name) != null) ||</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">                             (man.getAttributes(&quot;./&quot;+name) != null) ||</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">                             (man.getAttributes(&quot;/&quot;+name) != null));</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                        sb.append(</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">                          (isSigned ? rb.getString(&quot;s&quot;) : rb.getString(&quot;SPACE&quot;)) +</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">                          (inManifest ? rb.getString(&quot;m&quot;) : rb.getString(&quot;SPACE&quot;)) +</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">                          (inStore ? rb.getString(&quot;k&quot;) : rb.getString(&quot;SPACE&quot;)) +</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">                          (inScope ? rb.getString(&quot;i&quot;) : rb.getString(&quot;SPACE&quot;)) +</span>
                          ((inStoreOrScope &amp; NOT_ALIAS) != 0 ?&quot;X&quot;:&quot; &quot;) +
<span class="nc" id="L645">                          rb.getString(&quot;SPACE&quot;));</span>
<span class="nc" id="L646">                        sb.append(&quot;|&quot;);</span>
                    }

                    // When -certs provided, display info has extra empty
                    // lines at the beginning and end.
<span class="nc bnc" id="L651" title="All 2 branches missed.">                    if (isSigned) {</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">                        if (showcerts) sb.append('\n');</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">                        for (CodeSigner signer: signers) {</span>
                            // signerInfo() must be called even if -verbose
                            // not provided. The method updates various
                            // warning flags.
<span class="nc" id="L657">                            String si = signerInfo(signer, tab);</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                            if (showcerts) {</span>
<span class="nc" id="L659">                                sb.append(si);</span>
<span class="nc" id="L660">                                sb.append('\n');</span>
                            }
                        }
<span class="nc bnc" id="L663" title="All 4 branches missed.">                    } else if (showcerts &amp;&amp; !verbose.equals(&quot;all&quot;)) {</span>
                        // Print no info for unsigned entries when -verbose:all,
                        // to be consistent with old behavior.
<span class="nc bnc" id="L666" title="All 2 branches missed.">                        if (signatureRelated(name)) {</span>
<span class="nc" id="L667">                            sb.append(&quot;\n&quot; + tab + rb.getString(</span>
                                    &quot;.Signature.related.entries.&quot;) + &quot;\n\n&quot;);
                        } else {
<span class="nc" id="L670">                            sb.append(&quot;\n&quot; + tab + rb.getString(</span>
                                    &quot;.Unsigned.entries.&quot;) + &quot;\n\n&quot;);
                        }
                    }

<span class="nc bnc" id="L675" title="All 2 branches missed.">                    if (verbose != null) {</span>
<span class="nc" id="L676">                        String label = sb.toString();</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">                        if (signatureRelated(name)) {</span>
                            // Entries inside META-INF and other unsigned
                            // entries are grouped separately.
<span class="nc" id="L680">                            label = &quot;-&quot; + label;</span>
                        }

                        // The label finally contains 2 parts separated by '|':
                        // The legend displayed before the entry names, and
                        // the cert info (if -certs specified).

<span class="nc bnc" id="L687" title="All 2 branches missed.">                        if (!output.containsKey(label)) {</span>
<span class="nc" id="L688">                            output.put(label, new ArrayList&lt;String&gt;());</span>
                        }

<span class="nc" id="L691">                        StringBuffer fb = new StringBuffer();</span>
<span class="nc" id="L692">                        String s = Long.toString(je.getSize());</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                        for (int i = 6 - s.length(); i &gt; 0; --i) {</span>
<span class="nc" id="L694">                            fb.append(' ');</span>
                        }
<span class="nc" id="L696">                        fb.append(s).append(' ').</span>
<span class="nc" id="L697">                                append(new Date(je.getTime()).toString());</span>
<span class="nc" id="L698">                        fb.append(' ').append(name);</span>

<span class="nc" id="L700">                        output.get(label).add(fb.toString());</span>
                    }
<span class="nc" id="L702">                }</span>
            }
<span class="nc bnc" id="L704" title="All 2 branches missed.">            if (verbose != null) {</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">                for (Entry&lt;String,List&lt;String&gt;&gt; s: output.entrySet()) {</span>
<span class="nc" id="L706">                    List&lt;String&gt; files = s.getValue();</span>
<span class="nc" id="L707">                    String key = s.getKey();</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                    if (key.charAt(0) == '-') { // the signature-related group</span>
<span class="nc" id="L709">                        key = key.substring(1);</span>
                    }
<span class="nc" id="L711">                    int pipe = key.indexOf('|');</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                    if (verbose.equals(&quot;all&quot;)) {</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                        for (String f: files) {</span>
<span class="nc" id="L714">                            System.out.println(key.substring(0, pipe) + f);</span>
<span class="nc" id="L715">                            System.out.printf(key.substring(pipe+1));</span>
<span class="nc" id="L716">                        }</span>
                    } else {
<span class="nc bnc" id="L718" title="All 2 branches missed.">                        if (verbose.equals(&quot;grouped&quot;)) {</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">                            for (String f: files) {</span>
<span class="nc" id="L720">                                System.out.println(key.substring(0, pipe) + f);</span>
<span class="nc" id="L721">                            }</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">                        } else if (verbose.equals(&quot;summary&quot;)) {</span>
<span class="nc" id="L723">                            System.out.print(key.substring(0, pipe));</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">                            if (files.size() &gt; 1) {</span>
<span class="nc" id="L725">                                System.out.println(files.get(0) + &quot; &quot; +</span>
<span class="nc" id="L726">                                        String.format(rb.getString(</span>
<span class="nc" id="L727">                                        &quot;.and.d.more.&quot;), files.size()-1));</span>
                            } else {
<span class="nc" id="L729">                                System.out.println(files.get(0));</span>
                            }
                        }
<span class="nc" id="L732">                        System.out.printf(key.substring(pipe+1));</span>
                    }
<span class="nc" id="L734">                }</span>
<span class="nc" id="L735">                System.out.println();</span>
<span class="nc" id="L736">                System.out.println(rb.getString(</span>
                    &quot;.s.signature.was.verified.&quot;));
<span class="nc" id="L738">                System.out.println(rb.getString(</span>
                    &quot;.m.entry.is.listed.in.manifest&quot;));
<span class="nc" id="L740">                System.out.println(rb.getString(</span>
                    &quot;.k.at.least.one.certificate.was.found.in.keystore&quot;));
<span class="nc" id="L742">                System.out.println(rb.getString(</span>
                    &quot;.i.at.least.one.certificate.was.found.in.identity.scope&quot;));
<span class="nc bnc" id="L744" title="All 2 branches missed.">                if (ckaliases.size() &gt; 0) {</span>
<span class="nc" id="L745">                    System.out.println(rb.getString(</span>
                        &quot;.X.not.signed.by.specified.alias.es.&quot;));
                }
<span class="nc" id="L748">                System.out.println();</span>
            }
<span class="nc bnc" id="L750" title="All 2 branches missed.">            if (man == null)</span>
<span class="nc" id="L751">                System.out.println(rb.getString(&quot;no.manifest.&quot;));</span>

<span class="nc bnc" id="L753" title="All 2 branches missed.">            if (!anySigned) {</span>
<span class="nc" id="L754">                System.out.println(rb.getString(</span>
                      &quot;jar.is.unsigned.signatures.missing.or.not.parsable.&quot;));
            } else {
<span class="nc" id="L757">                System.out.println(rb.getString(&quot;jar.verified.&quot;));</span>
<span class="nc bnc" id="L758" title="All 20 branches missed.">                if (hasUnsignedEntry || hasExpiredCert || hasExpiringCert ||</span>
                    badKeyUsage || badExtendedKeyUsage || badNetscapeCertType ||
                    notYetValidCert || chainNotValidated ||
                    aliasNotInStore || notSignedByAlias) {

<span class="nc" id="L763">                    System.out.println();</span>
<span class="nc" id="L764">                    System.out.println(rb.getString(&quot;Warning.&quot;));</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">                    if (badKeyUsage) {</span>
<span class="nc" id="L766">                        System.out.println(</span>
<span class="nc" id="L767">                            rb.getString(&quot;This.jar.contains.entries.whose.signer.certificate.s.KeyUsage.extension.doesn.t.allow.code.signing.&quot;));</span>
                    }

<span class="nc bnc" id="L770" title="All 2 branches missed.">                    if (badExtendedKeyUsage) {</span>
<span class="nc" id="L771">                        System.out.println(</span>
<span class="nc" id="L772">                            rb.getString(&quot;This.jar.contains.entries.whose.signer.certificate.s.ExtendedKeyUsage.extension.doesn.t.allow.code.signing.&quot;));</span>
                    }

<span class="nc bnc" id="L775" title="All 2 branches missed.">                    if (badNetscapeCertType) {</span>
<span class="nc" id="L776">                        System.out.println(</span>
<span class="nc" id="L777">                            rb.getString(&quot;This.jar.contains.entries.whose.signer.certificate.s.NetscapeCertType.extension.doesn.t.allow.code.signing.&quot;));</span>
                    }

<span class="nc bnc" id="L780" title="All 2 branches missed.">                    if (hasUnsignedEntry) {</span>
<span class="nc" id="L781">                        System.out.println(rb.getString(</span>
                            &quot;This.jar.contains.unsigned.entries.which.have.not.been.integrity.checked.&quot;));
                    }
<span class="nc bnc" id="L784" title="All 2 branches missed.">                    if (hasExpiredCert) {</span>
<span class="nc" id="L785">                        System.out.println(rb.getString(</span>
                            &quot;This.jar.contains.entries.whose.signer.certificate.has.expired.&quot;));
                    }
<span class="nc bnc" id="L788" title="All 2 branches missed.">                    if (hasExpiringCert) {</span>
<span class="nc" id="L789">                        System.out.println(rb.getString(</span>
                            &quot;This.jar.contains.entries.whose.signer.certificate.will.expire.within.six.months.&quot;));
                    }
<span class="nc bnc" id="L792" title="All 2 branches missed.">                    if (notYetValidCert) {</span>
<span class="nc" id="L793">                        System.out.println(rb.getString(</span>
                            &quot;This.jar.contains.entries.whose.signer.certificate.is.not.yet.valid.&quot;));
                    }

<span class="nc bnc" id="L797" title="All 2 branches missed.">                    if (chainNotValidated) {</span>
<span class="nc" id="L798">                        System.out.println(</span>
<span class="nc" id="L799">                                rb.getString(&quot;This.jar.contains.entries.whose.certificate.chain.is.not.validated.&quot;));</span>
                    }

<span class="nc bnc" id="L802" title="All 2 branches missed.">                    if (notSignedByAlias) {</span>
<span class="nc" id="L803">                        System.out.println(</span>
<span class="nc" id="L804">                                rb.getString(&quot;This.jar.contains.signed.entries.which.is.not.signed.by.the.specified.alias.es.&quot;));</span>
                    }

<span class="nc bnc" id="L807" title="All 2 branches missed.">                    if (aliasNotInStore) {</span>
<span class="nc" id="L808">                        System.out.println(rb.getString(&quot;This.jar.contains.signed.entries.that.s.not.signed.by.alias.in.this.keystore.&quot;));</span>
                    }
<span class="nc bnc" id="L810" title="All 4 branches missed.">                    if (! (verbose != null &amp;&amp; showcerts)) {</span>
<span class="nc" id="L811">                        System.out.println();</span>
<span class="nc" id="L812">                        System.out.println(rb.getString(</span>
                            &quot;Re.run.with.the.verbose.and.certs.options.for.more.details.&quot;));
                    }
                }
            }
<span class="nc" id="L817">            return;</span>
<span class="nc" id="L818">        } catch (Exception e) {</span>
<span class="nc" id="L819">            System.out.println(rb.getString(&quot;jarsigner.&quot;) + e);</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L821">                e.printStackTrace();</span>
            }
        } finally { // close the resource
<span class="nc bnc" id="L824" title="All 6 branches missed.">            if (jf != null) {</span>
<span class="nc" id="L825">                jf.close();</span>
            }
        }

<span class="nc" id="L829">        System.exit(1);</span>
<span class="nc" id="L830">    }</span>

<span class="nc" id="L832">    private static MessageFormat validityTimeForm = null;</span>
<span class="nc" id="L833">    private static MessageFormat notYetTimeForm = null;</span>
<span class="nc" id="L834">    private static MessageFormat expiredTimeForm = null;</span>
<span class="nc" id="L835">    private static MessageFormat expiringTimeForm = null;</span>

    /*
     * Display some details about a certificate:
     *
     * [&lt;tab&gt;] &lt;cert-type&gt; [&quot;, &quot; &lt;subject-DN&gt;] [&quot; (&quot; &lt;keystore-entry-alias&gt; &quot;)&quot;]
     * [&lt;validity-period&gt; | &lt;expiry-warning&gt;]
     *
     * Note: no newline character at the end
     */
    String printCert(String tab, Certificate c, boolean checkValidityPeriod,
        Date timestamp, boolean checkUsage) {

<span class="nc" id="L848">        StringBuilder certStr = new StringBuilder();</span>
<span class="nc" id="L849">        String space = rb.getString(&quot;SPACE&quot;);</span>
<span class="nc" id="L850">        X509Certificate x509Cert = null;</span>

<span class="nc bnc" id="L852" title="All 2 branches missed.">        if (c instanceof X509Certificate) {</span>
<span class="nc" id="L853">            x509Cert = (X509Certificate) c;</span>
<span class="nc" id="L854">            certStr.append(tab).append(x509Cert.getType())</span>
<span class="nc" id="L855">                .append(rb.getString(&quot;COMMA&quot;))</span>
<span class="nc" id="L856">                .append(x509Cert.getSubjectDN().getName());</span>
        } else {
<span class="nc" id="L858">            certStr.append(tab).append(c.getType());</span>
        }

<span class="nc" id="L861">        String alias = storeHash.get(c);</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">        if (alias != null) {</span>
<span class="nc" id="L863">            certStr.append(space).append(alias);</span>
        }

<span class="nc bnc" id="L866" title="All 4 branches missed.">        if (checkValidityPeriod &amp;&amp; x509Cert != null) {</span>

<span class="nc" id="L868">            certStr.append(&quot;\n&quot;).append(tab).append(&quot;[&quot;);</span>
<span class="nc" id="L869">            Date notAfter = x509Cert.getNotAfter();</span>
            try {
<span class="nc" id="L871">                boolean printValidity = true;</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">                if (timestamp == null) {</span>
<span class="nc" id="L873">                    x509Cert.checkValidity();</span>
                    // test if cert will expire within six months
<span class="nc bnc" id="L875" title="All 2 branches missed.">                    if (notAfter.getTime() &lt; System.currentTimeMillis() + SIX_MONTHS) {</span>
<span class="nc" id="L876">                        hasExpiringCert = true;</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">                        if (expiringTimeForm == null) {</span>
<span class="nc" id="L878">                            expiringTimeForm = new MessageFormat(</span>
<span class="nc" id="L879">                                rb.getString(&quot;certificate.will.expire.on&quot;));</span>
                        }
<span class="nc" id="L881">                        Object[] source = { notAfter };</span>
<span class="nc" id="L882">                        certStr.append(expiringTimeForm.format(source));</span>
<span class="nc" id="L883">                        printValidity = false;</span>
<span class="nc" id="L884">                    }</span>
                } else {
<span class="nc" id="L886">                    x509Cert.checkValidity(timestamp);</span>
                }
<span class="nc bnc" id="L888" title="All 2 branches missed.">                if (printValidity) {</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">                    if (validityTimeForm == null) {</span>
<span class="nc" id="L890">                        validityTimeForm = new MessageFormat(</span>
<span class="nc" id="L891">                            rb.getString(&quot;certificate.is.valid.from&quot;));</span>
                    }
<span class="nc" id="L893">                    Object[] source = { x509Cert.getNotBefore(), notAfter };</span>
<span class="nc" id="L894">                    certStr.append(validityTimeForm.format(source));</span>
                }
<span class="nc" id="L896">            } catch (CertificateExpiredException cee) {</span>
<span class="nc" id="L897">                hasExpiredCert = true;</span>

<span class="nc bnc" id="L899" title="All 2 branches missed.">                if (expiredTimeForm == null) {</span>
<span class="nc" id="L900">                    expiredTimeForm = new MessageFormat(</span>
<span class="nc" id="L901">                        rb.getString(&quot;certificate.expired.on&quot;));</span>
                }
<span class="nc" id="L903">                Object[] source = { notAfter };</span>
<span class="nc" id="L904">                certStr.append(expiredTimeForm.format(source));</span>

<span class="nc" id="L906">            } catch (CertificateNotYetValidException cnyve) {</span>
<span class="nc" id="L907">                notYetValidCert = true;</span>

<span class="nc bnc" id="L909" title="All 2 branches missed.">                if (notYetTimeForm == null) {</span>
<span class="nc" id="L910">                    notYetTimeForm = new MessageFormat(</span>
<span class="nc" id="L911">                        rb.getString(&quot;certificate.is.not.valid.until&quot;));</span>
                }
<span class="nc" id="L913">                Object[] source = { x509Cert.getNotBefore() };</span>
<span class="nc" id="L914">                certStr.append(notYetTimeForm.format(source));</span>
<span class="nc" id="L915">            }</span>
<span class="nc" id="L916">            certStr.append(&quot;]&quot;);</span>

<span class="nc bnc" id="L918" title="All 2 branches missed.">            if (checkUsage) {</span>
<span class="nc" id="L919">                boolean[] bad = new boolean[3];</span>
<span class="nc" id="L920">                checkCertUsage(x509Cert, bad);</span>
<span class="nc bnc" id="L921" title="All 6 branches missed.">                if (bad[0] || bad[1] || bad[2]) {</span>
<span class="nc" id="L922">                    String x = &quot;&quot;;</span>
<span class="nc bnc" id="L923" title="All 2 branches missed.">                    if (bad[0]) {</span>
<span class="nc" id="L924">                        x =&quot;KeyUsage&quot;;</span>
                    }
<span class="nc bnc" id="L926" title="All 2 branches missed.">                    if (bad[1]) {</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">                        if (x.length() &gt; 0) x = x + &quot;, &quot;;</span>
<span class="nc" id="L928">                        x = x + &quot;ExtendedKeyUsage&quot;;</span>
                    }
<span class="nc bnc" id="L930" title="All 2 branches missed.">                    if (bad[2]) {</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">                        if (x.length() &gt; 0) x = x + &quot;, &quot;;</span>
<span class="nc" id="L932">                        x = x + &quot;NetscapeCertType&quot;;</span>
                    }
<span class="nc" id="L934">                    certStr.append(&quot;\n&quot;).append(tab)</span>
<span class="nc" id="L935">                        .append(MessageFormat.format(rb.getString(</span>
                        &quot;.{0}.extension.does.not.support.code.signing.&quot;), x));
                }
            }
        }
<span class="nc" id="L940">        return certStr.toString();</span>
    }

<span class="nc" id="L943">    private static MessageFormat signTimeForm = null;</span>

    private String printTimestamp(String tab, Timestamp timestamp) {

<span class="nc bnc" id="L947" title="All 2 branches missed.">        if (signTimeForm == null) {</span>
<span class="nc" id="L948">            signTimeForm =</span>
<span class="nc" id="L949">                new MessageFormat(rb.getString(&quot;entry.was.signed.on&quot;));</span>
        }
<span class="nc" id="L951">        Object[] source = { timestamp.getTimestamp() };</span>

<span class="nc" id="L953">        return new StringBuilder().append(tab).append(&quot;[&quot;)</span>
<span class="nc" id="L954">            .append(signTimeForm.format(source)).append(&quot;]&quot;).toString();</span>
    }

<span class="nc" id="L957">    private Map&lt;CodeSigner,Integer&gt; cacheForInKS = new IdentityHashMap&lt;&gt;();</span>

    private int inKeyStoreForOneSigner(CodeSigner signer) {
<span class="nc bnc" id="L960" title="All 2 branches missed.">        if (cacheForInKS.containsKey(signer)) {</span>
<span class="nc" id="L961">            return cacheForInKS.get(signer);</span>
        }

<span class="nc" id="L964">        boolean found = false;</span>
<span class="nc" id="L965">        int result = 0;</span>
<span class="nc" id="L966">        List&lt;? extends Certificate&gt; certs = signer.getSignerCertPath().getCertificates();</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">        for (Certificate c : certs) {</span>
<span class="nc" id="L968">            String alias = storeHash.get(c);</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">            if (alias != null) {</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">                if (alias.startsWith(&quot;(&quot;)) {</span>
<span class="nc" id="L971">                    result |= IN_KEYSTORE;</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">                } else if (alias.startsWith(&quot;[&quot;)) {</span>
<span class="nc" id="L973">                    result |= IN_SCOPE;</span>
                }
<span class="nc bnc" id="L975" title="All 2 branches missed.">                if (ckaliases.contains(alias.substring(1, alias.length() - 1))) {</span>
<span class="nc" id="L976">                    result |= SIGNED_BY_ALIAS;</span>
                }
            } else {
<span class="nc bnc" id="L979" title="All 2 branches missed.">                if (store != null) {</span>
                    try {
<span class="nc" id="L981">                        alias = store.getCertificateAlias(c);</span>
<span class="nc" id="L982">                    } catch (KeyStoreException kse) {</span>
                        // never happens, because keystore has been loaded
<span class="nc" id="L984">                    }</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">                    if (alias != null) {</span>
<span class="nc" id="L986">                        storeHash.put(c, &quot;(&quot; + alias + &quot;)&quot;);</span>
<span class="nc" id="L987">                        found = true;</span>
<span class="nc" id="L988">                        result |= IN_KEYSTORE;</span>
                    }
                }
<span class="nc bnc" id="L991" title="All 2 branches missed.">                if (ckaliases.contains(alias)) {</span>
<span class="nc" id="L992">                    result |= SIGNED_BY_ALIAS;</span>
                }
            }
<span class="nc" id="L995">        }</span>
<span class="nc" id="L996">        cacheForInKS.put(signer, result);</span>
<span class="nc" id="L997">        return result;</span>
    }

<span class="nc" id="L1000">    Hashtable&lt;Certificate, String&gt; storeHash = new Hashtable&lt;&gt;();</span>

    int inKeyStore(CodeSigner[] signers) {

<span class="nc bnc" id="L1004" title="All 2 branches missed.">        if (signers == null)</span>
<span class="nc" id="L1005">            return 0;</span>

<span class="nc" id="L1007">        int output = 0;</span>

<span class="nc bnc" id="L1009" title="All 2 branches missed.">        for (CodeSigner signer: signers) {</span>
<span class="nc" id="L1010">            int result = inKeyStoreForOneSigner(signer);</span>
<span class="nc" id="L1011">            output |= result;</span>
        }
<span class="nc bnc" id="L1013" title="All 4 branches missed.">        if (ckaliases.size() &gt; 0 &amp;&amp; (output &amp; SIGNED_BY_ALIAS) == 0) {</span>
<span class="nc" id="L1014">            output |= NOT_ALIAS;</span>
        }
<span class="nc" id="L1016">        return output;</span>
    }

    void signJar(String jarName, String alias, String[] args)
        throws Exception {
<span class="nc" id="L1021">        boolean aliasUsed = false;</span>
<span class="nc" id="L1022">        X509Certificate tsaCert = null;</span>

<span class="nc bnc" id="L1024" title="All 2 branches missed.">        if (sigfile == null) {</span>
<span class="nc" id="L1025">            sigfile = alias;</span>
<span class="nc" id="L1026">            aliasUsed = true;</span>
        }

<span class="nc bnc" id="L1029" title="All 2 branches missed.">        if (sigfile.length() &gt; 8) {</span>
<span class="nc" id="L1030">            sigfile = sigfile.substring(0, 8).toUpperCase(Locale.ENGLISH);</span>
        } else {
<span class="nc" id="L1032">            sigfile = sigfile.toUpperCase(Locale.ENGLISH);</span>
        }

<span class="nc" id="L1035">        StringBuilder tmpSigFile = new StringBuilder(sigfile.length());</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">        for (int j = 0; j &lt; sigfile.length(); j++) {</span>
<span class="nc" id="L1037">            char c = sigfile.charAt(j);</span>
<span class="nc bnc" id="L1038" title="All 12 branches missed.">            if (!</span>
                ((c&gt;= 'A' &amp;&amp; c&lt;= 'Z') ||
                (c&gt;= '0' &amp;&amp; c&lt;= '9') ||
                (c == '-') ||
                (c == '_'))) {
<span class="nc bnc" id="L1043" title="All 2 branches missed.">                if (aliasUsed) {</span>
                    // convert illegal characters from the alias to be _'s
<span class="nc" id="L1045">                    c = '_';</span>
                } else {
<span class="nc" id="L1047">                 throw new</span>
                   RuntimeException(rb.getString
<span class="nc" id="L1049">                        (&quot;signature.filename.must.consist.of.the.following.characters.A.Z.0.9.or.&quot;));</span>
                }
            }
<span class="nc" id="L1052">            tmpSigFile.append(c);</span>
        }

<span class="nc" id="L1055">        sigfile = tmpSigFile.toString();</span>

        String tmpJarName;
<span class="nc bnc" id="L1058" title="All 2 branches missed.">        if (signedjar == null) tmpJarName = jarName+&quot;.sig&quot;;</span>
<span class="nc" id="L1059">        else tmpJarName = signedjar;</span>

<span class="nc" id="L1061">        File jarFile = new File(jarName);</span>
<span class="nc" id="L1062">        File signedJarFile = new File(tmpJarName);</span>

        // Open the jar (zip) file
        try {
<span class="nc" id="L1066">            zipFile = new ZipFile(jarName);</span>
<span class="nc" id="L1067">        } catch (IOException ioe) {</span>
<span class="nc" id="L1068">            error(rb.getString(&quot;unable.to.open.jar.file.&quot;)+jarName, ioe);</span>
<span class="nc" id="L1069">        }</span>

<span class="nc" id="L1071">        FileOutputStream fos = null;</span>
        try {
<span class="nc" id="L1073">            fos = new FileOutputStream(signedJarFile);</span>
<span class="nc" id="L1074">        } catch (IOException ioe) {</span>
<span class="nc" id="L1075">            error(rb.getString(&quot;unable.to.create.&quot;)+tmpJarName, ioe);</span>
<span class="nc" id="L1076">        }</span>

<span class="nc" id="L1078">        PrintStream ps = new PrintStream(fos);</span>
<span class="nc" id="L1079">        ZipOutputStream zos = new ZipOutputStream(ps);</span>

        /* First guess at what they might be - we don't xclude RSA ones. */
<span class="nc" id="L1082">        String sfFilename = (META_INF + sigfile + &quot;.SF&quot;).toUpperCase(Locale.ENGLISH);</span>
<span class="nc" id="L1083">        String bkFilename = (META_INF + sigfile + &quot;.DSA&quot;).toUpperCase(Locale.ENGLISH);</span>

<span class="nc" id="L1085">        Manifest manifest = new Manifest();</span>
<span class="nc" id="L1086">        Map&lt;String,Attributes&gt; mfEntries = manifest.getEntries();</span>

        // The Attributes of manifest before updating
<span class="nc" id="L1089">        Attributes oldAttr = null;</span>

<span class="nc" id="L1091">        boolean mfModified = false;</span>
<span class="nc" id="L1092">        boolean mfCreated = false;</span>
<span class="nc" id="L1093">        byte[] mfRawBytes = null;</span>

        try {
<span class="nc" id="L1096">            MessageDigest digests[] = { MessageDigest.getInstance(digestalg) };</span>

            // Check if manifest exists
            ZipEntry mfFile;
<span class="nc bnc" id="L1100" title="All 2 branches missed.">            if ((mfFile = getManifestFile(zipFile)) != null) {</span>
                // Manifest exists. Read its raw bytes.
<span class="nc" id="L1102">                mfRawBytes = getBytes(zipFile, mfFile);</span>
<span class="nc" id="L1103">                manifest.read(new ByteArrayInputStream(mfRawBytes));</span>
<span class="nc" id="L1104">                oldAttr = (Attributes)(manifest.getMainAttributes().clone());</span>
            } else {
                // Create new manifest
<span class="nc" id="L1107">                Attributes mattr = manifest.getMainAttributes();</span>
<span class="nc" id="L1108">                mattr.putValue(Attributes.Name.MANIFEST_VERSION.toString(),</span>
                               &quot;1.0&quot;);
<span class="nc" id="L1110">                String javaVendor = System.getProperty(&quot;java.vendor&quot;);</span>
<span class="nc" id="L1111">                String jdkVersion = System.getProperty(&quot;java.version&quot;);</span>
<span class="nc" id="L1112">                mattr.putValue(&quot;Created-By&quot;, jdkVersion + &quot; (&quot; +javaVendor</span>
                               + &quot;)&quot;);
<span class="nc" id="L1114">                mfFile = new ZipEntry(JarFile.MANIFEST_NAME);</span>
<span class="nc" id="L1115">                mfCreated = true;</span>
            }

            /*
             * For each entry in jar
             * (except for signature-related META-INF entries),
             * do the following:
             *
             * - if entry is not contained in manifest, add it to manifest;
             * - if entry is contained in manifest, calculate its hash and
             *   compare it with the one in the manifest; if they are
             *   different, replace the hash in the manifest with the newly
             *   generated one. (This may invalidate existing signatures!)
             */
<span class="nc" id="L1129">            Vector&lt;ZipEntry&gt; mfFiles = new Vector&lt;&gt;();</span>

<span class="nc" id="L1131">            boolean wasSigned = false;</span>

<span class="nc" id="L1133">            for (Enumeration&lt;? extends ZipEntry&gt; enum_=zipFile.entries();</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">                        enum_.hasMoreElements();) {</span>
<span class="nc" id="L1135">                ZipEntry ze = enum_.nextElement();</span>

<span class="nc bnc" id="L1137" title="All 2 branches missed.">                if (ze.getName().startsWith(META_INF)) {</span>
                    // Store META-INF files in vector, so they can be written
                    // out first
<span class="nc" id="L1140">                    mfFiles.addElement(ze);</span>

<span class="nc bnc" id="L1142" title="All 2 branches missed.">                    if (SignatureFileVerifier.isBlockOrSF(</span>
<span class="nc" id="L1143">                            ze.getName().toUpperCase(Locale.ENGLISH))) {</span>
<span class="nc" id="L1144">                        wasSigned = true;</span>
                    }

<span class="nc bnc" id="L1147" title="All 2 branches missed.">                    if (signatureRelated(ze.getName())) {</span>
                        // ignore signature-related and manifest files
<span class="nc" id="L1149">                        continue;</span>
                    }
                }

<span class="nc bnc" id="L1153" title="All 2 branches missed.">                if (manifest.getAttributes(ze.getName()) != null) {</span>
                    // jar entry is contained in manifest, check and
                    // possibly update its digest attributes
<span class="nc bnc" id="L1156" title="All 2 branches missed.">                    if (updateDigests(ze, zipFile, digests,</span>
                                      manifest) == true) {
<span class="nc" id="L1158">                        mfModified = true;</span>
                    }
<span class="nc bnc" id="L1160" title="All 2 branches missed.">                } else if (!ze.isDirectory()) {</span>
                    // Add entry to manifest
<span class="nc" id="L1162">                    Attributes attrs = getDigestAttributes(ze, zipFile,</span>
                                                           digests);
<span class="nc" id="L1164">                    mfEntries.put(ze.getName(), attrs);</span>
<span class="nc" id="L1165">                    mfModified = true;</span>
                }
<span class="nc" id="L1167">            }</span>

            // Recalculate the manifest raw bytes if necessary
<span class="nc bnc" id="L1170" title="All 2 branches missed.">            if (mfModified) {</span>
<span class="nc" id="L1171">                ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L1172">                manifest.write(baos);</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">                if (wasSigned) {</span>
<span class="nc" id="L1174">                    byte[] newBytes = baos.toByteArray();</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">                    if (mfRawBytes != null</span>
<span class="nc bnc" id="L1176" title="All 2 branches missed.">                            &amp;&amp; oldAttr.equals(manifest.getMainAttributes())) {</span>

                        /*
                         * Note:
                         *
                         * The Attributes object is based on HashMap and can handle
                         * continuation columns. Therefore, even if the contents are
                         * not changed (in a Map view), the bytes that it write()
                         * may be different from the original bytes that it read()
                         * from. Since the signature on the main attributes is based
                         * on raw bytes, we must retain the exact bytes.
                         */

<span class="nc" id="L1189">                        int newPos = findHeaderEnd(newBytes);</span>
<span class="nc" id="L1190">                        int oldPos = findHeaderEnd(mfRawBytes);</span>

<span class="nc bnc" id="L1192" title="All 2 branches missed.">                        if (newPos == oldPos) {</span>
<span class="nc" id="L1193">                            System.arraycopy(mfRawBytes, 0, newBytes, 0, oldPos);</span>
                        } else {
                            // cat oldHead newTail &gt; newBytes
<span class="nc" id="L1196">                            byte[] lastBytes = new byte[oldPos +</span>
                                    newBytes.length - newPos];
<span class="nc" id="L1198">                            System.arraycopy(mfRawBytes, 0, lastBytes, 0, oldPos);</span>
<span class="nc" id="L1199">                            System.arraycopy(newBytes, newPos, lastBytes, oldPos,</span>
                                    newBytes.length - newPos);
<span class="nc" id="L1201">                            newBytes = lastBytes;</span>
                        }
                    }
<span class="nc" id="L1204">                    mfRawBytes = newBytes;</span>
<span class="nc" id="L1205">                } else {</span>
<span class="nc" id="L1206">                    mfRawBytes = baos.toByteArray();</span>
                }
            }

            // Write out the manifest
<span class="nc bnc" id="L1211" title="All 2 branches missed.">            if (mfModified) {</span>
                // manifest file has new length
<span class="nc" id="L1213">                mfFile = new ZipEntry(JarFile.MANIFEST_NAME);</span>
            }
<span class="nc bnc" id="L1215" title="All 2 branches missed.">            if (verbose != null) {</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">                if (mfCreated) {</span>
<span class="nc" id="L1217">                    System.out.println(rb.getString(&quot;.adding.&quot;) +</span>
<span class="nc" id="L1218">                                        mfFile.getName());</span>
<span class="nc bnc" id="L1219" title="All 2 branches missed.">                } else if (mfModified) {</span>
<span class="nc" id="L1220">                    System.out.println(rb.getString(&quot;.updating.&quot;) +</span>
<span class="nc" id="L1221">                                        mfFile.getName());</span>
                }
            }
<span class="nc" id="L1224">            zos.putNextEntry(mfFile);</span>
<span class="nc" id="L1225">            zos.write(mfRawBytes);</span>

            // Calculate SignatureFile (&quot;.SF&quot;) and SignatureBlockFile
<span class="nc" id="L1228">            ManifestDigester manDig = new ManifestDigester(mfRawBytes);</span>
<span class="nc" id="L1229">            SignatureFile sf = new SignatureFile(digests, manifest, manDig,</span>
                                                 sigfile, signManifest);

<span class="nc bnc" id="L1232" title="All 2 branches missed.">            if (tsaAlias != null) {</span>
<span class="nc" id="L1233">                tsaCert = getTsaCert(tsaAlias);</span>
            }

<span class="nc" id="L1236">            SignatureFile.Block block = null;</span>

            try {
<span class="nc" id="L1239">                block =</span>
<span class="nc" id="L1240">                    sf.generateBlock(privateKey, sigalg, certChain,</span>
                        externalSF, tsaUrl, tsaCert, tSAPolicyID, signingMechanism, args,
                        zipFile);
<span class="nc" id="L1243">            } catch (SocketTimeoutException e) {</span>
                // Provide a helpful message when TSA is beyond a firewall
<span class="nc" id="L1245">                error(rb.getString(&quot;unable.to.sign.jar.&quot;) +</span>
<span class="nc" id="L1246">                rb.getString(&quot;no.response.from.the.Timestamping.Authority.&quot;) +</span>
                &quot;\n  -J-Dhttp.proxyHost=&lt;hostname&gt;&quot; +
                &quot;\n  -J-Dhttp.proxyPort=&lt;portnumber&gt;\n&quot; +
<span class="nc" id="L1249">                rb.getString(&quot;or&quot;) +</span>
                &quot;\n  -J-Dhttps.proxyHost=&lt;hostname&gt; &quot; +
                &quot;\n  -J-Dhttps.proxyPort=&lt;portnumber&gt; &quot;, e);
<span class="nc" id="L1252">            }</span>

<span class="nc" id="L1254">            sfFilename = sf.getMetaName();</span>
<span class="nc" id="L1255">            bkFilename = block.getMetaName();</span>

<span class="nc" id="L1257">            ZipEntry sfFile = new ZipEntry(sfFilename);</span>
<span class="nc" id="L1258">            ZipEntry bkFile = new ZipEntry(bkFilename);</span>

<span class="nc" id="L1260">            long time = System.currentTimeMillis();</span>
<span class="nc" id="L1261">            sfFile.setTime(time);</span>
<span class="nc" id="L1262">            bkFile.setTime(time);</span>

            // signature file
<span class="nc" id="L1265">            zos.putNextEntry(sfFile);</span>
<span class="nc" id="L1266">            sf.write(zos);</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">            if (verbose != null) {</span>
<span class="nc bnc" id="L1268" title="All 2 branches missed.">                if (zipFile.getEntry(sfFilename) != null) {</span>
<span class="nc" id="L1269">                    System.out.println(rb.getString(&quot;.updating.&quot;) +</span>
                                sfFilename);
                } else {
<span class="nc" id="L1272">                    System.out.println(rb.getString(&quot;.adding.&quot;) +</span>
                                sfFilename);
                }
            }

<span class="nc bnc" id="L1277" title="All 2 branches missed.">            if (verbose != null) {</span>
<span class="nc bnc" id="L1278" title="All 4 branches missed.">                if (tsaUrl != null || tsaCert != null) {</span>
<span class="nc" id="L1279">                    System.out.println(</span>
<span class="nc" id="L1280">                        rb.getString(&quot;requesting.a.signature.timestamp&quot;));</span>
                }
<span class="nc bnc" id="L1282" title="All 2 branches missed.">                if (tsaUrl != null) {</span>
<span class="nc" id="L1283">                    System.out.println(rb.getString(&quot;TSA.location.&quot;) + tsaUrl);</span>
                }
<span class="nc bnc" id="L1285" title="All 2 branches missed.">                if (tsaCert != null) {</span>
<span class="nc" id="L1286">                    URI tsaURI = TimestampedSigner.getTimestampingURI(tsaCert);</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">                    if (tsaURI != null) {</span>
<span class="nc" id="L1288">                        System.out.println(rb.getString(&quot;TSA.location.&quot;) +</span>
                            tsaURI);
                    }
<span class="nc" id="L1291">                    System.out.println(rb.getString(&quot;TSA.certificate.&quot;) +</span>
<span class="nc" id="L1292">                        printCert(&quot;&quot;, tsaCert, false, null, false));</span>
                }
<span class="nc bnc" id="L1294" title="All 2 branches missed.">                if (signingMechanism != null) {</span>
<span class="nc" id="L1295">                    System.out.println(</span>
<span class="nc" id="L1296">                        rb.getString(&quot;using.an.alternative.signing.mechanism&quot;));</span>
                }
            }

            // signature block file
<span class="nc" id="L1301">            zos.putNextEntry(bkFile);</span>
<span class="nc" id="L1302">            block.write(zos);</span>
<span class="nc bnc" id="L1303" title="All 2 branches missed.">            if (verbose != null) {</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">                if (zipFile.getEntry(bkFilename) != null) {</span>
<span class="nc" id="L1305">                    System.out.println(rb.getString(&quot;.updating.&quot;) +</span>
                        bkFilename);
                } else {
<span class="nc" id="L1308">                    System.out.println(rb.getString(&quot;.adding.&quot;) +</span>
                        bkFilename);
                }
            }

            // Write out all other META-INF files that we stored in the
            // vector
<span class="nc bnc" id="L1315" title="All 2 branches missed.">            for (int i=0; i&lt;mfFiles.size(); i++) {</span>
<span class="nc" id="L1316">                ZipEntry ze = mfFiles.elementAt(i);</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">                if (!ze.getName().equalsIgnoreCase(JarFile.MANIFEST_NAME)</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">                    &amp;&amp; !ze.getName().equalsIgnoreCase(sfFilename)</span>
<span class="nc bnc" id="L1319" title="All 2 branches missed.">                    &amp;&amp; !ze.getName().equalsIgnoreCase(bkFilename)) {</span>
<span class="nc" id="L1320">                    writeEntry(zipFile, zos, ze);</span>
                }
            }

            // Write out all other files
<span class="nc" id="L1325">            for (Enumeration&lt;? extends ZipEntry&gt; enum_=zipFile.entries();</span>
<span class="nc bnc" id="L1326" title="All 2 branches missed.">                        enum_.hasMoreElements();) {</span>
<span class="nc" id="L1327">                ZipEntry ze = enum_.nextElement();</span>

<span class="nc bnc" id="L1329" title="All 2 branches missed.">                if (!ze.getName().startsWith(META_INF)) {</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">                    if (verbose != null) {</span>
<span class="nc bnc" id="L1331" title="All 2 branches missed.">                        if (manifest.getAttributes(ze.getName()) != null)</span>
<span class="nc" id="L1332">                          System.out.println(rb.getString(&quot;.signing.&quot;) +</span>
<span class="nc" id="L1333">                                ze.getName());</span>
                        else
<span class="nc" id="L1335">                          System.out.println(rb.getString(&quot;.adding.&quot;) +</span>
<span class="nc" id="L1336">                                ze.getName());</span>
                    }
<span class="nc" id="L1338">                    writeEntry(zipFile, zos, ze);</span>
                }
<span class="nc" id="L1340">            }</span>
<span class="nc" id="L1341">        } catch(IOException ioe) {</span>
<span class="nc" id="L1342">            error(rb.getString(&quot;unable.to.sign.jar.&quot;)+ioe, ioe);</span>
        } finally {
            // close the resouces
<span class="nc bnc" id="L1345" title="All 6 branches missed.">            if (zipFile != null) {</span>
<span class="nc" id="L1346">                zipFile.close();</span>
<span class="nc" id="L1347">                zipFile = null;</span>
            }

<span class="nc bnc" id="L1350" title="All 6 branches missed.">            if (zos != null) {</span>
<span class="nc" id="L1351">                zos.close();</span>
            }
        }

        // no IOException thrown in the follow try clause, so disable
        // the try clause.
        // try {
<span class="nc bnc" id="L1358" title="All 2 branches missed.">            if (signedjar == null) {</span>
                // attempt an atomic rename. If that fails,
                // rename the original jar file, then the signed
                // one, then delete the original.
<span class="nc bnc" id="L1362" title="All 2 branches missed.">                if (!signedJarFile.renameTo(jarFile)) {</span>
<span class="nc" id="L1363">                    File origJar = new File(jarName+&quot;.orig&quot;);</span>

<span class="nc bnc" id="L1365" title="All 2 branches missed.">                    if (jarFile.renameTo(origJar)) {</span>
<span class="nc bnc" id="L1366" title="All 2 branches missed.">                        if (signedJarFile.renameTo(jarFile)) {</span>
<span class="nc" id="L1367">                            origJar.delete();</span>
                        } else {
<span class="nc" id="L1369">                            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1370">                        (&quot;attempt.to.rename.signedJarFile.to.jarFile.failed&quot;));</span>
<span class="nc" id="L1371">                            Object[] source = {signedJarFile, jarFile};</span>
<span class="nc" id="L1372">                            error(form.format(source));</span>
<span class="nc" id="L1373">                        }</span>
                    } else {
<span class="nc" id="L1375">                        MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1376">                            (&quot;attempt.to.rename.jarFile.to.origJar.failed&quot;));</span>
<span class="nc" id="L1377">                        Object[] source = {jarFile, origJar};</span>
<span class="nc" id="L1378">                        error(form.format(source));</span>
                    }
                }
            }

<span class="nc bnc" id="L1383" title="All 14 branches missed.">            if (hasExpiredCert || hasExpiringCert || notYetValidCert</span>
                    || badKeyUsage || badExtendedKeyUsage
                    || badNetscapeCertType || chainNotValidated) {
<span class="nc" id="L1386">                System.out.println();</span>

<span class="nc" id="L1388">                System.out.println(rb.getString(&quot;Warning.&quot;));</span>
<span class="nc bnc" id="L1389" title="All 2 branches missed.">                if (badKeyUsage) {</span>
<span class="nc" id="L1390">                    System.out.println(</span>
<span class="nc" id="L1391">                        rb.getString(&quot;The.signer.certificate.s.KeyUsage.extension.doesn.t.allow.code.signing.&quot;));</span>
                }

<span class="nc bnc" id="L1394" title="All 2 branches missed.">                if (badExtendedKeyUsage) {</span>
<span class="nc" id="L1395">                    System.out.println(</span>
<span class="nc" id="L1396">                        rb.getString(&quot;The.signer.certificate.s.ExtendedKeyUsage.extension.doesn.t.allow.code.signing.&quot;));</span>
                }

<span class="nc bnc" id="L1399" title="All 2 branches missed.">                if (badNetscapeCertType) {</span>
<span class="nc" id="L1400">                    System.out.println(</span>
<span class="nc" id="L1401">                        rb.getString(&quot;The.signer.certificate.s.NetscapeCertType.extension.doesn.t.allow.code.signing.&quot;));</span>
                }

<span class="nc bnc" id="L1404" title="All 2 branches missed.">                if (hasExpiredCert) {</span>
<span class="nc" id="L1405">                    System.out.println(</span>
<span class="nc" id="L1406">                        rb.getString(&quot;The.signer.certificate.has.expired.&quot;));</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">                } else if (hasExpiringCert) {</span>
<span class="nc" id="L1408">                    System.out.println(</span>
<span class="nc" id="L1409">                        rb.getString(&quot;The.signer.certificate.will.expire.within.six.months.&quot;));</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">                } else if (notYetValidCert) {</span>
<span class="nc" id="L1411">                    System.out.println(</span>
<span class="nc" id="L1412">                        rb.getString(&quot;The.signer.certificate.is.not.yet.valid.&quot;));</span>
                }

<span class="nc bnc" id="L1415" title="All 2 branches missed.">                if (chainNotValidated) {</span>
<span class="nc" id="L1416">                    System.out.println(</span>
<span class="nc" id="L1417">                            rb.getString(&quot;The.signer.s.certificate.chain.is.not.validated.&quot;));</span>
                }
            }

        // no IOException thrown in the above try clause, so disable
        // the catch clause.
        // } catch(IOException ioe) {
        //     error(rb.getString(&quot;unable.to.sign.jar.&quot;)+ioe, ioe);
        // }
<span class="nc" id="L1426">    }</span>

    /**
     * Find the length of header inside bs. The header is a multiple (&gt;=0)
     * lines of attributes plus an empty line. The empty line is included
     * in the header.
     */
    @SuppressWarnings(&quot;fallthrough&quot;)
    private int findHeaderEnd(byte[] bs) {
        // Initial state true to deal with empty header
<span class="nc" id="L1436">        boolean newline = true;     // just met a newline</span>
<span class="nc" id="L1437">        int len = bs.length;</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">        for (int i=0; i&lt;len; i++) {</span>
<span class="nc bnc" id="L1439" title="All 3 branches missed.">            switch (bs[i]) {</span>
                case '\r':
<span class="nc bnc" id="L1441" title="All 4 branches missed.">                    if (i &lt; len - 1 &amp;&amp; bs[i+1] == '\n') i++;</span>
                    // fallthrough
                case '\n':
<span class="nc bnc" id="L1444" title="All 2 branches missed.">                    if (newline) return i+1;    //+1 to get length</span>
<span class="nc" id="L1445">                    newline = true;</span>
<span class="nc" id="L1446">                    break;</span>
                default:
<span class="nc" id="L1448">                    newline = false;</span>
            }
        }
        // If header end is not found, it means the MANIFEST.MF has only
        // the main attributes section and it does not end with 2 newlines.
        // Returns the whole length so that it can be completely replaced.
<span class="nc" id="L1454">        return len;</span>
    }

    /**
     * signature-related files include:
     * . META-INF/MANIFEST.MF
     * . META-INF/SIG-*
     * . META-INF/*.SF
     * . META-INF/*.DSA
     * . META-INF/*.RSA
     * . META-INF/*.EC
     */
    private boolean signatureRelated(String name) {
<span class="nc" id="L1467">        String ucName = name.toUpperCase(Locale.ENGLISH);</span>
<span class="nc bnc" id="L1468" title="All 2 branches missed.">        if (ucName.equals(JarFile.MANIFEST_NAME) ||</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">            ucName.equals(META_INF) ||</span>
<span class="nc bnc" id="L1470" title="All 2 branches missed.">            (ucName.startsWith(SIG_PREFIX) &amp;&amp;</span>
<span class="nc bnc" id="L1471" title="All 2 branches missed.">                ucName.indexOf(&quot;/&quot;) == ucName.lastIndexOf(&quot;/&quot;))) {</span>
<span class="nc" id="L1472">            return true;</span>
        }

<span class="nc bnc" id="L1475" title="All 2 branches missed.">        if (ucName.startsWith(META_INF) &amp;&amp;</span>
<span class="nc bnc" id="L1476" title="All 2 branches missed.">            SignatureFileVerifier.isBlockOrSF(ucName)) {</span>
            // .SF/.DSA/.RSA/.EC files in META-INF subdirs
            // are not considered signature-related
<span class="nc bnc" id="L1479" title="All 2 branches missed.">            return (ucName.indexOf(&quot;/&quot;) == ucName.lastIndexOf(&quot;/&quot;));</span>
        }

<span class="nc" id="L1482">        return false;</span>
    }

<span class="nc" id="L1485">    Map&lt;CodeSigner,String&gt; cacheForSignerInfo = new IdentityHashMap&lt;&gt;();</span>

    /**
     * Returns a string of singer info, with a newline at the end
     */
    private String signerInfo(CodeSigner signer, String tab) {
<span class="nc bnc" id="L1491" title="All 2 branches missed.">        if (cacheForSignerInfo.containsKey(signer)) {</span>
<span class="nc" id="L1492">            return cacheForSignerInfo.get(signer);</span>
        }
<span class="nc" id="L1494">        StringBuffer s = new StringBuffer();</span>
<span class="nc" id="L1495">        List&lt;? extends Certificate&gt; certs = signer.getSignerCertPath().getCertificates();</span>
        // display the signature timestamp, if present
        Date timestamp;
<span class="nc" id="L1498">        Timestamp ts = signer.getTimestamp();</span>
<span class="nc bnc" id="L1499" title="All 2 branches missed.">        if (ts != null) {</span>
<span class="nc" id="L1500">            s.append(printTimestamp(tab, ts));</span>
<span class="nc" id="L1501">            s.append('\n');</span>
<span class="nc" id="L1502">            timestamp = ts.getTimestamp();</span>
        } else {
<span class="nc" id="L1504">            timestamp = null;</span>
        }
        // display the certificate(s). The first one is end-entity cert and
        // its KeyUsage should be checked.
<span class="nc" id="L1508">        boolean first = true;</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">        for (Certificate c : certs) {</span>
<span class="nc" id="L1510">            s.append(printCert(tab, c, true, timestamp, first));</span>
<span class="nc" id="L1511">            s.append('\n');</span>
<span class="nc" id="L1512">            first = false;</span>
<span class="nc" id="L1513">        }</span>
        try {
<span class="nc" id="L1515">            CertPath cp = certificateFactory.generateCertPath(certs);</span>
<span class="nc" id="L1516">            validator.validate(cp, pkixParameters);</span>
<span class="nc" id="L1517">        } catch (Exception e) {</span>
<span class="nc bnc" id="L1518" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L1519">                e.printStackTrace();</span>
            }
<span class="nc bnc" id="L1521" title="All 2 branches missed.">            if (e.getCause() != null &amp;&amp;</span>
<span class="nc bnc" id="L1522" title="All 2 branches missed.">                    (e.getCause() instanceof CertificateExpiredException ||</span>
<span class="nc bnc" id="L1523" title="All 2 branches missed.">                     e.getCause() instanceof CertificateNotYetValidException)) {</span>
                // No more warning, we alreay have hasExpiredCert or notYetValidCert
            } else {
<span class="nc" id="L1526">                chainNotValidated = true;</span>
<span class="nc" id="L1527">                s.append(tab + rb.getString(&quot;.CertPath.not.validated.&quot;) +</span>
<span class="nc" id="L1528">                        e.getLocalizedMessage() + &quot;]\n&quot;);   // TODO</span>
            }
<span class="nc" id="L1530">        }</span>
<span class="nc" id="L1531">        String result = s.toString();</span>
<span class="nc" id="L1532">        cacheForSignerInfo.put(signer, result);</span>
<span class="nc" id="L1533">        return result;</span>
    }

    private void writeEntry(ZipFile zf, ZipOutputStream os, ZipEntry ze)
    throws IOException
    {
<span class="nc" id="L1539">        ZipEntry ze2 = new ZipEntry(ze.getName());</span>
<span class="nc" id="L1540">        ze2.setMethod(ze.getMethod());</span>
<span class="nc" id="L1541">        ze2.setTime(ze.getTime());</span>
<span class="nc" id="L1542">        ze2.setComment(ze.getComment());</span>
<span class="nc" id="L1543">        ze2.setExtra(ze.getExtra());</span>
<span class="nc bnc" id="L1544" title="All 2 branches missed.">        if (ze.getMethod() == ZipEntry.STORED) {</span>
<span class="nc" id="L1545">            ze2.setSize(ze.getSize());</span>
<span class="nc" id="L1546">            ze2.setCrc(ze.getCrc());</span>
        }
<span class="nc" id="L1548">        os.putNextEntry(ze2);</span>
<span class="nc" id="L1549">        writeBytes(zf, ze, os);</span>
<span class="nc" id="L1550">    }</span>

    /**
     * Writes all the bytes for a given entry to the specified output stream.
     */
    private synchronized void writeBytes
        (ZipFile zf, ZipEntry ze, ZipOutputStream os) throws IOException {
        int n;

<span class="nc" id="L1559">        InputStream is = null;</span>
        try {
<span class="nc" id="L1561">            is = zf.getInputStream(ze);</span>
<span class="nc" id="L1562">            long left = ze.getSize();</span>

<span class="nc bnc" id="L1564" title="All 4 branches missed.">            while((left &gt; 0) &amp;&amp; (n = is.read(buffer, 0, buffer.length)) != -1) {</span>
<span class="nc" id="L1565">                os.write(buffer, 0, n);</span>
<span class="nc" id="L1566">                left -= n;</span>
            }
        } finally {
<span class="nc bnc" id="L1569" title="All 4 branches missed.">            if (is != null) {</span>
<span class="nc" id="L1570">                is.close();</span>
            }
        }
<span class="nc" id="L1573">    }</span>

    void loadKeyStore(String keyStoreName, boolean prompt) {

<span class="nc bnc" id="L1577" title="All 4 branches missed.">        if (!nullStream &amp;&amp; keyStoreName == null) {</span>
<span class="nc" id="L1578">            keyStoreName = System.getProperty(&quot;user.home&quot;) + File.separator</span>
                + &quot;.keystore&quot;;
        }

        try {

<span class="nc" id="L1584">            certificateFactory = CertificateFactory.getInstance(&quot;X.509&quot;);</span>
<span class="nc" id="L1585">            validator = CertPathValidator.getInstance(&quot;PKIX&quot;);</span>
<span class="nc" id="L1586">            Set&lt;TrustAnchor&gt; tas = new HashSet&lt;&gt;();</span>
            try {
<span class="nc" id="L1588">                KeyStore caks = KeyStoreUtil.getCacertsKeyStore();</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">                if (caks != null) {</span>
<span class="nc" id="L1590">                    Enumeration&lt;String&gt; aliases = caks.aliases();</span>
<span class="nc bnc" id="L1591" title="All 2 branches missed.">                    while (aliases.hasMoreElements()) {</span>
<span class="nc" id="L1592">                        String a = aliases.nextElement();</span>
                        try {
<span class="nc" id="L1594">                            tas.add(new TrustAnchor((X509Certificate)caks.getCertificate(a), null));</span>
<span class="nc" id="L1595">                        } catch (Exception e2) {</span>
                            // ignore, when a SecretkeyEntry does not include a cert
<span class="nc" id="L1597">                        }</span>
<span class="nc" id="L1598">                    }</span>
                }
<span class="nc" id="L1600">            } catch (Exception e) {</span>
                // Ignore, if cacerts cannot be loaded
<span class="nc" id="L1602">            }</span>

<span class="nc bnc" id="L1604" title="All 2 branches missed.">            if (providerName == null) {</span>
<span class="nc" id="L1605">                store = KeyStore.getInstance(storetype);</span>
            } else {
<span class="nc" id="L1607">                store = KeyStore.getInstance(storetype, providerName);</span>
            }

            // Get pass phrase
            // XXX need to disable echo; on UNIX, call getpass(char *prompt)Z
            // and on NT call ??
<span class="nc bnc" id="L1613" title="All 6 branches missed.">            if (token &amp;&amp; storepass == null &amp;&amp; !protectedPath</span>
<span class="nc bnc" id="L1614" title="All 2 branches missed.">                    &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype)) {</span>
<span class="nc" id="L1615">                storepass = getPass</span>
<span class="nc" id="L1616">                        (rb.getString(&quot;Enter.Passphrase.for.keystore.&quot;));</span>
<span class="nc bnc" id="L1617" title="All 6 branches missed.">            } else if (!token &amp;&amp; storepass == null &amp;&amp; prompt) {</span>
<span class="nc" id="L1618">                storepass = getPass</span>
<span class="nc" id="L1619">                        (rb.getString(&quot;Enter.Passphrase.for.keystore.&quot;));</span>
            }

            try {
<span class="nc bnc" id="L1623" title="All 2 branches missed.">                if (nullStream) {</span>
<span class="nc" id="L1624">                    store.load(null, storepass);</span>
                } else {
<span class="nc" id="L1626">                    keyStoreName = keyStoreName.replace(File.separatorChar, '/');</span>
<span class="nc" id="L1627">                    URL url = null;</span>
                    try {
<span class="nc" id="L1629">                        url = new URL(keyStoreName);</span>
<span class="nc" id="L1630">                    } catch (java.net.MalformedURLException e) {</span>
                        // try as file
<span class="nc" id="L1632">                        url = new File(keyStoreName).toURI().toURL();</span>
<span class="nc" id="L1633">                    }</span>
<span class="nc" id="L1634">                    InputStream is = null;</span>
                    try {
<span class="nc" id="L1636">                        is = url.openStream();</span>
<span class="nc" id="L1637">                        store.load(is, storepass);</span>
                    } finally {
<span class="nc bnc" id="L1639" title="All 4 branches missed.">                        if (is != null) {</span>
<span class="nc" id="L1640">                            is.close();</span>
                        }
                    }
                }
<span class="nc" id="L1644">                Enumeration&lt;String&gt; aliases = store.aliases();</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">                while (aliases.hasMoreElements()) {</span>
<span class="nc" id="L1646">                    String a = aliases.nextElement();</span>
                    try {
<span class="nc" id="L1648">                        X509Certificate c = (X509Certificate)store.getCertificate(a);</span>
                        // Only add TrustedCertificateEntry and self-signed
                        // PrivateKeyEntry
<span class="nc bnc" id="L1651" title="All 2 branches missed.">                        if (store.isCertificateEntry(a) ||</span>
<span class="nc bnc" id="L1652" title="All 2 branches missed.">                                c.getSubjectDN().equals(c.getIssuerDN())) {</span>
<span class="nc" id="L1653">                            tas.add(new TrustAnchor(c, null));</span>
                        }
<span class="nc" id="L1655">                    } catch (Exception e2) {</span>
                        // ignore, when a SecretkeyEntry does not include a cert
<span class="nc" id="L1657">                    }</span>
<span class="nc" id="L1658">                }</span>
            } finally {
<span class="nc" id="L1660">                try {</span>
<span class="nc" id="L1661">                    pkixParameters = new PKIXParameters(tas);</span>
<span class="nc" id="L1662">                    pkixParameters.setRevocationEnabled(false);</span>
<span class="nc" id="L1663">                } catch (InvalidAlgorithmParameterException ex) {</span>
                    // Only if tas is empty
<span class="nc" id="L1665">                }</span>
<span class="nc" id="L1666">            }</span>
<span class="nc" id="L1667">        } catch (IOException ioe) {</span>
<span class="nc" id="L1668">            throw new RuntimeException(rb.getString(&quot;keystore.load.&quot;) +</span>
<span class="nc" id="L1669">                                        ioe.getMessage());</span>
<span class="nc" id="L1670">        } catch (java.security.cert.CertificateException ce) {</span>
<span class="nc" id="L1671">            throw new RuntimeException(rb.getString(&quot;certificate.exception.&quot;) +</span>
<span class="nc" id="L1672">                                        ce.getMessage());</span>
<span class="nc" id="L1673">        } catch (NoSuchProviderException pe) {</span>
<span class="nc" id="L1674">            throw new RuntimeException(rb.getString(&quot;keystore.load.&quot;) +</span>
<span class="nc" id="L1675">                                        pe.getMessage());</span>
<span class="nc" id="L1676">        } catch (NoSuchAlgorithmException nsae) {</span>
<span class="nc" id="L1677">            throw new RuntimeException(rb.getString(&quot;keystore.load.&quot;) +</span>
<span class="nc" id="L1678">                                        nsae.getMessage());</span>
<span class="nc" id="L1679">        } catch (KeyStoreException kse) {</span>
<span class="nc" id="L1680">            throw new RuntimeException</span>
<span class="nc" id="L1681">                (rb.getString(&quot;unable.to.instantiate.keystore.class.&quot;) +</span>
<span class="nc" id="L1682">                kse.getMessage());</span>
<span class="nc" id="L1683">        }</span>
<span class="nc" id="L1684">    }</span>

    X509Certificate getTsaCert(String alias) {

<span class="nc" id="L1688">        java.security.cert.Certificate cs = null;</span>

        try {
<span class="nc" id="L1691">            cs = store.getCertificate(alias);</span>
<span class="nc" id="L1692">        } catch (KeyStoreException kse) {</span>
            // this never happens, because keystore has been loaded
<span class="nc" id="L1694">        }</span>
<span class="nc bnc" id="L1695" title="All 4 branches missed.">        if (cs == null || (!(cs instanceof X509Certificate))) {</span>
<span class="nc" id="L1696">            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1697">                (&quot;Certificate.not.found.for.alias.alias.must.reference.a.valid.KeyStore.entry.containing.an.X.509.public.key.certificate.for.the&quot;));</span>
<span class="nc" id="L1698">            Object[] source = {alias, alias};</span>
<span class="nc" id="L1699">            error(form.format(source));</span>
        }
<span class="nc" id="L1701">        return (X509Certificate) cs;</span>
    }

    /**
     * Check if userCert is designed to be a code signer
     * @param userCert the certificate to be examined
     * @param bad 3 booleans to show if the KeyUsage, ExtendedKeyUsage,
     *            NetscapeCertType has codeSigning flag turned on.
     *            If null, the class field badKeyUsage, badExtendedKeyUsage,
     *            badNetscapeCertType will be set.
     */
    void checkCertUsage(X509Certificate userCert, boolean[] bad) {

        // Can act as a signer?
        // 1. if KeyUsage, then [0:digitalSignature] or
        //    [1:nonRepudiation] should be true
        // 2. if ExtendedKeyUsage, then should contains ANY or CODE_SIGNING
        // 3. if NetscapeCertType, then should contains OBJECT_SIGNING
        // 1,2,3 must be true

<span class="nc bnc" id="L1721" title="All 2 branches missed.">        if (bad != null) {</span>
<span class="nc" id="L1722">            bad[0] = bad[1] = bad[2] = false;</span>
        }

<span class="nc" id="L1725">        boolean[] keyUsage = userCert.getKeyUsage();</span>
<span class="nc bnc" id="L1726" title="All 2 branches missed.">        if (keyUsage != null) {</span>
<span class="nc" id="L1727">            keyUsage = Arrays.copyOf(keyUsage, 9);</span>
<span class="nc bnc" id="L1728" title="All 4 branches missed.">            if (!keyUsage[0] &amp;&amp; !keyUsage[1]) {</span>
<span class="nc bnc" id="L1729" title="All 2 branches missed.">                if (bad != null) {</span>
<span class="nc" id="L1730">                    bad[0] = true;</span>
<span class="nc" id="L1731">                    badKeyUsage = true;</span>
                }
            }
        }

        try {
<span class="nc" id="L1737">            List&lt;String&gt; xKeyUsage = userCert.getExtendedKeyUsage();</span>
<span class="nc bnc" id="L1738" title="All 2 branches missed.">            if (xKeyUsage != null) {</span>
<span class="nc bnc" id="L1739" title="All 2 branches missed.">                if (!xKeyUsage.contains(&quot;2.5.29.37.0&quot;) // anyExtendedKeyUsage</span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">                        &amp;&amp; !xKeyUsage.contains(&quot;1.3.6.1.5.5.7.3.3&quot;)) {  // codeSigning</span>
<span class="nc bnc" id="L1741" title="All 2 branches missed.">                    if (bad != null) {</span>
<span class="nc" id="L1742">                        bad[1] = true;</span>
<span class="nc" id="L1743">                        badExtendedKeyUsage = true;</span>
                    }
                }
            }
<span class="nc" id="L1747">        } catch (java.security.cert.CertificateParsingException e) {</span>
            // shouldn't happen
<span class="nc" id="L1749">        }</span>

        try {
            // OID_NETSCAPE_CERT_TYPE
<span class="nc" id="L1753">            byte[] netscapeEx = userCert.getExtensionValue</span>
<span class="nc" id="L1754">                    (&quot;2.16.840.1.113730.1.1&quot;);</span>
<span class="nc bnc" id="L1755" title="All 2 branches missed.">            if (netscapeEx != null) {</span>
<span class="nc" id="L1756">                DerInputStream in = new DerInputStream(netscapeEx);</span>
<span class="nc" id="L1757">                byte[] encoded = in.getOctetString();</span>
<span class="nc" id="L1758">                encoded = new DerValue(encoded).getUnalignedBitString()</span>
<span class="nc" id="L1759">                        .toByteArray();</span>

<span class="nc" id="L1761">                NetscapeCertTypeExtension extn =</span>
                        new NetscapeCertTypeExtension(encoded);

<span class="nc" id="L1764">                Boolean val = extn.get(NetscapeCertTypeExtension.OBJECT_SIGNING);</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">                if (!val) {</span>
<span class="nc bnc" id="L1766" title="All 2 branches missed.">                    if (bad != null) {</span>
<span class="nc" id="L1767">                        bad[2] = true;</span>
<span class="nc" id="L1768">                        badNetscapeCertType = true;</span>
                    }
                }
            }
<span class="nc" id="L1772">        } catch (IOException e) {</span>
            //
<span class="nc" id="L1774">        }</span>
<span class="nc" id="L1775">    }</span>

    void getAliasInfo(String alias) {

<span class="nc" id="L1779">        Key key = null;</span>

        try {
<span class="nc" id="L1782">            java.security.cert.Certificate[] cs = null;</span>
<span class="nc bnc" id="L1783" title="All 2 branches missed.">            if (altCertChain != null) {</span>
<span class="nc" id="L1784">                try (FileInputStream fis = new FileInputStream(altCertChain)) {</span>
<span class="nc" id="L1785">                    cs = CertificateFactory.getInstance(&quot;X.509&quot;).</span>
<span class="nc" id="L1786">                            generateCertificates(fis).</span>
<span class="nc" id="L1787">                            toArray(new Certificate[0]);</span>
<span class="nc bnc" id="L1788" title="All 8 branches missed.">                } catch (FileNotFoundException ex) {</span>
<span class="nc" id="L1789">                    error(rb.getString(&quot;File.specified.by.certchain.does.not.exist&quot;));</span>
<span class="nc" id="L1790">                } catch (CertificateException | IOException ex) {</span>
<span class="nc" id="L1791">                    error(rb.getString(&quot;Cannot.restore.certchain.from.file.specified&quot;));</span>
<span class="nc" id="L1792">                }</span>
            } else {
                try {
<span class="nc" id="L1795">                    cs = store.getCertificateChain(alias);</span>
<span class="nc" id="L1796">                } catch (KeyStoreException kse) {</span>
                    // this never happens, because keystore has been loaded
<span class="nc" id="L1798">                }</span>
            }
<span class="nc bnc" id="L1800" title="All 4 branches missed.">            if (cs == null || cs.length == 0) {</span>
<span class="nc bnc" id="L1801" title="All 2 branches missed.">                if (altCertChain != null) {</span>
<span class="nc" id="L1802">                    error(rb.getString</span>
<span class="nc" id="L1803">                            (&quot;Certificate.chain.not.found.in.the.file.specified.&quot;));</span>
                } else {
<span class="nc" id="L1805">                    MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1806">                        (&quot;Certificate.chain.not.found.for.alias.alias.must.reference.a.valid.KeyStore.key.entry.containing.a.private.key.and&quot;));</span>
<span class="nc" id="L1807">                    Object[] source = {alias, alias};</span>
<span class="nc" id="L1808">                    error(form.format(source));</span>
                }
            }

<span class="nc" id="L1812">            certChain = new X509Certificate[cs.length];</span>
<span class="nc bnc" id="L1813" title="All 2 branches missed.">            for (int i=0; i&lt;cs.length; i++) {</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">                if (!(cs[i] instanceof X509Certificate)) {</span>
<span class="nc" id="L1815">                    error(rb.getString</span>
<span class="nc" id="L1816">                        (&quot;found.non.X.509.certificate.in.signer.s.chain&quot;));</span>
                }
<span class="nc" id="L1818">                certChain[i] = (X509Certificate)cs[i];</span>
            }

            // We don't meant to print anything, the next call
            // checks validity and keyUsage etc
<span class="nc" id="L1823">            printCert(&quot;&quot;, certChain[0], true, null, true);</span>

            try {
<span class="nc" id="L1826">                CertPath cp = certificateFactory.generateCertPath(Arrays.asList(certChain));</span>
<span class="nc" id="L1827">                validator.validate(cp, pkixParameters);</span>
<span class="nc" id="L1828">            } catch (Exception e) {</span>
<span class="nc bnc" id="L1829" title="All 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L1830">                    e.printStackTrace();</span>
                }
<span class="nc bnc" id="L1832" title="All 2 branches missed.">                if (e.getCause() != null &amp;&amp;</span>
<span class="nc bnc" id="L1833" title="All 2 branches missed.">                        (e.getCause() instanceof CertificateExpiredException ||</span>
<span class="nc bnc" id="L1834" title="All 2 branches missed.">                        e.getCause() instanceof CertificateNotYetValidException)) {</span>
                    // No more warning, we alreay have hasExpiredCert or notYetValidCert
                } else {
<span class="nc" id="L1837">                    chainNotValidated = true;</span>
                }
<span class="nc" id="L1839">            }</span>

            try {
<span class="nc bnc" id="L1842" title="All 4 branches missed.">                if (!token &amp;&amp; keypass == null)</span>
<span class="nc" id="L1843">                    key = store.getKey(alias, storepass);</span>
                else
<span class="nc" id="L1845">                    key = store.getKey(alias, keypass);</span>
<span class="nc" id="L1846">            } catch (UnrecoverableKeyException e) {</span>
<span class="nc bnc" id="L1847" title="All 2 branches missed.">                if (token) {</span>
<span class="nc" id="L1848">                    throw e;</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">                } else if (keypass == null) {</span>
                    // Did not work out, so prompt user for key password
<span class="nc" id="L1851">                    MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1852">                        (&quot;Enter.key.password.for.alias.&quot;));</span>
<span class="nc" id="L1853">                    Object[] source = {alias};</span>
<span class="nc" id="L1854">                    keypass = getPass(form.format(source));</span>
<span class="nc" id="L1855">                    key = store.getKey(alias, keypass);</span>
                }
<span class="nc" id="L1857">            }</span>
<span class="nc" id="L1858">        } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L1859">            error(e.getMessage());</span>
<span class="nc" id="L1860">        } catch (UnrecoverableKeyException e) {</span>
<span class="nc" id="L1861">            error(rb.getString(&quot;unable.to.recover.key.from.keystore&quot;));</span>
<span class="nc" id="L1862">        } catch (KeyStoreException kse) {</span>
            // this never happens, because keystore has been loaded
<span class="nc" id="L1864">        }</span>

<span class="nc bnc" id="L1866" title="All 2 branches missed.">        if (!(key instanceof PrivateKey)) {</span>
<span class="nc" id="L1867">            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1868">                (&quot;key.associated.with.alias.not.a.private.key&quot;));</span>
<span class="nc" id="L1869">            Object[] source = {alias};</span>
<span class="nc" id="L1870">            error(form.format(source));</span>
<span class="nc" id="L1871">        } else {</span>
<span class="nc" id="L1872">            privateKey = (PrivateKey)key;</span>
        }
<span class="nc" id="L1874">    }</span>

    void error(String message)
    {
<span class="nc" id="L1878">        System.out.println(rb.getString(&quot;jarsigner.&quot;)+message);</span>
<span class="nc" id="L1879">        System.exit(1);</span>
<span class="nc" id="L1880">    }</span>


    void error(String message, Exception e)
    {
<span class="nc" id="L1885">        System.out.println(rb.getString(&quot;jarsigner.&quot;)+message);</span>
<span class="nc bnc" id="L1886" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L1887">            e.printStackTrace();</span>
        }
<span class="nc" id="L1889">        System.exit(1);</span>
<span class="nc" id="L1890">    }</span>

    char[] getPass(String prompt)
    {
<span class="nc" id="L1894">        System.err.print(prompt);</span>
<span class="nc" id="L1895">        System.err.flush();</span>
        try {
<span class="nc" id="L1897">            char[] pass = Password.readPassword(System.in);</span>

<span class="nc bnc" id="L1899" title="All 2 branches missed.">            if (pass == null) {</span>
<span class="nc" id="L1900">                error(rb.getString(&quot;you.must.enter.key.password&quot;));</span>
            } else {
<span class="nc" id="L1902">                return pass;</span>
            }
<span class="nc" id="L1904">        } catch (IOException ioe) {</span>
<span class="nc" id="L1905">            error(rb.getString(&quot;unable.to.read.password.&quot;)+ioe.getMessage());</span>
<span class="nc" id="L1906">        }</span>
        // this shouldn't happen
<span class="nc" id="L1908">        return null;</span>
    }

    /*
     * Reads all the bytes for a given zip entry.
     */
    private synchronized byte[] getBytes(ZipFile zf,
                                         ZipEntry ze) throws IOException {
        int n;

<span class="nc" id="L1918">        InputStream is = null;</span>
        try {
<span class="nc" id="L1920">            is = zf.getInputStream(ze);</span>
<span class="nc" id="L1921">            baos.reset();</span>
<span class="nc" id="L1922">            long left = ze.getSize();</span>

<span class="nc bnc" id="L1924" title="All 4 branches missed.">            while((left &gt; 0) &amp;&amp; (n = is.read(buffer, 0, buffer.length)) != -1) {</span>
<span class="nc" id="L1925">                baos.write(buffer, 0, n);</span>
<span class="nc" id="L1926">                left -= n;</span>
            }
        } finally {
<span class="nc bnc" id="L1929" title="All 4 branches missed.">            if (is != null) {</span>
<span class="nc" id="L1930">                is.close();</span>
            }
        }

<span class="nc" id="L1934">        return baos.toByteArray();</span>
    }

    /*
     * Returns manifest entry from given jar file, or null if given jar file
     * does not have a manifest entry.
     */
    private ZipEntry getManifestFile(ZipFile zf) {
<span class="nc" id="L1942">        ZipEntry ze = zf.getEntry(JarFile.MANIFEST_NAME);</span>
<span class="nc bnc" id="L1943" title="All 2 branches missed.">        if (ze == null) {</span>
            // Check all entries for matching name
<span class="nc" id="L1945">            Enumeration&lt;? extends ZipEntry&gt; enum_ = zf.entries();</span>
<span class="nc bnc" id="L1946" title="All 4 branches missed.">            while (enum_.hasMoreElements() &amp;&amp; ze == null) {</span>
<span class="nc" id="L1947">                ze = enum_.nextElement();</span>
<span class="nc" id="L1948">                if (!JarFile.MANIFEST_NAME.equalsIgnoreCase</span>
<span class="nc bnc" id="L1949" title="All 2 branches missed.">                    (ze.getName())) {</span>
<span class="nc" id="L1950">                    ze = null;</span>
                }
            }
        }
<span class="nc" id="L1954">        return ze;</span>
    }

    /*
     * Computes the digests of a zip entry, and returns them as an array
     * of base64-encoded strings.
     */
    private synchronized String[] getDigests(ZipEntry ze, ZipFile zf,
                                             MessageDigest[] digests)
        throws IOException {

        int n, i;
<span class="nc" id="L1966">        InputStream is = null;</span>
        try {
<span class="nc" id="L1968">            is = zf.getInputStream(ze);</span>
<span class="nc" id="L1969">            long left = ze.getSize();</span>
<span class="nc bnc" id="L1970" title="All 2 branches missed.">            while((left &gt; 0)</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">                &amp;&amp; (n = is.read(buffer, 0, buffer.length)) != -1) {</span>
<span class="nc bnc" id="L1972" title="All 2 branches missed.">                for (i=0; i&lt;digests.length; i++) {</span>
<span class="nc" id="L1973">                    digests[i].update(buffer, 0, n);</span>
                }
<span class="nc" id="L1975">                left -= n;</span>
            }
        } finally {
<span class="nc bnc" id="L1978" title="All 4 branches missed.">            if (is != null) {</span>
<span class="nc" id="L1979">                is.close();</span>
            }
        }

        // complete the digests
<span class="nc" id="L1984">        String[] base64Digests = new String[digests.length];</span>
<span class="nc bnc" id="L1985" title="All 2 branches missed.">        for (i=0; i&lt;digests.length; i++) {</span>
<span class="nc" id="L1986">            base64Digests[i] = Base64.getEncoder().encodeToString(digests[i].digest());</span>
        }
<span class="nc" id="L1988">        return base64Digests;</span>
    }

    /*
     * Computes the digests of a zip entry, and returns them as a list of
     * attributes
     */
    private Attributes getDigestAttributes(ZipEntry ze, ZipFile zf,
                                           MessageDigest[] digests)
        throws IOException {

<span class="nc" id="L1999">        String[] base64Digests = getDigests(ze, zf, digests);</span>
<span class="nc" id="L2000">        Attributes attrs = new Attributes();</span>

<span class="nc bnc" id="L2002" title="All 2 branches missed.">        for (int i=0; i&lt;digests.length; i++) {</span>
<span class="nc" id="L2003">            attrs.putValue(digests[i].getAlgorithm()+&quot;-Digest&quot;,</span>
                           base64Digests[i]);
        }
<span class="nc" id="L2006">        return attrs;</span>
    }

    /*
     * Updates the digest attributes of a manifest entry, by adding or
     * replacing digest values.
     * A digest value is added if the manifest entry does not contain a digest
     * for that particular algorithm.
     * A digest value is replaced if it is obsolete.
     *
     * Returns true if the manifest entry has been changed, and false
     * otherwise.
     */
    private boolean updateDigests(ZipEntry ze, ZipFile zf,
                                  MessageDigest[] digests,
                                  Manifest mf) throws IOException {
<span class="nc" id="L2022">        boolean update = false;</span>

<span class="nc" id="L2024">        Attributes attrs = mf.getAttributes(ze.getName());</span>
<span class="nc" id="L2025">        String[] base64Digests = getDigests(ze, zf, digests);</span>

<span class="nc bnc" id="L2027" title="All 2 branches missed.">        for (int i=0; i&lt;digests.length; i++) {</span>
            // The entry name to be written into attrs
<span class="nc" id="L2029">            String name = null;</span>
            try {
                // Find if the digest already exists
<span class="nc" id="L2032">                AlgorithmId aid = AlgorithmId.get(digests[i].getAlgorithm());</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">                for (Object key: attrs.keySet()) {</span>
<span class="nc bnc" id="L2034" title="All 2 branches missed.">                    if (key instanceof Attributes.Name) {</span>
<span class="nc" id="L2035">                        String n = ((Attributes.Name)key).toString();</span>
<span class="nc bnc" id="L2036" title="All 2 branches missed.">                        if (n.toUpperCase(Locale.ENGLISH).endsWith(&quot;-DIGEST&quot;)) {</span>
<span class="nc" id="L2037">                            String tmp = n.substring(0, n.length() - 7);</span>
<span class="nc bnc" id="L2038" title="All 2 branches missed.">                            if (AlgorithmId.get(tmp).equals(aid)) {</span>
<span class="nc" id="L2039">                                name = n;</span>
<span class="nc" id="L2040">                                break;</span>
                            }
                        }
                    }
<span class="nc" id="L2044">                }</span>
<span class="nc" id="L2045">            } catch (NoSuchAlgorithmException nsae) {</span>
                // Ignored. Writing new digest entry.
<span class="nc" id="L2047">            }</span>

<span class="nc bnc" id="L2049" title="All 2 branches missed.">            if (name == null) {</span>
<span class="nc" id="L2050">                name = digests[i].getAlgorithm()+&quot;-Digest&quot;;</span>
<span class="nc" id="L2051">                attrs.putValue(name, base64Digests[i]);</span>
<span class="nc" id="L2052">                update=true;</span>
            } else {
                // compare digests, and replace the one in the manifest
                // if they are different
<span class="nc" id="L2056">                String mfDigest = attrs.getValue(name);</span>
<span class="nc bnc" id="L2057" title="All 2 branches missed.">                if (!mfDigest.equalsIgnoreCase(base64Digests[i])) {</span>
<span class="nc" id="L2058">                    attrs.putValue(name, base64Digests[i]);</span>
<span class="nc" id="L2059">                    update=true;</span>
                }
            }
        }
<span class="nc" id="L2063">        return update;</span>
    }

    /*
     * Try to load the specified signing mechanism.
     * The URL class loader is used.
     */
    private ContentSigner loadSigningMechanism(String signerClassName,
        String signerClassPath) throws Exception {

        // construct class loader
<span class="nc" id="L2074">        String cpString = null;   // make sure env.class.path defaults to dot</span>

        // do prepends to get correct ordering
<span class="nc" id="L2077">        cpString = PathList.appendPath(System.getProperty(&quot;env.class.path&quot;), cpString);</span>
<span class="nc" id="L2078">        cpString = PathList.appendPath(System.getProperty(&quot;java.class.path&quot;), cpString);</span>
<span class="nc" id="L2079">        cpString = PathList.appendPath(signerClassPath, cpString);</span>
<span class="nc" id="L2080">        URL[] urls = PathList.pathToURLs(cpString);</span>
<span class="nc" id="L2081">        ClassLoader appClassLoader = new URLClassLoader(urls);</span>

        // attempt to find signer
<span class="nc" id="L2084">        Class&lt;?&gt; signerClass = appClassLoader.loadClass(signerClassName);</span>

        // Check that it implements ContentSigner
<span class="nc" id="L2087">        Object signer = signerClass.newInstance();</span>
<span class="nc bnc" id="L2088" title="All 2 branches missed.">        if (!(signer instanceof ContentSigner)) {</span>
<span class="nc" id="L2089">            MessageFormat form = new MessageFormat(</span>
<span class="nc" id="L2090">                rb.getString(&quot;signerClass.is.not.a.signing.mechanism&quot;));</span>
<span class="nc" id="L2091">            Object[] source = {signerClass.getName()};</span>
<span class="nc" id="L2092">            throw new IllegalArgumentException(form.format(source));</span>
        }
<span class="nc" id="L2094">        return (ContentSigner)signer;</span>
    }
}

class SignatureFile {

    /** SignatureFile */
    Manifest sf;

    /** .SF base name */
    String baseName;

    public SignatureFile(MessageDigest digests[],
                         Manifest mf,
                         ManifestDigester md,
                         String baseName,
                         boolean signManifest)

<span class="nc" id="L2112">    {</span>
<span class="nc" id="L2113">        this.baseName = baseName;</span>

<span class="nc" id="L2115">        String version = System.getProperty(&quot;java.version&quot;);</span>
<span class="nc" id="L2116">        String javaVendor = System.getProperty(&quot;java.vendor&quot;);</span>

<span class="nc" id="L2118">        sf = new Manifest();</span>
<span class="nc" id="L2119">        Attributes mattr = sf.getMainAttributes();</span>

<span class="nc" id="L2121">        mattr.putValue(Attributes.Name.SIGNATURE_VERSION.toString(), &quot;1.0&quot;);</span>
<span class="nc" id="L2122">        mattr.putValue(&quot;Created-By&quot;, version + &quot; (&quot; + javaVendor + &quot;)&quot;);</span>

<span class="nc bnc" id="L2124" title="All 2 branches missed.">        if (signManifest) {</span>
            // sign the whole manifest
<span class="nc bnc" id="L2126" title="All 2 branches missed.">            for (int i=0; i &lt; digests.length; i++) {</span>
<span class="nc" id="L2127">                mattr.putValue(digests[i].getAlgorithm()+&quot;-Digest-Manifest&quot;,</span>
<span class="nc" id="L2128">                               Base64.getEncoder().encodeToString(md.manifestDigest(digests[i])));</span>
            }
        }

        // create digest of the manifest main attributes
<span class="nc" id="L2133">        ManifestDigester.Entry mde =</span>
<span class="nc" id="L2134">                md.get(ManifestDigester.MF_MAIN_ATTRS, false);</span>
<span class="nc bnc" id="L2135" title="All 2 branches missed.">        if (mde != null) {</span>
<span class="nc bnc" id="L2136" title="All 2 branches missed.">            for (int i=0; i &lt; digests.length; i++) {</span>
<span class="nc" id="L2137">                mattr.putValue(digests[i].getAlgorithm() +</span>
                        &quot;-Digest-&quot; + ManifestDigester.MF_MAIN_ATTRS,
<span class="nc" id="L2139">                        Base64.getEncoder().encodeToString(mde.digest(digests[i])));</span>
            }
        } else {
<span class="nc" id="L2142">            throw new IllegalStateException</span>
                (&quot;ManifestDigester failed to create &quot; +
                &quot;Manifest-Main-Attribute entry&quot;);
        }

        /* go through the manifest entries and create the digests */

<span class="nc" id="L2149">        Map&lt;String,Attributes&gt; entries = sf.getEntries();</span>
<span class="nc" id="L2150">        Iterator&lt;Map.Entry&lt;String,Attributes&gt;&gt; mit =</span>
<span class="nc" id="L2151">                                mf.getEntries().entrySet().iterator();</span>
<span class="nc bnc" id="L2152" title="All 2 branches missed.">        while(mit.hasNext()) {</span>
<span class="nc" id="L2153">            Map.Entry&lt;String,Attributes&gt; e = mit.next();</span>
<span class="nc" id="L2154">            String name = e.getKey();</span>
<span class="nc" id="L2155">            mde = md.get(name, false);</span>
<span class="nc bnc" id="L2156" title="All 2 branches missed.">            if (mde != null) {</span>
<span class="nc" id="L2157">                Attributes attr = new Attributes();</span>
<span class="nc bnc" id="L2158" title="All 2 branches missed.">                for (int i=0; i &lt; digests.length; i++) {</span>
<span class="nc" id="L2159">                    attr.putValue(digests[i].getAlgorithm()+&quot;-Digest&quot;,</span>
<span class="nc" id="L2160">                                  Base64.getEncoder().encodeToString(mde.digest(digests[i])));</span>
                }
<span class="nc" id="L2162">                entries.put(name, attr);</span>
            }
<span class="nc" id="L2164">        }</span>
<span class="nc" id="L2165">    }</span>

    /**
     * Writes the SignatureFile to the specified OutputStream.
     *
     * @param out the output stream
     * @exception IOException if an I/O error has occurred
     */

    public void write(OutputStream out) throws IOException
    {
<span class="nc" id="L2176">        sf.write(out);</span>
<span class="nc" id="L2177">    }</span>

    /**
     * get .SF file name
     */
    public String getMetaName()
    {
<span class="nc" id="L2184">        return &quot;META-INF/&quot;+ baseName + &quot;.SF&quot;;</span>
    }

    /**
     * get base file name
     */
    public String getBaseName()
    {
<span class="nc" id="L2192">        return baseName;</span>
    }

    /*
     * Generate a signed data block.
     * If a URL or a certificate (containing a URL) for a Timestamping
     * Authority is supplied then a signature timestamp is generated and
     * inserted into the signed data block.
     *
     * @param sigalg signature algorithm to use, or null to use default
     * @param tsaUrl The location of the Timestamping Authority. If null
     *               then no timestamp is requested.
     * @param tsaCert The certificate for the Timestamping Authority. If null
     *               then no timestamp is requested.
     * @param signingMechanism The signing mechanism to use.
     * @param args The command-line arguments to jarsigner.
     * @param zipFile The original source Zip file.
     */
    public Block generateBlock(PrivateKey privateKey,
                               String sigalg,
                               X509Certificate[] certChain,
                               boolean externalSF, String tsaUrl,
                               X509Certificate tsaCert,
                               String tSAPolicyID,
                               ContentSigner signingMechanism,
                               String[] args, ZipFile zipFile)
        throws NoSuchAlgorithmException, InvalidKeyException, IOException,
            SignatureException, CertificateException
    {
<span class="nc" id="L2221">        return new Block(this, privateKey, sigalg, certChain, externalSF,</span>
                tsaUrl, tsaCert, tSAPolicyID, signingMechanism, args, zipFile);
    }


    public static class Block {

        private byte[] block;
        private String blockFileName;

        /*
         * Construct a new signature block.
         */
        Block(SignatureFile sfg, PrivateKey privateKey, String sigalg,
            X509Certificate[] certChain, boolean externalSF, String tsaUrl,
            X509Certificate tsaCert, String tSAPolicyID, ContentSigner signingMechanism,
            String[] args, ZipFile zipFile)
            throws NoSuchAlgorithmException, InvalidKeyException, IOException,
<span class="nc" id="L2239">            SignatureException, CertificateException {</span>

<span class="nc" id="L2241">            Principal issuerName = certChain[0].getIssuerDN();</span>
<span class="nc bnc" id="L2242" title="All 2 branches missed.">            if (!(issuerName instanceof X500Name)) {</span>
                // must extract the original encoded form of DN for subsequent
                // name comparison checks (converting to a String and back to
                // an encoded DN could cause the types of String attribute
                // values to be changed)
<span class="nc" id="L2247">                X509CertInfo tbsCert = new</span>
<span class="nc" id="L2248">                    X509CertInfo(certChain[0].getTBSCertificate());</span>
<span class="nc" id="L2249">                issuerName = (Principal)</span>
<span class="nc" id="L2250">                    tbsCert.get(X509CertInfo.ISSUER + &quot;.&quot; +</span>
                                X509CertInfo.DN_NAME);
                }
<span class="nc" id="L2253">            BigInteger serial = certChain[0].getSerialNumber();</span>

            String signatureAlgorithm;
<span class="nc" id="L2256">            String keyAlgorithm = privateKey.getAlgorithm();</span>
            /*
             * If no signature algorithm was specified, we choose a
             * default that is compatible with the private key algorithm.
             */
<span class="nc bnc" id="L2261" title="All 2 branches missed.">            if (sigalg == null) {</span>

<span class="nc bnc" id="L2263" title="All 2 branches missed.">                if (keyAlgorithm.equalsIgnoreCase(&quot;DSA&quot;))</span>
<span class="nc" id="L2264">                    signatureAlgorithm = &quot;SHA1withDSA&quot;;</span>
<span class="nc bnc" id="L2265" title="All 2 branches missed.">                else if (keyAlgorithm.equalsIgnoreCase(&quot;RSA&quot;))</span>
<span class="nc" id="L2266">                    signatureAlgorithm = &quot;SHA256withRSA&quot;;</span>
<span class="nc bnc" id="L2267" title="All 2 branches missed.">                else if (keyAlgorithm.equalsIgnoreCase(&quot;EC&quot;))</span>
<span class="nc" id="L2268">                    signatureAlgorithm = &quot;SHA256withECDSA&quot;;</span>
                else
<span class="nc" id="L2270">                    throw new RuntimeException(&quot;private key is not a DSA or &quot;</span>
                                               + &quot;RSA key&quot;);
            } else {
<span class="nc" id="L2273">                signatureAlgorithm = sigalg;</span>
            }

            // check common invalid key/signature algorithm combinations
<span class="nc" id="L2277">            String sigAlgUpperCase = signatureAlgorithm.toUpperCase(Locale.ENGLISH);</span>
<span class="nc bnc" id="L2278" title="All 2 branches missed.">            if ((sigAlgUpperCase.endsWith(&quot;WITHRSA&quot;) &amp;&amp;</span>
<span class="nc bnc" id="L2279" title="All 2 branches missed.">                !keyAlgorithm.equalsIgnoreCase(&quot;RSA&quot;)) ||</span>
<span class="nc bnc" id="L2280" title="All 2 branches missed.">                (sigAlgUpperCase.endsWith(&quot;WITHECDSA&quot;) &amp;&amp;</span>
<span class="nc bnc" id="L2281" title="All 2 branches missed.">                !keyAlgorithm.equalsIgnoreCase(&quot;EC&quot;)) ||</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">                (sigAlgUpperCase.endsWith(&quot;WITHDSA&quot;) &amp;&amp;</span>
<span class="nc bnc" id="L2283" title="All 2 branches missed.">                !keyAlgorithm.equalsIgnoreCase(&quot;DSA&quot;))) {</span>
<span class="nc" id="L2284">                throw new SignatureException</span>
                    (&quot;private key algorithm is not compatible with signature algorithm&quot;);
            }

<span class="nc" id="L2288">            blockFileName = &quot;META-INF/&quot;+sfg.getBaseName()+&quot;.&quot;+keyAlgorithm;</span>

<span class="nc" id="L2290">            AlgorithmId sigAlg = AlgorithmId.get(signatureAlgorithm);</span>
<span class="nc" id="L2291">            AlgorithmId digEncrAlg = AlgorithmId.get(keyAlgorithm);</span>

<span class="nc" id="L2293">            Signature sig = Signature.getInstance(signatureAlgorithm);</span>
<span class="nc" id="L2294">            sig.initSign(privateKey);</span>

<span class="nc" id="L2296">            ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L2297">            sfg.write(baos);</span>

<span class="nc" id="L2299">            byte[] content = baos.toByteArray();</span>

<span class="nc" id="L2301">            sig.update(content);</span>
<span class="nc" id="L2302">            byte[] signature = sig.sign();</span>

            // Timestamp the signature and generate the signature block file
<span class="nc bnc" id="L2305" title="All 2 branches missed.">            if (signingMechanism == null) {</span>
<span class="nc" id="L2306">                signingMechanism = new TimestampedSigner();</span>
            }
<span class="nc" id="L2308">            URI tsaUri = null;</span>
            try {
<span class="nc bnc" id="L2310" title="All 2 branches missed.">                if (tsaUrl != null) {</span>
<span class="nc" id="L2311">                    tsaUri = new URI(tsaUrl);</span>
                }
<span class="nc" id="L2313">            } catch (URISyntaxException e) {</span>
<span class="nc" id="L2314">                throw new IOException(e);</span>
<span class="nc" id="L2315">            }</span>

            // Assemble parameters for the signing mechanism
<span class="nc" id="L2318">            ContentSignerParameters params =</span>
                new JarSignerParameters(args, tsaUri, tsaCert, tSAPolicyID, signature,
                    signatureAlgorithm, certChain, content, zipFile);

            // Generate the signature block
<span class="nc bnc" id="L2323" title="All 4 branches missed.">            block = signingMechanism.generateSignedData(</span>
                    params, externalSF, (tsaUrl != null || tsaCert != null));
<span class="nc" id="L2325">        }</span>

        /*
         * get block file name.
         */
        public String getMetaName()
        {
<span class="nc" id="L2332">            return blockFileName;</span>
        }

        /**
         * Writes the block file to the specified OutputStream.
         *
         * @param out the output stream
         * @exception IOException if an I/O error has occurred
         */

        public void write(OutputStream out) throws IOException
        {
<span class="nc" id="L2344">            out.write(block);</span>
<span class="nc" id="L2345">        }</span>
    }
}


/*
 * This object encapsulates the parameters used to perform content signing.
 */
class JarSignerParameters implements ContentSignerParameters {

    private String[] args;
    private URI tsa;
    private X509Certificate tsaCertificate;
    private byte[] signature;
    private String signatureAlgorithm;
    private X509Certificate[] signerCertificateChain;
    private byte[] content;
    private ZipFile source;
    private String tSAPolicyID;

    /**
     * Create a new object.
     */
    JarSignerParameters(String[] args, URI tsa, X509Certificate tsaCertificate,
        String tSAPolicyID,
        byte[] signature, String signatureAlgorithm,
        X509Certificate[] signerCertificateChain, byte[] content,
<span class="nc" id="L2372">        ZipFile source) {</span>

<span class="nc bnc" id="L2374" title="All 6 branches missed.">        if (signature == null || signatureAlgorithm == null ||</span>
            signerCertificateChain == null) {
<span class="nc" id="L2376">            throw new NullPointerException();</span>
        }
<span class="nc" id="L2378">        this.args = args;</span>
<span class="nc" id="L2379">        this.tsa = tsa;</span>
<span class="nc" id="L2380">        this.tsaCertificate = tsaCertificate;</span>
<span class="nc" id="L2381">        this.tSAPolicyID = tSAPolicyID;</span>
<span class="nc" id="L2382">        this.signature = signature;</span>
<span class="nc" id="L2383">        this.signatureAlgorithm = signatureAlgorithm;</span>
<span class="nc" id="L2384">        this.signerCertificateChain = signerCertificateChain;</span>
<span class="nc" id="L2385">        this.content = content;</span>
<span class="nc" id="L2386">        this.source = source;</span>
<span class="nc" id="L2387">    }</span>

    /**
     * Retrieves the command-line arguments.
     *
     * @return The command-line arguments. May be null.
     */
    public String[] getCommandLine() {
<span class="nc" id="L2395">        return args;</span>
    }

    /**
     * Retrieves the identifier for a Timestamping Authority (TSA).
     *
     * @return The TSA identifier. May be null.
     */
    public URI getTimestampingAuthority() {
<span class="nc" id="L2404">        return tsa;</span>
    }

    /**
     * Retrieves the certificate for a Timestamping Authority (TSA).
     *
     * @return The TSA certificate. May be null.
     */
    public X509Certificate getTimestampingAuthorityCertificate() {
<span class="nc" id="L2413">        return tsaCertificate;</span>
    }

    public String getTSAPolicyID() {
<span class="nc" id="L2417">        return tSAPolicyID;</span>
    }

    /**
     * Retrieves the signature.
     *
     * @return The non-null signature bytes.
     */
    public byte[] getSignature() {
<span class="nc" id="L2426">        return signature;</span>
    }

    /**
     * Retrieves the name of the signature algorithm.
     *
     * @return The non-null string name of the signature algorithm.
     */
    public String getSignatureAlgorithm() {
<span class="nc" id="L2435">        return signatureAlgorithm;</span>
    }

    /**
     * Retrieves the signer's X.509 certificate chain.
     *
     * @return The non-null array of X.509 public-key certificates.
     */
    public X509Certificate[] getSignerCertificateChain() {
<span class="nc" id="L2444">        return signerCertificateChain;</span>
    }

    /**
     * Retrieves the content that was signed.
     *
     * @return The content bytes. May be null.
     */
    public byte[] getContent() {
<span class="nc" id="L2453">        return content;</span>
    }

    /**
     * Retrieves the original source ZIP file before it was signed.
     *
     * @return The original ZIP file. May be null.
     */
    public ZipFile getSource() {
<span class="nc" id="L2462">        return source;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>