<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>PropertiesDefaultHandler.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">jdk.internal.util.xml</a> &gt; <span class="el_source">PropertiesDefaultHandler.java</span></div><h1>PropertiesDefaultHandler.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package jdk.internal.util.xml;

import java.io.*;
import java.util.InvalidPropertiesFormatException;
import java.util.Map.Entry;
import java.util.Properties;
import jdk.internal.org.xml.sax.Attributes;
import jdk.internal.org.xml.sax.InputSource;
import jdk.internal.org.xml.sax.SAXException;
import jdk.internal.org.xml.sax.SAXParseException;
import jdk.internal.org.xml.sax.helpers.DefaultHandler;
import jdk.internal.util.xml.impl.SAXParserImpl;
import jdk.internal.util.xml.impl.XMLStreamWriterImpl;

/**
 * A class used to aid in Properties load and save in XML. This class is
 * re-implemented using a subset of SAX
 *
 * @author Joe Wang
 * @since 8
 */
<span class="fc" id="L47">public class PropertiesDefaultHandler extends DefaultHandler {</span>

    // Elements specified in the properties.dtd
    private static final String ELEMENT_ROOT = &quot;properties&quot;;
    private static final String ELEMENT_COMMENT = &quot;comment&quot;;
    private static final String ELEMENT_ENTRY = &quot;entry&quot;;
    private static final String ATTR_KEY = &quot;key&quot;;
    // The required DTD URI for exported properties
    private static final String PROPS_DTD_DECL =
            &quot;&lt;!DOCTYPE properties SYSTEM \&quot;http://java.sun.com/dtd/properties.dtd\&quot;&gt;&quot;;
    private static final String PROPS_DTD_URI =
            &quot;http://java.sun.com/dtd/properties.dtd&quot;;
    private static final String PROPS_DTD =
            &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot;
            + &quot;&lt;!-- DTD for properties --&gt;&quot;
            + &quot;&lt;!ELEMENT properties ( comment?, entry* ) &gt;&quot;
            + &quot;&lt;!ATTLIST properties&quot;
            + &quot; version CDATA #FIXED \&quot;1.0\&quot;&gt;&quot;
            + &quot;&lt;!ELEMENT comment (#PCDATA) &gt;&quot;
            + &quot;&lt;!ELEMENT entry (#PCDATA) &gt;&quot;
            + &quot;&lt;!ATTLIST entry &quot;
            + &quot; key CDATA #REQUIRED&gt;&quot;;
    /**
     * Version number for the format of exported properties files.
     */
    private static final String EXTERNAL_XML_VERSION = &quot;1.0&quot;;
    private Properties properties;

    public void load(Properties props, InputStream in)
        throws IOException, InvalidPropertiesFormatException, UnsupportedEncodingException
    {
<span class="fc" id="L78">        this.properties = props;</span>

        try {
<span class="fc" id="L81">            SAXParser parser = new SAXParserImpl();</span>
<span class="fc" id="L82">            parser.parse(in, this);</span>
<span class="fc" id="L83">        } catch (SAXException saxe) {</span>
<span class="fc" id="L84">            throw new InvalidPropertiesFormatException(saxe);</span>
<span class="fc" id="L85">        }</span>

        /**
         * String xmlVersion = propertiesElement.getAttribute(&quot;version&quot;); if
         * (xmlVersion.compareTo(EXTERNAL_XML_VERSION) &gt; 0) throw new
         * InvalidPropertiesFormatException( &quot;Exported Properties file format
         * version &quot; + xmlVersion + &quot; is not supported. This java installation
         * can read&quot; + &quot; versions &quot; + EXTERNAL_XML_VERSION + &quot; or older. You&quot; +
         * &quot; may need to install a newer version of JDK.&quot;);
         */
<span class="fc" id="L95">    }</span>

    public void store(Properties props, OutputStream os, String comment, String encoding)
        throws IOException
    {
        try {
<span class="fc" id="L101">            XMLStreamWriter writer = new XMLStreamWriterImpl(os, encoding);</span>
<span class="fc" id="L102">            writer.writeStartDocument();</span>
<span class="fc" id="L103">            writer.writeDTD(PROPS_DTD_DECL);</span>
<span class="fc" id="L104">            writer.writeStartElement(ELEMENT_ROOT);</span>
<span class="pc bpc" id="L105" title="3 of 4 branches missed.">            if (comment != null &amp;&amp; comment.length() &gt; 0) {</span>
<span class="nc" id="L106">                writer.writeStartElement(ELEMENT_COMMENT);</span>
<span class="nc" id="L107">                writer.writeCharacters(comment);</span>
<span class="nc" id="L108">                writer.writeEndElement();</span>
            }

<span class="fc" id="L111">            synchronized(props) {</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">                for (Entry&lt;Object, Object&gt; e : props.entrySet()) {</span>
<span class="fc" id="L113">                    final Object k = e.getKey();</span>
<span class="fc" id="L114">                    final Object v = e.getValue();</span>
<span class="pc bpc" id="L115" title="2 of 4 branches missed.">                    if (k instanceof String &amp;&amp; v instanceof String) {</span>
<span class="fc" id="L116">                        writer.writeStartElement(ELEMENT_ENTRY);</span>
<span class="fc" id="L117">                        writer.writeAttribute(ATTR_KEY, (String)k);</span>
<span class="fc" id="L118">                        writer.writeCharacters((String)v);</span>
<span class="fc" id="L119">                        writer.writeEndElement();</span>
                    }
<span class="fc" id="L121">                }</span>
<span class="pc" id="L122">            }</span>

<span class="fc" id="L124">            writer.writeEndElement();</span>
<span class="fc" id="L125">            writer.writeEndDocument();</span>
<span class="fc" id="L126">            writer.close();</span>
<span class="fc" id="L127">        } catch (XMLStreamException e) {</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">            if (e.getCause() instanceof UnsupportedEncodingException) {</span>
<span class="fc" id="L129">                throw (UnsupportedEncodingException) e.getCause();</span>
            }
<span class="nc" id="L131">            throw new IOException(e);</span>
<span class="fc" id="L132">        }</span>

<span class="fc" id="L134">    }</span>
    ////////////////////////////////////////////////////////////////////
    // Validate while parsing
    ////////////////////////////////////////////////////////////////////
    final static String ALLOWED_ELEMENTS = &quot;properties, comment, entry&quot;;
    final static String ALLOWED_COMMENT = &quot;comment&quot;;
    ////////////////////////////////////////////////////////////////////
    // Handler methods
    ////////////////////////////////////////////////////////////////////
<span class="fc" id="L143">    StringBuffer buf = new StringBuffer();</span>
<span class="fc" id="L144">    boolean sawComment = false;</span>
<span class="fc" id="L145">    boolean validEntry = false;</span>
<span class="fc" id="L146">    int rootElem = 0;</span>
    String key;
    String rootElm;

    @Override
    public void startElement(String uri, String localName, String qName, Attributes attributes)
        throws SAXException
    {
<span class="fc bfc" id="L154" title="All 2 branches covered.">        if (rootElem &lt; 2) {</span>
<span class="fc" id="L155">            rootElem++;</span>
        }

<span class="pc bpc" id="L158" title="1 of 2 branches missed.">        if (rootElm == null) {</span>
<span class="nc" id="L159">            fatalError(new SAXParseException(&quot;An XML properties document must contain&quot;</span>
                    + &quot; the DOCTYPE declaration as defined by java.util.Properties.&quot;, null));
        }

<span class="pc bpc" id="L163" title="1 of 4 branches missed.">        if (rootElem == 1 &amp;&amp; !rootElm.equals(qName)) {</span>
<span class="nc" id="L164">            fatalError(new SAXParseException(&quot;Document root element \&quot;&quot; + qName</span>
                    + &quot;\&quot;, must match DOCTYPE root \&quot;&quot; + rootElm + &quot;\&quot;&quot;, null));
        }
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        if (!ALLOWED_ELEMENTS.contains(qName)) {</span>
<span class="nc" id="L168">            fatalError(new SAXParseException(&quot;Element type \&quot;&quot; + qName + &quot;\&quot; must be declared.&quot;, null));</span>
        }
<span class="fc bfc" id="L170" title="All 2 branches covered.">        if (qName.equals(ELEMENT_ENTRY)) {</span>
<span class="fc" id="L171">            validEntry = true;</span>
<span class="fc" id="L172">            key = attributes.getValue(ATTR_KEY);</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">            if (key == null) {</span>
<span class="nc" id="L174">                fatalError(new SAXParseException(&quot;Attribute \&quot;key\&quot; is required and must be specified for element type \&quot;entry\&quot;&quot;, null));</span>
            }
<span class="fc bfc" id="L176" title="All 2 branches covered.">        } else if (qName.equals(ALLOWED_COMMENT)) {</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">            if (sawComment) {</span>
<span class="nc" id="L178">                fatalError(new SAXParseException(&quot;Only one comment element may be allowed. &quot;</span>
                        + &quot;The content of element type \&quot;properties\&quot; must match \&quot;(comment?,entry*)\&quot;&quot;, null));
            }
<span class="fc" id="L181">            sawComment = true;</span>
        }
<span class="fc" id="L183">    }</span>

    @Override
    public void characters(char[] ch, int start, int length) throws SAXException {
<span class="fc bfc" id="L187" title="All 2 branches covered.">        if (validEntry) {</span>
<span class="fc" id="L188">            buf.append(ch, start, length);</span>
        }
<span class="fc" id="L190">    }</span>

    @Override
    public void endElement(String uri, String localName, String qName) throws SAXException {
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if (!ALLOWED_ELEMENTS.contains(qName)) {</span>
<span class="nc" id="L195">            fatalError(new SAXParseException(&quot;Element: &quot; + qName + &quot; is invalid, must match  \&quot;(comment?,entry*)\&quot;.&quot;, null));</span>
        }

<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (validEntry) {</span>
<span class="fc" id="L199">            properties.setProperty(key, buf.toString());</span>
<span class="fc" id="L200">            buf.delete(0, buf.length());</span>
<span class="fc" id="L201">            validEntry = false;</span>
        }
<span class="fc" id="L203">    }</span>

    @Override
    public void notationDecl(String name, String publicId, String systemId) throws SAXException {
<span class="fc" id="L207">        rootElm = name;</span>
<span class="fc" id="L208">    }</span>

    @Override
    public InputSource resolveEntity(String pubid, String sysid)
            throws SAXException, IOException {
        {
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">            if (sysid.equals(PROPS_DTD_URI)) {</span>
                InputSource is;
<span class="fc" id="L216">                is = new InputSource(new StringReader(PROPS_DTD));</span>
<span class="fc" id="L217">                is.setSystemId(PROPS_DTD_URI);</span>
<span class="fc" id="L218">                return is;</span>
            }
<span class="nc" id="L220">            throw new SAXException(&quot;Invalid system identifier: &quot; + sysid);</span>
        }
    }

    @Override
    public void error(SAXParseException x) throws SAXException {
<span class="nc" id="L226">        throw x;</span>
    }

    @Override
    public void fatalError(SAXParseException x) throws SAXException {
<span class="fc" id="L231">        throw x;</span>
    }

    @Override
    public void warning(SAXParseException x) throws SAXException {
<span class="nc" id="L236">        throw x;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>