<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PNGMetadata.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.imageio.plugins.png</a> &gt; <span class="el_source">PNGMetadata.java</span></div><h1>PNGMetadata.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2001, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.imageio.plugins.png;

import java.awt.image.ColorModel;
import java.awt.image.IndexColorModel;
import java.awt.image.SampleModel;
import java.util.ArrayList;
import java.util.StringTokenizer;
import javax.imageio.ImageTypeSpecifier;
import javax.imageio.metadata.IIOInvalidTreeException;
import javax.imageio.metadata.IIOMetadata;
import javax.imageio.metadata.IIOMetadataFormatImpl;
import javax.imageio.metadata.IIOMetadataNode;
import org.w3c.dom.Node;

public class PNGMetadata extends IIOMetadata implements Cloneable {

    // package scope
    public static final String
        nativeMetadataFormatName = &quot;javax_imageio_png_1.0&quot;;

    protected static final String nativeMetadataFormatClassName
        = &quot;com.sun.imageio.plugins.png.PNGMetadataFormat&quot;;

    // Color types for IHDR chunk
<span class="nc" id="L50">    static final String[] IHDR_colorTypeNames = {</span>
        &quot;Grayscale&quot;, null, &quot;RGB&quot;, &quot;Palette&quot;,
        &quot;GrayAlpha&quot;, null, &quot;RGBAlpha&quot;
    };

<span class="nc" id="L55">    static final int[] IHDR_numChannels = {</span>
        1, 0, 3, 3, 2, 0, 4
    };

    // Bit depths for IHDR chunk
<span class="nc" id="L60">    static final String[] IHDR_bitDepths = {</span>
        &quot;1&quot;, &quot;2&quot;, &quot;4&quot;, &quot;8&quot;, &quot;16&quot;
    };

    // Compression methods for IHDR chunk
<span class="nc" id="L65">    static final String[] IHDR_compressionMethodNames = {</span>
        &quot;deflate&quot;
    };

    // Filter methods for IHDR chunk
<span class="nc" id="L70">    static final String[] IHDR_filterMethodNames = {</span>
        &quot;adaptive&quot;
    };

    // Interlace methods for IHDR chunk
<span class="nc" id="L75">    static final String[] IHDR_interlaceMethodNames = {</span>
        &quot;none&quot;, &quot;adam7&quot;
    };

    // Compression methods for iCCP chunk
<span class="nc" id="L80">    static final String[] iCCP_compressionMethodNames = {</span>
        &quot;deflate&quot;
    };

    // Compression methods for zTXt chunk
<span class="nc" id="L85">    static final String[] zTXt_compressionMethodNames = {</span>
        &quot;deflate&quot;
    };

    // &quot;Unknown&quot; unit for pHYs chunk
    public static final int PHYS_UNIT_UNKNOWN = 0;

    // &quot;Meter&quot; unit for pHYs chunk
    public static final int PHYS_UNIT_METER = 1;

    // Unit specifiers for pHYs chunk
<span class="nc" id="L96">    static final String[] unitSpecifierNames = {</span>
        &quot;unknown&quot;, &quot;meter&quot;
    };

    // Rendering intents for sRGB chunk
<span class="nc" id="L101">    static final String[] renderingIntentNames = {</span>
        &quot;Perceptual&quot;, // 0
        &quot;Relative colorimetric&quot;, // 1
        &quot;Saturation&quot;, // 2
        &quot;Absolute colorimetric&quot; // 3

    };

    // Color space types for Chroma-&gt;ColorSpaceType node
<span class="nc" id="L110">    static final String[] colorSpaceTypeNames = {</span>
        &quot;GRAY&quot;, null, &quot;RGB&quot;, &quot;RGB&quot;,
        &quot;GRAY&quot;, null, &quot;RGB&quot;
    };

    // IHDR chunk
    public boolean IHDR_present;
    public int IHDR_width;
    public int IHDR_height;
    public int IHDR_bitDepth;
    public int IHDR_colorType;
    public int IHDR_compressionMethod;
    public int IHDR_filterMethod;
    public int IHDR_interlaceMethod; // 0 == none, 1 == adam7

    // PLTE chunk
    public boolean PLTE_present;
    public byte[] PLTE_red;
    public byte[] PLTE_green;
    public byte[] PLTE_blue;

    // If non-null, used to reorder palette entries during encoding in
    // order to minimize the size of the tRNS chunk.  Thus an index of
    // 'i' in the source should be encoded as index 'PLTE_order[i]'.
    // PLTE_order will be null unless 'initialize' is called with an
    // IndexColorModel image type.
<span class="nc" id="L136">    public int[] PLTE_order = null;</span>

    // bKGD chunk
    // If external (non-PNG sourced) data has red = green = blue,
    // always store it as gray and promote when writing
    public boolean bKGD_present;
    public int bKGD_colorType; // PNG_COLOR_GRAY, _RGB, or _PALETTE
    public int bKGD_index;
    public int bKGD_gray;
    public int bKGD_red;
    public int bKGD_green;
    public int bKGD_blue;

    // cHRM chunk
    public boolean cHRM_present;
    public int cHRM_whitePointX;
    public int cHRM_whitePointY;
    public int cHRM_redX;
    public int cHRM_redY;
    public int cHRM_greenX;
    public int cHRM_greenY;
    public int cHRM_blueX;
    public int cHRM_blueY;

    // gAMA chunk
    public boolean gAMA_present;
    public int gAMA_gamma;

    // hIST chunk
    public boolean hIST_present;
    public char[] hIST_histogram;

    // iCCP chunk
    public boolean iCCP_present;
    public String iCCP_profileName;
    public int iCCP_compressionMethod;
    public byte[] iCCP_compressedProfile;

    // iTXt chunk
<span class="nc" id="L175">    public ArrayList&lt;String&gt; iTXt_keyword = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L176">    public ArrayList&lt;Boolean&gt; iTXt_compressionFlag = new ArrayList&lt;Boolean&gt;();</span>
<span class="nc" id="L177">    public ArrayList&lt;Integer&gt; iTXt_compressionMethod = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L178">    public ArrayList&lt;String&gt; iTXt_languageTag = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L179">    public ArrayList&lt;String&gt; iTXt_translatedKeyword = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L180">    public ArrayList&lt;String&gt; iTXt_text = new ArrayList&lt;String&gt;();</span>

    // pHYs chunk
    public boolean pHYs_present;
    public int pHYs_pixelsPerUnitXAxis;
    public int pHYs_pixelsPerUnitYAxis;
    public int pHYs_unitSpecifier; // 0 == unknown, 1 == meter

    // sBIT chunk
    public boolean sBIT_present;
    public int sBIT_colorType; // PNG_COLOR_GRAY, _GRAY_ALPHA, _RGB, _RGB_ALPHA
    public int sBIT_grayBits;
    public int sBIT_redBits;
    public int sBIT_greenBits;
    public int sBIT_blueBits;
    public int sBIT_alphaBits;

    // sPLT chunk
    public boolean sPLT_present;
    public String sPLT_paletteName; // 1-79 characters
    public int sPLT_sampleDepth; // 8 or 16
    public int[] sPLT_red;
    public int[] sPLT_green;
    public int[] sPLT_blue;
    public int[] sPLT_alpha;
    public int[] sPLT_frequency;

    // sRGB chunk
    public boolean sRGB_present;
    public int sRGB_renderingIntent;

    // tEXt chunk
<span class="nc" id="L212">    public ArrayList&lt;String&gt; tEXt_keyword = new ArrayList&lt;String&gt;(); // 1-79 characters</span>
<span class="nc" id="L213">    public ArrayList&lt;String&gt; tEXt_text = new ArrayList&lt;String&gt;();</span>

    // tIME chunk
    public boolean tIME_present;
    public int tIME_year;
    public int tIME_month;
    public int tIME_day;
    public int tIME_hour;
    public int tIME_minute;
    public int tIME_second;

    // tRNS chunk
    // If external (non-PNG sourced) data has red = green = blue,
    // always store it as gray and promote when writing
    public boolean tRNS_present;
    public int tRNS_colorType; // PNG_COLOR_GRAY, _RGB, or _PALETTE
    public byte[] tRNS_alpha; // May have fewer entries than PLTE_red, etc.
    public int tRNS_gray;
    public int tRNS_red;
    public int tRNS_green;
    public int tRNS_blue;

    // zTXt chunk
<span class="nc" id="L236">    public ArrayList&lt;String&gt; zTXt_keyword = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L237">    public ArrayList&lt;Integer&gt; zTXt_compressionMethod = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L238">    public ArrayList&lt;String&gt; zTXt_text = new ArrayList&lt;String&gt;();</span>

    // Unknown chunks
<span class="nc" id="L241">    public ArrayList&lt;String&gt; unknownChunkType = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L242">    public ArrayList&lt;byte[]&gt; unknownChunkData = new ArrayList&lt;byte[]&gt;();</span>

    public PNGMetadata() {
<span class="nc" id="L245">        super(true,</span>
              nativeMetadataFormatName,
              nativeMetadataFormatClassName,
              null, null);
<span class="nc" id="L249">    }</span>

<span class="nc" id="L251">    public PNGMetadata(IIOMetadata metadata) {</span>
        // TODO -- implement
<span class="nc" id="L253">    }</span>

    /**
     * Sets the IHDR_bitDepth and IHDR_colorType variables.
     * The &lt;code&gt;numBands&lt;/code&gt; parameter is necessary since
     * we may only be writing a subset of the image bands.
     */
    public void initialize(ImageTypeSpecifier imageType, int numBands) {
<span class="nc" id="L261">        ColorModel colorModel = imageType.getColorModel();</span>
<span class="nc" id="L262">        SampleModel sampleModel = imageType.getSampleModel();</span>

        // Initialize IHDR_bitDepth
<span class="nc" id="L265">        int[] sampleSize = sampleModel.getSampleSize();</span>
<span class="nc" id="L266">        int bitDepth = sampleSize[0];</span>
        // Choose max bit depth over all channels
        // Fixes bug 4413109
<span class="nc bnc" id="L269" title="All 2 branches missed.">        for (int i = 1; i &lt; sampleSize.length; i++) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (sampleSize[i] &gt; bitDepth) {</span>
<span class="nc" id="L271">                bitDepth = sampleSize[i];</span>
            }
        }
        // Multi-channel images must have a bit depth of 8 or 16
<span class="nc bnc" id="L275" title="All 4 branches missed.">        if (sampleSize.length &gt; 1 &amp;&amp; bitDepth &lt; 8) {</span>
<span class="nc" id="L276">            bitDepth = 8;</span>
        }

        // Round bit depth up to a power of 2
<span class="nc bnc" id="L280" title="All 4 branches missed.">        if (bitDepth &gt; 2 &amp;&amp; bitDepth &lt; 4) {</span>
<span class="nc" id="L281">            bitDepth = 4;</span>
<span class="nc bnc" id="L282" title="All 4 branches missed.">        } else if (bitDepth &gt; 4 &amp;&amp; bitDepth &lt; 8) {</span>
<span class="nc" id="L283">            bitDepth = 8;</span>
<span class="nc bnc" id="L284" title="All 4 branches missed.">        } else if (bitDepth &gt; 8 &amp;&amp; bitDepth &lt; 16) {</span>
<span class="nc" id="L285">            bitDepth = 16;</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        } else if (bitDepth &gt; 16) {</span>
<span class="nc" id="L287">            throw new RuntimeException(&quot;bitDepth &gt; 16!&quot;);</span>
        }
<span class="nc" id="L289">        IHDR_bitDepth = bitDepth;</span>

        // Initialize IHDR_colorType
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (colorModel instanceof IndexColorModel) {</span>
<span class="nc" id="L293">            IndexColorModel icm = (IndexColorModel)colorModel;</span>
<span class="nc" id="L294">            int size = icm.getMapSize();</span>

<span class="nc" id="L296">            byte[] reds = new byte[size];</span>
<span class="nc" id="L297">            icm.getReds(reds);</span>
<span class="nc" id="L298">            byte[] greens = new byte[size];</span>
<span class="nc" id="L299">            icm.getGreens(greens);</span>
<span class="nc" id="L300">            byte[] blues = new byte[size];</span>
<span class="nc" id="L301">            icm.getBlues(blues);</span>

            // Determine whether the color tables are actually a gray ramp
            // if the color type has not been set previously
<span class="nc" id="L305">            boolean isGray = false;</span>
<span class="nc bnc" id="L306" title="All 4 branches missed.">            if (!IHDR_present ||</span>
                (IHDR_colorType != PNGImageReader.PNG_COLOR_PALETTE)) {
<span class="nc" id="L308">                isGray = true;</span>
<span class="nc" id="L309">                int scale = 255/((1 &lt;&lt; IHDR_bitDepth) - 1);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                for (int i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L311">                    byte red = reds[i];</span>
<span class="nc bnc" id="L312" title="All 6 branches missed.">                    if ((red != (byte)(i*scale)) ||</span>
                        (red != greens[i]) ||
                        (red != blues[i])) {
<span class="nc" id="L315">                        isGray = false;</span>
<span class="nc" id="L316">                        break;</span>
                    }
                }
            }

            // Determine whether transparency exists
<span class="nc" id="L322">            boolean hasAlpha = colorModel.hasAlpha();</span>

<span class="nc" id="L324">            byte[] alpha = null;</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            if (hasAlpha) {</span>
<span class="nc" id="L326">                alpha = new byte[size];</span>
<span class="nc" id="L327">                icm.getAlphas(alpha);</span>
            }

            /*
             * NB: PNG_COLOR_GRAY_ALPHA color type may be not optimal for images
             * contained more than 1024 pixels (or even than 768 pixels in case of
             * single transparent pixel in palette).
             * For such images alpha samples in raster will occupy more space than
             * it is required to store palette so it could be reasonable to
             * use PNG_COLOR_PALETTE color type for large images.
             */

<span class="nc bnc" id="L339" title="All 8 branches missed.">            if (isGray &amp;&amp; hasAlpha &amp;&amp; (bitDepth == 8 || bitDepth == 16)) {</span>
<span class="nc" id="L340">                IHDR_colorType = PNGImageReader.PNG_COLOR_GRAY_ALPHA;</span>
<span class="nc bnc" id="L341" title="All 4 branches missed.">            } else if (isGray &amp;&amp; !hasAlpha) {</span>
<span class="nc" id="L342">                IHDR_colorType = PNGImageReader.PNG_COLOR_GRAY;</span>
            } else {
<span class="nc" id="L344">                IHDR_colorType = PNGImageReader.PNG_COLOR_PALETTE;</span>
<span class="nc" id="L345">                PLTE_present = true;</span>
<span class="nc" id="L346">                PLTE_order = null;</span>
<span class="nc" id="L347">                PLTE_red = (byte[])reds.clone();</span>
<span class="nc" id="L348">                PLTE_green = (byte[])greens.clone();</span>
<span class="nc" id="L349">                PLTE_blue = (byte[])blues.clone();</span>

<span class="nc bnc" id="L351" title="All 2 branches missed.">                if (hasAlpha) {</span>
<span class="nc" id="L352">                    tRNS_present = true;</span>
<span class="nc" id="L353">                    tRNS_colorType = PNGImageReader.PNG_COLOR_PALETTE;</span>

<span class="nc" id="L355">                    PLTE_order = new int[alpha.length];</span>

                    // Reorder the palette so that non-opaque entries
                    // come first.  Since the tRNS chunk does not have
                    // to store trailing 255's, this can save a
                    // considerable amount of space when encoding
                    // images with only one transparent pixel value,
                    // e.g., images from GIF sources.

<span class="nc" id="L364">                    byte[] newAlpha = new byte[alpha.length];</span>

                    // Scan for non-opaque entries and assign them
                    // positions starting at 0.
<span class="nc" id="L368">                    int newIndex = 0;</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">                    for (int i = 0; i &lt; alpha.length; i++) {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">                        if (alpha[i] != (byte)255) {</span>
<span class="nc" id="L371">                            PLTE_order[i] = newIndex;</span>
<span class="nc" id="L372">                            newAlpha[newIndex] = alpha[i];</span>
<span class="nc" id="L373">                            ++newIndex;</span>
                        }
                    }
<span class="nc" id="L376">                    int numTransparent = newIndex;</span>

                    // Scan for opaque entries and assign them
                    // positions following the non-opaque entries.
<span class="nc bnc" id="L380" title="All 2 branches missed.">                    for (int i = 0; i &lt; alpha.length; i++) {</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">                        if (alpha[i] == (byte)255) {</span>
<span class="nc" id="L382">                            PLTE_order[i] = newIndex++;</span>
                        }
                    }

                    // Reorder the palettes
<span class="nc" id="L387">                    byte[] oldRed = PLTE_red;</span>
<span class="nc" id="L388">                    byte[] oldGreen = PLTE_green;</span>
<span class="nc" id="L389">                    byte[] oldBlue = PLTE_blue;</span>
<span class="nc" id="L390">                    int len = oldRed.length; // All have the same length</span>
<span class="nc" id="L391">                    PLTE_red = new byte[len];</span>
<span class="nc" id="L392">                    PLTE_green = new byte[len];</span>
<span class="nc" id="L393">                    PLTE_blue = new byte[len];</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">                    for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L395">                        PLTE_red[PLTE_order[i]] = oldRed[i];</span>
<span class="nc" id="L396">                        PLTE_green[PLTE_order[i]] = oldGreen[i];</span>
<span class="nc" id="L397">                        PLTE_blue[PLTE_order[i]] = oldBlue[i];</span>
                    }

                    // Copy only the transparent entries into tRNS_alpha
<span class="nc" id="L401">                    tRNS_alpha = new byte[numTransparent];</span>
<span class="nc" id="L402">                    System.arraycopy(newAlpha, 0,</span>
                                     tRNS_alpha, 0, numTransparent);
                }
            }
<span class="nc" id="L406">        } else {</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">            if (numBands == 1) {</span>
<span class="nc" id="L408">                IHDR_colorType = PNGImageReader.PNG_COLOR_GRAY;</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">            } else if (numBands == 2) {</span>
<span class="nc" id="L410">                IHDR_colorType = PNGImageReader.PNG_COLOR_GRAY_ALPHA;</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">            } else if (numBands == 3) {</span>
<span class="nc" id="L412">                IHDR_colorType = PNGImageReader.PNG_COLOR_RGB;</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">            } else if (numBands == 4) {</span>
<span class="nc" id="L414">                IHDR_colorType = PNGImageReader.PNG_COLOR_RGB_ALPHA;</span>
            } else {
<span class="nc" id="L416">                throw new RuntimeException(&quot;Number of bands not 1-4!&quot;);</span>
            }
        }

<span class="nc" id="L420">        IHDR_present = true;</span>
<span class="nc" id="L421">    }</span>

    public boolean isReadOnly() {
<span class="nc" id="L424">        return false;</span>
    }

    private ArrayList&lt;byte[]&gt; cloneBytesArrayList(ArrayList&lt;byte[]&gt; in) {
<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (in == null) {</span>
<span class="nc" id="L429">            return null;</span>
        } else {
<span class="nc" id="L431">            ArrayList&lt;byte[]&gt; list = new ArrayList&lt;byte[]&gt;(in.size());</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">            for (byte[] b: in) {</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">                list.add((b == null) ? null : (byte[])b.clone());</span>
<span class="nc" id="L434">            }</span>
<span class="nc" id="L435">            return list;</span>
        }
    }

    // Deep clone
    public Object clone() {
        PNGMetadata metadata;
        try {
<span class="nc" id="L443">            metadata = (PNGMetadata)super.clone();</span>
<span class="nc" id="L444">        } catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L445">            return null;</span>
<span class="nc" id="L446">        }</span>

        // unknownChunkData needs deep clone
<span class="nc" id="L449">        metadata.unknownChunkData =</span>
<span class="nc" id="L450">            cloneBytesArrayList(this.unknownChunkData);</span>

<span class="nc" id="L452">        return metadata;</span>
    }

    public Node getAsTree(String formatName) {
<span class="nc bnc" id="L456" title="All 2 branches missed.">        if (formatName.equals(nativeMetadataFormatName)) {</span>
<span class="nc" id="L457">            return getNativeTree();</span>
<span class="nc" id="L458">        } else if (formatName.equals</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">                   (IIOMetadataFormatImpl.standardMetadataFormatName)) {</span>
<span class="nc" id="L460">            return getStandardTree();</span>
        } else {
<span class="nc" id="L462">            throw new IllegalArgumentException(&quot;Not a recognized format!&quot;);</span>
        }
    }

    private Node getNativeTree() {
<span class="nc" id="L467">        IIOMetadataNode node = null; // scratch node</span>
<span class="nc" id="L468">        IIOMetadataNode root = new IIOMetadataNode(nativeMetadataFormatName);</span>

        // IHDR
<span class="nc bnc" id="L471" title="All 2 branches missed.">        if (IHDR_present) {</span>
<span class="nc" id="L472">            IIOMetadataNode IHDR_node = new IIOMetadataNode(&quot;IHDR&quot;);</span>
<span class="nc" id="L473">            IHDR_node.setAttribute(&quot;width&quot;, Integer.toString(IHDR_width));</span>
<span class="nc" id="L474">            IHDR_node.setAttribute(&quot;height&quot;, Integer.toString(IHDR_height));</span>
<span class="nc" id="L475">            IHDR_node.setAttribute(&quot;bitDepth&quot;,</span>
<span class="nc" id="L476">                                   Integer.toString(IHDR_bitDepth));</span>
<span class="nc" id="L477">            IHDR_node.setAttribute(&quot;colorType&quot;,</span>
                                   IHDR_colorTypeNames[IHDR_colorType]);
            // IHDR_compressionMethod must be 0 in PNG 1.1
<span class="nc" id="L480">            IHDR_node.setAttribute(&quot;compressionMethod&quot;,</span>
                          IHDR_compressionMethodNames[IHDR_compressionMethod]);
            // IHDR_filterMethod must be 0 in PNG 1.1
<span class="nc" id="L483">            IHDR_node.setAttribute(&quot;filterMethod&quot;,</span>
                                    IHDR_filterMethodNames[IHDR_filterMethod]);
<span class="nc" id="L485">            IHDR_node.setAttribute(&quot;interlaceMethod&quot;,</span>
                              IHDR_interlaceMethodNames[IHDR_interlaceMethod]);
<span class="nc" id="L487">            root.appendChild(IHDR_node);</span>
        }

        // PLTE
<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (PLTE_present) {</span>
<span class="nc" id="L492">            IIOMetadataNode PLTE_node = new IIOMetadataNode(&quot;PLTE&quot;);</span>
<span class="nc" id="L493">            int numEntries = PLTE_red.length;</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">            for (int i = 0; i &lt; numEntries; i++) {</span>
<span class="nc" id="L495">                IIOMetadataNode entry = new IIOMetadataNode(&quot;PLTEEntry&quot;);</span>
<span class="nc" id="L496">                entry.setAttribute(&quot;index&quot;, Integer.toString(i));</span>
<span class="nc" id="L497">                entry.setAttribute(&quot;red&quot;,</span>
<span class="nc" id="L498">                                   Integer.toString(PLTE_red[i] &amp; 0xff));</span>
<span class="nc" id="L499">                entry.setAttribute(&quot;green&quot;,</span>
<span class="nc" id="L500">                                   Integer.toString(PLTE_green[i] &amp; 0xff));</span>
<span class="nc" id="L501">                entry.setAttribute(&quot;blue&quot;,</span>
<span class="nc" id="L502">                                   Integer.toString(PLTE_blue[i] &amp; 0xff));</span>
<span class="nc" id="L503">                PLTE_node.appendChild(entry);</span>
            }

<span class="nc" id="L506">            root.appendChild(PLTE_node);</span>
        }

        // bKGD
<span class="nc bnc" id="L510" title="All 2 branches missed.">        if (bKGD_present) {</span>
<span class="nc" id="L511">            IIOMetadataNode bKGD_node = new IIOMetadataNode(&quot;bKGD&quot;);</span>

<span class="nc bnc" id="L513" title="All 2 branches missed.">            if (bKGD_colorType == PNGImageReader.PNG_COLOR_PALETTE) {</span>
<span class="nc" id="L514">                node = new IIOMetadataNode(&quot;bKGD_Palette&quot;);</span>
<span class="nc" id="L515">                node.setAttribute(&quot;index&quot;, Integer.toString(bKGD_index));</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">            } else if (bKGD_colorType == PNGImageReader.PNG_COLOR_GRAY) {</span>
<span class="nc" id="L517">                node = new IIOMetadataNode(&quot;bKGD_Grayscale&quot;);</span>
<span class="nc" id="L518">                node.setAttribute(&quot;gray&quot;, Integer.toString(bKGD_gray));</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">            } else if (bKGD_colorType == PNGImageReader.PNG_COLOR_RGB) {</span>
<span class="nc" id="L520">                node = new IIOMetadataNode(&quot;bKGD_RGB&quot;);</span>
<span class="nc" id="L521">                node.setAttribute(&quot;red&quot;, Integer.toString(bKGD_red));</span>
<span class="nc" id="L522">                node.setAttribute(&quot;green&quot;, Integer.toString(bKGD_green));</span>
<span class="nc" id="L523">                node.setAttribute(&quot;blue&quot;, Integer.toString(bKGD_blue));</span>
            }
<span class="nc" id="L525">            bKGD_node.appendChild(node);</span>

<span class="nc" id="L527">            root.appendChild(bKGD_node);</span>
        }

        // cHRM
<span class="nc bnc" id="L531" title="All 2 branches missed.">        if (cHRM_present) {</span>
<span class="nc" id="L532">            IIOMetadataNode cHRM_node = new IIOMetadataNode(&quot;cHRM&quot;);</span>
<span class="nc" id="L533">            cHRM_node.setAttribute(&quot;whitePointX&quot;,</span>
<span class="nc" id="L534">                              Integer.toString(cHRM_whitePointX));</span>
<span class="nc" id="L535">            cHRM_node.setAttribute(&quot;whitePointY&quot;,</span>
<span class="nc" id="L536">                              Integer.toString(cHRM_whitePointY));</span>
<span class="nc" id="L537">            cHRM_node.setAttribute(&quot;redX&quot;, Integer.toString(cHRM_redX));</span>
<span class="nc" id="L538">            cHRM_node.setAttribute(&quot;redY&quot;, Integer.toString(cHRM_redY));</span>
<span class="nc" id="L539">            cHRM_node.setAttribute(&quot;greenX&quot;, Integer.toString(cHRM_greenX));</span>
<span class="nc" id="L540">            cHRM_node.setAttribute(&quot;greenY&quot;, Integer.toString(cHRM_greenY));</span>
<span class="nc" id="L541">            cHRM_node.setAttribute(&quot;blueX&quot;, Integer.toString(cHRM_blueX));</span>
<span class="nc" id="L542">            cHRM_node.setAttribute(&quot;blueY&quot;, Integer.toString(cHRM_blueY));</span>

<span class="nc" id="L544">            root.appendChild(cHRM_node);</span>
        }

        // gAMA
<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (gAMA_present) {</span>
<span class="nc" id="L549">            IIOMetadataNode gAMA_node = new IIOMetadataNode(&quot;gAMA&quot;);</span>
<span class="nc" id="L550">            gAMA_node.setAttribute(&quot;value&quot;, Integer.toString(gAMA_gamma));</span>

<span class="nc" id="L552">            root.appendChild(gAMA_node);</span>
        }

        // hIST
<span class="nc bnc" id="L556" title="All 2 branches missed.">        if (hIST_present) {</span>
<span class="nc" id="L557">            IIOMetadataNode hIST_node = new IIOMetadataNode(&quot;hIST&quot;);</span>

<span class="nc bnc" id="L559" title="All 2 branches missed.">            for (int i = 0; i &lt; hIST_histogram.length; i++) {</span>
<span class="nc" id="L560">                IIOMetadataNode hist =</span>
                    new IIOMetadataNode(&quot;hISTEntry&quot;);
<span class="nc" id="L562">                hist.setAttribute(&quot;index&quot;, Integer.toString(i));</span>
<span class="nc" id="L563">                hist.setAttribute(&quot;value&quot;,</span>
<span class="nc" id="L564">                                  Integer.toString(hIST_histogram[i]));</span>
<span class="nc" id="L565">                hIST_node.appendChild(hist);</span>
            }

<span class="nc" id="L568">            root.appendChild(hIST_node);</span>
        }

        // iCCP
<span class="nc bnc" id="L572" title="All 2 branches missed.">        if (iCCP_present) {</span>
<span class="nc" id="L573">            IIOMetadataNode iCCP_node = new IIOMetadataNode(&quot;iCCP&quot;);</span>
<span class="nc" id="L574">            iCCP_node.setAttribute(&quot;profileName&quot;, iCCP_profileName);</span>
<span class="nc" id="L575">            iCCP_node.setAttribute(&quot;compressionMethod&quot;,</span>
                          iCCP_compressionMethodNames[iCCP_compressionMethod]);

<span class="nc" id="L578">            Object profile = iCCP_compressedProfile;</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">            if (profile != null) {</span>
<span class="nc" id="L580">                profile = ((byte[])profile).clone();</span>
            }
<span class="nc" id="L582">            iCCP_node.setUserObject(profile);</span>

<span class="nc" id="L584">            root.appendChild(iCCP_node);</span>
        }

        // iTXt
<span class="nc bnc" id="L588" title="All 2 branches missed.">        if (iTXt_keyword.size() &gt; 0) {</span>
<span class="nc" id="L589">            IIOMetadataNode iTXt_parent = new IIOMetadataNode(&quot;iTXt&quot;);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">            for (int i = 0; i &lt; iTXt_keyword.size(); i++) {</span>
<span class="nc" id="L591">                IIOMetadataNode iTXt_node = new IIOMetadataNode(&quot;iTXtEntry&quot;);</span>
<span class="nc" id="L592">                iTXt_node.setAttribute(&quot;keyword&quot;, iTXt_keyword.get(i));</span>
<span class="nc" id="L593">                iTXt_node.setAttribute(&quot;compressionFlag&quot;,</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">                        iTXt_compressionFlag.get(i) ? &quot;TRUE&quot; : &quot;FALSE&quot;);</span>
<span class="nc" id="L595">                iTXt_node.setAttribute(&quot;compressionMethod&quot;,</span>
<span class="nc" id="L596">                        iTXt_compressionMethod.get(i).toString());</span>
<span class="nc" id="L597">                iTXt_node.setAttribute(&quot;languageTag&quot;,</span>
<span class="nc" id="L598">                                       iTXt_languageTag.get(i));</span>
<span class="nc" id="L599">                iTXt_node.setAttribute(&quot;translatedKeyword&quot;,</span>
<span class="nc" id="L600">                                       iTXt_translatedKeyword.get(i));</span>
<span class="nc" id="L601">                iTXt_node.setAttribute(&quot;text&quot;, iTXt_text.get(i));</span>

<span class="nc" id="L603">                iTXt_parent.appendChild(iTXt_node);</span>
            }

<span class="nc" id="L606">            root.appendChild(iTXt_parent);</span>
        }

        // pHYs
<span class="nc bnc" id="L610" title="All 2 branches missed.">        if (pHYs_present) {</span>
<span class="nc" id="L611">            IIOMetadataNode pHYs_node = new IIOMetadataNode(&quot;pHYs&quot;);</span>
<span class="nc" id="L612">            pHYs_node.setAttribute(&quot;pixelsPerUnitXAxis&quot;,</span>
<span class="nc" id="L613">                              Integer.toString(pHYs_pixelsPerUnitXAxis));</span>
<span class="nc" id="L614">            pHYs_node.setAttribute(&quot;pixelsPerUnitYAxis&quot;,</span>
<span class="nc" id="L615">                                   Integer.toString(pHYs_pixelsPerUnitYAxis));</span>
<span class="nc" id="L616">            pHYs_node.setAttribute(&quot;unitSpecifier&quot;,</span>
                                   unitSpecifierNames[pHYs_unitSpecifier]);

<span class="nc" id="L619">            root.appendChild(pHYs_node);</span>
        }

        // sBIT
<span class="nc bnc" id="L623" title="All 2 branches missed.">        if (sBIT_present) {</span>
<span class="nc" id="L624">            IIOMetadataNode sBIT_node = new IIOMetadataNode(&quot;sBIT&quot;);</span>

<span class="nc bnc" id="L626" title="All 2 branches missed.">            if (sBIT_colorType == PNGImageReader.PNG_COLOR_GRAY) {</span>
<span class="nc" id="L627">                node = new IIOMetadataNode(&quot;sBIT_Grayscale&quot;);</span>
<span class="nc" id="L628">                node.setAttribute(&quot;gray&quot;,</span>
<span class="nc" id="L629">                                  Integer.toString(sBIT_grayBits));</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">            } else if (sBIT_colorType == PNGImageReader.PNG_COLOR_GRAY_ALPHA) {</span>
<span class="nc" id="L631">                node = new IIOMetadataNode(&quot;sBIT_GrayAlpha&quot;);</span>
<span class="nc" id="L632">                node.setAttribute(&quot;gray&quot;,</span>
<span class="nc" id="L633">                                  Integer.toString(sBIT_grayBits));</span>
<span class="nc" id="L634">                node.setAttribute(&quot;alpha&quot;,</span>
<span class="nc" id="L635">                                  Integer.toString(sBIT_alphaBits));</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">            } else if (sBIT_colorType == PNGImageReader.PNG_COLOR_RGB) {</span>
<span class="nc" id="L637">                node = new IIOMetadataNode(&quot;sBIT_RGB&quot;);</span>
<span class="nc" id="L638">                node.setAttribute(&quot;red&quot;,</span>
<span class="nc" id="L639">                                  Integer.toString(sBIT_redBits));</span>
<span class="nc" id="L640">                node.setAttribute(&quot;green&quot;,</span>
<span class="nc" id="L641">                                  Integer.toString(sBIT_greenBits));</span>
<span class="nc" id="L642">                node.setAttribute(&quot;blue&quot;,</span>
<span class="nc" id="L643">                                  Integer.toString(sBIT_blueBits));</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">            } else if (sBIT_colorType == PNGImageReader.PNG_COLOR_RGB_ALPHA) {</span>
<span class="nc" id="L645">                node = new IIOMetadataNode(&quot;sBIT_RGBAlpha&quot;);</span>
<span class="nc" id="L646">                node.setAttribute(&quot;red&quot;,</span>
<span class="nc" id="L647">                                  Integer.toString(sBIT_redBits));</span>
<span class="nc" id="L648">                node.setAttribute(&quot;green&quot;,</span>
<span class="nc" id="L649">                                  Integer.toString(sBIT_greenBits));</span>
<span class="nc" id="L650">                node.setAttribute(&quot;blue&quot;,</span>
<span class="nc" id="L651">                                  Integer.toString(sBIT_blueBits));</span>
<span class="nc" id="L652">                node.setAttribute(&quot;alpha&quot;,</span>
<span class="nc" id="L653">                                  Integer.toString(sBIT_alphaBits));</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">            } else if (sBIT_colorType == PNGImageReader.PNG_COLOR_PALETTE) {</span>
<span class="nc" id="L655">                node = new IIOMetadataNode(&quot;sBIT_Palette&quot;);</span>
<span class="nc" id="L656">                node.setAttribute(&quot;red&quot;,</span>
<span class="nc" id="L657">                                  Integer.toString(sBIT_redBits));</span>
<span class="nc" id="L658">                node.setAttribute(&quot;green&quot;,</span>
<span class="nc" id="L659">                                  Integer.toString(sBIT_greenBits));</span>
<span class="nc" id="L660">                node.setAttribute(&quot;blue&quot;,</span>
<span class="nc" id="L661">                                  Integer.toString(sBIT_blueBits));</span>
            }
<span class="nc" id="L663">            sBIT_node.appendChild(node);</span>

<span class="nc" id="L665">            root.appendChild(sBIT_node);</span>
        }

        // sPLT
<span class="nc bnc" id="L669" title="All 2 branches missed.">        if (sPLT_present) {</span>
<span class="nc" id="L670">            IIOMetadataNode sPLT_node = new IIOMetadataNode(&quot;sPLT&quot;);</span>

<span class="nc" id="L672">            sPLT_node.setAttribute(&quot;name&quot;, sPLT_paletteName);</span>
<span class="nc" id="L673">            sPLT_node.setAttribute(&quot;sampleDepth&quot;,</span>
<span class="nc" id="L674">                                   Integer.toString(sPLT_sampleDepth));</span>

<span class="nc" id="L676">            int numEntries = sPLT_red.length;</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">            for (int i = 0; i &lt; numEntries; i++) {</span>
<span class="nc" id="L678">                IIOMetadataNode entry = new IIOMetadataNode(&quot;sPLTEntry&quot;);</span>
<span class="nc" id="L679">                entry.setAttribute(&quot;index&quot;, Integer.toString(i));</span>
<span class="nc" id="L680">                entry.setAttribute(&quot;red&quot;, Integer.toString(sPLT_red[i]));</span>
<span class="nc" id="L681">                entry.setAttribute(&quot;green&quot;, Integer.toString(sPLT_green[i]));</span>
<span class="nc" id="L682">                entry.setAttribute(&quot;blue&quot;, Integer.toString(sPLT_blue[i]));</span>
<span class="nc" id="L683">                entry.setAttribute(&quot;alpha&quot;, Integer.toString(sPLT_alpha[i]));</span>
<span class="nc" id="L684">                entry.setAttribute(&quot;frequency&quot;,</span>
<span class="nc" id="L685">                                  Integer.toString(sPLT_frequency[i]));</span>
<span class="nc" id="L686">                sPLT_node.appendChild(entry);</span>
            }

<span class="nc" id="L689">            root.appendChild(sPLT_node);</span>
        }

        // sRGB
<span class="nc bnc" id="L693" title="All 2 branches missed.">        if (sRGB_present) {</span>
<span class="nc" id="L694">            IIOMetadataNode sRGB_node = new IIOMetadataNode(&quot;sRGB&quot;);</span>
<span class="nc" id="L695">            sRGB_node.setAttribute(&quot;renderingIntent&quot;,</span>
                                   renderingIntentNames[sRGB_renderingIntent]);

<span class="nc" id="L698">            root.appendChild(sRGB_node);</span>
        }

        // tEXt
<span class="nc bnc" id="L702" title="All 2 branches missed.">        if (tEXt_keyword.size() &gt; 0) {</span>
<span class="nc" id="L703">            IIOMetadataNode tEXt_parent = new IIOMetadataNode(&quot;tEXt&quot;);</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">            for (int i = 0; i &lt; tEXt_keyword.size(); i++) {</span>
<span class="nc" id="L705">                IIOMetadataNode tEXt_node = new IIOMetadataNode(&quot;tEXtEntry&quot;);</span>
<span class="nc" id="L706">                tEXt_node.setAttribute(&quot;keyword&quot; , (String)tEXt_keyword.get(i));</span>
<span class="nc" id="L707">                tEXt_node.setAttribute(&quot;value&quot; , (String)tEXt_text.get(i));</span>

<span class="nc" id="L709">                tEXt_parent.appendChild(tEXt_node);</span>
            }

<span class="nc" id="L712">            root.appendChild(tEXt_parent);</span>
        }

        // tIME
<span class="nc bnc" id="L716" title="All 2 branches missed.">        if (tIME_present) {</span>
<span class="nc" id="L717">            IIOMetadataNode tIME_node = new IIOMetadataNode(&quot;tIME&quot;);</span>
<span class="nc" id="L718">            tIME_node.setAttribute(&quot;year&quot;, Integer.toString(tIME_year));</span>
<span class="nc" id="L719">            tIME_node.setAttribute(&quot;month&quot;, Integer.toString(tIME_month));</span>
<span class="nc" id="L720">            tIME_node.setAttribute(&quot;day&quot;, Integer.toString(tIME_day));</span>
<span class="nc" id="L721">            tIME_node.setAttribute(&quot;hour&quot;, Integer.toString(tIME_hour));</span>
<span class="nc" id="L722">            tIME_node.setAttribute(&quot;minute&quot;, Integer.toString(tIME_minute));</span>
<span class="nc" id="L723">            tIME_node.setAttribute(&quot;second&quot;, Integer.toString(tIME_second));</span>

<span class="nc" id="L725">            root.appendChild(tIME_node);</span>
        }

        // tRNS
<span class="nc bnc" id="L729" title="All 2 branches missed.">        if (tRNS_present) {</span>
<span class="nc" id="L730">            IIOMetadataNode tRNS_node = new IIOMetadataNode(&quot;tRNS&quot;);</span>

<span class="nc bnc" id="L732" title="All 2 branches missed.">            if (tRNS_colorType == PNGImageReader.PNG_COLOR_PALETTE) {</span>
<span class="nc" id="L733">                node = new IIOMetadataNode(&quot;tRNS_Palette&quot;);</span>

<span class="nc bnc" id="L735" title="All 2 branches missed.">                for (int i = 0; i &lt; tRNS_alpha.length; i++) {</span>
<span class="nc" id="L736">                    IIOMetadataNode entry =</span>
                        new IIOMetadataNode(&quot;tRNS_PaletteEntry&quot;);
<span class="nc" id="L738">                    entry.setAttribute(&quot;index&quot;, Integer.toString(i));</span>
<span class="nc" id="L739">                    entry.setAttribute(&quot;alpha&quot;,</span>
<span class="nc" id="L740">                                       Integer.toString(tRNS_alpha[i] &amp; 0xff));</span>
<span class="nc" id="L741">                    node.appendChild(entry);</span>
                }
<span class="nc bnc" id="L743" title="All 2 branches missed.">            } else if (tRNS_colorType == PNGImageReader.PNG_COLOR_GRAY) {</span>
<span class="nc" id="L744">                node = new IIOMetadataNode(&quot;tRNS_Grayscale&quot;);</span>
<span class="nc" id="L745">                node.setAttribute(&quot;gray&quot;, Integer.toString(tRNS_gray));</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">            } else if (tRNS_colorType == PNGImageReader.PNG_COLOR_RGB) {</span>
<span class="nc" id="L747">                node = new IIOMetadataNode(&quot;tRNS_RGB&quot;);</span>
<span class="nc" id="L748">                node.setAttribute(&quot;red&quot;, Integer.toString(tRNS_red));</span>
<span class="nc" id="L749">                node.setAttribute(&quot;green&quot;, Integer.toString(tRNS_green));</span>
<span class="nc" id="L750">                node.setAttribute(&quot;blue&quot;, Integer.toString(tRNS_blue));</span>
            }
<span class="nc" id="L752">            tRNS_node.appendChild(node);</span>

<span class="nc" id="L754">            root.appendChild(tRNS_node);</span>
        }

        // zTXt
<span class="nc bnc" id="L758" title="All 2 branches missed.">        if (zTXt_keyword.size() &gt; 0) {</span>
<span class="nc" id="L759">            IIOMetadataNode zTXt_parent = new IIOMetadataNode(&quot;zTXt&quot;);</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">            for (int i = 0; i &lt; zTXt_keyword.size(); i++) {</span>
<span class="nc" id="L761">                IIOMetadataNode zTXt_node = new IIOMetadataNode(&quot;zTXtEntry&quot;);</span>
<span class="nc" id="L762">                zTXt_node.setAttribute(&quot;keyword&quot;, (String)zTXt_keyword.get(i));</span>

<span class="nc" id="L764">                int cm = ((Integer)zTXt_compressionMethod.get(i)).intValue();</span>
<span class="nc" id="L765">                zTXt_node.setAttribute(&quot;compressionMethod&quot;,</span>
                                       zTXt_compressionMethodNames[cm]);

<span class="nc" id="L768">                zTXt_node.setAttribute(&quot;text&quot;, (String)zTXt_text.get(i));</span>

<span class="nc" id="L770">                zTXt_parent.appendChild(zTXt_node);</span>
            }

<span class="nc" id="L773">            root.appendChild(zTXt_parent);</span>
        }

        // Unknown chunks
<span class="nc bnc" id="L777" title="All 2 branches missed.">        if (unknownChunkType.size() &gt; 0) {</span>
<span class="nc" id="L778">            IIOMetadataNode unknown_parent =</span>
                new IIOMetadataNode(&quot;UnknownChunks&quot;);
<span class="nc bnc" id="L780" title="All 2 branches missed.">            for (int i = 0; i &lt; unknownChunkType.size(); i++) {</span>
<span class="nc" id="L781">                IIOMetadataNode unknown_node =</span>
                    new IIOMetadataNode(&quot;UnknownChunk&quot;);
<span class="nc" id="L783">                unknown_node.setAttribute(&quot;type&quot;,</span>
<span class="nc" id="L784">                                          (String)unknownChunkType.get(i));</span>
<span class="nc" id="L785">                unknown_node.setUserObject((byte[])unknownChunkData.get(i));</span>

<span class="nc" id="L787">                unknown_parent.appendChild(unknown_node);</span>
            }

<span class="nc" id="L790">            root.appendChild(unknown_parent);</span>
        }

<span class="nc" id="L793">        return root;</span>
    }

    private int getNumChannels() {
        // Determine number of channels
        // Be careful about palette color with transparency
<span class="nc" id="L799">        int numChannels = IHDR_numChannels[IHDR_colorType];</span>
<span class="nc bnc" id="L800" title="All 6 branches missed.">        if (IHDR_colorType == PNGImageReader.PNG_COLOR_PALETTE &amp;&amp;</span>
            tRNS_present &amp;&amp; tRNS_colorType == IHDR_colorType) {
<span class="nc" id="L802">            numChannels = 4;</span>
        }
<span class="nc" id="L804">        return numChannels;</span>
    }

    public IIOMetadataNode getStandardChromaNode() {
<span class="nc" id="L808">        IIOMetadataNode chroma_node = new IIOMetadataNode(&quot;Chroma&quot;);</span>
<span class="nc" id="L809">        IIOMetadataNode node = null; // scratch node</span>

<span class="nc" id="L811">        node = new IIOMetadataNode(&quot;ColorSpaceType&quot;);</span>
<span class="nc" id="L812">        node.setAttribute(&quot;name&quot;, colorSpaceTypeNames[IHDR_colorType]);</span>
<span class="nc" id="L813">        chroma_node.appendChild(node);</span>

<span class="nc" id="L815">        node = new IIOMetadataNode(&quot;NumChannels&quot;);</span>
<span class="nc" id="L816">        node.setAttribute(&quot;value&quot;, Integer.toString(getNumChannels()));</span>
<span class="nc" id="L817">        chroma_node.appendChild(node);</span>

<span class="nc bnc" id="L819" title="All 2 branches missed.">        if (gAMA_present) {</span>
<span class="nc" id="L820">            node = new IIOMetadataNode(&quot;Gamma&quot;);</span>
<span class="nc" id="L821">            node.setAttribute(&quot;value&quot;, Float.toString(gAMA_gamma*1.0e-5F));</span>
<span class="nc" id="L822">            chroma_node.appendChild(node);</span>
        }

<span class="nc" id="L825">        node = new IIOMetadataNode(&quot;BlackIsZero&quot;);</span>
<span class="nc" id="L826">        node.setAttribute(&quot;value&quot;, &quot;TRUE&quot;);</span>
<span class="nc" id="L827">        chroma_node.appendChild(node);</span>

<span class="nc bnc" id="L829" title="All 2 branches missed.">        if (PLTE_present) {</span>
<span class="nc bnc" id="L830" title="All 4 branches missed.">            boolean hasAlpha = tRNS_present &amp;&amp;</span>
                (tRNS_colorType == PNGImageReader.PNG_COLOR_PALETTE);

<span class="nc" id="L833">            node = new IIOMetadataNode(&quot;Palette&quot;);</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">            for (int i = 0; i &lt; PLTE_red.length; i++) {</span>
<span class="nc" id="L835">                IIOMetadataNode entry =</span>
                    new IIOMetadataNode(&quot;PaletteEntry&quot;);
<span class="nc" id="L837">                entry.setAttribute(&quot;index&quot;, Integer.toString(i));</span>
<span class="nc" id="L838">                entry.setAttribute(&quot;red&quot;,</span>
<span class="nc" id="L839">                                   Integer.toString(PLTE_red[i] &amp; 0xff));</span>
<span class="nc" id="L840">                entry.setAttribute(&quot;green&quot;,</span>
<span class="nc" id="L841">                                   Integer.toString(PLTE_green[i] &amp; 0xff));</span>
<span class="nc" id="L842">                entry.setAttribute(&quot;blue&quot;,</span>
<span class="nc" id="L843">                                   Integer.toString(PLTE_blue[i] &amp; 0xff));</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">                if (hasAlpha) {</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">                    int alpha = (i &lt; tRNS_alpha.length) ?</span>
                        (tRNS_alpha[i] &amp; 0xff) : 255;
<span class="nc" id="L847">                    entry.setAttribute(&quot;alpha&quot;, Integer.toString(alpha));</span>
                }
<span class="nc" id="L849">                node.appendChild(entry);</span>
            }
<span class="nc" id="L851">            chroma_node.appendChild(node);</span>
        }

<span class="nc bnc" id="L854" title="All 2 branches missed.">        if (bKGD_present) {</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">            if (bKGD_colorType == PNGImageReader.PNG_COLOR_PALETTE) {</span>
<span class="nc" id="L856">                node = new IIOMetadataNode(&quot;BackgroundIndex&quot;);</span>
<span class="nc" id="L857">                node.setAttribute(&quot;value&quot;, Integer.toString(bKGD_index));</span>
            } else {
<span class="nc" id="L859">                node = new IIOMetadataNode(&quot;BackgroundColor&quot;);</span>
                int r, g, b;

<span class="nc bnc" id="L862" title="All 2 branches missed.">                if (bKGD_colorType == PNGImageReader.PNG_COLOR_GRAY) {</span>
<span class="nc" id="L863">                    r = g = b = bKGD_gray;</span>
                } else {
<span class="nc" id="L865">                    r = bKGD_red;</span>
<span class="nc" id="L866">                    g = bKGD_green;</span>
<span class="nc" id="L867">                    b = bKGD_blue;</span>
                }
<span class="nc" id="L869">                node.setAttribute(&quot;red&quot;, Integer.toString(r));</span>
<span class="nc" id="L870">                node.setAttribute(&quot;green&quot;, Integer.toString(g));</span>
<span class="nc" id="L871">                node.setAttribute(&quot;blue&quot;, Integer.toString(b));</span>
            }
<span class="nc" id="L873">            chroma_node.appendChild(node);</span>
        }

<span class="nc" id="L876">        return chroma_node;</span>
    }

    public IIOMetadataNode getStandardCompressionNode() {
<span class="nc" id="L880">        IIOMetadataNode compression_node = new IIOMetadataNode(&quot;Compression&quot;);</span>
<span class="nc" id="L881">        IIOMetadataNode node = null; // scratch node</span>

<span class="nc" id="L883">        node = new IIOMetadataNode(&quot;CompressionTypeName&quot;);</span>
<span class="nc" id="L884">        node.setAttribute(&quot;value&quot;, &quot;deflate&quot;);</span>
<span class="nc" id="L885">        compression_node.appendChild(node);</span>

<span class="nc" id="L887">        node = new IIOMetadataNode(&quot;Lossless&quot;);</span>
<span class="nc" id="L888">        node.setAttribute(&quot;value&quot;, &quot;TRUE&quot;);</span>
<span class="nc" id="L889">        compression_node.appendChild(node);</span>

<span class="nc" id="L891">        node = new IIOMetadataNode(&quot;NumProgressiveScans&quot;);</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">        node.setAttribute(&quot;value&quot;,</span>
                          (IHDR_interlaceMethod == 0) ? &quot;1&quot; : &quot;7&quot;);
<span class="nc" id="L894">        compression_node.appendChild(node);</span>

<span class="nc" id="L896">        return compression_node;</span>
    }

    private String repeat(String s, int times) {
<span class="nc bnc" id="L900" title="All 2 branches missed.">        if (times == 1) {</span>
<span class="nc" id="L901">            return s;</span>
        }
<span class="nc" id="L903">        StringBuffer sb = new StringBuffer((s.length() + 1)*times - 1);</span>
<span class="nc" id="L904">        sb.append(s);</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">        for (int i = 1; i &lt; times; i++) {</span>
<span class="nc" id="L906">            sb.append(&quot; &quot;);</span>
<span class="nc" id="L907">            sb.append(s);</span>
        }
<span class="nc" id="L909">        return sb.toString();</span>
    }

    public IIOMetadataNode getStandardDataNode() {
<span class="nc" id="L913">        IIOMetadataNode data_node = new IIOMetadataNode(&quot;Data&quot;);</span>
<span class="nc" id="L914">        IIOMetadataNode node = null; // scratch node</span>

<span class="nc" id="L916">        node = new IIOMetadataNode(&quot;PlanarConfiguration&quot;);</span>
<span class="nc" id="L917">        node.setAttribute(&quot;value&quot;, &quot;PixelInterleaved&quot;);</span>
<span class="nc" id="L918">        data_node.appendChild(node);</span>

<span class="nc" id="L920">        node = new IIOMetadataNode(&quot;SampleFormat&quot;);</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">        node.setAttribute(&quot;value&quot;,</span>
                          IHDR_colorType == PNGImageReader.PNG_COLOR_PALETTE ?
                          &quot;Index&quot; : &quot;UnsignedIntegral&quot;);
<span class="nc" id="L924">        data_node.appendChild(node);</span>

<span class="nc" id="L926">        String bitDepth = Integer.toString(IHDR_bitDepth);</span>
<span class="nc" id="L927">        node = new IIOMetadataNode(&quot;BitsPerSample&quot;);</span>
<span class="nc" id="L928">        node.setAttribute(&quot;value&quot;, repeat(bitDepth, getNumChannels()));</span>
<span class="nc" id="L929">        data_node.appendChild(node);</span>

<span class="nc bnc" id="L931" title="All 2 branches missed.">        if (sBIT_present) {</span>
<span class="nc" id="L932">            node = new IIOMetadataNode(&quot;SignificantBitsPerSample&quot;);</span>
            String sbits;
<span class="nc bnc" id="L934" title="All 4 branches missed.">            if (sBIT_colorType == PNGImageReader.PNG_COLOR_GRAY ||</span>
                sBIT_colorType == PNGImageReader.PNG_COLOR_GRAY_ALPHA) {
<span class="nc" id="L936">                sbits = Integer.toString(sBIT_grayBits);</span>
            } else { // sBIT_colorType == PNGImageReader.PNG_COLOR_RGB ||
                     // sBIT_colorType == PNGImageReader.PNG_COLOR_RGB_ALPHA
<span class="nc" id="L939">                sbits = Integer.toString(sBIT_redBits) + &quot; &quot; +</span>
<span class="nc" id="L940">                    Integer.toString(sBIT_greenBits) + &quot; &quot; +</span>
<span class="nc" id="L941">                    Integer.toString(sBIT_blueBits);</span>
            }

<span class="nc bnc" id="L944" title="All 4 branches missed.">            if (sBIT_colorType == PNGImageReader.PNG_COLOR_GRAY_ALPHA ||</span>
                sBIT_colorType == PNGImageReader.PNG_COLOR_RGB_ALPHA) {
<span class="nc" id="L946">                sbits += &quot; &quot; + Integer.toString(sBIT_alphaBits);</span>
            }

<span class="nc" id="L949">            node.setAttribute(&quot;value&quot;, sbits);</span>
<span class="nc" id="L950">            data_node.appendChild(node);</span>
        }

        // SampleMSB

<span class="nc" id="L955">        return data_node;</span>
    }

    public IIOMetadataNode getStandardDimensionNode() {
<span class="nc" id="L959">        IIOMetadataNode dimension_node = new IIOMetadataNode(&quot;Dimension&quot;);</span>
<span class="nc" id="L960">        IIOMetadataNode node = null; // scratch node</span>

<span class="nc" id="L962">        node = new IIOMetadataNode(&quot;PixelAspectRatio&quot;);</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">        float ratio = pHYs_present ?</span>
            (float)pHYs_pixelsPerUnitXAxis/pHYs_pixelsPerUnitYAxis : 1.0F;
<span class="nc" id="L965">        node.setAttribute(&quot;value&quot;, Float.toString(ratio));</span>
<span class="nc" id="L966">        dimension_node.appendChild(node);</span>

<span class="nc" id="L968">        node = new IIOMetadataNode(&quot;ImageOrientation&quot;);</span>
<span class="nc" id="L969">        node.setAttribute(&quot;value&quot;, &quot;Normal&quot;);</span>
<span class="nc" id="L970">        dimension_node.appendChild(node);</span>

<span class="nc bnc" id="L972" title="All 4 branches missed.">        if (pHYs_present &amp;&amp; pHYs_unitSpecifier == PHYS_UNIT_METER) {</span>
<span class="nc" id="L973">            node = new IIOMetadataNode(&quot;HorizontalPixelSize&quot;);</span>
<span class="nc" id="L974">            node.setAttribute(&quot;value&quot;,</span>
<span class="nc" id="L975">                              Float.toString(1000.0F/pHYs_pixelsPerUnitXAxis));</span>
<span class="nc" id="L976">            dimension_node.appendChild(node);</span>

<span class="nc" id="L978">            node = new IIOMetadataNode(&quot;VerticalPixelSize&quot;);</span>
<span class="nc" id="L979">            node.setAttribute(&quot;value&quot;,</span>
<span class="nc" id="L980">                              Float.toString(1000.0F/pHYs_pixelsPerUnitYAxis));</span>
<span class="nc" id="L981">            dimension_node.appendChild(node);</span>
        }

<span class="nc" id="L984">        return dimension_node;</span>
    }

    public IIOMetadataNode getStandardDocumentNode() {
<span class="nc bnc" id="L988" title="All 2 branches missed.">        if (!tIME_present) {</span>
<span class="nc" id="L989">            return null;</span>
        }

<span class="nc" id="L992">        IIOMetadataNode document_node = new IIOMetadataNode(&quot;Document&quot;);</span>
<span class="nc" id="L993">        IIOMetadataNode node = null; // scratch node</span>

<span class="nc" id="L995">        node = new IIOMetadataNode(&quot;ImageModificationTime&quot;);</span>
<span class="nc" id="L996">        node.setAttribute(&quot;year&quot;, Integer.toString(tIME_year));</span>
<span class="nc" id="L997">        node.setAttribute(&quot;month&quot;, Integer.toString(tIME_month));</span>
<span class="nc" id="L998">        node.setAttribute(&quot;day&quot;, Integer.toString(tIME_day));</span>
<span class="nc" id="L999">        node.setAttribute(&quot;hour&quot;, Integer.toString(tIME_hour));</span>
<span class="nc" id="L1000">        node.setAttribute(&quot;minute&quot;, Integer.toString(tIME_minute));</span>
<span class="nc" id="L1001">        node.setAttribute(&quot;second&quot;, Integer.toString(tIME_second));</span>
<span class="nc" id="L1002">        document_node.appendChild(node);</span>

<span class="nc" id="L1004">        return document_node;</span>
    }

    public IIOMetadataNode getStandardTextNode() {
<span class="nc" id="L1008">        int numEntries = tEXt_keyword.size() +</span>
<span class="nc" id="L1009">            iTXt_keyword.size() + zTXt_keyword.size();</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">        if (numEntries == 0) {</span>
<span class="nc" id="L1011">            return null;</span>
        }

<span class="nc" id="L1014">        IIOMetadataNode text_node = new IIOMetadataNode(&quot;Text&quot;);</span>
<span class="nc" id="L1015">        IIOMetadataNode node = null; // scratch node</span>

<span class="nc bnc" id="L1017" title="All 2 branches missed.">        for (int i = 0; i &lt; tEXt_keyword.size(); i++) {</span>
<span class="nc" id="L1018">            node = new IIOMetadataNode(&quot;TextEntry&quot;);</span>
<span class="nc" id="L1019">            node.setAttribute(&quot;keyword&quot;, (String)tEXt_keyword.get(i));</span>
<span class="nc" id="L1020">            node.setAttribute(&quot;value&quot;, (String)tEXt_text.get(i));</span>
<span class="nc" id="L1021">            node.setAttribute(&quot;encoding&quot;, &quot;ISO-8859-1&quot;);</span>
<span class="nc" id="L1022">            node.setAttribute(&quot;compression&quot;, &quot;none&quot;);</span>

<span class="nc" id="L1024">            text_node.appendChild(node);</span>
        }

<span class="nc bnc" id="L1027" title="All 2 branches missed.">        for (int i = 0; i &lt; iTXt_keyword.size(); i++) {</span>
<span class="nc" id="L1028">            node = new IIOMetadataNode(&quot;TextEntry&quot;);</span>
<span class="nc" id="L1029">            node.setAttribute(&quot;keyword&quot;, iTXt_keyword.get(i));</span>
<span class="nc" id="L1030">            node.setAttribute(&quot;value&quot;, iTXt_text.get(i));</span>
<span class="nc" id="L1031">            node.setAttribute(&quot;language&quot;,</span>
<span class="nc" id="L1032">                              iTXt_languageTag.get(i));</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">            if (iTXt_compressionFlag.get(i)) {</span>
<span class="nc" id="L1034">                node.setAttribute(&quot;compression&quot;, &quot;zip&quot;);</span>
            } else {
<span class="nc" id="L1036">                node.setAttribute(&quot;compression&quot;, &quot;none&quot;);</span>
            }

<span class="nc" id="L1039">            text_node.appendChild(node);</span>
        }

<span class="nc bnc" id="L1042" title="All 2 branches missed.">        for (int i = 0; i &lt; zTXt_keyword.size(); i++) {</span>
<span class="nc" id="L1043">            node = new IIOMetadataNode(&quot;TextEntry&quot;);</span>
<span class="nc" id="L1044">            node.setAttribute(&quot;keyword&quot;, (String)zTXt_keyword.get(i));</span>
<span class="nc" id="L1045">            node.setAttribute(&quot;value&quot;, (String)zTXt_text.get(i));</span>
<span class="nc" id="L1046">            node.setAttribute(&quot;compression&quot;, &quot;zip&quot;);</span>

<span class="nc" id="L1048">            text_node.appendChild(node);</span>
        }

<span class="nc" id="L1051">        return text_node;</span>
    }

    public IIOMetadataNode getStandardTransparencyNode() {
<span class="nc" id="L1055">        IIOMetadataNode transparency_node =</span>
            new IIOMetadataNode(&quot;Transparency&quot;);
<span class="nc" id="L1057">        IIOMetadataNode node = null; // scratch node</span>

<span class="nc" id="L1059">        node = new IIOMetadataNode(&quot;Alpha&quot;);</span>
<span class="nc bnc" id="L1060" title="All 12 branches missed.">        boolean hasAlpha =</span>
            (IHDR_colorType == PNGImageReader.PNG_COLOR_RGB_ALPHA) ||
            (IHDR_colorType == PNGImageReader.PNG_COLOR_GRAY_ALPHA) ||
            (IHDR_colorType == PNGImageReader.PNG_COLOR_PALETTE &amp;&amp;
             tRNS_present &amp;&amp;
             (tRNS_colorType == IHDR_colorType) &amp;&amp;
             (tRNS_alpha != null));
<span class="nc bnc" id="L1067" title="All 2 branches missed.">        node.setAttribute(&quot;value&quot;, hasAlpha ? &quot;nonpremultipled&quot; : &quot;none&quot;);</span>
<span class="nc" id="L1068">        transparency_node.appendChild(node);</span>

<span class="nc bnc" id="L1070" title="All 2 branches missed.">        if (tRNS_present) {</span>
<span class="nc" id="L1071">            node = new IIOMetadataNode(&quot;TransparentColor&quot;);</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">            if (tRNS_colorType == PNGImageReader.PNG_COLOR_RGB) {</span>
<span class="nc" id="L1073">                node.setAttribute(&quot;value&quot;,</span>
<span class="nc" id="L1074">                                  Integer.toString(tRNS_red) + &quot; &quot; +</span>
<span class="nc" id="L1075">                                  Integer.toString(tRNS_green) + &quot; &quot; +</span>
<span class="nc" id="L1076">                                  Integer.toString(tRNS_blue));</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">            } else if (tRNS_colorType == PNGImageReader.PNG_COLOR_GRAY) {</span>
<span class="nc" id="L1078">                node.setAttribute(&quot;value&quot;, Integer.toString(tRNS_gray));</span>
            }
<span class="nc" id="L1080">            transparency_node.appendChild(node);</span>
        }

<span class="nc" id="L1083">        return transparency_node;</span>
    }

    // Shorthand for throwing an IIOInvalidTreeException
    private void fatal(Node node, String reason)
        throws IIOInvalidTreeException {
<span class="nc" id="L1089">        throw new IIOInvalidTreeException(reason, node);</span>
    }

    // Get an integer-valued attribute
    private String getStringAttribute(Node node, String name,
                                      String defaultValue, boolean required)
        throws IIOInvalidTreeException {
<span class="nc" id="L1096">        Node attr = node.getAttributes().getNamedItem(name);</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">        if (attr == null) {</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">            if (!required) {</span>
<span class="nc" id="L1099">                return defaultValue;</span>
            } else {
<span class="nc" id="L1101">                fatal(node, &quot;Required attribute &quot; + name + &quot; not present!&quot;);</span>
            }
        }
<span class="nc" id="L1104">        return attr.getNodeValue();</span>
    }


    // Get an integer-valued attribute
    private int getIntAttribute(Node node, String name,
                                int defaultValue, boolean required)
        throws IIOInvalidTreeException {
<span class="nc" id="L1112">        String value = getStringAttribute(node, name, null, required);</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L1114">            return defaultValue;</span>
        }
<span class="nc" id="L1116">        return Integer.parseInt(value);</span>
    }

    // Get a float-valued attribute
    private float getFloatAttribute(Node node, String name,
                                    float defaultValue, boolean required)
        throws IIOInvalidTreeException {
<span class="nc" id="L1123">        String value = getStringAttribute(node, name, null, required);</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L1125">            return defaultValue;</span>
        }
<span class="nc" id="L1127">        return Float.parseFloat(value);</span>
    }

    // Get a required integer-valued attribute
    private int getIntAttribute(Node node, String name)
        throws IIOInvalidTreeException {
<span class="nc" id="L1133">        return getIntAttribute(node, name, -1, true);</span>
    }

    // Get a required float-valued attribute
    private float getFloatAttribute(Node node, String name)
        throws IIOInvalidTreeException {
<span class="nc" id="L1139">        return getFloatAttribute(node, name, -1.0F, true);</span>
    }

    // Get a boolean-valued attribute
    private boolean getBooleanAttribute(Node node, String name,
                                        boolean defaultValue,
                                        boolean required)
        throws IIOInvalidTreeException {
<span class="nc" id="L1147">        Node attr = node.getAttributes().getNamedItem(name);</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">        if (attr == null) {</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">            if (!required) {</span>
<span class="nc" id="L1150">                return defaultValue;</span>
            } else {
<span class="nc" id="L1152">                fatal(node, &quot;Required attribute &quot; + name + &quot; not present!&quot;);</span>
            }
        }
<span class="nc" id="L1155">        String value = attr.getNodeValue();</span>
        // Allow lower case booleans for backward compatibility, #5082756
<span class="nc bnc" id="L1157" title="All 4 branches missed.">        if (value.equals(&quot;TRUE&quot;) || value.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L1158">            return true;</span>
<span class="nc bnc" id="L1159" title="All 4 branches missed.">        } else if (value.equals(&quot;FALSE&quot;) || value.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L1160">            return false;</span>
        } else {
<span class="nc" id="L1162">            fatal(node, &quot;Attribute &quot; + name + &quot; must be 'TRUE' or 'FALSE'!&quot;);</span>
<span class="nc" id="L1163">            return false;</span>
        }
    }

    // Get a required boolean-valued attribute
    private boolean getBooleanAttribute(Node node, String name)
        throws IIOInvalidTreeException {
<span class="nc" id="L1170">        return getBooleanAttribute(node, name, false, true);</span>
    }

    // Get an enumerated attribute as an index into a String array
    private int getEnumeratedAttribute(Node node,
                                       String name, String[] legalNames,
                                       int defaultValue, boolean required)
        throws IIOInvalidTreeException {
<span class="nc" id="L1178">        Node attr = node.getAttributes().getNamedItem(name);</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">        if (attr == null) {</span>
<span class="nc bnc" id="L1180" title="All 2 branches missed.">            if (!required) {</span>
<span class="nc" id="L1181">                return defaultValue;</span>
            } else {
<span class="nc" id="L1183">                fatal(node, &quot;Required attribute &quot; + name + &quot; not present!&quot;);</span>
            }
        }
<span class="nc" id="L1186">        String value = attr.getNodeValue();</span>
<span class="nc bnc" id="L1187" title="All 2 branches missed.">        for (int i = 0; i &lt; legalNames.length; i++) {</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">            if (value.equals(legalNames[i])) {</span>
<span class="nc" id="L1189">                return i;</span>
            }
        }

<span class="nc" id="L1193">        fatal(node, &quot;Illegal value for attribute &quot; + name + &quot;!&quot;);</span>
<span class="nc" id="L1194">        return -1;</span>
    }

    // Get a required enumerated attribute as an index into a String array
    private int getEnumeratedAttribute(Node node,
                                       String name, String[] legalNames)
        throws IIOInvalidTreeException {
<span class="nc" id="L1201">        return getEnumeratedAttribute(node, name, legalNames, -1, true);</span>
    }

    // Get a String-valued attribute
    private String getAttribute(Node node, String name,
                                String defaultValue, boolean required)
        throws IIOInvalidTreeException {
<span class="nc" id="L1208">        Node attr = node.getAttributes().getNamedItem(name);</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">        if (attr == null) {</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">            if (!required) {</span>
<span class="nc" id="L1211">                return defaultValue;</span>
            } else {
<span class="nc" id="L1213">                fatal(node, &quot;Required attribute &quot; + name + &quot; not present!&quot;);</span>
            }
        }
<span class="nc" id="L1216">        return attr.getNodeValue();</span>
    }

    // Get a required String-valued attribute
    private String getAttribute(Node node, String name)
        throws IIOInvalidTreeException {
<span class="nc" id="L1222">            return getAttribute(node, name, null, true);</span>
    }

    public void mergeTree(String formatName, Node root)
        throws IIOInvalidTreeException {
<span class="nc bnc" id="L1227" title="All 2 branches missed.">        if (formatName.equals(nativeMetadataFormatName)) {</span>
<span class="nc bnc" id="L1228" title="All 2 branches missed.">            if (root == null) {</span>
<span class="nc" id="L1229">                throw new IllegalArgumentException(&quot;root == null!&quot;);</span>
            }
<span class="nc" id="L1231">            mergeNativeTree(root);</span>
<span class="nc" id="L1232">        } else if (formatName.equals</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">                   (IIOMetadataFormatImpl.standardMetadataFormatName)) {</span>
<span class="nc bnc" id="L1234" title="All 2 branches missed.">            if (root == null) {</span>
<span class="nc" id="L1235">                throw new IllegalArgumentException(&quot;root == null!&quot;);</span>
            }
<span class="nc" id="L1237">            mergeStandardTree(root);</span>
        } else {
<span class="nc" id="L1239">            throw new IllegalArgumentException(&quot;Not a recognized format!&quot;);</span>
        }
<span class="nc" id="L1241">    }</span>

    private void mergeNativeTree(Node root)
        throws IIOInvalidTreeException {
<span class="nc" id="L1245">        Node node = root;</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">        if (!node.getNodeName().equals(nativeMetadataFormatName)) {</span>
<span class="nc" id="L1247">            fatal(node, &quot;Root must be &quot; + nativeMetadataFormatName);</span>
        }

<span class="nc" id="L1250">        node = node.getFirstChild();</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">        while (node != null) {</span>
<span class="nc" id="L1252">            String name = node.getNodeName();</span>

<span class="nc bnc" id="L1254" title="All 2 branches missed.">            if (name.equals(&quot;IHDR&quot;)) {</span>
<span class="nc" id="L1255">                IHDR_width = getIntAttribute(node, &quot;width&quot;);</span>
<span class="nc" id="L1256">                IHDR_height = getIntAttribute(node, &quot;height&quot;);</span>
<span class="nc" id="L1257">                IHDR_bitDepth = getEnumeratedAttribute(node, &quot;bitDepth&quot;,</span>
                                                       IHDR_bitDepths);
<span class="nc" id="L1259">                IHDR_colorType = getEnumeratedAttribute(node, &quot;colorType&quot;,</span>
                                                        IHDR_colorTypeNames);
<span class="nc" id="L1261">                IHDR_compressionMethod =</span>
<span class="nc" id="L1262">                    getEnumeratedAttribute(node, &quot;compressionMethod&quot;,</span>
                                           IHDR_compressionMethodNames);
<span class="nc" id="L1264">                IHDR_filterMethod =</span>
<span class="nc" id="L1265">                    getEnumeratedAttribute(node,</span>
                                           &quot;filterMethod&quot;,
                                           IHDR_filterMethodNames);
<span class="nc" id="L1268">                IHDR_interlaceMethod =</span>
<span class="nc" id="L1269">                    getEnumeratedAttribute(node, &quot;interlaceMethod&quot;,</span>
                                           IHDR_interlaceMethodNames);
<span class="nc" id="L1271">                IHDR_present = true;</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">            } else if (name.equals(&quot;PLTE&quot;)) {</span>
<span class="nc" id="L1273">                byte[] red = new byte[256];</span>
<span class="nc" id="L1274">                byte[] green  = new byte[256];</span>
<span class="nc" id="L1275">                byte[] blue = new byte[256];</span>
<span class="nc" id="L1276">                int maxindex = -1;</span>

<span class="nc" id="L1278">                Node PLTE_entry = node.getFirstChild();</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">                if (PLTE_entry == null) {</span>
<span class="nc" id="L1280">                    fatal(node, &quot;Palette has no entries!&quot;);</span>
                }

<span class="nc bnc" id="L1283" title="All 2 branches missed.">                while (PLTE_entry != null) {</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">                    if (!PLTE_entry.getNodeName().equals(&quot;PLTEEntry&quot;)) {</span>
<span class="nc" id="L1285">                        fatal(node,</span>
                              &quot;Only a PLTEEntry may be a child of a PLTE!&quot;);
                    }

<span class="nc" id="L1289">                    int index = getIntAttribute(PLTE_entry, &quot;index&quot;);</span>
<span class="nc bnc" id="L1290" title="All 4 branches missed.">                    if (index &lt; 0 || index &gt; 255) {</span>
<span class="nc" id="L1291">                        fatal(node,</span>
                              &quot;Bad value for PLTEEntry attribute index!&quot;);
                    }
<span class="nc bnc" id="L1294" title="All 2 branches missed.">                    if (index &gt; maxindex) {</span>
<span class="nc" id="L1295">                        maxindex = index;</span>
                    }
<span class="nc" id="L1297">                    red[index] =</span>
<span class="nc" id="L1298">                        (byte)getIntAttribute(PLTE_entry, &quot;red&quot;);</span>
<span class="nc" id="L1299">                    green[index] =</span>
<span class="nc" id="L1300">                        (byte)getIntAttribute(PLTE_entry, &quot;green&quot;);</span>
<span class="nc" id="L1301">                    blue[index] =</span>
<span class="nc" id="L1302">                        (byte)getIntAttribute(PLTE_entry, &quot;blue&quot;);</span>

<span class="nc" id="L1304">                    PLTE_entry = PLTE_entry.getNextSibling();</span>
<span class="nc" id="L1305">                }</span>

<span class="nc" id="L1307">                int numEntries = maxindex + 1;</span>
<span class="nc" id="L1308">                PLTE_red = new byte[numEntries];</span>
<span class="nc" id="L1309">                PLTE_green = new byte[numEntries];</span>
<span class="nc" id="L1310">                PLTE_blue = new byte[numEntries];</span>
<span class="nc" id="L1311">                System.arraycopy(red, 0, PLTE_red, 0, numEntries);</span>
<span class="nc" id="L1312">                System.arraycopy(green, 0, PLTE_green, 0, numEntries);</span>
<span class="nc" id="L1313">                System.arraycopy(blue, 0, PLTE_blue, 0, numEntries);</span>
<span class="nc" id="L1314">                PLTE_present = true;</span>
<span class="nc bnc" id="L1315" title="All 2 branches missed.">            } else if (name.equals(&quot;bKGD&quot;)) {</span>
<span class="nc" id="L1316">                bKGD_present = false; // Guard against partial overwrite</span>
<span class="nc" id="L1317">                Node bKGD_node = node.getFirstChild();</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">                if (bKGD_node == null) {</span>
<span class="nc" id="L1319">                    fatal(node, &quot;bKGD node has no children!&quot;);</span>
                }
<span class="nc" id="L1321">                String bKGD_name = bKGD_node.getNodeName();</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">                if (bKGD_name.equals(&quot;bKGD_Palette&quot;)) {</span>
<span class="nc" id="L1323">                    bKGD_index = getIntAttribute(bKGD_node, &quot;index&quot;);</span>
<span class="nc" id="L1324">                    bKGD_colorType = PNGImageReader.PNG_COLOR_PALETTE;</span>
<span class="nc bnc" id="L1325" title="All 2 branches missed.">                } else if (bKGD_name.equals(&quot;bKGD_Grayscale&quot;)) {</span>
<span class="nc" id="L1326">                    bKGD_gray = getIntAttribute(bKGD_node, &quot;gray&quot;);</span>
<span class="nc" id="L1327">                    bKGD_colorType = PNGImageReader.PNG_COLOR_GRAY;</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed.">                } else if (bKGD_name.equals(&quot;bKGD_RGB&quot;)) {</span>
<span class="nc" id="L1329">                    bKGD_red = getIntAttribute(bKGD_node, &quot;red&quot;);</span>
<span class="nc" id="L1330">                    bKGD_green = getIntAttribute(bKGD_node, &quot;green&quot;);</span>
<span class="nc" id="L1331">                    bKGD_blue = getIntAttribute(bKGD_node, &quot;blue&quot;);</span>
<span class="nc" id="L1332">                    bKGD_colorType = PNGImageReader.PNG_COLOR_RGB;</span>
                } else {
<span class="nc" id="L1334">                    fatal(node, &quot;Bad child of a bKGD node!&quot;);</span>
                }
<span class="nc bnc" id="L1336" title="All 2 branches missed.">                if (bKGD_node.getNextSibling() != null) {</span>
<span class="nc" id="L1337">                    fatal(node, &quot;bKGD node has more than one child!&quot;);</span>
                }

<span class="nc" id="L1340">                bKGD_present = true;</span>
<span class="nc bnc" id="L1341" title="All 2 branches missed.">            } else if (name.equals(&quot;cHRM&quot;)) {</span>
<span class="nc" id="L1342">                cHRM_whitePointX = getIntAttribute(node, &quot;whitePointX&quot;);</span>
<span class="nc" id="L1343">                cHRM_whitePointY = getIntAttribute(node, &quot;whitePointY&quot;);</span>
<span class="nc" id="L1344">                cHRM_redX = getIntAttribute(node, &quot;redX&quot;);</span>
<span class="nc" id="L1345">                cHRM_redY = getIntAttribute(node, &quot;redY&quot;);</span>
<span class="nc" id="L1346">                cHRM_greenX = getIntAttribute(node, &quot;greenX&quot;);</span>
<span class="nc" id="L1347">                cHRM_greenY = getIntAttribute(node, &quot;greenY&quot;);</span>
<span class="nc" id="L1348">                cHRM_blueX = getIntAttribute(node, &quot;blueX&quot;);</span>
<span class="nc" id="L1349">                cHRM_blueY = getIntAttribute(node, &quot;blueY&quot;);</span>

<span class="nc" id="L1351">                cHRM_present = true;</span>
<span class="nc bnc" id="L1352" title="All 2 branches missed.">            } else if (name.equals(&quot;gAMA&quot;)) {</span>
<span class="nc" id="L1353">                gAMA_gamma = getIntAttribute(node, &quot;value&quot;);</span>
<span class="nc" id="L1354">                gAMA_present = true;</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">            } else if (name.equals(&quot;hIST&quot;)) {</span>
<span class="nc" id="L1356">                char[] hist = new char[256];</span>
<span class="nc" id="L1357">                int maxindex = -1;</span>

<span class="nc" id="L1359">                Node hIST_entry = node.getFirstChild();</span>
<span class="nc bnc" id="L1360" title="All 2 branches missed.">                if (hIST_entry == null) {</span>
<span class="nc" id="L1361">                    fatal(node, &quot;hIST node has no children!&quot;);</span>
                }

<span class="nc bnc" id="L1364" title="All 2 branches missed.">                while (hIST_entry != null) {</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">                    if (!hIST_entry.getNodeName().equals(&quot;hISTEntry&quot;)) {</span>
<span class="nc" id="L1366">                        fatal(node,</span>
                              &quot;Only a hISTEntry may be a child of a hIST!&quot;);
                    }

<span class="nc" id="L1370">                    int index = getIntAttribute(hIST_entry, &quot;index&quot;);</span>
<span class="nc bnc" id="L1371" title="All 4 branches missed.">                    if (index &lt; 0 || index &gt; 255) {</span>
<span class="nc" id="L1372">                        fatal(node,</span>
                              &quot;Bad value for histEntry attribute index!&quot;);
                    }
<span class="nc bnc" id="L1375" title="All 2 branches missed.">                    if (index &gt; maxindex) {</span>
<span class="nc" id="L1376">                        maxindex = index;</span>
                    }
<span class="nc" id="L1378">                    hist[index] =</span>
<span class="nc" id="L1379">                        (char)getIntAttribute(hIST_entry, &quot;value&quot;);</span>

<span class="nc" id="L1381">                    hIST_entry = hIST_entry.getNextSibling();</span>
<span class="nc" id="L1382">                }</span>

<span class="nc" id="L1384">                int numEntries = maxindex + 1;</span>
<span class="nc" id="L1385">                hIST_histogram = new char[numEntries];</span>
<span class="nc" id="L1386">                System.arraycopy(hist, 0, hIST_histogram, 0, numEntries);</span>

<span class="nc" id="L1388">                hIST_present = true;</span>
<span class="nc bnc" id="L1389" title="All 2 branches missed.">            } else if (name.equals(&quot;iCCP&quot;)) {</span>
<span class="nc" id="L1390">                iCCP_profileName = getAttribute(node, &quot;profileName&quot;);</span>
<span class="nc" id="L1391">                iCCP_compressionMethod =</span>
<span class="nc" id="L1392">                    getEnumeratedAttribute(node, &quot;compressionMethod&quot;,</span>
                                           iCCP_compressionMethodNames);
<span class="nc" id="L1394">                Object compressedProfile =</span>
<span class="nc" id="L1395">                    ((IIOMetadataNode)node).getUserObject();</span>
<span class="nc bnc" id="L1396" title="All 2 branches missed.">                if (compressedProfile == null) {</span>
<span class="nc" id="L1397">                    fatal(node, &quot;No ICCP profile present in user object!&quot;);</span>
                }
<span class="nc bnc" id="L1399" title="All 2 branches missed.">                if (!(compressedProfile instanceof byte[])) {</span>
<span class="nc" id="L1400">                    fatal(node, &quot;User object not a byte array!&quot;);</span>
                }

<span class="nc" id="L1403">                iCCP_compressedProfile =</span>
<span class="nc" id="L1404">                    (byte[])((byte[])compressedProfile).clone();</span>

<span class="nc" id="L1406">                iCCP_present = true;</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">            } else if (name.equals(&quot;iTXt&quot;)) {</span>
<span class="nc" id="L1408">                Node iTXt_node = node.getFirstChild();</span>
<span class="nc bnc" id="L1409" title="All 2 branches missed.">                while (iTXt_node != null) {</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">                    if (!iTXt_node.getNodeName().equals(&quot;iTXtEntry&quot;)) {</span>
<span class="nc" id="L1411">                        fatal(node,</span>
                              &quot;Only an iTXtEntry may be a child of an iTXt!&quot;);
                    }

<span class="nc" id="L1415">                    String keyword = getAttribute(iTXt_node, &quot;keyword&quot;);</span>
<span class="nc bnc" id="L1416" title="All 2 branches missed.">                    if (isValidKeyword(keyword)) {</span>
<span class="nc" id="L1417">                        iTXt_keyword.add(keyword);</span>

<span class="nc" id="L1419">                        boolean compressionFlag =</span>
<span class="nc" id="L1420">                            getBooleanAttribute(iTXt_node, &quot;compressionFlag&quot;);</span>
<span class="nc" id="L1421">                        iTXt_compressionFlag.add(Boolean.valueOf(compressionFlag));</span>

<span class="nc" id="L1423">                        String compressionMethod =</span>
<span class="nc" id="L1424">                            getAttribute(iTXt_node, &quot;compressionMethod&quot;);</span>
<span class="nc" id="L1425">                        iTXt_compressionMethod.add(Integer.valueOf(compressionMethod));</span>

<span class="nc" id="L1427">                        String languageTag =</span>
<span class="nc" id="L1428">                            getAttribute(iTXt_node, &quot;languageTag&quot;);</span>
<span class="nc" id="L1429">                        iTXt_languageTag.add(languageTag);</span>

<span class="nc" id="L1431">                        String translatedKeyword =</span>
<span class="nc" id="L1432">                            getAttribute(iTXt_node, &quot;translatedKeyword&quot;);</span>
<span class="nc" id="L1433">                        iTXt_translatedKeyword.add(translatedKeyword);</span>

<span class="nc" id="L1435">                        String text = getAttribute(iTXt_node, &quot;text&quot;);</span>
<span class="nc" id="L1436">                        iTXt_text.add(text);</span>

                    }
                    // silently skip invalid text entry

<span class="nc" id="L1441">                    iTXt_node = iTXt_node.getNextSibling();</span>
<span class="nc" id="L1442">                }</span>
<span class="nc bnc" id="L1443" title="All 2 branches missed.">            } else if (name.equals(&quot;pHYs&quot;)) {</span>
<span class="nc" id="L1444">                pHYs_pixelsPerUnitXAxis =</span>
<span class="nc" id="L1445">                    getIntAttribute(node, &quot;pixelsPerUnitXAxis&quot;);</span>
<span class="nc" id="L1446">                pHYs_pixelsPerUnitYAxis =</span>
<span class="nc" id="L1447">                    getIntAttribute(node, &quot;pixelsPerUnitYAxis&quot;);</span>
<span class="nc" id="L1448">                pHYs_unitSpecifier =</span>
<span class="nc" id="L1449">                    getEnumeratedAttribute(node, &quot;unitSpecifier&quot;,</span>
                                           unitSpecifierNames);

<span class="nc" id="L1452">                pHYs_present = true;</span>
<span class="nc bnc" id="L1453" title="All 2 branches missed.">            } else if (name.equals(&quot;sBIT&quot;)) {</span>
<span class="nc" id="L1454">                sBIT_present = false; // Guard against partial overwrite</span>
<span class="nc" id="L1455">                Node sBIT_node = node.getFirstChild();</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">                if (sBIT_node == null) {</span>
<span class="nc" id="L1457">                    fatal(node, &quot;sBIT node has no children!&quot;);</span>
                }
<span class="nc" id="L1459">                String sBIT_name = sBIT_node.getNodeName();</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">                if (sBIT_name.equals(&quot;sBIT_Grayscale&quot;)) {</span>
<span class="nc" id="L1461">                    sBIT_grayBits = getIntAttribute(sBIT_node, &quot;gray&quot;);</span>
<span class="nc" id="L1462">                    sBIT_colorType = PNGImageReader.PNG_COLOR_GRAY;</span>
<span class="nc bnc" id="L1463" title="All 2 branches missed.">                } else if (sBIT_name.equals(&quot;sBIT_GrayAlpha&quot;)) {</span>
<span class="nc" id="L1464">                    sBIT_grayBits = getIntAttribute(sBIT_node, &quot;gray&quot;);</span>
<span class="nc" id="L1465">                    sBIT_alphaBits = getIntAttribute(sBIT_node, &quot;alpha&quot;);</span>
<span class="nc" id="L1466">                    sBIT_colorType = PNGImageReader.PNG_COLOR_GRAY_ALPHA;</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">                } else if (sBIT_name.equals(&quot;sBIT_RGB&quot;)) {</span>
<span class="nc" id="L1468">                    sBIT_redBits = getIntAttribute(sBIT_node, &quot;red&quot;);</span>
<span class="nc" id="L1469">                    sBIT_greenBits = getIntAttribute(sBIT_node, &quot;green&quot;);</span>
<span class="nc" id="L1470">                    sBIT_blueBits = getIntAttribute(sBIT_node, &quot;blue&quot;);</span>
<span class="nc" id="L1471">                    sBIT_colorType = PNGImageReader.PNG_COLOR_RGB;</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">                } else if (sBIT_name.equals(&quot;sBIT_RGBAlpha&quot;)) {</span>
<span class="nc" id="L1473">                    sBIT_redBits = getIntAttribute(sBIT_node, &quot;red&quot;);</span>
<span class="nc" id="L1474">                    sBIT_greenBits = getIntAttribute(sBIT_node, &quot;green&quot;);</span>
<span class="nc" id="L1475">                    sBIT_blueBits = getIntAttribute(sBIT_node, &quot;blue&quot;);</span>
<span class="nc" id="L1476">                    sBIT_alphaBits = getIntAttribute(sBIT_node, &quot;alpha&quot;);</span>
<span class="nc" id="L1477">                    sBIT_colorType = PNGImageReader.PNG_COLOR_RGB_ALPHA;</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">                } else if (sBIT_name.equals(&quot;sBIT_Palette&quot;)) {</span>
<span class="nc" id="L1479">                    sBIT_redBits = getIntAttribute(sBIT_node, &quot;red&quot;);</span>
<span class="nc" id="L1480">                    sBIT_greenBits = getIntAttribute(sBIT_node, &quot;green&quot;);</span>
<span class="nc" id="L1481">                    sBIT_blueBits = getIntAttribute(sBIT_node, &quot;blue&quot;);</span>
<span class="nc" id="L1482">                    sBIT_colorType = PNGImageReader.PNG_COLOR_PALETTE;</span>
                } else {
<span class="nc" id="L1484">                    fatal(node, &quot;Bad child of an sBIT node!&quot;);</span>
                }
<span class="nc bnc" id="L1486" title="All 2 branches missed.">                if (sBIT_node.getNextSibling() != null) {</span>
<span class="nc" id="L1487">                    fatal(node, &quot;sBIT node has more than one child!&quot;);</span>
                }

<span class="nc" id="L1490">                sBIT_present = true;</span>
<span class="nc bnc" id="L1491" title="All 2 branches missed.">            } else if (name.equals(&quot;sPLT&quot;)) {</span>
<span class="nc" id="L1492">                sPLT_paletteName = getAttribute(node, &quot;name&quot;);</span>
<span class="nc" id="L1493">                sPLT_sampleDepth = getIntAttribute(node, &quot;sampleDepth&quot;);</span>

<span class="nc" id="L1495">                int[] red = new int[256];</span>
<span class="nc" id="L1496">                int[] green  = new int[256];</span>
<span class="nc" id="L1497">                int[] blue = new int[256];</span>
<span class="nc" id="L1498">                int[] alpha = new int[256];</span>
<span class="nc" id="L1499">                int[] frequency = new int[256];</span>
<span class="nc" id="L1500">                int maxindex = -1;</span>

<span class="nc" id="L1502">                Node sPLT_entry = node.getFirstChild();</span>
<span class="nc bnc" id="L1503" title="All 2 branches missed.">                if (sPLT_entry == null) {</span>
<span class="nc" id="L1504">                    fatal(node, &quot;sPLT node has no children!&quot;);</span>
                }

<span class="nc bnc" id="L1507" title="All 2 branches missed.">                while (sPLT_entry != null) {</span>
<span class="nc bnc" id="L1508" title="All 2 branches missed.">                    if (!sPLT_entry.getNodeName().equals(&quot;sPLTEntry&quot;)) {</span>
<span class="nc" id="L1509">                        fatal(node,</span>
                              &quot;Only an sPLTEntry may be a child of an sPLT!&quot;);
                    }

<span class="nc" id="L1513">                    int index = getIntAttribute(sPLT_entry, &quot;index&quot;);</span>
<span class="nc bnc" id="L1514" title="All 4 branches missed.">                    if (index &lt; 0 || index &gt; 255) {</span>
<span class="nc" id="L1515">                        fatal(node,</span>
                              &quot;Bad value for PLTEEntry attribute index!&quot;);
                    }
<span class="nc bnc" id="L1518" title="All 2 branches missed.">                    if (index &gt; maxindex) {</span>
<span class="nc" id="L1519">                        maxindex = index;</span>
                    }
<span class="nc" id="L1521">                    red[index] = getIntAttribute(sPLT_entry, &quot;red&quot;);</span>
<span class="nc" id="L1522">                    green[index] = getIntAttribute(sPLT_entry, &quot;green&quot;);</span>
<span class="nc" id="L1523">                    blue[index] = getIntAttribute(sPLT_entry, &quot;blue&quot;);</span>
<span class="nc" id="L1524">                    alpha[index] = getIntAttribute(sPLT_entry, &quot;alpha&quot;);</span>
<span class="nc" id="L1525">                    frequency[index] =</span>
<span class="nc" id="L1526">                        getIntAttribute(sPLT_entry, &quot;frequency&quot;);</span>

<span class="nc" id="L1528">                    sPLT_entry = sPLT_entry.getNextSibling();</span>
<span class="nc" id="L1529">                }</span>

<span class="nc" id="L1531">                int numEntries = maxindex + 1;</span>
<span class="nc" id="L1532">                sPLT_red = new int[numEntries];</span>
<span class="nc" id="L1533">                sPLT_green = new int[numEntries];</span>
<span class="nc" id="L1534">                sPLT_blue = new int[numEntries];</span>
<span class="nc" id="L1535">                sPLT_alpha = new int[numEntries];</span>
<span class="nc" id="L1536">                sPLT_frequency = new int[numEntries];</span>
<span class="nc" id="L1537">                System.arraycopy(red, 0, sPLT_red, 0, numEntries);</span>
<span class="nc" id="L1538">                System.arraycopy(green, 0, sPLT_green, 0, numEntries);</span>
<span class="nc" id="L1539">                System.arraycopy(blue, 0, sPLT_blue, 0, numEntries);</span>
<span class="nc" id="L1540">                System.arraycopy(alpha, 0, sPLT_alpha, 0, numEntries);</span>
<span class="nc" id="L1541">                System.arraycopy(frequency, 0,</span>
                                 sPLT_frequency, 0, numEntries);

<span class="nc" id="L1544">                sPLT_present = true;</span>
<span class="nc bnc" id="L1545" title="All 2 branches missed.">            } else if (name.equals(&quot;sRGB&quot;)) {</span>
<span class="nc" id="L1546">                sRGB_renderingIntent =</span>
<span class="nc" id="L1547">                    getEnumeratedAttribute(node, &quot;renderingIntent&quot;,</span>
                                           renderingIntentNames);

<span class="nc" id="L1550">                sRGB_present = true;</span>
<span class="nc bnc" id="L1551" title="All 2 branches missed.">            } else if (name.equals(&quot;tEXt&quot;)) {</span>
<span class="nc" id="L1552">                Node tEXt_node = node.getFirstChild();</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">                while (tEXt_node != null) {</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">                    if (!tEXt_node.getNodeName().equals(&quot;tEXtEntry&quot;)) {</span>
<span class="nc" id="L1555">                        fatal(node,</span>
                              &quot;Only an tEXtEntry may be a child of an tEXt!&quot;);
                    }

<span class="nc" id="L1559">                    String keyword = getAttribute(tEXt_node, &quot;keyword&quot;);</span>
<span class="nc" id="L1560">                    tEXt_keyword.add(keyword);</span>

<span class="nc" id="L1562">                    String text = getAttribute(tEXt_node, &quot;value&quot;);</span>
<span class="nc" id="L1563">                    tEXt_text.add(text);</span>

<span class="nc" id="L1565">                    tEXt_node = tEXt_node.getNextSibling();</span>
<span class="nc" id="L1566">                }</span>
<span class="nc bnc" id="L1567" title="All 2 branches missed.">            } else if (name.equals(&quot;tIME&quot;)) {</span>
<span class="nc" id="L1568">                tIME_year = getIntAttribute(node, &quot;year&quot;);</span>
<span class="nc" id="L1569">                tIME_month = getIntAttribute(node, &quot;month&quot;);</span>
<span class="nc" id="L1570">                tIME_day = getIntAttribute(node, &quot;day&quot;);</span>
<span class="nc" id="L1571">                tIME_hour = getIntAttribute(node, &quot;hour&quot;);</span>
<span class="nc" id="L1572">                tIME_minute = getIntAttribute(node, &quot;minute&quot;);</span>
<span class="nc" id="L1573">                tIME_second = getIntAttribute(node, &quot;second&quot;);</span>

<span class="nc" id="L1575">                tIME_present = true;</span>
<span class="nc bnc" id="L1576" title="All 2 branches missed.">            } else if (name.equals(&quot;tRNS&quot;)) {</span>
<span class="nc" id="L1577">                tRNS_present = false; // Guard against partial overwrite</span>
<span class="nc" id="L1578">                Node tRNS_node = node.getFirstChild();</span>
<span class="nc bnc" id="L1579" title="All 2 branches missed.">                if (tRNS_node == null) {</span>
<span class="nc" id="L1580">                    fatal(node, &quot;tRNS node has no children!&quot;);</span>
                }
<span class="nc" id="L1582">                String tRNS_name = tRNS_node.getNodeName();</span>
<span class="nc bnc" id="L1583" title="All 2 branches missed.">                if (tRNS_name.equals(&quot;tRNS_Palette&quot;)) {</span>
<span class="nc" id="L1584">                    byte[] alpha = new byte[256];</span>
<span class="nc" id="L1585">                    int maxindex = -1;</span>

<span class="nc" id="L1587">                    Node tRNS_paletteEntry = tRNS_node.getFirstChild();</span>
<span class="nc bnc" id="L1588" title="All 2 branches missed.">                    if (tRNS_paletteEntry == null) {</span>
<span class="nc" id="L1589">                        fatal(node, &quot;tRNS_Palette node has no children!&quot;);</span>
                    }
<span class="nc bnc" id="L1591" title="All 2 branches missed.">                    while (tRNS_paletteEntry != null) {</span>
<span class="nc bnc" id="L1592" title="All 2 branches missed.">                        if (!tRNS_paletteEntry.getNodeName().equals(</span>
                                                        &quot;tRNS_PaletteEntry&quot;)) {
<span class="nc" id="L1594">                            fatal(node,</span>
                 &quot;Only a tRNS_PaletteEntry may be a child of a tRNS_Palette!&quot;);
                        }
<span class="nc" id="L1597">                        int index =</span>
<span class="nc" id="L1598">                            getIntAttribute(tRNS_paletteEntry, &quot;index&quot;);</span>
<span class="nc bnc" id="L1599" title="All 4 branches missed.">                        if (index &lt; 0 || index &gt; 255) {</span>
<span class="nc" id="L1600">                            fatal(node,</span>
                           &quot;Bad value for tRNS_PaletteEntry attribute index!&quot;);
                        }
<span class="nc bnc" id="L1603" title="All 2 branches missed.">                        if (index &gt; maxindex) {</span>
<span class="nc" id="L1604">                            maxindex = index;</span>
                        }
<span class="nc" id="L1606">                        alpha[index] =</span>
<span class="nc" id="L1607">                            (byte)getIntAttribute(tRNS_paletteEntry,</span>
                                                  &quot;alpha&quot;);

<span class="nc" id="L1610">                        tRNS_paletteEntry =</span>
<span class="nc" id="L1611">                            tRNS_paletteEntry.getNextSibling();</span>
<span class="nc" id="L1612">                    }</span>

<span class="nc" id="L1614">                    int numEntries = maxindex + 1;</span>
<span class="nc" id="L1615">                    tRNS_alpha = new byte[numEntries];</span>
<span class="nc" id="L1616">                    tRNS_colorType = PNGImageReader.PNG_COLOR_PALETTE;</span>
<span class="nc" id="L1617">                    System.arraycopy(alpha, 0, tRNS_alpha, 0, numEntries);</span>
<span class="nc bnc" id="L1618" title="All 2 branches missed.">                } else if (tRNS_name.equals(&quot;tRNS_Grayscale&quot;)) {</span>
<span class="nc" id="L1619">                    tRNS_gray = getIntAttribute(tRNS_node, &quot;gray&quot;);</span>
<span class="nc" id="L1620">                    tRNS_colorType = PNGImageReader.PNG_COLOR_GRAY;</span>
<span class="nc bnc" id="L1621" title="All 2 branches missed.">                } else if (tRNS_name.equals(&quot;tRNS_RGB&quot;)) {</span>
<span class="nc" id="L1622">                    tRNS_red = getIntAttribute(tRNS_node, &quot;red&quot;);</span>
<span class="nc" id="L1623">                    tRNS_green = getIntAttribute(tRNS_node, &quot;green&quot;);</span>
<span class="nc" id="L1624">                    tRNS_blue = getIntAttribute(tRNS_node, &quot;blue&quot;);</span>
<span class="nc" id="L1625">                    tRNS_colorType = PNGImageReader.PNG_COLOR_RGB;</span>
                } else {
<span class="nc" id="L1627">                    fatal(node, &quot;Bad child of a tRNS node!&quot;);</span>
                }
<span class="nc bnc" id="L1629" title="All 2 branches missed.">                if (tRNS_node.getNextSibling() != null) {</span>
<span class="nc" id="L1630">                    fatal(node, &quot;tRNS node has more than one child!&quot;);</span>
                }

<span class="nc" id="L1633">                tRNS_present = true;</span>
<span class="nc bnc" id="L1634" title="All 2 branches missed.">            } else if (name.equals(&quot;zTXt&quot;)) {</span>
<span class="nc" id="L1635">                Node zTXt_node = node.getFirstChild();</span>
<span class="nc bnc" id="L1636" title="All 2 branches missed.">                while (zTXt_node != null) {</span>
<span class="nc bnc" id="L1637" title="All 2 branches missed.">                    if (!zTXt_node.getNodeName().equals(&quot;zTXtEntry&quot;)) {</span>
<span class="nc" id="L1638">                        fatal(node,</span>
                              &quot;Only an zTXtEntry may be a child of an zTXt!&quot;);
                    }

<span class="nc" id="L1642">                    String keyword = getAttribute(zTXt_node, &quot;keyword&quot;);</span>
<span class="nc" id="L1643">                    zTXt_keyword.add(keyword);</span>

<span class="nc" id="L1645">                    int compressionMethod =</span>
<span class="nc" id="L1646">                        getEnumeratedAttribute(zTXt_node, &quot;compressionMethod&quot;,</span>
                                               zTXt_compressionMethodNames);
<span class="nc" id="L1648">                    zTXt_compressionMethod.add(new Integer(compressionMethod));</span>

<span class="nc" id="L1650">                    String text = getAttribute(zTXt_node, &quot;text&quot;);</span>
<span class="nc" id="L1651">                    zTXt_text.add(text);</span>

<span class="nc" id="L1653">                    zTXt_node = zTXt_node.getNextSibling();</span>
<span class="nc" id="L1654">                }</span>
<span class="nc bnc" id="L1655" title="All 2 branches missed.">            } else if (name.equals(&quot;UnknownChunks&quot;)) {</span>
<span class="nc" id="L1656">                Node unknown_node = node.getFirstChild();</span>
<span class="nc bnc" id="L1657" title="All 2 branches missed.">                while (unknown_node != null) {</span>
<span class="nc bnc" id="L1658" title="All 2 branches missed.">                    if (!unknown_node.getNodeName().equals(&quot;UnknownChunk&quot;)) {</span>
<span class="nc" id="L1659">                        fatal(node,</span>
                   &quot;Only an UnknownChunk may be a child of an UnknownChunks!&quot;);
                    }
<span class="nc" id="L1662">                    String chunkType = getAttribute(unknown_node, &quot;type&quot;);</span>
<span class="nc" id="L1663">                    Object chunkData =</span>
<span class="nc" id="L1664">                        ((IIOMetadataNode)unknown_node).getUserObject();</span>

<span class="nc bnc" id="L1666" title="All 2 branches missed.">                    if (chunkType.length() != 4) {</span>
<span class="nc" id="L1667">                        fatal(unknown_node,</span>
                              &quot;Chunk type must be 4 characters!&quot;);
                    }
<span class="nc bnc" id="L1670" title="All 2 branches missed.">                    if (chunkData == null) {</span>
<span class="nc" id="L1671">                        fatal(unknown_node,</span>
                              &quot;No chunk data present in user object!&quot;);
                    }
<span class="nc bnc" id="L1674" title="All 2 branches missed.">                    if (!(chunkData instanceof byte[])) {</span>
<span class="nc" id="L1675">                        fatal(unknown_node,</span>
                              &quot;User object not a byte array!&quot;);
                    }
<span class="nc" id="L1678">                    unknownChunkType.add(chunkType);</span>
<span class="nc" id="L1679">                    unknownChunkData.add(((byte[])chunkData).clone());</span>

<span class="nc" id="L1681">                    unknown_node = unknown_node.getNextSibling();</span>
<span class="nc" id="L1682">                }</span>
<span class="nc" id="L1683">            } else {</span>
<span class="nc" id="L1684">                fatal(node, &quot;Unknown child of root node!&quot;);</span>
            }

<span class="nc" id="L1687">            node = node.getNextSibling();</span>
<span class="nc" id="L1688">        }</span>
<span class="nc" id="L1689">    }</span>

    /*
     * Accrding to PNG spec, keywords are restricted to 1 to 79 bytes
     * in length. Keywords shall contain only printable Latin-1 characters
     * and spaces; To reduce the chances for human misreading of a keyword,
     * leading spaces, trailing spaces, and consecutive spaces are not
     * permitted in keywords.
     *
     * See: http://www.w3.org/TR/PNG/#11keywords
     */
    private boolean isValidKeyword(String s) {
<span class="nc" id="L1701">        int len = s.length();</span>
<span class="nc bnc" id="L1702" title="All 4 branches missed.">        if (len &lt; 1 || len &gt;= 80) {</span>
<span class="nc" id="L1703">            return false;</span>
        }
<span class="nc bnc" id="L1705" title="All 6 branches missed.">        if (s.startsWith(&quot; &quot;) || s.endsWith(&quot; &quot;) || s.contains(&quot;  &quot;)) {</span>
<span class="nc" id="L1706">            return false;</span>
        }
<span class="nc" id="L1708">        return isISOLatin(s, false);</span>
    }

    /*
     * According to PNG spec, keyword shall contain only printable
     * Latin-1 [ISO-8859-1] characters and spaces; that is, only
     * character codes 32-126 and 161-255 decimal are allowed.
     * For Latin-1 value fields the 0x10 (linefeed) control
     * character is aloowed too.
     *
     * See: http://www.w3.org/TR/PNG/#11keywords
     */
    private boolean isISOLatin(String s, boolean isLineFeedAllowed) {
<span class="nc" id="L1721">        int len = s.length();</span>
<span class="nc bnc" id="L1722" title="All 2 branches missed.">        for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L1723">            char c = s.charAt(i);</span>
<span class="nc bnc" id="L1724" title="All 8 branches missed.">            if (c &lt; 32 || c &gt; 255 || (c &gt; 126 &amp;&amp; c &lt; 161)) {</span>
                // not printable. Check whether this is an allowed
                // control char
<span class="nc bnc" id="L1727" title="All 4 branches missed.">                if (!isLineFeedAllowed || c != 0x10) {</span>
<span class="nc" id="L1728">                    return false;</span>
                }
            }
        }
<span class="nc" id="L1732">        return true;</span>
    }

    private void mergeStandardTree(Node root)
        throws IIOInvalidTreeException {
<span class="nc" id="L1737">        Node node = root;</span>
<span class="nc" id="L1738">        if (!node.getNodeName()</span>
<span class="nc bnc" id="L1739" title="All 2 branches missed.">            .equals(IIOMetadataFormatImpl.standardMetadataFormatName)) {</span>
<span class="nc" id="L1740">            fatal(node, &quot;Root must be &quot; +</span>
                  IIOMetadataFormatImpl.standardMetadataFormatName);
        }

<span class="nc" id="L1744">        node = node.getFirstChild();</span>
<span class="nc bnc" id="L1745" title="All 2 branches missed.">        while (node != null) {</span>
<span class="nc" id="L1746">            String name = node.getNodeName();</span>

<span class="nc bnc" id="L1748" title="All 2 branches missed.">            if (name.equals(&quot;Chroma&quot;)) {</span>
<span class="nc" id="L1749">                Node child = node.getFirstChild();</span>
<span class="nc bnc" id="L1750" title="All 2 branches missed.">                while (child != null) {</span>
<span class="nc" id="L1751">                    String childName = child.getNodeName();</span>
<span class="nc bnc" id="L1752" title="All 2 branches missed.">                    if (childName.equals(&quot;Gamma&quot;)) {</span>
<span class="nc" id="L1753">                        float gamma = getFloatAttribute(child, &quot;value&quot;);</span>
<span class="nc" id="L1754">                        gAMA_present = true;</span>
<span class="nc" id="L1755">                        gAMA_gamma = (int)(gamma*100000 + 0.5);</span>
<span class="nc bnc" id="L1756" title="All 2 branches missed.">                    } else if (childName.equals(&quot;Palette&quot;)) {</span>
<span class="nc" id="L1757">                        byte[] red = new byte[256];</span>
<span class="nc" id="L1758">                        byte[] green = new byte[256];</span>
<span class="nc" id="L1759">                        byte[] blue = new byte[256];</span>
<span class="nc" id="L1760">                        int maxindex = -1;</span>

<span class="nc" id="L1762">                        Node entry = child.getFirstChild();</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">                        while (entry != null) {</span>
<span class="nc" id="L1764">                            int index = getIntAttribute(entry, &quot;index&quot;);</span>
<span class="nc bnc" id="L1765" title="All 4 branches missed.">                            if (index &gt;= 0 &amp;&amp; index &lt;= 255) {</span>
<span class="nc" id="L1766">                                red[index] =</span>
<span class="nc" id="L1767">                                    (byte)getIntAttribute(entry, &quot;red&quot;);</span>
<span class="nc" id="L1768">                                green[index] =</span>
<span class="nc" id="L1769">                                    (byte)getIntAttribute(entry, &quot;green&quot;);</span>
<span class="nc" id="L1770">                                blue[index] =</span>
<span class="nc" id="L1771">                                    (byte)getIntAttribute(entry, &quot;blue&quot;);</span>
<span class="nc bnc" id="L1772" title="All 2 branches missed.">                                if (index &gt; maxindex) {</span>
<span class="nc" id="L1773">                                    maxindex = index;</span>
                                }
                            }
<span class="nc" id="L1776">                            entry = entry.getNextSibling();</span>
<span class="nc" id="L1777">                        }</span>

<span class="nc" id="L1779">                        int numEntries = maxindex + 1;</span>
<span class="nc" id="L1780">                        PLTE_red = new byte[numEntries];</span>
<span class="nc" id="L1781">                        PLTE_green = new byte[numEntries];</span>
<span class="nc" id="L1782">                        PLTE_blue = new byte[numEntries];</span>
<span class="nc" id="L1783">                        System.arraycopy(red, 0, PLTE_red, 0, numEntries);</span>
<span class="nc" id="L1784">                        System.arraycopy(green, 0, PLTE_green, 0, numEntries);</span>
<span class="nc" id="L1785">                        System.arraycopy(blue, 0, PLTE_blue, 0, numEntries);</span>
<span class="nc" id="L1786">                        PLTE_present = true;</span>
<span class="nc bnc" id="L1787" title="All 2 branches missed.">                    } else if (childName.equals(&quot;BackgroundIndex&quot;)) {</span>
<span class="nc" id="L1788">                        bKGD_present = true;</span>
<span class="nc" id="L1789">                        bKGD_colorType = PNGImageReader.PNG_COLOR_PALETTE;</span>
<span class="nc" id="L1790">                        bKGD_index = getIntAttribute(child, &quot;value&quot;);</span>
<span class="nc bnc" id="L1791" title="All 2 branches missed.">                    } else if (childName.equals(&quot;BackgroundColor&quot;)) {</span>
<span class="nc" id="L1792">                        int red = getIntAttribute(child, &quot;red&quot;);</span>
<span class="nc" id="L1793">                        int green = getIntAttribute(child, &quot;green&quot;);</span>
<span class="nc" id="L1794">                        int blue = getIntAttribute(child, &quot;blue&quot;);</span>
<span class="nc bnc" id="L1795" title="All 4 branches missed.">                        if (red == green &amp;&amp; red == blue) {</span>
<span class="nc" id="L1796">                            bKGD_colorType = PNGImageReader.PNG_COLOR_GRAY;</span>
<span class="nc" id="L1797">                            bKGD_gray = red;</span>
                        } else {
<span class="nc" id="L1799">                            bKGD_red = red;</span>
<span class="nc" id="L1800">                            bKGD_green = green;</span>
<span class="nc" id="L1801">                            bKGD_blue = blue;</span>
                        }
<span class="nc" id="L1803">                        bKGD_present = true;</span>
                    }
//                  } else if (childName.equals(&quot;ColorSpaceType&quot;)) {
//                  } else if (childName.equals(&quot;NumChannels&quot;)) {

<span class="nc" id="L1808">                    child = child.getNextSibling();</span>
<span class="nc" id="L1809">                }</span>
<span class="nc bnc" id="L1810" title="All 2 branches missed.">            } else if (name.equals(&quot;Compression&quot;)) {</span>
<span class="nc" id="L1811">                Node child = node.getFirstChild();</span>
<span class="nc bnc" id="L1812" title="All 2 branches missed.">                while (child != null) {</span>
<span class="nc" id="L1813">                    String childName = child.getNodeName();</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">                    if (childName.equals(&quot;NumProgressiveScans&quot;)) {</span>
                        // Use Adam7 if NumProgressiveScans &gt; 1
<span class="nc" id="L1816">                        int scans = getIntAttribute(child, &quot;value&quot;);</span>
<span class="nc bnc" id="L1817" title="All 2 branches missed.">                        IHDR_interlaceMethod = (scans &gt; 1) ? 1 : 0;</span>
//                  } else if (childName.equals(&quot;CompressionTypeName&quot;)) {
//                  } else if (childName.equals(&quot;Lossless&quot;)) {
//                  } else if (childName.equals(&quot;BitRate&quot;)) {
                    }
<span class="nc" id="L1822">                    child = child.getNextSibling();</span>
<span class="nc" id="L1823">                }</span>
<span class="nc bnc" id="L1824" title="All 2 branches missed.">            } else if (name.equals(&quot;Data&quot;)) {</span>
<span class="nc" id="L1825">                Node child = node.getFirstChild();</span>
<span class="nc bnc" id="L1826" title="All 2 branches missed.">                while (child != null) {</span>
<span class="nc" id="L1827">                    String childName = child.getNodeName();</span>
<span class="nc bnc" id="L1828" title="All 2 branches missed.">                    if (childName.equals(&quot;BitsPerSample&quot;)) {</span>
<span class="nc" id="L1829">                        String s = getAttribute(child, &quot;value&quot;);</span>
<span class="nc" id="L1830">                        StringTokenizer t = new StringTokenizer(s);</span>
<span class="nc" id="L1831">                        int maxBits = -1;</span>
<span class="nc bnc" id="L1832" title="All 2 branches missed.">                        while (t.hasMoreTokens()) {</span>
<span class="nc" id="L1833">                            int bits = Integer.parseInt(t.nextToken());</span>
<span class="nc bnc" id="L1834" title="All 2 branches missed.">                            if (bits &gt; maxBits) {</span>
<span class="nc" id="L1835">                                maxBits = bits;</span>
                            }
<span class="nc" id="L1837">                        }</span>
<span class="nc bnc" id="L1838" title="All 2 branches missed.">                        if (maxBits &lt; 1) {</span>
<span class="nc" id="L1839">                            maxBits = 1;</span>
                        }
<span class="nc bnc" id="L1841" title="All 2 branches missed.">                        if (maxBits == 3) maxBits = 4;</span>
<span class="nc bnc" id="L1842" title="All 4 branches missed.">                        if (maxBits &gt; 4 || maxBits &lt; 8) {</span>
<span class="nc" id="L1843">                            maxBits = 8;</span>
                        }
<span class="nc bnc" id="L1845" title="All 2 branches missed.">                        if (maxBits &gt; 8) {</span>
<span class="nc" id="L1846">                            maxBits = 16;</span>
                        }
<span class="nc" id="L1848">                        IHDR_bitDepth = maxBits;</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">                    } else if (childName.equals(&quot;SignificantBitsPerSample&quot;)) {</span>
<span class="nc" id="L1850">                        String s = getAttribute(child, &quot;value&quot;);</span>
<span class="nc" id="L1851">                        StringTokenizer t = new StringTokenizer(s);</span>
<span class="nc" id="L1852">                        int numTokens = t.countTokens();</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">                        if (numTokens == 1) {</span>
<span class="nc" id="L1854">                            sBIT_colorType = PNGImageReader.PNG_COLOR_GRAY;</span>
<span class="nc" id="L1855">                            sBIT_grayBits = Integer.parseInt(t.nextToken());</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">                        } else if (numTokens == 2) {</span>
<span class="nc" id="L1857">                            sBIT_colorType =</span>
                              PNGImageReader.PNG_COLOR_GRAY_ALPHA;
<span class="nc" id="L1859">                            sBIT_grayBits = Integer.parseInt(t.nextToken());</span>
<span class="nc" id="L1860">                            sBIT_alphaBits = Integer.parseInt(t.nextToken());</span>
<span class="nc bnc" id="L1861" title="All 2 branches missed.">                        } else if (numTokens == 3) {</span>
<span class="nc" id="L1862">                            sBIT_colorType = PNGImageReader.PNG_COLOR_RGB;</span>
<span class="nc" id="L1863">                            sBIT_redBits = Integer.parseInt(t.nextToken());</span>
<span class="nc" id="L1864">                            sBIT_greenBits = Integer.parseInt(t.nextToken());</span>
<span class="nc" id="L1865">                            sBIT_blueBits = Integer.parseInt(t.nextToken());</span>
<span class="nc bnc" id="L1866" title="All 2 branches missed.">                        } else if (numTokens == 4) {</span>
<span class="nc" id="L1867">                            sBIT_colorType =</span>
                              PNGImageReader.PNG_COLOR_RGB_ALPHA;
<span class="nc" id="L1869">                            sBIT_redBits = Integer.parseInt(t.nextToken());</span>
<span class="nc" id="L1870">                            sBIT_greenBits = Integer.parseInt(t.nextToken());</span>
<span class="nc" id="L1871">                            sBIT_blueBits = Integer.parseInt(t.nextToken());</span>
<span class="nc" id="L1872">                            sBIT_alphaBits = Integer.parseInt(t.nextToken());</span>
                        }
<span class="nc bnc" id="L1874" title="All 4 branches missed.">                        if (numTokens &gt;= 1 &amp;&amp; numTokens &lt;= 4) {</span>
<span class="nc" id="L1875">                            sBIT_present = true;</span>
                        }
//                      } else if (childName.equals(&quot;PlanarConfiguration&quot;)) {
//                      } else if (childName.equals(&quot;SampleFormat&quot;)) {
//                      } else if (childName.equals(&quot;SampleMSB&quot;)) {
                    }
<span class="nc" id="L1881">                    child = child.getNextSibling();</span>
<span class="nc" id="L1882">                }</span>
<span class="nc bnc" id="L1883" title="All 2 branches missed.">            } else if (name.equals(&quot;Dimension&quot;)) {</span>
<span class="nc" id="L1884">                boolean gotWidth = false;</span>
<span class="nc" id="L1885">                boolean gotHeight = false;</span>
<span class="nc" id="L1886">                boolean gotAspectRatio = false;</span>

<span class="nc" id="L1888">                float width = -1.0F;</span>
<span class="nc" id="L1889">                float height = -1.0F;</span>
<span class="nc" id="L1890">                float aspectRatio = -1.0F;</span>

<span class="nc" id="L1892">                Node child = node.getFirstChild();</span>
<span class="nc bnc" id="L1893" title="All 2 branches missed.">                while (child != null) {</span>
<span class="nc" id="L1894">                    String childName = child.getNodeName();</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">                    if (childName.equals(&quot;PixelAspectRatio&quot;)) {</span>
<span class="nc" id="L1896">                        aspectRatio = getFloatAttribute(child, &quot;value&quot;);</span>
<span class="nc" id="L1897">                        gotAspectRatio = true;</span>
<span class="nc bnc" id="L1898" title="All 2 branches missed.">                    } else if (childName.equals(&quot;HorizontalPixelSize&quot;)) {</span>
<span class="nc" id="L1899">                        width = getFloatAttribute(child, &quot;value&quot;);</span>
<span class="nc" id="L1900">                        gotWidth = true;</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">                    } else if (childName.equals(&quot;VerticalPixelSize&quot;)) {</span>
<span class="nc" id="L1902">                        height = getFloatAttribute(child, &quot;value&quot;);</span>
<span class="nc" id="L1903">                        gotHeight = true;</span>
//                  } else if (childName.equals(&quot;ImageOrientation&quot;)) {
//                  } else if
//                      (childName.equals(&quot;HorizontalPhysicalPixelSpacing&quot;)) {
//                  } else if
//                      (childName.equals(&quot;VerticalPhysicalPixelSpacing&quot;)) {
//                  } else if (childName.equals(&quot;HorizontalPosition&quot;)) {
//                  } else if (childName.equals(&quot;VerticalPosition&quot;)) {
//                  } else if (childName.equals(&quot;HorizontalPixelOffset&quot;)) {
//                  } else if (childName.equals(&quot;VerticalPixelOffset&quot;)) {
                    }
<span class="nc" id="L1914">                    child = child.getNextSibling();</span>
<span class="nc" id="L1915">                }</span>

<span class="nc bnc" id="L1917" title="All 4 branches missed.">                if (gotWidth &amp;&amp; gotHeight) {</span>
<span class="nc" id="L1918">                    pHYs_present = true;</span>
<span class="nc" id="L1919">                    pHYs_unitSpecifier = 1;</span>
<span class="nc" id="L1920">                    pHYs_pixelsPerUnitXAxis = (int)(width*1000 + 0.5F);</span>
<span class="nc" id="L1921">                    pHYs_pixelsPerUnitYAxis = (int)(height*1000 + 0.5F);</span>
<span class="nc bnc" id="L1922" title="All 2 branches missed.">                } else if (gotAspectRatio) {</span>
<span class="nc" id="L1923">                    pHYs_present = true;</span>
<span class="nc" id="L1924">                    pHYs_unitSpecifier = 0;</span>

                    // Find a reasonable rational approximation
<span class="nc" id="L1927">                    int denom = 1;</span>
<span class="nc bnc" id="L1928" title="All 2 branches missed.">                    for (; denom &lt; 100; denom++) {</span>
<span class="nc" id="L1929">                        int num = (int)(aspectRatio*denom);</span>
<span class="nc bnc" id="L1930" title="All 2 branches missed.">                        if (Math.abs(num/denom - aspectRatio) &lt; 0.001) {</span>
<span class="nc" id="L1931">                            break;</span>
                        }
                    }
<span class="nc" id="L1934">                    pHYs_pixelsPerUnitXAxis = (int)(aspectRatio*denom);</span>
<span class="nc" id="L1935">                    pHYs_pixelsPerUnitYAxis = denom;</span>
                }
<span class="nc bnc" id="L1937" title="All 2 branches missed.">            } else if (name.equals(&quot;Document&quot;)) {</span>
<span class="nc" id="L1938">                Node child = node.getFirstChild();</span>
<span class="nc bnc" id="L1939" title="All 2 branches missed.">                while (child != null) {</span>
<span class="nc" id="L1940">                    String childName = child.getNodeName();</span>
<span class="nc bnc" id="L1941" title="All 2 branches missed.">                    if (childName.equals(&quot;ImageModificationTime&quot;)) {</span>
<span class="nc" id="L1942">                        tIME_present = true;</span>
<span class="nc" id="L1943">                        tIME_year = getIntAttribute(child, &quot;year&quot;);</span>
<span class="nc" id="L1944">                        tIME_month = getIntAttribute(child, &quot;month&quot;);</span>
<span class="nc" id="L1945">                        tIME_day = getIntAttribute(child, &quot;day&quot;);</span>
<span class="nc" id="L1946">                        tIME_hour =</span>
<span class="nc" id="L1947">                            getIntAttribute(child, &quot;hour&quot;, 0, false);</span>
<span class="nc" id="L1948">                        tIME_minute =</span>
<span class="nc" id="L1949">                            getIntAttribute(child, &quot;minute&quot;, 0, false);</span>
<span class="nc" id="L1950">                        tIME_second =</span>
<span class="nc" id="L1951">                            getIntAttribute(child, &quot;second&quot;, 0, false);</span>
//                  } else if (childName.equals(&quot;SubimageInterpretation&quot;)) {
//                  } else if (childName.equals(&quot;ImageCreationTime&quot;)) {
                    }
<span class="nc" id="L1955">                    child = child.getNextSibling();</span>
<span class="nc" id="L1956">                }</span>
<span class="nc bnc" id="L1957" title="All 2 branches missed.">            } else if (name.equals(&quot;Text&quot;)) {</span>
<span class="nc" id="L1958">                Node child = node.getFirstChild();</span>
<span class="nc bnc" id="L1959" title="All 2 branches missed.">                while (child != null) {</span>
<span class="nc" id="L1960">                    String childName = child.getNodeName();</span>
<span class="nc bnc" id="L1961" title="All 2 branches missed.">                    if (childName.equals(&quot;TextEntry&quot;)) {</span>
<span class="nc" id="L1962">                        String keyword =</span>
<span class="nc" id="L1963">                            getAttribute(child, &quot;keyword&quot;, &quot;&quot;, false);</span>
<span class="nc" id="L1964">                        String value = getAttribute(child, &quot;value&quot;);</span>
<span class="nc" id="L1965">                        String language =</span>
<span class="nc" id="L1966">                            getAttribute(child, &quot;language&quot;, &quot;&quot;, false);</span>
<span class="nc" id="L1967">                        String compression =</span>
<span class="nc" id="L1968">                            getAttribute(child, &quot;compression&quot;, &quot;none&quot;, false);</span>

<span class="nc bnc" id="L1970" title="All 2 branches missed.">                        if (!isValidKeyword(keyword)) {</span>
                            // Just ignore this node, PNG requires keywords
<span class="nc bnc" id="L1972" title="All 2 branches missed.">                        } else if (isISOLatin(value, true)) {</span>
<span class="nc bnc" id="L1973" title="All 2 branches missed.">                            if (compression.equals(&quot;zip&quot;)) {</span>
                                // Use a zTXt node
<span class="nc" id="L1975">                                zTXt_keyword.add(keyword);</span>
<span class="nc" id="L1976">                                zTXt_text.add(value);</span>
<span class="nc" id="L1977">                                zTXt_compressionMethod.add(Integer.valueOf(0));</span>
                            } else {
                                // Use a tEXt node
<span class="nc" id="L1980">                                tEXt_keyword.add(keyword);</span>
<span class="nc" id="L1981">                                tEXt_text.add(value);</span>
                            }
                        } else {
                            // Use an iTXt node
<span class="nc" id="L1985">                            iTXt_keyword.add(keyword);</span>
<span class="nc" id="L1986">                            iTXt_compressionFlag.add(Boolean.valueOf(compression.equals(&quot;zip&quot;)));</span>
<span class="nc" id="L1987">                            iTXt_compressionMethod.add(Integer.valueOf(0));</span>
<span class="nc" id="L1988">                            iTXt_languageTag.add(language);</span>
<span class="nc" id="L1989">                            iTXt_translatedKeyword.add(keyword); // fake it</span>
<span class="nc" id="L1990">                            iTXt_text.add(value);</span>
                        }
                    }
<span class="nc" id="L1993">                    child = child.getNextSibling();</span>
<span class="nc" id="L1994">                }</span>
//          } else if (name.equals(&quot;Transparency&quot;)) {
//              Node child = node.getFirstChild();
//              while (child != null) {
//                  String childName = child.getNodeName();
//                  if (childName.equals(&quot;Alpha&quot;)) {
//                  } else if (childName.equals(&quot;TransparentIndex&quot;)) {
//                  } else if (childName.equals(&quot;TransparentColor&quot;)) {
//                  } else if (childName.equals(&quot;TileTransparencies&quot;)) {
//                  } else if (childName.equals(&quot;TileOpacities&quot;)) {
//                  }
//                  child = child.getNextSibling();
//              }
//          } else {
//              // fatal(node, &quot;Unknown child of root node!&quot;);
            }

<span class="nc" id="L2011">            node = node.getNextSibling();</span>
<span class="nc" id="L2012">        }</span>
<span class="nc" id="L2013">    }</span>

    // Reset all instance variables to their initial state
    public void reset() {
<span class="nc" id="L2017">        IHDR_present = false;</span>
<span class="nc" id="L2018">        PLTE_present = false;</span>
<span class="nc" id="L2019">        bKGD_present = false;</span>
<span class="nc" id="L2020">        cHRM_present = false;</span>
<span class="nc" id="L2021">        gAMA_present = false;</span>
<span class="nc" id="L2022">        hIST_present = false;</span>
<span class="nc" id="L2023">        iCCP_present = false;</span>
<span class="nc" id="L2024">        iTXt_keyword = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2025">        iTXt_compressionFlag = new ArrayList&lt;Boolean&gt;();</span>
<span class="nc" id="L2026">        iTXt_compressionMethod = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L2027">        iTXt_languageTag = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2028">        iTXt_translatedKeyword = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2029">        iTXt_text = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2030">        pHYs_present = false;</span>
<span class="nc" id="L2031">        sBIT_present = false;</span>
<span class="nc" id="L2032">        sPLT_present = false;</span>
<span class="nc" id="L2033">        sRGB_present = false;</span>
<span class="nc" id="L2034">        tEXt_keyword = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2035">        tEXt_text = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2036">        tIME_present = false;</span>
<span class="nc" id="L2037">        tRNS_present = false;</span>
<span class="nc" id="L2038">        zTXt_keyword = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2039">        zTXt_compressionMethod = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L2040">        zTXt_text = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2041">        unknownChunkType = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2042">        unknownChunkData = new ArrayList&lt;byte[]&gt;();</span>
<span class="nc" id="L2043">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>