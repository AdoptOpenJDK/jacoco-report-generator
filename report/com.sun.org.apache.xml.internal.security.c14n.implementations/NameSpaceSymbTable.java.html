<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>NameSpaceSymbTable.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.org.apache.xml.internal.security.c14n.implementations</a> &gt; <span class="el_source">NameSpaceSymbTable.java</span></div><h1>NameSpaceSymbTable.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package com.sun.org.apache.xml.internal.security.c14n.implementations;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Iterator;
import java.util.List;


import org.w3c.dom.Attr;
import org.w3c.dom.Node;

/**
 * A stack based Symbol Table.
 *&lt;br&gt;For speed reasons all the symbols are introduced in the same map,
 * and at the same time in a list so it can be removed when the frame is pop back.
 * @author Raul Benito
 */
public class NameSpaceSymbTable {

    private static final String XMLNS = &quot;xmlns&quot;;
<span class="nc" id="L43">    private static final SymbMap initialMap = new SymbMap();</span>

    static {
<span class="nc" id="L46">        NameSpaceSymbEntry ne = new NameSpaceSymbEntry(&quot;&quot;, null, true, XMLNS);</span>
<span class="nc" id="L47">        ne.lastrendered = &quot;&quot;;</span>
<span class="nc" id="L48">        initialMap.put(XMLNS, ne);</span>
<span class="nc" id="L49">    }</span>

    /**The map betwen prefix-&gt; entry table. */
    private SymbMap symb;

    /**The stacks for removing the definitions when doing pop.*/
    private List&lt;SymbMap&gt; level;
<span class="nc" id="L56">    private boolean cloned = true;</span>

    /**
     * Default constractor
     **/
<span class="nc" id="L61">    public NameSpaceSymbTable() {</span>
<span class="nc" id="L62">        level = new ArrayList&lt;SymbMap&gt;();</span>
        //Insert the default binding for xmlns.
<span class="nc" id="L64">        symb = (SymbMap) initialMap.clone();</span>
<span class="nc" id="L65">    }</span>

    /**
     * Get all the unrendered nodes in the name space.
     * For Inclusive rendering
     * @param result the list where to fill the unrendered xmlns definitions.
     **/
    public void getUnrenderedNodes(Collection&lt;Attr&gt; result) {
<span class="nc" id="L73">        Iterator&lt;NameSpaceSymbEntry&gt; it = symb.entrySet().iterator();</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        while (it.hasNext()) {</span>
<span class="nc" id="L75">            NameSpaceSymbEntry n = it.next();</span>
            //put them rendered?
<span class="nc bnc" id="L77" title="All 4 branches missed.">            if ((!n.rendered) &amp;&amp; (n.n != null)) {</span>
<span class="nc" id="L78">                n = (NameSpaceSymbEntry) n.clone();</span>
<span class="nc" id="L79">                needsClone();</span>
<span class="nc" id="L80">                symb.put(n.prefix, n);</span>
<span class="nc" id="L81">                n.lastrendered = n.uri;</span>
<span class="nc" id="L82">                n.rendered = true;</span>

<span class="nc" id="L84">                result.add(n.n);</span>
            }
<span class="nc" id="L86">        }</span>
<span class="nc" id="L87">    }</span>

    /**
     * Push a frame for visible namespace.
     * For Inclusive rendering.
     **/
    public void outputNodePush() {
<span class="nc" id="L94">        push();</span>
<span class="nc" id="L95">    }</span>

    /**
     * Pop a frame for visible namespace.
     **/
    public void outputNodePop() {
<span class="nc" id="L101">        pop();</span>
<span class="nc" id="L102">    }</span>

    /**
     * Push a frame for a node.
     * Inclusive or Exclusive.
     **/
    public void push() {
        //Put the number of namespace definitions in the stack.
<span class="nc" id="L110">        level.add(null);</span>
<span class="nc" id="L111">        cloned = false;</span>
<span class="nc" id="L112">    }</span>

    /**
     * Pop a frame.
     * Inclusive or Exclusive.
     **/
    public void pop() {
<span class="nc" id="L119">        int size = level.size() - 1;</span>
<span class="nc" id="L120">        Object ob = level.remove(size);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (ob != null) {</span>
<span class="nc" id="L122">            symb = (SymbMap)ob;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            if (size == 0) {</span>
<span class="nc" id="L124">                cloned = false;</span>
            } else {
<span class="nc bnc" id="L126" title="All 2 branches missed.">                cloned = (level.get(size - 1) != symb);</span>
            }
        } else {
<span class="nc" id="L129">            cloned = false;</span>
        }
<span class="nc" id="L131">    }</span>

    final void needsClone() {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!cloned) {</span>
<span class="nc" id="L135">            level.set(level.size() - 1, symb);</span>
<span class="nc" id="L136">            symb = (SymbMap) symb.clone();</span>
<span class="nc" id="L137">            cloned = true;</span>
        }
<span class="nc" id="L139">    }</span>


    /**
     * Gets the attribute node that defines the binding for the prefix.
     * @param prefix the prefix to obtain the attribute.
     * @return null if there is no need to render the prefix. Otherwise the node of
     * definition.
     **/
    public Attr getMapping(String prefix) {
<span class="nc" id="L149">        NameSpaceSymbEntry entry = symb.get(prefix);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (entry == null) {</span>
            //There is no definition for the prefix(a bug?).
<span class="nc" id="L152">            return null;</span>
        }
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (entry.rendered) {</span>
            //No need to render an entry already rendered.
<span class="nc" id="L156">            return null;</span>
        }
        // Mark this entry as render.
<span class="nc" id="L159">        entry = (NameSpaceSymbEntry) entry.clone();</span>
<span class="nc" id="L160">        needsClone();</span>
<span class="nc" id="L161">        symb.put(prefix, entry);</span>
<span class="nc" id="L162">        entry.rendered = true;</span>
<span class="nc" id="L163">        entry.lastrendered = entry.uri;</span>
        // Return the node for outputing.
<span class="nc" id="L165">        return entry.n;</span>
    }

    /**
     * Gets a definition without mark it as render.
     * For render in exclusive c14n the namespaces in the include prefixes.
     * @param prefix The prefix whose definition is neaded.
     * @return the attr to render, null if there is no need to render
     **/
    public Attr getMappingWithoutRendered(String prefix) {
<span class="nc" id="L175">        NameSpaceSymbEntry entry = symb.get(prefix);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (entry == null) {</span>
<span class="nc" id="L177">            return null;</span>
        }
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (entry.rendered) {</span>
<span class="nc" id="L180">            return null;</span>
        }
<span class="nc" id="L182">        return entry.n;</span>
    }

    /**
     * Adds the mapping for a prefix.
     * @param prefix the prefix of definition
     * @param uri the Uri of the definition
     * @param n the attribute that have the definition
     * @return true if there is already defined.
     **/
    public boolean addMapping(String prefix, String uri, Attr n) {
<span class="nc" id="L193">        NameSpaceSymbEntry ob = symb.get(prefix);</span>
<span class="nc bnc" id="L194" title="All 4 branches missed.">        if ((ob != null) &amp;&amp; uri.equals(ob.uri)) {</span>
            //If we have it previously defined. Don't keep working.
<span class="nc" id="L196">            return false;</span>
        }
        //Creates and entry in the table for this new definition.
<span class="nc" id="L199">        NameSpaceSymbEntry ne = new NameSpaceSymbEntry(uri, n, false, prefix);</span>
<span class="nc" id="L200">        needsClone();</span>
<span class="nc" id="L201">        symb.put(prefix, ne);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (ob != null) {</span>
            //We have a previous definition store it for the pop.
            //Check if a previous definition(not the inmidiatly one) has been rendered.
<span class="nc" id="L205">            ne.lastrendered = ob.lastrendered;</span>
<span class="nc bnc" id="L206" title="All 4 branches missed.">            if ((ob.lastrendered != null) &amp;&amp; (ob.lastrendered.equals(uri))) {</span>
                //Yes it is. Mark as rendered.
<span class="nc" id="L208">                ne.rendered = true;</span>
            }
        }
<span class="nc" id="L211">        return true;</span>
    }

    /**
     * Adds a definition and mark it as render.
     * For inclusive c14n.
     * @param prefix the prefix of definition
     * @param uri the Uri of the definition
     * @param n the attribute that have the definition
     * @return the attr to render, null if there is no need to render
     **/
    public Node addMappingAndRender(String prefix, String uri, Attr n) {
<span class="nc" id="L223">        NameSpaceSymbEntry ob = symb.get(prefix);</span>

<span class="nc bnc" id="L225" title="All 4 branches missed.">        if ((ob != null) &amp;&amp; uri.equals(ob.uri)) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            if (!ob.rendered) {</span>
<span class="nc" id="L227">                ob = (NameSpaceSymbEntry) ob.clone();</span>
<span class="nc" id="L228">                needsClone();</span>
<span class="nc" id="L229">                symb.put(prefix, ob);</span>
<span class="nc" id="L230">                ob.lastrendered = uri;</span>
<span class="nc" id="L231">                ob.rendered = true;</span>
<span class="nc" id="L232">                return ob.n;</span>
            }
<span class="nc" id="L234">            return null;</span>
        }

<span class="nc" id="L237">        NameSpaceSymbEntry ne = new NameSpaceSymbEntry(uri,n,true,prefix);</span>
<span class="nc" id="L238">        ne.lastrendered = uri;</span>
<span class="nc" id="L239">        needsClone();</span>
<span class="nc" id="L240">        symb.put(prefix, ne);</span>
<span class="nc bnc" id="L241" title="All 6 branches missed.">        if ((ob != null) &amp;&amp; (ob.lastrendered != null) &amp;&amp; (ob.lastrendered.equals(uri))) {</span>
<span class="nc" id="L242">            ne.rendered = true;</span>
<span class="nc" id="L243">            return null;</span>
        }
<span class="nc" id="L245">        return ne.n;</span>
    }

    public int getLevel() {
<span class="nc" id="L249">        return level.size();</span>
    }

    public void removeMapping(String prefix) {
<span class="nc" id="L253">        NameSpaceSymbEntry ob = symb.get(prefix);</span>

<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (ob != null) {</span>
<span class="nc" id="L256">            needsClone();</span>
<span class="nc" id="L257">            symb.put(prefix, null);</span>
        }
<span class="nc" id="L259">    }</span>

    public void removeMappingIfNotRender(String prefix) {
<span class="nc" id="L262">        NameSpaceSymbEntry ob = symb.get(prefix);</span>

<span class="nc bnc" id="L264" title="All 4 branches missed.">        if (ob != null &amp;&amp; !ob.rendered) {</span>
<span class="nc" id="L265">            needsClone();</span>
<span class="nc" id="L266">            symb.put(prefix, null);</span>
        }
<span class="nc" id="L268">    }</span>

    public boolean removeMappingIfRender(String prefix) {
<span class="nc" id="L271">        NameSpaceSymbEntry ob = symb.get(prefix);</span>

<span class="nc bnc" id="L273" title="All 4 branches missed.">        if (ob != null &amp;&amp; ob.rendered) {</span>
<span class="nc" id="L274">            needsClone();</span>
<span class="nc" id="L275">            symb.put(prefix, null);</span>
        }
<span class="nc" id="L277">        return false;</span>
    }
}

/**
 * The internal structure of NameSpaceSymbTable.
 **/
class NameSpaceSymbEntry implements Cloneable {

    String prefix;

    /**The URI that the prefix defines */
    String uri;

    /**The last output in the URI for this prefix (This for speed reason).*/
<span class="nc" id="L292">    String lastrendered = null;</span>

    /**This prefix-URI has been already render or not.*/
<span class="nc" id="L295">    boolean rendered = false;</span>

    /**The attribute to include.*/
    Attr n;

<span class="nc" id="L300">    NameSpaceSymbEntry(String name, Attr n, boolean rendered, String prefix) {</span>
<span class="nc" id="L301">        this.uri = name;</span>
<span class="nc" id="L302">        this.rendered = rendered;</span>
<span class="nc" id="L303">        this.n = n;</span>
<span class="nc" id="L304">        this.prefix = prefix;</span>
<span class="nc" id="L305">    }</span>

    /** @inheritDoc */
    public Object clone() {
        try {
<span class="nc" id="L310">            return super.clone();</span>
<span class="nc" id="L311">        } catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L312">            return null;</span>
        }
    }
};

class SymbMap implements Cloneable {
<span class="nc" id="L318">    int free = 23;</span>
    NameSpaceSymbEntry[] entries;
    String[] keys;

<span class="nc" id="L322">    SymbMap() {</span>
<span class="nc" id="L323">        entries = new NameSpaceSymbEntry[free];</span>
<span class="nc" id="L324">        keys = new String[free];</span>
<span class="nc" id="L325">    }</span>

    void put(String key, NameSpaceSymbEntry value) {
<span class="nc" id="L328">        int index = index(key);</span>
<span class="nc" id="L329">        Object oldKey = keys[index];</span>
<span class="nc" id="L330">        keys[index] = key;</span>
<span class="nc" id="L331">        entries[index] = value;</span>
<span class="nc bnc" id="L332" title="All 6 branches missed.">        if ((oldKey == null || !oldKey.equals(key)) &amp;&amp; (--free == 0)) {</span>
<span class="nc" id="L333">            free = entries.length;</span>
<span class="nc" id="L334">            int newCapacity = free &lt;&lt; 2;</span>
<span class="nc" id="L335">            rehash(newCapacity);</span>
        }
<span class="nc" id="L337">    }</span>

    List&lt;NameSpaceSymbEntry&gt; entrySet() {
<span class="nc" id="L340">        List&lt;NameSpaceSymbEntry&gt; a = new ArrayList&lt;NameSpaceSymbEntry&gt;();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        for (int i = 0;i &lt; entries.length;i++) {</span>
<span class="nc bnc" id="L342" title="All 4 branches missed.">            if ((entries[i] != null) &amp;&amp; !(&quot;&quot;.equals(entries[i].uri))) {</span>
<span class="nc" id="L343">                a.add(entries[i]);</span>
            }
        }
<span class="nc" id="L346">        return a;</span>
    }

    protected int index(Object obj) {
<span class="nc" id="L350">        Object[] set = keys;</span>
<span class="nc" id="L351">        int length = set.length;</span>
        //abs of index
<span class="nc" id="L353">        int index = (obj.hashCode() &amp; 0x7fffffff) % length;</span>
<span class="nc" id="L354">        Object cur = set[index];</span>

<span class="nc bnc" id="L356" title="All 4 branches missed.">        if (cur == null || (cur.equals(obj))) {</span>
<span class="nc" id="L357">            return index;</span>
        }
<span class="nc" id="L359">        length--;</span>
        do {
<span class="nc bnc" id="L361" title="All 2 branches missed.">            index = index == length ? 0 : ++index;</span>
<span class="nc" id="L362">            cur = set[index];</span>
<span class="nc bnc" id="L363" title="All 4 branches missed.">        } while (cur != null &amp;&amp; (!cur.equals(obj)));</span>
<span class="nc" id="L364">        return index;</span>
    }

    /**
     * rehashes the map to the new capacity.
     *
     * @param newCapacity an &lt;code&gt;int&lt;/code&gt; value
     */
    protected void rehash(int newCapacity) {
<span class="nc" id="L373">        int oldCapacity = keys.length;</span>
<span class="nc" id="L374">        String oldKeys[] = keys;</span>
<span class="nc" id="L375">        NameSpaceSymbEntry oldVals[] = entries;</span>

<span class="nc" id="L377">        keys = new String[newCapacity];</span>
<span class="nc" id="L378">        entries = new NameSpaceSymbEntry[newCapacity];</span>

<span class="nc bnc" id="L380" title="All 2 branches missed.">        for (int i = oldCapacity; i-- &gt; 0;) {</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            if (oldKeys[i] != null) {</span>
<span class="nc" id="L382">                String o = oldKeys[i];</span>
<span class="nc" id="L383">                int index = index(o);</span>
<span class="nc" id="L384">                keys[index] = o;</span>
<span class="nc" id="L385">                entries[index] = oldVals[i];</span>
<span class="nc" id="L386">            }</span>
        }
<span class="nc" id="L388">    }</span>

    NameSpaceSymbEntry get(String key) {
<span class="nc" id="L391">        return entries[index(key)];</span>
    }

    protected Object clone()  {
        try {
<span class="nc" id="L396">            SymbMap copy = (SymbMap) super.clone();</span>
<span class="nc" id="L397">            copy.entries = new NameSpaceSymbEntry[entries.length];</span>
<span class="nc" id="L398">            System.arraycopy(entries, 0, copy.entries, 0, entries.length);</span>
<span class="nc" id="L399">            copy.keys = new String[keys.length];</span>
<span class="nc" id="L400">            System.arraycopy(keys, 0, copy.keys, 0, keys.length);</span>

<span class="nc" id="L402">            return copy;</span>
<span class="nc" id="L403">        } catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L404">            e.printStackTrace();</span>
        }
<span class="nc" id="L406">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>