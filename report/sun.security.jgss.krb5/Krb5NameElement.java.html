<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>Krb5NameElement.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.jgss.krb5</a> &gt; <span class="el_source">Krb5NameElement.java</span></div><h1>Krb5NameElement.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.jgss.krb5;

import org.ietf.jgss.*;
import sun.security.jgss.spi.*;
import sun.security.krb5.PrincipalName;
import sun.security.krb5.KrbException;
import java.io.UnsupportedEncodingException;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.security.Provider;
import java.util.Locale;

/**
 * Implements the GSSNameSpi for the krb5 mechanism.
 *
 * @author Mayank Upadhyay
 */
public class Krb5NameElement
    implements GSSNameSpi {

    private PrincipalName krb5PrincipalName;

<span class="fc" id="L48">    private String gssNameStr = null;</span>
<span class="fc" id="L49">    private Oid gssNameType = null;</span>

    // XXX Move this concept into PrincipalName's asn1Encode() sometime
<span class="fc" id="L52">    private static String CHAR_ENCODING = &quot;UTF-8&quot;;</span>

    private Krb5NameElement(PrincipalName principalName,
                            String gssNameStr,
<span class="fc" id="L56">                            Oid gssNameType) {</span>
<span class="fc" id="L57">        this.krb5PrincipalName = principalName;</span>
<span class="fc" id="L58">        this.gssNameStr = gssNameStr;</span>
<span class="fc" id="L59">        this.gssNameType = gssNameType;</span>
<span class="fc" id="L60">    }</span>

    /**
     * Instantiates a new Krb5NameElement object. Internally it stores the
     * information provided by the input parameters so that they may later
     * be used for output when a printable representaion of this name is
     * needed in GSS-API format rather than in Kerberos format.
     *
     */
    static Krb5NameElement getInstance(String gssNameStr, Oid gssNameType)
        throws GSSException {

        /*
         * A null gssNameType implies that the mechanism default
         * Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL be used.
         */
<span class="fc bfc" id="L76" title="All 2 branches covered.">        if (gssNameType == null)</span>
<span class="fc" id="L77">            gssNameType = Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL;</span>
        else
<span class="fc bfc" id="L79" title="All 2 branches covered.">            if (!gssNameType.equals(GSSName.NT_USER_NAME) &amp;&amp;</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">                !gssNameType.equals(GSSName.NT_HOSTBASED_SERVICE) &amp;&amp;</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">                !gssNameType.equals(Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL) &amp;&amp;</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                !gssNameType.equals(GSSName.NT_EXPORT_NAME))</span>
<span class="nc" id="L83">                throw new GSSException(GSSException.BAD_NAMETYPE, -1,</span>
<span class="nc" id="L84">                                       gssNameType.toString()</span>
                                       +&quot; is an unsupported nametype&quot;);

        PrincipalName principalName;
        try {

<span class="pc bpc" id="L90" title="1 of 2 branches missed.">            if (gssNameType.equals(GSSName.NT_EXPORT_NAME) ||</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">                gssNameType.equals(Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL)) {</span>
<span class="fc" id="L92">                principalName = new PrincipalName(gssNameStr,</span>
                                  PrincipalName.KRB_NT_PRINCIPAL);
            } else {

<span class="fc" id="L96">                String[] components = getComponents(gssNameStr);</span>

                /*
                 * We have forms of GSS name strings that can come in:
                 *
                 * 1. names of the form &quot;foo&quot; with just one
                 * component. (This might include a &quot;@&quot; but only in escaped
                 * form like &quot;\@&quot;)
                 * 2. names of the form &quot;foo@bar&quot; with two components
                 *
                 * The nametypes that are accepted are NT_USER_NAME, and
                 * NT_HOSTBASED_SERVICE.
                 */

<span class="fc bfc" id="L110" title="All 2 branches covered.">                if (gssNameType.equals(GSSName.NT_USER_NAME))</span>
<span class="fc" id="L111">                    principalName = new PrincipalName(gssNameStr,</span>
                                    PrincipalName.KRB_NT_PRINCIPAL);
                else {
<span class="fc" id="L114">                    String hostName = null;</span>
<span class="fc" id="L115">                    String service = components[0];</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">                    if (components.length &gt;= 2)</span>
<span class="fc" id="L117">                        hostName = components[1];</span>

<span class="fc" id="L119">                    String principal = getHostBasedInstance(service, hostName);</span>
<span class="fc" id="L120">                    principalName = new PrincipalName(principal,</span>
                            PrincipalName.KRB_NT_SRV_HST);
                }
            }

<span class="fc" id="L125">        } catch (KrbException e) {</span>
<span class="fc" id="L126">            throw new GSSException(GSSException.BAD_NAME, -1, e.getMessage());</span>
<span class="fc" id="L127">        }</span>

<span class="fc" id="L129">        return new Krb5NameElement(principalName, gssNameStr, gssNameType);</span>
    }

    static Krb5NameElement getInstance(PrincipalName principalName) {
<span class="fc" id="L133">        return new Krb5NameElement(principalName,</span>
<span class="fc" id="L134">                                   principalName.getName(),</span>
                                   Krb5MechFactory.NT_GSS_KRB5_PRINCIPAL);
    }

    private static String[] getComponents(String gssNameStr)
        throws GSSException {

        String[] retVal;

        // XXX Perhaps provide this parsing code in PrincipalName

        // Look for @ as in service@host
        // Assumes host name will not have an escaped '@'
<span class="fc" id="L147">        int separatorPos = gssNameStr.lastIndexOf('@', gssNameStr.length());</span>

        // Not really a separator if it is escaped. Then this is just part
        // of the principal name or service name
<span class="fc bfc" id="L151" title="All 2 branches covered.">        if ((separatorPos &gt; 0) &amp;&amp;</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">                (gssNameStr.charAt(separatorPos-1) == '\\')) {</span>
            // Is the `\` character escaped itself?
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if ((separatorPos - 2 &lt; 0) ||</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                (gssNameStr.charAt(separatorPos-2) != '\\'))</span>
<span class="nc" id="L156">                separatorPos = -1;</span>
        }

<span class="fc bfc" id="L159" title="All 2 branches covered.">        if (separatorPos &gt; 0) {</span>
<span class="fc" id="L160">            String serviceName = gssNameStr.substring(0, separatorPos);</span>
<span class="fc" id="L161">            String hostName = gssNameStr.substring(separatorPos+1);</span>
<span class="fc" id="L162">            retVal = new String[] { serviceName, hostName};</span>
<span class="fc" id="L163">        } else {</span>
<span class="fc" id="L164">            retVal = new String[] {gssNameStr};</span>
        }

<span class="fc" id="L167">        return retVal;</span>

    }

    private static String getHostBasedInstance(String serviceName,
                                               String hostName)
        throws GSSException {
<span class="fc" id="L174">            StringBuffer temp = new StringBuffer(serviceName);</span>

            try {
                // A lack of &quot;@&quot; defaults to the service being on the local
                // host as per RFC 2743
                // XXX Move this part into JGSS framework
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">                if (hostName == null)</span>
<span class="nc" id="L181">                    hostName = InetAddress.getLocalHost().getHostName();</span>

<span class="nc" id="L183">            } catch (UnknownHostException e) {</span>
                // use hostname as it is
<span class="fc" id="L185">            }</span>
<span class="fc" id="L186">            hostName = hostName.toLowerCase(Locale.ENGLISH);</span>

<span class="fc" id="L188">            temp = temp.append('/').append(hostName);</span>
<span class="fc" id="L189">            return temp.toString();</span>
    }

    public final PrincipalName getKrb5PrincipalName() {
<span class="fc" id="L193">        return krb5PrincipalName;</span>
    }

    /**
     * Equal method for the GSSNameSpi objects.
     * If either name denotes an anonymous principal, the call should
     * return false.
     *
     * @param name to be compared with
     * @returns true if they both refer to the same entity, else false
     * @exception GSSException with major codes of BAD_NAMETYPE,
     *  BAD_NAME, FAILURE
     */
    public boolean equals(GSSNameSpi other) throws GSSException {

<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (other == this)</span>
<span class="nc" id="L209">            return true;</span>

<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (other instanceof Krb5NameElement) {</span>
<span class="fc" id="L212">                Krb5NameElement that = (Krb5NameElement) other;</span>
<span class="fc" id="L213">                return (this.krb5PrincipalName.getName().equals(</span>
<span class="fc" id="L214">                            that.krb5PrincipalName.getName()));</span>
        }
<span class="nc" id="L216">        return false;</span>
    }

    /**
     * Compares this &lt;code&gt;GSSNameSpi&lt;/code&gt; object to another Object
     * that might be a &lt;code&gt;GSSNameSpi&lt;/code&gt;. The behaviour is exactly
     * the same as in {@link #equals(GSSNameSpi) equals} except that
     * no GSSException is thrown; instead, false will be returned in the
     * situation where an error occurs.
     *
     * @param another the object to be compared to
     * @returns true if they both refer to the same entity, else false
     * @see #equals(GSSNameSpi)
     */
    public boolean equals(Object another) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (this == another) {</span>
<span class="nc" id="L232">            return true;</span>
        }

        try {
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (another instanceof Krb5NameElement)</span>
<span class="nc" id="L237">                 return equals((Krb5NameElement) another);</span>
<span class="nc" id="L238">        } catch (GSSException e) {</span>
            // ignore exception
<span class="nc" id="L240">        }</span>
<span class="nc" id="L241">        return false;</span>
    }

    /**
     * Returns a hashcode value for this GSSNameSpi.
     *
     * @return a hashCode value
     */
    public int hashCode() {
<span class="nc" id="L250">        return 37 * 17 + krb5PrincipalName.getName().hashCode();</span>
    }


    /**
     * Returns the principal name in the form user@REALM or
     * host/service@REALM but with the following constraints that are
     * imposed by RFC 1964:
     * &lt;pre&gt;
     *  (1) all occurrences of the characters `@`,  `/`, and `\` within
     *   principal components or realm names shall be quoted with an
     *   immediately-preceding `\`.
     *
     *   (2) all occurrences of the null, backspace, tab, or newline
     *   characters within principal components or realm names will be
     *   represented, respectively, with `\0`, `\b`, `\t`, or `\n`.
     *
     *   (3) the `\` quoting character shall not be emitted within an
     *   exported name except to accommodate cases (1) and (2).
     * &lt;/pre&gt;
     */
    public byte[] export() throws GSSException {
        // XXX Apply the above constraints.
<span class="nc" id="L273">        byte[] retVal = null;</span>
        try {
<span class="nc" id="L275">            retVal = krb5PrincipalName.getName().getBytes(CHAR_ENCODING);</span>
<span class="nc" id="L276">        } catch (UnsupportedEncodingException e) {</span>
            // Can't happen
<span class="nc" id="L278">        }</span>
<span class="nc" id="L279">        return retVal;</span>
    }

    /**
     * Get the mechanism type that this NameElement corresponds to.
     *
     * @return the Oid of the mechanism type
     */
    public Oid getMechanism() {
<span class="fc" id="L288">        return (Krb5MechFactory.GSS_KRB5_MECH_OID);</span>
    }

    /**
     * Returns a string representation for this name. The printed
     * name type can be obtained by calling getStringNameType().
     *
     * @return string form of this name
     * @see #getStringNameType()
     * @overrides Object#toString
     */
    public String toString() {
<span class="fc" id="L300">        return (gssNameStr);</span>
        // For testing: return (super.toString());
    }

    /**
     * Returns the name type oid.
     */
    public Oid getGSSNameType() {
<span class="nc" id="L308">        return (gssNameType);</span>
    }

    /**
     * Returns the oid describing the format of the printable name.
     *
     * @return the Oid for the format of the printed name
     */
    public Oid getStringNameType() {
        // XXX For NT_EXPORT_NAME return a different name type. Infact,
        // don't even store NT_EXPORT_NAME in the cons.
<span class="fc" id="L319">        return (gssNameType);</span>
    }

    /**
     * Indicates if this name object represents an Anonymous name.
     */
    public boolean isAnonymousName() {
<span class="nc" id="L326">        return (gssNameType.equals(GSSName.NT_ANONYMOUS));</span>
    }

    public Provider getProvider() {
<span class="nc" id="L330">        return Krb5MechFactory.PROVIDER;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>