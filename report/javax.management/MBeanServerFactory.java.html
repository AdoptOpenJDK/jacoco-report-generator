<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>MBeanServerFactory.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.management</a> &gt; <span class="el_source">MBeanServerFactory.java</span></div><h1>MBeanServerFactory.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.management;

import com.sun.jmx.defaults.JmxProperties;
import static com.sun.jmx.defaults.JmxProperties.JMX_INITIAL_BUILDER;
import static com.sun.jmx.defaults.JmxProperties.MBEANSERVER_LOGGER;
import com.sun.jmx.mbeanserver.GetPropertyAction;
import java.security.AccessController;
import java.security.Permission;
import java.util.ArrayList;
import java.util.logging.Level;
import javax.management.loading.ClassLoaderRepository;
import sun.reflect.misc.ReflectUtil;


/**
 * &lt;p&gt;Provides MBean server references.  There are no instances of
 * this class.&lt;/p&gt;
 *
 * &lt;p&gt;Since JMX 1.2 this class makes it possible to replace the default
 * MBeanServer implementation. This is done using the
 * {@link javax.management.MBeanServerBuilder} class.
 * The class of the initial MBeanServerBuilder to be
 * instantiated can be specified through the
 * &lt;b&gt;javax.management.builder.initial&lt;/b&gt; system property.
 * The specified class must be a public subclass of
 * {@link javax.management.MBeanServerBuilder}, and must have a public
 * empty constructor.
 * &lt;p&gt;By default, if no value for that property is specified, an instance of
 * {@link
 * javax.management.MBeanServerBuilder javax.management.MBeanServerBuilder}
 * is created. Otherwise, the MBeanServerFactory attempts to load the
 * specified class using
 * {@link java.lang.Thread#getContextClassLoader()
 *   Thread.currentThread().getContextClassLoader()}, or if that is null,
 * {@link java.lang.Class#forName(java.lang.String) Class.forName()}. Then
 * it creates an initial instance of that Class using
 * {@link java.lang.Class#newInstance()}. If any checked exception
 * is raised during this process (e.g.
 * {@link java.lang.ClassNotFoundException},
 * {@link java.lang.InstantiationException}) the MBeanServerFactory
 * will propagate this exception from within a RuntimeException.&lt;/p&gt;
 *
 * &lt;p&gt;The &lt;b&gt;javax.management.builder.initial&lt;/b&gt; system property is
 * consulted every time a new MBeanServer needs to be created, and the
 * class pointed to by that property is loaded. If that class is different
 * from that of the current MBeanServerBuilder, then a new MBeanServerBuilder
 * is created. Otherwise, the MBeanServerFactory may create a new
 * MBeanServerBuilder or reuse the current one.&lt;/p&gt;
 *
 * &lt;p&gt;If the class pointed to by the property cannot be
 * loaded, or does not correspond to a valid subclass of MBeanServerBuilder
 * then an exception is propagated, and no MBeanServer can be created until
 * the &lt;b&gt;javax.management.builder.initial&lt;/b&gt; system property is reset to
 * valid value.&lt;/p&gt;
 *
 * &lt;p&gt;The MBeanServerBuilder makes it possible to wrap the MBeanServers
 * returned by the default MBeanServerBuilder implementation, for the purpose
 * of e.g. adding an additional security layer.&lt;/p&gt;
 *
 * @since 1.5
 */
public class MBeanServerFactory {

    /*
     * There are no instances of this class so don't generate the
     * default public constructor.
     */
<span class="nc" id="L93">    private MBeanServerFactory() {</span>

<span class="nc" id="L95">    }</span>

    /**
     * The builder that will be used to construct MBeanServers.
     *
     **/
<span class="nc" id="L101">    private static MBeanServerBuilder builder = null;</span>

    /**
     * Provide a new {@link javax.management.MBeanServerBuilder}.
     * @param builder The new MBeanServerBuilder that will be used to
     *        create {@link javax.management.MBeanServer}s.
     * @exception IllegalArgumentException if the given builder is null.
     *
     * @exception SecurityException if there is a SecurityManager and
     * the caller's permissions do not include or imply &lt;code&gt;{@link
     * MBeanServerPermission}(&quot;setMBeanServerBuilder&quot;)&lt;/code&gt;.
     *
     **/
    // public static synchronized void
    //    setMBeanServerBuilder(MBeanServerBuilder builder) {
    //    checkPermission(&quot;setMBeanServerBuilder&quot;);
    //    MBeanServerFactory.builder = builder;
    // }

    /**
     * Get the current {@link javax.management.MBeanServerBuilder}.
     *
     * @return the current {@link javax.management.MBeanServerBuilder}.
     *
     * @exception SecurityException if there is a SecurityManager and
     * the caller's permissions do not include or imply &lt;code&gt;{@link
     * MBeanServerPermission}(&quot;getMBeanServerBuilder&quot;)&lt;/code&gt;.
     *
     **/
    // public static synchronized MBeanServerBuilder getMBeanServerBuilder() {
    //     checkPermission(&quot;getMBeanServerBuilder&quot;);
    //     return builder;
    // }

    /**
     * Remove internal MBeanServerFactory references to a created
     * MBeanServer. This allows the garbage collector to remove the
     * MBeanServer object.
     *
     * @param mbeanServer the MBeanServer object to remove.
     *
     * @exception java.lang.IllegalArgumentException if
     * &lt;code&gt;mbeanServer&lt;/code&gt; was not generated by one of the
     * &lt;code&gt;createMBeanServer&lt;/code&gt; methods, or if
     * &lt;code&gt;releaseMBeanServer&lt;/code&gt; was already called on it.
     *
     * @exception SecurityException if there is a SecurityManager and
     * the caller's permissions do not include or imply &lt;code&gt;{@link
     * MBeanServerPermission}(&quot;releaseMBeanServer&quot;)&lt;/code&gt;.
     */
    public static void releaseMBeanServer(MBeanServer mbeanServer) {
<span class="nc" id="L152">        checkPermission(&quot;releaseMBeanServer&quot;);</span>

<span class="nc" id="L154">        removeMBeanServer(mbeanServer);</span>
<span class="nc" id="L155">    }</span>

    /**
     * &lt;p&gt;Return a new object implementing the MBeanServer interface
     * with a standard default domain name.  The default domain name
     * is used as the domain part in the ObjectName of MBeans when the
     * domain is specified by the user is null.&lt;/p&gt;
     *
     * &lt;p&gt;The standard default domain name is
     * &lt;code&gt;DefaultDomain&lt;/code&gt;.&lt;/p&gt;
     *
     * &lt;p&gt;The MBeanServer reference is internally kept. This will
     * allow &lt;CODE&gt;findMBeanServer&lt;/CODE&gt; to return a reference to
     * this MBeanServer object.&lt;/p&gt;
     *
     * &lt;p&gt;This method is equivalent to &lt;code&gt;createMBeanServer(null)&lt;/code&gt;.
     *
     * @return the newly created MBeanServer.
     *
     * @exception SecurityException if there is a SecurityManager and the
     * caller's permissions do not include or imply &lt;code&gt;{@link
     * MBeanServerPermission}(&quot;createMBeanServer&quot;)&lt;/code&gt;.
     *
     * @exception JMRuntimeException if the property
     * &lt;code&gt;javax.management.builder.initial&lt;/code&gt; exists but the
     * class it names cannot be instantiated through a public
     * no-argument constructor; or if the instantiated builder returns
     * null from its {@link MBeanServerBuilder#newMBeanServerDelegate
     * newMBeanServerDelegate} or {@link
     * MBeanServerBuilder#newMBeanServer newMBeanServer} methods.
     *
     * @exception ClassCastException if the property
     * &lt;code&gt;javax.management.builder.initial&lt;/code&gt; exists and can be
     * instantiated but is not assignment compatible with {@link
     * MBeanServerBuilder}.
     */
    public static MBeanServer createMBeanServer() {
<span class="nc" id="L192">        return createMBeanServer(null);</span>
    }

    /**
     * &lt;p&gt;Return a new object implementing the {@link MBeanServer}
     * interface with the specified default domain name.  The given
     * domain name is used as the domain part in the ObjectName of
     * MBeans when the domain is specified by the user is null.&lt;/p&gt;
     *
     * &lt;p&gt;The MBeanServer reference is internally kept. This will
     * allow &lt;CODE&gt;findMBeanServer&lt;/CODE&gt; to return a reference to
     * this MBeanServer object.&lt;/p&gt;
     *
     * @param domain the default domain name for the created
     * MBeanServer.  This is the value that will be returned by {@link
     * MBeanServer#getDefaultDomain}.
     *
     * @return the newly created MBeanServer.
     *
     * @exception SecurityException if there is a SecurityManager and
     * the caller's permissions do not include or imply &lt;code&gt;{@link
     * MBeanServerPermission}(&quot;createMBeanServer&quot;)&lt;/code&gt;.
     *
     * @exception JMRuntimeException if the property
     * &lt;code&gt;javax.management.builder.initial&lt;/code&gt; exists but the
     * class it names cannot be instantiated through a public
     * no-argument constructor; or if the instantiated builder returns
     * null from its {@link MBeanServerBuilder#newMBeanServerDelegate
     * newMBeanServerDelegate} or {@link
     * MBeanServerBuilder#newMBeanServer newMBeanServer} methods.
     *
     * @exception ClassCastException if the property
     * &lt;code&gt;javax.management.builder.initial&lt;/code&gt; exists and can be
     * instantiated but is not assignment compatible with {@link
     * MBeanServerBuilder}.
     */
    public static MBeanServer createMBeanServer(String domain)  {
<span class="nc" id="L229">        checkPermission(&quot;createMBeanServer&quot;);</span>

<span class="nc" id="L231">        final MBeanServer mBeanServer = newMBeanServer(domain);</span>
<span class="nc" id="L232">        addMBeanServer(mBeanServer);</span>
<span class="nc" id="L233">        return mBeanServer;</span>
    }

    /**
     * &lt;p&gt;Return a new object implementing the MBeanServer interface
     * with a standard default domain name, without keeping an
     * internal reference to this new object.  The default domain name
     * is used as the domain part in the ObjectName of MBeans when the
     * domain is specified by the user is null.&lt;/p&gt;
     *
     * &lt;p&gt;The standard default domain name is
     * &lt;code&gt;DefaultDomain&lt;/code&gt;.&lt;/p&gt;
     *
     * &lt;p&gt;No reference is kept. &lt;CODE&gt;findMBeanServer&lt;/CODE&gt; will not
     * be able to return a reference to this MBeanServer object, but
     * the garbage collector will be able to remove the MBeanServer
     * object when it is no longer referenced.&lt;/p&gt;
     *
     * &lt;p&gt;This method is equivalent to &lt;code&gt;newMBeanServer(null)&lt;/code&gt;.&lt;/p&gt;
     *
     * @return the newly created MBeanServer.
     *
     * @exception SecurityException if there is a SecurityManager and the
     * caller's permissions do not include or imply &lt;code&gt;{@link
     * MBeanServerPermission}(&quot;newMBeanServer&quot;)&lt;/code&gt;.
     *
     * @exception JMRuntimeException if the property
     * &lt;code&gt;javax.management.builder.initial&lt;/code&gt; exists but the
     * class it names cannot be instantiated through a public
     * no-argument constructor; or if the instantiated builder returns
     * null from its {@link MBeanServerBuilder#newMBeanServerDelegate
     * newMBeanServerDelegate} or {@link
     * MBeanServerBuilder#newMBeanServer newMBeanServer} methods.
     *
     * @exception ClassCastException if the property
     * &lt;code&gt;javax.management.builder.initial&lt;/code&gt; exists and can be
     * instantiated but is not assignment compatible with {@link
     * MBeanServerBuilder}.
     */
    public static MBeanServer newMBeanServer() {
<span class="nc" id="L273">        return newMBeanServer(null);</span>
    }

    /**
     * &lt;p&gt;Return a new object implementing the MBeanServer interface
     * with the specified default domain name, without keeping an
     * internal reference to this new object.  The given domain name
     * is used as the domain part in the ObjectName of MBeans when the
     * domain is specified by the user is null.&lt;/p&gt;
     *
     * &lt;p&gt;No reference is kept. &lt;CODE&gt;findMBeanServer&lt;/CODE&gt; will not
     * be able to return a reference to this MBeanServer object, but
     * the garbage collector will be able to remove the MBeanServer
     * object when it is no longer referenced.&lt;/p&gt;
     *
     * @param domain the default domain name for the created
     * MBeanServer.  This is the value that will be returned by {@link
     * MBeanServer#getDefaultDomain}.
     *
     * @return the newly created MBeanServer.
     *
     * @exception SecurityException if there is a SecurityManager and the
     * caller's permissions do not include or imply &lt;code&gt;{@link
     * MBeanServerPermission}(&quot;newMBeanServer&quot;)&lt;/code&gt;.
     *
     * @exception JMRuntimeException if the property
     * &lt;code&gt;javax.management.builder.initial&lt;/code&gt; exists but the
     * class it names cannot be instantiated through a public
     * no-argument constructor; or if the instantiated builder returns
     * null from its {@link MBeanServerBuilder#newMBeanServerDelegate
     * newMBeanServerDelegate} or {@link
     * MBeanServerBuilder#newMBeanServer newMBeanServer} methods.
     *
     * @exception ClassCastException if the property
     * &lt;code&gt;javax.management.builder.initial&lt;/code&gt; exists and can be
     * instantiated but is not assignment compatible with {@link
     * MBeanServerBuilder}.
     */
    public static MBeanServer newMBeanServer(String domain)  {
<span class="nc" id="L312">        checkPermission(&quot;newMBeanServer&quot;);</span>

        // Get the builder. Creates a new one if necessary.
        //
<span class="nc" id="L316">        final MBeanServerBuilder mbsBuilder = getNewMBeanServerBuilder();</span>
        // Returned value cannot be null.  NullPointerException if violated.

<span class="nc" id="L319">        synchronized(mbsBuilder) {</span>
<span class="nc" id="L320">            final MBeanServerDelegate delegate  =</span>
<span class="nc" id="L321">                    mbsBuilder.newMBeanServerDelegate();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            if (delegate == null) {</span>
                final String msg =
                        &quot;MBeanServerBuilder.newMBeanServerDelegate() &quot; +
                        &quot;returned null&quot;;
<span class="nc" id="L326">                throw new JMRuntimeException(msg);</span>
            }
<span class="nc" id="L328">            final MBeanServer mbeanServer =</span>
<span class="nc" id="L329">                    mbsBuilder.newMBeanServer(domain,null,delegate);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if (mbeanServer == null) {</span>
                final String msg =
                        &quot;MBeanServerBuilder.newMBeanServer() returned null&quot;;
<span class="nc" id="L333">                throw new JMRuntimeException(msg);</span>
            }
<span class="nc" id="L335">            return mbeanServer;</span>
<span class="nc" id="L336">        }</span>
    }

    /**
     * &lt;p&gt;Return a list of registered MBeanServer objects.  A
     * registered MBeanServer object is one that was created by one of
     * the &lt;code&gt;createMBeanServer&lt;/code&gt; methods and not subsequently
     * released with &lt;code&gt;releaseMBeanServer&lt;/code&gt;.&lt;/p&gt;
     *
     * @param agentId The agent identifier of the MBeanServer to
     * retrieve.  If this parameter is null, all registered
     * MBeanServers in this JVM are returned.  Otherwise, only
     * MBeanServers whose id is equal to &lt;code&gt;agentId&lt;/code&gt; are
     * returned.  The id of an MBeanServer is the
     * &lt;code&gt;MBeanServerId&lt;/code&gt; attribute of its delegate MBean.
     *
     * @return A list of MBeanServer objects.
     *
     * @exception SecurityException if there is a SecurityManager and the
     * caller's permissions do not include or imply &lt;code&gt;{@link
     * MBeanServerPermission}(&quot;findMBeanServer&quot;)&lt;/code&gt;.
     */
    public synchronized static
            ArrayList&lt;MBeanServer&gt; findMBeanServer(String agentId) {

<span class="nc" id="L361">        checkPermission(&quot;findMBeanServer&quot;);</span>

<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (agentId == null)</span>
<span class="nc" id="L364">            return new ArrayList&lt;MBeanServer&gt;(mBeanServerList);</span>

<span class="nc" id="L366">        ArrayList&lt;MBeanServer&gt; result = new ArrayList&lt;MBeanServer&gt;();</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        for (MBeanServer mbs : mBeanServerList) {</span>
<span class="nc" id="L368">            String name = mBeanServerId(mbs);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">            if (agentId.equals(name))</span>
<span class="nc" id="L370">                result.add(mbs);</span>
<span class="nc" id="L371">        }</span>
<span class="nc" id="L372">        return result;</span>
    }

    /**
     * Return the ClassLoaderRepository used by the given MBeanServer.
     * This method is equivalent to {@link
     * MBeanServer#getClassLoaderRepository() server.getClassLoaderRepository()}.
     * @param server The MBeanServer under examination. Since JMX 1.2,
     * if &lt;code&gt;server&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;, the result is a
     * {@link NullPointerException}.  This behavior differs from what
     * was implemented in JMX 1.1 - where the possibility to use
     * &lt;code&gt;null&lt;/code&gt; was deprecated.
     * @return The Class Loader Repository used by the given MBeanServer.
     * @exception SecurityException if there is a SecurityManager and
     * the caller's permissions do not include or imply &lt;code&gt;{@link
     * MBeanPermission}(&quot;getClassLoaderRepository&quot;)&lt;/code&gt;.
     *
     * @exception NullPointerException if &lt;code&gt;server&lt;/code&gt; is null.
     *
     **/
    public static ClassLoaderRepository getClassLoaderRepository(
            MBeanServer server) {
<span class="nc" id="L394">        return server.getClassLoaderRepository();</span>
    }

    private static String mBeanServerId(MBeanServer mbs) {
        try {
<span class="nc" id="L399">            return (String) mbs.getAttribute(MBeanServerDelegate.DELEGATE_NAME,</span>
                    &quot;MBeanServerId&quot;);
<span class="nc" id="L401">        } catch (JMException e) {</span>
<span class="nc" id="L402">            JmxProperties.MISC_LOGGER.finest(</span>
                    &quot;Ignoring exception while getting MBeanServerId: &quot;+e);
<span class="nc" id="L404">            return null;</span>
        }
    }

    private static void checkPermission(String action)
    throws SecurityException {
<span class="nc" id="L410">        SecurityManager sm = System.getSecurityManager();</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">        if (sm != null) {</span>
<span class="nc" id="L412">            Permission perm = new MBeanServerPermission(action);</span>
<span class="nc" id="L413">            sm.checkPermission(perm);</span>
        }
<span class="nc" id="L415">    }</span>

    private static synchronized void addMBeanServer(MBeanServer mbs) {
<span class="nc" id="L418">        mBeanServerList.add(mbs);</span>
<span class="nc" id="L419">    }</span>

    private static synchronized void removeMBeanServer(MBeanServer mbs) {
<span class="nc" id="L422">        boolean removed = mBeanServerList.remove(mbs);</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (!removed) {</span>
<span class="nc" id="L424">            MBEANSERVER_LOGGER.logp(Level.FINER,</span>
<span class="nc" id="L425">                    MBeanServerFactory.class.getName(),</span>
                    &quot;removeMBeanServer(MBeanServer)&quot;,
                    &quot;MBeanServer was not in list!&quot;);
<span class="nc" id="L428">            throw new IllegalArgumentException(&quot;MBeanServer was not in list!&quot;);</span>
        }
<span class="nc" id="L430">    }</span>

<span class="nc" id="L432">    private static final ArrayList&lt;MBeanServer&gt; mBeanServerList =</span>
            new ArrayList&lt;MBeanServer&gt;();

    /**
     * Load the builder class through the context class loader.
     * @param builderClassName The name of the builder class.
     **/
    private static Class&lt;?&gt; loadBuilderClass(String builderClassName)
    throws ClassNotFoundException {
        final ClassLoader loader =
<span class="nc" id="L442">                Thread.currentThread().getContextClassLoader();</span>

<span class="nc bnc" id="L444" title="All 2 branches missed.">        if (loader != null) {</span>
            // Try with context class loader
<span class="nc" id="L446">            return loader.loadClass(builderClassName);</span>
        }

        // No context class loader? Try with Class.forName()
<span class="nc" id="L450">        return ReflectUtil.forName(builderClassName);</span>
    }

    /**
     * Creates the initial builder according to the
     * javax.management.builder.initial System property - if specified.
     * If any checked exception needs to be thrown, it is embedded in
     * a JMRuntimeException.
     **/
    private static MBeanServerBuilder newBuilder(Class&lt;?&gt; builderClass) {
        try {
<span class="nc" id="L461">            final Object abuilder = builderClass.newInstance();</span>
<span class="nc" id="L462">            return (MBeanServerBuilder)abuilder;</span>
<span class="nc" id="L463">        } catch (RuntimeException x) {</span>
<span class="nc" id="L464">            throw x;</span>
<span class="nc" id="L465">        } catch (Exception x) {</span>
<span class="nc" id="L466">            final String msg =</span>
                    &quot;Failed to instantiate a MBeanServerBuilder from &quot; +
                    builderClass + &quot;: &quot; + x;
<span class="nc" id="L469">            throw new JMRuntimeException(msg, x);</span>
        }
    }

    /**
     * Instantiate a new builder according to the
     * javax.management.builder.initial System property - if needed.
     **/
    private static synchronized void checkMBeanServerBuilder() {
        try {
<span class="nc" id="L479">            GetPropertyAction act =</span>
                    new GetPropertyAction(JMX_INITIAL_BUILDER);
<span class="nc" id="L481">            String builderClassName = AccessController.doPrivileged(act);</span>

            try {
                final Class&lt;?&gt; newBuilderClass;
<span class="nc bnc" id="L485" title="All 4 branches missed.">                if (builderClassName == null || builderClassName.length() == 0)</span>
<span class="nc" id="L486">                    newBuilderClass = MBeanServerBuilder.class;</span>
                else
<span class="nc" id="L488">                    newBuilderClass = loadBuilderClass(builderClassName);</span>

                // Check whether a new builder needs to be created
<span class="nc bnc" id="L491" title="All 2 branches missed.">                if (builder != null) {</span>
<span class="nc" id="L492">                    final Class&lt;?&gt; builderClass = builder.getClass();</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                    if (newBuilderClass == builderClass)</span>
<span class="nc" id="L494">                        return; // no need to create a new builder...</span>
                }

                // Create a new builder
<span class="nc" id="L498">                builder = newBuilder(newBuilderClass);</span>
<span class="nc" id="L499">            } catch (ClassNotFoundException x) {</span>
<span class="nc" id="L500">                final String msg =</span>
                        &quot;Failed to load MBeanServerBuilder class &quot; +
                        builderClassName + &quot;: &quot; + x;
<span class="nc" id="L503">                throw new JMRuntimeException(msg, x);</span>
<span class="nc" id="L504">            }</span>
<span class="nc" id="L505">        } catch (RuntimeException x) {</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">            if (MBEANSERVER_LOGGER.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L507">                StringBuilder strb = new StringBuilder()</span>
<span class="nc" id="L508">                .append(&quot;Failed to instantiate MBeanServerBuilder: &quot;).append(x)</span>
<span class="nc" id="L509">                .append(&quot;\n\t\tCheck the value of the &quot;)</span>
<span class="nc" id="L510">                .append(JMX_INITIAL_BUILDER).append(&quot; property.&quot;);</span>
<span class="nc" id="L511">                MBEANSERVER_LOGGER.logp(Level.FINEST,</span>
<span class="nc" id="L512">                        MBeanServerFactory.class.getName(),</span>
                        &quot;checkMBeanServerBuilder&quot;,
<span class="nc" id="L514">                        strb.toString());</span>
            }
<span class="nc" id="L516">            throw x;</span>
<span class="nc" id="L517">        }</span>
<span class="nc" id="L518">    }</span>

    /**
     * Get the current {@link javax.management.MBeanServerBuilder},
     * as specified by the current value of the
     * javax.management.builder.initial property.
     *
     * This method consults the property and instantiates a new builder
     * if needed.
     *
     * @return the new current {@link javax.management.MBeanServerBuilder}.
     *
     * @exception SecurityException if there is a SecurityManager and
     * the caller's permissions do not make it possible to instantiate
     * a new builder.
     * @exception JMRuntimeException if the builder instantiation
     *   fails with a checked exception -
     *   {@link java.lang.ClassNotFoundException} etc...
     *
     **/
    private static synchronized MBeanServerBuilder getNewMBeanServerBuilder() {
<span class="nc" id="L539">        checkMBeanServerBuilder();</span>
<span class="nc" id="L540">        return builder;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>