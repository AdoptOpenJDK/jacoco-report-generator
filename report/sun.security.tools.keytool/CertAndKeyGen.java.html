<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CertAndKeyGen.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.tools.keytool</a> &gt; <span class="el_source">CertAndKeyGen.java</span></div><h1>CertAndKeyGen.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1996, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.tools.keytool;

import java.io.IOException;
import java.security.cert.X509Certificate;
import java.security.cert.CertificateException;
import java.security.cert.CertificateEncodingException;
import java.security.*;
import java.util.Date;

import sun.security.pkcs10.PKCS10;
import sun.security.x509.*;


/**
 * Generate a pair of keys, and provide access to them.  This class is
 * provided primarily for ease of use.
 *
 * &lt;P&gt;This provides some simple certificate management functionality.
 * Specifically, it allows you to create self-signed X.509 certificates
 * as well as PKCS 10 based certificate signing requests.
 *
 * &lt;P&gt;Keys for some public key signature algorithms have algorithm
 * parameters, such as DSS/DSA.  Some sites' Certificate Authorities
 * adopt fixed algorithm parameters, which speeds up some operations
 * including key generation and signing.  &lt;em&gt;At this time, this interface
 * does not provide a way to provide such algorithm parameters, e.g.
 * by providing the CA certificate which includes those parameters.&lt;/em&gt;
 *
 * &lt;P&gt;Also, note that at this time only signature-capable keys may be
 * acquired through this interface.  Diffie-Hellman keys, used for secure
 * key exchange, may be supported later.
 *
 * @author David Brownell
 * @author Hemma Prafullchandra
 * @see PKCS10
 * @see X509CertImpl
 */
public final class CertAndKeyGen {
    /**
     * Creates a CertAndKeyGen object for a particular key type
     * and signature algorithm.
     *
     * @param keyType type of key, e.g. &quot;RSA&quot;, &quot;DSA&quot;
     * @param sigAlg name of the signature algorithm, e.g. &quot;MD5WithRSA&quot;,
     *          &quot;MD2WithRSA&quot;, &quot;SHAwithDSA&quot;.
     * @exception NoSuchAlgorithmException on unrecognized algorithms.
     */
    public CertAndKeyGen (String keyType, String sigAlg)
    throws NoSuchAlgorithmException
<span class="nc" id="L75">    {</span>
<span class="nc" id="L76">        keyGen = KeyPairGenerator.getInstance(keyType);</span>
<span class="nc" id="L77">        this.sigAlg = sigAlg;</span>
<span class="nc" id="L78">    }</span>

    /**
     * Creates a CertAndKeyGen object for a particular key type,
     * signature algorithm, and provider.
     *
     * @param keyType type of key, e.g. &quot;RSA&quot;, &quot;DSA&quot;
     * @param sigAlg name of the signature algorithm, e.g. &quot;MD5WithRSA&quot;,
     *          &quot;MD2WithRSA&quot;, &quot;SHAwithDSA&quot;.
     * @param providerName name of the provider
     * @exception NoSuchAlgorithmException on unrecognized algorithms.
     * @exception NoSuchProviderException on unrecognized providers.
     */
    public CertAndKeyGen (String keyType, String sigAlg, String providerName)
    throws NoSuchAlgorithmException, NoSuchProviderException
<span class="nc" id="L93">    {</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (providerName == null) {</span>
<span class="nc" id="L95">            keyGen = KeyPairGenerator.getInstance(keyType);</span>
        } else {
            try {
<span class="nc" id="L98">                keyGen = KeyPairGenerator.getInstance(keyType, providerName);</span>
<span class="nc" id="L99">            } catch (Exception e) {</span>
                // try first available provider instead
<span class="nc" id="L101">                keyGen = KeyPairGenerator.getInstance(keyType);</span>
<span class="nc" id="L102">            }</span>
        }
<span class="nc" id="L104">        this.sigAlg = sigAlg;</span>
<span class="nc" id="L105">    }</span>

    /**
     * Sets the source of random numbers used when generating keys.
     * If you do not provide one, a system default facility is used.
     * You may wish to provide your own source of random numbers
     * to get a reproducible sequence of keys and signatures, or
     * because you may be able to take advantage of strong sources
     * of randomness/entropy in your environment.
     */
    public void         setRandom (SecureRandom generator)
    {
<span class="nc" id="L117">        prng = generator;</span>
<span class="nc" id="L118">    }</span>

    // want &quot;public void generate (X509Certificate)&quot; ... inherit DSA/D-H param

    /**
     * Generates a random public/private key pair, with a given key
     * size.  Different algorithms provide different degrees of security
     * for the same key size, because of the &quot;work factor&quot; involved in
     * brute force attacks.  As computers become faster, it becomes
     * easier to perform such attacks.  Small keys are to be avoided.
     *
     * &lt;P&gt;Note that not all values of &quot;keyBits&quot; are valid for all
     * algorithms, and not all public key algorithms are currently
     * supported for use in X.509 certificates.  If the algorithm
     * you specified does not produce X.509 compatible keys, an
     * invalid key exception is thrown.
     *
     * @param keyBits the number of bits in the keys.
     * @exception InvalidKeyException if the environment does not
     *  provide X.509 public keys for this signature algorithm.
     */
    public void generate (int keyBits)
    throws InvalidKeyException
    {
        KeyPair pair;

        try {
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (prng == null) {</span>
<span class="nc" id="L146">                prng = new SecureRandom();</span>
            }
<span class="nc" id="L148">            keyGen.initialize(keyBits, prng);</span>
<span class="nc" id="L149">            pair = keyGen.generateKeyPair();</span>

<span class="nc" id="L151">        } catch (Exception e) {</span>
<span class="nc" id="L152">            throw new IllegalArgumentException(e.getMessage());</span>
<span class="nc" id="L153">        }</span>

<span class="nc" id="L155">        publicKey = pair.getPublic();</span>
<span class="nc" id="L156">        privateKey = pair.getPrivate();</span>

        // publicKey's format must be X.509 otherwise
        // the whole CertGen part of this class is broken.
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (!&quot;X.509&quot;.equalsIgnoreCase(publicKey.getFormat())) {</span>
<span class="nc" id="L161">            throw new IllegalArgumentException(&quot;publicKey's is not X.509, but &quot;</span>
<span class="nc" id="L162">                    + publicKey.getFormat());</span>
        }
<span class="nc" id="L164">    }</span>


    /**
     * Returns the public key of the generated key pair if it is of type
     * &lt;code&gt;X509Key&lt;/code&gt;, or null if the public key is of a different type.
     *
     * XXX Note: This behaviour is needed for backwards compatibility.
     * What this method really should return is the public key of the
     * generated key pair, regardless of whether or not it is an instance of
     * &lt;code&gt;X509Key&lt;/code&gt;. Accordingly, the return type of this method
     * should be &lt;code&gt;PublicKey&lt;/code&gt;.
     */
    public X509Key getPublicKey()
    {
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (!(publicKey instanceof X509Key)) {</span>
<span class="nc" id="L180">            return null;</span>
        }
<span class="nc" id="L182">        return (X509Key)publicKey;</span>
    }

    /**
     * Always returns the public key of the generated key pair. Used
     * by KeyTool only.
     *
     * The publicKey is not necessarily to be an instance of
     * X509Key in some JCA/JCE providers, for example SunPKCS11.
     */
    public PublicKey getPublicKeyAnyway() {
<span class="nc" id="L193">        return publicKey;</span>
    }

    /**
     * Returns the private key of the generated key pair.
     *
     * &lt;P&gt;&lt;STRONG&gt;&lt;em&gt;Be extremely careful when handling private keys.
     * When private keys are not kept secret, they lose their ability
     * to securely authenticate specific entities ... that is a huge
     * security risk!&lt;/em&gt;&lt;/STRONG&gt;
     */
    public PrivateKey getPrivateKey ()
    {
<span class="nc" id="L206">        return privateKey;</span>
    }

    /**
     * Returns a self-signed X.509v3 certificate for the public key.
     * The certificate is immediately valid. No extensions.
     *
     * &lt;P&gt;Such certificates normally are used to identify a &quot;Certificate
     * Authority&quot; (CA).  Accordingly, they will not always be accepted by
     * other parties.  However, such certificates are also useful when
     * you are bootstrapping your security infrastructure, or deploying
     * system prototypes.
     *
     * @param myname X.500 name of the subject (who is also the issuer)
     * @param firstDate the issue time of the certificate
     * @param validity how long the certificate should be valid, in seconds
     * @exception CertificateException on certificate handling errors.
     * @exception InvalidKeyException on key handling errors.
     * @exception SignatureException on signature handling errors.
     * @exception NoSuchAlgorithmException on unrecognized algorithms.
     * @exception NoSuchProviderException on unrecognized providers.
     */
    public X509Certificate getSelfCertificate (
            X500Name myname, Date firstDate, long validity)
    throws CertificateException, InvalidKeyException, SignatureException,
        NoSuchAlgorithmException, NoSuchProviderException
    {
<span class="nc" id="L233">        return getSelfCertificate(myname, firstDate, validity, null);</span>
    }

    // Like above, plus a CertificateExtensions argument, which can be null.
    public X509Certificate getSelfCertificate (X500Name myname, Date firstDate,
            long validity, CertificateExtensions ext)
    throws CertificateException, InvalidKeyException, SignatureException,
        NoSuchAlgorithmException, NoSuchProviderException
    {
        X509CertImpl    cert;
        Date            lastDate;

        try {
<span class="nc" id="L246">            lastDate = new Date ();</span>
<span class="nc" id="L247">            lastDate.setTime (firstDate.getTime () + validity * 1000);</span>

<span class="nc" id="L249">            CertificateValidity interval =</span>
                                   new CertificateValidity(firstDate,lastDate);

<span class="nc" id="L252">            X509CertInfo info = new X509CertInfo();</span>
            // Add all mandatory attributes
<span class="nc" id="L254">            info.set(X509CertInfo.VERSION,</span>
                     new CertificateVersion(CertificateVersion.V3));
<span class="nc" id="L256">            info.set(X509CertInfo.SERIAL_NUMBER, new CertificateSerialNumber(</span>
<span class="nc" id="L257">                    new java.util.Random().nextInt() &amp; 0x7fffffff));</span>
<span class="nc" id="L258">            AlgorithmId algID = AlgorithmId.get(sigAlg);</span>
<span class="nc" id="L259">            info.set(X509CertInfo.ALGORITHM_ID,</span>
                     new CertificateAlgorithmId(algID));
<span class="nc" id="L261">            info.set(X509CertInfo.SUBJECT, myname);</span>
<span class="nc" id="L262">            info.set(X509CertInfo.KEY, new CertificateX509Key(publicKey));</span>
<span class="nc" id="L263">            info.set(X509CertInfo.VALIDITY, interval);</span>
<span class="nc" id="L264">            info.set(X509CertInfo.ISSUER, myname);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">            if (ext != null) info.set(X509CertInfo.EXTENSIONS, ext);</span>

<span class="nc" id="L267">            cert = new X509CertImpl(info);</span>
<span class="nc" id="L268">            cert.sign(privateKey, this.sigAlg);</span>

<span class="nc" id="L270">            return (X509Certificate)cert;</span>

<span class="nc" id="L272">        } catch (IOException e) {</span>
<span class="nc" id="L273">             throw new CertificateEncodingException(&quot;getSelfCert: &quot; +</span>
<span class="nc" id="L274">                                                    e.getMessage());</span>
        }
    }

    // Keep the old method
    public X509Certificate getSelfCertificate (X500Name myname, long validity)
    throws CertificateException, InvalidKeyException, SignatureException,
        NoSuchAlgorithmException, NoSuchProviderException
    {
<span class="nc" id="L283">        return getSelfCertificate(myname, new Date(), validity);</span>
    }

    /**
     * Returns a PKCS #10 certificate request.  The caller uses either
     * &lt;code&gt;PKCS10.print&lt;/code&gt; or &lt;code&gt;PKCS10.toByteArray&lt;/code&gt;
     * operations on the result, to get the request in an appropriate
     * transmission format.
     *
     * &lt;P&gt;PKCS #10 certificate requests are sent, along with some proof
     * of identity, to Certificate Authorities (CAs) which then issue
     * X.509 public key certificates.
     *
     * @param myname X.500 name of the subject
     * @exception InvalidKeyException on key handling errors.
     * @exception SignatureException on signature handling errors.
     */
    public PKCS10 getCertRequest (X500Name myname)
    throws InvalidKeyException, SignatureException
    {
<span class="nc" id="L303">        PKCS10  req = new PKCS10 (publicKey);</span>

        try {
<span class="nc" id="L306">            Signature signature = Signature.getInstance(sigAlg);</span>
<span class="nc" id="L307">            signature.initSign (privateKey);</span>
<span class="nc" id="L308">            req.encodeAndSign(myname, signature);</span>

<span class="nc" id="L310">        } catch (CertificateException e) {</span>
<span class="nc" id="L311">            throw new SignatureException (sigAlg + &quot; CertificateException&quot;);</span>

<span class="nc" id="L313">        } catch (IOException e) {</span>
<span class="nc" id="L314">            throw new SignatureException (sigAlg + &quot; IOException&quot;);</span>

<span class="nc" id="L316">        } catch (NoSuchAlgorithmException e) {</span>
            // &quot;can't happen&quot;
<span class="nc" id="L318">            throw new SignatureException (sigAlg + &quot; unavailable?&quot;);</span>
<span class="nc" id="L319">        }</span>
<span class="nc" id="L320">        return req;</span>
    }

    private SecureRandom        prng;
    private String              sigAlg;
    private KeyPairGenerator    keyGen;
    private PublicKey           publicKey;
    private PrivateKey          privateKey;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>