<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Main.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.security.tools.keytool</a> &gt; <span class="el_source">Main.java</span></div><h1>Main.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.tools.keytool;

import java.io.*;
import java.security.CodeSigner;
import java.security.KeyStore;
import java.security.KeyStoreException;
import java.security.MessageDigest;
import java.security.Key;
import java.security.PublicKey;
import java.security.PrivateKey;
import java.security.Security;
import java.security.Signature;
import java.security.Timestamp;
import java.security.UnrecoverableEntryException;
import java.security.UnrecoverableKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.Principal;
import java.security.Provider;
import java.security.cert.Certificate;
import java.security.cert.CertificateFactory;
import java.security.cert.CertStoreException;
import java.security.cert.CRL;
import java.security.cert.X509Certificate;
import java.security.cert.CertificateException;
import java.text.Collator;
import java.text.MessageFormat;
import java.util.*;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;
import java.lang.reflect.Constructor;
import java.math.BigInteger;
import java.net.URI;
import java.net.URL;
import java.net.URLClassLoader;
import java.security.cert.CertStore;

import java.security.cert.X509CRL;
import java.security.cert.X509CRLEntry;
import java.security.cert.X509CRLSelector;
import javax.security.auth.x500.X500Principal;
import java.util.Base64;
import sun.security.util.ObjectIdentifier;
import sun.security.pkcs10.PKCS10;
import sun.security.pkcs10.PKCS10Attribute;
import sun.security.provider.X509Factory;
import sun.security.provider.certpath.CertStoreHelper;
import sun.security.util.Password;
import javax.crypto.KeyGenerator;
import javax.crypto.SecretKey;
import javax.crypto.SecretKeyFactory;
import javax.crypto.spec.PBEKeySpec;

import sun.security.pkcs.PKCS9Attribute;
import sun.security.tools.KeyStoreUtil;
import sun.security.tools.PathList;
import sun.security.util.DerValue;
import sun.security.x509.*;

import static java.security.KeyStore.*;
import static sun.security.tools.keytool.Main.Command.*;
import static sun.security.tools.keytool.Main.Option.*;

/**
 * This tool manages keystores.
 *
 * @author Jan Luehe
 *
 *
 * @see java.security.KeyStore
 * @see sun.security.provider.KeyProtector
 * @see sun.security.provider.JavaKeyStore
 *
 * @since 1.2
 */
public final class Main {

<span class="nc" id="L102">    private boolean debug = false;</span>
<span class="nc" id="L103">    private Command command = null;</span>
<span class="nc" id="L104">    private String sigAlgName = null;</span>
<span class="nc" id="L105">    private String keyAlgName = null;</span>
<span class="nc" id="L106">    private boolean verbose = false;</span>
<span class="nc" id="L107">    private int keysize = -1;</span>
<span class="nc" id="L108">    private boolean rfc = false;</span>
<span class="nc" id="L109">    private long validity = (long)90;</span>
<span class="nc" id="L110">    private String alias = null;</span>
<span class="nc" id="L111">    private String dname = null;</span>
<span class="nc" id="L112">    private String dest = null;</span>
<span class="nc" id="L113">    private String filename = null;</span>
<span class="nc" id="L114">    private String infilename = null;</span>
<span class="nc" id="L115">    private String outfilename = null;</span>
<span class="nc" id="L116">    private String srcksfname = null;</span>

    // User-specified providers are added before any command is called.
    // However, they are not removed before the end of the main() method.
    // If you're calling KeyTool.main() directly in your own Java program,
    // please programtically add any providers you need and do not specify
    // them through the command line.

<span class="nc" id="L124">    private Set&lt;Pair &lt;String, String&gt;&gt; providers = null;</span>
<span class="nc" id="L125">    private String storetype = null;</span>
<span class="nc" id="L126">    private String srcProviderName = null;</span>
<span class="nc" id="L127">    private String providerName = null;</span>
<span class="nc" id="L128">    private String pathlist = null;</span>
<span class="nc" id="L129">    private char[] storePass = null;</span>
<span class="nc" id="L130">    private char[] storePassNew = null;</span>
<span class="nc" id="L131">    private char[] keyPass = null;</span>
<span class="nc" id="L132">    private char[] keyPassNew = null;</span>
<span class="nc" id="L133">    private char[] newPass = null;</span>
<span class="nc" id="L134">    private char[] destKeyPass = null;</span>
<span class="nc" id="L135">    private char[] srckeyPass = null;</span>
<span class="nc" id="L136">    private String ksfname = null;</span>
<span class="nc" id="L137">    private File ksfile = null;</span>
<span class="nc" id="L138">    private InputStream ksStream = null; // keystore stream</span>
<span class="nc" id="L139">    private String sslserver = null;</span>
<span class="nc" id="L140">    private String jarfile = null;</span>
<span class="nc" id="L141">    private KeyStore keyStore = null;</span>
<span class="nc" id="L142">    private boolean token = false;</span>
<span class="nc" id="L143">    private boolean nullStream = false;</span>
<span class="nc" id="L144">    private boolean kssave = false;</span>
<span class="nc" id="L145">    private boolean noprompt = false;</span>
<span class="nc" id="L146">    private boolean trustcacerts = false;</span>
<span class="nc" id="L147">    private boolean protectedPath = false;</span>
<span class="nc" id="L148">    private boolean srcprotectedPath = false;</span>
<span class="nc" id="L149">    private CertificateFactory cf = null;</span>
<span class="nc" id="L150">    private KeyStore caks = null; // &quot;cacerts&quot; keystore</span>
<span class="nc" id="L151">    private char[] srcstorePass = null;</span>
<span class="nc" id="L152">    private String srcstoretype = null;</span>
<span class="nc" id="L153">    private Set&lt;char[]&gt; passwords = new HashSet&lt;&gt;();</span>
<span class="nc" id="L154">    private String startDate = null;</span>

<span class="nc" id="L156">    private List&lt;String&gt; ids = new ArrayList&lt;&gt;();   // used in GENCRL</span>
<span class="nc" id="L157">    private List&lt;String&gt; v3ext = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L159">    enum Command {</span>
<span class="nc" id="L160">        CERTREQ(&quot;Generates.a.certificate.request&quot;,</span>
            ALIAS, SIGALG, FILEOUT, KEYPASS, KEYSTORE, DNAME,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L164">        CHANGEALIAS(&quot;Changes.an.entry.s.alias&quot;,</span>
            ALIAS, DESTALIAS, KEYPASS, KEYSTORE, STOREPASS,
            STORETYPE, PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L168">        DELETE(&quot;Deletes.an.entry&quot;,</span>
            ALIAS, KEYSTORE, STOREPASS, STORETYPE,
            PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L172">        EXPORTCERT(&quot;Exports.certificate&quot;,</span>
            RFC, ALIAS, FILEOUT, KEYSTORE, STOREPASS,
            STORETYPE, PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L176">        GENKEYPAIR(&quot;Generates.a.key.pair&quot;,</span>
            ALIAS, KEYALG, KEYSIZE, SIGALG, DESTALIAS, DNAME,
            STARTDATE, EXT, VALIDITY, KEYPASS, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L181">        GENSECKEY(&quot;Generates.a.secret.key&quot;,</span>
            ALIAS, KEYPASS, KEYALG, KEYSIZE, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L185">        GENCERT(&quot;Generates.certificate.from.a.certificate.request&quot;,</span>
            RFC, INFILE, OUTFILE, ALIAS, SIGALG, DNAME,
            STARTDATE, EXT, VALIDITY, KEYPASS, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L190">        IMPORTCERT(&quot;Imports.a.certificate.or.a.certificate.chain&quot;,</span>
            NOPROMPT, TRUSTCACERTS, PROTECTED, ALIAS, FILEIN,
            KEYPASS, KEYSTORE, STOREPASS, STORETYPE,
            PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V),
<span class="nc" id="L195">        IMPORTPASS(&quot;Imports.a.password&quot;,</span>
            ALIAS, KEYPASS, KEYALG, KEYSIZE, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L199">        IMPORTKEYSTORE(&quot;Imports.one.or.all.entries.from.another.keystore&quot;,</span>
            SRCKEYSTORE, DESTKEYSTORE, SRCSTORETYPE,
            DESTSTORETYPE, SRCSTOREPASS, DESTSTOREPASS,
            SRCPROTECTED, SRCPROVIDERNAME, DESTPROVIDERNAME,
            SRCALIAS, DESTALIAS, SRCKEYPASS, DESTKEYPASS,
            NOPROMPT, PROVIDERCLASS, PROVIDERARG, PROVIDERPATH,
            V),
<span class="nc" id="L206">        KEYPASSWD(&quot;Changes.the.key.password.of.an.entry&quot;,</span>
            ALIAS, KEYPASS, NEW, KEYSTORE, STOREPASS,
            STORETYPE, PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V),
<span class="nc" id="L210">        LIST(&quot;Lists.entries.in.a.keystore&quot;,</span>
            RFC, ALIAS, KEYSTORE, STOREPASS, STORETYPE,
            PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L214">        PRINTCERT(&quot;Prints.the.content.of.a.certificate&quot;,</span>
            RFC, FILEIN, SSLSERVER, JARFILE, V),
<span class="nc" id="L216">        PRINTCERTREQ(&quot;Prints.the.content.of.a.certificate.request&quot;,</span>
            FILEIN, V),
<span class="nc" id="L218">        PRINTCRL(&quot;Prints.the.content.of.a.CRL.file&quot;,</span>
            FILEIN, V),
<span class="nc" id="L220">        STOREPASSWD(&quot;Changes.the.store.password.of.a.keystore&quot;,</span>
            NEW, KEYSTORE, STOREPASS, STORETYPE, PROVIDERNAME,
            PROVIDERCLASS, PROVIDERARG, PROVIDERPATH, V),

        // Undocumented start here, KEYCLONE is used a marker in -help;

<span class="nc" id="L226">        KEYCLONE(&quot;Clones.a.key.entry&quot;,</span>
            ALIAS, DESTALIAS, KEYPASS, NEW, STORETYPE,
            KEYSTORE, STOREPASS, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V),
<span class="nc" id="L230">        SELFCERT(&quot;Generates.a.self.signed.certificate&quot;,</span>
            ALIAS, SIGALG, DNAME, STARTDATE, VALIDITY, KEYPASS,
            STORETYPE, KEYSTORE, STOREPASS, PROVIDERNAME,
            PROVIDERCLASS, PROVIDERARG, PROVIDERPATH, V),
<span class="nc" id="L234">        GENCRL(&quot;Generates.CRL&quot;,</span>
            RFC, FILEOUT, ID,
            ALIAS, SIGALG, EXT, KEYPASS, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
<span class="nc" id="L239">        IDENTITYDB(&quot;Imports.entries.from.a.JDK.1.1.x.style.identity.database&quot;,</span>
            FILEIN, STORETYPE, KEYSTORE, STOREPASS, PROVIDERNAME,
            PROVIDERCLASS, PROVIDERARG, PROVIDERPATH, V);

        final String description;
        final Option[] options;
<span class="nc" id="L245">        Command(String d, Option... o) {</span>
<span class="nc" id="L246">            description = d;</span>
<span class="nc" id="L247">            options = o;</span>
<span class="nc" id="L248">        }</span>
        @Override
        public String toString() {
<span class="nc" id="L251">            return &quot;-&quot; + name().toLowerCase(Locale.ENGLISH);</span>
        }
    };

<span class="nc" id="L255">    enum Option {</span>
<span class="nc" id="L256">        ALIAS(&quot;alias&quot;, &quot;&lt;alias&gt;&quot;, &quot;alias.name.of.the.entry.to.process&quot;),</span>
<span class="nc" id="L257">        DESTALIAS(&quot;destalias&quot;, &quot;&lt;destalias&gt;&quot;, &quot;destination.alias&quot;),</span>
<span class="nc" id="L258">        DESTKEYPASS(&quot;destkeypass&quot;, &quot;&lt;arg&gt;&quot;, &quot;destination.key.password&quot;),</span>
<span class="nc" id="L259">        DESTKEYSTORE(&quot;destkeystore&quot;, &quot;&lt;destkeystore&gt;&quot;, &quot;destination.keystore.name&quot;),</span>
<span class="nc" id="L260">        DESTPROTECTED(&quot;destprotected&quot;, null, &quot;destination.keystore.password.protected&quot;),</span>
<span class="nc" id="L261">        DESTPROVIDERNAME(&quot;destprovidername&quot;, &quot;&lt;destprovidername&gt;&quot;, &quot;destination.keystore.provider.name&quot;),</span>
<span class="nc" id="L262">        DESTSTOREPASS(&quot;deststorepass&quot;, &quot;&lt;arg&gt;&quot;, &quot;destination.keystore.password&quot;),</span>
<span class="nc" id="L263">        DESTSTORETYPE(&quot;deststoretype&quot;, &quot;&lt;deststoretype&gt;&quot;, &quot;destination.keystore.type&quot;),</span>
<span class="nc" id="L264">        DNAME(&quot;dname&quot;, &quot;&lt;dname&gt;&quot;, &quot;distinguished.name&quot;),</span>
<span class="nc" id="L265">        EXT(&quot;ext&quot;, &quot;&lt;value&gt;&quot;, &quot;X.509.extension&quot;),</span>
<span class="nc" id="L266">        FILEOUT(&quot;file&quot;, &quot;&lt;filename&gt;&quot;, &quot;output.file.name&quot;),</span>
<span class="nc" id="L267">        FILEIN(&quot;file&quot;, &quot;&lt;filename&gt;&quot;, &quot;input.file.name&quot;),</span>
<span class="nc" id="L268">        ID(&quot;id&quot;, &quot;&lt;id:reason&gt;&quot;, &quot;Serial.ID.of.cert.to.revoke&quot;),</span>
<span class="nc" id="L269">        INFILE(&quot;infile&quot;, &quot;&lt;filename&gt;&quot;, &quot;input.file.name&quot;),</span>
<span class="nc" id="L270">        KEYALG(&quot;keyalg&quot;, &quot;&lt;keyalg&gt;&quot;, &quot;key.algorithm.name&quot;),</span>
<span class="nc" id="L271">        KEYPASS(&quot;keypass&quot;, &quot;&lt;arg&gt;&quot;, &quot;key.password&quot;),</span>
<span class="nc" id="L272">        KEYSIZE(&quot;keysize&quot;, &quot;&lt;keysize&gt;&quot;, &quot;key.bit.size&quot;),</span>
<span class="nc" id="L273">        KEYSTORE(&quot;keystore&quot;, &quot;&lt;keystore&gt;&quot;, &quot;keystore.name&quot;),</span>
<span class="nc" id="L274">        NEW(&quot;new&quot;, &quot;&lt;arg&gt;&quot;, &quot;new.password&quot;),</span>
<span class="nc" id="L275">        NOPROMPT(&quot;noprompt&quot;, null, &quot;do.not.prompt&quot;),</span>
<span class="nc" id="L276">        OUTFILE(&quot;outfile&quot;, &quot;&lt;filename&gt;&quot;, &quot;output.file.name&quot;),</span>
<span class="nc" id="L277">        PROTECTED(&quot;protected&quot;, null, &quot;password.through.protected.mechanism&quot;),</span>
<span class="nc" id="L278">        PROVIDERARG(&quot;providerarg&quot;, &quot;&lt;arg&gt;&quot;, &quot;provider.argument&quot;),</span>
<span class="nc" id="L279">        PROVIDERCLASS(&quot;providerclass&quot;, &quot;&lt;providerclass&gt;&quot;, &quot;provider.class.name&quot;),</span>
<span class="nc" id="L280">        PROVIDERNAME(&quot;providername&quot;, &quot;&lt;providername&gt;&quot;, &quot;provider.name&quot;),</span>
<span class="nc" id="L281">        PROVIDERPATH(&quot;providerpath&quot;, &quot;&lt;pathlist&gt;&quot;, &quot;provider.classpath&quot;),</span>
<span class="nc" id="L282">        RFC(&quot;rfc&quot;, null, &quot;output.in.RFC.style&quot;),</span>
<span class="nc" id="L283">        SIGALG(&quot;sigalg&quot;, &quot;&lt;sigalg&gt;&quot;, &quot;signature.algorithm.name&quot;),</span>
<span class="nc" id="L284">        SRCALIAS(&quot;srcalias&quot;, &quot;&lt;srcalias&gt;&quot;, &quot;source.alias&quot;),</span>
<span class="nc" id="L285">        SRCKEYPASS(&quot;srckeypass&quot;, &quot;&lt;arg&gt;&quot;, &quot;source.key.password&quot;),</span>
<span class="nc" id="L286">        SRCKEYSTORE(&quot;srckeystore&quot;, &quot;&lt;srckeystore&gt;&quot;, &quot;source.keystore.name&quot;),</span>
<span class="nc" id="L287">        SRCPROTECTED(&quot;srcprotected&quot;, null, &quot;source.keystore.password.protected&quot;),</span>
<span class="nc" id="L288">        SRCPROVIDERNAME(&quot;srcprovidername&quot;, &quot;&lt;srcprovidername&gt;&quot;, &quot;source.keystore.provider.name&quot;),</span>
<span class="nc" id="L289">        SRCSTOREPASS(&quot;srcstorepass&quot;, &quot;&lt;arg&gt;&quot;, &quot;source.keystore.password&quot;),</span>
<span class="nc" id="L290">        SRCSTORETYPE(&quot;srcstoretype&quot;, &quot;&lt;srcstoretype&gt;&quot;, &quot;source.keystore.type&quot;),</span>
<span class="nc" id="L291">        SSLSERVER(&quot;sslserver&quot;, &quot;&lt;server[:port]&gt;&quot;, &quot;SSL.server.host.and.port&quot;),</span>
<span class="nc" id="L292">        JARFILE(&quot;jarfile&quot;, &quot;&lt;filename&gt;&quot;, &quot;signed.jar.file&quot;),</span>
<span class="nc" id="L293">        STARTDATE(&quot;startdate&quot;, &quot;&lt;startdate&gt;&quot;, &quot;certificate.validity.start.date.time&quot;),</span>
<span class="nc" id="L294">        STOREPASS(&quot;storepass&quot;, &quot;&lt;arg&gt;&quot;, &quot;keystore.password&quot;),</span>
<span class="nc" id="L295">        STORETYPE(&quot;storetype&quot;, &quot;&lt;storetype&gt;&quot;, &quot;keystore.type&quot;),</span>
<span class="nc" id="L296">        TRUSTCACERTS(&quot;trustcacerts&quot;, null, &quot;trust.certificates.from.cacerts&quot;),</span>
<span class="nc" id="L297">        V(&quot;v&quot;, null, &quot;verbose.output&quot;),</span>
<span class="nc" id="L298">        VALIDITY(&quot;validity&quot;, &quot;&lt;valDays&gt;&quot;, &quot;validity.number.of.days&quot;);</span>

        final String name, arg, description;
<span class="nc" id="L301">        Option(String name, String arg, String description) {</span>
<span class="nc" id="L302">            this.name = name;</span>
<span class="nc" id="L303">            this.arg = arg;</span>
<span class="nc" id="L304">            this.description = description;</span>
<span class="nc" id="L305">        }</span>
        @Override
        public String toString() {
<span class="nc" id="L308">            return &quot;-&quot; + name;</span>
        }
    };

<span class="nc" id="L312">    private static final Class&lt;?&gt;[] PARAM_STRING = { String.class };</span>

    private static final String NONE = &quot;NONE&quot;;
    private static final String P11KEYSTORE = &quot;PKCS11&quot;;
    private static final String P12KEYSTORE = &quot;PKCS12&quot;;
<span class="nc" id="L317">    private final String keyAlias = &quot;mykey&quot;;</span>

    // for i18n
<span class="nc" id="L320">    private static final java.util.ResourceBundle rb =</span>
<span class="nc" id="L321">        java.util.ResourceBundle.getBundle(</span>
            &quot;sun.security.tools.keytool.Resources&quot;);
<span class="nc" id="L323">    private static final Collator collator = Collator.getInstance();</span>
    static {
        // this is for case insensitive string comparisons
<span class="nc" id="L326">        collator.setStrength(Collator.PRIMARY);</span>
    };

<span class="nc" id="L329">    private Main() { }</span>

    public static void main(String[] args) throws Exception {
<span class="nc" id="L332">        Main kt = new Main();</span>
<span class="nc" id="L333">        kt.run(args, System.out);</span>
<span class="nc" id="L334">    }</span>

    private void run(String[] args, PrintStream out) throws Exception {
        try {
<span class="nc" id="L338">            parseArgs(args);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (command != null) {</span>
<span class="nc" id="L340">                doCommands(out);</span>
            }
<span class="nc" id="L342">        } catch (Exception e) {</span>
<span class="nc" id="L343">            System.out.println(rb.getString(&quot;keytool.error.&quot;) + e);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (verbose) {</span>
<span class="nc" id="L345">                e.printStackTrace(System.out);</span>
            }
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (!debug) {</span>
<span class="nc" id="L348">                System.exit(1);</span>
            } else {
<span class="nc" id="L350">                throw e;</span>
            }
        } finally {
<span class="nc bnc" id="L353" title="All 6 branches missed.">            for (char[] pass : passwords) {</span>
<span class="nc bnc" id="L354" title="All 6 branches missed.">                if (pass != null) {</span>
<span class="nc" id="L355">                    Arrays.fill(pass, ' ');</span>
<span class="nc" id="L356">                    pass = null;</span>
                }
<span class="nc" id="L358">            }</span>

<span class="nc bnc" id="L360" title="All 6 branches missed.">            if (ksStream != null) {</span>
<span class="nc" id="L361">                ksStream.close();</span>
            }
        }
<span class="nc" id="L364">    }</span>

    /**
     * Parse command line arguments.
     */
    void parseArgs(String[] args) {

<span class="nc" id="L371">        int i=0;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        boolean help = args.length == 0;</span>

<span class="nc bnc" id="L374" title="All 4 branches missed.">        for (i=0; (i &lt; args.length) &amp;&amp; args[i].startsWith(&quot;-&quot;); i++) {</span>

<span class="nc" id="L376">            String flags = args[i];</span>

            // Check if the last option needs an arg
<span class="nc bnc" id="L379" title="All 2 branches missed.">            if (i == args.length - 1) {</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">                for (Option option: Option.values()) {</span>
                    // Only options with an arg need to be checked
<span class="nc bnc" id="L382" title="All 2 branches missed.">                    if (collator.compare(flags, option.toString()) == 0) {</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">                        if (option.arg != null) errorNeedArgument(flags);</span>
                        break;
                    }
                }
            }

            /*
             * Check modifiers
             */
<span class="nc" id="L392">            String modifier = null;</span>
<span class="nc" id="L393">            int pos = flags.indexOf(':');</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">            if (pos &gt; 0) {</span>
<span class="nc" id="L395">                modifier = flags.substring(pos+1);</span>
<span class="nc" id="L396">                flags = flags.substring(0, pos);</span>
            }
            /*
             * command modes
             */
<span class="nc" id="L401">            boolean isCommand = false;</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">            for (Command c: Command.values()) {</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">                if (collator.compare(flags, c.toString()) == 0) {</span>
<span class="nc" id="L404">                    command = c;</span>
<span class="nc" id="L405">                    isCommand = true;</span>
<span class="nc" id="L406">                    break;</span>
                }
            }

<span class="nc bnc" id="L410" title="All 2 branches missed.">            if (isCommand) {</span>
                // already recognized as a command
<span class="nc bnc" id="L412" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-export&quot;) == 0) {</span>
<span class="nc" id="L413">                command = EXPORTCERT;</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-genkey&quot;) == 0) {</span>
<span class="nc" id="L415">                command = GENKEYPAIR;</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-import&quot;) == 0) {</span>
<span class="nc" id="L417">                command = IMPORTCERT;</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-importpassword&quot;) == 0) {</span>
<span class="nc" id="L419">                command = IMPORTPASS;</span>
            }
            /*
             * Help
             */
<span class="nc bnc" id="L424" title="All 2 branches missed.">            else if (collator.compare(flags, &quot;-help&quot;) == 0) {</span>
<span class="nc" id="L425">                help = true;</span>
            }

            /*
             * specifiers
             */
<span class="nc bnc" id="L431" title="All 2 branches missed.">            else if (collator.compare(flags, &quot;-keystore&quot;) == 0 ||</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">                    collator.compare(flags, &quot;-destkeystore&quot;) == 0) {</span>
<span class="nc" id="L433">                ksfname = args[++i];</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-storepass&quot;) == 0 ||</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">                    collator.compare(flags, &quot;-deststorepass&quot;) == 0) {</span>
<span class="nc" id="L436">                storePass = getPass(modifier, args[++i]);</span>
<span class="nc" id="L437">                passwords.add(storePass);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-storetype&quot;) == 0 ||</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                    collator.compare(flags, &quot;-deststoretype&quot;) == 0) {</span>
<span class="nc" id="L440">                storetype = args[++i];</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-srcstorepass&quot;) == 0) {</span>
<span class="nc" id="L442">                srcstorePass = getPass(modifier, args[++i]);</span>
<span class="nc" id="L443">                passwords.add(srcstorePass);</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-srcstoretype&quot;) == 0) {</span>
<span class="nc" id="L445">                srcstoretype = args[++i];</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-srckeypass&quot;) == 0) {</span>
<span class="nc" id="L447">                srckeyPass = getPass(modifier, args[++i]);</span>
<span class="nc" id="L448">                passwords.add(srckeyPass);</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-srcprovidername&quot;) == 0) {</span>
<span class="nc" id="L450">                srcProviderName = args[++i];</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-providername&quot;) == 0 ||</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                    collator.compare(flags, &quot;-destprovidername&quot;) == 0) {</span>
<span class="nc" id="L453">                providerName = args[++i];</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-providerpath&quot;) == 0) {</span>
<span class="nc" id="L455">                pathlist = args[++i];</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-keypass&quot;) == 0) {</span>
<span class="nc" id="L457">                keyPass = getPass(modifier, args[++i]);</span>
<span class="nc" id="L458">                passwords.add(keyPass);</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-new&quot;) == 0) {</span>
<span class="nc" id="L460">                newPass = getPass(modifier, args[++i]);</span>
<span class="nc" id="L461">                passwords.add(newPass);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-destkeypass&quot;) == 0) {</span>
<span class="nc" id="L463">                destKeyPass = getPass(modifier, args[++i]);</span>
<span class="nc" id="L464">                passwords.add(destKeyPass);</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-alias&quot;) == 0 ||</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">                    collator.compare(flags, &quot;-srcalias&quot;) == 0) {</span>
<span class="nc" id="L467">                alias = args[++i];</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-dest&quot;) == 0 ||</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                    collator.compare(flags, &quot;-destalias&quot;) == 0) {</span>
<span class="nc" id="L470">                dest = args[++i];</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-dname&quot;) == 0) {</span>
<span class="nc" id="L472">                dname = args[++i];</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-keysize&quot;) == 0) {</span>
<span class="nc" id="L474">                keysize = Integer.parseInt(args[++i]);</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-keyalg&quot;) == 0) {</span>
<span class="nc" id="L476">                keyAlgName = args[++i];</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-sigalg&quot;) == 0) {</span>
<span class="nc" id="L478">                sigAlgName = args[++i];</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-startdate&quot;) == 0) {</span>
<span class="nc" id="L480">                startDate = args[++i];</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-validity&quot;) == 0) {</span>
<span class="nc" id="L482">                validity = Long.parseLong(args[++i]);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-ext&quot;) == 0) {</span>
<span class="nc" id="L484">                v3ext.add(args[++i]);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-id&quot;) == 0) {</span>
<span class="nc" id="L486">                ids.add(args[++i]);</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-file&quot;) == 0) {</span>
<span class="nc" id="L488">                filename = args[++i];</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-infile&quot;) == 0) {</span>
<span class="nc" id="L490">                infilename = args[++i];</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-outfile&quot;) == 0) {</span>
<span class="nc" id="L492">                outfilename = args[++i];</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-sslserver&quot;) == 0) {</span>
<span class="nc" id="L494">                sslserver = args[++i];</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-jarfile&quot;) == 0) {</span>
<span class="nc" id="L496">                jarfile = args[++i];</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-srckeystore&quot;) == 0) {</span>
<span class="nc" id="L498">                srcksfname = args[++i];</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">            } else if ((collator.compare(flags, &quot;-provider&quot;) == 0) ||</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">                        (collator.compare(flags, &quot;-providerclass&quot;) == 0)) {</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">                if (providers == null) {</span>
<span class="nc" id="L502">                    providers = new HashSet&lt;Pair &lt;String, String&gt;&gt; (3);</span>
                }
<span class="nc" id="L504">                String providerClass = args[++i];</span>
<span class="nc" id="L505">                String providerArg = null;</span>

<span class="nc bnc" id="L507" title="All 2 branches missed.">                if (args.length &gt; (i+1)) {</span>
<span class="nc" id="L508">                    flags = args[i+1];</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">                    if (collator.compare(flags, &quot;-providerarg&quot;) == 0) {</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                        if (args.length == (i+2)) errorNeedArgument(flags);</span>
<span class="nc" id="L511">                        providerArg = args[i+2];</span>
<span class="nc" id="L512">                        i += 2;</span>
                    }
                }
<span class="nc" id="L515">                providers.add(</span>
<span class="nc" id="L516">                        Pair.of(providerClass, providerArg));</span>
<span class="nc" id="L517">            }</span>

            /*
             * options
             */
<span class="nc bnc" id="L522" title="All 2 branches missed.">            else if (collator.compare(flags, &quot;-v&quot;) == 0) {</span>
<span class="nc" id="L523">                verbose = true;</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-debug&quot;) == 0) {</span>
<span class="nc" id="L525">                debug = true;</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-rfc&quot;) == 0) {</span>
<span class="nc" id="L527">                rfc = true;</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-noprompt&quot;) == 0) {</span>
<span class="nc" id="L529">                noprompt = true;</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-trustcacerts&quot;) == 0) {</span>
<span class="nc" id="L531">                trustcacerts = true;</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-protected&quot;) == 0 ||</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">                    collator.compare(flags, &quot;-destprotected&quot;) == 0) {</span>
<span class="nc" id="L534">                protectedPath = true;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">            } else if (collator.compare(flags, &quot;-srcprotected&quot;) == 0) {</span>
<span class="nc" id="L536">                srcprotectedPath = true;</span>
            } else  {
<span class="nc" id="L538">                System.err.println(rb.getString(&quot;Illegal.option.&quot;) + flags);</span>
<span class="nc" id="L539">                tinyHelp();</span>
            }
        }

<span class="nc bnc" id="L543" title="All 2 branches missed.">        if (i&lt;args.length) {</span>
<span class="nc" id="L544">            System.err.println(rb.getString(&quot;Illegal.option.&quot;) + args[i]);</span>
<span class="nc" id="L545">            tinyHelp();</span>
        }

<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (command == null) {</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">            if (help) {</span>
<span class="nc" id="L550">                usage();</span>
            } else {
<span class="nc" id="L552">                System.err.println(rb.getString(&quot;Usage.error.no.command.provided&quot;));</span>
<span class="nc" id="L553">                tinyHelp();</span>
            }
<span class="nc bnc" id="L555" title="All 2 branches missed.">        } else if (help) {</span>
<span class="nc" id="L556">            usage();</span>
<span class="nc" id="L557">            command = null;</span>
        }
<span class="nc" id="L559">    }</span>

    boolean isKeyStoreRelated(Command cmd) {
<span class="nc bnc" id="L562" title="All 4 branches missed.">        return cmd != PRINTCERT &amp;&amp; cmd != PRINTCERTREQ;</span>
    }


    /**
     * Execute the commands.
     */
    void doCommands(PrintStream out) throws Exception {
<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (storetype == null) {</span>
<span class="nc" id="L571">            storetype = KeyStore.getDefaultType();</span>
        }
<span class="nc" id="L573">        storetype = KeyStoreUtil.niceStoreTypeName(storetype);</span>

<span class="nc bnc" id="L575" title="All 2 branches missed.">        if (srcstoretype == null) {</span>
<span class="nc" id="L576">            srcstoretype = KeyStore.getDefaultType();</span>
        }
<span class="nc" id="L578">        srcstoretype = KeyStoreUtil.niceStoreTypeName(srcstoretype);</span>

<span class="nc bnc" id="L580" title="All 2 branches missed.">        if (P11KEYSTORE.equalsIgnoreCase(storetype) ||</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">                KeyStoreUtil.isWindowsKeyStore(storetype)) {</span>
<span class="nc" id="L582">            token = true;</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">            if (ksfname == null) {</span>
<span class="nc" id="L584">                ksfname = NONE;</span>
            }
        }
<span class="nc bnc" id="L587" title="All 2 branches missed.">        if (NONE.equals(ksfname)) {</span>
<span class="nc" id="L588">            nullStream = true;</span>
        }

<span class="nc bnc" id="L591" title="All 4 branches missed.">        if (token &amp;&amp; !nullStream) {</span>
<span class="nc" id="L592">            System.err.println(MessageFormat.format(rb.getString</span>
<span class="nc" id="L593">                (&quot;.keystore.must.be.NONE.if.storetype.is.{0}&quot;), storetype));</span>
<span class="nc" id="L594">            System.err.println();</span>
<span class="nc" id="L595">            tinyHelp();</span>
        }

<span class="nc bnc" id="L598" title="All 6 branches missed.">        if (token &amp;&amp;</span>
            (command == KEYPASSWD || command == STOREPASSWD)) {
<span class="nc" id="L600">            throw new UnsupportedOperationException(MessageFormat.format(rb.getString</span>
<span class="nc" id="L601">                        (&quot;.storepasswd.and.keypasswd.commands.not.supported.if.storetype.is.{0}&quot;), storetype));</span>
        }

<span class="nc bnc" id="L604" title="All 4 branches missed.">        if (P12KEYSTORE.equalsIgnoreCase(storetype) &amp;&amp; command == KEYPASSWD) {</span>
<span class="nc" id="L605">            throw new UnsupportedOperationException(rb.getString</span>
<span class="nc" id="L606">                        (&quot;.keypasswd.commands.not.supported.if.storetype.is.PKCS12&quot;));</span>
        }

<span class="nc bnc" id="L609" title="All 8 branches missed.">        if (token &amp;&amp; (keyPass != null || newPass != null || destKeyPass != null)) {</span>
<span class="nc" id="L610">            throw new IllegalArgumentException(MessageFormat.format(rb.getString</span>
<span class="nc" id="L611">                (&quot;.keypass.and.new.can.not.be.specified.if.storetype.is.{0}&quot;), storetype));</span>
        }

<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (protectedPath) {</span>
<span class="nc bnc" id="L615" title="All 8 branches missed.">            if (storePass != null || keyPass != null ||</span>
                    newPass != null || destKeyPass != null) {
<span class="nc" id="L617">                throw new IllegalArgumentException(rb.getString</span>
<span class="nc" id="L618">                        (&quot;if.protected.is.specified.then.storepass.keypass.and.new.must.not.be.specified&quot;));</span>
            }
        }

<span class="nc bnc" id="L622" title="All 2 branches missed.">        if (srcprotectedPath) {</span>
<span class="nc bnc" id="L623" title="All 4 branches missed.">            if (srcstorePass != null || srckeyPass != null) {</span>
<span class="nc" id="L624">                throw new IllegalArgumentException(rb.getString</span>
<span class="nc" id="L625">                        (&quot;if.srcprotected.is.specified.then.srcstorepass.and.srckeypass.must.not.be.specified&quot;));</span>
            }
        }

<span class="nc bnc" id="L629" title="All 2 branches missed.">        if (KeyStoreUtil.isWindowsKeyStore(storetype)) {</span>
<span class="nc bnc" id="L630" title="All 8 branches missed.">            if (storePass != null || keyPass != null ||</span>
                    newPass != null || destKeyPass != null) {
<span class="nc" id="L632">                throw new IllegalArgumentException(rb.getString</span>
<span class="nc" id="L633">                        (&quot;if.keystore.is.not.password.protected.then.storepass.keypass.and.new.must.not.be.specified&quot;));</span>
            }
        }

<span class="nc bnc" id="L637" title="All 2 branches missed.">        if (KeyStoreUtil.isWindowsKeyStore(srcstoretype)) {</span>
<span class="nc bnc" id="L638" title="All 4 branches missed.">            if (srcstorePass != null || srckeyPass != null) {</span>
<span class="nc" id="L639">                throw new IllegalArgumentException(rb.getString</span>
<span class="nc" id="L640">                        (&quot;if.source.keystore.is.not.password.protected.then.srcstorepass.and.srckeypass.must.not.be.specified&quot;));</span>
            }
        }

<span class="nc bnc" id="L644" title="All 2 branches missed.">        if (validity &lt;= (long)0) {</span>
<span class="nc" id="L645">            throw new Exception</span>
<span class="nc" id="L646">                (rb.getString(&quot;Validity.must.be.greater.than.zero&quot;));</span>
        }

        // Try to load and install specified provider
<span class="nc bnc" id="L650" title="All 2 branches missed.">        if (providers != null) {</span>
<span class="nc" id="L651">            ClassLoader cl = null;</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">            if (pathlist != null) {</span>
<span class="nc" id="L653">                String path = null;</span>
<span class="nc" id="L654">                path = PathList.appendPath(</span>
<span class="nc" id="L655">                        path, System.getProperty(&quot;java.class.path&quot;));</span>
<span class="nc" id="L656">                path = PathList.appendPath(</span>
<span class="nc" id="L657">                        path, System.getProperty(&quot;env.class.path&quot;));</span>
<span class="nc" id="L658">                path = PathList.appendPath(path, pathlist);</span>

<span class="nc" id="L660">                URL[] urls = PathList.pathToURLs(path);</span>
<span class="nc" id="L661">                cl = new URLClassLoader(urls);</span>
<span class="nc" id="L662">            } else {</span>
<span class="nc" id="L663">                cl = ClassLoader.getSystemClassLoader();</span>
            }

<span class="nc bnc" id="L666" title="All 2 branches missed.">            for (Pair &lt;String, String&gt; provider: providers) {</span>
<span class="nc" id="L667">                String provName = provider.fst;</span>
                Class&lt;?&gt; provClass;
<span class="nc bnc" id="L669" title="All 2 branches missed.">                if (cl != null) {</span>
<span class="nc" id="L670">                    provClass = cl.loadClass(provName);</span>
                } else {
<span class="nc" id="L672">                    provClass = Class.forName(provName);</span>
                }

<span class="nc" id="L675">                String provArg = provider.snd;</span>
                Object obj;
<span class="nc bnc" id="L677" title="All 2 branches missed.">                if (provArg == null) {</span>
<span class="nc" id="L678">                    obj = provClass.newInstance();</span>
                } else {
<span class="nc" id="L680">                    Constructor&lt;?&gt; c = provClass.getConstructor(PARAM_STRING);</span>
<span class="nc" id="L681">                    obj = c.newInstance(provArg);</span>
                }
<span class="nc bnc" id="L683" title="All 2 branches missed.">                if (!(obj instanceof Provider)) {</span>
<span class="nc" id="L684">                    MessageFormat form = new MessageFormat</span>
<span class="nc" id="L685">                        (rb.getString(&quot;provName.not.a.provider&quot;));</span>
<span class="nc" id="L686">                    Object[] source = {provName};</span>
<span class="nc" id="L687">                    throw new Exception(form.format(source));</span>
                }
<span class="nc" id="L689">                Security.addProvider((Provider)obj);</span>
<span class="nc" id="L690">            }</span>
        }

<span class="nc bnc" id="L693" title="All 6 branches missed.">        if (command == LIST &amp;&amp; verbose &amp;&amp; rfc) {</span>
<span class="nc" id="L694">            System.err.println(rb.getString</span>
<span class="nc" id="L695">                (&quot;Must.not.specify.both.v.and.rfc.with.list.command&quot;));</span>
<span class="nc" id="L696">            tinyHelp();</span>
        }

        // Make sure provided passwords are at least 6 characters long
<span class="nc bnc" id="L700" title="All 6 branches missed.">        if (command == GENKEYPAIR &amp;&amp; keyPass!=null &amp;&amp; keyPass.length &lt; 6) {</span>
<span class="nc" id="L701">            throw new Exception(rb.getString</span>
<span class="nc" id="L702">                (&quot;Key.password.must.be.at.least.6.characters&quot;));</span>
        }
<span class="nc bnc" id="L704" title="All 4 branches missed.">        if (newPass != null &amp;&amp; newPass.length &lt; 6) {</span>
<span class="nc" id="L705">            throw new Exception(rb.getString</span>
<span class="nc" id="L706">                (&quot;New.password.must.be.at.least.6.characters&quot;));</span>
        }
<span class="nc bnc" id="L708" title="All 4 branches missed.">        if (destKeyPass != null &amp;&amp; destKeyPass.length &lt; 6) {</span>
<span class="nc" id="L709">            throw new Exception(rb.getString</span>
<span class="nc" id="L710">                (&quot;New.password.must.be.at.least.6.characters&quot;));</span>
        }

        // Check if keystore exists.
        // If no keystore has been specified at the command line, try to use
        // the default, which is located in $HOME/.keystore.
        // If the command is &quot;genkey&quot;, &quot;identitydb&quot;, &quot;import&quot;, or &quot;printcert&quot;,
        // it is OK not to have a keystore.
<span class="nc bnc" id="L718" title="All 2 branches missed.">        if (isKeyStoreRelated(command)) {</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">            if (ksfname == null) {</span>
<span class="nc" id="L720">                ksfname = System.getProperty(&quot;user.home&quot;) + File.separator</span>
                    + &quot;.keystore&quot;;
            }

<span class="nc bnc" id="L724" title="All 2 branches missed.">            if (!nullStream) {</span>
                try {
<span class="nc" id="L726">                    ksfile = new File(ksfname);</span>
                    // Check if keystore file is empty
<span class="nc bnc" id="L728" title="All 4 branches missed.">                    if (ksfile.exists() &amp;&amp; ksfile.length() == 0) {</span>
<span class="nc" id="L729">                        throw new Exception(rb.getString</span>
<span class="nc" id="L730">                        (&quot;Keystore.file.exists.but.is.empty.&quot;) + ksfname);</span>
                    }
<span class="nc" id="L732">                    ksStream = new FileInputStream(ksfile);</span>
<span class="nc" id="L733">                } catch (FileNotFoundException e) {</span>
<span class="nc bnc" id="L734" title="All 14 branches missed.">                    if (command != GENKEYPAIR &amp;&amp;</span>
                        command != GENSECKEY &amp;&amp;
                        command != IDENTITYDB &amp;&amp;
                        command != IMPORTCERT &amp;&amp;
                        command != IMPORTPASS &amp;&amp;
                        command != IMPORTKEYSTORE &amp;&amp;
                        command != PRINTCRL) {
<span class="nc" id="L741">                        throw new Exception(rb.getString</span>
<span class="nc" id="L742">                                (&quot;Keystore.file.does.not.exist.&quot;) + ksfname);</span>
                    }
<span class="nc" id="L744">                }</span>
            }
        }

<span class="nc bnc" id="L748" title="All 6 branches missed.">        if ((command == KEYCLONE || command == CHANGEALIAS)</span>
                &amp;&amp; dest == null) {
<span class="nc" id="L750">            dest = getAlias(&quot;destination&quot;);</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">            if (&quot;&quot;.equals(dest)) {</span>
<span class="nc" id="L752">                throw new Exception(rb.getString</span>
<span class="nc" id="L753">                        (&quot;Must.specify.destination.alias&quot;));</span>
            }
        }

<span class="nc bnc" id="L757" title="All 4 branches missed.">        if (command == DELETE &amp;&amp; alias == null) {</span>
<span class="nc" id="L758">            alias = getAlias(null);</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">            if (&quot;&quot;.equals(alias)) {</span>
<span class="nc" id="L760">                throw new Exception(rb.getString(&quot;Must.specify.alias&quot;));</span>
            }
        }

        // Create new keystore
<span class="nc bnc" id="L765" title="All 2 branches missed.">        if (providerName == null) {</span>
<span class="nc" id="L766">            keyStore = KeyStore.getInstance(storetype);</span>
        } else {
<span class="nc" id="L768">            keyStore = KeyStore.getInstance(storetype, providerName);</span>
        }

        /*
         * Load the keystore data.
         *
         * At this point, it's OK if no keystore password has been provided.
         * We want to make sure that we can load the keystore data, i.e.,
         * the keystore data has the right format. If we cannot load the
         * keystore, why bother asking the user for his or her password?
         * Only if we were able to load the keystore, and no keystore
         * password has been provided, will we prompt the user for the
         * keystore password to verify the keystore integrity.
         * This means that the keystore is loaded twice: first load operation
         * checks the keystore format, second load operation verifies the
         * keystore integrity.
         *
         * If the keystore password has already been provided (at the
         * command line), however, the keystore is loaded only once, and the
         * keystore format and integrity are checked &quot;at the same time&quot;.
         *
         * Null stream keystores are loaded later.
         */
<span class="nc bnc" id="L791" title="All 2 branches missed.">        if (!nullStream) {</span>
<span class="nc" id="L792">            keyStore.load(ksStream, storePass);</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">            if (ksStream != null) {</span>
<span class="nc" id="L794">                ksStream.close();</span>
            }
        }

        // All commands that create or modify the keystore require a keystore
        // password.

<span class="nc bnc" id="L801" title="All 4 branches missed.">        if (nullStream &amp;&amp; storePass != null) {</span>
<span class="nc" id="L802">            keyStore.load(null, storePass);</span>
<span class="nc bnc" id="L803" title="All 4 branches missed.">        } else if (!nullStream &amp;&amp; storePass != null) {</span>
            // If we are creating a new non nullStream-based keystore,
            // insist that the password be at least 6 characters
<span class="nc bnc" id="L806" title="All 4 branches missed.">            if (ksStream == null &amp;&amp; storePass.length &lt; 6) {</span>
<span class="nc" id="L807">                throw new Exception(rb.getString</span>
<span class="nc" id="L808">                        (&quot;Keystore.password.must.be.at.least.6.characters&quot;));</span>
            }
<span class="nc bnc" id="L810" title="All 2 branches missed.">        } else if (storePass == null) {</span>

            // only prompt if (protectedPath == false)

<span class="nc bnc" id="L814" title="All 30 branches missed.">            if (!protectedPath &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype) &amp;&amp;</span>
                (command == CERTREQ ||
                        command == DELETE ||
                        command == GENKEYPAIR ||
                        command == GENSECKEY ||
                        command == IMPORTCERT ||
                        command == IMPORTPASS ||
                        command == IMPORTKEYSTORE ||
                        command == KEYCLONE ||
                        command == CHANGEALIAS ||
                        command == SELFCERT ||
                        command == STOREPASSWD ||
                        command == KEYPASSWD ||
                        command == IDENTITYDB)) {
<span class="nc" id="L828">                int count = 0;</span>
                do {
<span class="nc bnc" id="L830" title="All 2 branches missed.">                    if (command == IMPORTKEYSTORE) {</span>
<span class="nc" id="L831">                        System.err.print</span>
<span class="nc" id="L832">                                (rb.getString(&quot;Enter.destination.keystore.password.&quot;));</span>
                    } else {
<span class="nc" id="L834">                        System.err.print</span>
<span class="nc" id="L835">                                (rb.getString(&quot;Enter.keystore.password.&quot;));</span>
                    }
<span class="nc" id="L837">                    System.err.flush();</span>
<span class="nc" id="L838">                    storePass = Password.readPassword(System.in);</span>
<span class="nc" id="L839">                    passwords.add(storePass);</span>

                    // If we are creating a new non nullStream-based keystore,
                    // insist that the password be at least 6 characters
<span class="nc bnc" id="L843" title="All 6 branches missed.">                    if (!nullStream &amp;&amp; (storePass == null || storePass.length &lt; 6)) {</span>
<span class="nc" id="L844">                        System.err.println(rb.getString</span>
<span class="nc" id="L845">                                (&quot;Keystore.password.is.too.short.must.be.at.least.6.characters&quot;));</span>
<span class="nc" id="L846">                        storePass = null;</span>
                    }

                    // If the keystore file does not exist and needs to be
                    // created, the storepass should be prompted twice.
<span class="nc bnc" id="L851" title="All 6 branches missed.">                    if (storePass != null &amp;&amp; !nullStream &amp;&amp; ksStream == null) {</span>
<span class="nc" id="L852">                        System.err.print(rb.getString(&quot;Re.enter.new.password.&quot;));</span>
<span class="nc" id="L853">                        char[] storePassAgain = Password.readPassword(System.in);</span>
<span class="nc" id="L854">                        passwords.add(storePassAgain);</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">                        if (!Arrays.equals(storePass, storePassAgain)) {</span>
<span class="nc" id="L856">                            System.err.println</span>
<span class="nc" id="L857">                                (rb.getString(&quot;They.don.t.match.Try.again&quot;));</span>
<span class="nc" id="L858">                            storePass = null;</span>
                        }
                    }

<span class="nc" id="L862">                    count++;</span>
<span class="nc bnc" id="L863" title="All 4 branches missed.">                } while ((storePass == null) &amp;&amp; count &lt; 3);</span>


<span class="nc bnc" id="L866" title="All 2 branches missed.">                if (storePass == null) {</span>
<span class="nc" id="L867">                    System.err.println</span>
<span class="nc" id="L868">                        (rb.getString(&quot;Too.many.failures.try.later&quot;));</span>
<span class="nc" id="L869">                    return;</span>
                }
<span class="nc bnc" id="L871" title="All 2 branches missed.">            } else if (!protectedPath</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">                    &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype)</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">                    &amp;&amp; isKeyStoreRelated(command)) {</span>
                // here we have EXPORTCERT and LIST (info valid until STOREPASSWD)
<span class="nc bnc" id="L875" title="All 2 branches missed.">                if (command != PRINTCRL) {</span>
<span class="nc" id="L876">                    System.err.print(rb.getString(&quot;Enter.keystore.password.&quot;));</span>
<span class="nc" id="L877">                    System.err.flush();</span>
<span class="nc" id="L878">                    storePass = Password.readPassword(System.in);</span>
<span class="nc" id="L879">                    passwords.add(storePass);</span>
                }
            }

            // Now load a nullStream-based keystore,
            // or verify the integrity of an input stream-based keystore
<span class="nc bnc" id="L885" title="All 2 branches missed.">            if (nullStream) {</span>
<span class="nc" id="L886">                keyStore.load(null, storePass);</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">            } else if (ksStream != null) {</span>
<span class="nc" id="L888">                ksStream = new FileInputStream(ksfile);</span>
<span class="nc" id="L889">                keyStore.load(ksStream, storePass);</span>
<span class="nc" id="L890">                ksStream.close();</span>
            }
        }

<span class="nc bnc" id="L894" title="All 4 branches missed.">        if (storePass != null &amp;&amp; P12KEYSTORE.equalsIgnoreCase(storetype)) {</span>
<span class="nc" id="L895">            MessageFormat form = new MessageFormat(rb.getString(</span>
                &quot;Warning.Different.store.and.key.passwords.not.supported.for.PKCS12.KeyStores.Ignoring.user.specified.command.value.&quot;));
<span class="nc bnc" id="L897" title="All 4 branches missed.">            if (keyPass != null &amp;&amp; !Arrays.equals(storePass, keyPass)) {</span>
<span class="nc" id="L898">                Object[] source = {&quot;-keypass&quot;};</span>
<span class="nc" id="L899">                System.err.println(form.format(source));</span>
<span class="nc" id="L900">                keyPass = storePass;</span>
            }
<span class="nc bnc" id="L902" title="All 4 branches missed.">            if (newPass != null &amp;&amp; !Arrays.equals(storePass, newPass)) {</span>
<span class="nc" id="L903">                Object[] source = {&quot;-new&quot;};</span>
<span class="nc" id="L904">                System.err.println(form.format(source));</span>
<span class="nc" id="L905">                newPass = storePass;</span>
            }
<span class="nc bnc" id="L907" title="All 4 branches missed.">            if (destKeyPass != null &amp;&amp; !Arrays.equals(storePass, destKeyPass)) {</span>
<span class="nc" id="L908">                Object[] source = {&quot;-destkeypass&quot;};</span>
<span class="nc" id="L909">                System.err.println(form.format(source));</span>
<span class="nc" id="L910">                destKeyPass = storePass;</span>
            }
        }

        // Create a certificate factory
<span class="nc bnc" id="L915" title="All 8 branches missed.">        if (command == PRINTCERT || command == IMPORTCERT</span>
                || command == IDENTITYDB || command == PRINTCRL) {
<span class="nc" id="L917">            cf = CertificateFactory.getInstance(&quot;X509&quot;);</span>
        }

<span class="nc bnc" id="L920" title="All 2 branches missed.">        if (trustcacerts) {</span>
<span class="nc" id="L921">            caks = KeyStoreUtil.getCacertsKeyStore();</span>
        }

        // Perform the specified command
<span class="nc bnc" id="L925" title="All 2 branches missed.">        if (command == CERTREQ) {</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">            if (filename != null) {</span>
<span class="nc" id="L927">                try (PrintStream ps = new PrintStream(new FileOutputStream</span>
                                                      (filename))) {
<span class="nc" id="L929">                    doCertReq(alias, sigAlgName, ps);</span>
<span class="nc bnc" id="L930" title="All 8 branches missed.">                }</span>
            } else {
<span class="nc" id="L932">                doCertReq(alias, sigAlgName, out);</span>
            }
<span class="nc bnc" id="L934" title="All 4 branches missed.">            if (verbose &amp;&amp; filename != null) {</span>
<span class="nc" id="L935">                MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L936">                        (&quot;Certification.request.stored.in.file.filename.&quot;));</span>
<span class="nc" id="L937">                Object[] source = {filename};</span>
<span class="nc" id="L938">                System.err.println(form.format(source));</span>
<span class="nc" id="L939">                System.err.println(rb.getString(&quot;Submit.this.to.your.CA&quot;));</span>
<span class="nc" id="L940">            }</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">        } else if (command == DELETE) {</span>
<span class="nc" id="L942">            doDeleteEntry(alias);</span>
<span class="nc" id="L943">            kssave = true;</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">        } else if (command == EXPORTCERT) {</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">            if (filename != null) {</span>
<span class="nc" id="L946">                try (PrintStream ps = new PrintStream(new FileOutputStream</span>
                                                   (filename))) {
<span class="nc" id="L948">                    doExportCert(alias, ps);</span>
<span class="nc bnc" id="L949" title="All 8 branches missed.">                }</span>
            } else {
<span class="nc" id="L951">                doExportCert(alias, out);</span>
            }
<span class="nc bnc" id="L953" title="All 2 branches missed.">            if (filename != null) {</span>
<span class="nc" id="L954">                MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L955">                        (&quot;Certificate.stored.in.file.filename.&quot;));</span>
<span class="nc" id="L956">                Object[] source = {filename};</span>
<span class="nc" id="L957">                System.err.println(form.format(source));</span>
<span class="nc" id="L958">            }</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">        } else if (command == GENKEYPAIR) {</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">            if (keyAlgName == null) {</span>
<span class="nc" id="L961">                keyAlgName = &quot;DSA&quot;;</span>
            }
<span class="nc" id="L963">            doGenKeyPair(alias, dname, keyAlgName, keysize, sigAlgName);</span>
<span class="nc" id="L964">            kssave = true;</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">        } else if (command == GENSECKEY) {</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">            if (keyAlgName == null) {</span>
<span class="nc" id="L967">                keyAlgName = &quot;DES&quot;;</span>
            }
<span class="nc" id="L969">            doGenSecretKey(alias, keyAlgName, keysize);</span>
<span class="nc" id="L970">            kssave = true;</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">        } else if (command == IMPORTPASS) {</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">            if (keyAlgName == null) {</span>
<span class="nc" id="L973">                keyAlgName = &quot;PBE&quot;;</span>
            }
            // password is stored as a secret key
<span class="nc" id="L976">            doGenSecretKey(alias, keyAlgName, keysize);</span>
<span class="nc" id="L977">            kssave = true;</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">        } else if (command == IDENTITYDB) {</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">            if (filename != null) {</span>
<span class="nc" id="L980">                try (InputStream inStream = new FileInputStream(filename)) {</span>
<span class="nc" id="L981">                    doImportIdentityDatabase(inStream);</span>
<span class="nc bnc" id="L982" title="All 8 branches missed.">                }</span>
            } else {
<span class="nc" id="L984">                doImportIdentityDatabase(System.in);</span>
            }
<span class="nc bnc" id="L986" title="All 2 branches missed.">        } else if (command == IMPORTCERT) {</span>
<span class="nc" id="L987">            InputStream inStream = System.in;</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">            if (filename != null) {</span>
<span class="nc" id="L989">                inStream = new FileInputStream(filename);</span>
            }
<span class="nc bnc" id="L991" title="All 2 branches missed.">            String importAlias = (alias!=null)?alias:keyAlias;</span>
            try {
<span class="nc bnc" id="L993" title="All 2 branches missed.">                if (keyStore.entryInstanceOf(</span>
                        importAlias, KeyStore.PrivateKeyEntry.class)) {
<span class="nc" id="L995">                    kssave = installReply(importAlias, inStream);</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">                    if (kssave) {</span>
<span class="nc" id="L997">                        System.err.println(rb.getString</span>
<span class="nc" id="L998">                            (&quot;Certificate.reply.was.installed.in.keystore&quot;));</span>
                    } else {
<span class="nc" id="L1000">                        System.err.println(rb.getString</span>
<span class="nc" id="L1001">                            (&quot;Certificate.reply.was.not.installed.in.keystore&quot;));</span>
                    }
<span class="nc bnc" id="L1003" title="All 2 branches missed.">                } else if (!keyStore.containsAlias(importAlias) ||</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">                        keyStore.entryInstanceOf(importAlias,</span>
                            KeyStore.TrustedCertificateEntry.class)) {
<span class="nc" id="L1006">                    kssave = addTrustedCert(importAlias, inStream);</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">                    if (kssave) {</span>
<span class="nc" id="L1008">                        System.err.println(rb.getString</span>
<span class="nc" id="L1009">                            (&quot;Certificate.was.added.to.keystore&quot;));</span>
                    } else {
<span class="nc" id="L1011">                        System.err.println(rb.getString</span>
<span class="nc" id="L1012">                            (&quot;Certificate.was.not.added.to.keystore&quot;));</span>
                    }
                }
            } finally {
<span class="nc bnc" id="L1016" title="All 4 branches missed.">                if (inStream != System.in) {</span>
<span class="nc" id="L1017">                    inStream.close();</span>
                }
            }
<span class="nc bnc" id="L1020" title="All 2 branches missed.">        } else if (command == IMPORTKEYSTORE) {</span>
<span class="nc" id="L1021">            doImportKeyStore();</span>
<span class="nc" id="L1022">            kssave = true;</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">        } else if (command == KEYCLONE) {</span>
<span class="nc" id="L1024">            keyPassNew = newPass;</span>

            // added to make sure only key can go thru
<span class="nc bnc" id="L1027" title="All 2 branches missed.">            if (alias == null) {</span>
<span class="nc" id="L1028">                alias = keyAlias;</span>
            }
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if (keyStore.containsAlias(alias) == false) {</span>
<span class="nc" id="L1031">                MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1032">                    (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</span>
<span class="nc" id="L1033">                Object[] source = {alias};</span>
<span class="nc" id="L1034">                throw new Exception(form.format(source));</span>
            }
<span class="nc bnc" id="L1036" title="All 2 branches missed.">            if (!keyStore.entryInstanceOf(alias, KeyStore.PrivateKeyEntry.class)) {</span>
<span class="nc" id="L1037">                MessageFormat form = new MessageFormat(rb.getString(</span>
                        &quot;Alias.alias.references.an.entry.type.that.is.not.a.private.key.entry.The.keyclone.command.only.supports.cloning.of.private.key&quot;));
<span class="nc" id="L1039">                Object[] source = {alias};</span>
<span class="nc" id="L1040">                throw new Exception(form.format(source));</span>
            }

<span class="nc" id="L1043">            doCloneEntry(alias, dest, true);  // Now everything can be cloned</span>
<span class="nc" id="L1044">            kssave = true;</span>
<span class="nc bnc" id="L1045" title="All 2 branches missed.">        } else if (command == CHANGEALIAS) {</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">            if (alias == null) {</span>
<span class="nc" id="L1047">                alias = keyAlias;</span>
            }
<span class="nc" id="L1049">            doCloneEntry(alias, dest, false);</span>
            // in PKCS11, clone a PrivateKeyEntry will delete the old one
<span class="nc bnc" id="L1051" title="All 2 branches missed.">            if (keyStore.containsAlias(alias)) {</span>
<span class="nc" id="L1052">                doDeleteEntry(alias);</span>
            }
<span class="nc" id="L1054">            kssave = true;</span>
<span class="nc bnc" id="L1055" title="All 2 branches missed.">        } else if (command == KEYPASSWD) {</span>
<span class="nc" id="L1056">            keyPassNew = newPass;</span>
<span class="nc" id="L1057">            doChangeKeyPasswd(alias);</span>
<span class="nc" id="L1058">            kssave = true;</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">        } else if (command == LIST) {</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">            if (alias != null) {</span>
<span class="nc" id="L1061">                doPrintEntry(alias, out, true);</span>
            } else {
<span class="nc" id="L1063">                doPrintEntries(out);</span>
            }
<span class="nc bnc" id="L1065" title="All 2 branches missed.">        } else if (command == PRINTCERT) {</span>
<span class="nc" id="L1066">            doPrintCert(out);</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">        } else if (command == SELFCERT) {</span>
<span class="nc" id="L1068">            doSelfCert(alias, dname, sigAlgName);</span>
<span class="nc" id="L1069">            kssave = true;</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">        } else if (command == STOREPASSWD) {</span>
<span class="nc" id="L1071">            storePassNew = newPass;</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">            if (storePassNew == null) {</span>
<span class="nc" id="L1073">                storePassNew = getNewPasswd(&quot;keystore password&quot;, storePass);</span>
            }
<span class="nc" id="L1075">            kssave = true;</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">        } else if (command == GENCERT) {</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">            if (alias == null) {</span>
<span class="nc" id="L1078">                alias = keyAlias;</span>
            }
<span class="nc" id="L1080">            InputStream inStream = System.in;</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">            if (infilename != null) {</span>
<span class="nc" id="L1082">                inStream = new FileInputStream(infilename);</span>
            }
<span class="nc" id="L1084">            PrintStream ps = null;</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">            if (outfilename != null) {</span>
<span class="nc" id="L1086">                ps = new PrintStream(new FileOutputStream(outfilename));</span>
<span class="nc" id="L1087">                out = ps;</span>
            }
            try {
<span class="nc" id="L1090">                doGenCert(alias, sigAlgName, inStream, out);</span>
            } finally {
<span class="nc bnc" id="L1092" title="All 4 branches missed.">                if (inStream != System.in) {</span>
<span class="nc" id="L1093">                    inStream.close();</span>
                }
<span class="nc bnc" id="L1095" title="All 4 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L1096">                    ps.close();</span>
                }
            }
<span class="nc bnc" id="L1099" title="All 2 branches missed.">        } else if (command == GENCRL) {</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">            if (alias == null) {</span>
<span class="nc" id="L1101">                alias = keyAlias;</span>
            }
<span class="nc bnc" id="L1103" title="All 2 branches missed.">            if (filename != null) {</span>
<span class="nc" id="L1104">                try (PrintStream ps =</span>
                         new PrintStream(new FileOutputStream(filename))) {
<span class="nc" id="L1106">                    doGenCRL(ps);</span>
<span class="nc bnc" id="L1107" title="All 8 branches missed.">                }</span>
            } else {
<span class="nc" id="L1109">                doGenCRL(out);</span>
            }
<span class="nc bnc" id="L1111" title="All 2 branches missed.">        } else if (command == PRINTCERTREQ) {</span>
<span class="nc bnc" id="L1112" title="All 2 branches missed.">            if (filename != null) {</span>
<span class="nc" id="L1113">                try (InputStream inStream = new FileInputStream(filename)) {</span>
<span class="nc" id="L1114">                    doPrintCertReq(inStream, out);</span>
<span class="nc bnc" id="L1115" title="All 8 branches missed.">                }</span>
            } else {
<span class="nc" id="L1117">                doPrintCertReq(System.in, out);</span>
            }
<span class="nc bnc" id="L1119" title="All 2 branches missed.">        } else if (command == PRINTCRL) {</span>
<span class="nc" id="L1120">            doPrintCRL(filename, out);</span>
        }

        // If we need to save the keystore, do so.
<span class="nc bnc" id="L1124" title="All 2 branches missed.">        if (kssave) {</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">            if (verbose) {</span>
<span class="nc" id="L1126">                MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1127">                        (rb.getString(&quot;.Storing.ksfname.&quot;));</span>
<span class="nc bnc" id="L1128" title="All 2 branches missed.">                Object[] source = {nullStream ? &quot;keystore&quot; : ksfname};</span>
<span class="nc" id="L1129">                System.err.println(form.format(source));</span>
            }

<span class="nc bnc" id="L1132" title="All 2 branches missed.">            if (token) {</span>
<span class="nc" id="L1133">                keyStore.store(null, null);</span>
            } else {
<span class="nc bnc" id="L1135" title="All 2 branches missed.">                char[] pass = (storePassNew!=null) ? storePassNew : storePass;</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">                if (nullStream) {</span>
<span class="nc" id="L1137">                    keyStore.store(null, pass);</span>
                } else {
<span class="nc" id="L1139">                    ByteArrayOutputStream bout = new ByteArrayOutputStream();</span>
<span class="nc" id="L1140">                    keyStore.store(bout, pass);</span>
<span class="nc" id="L1141">                    try (FileOutputStream fout = new FileOutputStream(ksfname)) {</span>
<span class="nc" id="L1142">                        fout.write(bout.toByteArray());</span>
<span class="nc bnc" id="L1143" title="All 8 branches missed.">                    }</span>
                }
            }
        }
<span class="nc" id="L1147">    }</span>

    /**
     * Generate a certificate: Read PKCS10 request from in, and print
     * certificate to out. Use alias as CA, sigAlgName as the signature
     * type.
     */
    private void doGenCert(String alias, String sigAlgName, InputStream in, PrintStream out)
            throws Exception {


<span class="nc" id="L1158">        Certificate signerCert = keyStore.getCertificate(alias);</span>
<span class="nc" id="L1159">        byte[] encoded = signerCert.getEncoded();</span>
<span class="nc" id="L1160">        X509CertImpl signerCertImpl = new X509CertImpl(encoded);</span>
<span class="nc" id="L1161">        X509CertInfo signerCertInfo = (X509CertInfo)signerCertImpl.get(</span>
                X509CertImpl.NAME + &quot;.&quot; + X509CertImpl.INFO);
<span class="nc" id="L1163">        X500Name issuer = (X500Name)signerCertInfo.get(X509CertInfo.SUBJECT + &quot;.&quot; +</span>
                                           X509CertInfo.DN_NAME);

<span class="nc" id="L1166">        Date firstDate = getStartDate(startDate);</span>
<span class="nc" id="L1167">        Date lastDate = new Date();</span>
<span class="nc" id="L1168">        lastDate.setTime(firstDate.getTime() + validity*1000L*24L*60L*60L);</span>
<span class="nc" id="L1169">        CertificateValidity interval = new CertificateValidity(firstDate,</span>
                                                               lastDate);

<span class="nc" id="L1172">        PrivateKey privateKey =</span>
<span class="nc" id="L1173">                (PrivateKey)recoverKey(alias, storePass, keyPass).fst;</span>
<span class="nc bnc" id="L1174" title="All 2 branches missed.">        if (sigAlgName == null) {</span>
<span class="nc" id="L1175">            sigAlgName = getCompatibleSigAlgName(privateKey.getAlgorithm());</span>
        }
<span class="nc" id="L1177">        Signature signature = Signature.getInstance(sigAlgName);</span>
<span class="nc" id="L1178">        signature.initSign(privateKey);</span>

<span class="nc" id="L1180">        X509CertInfo info = new X509CertInfo();</span>
<span class="nc" id="L1181">        info.set(X509CertInfo.VALIDITY, interval);</span>
<span class="nc" id="L1182">        info.set(X509CertInfo.SERIAL_NUMBER, new CertificateSerialNumber(</span>
<span class="nc" id="L1183">                    new java.util.Random().nextInt() &amp; 0x7fffffff));</span>
<span class="nc" id="L1184">        info.set(X509CertInfo.VERSION,</span>
                    new CertificateVersion(CertificateVersion.V3));
<span class="nc" id="L1186">        info.set(X509CertInfo.ALGORITHM_ID,</span>
                    new CertificateAlgorithmId(
<span class="nc" id="L1188">                        AlgorithmId.get(sigAlgName)));</span>
<span class="nc" id="L1189">        info.set(X509CertInfo.ISSUER, issuer);</span>

<span class="nc" id="L1191">        BufferedReader reader = new BufferedReader(new InputStreamReader(in));</span>
<span class="nc" id="L1192">        boolean canRead = false;</span>
<span class="nc" id="L1193">        StringBuffer sb = new StringBuffer();</span>
        while (true) {
<span class="nc" id="L1195">            String s = reader.readLine();</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">            if (s == null) break;</span>
            // OpenSSL does not use NEW
            //if (s.startsWith(&quot;-----BEGIN NEW CERTIFICATE REQUEST-----&quot;)) {
<span class="nc bnc" id="L1199" title="All 4 branches missed.">            if (s.startsWith(&quot;-----BEGIN&quot;) &amp;&amp; s.indexOf(&quot;REQUEST&quot;) &gt;= 0) {</span>
<span class="nc" id="L1200">                canRead = true;</span>
            //} else if (s.startsWith(&quot;-----END NEW CERTIFICATE REQUEST-----&quot;)) {
<span class="nc bnc" id="L1202" title="All 4 branches missed.">            } else if (s.startsWith(&quot;-----END&quot;) &amp;&amp; s.indexOf(&quot;REQUEST&quot;) &gt;= 0) {</span>
<span class="nc" id="L1203">                break;</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">            } else if (canRead) {</span>
<span class="nc" id="L1205">                sb.append(s);</span>
            }
<span class="nc" id="L1207">        }</span>
<span class="nc" id="L1208">        byte[] rawReq = Base64.getMimeDecoder().decode(new String(sb));</span>
<span class="nc" id="L1209">        PKCS10 req = new PKCS10(rawReq);</span>

<span class="nc" id="L1211">        info.set(X509CertInfo.KEY, new CertificateX509Key(req.getSubjectPublicKeyInfo()));</span>
<span class="nc bnc" id="L1212" title="All 2 branches missed.">        info.set(X509CertInfo.SUBJECT,</span>
<span class="nc" id="L1213">                    dname==null?req.getSubjectName():new X500Name(dname));</span>
<span class="nc" id="L1214">        CertificateExtensions reqex = null;</span>
<span class="nc" id="L1215">        Iterator&lt;PKCS10Attribute&gt; attrs = req.getAttributes().getAttributes().iterator();</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">        while (attrs.hasNext()) {</span>
<span class="nc" id="L1217">            PKCS10Attribute attr = attrs.next();</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">            if (attr.getAttributeId().equals((Object)PKCS9Attribute.EXTENSION_REQUEST_OID)) {</span>
<span class="nc" id="L1219">                reqex = (CertificateExtensions)attr.getAttributeValue();</span>
            }
<span class="nc" id="L1221">        }</span>
<span class="nc" id="L1222">        CertificateExtensions ext = createV3Extensions(</span>
                reqex,
                null,
                v3ext,
<span class="nc" id="L1226">                req.getSubjectPublicKeyInfo(),</span>
<span class="nc" id="L1227">                signerCert.getPublicKey());</span>
<span class="nc" id="L1228">        info.set(X509CertInfo.EXTENSIONS, ext);</span>
<span class="nc" id="L1229">        X509CertImpl cert = new X509CertImpl(info);</span>
<span class="nc" id="L1230">        cert.sign(privateKey, sigAlgName);</span>
<span class="nc" id="L1231">        dumpCert(cert, out);</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">        for (Certificate ca: keyStore.getCertificateChain(alias)) {</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">            if (ca instanceof X509Certificate) {</span>
<span class="nc" id="L1234">                X509Certificate xca = (X509Certificate)ca;</span>
<span class="nc bnc" id="L1235" title="All 2 branches missed.">                if (!isSelfSigned(xca)) {</span>
<span class="nc" id="L1236">                    dumpCert(xca, out);</span>
                }
            }
        }
<span class="nc" id="L1240">    }</span>

    private void doGenCRL(PrintStream out)
            throws Exception {
<span class="nc bnc" id="L1244" title="All 2 branches missed.">        if (ids == null) {</span>
<span class="nc" id="L1245">            throw new Exception(&quot;Must provide -id when -gencrl&quot;);</span>
        }
<span class="nc" id="L1247">        Certificate signerCert = keyStore.getCertificate(alias);</span>
<span class="nc" id="L1248">        byte[] encoded = signerCert.getEncoded();</span>
<span class="nc" id="L1249">        X509CertImpl signerCertImpl = new X509CertImpl(encoded);</span>
<span class="nc" id="L1250">        X509CertInfo signerCertInfo = (X509CertInfo)signerCertImpl.get(</span>
                X509CertImpl.NAME + &quot;.&quot; + X509CertImpl.INFO);
<span class="nc" id="L1252">        X500Name owner = (X500Name)signerCertInfo.get(X509CertInfo.SUBJECT + &quot;.&quot; +</span>
                                                      X509CertInfo.DN_NAME);

<span class="nc" id="L1255">        Date firstDate = getStartDate(startDate);</span>
<span class="nc" id="L1256">        Date lastDate = (Date) firstDate.clone();</span>
<span class="nc" id="L1257">        lastDate.setTime(lastDate.getTime() + validity*1000*24*60*60);</span>
<span class="nc" id="L1258">        CertificateValidity interval = new CertificateValidity(firstDate,</span>
                                                               lastDate);


<span class="nc" id="L1262">        PrivateKey privateKey =</span>
<span class="nc" id="L1263">                (PrivateKey)recoverKey(alias, storePass, keyPass).fst;</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">        if (sigAlgName == null) {</span>
<span class="nc" id="L1265">            sigAlgName = getCompatibleSigAlgName(privateKey.getAlgorithm());</span>
        }

<span class="nc" id="L1268">        X509CRLEntry[] badCerts = new X509CRLEntry[ids.size()];</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">        for (int i=0; i&lt;ids.size(); i++) {</span>
<span class="nc" id="L1270">            String id = ids.get(i);</span>
<span class="nc" id="L1271">            int d = id.indexOf(':');</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">            if (d &gt;= 0) {</span>
<span class="nc" id="L1273">                CRLExtensions ext = new CRLExtensions();</span>
<span class="nc" id="L1274">                ext.set(&quot;Reason&quot;, new CRLReasonCodeExtension(Integer.parseInt(id.substring(d+1))));</span>
<span class="nc" id="L1275">                badCerts[i] = new X509CRLEntryImpl(new BigInteger(id.substring(0, d)),</span>
                        firstDate, ext);
<span class="nc" id="L1277">            } else {</span>
<span class="nc" id="L1278">                badCerts[i] = new X509CRLEntryImpl(new BigInteger(ids.get(i)), firstDate);</span>
            }
        }
<span class="nc" id="L1281">        X509CRLImpl crl = new X509CRLImpl(owner, firstDate, lastDate, badCerts);</span>
<span class="nc" id="L1282">        crl.sign(privateKey, sigAlgName);</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">        if (rfc) {</span>
<span class="nc" id="L1284">            out.println(&quot;-----BEGIN X509 CRL-----&quot;);</span>
<span class="nc" id="L1285">            out.println(Base64.getMimeEncoder().encodeToString(crl.getEncodedInternal()));</span>
<span class="nc" id="L1286">            out.println(&quot;-----END X509 CRL-----&quot;);</span>
        } else {
<span class="nc" id="L1288">            out.write(crl.getEncodedInternal());</span>
        }
<span class="nc" id="L1290">    }</span>

    /**
     * Creates a PKCS#10 cert signing request, corresponding to the
     * keys (and name) associated with a given alias.
     */
    private void doCertReq(String alias, String sigAlgName, PrintStream out)
        throws Exception
    {
<span class="nc bnc" id="L1299" title="All 2 branches missed.">        if (alias == null) {</span>
<span class="nc" id="L1300">            alias = keyAlias;</span>
        }

<span class="nc" id="L1303">        Pair&lt;Key,char[]&gt; objs = recoverKey(alias, storePass, keyPass);</span>
<span class="nc" id="L1304">        PrivateKey privKey = (PrivateKey)objs.fst;</span>
<span class="nc bnc" id="L1305" title="All 2 branches missed.">        if (keyPass == null) {</span>
<span class="nc" id="L1306">            keyPass = objs.snd;</span>
        }

<span class="nc" id="L1309">        Certificate cert = keyStore.getCertificate(alias);</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">        if (cert == null) {</span>
<span class="nc" id="L1311">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1312">                (rb.getString(&quot;alias.has.no.public.key.certificate.&quot;));</span>
<span class="nc" id="L1313">            Object[] source = {alias};</span>
<span class="nc" id="L1314">            throw new Exception(form.format(source));</span>
        }
<span class="nc" id="L1316">        PKCS10 request = new PKCS10(cert.getPublicKey());</span>
<span class="nc" id="L1317">        CertificateExtensions ext = createV3Extensions(null, null, v3ext, cert.getPublicKey(), null);</span>
        // Attribute name is not significant
<span class="nc" id="L1319">        request.getAttributes().setAttribute(X509CertInfo.EXTENSIONS,</span>
                new PKCS10Attribute(PKCS9Attribute.EXTENSION_REQUEST_OID, ext));

        // Construct a Signature object, so that we can sign the request
<span class="nc bnc" id="L1323" title="All 2 branches missed.">        if (sigAlgName == null) {</span>
<span class="nc" id="L1324">            sigAlgName = getCompatibleSigAlgName(privKey.getAlgorithm());</span>
        }

<span class="nc" id="L1327">        Signature signature = Signature.getInstance(sigAlgName);</span>
<span class="nc" id="L1328">        signature.initSign(privKey);</span>
<span class="nc bnc" id="L1329" title="All 2 branches missed.">        X500Name subject = dname == null?</span>
<span class="nc" id="L1330">                new X500Name(((X509Certificate)cert).getSubjectDN().toString()):</span>
                new X500Name(dname);

        // Sign the request and base-64 encode it
<span class="nc" id="L1334">        request.encodeAndSign(subject, signature);</span>
<span class="nc" id="L1335">        request.print(out);</span>
<span class="nc" id="L1336">    }</span>

    /**
     * Deletes an entry from the keystore.
     */
    private void doDeleteEntry(String alias) throws Exception {
<span class="nc bnc" id="L1342" title="All 2 branches missed.">        if (keyStore.containsAlias(alias) == false) {</span>
<span class="nc" id="L1343">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1344">                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</span>
<span class="nc" id="L1345">            Object[] source = {alias};</span>
<span class="nc" id="L1346">            throw new Exception(form.format(source));</span>
        }
<span class="nc" id="L1348">        keyStore.deleteEntry(alias);</span>
<span class="nc" id="L1349">    }</span>

    /**
     * Exports a certificate from the keystore.
     */
    private void doExportCert(String alias, PrintStream out)
        throws Exception
    {
<span class="nc bnc" id="L1357" title="All 2 branches missed.">        if (storePass == null</span>
<span class="nc bnc" id="L1358" title="All 2 branches missed.">                &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype)) {</span>
<span class="nc" id="L1359">            printWarning();</span>
        }
<span class="nc bnc" id="L1361" title="All 2 branches missed.">        if (alias == null) {</span>
<span class="nc" id="L1362">            alias = keyAlias;</span>
        }
<span class="nc bnc" id="L1364" title="All 2 branches missed.">        if (keyStore.containsAlias(alias) == false) {</span>
<span class="nc" id="L1365">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1366">                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</span>
<span class="nc" id="L1367">            Object[] source = {alias};</span>
<span class="nc" id="L1368">            throw new Exception(form.format(source));</span>
        }

<span class="nc" id="L1371">        X509Certificate cert = (X509Certificate)keyStore.getCertificate(alias);</span>
<span class="nc bnc" id="L1372" title="All 2 branches missed.">        if (cert == null) {</span>
<span class="nc" id="L1373">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1374">                (rb.getString(&quot;Alias.alias.has.no.certificate&quot;));</span>
<span class="nc" id="L1375">            Object[] source = {alias};</span>
<span class="nc" id="L1376">            throw new Exception(form.format(source));</span>
        }
<span class="nc" id="L1378">        dumpCert(cert, out);</span>
<span class="nc" id="L1379">    }</span>

    /**
     * Prompt the user for a keypass when generating a key entry.
     * @param alias the entry we will set password for
     * @param orig the original entry of doing a dup, null if generate new
     * @param origPass the password to copy from if user press ENTER
     */
    private char[] promptForKeyPass(String alias, String orig, char[] origPass) throws Exception{
<span class="nc bnc" id="L1388" title="All 2 branches missed.">        if (P12KEYSTORE.equalsIgnoreCase(storetype)) {</span>
<span class="nc" id="L1389">            return origPass;</span>
<span class="nc bnc" id="L1390" title="All 4 branches missed.">        } else if (!token &amp;&amp; !protectedPath) {</span>
            // Prompt for key password
            int count;
<span class="nc bnc" id="L1393" title="All 2 branches missed.">            for (count = 0; count &lt; 3; count++) {</span>
<span class="nc" id="L1394">                MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1395">                        (&quot;Enter.key.password.for.alias.&quot;));</span>
<span class="nc" id="L1396">                Object[] source = {alias};</span>
<span class="nc" id="L1397">                System.err.println(form.format(source));</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">                if (orig == null) {</span>
<span class="nc" id="L1399">                    System.err.print(rb.getString</span>
<span class="nc" id="L1400">                            (&quot;.RETURN.if.same.as.keystore.password.&quot;));</span>
                } else {
<span class="nc" id="L1402">                    form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1403">                            (&quot;.RETURN.if.same.as.for.otherAlias.&quot;));</span>
<span class="nc" id="L1404">                    Object[] src = {orig};</span>
<span class="nc" id="L1405">                    System.err.print(form.format(src));</span>
                }
<span class="nc" id="L1407">                System.err.flush();</span>
<span class="nc" id="L1408">                char[] entered = Password.readPassword(System.in);</span>
<span class="nc" id="L1409">                passwords.add(entered);</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">                if (entered == null) {</span>
<span class="nc" id="L1411">                    return origPass;</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">                } else if (entered.length &gt;= 6) {</span>
<span class="nc" id="L1413">                    System.err.print(rb.getString(&quot;Re.enter.new.password.&quot;));</span>
<span class="nc" id="L1414">                    char[] passAgain = Password.readPassword(System.in);</span>
<span class="nc" id="L1415">                    passwords.add(passAgain);</span>
<span class="nc bnc" id="L1416" title="All 2 branches missed.">                    if (!Arrays.equals(entered, passAgain)) {</span>
<span class="nc" id="L1417">                        System.err.println</span>
<span class="nc" id="L1418">                            (rb.getString(&quot;They.don.t.match.Try.again&quot;));</span>
<span class="nc" id="L1419">                        continue;</span>
                    }
<span class="nc" id="L1421">                    return entered;</span>
                } else {
<span class="nc" id="L1423">                    System.err.println(rb.getString</span>
<span class="nc" id="L1424">                        (&quot;Key.password.is.too.short.must.be.at.least.6.characters&quot;));</span>
                }
            }
<span class="nc bnc" id="L1427" title="All 2 branches missed.">            if (count == 3) {</span>
<span class="nc bnc" id="L1428" title="All 2 branches missed.">                if (command == KEYCLONE) {</span>
<span class="nc" id="L1429">                    throw new Exception(rb.getString</span>
<span class="nc" id="L1430">                        (&quot;Too.many.failures.Key.entry.not.cloned&quot;));</span>
                } else {
<span class="nc" id="L1432">                    throw new Exception(rb.getString</span>
<span class="nc" id="L1433">                            (&quot;Too.many.failures.key.not.added.to.keystore&quot;));</span>
                }
            }
        }
<span class="nc" id="L1437">        return null;    // PKCS11, MSCAPI, or -protected</span>
    }

    /*
     * Prompt the user for the password credential to be stored.
     */
    private char[] promptForCredential() throws Exception {
        // Handle password supplied via stdin
<span class="nc bnc" id="L1445" title="All 2 branches missed.">        if (System.console() == null) {</span>
<span class="nc" id="L1446">            char[] importPass = Password.readPassword(System.in);</span>
<span class="nc" id="L1447">            passwords.add(importPass);</span>
<span class="nc" id="L1448">            return importPass;</span>
        }

        int count;
<span class="nc bnc" id="L1452" title="All 2 branches missed.">        for (count = 0; count &lt; 3; count++) {</span>
<span class="nc" id="L1453">            System.err.print(</span>
<span class="nc" id="L1454">                rb.getString(&quot;Enter.the.password.to.be.stored.&quot;));</span>
<span class="nc" id="L1455">            System.err.flush();</span>
<span class="nc" id="L1456">            char[] entered = Password.readPassword(System.in);</span>
<span class="nc" id="L1457">            passwords.add(entered);</span>
<span class="nc" id="L1458">            System.err.print(rb.getString(&quot;Re.enter.password.&quot;));</span>
<span class="nc" id="L1459">            char[] passAgain = Password.readPassword(System.in);</span>
<span class="nc" id="L1460">            passwords.add(passAgain);</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">            if (!Arrays.equals(entered, passAgain)) {</span>
<span class="nc" id="L1462">                System.err.println(rb.getString(&quot;They.don.t.match.Try.again&quot;));</span>
<span class="nc" id="L1463">                continue;</span>
            }
<span class="nc" id="L1465">            return entered;</span>
        }

<span class="nc bnc" id="L1468" title="All 2 branches missed.">        if (count == 3) {</span>
<span class="nc" id="L1469">            throw new Exception(rb.getString</span>
<span class="nc" id="L1470">                (&quot;Too.many.failures.key.not.added.to.keystore&quot;));</span>
        }

<span class="nc" id="L1473">        return null;</span>
    }

    /**
     * Creates a new secret key.
     */
    private void doGenSecretKey(String alias, String keyAlgName,
                              int keysize)
        throws Exception
    {
<span class="nc bnc" id="L1483" title="All 2 branches missed.">        if (alias == null) {</span>
<span class="nc" id="L1484">            alias = keyAlias;</span>
        }
<span class="nc bnc" id="L1486" title="All 2 branches missed.">        if (keyStore.containsAlias(alias)) {</span>
<span class="nc" id="L1487">            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1488">                (&quot;Secret.key.not.generated.alias.alias.already.exists&quot;));</span>
<span class="nc" id="L1489">            Object[] source = {alias};</span>
<span class="nc" id="L1490">            throw new Exception(form.format(source));</span>
        }

        // Use the keystore's default PBE algorithm for entry protection
<span class="nc" id="L1494">        boolean useDefaultPBEAlgorithm = true;</span>
<span class="nc" id="L1495">        SecretKey secKey = null;</span>

<span class="nc bnc" id="L1497" title="All 2 branches missed.">        if (keyAlgName.toUpperCase().startsWith(&quot;PBE&quot;)) {</span>
<span class="nc" id="L1498">            SecretKeyFactory factory = SecretKeyFactory.getInstance(&quot;PBE&quot;);</span>

            // User is prompted for PBE credential
<span class="nc" id="L1501">            secKey =</span>
<span class="nc" id="L1502">                factory.generateSecret(new PBEKeySpec(promptForCredential()));</span>

            // Check whether a specific PBE algorithm was specified
<span class="nc bnc" id="L1505" title="All 2 branches missed.">            if (!&quot;PBE&quot;.equalsIgnoreCase(keyAlgName)) {</span>
<span class="nc" id="L1506">                useDefaultPBEAlgorithm = false;</span>
            }

<span class="nc bnc" id="L1509" title="All 2 branches missed.">            if (verbose) {</span>
<span class="nc" id="L1510">                MessageFormat form = new MessageFormat(rb.getString(</span>
                    &quot;Generated.keyAlgName.secret.key&quot;));
<span class="nc bnc" id="L1512" title="All 2 branches missed.">                Object[] source =</span>
<span class="nc" id="L1513">                    {useDefaultPBEAlgorithm ? &quot;PBE&quot; : secKey.getAlgorithm()};</span>
<span class="nc" id="L1514">                System.err.println(form.format(source));</span>
            }
<span class="nc" id="L1516">        } else {</span>
<span class="nc" id="L1517">            KeyGenerator keygen = KeyGenerator.getInstance(keyAlgName);</span>
<span class="nc bnc" id="L1518" title="All 2 branches missed.">            if (keysize == -1) {</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">                if (&quot;DES&quot;.equalsIgnoreCase(keyAlgName)) {</span>
<span class="nc" id="L1520">                    keysize = 56;</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">                } else if (&quot;DESede&quot;.equalsIgnoreCase(keyAlgName)) {</span>
<span class="nc" id="L1522">                    keysize = 168;</span>
                } else {
<span class="nc" id="L1524">                    throw new Exception(rb.getString</span>
<span class="nc" id="L1525">                        (&quot;Please.provide.keysize.for.secret.key.generation&quot;));</span>
                }
            }
<span class="nc" id="L1528">            keygen.init(keysize);</span>
<span class="nc" id="L1529">            secKey = keygen.generateKey();</span>

<span class="nc bnc" id="L1531" title="All 2 branches missed.">            if (verbose) {</span>
<span class="nc" id="L1532">                MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1533">                    (&quot;Generated.keysize.bit.keyAlgName.secret.key&quot;));</span>
<span class="nc" id="L1534">                Object[] source = {new Integer(keysize),</span>
<span class="nc" id="L1535">                                    secKey.getAlgorithm()};</span>
<span class="nc" id="L1536">                System.err.println(form.format(source));</span>
            }
        }

<span class="nc bnc" id="L1540" title="All 2 branches missed.">        if (keyPass == null) {</span>
<span class="nc" id="L1541">            keyPass = promptForKeyPass(alias, null, storePass);</span>
        }

<span class="nc bnc" id="L1544" title="All 2 branches missed.">        if (useDefaultPBEAlgorithm) {</span>
<span class="nc" id="L1545">            keyStore.setKeyEntry(alias, secKey, keyPass, null);</span>
        } else {
<span class="nc" id="L1547">            keyStore.setEntry(alias, new KeyStore.SecretKeyEntry(secKey),</span>
                new KeyStore.PasswordProtection(keyPass, keyAlgName, null));
        }
<span class="nc" id="L1550">    }</span>

    /**
     * If no signature algorithm was specified at the command line,
     * we choose one that is compatible with the selected private key
     */
    private static String getCompatibleSigAlgName(String keyAlgName)
            throws Exception {
<span class="nc bnc" id="L1558" title="All 2 branches missed.">        if (&quot;DSA&quot;.equalsIgnoreCase(keyAlgName)) {</span>
<span class="nc" id="L1559">            return &quot;SHA1WithDSA&quot;;</span>
<span class="nc bnc" id="L1560" title="All 2 branches missed.">        } else if (&quot;RSA&quot;.equalsIgnoreCase(keyAlgName)) {</span>
<span class="nc" id="L1561">            return &quot;SHA256WithRSA&quot;;</span>
<span class="nc bnc" id="L1562" title="All 2 branches missed.">        } else if (&quot;EC&quot;.equalsIgnoreCase(keyAlgName)) {</span>
<span class="nc" id="L1563">            return &quot;SHA256withECDSA&quot;;</span>
        } else {
<span class="nc" id="L1565">            throw new Exception(rb.getString</span>
<span class="nc" id="L1566">                    (&quot;Cannot.derive.signature.algorithm&quot;));</span>
        }
    }
    /**
     * Creates a new key pair and self-signed certificate.
     */
    private void doGenKeyPair(String alias, String dname, String keyAlgName,
                              int keysize, String sigAlgName)
        throws Exception
    {
<span class="nc bnc" id="L1576" title="All 2 branches missed.">        if (keysize == -1) {</span>
<span class="nc bnc" id="L1577" title="All 2 branches missed.">            if (&quot;EC&quot;.equalsIgnoreCase(keyAlgName)) {</span>
<span class="nc" id="L1578">                keysize = 256;</span>
<span class="nc bnc" id="L1579" title="All 2 branches missed.">            } else if (&quot;RSA&quot;.equalsIgnoreCase(keyAlgName)) {</span>
<span class="nc" id="L1580">                keysize = 2048;</span>
            } else {
<span class="nc" id="L1582">                keysize = 1024;</span>
            }
        }

<span class="nc bnc" id="L1586" title="All 2 branches missed.">        if (alias == null) {</span>
<span class="nc" id="L1587">            alias = keyAlias;</span>
        }

<span class="nc bnc" id="L1590" title="All 2 branches missed.">        if (keyStore.containsAlias(alias)) {</span>
<span class="nc" id="L1591">            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1592">                (&quot;Key.pair.not.generated.alias.alias.already.exists&quot;));</span>
<span class="nc" id="L1593">            Object[] source = {alias};</span>
<span class="nc" id="L1594">            throw new Exception(form.format(source));</span>
        }

<span class="nc bnc" id="L1597" title="All 2 branches missed.">        if (sigAlgName == null) {</span>
<span class="nc" id="L1598">            sigAlgName = getCompatibleSigAlgName(keyAlgName);</span>
        }
<span class="nc" id="L1600">        CertAndKeyGen keypair =</span>
                new CertAndKeyGen(keyAlgName, sigAlgName, providerName);


        // If DN is provided, parse it. Otherwise, prompt the user for it.
        X500Name x500Name;
<span class="nc bnc" id="L1606" title="All 2 branches missed.">        if (dname == null) {</span>
<span class="nc" id="L1607">            x500Name = getX500Name();</span>
        } else {
<span class="nc" id="L1609">            x500Name = new X500Name(dname);</span>
        }

<span class="nc" id="L1612">        keypair.generate(keysize);</span>
<span class="nc" id="L1613">        PrivateKey privKey = keypair.getPrivateKey();</span>

<span class="nc" id="L1615">        CertificateExtensions ext = createV3Extensions(</span>
                null,
                null,
                v3ext,
<span class="nc" id="L1619">                keypair.getPublicKeyAnyway(),</span>
                null);

<span class="nc" id="L1622">        X509Certificate[] chain = new X509Certificate[1];</span>
<span class="nc" id="L1623">        chain[0] = keypair.getSelfCertificate(</span>
<span class="nc" id="L1624">                x500Name, getStartDate(startDate), validity*24L*60L*60L, ext);</span>

<span class="nc bnc" id="L1626" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L1627">            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1628">                (&quot;Generating.keysize.bit.keyAlgName.key.pair.and.self.signed.certificate.sigAlgName.with.a.validity.of.validality.days.for&quot;));</span>
<span class="nc" id="L1629">            Object[] source = {new Integer(keysize),</span>
<span class="nc" id="L1630">                                privKey.getAlgorithm(),</span>
<span class="nc" id="L1631">                                chain[0].getSigAlgName(),</span>
                                new Long(validity),
                                x500Name};
<span class="nc" id="L1634">            System.err.println(form.format(source));</span>
        }

<span class="nc bnc" id="L1637" title="All 2 branches missed.">        if (keyPass == null) {</span>
<span class="nc" id="L1638">            keyPass = promptForKeyPass(alias, null, storePass);</span>
        }
<span class="nc" id="L1640">        keyStore.setKeyEntry(alias, privKey, keyPass, chain);</span>
<span class="nc" id="L1641">    }</span>

    /**
     * Clones an entry
     * @param orig original alias
     * @param dest destination alias
     * @changePassword if the password can be changed
     */
    private void doCloneEntry(String orig, String dest, boolean changePassword)
        throws Exception
    {
<span class="nc bnc" id="L1652" title="All 2 branches missed.">        if (orig == null) {</span>
<span class="nc" id="L1653">            orig = keyAlias;</span>
        }

<span class="nc bnc" id="L1656" title="All 2 branches missed.">        if (keyStore.containsAlias(dest)) {</span>
<span class="nc" id="L1657">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1658">                (rb.getString(&quot;Destination.alias.dest.already.exists&quot;));</span>
<span class="nc" id="L1659">            Object[] source = {dest};</span>
<span class="nc" id="L1660">            throw new Exception(form.format(source));</span>
        }

<span class="nc" id="L1663">        Pair&lt;Entry,char[]&gt; objs = recoverEntry(keyStore, orig, storePass, keyPass);</span>
<span class="nc" id="L1664">        Entry entry = objs.fst;</span>
<span class="nc" id="L1665">        keyPass = objs.snd;</span>

<span class="nc" id="L1667">        PasswordProtection pp = null;</span>

<span class="nc bnc" id="L1669" title="All 2 branches missed.">        if (keyPass != null) {  // protected</span>
<span class="nc bnc" id="L1670" title="All 4 branches missed.">            if (!changePassword || P12KEYSTORE.equalsIgnoreCase(storetype)) {</span>
<span class="nc" id="L1671">                keyPassNew = keyPass;</span>
            } else {
<span class="nc bnc" id="L1673" title="All 2 branches missed.">                if (keyPassNew == null) {</span>
<span class="nc" id="L1674">                    keyPassNew = promptForKeyPass(dest, orig, keyPass);</span>
                }
            }
<span class="nc" id="L1677">            pp = new PasswordProtection(keyPassNew);</span>
        }
<span class="nc" id="L1679">        keyStore.setEntry(dest, entry, pp);</span>
<span class="nc" id="L1680">    }</span>

    /**
     * Changes a key password.
     */
    private void doChangeKeyPasswd(String alias) throws Exception
    {

<span class="nc bnc" id="L1688" title="All 2 branches missed.">        if (alias == null) {</span>
<span class="nc" id="L1689">            alias = keyAlias;</span>
        }
<span class="nc" id="L1691">        Pair&lt;Key,char[]&gt; objs = recoverKey(alias, storePass, keyPass);</span>
<span class="nc" id="L1692">        Key privKey = objs.fst;</span>
<span class="nc bnc" id="L1693" title="All 2 branches missed.">        if (keyPass == null) {</span>
<span class="nc" id="L1694">            keyPass = objs.snd;</span>
        }

<span class="nc bnc" id="L1697" title="All 2 branches missed.">        if (keyPassNew == null) {</span>
<span class="nc" id="L1698">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1699">                (rb.getString(&quot;key.password.for.alias.&quot;));</span>
<span class="nc" id="L1700">            Object[] source = {alias};</span>
<span class="nc" id="L1701">            keyPassNew = getNewPasswd(form.format(source), keyPass);</span>
        }
<span class="nc" id="L1703">        keyStore.setKeyEntry(alias, privKey, keyPassNew,</span>
<span class="nc" id="L1704">                             keyStore.getCertificateChain(alias));</span>
<span class="nc" id="L1705">    }</span>

    /**
     * Imports a JDK 1.1-style identity database. We can only store one
     * certificate per identity, because we use the identity's name as the
     * alias (which references a keystore entry), and aliases must be unique.
     */
    private void doImportIdentityDatabase(InputStream in)
        throws Exception
    {
<span class="nc" id="L1715">        System.err.println(rb.getString</span>
<span class="nc" id="L1716">            (&quot;No.entries.from.identity.database.added&quot;));</span>
<span class="nc" id="L1717">    }</span>

    /**
     * Prints a single keystore entry.
     */
    private void doPrintEntry(String alias, PrintStream out,
                              boolean printWarning)
        throws Exception
    {
<span class="nc bnc" id="L1726" title="All 4 branches missed.">        if (storePass == null &amp;&amp; printWarning</span>
<span class="nc bnc" id="L1727" title="All 2 branches missed.">                &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype)) {</span>
<span class="nc" id="L1728">            printWarning();</span>
        }

<span class="nc bnc" id="L1731" title="All 2 branches missed.">        if (keyStore.containsAlias(alias) == false) {</span>
<span class="nc" id="L1732">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1733">                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</span>
<span class="nc" id="L1734">            Object[] source = {alias};</span>
<span class="nc" id="L1735">            throw new Exception(form.format(source));</span>
        }

<span class="nc bnc" id="L1738" title="All 6 branches missed.">        if (verbose || rfc || debug) {</span>
<span class="nc" id="L1739">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1740">                (rb.getString(&quot;Alias.name.alias&quot;));</span>
<span class="nc" id="L1741">            Object[] source = {alias};</span>
<span class="nc" id="L1742">            out.println(form.format(source));</span>

<span class="nc bnc" id="L1744" title="All 2 branches missed.">            if (!token) {</span>
<span class="nc" id="L1745">                form = new MessageFormat(rb.getString</span>
<span class="nc" id="L1746">                    (&quot;Creation.date.keyStore.getCreationDate.alias.&quot;));</span>
<span class="nc" id="L1747">                Object[] src = {keyStore.getCreationDate(alias)};</span>
<span class="nc" id="L1748">                out.println(form.format(src));</span>
            }
<span class="nc" id="L1750">        } else {</span>
<span class="nc bnc" id="L1751" title="All 2 branches missed.">            if (!token) {</span>
<span class="nc" id="L1752">                MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1753">                    (rb.getString(&quot;alias.keyStore.getCreationDate.alias.&quot;));</span>
<span class="nc" id="L1754">                Object[] source = {alias, keyStore.getCreationDate(alias)};</span>
<span class="nc" id="L1755">                out.print(form.format(source));</span>
<span class="nc" id="L1756">            } else {</span>
<span class="nc" id="L1757">                MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1758">                    (rb.getString(&quot;alias.&quot;));</span>
<span class="nc" id="L1759">                Object[] source = {alias};</span>
<span class="nc" id="L1760">                out.print(form.format(source));</span>
            }
        }

<span class="nc bnc" id="L1764" title="All 2 branches missed.">        if (keyStore.entryInstanceOf(alias, KeyStore.SecretKeyEntry.class)) {</span>
<span class="nc bnc" id="L1765" title="All 6 branches missed.">            if (verbose || rfc || debug) {</span>
<span class="nc" id="L1766">                Object[] source = {&quot;SecretKeyEntry&quot;};</span>
<span class="nc" id="L1767">                out.println(new MessageFormat(</span>
<span class="nc" id="L1768">                        rb.getString(&quot;Entry.type.type.&quot;)).format(source));</span>
<span class="nc" id="L1769">            } else {</span>
<span class="nc" id="L1770">                out.println(&quot;SecretKeyEntry, &quot;);</span>
            }
<span class="nc bnc" id="L1772" title="All 2 branches missed.">        } else if (keyStore.entryInstanceOf(alias, KeyStore.PrivateKeyEntry.class)) {</span>
<span class="nc bnc" id="L1773" title="All 6 branches missed.">            if (verbose || rfc || debug) {</span>
<span class="nc" id="L1774">                Object[] source = {&quot;PrivateKeyEntry&quot;};</span>
<span class="nc" id="L1775">                out.println(new MessageFormat(</span>
<span class="nc" id="L1776">                        rb.getString(&quot;Entry.type.type.&quot;)).format(source));</span>
<span class="nc" id="L1777">            } else {</span>
<span class="nc" id="L1778">                out.println(&quot;PrivateKeyEntry, &quot;);</span>
            }

            // Get the chain
<span class="nc" id="L1782">            Certificate[] chain = keyStore.getCertificateChain(alias);</span>
<span class="nc bnc" id="L1783" title="All 2 branches missed.">            if (chain != null) {</span>
<span class="nc bnc" id="L1784" title="All 6 branches missed.">                if (verbose || rfc || debug) {</span>
<span class="nc" id="L1785">                    out.println(rb.getString</span>
<span class="nc" id="L1786">                        (&quot;Certificate.chain.length.&quot;) + chain.length);</span>
<span class="nc bnc" id="L1787" title="All 2 branches missed.">                    for (int i = 0; i &lt; chain.length; i ++) {</span>
<span class="nc" id="L1788">                        MessageFormat form = new MessageFormat</span>
<span class="nc" id="L1789">                                (rb.getString(&quot;Certificate.i.1.&quot;));</span>
<span class="nc" id="L1790">                        Object[] source = {new Integer((i + 1))};</span>
<span class="nc" id="L1791">                        out.println(form.format(source));</span>
<span class="nc bnc" id="L1792" title="All 4 branches missed.">                        if (verbose &amp;&amp; (chain[i] instanceof X509Certificate)) {</span>
<span class="nc" id="L1793">                            printX509Cert((X509Certificate)(chain[i]), out);</span>
<span class="nc bnc" id="L1794" title="All 2 branches missed.">                        } else if (debug) {</span>
<span class="nc" id="L1795">                            out.println(chain[i].toString());</span>
                        } else {
<span class="nc" id="L1797">                            dumpCert(chain[i], out);</span>
                        }
                    }
                } else {
                    // Print the digest of the user cert only
<span class="nc" id="L1802">                    out.println</span>
<span class="nc" id="L1803">                        (rb.getString(&quot;Certificate.fingerprint.SHA1.&quot;) +</span>
<span class="nc" id="L1804">                        getCertFingerPrint(&quot;SHA1&quot;, chain[0]));</span>
                }
            }
<span class="nc bnc" id="L1807" title="All 2 branches missed.">        } else if (keyStore.entryInstanceOf(alias,</span>
                KeyStore.TrustedCertificateEntry.class)) {
            // We have a trusted certificate entry
<span class="nc" id="L1810">            Certificate cert = keyStore.getCertificate(alias);</span>
<span class="nc" id="L1811">            Object[] source = {&quot;trustedCertEntry&quot;};</span>
<span class="nc" id="L1812">            String mf = new MessageFormat(</span>
<span class="nc" id="L1813">                    rb.getString(&quot;Entry.type.type.&quot;)).format(source) + &quot;\n&quot;;</span>
<span class="nc bnc" id="L1814" title="All 4 branches missed.">            if (verbose &amp;&amp; (cert instanceof X509Certificate)) {</span>
<span class="nc" id="L1815">                out.println(mf);</span>
<span class="nc" id="L1816">                printX509Cert((X509Certificate)cert, out);</span>
<span class="nc bnc" id="L1817" title="All 2 branches missed.">            } else if (rfc) {</span>
<span class="nc" id="L1818">                out.println(mf);</span>
<span class="nc" id="L1819">                dumpCert(cert, out);</span>
<span class="nc bnc" id="L1820" title="All 2 branches missed.">            } else if (debug) {</span>
<span class="nc" id="L1821">                out.println(cert.toString());</span>
            } else {
<span class="nc" id="L1823">                out.println(&quot;trustedCertEntry, &quot;);</span>
<span class="nc" id="L1824">                out.println(rb.getString(&quot;Certificate.fingerprint.SHA1.&quot;)</span>
<span class="nc" id="L1825">                            + getCertFingerPrint(&quot;SHA1&quot;, cert));</span>
            }
<span class="nc" id="L1827">        } else {</span>
<span class="nc" id="L1828">            out.println(rb.getString(&quot;Unknown.Entry.Type&quot;));</span>
        }
<span class="nc" id="L1830">    }</span>

    /**
     * Load the srckeystore from a stream, used in -importkeystore
     * @returns the src KeyStore
     */
    KeyStore loadSourceKeyStore() throws Exception {
<span class="nc" id="L1837">        boolean isPkcs11 = false;</span>

<span class="nc" id="L1839">        InputStream is = null;</span>

<span class="nc bnc" id="L1841" title="All 2 branches missed.">        if (P11KEYSTORE.equalsIgnoreCase(srcstoretype) ||</span>
<span class="nc bnc" id="L1842" title="All 2 branches missed.">                KeyStoreUtil.isWindowsKeyStore(srcstoretype)) {</span>
<span class="nc bnc" id="L1843" title="All 2 branches missed.">            if (!NONE.equals(srcksfname)) {</span>
<span class="nc" id="L1844">                System.err.println(MessageFormat.format(rb.getString</span>
<span class="nc" id="L1845">                    (&quot;.keystore.must.be.NONE.if.storetype.is.{0}&quot;), srcstoretype));</span>
<span class="nc" id="L1846">                System.err.println();</span>
<span class="nc" id="L1847">                tinyHelp();</span>
            }
<span class="nc" id="L1849">            isPkcs11 = true;</span>
        } else {
<span class="nc bnc" id="L1851" title="All 2 branches missed.">            if (srcksfname != null) {</span>
<span class="nc" id="L1852">                File srcksfile = new File(srcksfname);</span>
<span class="nc bnc" id="L1853" title="All 4 branches missed.">                    if (srcksfile.exists() &amp;&amp; srcksfile.length() == 0) {</span>
<span class="nc" id="L1854">                        throw new Exception(rb.getString</span>
<span class="nc" id="L1855">                                (&quot;Source.keystore.file.exists.but.is.empty.&quot;) +</span>
                                srcksfname);
                }
<span class="nc" id="L1858">                is = new FileInputStream(srcksfile);</span>
<span class="nc" id="L1859">            } else {</span>
<span class="nc" id="L1860">                throw new Exception(rb.getString</span>
<span class="nc" id="L1861">                        (&quot;Please.specify.srckeystore&quot;));</span>
            }
        }

        KeyStore store;
        try {
<span class="nc bnc" id="L1867" title="All 2 branches missed.">            if (srcProviderName == null) {</span>
<span class="nc" id="L1868">                store = KeyStore.getInstance(srcstoretype);</span>
            } else {
<span class="nc" id="L1870">                store = KeyStore.getInstance(srcstoretype, srcProviderName);</span>
            }

<span class="nc bnc" id="L1873" title="All 4 branches missed.">            if (srcstorePass == null</span>
                    &amp;&amp; !srcprotectedPath
<span class="nc bnc" id="L1875" title="All 2 branches missed.">                    &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(srcstoretype)) {</span>
<span class="nc" id="L1876">                System.err.print(rb.getString(&quot;Enter.source.keystore.password.&quot;));</span>
<span class="nc" id="L1877">                System.err.flush();</span>
<span class="nc" id="L1878">                srcstorePass = Password.readPassword(System.in);</span>
<span class="nc" id="L1879">                passwords.add(srcstorePass);</span>
            }

            // always let keypass be storepass when using pkcs12
<span class="nc bnc" id="L1883" title="All 2 branches missed.">            if (P12KEYSTORE.equalsIgnoreCase(srcstoretype)) {</span>
<span class="nc bnc" id="L1884" title="All 4 branches missed.">                if (srckeyPass != null &amp;&amp; srcstorePass != null &amp;&amp;</span>
<span class="nc bnc" id="L1885" title="All 2 branches missed.">                        !Arrays.equals(srcstorePass, srckeyPass)) {</span>
<span class="nc" id="L1886">                    MessageFormat form = new MessageFormat(rb.getString(</span>
                        &quot;Warning.Different.store.and.key.passwords.not.supported.for.PKCS12.KeyStores.Ignoring.user.specified.command.value.&quot;));
<span class="nc" id="L1888">                    Object[] source = {&quot;-srckeypass&quot;};</span>
<span class="nc" id="L1889">                    System.err.println(form.format(source));</span>
<span class="nc" id="L1890">                    srckeyPass = srcstorePass;</span>
                }
            }

<span class="nc" id="L1894">            store.load(is, srcstorePass);   // &quot;is&quot; already null in PKCS11</span>
        } finally {
<span class="nc bnc" id="L1896" title="All 4 branches missed.">            if (is != null) {</span>
<span class="nc" id="L1897">                is.close();</span>
            }
        }

<span class="nc bnc" id="L1901" title="All 2 branches missed.">        if (srcstorePass == null</span>
<span class="nc bnc" id="L1902" title="All 2 branches missed.">                &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(srcstoretype)) {</span>
            // anti refactoring, copied from printWarning(),
            // but change 2 lines
<span class="nc" id="L1905">            System.err.println();</span>
<span class="nc" id="L1906">            System.err.println(rb.getString</span>
<span class="nc" id="L1907">                (&quot;.WARNING.WARNING.WARNING.&quot;));</span>
<span class="nc" id="L1908">            System.err.println(rb.getString</span>
<span class="nc" id="L1909">                (&quot;.The.integrity.of.the.information.stored.in.the.srckeystore.&quot;));</span>
<span class="nc" id="L1910">            System.err.println(rb.getString</span>
<span class="nc" id="L1911">                (&quot;.WARNING.WARNING.WARNING.&quot;));</span>
<span class="nc" id="L1912">            System.err.println();</span>
        }

<span class="nc" id="L1915">        return store;</span>
    }

    /**
     * import all keys and certs from importkeystore.
     * keep alias unchanged if no name conflict, otherwise, prompt.
     * keep keypass unchanged for keys
     */
    private void doImportKeyStore() throws Exception {

<span class="nc bnc" id="L1925" title="All 2 branches missed.">        if (alias != null) {</span>
<span class="nc" id="L1926">            doImportKeyStoreSingle(loadSourceKeyStore(), alias);</span>
        } else {
<span class="nc bnc" id="L1928" title="All 4 branches missed.">            if (dest != null || srckeyPass != null) {</span>
<span class="nc" id="L1929">                throw new Exception(rb.getString(</span>
                        &quot;if.alias.not.specified.destalias.and.srckeypass.must.not.be.specified&quot;));
            }
<span class="nc" id="L1932">            doImportKeyStoreAll(loadSourceKeyStore());</span>
        }
        /*
         * Information display rule of -importkeystore
         * 1. inside single, shows failure
         * 2. inside all, shows sucess
         * 3. inside all where there is a failure, prompt for continue
         * 4. at the final of all, shows summary
         */
<span class="nc" id="L1941">    }</span>

    /**
     * Import a single entry named alias from srckeystore
     * @returns 1 if the import action succeed
     *          0 if user choose to ignore an alias-dumplicated entry
     *          2 if setEntry throws Exception
     */
    private int doImportKeyStoreSingle(KeyStore srckeystore, String alias)
            throws Exception {

<span class="nc bnc" id="L1952" title="All 2 branches missed.">        String newAlias = (dest==null) ? alias : dest;</span>

<span class="nc bnc" id="L1954" title="All 2 branches missed.">        if (keyStore.containsAlias(newAlias)) {</span>
<span class="nc" id="L1955">            Object[] source = {alias};</span>
<span class="nc bnc" id="L1956" title="All 2 branches missed.">            if (noprompt) {</span>
<span class="nc" id="L1957">                System.err.println(new MessageFormat(rb.getString(</span>
<span class="nc" id="L1958">                        &quot;Warning.Overwriting.existing.alias.alias.in.destination.keystore&quot;)).format(source));</span>
            } else {
<span class="nc" id="L1960">                String reply = getYesNoReply(new MessageFormat(rb.getString(</span>
<span class="nc" id="L1961">                        &quot;Existing.entry.alias.alias.exists.overwrite.no.&quot;)).format(source));</span>
<span class="nc bnc" id="L1962" title="All 2 branches missed.">                if (&quot;NO&quot;.equals(reply)) {</span>
<span class="nc" id="L1963">                    newAlias = inputStringFromStdin(rb.getString</span>
<span class="nc" id="L1964">                            (&quot;Enter.new.alias.name.RETURN.to.cancel.import.for.this.entry.&quot;));</span>
<span class="nc bnc" id="L1965" title="All 2 branches missed.">                    if (&quot;&quot;.equals(newAlias)) {</span>
<span class="nc" id="L1966">                        System.err.println(new MessageFormat(rb.getString(</span>
<span class="nc" id="L1967">                                &quot;Entry.for.alias.alias.not.imported.&quot;)).format(</span>
                                source));
<span class="nc" id="L1969">                        return 0;</span>
                    }
                }
            }
        }

<span class="nc" id="L1975">        Pair&lt;Entry,char[]&gt; objs = recoverEntry(srckeystore, alias, srcstorePass, srckeyPass);</span>
<span class="nc" id="L1976">        Entry entry = objs.fst;</span>

<span class="nc" id="L1978">        PasswordProtection pp = null;</span>

        // According to keytool.html, &quot;The destination entry will be protected
        // using destkeypass. If destkeypass is not provided, the destination
        // entry will be protected with the source entry password.&quot;
        // so always try to protect with destKeyPass.
<span class="nc" id="L1984">        char[] newPass = null;</span>
<span class="nc bnc" id="L1985" title="All 2 branches missed.">        if (destKeyPass != null) {</span>
<span class="nc" id="L1986">            newPass = destKeyPass;</span>
<span class="nc" id="L1987">            pp = new PasswordProtection(destKeyPass);</span>
<span class="nc bnc" id="L1988" title="All 2 branches missed.">        } else if (objs.snd != null) {</span>
<span class="nc" id="L1989">            newPass = objs.snd;</span>
<span class="nc" id="L1990">            pp = new PasswordProtection(objs.snd);</span>
        }

        try {
<span class="nc" id="L1994">            keyStore.setEntry(newAlias, entry, pp);</span>
            // Place the check so that only successful imports are blocked.
            // For example, we don't block a failed SecretEntry import.
<span class="nc bnc" id="L1997" title="All 2 branches missed.">            if (P12KEYSTORE.equalsIgnoreCase(storetype)) {</span>
<span class="nc bnc" id="L1998" title="All 4 branches missed.">                if (newPass != null &amp;&amp; !Arrays.equals(newPass, storePass)) {</span>
<span class="nc" id="L1999">                    throw new Exception(rb.getString(</span>
                            &quot;The.destination.pkcs12.keystore.has.different.storepass.and.keypass.Please.retry.with.destkeypass.specified.&quot;));
                }
            }
<span class="nc" id="L2003">            return 1;</span>
<span class="nc" id="L2004">        } catch (KeyStoreException kse) {</span>
<span class="nc" id="L2005">            Object[] source2 = {alias, kse.toString()};</span>
<span class="nc" id="L2006">            MessageFormat form = new MessageFormat(rb.getString(</span>
                    &quot;Problem.importing.entry.for.alias.alias.exception.Entry.for.alias.alias.not.imported.&quot;));
<span class="nc" id="L2008">            System.err.println(form.format(source2));</span>
<span class="nc" id="L2009">            return 2;</span>
        }
    }

    private void doImportKeyStoreAll(KeyStore srckeystore) throws Exception {

<span class="nc" id="L2015">        int ok = 0;</span>
<span class="nc" id="L2016">        int count = srckeystore.size();</span>
<span class="nc" id="L2017">        for (Enumeration&lt;String&gt; e = srckeystore.aliases();</span>
<span class="nc bnc" id="L2018" title="All 2 branches missed.">                                        e.hasMoreElements(); ) {</span>
<span class="nc" id="L2019">            String alias = e.nextElement();</span>
<span class="nc" id="L2020">            int result = doImportKeyStoreSingle(srckeystore, alias);</span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">            if (result == 1) {</span>
<span class="nc" id="L2022">                ok++;</span>
<span class="nc" id="L2023">                Object[] source = {alias};</span>
<span class="nc" id="L2024">                MessageFormat form = new MessageFormat(rb.getString(&quot;Entry.for.alias.alias.successfully.imported.&quot;));</span>
<span class="nc" id="L2025">                System.err.println(form.format(source));</span>
<span class="nc bnc" id="L2026" title="All 2 branches missed.">            } else if (result == 2) {</span>
<span class="nc bnc" id="L2027" title="All 2 branches missed.">                if (!noprompt) {</span>
<span class="nc" id="L2028">                    String reply = getYesNoReply(&quot;Do you want to quit the import process? [no]:  &quot;);</span>
<span class="nc bnc" id="L2029" title="All 2 branches missed.">                    if (&quot;YES&quot;.equals(reply)) {</span>
<span class="nc" id="L2030">                        break;</span>
                    }
                }
            }
<span class="nc" id="L2034">        }</span>
<span class="nc" id="L2035">        Object[] source = {ok, count-ok};</span>
<span class="nc" id="L2036">        MessageFormat form = new MessageFormat(rb.getString(</span>
                &quot;Import.command.completed.ok.entries.successfully.imported.fail.entries.failed.or.cancelled&quot;));
<span class="nc" id="L2038">        System.err.println(form.format(source));</span>
<span class="nc" id="L2039">    }</span>

    /**
     * Prints all keystore entries.
     */
    private void doPrintEntries(PrintStream out)
        throws Exception
    {
<span class="nc bnc" id="L2047" title="All 2 branches missed.">        if (storePass == null</span>
<span class="nc bnc" id="L2048" title="All 2 branches missed.">                &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype)) {</span>
<span class="nc" id="L2049">            printWarning();</span>
        } else {
<span class="nc" id="L2051">            out.println();</span>
        }

<span class="nc" id="L2054">        out.println(rb.getString(&quot;Keystore.type.&quot;) + keyStore.getType());</span>
<span class="nc" id="L2055">        out.println(rb.getString(&quot;Keystore.provider.&quot;) +</span>
<span class="nc" id="L2056">                keyStore.getProvider().getName());</span>
<span class="nc" id="L2057">        out.println();</span>

        MessageFormat form;
<span class="nc bnc" id="L2060" title="All 2 branches missed.">        form = (keyStore.size() == 1) ?</span>
                new MessageFormat(rb.getString
<span class="nc" id="L2062">                        (&quot;Your.keystore.contains.keyStore.size.entry&quot;)) :</span>
                new MessageFormat(rb.getString
<span class="nc" id="L2064">                        (&quot;Your.keystore.contains.keyStore.size.entries&quot;));</span>
<span class="nc" id="L2065">        Object[] source = {new Integer(keyStore.size())};</span>
<span class="nc" id="L2066">        out.println(form.format(source));</span>
<span class="nc" id="L2067">        out.println();</span>

<span class="nc" id="L2069">        for (Enumeration&lt;String&gt; e = keyStore.aliases();</span>
<span class="nc bnc" id="L2070" title="All 2 branches missed.">                                        e.hasMoreElements(); ) {</span>
<span class="nc" id="L2071">            String alias = e.nextElement();</span>
<span class="nc" id="L2072">            doPrintEntry(alias, out, false);</span>
<span class="nc bnc" id="L2073" title="All 4 branches missed.">            if (verbose || rfc) {</span>
<span class="nc" id="L2074">                out.println(rb.getString(&quot;NEWLINE&quot;));</span>
<span class="nc" id="L2075">                out.println(rb.getString</span>
<span class="nc" id="L2076">                        (&quot;STAR&quot;));</span>
<span class="nc" id="L2077">                out.println(rb.getString</span>
<span class="nc" id="L2078">                        (&quot;STARNN&quot;));</span>
            }
<span class="nc" id="L2080">        }</span>
<span class="nc" id="L2081">    }</span>

    private static &lt;T&gt; Iterable&lt;T&gt; e2i(final Enumeration&lt;T&gt; e) {
<span class="nc" id="L2084">        return new Iterable&lt;T&gt;() {</span>
            @Override
            public Iterator&lt;T&gt; iterator() {
<span class="nc" id="L2087">                return new Iterator&lt;T&gt;() {</span>
                    @Override
                    public boolean hasNext() {
<span class="nc" id="L2090">                        return e.hasMoreElements();</span>
                    }
                    @Override
                    public T next() {
<span class="nc" id="L2094">                        return e.nextElement();</span>
                    }
                    public void remove() {
<span class="nc" id="L2097">                        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);</span>
                    }
                };
            }
        };
    }

    /**
     * Loads CRLs from a source. This method is also called in JarSigner.
     * @param src the source, which means System.in if null, or a URI,
     *        or a bare file path name
     */
    public static Collection&lt;? extends CRL&gt; loadCRLs(String src) throws Exception {
<span class="nc" id="L2110">        InputStream in = null;</span>
<span class="nc" id="L2111">        URI uri = null;</span>
<span class="nc bnc" id="L2112" title="All 2 branches missed.">        if (src == null) {</span>
<span class="nc" id="L2113">            in = System.in;</span>
        } else {
            try {
<span class="nc" id="L2116">                uri = new URI(src);</span>
<span class="nc bnc" id="L2117" title="All 2 branches missed.">                if (uri.getScheme().equals(&quot;ldap&quot;)) {</span>
                    // No input stream for LDAP
                } else {
<span class="nc" id="L2120">                    in = uri.toURL().openStream();</span>
                }
<span class="nc" id="L2122">            } catch (Exception e) {</span>
                try {
<span class="nc" id="L2124">                    in = new FileInputStream(src);</span>
<span class="nc" id="L2125">                } catch (Exception e2) {</span>
<span class="nc bnc" id="L2126" title="All 4 branches missed.">                    if (uri == null || uri.getScheme() == null) {</span>
<span class="nc" id="L2127">                        throw e2;   // More likely a bare file path</span>
                    } else {
<span class="nc" id="L2129">                        throw e;    // More likely a protocol or network problem</span>
                    }
<span class="nc" id="L2131">                }</span>
<span class="nc" id="L2132">            }</span>
        }
<span class="nc bnc" id="L2134" title="All 2 branches missed.">        if (in != null) {</span>
            try {
                // Read the full stream before feeding to X509Factory,
                // otherwise, keytool -gencrl | keytool -printcrl
                // might not work properly, since -gencrl is slow
                // and there's no data in the pipe at the beginning.
<span class="nc" id="L2140">                ByteArrayOutputStream bout = new ByteArrayOutputStream();</span>
<span class="nc" id="L2141">                byte[] b = new byte[4096];</span>
                while (true) {
<span class="nc" id="L2143">                    int len = in.read(b);</span>
<span class="nc bnc" id="L2144" title="All 2 branches missed.">                    if (len &lt; 0) break;</span>
<span class="nc" id="L2145">                    bout.write(b, 0, len);</span>
<span class="nc" id="L2146">                }</span>
<span class="nc" id="L2147">                return CertificateFactory.getInstance(&quot;X509&quot;).generateCRLs(</span>
<span class="nc" id="L2148">                        new ByteArrayInputStream(bout.toByteArray()));</span>
            } finally {
<span class="nc bnc" id="L2150" title="All 4 branches missed.">                if (in != System.in) {</span>
<span class="nc" id="L2151">                    in.close();</span>
                }
            }
        } else {    // must be LDAP, and uri is not null
            // Lazily load LDAPCertStoreHelper if present
<span class="nc" id="L2156">            CertStoreHelper helper = CertStoreHelper.getInstance(&quot;LDAP&quot;);</span>
<span class="nc" id="L2157">            String path = uri.getPath();</span>
<span class="nc bnc" id="L2158" title="All 2 branches missed.">            if (path.charAt(0) == '/') path = path.substring(1);</span>
<span class="nc" id="L2159">            CertStore s = helper.getCertStore(uri);</span>
<span class="nc" id="L2160">            X509CRLSelector sel =</span>
<span class="nc" id="L2161">                    helper.wrap(new X509CRLSelector(), null, path);</span>
<span class="nc" id="L2162">            return s.getCRLs(sel);</span>
        }
    }

    /**
     * Returns CRLs described in a X509Certificate's CRLDistributionPoints
     * Extension. Only those containing a general name of type URI are read.
     */
    public static List&lt;CRL&gt; readCRLsFromCert(X509Certificate cert)
            throws Exception {
<span class="nc" id="L2172">        List&lt;CRL&gt; crls = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2173">        CRLDistributionPointsExtension ext =</span>
<span class="nc" id="L2174">                X509CertImpl.toImpl(cert).getCRLDistributionPointsExtension();</span>
<span class="nc bnc" id="L2175" title="All 2 branches missed.">        if (ext == null) return crls;</span>
<span class="nc" id="L2176">        List&lt;DistributionPoint&gt; distPoints =</span>
<span class="nc" id="L2177">                ext.get(CRLDistributionPointsExtension.POINTS);</span>
<span class="nc bnc" id="L2178" title="All 2 branches missed.">        for (DistributionPoint o: distPoints) {</span>
<span class="nc" id="L2179">            GeneralNames names = o.getFullName();</span>
<span class="nc bnc" id="L2180" title="All 2 branches missed.">            if (names != null) {</span>
<span class="nc bnc" id="L2181" title="All 2 branches missed.">                for (GeneralName name: names.names()) {</span>
<span class="nc bnc" id="L2182" title="All 2 branches missed.">                    if (name.getType() == GeneralNameInterface.NAME_URI) {</span>
<span class="nc" id="L2183">                        URIName uriName = (URIName)name.getName();</span>
<span class="nc bnc" id="L2184" title="All 2 branches missed.">                        for (CRL crl: loadCRLs(uriName.getName())) {</span>
<span class="nc bnc" id="L2185" title="All 2 branches missed.">                            if (crl instanceof X509CRL) {</span>
<span class="nc" id="L2186">                                crls.add((X509CRL)crl);</span>
                            }
<span class="nc" id="L2188">                        }</span>
<span class="nc" id="L2189">                        break;  // Different name should point to same CRL</span>
                    }
<span class="nc" id="L2191">                }</span>
            }
<span class="nc" id="L2193">        }</span>
<span class="nc" id="L2194">        return crls;</span>
    }

    private static String verifyCRL(KeyStore ks, CRL crl)
            throws Exception {
<span class="nc" id="L2199">        X509CRLImpl xcrl = (X509CRLImpl)crl;</span>
<span class="nc" id="L2200">        X500Principal issuer = xcrl.getIssuerX500Principal();</span>
<span class="nc bnc" id="L2201" title="All 2 branches missed.">        for (String s: e2i(ks.aliases())) {</span>
<span class="nc" id="L2202">            Certificate cert = ks.getCertificate(s);</span>
<span class="nc bnc" id="L2203" title="All 2 branches missed.">            if (cert instanceof X509Certificate) {</span>
<span class="nc" id="L2204">                X509Certificate xcert = (X509Certificate)cert;</span>
<span class="nc bnc" id="L2205" title="All 2 branches missed.">                if (xcert.getSubjectX500Principal().equals(issuer)) {</span>
                    try {
<span class="nc" id="L2207">                        ((X509CRLImpl)crl).verify(cert.getPublicKey());</span>
<span class="nc" id="L2208">                        return s;</span>
<span class="nc" id="L2209">                    } catch (Exception e) {</span>
                    }
                }
            }
<span class="nc" id="L2213">        }</span>
<span class="nc" id="L2214">        return null;</span>
    }

    private void doPrintCRL(String src, PrintStream out)
            throws Exception {
<span class="nc bnc" id="L2219" title="All 2 branches missed.">        for (CRL crl: loadCRLs(src)) {</span>
<span class="nc" id="L2220">            printCRL(crl, out);</span>
<span class="nc" id="L2221">            String issuer = null;</span>
<span class="nc bnc" id="L2222" title="All 2 branches missed.">            if (caks != null) {</span>
<span class="nc" id="L2223">                issuer = verifyCRL(caks, crl);</span>
<span class="nc bnc" id="L2224" title="All 2 branches missed.">                if (issuer != null) {</span>
<span class="nc" id="L2225">                    out.printf(rb.getString(</span>
                            &quot;verified.by.s.in.s&quot;), issuer, &quot;cacerts&quot;);
<span class="nc" id="L2227">                    out.println();</span>
                }
            }
<span class="nc bnc" id="L2230" title="All 4 branches missed.">            if (issuer == null &amp;&amp; keyStore != null) {</span>
<span class="nc" id="L2231">                issuer = verifyCRL(keyStore, crl);</span>
<span class="nc bnc" id="L2232" title="All 2 branches missed.">                if (issuer != null) {</span>
<span class="nc" id="L2233">                    out.printf(rb.getString(</span>
                            &quot;verified.by.s.in.s&quot;), issuer, &quot;keystore&quot;);
<span class="nc" id="L2235">                    out.println();</span>
                }
            }
<span class="nc bnc" id="L2238" title="All 2 branches missed.">            if (issuer == null) {</span>
<span class="nc" id="L2239">                out.println(rb.getString</span>
<span class="nc" id="L2240">                        (&quot;STAR&quot;));</span>
<span class="nc" id="L2241">                out.println(rb.getString</span>
<span class="nc" id="L2242">                        (&quot;warning.not.verified.make.sure.keystore.is.correct&quot;));</span>
<span class="nc" id="L2243">                out.println(rb.getString</span>
<span class="nc" id="L2244">                        (&quot;STARNN&quot;));</span>
            }
<span class="nc" id="L2246">        }</span>
<span class="nc" id="L2247">    }</span>

    private void printCRL(CRL crl, PrintStream out)
            throws Exception {
<span class="nc bnc" id="L2251" title="All 2 branches missed.">        if (rfc) {</span>
<span class="nc" id="L2252">            X509CRL xcrl = (X509CRL)crl;</span>
<span class="nc" id="L2253">            out.println(&quot;-----BEGIN X509 CRL-----&quot;);</span>
<span class="nc" id="L2254">            out.println(Base64.getMimeEncoder().encodeToString(xcrl.getEncoded()));</span>
<span class="nc" id="L2255">            out.println(&quot;-----END X509 CRL-----&quot;);</span>
<span class="nc" id="L2256">        } else {</span>
<span class="nc" id="L2257">            out.println(crl.toString());</span>
        }
<span class="nc" id="L2259">    }</span>

    private void doPrintCertReq(InputStream in, PrintStream out)
            throws Exception {

<span class="nc" id="L2264">        BufferedReader reader = new BufferedReader(new InputStreamReader(in));</span>
<span class="nc" id="L2265">        StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L2266">        boolean started = false;</span>
        while (true) {
<span class="nc" id="L2268">            String s = reader.readLine();</span>
<span class="nc bnc" id="L2269" title="All 2 branches missed.">            if (s == null) break;</span>
<span class="nc bnc" id="L2270" title="All 2 branches missed.">            if (!started) {</span>
<span class="nc bnc" id="L2271" title="All 2 branches missed.">                if (s.startsWith(&quot;-----&quot;)) {</span>
<span class="nc" id="L2272">                    started = true;</span>
                }
            } else {
<span class="nc bnc" id="L2275" title="All 2 branches missed.">                if (s.startsWith(&quot;-----&quot;)) {</span>
<span class="nc" id="L2276">                    break;</span>
                }
<span class="nc" id="L2278">                sb.append(s);</span>
            }
<span class="nc" id="L2280">        }</span>
<span class="nc" id="L2281">        PKCS10 req = new PKCS10(Base64.getMimeDecoder().decode(new String(sb)));</span>

<span class="nc" id="L2283">        PublicKey pkey = req.getSubjectPublicKeyInfo();</span>
<span class="nc" id="L2284">        out.printf(rb.getString(&quot;PKCS.10.Certificate.Request.Version.1.0.Subject.s.Public.Key.s.format.s.key.&quot;),</span>
<span class="nc" id="L2285">                req.getSubjectName(), pkey.getFormat(), pkey.getAlgorithm());</span>
<span class="nc bnc" id="L2286" title="All 2 branches missed.">        for (PKCS10Attribute attr: req.getAttributes().getAttributes()) {</span>
<span class="nc" id="L2287">            ObjectIdentifier oid = attr.getAttributeId();</span>
<span class="nc bnc" id="L2288" title="All 2 branches missed.">            if (oid.equals((Object)PKCS9Attribute.EXTENSION_REQUEST_OID)) {</span>
<span class="nc" id="L2289">                CertificateExtensions exts = (CertificateExtensions)attr.getAttributeValue();</span>
<span class="nc bnc" id="L2290" title="All 2 branches missed.">                if (exts != null) {</span>
<span class="nc" id="L2291">                    printExtensions(rb.getString(&quot;Extension.Request.&quot;), exts, out);</span>
                }
<span class="nc" id="L2293">            } else {</span>
<span class="nc" id="L2294">                out.println(&quot;Attribute: &quot; + attr.getAttributeId());</span>
<span class="nc" id="L2295">                PKCS9Attribute pkcs9Attr =</span>
<span class="nc" id="L2296">                        new PKCS9Attribute(attr.getAttributeId(),</span>
<span class="nc" id="L2297">                                           attr.getAttributeValue());</span>
<span class="nc" id="L2298">                out.print(pkcs9Attr.getName() + &quot;: &quot;);</span>
<span class="nc" id="L2299">                Object attrVal = attr.getAttributeValue();</span>
<span class="nc bnc" id="L2300" title="All 2 branches missed.">                out.println(attrVal instanceof String[] ?</span>
<span class="nc" id="L2301">                            Arrays.toString((String[]) attrVal) :</span>
                            attrVal);
            }
<span class="nc" id="L2304">        }</span>
<span class="nc bnc" id="L2305" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L2306">            out.println(req);   // Just to see more, say, public key length...</span>
        }
<span class="nc" id="L2308">    }</span>

    /**
     * Reads a certificate (or certificate chain) and prints its contents in
     * a human readable format.
     */
    private void printCertFromStream(InputStream in, PrintStream out)
        throws Exception
    {
<span class="nc" id="L2317">        Collection&lt;? extends Certificate&gt; c = null;</span>
        try {
<span class="nc" id="L2319">            c = cf.generateCertificates(in);</span>
<span class="nc" id="L2320">        } catch (CertificateException ce) {</span>
<span class="nc" id="L2321">            throw new Exception(rb.getString(&quot;Failed.to.parse.input&quot;), ce);</span>
<span class="nc" id="L2322">        }</span>
<span class="nc bnc" id="L2323" title="All 2 branches missed.">        if (c.isEmpty()) {</span>
<span class="nc" id="L2324">            throw new Exception(rb.getString(&quot;Empty.input&quot;));</span>
        }
<span class="nc" id="L2326">        Certificate[] certs = c.toArray(new Certificate[c.size()]);</span>
<span class="nc bnc" id="L2327" title="All 2 branches missed.">        for (int i=0; i&lt;certs.length; i++) {</span>
<span class="nc" id="L2328">            X509Certificate x509Cert = null;</span>
            try {
<span class="nc" id="L2330">                x509Cert = (X509Certificate)certs[i];</span>
<span class="nc" id="L2331">            } catch (ClassCastException cce) {</span>
<span class="nc" id="L2332">                throw new Exception(rb.getString(&quot;Not.X.509.certificate&quot;));</span>
<span class="nc" id="L2333">            }</span>
<span class="nc bnc" id="L2334" title="All 2 branches missed.">            if (certs.length &gt; 1) {</span>
<span class="nc" id="L2335">                MessageFormat form = new MessageFormat</span>
<span class="nc" id="L2336">                        (rb.getString(&quot;Certificate.i.1.&quot;));</span>
<span class="nc" id="L2337">                Object[] source = {new Integer(i + 1)};</span>
<span class="nc" id="L2338">                out.println(form.format(source));</span>
            }
<span class="nc bnc" id="L2340" title="All 2 branches missed.">            if (rfc)</span>
<span class="nc" id="L2341">                dumpCert(x509Cert, out);</span>
            else
<span class="nc" id="L2343">                printX509Cert(x509Cert, out);</span>
<span class="nc bnc" id="L2344" title="All 2 branches missed.">            if (i &lt; (certs.length-1)) {</span>
<span class="nc" id="L2345">                out.println();</span>
            }
        }
<span class="nc" id="L2348">    }</span>

    private void doPrintCert(final PrintStream out) throws Exception {
<span class="nc bnc" id="L2351" title="All 2 branches missed.">        if (jarfile != null) {</span>
<span class="nc" id="L2352">            JarFile jf = new JarFile(jarfile, true);</span>
<span class="nc" id="L2353">            Enumeration&lt;JarEntry&gt; entries = jf.entries();</span>
<span class="nc" id="L2354">            Set&lt;CodeSigner&gt; ss = new HashSet&lt;&gt;();</span>
<span class="nc" id="L2355">            byte[] buffer = new byte[8192];</span>
<span class="nc" id="L2356">            int pos = 0;</span>
<span class="nc bnc" id="L2357" title="All 2 branches missed.">            while (entries.hasMoreElements()) {</span>
<span class="nc" id="L2358">                JarEntry je = entries.nextElement();</span>
<span class="nc" id="L2359">                try (InputStream is = jf.getInputStream(je)) {</span>
<span class="nc bnc" id="L2360" title="All 2 branches missed.">                    while (is.read(buffer) != -1) {</span>
                        // we just read. this will throw a SecurityException
                        // if a signature/digest check fails. This also
                        // populate the signers
                    }
<span class="nc bnc" id="L2365" title="All 8 branches missed.">                }</span>
<span class="nc" id="L2366">                CodeSigner[] signers = je.getCodeSigners();</span>
<span class="nc bnc" id="L2367" title="All 2 branches missed.">                if (signers != null) {</span>
<span class="nc bnc" id="L2368" title="All 2 branches missed.">                    for (CodeSigner signer: signers) {</span>
<span class="nc bnc" id="L2369" title="All 2 branches missed.">                        if (!ss.contains(signer)) {</span>
<span class="nc" id="L2370">                            ss.add(signer);</span>
<span class="nc" id="L2371">                            out.printf(rb.getString(&quot;Signer.d.&quot;), ++pos);</span>
<span class="nc" id="L2372">                            out.println();</span>
<span class="nc" id="L2373">                            out.println();</span>
<span class="nc" id="L2374">                            out.println(rb.getString(&quot;Signature.&quot;));</span>
<span class="nc" id="L2375">                            out.println();</span>
<span class="nc bnc" id="L2376" title="All 2 branches missed.">                            for (Certificate cert: signer.getSignerCertPath().getCertificates()) {</span>
<span class="nc" id="L2377">                                X509Certificate x = (X509Certificate)cert;</span>
<span class="nc bnc" id="L2378" title="All 2 branches missed.">                                if (rfc) {</span>
<span class="nc" id="L2379">                                    out.println(rb.getString(&quot;Certificate.owner.&quot;) + x.getSubjectDN() + &quot;\n&quot;);</span>
<span class="nc" id="L2380">                                    dumpCert(x, out);</span>
                                } else {
<span class="nc" id="L2382">                                    printX509Cert(x, out);</span>
                                }
<span class="nc" id="L2384">                                out.println();</span>
<span class="nc" id="L2385">                            }</span>
<span class="nc" id="L2386">                            Timestamp ts = signer.getTimestamp();</span>
<span class="nc bnc" id="L2387" title="All 2 branches missed.">                            if (ts != null) {</span>
<span class="nc" id="L2388">                                out.println(rb.getString(&quot;Timestamp.&quot;));</span>
<span class="nc" id="L2389">                                out.println();</span>
<span class="nc bnc" id="L2390" title="All 2 branches missed.">                                for (Certificate cert: ts.getSignerCertPath().getCertificates()) {</span>
<span class="nc" id="L2391">                                    X509Certificate x = (X509Certificate)cert;</span>
<span class="nc bnc" id="L2392" title="All 2 branches missed.">                                    if (rfc) {</span>
<span class="nc" id="L2393">                                        out.println(rb.getString(&quot;Certificate.owner.&quot;) + x.getSubjectDN() + &quot;\n&quot;);</span>
<span class="nc" id="L2394">                                        dumpCert(x, out);</span>
                                    } else {
<span class="nc" id="L2396">                                        printX509Cert(x, out);</span>
                                    }
<span class="nc" id="L2398">                                    out.println();</span>
<span class="nc" id="L2399">                                }</span>
                            }
                        }
                    }
                }
<span class="nc" id="L2404">            }</span>
<span class="nc" id="L2405">            jf.close();</span>
<span class="nc bnc" id="L2406" title="All 2 branches missed.">            if (ss.isEmpty()) {</span>
<span class="nc" id="L2407">                out.println(rb.getString(&quot;Not.a.signed.jar.file&quot;));</span>
            }
<span class="nc bnc" id="L2409" title="All 2 branches missed.">        } else if (sslserver != null) {</span>
            // Lazily load SSLCertStoreHelper if present
<span class="nc" id="L2411">            CertStoreHelper helper = CertStoreHelper.getInstance(&quot;SSLServer&quot;);</span>
<span class="nc" id="L2412">            CertStore cs = helper.getCertStore(new URI(&quot;https://&quot; + sslserver));</span>
            Collection&lt;? extends Certificate&gt; chain;
            try {
<span class="nc" id="L2415">                chain = cs.getCertificates(null);</span>
<span class="nc bnc" id="L2416" title="All 2 branches missed.">                if (chain.isEmpty()) {</span>
                    // If the certs are not retrieved, we consider it an error
                    // even if the URL connection is successful.
<span class="nc" id="L2419">                    throw new Exception(rb.getString(</span>
                                        &quot;No.certificate.from.the.SSL.server&quot;));
                }
<span class="nc" id="L2422">            } catch (CertStoreException cse) {</span>
<span class="nc bnc" id="L2423" title="All 2 branches missed.">                if (cse.getCause() instanceof IOException) {</span>
<span class="nc" id="L2424">                    throw new Exception(rb.getString(</span>
                                        &quot;No.certificate.from.the.SSL.server&quot;),
<span class="nc" id="L2426">                                        cse.getCause());</span>
                } else {
<span class="nc" id="L2428">                    throw cse;</span>
                }
<span class="nc" id="L2430">            }</span>

<span class="nc" id="L2432">            int i = 0;</span>
<span class="nc bnc" id="L2433" title="All 2 branches missed.">            for (Certificate cert : chain) {</span>
                try {
<span class="nc bnc" id="L2435" title="All 2 branches missed.">                    if (rfc) {</span>
<span class="nc" id="L2436">                        dumpCert(cert, out);</span>
                    } else {
<span class="nc" id="L2438">                        out.println(&quot;Certificate #&quot; + i++);</span>
<span class="nc" id="L2439">                        out.println(&quot;====================================&quot;);</span>
<span class="nc" id="L2440">                        printX509Cert((X509Certificate)cert, out);</span>
<span class="nc" id="L2441">                        out.println();</span>
                    }
<span class="nc" id="L2443">                } catch (Exception e) {</span>
<span class="nc bnc" id="L2444" title="All 2 branches missed.">                    if (debug) {</span>
<span class="nc" id="L2445">                        e.printStackTrace();</span>
                    }
<span class="nc" id="L2447">                }</span>
<span class="nc" id="L2448">            }</span>
<span class="nc" id="L2449">        } else {</span>
<span class="nc bnc" id="L2450" title="All 2 branches missed.">            if (filename != null) {</span>
<span class="nc" id="L2451">                try (FileInputStream inStream = new FileInputStream(filename)) {</span>
<span class="nc" id="L2452">                    printCertFromStream(inStream, out);</span>
<span class="nc bnc" id="L2453" title="All 8 branches missed.">                }</span>
            } else {
<span class="nc" id="L2455">                printCertFromStream(System.in, out);</span>
            }
        }
<span class="nc" id="L2458">    }</span>
    /**
     * Creates a self-signed certificate, and stores it as a single-element
     * certificate chain.
     */
    private void doSelfCert(String alias, String dname, String sigAlgName)
        throws Exception
    {
<span class="nc bnc" id="L2466" title="All 2 branches missed.">        if (alias == null) {</span>
<span class="nc" id="L2467">            alias = keyAlias;</span>
        }

<span class="nc" id="L2470">        Pair&lt;Key,char[]&gt; objs = recoverKey(alias, storePass, keyPass);</span>
<span class="nc" id="L2471">        PrivateKey privKey = (PrivateKey)objs.fst;</span>
<span class="nc bnc" id="L2472" title="All 2 branches missed.">        if (keyPass == null)</span>
<span class="nc" id="L2473">            keyPass = objs.snd;</span>

        // Determine the signature algorithm
<span class="nc bnc" id="L2476" title="All 2 branches missed.">        if (sigAlgName == null) {</span>
<span class="nc" id="L2477">            sigAlgName = getCompatibleSigAlgName(privKey.getAlgorithm());</span>
        }

        // Get the old certificate
<span class="nc" id="L2481">        Certificate oldCert = keyStore.getCertificate(alias);</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">        if (oldCert == null) {</span>
<span class="nc" id="L2483">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L2484">                (rb.getString(&quot;alias.has.no.public.key&quot;));</span>
<span class="nc" id="L2485">            Object[] source = {alias};</span>
<span class="nc" id="L2486">            throw new Exception(form.format(source));</span>
        }
<span class="nc bnc" id="L2488" title="All 2 branches missed.">        if (!(oldCert instanceof X509Certificate)) {</span>
<span class="nc" id="L2489">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L2490">                (rb.getString(&quot;alias.has.no.X.509.certificate&quot;));</span>
<span class="nc" id="L2491">            Object[] source = {alias};</span>
<span class="nc" id="L2492">            throw new Exception(form.format(source));</span>
        }

        // convert to X509CertImpl, so that we can modify selected fields
        // (no public APIs available yet)
<span class="nc" id="L2497">        byte[] encoded = oldCert.getEncoded();</span>
<span class="nc" id="L2498">        X509CertImpl certImpl = new X509CertImpl(encoded);</span>
<span class="nc" id="L2499">        X509CertInfo certInfo = (X509CertInfo)certImpl.get(X509CertImpl.NAME</span>
                                                           + &quot;.&quot; +
                                                           X509CertImpl.INFO);

        // Extend its validity
<span class="nc" id="L2504">        Date firstDate = getStartDate(startDate);</span>
<span class="nc" id="L2505">        Date lastDate = new Date();</span>
<span class="nc" id="L2506">        lastDate.setTime(firstDate.getTime() + validity*1000L*24L*60L*60L);</span>
<span class="nc" id="L2507">        CertificateValidity interval = new CertificateValidity(firstDate,</span>
                                                               lastDate);
<span class="nc" id="L2509">        certInfo.set(X509CertInfo.VALIDITY, interval);</span>

        // Make new serial number
<span class="nc" id="L2512">        certInfo.set(X509CertInfo.SERIAL_NUMBER, new CertificateSerialNumber(</span>
<span class="nc" id="L2513">                    new java.util.Random().nextInt() &amp; 0x7fffffff));</span>

        // Set owner and issuer fields
        X500Name owner;
<span class="nc bnc" id="L2517" title="All 2 branches missed.">        if (dname == null) {</span>
            // Get the owner name from the certificate
<span class="nc" id="L2519">            owner = (X500Name)certInfo.get(X509CertInfo.SUBJECT + &quot;.&quot; +</span>
                                           X509CertInfo.DN_NAME);
        } else {
            // Use the owner name specified at the command line
<span class="nc" id="L2523">            owner = new X500Name(dname);</span>
<span class="nc" id="L2524">            certInfo.set(X509CertInfo.SUBJECT + &quot;.&quot; +</span>
                         X509CertInfo.DN_NAME, owner);
        }
        // Make issuer same as owner (self-signed!)
<span class="nc" id="L2528">        certInfo.set(X509CertInfo.ISSUER + &quot;.&quot; +</span>
                     X509CertInfo.DN_NAME, owner);

        // The inner and outer signature algorithms have to match.
        // The way we achieve that is really ugly, but there seems to be no
        // other solution: We first sign the cert, then retrieve the
        // outer sigalg and use it to set the inner sigalg
<span class="nc" id="L2535">        X509CertImpl newCert = new X509CertImpl(certInfo);</span>
<span class="nc" id="L2536">        newCert.sign(privKey, sigAlgName);</span>
<span class="nc" id="L2537">        AlgorithmId sigAlgid = (AlgorithmId)newCert.get(X509CertImpl.SIG_ALG);</span>
<span class="nc" id="L2538">        certInfo.set(CertificateAlgorithmId.NAME + &quot;.&quot; +</span>
                     CertificateAlgorithmId.ALGORITHM, sigAlgid);

<span class="nc" id="L2541">        certInfo.set(X509CertInfo.VERSION,</span>
                        new CertificateVersion(CertificateVersion.V3));

<span class="nc" id="L2544">        CertificateExtensions ext = createV3Extensions(</span>
                null,
<span class="nc" id="L2546">                (CertificateExtensions)certInfo.get(X509CertInfo.EXTENSIONS),</span>
                v3ext,
<span class="nc" id="L2548">                oldCert.getPublicKey(),</span>
                null);
<span class="nc" id="L2550">        certInfo.set(X509CertInfo.EXTENSIONS, ext);</span>
        // Sign the new certificate
<span class="nc" id="L2552">        newCert = new X509CertImpl(certInfo);</span>
<span class="nc" id="L2553">        newCert.sign(privKey, sigAlgName);</span>

        // Store the new certificate as a single-element certificate chain
<span class="nc bnc" id="L2556" title="All 2 branches missed.">        keyStore.setKeyEntry(alias, privKey,</span>
                             (keyPass != null) ? keyPass : storePass,
                             new Certificate[] { newCert } );

<span class="nc bnc" id="L2560" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L2561">            System.err.println(rb.getString(&quot;New.certificate.self.signed.&quot;));</span>
<span class="nc" id="L2562">            System.err.print(newCert.toString());</span>
<span class="nc" id="L2563">            System.err.println();</span>
        }
<span class="nc" id="L2565">    }</span>

    /**
     * Processes a certificate reply from a certificate authority.
     *
     * &lt;p&gt;Builds a certificate chain on top of the certificate reply,
     * using trusted certificates from the keystore. The chain is complete
     * after a self-signed certificate has been encountered. The self-signed
     * certificate is considered a root certificate authority, and is stored
     * at the end of the chain.
     *
     * &lt;p&gt;The newly generated chain replaces the old chain associated with the
     * key entry.
     *
     * @return true if the certificate reply was installed, otherwise false.
     */
    private boolean installReply(String alias, InputStream in)
        throws Exception
    {
<span class="nc bnc" id="L2584" title="All 2 branches missed.">        if (alias == null) {</span>
<span class="nc" id="L2585">            alias = keyAlias;</span>
        }

<span class="nc" id="L2588">        Pair&lt;Key,char[]&gt; objs = recoverKey(alias, storePass, keyPass);</span>
<span class="nc" id="L2589">        PrivateKey privKey = (PrivateKey)objs.fst;</span>
<span class="nc bnc" id="L2590" title="All 2 branches missed.">        if (keyPass == null) {</span>
<span class="nc" id="L2591">            keyPass = objs.snd;</span>
        }

<span class="nc" id="L2594">        Certificate userCert = keyStore.getCertificate(alias);</span>
<span class="nc bnc" id="L2595" title="All 2 branches missed.">        if (userCert == null) {</span>
<span class="nc" id="L2596">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L2597">                (rb.getString(&quot;alias.has.no.public.key.certificate.&quot;));</span>
<span class="nc" id="L2598">            Object[] source = {alias};</span>
<span class="nc" id="L2599">            throw new Exception(form.format(source));</span>
        }

        // Read the certificates in the reply
<span class="nc" id="L2603">        Collection&lt;? extends Certificate&gt; c = cf.generateCertificates(in);</span>
<span class="nc bnc" id="L2604" title="All 2 branches missed.">        if (c.isEmpty()) {</span>
<span class="nc" id="L2605">            throw new Exception(rb.getString(&quot;Reply.has.no.certificates&quot;));</span>
        }
<span class="nc" id="L2607">        Certificate[] replyCerts = c.toArray(new Certificate[c.size()]);</span>
        Certificate[] newChain;
<span class="nc bnc" id="L2609" title="All 2 branches missed.">        if (replyCerts.length == 1) {</span>
            // single-cert reply
<span class="nc" id="L2611">            newChain = establishCertChain(userCert, replyCerts[0]);</span>
        } else {
            // cert-chain reply (e.g., PKCS#7)
<span class="nc" id="L2614">            newChain = validateReply(alias, userCert, replyCerts);</span>
        }

        // Now store the newly established chain in the keystore. The new
        // chain replaces the old one.
<span class="nc bnc" id="L2619" title="All 2 branches missed.">        if (newChain != null) {</span>
<span class="nc bnc" id="L2620" title="All 2 branches missed.">            keyStore.setKeyEntry(alias, privKey,</span>
                                 (keyPass != null) ? keyPass : storePass,
                                 newChain);
<span class="nc" id="L2623">            return true;</span>
        } else {
<span class="nc" id="L2625">            return false;</span>
        }
    }

    /**
     * Imports a certificate and adds it to the list of trusted certificates.
     *
     * @return true if the certificate was added, otherwise false.
     */
    private boolean addTrustedCert(String alias, InputStream in)
        throws Exception
    {
<span class="nc bnc" id="L2637" title="All 2 branches missed.">        if (alias == null) {</span>
<span class="nc" id="L2638">            throw new Exception(rb.getString(&quot;Must.specify.alias&quot;));</span>
        }
<span class="nc bnc" id="L2640" title="All 2 branches missed.">        if (keyStore.containsAlias(alias)) {</span>
<span class="nc" id="L2641">            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L2642">                (&quot;Certificate.not.imported.alias.alias.already.exists&quot;));</span>
<span class="nc" id="L2643">            Object[] source = {alias};</span>
<span class="nc" id="L2644">            throw new Exception(form.format(source));</span>
        }

        // Read the certificate
<span class="nc" id="L2648">        X509Certificate cert = null;</span>
        try {
<span class="nc" id="L2650">            cert = (X509Certificate)cf.generateCertificate(in);</span>
<span class="nc" id="L2651">        } catch (ClassCastException | CertificateException ce) {</span>
<span class="nc" id="L2652">            throw new Exception(rb.getString(&quot;Input.not.an.X.509.certificate&quot;));</span>
<span class="nc" id="L2653">        }</span>

        // if certificate is self-signed, make sure it verifies
<span class="nc" id="L2656">        boolean selfSigned = false;</span>
<span class="nc bnc" id="L2657" title="All 2 branches missed.">        if (isSelfSigned(cert)) {</span>
<span class="nc" id="L2658">            cert.verify(cert.getPublicKey());</span>
<span class="nc" id="L2659">            selfSigned = true;</span>
        }

<span class="nc bnc" id="L2662" title="All 2 branches missed.">        if (noprompt) {</span>
<span class="nc" id="L2663">            keyStore.setCertificateEntry(alias, cert);</span>
<span class="nc" id="L2664">            return true;</span>
        }

        // check if cert already exists in keystore
<span class="nc" id="L2668">        String reply = null;</span>
<span class="nc" id="L2669">        String trustalias = keyStore.getCertificateAlias(cert);</span>
<span class="nc bnc" id="L2670" title="All 2 branches missed.">        if (trustalias != null) {</span>
<span class="nc" id="L2671">            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L2672">                (&quot;Certificate.already.exists.in.keystore.under.alias.trustalias.&quot;));</span>
<span class="nc" id="L2673">            Object[] source = {trustalias};</span>
<span class="nc" id="L2674">            System.err.println(form.format(source));</span>
<span class="nc" id="L2675">            reply = getYesNoReply</span>
<span class="nc" id="L2676">                (rb.getString(&quot;Do.you.still.want.to.add.it.no.&quot;));</span>
<span class="nc bnc" id="L2677" title="All 2 branches missed.">        } else if (selfSigned) {</span>
<span class="nc bnc" id="L2678" title="All 4 branches missed.">            if (trustcacerts &amp;&amp; (caks != null) &amp;&amp;</span>
<span class="nc bnc" id="L2679" title="All 2 branches missed.">                    ((trustalias=caks.getCertificateAlias(cert)) != null)) {</span>
<span class="nc" id="L2680">                MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L2681">                        (&quot;Certificate.already.exists.in.system.wide.CA.keystore.under.alias.trustalias.&quot;));</span>
<span class="nc" id="L2682">                Object[] source = {trustalias};</span>
<span class="nc" id="L2683">                System.err.println(form.format(source));</span>
<span class="nc" id="L2684">                reply = getYesNoReply</span>
<span class="nc" id="L2685">                        (rb.getString(&quot;Do.you.still.want.to.add.it.to.your.own.keystore.no.&quot;));</span>
            }
<span class="nc bnc" id="L2687" title="All 2 branches missed.">            if (trustalias == null) {</span>
                // Print the cert and ask user if they really want to add
                // it to their keystore
<span class="nc" id="L2690">                printX509Cert(cert, System.out);</span>
<span class="nc" id="L2691">                reply = getYesNoReply</span>
<span class="nc" id="L2692">                        (rb.getString(&quot;Trust.this.certificate.no.&quot;));</span>
            }
        }
<span class="nc bnc" id="L2695" title="All 2 branches missed.">        if (reply != null) {</span>
<span class="nc bnc" id="L2696" title="All 2 branches missed.">            if (&quot;YES&quot;.equals(reply)) {</span>
<span class="nc" id="L2697">                keyStore.setCertificateEntry(alias, cert);</span>
<span class="nc" id="L2698">                return true;</span>
            } else {
<span class="nc" id="L2700">                return false;</span>
            }
        }

        // Try to establish trust chain
        try {
<span class="nc" id="L2706">            Certificate[] chain = establishCertChain(null, cert);</span>
<span class="nc bnc" id="L2707" title="All 2 branches missed.">            if (chain != null) {</span>
<span class="nc" id="L2708">                keyStore.setCertificateEntry(alias, cert);</span>
<span class="nc" id="L2709">                return true;</span>
            }
<span class="nc" id="L2711">        } catch (Exception e) {</span>
            // Print the cert and ask user if they really want to add it to
            // their keystore
<span class="nc" id="L2714">            printX509Cert(cert, System.out);</span>
<span class="nc" id="L2715">            reply = getYesNoReply</span>
<span class="nc" id="L2716">                (rb.getString(&quot;Trust.this.certificate.no.&quot;));</span>
<span class="nc bnc" id="L2717" title="All 2 branches missed.">            if (&quot;YES&quot;.equals(reply)) {</span>
<span class="nc" id="L2718">                keyStore.setCertificateEntry(alias, cert);</span>
<span class="nc" id="L2719">                return true;</span>
            } else {
<span class="nc" id="L2721">                return false;</span>
            }
<span class="nc" id="L2723">        }</span>

<span class="nc" id="L2725">        return false;</span>
    }

    /**
     * Prompts user for new password. New password must be different from
     * old one.
     *
     * @param prompt the message that gets prompted on the screen
     * @param oldPasswd the current (i.e., old) password
     */
    private char[] getNewPasswd(String prompt, char[] oldPasswd)
        throws Exception
    {
<span class="nc" id="L2738">        char[] entered = null;</span>
<span class="nc" id="L2739">        char[] reentered = null;</span>

<span class="nc bnc" id="L2741" title="All 2 branches missed.">        for (int count = 0; count &lt; 3; count++) {</span>
<span class="nc" id="L2742">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L2743">                (rb.getString(&quot;New.prompt.&quot;));</span>
<span class="nc" id="L2744">            Object[] source = {prompt};</span>
<span class="nc" id="L2745">            System.err.print(form.format(source));</span>
<span class="nc" id="L2746">            entered = Password.readPassword(System.in);</span>
<span class="nc" id="L2747">            passwords.add(entered);</span>
<span class="nc bnc" id="L2748" title="All 4 branches missed.">            if (entered == null || entered.length &lt; 6) {</span>
<span class="nc" id="L2749">                System.err.println(rb.getString</span>
<span class="nc" id="L2750">                    (&quot;Password.is.too.short.must.be.at.least.6.characters&quot;));</span>
<span class="nc bnc" id="L2751" title="All 2 branches missed.">            } else if (Arrays.equals(entered, oldPasswd)) {</span>
<span class="nc" id="L2752">                System.err.println(rb.getString(&quot;Passwords.must.differ&quot;));</span>
            } else {
<span class="nc" id="L2754">                form = new MessageFormat</span>
<span class="nc" id="L2755">                        (rb.getString(&quot;Re.enter.new.prompt.&quot;));</span>
<span class="nc" id="L2756">                Object[] src = {prompt};</span>
<span class="nc" id="L2757">                System.err.print(form.format(src));</span>
<span class="nc" id="L2758">                reentered = Password.readPassword(System.in);</span>
<span class="nc" id="L2759">                passwords.add(reentered);</span>
<span class="nc bnc" id="L2760" title="All 2 branches missed.">                if (!Arrays.equals(entered, reentered)) {</span>
<span class="nc" id="L2761">                    System.err.println</span>
<span class="nc" id="L2762">                        (rb.getString(&quot;They.don.t.match.Try.again&quot;));</span>
                } else {
<span class="nc" id="L2764">                    Arrays.fill(reentered, ' ');</span>
<span class="nc" id="L2765">                    return entered;</span>
                }
            }
<span class="nc bnc" id="L2768" title="All 2 branches missed.">            if (entered != null) {</span>
<span class="nc" id="L2769">                Arrays.fill(entered, ' ');</span>
<span class="nc" id="L2770">                entered = null;</span>
            }
<span class="nc bnc" id="L2772" title="All 2 branches missed.">            if (reentered != null) {</span>
<span class="nc" id="L2773">                Arrays.fill(reentered, ' ');</span>
<span class="nc" id="L2774">                reentered = null;</span>
            }
        }
<span class="nc" id="L2777">        throw new Exception(rb.getString(&quot;Too.many.failures.try.later&quot;));</span>
    }

    /**
     * Prompts user for alias name.
     * @param prompt the {0} of &quot;Enter {0} alias name:  &quot; in prompt line
     * @returns the string entered by the user, without the \n at the end
     */
    private String getAlias(String prompt) throws Exception {
<span class="nc bnc" id="L2786" title="All 2 branches missed.">        if (prompt != null) {</span>
<span class="nc" id="L2787">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L2788">                (rb.getString(&quot;Enter.prompt.alias.name.&quot;));</span>
<span class="nc" id="L2789">            Object[] source = {prompt};</span>
<span class="nc" id="L2790">            System.err.print(form.format(source));</span>
<span class="nc" id="L2791">        } else {</span>
<span class="nc" id="L2792">            System.err.print(rb.getString(&quot;Enter.alias.name.&quot;));</span>
        }
<span class="nc" id="L2794">        return (new BufferedReader(new InputStreamReader(</span>
<span class="nc" id="L2795">                                        System.in))).readLine();</span>
    }

    /**
     * Prompts user for an input string from the command line (System.in)
     * @prompt the prompt string printed
     * @returns the string entered by the user, without the \n at the end
     */
    private String inputStringFromStdin(String prompt) throws Exception {
<span class="nc" id="L2804">        System.err.print(prompt);</span>
<span class="nc" id="L2805">        return (new BufferedReader(new InputStreamReader(</span>
<span class="nc" id="L2806">                                        System.in))).readLine();</span>
    }

    /**
     * Prompts user for key password. User may select to choose the same
     * password (&lt;code&gt;otherKeyPass&lt;/code&gt;) as for &lt;code&gt;otherAlias&lt;/code&gt;.
     */
    private char[] getKeyPasswd(String alias, String otherAlias,
                                char[] otherKeyPass)
        throws Exception
    {
<span class="nc" id="L2817">        int count = 0;</span>
<span class="nc" id="L2818">        char[] keyPass = null;</span>

        do {
<span class="nc bnc" id="L2821" title="All 2 branches missed.">            if (otherKeyPass != null) {</span>
<span class="nc" id="L2822">                MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L2823">                        (&quot;Enter.key.password.for.alias.&quot;));</span>
<span class="nc" id="L2824">                Object[] source = {alias};</span>
<span class="nc" id="L2825">                System.err.println(form.format(source));</span>

<span class="nc" id="L2827">                form = new MessageFormat(rb.getString</span>
<span class="nc" id="L2828">                        (&quot;.RETURN.if.same.as.for.otherAlias.&quot;));</span>
<span class="nc" id="L2829">                Object[] src = {otherAlias};</span>
<span class="nc" id="L2830">                System.err.print(form.format(src));</span>
<span class="nc" id="L2831">            } else {</span>
<span class="nc" id="L2832">                MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L2833">                        (&quot;Enter.key.password.for.alias.&quot;));</span>
<span class="nc" id="L2834">                Object[] source = {alias};</span>
<span class="nc" id="L2835">                System.err.print(form.format(source));</span>
            }
<span class="nc" id="L2837">            System.err.flush();</span>
<span class="nc" id="L2838">            keyPass = Password.readPassword(System.in);</span>
<span class="nc" id="L2839">            passwords.add(keyPass);</span>
<span class="nc bnc" id="L2840" title="All 2 branches missed.">            if (keyPass == null) {</span>
<span class="nc" id="L2841">                keyPass = otherKeyPass;</span>
            }
<span class="nc" id="L2843">            count++;</span>
<span class="nc bnc" id="L2844" title="All 4 branches missed.">        } while ((keyPass == null) &amp;&amp; count &lt; 3);</span>

<span class="nc bnc" id="L2846" title="All 2 branches missed.">        if (keyPass == null) {</span>
<span class="nc" id="L2847">            throw new Exception(rb.getString(&quot;Too.many.failures.try.later&quot;));</span>
        }

<span class="nc" id="L2850">        return keyPass;</span>
    }

    /**
     * Prints a certificate in a human readable format.
     */
    private void printX509Cert(X509Certificate cert, PrintStream out)
        throws Exception
    {
        /*
        out.println(&quot;Owner: &quot;
                    + cert.getSubjectDN().toString()
                    + &quot;\n&quot;
                    + &quot;Issuer: &quot;
                    + cert.getIssuerDN().toString()
                    + &quot;\n&quot;
                    + &quot;Serial number: &quot; + cert.getSerialNumber().toString(16)
                    + &quot;\n&quot;
                    + &quot;Valid from: &quot; + cert.getNotBefore().toString()
                    + &quot; until: &quot; + cert.getNotAfter().toString()
                    + &quot;\n&quot;
                    + &quot;Certificate fingerprints:\n&quot;
                    + &quot;\t MD5:  &quot; + getCertFingerPrint(&quot;MD5&quot;, cert)
                    + &quot;\n&quot;
                    + &quot;\t SHA1: &quot; + getCertFingerPrint(&quot;SHA1&quot;, cert));
        */

<span class="nc" id="L2877">        MessageFormat form = new MessageFormat</span>
<span class="nc" id="L2878">                (rb.getString(&quot;.PATTERN.printX509Cert&quot;));</span>
<span class="nc" id="L2879">        Object[] source = {cert.getSubjectDN().toString(),</span>
<span class="nc" id="L2880">                        cert.getIssuerDN().toString(),</span>
<span class="nc" id="L2881">                        cert.getSerialNumber().toString(16),</span>
<span class="nc" id="L2882">                        cert.getNotBefore().toString(),</span>
<span class="nc" id="L2883">                        cert.getNotAfter().toString(),</span>
<span class="nc" id="L2884">                        getCertFingerPrint(&quot;MD5&quot;, cert),</span>
<span class="nc" id="L2885">                        getCertFingerPrint(&quot;SHA1&quot;, cert),</span>
<span class="nc" id="L2886">                        getCertFingerPrint(&quot;SHA-256&quot;, cert),</span>
<span class="nc" id="L2887">                        cert.getSigAlgName(),</span>
<span class="nc" id="L2888">                        cert.getVersion()</span>
                        };
<span class="nc" id="L2890">        out.println(form.format(source));</span>

<span class="nc bnc" id="L2892" title="All 2 branches missed.">        if (cert instanceof X509CertImpl) {</span>
<span class="nc" id="L2893">            X509CertImpl impl = (X509CertImpl)cert;</span>
<span class="nc" id="L2894">            X509CertInfo certInfo = (X509CertInfo)impl.get(X509CertImpl.NAME</span>
                                                           + &quot;.&quot; +
                                                           X509CertImpl.INFO);
<span class="nc" id="L2897">            CertificateExtensions exts = (CertificateExtensions)</span>
<span class="nc" id="L2898">                    certInfo.get(X509CertInfo.EXTENSIONS);</span>
<span class="nc bnc" id="L2899" title="All 2 branches missed.">            if (exts != null) {</span>
<span class="nc" id="L2900">                printExtensions(rb.getString(&quot;Extensions.&quot;), exts, out);</span>
            }
        }
<span class="nc" id="L2903">    }</span>

    private static void printExtensions(String title, CertificateExtensions exts, PrintStream out)
            throws Exception {
<span class="nc" id="L2907">        int extnum = 0;</span>
<span class="nc" id="L2908">        Iterator&lt;Extension&gt; i1 = exts.getAllExtensions().iterator();</span>
<span class="nc" id="L2909">        Iterator&lt;Extension&gt; i2 = exts.getUnparseableExtensions().values().iterator();</span>
<span class="nc bnc" id="L2910" title="All 4 branches missed.">        while (i1.hasNext() || i2.hasNext()) {</span>
<span class="nc bnc" id="L2911" title="All 2 branches missed.">            Extension ext = i1.hasNext()?i1.next():i2.next();</span>
<span class="nc bnc" id="L2912" title="All 2 branches missed.">            if (extnum == 0) {</span>
<span class="nc" id="L2913">                out.println();</span>
<span class="nc" id="L2914">                out.println(title);</span>
<span class="nc" id="L2915">                out.println();</span>
            }
<span class="nc" id="L2917">            out.print(&quot;#&quot;+(++extnum)+&quot;: &quot;+ ext);</span>
<span class="nc bnc" id="L2918" title="All 2 branches missed.">            if (ext.getClass() == Extension.class) {</span>
<span class="nc" id="L2919">                byte[] v = ext.getExtensionValue();</span>
<span class="nc bnc" id="L2920" title="All 2 branches missed.">                if (v.length == 0) {</span>
<span class="nc" id="L2921">                    out.println(rb.getString(&quot;.Empty.value.&quot;));</span>
                } else {
<span class="nc" id="L2923">                    new sun.misc.HexDumpEncoder().encodeBuffer(ext.getExtensionValue(), out);</span>
<span class="nc" id="L2924">                    out.println();</span>
                }
            }
<span class="nc" id="L2927">            out.println();</span>
<span class="nc" id="L2928">        }</span>
<span class="nc" id="L2929">    }</span>

    /**
     * Returns true if the certificate is self-signed, false otherwise.
     */
    private boolean isSelfSigned(X509Certificate cert) {
<span class="nc" id="L2935">        return signedBy(cert, cert);</span>
    }

    private boolean signedBy(X509Certificate end, X509Certificate ca) {
<span class="nc bnc" id="L2939" title="All 2 branches missed.">        if (!ca.getSubjectDN().equals(end.getIssuerDN())) {</span>
<span class="nc" id="L2940">            return false;</span>
        }
        try {
<span class="nc" id="L2943">            end.verify(ca.getPublicKey());</span>
<span class="nc" id="L2944">            return true;</span>
<span class="nc" id="L2945">        } catch (Exception e) {</span>
<span class="nc" id="L2946">            return false;</span>
        }
    }

    /**
     * Locates a signer for a given certificate from a given keystore and
     * returns the signer's certificate.
     * @param cert the certificate whose signer is searched, not null
     * @param ks the keystore to search with, not null
     * @return &lt;code&gt;cert&lt;/code&gt; itself if it's already inside &lt;code&gt;ks&lt;/code&gt;,
     * or a certificate inside &lt;code&gt;ks&lt;/code&gt; who signs &lt;code&gt;cert&lt;/code&gt;,
     * or null otherwise.
     */
    private static Certificate getTrustedSigner(Certificate cert, KeyStore ks)
            throws Exception {
<span class="nc bnc" id="L2961" title="All 2 branches missed.">        if (ks.getCertificateAlias(cert) != null) {</span>
<span class="nc" id="L2962">            return cert;</span>
        }
<span class="nc" id="L2964">        for (Enumeration&lt;String&gt; aliases = ks.aliases();</span>
<span class="nc bnc" id="L2965" title="All 2 branches missed.">                aliases.hasMoreElements(); ) {</span>
<span class="nc" id="L2966">            String name = aliases.nextElement();</span>
<span class="nc" id="L2967">            Certificate trustedCert = ks.getCertificate(name);</span>
<span class="nc bnc" id="L2968" title="All 2 branches missed.">            if (trustedCert != null) {</span>
                try {
<span class="nc" id="L2970">                    cert.verify(trustedCert.getPublicKey());</span>
<span class="nc" id="L2971">                    return trustedCert;</span>
<span class="nc" id="L2972">                } catch (Exception e) {</span>
                    // Not verified, skip to the next one
                }
            }
<span class="nc" id="L2976">        }</span>
<span class="nc" id="L2977">        return null;</span>
    }

    /**
     * Gets an X.500 name suitable for inclusion in a certification request.
     */
    private X500Name getX500Name() throws IOException {
        BufferedReader in;
<span class="nc" id="L2985">        in = new BufferedReader(new InputStreamReader(System.in));</span>
<span class="nc" id="L2986">        String commonName = &quot;Unknown&quot;;</span>
<span class="nc" id="L2987">        String organizationalUnit = &quot;Unknown&quot;;</span>
<span class="nc" id="L2988">        String organization = &quot;Unknown&quot;;</span>
<span class="nc" id="L2989">        String city = &quot;Unknown&quot;;</span>
<span class="nc" id="L2990">        String state = &quot;Unknown&quot;;</span>
<span class="nc" id="L2991">        String country = &quot;Unknown&quot;;</span>
        X500Name name;
<span class="nc" id="L2993">        String userInput = null;</span>

<span class="nc" id="L2995">        int maxRetry = 20;</span>
        do {
<span class="nc bnc" id="L2997" title="All 2 branches missed.">            if (maxRetry-- &lt; 0) {</span>
<span class="nc" id="L2998">                throw new RuntimeException(rb.getString(</span>
                        &quot;Too.many.retries.program.terminated&quot;));
            }
<span class="nc" id="L3001">            commonName = inputString(in,</span>
<span class="nc" id="L3002">                    rb.getString(&quot;What.is.your.first.and.last.name.&quot;),</span>
                    commonName);
<span class="nc" id="L3004">            organizationalUnit = inputString(in,</span>
                    rb.getString
<span class="nc" id="L3006">                        (&quot;What.is.the.name.of.your.organizational.unit.&quot;),</span>
                    organizationalUnit);
<span class="nc" id="L3008">            organization = inputString(in,</span>
<span class="nc" id="L3009">                    rb.getString(&quot;What.is.the.name.of.your.organization.&quot;),</span>
                    organization);
<span class="nc" id="L3011">            city = inputString(in,</span>
<span class="nc" id="L3012">                    rb.getString(&quot;What.is.the.name.of.your.City.or.Locality.&quot;),</span>
                    city);
<span class="nc" id="L3014">            state = inputString(in,</span>
<span class="nc" id="L3015">                    rb.getString(&quot;What.is.the.name.of.your.State.or.Province.&quot;),</span>
                    state);
<span class="nc" id="L3017">            country = inputString(in,</span>
                    rb.getString
<span class="nc" id="L3019">                        (&quot;What.is.the.two.letter.country.code.for.this.unit.&quot;),</span>
                    country);
<span class="nc" id="L3021">            name = new X500Name(commonName, organizationalUnit, organization,</span>
                                city, state, country);
<span class="nc" id="L3023">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L3024">                (rb.getString(&quot;Is.name.correct.&quot;));</span>
<span class="nc" id="L3025">            Object[] source = {name};</span>
<span class="nc" id="L3026">            userInput = inputString</span>
<span class="nc" id="L3027">                (in, form.format(source), rb.getString(&quot;no&quot;));</span>
<span class="nc bnc" id="L3028" title="All 2 branches missed.">        } while (collator.compare(userInput, rb.getString(&quot;yes&quot;)) != 0 &amp;&amp;</span>
<span class="nc bnc" id="L3029" title="All 2 branches missed.">                 collator.compare(userInput, rb.getString(&quot;y&quot;)) != 0);</span>

<span class="nc" id="L3031">        System.err.println();</span>
<span class="nc" id="L3032">        return name;</span>
    }

    private String inputString(BufferedReader in, String prompt,
                               String defaultValue)
        throws IOException
    {
<span class="nc" id="L3039">        System.err.println(prompt);</span>
<span class="nc" id="L3040">        MessageFormat form = new MessageFormat</span>
<span class="nc" id="L3041">                (rb.getString(&quot;.defaultValue.&quot;));</span>
<span class="nc" id="L3042">        Object[] source = {defaultValue};</span>
<span class="nc" id="L3043">        System.err.print(form.format(source));</span>
<span class="nc" id="L3044">        System.err.flush();</span>

<span class="nc" id="L3046">        String value = in.readLine();</span>
<span class="nc bnc" id="L3047" title="All 4 branches missed.">        if (value == null || collator.compare(value, &quot;&quot;) == 0) {</span>
<span class="nc" id="L3048">            value = defaultValue;</span>
        }
<span class="nc" id="L3050">        return value;</span>
    }

    /**
     * Writes an X.509 certificate in base64 or binary encoding to an output
     * stream.
     */
    private void dumpCert(Certificate cert, PrintStream out)
        throws IOException, CertificateException
    {
<span class="nc bnc" id="L3060" title="All 2 branches missed.">        if (rfc) {</span>
<span class="nc" id="L3061">            out.println(X509Factory.BEGIN_CERT);</span>
<span class="nc" id="L3062">            out.println(Base64.getMimeEncoder().encodeToString(cert.getEncoded()));</span>
<span class="nc" id="L3063">            out.println(X509Factory.END_CERT);</span>
        } else {
<span class="nc" id="L3065">            out.write(cert.getEncoded()); // binary</span>
        }
<span class="nc" id="L3067">    }</span>

    /**
     * Converts a byte to hex digit and writes to the supplied buffer
     */
    private void byte2hex(byte b, StringBuffer buf) {
<span class="nc" id="L3073">        char[] hexChars = { '0', '1', '2', '3', '4', '5', '6', '7', '8',</span>
                            '9', 'A', 'B', 'C', 'D', 'E', 'F' };
<span class="nc" id="L3075">        int high = ((b &amp; 0xf0) &gt;&gt; 4);</span>
<span class="nc" id="L3076">        int low = (b &amp; 0x0f);</span>
<span class="nc" id="L3077">        buf.append(hexChars[high]);</span>
<span class="nc" id="L3078">        buf.append(hexChars[low]);</span>
<span class="nc" id="L3079">    }</span>

    /**
     * Converts a byte array to hex string
     */
    private String toHexString(byte[] block) {
<span class="nc" id="L3085">        StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L3086">        int len = block.length;</span>
<span class="nc bnc" id="L3087" title="All 2 branches missed.">        for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L3088">             byte2hex(block[i], buf);</span>
<span class="nc bnc" id="L3089" title="All 2 branches missed.">             if (i &lt; len-1) {</span>
<span class="nc" id="L3090">                 buf.append(&quot;:&quot;);</span>
             }
        }
<span class="nc" id="L3093">        return buf.toString();</span>
    }

    /**
     * Recovers (private) key associated with given alias.
     *
     * @return an array of objects, where the 1st element in the array is the
     * recovered private key, and the 2nd element is the password used to
     * recover it.
     */
    private Pair&lt;Key,char[]&gt; recoverKey(String alias, char[] storePass,
                                       char[] keyPass)
        throws Exception
    {
<span class="nc" id="L3107">        Key key = null;</span>

<span class="nc bnc" id="L3109" title="All 2 branches missed.">        if (keyStore.containsAlias(alias) == false) {</span>
<span class="nc" id="L3110">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L3111">                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</span>
<span class="nc" id="L3112">            Object[] source = {alias};</span>
<span class="nc" id="L3113">            throw new Exception(form.format(source));</span>
        }
<span class="nc bnc" id="L3115" title="All 2 branches missed.">        if (!keyStore.entryInstanceOf(alias, KeyStore.PrivateKeyEntry.class) &amp;&amp;</span>
<span class="nc bnc" id="L3116" title="All 2 branches missed.">                !keyStore.entryInstanceOf(alias, KeyStore.SecretKeyEntry.class)) {</span>
<span class="nc" id="L3117">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L3118">                (rb.getString(&quot;Alias.alias.has.no.key&quot;));</span>
<span class="nc" id="L3119">            Object[] source = {alias};</span>
<span class="nc" id="L3120">            throw new Exception(form.format(source));</span>
        }

<span class="nc bnc" id="L3123" title="All 2 branches missed.">        if (keyPass == null) {</span>
            // Try to recover the key using the keystore password
            try {
<span class="nc" id="L3126">                key = keyStore.getKey(alias, storePass);</span>

<span class="nc" id="L3128">                keyPass = storePass;</span>
<span class="nc" id="L3129">                passwords.add(keyPass);</span>
<span class="nc" id="L3130">            } catch (UnrecoverableKeyException e) {</span>
                // Did not work out, so prompt user for key password
<span class="nc bnc" id="L3132" title="All 2 branches missed.">                if (!token) {</span>
<span class="nc" id="L3133">                    keyPass = getKeyPasswd(alias, null, null);</span>
<span class="nc" id="L3134">                    key = keyStore.getKey(alias, keyPass);</span>
                } else {
<span class="nc" id="L3136">                    throw e;</span>
                }
<span class="nc" id="L3138">            }</span>
        } else {
<span class="nc" id="L3140">            key = keyStore.getKey(alias, keyPass);</span>
        }

<span class="nc" id="L3143">        return Pair.of(key, keyPass);</span>
    }

    /**
     * Recovers entry associated with given alias.
     *
     * @return an array of objects, where the 1st element in the array is the
     * recovered entry, and the 2nd element is the password used to
     * recover it (null if no password).
     */
    private Pair&lt;Entry,char[]&gt; recoverEntry(KeyStore ks,
                            String alias,
                            char[] pstore,
                            char[] pkey) throws Exception {

<span class="nc bnc" id="L3158" title="All 2 branches missed.">        if (ks.containsAlias(alias) == false) {</span>
<span class="nc" id="L3159">            MessageFormat form = new MessageFormat</span>
<span class="nc" id="L3160">                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</span>
<span class="nc" id="L3161">            Object[] source = {alias};</span>
<span class="nc" id="L3162">            throw new Exception(form.format(source));</span>
        }

<span class="nc" id="L3165">        PasswordProtection pp = null;</span>
        Entry entry;

        try {
            // First attempt to access entry without key password
            // (PKCS11 entry or trusted certificate entry, for example)

<span class="nc" id="L3172">            entry = ks.getEntry(alias, pp);</span>
<span class="nc" id="L3173">            pkey = null;</span>
<span class="nc" id="L3174">        } catch (UnrecoverableEntryException une) {</span>

<span class="nc bnc" id="L3176" title="All 2 branches missed.">            if(P11KEYSTORE.equalsIgnoreCase(ks.getType()) ||</span>
<span class="nc bnc" id="L3177" title="All 2 branches missed.">                KeyStoreUtil.isWindowsKeyStore(ks.getType())) {</span>
                // should not happen, but a possibility
<span class="nc" id="L3179">                throw une;</span>
            }

            // entry is protected

<span class="nc bnc" id="L3184" title="All 2 branches missed.">            if (pkey != null) {</span>

                // try provided key password

<span class="nc" id="L3188">                pp = new PasswordProtection(pkey);</span>
<span class="nc" id="L3189">                entry = ks.getEntry(alias, pp);</span>

            } else {

                // try store pass

                try {
<span class="nc" id="L3196">                    pp = new PasswordProtection(pstore);</span>
<span class="nc" id="L3197">                    entry = ks.getEntry(alias, pp);</span>
<span class="nc" id="L3198">                    pkey = pstore;</span>
<span class="nc" id="L3199">                } catch (UnrecoverableEntryException une2) {</span>
<span class="nc bnc" id="L3200" title="All 2 branches missed.">                    if (P12KEYSTORE.equalsIgnoreCase(ks.getType())) {</span>

                        // P12 keystore currently does not support separate
                        // store and entry passwords

<span class="nc" id="L3205">                        throw une2;</span>
                    } else {

                        // prompt for entry password

<span class="nc" id="L3210">                        pkey = getKeyPasswd(alias, null, null);</span>
<span class="nc" id="L3211">                        pp = new PasswordProtection(pkey);</span>
<span class="nc" id="L3212">                        entry = ks.getEntry(alias, pp);</span>
                    }
<span class="nc" id="L3214">                }</span>
            }
<span class="nc" id="L3216">        }</span>

<span class="nc" id="L3218">        return Pair.of(entry, pkey);</span>
    }
    /**
     * Gets the requested finger print of the certificate.
     */
    private String getCertFingerPrint(String mdAlg, Certificate cert)
        throws Exception
    {
<span class="nc" id="L3226">        byte[] encCertInfo = cert.getEncoded();</span>
<span class="nc" id="L3227">        MessageDigest md = MessageDigest.getInstance(mdAlg);</span>
<span class="nc" id="L3228">        byte[] digest = md.digest(encCertInfo);</span>
<span class="nc" id="L3229">        return toHexString(digest);</span>
    }

    /**
     * Prints warning about missing integrity check.
     */
    private void printWarning() {
<span class="nc" id="L3236">        System.err.println();</span>
<span class="nc" id="L3237">        System.err.println(rb.getString</span>
<span class="nc" id="L3238">            (&quot;.WARNING.WARNING.WARNING.&quot;));</span>
<span class="nc" id="L3239">        System.err.println(rb.getString</span>
<span class="nc" id="L3240">            (&quot;.The.integrity.of.the.information.stored.in.your.keystore.&quot;));</span>
<span class="nc" id="L3241">        System.err.println(rb.getString</span>
<span class="nc" id="L3242">            (&quot;.WARNING.WARNING.WARNING.&quot;));</span>
<span class="nc" id="L3243">        System.err.println();</span>
<span class="nc" id="L3244">    }</span>

    /**
     * Validates chain in certification reply, and returns the ordered
     * elements of the chain (with user certificate first, and root
     * certificate last in the array).
     *
     * @param alias the alias name
     * @param userCert the user certificate of the alias
     * @param replyCerts the chain provided in the reply
     */
    private Certificate[] validateReply(String alias,
                                        Certificate userCert,
                                        Certificate[] replyCerts)
        throws Exception
    {
        // order the certs in the reply (bottom-up).
        // we know that all certs in the reply are of type X.509, because
        // we parsed them using an X.509 certificate factory
        int i;
<span class="nc" id="L3264">        PublicKey userPubKey = userCert.getPublicKey();</span>
<span class="nc bnc" id="L3265" title="All 2 branches missed.">        for (i=0; i&lt;replyCerts.length; i++) {</span>
<span class="nc bnc" id="L3266" title="All 2 branches missed.">            if (userPubKey.equals(replyCerts[i].getPublicKey())) {</span>
<span class="nc" id="L3267">                break;</span>
            }
        }
<span class="nc bnc" id="L3270" title="All 2 branches missed.">        if (i == replyCerts.length) {</span>
<span class="nc" id="L3271">            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L3272">                (&quot;Certificate.reply.does.not.contain.public.key.for.alias.&quot;));</span>
<span class="nc" id="L3273">            Object[] source = {alias};</span>
<span class="nc" id="L3274">            throw new Exception(form.format(source));</span>
        }

<span class="nc" id="L3277">        Certificate tmpCert = replyCerts[0];</span>
<span class="nc" id="L3278">        replyCerts[0] = replyCerts[i];</span>
<span class="nc" id="L3279">        replyCerts[i] = tmpCert;</span>

<span class="nc" id="L3281">        X509Certificate thisCert = (X509Certificate)replyCerts[0];</span>

<span class="nc bnc" id="L3283" title="All 2 branches missed.">        for (i=1; i &lt; replyCerts.length-1; i++) {</span>
            // find a cert in the reply who signs thisCert
            int j;
<span class="nc bnc" id="L3286" title="All 2 branches missed.">            for (j=i; j&lt;replyCerts.length; j++) {</span>
<span class="nc bnc" id="L3287" title="All 2 branches missed.">                if (signedBy(thisCert, (X509Certificate)replyCerts[j])) {</span>
<span class="nc" id="L3288">                    tmpCert = replyCerts[i];</span>
<span class="nc" id="L3289">                    replyCerts[i] = replyCerts[j];</span>
<span class="nc" id="L3290">                    replyCerts[j] = tmpCert;</span>
<span class="nc" id="L3291">                    thisCert = (X509Certificate)replyCerts[i];</span>
<span class="nc" id="L3292">                    break;</span>
                }
            }
<span class="nc bnc" id="L3295" title="All 2 branches missed.">            if (j == replyCerts.length) {</span>
<span class="nc" id="L3296">                throw new Exception</span>
<span class="nc" id="L3297">                    (rb.getString(&quot;Incomplete.certificate.chain.in.reply&quot;));</span>
            }
        }

<span class="nc bnc" id="L3301" title="All 2 branches missed.">        if (noprompt) {</span>
<span class="nc" id="L3302">            return replyCerts;</span>
        }

        // do we trust the cert at the top?
<span class="nc" id="L3306">        Certificate topCert = replyCerts[replyCerts.length-1];</span>
<span class="nc" id="L3307">        Certificate root = getTrustedSigner(topCert, keyStore);</span>
<span class="nc bnc" id="L3308" title="All 6 branches missed.">        if (root == null &amp;&amp; trustcacerts &amp;&amp; caks != null) {</span>
<span class="nc" id="L3309">            root = getTrustedSigner(topCert, caks);</span>
        }
<span class="nc bnc" id="L3311" title="All 2 branches missed.">        if (root == null) {</span>
<span class="nc" id="L3312">            System.err.println();</span>
<span class="nc" id="L3313">            System.err.println</span>
<span class="nc" id="L3314">                    (rb.getString(&quot;Top.level.certificate.in.reply.&quot;));</span>
<span class="nc" id="L3315">            printX509Cert((X509Certificate)topCert, System.out);</span>
<span class="nc" id="L3316">            System.err.println();</span>
<span class="nc" id="L3317">            System.err.print(rb.getString(&quot;.is.not.trusted.&quot;));</span>
<span class="nc" id="L3318">            String reply = getYesNoReply</span>
<span class="nc" id="L3319">                    (rb.getString(&quot;Install.reply.anyway.no.&quot;));</span>
<span class="nc bnc" id="L3320" title="All 2 branches missed.">            if (&quot;NO&quot;.equals(reply)) {</span>
<span class="nc" id="L3321">                return null;</span>
            }
<span class="nc" id="L3323">        } else {</span>
<span class="nc bnc" id="L3324" title="All 2 branches missed.">            if (root != topCert) {</span>
                // append the root CA cert to the chain
<span class="nc" id="L3326">                Certificate[] tmpCerts =</span>
                    new Certificate[replyCerts.length+1];
<span class="nc" id="L3328">                System.arraycopy(replyCerts, 0, tmpCerts, 0,</span>
                                 replyCerts.length);
<span class="nc" id="L3330">                tmpCerts[tmpCerts.length-1] = root;</span>
<span class="nc" id="L3331">                replyCerts = tmpCerts;</span>
            }
        }

<span class="nc" id="L3335">        return replyCerts;</span>
    }

    /**
     * Establishes a certificate chain (using trusted certificates in the
     * keystore), starting with the user certificate
     * and ending at a self-signed certificate found in the keystore.
     *
     * @param userCert the user certificate of the alias
     * @param certToVerify the single certificate provided in the reply
     */
    private Certificate[] establishCertChain(Certificate userCert,
                                             Certificate certToVerify)
        throws Exception
    {
<span class="nc bnc" id="L3350" title="All 2 branches missed.">        if (userCert != null) {</span>
            // Make sure that the public key of the certificate reply matches
            // the original public key in the keystore
<span class="nc" id="L3353">            PublicKey origPubKey = userCert.getPublicKey();</span>
<span class="nc" id="L3354">            PublicKey replyPubKey = certToVerify.getPublicKey();</span>
<span class="nc bnc" id="L3355" title="All 2 branches missed.">            if (!origPubKey.equals(replyPubKey)) {</span>
<span class="nc" id="L3356">                throw new Exception(rb.getString</span>
<span class="nc" id="L3357">                        (&quot;Public.keys.in.reply.and.keystore.don.t.match&quot;));</span>
            }

            // If the two certs are identical, we're done: no need to import
            // anything
<span class="nc bnc" id="L3362" title="All 2 branches missed.">            if (certToVerify.equals(userCert)) {</span>
<span class="nc" id="L3363">                throw new Exception(rb.getString</span>
<span class="nc" id="L3364">                        (&quot;Certificate.reply.and.certificate.in.keystore.are.identical&quot;));</span>
            }
        }

        // Build a hash table of all certificates in the keystore.
        // Use the subject distinguished name as the key into the hash table.
        // All certificates associated with the same subject distinguished
        // name are stored in the same hash table entry as a vector.
<span class="nc" id="L3372">        Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt; certs = null;</span>
<span class="nc bnc" id="L3373" title="All 2 branches missed.">        if (keyStore.size() &gt; 0) {</span>
<span class="nc" id="L3374">            certs = new Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt;(11);</span>
<span class="nc" id="L3375">            keystorecerts2Hashtable(keyStore, certs);</span>
        }
<span class="nc bnc" id="L3377" title="All 2 branches missed.">        if (trustcacerts) {</span>
<span class="nc bnc" id="L3378" title="All 4 branches missed.">            if (caks!=null &amp;&amp; caks.size()&gt;0) {</span>
<span class="nc bnc" id="L3379" title="All 2 branches missed.">                if (certs == null) {</span>
<span class="nc" id="L3380">                    certs = new Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt;(11);</span>
                }
<span class="nc" id="L3382">                keystorecerts2Hashtable(caks, certs);</span>
            }
        }

        // start building chain
<span class="nc" id="L3387">        Vector&lt;Certificate&gt; chain = new Vector&lt;&gt;(2);</span>
<span class="nc bnc" id="L3388" title="All 2 branches missed.">        if (buildChain((X509Certificate)certToVerify, chain, certs)) {</span>
<span class="nc" id="L3389">            Certificate[] newChain = new Certificate[chain.size()];</span>
            // buildChain() returns chain with self-signed root-cert first and
            // user-cert last, so we need to invert the chain before we store
            // it
<span class="nc" id="L3393">            int j=0;</span>
<span class="nc bnc" id="L3394" title="All 2 branches missed.">            for (int i=chain.size()-1; i&gt;=0; i--) {</span>
<span class="nc" id="L3395">                newChain[j] = chain.elementAt(i);</span>
<span class="nc" id="L3396">                j++;</span>
            }
<span class="nc" id="L3398">            return newChain;</span>
        } else {
<span class="nc" id="L3400">            throw new Exception</span>
<span class="nc" id="L3401">                (rb.getString(&quot;Failed.to.establish.chain.from.reply&quot;));</span>
        }
    }

    /**
     * Recursively tries to establish chain from pool of trusted certs.
     *
     * @param certToVerify the cert that needs to be verified.
     * @param chain the chain that's being built.
     * @param certs the pool of trusted certs
     *
     * @return true if successful, false otherwise.
     */
    private boolean buildChain(X509Certificate certToVerify,
                        Vector&lt;Certificate&gt; chain,
                        Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt; certs) {
<span class="nc" id="L3417">        Principal issuer = certToVerify.getIssuerDN();</span>
<span class="nc bnc" id="L3418" title="All 2 branches missed.">        if (isSelfSigned(certToVerify)) {</span>
            // reached self-signed root cert;
            // no verification needed because it's trusted.
<span class="nc" id="L3421">            chain.addElement(certToVerify);</span>
<span class="nc" id="L3422">            return true;</span>
        }

        // Get the issuer's certificate(s)
<span class="nc" id="L3426">        Vector&lt;Certificate&gt; vec = certs.get(issuer);</span>
<span class="nc bnc" id="L3427" title="All 2 branches missed.">        if (vec == null) {</span>
<span class="nc" id="L3428">            return false;</span>
        }

        // Try out each certificate in the vector, until we find one
        // whose public key verifies the signature of the certificate
        // in question.
<span class="nc" id="L3434">        for (Enumeration&lt;Certificate&gt; issuerCerts = vec.elements();</span>
<span class="nc bnc" id="L3435" title="All 2 branches missed.">             issuerCerts.hasMoreElements(); ) {</span>
<span class="nc" id="L3436">            X509Certificate issuerCert</span>
<span class="nc" id="L3437">                = (X509Certificate)issuerCerts.nextElement();</span>
<span class="nc" id="L3438">            PublicKey issuerPubKey = issuerCert.getPublicKey();</span>
            try {
<span class="nc" id="L3440">                certToVerify.verify(issuerPubKey);</span>
<span class="nc" id="L3441">            } catch (Exception e) {</span>
<span class="nc" id="L3442">                continue;</span>
<span class="nc" id="L3443">            }</span>
<span class="nc bnc" id="L3444" title="All 2 branches missed.">            if (buildChain(issuerCert, chain, certs)) {</span>
<span class="nc" id="L3445">                chain.addElement(certToVerify);</span>
<span class="nc" id="L3446">                return true;</span>
            }
<span class="nc" id="L3448">        }</span>
<span class="nc" id="L3449">        return false;</span>
    }

    /**
     * Prompts user for yes/no decision.
     *
     * @return the user's decision, can only be &quot;YES&quot; or &quot;NO&quot;
     */
    private String getYesNoReply(String prompt)
        throws IOException
    {
<span class="nc" id="L3460">        String reply = null;</span>
<span class="nc" id="L3461">        int maxRetry = 20;</span>
        do {
<span class="nc bnc" id="L3463" title="All 2 branches missed.">            if (maxRetry-- &lt; 0) {</span>
<span class="nc" id="L3464">                throw new RuntimeException(rb.getString(</span>
                        &quot;Too.many.retries.program.terminated&quot;));
            }
<span class="nc" id="L3467">            System.err.print(prompt);</span>
<span class="nc" id="L3468">            System.err.flush();</span>
<span class="nc" id="L3469">            reply = (new BufferedReader(new InputStreamReader</span>
<span class="nc" id="L3470">                                        (System.in))).readLine();</span>
<span class="nc bnc" id="L3471" title="All 2 branches missed.">            if (collator.compare(reply, &quot;&quot;) == 0 ||</span>
<span class="nc bnc" id="L3472" title="All 2 branches missed.">                collator.compare(reply, rb.getString(&quot;n&quot;)) == 0 ||</span>
<span class="nc bnc" id="L3473" title="All 2 branches missed.">                collator.compare(reply, rb.getString(&quot;no&quot;)) == 0) {</span>
<span class="nc" id="L3474">                reply = &quot;NO&quot;;</span>
<span class="nc bnc" id="L3475" title="All 2 branches missed.">            } else if (collator.compare(reply, rb.getString(&quot;y&quot;)) == 0 ||</span>
<span class="nc bnc" id="L3476" title="All 2 branches missed.">                       collator.compare(reply, rb.getString(&quot;yes&quot;)) == 0) {</span>
<span class="nc" id="L3477">                reply = &quot;YES&quot;;</span>
            } else {
<span class="nc" id="L3479">                System.err.println(rb.getString(&quot;Wrong.answer.try.again&quot;));</span>
<span class="nc" id="L3480">                reply = null;</span>
            }
<span class="nc bnc" id="L3482" title="All 2 branches missed.">        } while (reply == null);</span>
<span class="nc" id="L3483">        return reply;</span>
    }

    /**
     * Stores the (leaf) certificates of a keystore in a hashtable.
     * All certs belonging to the same CA are stored in a vector that
     * in turn is stored in the hashtable, keyed by the CA's subject DN
     */
    private void keystorecerts2Hashtable(KeyStore ks,
                Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt; hash)
        throws Exception {

<span class="nc" id="L3495">        for (Enumeration&lt;String&gt; aliases = ks.aliases();</span>
<span class="nc bnc" id="L3496" title="All 2 branches missed.">                                        aliases.hasMoreElements(); ) {</span>
<span class="nc" id="L3497">            String alias = aliases.nextElement();</span>
<span class="nc" id="L3498">            Certificate cert = ks.getCertificate(alias);</span>
<span class="nc bnc" id="L3499" title="All 2 branches missed.">            if (cert != null) {</span>
<span class="nc" id="L3500">                Principal subjectDN = ((X509Certificate)cert).getSubjectDN();</span>
<span class="nc" id="L3501">                Vector&lt;Certificate&gt; vec = hash.get(subjectDN);</span>
<span class="nc bnc" id="L3502" title="All 2 branches missed.">                if (vec == null) {</span>
<span class="nc" id="L3503">                    vec = new Vector&lt;Certificate&gt;();</span>
<span class="nc" id="L3504">                    vec.addElement(cert);</span>
                } else {
<span class="nc bnc" id="L3506" title="All 2 branches missed.">                    if (!vec.contains(cert)) {</span>
<span class="nc" id="L3507">                        vec.addElement(cert);</span>
                    }
                }
<span class="nc" id="L3510">                hash.put(subjectDN, vec);</span>
            }
<span class="nc" id="L3512">        }</span>
<span class="nc" id="L3513">    }</span>

    /**
     * Returns the issue time that's specified the -startdate option
     * @param s the value of -startdate option
     */
    private static Date getStartDate(String s) throws IOException {
<span class="nc" id="L3520">        Calendar c = new GregorianCalendar();</span>
<span class="nc bnc" id="L3521" title="All 2 branches missed.">        if (s != null) {</span>
<span class="nc" id="L3522">            IOException ioe = new IOException(</span>
<span class="nc" id="L3523">                    rb.getString(&quot;Illegal.startdate.value&quot;));</span>
<span class="nc" id="L3524">            int len = s.length();</span>
<span class="nc bnc" id="L3525" title="All 2 branches missed.">            if (len == 0) {</span>
<span class="nc" id="L3526">                throw ioe;</span>
            }
<span class="nc bnc" id="L3528" title="All 4 branches missed.">            if (s.charAt(0) == '-' || s.charAt(0) == '+') {</span>
                // Form 1: ([+-]nnn[ymdHMS])+
<span class="nc" id="L3530">                int start = 0;</span>
<span class="nc bnc" id="L3531" title="All 2 branches missed.">                while (start &lt; len) {</span>
<span class="nc" id="L3532">                    int sign = 0;</span>
<span class="nc bnc" id="L3533" title="All 3 branches missed.">                    switch (s.charAt(start)) {</span>
<span class="nc" id="L3534">                        case '+': sign = 1; break;</span>
<span class="nc" id="L3535">                        case '-': sign = -1; break;</span>
<span class="nc" id="L3536">                        default: throw ioe;</span>
                    }
<span class="nc" id="L3538">                    int i = start+1;</span>
<span class="nc bnc" id="L3539" title="All 2 branches missed.">                    for (; i&lt;len; i++) {</span>
<span class="nc" id="L3540">                        char ch = s.charAt(i);</span>
<span class="nc bnc" id="L3541" title="All 4 branches missed.">                        if (ch &lt; '0' || ch &gt; '9') break;</span>
                    }
<span class="nc bnc" id="L3543" title="All 2 branches missed.">                    if (i == start+1) throw ioe;</span>
<span class="nc" id="L3544">                    int number = Integer.parseInt(s.substring(start+1, i));</span>
<span class="nc bnc" id="L3545" title="All 2 branches missed.">                    if (i &gt;= len) throw ioe;</span>
<span class="nc" id="L3546">                    int unit = 0;</span>
<span class="nc bnc" id="L3547" title="All 7 branches missed.">                    switch (s.charAt(i)) {</span>
<span class="nc" id="L3548">                        case 'y': unit = Calendar.YEAR; break;</span>
<span class="nc" id="L3549">                        case 'm': unit = Calendar.MONTH; break;</span>
<span class="nc" id="L3550">                        case 'd': unit = Calendar.DATE; break;</span>
<span class="nc" id="L3551">                        case 'H': unit = Calendar.HOUR; break;</span>
<span class="nc" id="L3552">                        case 'M': unit = Calendar.MINUTE; break;</span>
<span class="nc" id="L3553">                        case 'S': unit = Calendar.SECOND; break;</span>
<span class="nc" id="L3554">                        default: throw ioe;</span>
                    }
<span class="nc" id="L3556">                    c.add(unit, sign * number);</span>
<span class="nc" id="L3557">                    start = i + 1;</span>
<span class="nc" id="L3558">                }</span>
<span class="nc" id="L3559">            } else  {</span>
                // Form 2: [yyyy/mm/dd] [HH:MM:SS]
<span class="nc" id="L3561">                String date = null, time = null;</span>
<span class="nc bnc" id="L3562" title="All 2 branches missed.">                if (len == 19) {</span>
<span class="nc" id="L3563">                    date = s.substring(0, 10);</span>
<span class="nc" id="L3564">                    time = s.substring(11);</span>
<span class="nc bnc" id="L3565" title="All 2 branches missed.">                    if (s.charAt(10) != ' ')</span>
<span class="nc" id="L3566">                        throw ioe;</span>
<span class="nc bnc" id="L3567" title="All 2 branches missed.">                } else if (len == 10) {</span>
<span class="nc" id="L3568">                    date = s;</span>
<span class="nc bnc" id="L3569" title="All 2 branches missed.">                } else if (len == 8) {</span>
<span class="nc" id="L3570">                    time = s;</span>
                } else {
<span class="nc" id="L3572">                    throw ioe;</span>
                }
<span class="nc bnc" id="L3574" title="All 2 branches missed.">                if (date != null) {</span>
<span class="nc bnc" id="L3575" title="All 2 branches missed.">                    if (date.matches(&quot;\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d&quot;)) {</span>
<span class="nc" id="L3576">                        c.set(Integer.valueOf(date.substring(0, 4)),</span>
<span class="nc" id="L3577">                                Integer.valueOf(date.substring(5, 7))-1,</span>
<span class="nc" id="L3578">                                Integer.valueOf(date.substring(8, 10)));</span>
                    } else {
<span class="nc" id="L3580">                        throw ioe;</span>
                    }
                }
<span class="nc bnc" id="L3583" title="All 2 branches missed.">                if (time != null) {</span>
<span class="nc bnc" id="L3584" title="All 2 branches missed.">                    if (time.matches(&quot;\\d\\d:\\d\\d:\\d\\d&quot;)) {</span>
<span class="nc" id="L3585">                        c.set(Calendar.HOUR_OF_DAY, Integer.valueOf(time.substring(0, 2)));</span>
<span class="nc" id="L3586">                        c.set(Calendar.MINUTE, Integer.valueOf(time.substring(0, 2)));</span>
<span class="nc" id="L3587">                        c.set(Calendar.SECOND, Integer.valueOf(time.substring(0, 2)));</span>
<span class="nc" id="L3588">                        c.set(Calendar.MILLISECOND, 0);</span>
                    } else {
<span class="nc" id="L3590">                        throw ioe;</span>
                    }
                }
            }
        }
<span class="nc" id="L3595">        return c.getTime();</span>
    }

    /**
     * Match a command (may be abbreviated) with a command set.
     * @param s the command provided
     * @param list the legal command set. If there is a null, commands after it
     * are regarded experimental, which means they are supported but their
     * existence should not be revealed to user.
     * @return the position of a single match, or -1 if none matched
     * @throws Exception if s is ambiguous
     */
    private static int oneOf(String s, String... list) throws Exception {
<span class="nc" id="L3608">        int[] match = new int[list.length];</span>
<span class="nc" id="L3609">        int nmatch = 0;</span>
<span class="nc" id="L3610">        int experiment = Integer.MAX_VALUE;</span>
<span class="nc bnc" id="L3611" title="All 2 branches missed.">        for (int i = 0; i&lt;list.length; i++) {</span>
<span class="nc" id="L3612">            String one = list[i];</span>
<span class="nc bnc" id="L3613" title="All 2 branches missed.">            if (one == null) {</span>
<span class="nc" id="L3614">                experiment = i;</span>
<span class="nc" id="L3615">                continue;</span>
            }
<span class="nc" id="L3617">            if (one.toLowerCase(Locale.ENGLISH)</span>
<span class="nc bnc" id="L3618" title="All 2 branches missed.">                    .startsWith(s.toLowerCase(Locale.ENGLISH))) {</span>
<span class="nc" id="L3619">                match[nmatch++] = i;</span>
            } else {
<span class="nc" id="L3621">                StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L3622">                boolean first = true;</span>
<span class="nc bnc" id="L3623" title="All 2 branches missed.">                for (char c: one.toCharArray()) {</span>
<span class="nc bnc" id="L3624" title="All 2 branches missed.">                    if (first) {</span>
<span class="nc" id="L3625">                        sb.append(c);</span>
<span class="nc" id="L3626">                        first = false;</span>
                    } else {
<span class="nc bnc" id="L3628" title="All 2 branches missed.">                        if (!Character.isLowerCase(c)) {</span>
<span class="nc" id="L3629">                            sb.append(c);</span>
                        }
                    }
                }
<span class="nc bnc" id="L3633" title="All 2 branches missed.">                if (sb.toString().equalsIgnoreCase(s)) {</span>
<span class="nc" id="L3634">                    match[nmatch++] = i;</span>
                }
            }
        }
<span class="nc bnc" id="L3638" title="All 2 branches missed.">        if (nmatch == 0) {</span>
<span class="nc" id="L3639">            return -1;</span>
<span class="nc bnc" id="L3640" title="All 2 branches missed.">        } else if (nmatch == 1) {</span>
<span class="nc" id="L3641">            return match[0];</span>
        } else {
            // If multiple matches is in experimental commands, ignore them
<span class="nc bnc" id="L3644" title="All 2 branches missed.">            if (match[1] &gt; experiment) {</span>
<span class="nc" id="L3645">                return match[0];</span>
            }
<span class="nc" id="L3647">            StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L3648">            MessageFormat form = new MessageFormat(rb.getString</span>
<span class="nc" id="L3649">                (&quot;command.{0}.is.ambiguous.&quot;));</span>
<span class="nc" id="L3650">            Object[] source = {s};</span>
<span class="nc" id="L3651">            sb.append(form.format(source));</span>
<span class="nc" id="L3652">            sb.append(&quot;\n    &quot;);</span>
<span class="nc bnc" id="L3653" title="All 4 branches missed.">            for (int i=0; i&lt;nmatch &amp;&amp; match[i]&lt;experiment; i++) {</span>
<span class="nc" id="L3654">                sb.append(' ');</span>
<span class="nc" id="L3655">                sb.append(list[match[i]]);</span>
            }
<span class="nc" id="L3657">            throw new Exception(sb.toString());</span>
        }
    }

    /**
     * Create a GeneralName object from known types
     * @param t one of 5 known types
     * @param v value
     * @return which one
     */
    private GeneralName createGeneralName(String t, String v)
            throws Exception {
        GeneralNameInterface gn;
<span class="nc" id="L3670">        int p = oneOf(t, &quot;EMAIL&quot;, &quot;URI&quot;, &quot;DNS&quot;, &quot;IP&quot;, &quot;OID&quot;);</span>
<span class="nc bnc" id="L3671" title="All 2 branches missed.">        if (p &lt; 0) {</span>
<span class="nc" id="L3672">            throw new Exception(rb.getString(</span>
                    &quot;Unrecognized.GeneralName.type.&quot;) + t);
        }
<span class="nc bnc" id="L3675" title="All 5 branches missed.">        switch (p) {</span>
<span class="nc" id="L3676">            case 0: gn = new RFC822Name(v); break;</span>
<span class="nc" id="L3677">            case 1: gn = new URIName(v); break;</span>
<span class="nc" id="L3678">            case 2: gn = new DNSName(v); break;</span>
<span class="nc" id="L3679">            case 3: gn = new IPAddressName(v); break;</span>
<span class="nc" id="L3680">            default: gn = new OIDName(v); break; //4</span>
        }
<span class="nc" id="L3682">        return new GeneralName(gn);</span>
    }

<span class="nc" id="L3685">    private static final String[] extSupported = {</span>
                        &quot;BasicConstraints&quot;,
                        &quot;KeyUsage&quot;,
                        &quot;ExtendedKeyUsage&quot;,
                        &quot;SubjectAlternativeName&quot;,
                        &quot;IssuerAlternativeName&quot;,
                        &quot;SubjectInfoAccess&quot;,
                        &quot;AuthorityInfoAccess&quot;,
                        null,
                        &quot;CRLDistributionPoints&quot;,
    };

    private ObjectIdentifier findOidForExtName(String type)
            throws Exception {
<span class="nc bnc" id="L3699" title="All 9 branches missed.">        switch (oneOf(type, extSupported)) {</span>
<span class="nc" id="L3700">            case 0: return PKIXExtensions.BasicConstraints_Id;</span>
<span class="nc" id="L3701">            case 1: return PKIXExtensions.KeyUsage_Id;</span>
<span class="nc" id="L3702">            case 2: return PKIXExtensions.ExtendedKeyUsage_Id;</span>
<span class="nc" id="L3703">            case 3: return PKIXExtensions.SubjectAlternativeName_Id;</span>
<span class="nc" id="L3704">            case 4: return PKIXExtensions.IssuerAlternativeName_Id;</span>
<span class="nc" id="L3705">            case 5: return PKIXExtensions.SubjectInfoAccess_Id;</span>
<span class="nc" id="L3706">            case 6: return PKIXExtensions.AuthInfoAccess_Id;</span>
<span class="nc" id="L3707">            case 8: return PKIXExtensions.CRLDistributionPoints_Id;</span>
<span class="nc" id="L3708">            default: return new ObjectIdentifier(type);</span>
        }
    }

    /**
     * Create X509v3 extensions from a string representation. Note that the
     * SubjectKeyIdentifierExtension will always be created non-critical besides
     * the extension requested in the &lt;code&gt;extstr&lt;/code&gt; argument.
     *
     * @param reqex the requested extensions, can be null, used for -gencert
     * @param ext the original extensions, can be null, used for -selfcert
     * @param extstrs -ext values, Read keytool doc
     * @param pkey the public key for the certificate
     * @param akey the public key for the authority (issuer)
     * @return the created CertificateExtensions
     */
    private CertificateExtensions createV3Extensions(
            CertificateExtensions reqex,
            CertificateExtensions ext,
            List &lt;String&gt; extstrs,
            PublicKey pkey,
            PublicKey akey) throws Exception {

<span class="nc bnc" id="L3731" title="All 4 branches missed.">        if (ext != null &amp;&amp; reqex != null) {</span>
            // This should not happen
<span class="nc" id="L3733">            throw new Exception(&quot;One of request and original should be null.&quot;);</span>
        }
<span class="nc bnc" id="L3735" title="All 2 branches missed.">        if (ext == null) ext = new CertificateExtensions();</span>
        try {
            // name{:critical}{=value}
            // Honoring requested extensions
<span class="nc bnc" id="L3739" title="All 2 branches missed.">            if (reqex != null) {</span>
<span class="nc bnc" id="L3740" title="All 2 branches missed.">                for(String extstr: extstrs) {</span>
<span class="nc bnc" id="L3741" title="All 2 branches missed.">                    if (extstr.toLowerCase(Locale.ENGLISH).startsWith(&quot;honored=&quot;)) {</span>
<span class="nc" id="L3742">                        List&lt;String&gt; list = Arrays.asList(</span>
<span class="nc" id="L3743">                                extstr.toLowerCase(Locale.ENGLISH).substring(8).split(&quot;,&quot;));</span>
                        // First check existence of &quot;all&quot;
<span class="nc bnc" id="L3745" title="All 2 branches missed.">                        if (list.contains(&quot;all&quot;)) {</span>
<span class="nc" id="L3746">                            ext = reqex;    // we know ext was null</span>
                        }
                        // one by one for others
<span class="nc bnc" id="L3749" title="All 2 branches missed.">                        for (String item: list) {</span>
<span class="nc bnc" id="L3750" title="All 2 branches missed.">                            if (item.equals(&quot;all&quot;)) continue;</span>

                            // add or remove
<span class="nc" id="L3753">                            boolean add = true;</span>
                            // -1, unchanged, 0 crtical, 1 non-critical
<span class="nc" id="L3755">                            int action = -1;</span>
<span class="nc" id="L3756">                            String type = null;</span>
<span class="nc bnc" id="L3757" title="All 2 branches missed.">                            if (item.startsWith(&quot;-&quot;)) {</span>
<span class="nc" id="L3758">                                add = false;</span>
<span class="nc" id="L3759">                                type = item.substring(1);</span>
                            } else {
<span class="nc" id="L3761">                                int colonpos = item.indexOf(':');</span>
<span class="nc bnc" id="L3762" title="All 2 branches missed.">                                if (colonpos &gt;= 0) {</span>
<span class="nc" id="L3763">                                    type = item.substring(0, colonpos);</span>
<span class="nc" id="L3764">                                    action = oneOf(item.substring(colonpos+1),</span>
                                            &quot;critical&quot;, &quot;non-critical&quot;);
<span class="nc bnc" id="L3766" title="All 2 branches missed.">                                    if (action == -1) {</span>
<span class="nc" id="L3767">                                        throw new Exception(rb.getString</span>
<span class="nc" id="L3768">                                            (&quot;Illegal.value.&quot;) + item);</span>
                                    }
                                }
                            }
<span class="nc" id="L3772">                            String n = reqex.getNameByOid(findOidForExtName(type));</span>
<span class="nc bnc" id="L3773" title="All 2 branches missed.">                            if (add) {</span>
<span class="nc" id="L3774">                                Extension e = reqex.get(n);</span>
<span class="nc bnc" id="L3775" title="All 4 branches missed.">                                if (!e.isCritical() &amp;&amp; action == 0</span>
<span class="nc bnc" id="L3776" title="All 4 branches missed.">                                        || e.isCritical() &amp;&amp; action == 1) {</span>
<span class="nc" id="L3777">                                    e = Extension.newExtension(</span>
<span class="nc" id="L3778">                                            e.getExtensionId(),</span>
<span class="nc bnc" id="L3779" title="All 2 branches missed.">                                            !e.isCritical(),</span>
<span class="nc" id="L3780">                                            e.getExtensionValue());</span>
<span class="nc" id="L3781">                                    ext.set(n, e);</span>
                                }
<span class="nc" id="L3783">                            } else {</span>
<span class="nc" id="L3784">                                ext.delete(n);</span>
                            }
<span class="nc" id="L3786">                        }</span>
<span class="nc" id="L3787">                        break;</span>
                    }
<span class="nc" id="L3789">                }</span>
            }
<span class="nc bnc" id="L3791" title="All 2 branches missed.">            for(String extstr: extstrs) {</span>
                String name, value;
<span class="nc" id="L3793">                boolean isCritical = false;</span>

<span class="nc" id="L3795">                int eqpos = extstr.indexOf('=');</span>
<span class="nc bnc" id="L3796" title="All 2 branches missed.">                if (eqpos &gt;= 0) {</span>
<span class="nc" id="L3797">                    name = extstr.substring(0, eqpos);</span>
<span class="nc" id="L3798">                    value = extstr.substring(eqpos+1);</span>
                } else {
<span class="nc" id="L3800">                    name = extstr;</span>
<span class="nc" id="L3801">                    value = null;</span>
                }

<span class="nc" id="L3804">                int colonpos = name.indexOf(':');</span>
<span class="nc bnc" id="L3805" title="All 2 branches missed.">                if (colonpos &gt;= 0) {</span>
<span class="nc bnc" id="L3806" title="All 2 branches missed.">                    if (oneOf(name.substring(colonpos+1), &quot;critical&quot;) == 0) {</span>
<span class="nc" id="L3807">                        isCritical = true;</span>
                    }
<span class="nc" id="L3809">                    name = name.substring(0, colonpos);</span>
                }

<span class="nc bnc" id="L3812" title="All 2 branches missed.">                if (name.equalsIgnoreCase(&quot;honored&quot;)) {</span>
<span class="nc" id="L3813">                    continue;</span>
                }
<span class="nc" id="L3815">                int exttype = oneOf(name, extSupported);</span>
<span class="nc bnc" id="L3816" title="All 8 branches missed.">                switch (exttype) {</span>
                    case 0:     // BC
<span class="nc" id="L3818">                        int pathLen = -1;</span>
<span class="nc" id="L3819">                        boolean isCA = false;</span>
<span class="nc bnc" id="L3820" title="All 2 branches missed.">                        if (value == null) {</span>
<span class="nc" id="L3821">                            isCA = true;</span>
                        } else {
                            try {   // the abbr format
<span class="nc" id="L3824">                                pathLen = Integer.parseInt(value);</span>
<span class="nc" id="L3825">                                isCA = true;</span>
<span class="nc" id="L3826">                            } catch (NumberFormatException ufe) {</span>
                                // ca:true,pathlen:1
<span class="nc bnc" id="L3828" title="All 2 branches missed.">                                for (String part: value.split(&quot;,&quot;)) {</span>
<span class="nc" id="L3829">                                    String[] nv = part.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L3830" title="All 2 branches missed.">                                    if (nv.length != 2) {</span>
<span class="nc" id="L3831">                                        throw new Exception(rb.getString</span>
<span class="nc" id="L3832">                                                (&quot;Illegal.value.&quot;) + extstr);</span>
                                    } else {
<span class="nc bnc" id="L3834" title="All 2 branches missed.">                                        if (nv[0].equalsIgnoreCase(&quot;ca&quot;)) {</span>
<span class="nc" id="L3835">                                            isCA = Boolean.parseBoolean(nv[1]);</span>
<span class="nc bnc" id="L3836" title="All 2 branches missed.">                                        } else if (nv[0].equalsIgnoreCase(&quot;pathlen&quot;)) {</span>
<span class="nc" id="L3837">                                            pathLen = Integer.parseInt(nv[1]);</span>
                                        } else {
<span class="nc" id="L3839">                                            throw new Exception(rb.getString</span>
<span class="nc" id="L3840">                                                (&quot;Illegal.value.&quot;) + extstr);</span>
                                        }
                                    }
                                }
<span class="nc" id="L3844">                            }</span>
                        }
<span class="nc" id="L3846">                        ext.set(BasicConstraintsExtension.NAME,</span>
<span class="nc" id="L3847">                                new BasicConstraintsExtension(isCritical, isCA,</span>
                                pathLen));
<span class="nc" id="L3849">                        break;</span>
                    case 1:     // KU
<span class="nc bnc" id="L3851" title="All 2 branches missed.">                        if(value != null) {</span>
<span class="nc" id="L3852">                            boolean[] ok = new boolean[9];</span>
<span class="nc bnc" id="L3853" title="All 2 branches missed.">                            for (String s: value.split(&quot;,&quot;)) {</span>
<span class="nc" id="L3854">                                int p = oneOf(s,</span>
                                       &quot;digitalSignature&quot;,  // (0),
                                       &quot;nonRepudiation&quot;,    // (1)
                                       &quot;keyEncipherment&quot;,   // (2),
                                       &quot;dataEncipherment&quot;,  // (3),
                                       &quot;keyAgreement&quot;,      // (4),
                                       &quot;keyCertSign&quot;,       // (5),
                                       &quot;cRLSign&quot;,           // (6),
                                       &quot;encipherOnly&quot;,      // (7),
                                       &quot;decipherOnly&quot;,      // (8)
                                       &quot;contentCommitment&quot;  // also (1)
                                       );
<span class="nc bnc" id="L3866" title="All 2 branches missed.">                                if (p &lt; 0) {</span>
<span class="nc" id="L3867">                                    throw new Exception(rb.getString(&quot;Unknown.keyUsage.type.&quot;) + s);</span>
                                }
<span class="nc bnc" id="L3869" title="All 2 branches missed.">                                if (p == 9) p = 1;</span>
<span class="nc" id="L3870">                                ok[p] = true;</span>
                            }
<span class="nc" id="L3872">                            KeyUsageExtension kue = new KeyUsageExtension(ok);</span>
                            // The above KeyUsageExtension constructor does not
                            // allow isCritical value, so...
<span class="nc" id="L3875">                            ext.set(KeyUsageExtension.NAME, Extension.newExtension(</span>
<span class="nc" id="L3876">                                    kue.getExtensionId(),</span>
                                    isCritical,
<span class="nc" id="L3878">                                    kue.getExtensionValue()));</span>
<span class="nc" id="L3879">                        } else {</span>
<span class="nc" id="L3880">                            throw new Exception(rb.getString</span>
<span class="nc" id="L3881">                                    (&quot;Illegal.value.&quot;) + extstr);</span>
                        }
                        break;
                    case 2:     // EKU
<span class="nc bnc" id="L3885" title="All 2 branches missed.">                        if(value != null) {</span>
<span class="nc" id="L3886">                            Vector&lt;ObjectIdentifier&gt; v = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L3887" title="All 2 branches missed.">                            for (String s: value.split(&quot;,&quot;)) {</span>
<span class="nc" id="L3888">                                int p = oneOf(s,</span>
                                        &quot;anyExtendedKeyUsage&quot;,
                                        &quot;serverAuth&quot;,       //1
                                        &quot;clientAuth&quot;,       //2
                                        &quot;codeSigning&quot;,      //3
                                        &quot;emailProtection&quot;,  //4
                                        &quot;&quot;,                 //5
                                        &quot;&quot;,                 //6
                                        &quot;&quot;,                 //7
                                        &quot;timeStamping&quot;,     //8
                                        &quot;OCSPSigning&quot;       //9
                                       );
<span class="nc bnc" id="L3900" title="All 2 branches missed.">                                if (p &lt; 0) {</span>
                                    try {
<span class="nc" id="L3902">                                        v.add(new ObjectIdentifier(s));</span>
<span class="nc" id="L3903">                                    } catch (Exception e) {</span>
<span class="nc" id="L3904">                                        throw new Exception(rb.getString(</span>
                                                &quot;Unknown.extendedkeyUsage.type.&quot;) + s);
<span class="nc" id="L3906">                                    }</span>
<span class="nc bnc" id="L3907" title="All 2 branches missed.">                                } else if (p == 0) {</span>
<span class="nc" id="L3908">                                    v.add(new ObjectIdentifier(&quot;2.5.29.37.0&quot;));</span>
                                } else {
<span class="nc" id="L3910">                                    v.add(new ObjectIdentifier(&quot;1.3.6.1.5.5.7.3.&quot; + p));</span>
                                }
                            }
<span class="nc" id="L3913">                            ext.set(ExtendedKeyUsageExtension.NAME,</span>
<span class="nc" id="L3914">                                    new ExtendedKeyUsageExtension(isCritical, v));</span>
<span class="nc" id="L3915">                        } else {</span>
<span class="nc" id="L3916">                            throw new Exception(rb.getString</span>
<span class="nc" id="L3917">                                    (&quot;Illegal.value.&quot;) + extstr);</span>
                        }
                        break;
                    case 3:     // SAN
                    case 4:     // IAN
<span class="nc bnc" id="L3922" title="All 2 branches missed.">                        if(value != null) {</span>
<span class="nc" id="L3923">                            String[] ps = value.split(&quot;,&quot;);</span>
<span class="nc" id="L3924">                            GeneralNames gnames = new GeneralNames();</span>
<span class="nc bnc" id="L3925" title="All 2 branches missed.">                            for(String item: ps) {</span>
<span class="nc" id="L3926">                                colonpos = item.indexOf(':');</span>
<span class="nc bnc" id="L3927" title="All 2 branches missed.">                                if (colonpos &lt; 0) {</span>
<span class="nc" id="L3928">                                    throw new Exception(&quot;Illegal item &quot; + item + &quot; in &quot; + extstr);</span>
                                }
<span class="nc" id="L3930">                                String t = item.substring(0, colonpos);</span>
<span class="nc" id="L3931">                                String v = item.substring(colonpos+1);</span>
<span class="nc" id="L3932">                                gnames.add(createGeneralName(t, v));</span>
                            }
<span class="nc bnc" id="L3934" title="All 2 branches missed.">                            if (exttype == 3) {</span>
<span class="nc" id="L3935">                                ext.set(SubjectAlternativeNameExtension.NAME,</span>
                                        new SubjectAlternativeNameExtension(
<span class="nc" id="L3937">                                            isCritical, gnames));</span>
                            } else {
<span class="nc" id="L3939">                                ext.set(IssuerAlternativeNameExtension.NAME,</span>
                                        new IssuerAlternativeNameExtension(
<span class="nc" id="L3941">                                            isCritical, gnames));</span>
                            }
<span class="nc" id="L3943">                        } else {</span>
<span class="nc" id="L3944">                            throw new Exception(rb.getString</span>
<span class="nc" id="L3945">                                    (&quot;Illegal.value.&quot;) + extstr);</span>
                        }
                        break;
                    case 5:     // SIA, always non-critical
                    case 6:     // AIA, always non-critical
<span class="nc bnc" id="L3950" title="All 2 branches missed.">                        if (isCritical) {</span>
<span class="nc" id="L3951">                            throw new Exception(rb.getString(</span>
                                    &quot;This.extension.cannot.be.marked.as.critical.&quot;) + extstr);
                        }
<span class="nc bnc" id="L3954" title="All 2 branches missed.">                        if(value != null) {</span>
<span class="nc" id="L3955">                            List&lt;AccessDescription&gt; accessDescriptions =</span>
                                    new ArrayList&lt;&gt;();
<span class="nc" id="L3957">                            String[] ps = value.split(&quot;,&quot;);</span>
<span class="nc bnc" id="L3958" title="All 2 branches missed.">                            for(String item: ps) {</span>
<span class="nc" id="L3959">                                colonpos = item.indexOf(':');</span>
<span class="nc" id="L3960">                                int colonpos2 = item.indexOf(':', colonpos+1);</span>
<span class="nc bnc" id="L3961" title="All 4 branches missed.">                                if (colonpos &lt; 0 || colonpos2 &lt; 0) {</span>
<span class="nc" id="L3962">                                    throw new Exception(rb.getString</span>
<span class="nc" id="L3963">                                            (&quot;Illegal.value.&quot;) + extstr);</span>
                                }
<span class="nc" id="L3965">                                String m = item.substring(0, colonpos);</span>
<span class="nc" id="L3966">                                String t = item.substring(colonpos+1, colonpos2);</span>
<span class="nc" id="L3967">                                String v = item.substring(colonpos2+1);</span>
<span class="nc" id="L3968">                                int p = oneOf(m,</span>
                                        &quot;&quot;,
                                        &quot;ocsp&quot;,         //1
                                        &quot;caIssuers&quot;,    //2
                                        &quot;timeStamping&quot;, //3
                                        &quot;&quot;,
                                        &quot;caRepository&quot;  //5
                                        );
                                ObjectIdentifier oid;
<span class="nc bnc" id="L3977" title="All 2 branches missed.">                                if (p &lt; 0) {</span>
                                    try {
<span class="nc" id="L3979">                                        oid = new ObjectIdentifier(m);</span>
<span class="nc" id="L3980">                                    } catch (Exception e) {</span>
<span class="nc" id="L3981">                                        throw new Exception(rb.getString(</span>
                                                &quot;Unknown.AccessDescription.type.&quot;) + m);
<span class="nc" id="L3983">                                    }</span>
                                } else {
<span class="nc" id="L3985">                                    oid = new ObjectIdentifier(&quot;1.3.6.1.5.5.7.48.&quot; + p);</span>
                                }
<span class="nc" id="L3987">                                accessDescriptions.add(new AccessDescription(</span>
<span class="nc" id="L3988">                                        oid, createGeneralName(t, v)));</span>
                            }
<span class="nc bnc" id="L3990" title="All 2 branches missed.">                            if (exttype == 5) {</span>
<span class="nc" id="L3991">                                ext.set(SubjectInfoAccessExtension.NAME,</span>
                                        new SubjectInfoAccessExtension(accessDescriptions));
                            } else {
<span class="nc" id="L3994">                                ext.set(AuthorityInfoAccessExtension.NAME,</span>
                                        new AuthorityInfoAccessExtension(accessDescriptions));
                            }
<span class="nc" id="L3997">                        } else {</span>
<span class="nc" id="L3998">                            throw new Exception(rb.getString</span>
<span class="nc" id="L3999">                                    (&quot;Illegal.value.&quot;) + extstr);</span>
                        }
                        break;
                    case 8: // CRL, experimental, only support 1 distributionpoint
<span class="nc bnc" id="L4003" title="All 2 branches missed.">                        if(value != null) {</span>
<span class="nc" id="L4004">                            String[] ps = value.split(&quot;,&quot;);</span>
<span class="nc" id="L4005">                            GeneralNames gnames = new GeneralNames();</span>
<span class="nc bnc" id="L4006" title="All 2 branches missed.">                            for(String item: ps) {</span>
<span class="nc" id="L4007">                                colonpos = item.indexOf(':');</span>
<span class="nc bnc" id="L4008" title="All 2 branches missed.">                                if (colonpos &lt; 0) {</span>
<span class="nc" id="L4009">                                    throw new Exception(&quot;Illegal item &quot; + item + &quot; in &quot; + extstr);</span>
                                }
<span class="nc" id="L4011">                                String t = item.substring(0, colonpos);</span>
<span class="nc" id="L4012">                                String v = item.substring(colonpos+1);</span>
<span class="nc" id="L4013">                                gnames.add(createGeneralName(t, v));</span>
                            }
<span class="nc" id="L4015">                            ext.set(CRLDistributionPointsExtension.NAME,</span>
                                    new CRLDistributionPointsExtension(
<span class="nc" id="L4017">                                        isCritical, Collections.singletonList(</span>
                                        new DistributionPoint(gnames, null, null))));
<span class="nc" id="L4019">                        } else {</span>
<span class="nc" id="L4020">                            throw new Exception(rb.getString</span>
<span class="nc" id="L4021">                                    (&quot;Illegal.value.&quot;) + extstr);</span>
                        }
                        break;
                    case -1:
<span class="nc" id="L4025">                        ObjectIdentifier oid = new ObjectIdentifier(name);</span>
<span class="nc" id="L4026">                        byte[] data = null;</span>
<span class="nc bnc" id="L4027" title="All 2 branches missed.">                        if (value != null) {</span>
<span class="nc" id="L4028">                            data = new byte[value.length() / 2 + 1];</span>
<span class="nc" id="L4029">                            int pos = 0;</span>
<span class="nc bnc" id="L4030" title="All 2 branches missed.">                            for (char c: value.toCharArray()) {</span>
                                int hex;
<span class="nc bnc" id="L4032" title="All 4 branches missed.">                                if (c &gt;= '0' &amp;&amp; c &lt;= '9') {</span>
<span class="nc" id="L4033">                                    hex = c - '0' ;</span>
<span class="nc bnc" id="L4034" title="All 4 branches missed.">                                } else if (c &gt;= 'A' &amp;&amp; c &lt;= 'F') {</span>
<span class="nc" id="L4035">                                    hex = c - 'A' + 10;</span>
<span class="nc bnc" id="L4036" title="All 4 branches missed.">                                } else if (c &gt;= 'a' &amp;&amp; c &lt;= 'f') {</span>
<span class="nc" id="L4037">                                    hex = c - 'a' + 10;</span>
                                } else {
                                    continue;
                                }
<span class="nc bnc" id="L4041" title="All 2 branches missed.">                                if (pos % 2 == 0) {</span>
<span class="nc" id="L4042">                                    data[pos/2] = (byte)(hex &lt;&lt; 4);</span>
                                } else {
<span class="nc" id="L4044">                                    data[pos/2] += hex;</span>
                                }
<span class="nc" id="L4046">                                pos++;</span>
                            }
<span class="nc bnc" id="L4048" title="All 2 branches missed.">                            if (pos % 2 != 0) {</span>
<span class="nc" id="L4049">                                throw new Exception(rb.getString(</span>
                                        &quot;Odd.number.of.hex.digits.found.&quot;) + extstr);
                            }
<span class="nc" id="L4052">                            data = Arrays.copyOf(data, pos/2);</span>
<span class="nc" id="L4053">                        } else {</span>
<span class="nc" id="L4054">                            data = new byte[0];</span>
                        }
<span class="nc" id="L4056">                        ext.set(oid.toString(), new Extension(oid, isCritical,</span>
                                new DerValue(DerValue.tag_OctetString, data)
<span class="nc" id="L4058">                                        .toByteArray()));</span>
<span class="nc" id="L4059">                        break;</span>
                    default:
<span class="nc" id="L4061">                        throw new Exception(rb.getString(</span>
                                &quot;Unknown.extension.type.&quot;) + extstr);
                }
<span class="nc" id="L4064">            }</span>
            // always non-critical
<span class="nc" id="L4066">            ext.set(SubjectKeyIdentifierExtension.NAME,</span>
                    new SubjectKeyIdentifierExtension(
<span class="nc" id="L4068">                        new KeyIdentifier(pkey).getIdentifier()));</span>
<span class="nc bnc" id="L4069" title="All 4 branches missed.">            if (akey != null &amp;&amp; !pkey.equals(akey)) {</span>
<span class="nc" id="L4070">                ext.set(AuthorityKeyIdentifierExtension.NAME,</span>
                        new AuthorityKeyIdentifierExtension(
                        new KeyIdentifier(akey), null, null));
            }
<span class="nc" id="L4074">        } catch(IOException e) {</span>
<span class="nc" id="L4075">            throw new RuntimeException(e);</span>
<span class="nc" id="L4076">        }</span>
<span class="nc" id="L4077">        return ext;</span>
    }

    /**
     * Prints the usage of this tool.
     */
    private void usage() {
<span class="nc bnc" id="L4084" title="All 2 branches missed.">        if (command != null) {</span>
<span class="nc" id="L4085">            System.err.println(&quot;keytool &quot; + command +</span>
<span class="nc" id="L4086">                    rb.getString(&quot;.OPTION.&quot;));</span>
<span class="nc" id="L4087">            System.err.println();</span>
<span class="nc" id="L4088">            System.err.println(rb.getString(command.description));</span>
<span class="nc" id="L4089">            System.err.println();</span>
<span class="nc" id="L4090">            System.err.println(rb.getString(&quot;Options.&quot;));</span>
<span class="nc" id="L4091">            System.err.println();</span>

            // Left and right sides of the options list
<span class="nc" id="L4094">            String[] left = new String[command.options.length];</span>
<span class="nc" id="L4095">            String[] right = new String[command.options.length];</span>

            // Check if there's an unknown option
<span class="nc" id="L4098">            boolean found = false;</span>

            // Length of left side of options list
<span class="nc" id="L4101">            int lenLeft = 0;</span>
<span class="nc bnc" id="L4102" title="All 2 branches missed.">            for (int j=0; j&lt;left.length; j++) {</span>
<span class="nc" id="L4103">                Option opt = command.options[j];</span>
<span class="nc" id="L4104">                left[j] = opt.toString();</span>
<span class="nc bnc" id="L4105" title="All 2 branches missed.">                if (opt.arg != null) left[j] += &quot; &quot; + opt.arg;</span>
<span class="nc bnc" id="L4106" title="All 2 branches missed.">                if (left[j].length() &gt; lenLeft) {</span>
<span class="nc" id="L4107">                    lenLeft = left[j].length();</span>
                }
<span class="nc" id="L4109">                right[j] = rb.getString(opt.description);</span>
            }
<span class="nc bnc" id="L4111" title="All 2 branches missed.">            for (int j=0; j&lt;left.length; j++) {</span>
<span class="nc" id="L4112">                System.err.printf(&quot; %-&quot; + lenLeft + &quot;s  %s\n&quot;,</span>
                        left[j], right[j]);
            }
<span class="nc" id="L4115">            System.err.println();</span>
<span class="nc" id="L4116">            System.err.println(rb.getString(</span>
                    &quot;Use.keytool.help.for.all.available.commands&quot;));
<span class="nc" id="L4118">        } else {</span>
<span class="nc" id="L4119">            System.err.println(rb.getString(</span>
                    &quot;Key.and.Certificate.Management.Tool&quot;));
<span class="nc" id="L4121">            System.err.println();</span>
<span class="nc" id="L4122">            System.err.println(rb.getString(&quot;Commands.&quot;));</span>
<span class="nc" id="L4123">            System.err.println();</span>
<span class="nc bnc" id="L4124" title="All 2 branches missed.">            for (Command c: Command.values()) {</span>
<span class="nc bnc" id="L4125" title="All 2 branches missed.">                if (c == KEYCLONE) break;</span>
<span class="nc" id="L4126">                System.err.printf(&quot; %-20s%s\n&quot;, c, rb.getString(c.description));</span>
            }
<span class="nc" id="L4128">            System.err.println();</span>
<span class="nc" id="L4129">            System.err.println(rb.getString(</span>
                    &quot;Use.keytool.command.name.help.for.usage.of.command.name&quot;));
        }
<span class="nc" id="L4132">    }</span>

    private void tinyHelp() {
<span class="nc" id="L4135">        usage();</span>
<span class="nc bnc" id="L4136" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L4137">            throw new RuntimeException(&quot;NO BIG ERROR, SORRY&quot;);</span>
        } else {
<span class="nc" id="L4139">            System.exit(1);</span>
        }
<span class="nc" id="L4141">    }</span>

    private void errorNeedArgument(String flag) {
<span class="nc" id="L4144">        Object[] source = {flag};</span>
<span class="nc" id="L4145">        System.err.println(new MessageFormat(</span>
<span class="nc" id="L4146">                rb.getString(&quot;Command.option.flag.needs.an.argument.&quot;)).format(source));</span>
<span class="nc" id="L4147">        tinyHelp();</span>
<span class="nc" id="L4148">    }</span>

    private char[] getPass(String modifier, String arg) {
<span class="nc" id="L4151">        char[] output = KeyStoreUtil.getPassWithModifier(modifier, arg, rb);</span>
<span class="nc bnc" id="L4152" title="All 2 branches missed.">        if (output != null) return output;</span>
<span class="nc" id="L4153">        tinyHelp();</span>
<span class="nc" id="L4154">        return null;    // Useless, tinyHelp() already exits.</span>
    }
}

// This class is exactly the same as com.sun.tools.javac.util.Pair,
// it's copied here since the original one is not included in JRE.
class Pair&lt;A, B&gt; {

    public final A fst;
    public final B snd;

<span class="nc" id="L4165">    public Pair(A fst, B snd) {</span>
<span class="nc" id="L4166">        this.fst = fst;</span>
<span class="nc" id="L4167">        this.snd = snd;</span>
<span class="nc" id="L4168">    }</span>

    public String toString() {
<span class="nc" id="L4171">        return &quot;Pair[&quot; + fst + &quot;,&quot; + snd + &quot;]&quot;;</span>
    }

    public boolean equals(Object other) {
<span class="nc bnc" id="L4175" title="All 2 branches missed.">        return</span>
            other instanceof Pair &amp;&amp;
<span class="nc bnc" id="L4177" title="All 2 branches missed.">            Objects.equals(fst, ((Pair)other).fst) &amp;&amp;</span>
<span class="nc bnc" id="L4178" title="All 2 branches missed.">            Objects.equals(snd, ((Pair)other).snd);</span>
    }

    public int hashCode() {
<span class="nc bnc" id="L4182" title="All 4 branches missed.">        if (fst == null) return (snd == null) ? 0 : snd.hashCode() + 1;</span>
<span class="nc bnc" id="L4183" title="All 2 branches missed.">        else if (snd == null) return fst.hashCode() + 2;</span>
<span class="nc" id="L4184">        else return fst.hashCode() * 17 + snd.hashCode();</span>
    }

    public static &lt;A,B&gt; Pair&lt;A,B&gt; of(A a, B b) {
<span class="nc" id="L4188">        return new Pair&lt;&gt;(a,b);</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>