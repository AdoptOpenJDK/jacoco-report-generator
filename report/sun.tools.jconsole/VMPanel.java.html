<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>VMPanel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.tools.jconsole</a> &gt; <span class="el_source">VMPanel.java</span></div><h1>VMPanel.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jconsole;

import java.awt.*;
import java.awt.event.*;
import java.beans.*;
import java.lang.reflect.*;
import java.util.*;
import java.util.List;
import java.util.Timer;
import javax.swing.*;
import javax.swing.plaf.*;


import com.sun.tools.jconsole.JConsolePlugin;
import com.sun.tools.jconsole.JConsoleContext;

import static sun.tools.jconsole.ProxyClient.*;

@SuppressWarnings(&quot;serial&quot;)
public class VMPanel extends JTabbedPane implements PropertyChangeListener {

    private ProxyClient proxyClient;
    private Timer timer;
    private int updateInterval;
    private String hostName;
    private int port;
    private String userName;
    private String password;
    private String url;
<span class="nc" id="L55">    private VMInternalFrame vmIF = null;</span>
<span class="nc" id="L56">    private static ArrayList&lt;TabInfo&gt; tabInfos = new ArrayList&lt;TabInfo&gt;();</span>
<span class="nc" id="L57">    private boolean wasConnected = false;</span>
<span class="nc" id="L58">    private boolean userDisconnected = false;</span>
<span class="nc" id="L59">    private boolean shouldUseSSL = true;</span>

    // The everConnected flag keeps track of whether the window can be
    // closed if the user clicks Cancel after a failed connection attempt.
    //
<span class="nc" id="L64">    private boolean everConnected = false;</span>

    // The initialUpdate flag is used to enable/disable tabs each time
    // a connect or reconnect takes place. This flag avoids having to
    // enable/disable tabs on each update call.
    //
<span class="nc" id="L70">    private boolean initialUpdate = true;</span>

    // Each VMPanel has its own instance of the JConsolePlugin
    // A map of JConsolePlugin to the previous SwingWorker
<span class="nc" id="L74">    private Map&lt;ExceptionSafePlugin, SwingWorker&lt;?, ?&gt;&gt; plugins = null;</span>
<span class="nc" id="L75">    private boolean pluginTabsAdded = false;</span>

    // Update these only on the EDT
    private JOptionPane optionPane;
    private JProgressBar progressBar;
    private long time0;

    static {
<span class="nc" id="L83">        tabInfos.add(new TabInfo(OverviewTab.class, OverviewTab.getTabName(), true));</span>
<span class="nc" id="L84">        tabInfos.add(new TabInfo(MemoryTab.class, MemoryTab.getTabName(), true));</span>
<span class="nc" id="L85">        tabInfos.add(new TabInfo(ThreadTab.class, ThreadTab.getTabName(), true));</span>
<span class="nc" id="L86">        tabInfos.add(new TabInfo(ClassTab.class, ClassTab.getTabName(), true));</span>
<span class="nc" id="L87">        tabInfos.add(new TabInfo(SummaryTab.class, SummaryTab.getTabName(), true));</span>
<span class="nc" id="L88">        tabInfos.add(new TabInfo(MBeansTab.class, MBeansTab.getTabName(), true));</span>
    }

    public static TabInfo[] getTabInfos() {
<span class="nc" id="L92">        return tabInfos.toArray(new TabInfo[tabInfos.size()]);</span>
    }

<span class="nc" id="L95">    VMPanel(ProxyClient proxyClient, int updateInterval) {</span>
<span class="nc" id="L96">        this.proxyClient = proxyClient;</span>
<span class="nc" id="L97">        this.updateInterval = updateInterval;</span>
<span class="nc" id="L98">        this.hostName = proxyClient.getHostName();</span>
<span class="nc" id="L99">        this.port = proxyClient.getPort();</span>
<span class="nc" id="L100">        this.userName = proxyClient.getUserName();</span>
<span class="nc" id="L101">        this.password = proxyClient.getPassword();</span>
<span class="nc" id="L102">        this.url = proxyClient.getUrl();</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">        for (TabInfo tabInfo : tabInfos) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (tabInfo.tabVisible) {</span>
<span class="nc" id="L106">                addTab(tabInfo);</span>
            }
<span class="nc" id="L108">        }</span>

<span class="nc" id="L110">        plugins = new LinkedHashMap&lt;ExceptionSafePlugin, SwingWorker&lt;?, ?&gt;&gt;();</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        for (JConsolePlugin p : JConsole.getPlugins()) {</span>
<span class="nc" id="L112">            p.setContext(proxyClient);</span>
<span class="nc" id="L113">            plugins.put(new ExceptionSafePlugin(p), null);</span>
<span class="nc" id="L114">        }</span>

<span class="nc" id="L116">        Utilities.updateTransparency(this);</span>

<span class="nc" id="L118">        ToolTipManager.sharedInstance().registerComponent(this);</span>

        // Start listening to connection state events
        //
<span class="nc" id="L122">        proxyClient.addPropertyChangeListener(this);</span>

<span class="nc" id="L124">        addMouseListener(new MouseAdapter() {</span>

            public void mouseClicked(MouseEvent e) {
<span class="nc bnc" id="L127" title="All 6 branches missed.">                if (connectedIconBounds != null &amp;&amp; (e.getModifiers() &amp; MouseEvent.BUTTON1_MASK) != 0 &amp;&amp; connectedIconBounds.contains(e.getPoint())) {</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">                    if (isConnected()) {</span>
<span class="nc" id="L130">                        userDisconnected = true;</span>
<span class="nc" id="L131">                        disconnect();</span>
<span class="nc" id="L132">                        wasConnected = false;</span>
                    } else {
<span class="nc" id="L134">                        connect();</span>
                    }
<span class="nc" id="L136">                    repaint();</span>
                }
<span class="nc" id="L138">            }</span>
        });

<span class="nc" id="L141">    }</span>
<span class="nc" id="L142">    private static Icon connectedIcon16 =</span>
<span class="nc" id="L143">            new ImageIcon(VMPanel.class.getResource(&quot;resources/connected16.png&quot;));</span>
<span class="nc" id="L144">    private static Icon connectedIcon24 =</span>
<span class="nc" id="L145">            new ImageIcon(VMPanel.class.getResource(&quot;resources/connected24.png&quot;));</span>
<span class="nc" id="L146">    private static Icon disconnectedIcon16 =</span>
<span class="nc" id="L147">            new ImageIcon(VMPanel.class.getResource(&quot;resources/disconnected16.png&quot;));</span>
<span class="nc" id="L148">    private static Icon disconnectedIcon24 =</span>
<span class="nc" id="L149">            new ImageIcon(VMPanel.class.getResource(&quot;resources/disconnected24.png&quot;));</span>
    private Rectangle connectedIconBounds;

    // Override to increase right inset for tab area,
    // in order to reserve space for the connect toggle.
    public void setUI(TabbedPaneUI ui) {
<span class="nc" id="L155">        Insets insets = (Insets) UIManager.getLookAndFeelDefaults().get(&quot;TabbedPane.tabAreaInsets&quot;);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (insets != null) {</span>
<span class="nc" id="L157">            insets = (Insets) insets.clone();</span>
<span class="nc" id="L158">            insets.right += connectedIcon24.getIconWidth() + 8;</span>
<span class="nc" id="L159">            UIManager.put(&quot;TabbedPane.tabAreaInsets&quot;, insets);</span>
        }
<span class="nc" id="L161">        super.setUI(ui);</span>
<span class="nc" id="L162">    }</span>

    // Override to paint the connect toggle
    protected void paintComponent(Graphics g) {
<span class="nc" id="L166">        super.paintComponent(g);</span>

        Icon icon;
<span class="nc" id="L169">        Component c0 = getComponent(0);</span>
<span class="nc bnc" id="L170" title="All 4 branches missed.">        if (c0 != null &amp;&amp; c0.getY() &gt; 24) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            icon = isConnected() ? connectedIcon24 : disconnectedIcon24;</span>
        } else {
<span class="nc bnc" id="L173" title="All 2 branches missed.">            icon = isConnected() ? connectedIcon16 : disconnectedIcon16;</span>
        }
<span class="nc" id="L175">        Insets insets = getInsets();</span>
<span class="nc" id="L176">        int x = getWidth() - insets.right - icon.getIconWidth() - 4;</span>
<span class="nc" id="L177">        int y = insets.top;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (c0 != null) {</span>
<span class="nc" id="L179">            y = (c0.getY() - icon.getIconHeight()) / 2;</span>
        }
<span class="nc" id="L181">        icon.paintIcon(this, g, x, y);</span>
<span class="nc" id="L182">        connectedIconBounds = new Rectangle(x, y, icon.getIconWidth(), icon.getIconHeight());</span>
<span class="nc" id="L183">    }</span>

    public String getToolTipText(MouseEvent event) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (connectedIconBounds.contains(event.getPoint())) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (isConnected()) {</span>
<span class="nc" id="L188">                return Messages.CONNECTED_PUNCTUATION_CLICK_TO_DISCONNECT_;</span>
            } else {
<span class="nc" id="L190">                return Messages.DISCONNECTED_PUNCTUATION_CLICK_TO_CONNECT_;</span>
            }
        } else {
<span class="nc" id="L193">            return super.getToolTipText(event);</span>
        }
    }

    private synchronized void addTab(TabInfo tabInfo) {
<span class="nc" id="L198">        Tab tab = instantiate(tabInfo);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (tab != null) {</span>
<span class="nc" id="L200">            addTab(tabInfo.name, tab);</span>
        } else {
<span class="nc" id="L202">            tabInfo.tabVisible = false;</span>
        }
<span class="nc" id="L204">    }</span>

    private synchronized void insertTab(TabInfo tabInfo, int index) {
<span class="nc" id="L207">        Tab tab = instantiate(tabInfo);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (tab != null) {</span>
<span class="nc" id="L209">            insertTab(tabInfo.name, null, tab, null, index);</span>
        } else {
<span class="nc" id="L211">            tabInfo.tabVisible = false;</span>
        }
<span class="nc" id="L213">    }</span>

    public synchronized void removeTabAt(int index) {
<span class="nc" id="L216">        super.removeTabAt(index);</span>
<span class="nc" id="L217">    }</span>

    private Tab instantiate(TabInfo tabInfo) {
        try {
<span class="nc" id="L221">            Constructor&lt;?&gt; con = tabInfo.tabClass.getConstructor(VMPanel.class);</span>
<span class="nc" id="L222">            return (Tab) con.newInstance(this);</span>
<span class="nc" id="L223">        } catch (Exception ex) {</span>
<span class="nc" id="L224">            System.err.println(ex);</span>
<span class="nc" id="L225">            return null;</span>
        }
    }

    boolean isConnected() {
<span class="nc" id="L230">        return proxyClient.isConnected();</span>
    }

    public int getUpdateInterval() {
<span class="nc" id="L234">        return updateInterval;</span>
    }

    /**
     * WARNING NEVER CALL THIS METHOD TO MAKE JMX REQUEST
     * IF  assertThread == false.
     * DISPATCHER THREAD IS NOT ASSERTED.
     * IT IS USED TO MAKE SOME LOCAL MANIPULATIONS.
     */
    ProxyClient getProxyClient(boolean assertThread) {
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (assertThread) {</span>
<span class="nc" id="L245">            return getProxyClient();</span>
        } else {
<span class="nc" id="L247">            return proxyClient;</span>
        }
    }

    public ProxyClient getProxyClient() {
<span class="nc" id="L252">        String threadClass = Thread.currentThread().getClass().getName();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (threadClass.equals(&quot;java.awt.EventDispatchThread&quot;)) {</span>
<span class="nc" id="L254">            String msg = &quot;Calling VMPanel.getProxyClient() from the Event Dispatch Thread!&quot;;</span>
<span class="nc" id="L255">            new RuntimeException(msg).printStackTrace();</span>
<span class="nc" id="L256">            System.exit(1);</span>
        }
<span class="nc" id="L258">        return proxyClient;</span>
    }

    public void cleanUp() {
        //proxyClient.disconnect();
<span class="nc bnc" id="L263" title="All 2 branches missed.">        for (Tab tab : getTabs()) {</span>
<span class="nc" id="L264">            tab.dispose();</span>
<span class="nc" id="L265">        }</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        for (JConsolePlugin p : plugins.keySet()) {</span>
<span class="nc" id="L267">            p.dispose();</span>
<span class="nc" id="L268">        }</span>
        // Cancel pending update tasks
        //
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (timer != null) {</span>
<span class="nc" id="L272">            timer.cancel();</span>
        }
        // Stop listening to connection state events
        //
<span class="nc" id="L276">        proxyClient.removePropertyChangeListener(this);</span>
<span class="nc" id="L277">    }</span>

    // Call on EDT
    public void connect() {
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (isConnected()) {</span>
            // create plugin tabs if not done
<span class="nc" id="L283">            createPluginTabs();</span>
            // Notify tabs
<span class="nc" id="L285">            fireConnectedChange(true);</span>
            // Enable/disable tabs on initial update
<span class="nc" id="L287">            initialUpdate = true;</span>
            // Start/Restart update timer on connect/reconnect
<span class="nc" id="L289">            startUpdateTimer();</span>
        } else {
<span class="nc" id="L291">            new Thread(&quot;VMPanel.connect&quot;) {</span>

                public void run() {
<span class="nc" id="L294">                    proxyClient.connect(shouldUseSSL);</span>
<span class="nc" id="L295">                }</span>
<span class="nc" id="L296">            }.start();</span>
        }
<span class="nc" id="L298">    }</span>

    // Call on EDT
    public void disconnect() {
<span class="nc" id="L302">        proxyClient.disconnect();</span>
<span class="nc" id="L303">        updateFrameTitle();</span>
<span class="nc" id="L304">    }</span>

    // Called on EDT
    public void propertyChange(PropertyChangeEvent ev) {
<span class="nc" id="L308">        String prop = ev.getPropertyName();</span>

<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (prop == CONNECTION_STATE_PROPERTY) {</span>
<span class="nc" id="L311">            ConnectionState oldState = (ConnectionState) ev.getOldValue();</span>
<span class="nc" id="L312">            ConnectionState newState = (ConnectionState) ev.getNewValue();</span>
<span class="nc bnc" id="L313" title="All 4 branches missed.">            switch (newState) {</span>
                case CONNECTING:
<span class="nc" id="L315">                    onConnecting();</span>
<span class="nc" id="L316">                    break;</span>

                case CONNECTED:
<span class="nc bnc" id="L319" title="All 2 branches missed.">                    if (progressBar != null) {</span>
<span class="nc" id="L320">                        progressBar.setIndeterminate(false);</span>
<span class="nc" id="L321">                        progressBar.setValue(100);</span>
                    }
<span class="nc" id="L323">                    closeOptionPane();</span>
<span class="nc" id="L324">                    updateFrameTitle();</span>
                    // create tabs if not done
<span class="nc" id="L326">                    createPluginTabs();</span>
<span class="nc" id="L327">                    repaint();</span>
                    // Notify tabs
<span class="nc" id="L329">                    fireConnectedChange(true);</span>
                    // Enable/disable tabs on initial update
<span class="nc" id="L331">                    initialUpdate = true;</span>
                    // Start/Restart update timer on connect/reconnect
<span class="nc" id="L333">                    startUpdateTimer();</span>
<span class="nc" id="L334">                    break;</span>

                case DISCONNECTED:
<span class="nc bnc" id="L337" title="All 2 branches missed.">                    if (progressBar != null) {</span>
<span class="nc" id="L338">                        progressBar.setIndeterminate(false);</span>
<span class="nc" id="L339">                        progressBar.setValue(0);</span>
<span class="nc" id="L340">                        closeOptionPane();</span>
                    }
<span class="nc" id="L342">                    vmPanelDied();</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                    if (oldState == ConnectionState.CONNECTED) {</span>
                        // Notify tabs
<span class="nc" id="L345">                        fireConnectedChange(false);</span>
                    }
                    break;
            }
        }
<span class="nc" id="L350">    }</span>

    // Called on EDT
    private void onConnecting() {
<span class="nc" id="L354">        time0 = System.currentTimeMillis();</span>

<span class="nc" id="L356">        SwingUtilities.getWindowAncestor(this);</span>

<span class="nc" id="L358">        String connectionName = getConnectionName();</span>
<span class="nc" id="L359">        progressBar = new JProgressBar();</span>
<span class="nc" id="L360">        progressBar.setIndeterminate(true);</span>
<span class="nc" id="L361">        JPanel progressPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));</span>
<span class="nc" id="L362">        progressPanel.add(progressBar);</span>

<span class="nc" id="L364">        Object[] message = {</span>
<span class="nc" id="L365">            &quot;&lt;html&gt;&lt;h3&gt;&quot; + Resources.format(Messages.CONNECTING_TO1, connectionName) + &quot;&lt;/h3&gt;&lt;/html&gt;&quot;,</span>
            progressPanel,
<span class="nc" id="L367">            &quot;&lt;html&gt;&lt;b&gt;&quot; + Resources.format(Messages.CONNECTING_TO2, connectionName) + &quot;&lt;/b&gt;&lt;/html&gt;&quot;</span>
        };

<span class="nc" id="L370">        optionPane =</span>
<span class="nc" id="L371">                SheetDialog.showOptionDialog(this,</span>
                message,
                JOptionPane.DEFAULT_OPTION,
                JOptionPane.INFORMATION_MESSAGE, null,
                new String[]{Messages.CANCEL},
<span class="nc" id="L376">                0);</span>


<span class="nc" id="L379">    }</span>

    // Called on EDT
    private void closeOptionPane() {
<span class="nc bnc" id="L383" title="All 2 branches missed.">        if (optionPane != null) {</span>
<span class="nc" id="L384">            new Thread(&quot;VMPanel.sleeper&quot;) {</span>
                public void run() {
<span class="nc" id="L386">                    long elapsed = System.currentTimeMillis() - time0;</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                    if (elapsed &lt; 2000) {</span>
                        try {
<span class="nc" id="L389">                            sleep(2000 - elapsed);</span>
<span class="nc" id="L390">                        } catch (InterruptedException ex) {</span>
                        // Ignore
<span class="nc" id="L392">                        }</span>
                    }
<span class="nc" id="L394">                    SwingUtilities.invokeLater(new Runnable() {</span>

                        public void run() {
<span class="nc" id="L397">                            optionPane.setVisible(false);</span>
<span class="nc" id="L398">                            progressBar = null;</span>
<span class="nc" id="L399">                        }</span>
                    });
<span class="nc" id="L401">                }</span>
<span class="nc" id="L402">            }.start();</span>
        }
<span class="nc" id="L404">    }</span>

    void updateFrameTitle() {
<span class="nc" id="L407">        VMInternalFrame vmIF = getFrame();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (vmIF != null) {</span>
<span class="nc" id="L409">            String displayName = getDisplayName();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">            if (!proxyClient.isConnected()) {</span>
<span class="nc" id="L411">                displayName = Resources.format(Messages.CONNECTION_NAME__DISCONNECTED_, displayName);</span>
            }
<span class="nc" id="L413">            vmIF.setTitle(displayName);</span>
        }
<span class="nc" id="L415">    }</span>

    private VMInternalFrame getFrame() {
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if (vmIF == null) {</span>
<span class="nc" id="L419">            vmIF = (VMInternalFrame) SwingUtilities.getAncestorOfClass(VMInternalFrame.class,</span>
                    this);
        }
<span class="nc" id="L422">        return vmIF;</span>
    }

    // TODO: this method is not needed when all JConsole tabs
    // are migrated to use the new JConsolePlugin API.
    //
    // A thread safe clone of all JConsole tabs
    synchronized List&lt;Tab&gt; getTabs() {
<span class="nc" id="L430">        ArrayList&lt;Tab&gt; list = new ArrayList&lt;Tab&gt;();</span>
<span class="nc" id="L431">        int n = getTabCount();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L433">            Component c = getComponentAt(i);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">            if (c instanceof Tab) {</span>
<span class="nc" id="L435">                list.add((Tab) c);</span>
            }
        }
<span class="nc" id="L438">        return list;</span>
    }

    private void startUpdateTimer() {
<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (timer != null) {</span>
<span class="nc" id="L443">            timer.cancel();</span>
        }
<span class="nc" id="L445">        TimerTask timerTask = new TimerTask() {</span>

            public void run() {
<span class="nc" id="L448">                update();</span>
<span class="nc" id="L449">            }</span>
        };
<span class="nc" id="L451">        String timerName = &quot;Timer-&quot; + getConnectionName();</span>
<span class="nc" id="L452">        timer = new Timer(timerName, true);</span>
<span class="nc" id="L453">        timer.schedule(timerTask, 0, updateInterval);</span>
<span class="nc" id="L454">    }</span>

    // Call on EDT
    private void vmPanelDied() {
<span class="nc" id="L458">        disconnect();</span>

<span class="nc bnc" id="L460" title="All 2 branches missed.">        if (userDisconnected) {</span>
<span class="nc" id="L461">            userDisconnected = false;</span>
<span class="nc" id="L462">            return;</span>
        }

        JOptionPane optionPane;
        String msgTitle, msgExplanation, buttonStr;

<span class="nc bnc" id="L468" title="All 2 branches missed.">        if (wasConnected) {</span>
<span class="nc" id="L469">            wasConnected = false;</span>
<span class="nc" id="L470">            msgTitle = Messages.CONNECTION_LOST1;</span>
<span class="nc" id="L471">            msgExplanation = Resources.format(Messages.CONNECTING_TO2, getConnectionName());</span>
<span class="nc" id="L472">            buttonStr = Messages.RECONNECT;</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">        } else if (shouldUseSSL) {</span>
<span class="nc" id="L474">            msgTitle = Messages.CONNECTION_FAILED_SSL1;</span>
<span class="nc" id="L475">            msgExplanation = Resources.format(Messages.CONNECTION_FAILED_SSL2, getConnectionName());</span>
<span class="nc" id="L476">            buttonStr = Messages.INSECURE;</span>
        } else {
<span class="nc" id="L478">            msgTitle = Messages.CONNECTION_FAILED1;</span>
<span class="nc" id="L479">            msgExplanation = Resources.format(Messages.CONNECTION_FAILED2, getConnectionName());</span>
<span class="nc" id="L480">            buttonStr = Messages.CONNECT;</span>
        }

<span class="nc" id="L483">        optionPane =</span>
<span class="nc" id="L484">                SheetDialog.showOptionDialog(this,</span>
                &quot;&lt;html&gt;&lt;h3&gt;&quot; + msgTitle + &quot;&lt;/h3&gt;&quot; +
                &quot;&lt;b&gt;&quot; + msgExplanation + &quot;&lt;/b&gt;&quot;,
                JOptionPane.DEFAULT_OPTION,
                JOptionPane.WARNING_MESSAGE, null,
                new String[]{buttonStr, Messages.CANCEL},
<span class="nc" id="L490">                0);</span>

<span class="nc" id="L492">        optionPane.addPropertyChangeListener(new PropertyChangeListener() {</span>

            public void propertyChange(PropertyChangeEvent event) {
<span class="nc bnc" id="L495" title="All 2 branches missed.">                if (event.getPropertyName().equals(JOptionPane.VALUE_PROPERTY)) {</span>
<span class="nc" id="L496">                    Object value = event.getNewValue();</span>

<span class="nc bnc" id="L498" title="All 4 branches missed.">                    if (value == Messages.RECONNECT || value == Messages.CONNECT) {</span>
<span class="nc" id="L499">                        connect();</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">                    } else if (value == Messages.INSECURE) {</span>
<span class="nc" id="L501">                        shouldUseSSL = false;</span>
<span class="nc" id="L502">                        connect();</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">                    } else if (!everConnected) {</span>
                        try {
<span class="nc" id="L505">                            getFrame().setClosed(true);</span>
<span class="nc" id="L506">                        } catch (PropertyVetoException ex) {</span>
                        // Should not happen, but can be ignored.
<span class="nc" id="L508">                        }</span>
                    }
                }
<span class="nc" id="L511">            }</span>
        });
<span class="nc" id="L513">    }</span>

    // Note: This method is called on a TimerTask thread. Any GUI manipulation
    // must be performed with invokeLater() or invokeAndWait().
<span class="nc" id="L517">    private Object lockObject = new Object();</span>

    private void update() {
<span class="nc" id="L520">        synchronized (lockObject) {</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">            if (!isConnected()) {</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                if (wasConnected) {</span>
<span class="nc" id="L523">                    EventQueue.invokeLater(new Runnable() {</span>

                        public void run() {
<span class="nc" id="L526">                            vmPanelDied();</span>
<span class="nc" id="L527">                        }</span>
                    });
                }
<span class="nc" id="L530">                wasConnected = false;</span>
<span class="nc" id="L531">                return;</span>
            } else {
<span class="nc" id="L533">                wasConnected = true;</span>
<span class="nc" id="L534">                everConnected = true;</span>
            }
<span class="nc" id="L536">            proxyClient.flush();</span>
<span class="nc" id="L537">            List&lt;Tab&gt; tabs = getTabs();</span>
<span class="nc" id="L538">            final int n = tabs.size();</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">            for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L540">                final int index = i;</span>
                try {
<span class="nc bnc" id="L542" title="All 2 branches missed.">                    if (!proxyClient.isDead()) {</span>
                        // Update tab
                        //
<span class="nc" id="L545">                        tabs.get(index).update();</span>
                        // Enable tab on initial update
                        //
<span class="nc bnc" id="L548" title="All 2 branches missed.">                        if (initialUpdate) {</span>
<span class="nc" id="L549">                            EventQueue.invokeLater(new Runnable() {</span>

                                public void run() {
<span class="nc" id="L552">                                    setEnabledAt(index, true);</span>
<span class="nc" id="L553">                                }</span>
                            });
                        }
                    }
<span class="nc" id="L557">                } catch (Exception e) {</span>
                    // Disable tab on initial update
                    //
<span class="nc bnc" id="L560" title="All 2 branches missed.">                    if (initialUpdate) {</span>
<span class="nc" id="L561">                        EventQueue.invokeLater(new Runnable() {</span>
                            public void run() {
<span class="nc" id="L563">                                setEnabledAt(index, false);</span>
<span class="nc" id="L564">                            }</span>
                        });
                    }
<span class="nc" id="L567">                }</span>
            }

            // plugin GUI update
<span class="nc bnc" id="L571" title="All 2 branches missed.">            for (ExceptionSafePlugin p : plugins.keySet()) {</span>
<span class="nc" id="L572">                SwingWorker&lt;?, ?&gt; sw = p.newSwingWorker();</span>
<span class="nc" id="L573">                SwingWorker&lt;?, ?&gt; prevSW = plugins.get(p);</span>
                // schedule SwingWorker to run only if the previous
                // SwingWorker has finished its task and it hasn't started.
<span class="nc bnc" id="L576" title="All 4 branches missed.">                if (prevSW == null || prevSW.isDone()) {</span>
<span class="nc bnc" id="L577" title="All 4 branches missed.">                    if (sw == null || sw.getState() == SwingWorker.StateValue.PENDING) {</span>
<span class="nc" id="L578">                        plugins.put(p, sw);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">                        if (sw != null) {</span>
<span class="nc" id="L580">                            p.executeSwingWorker(sw);</span>
                        }
                    }
                }
<span class="nc" id="L584">            }</span>

            // Set the first enabled tab in the tab's list
            // as the selected tab on initial update
            //
<span class="nc bnc" id="L589" title="All 2 branches missed.">            if (initialUpdate) {</span>
<span class="nc" id="L590">                EventQueue.invokeLater(new Runnable() {</span>
                    public void run() {
                        // Select first enabled tab if current tab isn't.
<span class="nc" id="L593">                        int index = getSelectedIndex();</span>
<span class="nc bnc" id="L594" title="All 4 branches missed.">                        if (index &lt; 0 || !isEnabledAt(index)) {</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">                            for (int i = 0; i &lt; n; i++) {</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                                if (isEnabledAt(i)) {</span>
<span class="nc" id="L597">                                    setSelectedIndex(i);</span>
<span class="nc" id="L598">                                    break;</span>
                                }
                            }
                        }
<span class="nc" id="L602">                    }</span>
                });
<span class="nc" id="L604">                initialUpdate = false;</span>
            }
<span class="nc" id="L606">        }</span>
<span class="nc" id="L607">    }</span>

    public String getHostName() {
<span class="nc" id="L610">        return hostName;</span>
    }

    public int getPort() {
<span class="nc" id="L614">        return port;</span>
    }

    public String getUserName() {
<span class="nc" id="L618">        return userName;</span>
    }

    public String getUrl() {
<span class="nc" id="L622">        return url;</span>
    }

    public String getPassword() {
<span class="nc" id="L626">        return password;</span>
    }

    public String getConnectionName() {
<span class="nc" id="L630">        return proxyClient.connectionName();</span>
    }

    public String getDisplayName() {
<span class="nc" id="L634">        return proxyClient.getDisplayName();</span>
    }

    static class TabInfo {

        Class&lt;? extends Tab&gt; tabClass;
        String name;
        boolean tabVisible;

<span class="nc" id="L643">        TabInfo(Class&lt;? extends Tab&gt; tabClass, String name, boolean tabVisible) {</span>
<span class="nc" id="L644">            this.tabClass = tabClass;</span>
<span class="nc" id="L645">            this.name = name;</span>
<span class="nc" id="L646">            this.tabVisible = tabVisible;</span>
<span class="nc" id="L647">        }</span>
    }

    private void createPluginTabs() {
        // add plugin tabs if not done
<span class="nc bnc" id="L652" title="All 2 branches missed.">        if (!pluginTabsAdded) {</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">            for (JConsolePlugin p : plugins.keySet()) {</span>
<span class="nc" id="L654">                Map&lt;String, JPanel&gt; tabs = p.getTabs();</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                for (Map.Entry&lt;String, JPanel&gt; e : tabs.entrySet()) {</span>
<span class="nc" id="L656">                    addTab(e.getKey(), e.getValue());</span>
<span class="nc" id="L657">                }</span>
<span class="nc" id="L658">            }</span>
<span class="nc" id="L659">            pluginTabsAdded = true;</span>
        }
<span class="nc" id="L661">    }</span>

    private void fireConnectedChange(boolean connected) {
<span class="nc bnc" id="L664" title="All 2 branches missed.">        for (Tab tab : getTabs()) {</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">            tab.firePropertyChange(JConsoleContext.CONNECTION_STATE_PROPERTY, !connected, connected);</span>
<span class="nc" id="L666">        }</span>
<span class="nc" id="L667">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>