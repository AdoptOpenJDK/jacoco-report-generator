<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>MBeansTab.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.tools.jconsole</a> &gt; <span class="el_source">MBeansTab.java</span></div><h1>MBeansTab.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jconsole;

import java.awt.BorderLayout;
import java.awt.EventQueue;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.beans.*;
import java.io.*;
import java.util.Set;
import javax.management.*;
import javax.swing.*;
import javax.swing.event.*;
import javax.swing.tree.*;
import sun.tools.jconsole.ProxyClient.SnapshotMBeanServerConnection;
import sun.tools.jconsole.inspector.*;

import com.sun.tools.jconsole.JConsoleContext;

@SuppressWarnings(&quot;serial&quot;)
public class MBeansTab extends Tab implements
        NotificationListener, PropertyChangeListener,
        TreeSelectionListener, TreeWillExpandListener {

    private XTree tree;
    private XSheet sheet;
    private XDataViewer viewer;

    public static String getTabName() {
<span class="nc" id="L55">        return Messages.MBEANS;</span>
    }

    public MBeansTab(final VMPanel vmPanel) {
<span class="nc" id="L59">        super(vmPanel, getTabName());</span>
<span class="nc" id="L60">        addPropertyChangeListener(this);</span>
<span class="nc" id="L61">        setupTab();</span>
<span class="nc" id="L62">    }</span>

    public XDataViewer getDataViewer() {
<span class="nc" id="L65">        return viewer;</span>
    }

    public XTree getTree() {
<span class="nc" id="L69">        return tree;</span>
    }

    public XSheet getSheet() {
<span class="nc" id="L73">        return sheet;</span>
    }

    @Override
    public void dispose() {
<span class="nc" id="L78">        super.dispose();</span>
<span class="nc" id="L79">        sheet.dispose();</span>
<span class="nc" id="L80">    }</span>

    public int getUpdateInterval() {
<span class="nc" id="L83">        return vmPanel.getUpdateInterval();</span>
    }

    private void buildMBeanServerView() {
<span class="nc" id="L87">        new SwingWorker&lt;Set&lt;ObjectName&gt;, Void&gt;() {</span>
            @Override
            public Set&lt;ObjectName&gt; doInBackground() {
                // Register listener for MBean registration/unregistration
                //
                try {
<span class="nc" id="L93">                    getMBeanServerConnection().addNotificationListener(</span>
                            MBeanServerDelegate.DELEGATE_NAME,
                            MBeansTab.this,
                            null,
                            null);
<span class="nc" id="L98">                } catch (InstanceNotFoundException e) {</span>
                    // Should never happen because the MBeanServerDelegate
                    // is always present in any standard MBeanServer
                    //
<span class="nc bnc" id="L102" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L103">                        e.printStackTrace();</span>
                    }
<span class="nc" id="L105">                } catch (IOException e) {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L107">                        e.printStackTrace();</span>
                    }
<span class="nc" id="L109">                    vmPanel.getProxyClient().markAsDead();</span>
<span class="nc" id="L110">                    return null;</span>
<span class="nc" id="L111">                }</span>
                // Retrieve MBeans from MBeanServer
                //
<span class="nc" id="L114">                Set&lt;ObjectName&gt; mbeans = null;</span>
                try {
<span class="nc" id="L116">                    mbeans = getMBeanServerConnection().queryNames(null, null);</span>
<span class="nc" id="L117">                } catch (IOException e) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L119">                        e.printStackTrace();</span>
                    }
<span class="nc" id="L121">                    vmPanel.getProxyClient().markAsDead();</span>
<span class="nc" id="L122">                    return null;</span>
<span class="nc" id="L123">                }</span>
<span class="nc" id="L124">                return mbeans;</span>
            }
            @Override
            protected void done() {
                try {
                    // Wait for mbsc.queryNames() result
<span class="nc" id="L130">                    Set&lt;ObjectName&gt; mbeans = get();</span>
                    // Do not display anything until the new tree has been built
                    //
<span class="nc" id="L133">                    tree.setVisible(false);</span>
                    // Cleanup current tree
                    //
<span class="nc" id="L136">                    tree.removeAll();</span>
                    // Add MBeans to tree
                    //
<span class="nc" id="L139">                    tree.addMBeansToView(mbeans);</span>
                    // Display the new tree
                    //
<span class="nc" id="L142">                    tree.setVisible(true);</span>
<span class="nc" id="L143">                } catch (Exception e) {</span>
<span class="nc" id="L144">                    Throwable t = Utils.getActualException(e);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L146">                        System.err.println(&quot;Problem at MBean tree construction&quot;);</span>
<span class="nc" id="L147">                        t.printStackTrace();</span>
                    }
<span class="nc" id="L149">                }</span>
<span class="nc" id="L150">            }</span>
<span class="nc" id="L151">        }.execute();</span>
<span class="nc" id="L152">    }</span>

    public MBeanServerConnection getMBeanServerConnection() {
<span class="nc" id="L155">        return vmPanel.getProxyClient().getMBeanServerConnection();</span>
    }

    public SnapshotMBeanServerConnection getSnapshotMBeanServerConnection() {
<span class="nc" id="L159">        return vmPanel.getProxyClient().getSnapshotMBeanServerConnection();</span>
    }

    @Override
    public void update() {
        // Ping the connection to see if it is still alive. At
        // some point the ProxyClient class should centralize
        // the connection aliveness monitoring and no longer
        // rely on the custom tabs to ping the connections.
        //
        try {
<span class="nc" id="L170">            getMBeanServerConnection().getDefaultDomain();</span>
<span class="nc" id="L171">        } catch (IOException ex) {</span>
<span class="nc" id="L172">            vmPanel.getProxyClient().markAsDead();</span>
<span class="nc" id="L173">        }</span>
<span class="nc" id="L174">    }</span>

    private void setupTab() {
        // set up the split pane with the MBean tree and MBean sheet panels
<span class="nc" id="L178">        setLayout(new BorderLayout());</span>
<span class="nc" id="L179">        JSplitPane mainSplit = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT);</span>
<span class="nc" id="L180">        mainSplit.setDividerLocation(160);</span>
<span class="nc" id="L181">        mainSplit.setBorder(BorderFactory.createEmptyBorder());</span>

        // set up the MBean tree panel (left pane)
<span class="nc" id="L184">        tree = new XTree(this);</span>
<span class="nc" id="L185">        tree.setCellRenderer(new XTreeRenderer());</span>
<span class="nc" id="L186">        tree.getSelectionModel().setSelectionMode(</span>
                TreeSelectionModel.SINGLE_TREE_SELECTION);
<span class="nc" id="L188">        tree.addTreeSelectionListener(this);</span>
<span class="nc" id="L189">        tree.addTreeWillExpandListener(this);</span>
<span class="nc" id="L190">        tree.addMouseListener(ml);</span>
<span class="nc" id="L191">        JScrollPane theScrollPane = new JScrollPane(</span>
                tree,
                JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED,
                JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L195">        JPanel treePanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L196">        treePanel.add(theScrollPane, BorderLayout.CENTER);</span>
<span class="nc" id="L197">        mainSplit.add(treePanel, JSplitPane.LEFT, 0);</span>

        // set up the MBean sheet panel (right pane)
<span class="nc" id="L200">        viewer = new XDataViewer(this);</span>
<span class="nc" id="L201">        sheet = new XSheet(this);</span>
<span class="nc" id="L202">        mainSplit.add(sheet, JSplitPane.RIGHT, 0);</span>

<span class="nc" id="L204">        add(mainSplit);</span>
<span class="nc" id="L205">    }</span>

    /* notification listener:  handleNotification */
    public void handleNotification(
            final Notification notification, Object handback) {
<span class="nc" id="L210">        EventQueue.invokeLater(new Runnable() {</span>
            public void run() {
<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (notification instanceof MBeanServerNotification) {</span>
<span class="nc" id="L213">                    ObjectName mbean =</span>
<span class="nc" id="L214">                            ((MBeanServerNotification) notification).getMBeanName();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                    if (notification.getType().equals(</span>
                            MBeanServerNotification.REGISTRATION_NOTIFICATION)) {
<span class="nc" id="L217">                        tree.addMBeanToView(mbean);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    } else if (notification.getType().equals(</span>
                            MBeanServerNotification.UNREGISTRATION_NOTIFICATION)) {
<span class="nc" id="L220">                        tree.removeMBeanFromView(mbean);</span>
                    }
                }
<span class="nc" id="L223">            }</span>
        });
<span class="nc" id="L225">    }</span>

    /* property change listener:  propertyChange */
    public void propertyChange(PropertyChangeEvent evt) {
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (JConsoleContext.CONNECTION_STATE_PROPERTY.equals(evt.getPropertyName())) {</span>
<span class="nc" id="L230">            boolean connected = (Boolean) evt.getNewValue();</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">            if (connected) {</span>
<span class="nc" id="L232">                buildMBeanServerView();</span>
            } else {
<span class="nc" id="L234">                sheet.dispose();</span>
            }
        }
<span class="nc" id="L237">    }</span>

    /* tree selection listener: valueChanged */
    public void valueChanged(TreeSelectionEvent e) {
<span class="nc" id="L241">        DefaultMutableTreeNode node =</span>
<span class="nc" id="L242">                (DefaultMutableTreeNode) tree.getLastSelectedPathComponent();</span>
<span class="nc" id="L243">        sheet.displayNode(node);</span>
<span class="nc" id="L244">    }</span>
    /* tree mouse listener: mousePressed */
<span class="nc" id="L246">    private MouseListener ml = new MouseAdapter() {</span>
        @Override
        public void mousePressed(MouseEvent e) {
<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (e.getClickCount() == 1) {</span>
<span class="nc" id="L250">                int selRow = tree.getRowForLocation(e.getX(), e.getY());</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                if (selRow != -1) {</span>
<span class="nc" id="L252">                    TreePath selPath =</span>
<span class="nc" id="L253">                            tree.getPathForLocation(e.getX(), e.getY());</span>
<span class="nc" id="L254">                    DefaultMutableTreeNode node =</span>
<span class="nc" id="L255">                            (DefaultMutableTreeNode) selPath.getLastPathComponent();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                    if (sheet.isMBeanNode(node)) {</span>
<span class="nc" id="L257">                        tree.expandPath(selPath);</span>
                    }
                }
            }
<span class="nc" id="L261">        }</span>
    };

    /* tree will expand listener: treeWillExpand */
    public void treeWillExpand(TreeExpansionEvent e)
            throws ExpandVetoException {
<span class="nc" id="L267">        TreePath path = e.getPath();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (!tree.hasBeenExpanded(path)) {</span>
<span class="nc" id="L269">            DefaultMutableTreeNode node =</span>
<span class="nc" id="L270">                    (DefaultMutableTreeNode) path.getLastPathComponent();</span>
<span class="nc bnc" id="L271" title="All 4 branches missed.">            if (sheet.isMBeanNode(node) &amp;&amp; !tree.hasMetadataNodes(node)) {</span>
<span class="nc" id="L272">                tree.addMetadataNodes(node);</span>
            }
        }
<span class="nc" id="L275">    }</span>

    /* tree will expand listener: treeWillCollapse */
    public void treeWillCollapse(TreeExpansionEvent e)
            throws ExpandVetoException {
<span class="nc" id="L280">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>