<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ClassTab.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.tools.jconsole</a> &gt; <span class="el_source">ClassTab.java</span></div><h1>ClassTab.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jconsole;

import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.lang.management.*;
import java.lang.reflect.*;

import javax.swing.*;
import javax.swing.border.*;


import java.util.concurrent.*;

import static sun.tools.jconsole.Formatter.*;
import static sun.tools.jconsole.Utilities.*;


@SuppressWarnings(&quot;serial&quot;)
class ClassTab extends Tab implements ActionListener {
    PlotterPanel loadedClassesMeter;
    TimeComboBox timeComboBox;
    private JCheckBox verboseCheckBox;
    private HTMLPane details;
    private ClassOverviewPanel overviewPanel;
<span class="nc" id="L51">    private boolean plotterListening = false;</span>

    private static final String loadedPlotterKey        = &quot;loaded&quot;;
    private static final String totalLoadedPlotterKey   = &quot;totalLoaded&quot;;
<span class="nc" id="L55">    private static final Color  loadedPlotterColor      = Plotter.defaultColor;</span>
<span class="nc" id="L56">    private static final Color  totalLoadedPlotterColor = Color.red;</span>

    /*
      Hierarchy of panels and layouts for this tab:

        ClassTab (BorderLayout)

            North:  topPanel (BorderLayout)

                        Center: controlPanel (FlowLayout)
                                    timeComboBox

                        East:   topRightPanel (FlowLayout)
                                    verboseCheckBox

            Center: plotterPanel (BorderLayout)

                        Center: plotter

            South:  bottomPanel (BorderLayout)

                        Center: details
    */

    public static String getTabName() {
<span class="nc" id="L81">        return Messages.CLASSES;</span>
    }

    public ClassTab(VMPanel vmPanel) {
<span class="nc" id="L85">        super(vmPanel, getTabName());</span>

<span class="nc" id="L87">        setLayout(new BorderLayout(0, 0));</span>
<span class="nc" id="L88">        setBorder(new EmptyBorder(4, 4, 3, 4));</span>

<span class="nc" id="L90">        JPanel topPanel     = new JPanel(new BorderLayout());</span>
<span class="nc" id="L91">        JPanel plotterPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L92">        JPanel bottomPanel  = new JPanel(new BorderLayout());</span>

<span class="nc" id="L94">        add(topPanel,     BorderLayout.NORTH);</span>
<span class="nc" id="L95">        add(plotterPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L96">        add(bottomPanel,  BorderLayout.SOUTH);</span>

<span class="nc" id="L98">        JPanel controlPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 20, 5));</span>
<span class="nc" id="L99">        topPanel.add(controlPanel, BorderLayout.CENTER);</span>

<span class="nc" id="L101">        verboseCheckBox = new JCheckBox(Messages.VERBOSE_OUTPUT);</span>
<span class="nc" id="L102">        verboseCheckBox.addActionListener(this);</span>
<span class="nc" id="L103">        verboseCheckBox.setToolTipText(Messages.VERBOSE_OUTPUT_TOOLTIP);</span>
<span class="nc" id="L104">        JPanel topRightPanel = new JPanel();</span>
<span class="nc" id="L105">        topRightPanel.setBorder(new EmptyBorder(0, 65-8, 0, 70));</span>
<span class="nc" id="L106">        topRightPanel.add(verboseCheckBox);</span>
<span class="nc" id="L107">        topPanel.add(topRightPanel, BorderLayout.AFTER_LINE_ENDS);</span>

<span class="nc" id="L109">        loadedClassesMeter = new PlotterPanel(Messages.NUMBER_OF_LOADED_CLASSES,</span>
                                              Plotter.Unit.NONE, false);
<span class="nc" id="L111">        loadedClassesMeter.plotter.createSequence(loadedPlotterKey,</span>
                                                  Messages.LOADED,
                                                  loadedPlotterColor,
                                                  true);
<span class="nc" id="L115">        loadedClassesMeter.plotter.createSequence(totalLoadedPlotterKey,</span>
                                                  Messages.TOTAL_LOADED,
                                                  totalLoadedPlotterColor,
                                                  true);
<span class="nc" id="L119">        setAccessibleName(loadedClassesMeter.plotter,</span>
                          Messages.CLASS_TAB_LOADED_CLASSES_PLOTTER_ACCESSIBLE_NAME);
<span class="nc" id="L121">        plotterPanel.add(loadedClassesMeter);</span>

<span class="nc" id="L123">        timeComboBox = new TimeComboBox(loadedClassesMeter.plotter);</span>
<span class="nc" id="L124">        controlPanel.add(new LabeledComponent(Messages.TIME_RANGE_COLON,</span>
<span class="nc" id="L125">                                              Resources.getMnemonicInt(Messages.TIME_RANGE_COLON),</span>
                                              timeComboBox));

<span class="nc" id="L128">        LabeledComponent.layout(plotterPanel);</span>

<span class="nc" id="L130">        bottomPanel.setBorder(new CompoundBorder(new TitledBorder(Messages.DETAILS),</span>
                                                 new EmptyBorder(10, 10, 10, 10)));

<span class="nc" id="L133">        details = new HTMLPane();</span>
<span class="nc" id="L134">        setAccessibleName(details, Messages.DETAILS);</span>
<span class="nc" id="L135">        JScrollPane scrollPane = new JScrollPane(details);</span>
<span class="nc" id="L136">        scrollPane.setPreferredSize(new Dimension(0, 150));</span>
<span class="nc" id="L137">        bottomPanel.add(scrollPane, BorderLayout.SOUTH);</span>

<span class="nc" id="L139">    }</span>

    public void actionPerformed(ActionEvent ev) {
<span class="nc" id="L142">        final boolean b = verboseCheckBox.isSelected();</span>
<span class="nc" id="L143">        workerAdd(new Runnable() {</span>
            public void run() {
<span class="nc" id="L145">                ProxyClient proxyClient = vmPanel.getProxyClient();</span>
                try {
<span class="nc" id="L147">                    proxyClient.getClassLoadingMXBean().setVerbose(b);</span>
<span class="nc" id="L148">                } catch (UndeclaredThrowableException e) {</span>
<span class="nc" id="L149">                    proxyClient.markAsDead();</span>
<span class="nc" id="L150">                } catch (IOException ex) {</span>
                    // Ignore
<span class="nc" id="L152">                }</span>
<span class="nc" id="L153">            }</span>
        });
<span class="nc" id="L155">    }</span>


    public SwingWorker&lt;?, ?&gt; newSwingWorker() {
<span class="nc" id="L159">        final ProxyClient proxyClient = vmPanel.getProxyClient();</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!plotterListening) {</span>
<span class="nc" id="L162">            proxyClient.addWeakPropertyChangeListener(loadedClassesMeter.plotter);</span>
<span class="nc" id="L163">            plotterListening = true;</span>
        }

<span class="nc" id="L166">        return new SwingWorker&lt;Boolean, Object&gt;() {</span>
            private long clCount, cuCount, ctCount;
            private boolean isVerbose;
            private String detailsStr;
            private long timeStamp;

            public Boolean doInBackground() {
                try {
<span class="nc" id="L174">                    ClassLoadingMXBean classLoadingMBean = proxyClient.getClassLoadingMXBean();</span>

<span class="nc" id="L176">                    clCount = classLoadingMBean.getLoadedClassCount();</span>
<span class="nc" id="L177">                    cuCount = classLoadingMBean.getUnloadedClassCount();</span>
<span class="nc" id="L178">                    ctCount = classLoadingMBean.getTotalLoadedClassCount();</span>
<span class="nc" id="L179">                    isVerbose = classLoadingMBean.isVerbose();</span>
<span class="nc" id="L180">                    detailsStr = formatDetails();</span>
<span class="nc" id="L181">                    timeStamp = System.currentTimeMillis();</span>

<span class="nc" id="L183">                    return true;</span>
<span class="nc" id="L184">                } catch (UndeclaredThrowableException e) {</span>
<span class="nc" id="L185">                    proxyClient.markAsDead();</span>
<span class="nc" id="L186">                    return false;</span>
<span class="nc" id="L187">                } catch (IOException e) {</span>
<span class="nc" id="L188">                    return false;</span>
                }
            }

            protected void done() {
                try {
<span class="nc bnc" id="L194" title="All 2 branches missed.">                    if (get()) {</span>
<span class="nc" id="L195">                        loadedClassesMeter.plotter.addValues(timeStamp, clCount, ctCount);</span>

<span class="nc bnc" id="L197" title="All 2 branches missed.">                        if (overviewPanel != null) {</span>
<span class="nc" id="L198">                            overviewPanel.updateClassInfo(ctCount, clCount);</span>
<span class="nc" id="L199">                            overviewPanel.getPlotter().addValues(timeStamp, clCount);</span>
                        }

<span class="nc" id="L202">                        loadedClassesMeter.setValueLabel(clCount + &quot;&quot;);</span>
<span class="nc" id="L203">                        verboseCheckBox.setSelected(isVerbose);</span>
<span class="nc" id="L204">                        details.setText(detailsStr);</span>
                    }
<span class="nc" id="L206">                } catch (InterruptedException ex) {</span>
<span class="nc" id="L207">                } catch (ExecutionException ex) {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L209">                        ex.printStackTrace();</span>
                    }
<span class="nc" id="L211">                }</span>
<span class="nc" id="L212">            }</span>

            private String formatDetails() {
<span class="nc" id="L215">                String text = &quot;&lt;table cellspacing=0 cellpadding=0&gt;&quot;;</span>

<span class="nc" id="L217">                long time = System.currentTimeMillis();</span>
<span class="nc" id="L218">                String timeStamp = formatDateTime(time);</span>
<span class="nc" id="L219">                text += newRow(Messages.TIME, timeStamp);</span>
<span class="nc" id="L220">                text += newRow(Messages.CURRENT_CLASSES_LOADED, justify(clCount, 5));</span>
<span class="nc" id="L221">                text += newRow(Messages.TOTAL_CLASSES_LOADED,   justify(ctCount, 5));</span>
<span class="nc" id="L222">                text += newRow(Messages.TOTAL_CLASSES_UNLOADED, justify(cuCount, 5));</span>

<span class="nc" id="L224">                return text;</span>
            }
        };
    }


    OverviewPanel[] getOverviewPanels() {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (overviewPanel == null) {</span>
<span class="nc" id="L232">            overviewPanel = new ClassOverviewPanel();</span>
        }
<span class="nc" id="L234">        return new OverviewPanel[] { overviewPanel };</span>
    }

    private static class ClassOverviewPanel extends OverviewPanel {
        ClassOverviewPanel() {
<span class="nc" id="L239">            super(Messages.CLASSES, loadedPlotterKey, Messages.LOADED, null);</span>
<span class="nc" id="L240">        }</span>

        private void updateClassInfo(long total, long loaded) {
<span class="nc" id="L243">            long unloaded = (total - loaded);</span>
<span class="nc" id="L244">            getInfoLabel().setText(Resources.format(Messages.CLASS_TAB_INFO_LABEL_FORMAT,</span>
<span class="nc" id="L245">                                   loaded, unloaded, total));</span>
<span class="nc" id="L246">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>