<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SummaryTab.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.tools.jconsole</a> &gt; <span class="el_source">SummaryTab.java</span></div><h1>SummaryTab.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jconsole;

import java.awt.*;
import java.io.*;
import java.lang.management.*;
import java.lang.reflect.*;
import java.text.*;
import java.util.*;
import java.util.concurrent.*;

import javax.swing.*;


import static sun.tools.jconsole.Formatter.*;
import static sun.tools.jconsole.Utilities.*;

@SuppressWarnings(&quot;serial&quot;)
class SummaryTab extends Tab {
    private static final String cpuUsageKey = &quot;cpu&quot;;

    private static final String newDivider =   &quot;&lt;tr&gt;&lt;td colspan=4&gt;&lt;font size =-1&gt;&lt;hr&gt;&quot;;
    private static final String newTable =     &quot;&lt;tr&gt;&lt;td colspan=4 align=left&gt;&lt;table cellpadding=1&gt;&quot;;
    private static final String newLeftTable = &quot;&lt;tr&gt;&lt;td colspan=2 align=left&gt;&lt;table cellpadding=1&gt;&quot;;
    private static final String newRightTable =  &quot;&lt;td colspan=2 align=left&gt;&lt;table cellpadding=1&gt;&quot;;
    private static final String endTable = &quot;&lt;/table&gt;&quot;;

    private static final int CPU_DECIMALS = 1;

    private CPUOverviewPanel overviewPanel;
    private DateFormat headerDateTimeFormat;
<span class="nc" id="L56">    private String pathSeparator = null;</span>
    HTMLPane info;

<span class="nc" id="L59">    private static class Result {</span>
<span class="nc" id="L60">        long upTime = -1L;</span>
<span class="nc" id="L61">        long processCpuTime = -1L;</span>
        long timeStamp;
        int nCPUs;
        String summary;
    }

    public static String getTabName() {
<span class="nc" id="L68">        return Messages.SUMMARY_TAB_TAB_NAME;</span>
    }

    public SummaryTab(VMPanel vmPanel) {
<span class="nc" id="L72">        super(vmPanel, getTabName());</span>

<span class="nc" id="L74">        setLayout(new BorderLayout());</span>

<span class="nc" id="L76">        info = new HTMLPane();</span>
<span class="nc" id="L77">        setAccessibleName(info, getTabName());</span>
<span class="nc" id="L78">        add(new JScrollPane(info));</span>

<span class="nc" id="L80">        headerDateTimeFormat =</span>
<span class="nc" id="L81">            Formatter.getDateTimeFormat(Messages.SUMMARY_TAB_HEADER_DATE_TIME_FORMAT);</span>
<span class="nc" id="L82">    }</span>

    public SwingWorker&lt;?, ?&gt; newSwingWorker() {
<span class="nc" id="L85">        return new SwingWorker&lt;Result, Object&gt;() {</span>
            public Result doInBackground() {
<span class="nc" id="L87">                return formatSummary();</span>
            }


            protected void done() {
                try {
<span class="nc" id="L93">                    Result result = get();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">                    if (result != null) {</span>
<span class="nc" id="L95">                        info.setText(result.summary);</span>
<span class="nc bnc" id="L96" title="All 6 branches missed.">                        if (overviewPanel != null &amp;&amp;</span>
                            result.upTime &gt; 0L &amp;&amp;
                            result.processCpuTime &gt;= 0L) {

<span class="nc" id="L100">                            overviewPanel.updateCPUInfo(result);</span>
                        }
                    }
<span class="nc" id="L103">                } catch (InterruptedException ex) {</span>
<span class="nc" id="L104">                } catch (ExecutionException ex) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L106">                        ex.printStackTrace();</span>
                    }
<span class="nc" id="L108">                }</span>
<span class="nc" id="L109">            }</span>
        };
    }

    StringBuilder buf;

    synchronized Result formatSummary() {
<span class="nc" id="L116">        Result result = new Result();</span>
<span class="nc" id="L117">        ProxyClient proxyClient = vmPanel.getProxyClient();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (proxyClient.isDead()) {</span>
<span class="nc" id="L119">            return null;</span>
        }

<span class="nc" id="L122">        buf = new StringBuilder();</span>
<span class="nc" id="L123">        append(&quot;&lt;table cellpadding=1&gt;&quot;);</span>

        try {
<span class="nc" id="L126">            RuntimeMXBean         rmBean     = proxyClient.getRuntimeMXBean();</span>
<span class="nc" id="L127">            CompilationMXBean     cmpMBean   = proxyClient.getCompilationMXBean();</span>
<span class="nc" id="L128">            ThreadMXBean          tmBean     = proxyClient.getThreadMXBean();</span>
<span class="nc" id="L129">            MemoryMXBean          memoryBean = proxyClient.getMemoryMXBean();</span>
<span class="nc" id="L130">            ClassLoadingMXBean    clMBean    = proxyClient.getClassLoadingMXBean();</span>
<span class="nc" id="L131">            OperatingSystemMXBean osMBean    = proxyClient.getOperatingSystemMXBean();</span>
<span class="nc" id="L132">            com.sun.management.OperatingSystemMXBean sunOSMBean  =</span>
<span class="nc" id="L133">               proxyClient.getSunOperatingSystemMXBean();</span>

<span class="nc" id="L135">            append(&quot;&lt;tr&gt;&lt;td colspan=4&gt;&quot;);</span>
<span class="nc" id="L136">            append(&quot;&lt;center&gt;&lt;b&gt;&quot; + Messages.SUMMARY_TAB_TAB_NAME + &quot;&lt;/b&gt;&lt;/center&gt;&quot;);</span>
<span class="nc" id="L137">            String dateTime =</span>
<span class="nc" id="L138">                headerDateTimeFormat.format(System.currentTimeMillis());</span>
<span class="nc" id="L139">            append(&quot;&lt;center&gt;&quot; + dateTime + &quot;&lt;/center&gt;&quot;);</span>

<span class="nc" id="L141">            append(newDivider);</span>

            {  // VM info
<span class="nc" id="L144">                append(newLeftTable);</span>
<span class="nc" id="L145">                append(Messages.CONNECTION_NAME, vmPanel.getDisplayName());</span>
<span class="nc" id="L146">                append(Messages.VIRTUAL_MACHINE,</span>
<span class="nc" id="L147">                       Resources.format(Messages.SUMMARY_TAB_VM_VERSION,</span>
<span class="nc" id="L148">                                        rmBean.getVmName(), rmBean.getVmVersion()));</span>
<span class="nc" id="L149">                append(Messages.VENDOR, rmBean.getVmVendor());</span>
<span class="nc" id="L150">                append(Messages.NAME, rmBean.getName());</span>
<span class="nc" id="L151">                append(endTable);</span>

<span class="nc" id="L153">                append(newRightTable);</span>
<span class="nc" id="L154">                result.upTime = rmBean.getUptime();</span>
<span class="nc" id="L155">                append(Messages.UPTIME, formatTime(result.upTime));</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                if (sunOSMBean != null) {</span>
<span class="nc" id="L157">                    result.processCpuTime = sunOSMBean.getProcessCpuTime();</span>
<span class="nc" id="L158">                    append(Messages.PROCESS_CPU_TIME, formatNanoTime(result.processCpuTime));</span>
                }

<span class="nc bnc" id="L161" title="All 2 branches missed.">                if (cmpMBean != null) {</span>
<span class="nc" id="L162">                    append(Messages.JIT_COMPILER, cmpMBean.getName());</span>
<span class="nc" id="L163">                    append(Messages.TOTAL_COMPILE_TIME,</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                           cmpMBean.isCompilationTimeMonitoringSupported()</span>
<span class="nc" id="L165">                                    ? formatTime(cmpMBean.getTotalCompilationTime())</span>
                                    : Messages.UNAVAILABLE);
                } else {
<span class="nc" id="L168">                    append(Messages.JIT_COMPILER, Messages.UNAVAILABLE);</span>
                }
<span class="nc" id="L170">                append(endTable);</span>
            }

<span class="nc" id="L173">            append(newDivider);</span>

            {  // Threads and Classes
<span class="nc" id="L176">                append(newLeftTable);</span>
<span class="nc" id="L177">                int tlCount = tmBean.getThreadCount();</span>
<span class="nc" id="L178">                int tdCount = tmBean.getDaemonThreadCount();</span>
<span class="nc" id="L179">                int tpCount = tmBean.getPeakThreadCount();</span>
<span class="nc" id="L180">                long ttCount = tmBean.getTotalStartedThreadCount();</span>
<span class="nc" id="L181">                String[] strings1 = formatLongs(tlCount, tpCount,</span>
                                                tdCount, ttCount);
<span class="nc" id="L183">                append(Messages.LIVE_THREADS, strings1[0]);</span>
<span class="nc" id="L184">                append(Messages.PEAK, strings1[1]);</span>
<span class="nc" id="L185">                append(Messages.DAEMON_THREADS, strings1[2]);</span>
<span class="nc" id="L186">                append(Messages.TOTAL_THREADS_STARTED, strings1[3]);</span>
<span class="nc" id="L187">                append(endTable);</span>

<span class="nc" id="L189">                append(newRightTable);</span>
<span class="nc" id="L190">                long clCount = clMBean.getLoadedClassCount();</span>
<span class="nc" id="L191">                long cuCount = clMBean.getUnloadedClassCount();</span>
<span class="nc" id="L192">                long ctCount = clMBean.getTotalLoadedClassCount();</span>
<span class="nc" id="L193">                String[] strings2 = formatLongs(clCount, cuCount, ctCount);</span>
<span class="nc" id="L194">                append(Messages.CURRENT_CLASSES_LOADED, strings2[0]);</span>
<span class="nc" id="L195">                append(Messages.TOTAL_CLASSES_LOADED, strings2[2]);</span>
<span class="nc" id="L196">                append(Messages.TOTAL_CLASSES_UNLOADED, strings2[1]);</span>
<span class="nc" id="L197">                append(null, &quot;&quot;);</span>
<span class="nc" id="L198">                append(endTable);</span>
            }

<span class="nc" id="L201">            append(newDivider);</span>

            {  // Memory
<span class="nc" id="L204">                MemoryUsage u = memoryBean.getHeapMemoryUsage();</span>

<span class="nc" id="L206">                append(newLeftTable);</span>
<span class="nc" id="L207">                String[] strings1 = formatKByteStrings(u.getUsed(), u.getMax());</span>
<span class="nc" id="L208">                append(Messages.CURRENT_HEAP_SIZE, strings1[0]);</span>
<span class="nc" id="L209">                append(Messages.MAXIMUM_HEAP_SIZE, strings1[1]);</span>
<span class="nc" id="L210">                append(endTable);</span>

<span class="nc" id="L212">                append(newRightTable);</span>
<span class="nc" id="L213">                String[] strings2 = formatKByteStrings(u.getCommitted());</span>
<span class="nc" id="L214">                append(Messages.COMMITTED_MEMORY,  strings2[0]);</span>
<span class="nc" id="L215">                append(Messages.SUMMARY_TAB_PENDING_FINALIZATION_LABEL,</span>
                       Messages.SUMMARY_TAB_PENDING_FINALIZATION_VALUE,
<span class="nc" id="L217">                       memoryBean.getObjectPendingFinalizationCount());</span>
<span class="nc" id="L218">                append(endTable);</span>

<span class="nc" id="L220">                append(newTable);</span>
<span class="nc" id="L221">                Collection&lt;GarbageCollectorMXBean&gt; garbageCollectors =</span>
<span class="nc" id="L222">                                            proxyClient.getGarbageCollectorMXBeans();</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                for (GarbageCollectorMXBean garbageCollectorMBean : garbageCollectors) {</span>
<span class="nc" id="L224">                    String gcName = garbageCollectorMBean.getName();</span>
<span class="nc" id="L225">                    long gcCount = garbageCollectorMBean.getCollectionCount();</span>
<span class="nc" id="L226">                    long gcTime = garbageCollectorMBean.getCollectionTime();</span>

<span class="nc" id="L228">                    append(Messages.GARBAGE_COLLECTOR,</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                           Resources.format(Messages.GC_INFO, gcName, gcCount,</span>
<span class="nc" id="L230">                                            (gcTime &gt;= 0) ? formatTime(gcTime)</span>
                                                 : Messages.UNAVAILABLE),
                           4);
<span class="nc" id="L233">                }</span>
<span class="nc" id="L234">                append(endTable);</span>
            }

<span class="nc" id="L237">            append(newDivider);</span>

            {  // Operating System info
<span class="nc" id="L240">                append(newLeftTable);</span>
<span class="nc" id="L241">                String osName = osMBean.getName();</span>
<span class="nc" id="L242">                String osVersion = osMBean.getVersion();</span>
<span class="nc" id="L243">                String osArch = osMBean.getArch();</span>
<span class="nc" id="L244">                result.nCPUs = osMBean.getAvailableProcessors();</span>
<span class="nc" id="L245">                append(Messages.OPERATING_SYSTEM, osName + &quot; &quot; + osVersion);</span>
<span class="nc" id="L246">                append(Messages.ARCHITECTURE, osArch);</span>
<span class="nc" id="L247">                append(Messages.NUMBER_OF_PROCESSORS, result.nCPUs+&quot;&quot;);</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (pathSeparator == null) {</span>
                    // Must use separator of remote OS, not File.pathSeparator
                    // from this local VM. In the future, consider using
                    // RuntimeMXBean to get the remote system property.
<span class="nc bnc" id="L253" title="All 2 branches missed.">                    pathSeparator = osName.startsWith(&quot;Windows &quot;) ? &quot;;&quot; : &quot;:&quot;;</span>
                }

<span class="nc bnc" id="L256" title="All 2 branches missed.">                if (sunOSMBean != null) {</span>
<span class="nc" id="L257">                    String[] kbStrings1 =</span>
<span class="nc" id="L258">                        formatKByteStrings(sunOSMBean.getCommittedVirtualMemorySize());</span>

<span class="nc" id="L260">                    String[] kbStrings2 =</span>
<span class="nc" id="L261">                        formatKByteStrings(sunOSMBean.getTotalPhysicalMemorySize(),</span>
<span class="nc" id="L262">                                           sunOSMBean.getFreePhysicalMemorySize(),</span>
<span class="nc" id="L263">                                           sunOSMBean.getTotalSwapSpaceSize(),</span>
<span class="nc" id="L264">                                           sunOSMBean.getFreeSwapSpaceSize());</span>

<span class="nc" id="L266">                    append(Messages.COMMITTED_VIRTUAL_MEMORY, kbStrings1[0]);</span>
<span class="nc" id="L267">                    append(endTable);</span>

<span class="nc" id="L269">                    append(newRightTable);</span>
<span class="nc" id="L270">                    append(Messages.TOTAL_PHYSICAL_MEMORY, kbStrings2[0]);</span>
<span class="nc" id="L271">                    append(Messages.FREE_PHYSICAL_MEMORY,  kbStrings2[1]);</span>
<span class="nc" id="L272">                    append(Messages.TOTAL_SWAP_SPACE,      kbStrings2[2]);</span>
<span class="nc" id="L273">                    append(Messages.FREE_SWAP_SPACE,       kbStrings2[3]);</span>
                }

<span class="nc" id="L276">                append(endTable);</span>
            }

<span class="nc" id="L279">            append(newDivider);</span>

            {  // VM arguments and paths
<span class="nc" id="L282">                append(newTable);</span>
<span class="nc" id="L283">                String args = &quot;&quot;;</span>
<span class="nc" id="L284">                java.util.List&lt;String&gt; inputArguments = rmBean.getInputArguments();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                for (String arg : inputArguments) {</span>
<span class="nc" id="L286">                    args += arg + &quot; &quot;;</span>
<span class="nc" id="L287">                }</span>
<span class="nc" id="L288">                append(Messages.VM_ARGUMENTS, args, 4);</span>
<span class="nc" id="L289">                append(Messages.CLASS_PATH,   rmBean.getClassPath(), 4);</span>
<span class="nc" id="L290">                append(Messages.LIBRARY_PATH, rmBean.getLibraryPath(), 4);</span>
<span class="nc" id="L291">                append(Messages.BOOT_CLASS_PATH,</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                       rmBean.isBootClassPathSupported()</span>
<span class="nc" id="L293">                                    ? rmBean.getBootClassPath()</span>
                                    : Messages.UNAVAILABLE,
                       4);
<span class="nc" id="L296">                append(endTable);</span>
            }
<span class="nc" id="L298">        } catch (IOException e) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            if (JConsole.isDebug()) {</span>
<span class="nc" id="L300">                e.printStackTrace();</span>
            }
<span class="nc" id="L302">            proxyClient.markAsDead();</span>
<span class="nc" id="L303">            return null;</span>
<span class="nc" id="L304">        } catch (UndeclaredThrowableException e) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (JConsole.isDebug()) {</span>
<span class="nc" id="L306">                e.printStackTrace();</span>
            }
<span class="nc" id="L308">            proxyClient.markAsDead();</span>
<span class="nc" id="L309">            return null;</span>
<span class="nc" id="L310">        }</span>

<span class="nc" id="L312">        append(&quot;&lt;/table&gt;&quot;);</span>

<span class="nc" id="L314">        result.timeStamp = System.currentTimeMillis();</span>
<span class="nc" id="L315">        result.summary = buf.toString();</span>

<span class="nc" id="L317">        return result;</span>
    }

    private synchronized void append(String str) {
<span class="nc" id="L321">        buf.append(str);</span>
<span class="nc" id="L322">    }</span>

    void append(String label, String value) {
<span class="nc" id="L325">        append(newRow(label, value));</span>
<span class="nc" id="L326">    }</span>

    private void append(String label, String value, int columnPerRow) {
<span class="nc bnc" id="L329" title="All 4 branches missed.">        if (columnPerRow == 4 &amp;&amp; pathSeparator != null) {</span>
<span class="nc" id="L330">            value = value.replace(pathSeparator,</span>
                                  &quot;&lt;b&gt;&lt;/b&gt;&quot; + pathSeparator);
        }
<span class="nc" id="L333">        append(newRow(label, value, columnPerRow));</span>
<span class="nc" id="L334">    }</span>

    OverviewPanel[] getOverviewPanels() {
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (overviewPanel == null) {</span>
<span class="nc" id="L338">            overviewPanel = new CPUOverviewPanel();</span>
        }
<span class="nc" id="L340">        return new OverviewPanel[] { overviewPanel };</span>
    }

    private static class CPUOverviewPanel extends OverviewPanel {
        private long prevUpTime, prevProcessCpuTime;

        CPUOverviewPanel() {
<span class="nc" id="L347">            super(Messages.CPU_USAGE, cpuUsageKey, Messages.CPU_USAGE, Plotter.Unit.PERCENT);</span>
<span class="nc" id="L348">            getPlotter().setDecimals(CPU_DECIMALS);</span>
<span class="nc" id="L349">        }</span>

        public void updateCPUInfo(Result result) {
<span class="nc bnc" id="L352" title="All 4 branches missed.">            if (prevUpTime &gt; 0L &amp;&amp; result.upTime &gt; prevUpTime) {</span>
                // elapsedCpu is in ns and elapsedTime is in ms.
<span class="nc" id="L354">                long elapsedCpu = result.processCpuTime - prevProcessCpuTime;</span>
<span class="nc" id="L355">                long elapsedTime = result.upTime - prevUpTime;</span>
                // cpuUsage could go higher than 100% because elapsedTime
                // and elapsedCpu are not fetched simultaneously. Limit to
                // 99% to avoid Plotter showing a scale from 0% to 200%.
<span class="nc" id="L359">                float cpuUsage =</span>
<span class="nc" id="L360">                    Math.min(99F,</span>
                             elapsedCpu / (elapsedTime * 10000F * result.nCPUs));

<span class="nc" id="L363">                cpuUsage = Math.max(0F, cpuUsage);</span>

<span class="nc" id="L365">                getPlotter().addValues(result.timeStamp,</span>
<span class="nc" id="L366">                                Math.round(cpuUsage * Math.pow(10.0, CPU_DECIMALS)));</span>
<span class="nc" id="L367">                getInfoLabel().setText(Resources.format(Messages.CPU_USAGE_FORMAT,</span>
<span class="nc" id="L368">                                               String.format(&quot;%.&quot;+CPU_DECIMALS+&quot;f&quot;, cpuUsage)));</span>
            }
<span class="nc" id="L370">            this.prevUpTime = result.upTime;</span>
<span class="nc" id="L371">            this.prevProcessCpuTime = result.processCpuTime;</span>
<span class="nc" id="L372">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>