<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>MaximizableInternalFrame.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.tools.jconsole</a> &gt; <span class="el_source">MaximizableInternalFrame.java</span></div><h1>MaximizableInternalFrame.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2006, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jconsole;

import java.awt.*;
import java.beans.*;
import java.lang.reflect.*;

import javax.swing.*;
import javax.swing.border.*;
import javax.swing.plaf.basic.*;


/**
 * This class is a temporary workaround for bug 4834918:
 * Win L&amp;F: JInternalFrame should merge with JMenuBar when maximized.
 * It is not a general solution, but intended for use within the
 * limited scope of JConsole when running with XP/Vista styles.
 */
@SuppressWarnings(&quot;serial&quot;)
public class MaximizableInternalFrame extends JInternalFrame {
    private boolean isXP;
    private JFrame mainFrame;
    private JMenuBar mainMenuBar;
    private String mainTitle;
    private JComponent titlePane;
    private Border normalBorder;
    private PropertyChangeListener pcl;

    public MaximizableInternalFrame(String title, boolean resizable,
                                    boolean closable, boolean maximizable,
                                    boolean iconifiable) {
<span class="nc" id="L56">        super(title, resizable, closable, maximizable, iconifiable);</span>

<span class="nc" id="L58">        init();</span>
<span class="nc" id="L59">    }</span>

    private void init() {
<span class="nc" id="L62">        normalBorder = getBorder();</span>
<span class="nc" id="L63">        isXP = normalBorder.getClass().getName().endsWith(&quot;XPBorder&quot;);</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (isXP) {</span>
<span class="nc" id="L65">            setRootPaneCheckingEnabled(false);</span>
<span class="nc" id="L66">            titlePane = ((BasicInternalFrameUI)getUI()).getNorthPane();</span>

<span class="nc bnc" id="L68" title="All 2 branches missed.">            if (pcl == null) {</span>
<span class="nc" id="L69">                pcl = new PropertyChangeListener() {</span>
                    public void propertyChange(PropertyChangeEvent ev) {
<span class="nc" id="L71">                        String prop = ev.getPropertyName();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">                        if (prop.equals(&quot;icon&quot;) ||</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">                            prop.equals(&quot;maximum&quot;) ||</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">                            prop.equals(&quot;closed&quot;)) {</span>

<span class="nc" id="L76">                            updateFrame();</span>
                        }
<span class="nc" id="L78">                    }</span>
                };
<span class="nc" id="L80">                addPropertyChangeListener(pcl);</span>
            }
<span class="nc bnc" id="L82" title="All 2 branches missed.">        } else if (pcl != null) {</span>
<span class="nc" id="L83">            removePropertyChangeListener(pcl);</span>
<span class="nc" id="L84">            pcl = null;</span>
        }
<span class="nc" id="L86">    }</span>

    private void updateFrame() {
        JFrame mainFrame;
<span class="nc bnc" id="L90" title="All 4 branches missed.">        if (!isXP || (mainFrame = getMainFrame()) == null) {</span>
<span class="nc" id="L91">            return;</span>
        }
<span class="nc" id="L93">        JMenuBar menuBar = getMainMenuBar();</span>
<span class="nc" id="L94">        BasicInternalFrameUI ui = (BasicInternalFrameUI)getUI();</span>
<span class="nc bnc" id="L95" title="All 6 branches missed.">        if (isMaximum() &amp;&amp; !isIcon() &amp;&amp; !isClosed()) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (ui.getNorthPane() != null) {</span>
                // Merge title bar into menu bar
<span class="nc" id="L98">                mainTitle = mainFrame.getTitle();</span>
<span class="nc" id="L99">                mainFrame.setTitle(mainTitle + &quot; - &quot; + getTitle());</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (menuBar != null) {</span>
                    // Move buttons to menu bar
<span class="nc" id="L102">                    updateButtonStates();</span>
<span class="nc" id="L103">                    menuBar.add(Box.createGlue());</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                    for (Component c : titlePane.getComponents()) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                        if (c instanceof JButton) {</span>
<span class="nc" id="L106">                            menuBar.add(c);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                        } else if (c instanceof JLabel) {</span>
                            // This is the system menu icon
<span class="nc" id="L109">                            menuBar.add(Box.createHorizontalStrut(3), 0);</span>
<span class="nc" id="L110">                            menuBar.add(c, 1);</span>
<span class="nc" id="L111">                            menuBar.add(Box.createHorizontalStrut(3), 2);</span>
                        }
                    }
<span class="nc" id="L114">                    ui.setNorthPane(null);</span>
<span class="nc" id="L115">                    setBorder(null);</span>
                }
            }
        } else {
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (ui.getNorthPane() == null) {</span>
                // Restore title bar
<span class="nc" id="L121">                mainFrame.setTitle(mainTitle);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (menuBar != null) {</span>
                    // Move buttons back to title bar
<span class="nc bnc" id="L124" title="All 2 branches missed.">                    for (Component c : menuBar.getComponents()) {</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">                        if (c instanceof JButton || c instanceof JLabel) {</span>
<span class="nc" id="L126">                            titlePane.add(c);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                        } else if (c instanceof Box.Filler) {</span>
<span class="nc" id="L128">                            menuBar.remove(c);</span>
                        }
                    }
<span class="nc" id="L131">                    menuBar.repaint();</span>
<span class="nc" id="L132">                    updateButtonStates();</span>
<span class="nc" id="L133">                    ui.setNorthPane(titlePane);</span>
<span class="nc" id="L134">                    setBorder(normalBorder);</span>
                }
            }
        }
<span class="nc" id="L138">    }</span>

    public void updateUI() {
<span class="nc bnc" id="L141" title="All 4 branches missed.">        boolean isMax = (isXP &amp;&amp; getBorder() == null);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (isMax) {</span>
            try {
<span class="nc" id="L144">                setMaximum(false);</span>
<span class="nc" id="L145">            } catch (PropertyVetoException ex) { }</span>
        }
<span class="nc" id="L147">        super.updateUI();</span>
<span class="nc" id="L148">        init();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (isMax) {</span>
            try {
<span class="nc" id="L151">                setMaximum(true);</span>
<span class="nc" id="L152">            } catch (PropertyVetoException ex) { }</span>
        }
<span class="nc" id="L154">    }</span>

    private JFrame getMainFrame() {
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (mainFrame == null) {</span>
<span class="nc" id="L158">            JDesktopPane desktop = getDesktopPane();</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (desktop != null) {</span>
<span class="nc" id="L160">                mainFrame = (JFrame)SwingUtilities.getWindowAncestor(desktop);</span>
            }
        }
<span class="nc" id="L163">        return mainFrame;</span>
    }

    private JMenuBar getMainMenuBar() {
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (mainMenuBar == null) {</span>
<span class="nc" id="L168">            JFrame mainFrame = getMainFrame();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (mainFrame != null) {</span>
<span class="nc" id="L170">                mainMenuBar = mainFrame.getJMenuBar();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                if (mainMenuBar != null &amp;&amp;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                    !(mainMenuBar.getLayout() instanceof FixedMenuBarLayout)) {</span>

<span class="nc" id="L174">                    mainMenuBar.setLayout(new FixedMenuBarLayout(mainMenuBar,</span>
                                                            BoxLayout.X_AXIS));
                }
            }
        }
<span class="nc" id="L179">        return mainMenuBar;</span>
    }

    public void setTitle(String title) {
<span class="nc bnc" id="L183" title="All 4 branches missed.">        if (isXP &amp;&amp; isMaximum()) {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (getMainFrame() != null) {</span>
<span class="nc" id="L185">                getMainFrame().setTitle(mainTitle + &quot; - &quot; + title);</span>
            }
        }
<span class="nc" id="L188">        super.setTitle(title);</span>
<span class="nc" id="L189">    }</span>


    private class FixedMenuBarLayout extends BoxLayout {
<span class="nc" id="L193">        public FixedMenuBarLayout(Container target, int axis) {</span>
<span class="nc" id="L194">            super(target, axis);</span>
<span class="nc" id="L195">        }</span>

        public void layoutContainer(Container target) {
<span class="nc" id="L198">            super.layoutContainer(target);</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">            for (Component c : target.getComponents()) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                if (c instanceof JButton) {</span>
<span class="nc" id="L202">                    int y = (target.getHeight() - c.getHeight()) / 2;</span>
<span class="nc" id="L203">                    c.setLocation(c.getX(), Math.max(2, y));</span>
                }
            }
<span class="nc" id="L206">        }</span>
    }


    // The rest of this class is messy and should not be relied upon. It
    // uses reflection to access private, undocumented, and unsupported
    // classes and fields.
    //
    // Install icon wrappers to display MDI icons when the buttons
    // are in the menubar.
    //
    // Please note that this will very likely fail in a future version
    // of Swing, but at least it should fail silently.
    //
    private static Object WP_MINBUTTON, WP_RESTOREBUTTON, WP_CLOSEBUTTON,
                          WP_MDIMINBUTTON, WP_MDIRESTOREBUTTON, WP_MDICLOSEBUTTON;
    static {
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (JConsole.IS_WIN) {</span>
            try {
<span class="nc" id="L225">                Class&lt;?&gt; Part =</span>
<span class="nc" id="L226">                    Class.forName(&quot;com.sun.java.swing.plaf.windows.TMSchema$Part&quot;);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                if (Part != null) {</span>
<span class="nc" id="L228">                    WP_MINBUTTON        = Part.getField(&quot;WP_MINBUTTON&quot;).get(null);</span>
<span class="nc" id="L229">                    WP_RESTOREBUTTON    = Part.getField(&quot;WP_RESTOREBUTTON&quot;).get(null);</span>
<span class="nc" id="L230">                    WP_CLOSEBUTTON      = Part.getField(&quot;WP_CLOSEBUTTON&quot;).get(null);</span>
<span class="nc" id="L231">                    WP_MDIMINBUTTON     = Part.getField(&quot;WP_MDIMINBUTTON&quot;).get(null);</span>
<span class="nc" id="L232">                    WP_MDIRESTOREBUTTON = Part.getField(&quot;WP_MDIRESTOREBUTTON&quot;).get(null);</span>
<span class="nc" id="L233">                    WP_MDICLOSEBUTTON   = Part.getField(&quot;WP_MDICLOSEBUTTON&quot;).get(null);</span>
                }

<span class="nc bnc" id="L236" title="All 2 branches missed.">                for (String str : new String[] { &quot;maximize&quot;, &quot;minimize&quot;,</span>
                                                 &quot;iconify&quot;, &quot;close&quot; }) {
<span class="nc" id="L238">                    String key = &quot;InternalFrame.&quot; + str + &quot;Icon&quot;;</span>
<span class="nc" id="L239">                    UIManager.put(key,</span>
<span class="nc" id="L240">                                  new MDIButtonIcon(UIManager.getIcon(key)));</span>
                }
<span class="nc" id="L242">            } catch (ClassNotFoundException ex) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                if (JConsole.debug) {</span>
<span class="nc" id="L244">                    ex.printStackTrace();</span>
                }
<span class="nc" id="L246">            } catch (NoSuchFieldException ex) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (JConsole.debug) {</span>
<span class="nc" id="L248">                    ex.printStackTrace();</span>
                }
<span class="nc" id="L250">            } catch (IllegalAccessException ex) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                if (JConsole.debug) {</span>
<span class="nc" id="L252">                    ex.printStackTrace();</span>
                }
<span class="nc" id="L254">            }</span>
        }
<span class="nc" id="L256">    }</span>


    // A wrapper class for the title pane button icons.
    // This code should really go in the WindowsIconsFactory class.
    private static class MDIButtonIcon implements Icon {
        Icon windowsIcon;
        Field part;

<span class="nc" id="L265">        MDIButtonIcon(Icon icon) {</span>
<span class="nc" id="L266">            windowsIcon = icon;</span>

<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (WP_MINBUTTON != null) {</span>
                try {
<span class="nc" id="L270">                    part = windowsIcon.getClass().getDeclaredField(&quot;part&quot;);</span>
<span class="nc" id="L271">                    part.setAccessible(true);</span>
<span class="nc" id="L272">                } catch (NoSuchFieldException ex) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                    if (JConsole.debug) {</span>
<span class="nc" id="L274">                        ex.printStackTrace();</span>
                    }
<span class="nc" id="L276">                }</span>
            }
<span class="nc" id="L278">        }</span>

        public void paintIcon(Component c, Graphics g, int x, int y) {
<span class="nc bnc" id="L281" title="All 2 branches missed.">            if (part != null) {</span>
                try {
<span class="nc" id="L283">                    Object v = part.get(windowsIcon);</span>

<span class="nc bnc" id="L285" title="All 2 branches missed.">                    if (c.getParent() instanceof JMenuBar) {</span>
                        // Use MDI icons
<span class="nc bnc" id="L287" title="All 2 branches missed.">                        if (v == WP_MINBUTTON) {</span>
<span class="nc" id="L288">                            part.set(windowsIcon, WP_MDIMINBUTTON);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">                        } else if (v == WP_RESTOREBUTTON) {</span>
<span class="nc" id="L290">                            part.set(windowsIcon, WP_MDIRESTOREBUTTON);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">                        } else if (v == WP_CLOSEBUTTON) {</span>
<span class="nc" id="L292">                            part.set(windowsIcon, WP_MDICLOSEBUTTON);</span>
                        }
                    } else {
                        // Use regular icons
<span class="nc bnc" id="L296" title="All 2 branches missed.">                        if (v == WP_MDIMINBUTTON) {</span>
<span class="nc" id="L297">                            part.set(windowsIcon, WP_MINBUTTON);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">                        } else if (v == WP_MDIRESTOREBUTTON) {</span>
<span class="nc" id="L299">                            part.set(windowsIcon, WP_RESTOREBUTTON);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                        } else if (v == WP_MDICLOSEBUTTON) {</span>
<span class="nc" id="L301">                            part.set(windowsIcon, WP_CLOSEBUTTON);</span>
                        }
                    }
<span class="nc" id="L304">                } catch (IllegalAccessException ex) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                    if (JConsole.debug) {</span>
<span class="nc" id="L306">                        ex.printStackTrace();</span>
                    }
<span class="nc" id="L308">                }</span>
            }
<span class="nc" id="L310">            windowsIcon.paintIcon(c, g, x, y);</span>
<span class="nc" id="L311">        }</span>

        public int getIconWidth(){
<span class="nc" id="L314">            return windowsIcon.getIconWidth();</span>
        }

        public int getIconHeight() {
<span class="nc" id="L318">            return windowsIcon.getIconHeight();</span>
        }
    }


    // Use reflection to invoke protected methods in BasicInternalFrameTitlePane
    private Method setButtonIcons;
    private Method enableActions;

    private void updateButtonStates() {
        try {
<span class="nc bnc" id="L329" title="All 2 branches missed.">            if (setButtonIcons == null) {</span>
<span class="nc" id="L330">                Class&lt;? extends JComponent&gt; cls = titlePane.getClass();</span>
<span class="nc" id="L331">                Class&lt;?&gt; superCls = cls.getSuperclass();</span>
<span class="nc" id="L332">                setButtonIcons = cls.getDeclaredMethod(&quot;setButtonIcons&quot;);</span>
<span class="nc" id="L333">                enableActions  = superCls.getDeclaredMethod(&quot;enableActions&quot;);</span>
<span class="nc" id="L334">                setButtonIcons.setAccessible(true);</span>
<span class="nc" id="L335">                enableActions.setAccessible(true);</span>
            }
<span class="nc" id="L337">            setButtonIcons.invoke(titlePane);</span>
<span class="nc" id="L338">            enableActions.invoke(titlePane);</span>
<span class="nc" id="L339">        } catch (Exception ex) {</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">            if (JConsole.debug) {</span>
<span class="nc" id="L341">                ex.printStackTrace();</span>
            }
<span class="nc" id="L343">        }</span>
<span class="nc" id="L344">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>