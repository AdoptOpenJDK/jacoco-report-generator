<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>JConsole.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.tools.jconsole</a> &gt; <span class="el_source">JConsole.java</span></div><h1>JConsole.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jconsole;

import java.awt.*;
import java.awt.event.*;
import java.beans.*;
import java.io.*;
import java.net.*;
import java.util.*;
import java.util.List;

import javax.swing.*;
import javax.swing.border.*;
import javax.swing.event.*;
import javax.swing.plaf.*;
import javax.security.auth.login.FailedLoginException;
import javax.net.ssl.SSLHandshakeException;

import com.sun.tools.jconsole.JConsolePlugin;

import sun.net.util.IPAddressUtil;

import static sun.tools.jconsole.Utilities.*;

@SuppressWarnings(&quot;serial&quot;)
public class JConsole extends JFrame
    implements ActionListener, InternalFrameListener {

    static /*final*/ boolean IS_GTK;
    static /*final*/ boolean IS_WIN;

    static {
        // Apply the system L&amp;F if it is GTK or Windows, and
        // the L&amp;F is not specified using a system property.
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (System.getProperty(&quot;swing.defaultlaf&quot;) == null) {</span>
<span class="nc" id="L60">            String systemLaF = UIManager.getSystemLookAndFeelClassName();</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            if (systemLaF.equals(&quot;com.sun.java.swing.plaf.gtk.GTKLookAndFeel&quot;) ||</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">                systemLaF.equals(&quot;com.sun.java.swing.plaf.windows.WindowsLookAndFeel&quot;)) {</span>

                try {
<span class="nc" id="L65">                    UIManager.setLookAndFeel(systemLaF);</span>
<span class="nc" id="L66">                } catch (Exception e) {</span>
<span class="nc" id="L67">                    System.err.println(Resources.format(Messages.JCONSOLE_COLON_, e.getMessage()));</span>
<span class="nc" id="L68">                }</span>
            }
        }

<span class="nc" id="L72">        updateLafValues();</span>
    }


    static void updateLafValues() {
<span class="nc" id="L77">        String lafName = UIManager.getLookAndFeel().getClass().getName();</span>
<span class="nc" id="L78">        IS_GTK = lafName.equals(&quot;com.sun.java.swing.plaf.gtk.GTKLookAndFeel&quot;);</span>
<span class="nc" id="L79">        IS_WIN = lafName.equals(&quot;com.sun.java.swing.plaf.windows.WindowsLookAndFeel&quot;);</span>

        //BorderedComponent.updateLafValues();
<span class="nc" id="L82">    }</span>


<span class="nc" id="L85">    private final static String title =</span>
        Messages.JAVA_MONITORING___MANAGEMENT_CONSOLE;
    public final static String ROOT_URL =
        &quot;service:jmx:&quot;;

<span class="nc" id="L90">    private static int updateInterval = 4000;</span>
<span class="nc" id="L91">    private static String pluginPath = &quot;&quot;;</span>

    private JMenuBar menuBar;
    private JMenuItem hotspotMI, connectMI, exitMI;
    private WindowMenu windowMenu;
    private JMenuItem tileMI, cascadeMI, minimizeAllMI, restoreAllMI;
    private JMenuItem userGuideMI, aboutMI;

    private JButton connectButton;
    private JDesktopPane desktop;
    private ConnectDialog connectDialog;
    private CreateMBeanDialog createDialog;

<span class="nc" id="L104">    private ArrayList&lt;VMInternalFrame&gt; windows =</span>
        new ArrayList&lt;VMInternalFrame&gt;();

<span class="nc" id="L107">    private int frameLoc = 5;</span>
    static boolean debug;

    public JConsole(boolean hotspot) {
<span class="nc" id="L111">        super(title);</span>

<span class="nc" id="L113">        setRootPane(new FixedJRootPane());</span>
<span class="nc" id="L114">        setAccessibleDescription(this,</span>
                                 Messages.JCONSOLE_ACCESSIBLE_DESCRIPTION);
<span class="nc" id="L116">        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span>

<span class="nc" id="L118">        menuBar = new JMenuBar();</span>
<span class="nc" id="L119">        setJMenuBar(menuBar);</span>

        // TODO: Use Actions !

<span class="nc" id="L123">        JMenu connectionMenu = new JMenu(Messages.CONNECTION);</span>
<span class="nc" id="L124">        connectionMenu.setMnemonic(Resources.getMnemonicInt(Messages.CONNECTION));</span>
<span class="nc" id="L125">        menuBar.add(connectionMenu);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if(hotspot) {</span>
<span class="nc" id="L127">            hotspotMI = new JMenuItem(Messages.HOTSPOT_MBEANS_ELLIPSIS);</span>
<span class="nc" id="L128">            hotspotMI.setMnemonic(Resources.getMnemonicInt(Messages.HOTSPOT_MBEANS_ELLIPSIS));</span>
<span class="nc" id="L129">            hotspotMI.setAccelerator(KeyStroke.</span>
<span class="nc" id="L130">                                     getKeyStroke(KeyEvent.VK_H,</span>
                                                  InputEvent.CTRL_MASK));
<span class="nc" id="L132">            hotspotMI.addActionListener(this);</span>
<span class="nc" id="L133">            connectionMenu.add(hotspotMI);</span>

<span class="nc" id="L135">            connectionMenu.addSeparator();</span>
        }

<span class="nc" id="L138">        connectMI = new JMenuItem(Messages.NEW_CONNECTION_ELLIPSIS);</span>
<span class="nc" id="L139">        connectMI.setMnemonic(Resources.getMnemonicInt(Messages.NEW_CONNECTION_ELLIPSIS));</span>
<span class="nc" id="L140">        connectMI.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_N,</span>
                                                        InputEvent.CTRL_MASK));
<span class="nc" id="L142">        connectMI.addActionListener(this);</span>
<span class="nc" id="L143">        connectionMenu.add(connectMI);</span>

<span class="nc" id="L145">        connectionMenu.addSeparator();</span>

<span class="nc" id="L147">        exitMI = new JMenuItem(Messages.EXIT);</span>
<span class="nc" id="L148">        exitMI.setMnemonic(Resources.getMnemonicInt(Messages.EXIT));</span>
<span class="nc" id="L149">        exitMI.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_F4,</span>
                                                     InputEvent.ALT_MASK));
<span class="nc" id="L151">        exitMI.addActionListener(this);</span>
<span class="nc" id="L152">        connectionMenu.add(exitMI);</span>


<span class="nc" id="L155">        JMenu helpMenu = new JMenu(Messages.HELP_MENU_TITLE);</span>
<span class="nc" id="L156">        helpMenu.setMnemonic(Resources.getMnemonicInt(Messages.HELP_MENU_TITLE));</span>
<span class="nc" id="L157">        menuBar.add(helpMenu);</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (AboutDialog.isBrowseSupported()) {</span>
<span class="nc" id="L160">            userGuideMI = new JMenuItem(Messages.HELP_MENU_USER_GUIDE_TITLE);</span>
<span class="nc" id="L161">            userGuideMI.setMnemonic(Resources.getMnemonicInt(Messages.HELP_MENU_USER_GUIDE_TITLE));</span>
<span class="nc" id="L162">            userGuideMI.addActionListener(this);</span>
<span class="nc" id="L163">            helpMenu.add(userGuideMI);</span>
<span class="nc" id="L164">            helpMenu.addSeparator();</span>
        }
<span class="nc" id="L166">        aboutMI = new JMenuItem(Messages.HELP_MENU_ABOUT_TITLE);</span>
<span class="nc" id="L167">        aboutMI.setMnemonic(Resources.getMnemonicInt(Messages.HELP_MENU_ABOUT_TITLE));</span>
<span class="nc" id="L168">        aboutMI.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_F1, 0));</span>
<span class="nc" id="L169">        aboutMI.addActionListener(this);</span>
<span class="nc" id="L170">        helpMenu.add(aboutMI);</span>
<span class="nc" id="L171">    }</span>

    public JDesktopPane getDesktopPane() {
<span class="nc" id="L174">        return desktop;</span>
    }

    public List&lt;VMInternalFrame&gt; getInternalFrames() {
<span class="nc" id="L178">        return windows;</span>
    }

    private void createMDI() {
        // Restore title - we now show connection name on internal frames
<span class="nc" id="L183">        setTitle(title);</span>

<span class="nc" id="L185">        Container cp = getContentPane();</span>
<span class="nc" id="L186">        Component oldCenter =</span>
<span class="nc" id="L187">            ((BorderLayout)cp.getLayout()).</span>
<span class="nc" id="L188">            getLayoutComponent(BorderLayout.CENTER);</span>

<span class="nc" id="L190">        windowMenu = new WindowMenu(Messages.WINDOW);</span>
<span class="nc" id="L191">        windowMenu.setMnemonic(Resources.getMnemonicInt(Messages.WINDOW));</span>
        // Add Window menu before Help menu
<span class="nc" id="L193">        menuBar.add(windowMenu, menuBar.getComponentCount() - 1);</span>

<span class="nc" id="L195">        desktop = new JDesktopPane();</span>
<span class="nc" id="L196">        desktop.setBackground(new Color(235, 245, 255));</span>

<span class="nc" id="L198">        cp.add(desktop, BorderLayout.CENTER);</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (oldCenter instanceof VMPanel) {</span>
<span class="nc" id="L201">            addFrame((VMPanel)oldCenter);</span>
        }
<span class="nc" id="L203">    }</span>

    private class WindowMenu extends JMenu {
<span class="nc" id="L206">        VMInternalFrame[] windowMenuWindows = new VMInternalFrame[0];</span>
        int separatorPosition;

        // The width value of viewR is used to truncate long menu items.
        // The rest are placeholders and are ignored for this purpose.
<span class="nc" id="L211">        Rectangle viewR = new Rectangle(0, 0, 400, 20);</span>
<span class="nc" id="L212">        Rectangle textR = new Rectangle(0, 0, 0, 0);</span>
<span class="nc" id="L213">        Rectangle iconR = new Rectangle(0, 0, 0, 0);</span>

<span class="nc" id="L215">        WindowMenu(String text) {</span>
<span class="nc" id="L216">            super(text);</span>

<span class="nc" id="L218">            cascadeMI = new JMenuItem(Messages.CASCADE);</span>
<span class="nc" id="L219">            cascadeMI.setMnemonic(Resources.getMnemonicInt(Messages.CASCADE));</span>
<span class="nc" id="L220">            cascadeMI.addActionListener(JConsole.this);</span>
<span class="nc" id="L221">            add(cascadeMI);</span>

<span class="nc" id="L223">            tileMI = new JMenuItem(Messages.TILE);</span>
<span class="nc" id="L224">            tileMI.setMnemonic(Resources.getMnemonicInt(Messages.TILE));</span>
<span class="nc" id="L225">            tileMI.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_T,</span>
                                                         InputEvent.CTRL_MASK));
<span class="nc" id="L227">            tileMI.addActionListener(JConsole.this);</span>
<span class="nc" id="L228">            add(tileMI);</span>

<span class="nc" id="L230">            minimizeAllMI = new JMenuItem(Messages.MINIMIZE_ALL);</span>
<span class="nc" id="L231">            minimizeAllMI.setMnemonic(Resources.getMnemonicInt(Messages.MINIMIZE_ALL));</span>
<span class="nc" id="L232">            minimizeAllMI.addActionListener(JConsole.this);</span>
<span class="nc" id="L233">            add(minimizeAllMI);</span>

<span class="nc" id="L235">            restoreAllMI = new JMenuItem(Messages.RESTORE_ALL);</span>
<span class="nc" id="L236">            restoreAllMI.setMnemonic(Resources.getMnemonicInt(Messages.RESTORE_ALL));</span>
<span class="nc" id="L237">            restoreAllMI.addActionListener(JConsole.this);</span>
<span class="nc" id="L238">            add(restoreAllMI);</span>

<span class="nc" id="L240">            separatorPosition = getMenuComponentCount();</span>
<span class="nc" id="L241">        }</span>

        private void add(VMInternalFrame vmIF) {
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (separatorPosition == getMenuComponentCount()) {</span>
<span class="nc" id="L245">                addSeparator();</span>
            }

<span class="nc" id="L248">            int index = -1;</span>
<span class="nc" id="L249">            int position = separatorPosition + 1;</span>
<span class="nc" id="L250">            int n = windowMenuWindows.length;</span>

<span class="nc bnc" id="L252" title="All 2 branches missed.">            for (int i = 0; i &lt; n; i++) {</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">                if (windowMenuWindows[i] != null) {</span>
                    // Slot is in use, try next
<span class="nc" id="L255">                    position++;</span>
                } else {
                    // Found a free slot
<span class="nc" id="L258">                    index = i;</span>
<span class="nc" id="L259">                    break;</span>
                }
            }

<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (index == -1) {</span>
                // Create a slot at the end
<span class="nc" id="L265">                VMInternalFrame[] newArray = new VMInternalFrame[n + 1];</span>
<span class="nc" id="L266">                System.arraycopy(windowMenuWindows, 0, newArray, 0, n);</span>
<span class="nc" id="L267">                windowMenuWindows = newArray;</span>
<span class="nc" id="L268">                index = n;</span>
            }

<span class="nc" id="L271">            windowMenuWindows[index] = vmIF;</span>

<span class="nc" id="L273">            String indexString = &quot;&quot; + (index+1);</span>
<span class="nc" id="L274">            String vmName = vmIF.getVMPanel().getDisplayName();</span>
            // Maybe truncate menu item string and end with &quot;...&quot;
<span class="nc" id="L276">            String text =</span>
<span class="nc" id="L277">                SwingUtilities.layoutCompoundLabel(this,</span>
<span class="nc" id="L278">                                        getGraphics().getFontMetrics(getFont()),</span>
                                        indexString +  &quot; &quot; + vmName,
                                        null, 0, 0, 0, 0,
                                        viewR, iconR, textR, 0);
<span class="nc" id="L282">            JMenuItem mi = new JMenuItem(text);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (text.endsWith(&quot;...&quot;)) {</span>
<span class="nc" id="L284">                mi.setToolTipText(vmName);</span>
            }

            // Set mnemonic using last digit of number
<span class="nc" id="L288">            int nDigits = indexString.length();</span>
<span class="nc" id="L289">            mi.setMnemonic(indexString.charAt(nDigits-1));</span>
<span class="nc" id="L290">            mi.setDisplayedMnemonicIndex(nDigits-1);</span>

<span class="nc" id="L292">            mi.putClientProperty(&quot;JConsole.vmIF&quot;, vmIF);</span>
<span class="nc" id="L293">            mi.addActionListener(JConsole.this);</span>
<span class="nc" id="L294">            vmIF.putClientProperty(&quot;JConsole.menuItem&quot;, mi);</span>
<span class="nc" id="L295">            add(mi, position);</span>
<span class="nc" id="L296">        }</span>

        private void remove(VMInternalFrame vmIF) {
<span class="nc bnc" id="L299" title="All 2 branches missed.">            for (int i = 0; i &lt; windowMenuWindows.length; i++) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                if (windowMenuWindows[i] == vmIF) {</span>
<span class="nc" id="L301">                    windowMenuWindows[i] = null;</span>
                }
            }
<span class="nc" id="L304">            JMenuItem mi = (JMenuItem)vmIF.getClientProperty(&quot;JConsole.menuItem&quot;);</span>
<span class="nc" id="L305">            remove(mi);</span>
<span class="nc" id="L306">            mi.putClientProperty(&quot;JConsole.vmIF&quot;, null);</span>
<span class="nc" id="L307">            vmIF.putClientProperty(&quot;JConsole.menuItem&quot;, null);</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (separatorPosition == getMenuComponentCount() - 1) {</span>
<span class="nc" id="L310">                remove(getMenuComponent(getMenuComponentCount() - 1));</span>
            }
<span class="nc" id="L312">        }</span>
    }

    public void actionPerformed(ActionEvent ev) {
<span class="nc" id="L316">        Object src = ev.getSource();</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if (src == hotspotMI) {</span>
<span class="nc" id="L318">            showCreateMBeanDialog();</span>
        }

<span class="nc bnc" id="L321" title="All 4 branches missed.">        if (src == connectButton || src == connectMI) {</span>
<span class="nc" id="L322">            VMPanel vmPanel = null;</span>
<span class="nc" id="L323">            JInternalFrame vmIF = desktop.getSelectedFrame();</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (vmIF instanceof VMInternalFrame) {</span>
<span class="nc" id="L325">                vmPanel = ((VMInternalFrame)vmIF).getVMPanel();</span>
            }
<span class="nc" id="L327">                String hostName = &quot;&quot;;</span>
<span class="nc" id="L328">                String url = &quot;&quot;;</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                if (vmPanel != null) {</span>
<span class="nc" id="L330">                    hostName = vmPanel.getHostName();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                    if(vmPanel.getUrl() != null)</span>
<span class="nc" id="L332">                        url = vmPanel.getUrl();</span>
                }
<span class="nc" id="L334">                showConnectDialog(url, hostName, 0, null, null, null);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        } else if (src == tileMI) {</span>
<span class="nc" id="L336">            tileWindows();</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">        } else if (src == cascadeMI) {</span>
<span class="nc" id="L338">            cascadeWindows();</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        } else if (src == minimizeAllMI) {</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">            for (VMInternalFrame vmIF : windows) {</span>
                try {
<span class="nc" id="L342">                    vmIF.setIcon(true);</span>
<span class="nc" id="L343">                } catch (PropertyVetoException ex) {</span>
                    // Ignore
<span class="nc" id="L345">                }</span>
<span class="nc" id="L346">            }</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">        } else if (src == restoreAllMI) {</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            for (VMInternalFrame vmIF : windows) {</span>
                try {
<span class="nc" id="L350">                    vmIF.setIcon(false);</span>
<span class="nc" id="L351">                } catch (PropertyVetoException ex) {</span>
                    // Ignore
<span class="nc" id="L353">                }</span>
<span class="nc" id="L354">            }</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        } else if (src == exitMI) {</span>
<span class="nc" id="L356">            System.exit(0);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">        } else if (src == userGuideMI) {</span>
<span class="nc" id="L358">            AboutDialog.browseUserGuide(this);</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">        } else if (src == aboutMI) {</span>
<span class="nc" id="L360">            AboutDialog.showAboutDialog(this);</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">        } else if (src instanceof JMenuItem) {</span>
<span class="nc" id="L362">            JMenuItem mi = (JMenuItem)src;</span>
<span class="nc" id="L363">            VMInternalFrame vmIF = (VMInternalFrame)mi.</span>
<span class="nc" id="L364">                getClientProperty(&quot;JConsole.vmIF&quot;);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (vmIF != null) {</span>
                try {
<span class="nc" id="L367">                    vmIF.setIcon(false);</span>
<span class="nc" id="L368">                    vmIF.setSelected(true);</span>
<span class="nc" id="L369">                } catch (PropertyVetoException ex) {</span>
                    // Ignore
<span class="nc" id="L371">                }</span>
<span class="nc" id="L372">                vmIF.moveToFront();</span>
            }
        }
<span class="nc" id="L375">    }</span>


    public void tileWindows() {
<span class="nc" id="L379">        int w = -1;</span>
<span class="nc" id="L380">        int h = -1;</span>
<span class="nc" id="L381">        int n = 0;</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">        for (VMInternalFrame vmIF : windows) {</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            if (!vmIF.isIcon()) {</span>
<span class="nc" id="L384">                n++;</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">                if (w == -1) {</span>
                    try {
<span class="nc" id="L387">                        vmIF.setMaximum(true);</span>
<span class="nc" id="L388">                        w = vmIF.getWidth();</span>
<span class="nc" id="L389">                        h = vmIF.getHeight();</span>
<span class="nc" id="L390">                    } catch (PropertyVetoException ex) {</span>
                        // Ignore
<span class="nc" id="L392">                    }</span>
                }
            }
<span class="nc" id="L395">        }</span>
<span class="nc bnc" id="L396" title="All 6 branches missed.">        if (n &gt; 0 &amp;&amp; w &gt; 0 &amp;&amp; h &gt; 0) {</span>
<span class="nc" id="L397">            int rows = (int)Math.ceil(Math.sqrt(n));</span>
<span class="nc" id="L398">            int cols = n / rows;</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">            if (rows * cols &lt; n) cols++;</span>
<span class="nc" id="L400">            int x = 0;</span>
<span class="nc" id="L401">            int y = 0;</span>
<span class="nc" id="L402">            w /= cols;</span>
<span class="nc" id="L403">            h /= rows;</span>
<span class="nc" id="L404">            int col = 0;</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">            for (VMInternalFrame vmIF : windows) {</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">                if (!vmIF.isIcon()) {</span>
                    try {
<span class="nc bnc" id="L408" title="All 2 branches missed.">                        vmIF.setMaximum(n==1);</span>
<span class="nc" id="L409">                    } catch (PropertyVetoException ex) {</span>
                        // Ignore
<span class="nc" id="L411">                    }</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">                    if (n &gt; 1) {</span>
<span class="nc" id="L413">                        vmIF.setBounds(x, y, w, h);</span>
                    }
<span class="nc bnc" id="L415" title="All 2 branches missed.">                    if (col &lt; cols-1) {</span>
<span class="nc" id="L416">                        col++;</span>
<span class="nc" id="L417">                        x += w;</span>
                    } else {
<span class="nc" id="L419">                        col = 0;</span>
<span class="nc" id="L420">                        x = 0;</span>
<span class="nc" id="L421">                        y += h;</span>
                    }
                }
<span class="nc" id="L424">            }</span>
        }
<span class="nc" id="L426">    }</span>

    public void cascadeWindows() {
<span class="nc" id="L429">        int n = 0;</span>
<span class="nc" id="L430">        int w = -1;</span>
<span class="nc" id="L431">        int h = -1;</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        for (VMInternalFrame vmIF : windows) {</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">            if (!vmIF.isIcon()) {</span>
                try {
<span class="nc" id="L435">                    vmIF.setMaximum(false);</span>
<span class="nc" id="L436">                } catch (PropertyVetoException ex) {</span>
                    // Ignore
<span class="nc" id="L438">                }</span>
<span class="nc" id="L439">                n++;</span>
<span class="nc" id="L440">                vmIF.pack();</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                if (w == -1) {</span>
                    try {
<span class="nc" id="L443">                        w = vmIF.getWidth();</span>
<span class="nc" id="L444">                        h = vmIF.getHeight();</span>
<span class="nc" id="L445">                        vmIF.setMaximum(true);</span>
<span class="nc" id="L446">                        w = vmIF.getWidth() - w;</span>
<span class="nc" id="L447">                        h = vmIF.getHeight() - h;</span>
<span class="nc" id="L448">                        vmIF.pack();</span>
<span class="nc" id="L449">                    } catch (PropertyVetoException ex) {</span>
                        // Ignore
<span class="nc" id="L451">                    }</span>
                }
            }
<span class="nc" id="L454">        }</span>
<span class="nc" id="L455">        int x = 0;</span>
<span class="nc" id="L456">        int y = 0;</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">        int dX = (n &gt; 1) ? (w / (n - 1)) : 0;</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">        int dY = (n &gt; 1) ? (h / (n - 1)) : 0;</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">        for (VMInternalFrame vmIF : windows) {</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">            if (!vmIF.isIcon()) {</span>
<span class="nc" id="L461">                vmIF.setLocation(x, y);</span>
<span class="nc" id="L462">                vmIF.moveToFront();</span>
<span class="nc" id="L463">                x += dX;</span>
<span class="nc" id="L464">                y += dY;</span>
            }
<span class="nc" id="L466">        }</span>
<span class="nc" id="L467">    }</span>

    // Call on EDT
    void addHost(String hostName, int port,
                 String userName, String password) {
<span class="nc" id="L472">        addHost(hostName, port, userName, password, false);</span>
<span class="nc" id="L473">    }</span>

    // Call on EDT
    void addVmid(LocalVirtualMachine lvm) {
<span class="nc" id="L477">        addVmid(lvm, false);</span>
<span class="nc" id="L478">    }</span>

    // Call on EDT
    void addVmid(final LocalVirtualMachine lvm, final boolean tile) {
<span class="nc" id="L482">        new Thread(&quot;JConsole.addVmid&quot;) {</span>
            public void run() {
                try {
<span class="nc" id="L485">                    addProxyClient(ProxyClient.getProxyClient(lvm), tile);</span>
<span class="nc" id="L486">                } catch (final SecurityException ex) {</span>
<span class="nc" id="L487">                    failed(ex, null, null, null);</span>
<span class="nc" id="L488">                } catch (final IOException ex) {</span>
<span class="nc" id="L489">                    failed(ex, null, null, null);</span>
<span class="nc" id="L490">                }</span>
<span class="nc" id="L491">            }</span>
<span class="nc" id="L492">        }.start();</span>
<span class="nc" id="L493">    }</span>

    // Call on EDT
    void addUrl(final String url,
                final String userName,
                final String password,
                final boolean tile) {
<span class="nc" id="L500">        new Thread(&quot;JConsole.addUrl&quot;) {</span>
            public void run() {
                try {
<span class="nc" id="L503">                    addProxyClient(ProxyClient.getProxyClient(url, userName, password),</span>
                                   tile);
<span class="nc" id="L505">                } catch (final MalformedURLException ex) {</span>
<span class="nc" id="L506">                    failed(ex, url, userName, password);</span>
<span class="nc" id="L507">                } catch (final SecurityException ex) {</span>
<span class="nc" id="L508">                    failed(ex, url, userName, password);</span>
<span class="nc" id="L509">                } catch (final IOException ex) {</span>
<span class="nc" id="L510">                    failed(ex, url, userName, password);</span>
<span class="nc" id="L511">                }</span>
<span class="nc" id="L512">            }</span>
<span class="nc" id="L513">        }.start();</span>
<span class="nc" id="L514">    }</span>


    // Call on EDT
    void addHost(final String hostName, final int port,
                 final String userName, final String password,
                 final boolean tile) {
<span class="nc" id="L521">        new Thread(&quot;JConsole.addHost&quot;) {</span>
            public void run() {
                try {
<span class="nc" id="L524">                    addProxyClient(ProxyClient.getProxyClient(hostName, port,</span>
                                                              userName, password),
                                   tile);
<span class="nc" id="L527">                } catch (final IOException ex) {</span>
<span class="nc" id="L528">                    dbgStackTrace(ex);</span>
<span class="nc" id="L529">                    SwingUtilities.invokeLater(new Runnable() {</span>
                        public void run() {
<span class="nc" id="L531">                            showConnectDialog(null, hostName, port,</span>
<span class="nc" id="L532">                                              userName, password, errorMessage(ex));</span>
<span class="nc" id="L533">                        }</span>
                    });
<span class="nc" id="L535">                }</span>
<span class="nc" id="L536">            }</span>
<span class="nc" id="L537">        }.start();</span>
<span class="nc" id="L538">    }</span>


    // Call on worker thread
    void addProxyClient(final ProxyClient proxyClient, final boolean tile) {
<span class="nc" id="L543">        SwingUtilities.invokeLater(new Runnable() {</span>
            public void run() {
<span class="nc" id="L545">                VMPanel vmPanel = new VMPanel(proxyClient, updateInterval);</span>
<span class="nc" id="L546">                addFrame(vmPanel);</span>

<span class="nc bnc" id="L548" title="All 2 branches missed.">                if (tile) {</span>
<span class="nc" id="L549">                    SwingUtilities.invokeLater(new Runnable() {</span>
                        public void run() {
<span class="nc" id="L551">                            tileWindows();</span>
<span class="nc" id="L552">                        }</span>
                    });
                }
<span class="nc" id="L555">                vmPanel.connect();</span>
<span class="nc" id="L556">            }</span>
        });
<span class="nc" id="L558">    }</span>


    // Call on worker thread
    private void failed(final Exception ex,
                        final String url,
                        final String userName,
                        final String password) {
<span class="nc" id="L566">        SwingUtilities.invokeLater(new Runnable() {</span>
            public void run() {
<span class="nc" id="L568">                dbgStackTrace(ex);</span>
<span class="nc" id="L569">                showConnectDialog(url,</span>
                                  null,
                                  -1,
                                  userName,
                                  password,
<span class="nc" id="L574">                                  errorMessage(ex));</span>
<span class="nc" id="L575">            }</span>
        });
<span class="nc" id="L577">    }</span>


    private VMInternalFrame addFrame(VMPanel vmPanel) {
<span class="nc" id="L581">        final VMInternalFrame vmIF = new VMInternalFrame(vmPanel);</span>

<span class="nc bnc" id="L583" title="All 2 branches missed.">        for (VMInternalFrame f : windows) {</span>
            try {
<span class="nc" id="L585">                f.setMaximum(false);</span>
<span class="nc" id="L586">            } catch (PropertyVetoException ex) {</span>
                // Ignore
<span class="nc" id="L588">            }</span>
<span class="nc" id="L589">        }</span>
<span class="nc" id="L590">        desktop.add(vmIF);</span>

<span class="nc" id="L592">        vmIF.setLocation(frameLoc, frameLoc);</span>
<span class="nc" id="L593">        frameLoc += 30;</span>
<span class="nc" id="L594">        vmIF.setVisible(true);</span>
<span class="nc" id="L595">        windows.add(vmIF);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">        if (windows.size() == 1) {</span>
            try {
<span class="nc" id="L598">                vmIF.setMaximum(true);</span>
<span class="nc" id="L599">            } catch (PropertyVetoException ex) {</span>
                // Ignore
<span class="nc" id="L601">            }</span>
        }
<span class="nc" id="L603">        vmIF.addInternalFrameListener(this);</span>
<span class="nc" id="L604">        windowMenu.add(vmIF);</span>

<span class="nc" id="L606">        return vmIF;</span>
    }

    private void showConnectDialog(String url,
                                   String hostName,
                                   int port,
                                   String userName,
                                   String password,
                                   String msg) {
<span class="nc bnc" id="L615" title="All 2 branches missed.">        if (connectDialog == null) {</span>
<span class="nc" id="L616">            connectDialog = new ConnectDialog(this);</span>
        }
<span class="nc" id="L618">        connectDialog.setConnectionParameters(url,</span>
                                              hostName,
                                              port,
                                              userName,
                                              password,
                                              msg);

<span class="nc" id="L625">        connectDialog.refresh();</span>
<span class="nc" id="L626">        connectDialog.setVisible(true);</span>
        try {
            // Bring to front of other dialogs
<span class="nc" id="L629">            connectDialog.setSelected(true);</span>
<span class="nc" id="L630">        } catch (PropertyVetoException e) {</span>
<span class="nc" id="L631">        }</span>
<span class="nc" id="L632">    }</span>

    private void showCreateMBeanDialog() {
<span class="nc bnc" id="L635" title="All 2 branches missed.">        if (createDialog == null) {</span>
<span class="nc" id="L636">            createDialog = new CreateMBeanDialog(this);</span>
        }
<span class="nc" id="L638">        createDialog.setVisible(true);</span>
        try {
            // Bring to front of other dialogs
<span class="nc" id="L641">            createDialog.setSelected(true);</span>
<span class="nc" id="L642">        } catch (PropertyVetoException e) {</span>
<span class="nc" id="L643">        }</span>
<span class="nc" id="L644">    }</span>

    private void removeVMInternalFrame(VMInternalFrame vmIF) {
<span class="nc" id="L647">        windowMenu.remove(vmIF);</span>
<span class="nc" id="L648">        desktop.remove(vmIF);</span>
<span class="nc" id="L649">        desktop.repaint();</span>
<span class="nc" id="L650">        vmIF.getVMPanel().cleanUp();</span>
<span class="nc" id="L651">        vmIF.dispose();</span>
<span class="nc" id="L652">    }</span>

    private boolean isProxyClientUsed(ProxyClient client) {
<span class="nc bnc" id="L655" title="All 2 branches missed.">        for(VMInternalFrame frame : windows) {</span>
<span class="nc" id="L656">            ProxyClient cli = frame.getVMPanel().getProxyClient(false);</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">            if(client == cli)</span>
<span class="nc" id="L658">                return true;</span>
<span class="nc" id="L659">        }</span>
<span class="nc" id="L660">        return false;</span>
    }

    static boolean isValidRemoteString(String txt) {
<span class="nc" id="L664">        boolean valid = false;</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">        if (txt != null) {</span>
<span class="nc" id="L666">            txt = txt.trim();</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">            if (txt.startsWith(ROOT_URL)) {</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">                if (txt.length() &gt; ROOT_URL.length()) {</span>
<span class="nc" id="L669">                    valid = true;</span>
                }
            } else {
                //---------------------------------------
                // Supported host and port combinations:
                //     hostname:port
                //     IPv4Address:port
                //     [IPv6Address]:port
                //---------------------------------------

                // Is literal IPv6 address?
                //
<span class="nc bnc" id="L681" title="All 2 branches missed.">                if (txt.startsWith(&quot;[&quot;)) {</span>
<span class="nc" id="L682">                    int index = txt.indexOf(&quot;]:&quot;);</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">                    if (index != -1) {</span>
                        // Extract literal IPv6 address
                        //
<span class="nc" id="L686">                        String address = txt.substring(1, index);</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">                        if (IPAddressUtil.isIPv6LiteralAddress(address)) {</span>
                            // Extract port
                            //
                            try {
<span class="nc" id="L691">                                String portStr = txt.substring(index + 2);</span>
<span class="nc" id="L692">                                int port = Integer.parseInt(portStr);</span>
<span class="nc bnc" id="L693" title="All 4 branches missed.">                                if (port &gt;= 0 &amp;&amp; port &lt;= 0xFFFF) {</span>
<span class="nc" id="L694">                                    valid = true;</span>
                                }
<span class="nc" id="L696">                            } catch (NumberFormatException ex) {</span>
<span class="nc" id="L697">                                valid = false;</span>
<span class="nc" id="L698">                            }</span>
                        }
                    }
<span class="nc" id="L701">                } else {</span>
<span class="nc" id="L702">                    String[] s = txt.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">                    if (s.length == 2) {</span>
                        try {
<span class="nc" id="L705">                            int port = Integer.parseInt(s[1]);</span>
<span class="nc bnc" id="L706" title="All 4 branches missed.">                            if (port &gt;= 0 &amp;&amp; port &lt;= 0xFFFF) {</span>
<span class="nc" id="L707">                                valid = true;</span>
                            }
<span class="nc" id="L709">                        } catch (NumberFormatException ex) {</span>
<span class="nc" id="L710">                            valid = false;</span>
<span class="nc" id="L711">                        }</span>
                    }
                }
            }
        }
<span class="nc" id="L716">        return valid;</span>
    }

    private String errorMessage(Exception ex) {
<span class="nc" id="L720">       String msg = Messages.CONNECTION_FAILED;</span>
<span class="nc bnc" id="L721" title="All 4 branches missed.">       if (ex instanceof IOException || ex instanceof SecurityException) {</span>
<span class="nc" id="L722">           Throwable cause = null;</span>
<span class="nc" id="L723">           Throwable c = ex.getCause();</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">           while (c != null) {</span>
<span class="nc" id="L725">               cause = c;</span>
<span class="nc" id="L726">               c = c.getCause();</span>
           }
<span class="nc bnc" id="L728" title="All 2 branches missed.">           if (cause instanceof ConnectException) {</span>
<span class="nc" id="L729">               return msg + &quot;: &quot; + cause.getMessage();</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">           } else if (cause instanceof UnknownHostException) {</span>
<span class="nc" id="L731">               return Resources.format(Messages.UNKNOWN_HOST, cause.getMessage());</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">           } else if (cause instanceof NoRouteToHostException) {</span>
<span class="nc" id="L733">               return msg + &quot;: &quot; + cause.getMessage();</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">           } else if (cause instanceof FailedLoginException) {</span>
<span class="nc" id="L735">               return msg + &quot;: &quot; + cause.getMessage();</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">           } else if (cause instanceof SSLHandshakeException) {</span>
<span class="nc" id="L737">               return msg + &quot;: &quot;+ cause.getMessage();</span>
           }
<span class="nc bnc" id="L739" title="All 2 branches missed.">        } else if (ex instanceof MalformedURLException) {</span>
<span class="nc" id="L740">           return Resources.format(Messages.INVALID_URL, ex.getMessage());</span>
        }
<span class="nc" id="L742">        return msg + &quot;: &quot; + ex.getMessage();</span>
    }


    // InternalFrameListener interface

    public void internalFrameClosing(InternalFrameEvent e) {
<span class="nc" id="L749">        VMInternalFrame vmIF = (VMInternalFrame)e.getInternalFrame();</span>
<span class="nc" id="L750">        removeVMInternalFrame(vmIF);</span>
<span class="nc" id="L751">        windows.remove(vmIF);</span>
<span class="nc" id="L752">        ProxyClient client = vmIF.getVMPanel().getProxyClient(false);</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">        if(!isProxyClientUsed(client))</span>
<span class="nc" id="L754">            client.markAsDead();</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">        if (windows.size() == 0) {</span>
<span class="nc" id="L756">            showConnectDialog(&quot;&quot;, &quot;&quot;, 0, null, null, null);</span>
        }
<span class="nc" id="L758">    }</span>

<span class="nc" id="L760">    public void internalFrameOpened(InternalFrameEvent e) {}</span>
<span class="nc" id="L761">    public void internalFrameClosed(InternalFrameEvent e) {}</span>
<span class="nc" id="L762">    public void internalFrameIconified(InternalFrameEvent e) {}</span>
<span class="nc" id="L763">    public void internalFrameDeiconified(InternalFrameEvent e) {}</span>
<span class="nc" id="L764">    public void internalFrameActivated(InternalFrameEvent e) {}</span>
<span class="nc" id="L765">    public void internalFrameDeactivated(InternalFrameEvent e) {}</span>


    private static void usage() {
<span class="nc" id="L769">        System.err.println(Resources.format(Messages.ZZ_USAGE_TEXT, &quot;jconsole&quot;));</span>
<span class="nc" id="L770">    }</span>

    private static void mainInit(final List&lt;String&gt; urls,
                                 final List&lt;String&gt; hostNames,
                                 final List&lt;Integer&gt; ports,
                                 final List&lt;LocalVirtualMachine&gt; vmids,
                                 final ProxyClient proxyClient,
                                 final boolean noTile,
                                 final boolean hotspot) {


        // Always create Swing GUI on the Event Dispatching Thread
<span class="nc" id="L782">        SwingUtilities.invokeLater(new Runnable() {</span>
                public void run() {
<span class="nc" id="L784">                    JConsole jConsole = new JConsole(hotspot);</span>

                    // Center the window on screen, taking into account screen
                    // size and insets.
<span class="nc" id="L788">                    Toolkit toolkit = Toolkit.getDefaultToolkit();</span>
<span class="nc" id="L789">                    GraphicsConfiguration gc = jConsole.getGraphicsConfiguration();</span>
<span class="nc" id="L790">                    Dimension scrSize = toolkit.getScreenSize();</span>
<span class="nc" id="L791">                    Insets scrInsets  = toolkit.getScreenInsets(gc);</span>
<span class="nc" id="L792">                    Rectangle scrBounds =</span>
                        new Rectangle(scrInsets.left, scrInsets.top,
                                      scrSize.width  - scrInsets.left - scrInsets.right,
                                      scrSize.height - scrInsets.top  - scrInsets.bottom);
<span class="nc" id="L796">                    int w = Math.min(900, scrBounds.width);</span>
<span class="nc" id="L797">                    int h = Math.min(750, scrBounds.height);</span>
<span class="nc" id="L798">                    jConsole.setBounds(scrBounds.x + (scrBounds.width  - w) / 2,</span>
                                       scrBounds.y + (scrBounds.height - h) / 2,
                                       w, h);

<span class="nc" id="L802">                    jConsole.setVisible(true);</span>
<span class="nc" id="L803">                    jConsole.createMDI();</span>

<span class="nc bnc" id="L805" title="All 2 branches missed.">                    for (int i = 0; i &lt; hostNames.size(); i++) {</span>
<span class="nc" id="L806">                        jConsole.addHost(hostNames.get(i), ports.get(i),</span>
                                         null, null,
<span class="nc bnc" id="L808" title="All 4 branches missed.">                                         (i == hostNames.size() - 1) ?</span>
                                         !noTile : false);
                    }

<span class="nc bnc" id="L812" title="All 2 branches missed.">                    for (int i = 0; i &lt; urls.size(); i++) {</span>
<span class="nc" id="L813">                        jConsole.addUrl(urls.get(i),</span>
                                        null,
                                        null,
<span class="nc bnc" id="L816" title="All 4 branches missed.">                                        (i == urls.size() - 1) ?</span>
                                        !noTile : false);
                    }

<span class="nc bnc" id="L820" title="All 2 branches missed.">                    for (int i = 0; i &lt; vmids.size(); i++) {</span>
<span class="nc" id="L821">                        jConsole.addVmid(vmids.get(i),</span>
<span class="nc bnc" id="L822" title="All 4 branches missed.">                                        (i == vmids.size() - 1) ?</span>
                                        !noTile : false);
                    }

<span class="nc bnc" id="L826" title="All 2 branches missed.">                    if (vmids.size() == 0 &amp;&amp;</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">                        hostNames.size() == 0 &amp;&amp;</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">                        urls.size() == 0) {</span>
<span class="nc" id="L829">                        jConsole.showConnectDialog(null,</span>
                                                   null,
                                                   0,
                                                   null,
                                                   null,
                                                   null);
                    }
<span class="nc" id="L836">                }</span>
            });
<span class="nc" id="L838">    }</span>

    public static void main(String[] args) {
<span class="nc" id="L841">        boolean noTile = false, hotspot = false;</span>
<span class="nc" id="L842">        int argIndex = 0;</span>
<span class="nc" id="L843">        ProxyClient proxyClient = null;</span>

<span class="nc bnc" id="L845" title="All 2 branches missed.">        if (System.getProperty(&quot;jconsole.showOutputViewer&quot;) != null) {</span>
<span class="nc" id="L846">            OutputViewer.init();</span>
        }

<span class="nc bnc" id="L849" title="All 4 branches missed.">        while (args.length - argIndex &gt; 0 &amp;&amp; args[argIndex].startsWith(&quot;-&quot;)) {</span>
<span class="nc" id="L850">            String arg = args[argIndex++];</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">            if (arg.equals(&quot;-h&quot;) ||</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">                arg.equals(&quot;-help&quot;) ||</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">                arg.equals(&quot;-?&quot;)) {</span>

<span class="nc" id="L855">                usage();</span>
<span class="nc" id="L856">                return;</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">            } else if (arg.startsWith(&quot;-interval=&quot;)) {</span>
                try {
<span class="nc" id="L859">                    updateInterval = Integer.parseInt(arg.substring(10)) *</span>
                        1000;
<span class="nc bnc" id="L861" title="All 2 branches missed.">                    if (updateInterval &lt;= 0) {</span>
<span class="nc" id="L862">                        usage();</span>
<span class="nc" id="L863">                        return;</span>
                    }
<span class="nc" id="L865">                } catch (NumberFormatException ex) {</span>
<span class="nc" id="L866">                    usage();</span>
<span class="nc" id="L867">                    return;</span>
<span class="nc" id="L868">                }</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">            } else if (arg.equals(&quot;-pluginpath&quot;)) {</span>
<span class="nc bnc" id="L870" title="All 4 branches missed.">                if (argIndex &lt; args.length &amp;&amp; !args[argIndex].startsWith(&quot;-&quot;)) {</span>
<span class="nc" id="L871">                    pluginPath = args[argIndex++];</span>
                } else {
                    // Invalid argument
<span class="nc" id="L874">                    usage();</span>
<span class="nc" id="L875">                    return;</span>
                }
<span class="nc bnc" id="L877" title="All 2 branches missed.">            } else if (arg.equals(&quot;-notile&quot;)) {</span>
<span class="nc" id="L878">                noTile = true;</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">            } else if (arg.equals(&quot;-version&quot;)) {</span>
<span class="nc" id="L880">                Version.print(System.err);</span>
<span class="nc" id="L881">                return;</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">            } else if (arg.equals(&quot;-debug&quot;)) {</span>
<span class="nc" id="L883">                debug = true;</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">            } else if (arg.equals(&quot;-fullversion&quot;)) {</span>
<span class="nc" id="L885">                Version.printFullVersion(System.err);</span>
<span class="nc" id="L886">                return;</span>
            } else {
                // Unknown switch
<span class="nc" id="L889">                usage();</span>
<span class="nc" id="L890">                return;</span>
            }
<span class="nc" id="L892">        }</span>

<span class="nc bnc" id="L894" title="All 2 branches missed.">        if (System.getProperty(&quot;jconsole.showUnsupported&quot;) != null) {</span>
<span class="nc" id="L895">            hotspot = true;</span>
        }

<span class="nc" id="L898">        List&lt;String&gt; urls = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L899">        List&lt;String&gt; hostNames = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L900">        List&lt;Integer&gt; ports = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L901">        List&lt;LocalVirtualMachine&gt; vms = new ArrayList&lt;LocalVirtualMachine&gt;();</span>

<span class="nc bnc" id="L903" title="All 2 branches missed.">        for (int i = argIndex; i &lt; args.length; i++) {</span>
<span class="nc" id="L904">            String arg = args[i];</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">            if (isValidRemoteString(arg)) {</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">                if (arg.startsWith(ROOT_URL)) {</span>
<span class="nc" id="L907">                    urls.add(arg);</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">                } else if (arg.matches(&quot;.*:[0-9]*&quot;)) {</span>
<span class="nc" id="L909">                    int p = arg.lastIndexOf(':');</span>
<span class="nc" id="L910">                    hostNames.add(arg.substring(0, p));</span>
                    try {
<span class="nc" id="L912">                        ports.add(Integer.parseInt(arg.substring(p+1)));</span>
<span class="nc" id="L913">                    } catch (NumberFormatException ex) {</span>
<span class="nc" id="L914">                        usage();</span>
<span class="nc" id="L915">                        return;</span>
<span class="nc" id="L916">                    }</span>
<span class="nc" id="L917">                }</span>
            } else {
<span class="nc bnc" id="L919" title="All 2 branches missed.">                if (!isLocalAttachAvailable()) {</span>
<span class="nc" id="L920">                    System.err.println(&quot;Local process monitoring is not supported&quot;);</span>
<span class="nc" id="L921">                    return;</span>
                }
                try {
<span class="nc" id="L924">                    int vmid = Integer.parseInt(arg);</span>
<span class="nc" id="L925">                    LocalVirtualMachine lvm =</span>
<span class="nc" id="L926">                        LocalVirtualMachine.getLocalVirtualMachine(vmid);</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">                    if (lvm == null) {</span>
<span class="nc" id="L928">                        System.err.println(&quot;Invalid process id:&quot; + vmid);</span>
<span class="nc" id="L929">                        return;</span>
                    }
<span class="nc" id="L931">                    vms.add(lvm);</span>
<span class="nc" id="L932">                } catch (NumberFormatException ex) {</span>
<span class="nc" id="L933">                    usage();</span>
<span class="nc" id="L934">                    return;</span>
<span class="nc" id="L935">                }</span>
            }
        }

<span class="nc" id="L939">        mainInit(urls, hostNames, ports, vms, proxyClient, noTile, hotspot);</span>
<span class="nc" id="L940">    }</span>

    public static boolean isDebug() {
<span class="nc" id="L943">        return debug;</span>
    }

    private static void dbgStackTrace(Exception ex) {
<span class="nc bnc" id="L947" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L948">            ex.printStackTrace();</span>
        }
<span class="nc" id="L950">    }</span>

    private static final boolean localAttachmentSupported;
    static {
        boolean supported;
        try {
<span class="nc" id="L956">            Class.forName(&quot;com.sun.tools.attach.VirtualMachine&quot;);</span>
<span class="nc" id="L957">            Class.forName(&quot;sun.management.ConnectorAddressLink&quot;);</span>
<span class="nc" id="L958">            supported = true;</span>
<span class="nc" id="L959">        } catch (NoClassDefFoundError x) {</span>
<span class="nc" id="L960">            supported = false;</span>
<span class="nc" id="L961">        } catch (ClassNotFoundException x) {</span>
<span class="nc" id="L962">            supported = false;</span>
<span class="nc" id="L963">        }</span>
<span class="nc" id="L964">        localAttachmentSupported = supported;</span>
    }

    public static boolean isLocalAttachAvailable() {
<span class="nc" id="L968">        return localAttachmentSupported;</span>
    }


<span class="nc" id="L972">    private static ServiceLoader&lt;JConsolePlugin&gt; pluginService = null;</span>

    // Return a list of newly instantiated JConsolePlugin objects
    static synchronized List&lt;JConsolePlugin&gt; getPlugins() {
<span class="nc bnc" id="L976" title="All 2 branches missed.">        if (pluginService == null) {</span>
            // First time loading and initializing the plugins
<span class="nc" id="L978">            initPluginService(pluginPath);</span>
        } else {
            // reload the plugin so that new instances will be created
<span class="nc" id="L981">            pluginService.reload();</span>
        }

<span class="nc" id="L984">        List&lt;JConsolePlugin&gt; plugins = new ArrayList&lt;JConsolePlugin&gt;();</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">        for (JConsolePlugin p : pluginService) {</span>
<span class="nc" id="L986">            plugins.add(p);</span>
<span class="nc" id="L987">        }</span>
<span class="nc" id="L988">        return plugins;</span>
    }

    private static void initPluginService(String pluginPath) {
<span class="nc bnc" id="L992" title="All 2 branches missed.">        if (pluginPath.length() &gt; 0) {</span>
            try {
<span class="nc" id="L994">                ClassLoader pluginCL = new URLClassLoader(pathToURLs(pluginPath));</span>
<span class="nc" id="L995">                ServiceLoader&lt;JConsolePlugin&gt; plugins =</span>
<span class="nc" id="L996">                    ServiceLoader.load(JConsolePlugin.class, pluginCL);</span>
                // validate all plugins
<span class="nc bnc" id="L998" title="All 2 branches missed.">            for (JConsolePlugin p : plugins) {</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">                    if (isDebug()) {</span>
<span class="nc" id="L1000">                        System.out.println(&quot;Plugin &quot; + p.getClass() + &quot; loaded.&quot;);</span>
                    }
<span class="nc" id="L1002">                }</span>
<span class="nc" id="L1003">                pluginService = plugins;</span>
<span class="nc" id="L1004">            } catch (ServiceConfigurationError e) {</span>
                // Error occurs during initialization of plugin
<span class="nc" id="L1006">                System.out.println(Resources.format(Messages.FAIL_TO_LOAD_PLUGIN,</span>
<span class="nc" id="L1007">                                   e.getMessage()));</span>
<span class="nc" id="L1008">            } catch (MalformedURLException e) {</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">                if (JConsole.isDebug()) {</span>
<span class="nc" id="L1010">                    e.printStackTrace();</span>
                }
<span class="nc" id="L1012">                System.out.println(Resources.format(Messages.INVALID_PLUGIN_PATH,</span>
<span class="nc" id="L1013">                                   e.getMessage()));</span>
<span class="nc" id="L1014">            }</span>
        }

<span class="nc bnc" id="L1017" title="All 2 branches missed.">        if (pluginService == null) {</span>
<span class="nc" id="L1018">            initEmptyPlugin();</span>
        }
<span class="nc" id="L1020">    }</span>

    private static void initEmptyPlugin() {
<span class="nc" id="L1023">        ClassLoader pluginCL = new URLClassLoader(new URL[0]);</span>
<span class="nc" id="L1024">        pluginService = ServiceLoader.load(JConsolePlugin.class, pluginCL);</span>
<span class="nc" id="L1025">    }</span>

   /**
     * Utility method for converting a search path string to an array
     * of directory and JAR file URLs.
     *
     * @param path the search path string
     * @return the resulting array of directory and JAR file URLs
     */
    private static URL[] pathToURLs(String path) throws MalformedURLException {
<span class="nc" id="L1035">        String[] names = path.split(File.pathSeparator);</span>
<span class="nc" id="L1036">        URL[] urls = new URL[names.length];</span>
<span class="nc" id="L1037">        int count = 0;</span>
<span class="nc bnc" id="L1038" title="All 2 branches missed.">        for (String f : names) {</span>
<span class="nc" id="L1039">            URL url = fileToURL(new File(f));</span>
<span class="nc" id="L1040">            urls[count++] = url;</span>
        }
<span class="nc" id="L1042">        return urls;</span>
    }

    /**
     * Returns the directory or JAR file URL corresponding to the specified
     * local file name.
     *
     * @param file the File object
     * @return the resulting directory or JAR file URL, or null if unknown
     */
    private static URL fileToURL(File file) throws MalformedURLException {
        String name;
        try {
<span class="nc" id="L1055">            name = file.getCanonicalPath();</span>
<span class="nc" id="L1056">        } catch (IOException e) {</span>
<span class="nc" id="L1057">            name = file.getAbsolutePath();</span>
<span class="nc" id="L1058">        }</span>
<span class="nc" id="L1059">        name = name.replace(File.separatorChar, '/');</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">        if (!name.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L1061">            name = &quot;/&quot; + name;</span>
        }
        // If the file does not exist, then assume that it's a directory
<span class="nc bnc" id="L1064" title="All 2 branches missed.">        if (!file.isFile()) {</span>
<span class="nc" id="L1065">            name = name + &quot;/&quot;;</span>
        }
<span class="nc" id="L1067">        return new URL(&quot;file&quot;, &quot;&quot;, name);</span>
    }


<span class="nc" id="L1071">    private static class FixedJRootPane extends JRootPane {</span>
        public void updateUI() {
<span class="nc" id="L1073">            updateLafValues();</span>
<span class="nc" id="L1074">            super.updateUI();</span>
<span class="nc" id="L1075">        }</span>

        /**
         * The revalidate method seems to be the only one that gets
         * called whenever there is a change of L&amp;F or change of theme
         * in Windows L&amp;F and GTK L&amp;F.
         */
        @Override
        public void revalidate() {
            // Workaround for Swing bug where the titledborder in both
            // GTK and Windows L&amp;F's use calculated colors instead of
            // the highlight/shadow colors from the theme.
            //
            // Putting null removes any previous override and causes a
            // fallback to the current L&amp;F's value.
<span class="nc" id="L1090">            UIManager.put(&quot;TitledBorder.border&quot;, null);</span>
<span class="nc" id="L1091">            Border border = UIManager.getBorder(&quot;TitledBorder.border&quot;);</span>
<span class="nc bnc" id="L1092" title="All 2 branches missed.">            if (border instanceof BorderUIResource.EtchedBorderUIResource) {</span>
<span class="nc" id="L1093">                Color highlight = UIManager.getColor(&quot;ToolBar.highlight&quot;);</span>
<span class="nc" id="L1094">                Color shadow    = UIManager.getColor(&quot;ToolBar.shadow&quot;);</span>
<span class="nc" id="L1095">                border = new BorderUIResource.EtchedBorderUIResource(highlight,</span>
                                                                     shadow);
<span class="nc" id="L1097">                UIManager.put(&quot;TitledBorder.border&quot;, border);</span>
            }

<span class="nc bnc" id="L1100" title="All 2 branches missed.">            if (IS_GTK) {</span>
                // Workaround for Swing bug where the titledborder in
                // GTK L&amp;F use hardcoded color and font for the title
                // instead of getting them from the theme.
<span class="nc" id="L1104">                UIManager.put(&quot;TitledBorder.titleColor&quot;,</span>
<span class="nc" id="L1105">                              UIManager.getColor(&quot;Label.foreground&quot;));</span>
<span class="nc" id="L1106">                UIManager.put(&quot;TitledBorder.font&quot;,</span>
<span class="nc" id="L1107">                              UIManager.getFont(&quot;Label.font&quot;));</span>
            }
<span class="nc" id="L1109">            super.revalidate();</span>
<span class="nc" id="L1110">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>