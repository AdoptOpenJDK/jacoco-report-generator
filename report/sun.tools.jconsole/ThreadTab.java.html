<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ThreadTab.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.tools.jconsole</a> &gt; <span class="el_source">ThreadTab.java</span></div><h1>ThreadTab.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jconsole;

import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.lang.management.*;
import java.lang.reflect.*;

import javax.swing.*;
import javax.swing.border.*;
import javax.swing.event.*;


import java.util.*;
import java.util.concurrent.*;
import java.util.List;

import static sun.tools.jconsole.Utilities.*;


@SuppressWarnings(&quot;serial&quot;)
class ThreadTab extends Tab implements ActionListener, DocumentListener, ListSelectionListener {
    PlotterPanel threadMeter;
    TimeComboBox timeComboBox;
    JTabbedPane threadListTabbedPane;
    DefaultListModel&lt;Long&gt; listModel;
    JTextField filterTF;
    JLabel messageLabel;
    JSplitPane threadsSplitPane;
<span class="nc" id="L55">    HashMap&lt;Long, String&gt; nameCache = new HashMap&lt;Long, String&gt;();</span>

    private ThreadOverviewPanel overviewPanel;
<span class="nc" id="L58">    private boolean plotterListening = false;</span>


    private static final String threadCountKey   = &quot;threadCount&quot;;
    private static final String peakKey          = &quot;peak&quot;;

<span class="nc" id="L64">    private static final Color  threadCountColor = Plotter.defaultColor;</span>
<span class="nc" id="L65">    private static final Color  peakColor        = Color.red;</span>

<span class="nc" id="L67">    private static final Border thinEmptyBorder  = new EmptyBorder(2, 2, 2, 2);</span>

    private static final String infoLabelFormat = &quot;ThreadTab.infoLabelFormat&quot;;


    /*
      Hierarchy of panels and layouts for this tab:

        ThreadTab (BorderLayout)

            North:  topPanel (BorderLayout)

                        Center: controlPanel (FlowLayout)
                                    timeComboBox

            Center: plotterPanel (BorderLayout)

                        Center: plotter

    */


    public static String getTabName() {
<span class="nc" id="L90">        return Messages.THREADS;</span>
    }

    public ThreadTab(VMPanel vmPanel) {
<span class="nc" id="L94">        super(vmPanel, getTabName());</span>

<span class="nc" id="L96">        setLayout(new BorderLayout(0, 0));</span>
<span class="nc" id="L97">        setBorder(new EmptyBorder(4, 4, 3, 4));</span>

<span class="nc" id="L99">        JPanel topPanel     = new JPanel(new BorderLayout());</span>
<span class="nc" id="L100">        JPanel plotterPanel = new JPanel(new VariableGridLayout(0, 1, 4, 4, true, true));</span>

<span class="nc" id="L102">        add(topPanel, BorderLayout.NORTH);</span>
<span class="nc" id="L103">        add(plotterPanel,  BorderLayout.CENTER);</span>

<span class="nc" id="L105">        JPanel controlPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 20, 5));</span>
<span class="nc" id="L106">        topPanel.add(controlPanel, BorderLayout.CENTER);</span>

<span class="nc" id="L108">        threadMeter = new PlotterPanel(Messages.NUMBER_OF_THREADS,</span>
                                       Plotter.Unit.NONE, true);
<span class="nc" id="L110">        threadMeter.plotter.createSequence(threadCountKey, Messages.LIVE_THREADS,  threadCountColor, true);</span>
<span class="nc" id="L111">        threadMeter.plotter.createSequence(peakKey,        Messages.PEAK,         peakColor,        true);</span>
<span class="nc" id="L112">        setAccessibleName(threadMeter.plotter,</span>
                          Messages.THREAD_TAB_THREAD_PLOTTER_ACCESSIBLE_NAME);

<span class="nc" id="L115">        plotterPanel.add(threadMeter);</span>

<span class="nc" id="L117">        timeComboBox = new TimeComboBox(threadMeter.plotter);</span>
<span class="nc" id="L118">        controlPanel.add(new LabeledComponent(Messages.TIME_RANGE_COLON,</span>
<span class="nc" id="L119">                                              Resources.getMnemonicInt(Messages.TIME_RANGE_COLON),</span>
                                              timeComboBox));

<span class="nc" id="L122">        listModel = new DefaultListModel&lt;Long&gt;();</span>

<span class="nc" id="L124">        JTextArea textArea = new JTextArea();</span>
<span class="nc" id="L125">        textArea.setBorder(thinEmptyBorder);</span>
<span class="nc" id="L126">        textArea.setEditable(false);</span>
<span class="nc" id="L127">        setAccessibleName(textArea,</span>
                          Messages.THREAD_TAB_THREAD_INFO_ACCESSIBLE_NAME);
<span class="nc" id="L129">        ThreadJList list = new ThreadJList(listModel, textArea);</span>

<span class="nc" id="L131">        Dimension di = new Dimension(super.getPreferredSize());</span>
<span class="nc" id="L132">        di.width = Math.min(di.width, 200);</span>

<span class="nc" id="L134">        JScrollPane threadlistSP = new JScrollPane(list);</span>
<span class="nc" id="L135">        threadlistSP.setPreferredSize(di);</span>
<span class="nc" id="L136">        threadlistSP.setBorder(null);</span>

<span class="nc" id="L138">        JScrollPane textAreaSP = new JScrollPane(textArea);</span>
<span class="nc" id="L139">        textAreaSP.setBorder(null);</span>

<span class="nc" id="L141">        threadListTabbedPane = new JTabbedPane(JTabbedPane.TOP);</span>
<span class="nc" id="L142">        threadsSplitPane  = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT,</span>
                                           threadlistSP, textAreaSP);
<span class="nc" id="L144">        threadsSplitPane.setOneTouchExpandable(true);</span>
<span class="nc" id="L145">        threadsSplitPane.setBorder(null);</span>

<span class="nc" id="L147">        JPanel firstTabPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L148">        firstTabPanel.setOpaque(false);</span>

<span class="nc" id="L150">        JPanel firstTabToolPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 5, 2));</span>
<span class="nc" id="L151">        firstTabToolPanel.setOpaque(false);</span>

<span class="nc" id="L153">        filterTF = new PromptingTextField(&quot;Filter&quot;, 20);</span>
<span class="nc" id="L154">        filterTF.getDocument().addDocumentListener(this);</span>
<span class="nc" id="L155">        firstTabToolPanel.add(filterTF);</span>

<span class="nc" id="L157">        JSeparator separator = new JSeparator(JSeparator.VERTICAL);</span>
<span class="nc" id="L158">        separator.setPreferredSize(new Dimension(separator.getPreferredSize().width,</span>
<span class="nc" id="L159">                                                 filterTF.getPreferredSize().height));</span>
<span class="nc" id="L160">        firstTabToolPanel.add(separator);</span>

<span class="nc" id="L162">        JButton detectDeadlockButton = new JButton(Messages.DETECT_DEADLOCK);</span>
<span class="nc" id="L163">        detectDeadlockButton.setMnemonic(Resources.getMnemonicInt(Messages.DETECT_DEADLOCK));</span>
<span class="nc" id="L164">        detectDeadlockButton.setActionCommand(&quot;detectDeadlock&quot;);</span>
<span class="nc" id="L165">        detectDeadlockButton.addActionListener(this);</span>
<span class="nc" id="L166">        detectDeadlockButton.setToolTipText(Messages.DETECT_DEADLOCK_TOOLTIP);</span>
<span class="nc" id="L167">        firstTabToolPanel.add(detectDeadlockButton);</span>

<span class="nc" id="L169">        messageLabel = new JLabel();</span>
<span class="nc" id="L170">        firstTabToolPanel.add(messageLabel);</span>

<span class="nc" id="L172">        firstTabPanel.add(threadsSplitPane, BorderLayout.CENTER);</span>
<span class="nc" id="L173">        firstTabPanel.add(firstTabToolPanel, BorderLayout.SOUTH);</span>
<span class="nc" id="L174">        threadListTabbedPane.addTab(Messages.THREADS, firstTabPanel);</span>

<span class="nc" id="L176">        plotterPanel.add(threadListTabbedPane);</span>
<span class="nc" id="L177">    }</span>

<span class="nc" id="L179">    private long oldThreads[] = new long[0];</span>

    public SwingWorker&lt;?, ?&gt; newSwingWorker() {
<span class="nc" id="L182">        final ProxyClient proxyClient = vmPanel.getProxyClient();</span>

<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (!plotterListening) {</span>
<span class="nc" id="L185">            proxyClient.addWeakPropertyChangeListener(threadMeter.plotter);</span>
<span class="nc" id="L186">            plotterListening = true;</span>
        }

<span class="nc" id="L189">        return new SwingWorker&lt;Boolean, Object&gt;() {</span>
            private int tlCount;
            private int tpCount;
            private long ttCount;
            private long[] threads;
            private long timeStamp;

            public Boolean doInBackground() {
                try {
<span class="nc" id="L198">                    ThreadMXBean threadMBean = proxyClient.getThreadMXBean();</span>

<span class="nc" id="L200">                    tlCount = threadMBean.getThreadCount();</span>
<span class="nc" id="L201">                    tpCount = threadMBean.getPeakThreadCount();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                    if (overviewPanel != null) {</span>
<span class="nc" id="L203">                        ttCount = threadMBean.getTotalStartedThreadCount();</span>
                    } else {
<span class="nc" id="L205">                        ttCount = 0L;</span>
                    }

<span class="nc" id="L208">                    threads = threadMBean.getAllThreadIds();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                    for (long newThread : threads) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                        if (nameCache.get(newThread) == null) {</span>
<span class="nc" id="L211">                            ThreadInfo ti = threadMBean.getThreadInfo(newThread);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                            if (ti != null) {</span>
<span class="nc" id="L213">                                String name = ti.getThreadName();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                                if (name != null) {</span>
<span class="nc" id="L215">                                    nameCache.put(newThread, name);</span>
                                }
                            }
                        }
                    }
<span class="nc" id="L220">                    timeStamp = System.currentTimeMillis();</span>
<span class="nc" id="L221">                    return true;</span>
<span class="nc" id="L222">                } catch (IOException e) {</span>
<span class="nc" id="L223">                    return false;</span>
<span class="nc" id="L224">                } catch (UndeclaredThrowableException e) {</span>
<span class="nc" id="L225">                    return false;</span>
                }
            }

            protected void done() {
                try {
<span class="nc bnc" id="L231" title="All 2 branches missed.">                    if (!get()) {</span>
<span class="nc" id="L232">                        return;</span>
                    }
<span class="nc" id="L234">                } catch (InterruptedException ex) {</span>
<span class="nc" id="L235">                    return;</span>
<span class="nc" id="L236">                } catch (ExecutionException ex) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L238">                        ex.printStackTrace();</span>
                    }
<span class="nc" id="L240">                    return;</span>
<span class="nc" id="L241">                }</span>

<span class="nc" id="L243">                threadMeter.plotter.addValues(timeStamp, tlCount, tpCount);</span>
<span class="nc" id="L244">                threadMeter.setValueLabel(tlCount+&quot;&quot;);</span>

<span class="nc bnc" id="L246" title="All 2 branches missed.">                if (overviewPanel != null) {</span>
<span class="nc" id="L247">                    overviewPanel.updateThreadsInfo(tlCount, tpCount, ttCount, timeStamp);</span>
                }

<span class="nc" id="L250">                String filter = filterTF.getText().toLowerCase(Locale.ENGLISH);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                boolean doFilter = (filter.length() &gt; 0);</span>

<span class="nc" id="L253">                ArrayList&lt;Long&gt; l = new ArrayList&lt;Long&gt;();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                for (long t : threads) {</span>
<span class="nc" id="L255">                    l.add(t);</span>
                }
<span class="nc" id="L257">                Iterator&lt;Long&gt; iterator = l.iterator();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                while (iterator.hasNext()) {</span>
<span class="nc" id="L259">                    long newThread = iterator.next();</span>
<span class="nc" id="L260">                    String name = nameCache.get(newThread);</span>
<span class="nc bnc" id="L261" title="All 4 branches missed.">                    if (doFilter &amp;&amp; name != null &amp;&amp;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                        name.toLowerCase(Locale.ENGLISH).indexOf(filter) &lt; 0) {</span>

<span class="nc" id="L264">                        iterator.remove();</span>
                    }
<span class="nc" id="L266">                }</span>
<span class="nc" id="L267">                long[] newThreads = threads;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">                if (l.size() &lt; threads.length) {</span>
<span class="nc" id="L269">                    newThreads = new long[l.size()];</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                    for (int i = 0; i &lt; newThreads.length; i++) {</span>
<span class="nc" id="L271">                        newThreads[i] = l.get(i);</span>
                    }
                }


<span class="nc bnc" id="L276" title="All 2 branches missed.">                for (long oldThread : oldThreads) {</span>
<span class="nc" id="L277">                    boolean found = false;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                    for (long newThread : newThreads) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                        if (newThread == oldThread) {</span>
<span class="nc" id="L280">                            found = true;</span>
<span class="nc" id="L281">                            break;</span>
                        }
                    }
<span class="nc bnc" id="L284" title="All 2 branches missed.">                    if (!found) {</span>
<span class="nc" id="L285">                        listModel.removeElement(oldThread);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">                        if (!doFilter) {</span>
<span class="nc" id="L287">                            nameCache.remove(oldThread);</span>
                        }
                    }
                }

                // Threads are in reverse chronological order
<span class="nc bnc" id="L293" title="All 2 branches missed.">                for (int i = newThreads.length - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L294">                    long newThread = newThreads[i];</span>
<span class="nc" id="L295">                    boolean found = false;</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                    for (long oldThread : oldThreads) {</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">                        if (newThread == oldThread) {</span>
<span class="nc" id="L298">                            found = true;</span>
<span class="nc" id="L299">                            break;</span>
                        }
                    }
<span class="nc bnc" id="L302" title="All 2 branches missed.">                    if (!found) {</span>
<span class="nc" id="L303">                        listModel.addElement(newThread);</span>
                    }
                }
<span class="nc" id="L306">                oldThreads = newThreads;</span>
<span class="nc" id="L307">            }</span>
        };
    }

<span class="nc" id="L311">    long lastSelected = -1;</span>

    public void valueChanged(ListSelectionEvent ev) {
<span class="nc" id="L314">        ThreadJList list = (ThreadJList)ev.getSource();</span>
<span class="nc" id="L315">        final JTextArea textArea = list.textArea;</span>

<span class="nc" id="L317">        Long selected = (Long)list.getSelectedValue();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (selected == null) {</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (lastSelected != -1) {</span>
<span class="nc" id="L320">                selected = lastSelected;</span>
            }
        } else {
<span class="nc" id="L323">            lastSelected = selected;</span>
        }
<span class="nc" id="L325">        textArea.setText(&quot;&quot;);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (selected != null) {</span>
<span class="nc" id="L327">            final long threadID = selected;</span>
<span class="nc" id="L328">            workerAdd(new Runnable() {</span>
                public void run() {
<span class="nc" id="L330">                    ProxyClient proxyClient = vmPanel.getProxyClient();</span>
<span class="nc" id="L331">                    StringBuilder sb = new StringBuilder();</span>
                    try {
<span class="nc" id="L333">                        ThreadMXBean threadMBean = proxyClient.getThreadMXBean();</span>
<span class="nc" id="L334">                        ThreadInfo ti = null;</span>
<span class="nc" id="L335">                        MonitorInfo[] monitors = null;</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                        if (proxyClient.isLockUsageSupported() &amp;&amp;</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                              threadMBean.isObjectMonitorUsageSupported()) {</span>
                            // VMs that support the monitor usage monitoring
<span class="nc" id="L339">                            ThreadInfo[] infos = threadMBean.dumpAllThreads(true, false);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                            for (ThreadInfo info : infos) {</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">                                if (info.getThreadId() == threadID) {</span>
<span class="nc" id="L342">                                    ti = info;</span>
<span class="nc" id="L343">                                    monitors = info.getLockedMonitors();</span>
<span class="nc" id="L344">                                    break;</span>
                                }
                            }
<span class="nc" id="L347">                        } else {</span>
                            // VM doesn't support monitor usage monitoring
<span class="nc" id="L349">                            ti = threadMBean.getThreadInfo(threadID, Integer.MAX_VALUE);</span>
                        }
<span class="nc bnc" id="L351" title="All 2 branches missed.">                        if (ti != null) {</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                            if (ti.getLockName() == null) {</span>
<span class="nc" id="L353">                                sb.append(Resources.format(Messages.NAME_STATE,</span>
<span class="nc" id="L354">                                              ti.getThreadName(),</span>
<span class="nc" id="L355">                                              ti.getThreadState().toString()));</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                            } else if (ti.getLockOwnerName() == null) {</span>
<span class="nc" id="L357">                                sb.append(Resources.format(Messages.NAME_STATE_LOCK_NAME,</span>
<span class="nc" id="L358">                                              ti.getThreadName(),</span>
<span class="nc" id="L359">                                              ti.getThreadState().toString(),</span>
<span class="nc" id="L360">                                              ti.getLockName()));</span>
                            } else {
<span class="nc" id="L362">                                sb.append(Resources.format(Messages.NAME_STATE_LOCK_NAME_LOCK_OWNER,</span>
<span class="nc" id="L363">                                              ti.getThreadName(),</span>
<span class="nc" id="L364">                                              ti.getThreadState().toString(),</span>
<span class="nc" id="L365">                                              ti.getLockName(),</span>
<span class="nc" id="L366">                                              ti.getLockOwnerName()));</span>
                            }
<span class="nc" id="L368">                            sb.append(Resources.format(Messages.BLOCKED_COUNT_WAITED_COUNT,</span>
<span class="nc" id="L369">                                              ti.getBlockedCount(),</span>
<span class="nc" id="L370">                                              ti.getWaitedCount()));</span>
<span class="nc" id="L371">                            sb.append(Messages.STACK_TRACE);</span>
<span class="nc" id="L372">                            int index = 0;</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                            for (StackTraceElement e : ti.getStackTrace()) {</span>
<span class="nc" id="L374">                                sb.append(e.toString()+&quot;\n&quot;);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                                if (monitors != null) {</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                                    for (MonitorInfo mi : monitors) {</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                                        if (mi.getLockedStackDepth() == index) {</span>
<span class="nc" id="L378">                                            sb.append(Resources.format(Messages.MONITOR_LOCKED, mi.toString()));</span>
                                        }
                                    }
                                }
<span class="nc" id="L382">                                index++;</span>
                            }
                        }
<span class="nc" id="L385">                    } catch (IOException ex) {</span>
                        // Ignore
<span class="nc" id="L387">                    } catch (UndeclaredThrowableException e) {</span>
<span class="nc" id="L388">                        proxyClient.markAsDead();</span>
<span class="nc" id="L389">                    }</span>
<span class="nc" id="L390">                    final String text = sb.toString();</span>
<span class="nc" id="L391">                    SwingUtilities.invokeLater(new Runnable() {</span>
                        public void run() {
<span class="nc" id="L393">                            textArea.setText(text);</span>
<span class="nc" id="L394">                            textArea.setCaretPosition(0);</span>
<span class="nc" id="L395">                        }</span>
                    });
<span class="nc" id="L397">                }</span>
            });
        }
<span class="nc" id="L400">    }</span>

    private void doUpdate() {
<span class="nc" id="L403">        workerAdd(new Runnable() {</span>
            public void run() {
<span class="nc" id="L405">                update();</span>
<span class="nc" id="L406">            }</span>
        });
<span class="nc" id="L408">    }</span>


    private void detectDeadlock() {
<span class="nc" id="L412">        workerAdd(new Runnable() {</span>
            public void run() {
                try {
<span class="nc" id="L415">                    final Long[][] deadlockedThreads = getDeadlockedThreadIds();</span>

<span class="nc bnc" id="L417" title="All 4 branches missed.">                    if (deadlockedThreads == null || deadlockedThreads.length == 0) {</span>
                        // Display message for 30 seconds. Do it on a separate thread so
                        // the sleep won't hold up the worker queue.
                        // This will be replaced later by separate statusbar logic.
<span class="nc" id="L421">                        new Thread() {</span>
                            public void run() {
                                try {
<span class="nc" id="L424">                                    SwingUtilities.invokeAndWait(new Runnable() {</span>
                                        public void run() {
<span class="nc" id="L426">                                            String msg = Messages.NO_DEADLOCK_DETECTED;</span>
<span class="nc" id="L427">                                            messageLabel.setText(msg);</span>
<span class="nc" id="L428">                                            threadListTabbedPane.revalidate();</span>
<span class="nc" id="L429">                                        }</span>
                                    });
<span class="nc" id="L431">                                    sleep(30 * 1000);</span>
<span class="nc" id="L432">                                } catch (InterruptedException ex) {</span>
                                    // Ignore
<span class="nc" id="L434">                                } catch (InvocationTargetException ex) {</span>
                                    // Ignore
<span class="nc" id="L436">                                }</span>
<span class="nc" id="L437">                                SwingUtilities.invokeLater(new Runnable() {</span>
                                    public void run() {
<span class="nc" id="L439">                                        messageLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L440">                                    }</span>
                                });
<span class="nc" id="L442">                            }</span>
<span class="nc" id="L443">                        }.start();</span>
<span class="nc" id="L444">                        return;</span>
                    }

<span class="nc" id="L447">                    SwingUtilities.invokeLater(new Runnable() {</span>
                        public void run() {
                            // Remove old deadlock tabs
<span class="nc bnc" id="L450" title="All 2 branches missed.">                            while (threadListTabbedPane.getTabCount() &gt; 1) {</span>
<span class="nc" id="L451">                                threadListTabbedPane.removeTabAt(1);</span>
                            }

<span class="nc bnc" id="L454" title="All 2 branches missed.">                            if (deadlockedThreads != null) {</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">                                for (int i = 0; i &lt; deadlockedThreads.length; i++) {</span>
<span class="nc" id="L456">                                    DefaultListModel&lt;Long&gt; listModel = new DefaultListModel&lt;Long&gt;();</span>
<span class="nc" id="L457">                                    JTextArea textArea = new JTextArea();</span>
<span class="nc" id="L458">                                    textArea.setBorder(thinEmptyBorder);</span>
<span class="nc" id="L459">                                    textArea.setEditable(false);</span>
<span class="nc" id="L460">                                    setAccessibleName(textArea,</span>
                                                      Messages.THREAD_TAB_THREAD_INFO_ACCESSIBLE_NAME);
<span class="nc" id="L462">                                    ThreadJList list = new ThreadJList(listModel, textArea);</span>
<span class="nc" id="L463">                                    JScrollPane threadlistSP = new JScrollPane(list);</span>
<span class="nc" id="L464">                                    JScrollPane textAreaSP = new JScrollPane(textArea);</span>
<span class="nc" id="L465">                                    threadlistSP.setBorder(null);</span>
<span class="nc" id="L466">                                    textAreaSP.setBorder(null);</span>
<span class="nc" id="L467">                                    JSplitPane splitPane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT,</span>
                                                                                 threadlistSP, textAreaSP);
<span class="nc" id="L469">                                    splitPane.setOneTouchExpandable(true);</span>
<span class="nc" id="L470">                                    splitPane.setBorder(null);</span>
<span class="nc" id="L471">                                    splitPane.setDividerLocation(threadsSplitPane.getDividerLocation());</span>
                                    String tabName;
<span class="nc bnc" id="L473" title="All 2 branches missed.">                                    if (deadlockedThreads.length &gt; 1) {</span>
<span class="nc" id="L474">                                        tabName = Resources.format(Messages.DEADLOCK_TAB_N, i+1);</span>
                                    } else {
<span class="nc" id="L476">                                        tabName = Messages.DEADLOCK_TAB;</span>
                                    }
<span class="nc" id="L478">                                    threadListTabbedPane.addTab(tabName, splitPane);</span>

<span class="nc bnc" id="L480" title="All 2 branches missed.">                                    for (long t : deadlockedThreads[i]) {</span>
<span class="nc" id="L481">                                        listModel.addElement(t);</span>
                                    }
                                }
<span class="nc" id="L484">                                threadListTabbedPane.setSelectedIndex(1);</span>
                            }
<span class="nc" id="L486">                        }</span>
                    });
<span class="nc" id="L488">                } catch (IOException e) {</span>
                    // Ignore
<span class="nc" id="L490">                } catch (UndeclaredThrowableException e) {</span>
<span class="nc" id="L491">                    vmPanel.getProxyClient().markAsDead();</span>
<span class="nc" id="L492">                }</span>
<span class="nc" id="L493">            }</span>
        });
<span class="nc" id="L495">    }</span>


    // Return deadlocked threads or null
    public Long[][] getDeadlockedThreadIds() throws IOException {
<span class="nc" id="L500">        ProxyClient proxyClient = vmPanel.getProxyClient();</span>
<span class="nc" id="L501">        ThreadMXBean threadMBean = proxyClient.getThreadMXBean();</span>

<span class="nc" id="L503">        long[] ids = proxyClient.findDeadlockedThreads();</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (ids == null) {</span>
<span class="nc" id="L505">            return null;</span>
        }
<span class="nc" id="L507">        ThreadInfo[] infos = threadMBean.getThreadInfo(ids, Integer.MAX_VALUE);</span>

<span class="nc" id="L509">        List&lt;Long[]&gt; dcycles = new ArrayList&lt;Long[]&gt;();</span>
<span class="nc" id="L510">        List&lt;Long&gt; cycle = new ArrayList&lt;Long&gt;();</span>

        // keep track of which thread is visited
        // one thread can only be in one cycle
<span class="nc" id="L514">        boolean[] visited = new boolean[ids.length];</span>

<span class="nc" id="L516">        int deadlockedThread = -1; // Index into arrays</span>
        while (true) {
<span class="nc bnc" id="L518" title="All 2 branches missed.">            if (deadlockedThread &lt; 0) {</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">                if (cycle.size() &gt; 0) {</span>
                    // a cycle found
<span class="nc" id="L521">                    dcycles.add(cycle.toArray(new Long[0]));</span>
<span class="nc" id="L522">                    cycle = new ArrayList&lt;Long&gt;();</span>
                }
                // start a new cycle from a non-visited thread
<span class="nc bnc" id="L525" title="All 2 branches missed.">                for (int j = 0; j &lt; ids.length; j++) {</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">                    if (!visited[j]) {</span>
<span class="nc" id="L527">                        deadlockedThread = j;</span>
<span class="nc" id="L528">                        visited[j] = true;</span>
<span class="nc" id="L529">                        break;</span>
                    }
                }
<span class="nc bnc" id="L532" title="All 2 branches missed.">                if (deadlockedThread &lt; 0) {</span>
                    // done
<span class="nc" id="L534">                    break;</span>
                }
            }

<span class="nc" id="L538">            cycle.add(ids[deadlockedThread]);</span>
<span class="nc" id="L539">            long nextThreadId = infos[deadlockedThread].getLockOwnerId();</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">            for (int j = 0; j &lt; ids.length; j++) {</span>
<span class="nc" id="L541">                ThreadInfo ti = infos[j];</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                if (ti.getThreadId() == nextThreadId) {</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">                     if (visited[j]) {</span>
<span class="nc" id="L544">                         deadlockedThread = -1;</span>
                     } else {
<span class="nc" id="L546">                         deadlockedThread = j;</span>
<span class="nc" id="L547">                         visited[j] = true;</span>
                     }
<span class="nc" id="L549">                     break;</span>
                }
            }
<span class="nc" id="L552">        }</span>
<span class="nc" id="L553">        return dcycles.toArray(new Long[0][0]);</span>
    }





    // ActionListener interface
    public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L562">        String cmd = ((AbstractButton)evt.getSource()).getActionCommand();</span>

<span class="nc bnc" id="L564" title="All 2 branches missed.">        if (cmd == &quot;detectDeadlock&quot;) {</span>
<span class="nc" id="L565">            messageLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L566">            detectDeadlock();</span>
        }
<span class="nc" id="L568">    }</span>



    // DocumentListener interface

    public void insertUpdate(DocumentEvent e) {
<span class="nc" id="L575">        doUpdate();</span>
<span class="nc" id="L576">    }</span>

    public void removeUpdate(DocumentEvent e) {
<span class="nc" id="L579">        doUpdate();</span>
<span class="nc" id="L580">    }</span>

    public void changedUpdate(DocumentEvent e) {
<span class="nc" id="L583">        doUpdate();</span>
<span class="nc" id="L584">    }</span>



    private class ThreadJList extends JList&lt;Long&gt; {
        private JTextArea textArea;

<span class="nc" id="L591">        ThreadJList(DefaultListModel&lt;Long&gt; listModel, JTextArea textArea) {</span>
<span class="nc" id="L592">            super(listModel);</span>

<span class="nc" id="L594">            this.textArea = textArea;</span>

<span class="nc" id="L596">            setBorder(thinEmptyBorder);</span>

<span class="nc" id="L598">            setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L599">            textArea.setText(Messages.THREAD_TAB_INITIAL_STACK_TRACE_MESSAGE);</span>
<span class="nc" id="L600">            addListSelectionListener(ThreadTab.this);</span>
<span class="nc" id="L601">            setCellRenderer(new DefaultListCellRenderer() {</span>
                public Component getListCellRendererComponent(JList&lt;?&gt; list, Object value, int index,
                                                              boolean isSelected, boolean cellHasFocus) {
<span class="nc" id="L604">                    super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);</span>

<span class="nc bnc" id="L606" title="All 2 branches missed.">                    if (value != null) {</span>
<span class="nc" id="L607">                        String name = nameCache.get(value);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">                        if (name == null) {</span>
<span class="nc" id="L609">                            name = value.toString();</span>
                        }
<span class="nc" id="L611">                        setText(name);</span>
                    }
<span class="nc" id="L613">                    return this;</span>
                }
            });
<span class="nc" id="L616">        }</span>

        public Dimension getPreferredSize() {
<span class="nc" id="L619">            Dimension d = super.getPreferredSize();</span>
<span class="nc" id="L620">            d.width = Math.max(d.width, 100);</span>
<span class="nc" id="L621">            return d;</span>
        }
    }

    private class PromptingTextField extends JTextField implements FocusListener {
        private String prompt;
<span class="nc" id="L627">        boolean promptRemoved = false;</span>
        Color fg;

<span class="nc" id="L630">        public PromptingTextField(String prompt, int columns) {</span>
<span class="nc" id="L631">            super(prompt, columns);</span>

<span class="nc" id="L633">            this.prompt = prompt;</span>
<span class="nc" id="L634">            updateForeground();</span>
<span class="nc" id="L635">            addFocusListener(this);</span>
<span class="nc" id="L636">            setAccessibleName(this, prompt);</span>
<span class="nc" id="L637">        }</span>

        @Override
        public void revalidate() {
<span class="nc" id="L641">            super.revalidate();</span>
<span class="nc" id="L642">            updateForeground();</span>
<span class="nc" id="L643">        }</span>

        private void updateForeground() {
<span class="nc" id="L646">            this.fg = UIManager.getColor(&quot;TextField.foreground&quot;);</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">            if (promptRemoved) {</span>
<span class="nc" id="L648">                setForeground(fg);</span>
            } else {
<span class="nc" id="L650">                setForeground(Color.gray);</span>
            }
<span class="nc" id="L652">        }</span>

        public String getText() {
<span class="nc bnc" id="L655" title="All 2 branches missed.">            if (!promptRemoved) {</span>
<span class="nc" id="L656">                return &quot;&quot;;</span>
            } else {
<span class="nc" id="L658">                return super.getText();</span>
            }
        }

        public void focusGained(FocusEvent e) {
<span class="nc bnc" id="L663" title="All 2 branches missed.">            if (!promptRemoved) {</span>
<span class="nc" id="L664">                setText(&quot;&quot;);</span>
<span class="nc" id="L665">                setForeground(fg);</span>
<span class="nc" id="L666">                promptRemoved = true;</span>
            }
<span class="nc" id="L668">        }</span>

        public void focusLost(FocusEvent e) {
<span class="nc bnc" id="L671" title="All 4 branches missed.">            if (promptRemoved &amp;&amp; getText().equals(&quot;&quot;)) {</span>
<span class="nc" id="L672">                setText(prompt);</span>
<span class="nc" id="L673">                setForeground(Color.gray);</span>
<span class="nc" id="L674">                promptRemoved = false;</span>
            }
<span class="nc" id="L676">        }</span>

    }

    OverviewPanel[] getOverviewPanels() {
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (overviewPanel == null) {</span>
<span class="nc" id="L682">            overviewPanel = new ThreadOverviewPanel();</span>
        }
<span class="nc" id="L684">        return new OverviewPanel[] { overviewPanel };</span>
    }


    private static class ThreadOverviewPanel extends OverviewPanel {
        ThreadOverviewPanel() {
<span class="nc" id="L690">            super(Messages.THREADS, threadCountKey,  Messages.LIVE_THREADS, null);</span>
<span class="nc" id="L691">        }</span>

        private void updateThreadsInfo(long tlCount, long tpCount, long ttCount, long timeStamp) {
<span class="nc" id="L694">            getPlotter().addValues(timeStamp, tlCount);</span>
<span class="nc" id="L695">            getInfoLabel().setText(Resources.format(infoLabelFormat, tlCount, tpCount, ttCount));</span>
<span class="nc" id="L696">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>