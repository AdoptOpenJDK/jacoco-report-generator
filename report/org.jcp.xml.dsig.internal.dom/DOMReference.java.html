<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DOMReference.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">org.jcp.xml.dsig.internal.dom</a> &gt; <span class="el_source">DOMReference.java</span></div><h1>DOMReference.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
/*
 * Copyright (c) 2005, Oracle and/or its affiliates. All rights reserved.
 */
/*
 * ===========================================================================
 *
 * (C) Copyright IBM Corp. 2003 All Rights Reserved.
 *
 * ===========================================================================
 */
/*
 * $Id: DOMReference.java 1334007 2012-05-04 14:59:46Z coheigea $
 */
package org.jcp.xml.dsig.internal.dom;

import javax.xml.crypto.*;
import javax.xml.crypto.dsig.*;
import javax.xml.crypto.dom.DOMCryptoContext;
import javax.xml.crypto.dom.DOMURIReference;

import java.io.*;
import java.net.URI;
import java.net.URISyntaxException;
import java.security.*;
import java.util.*;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;

import org.jcp.xml.dsig.internal.DigesterOutputStream;
import com.sun.org.apache.xml.internal.security.algorithms.MessageDigestAlgorithm;
import com.sun.org.apache.xml.internal.security.exceptions.Base64DecodingException;
import com.sun.org.apache.xml.internal.security.signature.XMLSignatureInput;
import com.sun.org.apache.xml.internal.security.utils.Base64;
import com.sun.org.apache.xml.internal.security.utils.UnsyncBufferedOutputStream;

/**
 * DOM-based implementation of Reference.
 *
 * @author Sean Mullan
 * @author Joyce Leung
 */
public final class DOMReference extends DOMStructure
    implements Reference, DOMURIReference {

   /**
    * The maximum number of transforms per reference, if secure validation is enabled.
    */
   public static final int MAXIMUM_TRANSFORM_COUNT = 5;

   /**
    * Look up useC14N11 system property. If true, an explicit C14N11 transform
    * will be added if necessary when generating the signature. See section
    * 3.1.1 of http://www.w3.org/2007/xmlsec/Drafts/xmldsig-core/ for more info.
    *
    * If true, overrides the same property if set in the XMLSignContext.
    */
<span class="nc" id="L81">    private static boolean useC14N11 =</span>
<span class="nc" id="L82">        AccessController.doPrivileged(new PrivilegedAction&lt;Boolean&gt;() {</span>
            public Boolean run() {
<span class="nc" id="L84">                return Boolean.valueOf(Boolean.getBoolean</span>
<span class="nc" id="L85">                    (&quot;com.sun.org.apache.xml.internal.security.useC14N11&quot;));</span>
            }
        });

<span class="nc" id="L89">    private static java.util.logging.Logger log =</span>
<span class="nc" id="L90">        java.util.logging.Logger.getLogger(&quot;org.jcp.xml.dsig.internal.dom&quot;);</span>

    private final DigestMethod digestMethod;
    private final String id;
    private final List&lt;Transform&gt; transforms;
    private List&lt;Transform&gt; allTransforms;
    private final Data appliedTransformData;
    private Attr here;
    private final String uri;
    private final String type;
    private byte[] digestValue;
    private byte[] calcDigestValue;
    private Element refElem;
<span class="nc" id="L103">    private boolean digested = false;</span>
<span class="nc" id="L104">    private boolean validated = false;</span>
    private boolean validationStatus;
    private Data derefData;
    private InputStream dis;
    private MessageDigest md;
    private Provider provider;

    /**
     * Creates a &lt;code&gt;Reference&lt;/code&gt; from the specified parameters.
     *
     * @param uri the URI (may be null)
     * @param type the type (may be null)
     * @param dm the digest method
     * @param transforms a list of {@link Transform}s. The list
     *    is defensively copied to protect against subsequent modification.
     *    May be &lt;code&gt;null&lt;/code&gt; or empty.
     * @param id the reference ID (may be &lt;code&gt;null&lt;/code&gt;)
     * @return a &lt;code&gt;Reference&lt;/code&gt;
     * @throws NullPointerException if &lt;code&gt;dm&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;
     * @throws ClassCastException if any of the &lt;code&gt;transforms&lt;/code&gt; are
     *    not of type &lt;code&gt;Transform&lt;/code&gt;
     */
    public DOMReference(String uri, String type, DigestMethod dm,
                        List&lt;? extends Transform&gt; transforms, String id,
                        Provider provider)
    {
<span class="nc" id="L130">        this(uri, type, dm, null, null, transforms, id, null, provider);</span>
<span class="nc" id="L131">    }</span>

    public DOMReference(String uri, String type, DigestMethod dm,
                        List&lt;? extends Transform&gt; appliedTransforms,
                        Data result, List&lt;? extends Transform&gt; transforms,
                        String id, Provider provider)
    {
<span class="nc" id="L138">        this(uri, type, dm, appliedTransforms,</span>
             result, transforms, id, null, provider);
<span class="nc" id="L140">    }</span>

    public DOMReference(String uri, String type, DigestMethod dm,
                        List&lt;? extends Transform&gt; appliedTransforms,
                        Data result, List&lt;? extends Transform&gt; transforms,
                        String id, byte[] digestValue, Provider provider)
<span class="nc" id="L146">    {</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (dm == null) {</span>
<span class="nc" id="L148">            throw new NullPointerException(&quot;DigestMethod must be non-null&quot;);</span>
        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (appliedTransforms == null) {</span>
<span class="nc" id="L151">            this.allTransforms = new ArrayList&lt;Transform&gt;();</span>
        } else {
<span class="nc" id="L153">            this.allTransforms = new ArrayList&lt;Transform&gt;(appliedTransforms);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            for (int i = 0, size = this.allTransforms.size(); i &lt; size; i++) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                if (!(this.allTransforms.get(i) instanceof Transform)) {</span>
<span class="nc" id="L156">                    throw new ClassCastException</span>
                        (&quot;appliedTransforms[&quot;+i+&quot;] is not a valid type&quot;);
                }
            }
        }
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (transforms == null) {</span>
<span class="nc" id="L162">            this.transforms = Collections.emptyList();</span>
        } else {
<span class="nc" id="L164">            this.transforms = new ArrayList&lt;Transform&gt;(transforms);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            for (int i = 0, size = this.transforms.size(); i &lt; size; i++) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                if (!(this.transforms.get(i) instanceof Transform)) {</span>
<span class="nc" id="L167">                    throw new ClassCastException</span>
                        (&quot;transforms[&quot;+i+&quot;] is not a valid type&quot;);
                }
            }
<span class="nc" id="L171">            this.allTransforms.addAll(this.transforms);</span>
        }
<span class="nc" id="L173">        this.digestMethod = dm;</span>
<span class="nc" id="L174">        this.uri = uri;</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">        if ((uri != null) &amp;&amp; (!uri.equals(&quot;&quot;))) {</span>
            try {
<span class="nc" id="L177">                new URI(uri);</span>
<span class="nc" id="L178">            } catch (URISyntaxException e) {</span>
<span class="nc" id="L179">                throw new IllegalArgumentException(e.getMessage());</span>
<span class="nc" id="L180">            }</span>
        }
<span class="nc" id="L182">        this.type = type;</span>
<span class="nc" id="L183">        this.id = id;</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (digestValue != null) {</span>
<span class="nc" id="L185">            this.digestValue = (byte[])digestValue.clone();</span>
<span class="nc" id="L186">            this.digested = true;</span>
        }
<span class="nc" id="L188">        this.appliedTransformData = result;</span>
<span class="nc" id="L189">        this.provider = provider;</span>
<span class="nc" id="L190">    }</span>

    /**
     * Creates a &lt;code&gt;DOMReference&lt;/code&gt; from an element.
     *
     * @param refElem a Reference element
     */
    public DOMReference(Element refElem, XMLCryptoContext context,
                        Provider provider)
        throws MarshalException
<span class="nc" id="L200">    {</span>
<span class="nc" id="L201">        boolean secVal = Utils.secureValidation(context);</span>

        // unmarshal Transforms, if specified
<span class="nc" id="L204">        Element nextSibling = DOMUtils.getFirstChildElement(refElem);</span>
<span class="nc" id="L205">        List&lt;Transform&gt; transforms = new ArrayList&lt;Transform&gt;(5);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (nextSibling.getLocalName().equals(&quot;Transforms&quot;)) {</span>
<span class="nc" id="L207">            Element transformElem = DOMUtils.getFirstChildElement(nextSibling,</span>
                                                                  &quot;Transform&quot;);
<span class="nc" id="L209">            transforms.add(new DOMTransform(transformElem, context, provider));</span>
<span class="nc" id="L210">            transformElem = DOMUtils.getNextSiblingElement(transformElem);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            while (transformElem != null) {</span>
<span class="nc" id="L212">                String localName = transformElem.getLocalName();</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                if (!localName.equals(&quot;Transform&quot;)) {</span>
<span class="nc" id="L214">                    throw new MarshalException(</span>
                        &quot;Invalid element name: &quot; + localName +
                        &quot;, expected Transform&quot;);
                }
<span class="nc" id="L218">                transforms.add</span>
<span class="nc" id="L219">                    (new DOMTransform(transformElem, context, provider));</span>
<span class="nc bnc" id="L220" title="All 4 branches missed.">                if (secVal &amp;&amp; (transforms.size() &gt; MAXIMUM_TRANSFORM_COUNT)) {</span>
<span class="nc" id="L221">                    String error = &quot;A maxiumum of &quot; + MAXIMUM_TRANSFORM_COUNT + &quot; &quot;</span>
                        + &quot;transforms per Reference are allowed with secure validation&quot;;
<span class="nc" id="L223">                    throw new MarshalException(error);</span>
                }
<span class="nc" id="L225">                transformElem = DOMUtils.getNextSiblingElement(transformElem);</span>
<span class="nc" id="L226">            }</span>
<span class="nc" id="L227">            nextSibling = DOMUtils.getNextSiblingElement(nextSibling);</span>
        }
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (!nextSibling.getLocalName().equals(&quot;DigestMethod&quot;)) {</span>
<span class="nc" id="L230">            throw new MarshalException(&quot;Invalid element name: &quot; +</span>
<span class="nc" id="L231">                                       nextSibling.getLocalName() +</span>
                                       &quot;, expected DigestMethod&quot;);
        }

        // unmarshal DigestMethod
<span class="nc" id="L236">        Element dmElem = nextSibling;</span>
<span class="nc" id="L237">        this.digestMethod = DOMDigestMethod.unmarshal(dmElem);</span>
<span class="nc" id="L238">        String digestMethodAlgorithm = this.digestMethod.getAlgorithm();</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (secVal</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">            &amp;&amp; MessageDigestAlgorithm.ALGO_ID_DIGEST_NOT_RECOMMENDED_MD5.equals(digestMethodAlgorithm)) {</span>
<span class="nc" id="L241">            throw new MarshalException(</span>
                &quot;It is forbidden to use algorithm &quot; + digestMethod + &quot; when secure validation is enabled&quot;
            );
        }

        // unmarshal DigestValue
<span class="nc" id="L247">        Element dvElem = DOMUtils.getNextSiblingElement(dmElem, &quot;DigestValue&quot;);</span>
        try {
<span class="nc" id="L249">            this.digestValue = Base64.decode(dvElem);</span>
<span class="nc" id="L250">        } catch (Base64DecodingException bde) {</span>
<span class="nc" id="L251">            throw new MarshalException(bde);</span>
<span class="nc" id="L252">        }</span>

        // check for extra elements
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (DOMUtils.getNextSiblingElement(dvElem) != null) {</span>
<span class="nc" id="L256">            throw new MarshalException(</span>
                &quot;Unexpected element after DigestValue element&quot;);
        }

        // unmarshal attributes
<span class="nc" id="L261">        this.uri = DOMUtils.getAttributeValue(refElem, &quot;URI&quot;);</span>

<span class="nc" id="L263">        Attr attr = refElem.getAttributeNodeNS(null, &quot;Id&quot;);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (attr != null) {</span>
<span class="nc" id="L265">            this.id = attr.getValue();</span>
<span class="nc" id="L266">            refElem.setIdAttributeNode(attr, true);</span>
        } else {
<span class="nc" id="L268">            this.id = null;</span>
        }

<span class="nc" id="L271">        this.type = DOMUtils.getAttributeValue(refElem, &quot;Type&quot;);</span>
<span class="nc" id="L272">        this.here = refElem.getAttributeNodeNS(null, &quot;URI&quot;);</span>
<span class="nc" id="L273">        this.refElem = refElem;</span>
<span class="nc" id="L274">        this.transforms = transforms;</span>
<span class="nc" id="L275">        this.allTransforms = transforms;</span>
<span class="nc" id="L276">        this.appliedTransformData = null;</span>
<span class="nc" id="L277">        this.provider = provider;</span>
<span class="nc" id="L278">    }</span>

    public DigestMethod getDigestMethod() {
<span class="nc" id="L281">        return digestMethod;</span>
    }

    public String getId() {
<span class="nc" id="L285">        return id;</span>
    }

    public String getURI() {
<span class="nc" id="L289">        return uri;</span>
    }

    public String getType() {
<span class="nc" id="L293">        return type;</span>
    }

    public List getTransforms() {
<span class="nc" id="L297">        return Collections.unmodifiableList(allTransforms);</span>
    }

    public byte[] getDigestValue() {
<span class="nc bnc" id="L301" title="All 2 branches missed.">        return (digestValue == null ? null : (byte[])digestValue.clone());</span>
    }

    public byte[] getCalculatedDigestValue() {
<span class="nc bnc" id="L305" title="All 2 branches missed.">        return (calcDigestValue == null ? null</span>
<span class="nc" id="L306">                                        : (byte[])calcDigestValue.clone());</span>
    }

    public void marshal(Node parent, String dsPrefix, DOMCryptoContext context)
        throws MarshalException
    {
<span class="nc bnc" id="L312" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L313">            log.log(java.util.logging.Level.FINE, &quot;Marshalling Reference&quot;);</span>
        }
<span class="nc" id="L315">        Document ownerDoc = DOMUtils.getOwnerDocument(parent);</span>

<span class="nc" id="L317">        refElem = DOMUtils.createElement(ownerDoc, &quot;Reference&quot;,</span>
                                         XMLSignature.XMLNS, dsPrefix);

        // set attributes
<span class="nc" id="L321">        DOMUtils.setAttributeID(refElem, &quot;Id&quot;, id);</span>
<span class="nc" id="L322">        DOMUtils.setAttribute(refElem, &quot;URI&quot;, uri);</span>
<span class="nc" id="L323">        DOMUtils.setAttribute(refElem, &quot;Type&quot;, type);</span>

        // create and append Transforms element
<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (!allTransforms.isEmpty()) {</span>
<span class="nc" id="L327">            Element transformsElem = DOMUtils.createElement(ownerDoc,</span>
                                                            &quot;Transforms&quot;,
                                                            XMLSignature.XMLNS,
                                                            dsPrefix);
<span class="nc" id="L331">            refElem.appendChild(transformsElem);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">            for (Transform transform : allTransforms) {</span>
<span class="nc" id="L333">                ((DOMStructure)transform).marshal(transformsElem,</span>
                                                  dsPrefix, context);
<span class="nc" id="L335">            }</span>
        }

        // create and append DigestMethod element
<span class="nc" id="L339">        ((DOMDigestMethod)digestMethod).marshal(refElem, dsPrefix, context);</span>

        // create and append DigestValue element
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L343">            log.log(java.util.logging.Level.FINE, &quot;Adding digestValueElem&quot;);</span>
        }
<span class="nc" id="L345">        Element digestValueElem = DOMUtils.createElement(ownerDoc,</span>
                                                         &quot;DigestValue&quot;,
                                                         XMLSignature.XMLNS,
                                                         dsPrefix);
<span class="nc bnc" id="L349" title="All 2 branches missed.">        if (digestValue != null) {</span>
<span class="nc" id="L350">            digestValueElem.appendChild</span>
<span class="nc" id="L351">                (ownerDoc.createTextNode(Base64.encode(digestValue)));</span>
        }
<span class="nc" id="L353">        refElem.appendChild(digestValueElem);</span>

<span class="nc" id="L355">        parent.appendChild(refElem);</span>
<span class="nc" id="L356">        here = refElem.getAttributeNodeNS(null, &quot;URI&quot;);</span>
<span class="nc" id="L357">    }</span>

    public void digest(XMLSignContext signContext)
        throws XMLSignatureException
    {
<span class="nc" id="L362">        Data data = null;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (appliedTransformData == null) {</span>
<span class="nc" id="L364">            data = dereference(signContext);</span>
        } else {
<span class="nc" id="L366">            data = appliedTransformData;</span>
        }
<span class="nc" id="L368">        digestValue = transform(data, signContext);</span>

        // insert digestValue into DigestValue element
<span class="nc" id="L371">        String encodedDV = Base64.encode(digestValue);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L373">            log.log(java.util.logging.Level.FINE, &quot;Reference object uri = &quot; + uri);</span>
        }
<span class="nc" id="L375">        Element digestElem = DOMUtils.getLastChildElement(refElem);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (digestElem == null) {</span>
<span class="nc" id="L377">            throw new XMLSignatureException(&quot;DigestValue element expected&quot;);</span>
        }
<span class="nc" id="L379">        DOMUtils.removeAllChildren(digestElem);</span>
<span class="nc" id="L380">        digestElem.appendChild</span>
<span class="nc" id="L381">            (refElem.getOwnerDocument().createTextNode(encodedDV));</span>

<span class="nc" id="L383">        digested = true;</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L385">            log.log(java.util.logging.Level.FINE, &quot;Reference digesting completed&quot;);</span>
        }
<span class="nc" id="L387">    }</span>

    public boolean validate(XMLValidateContext validateContext)
        throws XMLSignatureException
    {
<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (validateContext == null) {</span>
<span class="nc" id="L393">            throw new NullPointerException(&quot;validateContext cannot be null&quot;);</span>
        }
<span class="nc bnc" id="L395" title="All 2 branches missed.">        if (validated) {</span>
<span class="nc" id="L396">            return validationStatus;</span>
        }
<span class="nc" id="L398">        Data data = dereference(validateContext);</span>
<span class="nc" id="L399">        calcDigestValue = transform(data, validateContext);</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L402">            log.log(java.util.logging.Level.FINE, &quot;Expected digest: &quot; + Base64.encode(digestValue));</span>
<span class="nc" id="L403">            log.log(java.util.logging.Level.FINE, &quot;Actual digest: &quot; + Base64.encode(calcDigestValue));</span>
        }

<span class="nc" id="L406">        validationStatus = Arrays.equals(digestValue, calcDigestValue);</span>
<span class="nc" id="L407">        validated = true;</span>
<span class="nc" id="L408">        return validationStatus;</span>
    }

    public Data getDereferencedData() {
<span class="nc" id="L412">        return derefData;</span>
    }

    public InputStream getDigestInputStream() {
<span class="nc" id="L416">        return dis;</span>
    }

    private Data dereference(XMLCryptoContext context)
        throws XMLSignatureException
    {
<span class="nc" id="L422">        Data data = null;</span>

        // use user-specified URIDereferencer if specified; otherwise use deflt
<span class="nc" id="L425">        URIDereferencer deref = context.getURIDereferencer();</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (deref == null) {</span>
<span class="nc" id="L427">            deref = DOMURIDereferencer.INSTANCE;</span>
        }
        try {
<span class="nc" id="L430">            data = deref.dereference(this, context);</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L432">                log.log(java.util.logging.Level.FINE, &quot;URIDereferencer class name: &quot; + deref.getClass().getName());</span>
<span class="nc" id="L433">                log.log(java.util.logging.Level.FINE, &quot;Data class name: &quot; + data.getClass().getName());</span>
            }
<span class="nc" id="L435">        } catch (URIReferenceException ure) {</span>
<span class="nc" id="L436">            throw new XMLSignatureException(ure);</span>
<span class="nc" id="L437">        }</span>

<span class="nc" id="L439">        return data;</span>
    }

    private byte[] transform(Data dereferencedData,
                             XMLCryptoContext context)
        throws XMLSignatureException
    {
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if (md == null) {</span>
            try {
<span class="nc" id="L448">                md = MessageDigest.getInstance</span>
<span class="nc" id="L449">                    (((DOMDigestMethod)digestMethod).getMessageDigestAlgorithm());</span>
<span class="nc" id="L450">            } catch (NoSuchAlgorithmException nsae) {</span>
<span class="nc" id="L451">                throw new XMLSignatureException(nsae);</span>
<span class="nc" id="L452">            }</span>
        }
<span class="nc" id="L454">        md.reset();</span>
        DigesterOutputStream dos;
<span class="nc" id="L456">        Boolean cache = (Boolean)</span>
<span class="nc" id="L457">            context.getProperty(&quot;javax.xml.crypto.dsig.cacheReference&quot;);</span>
<span class="nc bnc" id="L458" title="All 4 branches missed.">        if (cache != null &amp;&amp; cache.booleanValue()) {</span>
<span class="nc" id="L459">            this.derefData = copyDerefData(dereferencedData);</span>
<span class="nc" id="L460">            dos = new DigesterOutputStream(md, true);</span>
        } else {
<span class="nc" id="L462">            dos = new DigesterOutputStream(md);</span>
        }
<span class="nc" id="L464">        OutputStream os = null;</span>
<span class="nc" id="L465">        Data data = dereferencedData;</span>
        try {
<span class="nc" id="L467">            os = new UnsyncBufferedOutputStream(dos);</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">            for (int i = 0, size = transforms.size(); i &lt; size; i++) {</span>
<span class="nc" id="L469">                DOMTransform transform = (DOMTransform)transforms.get(i);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">                if (i &lt; size - 1) {</span>
<span class="nc" id="L471">                    data = transform.transform(data, context);</span>
                } else {
<span class="nc" id="L473">                    data = transform.transform(data, context, os);</span>
                }
            }

<span class="nc bnc" id="L477" title="All 2 branches missed.">            if (data != null) {</span>
                XMLSignatureInput xi;
                // explicitly use C14N 1.1 when generating signature
                // first check system property, then context property
<span class="nc" id="L481">                boolean c14n11 = useC14N11;</span>
<span class="nc" id="L482">                String c14nalg = CanonicalizationMethod.INCLUSIVE;</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">                if (context instanceof XMLSignContext) {</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">                    if (!c14n11) {</span>
<span class="nc" id="L485">                        Boolean prop = (Boolean)context.getProperty</span>
<span class="nc" id="L486">                            (&quot;com.sun.org.apache.xml.internal.security.useC14N11&quot;);</span>
<span class="nc bnc" id="L487" title="All 4 branches missed.">                        c14n11 = (prop != null &amp;&amp; prop.booleanValue());</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">                        if (c14n11) {</span>
<span class="nc" id="L489">                            c14nalg = &quot;http://www.w3.org/2006/12/xml-c14n11&quot;;</span>
                        }
<span class="nc" id="L491">                    } else {</span>
<span class="nc" id="L492">                        c14nalg = &quot;http://www.w3.org/2006/12/xml-c14n11&quot;;</span>
                    }
                }
<span class="nc bnc" id="L495" title="All 2 branches missed.">                if (data instanceof ApacheData) {</span>
<span class="nc" id="L496">                    xi = ((ApacheData)data).getXMLSignatureInput();</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                } else if (data instanceof OctetStreamData) {</span>
<span class="nc" id="L498">                    xi = new XMLSignatureInput</span>
<span class="nc" id="L499">                        (((OctetStreamData)data).getOctetStream());</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">                } else if (data instanceof NodeSetData) {</span>
<span class="nc" id="L501">                    TransformService spi = null;</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">                    if (provider == null) {</span>
<span class="nc" id="L503">                        spi = TransformService.getInstance(c14nalg, &quot;DOM&quot;);</span>
                    } else {
                        try {
<span class="nc" id="L506">                            spi = TransformService.getInstance(c14nalg, &quot;DOM&quot;, provider);</span>
<span class="nc" id="L507">                        } catch (NoSuchAlgorithmException nsae) {</span>
<span class="nc" id="L508">                            spi = TransformService.getInstance(c14nalg, &quot;DOM&quot;);</span>
<span class="nc" id="L509">                        }</span>
                    }
<span class="nc" id="L511">                    data = spi.transform(data, context);</span>
<span class="nc" id="L512">                    xi = new XMLSignatureInput</span>
<span class="nc" id="L513">                        (((OctetStreamData)data).getOctetStream());</span>
<span class="nc" id="L514">                } else {</span>
<span class="nc" id="L515">                    throw new XMLSignatureException(&quot;unrecognized Data type&quot;);</span>
                }
<span class="nc bnc" id="L517" title="All 4 branches missed.">                if (context instanceof XMLSignContext &amp;&amp; c14n11</span>
<span class="nc bnc" id="L518" title="All 4 branches missed.">                    &amp;&amp; !xi.isOctetStream() &amp;&amp; !xi.isOutputStreamSet()) {</span>
<span class="nc" id="L519">                    TransformService spi = null;</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">                    if (provider == null) {</span>
<span class="nc" id="L521">                        spi = TransformService.getInstance(c14nalg, &quot;DOM&quot;);</span>
                    } else {
                        try {
<span class="nc" id="L524">                            spi = TransformService.getInstance(c14nalg, &quot;DOM&quot;, provider);</span>
<span class="nc" id="L525">                        } catch (NoSuchAlgorithmException nsae) {</span>
<span class="nc" id="L526">                            spi = TransformService.getInstance(c14nalg, &quot;DOM&quot;);</span>
<span class="nc" id="L527">                        }</span>
                    }

<span class="nc" id="L530">                    DOMTransform t = new DOMTransform(spi);</span>
<span class="nc" id="L531">                    Element transformsElem = null;</span>
<span class="nc" id="L532">                    String dsPrefix = DOMUtils.getSignaturePrefix(context);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">                    if (allTransforms.isEmpty()) {</span>
<span class="nc" id="L534">                        transformsElem = DOMUtils.createElement(</span>
<span class="nc" id="L535">                            refElem.getOwnerDocument(),</span>
                            &quot;Transforms&quot;, XMLSignature.XMLNS, dsPrefix);
<span class="nc" id="L537">                        refElem.insertBefore(transformsElem,</span>
<span class="nc" id="L538">                            DOMUtils.getFirstChildElement(refElem));</span>
                    } else {
<span class="nc" id="L540">                        transformsElem = DOMUtils.getFirstChildElement(refElem);</span>
                    }
<span class="nc" id="L542">                    t.marshal(transformsElem, dsPrefix,</span>
                              (DOMCryptoContext)context);
<span class="nc" id="L544">                    allTransforms.add(t);</span>
<span class="nc" id="L545">                    xi.updateOutputStream(os, true);</span>
<span class="nc" id="L546">                } else {</span>
<span class="nc" id="L547">                    xi.updateOutputStream(os);</span>
                }
            }
<span class="nc" id="L550">            os.flush();</span>
<span class="nc bnc" id="L551" title="All 4 branches missed.">            if (cache != null &amp;&amp; cache.booleanValue()) {</span>
<span class="nc" id="L552">                this.dis = dos.getInputStream();</span>
            }
<span class="nc" id="L554">            return dos.getDigestValue();</span>
<span class="nc" id="L555">        } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L556">            throw new XMLSignatureException(e);</span>
<span class="nc" id="L557">        } catch (TransformException e) {</span>
<span class="nc" id="L558">            throw new XMLSignatureException(e);</span>
<span class="nc" id="L559">        } catch (MarshalException e) {</span>
<span class="nc" id="L560">            throw new XMLSignatureException(e);</span>
<span class="nc" id="L561">        } catch (IOException e) {</span>
<span class="nc" id="L562">            throw new XMLSignatureException(e);</span>
<span class="nc" id="L563">        } catch (com.sun.org.apache.xml.internal.security.c14n.CanonicalizationException e) {</span>
<span class="nc" id="L564">            throw new XMLSignatureException(e);</span>
        } finally {
<span class="nc bnc" id="L566" title="All 4 branches missed.">            if (os != null) {</span>
                try {
<span class="nc" id="L568">                    os.close();</span>
<span class="nc" id="L569">                } catch (IOException e) {</span>
<span class="nc" id="L570">                    throw new XMLSignatureException(e);</span>
<span class="nc" id="L571">                }</span>
            }
<span class="nc bnc" id="L573" title="All 4 branches missed.">            if (dos != null) {</span>
                try {
<span class="nc" id="L575">                    dos.close();</span>
<span class="nc" id="L576">                } catch (IOException e) {</span>
<span class="nc" id="L577">                    throw new XMLSignatureException(e);</span>
<span class="nc" id="L578">                }</span>
            }
        }
    }

    public Node getHere() {
<span class="nc" id="L584">        return here;</span>
    }

    @Override
    public boolean equals(Object o) {
<span class="nc bnc" id="L589" title="All 2 branches missed.">        if (this == o) {</span>
<span class="nc" id="L590">            return true;</span>
        }

<span class="nc bnc" id="L593" title="All 2 branches missed.">        if (!(o instanceof Reference)) {</span>
<span class="nc" id="L594">            return false;</span>
        }
<span class="nc" id="L596">        Reference oref = (Reference)o;</span>

<span class="nc bnc" id="L598" title="All 4 branches missed.">        boolean idsEqual = (id == null ? oref.getId() == null</span>
<span class="nc" id="L599">                                       : id.equals(oref.getId()));</span>
<span class="nc bnc" id="L600" title="All 4 branches missed.">        boolean urisEqual = (uri == null ? oref.getURI() == null</span>
<span class="nc" id="L601">                                         : uri.equals(oref.getURI()));</span>
<span class="nc bnc" id="L602" title="All 4 branches missed.">        boolean typesEqual = (type == null ? oref.getType() == null</span>
<span class="nc" id="L603">                                           : type.equals(oref.getType()));</span>
<span class="nc" id="L604">        boolean digestValuesEqual =</span>
<span class="nc" id="L605">            Arrays.equals(digestValue, oref.getDigestValue());</span>

<span class="nc bnc" id="L607" title="All 8 branches missed.">        return digestMethod.equals(oref.getDigestMethod()) &amp;&amp; idsEqual &amp;&amp;</span>
            urisEqual &amp;&amp; typesEqual &amp;&amp;
<span class="nc bnc" id="L609" title="All 4 branches missed.">            allTransforms.equals(oref.getTransforms()) &amp;&amp; digestValuesEqual;</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L614">        int result = 17;</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">        if (id != null) {</span>
<span class="nc" id="L616">            result = 31 * result + id.hashCode();</span>
        }
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (uri != null) {</span>
<span class="nc" id="L619">            result = 31 * result + uri.hashCode();</span>
        }
<span class="nc bnc" id="L621" title="All 2 branches missed.">        if (type != null) {</span>
<span class="nc" id="L622">            result = 31 * result + type.hashCode();</span>
        }
<span class="nc bnc" id="L624" title="All 2 branches missed.">        if (digestValue != null) {</span>
<span class="nc" id="L625">            result = 31 * result + Arrays.hashCode(digestValue);</span>
        }
<span class="nc" id="L627">        result = 31 * result + digestMethod.hashCode();</span>
<span class="nc" id="L628">        result = 31 * result + allTransforms.hashCode();</span>

<span class="nc" id="L630">        return result;</span>
    }

    boolean isDigested() {
<span class="nc" id="L634">        return digested;</span>
    }

    private static Data copyDerefData(Data dereferencedData) {
<span class="nc bnc" id="L638" title="All 2 branches missed.">        if (dereferencedData instanceof ApacheData) {</span>
            // need to make a copy of the Data
<span class="nc" id="L640">            ApacheData ad = (ApacheData)dereferencedData;</span>
<span class="nc" id="L641">            XMLSignatureInput xsi = ad.getXMLSignatureInput();</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">            if (xsi.isNodeSet()) {</span>
                try {
<span class="nc" id="L644">                    final Set&lt;Node&gt; s = xsi.getNodeSet();</span>
<span class="nc" id="L645">                    return new NodeSetData() {</span>
<span class="nc" id="L646">                        public Iterator iterator() { return s.iterator(); }</span>
                    };
<span class="nc" id="L648">                } catch (Exception e) {</span>
                    // log a warning
<span class="nc" id="L650">                    log.log(java.util.logging.Level.WARNING, &quot;cannot cache dereferenced data: &quot; + e);</span>
<span class="nc" id="L651">                    return null;</span>
                }
<span class="nc bnc" id="L653" title="All 2 branches missed.">            } else if (xsi.isElement()) {</span>
<span class="nc" id="L654">                return new DOMSubTreeData</span>
<span class="nc" id="L655">                    (xsi.getSubNode(), xsi.isExcludeComments());</span>
<span class="nc bnc" id="L656" title="All 4 branches missed.">            } else if (xsi.isOctetStream() || xsi.isByteArray()) {</span>
                try {
<span class="nc" id="L658">                    return new OctetStreamData</span>
<span class="nc" id="L659">                        (xsi.getOctetStream(), xsi.getSourceURI(),</span>
<span class="nc" id="L660">                         xsi.getMIMEType());</span>
<span class="nc" id="L661">                } catch (IOException ioe) {</span>
                    // log a warning
<span class="nc" id="L663">                    log.log(java.util.logging.Level.WARNING, &quot;cannot cache dereferenced data: &quot; + ioe);</span>
<span class="nc" id="L664">                    return null;</span>
                }
            }
        }
<span class="nc" id="L668">        return dereferencedData;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>