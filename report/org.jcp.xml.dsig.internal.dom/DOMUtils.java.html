<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>DOMUtils.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">org.jcp.xml.dsig.internal.dom</a> &gt; <span class="el_source">DOMUtils.java</span></div><h1>DOMUtils.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
/*
 * Copyright (c) 2005, 2008, Oracle and/or its affiliates. All rights reserved.
 */
/*
 * $Id: DOMUtils.java 1333415 2012-05-03 12:03:51Z coheigea $
 */
package org.jcp.xml.dsig.internal.dom;

import java.util.*;
import java.security.spec.AlgorithmParameterSpec;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import javax.xml.crypto.*;
import javax.xml.crypto.dsig.*;
import javax.xml.crypto.dsig.spec.*;

/**
 * Useful static DOM utility methods.
 *
 * @author Sean Mullan
 */
public class DOMUtils {

    // class cannot be instantiated
<span class="nc" id="L50">    private DOMUtils() {}</span>

    /**
     * Returns the owner document of the specified node.
     *
     * @param node the node
     * @return the owner document
     */
    public static Document getOwnerDocument(Node node) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (node.getNodeType() == Node.DOCUMENT_NODE) {</span>
<span class="nc" id="L60">            return (Document)node;</span>
        } else {
<span class="nc" id="L62">            return node.getOwnerDocument();</span>
        }
    }

    /**
     * Creates an element in the specified namespace, with the specified tag
     * and namespace prefix.
     *
     * @param doc the owner document
     * @param tag the tag
     * @param nsURI the namespace URI
     * @param prefix the namespace prefix
     * @return the newly created element
     */
    public static Element createElement(Document doc, String tag,
                                        String nsURI, String prefix)
    {
<span class="nc bnc" id="L79" title="All 4 branches missed.">        String qName = (prefix == null || prefix.length() == 0)</span>
                       ? tag : prefix + &quot;:&quot; + tag;
<span class="nc" id="L81">        return doc.createElementNS(nsURI, qName);</span>
    }

    /**
     * Sets an element's attribute (using DOM level 2) with the
     * specified value and namespace prefix.
     *
     * @param elem the element to set the attribute on
     * @param name the name of the attribute
     * @param value the attribute value. If null, no attribute is set.
     */
    public static void setAttribute(Element elem, String name, String value) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L94">            return;</span>
        }
<span class="nc" id="L96">        elem.setAttributeNS(null, name, value);</span>
<span class="nc" id="L97">    }</span>

    /**
     * Sets an element's attribute (using DOM level 2) with the
     * specified value and namespace prefix AND registers the ID value with
     * the specified element. This is for resolving same-document
     * ID references.
     *
     * @param elem the element to set the attribute on
     * @param name the name of the attribute
     * @param value the attribute value. If null, no attribute is set.
     */
    public static void setAttributeID(Element elem, String name, String value) {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L111">            return;</span>
        }
<span class="nc" id="L113">        elem.setAttributeNS(null, name, value);</span>
<span class="nc" id="L114">        elem.setIdAttributeNS(null, name, true);</span>
<span class="nc" id="L115">    }</span>

    /**
     * Returns the first child element of the specified node, or null if there
     * is no such element.
     *
     * @param node the node
     * @return the first child element of the specified node, or null if there
     *    is no such element
     * @throws NullPointerException if &lt;code&gt;node == null&lt;/code&gt;
     */
    public static Element getFirstChildElement(Node node) {
<span class="nc" id="L127">        Node child = node.getFirstChild();</span>
<span class="nc bnc" id="L128" title="All 4 branches missed.">        while (child != null &amp;&amp; child.getNodeType() != Node.ELEMENT_NODE) {</span>
<span class="nc" id="L129">            child = child.getNextSibling();</span>
        }
<span class="nc" id="L131">        return (Element)child;</span>
    }

    /**
     * Returns the first child element of the specified node and checks that
     * the local name is equal to {@code localName}.
     *
     * @param node the node
     * @return the first child element of the specified node
     * @throws NullPointerException if {@code node == null}
     * @throws MarshalException if no such element or the local name is not
     *    equal to {@code localName}
     */
    public static Element getFirstChildElement(Node node, String localName)
        throws MarshalException
    {
<span class="nc" id="L147">        return verifyElement(getFirstChildElement(node), localName);</span>
    }

    private static Element verifyElement(Element elem, String localName)
        throws MarshalException
    {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (elem == null) {</span>
<span class="nc" id="L154">            throw new MarshalException(&quot;Missing &quot; + localName + &quot; element&quot;);</span>
        }
<span class="nc" id="L156">        String name = elem.getLocalName();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!name.equals(localName)) {</span>
<span class="nc" id="L158">            throw new MarshalException(&quot;Invalid element name: &quot; +</span>
                                       name + &quot;, expected &quot; + localName);
        }
<span class="nc" id="L161">        return elem;</span>
    }

    /**
     * Returns the last child element of the specified node, or null if there
     * is no such element.
     *
     * @param node the node
     * @return the last child element of the specified node, or null if there
     *    is no such element
     * @throws NullPointerException if &lt;code&gt;node == null&lt;/code&gt;
     */
    public static Element getLastChildElement(Node node) {
<span class="nc" id="L174">        Node child = node.getLastChild();</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">        while (child != null &amp;&amp; child.getNodeType() != Node.ELEMENT_NODE) {</span>
<span class="nc" id="L176">            child = child.getPreviousSibling();</span>
        }
<span class="nc" id="L178">        return (Element)child;</span>
    }

    /**
     * Returns the next sibling element of the specified node, or null if there
     * is no such element.
     *
     * @param node the node
     * @return the next sibling element of the specified node, or null if there
     *    is no such element
     * @throws NullPointerException if &lt;code&gt;node == null&lt;/code&gt;
     */
    public static Element getNextSiblingElement(Node node) {
<span class="nc" id="L191">        Node sibling = node.getNextSibling();</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">        while (sibling != null &amp;&amp; sibling.getNodeType() != Node.ELEMENT_NODE) {</span>
<span class="nc" id="L193">            sibling = sibling.getNextSibling();</span>
        }
<span class="nc" id="L195">        return (Element)sibling;</span>
    }

    /**
     * Returns the next sibling element of the specified node and checks that
     * the local name is equal to {@code localName}.
     *
     * @param node the node
     * @return the next sibling element of the specified node
     * @throws NullPointerException if {@code node == null}
     * @throws MarshalException if no such element or the local name is not
     *    equal to {@code localName}
     */
    public static Element getNextSiblingElement(Node node, String localName)
        throws MarshalException
    {
<span class="nc" id="L211">        return verifyElement(getNextSiblingElement(node), localName);</span>
    }

    /**
     * Returns the attribute value for the attribute with the specified name.
     * Returns null if there is no such attribute, or
     * the empty string if the attribute value is empty.
     *
     * &lt;p&gt;This works around a limitation of the DOM
     * &lt;code&gt;Element.getAttributeNode&lt;/code&gt; method, which does not distinguish
     * between an unspecified attribute and an attribute with a value of
     * &quot;&quot; (it returns &quot;&quot; for both cases).
     *
     * @param elem the element containing the attribute
     * @param name the name of the attribute
     * @return the attribute value (may be null if unspecified)
     */
    public static String getAttributeValue(Element elem, String name) {
<span class="nc" id="L229">        Attr attr = elem.getAttributeNodeNS(null, name);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        return (attr == null) ? null : attr.getValue();</span>
    }

    /**
     * Returns a Set of &lt;code&gt;Node&lt;/code&gt;s, backed by the specified
     * &lt;code&gt;NodeList&lt;/code&gt;.
     *
     * @param nl the NodeList
     * @return a Set of Nodes
     */
    public static Set&lt;Node&gt; nodeSet(NodeList nl) {
<span class="nc" id="L241">        return new NodeSet(nl);</span>
    }

    static class NodeSet extends AbstractSet&lt;Node&gt; {
        private NodeList nl;
<span class="nc" id="L246">        public NodeSet(NodeList nl) {</span>
<span class="nc" id="L247">            this.nl = nl;</span>
<span class="nc" id="L248">        }</span>

<span class="nc" id="L250">        public int size() { return nl.getLength(); }</span>
        public Iterator&lt;Node&gt; iterator() {
<span class="nc" id="L252">            return new Iterator&lt;Node&gt;() {</span>
<span class="nc" id="L253">                int index = 0;</span>

                public void remove() {
<span class="nc" id="L256">                    throw new UnsupportedOperationException();</span>
                }
                public Node next() {
<span class="nc bnc" id="L259" title="All 2 branches missed.">                    if (!hasNext()) {</span>
<span class="nc" id="L260">                        throw new NoSuchElementException();</span>
                    }
<span class="nc" id="L262">                    return nl.item(index++);</span>
                }
                public boolean hasNext() {
<span class="nc bnc" id="L265" title="All 2 branches missed.">                    return index &lt; nl.getLength() ? true : false;</span>
                }
            };
        }
    }

    /**
     * Returns the prefix associated with the specified namespace URI
     *
     * @param context contains the namespace map
     * @param nsURI the namespace URI
     * @return the prefix associated with the specified namespace URI, or
     *    null if not set
     */
    public static String getNSPrefix(XMLCryptoContext context, String nsURI) {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (context != null) {</span>
<span class="nc" id="L281">            return context.getNamespacePrefix</span>
<span class="nc" id="L282">                (nsURI, context.getDefaultNamespacePrefix());</span>
        } else {
<span class="nc" id="L284">            return null;</span>
        }
    }

    /**
     * Returns the prefix associated with the XML Signature namespace URI
     *
     * @param context contains the namespace map
     * @return the prefix associated with the specified namespace URI, or
     *    null if not set
     */
    public static String getSignaturePrefix(XMLCryptoContext context) {
<span class="nc" id="L296">        return getNSPrefix(context, XMLSignature.XMLNS);</span>
    }

    /**
     * Removes all children nodes from the specified node.
     *
     * @param node the parent node whose children are to be removed
     */
    public static void removeAllChildren(Node node) {
<span class="nc" id="L305">        NodeList children = node.getChildNodes();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">        for (int i = 0, length = children.getLength(); i &lt; length; i++) {</span>
<span class="nc" id="L307">            node.removeChild(children.item(i));</span>
        }
<span class="nc" id="L309">    }</span>

    /**
     * Compares 2 nodes for equality. Implementation is not complete.
     */
    public static boolean nodesEqual(Node thisNode, Node otherNode) {
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (thisNode == otherNode) {</span>
<span class="nc" id="L316">            return true;</span>
        }
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (thisNode.getNodeType() != otherNode.getNodeType()) {</span>
<span class="nc" id="L319">            return false;</span>
        }
        // FIXME - test content, etc
<span class="nc" id="L322">        return true;</span>
    }

    /**
     * Checks if child element has same owner document before
     * appending to the parent, and imports it to the parent's document
     * if necessary.
     */
    public static void appendChild(Node parent, Node child) {
<span class="nc" id="L331">        Document ownerDoc = getOwnerDocument(parent);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (child.getOwnerDocument() != ownerDoc) {</span>
<span class="nc" id="L333">            parent.appendChild(ownerDoc.importNode(child, true));</span>
        } else {
<span class="nc" id="L335">            parent.appendChild(child);</span>
        }
<span class="nc" id="L337">    }</span>

    public static boolean paramsEqual(AlgorithmParameterSpec spec1,
        AlgorithmParameterSpec spec2) {
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (spec1 == spec2) {</span>
<span class="nc" id="L342">            return true;</span>
        }
<span class="nc bnc" id="L344" title="All 4 branches missed.">        if (spec1 instanceof XPathFilter2ParameterSpec &amp;&amp;</span>
            spec2 instanceof XPathFilter2ParameterSpec) {
<span class="nc" id="L346">            return paramsEqual((XPathFilter2ParameterSpec)spec1,</span>
                               (XPathFilter2ParameterSpec)spec2);
        }
<span class="nc bnc" id="L349" title="All 4 branches missed.">        if (spec1 instanceof ExcC14NParameterSpec &amp;&amp;</span>
            spec2 instanceof ExcC14NParameterSpec) {
<span class="nc" id="L351">            return paramsEqual((ExcC14NParameterSpec) spec1,</span>
                               (ExcC14NParameterSpec)spec2);
        }
<span class="nc bnc" id="L354" title="All 4 branches missed.">        if (spec1 instanceof XPathFilterParameterSpec &amp;&amp;</span>
            spec2 instanceof XPathFilterParameterSpec) {
<span class="nc" id="L356">            return paramsEqual((XPathFilterParameterSpec)spec1,</span>
                               (XPathFilterParameterSpec)spec2);
        }
<span class="nc bnc" id="L359" title="All 4 branches missed.">        if (spec1 instanceof XSLTTransformParameterSpec &amp;&amp;</span>
            spec2 instanceof XSLTTransformParameterSpec) {
<span class="nc" id="L361">            return paramsEqual((XSLTTransformParameterSpec)spec1,</span>
                               (XSLTTransformParameterSpec)spec2);
        }
<span class="nc" id="L364">        return false;</span>
    }

    private static boolean paramsEqual(XPathFilter2ParameterSpec spec1,
                                       XPathFilter2ParameterSpec spec2)
    {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L371">        List&lt;XPathType&gt; types = spec1.getXPathList();</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L373">        List&lt;XPathType&gt; otypes = spec2.getXPathList();</span>
<span class="nc" id="L374">        int size = types.size();</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (size != otypes.size()) {</span>
<span class="nc" id="L376">            return false;</span>
        }
<span class="nc bnc" id="L378" title="All 2 branches missed.">        for (int i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L379">            XPathType type = types.get(i);</span>
<span class="nc" id="L380">            XPathType otype = otypes.get(i);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            if (!type.getExpression().equals(otype.getExpression()) ||</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                !type.getNamespaceMap().equals(otype.getNamespaceMap()) ||</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">                type.getFilter() != otype.getFilter()) {</span>
<span class="nc" id="L384">                return false;</span>
            }
        }
<span class="nc" id="L387">        return true;</span>
    }

    private static boolean paramsEqual(ExcC14NParameterSpec spec1,
                                       ExcC14NParameterSpec spec2)
    {
<span class="nc" id="L393">        return spec1.getPrefixList().equals(spec2.getPrefixList());</span>
    }

    private static boolean paramsEqual(XPathFilterParameterSpec spec1,
                                       XPathFilterParameterSpec spec2)
    {
<span class="nc bnc" id="L399" title="All 2 branches missed.">        return (spec1.getXPath().equals(spec2.getXPath()) &amp;&amp;</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">                spec1.getNamespaceMap().equals(spec2.getNamespaceMap()));</span>
    }

    private static boolean paramsEqual(XSLTTransformParameterSpec spec1,
                                       XSLTTransformParameterSpec spec2)
    {

<span class="nc" id="L407">        XMLStructure ostylesheet = spec2.getStylesheet();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (!(ostylesheet instanceof javax.xml.crypto.dom.DOMStructure)) {</span>
<span class="nc" id="L409">            return false;</span>
        }
<span class="nc" id="L411">        Node ostylesheetElem =</span>
<span class="nc" id="L412">            ((javax.xml.crypto.dom.DOMStructure) ostylesheet).getNode();</span>
<span class="nc" id="L413">        XMLStructure stylesheet = spec1.getStylesheet();</span>
<span class="nc" id="L414">        Node stylesheetElem =</span>
<span class="nc" id="L415">            ((javax.xml.crypto.dom.DOMStructure) stylesheet).getNode();</span>
<span class="nc" id="L416">        return nodesEqual(stylesheetElem, ostylesheetElem);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>