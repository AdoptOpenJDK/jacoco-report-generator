<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DOMKeyValue.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">org.jcp.xml.dsig.internal.dom</a> &gt; <span class="el_source">DOMKeyValue.java</span></div><h1>DOMKeyValue.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
/*
 * Copyright (c) 2005, 2008, Oracle and/or its affiliates. All rights reserved.
 */
/*
 * $Id: DOMKeyValue.java 1333415 2012-05-03 12:03:51Z coheigea $
 */
package org.jcp.xml.dsig.internal.dom;

import javax.xml.crypto.*;
import javax.xml.crypto.dom.DOMCryptoContext;
import javax.xml.crypto.dsig.*;
import javax.xml.crypto.dsig.keyinfo.KeyValue;

// import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.security.AccessController;
import java.security.KeyException;
import java.security.KeyFactory;
import java.security.NoSuchAlgorithmException;
import java.security.PrivilegedActionException;
import java.security.PrivilegedExceptionAction;
import java.security.PublicKey;
import java.security.interfaces.DSAParams;
import java.security.interfaces.DSAPublicKey;
import java.security.interfaces.ECPublicKey;
import java.security.interfaces.RSAPublicKey;
import java.security.spec.DSAPublicKeySpec;
import java.security.spec.ECParameterSpec;
import java.security.spec.ECPoint;
import java.security.spec.ECPublicKeySpec;
import java.security.spec.EllipticCurve;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.KeySpec;
import java.security.spec.RSAPublicKeySpec;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;

import com.sun.org.apache.xml.internal.security.exceptions.Base64DecodingException;
import com.sun.org.apache.xml.internal.security.utils.Base64;

/**
 * DOM-based implementation of KeyValue.
 *
 * @author Sean Mullan
 */
public abstract class DOMKeyValue extends DOMStructure implements KeyValue {

    private static final String XMLDSIG_11_XMLNS
        = &quot;http://www.w3.org/2009/xmldsig11#&quot;;
    private final PublicKey publicKey;

<span class="nc" id="L76">    public DOMKeyValue(PublicKey key) throws KeyException {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (key == null) {</span>
<span class="nc" id="L78">            throw new NullPointerException(&quot;key cannot be null&quot;);</span>
        }
<span class="nc" id="L80">        this.publicKey = key;</span>
<span class="nc" id="L81">    }</span>

    /**
     * Creates a &lt;code&gt;DOMKeyValue&lt;/code&gt; from an element.
     *
     * @param kvtElem a KeyValue child element
     */
<span class="nc" id="L88">    public DOMKeyValue(Element kvtElem) throws MarshalException {</span>
<span class="nc" id="L89">        this.publicKey = unmarshalKeyValue(kvtElem);</span>
<span class="nc" id="L90">    }</span>

    static KeyValue unmarshal(Element kvElem) throws MarshalException {
<span class="nc" id="L93">        Element kvtElem = DOMUtils.getFirstChildElement(kvElem);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (kvtElem.getLocalName().equals(&quot;DSAKeyValue&quot;)) {</span>
<span class="nc" id="L95">            return new DSA(kvtElem);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        } else if (kvtElem.getLocalName().equals(&quot;RSAKeyValue&quot;)) {</span>
<span class="nc" id="L97">            return new RSA(kvtElem);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        } else if (kvtElem.getLocalName().equals(&quot;ECKeyValue&quot;)) {</span>
<span class="nc" id="L99">            return new EC(kvtElem);</span>
        } else {
<span class="nc" id="L101">            return new Unknown(kvtElem);</span>
        }
    }

    public PublicKey getPublicKey() throws KeyException {
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (publicKey == null) {</span>
<span class="nc" id="L107">            throw new KeyException(&quot;can't convert KeyValue to PublicKey&quot;);</span>
        } else {
<span class="nc" id="L109">            return publicKey;</span>
        }
    }

    public void marshal(Node parent, String dsPrefix, DOMCryptoContext context)
        throws MarshalException
    {
<span class="nc" id="L116">        Document ownerDoc = DOMUtils.getOwnerDocument(parent);</span>

        // create KeyValue element
<span class="nc" id="L119">        Element kvElem = DOMUtils.createElement(ownerDoc, &quot;KeyValue&quot;,</span>
                                                XMLSignature.XMLNS, dsPrefix);
<span class="nc" id="L121">        marshalPublicKey(kvElem, ownerDoc, dsPrefix, context);</span>

<span class="nc" id="L123">        parent.appendChild(kvElem);</span>
<span class="nc" id="L124">    }</span>

    abstract void marshalPublicKey(Node parent, Document doc, String dsPrefix,
        DOMCryptoContext context) throws MarshalException;

    abstract PublicKey unmarshalKeyValue(Element kvtElem)
        throws MarshalException;

    private static PublicKey generatePublicKey(KeyFactory kf, KeySpec keyspec) {
        try {
<span class="nc" id="L134">            return kf.generatePublic(keyspec);</span>
<span class="nc" id="L135">        } catch (InvalidKeySpecException e) {</span>
            //@@@ should dump exception to log
<span class="nc" id="L137">            return null;</span>
        }
    }

    @Override
    public boolean equals(Object obj) {
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (this == obj) {</span>
<span class="nc" id="L144">            return true;</span>
        }
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!(obj instanceof KeyValue)) {</span>
<span class="nc" id="L147">            return false;</span>
        }
        try {
<span class="nc" id="L150">            KeyValue kv = (KeyValue)obj;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if (publicKey == null ) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                if (kv.getPublicKey() != null) {</span>
<span class="nc" id="L153">                    return false;</span>
                }
<span class="nc bnc" id="L155" title="All 2 branches missed.">            } else if (!publicKey.equals(kv.getPublicKey())) {</span>
<span class="nc" id="L156">                return false;</span>
            }
<span class="nc" id="L158">        } catch (KeyException ke) {</span>
            // no practical way to determine if the keys are equal
<span class="nc" id="L160">            return false;</span>
<span class="nc" id="L161">        }</span>

<span class="nc" id="L163">        return true;</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L168">        int result = 17;</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (publicKey != null) {</span>
<span class="nc" id="L170">            result = 31 * result + publicKey.hashCode();</span>
        }

<span class="nc" id="L173">        return result;</span>
    }

    static final class RSA extends DOMKeyValue {
        // RSAKeyValue CryptoBinaries
        private DOMCryptoBinary modulus, exponent;
        private KeyFactory rsakf;

        RSA(PublicKey key) throws KeyException {
<span class="nc" id="L182">            super(key);</span>
<span class="nc" id="L183">            RSAPublicKey rkey = (RSAPublicKey)key;</span>
<span class="nc" id="L184">            exponent = new DOMCryptoBinary(rkey.getPublicExponent());</span>
<span class="nc" id="L185">            modulus = new DOMCryptoBinary(rkey.getModulus());</span>
<span class="nc" id="L186">        }</span>

        RSA(Element elem) throws MarshalException {
<span class="nc" id="L189">            super(elem);</span>
<span class="nc" id="L190">        }</span>

        void marshalPublicKey(Node parent, Document doc, String dsPrefix,
            DOMCryptoContext context) throws MarshalException {
<span class="nc" id="L194">            Element rsaElem = DOMUtils.createElement(doc, &quot;RSAKeyValue&quot;,</span>
                                                     XMLSignature.XMLNS,
                                                     dsPrefix);
<span class="nc" id="L197">            Element modulusElem = DOMUtils.createElement(doc, &quot;Modulus&quot;,</span>
                                                         XMLSignature.XMLNS,
                                                         dsPrefix);
<span class="nc" id="L200">            Element exponentElem = DOMUtils.createElement(doc, &quot;Exponent&quot;,</span>
                                                          XMLSignature.XMLNS,
                                                          dsPrefix);
<span class="nc" id="L203">            modulus.marshal(modulusElem, dsPrefix, context);</span>
<span class="nc" id="L204">            exponent.marshal(exponentElem, dsPrefix, context);</span>
<span class="nc" id="L205">            rsaElem.appendChild(modulusElem);</span>
<span class="nc" id="L206">            rsaElem.appendChild(exponentElem);</span>
<span class="nc" id="L207">            parent.appendChild(rsaElem);</span>
<span class="nc" id="L208">        }</span>

        PublicKey unmarshalKeyValue(Element kvtElem)
            throws MarshalException
        {
<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (rsakf == null) {</span>
                try {
<span class="nc" id="L215">                    rsakf = KeyFactory.getInstance(&quot;RSA&quot;);</span>
<span class="nc" id="L216">                } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L217">                    throw new RuntimeException</span>
<span class="nc" id="L218">                        (&quot;unable to create RSA KeyFactory: &quot; + e.getMessage());</span>
<span class="nc" id="L219">                }</span>
            }
<span class="nc" id="L221">            Element modulusElem = DOMUtils.getFirstChildElement(kvtElem,</span>
                                                                &quot;Modulus&quot;);
<span class="nc" id="L223">            modulus = new DOMCryptoBinary(modulusElem.getFirstChild());</span>
<span class="nc" id="L224">            Element exponentElem = DOMUtils.getNextSiblingElement(modulusElem,</span>
                                                                  &quot;Exponent&quot;);
<span class="nc" id="L226">            exponent = new DOMCryptoBinary(exponentElem.getFirstChild());</span>
<span class="nc" id="L227">            RSAPublicKeySpec spec = new RSAPublicKeySpec(modulus.getBigNum(),</span>
<span class="nc" id="L228">                                                         exponent.getBigNum());</span>
<span class="nc" id="L229">            return generatePublicKey(rsakf, spec);</span>
        }
    }

    static final class DSA extends DOMKeyValue {
        // DSAKeyValue CryptoBinaries
        private DOMCryptoBinary p, q, g, y, j; //, seed, pgen;
        private KeyFactory dsakf;

        DSA(PublicKey key) throws KeyException {
<span class="nc" id="L239">            super(key);</span>
<span class="nc" id="L240">            DSAPublicKey dkey = (DSAPublicKey) key;</span>
<span class="nc" id="L241">            DSAParams params = dkey.getParams();</span>
<span class="nc" id="L242">            p = new DOMCryptoBinary(params.getP());</span>
<span class="nc" id="L243">            q = new DOMCryptoBinary(params.getQ());</span>
<span class="nc" id="L244">            g = new DOMCryptoBinary(params.getG());</span>
<span class="nc" id="L245">            y = new DOMCryptoBinary(dkey.getY());</span>
<span class="nc" id="L246">        }</span>

        DSA(Element elem) throws MarshalException {
<span class="nc" id="L249">            super(elem);</span>
<span class="nc" id="L250">        }</span>

        void marshalPublicKey(Node parent, Document doc, String dsPrefix,
                              DOMCryptoContext context)
            throws MarshalException
        {
<span class="nc" id="L256">            Element dsaElem = DOMUtils.createElement(doc, &quot;DSAKeyValue&quot;,</span>
                                                     XMLSignature.XMLNS,
                                                     dsPrefix);
            // parameters J, Seed &amp; PgenCounter are not included
<span class="nc" id="L260">            Element pElem = DOMUtils.createElement(doc, &quot;P&quot;, XMLSignature.XMLNS,</span>
                                                   dsPrefix);
<span class="nc" id="L262">            Element qElem = DOMUtils.createElement(doc, &quot;Q&quot;, XMLSignature.XMLNS,</span>
                                                   dsPrefix);
<span class="nc" id="L264">            Element gElem = DOMUtils.createElement(doc, &quot;G&quot;, XMLSignature.XMLNS,</span>
                                                   dsPrefix);
<span class="nc" id="L266">            Element yElem = DOMUtils.createElement(doc, &quot;Y&quot;, XMLSignature.XMLNS,</span>
                                                   dsPrefix);
<span class="nc" id="L268">            p.marshal(pElem, dsPrefix, context);</span>
<span class="nc" id="L269">            q.marshal(qElem, dsPrefix, context);</span>
<span class="nc" id="L270">            g.marshal(gElem, dsPrefix, context);</span>
<span class="nc" id="L271">            y.marshal(yElem, dsPrefix, context);</span>
<span class="nc" id="L272">            dsaElem.appendChild(pElem);</span>
<span class="nc" id="L273">            dsaElem.appendChild(qElem);</span>
<span class="nc" id="L274">            dsaElem.appendChild(gElem);</span>
<span class="nc" id="L275">            dsaElem.appendChild(yElem);</span>
<span class="nc" id="L276">            parent.appendChild(dsaElem);</span>
<span class="nc" id="L277">        }</span>

        PublicKey unmarshalKeyValue(Element kvtElem)
            throws MarshalException
        {
<span class="nc bnc" id="L282" title="All 2 branches missed.">            if (dsakf == null) {</span>
                try {
<span class="nc" id="L284">                    dsakf = KeyFactory.getInstance(&quot;DSA&quot;);</span>
<span class="nc" id="L285">                } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L286">                    throw new RuntimeException</span>
<span class="nc" id="L287">                        (&quot;unable to create DSA KeyFactory: &quot; + e.getMessage());</span>
<span class="nc" id="L288">                }</span>
            }
<span class="nc" id="L290">            Element curElem = DOMUtils.getFirstChildElement(kvtElem);</span>
            // check for P and Q
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if (curElem.getLocalName().equals(&quot;P&quot;)) {</span>
<span class="nc" id="L293">                p = new DOMCryptoBinary(curElem.getFirstChild());</span>
<span class="nc" id="L294">                curElem = DOMUtils.getNextSiblingElement(curElem, &quot;Q&quot;);</span>
<span class="nc" id="L295">                q = new DOMCryptoBinary(curElem.getFirstChild());</span>
<span class="nc" id="L296">                curElem = DOMUtils.getNextSiblingElement(curElem);</span>
            }
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (curElem.getLocalName().equals(&quot;G&quot;)) {</span>
<span class="nc" id="L299">                g = new DOMCryptoBinary(curElem.getFirstChild());</span>
<span class="nc" id="L300">                curElem = DOMUtils.getNextSiblingElement(curElem, &quot;Y&quot;);</span>
            }
<span class="nc" id="L302">            y = new DOMCryptoBinary(curElem.getFirstChild());</span>
<span class="nc" id="L303">            curElem = DOMUtils.getNextSiblingElement(curElem);</span>
<span class="nc bnc" id="L304" title="All 4 branches missed.">            if (curElem != null &amp;&amp; curElem.getLocalName().equals(&quot;J&quot;)) {</span>
<span class="nc" id="L305">                j = new DOMCryptoBinary(curElem.getFirstChild());</span>
                // curElem = DOMUtils.getNextSiblingElement(curElem);
            }
            /*
            if (curElem != null) {
                seed = new DOMCryptoBinary(curElem.getFirstChild());
                curElem = DOMUtils.getNextSiblingElement(curElem);
                pgen = new DOMCryptoBinary(curElem.getFirstChild());
            }
            */
            //@@@ do we care about j, pgenCounter or seed?
<span class="nc" id="L316">            DSAPublicKeySpec spec = new DSAPublicKeySpec(y.getBigNum(),</span>
<span class="nc" id="L317">                                                         p.getBigNum(),</span>
<span class="nc" id="L318">                                                         q.getBigNum(),</span>
<span class="nc" id="L319">                                                         g.getBigNum());</span>
<span class="nc" id="L320">            return generatePublicKey(dsakf, spec);</span>
        }
    }

    static final class EC extends DOMKeyValue {
        // ECKeyValue CryptoBinaries
        private byte[] ecPublicKey;
        private KeyFactory eckf;
        private ECParameterSpec ecParams;
        private Method encodePoint, decodePoint, getCurveName,
                       getECParameterSpec;

        EC(PublicKey key) throws KeyException {
<span class="nc" id="L333">            super(key);</span>
<span class="nc" id="L334">            ECPublicKey ecKey = (ECPublicKey)key;</span>
<span class="nc" id="L335">            ECPoint ecPoint = ecKey.getW();</span>
<span class="nc" id="L336">            ecParams = ecKey.getParams();</span>
            try {
<span class="nc" id="L338">                AccessController.doPrivileged(</span>
<span class="nc" id="L339">                    new PrivilegedExceptionAction&lt;Void&gt;() {</span>
                        public Void run() throws
                            ClassNotFoundException, NoSuchMethodException
                        {
<span class="nc" id="L343">                            getMethods();</span>
<span class="nc" id="L344">                            return null;</span>
                        }
                    }
                );
<span class="nc" id="L348">            } catch (PrivilegedActionException pae) {</span>
<span class="nc" id="L349">                throw new KeyException(&quot;ECKeyValue not supported&quot;,</span>
<span class="nc" id="L350">                                        pae.getException());</span>
<span class="nc" id="L351">            }</span>
<span class="nc" id="L352">            Object[] args = new Object[] { ecPoint, ecParams.getCurve() };</span>
            try {
<span class="nc" id="L354">                ecPublicKey = (byte[])encodePoint.invoke(null, args);</span>
<span class="nc" id="L355">            } catch (IllegalAccessException iae) {</span>
<span class="nc" id="L356">                throw new KeyException(iae);</span>
<span class="nc" id="L357">            } catch (InvocationTargetException ite) {</span>
<span class="nc" id="L358">                throw new KeyException(ite);</span>
<span class="nc" id="L359">            }</span>
<span class="nc" id="L360">        }</span>

        EC(Element dmElem) throws MarshalException {
<span class="nc" id="L363">            super(dmElem);</span>
<span class="nc" id="L364">        }</span>

        void getMethods() throws ClassNotFoundException, NoSuchMethodException {
<span class="nc" id="L367">            Class c  = Class.forName(&quot;sun.security.ec.ECParameters&quot;);</span>
<span class="nc" id="L368">            Class[] params = new Class[] { ECPoint.class, EllipticCurve.class };</span>
<span class="nc" id="L369">            encodePoint = c.getMethod(&quot;encodePoint&quot;, params);</span>
<span class="nc" id="L370">            params = new Class[] { ECParameterSpec.class };</span>
<span class="nc" id="L371">            getCurveName = c.getMethod(&quot;getCurveName&quot;, params);</span>
<span class="nc" id="L372">            params = new Class[] { byte[].class, EllipticCurve.class };</span>
<span class="nc" id="L373">            decodePoint = c.getMethod(&quot;decodePoint&quot;, params);</span>
<span class="nc" id="L374">            c  = Class.forName(&quot;sun.security.ec.NamedCurve&quot;);</span>
<span class="nc" id="L375">            params = new Class[] { String.class };</span>
<span class="nc" id="L376">            getECParameterSpec = c.getMethod(&quot;getECParameterSpec&quot;, params);</span>
<span class="nc" id="L377">        }</span>

        void marshalPublicKey(Node parent, Document doc, String dsPrefix,
                              DOMCryptoContext context)
            throws MarshalException
        {
<span class="nc" id="L383">            String prefix = DOMUtils.getNSPrefix(context, XMLDSIG_11_XMLNS);</span>
<span class="nc" id="L384">            Element ecKeyValueElem = DOMUtils.createElement(doc, &quot;ECKeyValue&quot;,</span>
                                                            XMLDSIG_11_XMLNS,
                                                            prefix);
<span class="nc" id="L387">            Element namedCurveElem = DOMUtils.createElement(doc, &quot;NamedCurve&quot;,</span>
                                                            XMLDSIG_11_XMLNS,
                                                            prefix);
<span class="nc" id="L390">            Element publicKeyElem = DOMUtils.createElement(doc, &quot;PublicKey&quot;,</span>
                                                           XMLDSIG_11_XMLNS,
                                                           prefix);
<span class="nc" id="L393">            Object[] args = new Object[] { ecParams };</span>
            try {
<span class="nc" id="L395">                String oid = (String) getCurveName.invoke(null, args);</span>
<span class="nc" id="L396">                DOMUtils.setAttribute(namedCurveElem, &quot;URI&quot;, &quot;urn:oid:&quot; + oid);</span>
<span class="nc" id="L397">            } catch (IllegalAccessException iae) {</span>
<span class="nc" id="L398">                throw new MarshalException(iae);</span>
<span class="nc" id="L399">            } catch (InvocationTargetException ite) {</span>
<span class="nc" id="L400">                throw new MarshalException(ite);</span>
<span class="nc" id="L401">            }</span>
<span class="nc bnc" id="L402" title="All 4 branches missed.">            String qname = (prefix == null || prefix.length() == 0)</span>
                       ? &quot;xmlns&quot; : &quot;xmlns:&quot; + prefix;
<span class="nc" id="L404">            namedCurveElem.setAttributeNS(&quot;http://www.w3.org/2000/xmlns/&quot;,</span>
                                          qname, XMLDSIG_11_XMLNS);
<span class="nc" id="L406">            ecKeyValueElem.appendChild(namedCurveElem);</span>
<span class="nc" id="L407">            String encoded = Base64.encode(ecPublicKey);</span>
<span class="nc" id="L408">            publicKeyElem.appendChild</span>
<span class="nc" id="L409">                (DOMUtils.getOwnerDocument(publicKeyElem).createTextNode(encoded));</span>
<span class="nc" id="L410">            ecKeyValueElem.appendChild(publicKeyElem);</span>
<span class="nc" id="L411">            parent.appendChild(ecKeyValueElem);</span>
<span class="nc" id="L412">        }</span>

        PublicKey unmarshalKeyValue(Element kvtElem)
            throws MarshalException
        {
<span class="nc bnc" id="L417" title="All 2 branches missed.">            if (eckf == null) {</span>
                try {
<span class="nc" id="L419">                    eckf = KeyFactory.getInstance(&quot;EC&quot;);</span>
<span class="nc" id="L420">                } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L421">                    throw new RuntimeException</span>
<span class="nc" id="L422">                        (&quot;unable to create EC KeyFactory: &quot; + e.getMessage());</span>
<span class="nc" id="L423">                }</span>
            }
            try {
<span class="nc" id="L426">                AccessController.doPrivileged(</span>
<span class="nc" id="L427">                    new PrivilegedExceptionAction&lt;Void&gt;() {</span>
                        public Void run() throws
                            ClassNotFoundException, NoSuchMethodException
                        {
<span class="nc" id="L431">                            getMethods();</span>
<span class="nc" id="L432">                            return null;</span>
                        }
                    }
                );
<span class="nc" id="L436">            } catch (PrivilegedActionException pae) {</span>
<span class="nc" id="L437">                throw new MarshalException(&quot;ECKeyValue not supported&quot;,</span>
<span class="nc" id="L438">                                           pae.getException());</span>
<span class="nc" id="L439">            }</span>
<span class="nc" id="L440">            ECParameterSpec ecParams = null;</span>
<span class="nc" id="L441">            Element curElem = DOMUtils.getFirstChildElement(kvtElem);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if (curElem.getLocalName().equals(&quot;ECParameters&quot;)) {</span>
<span class="nc" id="L443">                throw new UnsupportedOperationException</span>
                    (&quot;ECParameters not supported&quot;);
<span class="nc bnc" id="L445" title="All 2 branches missed.">            } else if (curElem.getLocalName().equals(&quot;NamedCurve&quot;)) {</span>
<span class="nc" id="L446">                String uri = DOMUtils.getAttributeValue(curElem, &quot;URI&quot;);</span>
                // strip off &quot;urn:oid&quot;
<span class="nc bnc" id="L448" title="All 2 branches missed.">                if (uri.startsWith(&quot;urn:oid:&quot;)) {</span>
<span class="nc" id="L449">                    String oid = uri.substring(8);</span>
                    try {
<span class="nc" id="L451">                        Object[] args = new Object[] { oid };</span>
<span class="nc" id="L452">                        ecParams = (ECParameterSpec)</span>
<span class="nc" id="L453">                                    getECParameterSpec.invoke(null, args);</span>
<span class="nc" id="L454">                    } catch (IllegalAccessException iae) {</span>
<span class="nc" id="L455">                        throw new MarshalException(iae);</span>
<span class="nc" id="L456">                    } catch (InvocationTargetException ite) {</span>
<span class="nc" id="L457">                        throw new MarshalException(ite);</span>
<span class="nc" id="L458">                    }</span>
<span class="nc" id="L459">                } else {</span>
<span class="nc" id="L460">                    throw new MarshalException(&quot;Invalid NamedCurve URI&quot;);</span>
                }
<span class="nc" id="L462">            } else {</span>
<span class="nc" id="L463">                throw new MarshalException(&quot;Invalid ECKeyValue&quot;);</span>
            }
<span class="nc" id="L465">            curElem = DOMUtils.getNextSiblingElement(curElem, &quot;PublicKey&quot;);</span>
<span class="nc" id="L466">            ECPoint ecPoint = null;</span>
            try {
<span class="nc" id="L468">                Object[] args = new Object[] { Base64.decode(curElem),</span>
<span class="nc" id="L469">                                               ecParams.getCurve() };</span>
<span class="nc" id="L470">                ecPoint = (ECPoint)decodePoint.invoke(null, args);</span>
<span class="nc" id="L471">            } catch (Base64DecodingException bde) {</span>
<span class="nc" id="L472">                throw new MarshalException(&quot;Invalid EC PublicKey&quot;, bde);</span>
<span class="nc" id="L473">            } catch (IllegalAccessException iae) {</span>
<span class="nc" id="L474">                throw new MarshalException(iae);</span>
<span class="nc" id="L475">            } catch (InvocationTargetException ite) {</span>
<span class="nc" id="L476">                throw new MarshalException(ite);</span>
<span class="nc" id="L477">            }</span>
/*
                ecPoint = sun.security.ec.ECParameters.decodePoint(
                    Base64.decode(curElem), ecParams.getCurve());
*/
<span class="nc" id="L482">            ECPublicKeySpec spec = new ECPublicKeySpec(ecPoint, ecParams);</span>
<span class="nc" id="L483">            return generatePublicKey(eckf, spec);</span>
        }
    }

    static final class Unknown extends DOMKeyValue {
        private javax.xml.crypto.dom.DOMStructure externalPublicKey;
        Unknown(Element elem) throws MarshalException {
<span class="nc" id="L490">            super(elem);</span>
<span class="nc" id="L491">        }</span>
        PublicKey unmarshalKeyValue(Element kvElem) throws MarshalException {
<span class="nc" id="L493">            externalPublicKey = new javax.xml.crypto.dom.DOMStructure(kvElem);</span>
<span class="nc" id="L494">            return null;</span>
        }
        void marshalPublicKey(Node parent, Document doc, String dsPrefix,
                              DOMCryptoContext context)
            throws MarshalException
        {
<span class="nc" id="L500">            parent.appendChild(externalPublicKey.getNode());</span>
<span class="nc" id="L501">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>