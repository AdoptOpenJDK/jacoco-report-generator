<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SoftMixingMixer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">SoftMixingMixer.java</span></div><h1>SoftMixingMixer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2008, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.Clip;
import javax.sound.sampled.Control;
import javax.sound.sampled.DataLine;
import javax.sound.sampled.Line;
import javax.sound.sampled.LineEvent;
import javax.sound.sampled.LineListener;
import javax.sound.sampled.LineUnavailableException;
import javax.sound.sampled.Mixer;
import javax.sound.sampled.SourceDataLine;
import javax.sound.sampled.AudioFormat.Encoding;
import javax.sound.sampled.Control.Type;

/**
 * Software audio mixer
 *
 * @author Karl Helgason
 */
public final class SoftMixingMixer implements Mixer {

    private static class Info extends Mixer.Info {
        Info() {
<span class="nc" id="L55">            super(INFO_NAME, INFO_VENDOR, INFO_DESCRIPTION, INFO_VERSION);</span>
<span class="nc" id="L56">        }</span>
    }

    static final String INFO_NAME = &quot;Gervill Sound Mixer&quot;;

    static final String INFO_VENDOR = &quot;OpenJDK Proposal&quot;;

    static final String INFO_DESCRIPTION = &quot;Software Sound Mixer&quot;;

    static final String INFO_VERSION = &quot;1.0&quot;;

<span class="nc" id="L67">    static final Mixer.Info info = new Info();</span>

<span class="nc" id="L69">    final Object control_mutex = this;</span>

<span class="nc" id="L71">    boolean implicitOpen = false;</span>

<span class="nc" id="L73">    private boolean open = false;</span>

<span class="nc" id="L75">    private SoftMixingMainMixer mainmixer = null;</span>

<span class="nc" id="L77">    private AudioFormat format = new AudioFormat(44100, 16, 2, true, false);</span>

<span class="nc" id="L79">    private SourceDataLine sourceDataLine = null;</span>

<span class="nc" id="L81">    private SoftAudioPusher pusher = null;</span>

<span class="nc" id="L83">    private AudioInputStream pusher_stream = null;</span>

<span class="nc" id="L85">    private final float controlrate = 147f;</span>

<span class="nc" id="L87">    private final long latency = 100000; // 100 msec</span>

<span class="nc" id="L89">    private final boolean jitter_correction = false;</span>

<span class="nc" id="L91">    private final List&lt;LineListener&gt; listeners = new ArrayList&lt;LineListener&gt;();</span>

    private final javax.sound.sampled.Line.Info[] sourceLineInfo;

<span class="nc" id="L95">    public SoftMixingMixer() {</span>

<span class="nc" id="L97">        sourceLineInfo = new javax.sound.sampled.Line.Info[2];</span>

<span class="nc" id="L99">        ArrayList&lt;AudioFormat&gt; formats = new ArrayList&lt;AudioFormat&gt;();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        for (int channels = 1; channels &lt;= 2; channels++) {</span>
<span class="nc" id="L101">            formats.add(new AudioFormat(Encoding.PCM_SIGNED,</span>
                    AudioSystem.NOT_SPECIFIED, 8, channels, channels,
                    AudioSystem.NOT_SPECIFIED, false));
<span class="nc" id="L104">            formats.add(new AudioFormat(Encoding.PCM_UNSIGNED,</span>
                    AudioSystem.NOT_SPECIFIED, 8, channels, channels,
                    AudioSystem.NOT_SPECIFIED, false));
<span class="nc bnc" id="L107" title="All 2 branches missed.">            for (int bits = 16; bits &lt; 32; bits += 8) {</span>
<span class="nc" id="L108">                formats.add(new AudioFormat(Encoding.PCM_SIGNED,</span>
                        AudioSystem.NOT_SPECIFIED, bits, channels, channels
                                * bits / 8, AudioSystem.NOT_SPECIFIED, false));
<span class="nc" id="L111">                formats.add(new AudioFormat(Encoding.PCM_UNSIGNED,</span>
                        AudioSystem.NOT_SPECIFIED, bits, channels, channels
                                * bits / 8, AudioSystem.NOT_SPECIFIED, false));
<span class="nc" id="L114">                formats.add(new AudioFormat(Encoding.PCM_SIGNED,</span>
                        AudioSystem.NOT_SPECIFIED, bits, channels, channels
                                * bits / 8, AudioSystem.NOT_SPECIFIED, true));
<span class="nc" id="L117">                formats.add(new AudioFormat(Encoding.PCM_UNSIGNED,</span>
                        AudioSystem.NOT_SPECIFIED, bits, channels, channels
                                * bits / 8, AudioSystem.NOT_SPECIFIED, true));
            }
<span class="nc" id="L121">            formats.add(new AudioFormat(Encoding.PCM_FLOAT,</span>
                    AudioSystem.NOT_SPECIFIED, 32, channels, channels * 4,
                    AudioSystem.NOT_SPECIFIED, false));
<span class="nc" id="L124">            formats.add(new AudioFormat(Encoding.PCM_FLOAT,</span>
                    AudioSystem.NOT_SPECIFIED, 32, channels, channels * 4,
                    AudioSystem.NOT_SPECIFIED, true));
<span class="nc" id="L127">            formats.add(new AudioFormat(Encoding.PCM_FLOAT,</span>
                    AudioSystem.NOT_SPECIFIED, 64, channels, channels * 8,
                    AudioSystem.NOT_SPECIFIED, false));
<span class="nc" id="L130">            formats.add(new AudioFormat(Encoding.PCM_FLOAT,</span>
                    AudioSystem.NOT_SPECIFIED, 64, channels, channels * 8,
                    AudioSystem.NOT_SPECIFIED, true));
        }
<span class="nc" id="L134">        AudioFormat[] formats_array = formats.toArray(new AudioFormat[formats</span>
<span class="nc" id="L135">                .size()]);</span>
<span class="nc" id="L136">        sourceLineInfo[0] = new DataLine.Info(SourceDataLine.class,</span>
                formats_array, AudioSystem.NOT_SPECIFIED,
                AudioSystem.NOT_SPECIFIED);
<span class="nc" id="L139">        sourceLineInfo[1] = new DataLine.Info(Clip.class, formats_array,</span>
                AudioSystem.NOT_SPECIFIED, AudioSystem.NOT_SPECIFIED);
<span class="nc" id="L141">    }</span>

    public Line getLine(Line.Info info) throws LineUnavailableException {

<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (!isLineSupported(info))</span>
<span class="nc" id="L146">            throw new IllegalArgumentException(&quot;Line unsupported: &quot; + info);</span>

<span class="nc bnc" id="L148" title="All 2 branches missed.">        if ((info.getLineClass() == SourceDataLine.class)) {</span>
<span class="nc" id="L149">            return new SoftMixingSourceDataLine(this, (DataLine.Info) info);</span>
        }
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if ((info.getLineClass() == Clip.class)) {</span>
<span class="nc" id="L152">            return new SoftMixingClip(this, (DataLine.Info) info);</span>
        }

<span class="nc" id="L155">        throw new IllegalArgumentException(&quot;Line unsupported: &quot; + info);</span>
    }

    public int getMaxLines(Line.Info info) {
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (info.getLineClass() == SourceDataLine.class)</span>
<span class="nc" id="L160">            return AudioSystem.NOT_SPECIFIED;</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (info.getLineClass() == Clip.class)</span>
<span class="nc" id="L162">            return AudioSystem.NOT_SPECIFIED;</span>
<span class="nc" id="L163">        return 0;</span>
    }

    public javax.sound.sampled.Mixer.Info getMixerInfo() {
<span class="nc" id="L167">        return info;</span>
    }

    public javax.sound.sampled.Line.Info[] getSourceLineInfo() {
<span class="nc" id="L171">        Line.Info[] localArray = new Line.Info[sourceLineInfo.length];</span>
<span class="nc" id="L172">        System.arraycopy(sourceLineInfo, 0, localArray, 0,</span>
                sourceLineInfo.length);
<span class="nc" id="L174">        return localArray;</span>
    }

    public javax.sound.sampled.Line.Info[] getSourceLineInfo(
            javax.sound.sampled.Line.Info info) {
        int i;
<span class="nc" id="L180">        ArrayList&lt;javax.sound.sampled.Line.Info&gt; infos = new ArrayList&lt;javax.sound.sampled.Line.Info&gt;();</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">        for (i = 0; i &lt; sourceLineInfo.length; i++) {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (info.matches(sourceLineInfo[i])) {</span>
<span class="nc" id="L184">                infos.add(sourceLineInfo[i]);</span>
            }
        }
<span class="nc" id="L187">        return infos.toArray(new Line.Info[infos.size()]);</span>
    }

    public Line[] getSourceLines() {

        Line[] localLines;

<span class="nc" id="L194">        synchronized (control_mutex) {</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">            if (mainmixer == null)</span>
<span class="nc" id="L197">                return new Line[0];</span>
<span class="nc" id="L198">            SoftMixingDataLine[] sourceLines = mainmixer.getOpenLines();</span>

<span class="nc" id="L200">            localLines = new Line[sourceLines.length];</span>

<span class="nc bnc" id="L202" title="All 2 branches missed.">            for (int i = 0; i &lt; localLines.length; i++) {</span>
<span class="nc" id="L203">                localLines[i] = sourceLines[i];</span>
            }
<span class="nc" id="L205">        }</span>

<span class="nc" id="L207">        return localLines;</span>
    }

    public javax.sound.sampled.Line.Info[] getTargetLineInfo() {
<span class="nc" id="L211">        return new javax.sound.sampled.Line.Info[0];</span>
    }

    public javax.sound.sampled.Line.Info[] getTargetLineInfo(
            javax.sound.sampled.Line.Info info) {
<span class="nc" id="L216">        return new javax.sound.sampled.Line.Info[0];</span>
    }

    public Line[] getTargetLines() {
<span class="nc" id="L220">        return new Line[0];</span>
    }

    public boolean isLineSupported(javax.sound.sampled.Line.Info info) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (info != null) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            for (int i = 0; i &lt; sourceLineInfo.length; i++) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                if (info.matches(sourceLineInfo[i])) {</span>
<span class="nc" id="L227">                    return true;</span>
                }
            }
        }
<span class="nc" id="L231">        return false;</span>
    }

    public boolean isSynchronizationSupported(Line[] lines, boolean maintainSync) {
<span class="nc" id="L235">        return false;</span>
    }

    public void synchronize(Line[] lines, boolean maintainSync) {
<span class="nc" id="L239">        throw new IllegalArgumentException(</span>
                &quot;Synchronization not supported by this mixer.&quot;);
    }

    public void unsynchronize(Line[] lines) {
<span class="nc" id="L244">        throw new IllegalArgumentException(</span>
                &quot;Synchronization not supported by this mixer.&quot;);
    }

    public void addLineListener(LineListener listener) {
<span class="nc" id="L249">        synchronized (control_mutex) {</span>
<span class="nc" id="L250">            listeners.add(listener);</span>
<span class="nc" id="L251">        }</span>
<span class="nc" id="L252">    }</span>

    private void sendEvent(LineEvent event) {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (listeners.size() == 0)</span>
<span class="nc" id="L256">            return;</span>
<span class="nc" id="L257">        LineListener[] listener_array = listeners</span>
<span class="nc" id="L258">                .toArray(new LineListener[listeners.size()]);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        for (LineListener listener : listener_array) {</span>
<span class="nc" id="L260">            listener.update(event);</span>
        }
<span class="nc" id="L262">    }</span>

    public void close() {
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L266">            return;</span>

<span class="nc" id="L268">        sendEvent(new LineEvent(this, LineEvent.Type.CLOSE,</span>
                AudioSystem.NOT_SPECIFIED));

<span class="nc" id="L271">        SoftAudioPusher pusher_to_be_closed = null;</span>
<span class="nc" id="L272">        AudioInputStream pusher_stream_to_be_closed = null;</span>
<span class="nc" id="L273">        synchronized (control_mutex) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (pusher != null) {</span>
<span class="nc" id="L275">                pusher_to_be_closed = pusher;</span>
<span class="nc" id="L276">                pusher_stream_to_be_closed = pusher_stream;</span>
<span class="nc" id="L277">                pusher = null;</span>
<span class="nc" id="L278">                pusher_stream = null;</span>
            }
<span class="nc" id="L280">        }</span>

<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (pusher_to_be_closed != null) {</span>
            // Pusher must not be closed synchronized against control_mutex
            // this may result in synchronized conflict between pusher and
            // current thread.
<span class="nc" id="L286">            pusher_to_be_closed.stop();</span>

            try {
<span class="nc" id="L289">                pusher_stream_to_be_closed.close();</span>
<span class="nc" id="L290">            } catch (IOException e) {</span>
<span class="nc" id="L291">                e.printStackTrace();</span>
<span class="nc" id="L292">            }</span>
        }

<span class="nc" id="L295">        synchronized (control_mutex) {</span>

<span class="nc bnc" id="L297" title="All 2 branches missed.">            if (mainmixer != null)</span>
<span class="nc" id="L298">                mainmixer.close();</span>
<span class="nc" id="L299">            open = false;</span>

<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (sourceDataLine != null) {</span>
<span class="nc" id="L302">                sourceDataLine.drain();</span>
<span class="nc" id="L303">                sourceDataLine.close();</span>
<span class="nc" id="L304">                sourceDataLine = null;</span>
            }

<span class="nc" id="L307">        }</span>

<span class="nc" id="L309">    }</span>

    public Control getControl(Type control) {
<span class="nc" id="L312">        throw new IllegalArgumentException(&quot;Unsupported control type : &quot;</span>
                + control);
    }

    public Control[] getControls() {
<span class="nc" id="L317">        return new Control[0];</span>
    }

    public javax.sound.sampled.Line.Info getLineInfo() {
<span class="nc" id="L321">        return new Line.Info(Mixer.class);</span>
    }

    public boolean isControlSupported(Type control) {
<span class="nc" id="L325">        return false;</span>
    }

    public boolean isOpen() {
<span class="nc" id="L329">        synchronized (control_mutex) {</span>
<span class="nc" id="L330">            return open;</span>
<span class="nc" id="L331">        }</span>
    }

    public void open() throws LineUnavailableException {
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (isOpen()) {</span>
<span class="nc" id="L336">            implicitOpen = false;</span>
<span class="nc" id="L337">            return;</span>
        }
<span class="nc" id="L339">        open(null);</span>
<span class="nc" id="L340">    }</span>

    public void open(SourceDataLine line) throws LineUnavailableException {
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (isOpen()) {</span>
<span class="nc" id="L344">            implicitOpen = false;</span>
<span class="nc" id="L345">            return;</span>
        }
<span class="nc" id="L347">        synchronized (control_mutex) {</span>

            try {

<span class="nc bnc" id="L351" title="All 2 branches missed.">                if (line != null)</span>
<span class="nc" id="L352">                    format = line.getFormat();</span>

<span class="nc" id="L354">                AudioInputStream ais = openStream(getFormat());</span>

<span class="nc bnc" id="L356" title="All 2 branches missed.">                if (line == null) {</span>
<span class="nc" id="L357">                    synchronized (SoftMixingMixerProvider.mutex) {</span>
                        SoftMixingMixerProvider.lockthread = Thread
<span class="nc" id="L359">                                .currentThread();</span>
<span class="nc" id="L360">                    }</span>

                    try {
<span class="nc" id="L363">                        Mixer defaultmixer = AudioSystem.getMixer(null);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">                        if (defaultmixer != null)</span>
                        {
                            // Search for suitable line

<span class="nc" id="L368">                            DataLine.Info idealinfo = null;</span>
<span class="nc" id="L369">                            AudioFormat idealformat = null;</span>

<span class="nc" id="L371">                            Line.Info[] lineinfos = defaultmixer.getSourceLineInfo();</span>
                            idealFound:
<span class="nc bnc" id="L373" title="All 2 branches missed.">                            for (int i = 0; i &lt; lineinfos.length; i++) {</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                                if(lineinfos[i].getLineClass() == SourceDataLine.class)</span>
                                {
<span class="nc" id="L376">                                    DataLine.Info info = (DataLine.Info)lineinfos[i];</span>
<span class="nc" id="L377">                                    AudioFormat[] formats = info.getFormats();</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">                                    for (int j = 0; j &lt; formats.length; j++) {</span>
<span class="nc" id="L379">                                        AudioFormat format = formats[j];</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">                                        if(format.getChannels() == 2 ||</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">                                                format.getChannels() == AudioSystem.NOT_SPECIFIED)</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                                        if(format.getEncoding().equals(Encoding.PCM_SIGNED) ||</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">                                                format.getEncoding().equals(Encoding.PCM_UNSIGNED))</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">                                        if(format.getSampleRate() == AudioSystem.NOT_SPECIFIED ||</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">                                                format.getSampleRate() == 48000.0)</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">                                        if(format.getSampleSizeInBits() == AudioSystem.NOT_SPECIFIED ||</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                                                format.getSampleSizeInBits() == 16)</span>
                                        {
<span class="nc" id="L389">                                            idealinfo = info;</span>
<span class="nc" id="L390">                                            int ideal_channels = format.getChannels();</span>
<span class="nc" id="L391">                                            boolean ideal_signed = format.getEncoding().equals(Encoding.PCM_SIGNED);</span>
<span class="nc" id="L392">                                            float ideal_rate = format.getSampleRate();</span>
<span class="nc" id="L393">                                            boolean ideal_endian = format.isBigEndian();</span>
<span class="nc" id="L394">                                            int ideal_bits = format.getSampleSizeInBits();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">                                            if(ideal_bits == AudioSystem.NOT_SPECIFIED) ideal_bits = 16;</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                                            if(ideal_channels == AudioSystem.NOT_SPECIFIED) ideal_channels = 2;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">                                            if(ideal_rate == AudioSystem.NOT_SPECIFIED) ideal_rate = 48000;</span>
<span class="nc" id="L398">                                            idealformat = new AudioFormat(ideal_rate, ideal_bits,</span>
                                                    ideal_channels, ideal_signed, ideal_endian);
<span class="nc" id="L400">                                            break idealFound;</span>
                                        }
                                    }
                                }
                            }

<span class="nc bnc" id="L406" title="All 2 branches missed.">                            if(idealformat != null)</span>
                            {
<span class="nc" id="L408">                                format = idealformat;</span>
<span class="nc" id="L409">                                line = (SourceDataLine) defaultmixer.getLine(idealinfo);</span>
                            }
                        }

<span class="nc bnc" id="L413" title="All 2 branches missed.">                        if(line == null)</span>
<span class="nc" id="L414">                            line = AudioSystem.getSourceDataLine(format);</span>
                    } finally {
<span class="nc" id="L416">                        synchronized (SoftMixingMixerProvider.mutex) {</span>
<span class="nc" id="L417">                            SoftMixingMixerProvider.lockthread = null;</span>
<span class="nc" id="L418">                        }</span>
<span class="nc" id="L419">                    }</span>

<span class="nc bnc" id="L421" title="All 2 branches missed.">                    if (line == null)</span>
<span class="nc" id="L422">                        throw new IllegalArgumentException(&quot;No line matching &quot;</span>
<span class="nc" id="L423">                                + info.toString() + &quot; is supported.&quot;);</span>
                }

<span class="nc" id="L426">                double latency = this.latency;</span>

<span class="nc bnc" id="L428" title="All 2 branches missed.">                if (!line.isOpen()) {</span>
<span class="nc" id="L429">                    int bufferSize = getFormat().getFrameSize()</span>
<span class="nc" id="L430">                            * (int) (getFormat().getFrameRate() * (latency / 1000000f));</span>
<span class="nc" id="L431">                    line.open(getFormat(), bufferSize);</span>

                    // Remember that we opened that line
                    // so we can close again in SoftSynthesizer.close()
<span class="nc" id="L435">                    sourceDataLine = line;</span>
                }
<span class="nc bnc" id="L437" title="All 2 branches missed.">                if (!line.isActive())</span>
<span class="nc" id="L438">                    line.start();</span>

<span class="nc" id="L440">                int controlbuffersize = 512;</span>
                try {
<span class="nc" id="L442">                    controlbuffersize = ais.available();</span>
<span class="nc" id="L443">                } catch (IOException e) {</span>
<span class="nc" id="L444">                }</span>

                // Tell mixer not fill read buffers fully.
                // This lowers latency, and tells DataPusher
                // to read in smaller amounts.
                // mainmixer.readfully = false;
                // pusher = new DataPusher(line, ais);

<span class="nc" id="L452">                int buffersize = line.getBufferSize();</span>
<span class="nc" id="L453">                buffersize -= buffersize % controlbuffersize;</span>

<span class="nc bnc" id="L455" title="All 2 branches missed.">                if (buffersize &lt; 3 * controlbuffersize)</span>
<span class="nc" id="L456">                    buffersize = 3 * controlbuffersize;</span>

                if (jitter_correction) {
                    ais = new SoftJitterCorrector(ais, buffersize,
                            controlbuffersize);
                }
<span class="nc" id="L462">                pusher = new SoftAudioPusher(line, ais, controlbuffersize);</span>
<span class="nc" id="L463">                pusher_stream = ais;</span>
<span class="nc" id="L464">                pusher.start();</span>

<span class="nc" id="L466">            } catch (LineUnavailableException e) {</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">                if (isOpen())</span>
<span class="nc" id="L468">                    close();</span>
<span class="nc" id="L469">                throw new LineUnavailableException(e.toString());</span>
<span class="nc" id="L470">            }</span>

<span class="nc" id="L472">        }</span>
<span class="nc" id="L473">    }</span>

    public AudioInputStream openStream(AudioFormat targetFormat)
            throws LineUnavailableException {

<span class="nc bnc" id="L478" title="All 2 branches missed.">        if (isOpen())</span>
<span class="nc" id="L479">            throw new LineUnavailableException(&quot;Mixer is already open&quot;);</span>

<span class="nc" id="L481">        synchronized (control_mutex) {</span>

<span class="nc" id="L483">            open = true;</span>

<span class="nc" id="L485">            implicitOpen = false;</span>

<span class="nc bnc" id="L487" title="All 2 branches missed.">            if (targetFormat != null)</span>
<span class="nc" id="L488">                format = targetFormat;</span>

<span class="nc" id="L490">            mainmixer = new SoftMixingMainMixer(this);</span>

<span class="nc" id="L492">            sendEvent(new LineEvent(this, LineEvent.Type.OPEN,</span>
                    AudioSystem.NOT_SPECIFIED));

<span class="nc" id="L495">            return mainmixer.getInputStream();</span>

<span class="nc" id="L497">        }</span>

    }

    public void removeLineListener(LineListener listener) {
<span class="nc" id="L502">        synchronized (control_mutex) {</span>
<span class="nc" id="L503">            listeners.remove(listener);</span>
<span class="nc" id="L504">        }</span>
<span class="nc" id="L505">    }</span>

    public long getLatency() {
<span class="nc" id="L508">        synchronized (control_mutex) {</span>
<span class="nc" id="L509">            return latency;</span>
<span class="nc" id="L510">        }</span>
    }

    public AudioFormat getFormat() {
<span class="nc" id="L514">        synchronized (control_mutex) {</span>
<span class="nc" id="L515">            return format;</span>
<span class="nc" id="L516">        }</span>
    }

    float getControlRate() {
<span class="nc" id="L520">        return controlrate;</span>
    }

    SoftMixingMainMixer getMainMixer() {
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L525">            return null;</span>
<span class="nc" id="L526">        return mainmixer;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>