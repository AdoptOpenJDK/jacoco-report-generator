<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StandardMidiFileReader.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">StandardMidiFileReader.java</span></div><h1>StandardMidiFileReader.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.media.sound;

import java.io.DataInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.io.IOException;
import java.io.EOFException;
import java.io.BufferedInputStream;
import java.net.URL;

import javax.sound.midi.MidiFileFormat;
import javax.sound.midi.InvalidMidiDataException;
import javax.sound.midi.MetaMessage;
import javax.sound.midi.MidiEvent;
import javax.sound.midi.MidiMessage;
import javax.sound.midi.Sequence;
import javax.sound.midi.SysexMessage;
import javax.sound.midi.Track;
import javax.sound.midi.spi.MidiFileReader;



/**
 * MIDI file reader.
 *
 * @author Kara Kytle
 * @author Jan Borgersen
 * @author Florian Bomers
 */

<span class="nc" id="L57">public final class StandardMidiFileReader extends MidiFileReader {</span>

    private static final int MThd_MAGIC = 0x4d546864;  // 'MThd'

    private static final int bisBufferSize = 1024; // buffer size in buffered input streams

    public MidiFileFormat getMidiFileFormat(InputStream stream) throws InvalidMidiDataException, IOException {
<span class="nc" id="L64">        return getMidiFileFormatFromStream(stream, MidiFileFormat.UNKNOWN_LENGTH, null);</span>
    }

    // $$fb 2002-04-17: part of fix for 4635286: MidiSystem.getMidiFileFormat() returns format having invalid length
    private MidiFileFormat getMidiFileFormatFromStream(InputStream stream, int fileLength, SMFParser smfParser) throws InvalidMidiDataException, IOException {
<span class="nc" id="L69">        int maxReadLength = 16;</span>
<span class="nc" id="L70">        int duration = MidiFileFormat.UNKNOWN_LENGTH;</span>
        DataInputStream dis;

<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (stream instanceof DataInputStream) {</span>
<span class="nc" id="L74">            dis = (DataInputStream) stream;</span>
        } else {
<span class="nc" id="L76">            dis = new DataInputStream(stream);</span>
        }
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (smfParser == null) {</span>
<span class="nc" id="L79">            dis.mark(maxReadLength);</span>
        } else {
<span class="nc" id="L81">            smfParser.stream = dis;</span>
        }

        int type;
        int numtracks;
        float divisionType;
        int resolution;

        try {
<span class="nc" id="L90">            int magic = dis.readInt();</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            if( !(magic == MThd_MAGIC) ) {</span>
                // not MIDI
<span class="nc" id="L93">                throw new InvalidMidiDataException(&quot;not a valid MIDI file&quot;);</span>
            }

            // read header length
<span class="nc" id="L97">            int bytesRemaining = dis.readInt() - 6;</span>
<span class="nc" id="L98">            type = dis.readShort();</span>
<span class="nc" id="L99">            numtracks = dis.readShort();</span>
<span class="nc" id="L100">            int timing = dis.readShort();</span>

            // decipher the timing code
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (timing &gt; 0) {</span>
                // tempo based timing.  value is ticks per beat.
<span class="nc" id="L105">                divisionType = Sequence.PPQ;</span>
<span class="nc" id="L106">                resolution = timing;</span>
            } else {
                // SMPTE based timing.  first decipher the frame code.
<span class="nc" id="L109">                int frameCode = -1 * (timing &gt;&gt; 8);</span>
<span class="nc bnc" id="L110" title="All 5 branches missed.">                switch(frameCode) {</span>
                case 24:
<span class="nc" id="L112">                    divisionType = Sequence.SMPTE_24;</span>
<span class="nc" id="L113">                    break;</span>
                case 25:
<span class="nc" id="L115">                    divisionType = Sequence.SMPTE_25;</span>
<span class="nc" id="L116">                    break;</span>
                case 29:
<span class="nc" id="L118">                    divisionType = Sequence.SMPTE_30DROP;</span>
<span class="nc" id="L119">                    break;</span>
                case 30:
<span class="nc" id="L121">                    divisionType = Sequence.SMPTE_30;</span>
<span class="nc" id="L122">                    break;</span>
                default:
<span class="nc" id="L124">                    throw new InvalidMidiDataException(&quot;Unknown frame code: &quot; + frameCode);</span>
                }
                // now determine the timing resolution in ticks per frame.
<span class="nc" id="L127">                resolution = timing &amp; 0xFF;</span>
            }
<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (smfParser != null) {</span>
                // remainder of this chunk
<span class="nc" id="L131">                dis.skip(bytesRemaining);</span>
<span class="nc" id="L132">                smfParser.tracks = numtracks;</span>
            }
        } finally {
            // if only reading the file format, reset the stream
<span class="nc bnc" id="L136" title="All 4 branches missed.">            if (smfParser == null) {</span>
<span class="nc" id="L137">                dis.reset();</span>
            }
        }
<span class="nc" id="L140">        MidiFileFormat format = new MidiFileFormat(type, divisionType, resolution, fileLength, duration);</span>
<span class="nc" id="L141">        return format;</span>
    }


    public MidiFileFormat getMidiFileFormat(URL url) throws InvalidMidiDataException, IOException {
<span class="nc" id="L146">        InputStream urlStream = url.openStream(); // throws IOException</span>
<span class="nc" id="L147">        BufferedInputStream bis = new BufferedInputStream( urlStream, bisBufferSize );</span>
<span class="nc" id="L148">        MidiFileFormat fileFormat = null;</span>
        try {
<span class="nc" id="L150">            fileFormat = getMidiFileFormat( bis ); // throws InvalidMidiDataException</span>
        } finally {
<span class="nc" id="L152">            bis.close();</span>
<span class="nc" id="L153">        }</span>
<span class="nc" id="L154">        return fileFormat;</span>
    }


    public MidiFileFormat getMidiFileFormat(File file) throws InvalidMidiDataException, IOException {
<span class="nc" id="L159">        FileInputStream fis = new FileInputStream(file); // throws IOException</span>
<span class="nc" id="L160">        BufferedInputStream bis = new BufferedInputStream(fis, bisBufferSize);</span>

        // $$fb 2002-04-17: part of fix for 4635286: MidiSystem.getMidiFileFormat() returns format having invalid length
<span class="nc" id="L163">        long length = file.length();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (length &gt; Integer.MAX_VALUE) {</span>
<span class="nc" id="L165">            length = MidiFileFormat.UNKNOWN_LENGTH;</span>
        }
<span class="nc" id="L167">        MidiFileFormat fileFormat = null;</span>
        try {
<span class="nc" id="L169">            fileFormat = getMidiFileFormatFromStream(bis, (int) length, null);</span>
        } finally {
<span class="nc" id="L171">            bis.close();</span>
<span class="nc" id="L172">        }</span>
<span class="nc" id="L173">        return fileFormat;</span>
    }


    public Sequence getSequence(InputStream stream) throws InvalidMidiDataException, IOException {
<span class="nc" id="L178">        SMFParser smfParser = new SMFParser();</span>
<span class="nc" id="L179">        MidiFileFormat format = getMidiFileFormatFromStream(stream,</span>
                                                            MidiFileFormat.UNKNOWN_LENGTH,
                                                            smfParser);

        // must be MIDI Type 0 or Type 1
<span class="nc bnc" id="L184" title="All 4 branches missed.">        if ((format.getType() != 0) &amp;&amp; (format.getType() != 1)) {</span>
<span class="nc" id="L185">            throw new InvalidMidiDataException(&quot;Invalid or unsupported file type: &quot;  + format.getType());</span>
        }

        // construct the sequence object
<span class="nc" id="L189">        Sequence sequence = new Sequence(format.getDivisionType(), format.getResolution());</span>

        // for each track, go to the beginning and read the track events
<span class="nc bnc" id="L192" title="All 2 branches missed.">        for (int i = 0; i &lt; smfParser.tracks; i++) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (smfParser.nextTrack()) {</span>
<span class="nc" id="L194">                smfParser.readTrack(sequence.createTrack());</span>
            } else {
                break;
            }
        }
<span class="nc" id="L199">        return sequence;</span>
    }



    public Sequence getSequence(URL url) throws InvalidMidiDataException, IOException {
<span class="nc" id="L205">        InputStream is = url.openStream();  // throws IOException</span>
<span class="nc" id="L206">        is = new BufferedInputStream(is, bisBufferSize);</span>
<span class="nc" id="L207">        Sequence seq = null;</span>
        try {
<span class="nc" id="L209">            seq = getSequence(is);</span>
        } finally {
<span class="nc" id="L211">            is.close();</span>
<span class="nc" id="L212">        }</span>
<span class="nc" id="L213">        return seq;</span>
    }


    public Sequence getSequence(File file) throws InvalidMidiDataException, IOException {
<span class="nc" id="L218">        InputStream is = new FileInputStream(file); // throws IOException</span>
<span class="nc" id="L219">        is = new BufferedInputStream(is, bisBufferSize);</span>
<span class="nc" id="L220">        Sequence seq = null;</span>
        try {
<span class="nc" id="L222">            seq = getSequence(is);</span>
        } finally {
<span class="nc" id="L224">            is.close();</span>
<span class="nc" id="L225">        }</span>
<span class="nc" id="L226">        return seq;</span>
    }
}

//=============================================================================================================

/**
 * State variables during parsing of a MIDI file
 */
final class SMFParser {
    private static final int MTrk_MAGIC = 0x4d54726b;  // 'MTrk'

    // set to true to not allow corrupt MIDI files tombe loaded
    private static final boolean STRICT_PARSER = false;

    private static final boolean DEBUG = false;

    int tracks;                       // number of tracks
    DataInputStream stream;   // the stream to read from

<span class="nc" id="L246">    private int trackLength = 0;  // remaining length in track</span>
<span class="nc" id="L247">    private byte[] trackData = null;</span>
<span class="nc" id="L248">    private int pos = 0;</span>

<span class="nc" id="L250">    SMFParser() {</span>
<span class="nc" id="L251">    }</span>

    private int readUnsigned() throws IOException {
<span class="nc" id="L254">        return trackData[pos++] &amp; 0xFF;</span>
    }

    private void read(byte[] data) throws IOException {
<span class="nc" id="L258">        System.arraycopy(trackData, pos, data, 0, data.length);</span>
<span class="nc" id="L259">        pos += data.length;</span>
<span class="nc" id="L260">    }</span>

    private long readVarInt() throws IOException {
<span class="nc" id="L263">        long value = 0; // the variable-lengh int value</span>
<span class="nc" id="L264">        int currentByte = 0;</span>
        do {
<span class="nc" id="L266">            currentByte = trackData[pos++] &amp; 0xFF;</span>
<span class="nc" id="L267">            value = (value &lt;&lt; 7) + (currentByte &amp; 0x7F);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        } while ((currentByte &amp; 0x80) != 0);</span>
<span class="nc" id="L269">        return value;</span>
    }

    private int readIntFromStream() throws IOException {
        try {
<span class="nc" id="L274">            return stream.readInt();</span>
<span class="nc" id="L275">        } catch (EOFException eof) {</span>
<span class="nc" id="L276">            throw new EOFException(&quot;invalid MIDI file&quot;);</span>
        }
    }

    boolean nextTrack() throws IOException, InvalidMidiDataException {
        int magic;
<span class="nc" id="L282">        trackLength = 0;</span>
        do {
            // $$fb 2003-08-20: fix for 4910986: MIDI file parser breaks up on http connection
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (stream.skipBytes(trackLength) != trackLength) {</span>
                if (!STRICT_PARSER) {
<span class="nc" id="L287">                    return false;</span>
                }
                throw new EOFException(&quot;invalid MIDI file&quot;);
            }
<span class="nc" id="L291">            magic = readIntFromStream();</span>
<span class="nc" id="L292">            trackLength = readIntFromStream();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        } while (magic != MTrk_MAGIC);</span>
        if (!STRICT_PARSER) {
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (trackLength &lt; 0) {</span>
<span class="nc" id="L296">                return false;</span>
            }
        }
        // now read track in a byte array
<span class="nc" id="L300">        trackData = new byte[trackLength];</span>
        try {
            // $$fb 2003-08-20: fix for 4910986: MIDI file parser breaks up on http connection
<span class="nc" id="L303">            stream.readFully(trackData);</span>
<span class="nc" id="L304">        } catch (EOFException eof) {</span>
            if (!STRICT_PARSER) {
<span class="nc" id="L306">                return false;</span>
            }
            throw new EOFException(&quot;invalid MIDI file&quot;);
<span class="nc" id="L309">        }</span>
<span class="nc" id="L310">        pos = 0;</span>
<span class="nc" id="L311">        return true;</span>
    }

    private boolean trackFinished() {
<span class="nc bnc" id="L315" title="All 2 branches missed.">        return pos &gt;= trackLength;</span>
    }

    void readTrack(Track track) throws IOException, InvalidMidiDataException {
        try {
            // reset current tick to 0
<span class="nc" id="L321">            long tick = 0;</span>

            // reset current status byte to 0 (invalid value).
            // this should cause us to throw an InvalidMidiDataException if we don't
            // get a valid status byte from the beginning of the track.
<span class="nc" id="L326">            int status = 0;</span>
<span class="nc" id="L327">            boolean endOfTrackFound = false;</span>

<span class="nc bnc" id="L329" title="All 4 branches missed.">            while (!trackFinished() &amp;&amp; !endOfTrackFound) {</span>
                MidiMessage message;

<span class="nc" id="L332">                int data1 = -1;         // initialize to invalid value</span>
<span class="nc" id="L333">                int data2 = 0;</span>

                // each event has a tick delay and then the event data.

                // first read the delay (a variable-length int) and update our tick value
<span class="nc" id="L338">                tick += readVarInt();</span>

                // check for new status
<span class="nc" id="L341">                int byteValue = readUnsigned();</span>

<span class="nc bnc" id="L343" title="All 2 branches missed.">                if (byteValue &gt;= 0x80) {</span>
<span class="nc" id="L344">                    status = byteValue;</span>
                } else {
<span class="nc" id="L346">                    data1 = byteValue;</span>
                }

<span class="nc bnc" id="L349" title="All 4 branches missed.">                switch (status &amp; 0xF0) {</span>
                case 0x80:
                case 0x90:
                case 0xA0:
                case 0xB0:
                case 0xE0:
                    // two data bytes
<span class="nc bnc" id="L356" title="All 2 branches missed.">                    if (data1 == -1) {</span>
<span class="nc" id="L357">                        data1 = readUnsigned();</span>
                    }
<span class="nc" id="L359">                    data2 = readUnsigned();</span>
<span class="nc" id="L360">                    message = new FastShortMessage(status | (data1 &lt;&lt; 8) | (data2 &lt;&lt; 16));</span>
<span class="nc" id="L361">                    break;</span>
                case 0xC0:
                case 0xD0:
                    // one data byte
<span class="nc bnc" id="L365" title="All 2 branches missed.">                    if (data1 == -1) {</span>
<span class="nc" id="L366">                        data1 = readUnsigned();</span>
                    }
<span class="nc" id="L368">                    message = new FastShortMessage(status | (data1 &lt;&lt; 8));</span>
<span class="nc" id="L369">                    break;</span>
                case 0xF0:
                    // sys-ex or meta
<span class="nc bnc" id="L372" title="All 3 branches missed.">                    switch(status) {</span>
                    case 0xF0:
                    case 0xF7:
                        // sys ex
<span class="nc" id="L376">                        int sysexLength = (int) readVarInt();</span>
<span class="nc" id="L377">                        byte[] sysexData = new byte[sysexLength];</span>
<span class="nc" id="L378">                        read(sysexData);</span>

<span class="nc" id="L380">                        SysexMessage sysexMessage = new SysexMessage();</span>
<span class="nc" id="L381">                        sysexMessage.setMessage(status, sysexData, sysexLength);</span>
<span class="nc" id="L382">                        message = sysexMessage;</span>
<span class="nc" id="L383">                        break;</span>

                    case 0xFF:
                        // meta
<span class="nc" id="L387">                        int metaType = readUnsigned();</span>
<span class="nc" id="L388">                        int metaLength = (int) readVarInt();</span>

<span class="nc" id="L390">                        byte[] metaData = new byte[metaLength];</span>
<span class="nc" id="L391">                        read(metaData);</span>

<span class="nc" id="L393">                        MetaMessage metaMessage = new MetaMessage();</span>
<span class="nc" id="L394">                        metaMessage.setMessage(metaType, metaData, metaLength);</span>
<span class="nc" id="L395">                        message = metaMessage;</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                        if (metaType == 0x2F) {</span>
                            // end of track means it!
<span class="nc" id="L398">                            endOfTrackFound = true;</span>
                        }
                        break;
                    default:
<span class="nc" id="L402">                        throw new InvalidMidiDataException(&quot;Invalid status byte: &quot; + status);</span>
                    } // switch sys-ex or meta
<span class="nc" id="L404">                    break;</span>
                default:
<span class="nc" id="L406">                    throw new InvalidMidiDataException(&quot;Invalid status byte: &quot; + status);</span>
                } // switch
<span class="nc" id="L408">                track.add(new MidiEvent(message, tick));</span>
<span class="nc" id="L409">            } // while</span>
<span class="nc" id="L410">        } catch (ArrayIndexOutOfBoundsException e) {</span>
            if (DEBUG) e.printStackTrace();
            // fix for 4834374
<span class="nc" id="L413">            throw new EOFException(&quot;invalid MIDI file&quot;);</span>
<span class="nc" id="L414">        }</span>
<span class="nc" id="L415">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>