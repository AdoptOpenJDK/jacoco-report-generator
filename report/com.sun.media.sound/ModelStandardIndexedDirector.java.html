<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ModelStandardIndexedDirector.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">ModelStandardIndexedDirector.java</span></div><h1>ModelStandardIndexedDirector.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2010, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.util.Arrays;

/**
 * A standard indexed director who chooses performers
 * by there keyfrom,keyto,velfrom,velto properties.
 *
 * @author Karl Helgason
 */
public final class ModelStandardIndexedDirector implements ModelDirector {

    private final ModelPerformer[] performers;
    private final ModelDirectedPlayer player;
<span class="nc" id="L39">    private boolean noteOnUsed = false;</span>
<span class="nc" id="L40">    private boolean noteOffUsed = false;</span>

    // Variables needed for index
    private byte[][] trantables;
    private int[] counters;
    private int[][] mat;

    public ModelStandardIndexedDirector(final ModelPerformer[] performers,
<span class="nc" id="L48">                                        final ModelDirectedPlayer player) {</span>
<span class="nc" id="L49">        this.performers = Arrays.copyOf(performers, performers.length);</span>
<span class="nc" id="L50">        this.player = player;</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        for (final ModelPerformer p : this.performers) {</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            if (p.isReleaseTriggered()) {</span>
<span class="nc" id="L53">                noteOffUsed = true;</span>
            } else {
<span class="nc" id="L55">                noteOnUsed = true;</span>
            }
        }
<span class="nc" id="L58">        buildindex();</span>
<span class="nc" id="L59">    }</span>

    private int[] lookupIndex(int x, int y) {
<span class="nc bnc" id="L62" title="All 8 branches missed.">        if ((x &gt;= 0) &amp;&amp; (x &lt; 128) &amp;&amp; (y &gt;= 0) &amp;&amp; (y &lt; 128)) {</span>
<span class="nc" id="L63">            int xt = trantables[0][x];</span>
<span class="nc" id="L64">            int yt = trantables[1][y];</span>
<span class="nc bnc" id="L65" title="All 4 branches missed.">            if (xt != -1 &amp;&amp; yt != -1) {</span>
<span class="nc" id="L66">                return mat[xt + yt * counters[0]];</span>
            }
        }
<span class="nc" id="L69">        return null;</span>
    }

    private int restrict(int value) {
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if(value &lt; 0) return 0;</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if(value &gt; 127) return 127;</span>
<span class="nc" id="L75">        return value;</span>
    }

    private void buildindex() {
<span class="nc" id="L79">        trantables = new byte[2][129];</span>
<span class="nc" id="L80">        counters = new int[trantables.length];</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        for (ModelPerformer performer : performers) {</span>
<span class="nc" id="L82">            int keyFrom = performer.getKeyFrom();</span>
<span class="nc" id="L83">            int keyTo = performer.getKeyTo();</span>
<span class="nc" id="L84">            int velFrom = performer.getVelFrom();</span>
<span class="nc" id="L85">            int velTo = performer.getVelTo();</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (keyFrom &gt; keyTo) continue;</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (velFrom &gt; velTo) continue;</span>
<span class="nc" id="L88">            keyFrom = restrict(keyFrom);</span>
<span class="nc" id="L89">            keyTo = restrict(keyTo);</span>
<span class="nc" id="L90">            velFrom = restrict(velFrom);</span>
<span class="nc" id="L91">            velTo = restrict(velTo);</span>
<span class="nc" id="L92">            trantables[0][keyFrom] = 1;</span>
<span class="nc" id="L93">            trantables[0][keyTo + 1] = 1;</span>
<span class="nc" id="L94">            trantables[1][velFrom] = 1;</span>
<span class="nc" id="L95">            trantables[1][velTo + 1] = 1;</span>
        }
<span class="nc bnc" id="L97" title="All 2 branches missed.">        for (int d = 0; d &lt; trantables.length; d++) {</span>
<span class="nc" id="L98">            byte[] trantable = trantables[d];</span>
<span class="nc" id="L99">            int transize = trantable.length;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            for (int i = transize - 1; i &gt;= 0; i--) {</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                if (trantable[i] == 1) {</span>
<span class="nc" id="L102">                    trantable[i] = -1;</span>
<span class="nc" id="L103">                    break;</span>
                }
<span class="nc" id="L105">                trantable[i] = -1;</span>
            }
<span class="nc" id="L107">            int counter = -1;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            for (int i = 0; i &lt; transize; i++) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                if (trantable[i] != 0) {</span>
<span class="nc" id="L110">                    counter++;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                    if (trantable[i] == -1)</span>
<span class="nc" id="L112">                        break;</span>
                }
<span class="nc" id="L114">                trantable[i] = (byte) counter;</span>
            }
<span class="nc" id="L116">            counters[d] = counter;</span>
        }
<span class="nc" id="L118">        mat = new int[counters[0] * counters[1]][];</span>
<span class="nc" id="L119">        int ix = 0;</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        for (ModelPerformer performer : performers) {</span>
<span class="nc" id="L121">            int keyFrom = performer.getKeyFrom();</span>
<span class="nc" id="L122">            int keyTo = performer.getKeyTo();</span>
<span class="nc" id="L123">            int velFrom = performer.getVelFrom();</span>
<span class="nc" id="L124">            int velTo = performer.getVelTo();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (keyFrom &gt; keyTo) continue;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (velFrom &gt; velTo) continue;</span>
<span class="nc" id="L127">            keyFrom = restrict(keyFrom);</span>
<span class="nc" id="L128">            keyTo = restrict(keyTo);</span>
<span class="nc" id="L129">            velFrom = restrict(velFrom);</span>
<span class="nc" id="L130">            velTo = restrict(velTo);</span>
<span class="nc" id="L131">            int x_from = trantables[0][keyFrom];</span>
<span class="nc" id="L132">            int x_to = trantables[0][keyTo + 1];</span>
<span class="nc" id="L133">            int y_from = trantables[1][velFrom];</span>
<span class="nc" id="L134">            int y_to = trantables[1][velTo + 1];</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (x_to == -1)</span>
<span class="nc" id="L136">                x_to = counters[0];</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (y_to == -1)</span>
<span class="nc" id="L138">                y_to = counters[1];</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            for (int y = y_from; y &lt; y_to; y++) {</span>
<span class="nc" id="L140">                int i = x_from + y * counters[0];</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                for (int x = x_from; x &lt; x_to; x++) {</span>
<span class="nc" id="L142">                    int[] mprev = mat[i];</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                    if (mprev == null) {</span>
<span class="nc" id="L144">                        mat[i] = new int[] { ix };</span>
                    } else {
<span class="nc" id="L146">                        int[] mnew = new int[mprev.length + 1];</span>
<span class="nc" id="L147">                        mnew[mnew.length - 1] = ix;</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                        for (int k = 0; k &lt; mprev.length; k++)</span>
<span class="nc" id="L149">                            mnew[k] = mprev[k];</span>
<span class="nc" id="L150">                        mat[i] = mnew;</span>
                    }
<span class="nc" id="L152">                    i++;</span>
                }
            }
<span class="nc" id="L155">            ix++;</span>
        }
<span class="nc" id="L157">    }</span>

    public void close() {
<span class="nc" id="L160">    }</span>

    public void noteOff(int noteNumber, int velocity) {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (!noteOffUsed)</span>
<span class="nc" id="L164">            return;</span>
<span class="nc" id="L165">        int[] plist = lookupIndex(noteNumber, velocity);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if(plist == null) return;</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        for (int i : plist) {</span>
<span class="nc" id="L168">            ModelPerformer p = performers[i];</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (p.isReleaseTriggered()) {</span>
<span class="nc" id="L170">                player.play(i, null);</span>
            }
        }
<span class="nc" id="L173">    }</span>

    public void noteOn(int noteNumber, int velocity) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (!noteOnUsed)</span>
<span class="nc" id="L177">            return;</span>
<span class="nc" id="L178">        int[] plist = lookupIndex(noteNumber, velocity);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if(plist == null) return;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">        for (int i : plist) {</span>
<span class="nc" id="L181">            ModelPerformer p = performers[i];</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (!p.isReleaseTriggered()) {</span>
<span class="nc" id="L183">                player.play(i, null);</span>
            }
        }
<span class="nc" id="L186">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>