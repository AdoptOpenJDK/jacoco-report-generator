<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>DLSSoundbank.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">DLSSoundbank.java</span></div><h1>DLSSoundbank.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.URL;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Stack;

import javax.sound.midi.Instrument;
import javax.sound.midi.Patch;
import javax.sound.midi.Soundbank;
import javax.sound.midi.SoundbankResource;
import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.AudioFormat.Encoding;

/**
 * A DLS Level 1 and Level 2 soundbank reader (from files/url/streams).
 *
 * @author Karl Helgason
 */
public final class DLSSoundbank implements Soundbank {

    static private class DLSID {
        long i1;
        int s1;
        int s2;
        int x1;
        int x2;
        int x3;
        int x4;
        int x5;
        int x6;
        int x7;
        int x8;

<span class="nc" id="L69">        private DLSID() {</span>
<span class="nc" id="L70">        }</span>

        DLSID(long i1, int s1, int s2, int x1, int x2, int x3, int x4,
<span class="nc" id="L73">                int x5, int x6, int x7, int x8) {</span>
<span class="nc" id="L74">            this.i1 = i1;</span>
<span class="nc" id="L75">            this.s1 = s1;</span>
<span class="nc" id="L76">            this.s2 = s2;</span>
<span class="nc" id="L77">            this.x1 = x1;</span>
<span class="nc" id="L78">            this.x2 = x2;</span>
<span class="nc" id="L79">            this.x3 = x3;</span>
<span class="nc" id="L80">            this.x4 = x4;</span>
<span class="nc" id="L81">            this.x5 = x5;</span>
<span class="nc" id="L82">            this.x6 = x6;</span>
<span class="nc" id="L83">            this.x7 = x7;</span>
<span class="nc" id="L84">            this.x8 = x8;</span>
<span class="nc" id="L85">        }</span>

        public static DLSID read(RIFFReader riff) throws IOException {
<span class="nc" id="L88">            DLSID d = new DLSID();</span>
<span class="nc" id="L89">            d.i1 = riff.readUnsignedInt();</span>
<span class="nc" id="L90">            d.s1 = riff.readUnsignedShort();</span>
<span class="nc" id="L91">            d.s2 = riff.readUnsignedShort();</span>
<span class="nc" id="L92">            d.x1 = riff.readUnsignedByte();</span>
<span class="nc" id="L93">            d.x2 = riff.readUnsignedByte();</span>
<span class="nc" id="L94">            d.x3 = riff.readUnsignedByte();</span>
<span class="nc" id="L95">            d.x4 = riff.readUnsignedByte();</span>
<span class="nc" id="L96">            d.x5 = riff.readUnsignedByte();</span>
<span class="nc" id="L97">            d.x6 = riff.readUnsignedByte();</span>
<span class="nc" id="L98">            d.x7 = riff.readUnsignedByte();</span>
<span class="nc" id="L99">            d.x8 = riff.readUnsignedByte();</span>
<span class="nc" id="L100">            return d;</span>
        }

        public int hashCode() {
<span class="nc" id="L104">            return (int)i1;</span>
        }

        public boolean equals(Object obj) {
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (!(obj instanceof DLSID)) {</span>
<span class="nc" id="L109">                return false;</span>
            }
<span class="nc" id="L111">            DLSID t = (DLSID) obj;</span>
<span class="nc bnc" id="L112" title="All 22 branches missed.">            return i1 == t.i1 &amp;&amp; s1 == t.s1 &amp;&amp; s2 == t.s2</span>
                &amp;&amp; x1 == t.x1 &amp;&amp; x2 == t.x2 &amp;&amp; x3 == t.x3 &amp;&amp; x4 == t.x4
                &amp;&amp; x5 == t.x5 &amp;&amp; x6 == t.x6 &amp;&amp; x7 == t.x7 &amp;&amp; x8 == t.x8;
        }
    }

    /** X = X &amp; Y */
    private static final int DLS_CDL_AND = 0x0001;
    /** X = X | Y */
    private static final int DLS_CDL_OR = 0x0002;
    /** X = X ^ Y */
    private static final int DLS_CDL_XOR = 0x0003;
    /** X = X + Y */
    private static final int DLS_CDL_ADD = 0x0004;
    /** X = X - Y */
    private static final int DLS_CDL_SUBTRACT = 0x0005;
    /** X = X * Y */
    private static final int DLS_CDL_MULTIPLY = 0x0006;
    /** X = X / Y */
    private static final int DLS_CDL_DIVIDE = 0x0007;
    /** X = X &amp;&amp; Y */
    private static final int DLS_CDL_LOGICAL_AND = 0x0008;
    /** X = X || Y */
    private static final int DLS_CDL_LOGICAL_OR = 0x0009;
    /** X = (X &lt; Y) */
    private static final int DLS_CDL_LT = 0x000A;
    /** X = (X &lt;= Y) */
    private static final int DLS_CDL_LE = 0x000B;
    /** X = (X &gt; Y) */
    private static final int DLS_CDL_GT = 0x000C;
    /** X = (X &gt;= Y) */
    private static final int DLS_CDL_GE = 0x000D;
    /** X = (X == Y) */
    private static final int DLS_CDL_EQ = 0x000E;
    /** X = !X */
    private static final int DLS_CDL_NOT = 0x000F;
    /** 32-bit constant */
    private static final int DLS_CDL_CONST = 0x0010;
    /** 32-bit value returned from query */
    private static final int DLS_CDL_QUERY = 0x0011;
    /** 32-bit value returned from query */
    private static final int DLS_CDL_QUERYSUPPORTED = 0x0012;

<span class="nc" id="L155">    private static final DLSID DLSID_GMInHardware = new DLSID(0x178f2f24,</span>
            0xc364, 0x11d1, 0xa7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xac, 0x12);
<span class="nc" id="L157">    private static final DLSID DLSID_GSInHardware = new DLSID(0x178f2f25,</span>
            0xc364, 0x11d1, 0xa7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xac, 0x12);
<span class="nc" id="L159">    private static final DLSID DLSID_XGInHardware = new DLSID(0x178f2f26,</span>
            0xc364, 0x11d1, 0xa7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xac, 0x12);
<span class="nc" id="L161">    private static final DLSID DLSID_SupportsDLS1 = new DLSID(0x178f2f27,</span>
            0xc364, 0x11d1, 0xa7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xac, 0x12);
<span class="nc" id="L163">    private static final DLSID DLSID_SupportsDLS2 = new DLSID(0xf14599e5,</span>
            0x4689, 0x11d2, 0xaf, 0xa6, 0x0, 0xaa, 0x0, 0x24, 0xd8, 0xb6);
<span class="nc" id="L165">    private static final DLSID DLSID_SampleMemorySize = new DLSID(0x178f2f28,</span>
            0xc364, 0x11d1, 0xa7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xac, 0x12);
<span class="nc" id="L167">    private static final DLSID DLSID_ManufacturersID = new DLSID(0xb03e1181,</span>
            0x8095, 0x11d2, 0xa1, 0xef, 0x0, 0x60, 0x8, 0x33, 0xdb, 0xd8);
<span class="nc" id="L169">    private static final DLSID DLSID_ProductID = new DLSID(0xb03e1182,</span>
            0x8095, 0x11d2, 0xa1, 0xef, 0x0, 0x60, 0x8, 0x33, 0xdb, 0xd8);
<span class="nc" id="L171">    private static final DLSID DLSID_SamplePlaybackRate = new DLSID(0x2a91f713,</span>
            0xa4bf, 0x11d2, 0xbb, 0xdf, 0x0, 0x60, 0x8, 0x33, 0xdb, 0xd8);

<span class="nc" id="L174">    private long major = -1;</span>
<span class="nc" id="L175">    private long minor = -1;</span>

<span class="nc" id="L177">    private final DLSInfo info = new DLSInfo();</span>

<span class="nc" id="L179">    private final List&lt;DLSInstrument&gt; instruments = new ArrayList&lt;DLSInstrument&gt;();</span>
<span class="nc" id="L180">    private final List&lt;DLSSample&gt; samples = new ArrayList&lt;DLSSample&gt;();</span>

<span class="nc" id="L182">    private boolean largeFormat = false;</span>
    private File sampleFile;

<span class="nc" id="L185">    public DLSSoundbank() {</span>
<span class="nc" id="L186">    }</span>

<span class="nc" id="L188">    public DLSSoundbank(URL url) throws IOException {</span>
<span class="nc" id="L189">        InputStream is = url.openStream();</span>
        try {
<span class="nc" id="L191">            readSoundbank(is);</span>
        } finally {
<span class="nc" id="L193">            is.close();</span>
<span class="nc" id="L194">        }</span>
<span class="nc" id="L195">    }</span>

<span class="nc" id="L197">    public DLSSoundbank(File file) throws IOException {</span>
<span class="nc" id="L198">        largeFormat = true;</span>
<span class="nc" id="L199">        sampleFile = file;</span>
<span class="nc" id="L200">        InputStream is = new FileInputStream(file);</span>
        try {
<span class="nc" id="L202">            readSoundbank(is);</span>
        } finally {
<span class="nc" id="L204">            is.close();</span>
<span class="nc" id="L205">        }</span>
<span class="nc" id="L206">    }</span>

<span class="nc" id="L208">    public DLSSoundbank(InputStream inputstream) throws IOException {</span>
<span class="nc" id="L209">        readSoundbank(inputstream);</span>
<span class="nc" id="L210">    }</span>

    private void readSoundbank(InputStream inputstream) throws IOException {
<span class="nc" id="L213">        RIFFReader riff = new RIFFReader(inputstream);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!riff.getFormat().equals(&quot;RIFF&quot;)) {</span>
<span class="nc" id="L215">            throw new RIFFInvalidFormatException(</span>
                    &quot;Input stream is not a valid RIFF stream!&quot;);
        }
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (!riff.getType().equals(&quot;DLS &quot;)) {</span>
<span class="nc" id="L219">            throw new RIFFInvalidFormatException(</span>
                    &quot;Input stream is not a valid DLS soundbank!&quot;);
        }
<span class="nc bnc" id="L222" title="All 2 branches missed.">        while (riff.hasNextChunk()) {</span>
<span class="nc" id="L223">            RIFFReader chunk = riff.nextChunk();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (chunk.getFormat().equals(&quot;LIST&quot;)) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;INFO&quot;))</span>
<span class="nc" id="L226">                    readInfoChunk(chunk);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;lins&quot;))</span>
<span class="nc" id="L228">                    readLinsChunk(chunk);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;wvpl&quot;))</span>
<span class="nc" id="L230">                    readWvplChunk(chunk);</span>
            } else {
<span class="nc bnc" id="L232" title="All 2 branches missed.">                if (chunk.getFormat().equals(&quot;cdl &quot;)) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                    if (!readCdlChunk(chunk)) {</span>
<span class="nc" id="L234">                        throw new RIFFInvalidFormatException(</span>
                                &quot;DLS file isn't supported!&quot;);
                    }
                }
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (chunk.getFormat().equals(&quot;colh&quot;)) {</span>
                    // skipped because we will load the entire bank into memory
                    // long instrumentcount = chunk.readUnsignedInt();
                    // System.out.println(&quot;instrumentcount = &quot;+ instrumentcount);
                }
<span class="nc bnc" id="L243" title="All 2 branches missed.">                if (chunk.getFormat().equals(&quot;ptbl&quot;)) {</span>
                    // Pool Table Chunk
                    // skipped because we will load the entire bank into memory
                }
<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (chunk.getFormat().equals(&quot;vers&quot;)) {</span>
<span class="nc" id="L248">                    major = chunk.readUnsignedInt();</span>
<span class="nc" id="L249">                    minor = chunk.readUnsignedInt();</span>
                }
            }
<span class="nc" id="L252">        }</span>

<span class="nc bnc" id="L254" title="All 2 branches missed.">        for (Map.Entry&lt;DLSRegion, Long&gt; entry : temp_rgnassign.entrySet()) {</span>
<span class="nc" id="L255">            entry.getKey().sample = samples.get((int)entry.getValue().longValue());</span>
<span class="nc" id="L256">        }</span>

<span class="nc" id="L258">        temp_rgnassign = null;</span>
<span class="nc" id="L259">    }</span>

    private boolean cdlIsQuerySupported(DLSID uuid) {
<span class="nc bnc" id="L262" title="All 2 branches missed.">        return uuid.equals(DLSID_GMInHardware)</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            || uuid.equals(DLSID_GSInHardware)</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">            || uuid.equals(DLSID_XGInHardware)</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">            || uuid.equals(DLSID_SupportsDLS1)</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">            || uuid.equals(DLSID_SupportsDLS2)</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">            || uuid.equals(DLSID_SampleMemorySize)</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            || uuid.equals(DLSID_ManufacturersID)</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            || uuid.equals(DLSID_ProductID)</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">            || uuid.equals(DLSID_SamplePlaybackRate);</span>
    }

    private long cdlQuery(DLSID uuid) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (uuid.equals(DLSID_GMInHardware))</span>
<span class="nc" id="L275">            return 1;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (uuid.equals(DLSID_GSInHardware))</span>
<span class="nc" id="L277">            return 0;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (uuid.equals(DLSID_XGInHardware))</span>
<span class="nc" id="L279">            return 0;</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (uuid.equals(DLSID_SupportsDLS1))</span>
<span class="nc" id="L281">            return 1;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (uuid.equals(DLSID_SupportsDLS2))</span>
<span class="nc" id="L283">            return 1;</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (uuid.equals(DLSID_SampleMemorySize))</span>
<span class="nc" id="L285">            return Runtime.getRuntime().totalMemory();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (uuid.equals(DLSID_ManufacturersID))</span>
<span class="nc" id="L287">            return 0;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (uuid.equals(DLSID_ProductID))</span>
<span class="nc" id="L289">            return 0;</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (uuid.equals(DLSID_SamplePlaybackRate))</span>
<span class="nc" id="L291">            return 44100;</span>
<span class="nc" id="L292">        return 0;</span>
    }


    // Reading cdl-ck Chunk
    // &quot;cdl &quot; chunk can only appear inside : DLS,lart,lar2,rgn,rgn2
    private boolean readCdlChunk(RIFFReader riff) throws IOException {

        DLSID uuid;
        long x;
        long y;
<span class="nc" id="L303">        Stack&lt;Long&gt; stack = new Stack&lt;Long&gt;();</span>

<span class="nc bnc" id="L305" title="All 2 branches missed.">        while (riff.available() != 0) {</span>
<span class="nc" id="L306">            int opcode = riff.readUnsignedShort();</span>
<span class="nc bnc" id="L307" title="All 19 branches missed.">            switch (opcode) {</span>
            case DLS_CDL_AND:
<span class="nc" id="L309">                x = stack.pop();</span>
<span class="nc" id="L310">                y = stack.pop();</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">                stack.push(Long.valueOf(((x != 0) &amp;&amp; (y != 0)) ? 1 : 0));</span>
<span class="nc" id="L312">                break;</span>
            case DLS_CDL_OR:
<span class="nc" id="L314">                x = stack.pop();</span>
<span class="nc" id="L315">                y = stack.pop();</span>
<span class="nc bnc" id="L316" title="All 4 branches missed.">                stack.push(Long.valueOf(((x != 0) || (y != 0)) ? 1 : 0));</span>
<span class="nc" id="L317">                break;</span>
            case DLS_CDL_XOR:
<span class="nc" id="L319">                x = stack.pop();</span>
<span class="nc" id="L320">                y = stack.pop();</span>
<span class="nc bnc" id="L321" title="All 6 branches missed.">                stack.push(Long.valueOf(((x != 0) ^ (y != 0)) ? 1 : 0));</span>
<span class="nc" id="L322">                break;</span>
            case DLS_CDL_ADD:
<span class="nc" id="L324">                x = stack.pop();</span>
<span class="nc" id="L325">                y = stack.pop();</span>
<span class="nc" id="L326">                stack.push(Long.valueOf(x + y));</span>
<span class="nc" id="L327">                break;</span>
            case DLS_CDL_SUBTRACT:
<span class="nc" id="L329">                x = stack.pop();</span>
<span class="nc" id="L330">                y = stack.pop();</span>
<span class="nc" id="L331">                stack.push(Long.valueOf(x - y));</span>
<span class="nc" id="L332">                break;</span>
            case DLS_CDL_MULTIPLY:
<span class="nc" id="L334">                x = stack.pop();</span>
<span class="nc" id="L335">                y = stack.pop();</span>
<span class="nc" id="L336">                stack.push(Long.valueOf(x * y));</span>
<span class="nc" id="L337">                break;</span>
            case DLS_CDL_DIVIDE:
<span class="nc" id="L339">                x = stack.pop();</span>
<span class="nc" id="L340">                y = stack.pop();</span>
<span class="nc" id="L341">                stack.push(Long.valueOf(x / y));</span>
<span class="nc" id="L342">                break;</span>
            case DLS_CDL_LOGICAL_AND:
<span class="nc" id="L344">                x = stack.pop();</span>
<span class="nc" id="L345">                y = stack.pop();</span>
<span class="nc bnc" id="L346" title="All 4 branches missed.">                stack.push(Long.valueOf(((x != 0) &amp;&amp; (y != 0)) ? 1 : 0));</span>
<span class="nc" id="L347">                break;</span>
            case DLS_CDL_LOGICAL_OR:
<span class="nc" id="L349">                x = stack.pop();</span>
<span class="nc" id="L350">                y = stack.pop();</span>
<span class="nc bnc" id="L351" title="All 4 branches missed.">                stack.push(Long.valueOf(((x != 0) || (y != 0)) ? 1 : 0));</span>
<span class="nc" id="L352">                break;</span>
            case DLS_CDL_LT:
<span class="nc" id="L354">                x = stack.pop();</span>
<span class="nc" id="L355">                y = stack.pop();</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                stack.push(Long.valueOf((x &lt; y) ? 1 : 0));</span>
<span class="nc" id="L357">                break;</span>
            case DLS_CDL_LE:
<span class="nc" id="L359">                x = stack.pop();</span>
<span class="nc" id="L360">                y = stack.pop();</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                stack.push(Long.valueOf((x &lt;= y) ? 1 : 0));</span>
<span class="nc" id="L362">                break;</span>
            case DLS_CDL_GT:
<span class="nc" id="L364">                x = stack.pop();</span>
<span class="nc" id="L365">                y = stack.pop();</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                stack.push(Long.valueOf((x &gt; y) ? 1 : 0));</span>
<span class="nc" id="L367">                break;</span>
            case DLS_CDL_GE:
<span class="nc" id="L369">                x = stack.pop();</span>
<span class="nc" id="L370">                y = stack.pop();</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                stack.push(Long.valueOf((x &gt;= y) ? 1 : 0));</span>
<span class="nc" id="L372">                break;</span>
            case DLS_CDL_EQ:
<span class="nc" id="L374">                x = stack.pop();</span>
<span class="nc" id="L375">                y = stack.pop();</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                stack.push(Long.valueOf((x == y) ? 1 : 0));</span>
<span class="nc" id="L377">                break;</span>
            case DLS_CDL_NOT:
<span class="nc" id="L379">                x = stack.pop();</span>
<span class="nc" id="L380">                y = stack.pop();</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">                stack.push(Long.valueOf((x == 0) ? 1 : 0));</span>
<span class="nc" id="L382">                break;</span>
            case DLS_CDL_CONST:
<span class="nc" id="L384">                stack.push(Long.valueOf(riff.readUnsignedInt()));</span>
<span class="nc" id="L385">                break;</span>
            case DLS_CDL_QUERY:
<span class="nc" id="L387">                uuid = DLSID.read(riff);</span>
<span class="nc" id="L388">                stack.push(cdlQuery(uuid));</span>
<span class="nc" id="L389">                break;</span>
            case DLS_CDL_QUERYSUPPORTED:
<span class="nc" id="L391">                uuid = DLSID.read(riff);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">                stack.push(Long.valueOf(cdlIsQuerySupported(uuid) ? 1 : 0));</span>
<span class="nc" id="L393">                break;</span>
            default:
                break;
            }
<span class="nc" id="L397">        }</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (stack.isEmpty())</span>
<span class="nc" id="L399">            return false;</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">        return stack.pop() == 1;</span>
    }

    private void readInfoChunk(RIFFReader riff) throws IOException {
<span class="nc" id="L405">        info.name = null;</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">        while (riff.hasNextChunk()) {</span>
<span class="nc" id="L407">            RIFFReader chunk = riff.nextChunk();</span>
<span class="nc" id="L408">            String format = chunk.getFormat();</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">            if (format.equals(&quot;INAM&quot;))</span>
<span class="nc" id="L410">                info.name = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">            else if (format.equals(&quot;ICRD&quot;))</span>
<span class="nc" id="L412">                info.creationDate = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">            else if (format.equals(&quot;IENG&quot;))</span>
<span class="nc" id="L414">                info.engineers = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">            else if (format.equals(&quot;IPRD&quot;))</span>
<span class="nc" id="L416">                info.product = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">            else if (format.equals(&quot;ICOP&quot;))</span>
<span class="nc" id="L418">                info.copyright = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">            else if (format.equals(&quot;ICMT&quot;))</span>
<span class="nc" id="L420">                info.comments = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">            else if (format.equals(&quot;ISFT&quot;))</span>
<span class="nc" id="L422">                info.tools = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">            else if (format.equals(&quot;IARL&quot;))</span>
<span class="nc" id="L424">                info.archival_location = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">            else if (format.equals(&quot;IART&quot;))</span>
<span class="nc" id="L426">                info.artist = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">            else if (format.equals(&quot;ICMS&quot;))</span>
<span class="nc" id="L428">                info.commissioned = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">            else if (format.equals(&quot;IGNR&quot;))</span>
<span class="nc" id="L430">                info.genre = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">            else if (format.equals(&quot;IKEY&quot;))</span>
<span class="nc" id="L432">                info.keywords = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">            else if (format.equals(&quot;IMED&quot;))</span>
<span class="nc" id="L434">                info.medium = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">            else if (format.equals(&quot;ISBJ&quot;))</span>
<span class="nc" id="L436">                info.subject = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">            else if (format.equals(&quot;ISRC&quot;))</span>
<span class="nc" id="L438">                info.source = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">            else if (format.equals(&quot;ISRF&quot;))</span>
<span class="nc" id="L440">                info.source_form = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            else if (format.equals(&quot;ITCH&quot;))</span>
<span class="nc" id="L442">                info.technician = chunk.readString(chunk.available());</span>
<span class="nc" id="L443">        }</span>
<span class="nc" id="L444">    }</span>

    private void readLinsChunk(RIFFReader riff) throws IOException {
<span class="nc bnc" id="L447" title="All 2 branches missed.">        while (riff.hasNextChunk()) {</span>
<span class="nc" id="L448">            RIFFReader chunk = riff.nextChunk();</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">            if (chunk.getFormat().equals(&quot;LIST&quot;)) {</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;ins &quot;))</span>
<span class="nc" id="L451">                    readInsChunk(chunk);</span>
            }
<span class="nc" id="L453">        }</span>
<span class="nc" id="L454">    }</span>

    private void readInsChunk(RIFFReader riff) throws IOException {
<span class="nc" id="L457">        DLSInstrument instrument = new DLSInstrument(this);</span>

<span class="nc bnc" id="L459" title="All 2 branches missed.">        while (riff.hasNextChunk()) {</span>
<span class="nc" id="L460">            RIFFReader chunk = riff.nextChunk();</span>
<span class="nc" id="L461">            String format = chunk.getFormat();</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">            if (format.equals(&quot;LIST&quot;)) {</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;INFO&quot;)) {</span>
<span class="nc" id="L464">                    readInsInfoChunk(instrument, chunk);</span>
                }
<span class="nc bnc" id="L466" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;lrgn&quot;)) {</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">                    while (chunk.hasNextChunk()) {</span>
<span class="nc" id="L468">                        RIFFReader subchunk = chunk.nextChunk();</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                        if (subchunk.getFormat().equals(&quot;LIST&quot;)) {</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">                            if (subchunk.getType().equals(&quot;rgn &quot;)) {</span>
<span class="nc" id="L471">                                DLSRegion split = new DLSRegion();</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">                                if (readRgnChunk(split, subchunk))</span>
<span class="nc" id="L473">                                    instrument.getRegions().add(split);</span>
                            }
<span class="nc bnc" id="L475" title="All 2 branches missed.">                            if (subchunk.getType().equals(&quot;rgn2&quot;)) {</span>
                                // support for DLS level 2 regions
<span class="nc" id="L477">                                DLSRegion split = new DLSRegion();</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">                                if (readRgnChunk(split, subchunk))</span>
<span class="nc" id="L479">                                    instrument.getRegions().add(split);</span>
                            }
                        }
<span class="nc" id="L482">                    }</span>
                }
<span class="nc bnc" id="L484" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;lart&quot;)) {</span>
<span class="nc" id="L485">                    List&lt;DLSModulator&gt; modlist = new ArrayList&lt;DLSModulator&gt;();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">                    while (chunk.hasNextChunk()) {</span>
<span class="nc" id="L487">                        RIFFReader subchunk = chunk.nextChunk();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">                        if (chunk.getFormat().equals(&quot;cdl &quot;)) {</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">                            if (!readCdlChunk(chunk)) {</span>
<span class="nc" id="L490">                                modlist.clear();</span>
<span class="nc" id="L491">                                break;</span>
                            }
                        }
<span class="nc bnc" id="L494" title="All 2 branches missed.">                        if (subchunk.getFormat().equals(&quot;art1&quot;))</span>
<span class="nc" id="L495">                            readArt1Chunk(modlist, subchunk);</span>
<span class="nc" id="L496">                    }</span>
<span class="nc" id="L497">                    instrument.getModulators().addAll(modlist);</span>
                }
<span class="nc bnc" id="L499" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;lar2&quot;)) {</span>
                    // support for DLS level 2 ART
<span class="nc" id="L501">                    List&lt;DLSModulator&gt; modlist = new ArrayList&lt;DLSModulator&gt;();</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">                    while (chunk.hasNextChunk()) {</span>
<span class="nc" id="L503">                        RIFFReader subchunk = chunk.nextChunk();</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">                        if (chunk.getFormat().equals(&quot;cdl &quot;)) {</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                            if (!readCdlChunk(chunk)) {</span>
<span class="nc" id="L506">                                modlist.clear();</span>
<span class="nc" id="L507">                                break;</span>
                            }
                        }
<span class="nc bnc" id="L510" title="All 2 branches missed.">                        if (subchunk.getFormat().equals(&quot;art2&quot;))</span>
<span class="nc" id="L511">                            readArt2Chunk(modlist, subchunk);</span>
<span class="nc" id="L512">                    }</span>
<span class="nc" id="L513">                    instrument.getModulators().addAll(modlist);</span>
<span class="nc" id="L514">                }</span>
            } else {
<span class="nc bnc" id="L516" title="All 2 branches missed.">                if (format.equals(&quot;dlid&quot;)) {</span>
<span class="nc" id="L517">                    instrument.guid = new byte[16];</span>
<span class="nc" id="L518">                    chunk.readFully(instrument.guid);</span>
                }
<span class="nc bnc" id="L520" title="All 2 branches missed.">                if (format.equals(&quot;insh&quot;)) {</span>
<span class="nc" id="L521">                    chunk.readUnsignedInt(); // Read Region Count - ignored</span>

<span class="nc" id="L523">                    int bank = chunk.read();             // LSB</span>
<span class="nc" id="L524">                    bank += (chunk.read() &amp; 127) &lt;&lt; 7;   // MSB</span>
<span class="nc" id="L525">                    chunk.read(); // Read Reserved byte</span>
<span class="nc" id="L526">                    int drumins = chunk.read();          // Drum Instrument</span>

<span class="nc" id="L528">                    int id = chunk.read() &amp; 127; // Read only first 7 bits</span>
<span class="nc" id="L529">                    chunk.read(); // Read Reserved byte</span>
<span class="nc" id="L530">                    chunk.read(); // Read Reserved byte</span>
<span class="nc" id="L531">                    chunk.read(); // Read Reserved byte</span>

<span class="nc" id="L533">                    instrument.bank = bank;</span>
<span class="nc" id="L534">                    instrument.preset = (int) id;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                    instrument.druminstrument = (drumins &amp; 128) &gt; 0;</span>
                    //System.out.println(&quot;bank=&quot;+bank+&quot; drumkit=&quot;+drumkit
                    //        +&quot; id=&quot;+id);
                }

            }
<span class="nc" id="L541">        }</span>
<span class="nc" id="L542">        instruments.add(instrument);</span>
<span class="nc" id="L543">    }</span>

    private void readArt1Chunk(List&lt;DLSModulator&gt; modulators, RIFFReader riff)
            throws IOException {
<span class="nc" id="L547">        long size = riff.readUnsignedInt();</span>
<span class="nc" id="L548">        long count = riff.readUnsignedInt();</span>

<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (size - 8 != 0)</span>
<span class="nc" id="L551">            riff.skipBytes(size - 8);</span>

<span class="nc bnc" id="L553" title="All 2 branches missed.">        for (int i = 0; i &lt; count; i++) {</span>
<span class="nc" id="L554">            DLSModulator modulator = new DLSModulator();</span>
<span class="nc" id="L555">            modulator.version = 1;</span>
<span class="nc" id="L556">            modulator.source = riff.readUnsignedShort();</span>
<span class="nc" id="L557">            modulator.control = riff.readUnsignedShort();</span>
<span class="nc" id="L558">            modulator.destination = riff.readUnsignedShort();</span>
<span class="nc" id="L559">            modulator.transform = riff.readUnsignedShort();</span>
<span class="nc" id="L560">            modulator.scale = riff.readInt();</span>
<span class="nc" id="L561">            modulators.add(modulator);</span>
        }
<span class="nc" id="L563">    }</span>

    private void readArt2Chunk(List&lt;DLSModulator&gt; modulators, RIFFReader riff)
            throws IOException {
<span class="nc" id="L567">        long size = riff.readUnsignedInt();</span>
<span class="nc" id="L568">        long count = riff.readUnsignedInt();</span>

<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (size - 8 != 0)</span>
<span class="nc" id="L571">            riff.skipBytes(size - 8);</span>

<span class="nc bnc" id="L573" title="All 2 branches missed.">        for (int i = 0; i &lt; count; i++) {</span>
<span class="nc" id="L574">            DLSModulator modulator = new DLSModulator();</span>
<span class="nc" id="L575">            modulator.version = 2;</span>
<span class="nc" id="L576">            modulator.source = riff.readUnsignedShort();</span>
<span class="nc" id="L577">            modulator.control = riff.readUnsignedShort();</span>
<span class="nc" id="L578">            modulator.destination = riff.readUnsignedShort();</span>
<span class="nc" id="L579">            modulator.transform = riff.readUnsignedShort();</span>
<span class="nc" id="L580">            modulator.scale = riff.readInt();</span>
<span class="nc" id="L581">            modulators.add(modulator);</span>
        }
<span class="nc" id="L583">    }</span>

<span class="nc" id="L585">    private Map&lt;DLSRegion, Long&gt; temp_rgnassign = new HashMap&lt;DLSRegion, Long&gt;();</span>

    private boolean readRgnChunk(DLSRegion split, RIFFReader riff)
            throws IOException {
<span class="nc bnc" id="L589" title="All 2 branches missed.">        while (riff.hasNextChunk()) {</span>
<span class="nc" id="L590">            RIFFReader chunk = riff.nextChunk();</span>
<span class="nc" id="L591">            String format = chunk.getFormat();</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">            if (format.equals(&quot;LIST&quot;)) {</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;lart&quot;)) {</span>
<span class="nc" id="L594">                    List&lt;DLSModulator&gt; modlist = new ArrayList&lt;DLSModulator&gt;();</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">                    while (chunk.hasNextChunk()) {</span>
<span class="nc" id="L596">                        RIFFReader subchunk = chunk.nextChunk();</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                        if (chunk.getFormat().equals(&quot;cdl &quot;)) {</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                            if (!readCdlChunk(chunk)) {</span>
<span class="nc" id="L599">                                modlist.clear();</span>
<span class="nc" id="L600">                                break;</span>
                            }
                        }
<span class="nc bnc" id="L603" title="All 2 branches missed.">                        if (subchunk.getFormat().equals(&quot;art1&quot;))</span>
<span class="nc" id="L604">                            readArt1Chunk(modlist, subchunk);</span>
<span class="nc" id="L605">                    }</span>
<span class="nc" id="L606">                    split.getModulators().addAll(modlist);</span>
                }
<span class="nc bnc" id="L608" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;lar2&quot;)) {</span>
                    // support for DLS level 2 ART
<span class="nc" id="L610">                    List&lt;DLSModulator&gt; modlist = new ArrayList&lt;DLSModulator&gt;();</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">                    while (chunk.hasNextChunk()) {</span>
<span class="nc" id="L612">                        RIFFReader subchunk = chunk.nextChunk();</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                        if (chunk.getFormat().equals(&quot;cdl &quot;)) {</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">                            if (!readCdlChunk(chunk)) {</span>
<span class="nc" id="L615">                                modlist.clear();</span>
<span class="nc" id="L616">                                break;</span>
                            }
                        }
<span class="nc bnc" id="L619" title="All 2 branches missed.">                        if (subchunk.getFormat().equals(&quot;art2&quot;))</span>
<span class="nc" id="L620">                            readArt2Chunk(modlist, subchunk);</span>
<span class="nc" id="L621">                    }</span>
<span class="nc" id="L622">                    split.getModulators().addAll(modlist);</span>
<span class="nc" id="L623">                }</span>
            } else {

<span class="nc bnc" id="L626" title="All 2 branches missed.">                if (format.equals(&quot;cdl &quot;)) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                    if (!readCdlChunk(chunk))</span>
<span class="nc" id="L628">                        return false;</span>
                }
<span class="nc bnc" id="L630" title="All 2 branches missed.">                if (format.equals(&quot;rgnh&quot;)) {</span>
<span class="nc" id="L631">                    split.keyfrom = chunk.readUnsignedShort();</span>
<span class="nc" id="L632">                    split.keyto = chunk.readUnsignedShort();</span>
<span class="nc" id="L633">                    split.velfrom = chunk.readUnsignedShort();</span>
<span class="nc" id="L634">                    split.velto = chunk.readUnsignedShort();</span>
<span class="nc" id="L635">                    split.options = chunk.readUnsignedShort();</span>
<span class="nc" id="L636">                    split.exclusiveClass = chunk.readUnsignedShort();</span>
                }
<span class="nc bnc" id="L638" title="All 2 branches missed.">                if (format.equals(&quot;wlnk&quot;)) {</span>
<span class="nc" id="L639">                    split.fusoptions = chunk.readUnsignedShort();</span>
<span class="nc" id="L640">                    split.phasegroup = chunk.readUnsignedShort();</span>
<span class="nc" id="L641">                    split.channel = chunk.readUnsignedInt();</span>
<span class="nc" id="L642">                    long sampleid = chunk.readUnsignedInt();</span>
<span class="nc" id="L643">                    temp_rgnassign.put(split, sampleid);</span>
                }
<span class="nc bnc" id="L645" title="All 2 branches missed.">                if (format.equals(&quot;wsmp&quot;)) {</span>
<span class="nc" id="L646">                    split.sampleoptions = new DLSSampleOptions();</span>
<span class="nc" id="L647">                    readWsmpChunk(split.sampleoptions, chunk);</span>
                }
            }
<span class="nc" id="L650">        }</span>
<span class="nc" id="L651">        return true;</span>
    }

    private void readWsmpChunk(DLSSampleOptions sampleOptions, RIFFReader riff)
            throws IOException {
<span class="nc" id="L656">        long size = riff.readUnsignedInt();</span>
<span class="nc" id="L657">        sampleOptions.unitynote = riff.readUnsignedShort();</span>
<span class="nc" id="L658">        sampleOptions.finetune = riff.readShort();</span>
<span class="nc" id="L659">        sampleOptions.attenuation = riff.readInt();</span>
<span class="nc" id="L660">        sampleOptions.options = riff.readUnsignedInt();</span>
<span class="nc" id="L661">        long loops = riff.readInt();</span>

<span class="nc bnc" id="L663" title="All 2 branches missed.">        if (size &gt; 20)</span>
<span class="nc" id="L664">            riff.skipBytes(size - 20);</span>

<span class="nc bnc" id="L666" title="All 2 branches missed.">        for (int i = 0; i &lt; loops; i++) {</span>
<span class="nc" id="L667">            DLSSampleLoop loop = new DLSSampleLoop();</span>
<span class="nc" id="L668">            long size2 = riff.readUnsignedInt();</span>
<span class="nc" id="L669">            loop.type = riff.readUnsignedInt();</span>
<span class="nc" id="L670">            loop.start = riff.readUnsignedInt();</span>
<span class="nc" id="L671">            loop.length = riff.readUnsignedInt();</span>
<span class="nc" id="L672">            sampleOptions.loops.add(loop);</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">            if (size2 &gt; 16)</span>
<span class="nc" id="L674">                riff.skipBytes(size2 - 16);</span>
        }
<span class="nc" id="L676">    }</span>

    private void readInsInfoChunk(DLSInstrument dlsinstrument, RIFFReader riff)
            throws IOException {
<span class="nc" id="L680">        dlsinstrument.info.name = null;</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        while (riff.hasNextChunk()) {</span>
<span class="nc" id="L682">            RIFFReader chunk = riff.nextChunk();</span>
<span class="nc" id="L683">            String format = chunk.getFormat();</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">            if (format.equals(&quot;INAM&quot;)) {</span>
<span class="nc" id="L685">                dlsinstrument.info.name = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">            } else if (format.equals(&quot;ICRD&quot;)) {</span>
<span class="nc" id="L687">                dlsinstrument.info.creationDate =</span>
<span class="nc" id="L688">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">            } else if (format.equals(&quot;IENG&quot;)) {</span>
<span class="nc" id="L690">                dlsinstrument.info.engineers =</span>
<span class="nc" id="L691">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">            } else if (format.equals(&quot;IPRD&quot;)) {</span>
<span class="nc" id="L693">                dlsinstrument.info.product = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">            } else if (format.equals(&quot;ICOP&quot;)) {</span>
<span class="nc" id="L695">                dlsinstrument.info.copyright =</span>
<span class="nc" id="L696">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">            } else if (format.equals(&quot;ICMT&quot;)) {</span>
<span class="nc" id="L698">                dlsinstrument.info.comments =</span>
<span class="nc" id="L699">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">            } else if (format.equals(&quot;ISFT&quot;)) {</span>
<span class="nc" id="L701">                dlsinstrument.info.tools = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">            } else if (format.equals(&quot;IARL&quot;)) {</span>
<span class="nc" id="L703">                dlsinstrument.info.archival_location =</span>
<span class="nc" id="L704">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">            } else if (format.equals(&quot;IART&quot;)) {</span>
<span class="nc" id="L706">                dlsinstrument.info.artist = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">            } else if (format.equals(&quot;ICMS&quot;)) {</span>
<span class="nc" id="L708">                dlsinstrument.info.commissioned =</span>
<span class="nc" id="L709">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">            } else if (format.equals(&quot;IGNR&quot;)) {</span>
<span class="nc" id="L711">                dlsinstrument.info.genre = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">            } else if (format.equals(&quot;IKEY&quot;)) {</span>
<span class="nc" id="L713">                dlsinstrument.info.keywords =</span>
<span class="nc" id="L714">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">            } else if (format.equals(&quot;IMED&quot;)) {</span>
<span class="nc" id="L716">                dlsinstrument.info.medium = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">            } else if (format.equals(&quot;ISBJ&quot;)) {</span>
<span class="nc" id="L718">                dlsinstrument.info.subject = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">            } else if (format.equals(&quot;ISRC&quot;)) {</span>
<span class="nc" id="L720">                dlsinstrument.info.source = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">            } else if (format.equals(&quot;ISRF&quot;)) {</span>
<span class="nc" id="L722">                dlsinstrument.info.source_form =</span>
<span class="nc" id="L723">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">            } else if (format.equals(&quot;ITCH&quot;)) {</span>
<span class="nc" id="L725">                dlsinstrument.info.technician =</span>
<span class="nc" id="L726">                        chunk.readString(chunk.available());</span>
            }
<span class="nc" id="L728">        }</span>
<span class="nc" id="L729">    }</span>

    private void readWvplChunk(RIFFReader riff) throws IOException {
<span class="nc bnc" id="L732" title="All 2 branches missed.">        while (riff.hasNextChunk()) {</span>
<span class="nc" id="L733">            RIFFReader chunk = riff.nextChunk();</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">            if (chunk.getFormat().equals(&quot;LIST&quot;)) {</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;wave&quot;))</span>
<span class="nc" id="L736">                    readWaveChunk(chunk);</span>
            }
<span class="nc" id="L738">        }</span>
<span class="nc" id="L739">    }</span>

    private void readWaveChunk(RIFFReader riff) throws IOException {
<span class="nc" id="L742">        DLSSample sample = new DLSSample(this);</span>

<span class="nc bnc" id="L744" title="All 2 branches missed.">        while (riff.hasNextChunk()) {</span>
<span class="nc" id="L745">            RIFFReader chunk = riff.nextChunk();</span>
<span class="nc" id="L746">            String format = chunk.getFormat();</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">            if (format.equals(&quot;LIST&quot;)) {</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">                if (chunk.getType().equals(&quot;INFO&quot;)) {</span>
<span class="nc" id="L749">                    readWaveInfoChunk(sample, chunk);</span>
                }
            } else {
<span class="nc bnc" id="L752" title="All 2 branches missed.">                if (format.equals(&quot;dlid&quot;)) {</span>
<span class="nc" id="L753">                    sample.guid = new byte[16];</span>
<span class="nc" id="L754">                    chunk.readFully(sample.guid);</span>
                }

<span class="nc bnc" id="L757" title="All 2 branches missed.">                if (format.equals(&quot;fmt &quot;)) {</span>
<span class="nc" id="L758">                    int sampleformat = chunk.readUnsignedShort();</span>
<span class="nc bnc" id="L759" title="All 4 branches missed.">                    if (sampleformat != 1 &amp;&amp; sampleformat != 3) {</span>
<span class="nc" id="L760">                        throw new RIFFInvalidDataException(</span>
                                &quot;Only PCM samples are supported!&quot;);
                    }
<span class="nc" id="L763">                    int channels = chunk.readUnsignedShort();</span>
<span class="nc" id="L764">                    long samplerate = chunk.readUnsignedInt();</span>
                    // bytes per sec
<span class="nc" id="L766">                    /* long framerate = */ chunk.readUnsignedInt();</span>
                    // block align, framesize
<span class="nc" id="L768">                    int framesize = chunk.readUnsignedShort();</span>
<span class="nc" id="L769">                    int bits = chunk.readUnsignedShort();</span>
<span class="nc" id="L770">                    AudioFormat audioformat = null;</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">                    if (sampleformat == 1) {</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">                        if (bits == 8) {</span>
<span class="nc" id="L773">                            audioformat = new AudioFormat(</span>
                                    Encoding.PCM_UNSIGNED, samplerate, bits,
                                    channels, framesize, samplerate, false);
                        } else {
<span class="nc" id="L777">                            audioformat = new AudioFormat(</span>
                                    Encoding.PCM_SIGNED, samplerate, bits,
                                    channels, framesize, samplerate, false);
                        }
                    }
<span class="nc bnc" id="L782" title="All 2 branches missed.">                    if (sampleformat == 3) {</span>
<span class="nc" id="L783">                        audioformat = new AudioFormat(</span>
                                Encoding.PCM_FLOAT, samplerate, bits,
                                channels, framesize, samplerate, false);
                    }

<span class="nc" id="L788">                    sample.format = audioformat;</span>
                }

<span class="nc bnc" id="L791" title="All 2 branches missed.">                if (format.equals(&quot;data&quot;)) {</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">                    if (largeFormat) {</span>
<span class="nc" id="L793">                        sample.setData(new ModelByteBuffer(sampleFile,</span>
<span class="nc" id="L794">                                chunk.getFilePointer(), chunk.available()));</span>
                    } else {
<span class="nc" id="L796">                        byte[] buffer = new byte[chunk.available()];</span>
                        //  chunk.read(buffer);
<span class="nc" id="L798">                        sample.setData(buffer);</span>

<span class="nc" id="L800">                        int read = 0;</span>
<span class="nc" id="L801">                        int avail = chunk.available();</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">                        while (read != avail) {</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">                            if (avail - read &gt; 65536) {</span>
<span class="nc" id="L804">                                chunk.readFully(buffer, read, 65536);</span>
<span class="nc" id="L805">                                read += 65536;</span>
                            } else {
<span class="nc" id="L807">                                chunk.readFully(buffer, read, avail - read);</span>
<span class="nc" id="L808">                                read = avail;</span>
                            }
                        }
                    }
                }

<span class="nc bnc" id="L814" title="All 2 branches missed.">                if (format.equals(&quot;wsmp&quot;)) {</span>
<span class="nc" id="L815">                    sample.sampleoptions = new DLSSampleOptions();</span>
<span class="nc" id="L816">                    readWsmpChunk(sample.sampleoptions, chunk);</span>
                }
            }
<span class="nc" id="L819">        }</span>

<span class="nc" id="L821">        samples.add(sample);</span>

<span class="nc" id="L823">    }</span>

    private void readWaveInfoChunk(DLSSample dlssample, RIFFReader riff)
            throws IOException {
<span class="nc" id="L827">        dlssample.info.name = null;</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">        while (riff.hasNextChunk()) {</span>
<span class="nc" id="L829">            RIFFReader chunk = riff.nextChunk();</span>
<span class="nc" id="L830">            String format = chunk.getFormat();</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">            if (format.equals(&quot;INAM&quot;)) {</span>
<span class="nc" id="L832">                dlssample.info.name = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">            } else if (format.equals(&quot;ICRD&quot;)) {</span>
<span class="nc" id="L834">                dlssample.info.creationDate =</span>
<span class="nc" id="L835">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">            } else if (format.equals(&quot;IENG&quot;)) {</span>
<span class="nc" id="L837">                dlssample.info.engineers = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">            } else if (format.equals(&quot;IPRD&quot;)) {</span>
<span class="nc" id="L839">                dlssample.info.product = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">            } else if (format.equals(&quot;ICOP&quot;)) {</span>
<span class="nc" id="L841">                dlssample.info.copyright = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">            } else if (format.equals(&quot;ICMT&quot;)) {</span>
<span class="nc" id="L843">                dlssample.info.comments = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">            } else if (format.equals(&quot;ISFT&quot;)) {</span>
<span class="nc" id="L845">                dlssample.info.tools = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">            } else if (format.equals(&quot;IARL&quot;)) {</span>
<span class="nc" id="L847">                dlssample.info.archival_location =</span>
<span class="nc" id="L848">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">            } else if (format.equals(&quot;IART&quot;)) {</span>
<span class="nc" id="L850">                dlssample.info.artist = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">            } else if (format.equals(&quot;ICMS&quot;)) {</span>
<span class="nc" id="L852">                dlssample.info.commissioned =</span>
<span class="nc" id="L853">                        chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">            } else if (format.equals(&quot;IGNR&quot;)) {</span>
<span class="nc" id="L855">                dlssample.info.genre = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">            } else if (format.equals(&quot;IKEY&quot;)) {</span>
<span class="nc" id="L857">                dlssample.info.keywords = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">            } else if (format.equals(&quot;IMED&quot;)) {</span>
<span class="nc" id="L859">                dlssample.info.medium = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">            } else if (format.equals(&quot;ISBJ&quot;)) {</span>
<span class="nc" id="L861">                dlssample.info.subject = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">            } else if (format.equals(&quot;ISRC&quot;)) {</span>
<span class="nc" id="L863">                dlssample.info.source = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">            } else if (format.equals(&quot;ISRF&quot;)) {</span>
<span class="nc" id="L865">                dlssample.info.source_form = chunk.readString(chunk.available());</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">            } else if (format.equals(&quot;ITCH&quot;)) {</span>
<span class="nc" id="L867">                dlssample.info.technician = chunk.readString(chunk.available());</span>
            }
<span class="nc" id="L869">        }</span>
<span class="nc" id="L870">    }</span>

    public void save(String name) throws IOException {
<span class="nc" id="L873">        writeSoundbank(new RIFFWriter(name, &quot;DLS &quot;));</span>
<span class="nc" id="L874">    }</span>

    public void save(File file) throws IOException {
<span class="nc" id="L877">        writeSoundbank(new RIFFWriter(file, &quot;DLS &quot;));</span>
<span class="nc" id="L878">    }</span>

    public void save(OutputStream out) throws IOException {
<span class="nc" id="L881">        writeSoundbank(new RIFFWriter(out, &quot;DLS &quot;));</span>
<span class="nc" id="L882">    }</span>

    private void writeSoundbank(RIFFWriter writer) throws IOException {
<span class="nc" id="L885">        RIFFWriter colh_chunk = writer.writeChunk(&quot;colh&quot;);</span>
<span class="nc" id="L886">        colh_chunk.writeUnsignedInt(instruments.size());</span>

<span class="nc bnc" id="L888" title="All 4 branches missed.">        if (major != -1 &amp;&amp; minor != -1) {</span>
<span class="nc" id="L889">            RIFFWriter vers_chunk = writer.writeChunk(&quot;vers&quot;);</span>
<span class="nc" id="L890">            vers_chunk.writeUnsignedInt(major);</span>
<span class="nc" id="L891">            vers_chunk.writeUnsignedInt(minor);</span>
        }

<span class="nc" id="L894">        writeInstruments(writer.writeList(&quot;lins&quot;));</span>

<span class="nc" id="L896">        RIFFWriter ptbl = writer.writeChunk(&quot;ptbl&quot;);</span>
<span class="nc" id="L897">        ptbl.writeUnsignedInt(8);</span>
<span class="nc" id="L898">        ptbl.writeUnsignedInt(samples.size());</span>
<span class="nc" id="L899">        long ptbl_offset = writer.getFilePointer();</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">        for (int i = 0; i &lt; samples.size(); i++)</span>
<span class="nc" id="L901">            ptbl.writeUnsignedInt(0);</span>

<span class="nc" id="L903">        RIFFWriter wvpl = writer.writeList(&quot;wvpl&quot;);</span>
<span class="nc" id="L904">        long off = wvpl.getFilePointer();</span>
<span class="nc" id="L905">        List&lt;Long&gt; offsettable = new ArrayList&lt;Long&gt;();</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">        for (DLSSample sample : samples) {</span>
<span class="nc" id="L907">            offsettable.add(Long.valueOf(wvpl.getFilePointer() - off));</span>
<span class="nc" id="L908">            writeSample(wvpl.writeList(&quot;wave&quot;), sample);</span>
<span class="nc" id="L909">        }</span>

        // small cheat, we are going to rewrite data back in wvpl
<span class="nc" id="L912">        long bak = writer.getFilePointer();</span>
<span class="nc" id="L913">        writer.seek(ptbl_offset);</span>
<span class="nc" id="L914">        writer.setWriteOverride(true);</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">        for (Long offset : offsettable)</span>
<span class="nc" id="L916">            writer.writeUnsignedInt(offset.longValue());</span>
<span class="nc" id="L917">        writer.setWriteOverride(false);</span>
<span class="nc" id="L918">        writer.seek(bak);</span>

<span class="nc" id="L920">        writeInfo(writer.writeList(&quot;INFO&quot;), info);</span>

<span class="nc" id="L922">        writer.close();</span>
<span class="nc" id="L923">    }</span>

    private void writeSample(RIFFWriter writer, DLSSample sample)
            throws IOException {

<span class="nc" id="L928">        AudioFormat audioformat = sample.getFormat();</span>

<span class="nc" id="L930">        Encoding encoding = audioformat.getEncoding();</span>
<span class="nc" id="L931">        float sampleRate = audioformat.getSampleRate();</span>
<span class="nc" id="L932">        int sampleSizeInBits = audioformat.getSampleSizeInBits();</span>
<span class="nc" id="L933">        int channels = audioformat.getChannels();</span>
<span class="nc" id="L934">        int frameSize = audioformat.getFrameSize();</span>
<span class="nc" id="L935">        float frameRate = audioformat.getFrameRate();</span>
<span class="nc" id="L936">        boolean bigEndian = audioformat.isBigEndian();</span>

<span class="nc" id="L938">        boolean convert_needed = false;</span>

<span class="nc bnc" id="L940" title="All 2 branches missed.">        if (audioformat.getSampleSizeInBits() == 8) {</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">            if (!encoding.equals(Encoding.PCM_UNSIGNED)) {</span>
<span class="nc" id="L942">                encoding = Encoding.PCM_UNSIGNED;</span>
<span class="nc" id="L943">                convert_needed = true;</span>
            }
        } else {
<span class="nc bnc" id="L946" title="All 2 branches missed.">            if (!encoding.equals(Encoding.PCM_SIGNED)) {</span>
<span class="nc" id="L947">                encoding = Encoding.PCM_SIGNED;</span>
<span class="nc" id="L948">                convert_needed = true;</span>
            }
<span class="nc bnc" id="L950" title="All 2 branches missed.">            if (bigEndian) {</span>
<span class="nc" id="L951">                bigEndian = false;</span>
<span class="nc" id="L952">                convert_needed = true;</span>
            }
        }

<span class="nc bnc" id="L956" title="All 2 branches missed.">        if (convert_needed) {</span>
<span class="nc" id="L957">            audioformat = new AudioFormat(encoding, sampleRate,</span>
                    sampleSizeInBits, channels, frameSize, frameRate, bigEndian);
        }

        // fmt
<span class="nc" id="L962">        RIFFWriter fmt_chunk = writer.writeChunk(&quot;fmt &quot;);</span>
<span class="nc" id="L963">        int sampleformat = 0;</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">        if (audioformat.getEncoding().equals(Encoding.PCM_UNSIGNED))</span>
<span class="nc" id="L965">            sampleformat = 1;</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">        else if (audioformat.getEncoding().equals(Encoding.PCM_SIGNED))</span>
<span class="nc" id="L967">            sampleformat = 1;</span>
<span class="nc bnc" id="L968" title="All 2 branches missed.">        else if (audioformat.getEncoding().equals(Encoding.PCM_FLOAT))</span>
<span class="nc" id="L969">            sampleformat = 3;</span>

<span class="nc" id="L971">        fmt_chunk.writeUnsignedShort(sampleformat);</span>
<span class="nc" id="L972">        fmt_chunk.writeUnsignedShort(audioformat.getChannels());</span>
<span class="nc" id="L973">        fmt_chunk.writeUnsignedInt((long) audioformat.getSampleRate());</span>
<span class="nc" id="L974">        long srate = ((long)audioformat.getFrameRate())*audioformat.getFrameSize();</span>
<span class="nc" id="L975">        fmt_chunk.writeUnsignedInt(srate);</span>
<span class="nc" id="L976">        fmt_chunk.writeUnsignedShort(audioformat.getFrameSize());</span>
<span class="nc" id="L977">        fmt_chunk.writeUnsignedShort(audioformat.getSampleSizeInBits());</span>
<span class="nc" id="L978">        fmt_chunk.write(0);</span>
<span class="nc" id="L979">        fmt_chunk.write(0);</span>

<span class="nc" id="L981">        writeSampleOptions(writer.writeChunk(&quot;wsmp&quot;), sample.sampleoptions);</span>

<span class="nc bnc" id="L983" title="All 2 branches missed.">        if (convert_needed) {</span>
<span class="nc" id="L984">            RIFFWriter data_chunk = writer.writeChunk(&quot;data&quot;);</span>
<span class="nc" id="L985">            AudioInputStream stream = AudioSystem.getAudioInputStream(</span>
<span class="nc" id="L986">                    audioformat, (AudioInputStream)sample.getData());</span>
<span class="nc" id="L987">            byte[] buff = new byte[1024];</span>
            int ret;
<span class="nc bnc" id="L989" title="All 2 branches missed.">            while ((ret = stream.read(buff)) != -1) {</span>
<span class="nc" id="L990">                data_chunk.write(buff, 0, ret);</span>
            }
<span class="nc" id="L992">        } else {</span>
<span class="nc" id="L993">            RIFFWriter data_chunk = writer.writeChunk(&quot;data&quot;);</span>
<span class="nc" id="L994">            ModelByteBuffer databuff = sample.getDataBuffer();</span>
<span class="nc" id="L995">            databuff.writeTo(data_chunk);</span>
            /*
            data_chunk.write(databuff.array(),
            databuff.arrayOffset(),
            databuff.capacity());
             */
        }

<span class="nc" id="L1003">        writeInfo(writer.writeList(&quot;INFO&quot;), sample.info);</span>
<span class="nc" id="L1004">    }</span>

    private void writeInstruments(RIFFWriter writer) throws IOException {
<span class="nc bnc" id="L1007" title="All 2 branches missed.">        for (DLSInstrument instrument : instruments) {</span>
<span class="nc" id="L1008">            writeInstrument(writer.writeList(&quot;ins &quot;), instrument);</span>
<span class="nc" id="L1009">        }</span>
<span class="nc" id="L1010">    }</span>

    private void writeInstrument(RIFFWriter writer, DLSInstrument instrument)
            throws IOException {

<span class="nc" id="L1015">        int art1_count = 0;</span>
<span class="nc" id="L1016">        int art2_count = 0;</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">        for (DLSModulator modulator : instrument.getModulators()) {</span>
<span class="nc bnc" id="L1018" title="All 2 branches missed.">            if (modulator.version == 1)</span>
<span class="nc" id="L1019">                art1_count++;</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">            if (modulator.version == 2)</span>
<span class="nc" id="L1021">                art2_count++;</span>
<span class="nc" id="L1022">        }</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">        for (DLSRegion region : instrument.regions) {</span>
<span class="nc bnc" id="L1024" title="All 2 branches missed.">            for (DLSModulator modulator : region.getModulators()) {</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">                if (modulator.version == 1)</span>
<span class="nc" id="L1026">                    art1_count++;</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">                if (modulator.version == 2)</span>
<span class="nc" id="L1028">                    art2_count++;</span>
<span class="nc" id="L1029">            }</span>
<span class="nc" id="L1030">        }</span>

<span class="nc" id="L1032">        int version = 1;</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">        if (art2_count &gt; 0)</span>
<span class="nc" id="L1034">            version = 2;</span>

<span class="nc" id="L1036">        RIFFWriter insh_chunk = writer.writeChunk(&quot;insh&quot;);</span>
<span class="nc" id="L1037">        insh_chunk.writeUnsignedInt(instrument.getRegions().size());</span>
<span class="nc bnc" id="L1038" title="All 2 branches missed.">        insh_chunk.writeUnsignedInt(instrument.bank +</span>
                (instrument.druminstrument ? 2147483648L : 0));
<span class="nc" id="L1040">        insh_chunk.writeUnsignedInt(instrument.preset);</span>

<span class="nc" id="L1042">        RIFFWriter lrgn = writer.writeList(&quot;lrgn&quot;);</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">        for (DLSRegion region: instrument.regions)</span>
<span class="nc" id="L1044">            writeRegion(lrgn, region, version);</span>

<span class="nc" id="L1046">        writeArticulators(writer, instrument.getModulators());</span>

<span class="nc" id="L1048">        writeInfo(writer.writeList(&quot;INFO&quot;), instrument.info);</span>

<span class="nc" id="L1050">    }</span>

    private void writeArticulators(RIFFWriter writer,
            List&lt;DLSModulator&gt; modulators) throws IOException {
<span class="nc" id="L1054">        int art1_count = 0;</span>
<span class="nc" id="L1055">        int art2_count = 0;</span>
<span class="nc bnc" id="L1056" title="All 2 branches missed.">        for (DLSModulator modulator : modulators) {</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">            if (modulator.version == 1)</span>
<span class="nc" id="L1058">                art1_count++;</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">            if (modulator.version == 2)</span>
<span class="nc" id="L1060">                art2_count++;</span>
<span class="nc" id="L1061">        }</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">        if (art1_count &gt; 0) {</span>
<span class="nc" id="L1063">            RIFFWriter lar1 = writer.writeList(&quot;lart&quot;);</span>
<span class="nc" id="L1064">            RIFFWriter art1 = lar1.writeChunk(&quot;art1&quot;);</span>
<span class="nc" id="L1065">            art1.writeUnsignedInt(8);</span>
<span class="nc" id="L1066">            art1.writeUnsignedInt(art1_count);</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">            for (DLSModulator modulator : modulators) {</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">                if (modulator.version == 1) {</span>
<span class="nc" id="L1069">                    art1.writeUnsignedShort(modulator.source);</span>
<span class="nc" id="L1070">                    art1.writeUnsignedShort(modulator.control);</span>
<span class="nc" id="L1071">                    art1.writeUnsignedShort(modulator.destination);</span>
<span class="nc" id="L1072">                    art1.writeUnsignedShort(modulator.transform);</span>
<span class="nc" id="L1073">                    art1.writeInt(modulator.scale);</span>
                }
<span class="nc" id="L1075">            }</span>
        }
<span class="nc bnc" id="L1077" title="All 2 branches missed.">        if (art2_count &gt; 0) {</span>
<span class="nc" id="L1078">            RIFFWriter lar2 = writer.writeList(&quot;lar2&quot;);</span>
<span class="nc" id="L1079">            RIFFWriter art2 = lar2.writeChunk(&quot;art2&quot;);</span>
<span class="nc" id="L1080">            art2.writeUnsignedInt(8);</span>
<span class="nc" id="L1081">            art2.writeUnsignedInt(art2_count);</span>
<span class="nc bnc" id="L1082" title="All 2 branches missed.">            for (DLSModulator modulator : modulators) {</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">                if (modulator.version == 2) {</span>
<span class="nc" id="L1084">                    art2.writeUnsignedShort(modulator.source);</span>
<span class="nc" id="L1085">                    art2.writeUnsignedShort(modulator.control);</span>
<span class="nc" id="L1086">                    art2.writeUnsignedShort(modulator.destination);</span>
<span class="nc" id="L1087">                    art2.writeUnsignedShort(modulator.transform);</span>
<span class="nc" id="L1088">                    art2.writeInt(modulator.scale);</span>
                }
<span class="nc" id="L1090">            }</span>
        }
<span class="nc" id="L1092">    }</span>

    private void writeRegion(RIFFWriter writer, DLSRegion region, int version)
            throws IOException {
<span class="nc" id="L1096">        RIFFWriter rgns = null;</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">        if (version == 1)</span>
<span class="nc" id="L1098">            rgns = writer.writeList(&quot;rgn &quot;);</span>
<span class="nc bnc" id="L1099" title="All 2 branches missed.">        if (version == 2)</span>
<span class="nc" id="L1100">            rgns = writer.writeList(&quot;rgn2&quot;);</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">        if (rgns == null)</span>
<span class="nc" id="L1102">            return;</span>

<span class="nc" id="L1104">        RIFFWriter rgnh = rgns.writeChunk(&quot;rgnh&quot;);</span>
<span class="nc" id="L1105">        rgnh.writeUnsignedShort(region.keyfrom);</span>
<span class="nc" id="L1106">        rgnh.writeUnsignedShort(region.keyto);</span>
<span class="nc" id="L1107">        rgnh.writeUnsignedShort(region.velfrom);</span>
<span class="nc" id="L1108">        rgnh.writeUnsignedShort(region.velto);</span>
<span class="nc" id="L1109">        rgnh.writeUnsignedShort(region.options);</span>
<span class="nc" id="L1110">        rgnh.writeUnsignedShort(region.exclusiveClass);</span>

<span class="nc bnc" id="L1112" title="All 2 branches missed.">        if (region.sampleoptions != null)</span>
<span class="nc" id="L1113">            writeSampleOptions(rgns.writeChunk(&quot;wsmp&quot;), region.sampleoptions);</span>

<span class="nc bnc" id="L1115" title="All 2 branches missed.">        if (region.sample != null) {</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">            if (samples.indexOf(region.sample) != -1) {</span>
<span class="nc" id="L1117">                RIFFWriter wlnk = rgns.writeChunk(&quot;wlnk&quot;);</span>
<span class="nc" id="L1118">                wlnk.writeUnsignedShort(region.fusoptions);</span>
<span class="nc" id="L1119">                wlnk.writeUnsignedShort(region.phasegroup);</span>
<span class="nc" id="L1120">                wlnk.writeUnsignedInt(region.channel);</span>
<span class="nc" id="L1121">                wlnk.writeUnsignedInt(samples.indexOf(region.sample));</span>
            }
        }
<span class="nc" id="L1124">        writeArticulators(rgns, region.getModulators());</span>
<span class="nc" id="L1125">        rgns.close();</span>
<span class="nc" id="L1126">    }</span>

    private void writeSampleOptions(RIFFWriter wsmp,
            DLSSampleOptions sampleoptions) throws IOException {
<span class="nc" id="L1130">        wsmp.writeUnsignedInt(20);</span>
<span class="nc" id="L1131">        wsmp.writeUnsignedShort(sampleoptions.unitynote);</span>
<span class="nc" id="L1132">        wsmp.writeShort(sampleoptions.finetune);</span>
<span class="nc" id="L1133">        wsmp.writeInt(sampleoptions.attenuation);</span>
<span class="nc" id="L1134">        wsmp.writeUnsignedInt(sampleoptions.options);</span>
<span class="nc" id="L1135">        wsmp.writeInt(sampleoptions.loops.size());</span>

<span class="nc bnc" id="L1137" title="All 2 branches missed.">        for (DLSSampleLoop loop : sampleoptions.loops) {</span>
<span class="nc" id="L1138">            wsmp.writeUnsignedInt(16);</span>
<span class="nc" id="L1139">            wsmp.writeUnsignedInt(loop.type);</span>
<span class="nc" id="L1140">            wsmp.writeUnsignedInt(loop.start);</span>
<span class="nc" id="L1141">            wsmp.writeUnsignedInt(loop.length);</span>
<span class="nc" id="L1142">        }</span>
<span class="nc" id="L1143">    }</span>

    private void writeInfoStringChunk(RIFFWriter writer,
            String name, String value) throws IOException {
<span class="nc bnc" id="L1147" title="All 2 branches missed.">        if (value == null)</span>
<span class="nc" id="L1148">            return;</span>
<span class="nc" id="L1149">        RIFFWriter chunk = writer.writeChunk(name);</span>
<span class="nc" id="L1150">        chunk.writeString(value);</span>
<span class="nc" id="L1151">        int len = value.getBytes(&quot;ascii&quot;).length;</span>
<span class="nc" id="L1152">        chunk.write(0);</span>
<span class="nc" id="L1153">        len++;</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">        if (len % 2 != 0)</span>
<span class="nc" id="L1155">            chunk.write(0);</span>
<span class="nc" id="L1156">    }</span>

    private void writeInfo(RIFFWriter writer, DLSInfo info) throws IOException {
<span class="nc" id="L1159">        writeInfoStringChunk(writer, &quot;INAM&quot;, info.name);</span>
<span class="nc" id="L1160">        writeInfoStringChunk(writer, &quot;ICRD&quot;, info.creationDate);</span>
<span class="nc" id="L1161">        writeInfoStringChunk(writer, &quot;IENG&quot;, info.engineers);</span>
<span class="nc" id="L1162">        writeInfoStringChunk(writer, &quot;IPRD&quot;, info.product);</span>
<span class="nc" id="L1163">        writeInfoStringChunk(writer, &quot;ICOP&quot;, info.copyright);</span>
<span class="nc" id="L1164">        writeInfoStringChunk(writer, &quot;ICMT&quot;, info.comments);</span>
<span class="nc" id="L1165">        writeInfoStringChunk(writer, &quot;ISFT&quot;, info.tools);</span>
<span class="nc" id="L1166">        writeInfoStringChunk(writer, &quot;IARL&quot;, info.archival_location);</span>
<span class="nc" id="L1167">        writeInfoStringChunk(writer, &quot;IART&quot;, info.artist);</span>
<span class="nc" id="L1168">        writeInfoStringChunk(writer, &quot;ICMS&quot;, info.commissioned);</span>
<span class="nc" id="L1169">        writeInfoStringChunk(writer, &quot;IGNR&quot;, info.genre);</span>
<span class="nc" id="L1170">        writeInfoStringChunk(writer, &quot;IKEY&quot;, info.keywords);</span>
<span class="nc" id="L1171">        writeInfoStringChunk(writer, &quot;IMED&quot;, info.medium);</span>
<span class="nc" id="L1172">        writeInfoStringChunk(writer, &quot;ISBJ&quot;, info.subject);</span>
<span class="nc" id="L1173">        writeInfoStringChunk(writer, &quot;ISRC&quot;, info.source);</span>
<span class="nc" id="L1174">        writeInfoStringChunk(writer, &quot;ISRF&quot;, info.source_form);</span>
<span class="nc" id="L1175">        writeInfoStringChunk(writer, &quot;ITCH&quot;, info.technician);</span>
<span class="nc" id="L1176">    }</span>

    public DLSInfo getInfo() {
<span class="nc" id="L1179">        return info;</span>
    }

    public String getName() {
<span class="nc" id="L1183">        return info.name;</span>
    }

    public String getVersion() {
<span class="nc" id="L1187">        return major + &quot;.&quot; + minor;</span>
    }

    public String getVendor() {
<span class="nc" id="L1191">        return info.engineers;</span>
    }

    public String getDescription() {
<span class="nc" id="L1195">        return info.comments;</span>
    }

    public void setName(String s) {
<span class="nc" id="L1199">        info.name = s;</span>
<span class="nc" id="L1200">    }</span>

    public void setVendor(String s) {
<span class="nc" id="L1203">        info.engineers = s;</span>
<span class="nc" id="L1204">    }</span>

    public void setDescription(String s) {
<span class="nc" id="L1207">        info.comments = s;</span>
<span class="nc" id="L1208">    }</span>

    public SoundbankResource[] getResources() {
<span class="nc" id="L1211">        SoundbankResource[] resources = new SoundbankResource[samples.size()];</span>
<span class="nc" id="L1212">        int j = 0;</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">        for (int i = 0; i &lt; samples.size(); i++)</span>
<span class="nc" id="L1214">            resources[j++] = samples.get(i);</span>
<span class="nc" id="L1215">        return resources;</span>
    }

    public DLSInstrument[] getInstruments() {
<span class="nc" id="L1219">        DLSInstrument[] inslist_array =</span>
<span class="nc" id="L1220">                instruments.toArray(new DLSInstrument[instruments.size()]);</span>
<span class="nc" id="L1221">        Arrays.sort(inslist_array, new ModelInstrumentComparator());</span>
<span class="nc" id="L1222">        return inslist_array;</span>
    }

    public DLSSample[] getSamples() {
<span class="nc" id="L1226">        return samples.toArray(new DLSSample[samples.size()]);</span>
    }

    public Instrument getInstrument(Patch patch) {
<span class="nc" id="L1230">        int program = patch.getProgram();</span>
<span class="nc" id="L1231">        int bank = patch.getBank();</span>
<span class="nc" id="L1232">        boolean percussion = false;</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">        if (patch instanceof ModelPatch)</span>
<span class="nc" id="L1234">            percussion = ((ModelPatch) patch).isPercussion();</span>
<span class="nc bnc" id="L1235" title="All 2 branches missed.">        for (Instrument instrument : instruments) {</span>
<span class="nc" id="L1236">            Patch patch2 = instrument.getPatch();</span>
<span class="nc" id="L1237">            int program2 = patch2.getProgram();</span>
<span class="nc" id="L1238">            int bank2 = patch2.getBank();</span>
<span class="nc bnc" id="L1239" title="All 4 branches missed.">            if (program == program2 &amp;&amp; bank == bank2) {</span>
<span class="nc" id="L1240">                boolean percussion2 = false;</span>
<span class="nc bnc" id="L1241" title="All 2 branches missed.">                if (patch2 instanceof ModelPatch)</span>
<span class="nc" id="L1242">                    percussion2 = ((ModelPatch) patch2).isPercussion();</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">                if (percussion == percussion2)</span>
<span class="nc" id="L1244">                    return instrument;</span>
            }
<span class="nc" id="L1246">        }</span>
<span class="nc" id="L1247">        return null;</span>
    }

    public void addResource(SoundbankResource resource) {
<span class="nc bnc" id="L1251" title="All 2 branches missed.">        if (resource instanceof DLSInstrument)</span>
<span class="nc" id="L1252">            instruments.add((DLSInstrument) resource);</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">        if (resource instanceof DLSSample)</span>
<span class="nc" id="L1254">            samples.add((DLSSample) resource);</span>
<span class="nc" id="L1255">    }</span>

    public void removeResource(SoundbankResource resource) {
<span class="nc bnc" id="L1258" title="All 2 branches missed.">        if (resource instanceof DLSInstrument)</span>
<span class="nc" id="L1259">            instruments.remove((DLSInstrument) resource);</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">        if (resource instanceof DLSSample)</span>
<span class="nc" id="L1261">            samples.remove((DLSSample) resource);</span>
<span class="nc" id="L1262">    }</span>

    public void addInstrument(DLSInstrument resource) {
<span class="nc" id="L1265">        instruments.add(resource);</span>
<span class="nc" id="L1266">    }</span>

    public void removeInstrument(DLSInstrument resource) {
<span class="nc" id="L1269">        instruments.remove(resource);</span>
<span class="nc" id="L1270">    }</span>

    public long getMajor() {
<span class="nc" id="L1273">        return major;</span>
    }

    public void setMajor(long major) {
<span class="nc" id="L1277">        this.major = major;</span>
<span class="nc" id="L1278">    }</span>

    public long getMinor() {
<span class="nc" id="L1281">        return minor;</span>
    }

    public void setMinor(long minor) {
<span class="nc" id="L1285">        this.minor = minor;</span>
<span class="nc" id="L1286">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>