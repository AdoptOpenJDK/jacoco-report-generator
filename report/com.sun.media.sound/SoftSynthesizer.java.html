<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SoftSynthesizer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">SoftSynthesizer.java</span></div><h1>SoftSynthesizer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2008, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.media.sound;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.lang.ref.WeakReference;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.StringTokenizer;
import java.util.prefs.BackingStoreException;
import java.util.prefs.Preferences;

import javax.sound.midi.Instrument;
import javax.sound.midi.MidiChannel;
import javax.sound.midi.MidiDevice;
import javax.sound.midi.MidiSystem;
import javax.sound.midi.MidiUnavailableException;
import javax.sound.midi.Patch;
import javax.sound.midi.Receiver;
import javax.sound.midi.Soundbank;
import javax.sound.midi.Transmitter;
import javax.sound.midi.VoiceStatus;
import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.LineUnavailableException;
import javax.sound.sampled.SourceDataLine;

/**
 * The software synthesizer class.
 *
 * @author Karl Helgason
 */
<span class="nc" id="L69">public final class SoftSynthesizer implements AudioSynthesizer,</span>
        ReferenceCountingDevice {

    protected static final class WeakAudioStream extends InputStream
    {
        private volatile AudioInputStream stream;
<span class="nc" id="L75">        public SoftAudioPusher pusher = null;</span>
<span class="nc" id="L76">        public AudioInputStream jitter_stream = null;</span>
<span class="nc" id="L77">        public SourceDataLine sourceDataLine = null;</span>
<span class="nc" id="L78">        public volatile long silent_samples = 0;</span>
<span class="nc" id="L79">        private int framesize = 0;</span>
        private WeakReference&lt;AudioInputStream&gt; weak_stream_link;
        private AudioFloatConverter converter;
<span class="nc" id="L82">        private float[] silentbuffer = null;</span>
        private int samplesize;

        public void setInputStream(AudioInputStream stream)
        {
<span class="nc" id="L87">            this.stream = stream;</span>
<span class="nc" id="L88">        }</span>

        public int available() throws IOException {
<span class="nc" id="L91">            AudioInputStream local_stream = stream;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if(local_stream != null)</span>
<span class="nc" id="L93">                return local_stream.available();</span>
<span class="nc" id="L94">            return 0;</span>
        }

        public int read() throws IOException {
<span class="nc" id="L98">             byte[] b = new byte[1];</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">             if (read(b) == -1)</span>
<span class="nc" id="L100">                  return -1;</span>
<span class="nc" id="L101">             return b[0] &amp; 0xFF;</span>
        }

        public int read(byte[] b, int off, int len) throws IOException {
<span class="nc" id="L105">             AudioInputStream local_stream = stream;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">             if(local_stream != null)</span>
<span class="nc" id="L107">                 return local_stream.read(b, off, len);</span>
             else
             {
<span class="nc" id="L110">                 int flen = len / samplesize;</span>
<span class="nc bnc" id="L111" title="All 4 branches missed.">                 if(silentbuffer == null || silentbuffer.length &lt; flen)</span>
<span class="nc" id="L112">                     silentbuffer = new float[flen];</span>
<span class="nc" id="L113">                 converter.toByteArray(silentbuffer, flen, b, off);</span>

<span class="nc" id="L115">                 silent_samples += (long)((len / framesize));</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">                 if(pusher != null)</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                 if(weak_stream_link.get() == null)</span>
                 {
<span class="nc" id="L120">                     Runnable runnable = new Runnable()</span>
<span class="nc" id="L121">                     {</span>
<span class="nc" id="L122">                         SoftAudioPusher _pusher = pusher;</span>
<span class="nc" id="L123">                         AudioInputStream _jitter_stream = jitter_stream;</span>
<span class="nc" id="L124">                         SourceDataLine _sourceDataLine = sourceDataLine;</span>
                         public void run()
                         {
<span class="nc" id="L127">                             _pusher.stop();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                             if(_jitter_stream != null)</span>
                                try {
<span class="nc" id="L130">                                    _jitter_stream.close();</span>
<span class="nc" id="L131">                                } catch (IOException e) {</span>
<span class="nc" id="L132">                                    e.printStackTrace();</span>
<span class="nc" id="L133">                                }</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">                             if(_sourceDataLine != null)</span>
<span class="nc" id="L135">                                 _sourceDataLine.close();</span>
<span class="nc" id="L136">                         }</span>
                     };
<span class="nc" id="L138">                     pusher = null;</span>
<span class="nc" id="L139">                     jitter_stream = null;</span>
<span class="nc" id="L140">                     sourceDataLine = null;</span>
<span class="nc" id="L141">                     new Thread(runnable).start();</span>
                 }
<span class="nc" id="L143">                 return len;</span>
             }
        }

<span class="nc" id="L147">        public WeakAudioStream(AudioInputStream stream) {</span>
<span class="nc" id="L148">            this.stream = stream;</span>
<span class="nc" id="L149">            weak_stream_link = new WeakReference&lt;AudioInputStream&gt;(stream);</span>
<span class="nc" id="L150">            converter = AudioFloatConverter.getConverter(stream.getFormat());</span>
<span class="nc" id="L151">            samplesize = stream.getFormat().getFrameSize() / stream.getFormat().getChannels();</span>
<span class="nc" id="L152">            framesize = stream.getFormat().getFrameSize();</span>
<span class="nc" id="L153">        }</span>

        public AudioInputStream getAudioInputStream()
        {
<span class="nc" id="L157">            return new AudioInputStream(this, stream.getFormat(), AudioSystem.NOT_SPECIFIED);</span>
        }

        public void close() throws IOException
        {
<span class="nc" id="L162">            AudioInputStream astream  = weak_stream_link.get();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if(astream != null)</span>
<span class="nc" id="L164">                astream.close();</span>
<span class="nc" id="L165">        }</span>
    }

    private static class Info extends MidiDevice.Info {
        Info() {
<span class="nc" id="L170">            super(INFO_NAME, INFO_VENDOR, INFO_DESCRIPTION, INFO_VERSION);</span>
<span class="nc" id="L171">        }</span>
    }

    static final String INFO_NAME = &quot;Gervill&quot;;
    static final String INFO_VENDOR = &quot;OpenJDK&quot;;
    static final String INFO_DESCRIPTION = &quot;Software MIDI Synthesizer&quot;;
    static final String INFO_VERSION = &quot;1.0&quot;;
<span class="nc" id="L178">    final static MidiDevice.Info info = new Info();</span>

<span class="nc" id="L180">    private static SourceDataLine testline = null;</span>

<span class="nc" id="L182">    private static Soundbank defaultSoundBank = null;</span>

<span class="nc" id="L184">    WeakAudioStream weakstream = null;</span>

<span class="nc" id="L186">    final Object control_mutex = this;</span>

<span class="nc" id="L188">    int voiceIDCounter = 0;</span>

    // 0: default
    // 1: DLS Voice Allocation
<span class="nc" id="L192">    int voice_allocation_mode = 0;</span>

<span class="nc" id="L194">    boolean load_default_soundbank = false;</span>
<span class="nc" id="L195">    boolean reverb_light = true;</span>
<span class="nc" id="L196">    boolean reverb_on = true;</span>
<span class="nc" id="L197">    boolean chorus_on = true;</span>
<span class="nc" id="L198">    boolean agc_on = true;</span>

    SoftChannel[] channels;
<span class="nc" id="L201">    SoftChannelProxy[] external_channels = null;</span>

<span class="nc" id="L203">    private boolean largemode = false;</span>

    // 0: GM Mode off (default)
    // 1: GM Level 1
    // 2: GM Level 2
<span class="nc" id="L208">    private int gmmode = 0;</span>

<span class="nc" id="L210">    private int deviceid = 0;</span>

<span class="nc" id="L212">    private AudioFormat format = new AudioFormat(44100, 16, 2, true, false);</span>

<span class="nc" id="L214">    private SourceDataLine sourceDataLine = null;</span>

<span class="nc" id="L216">    private SoftAudioPusher pusher = null;</span>
<span class="nc" id="L217">    private AudioInputStream pusher_stream = null;</span>

<span class="nc" id="L219">    private float controlrate = 147f;</span>

<span class="nc" id="L221">    private boolean open = false;</span>
<span class="nc" id="L222">    private boolean implicitOpen = false;</span>

<span class="nc" id="L224">    private String resamplerType = &quot;linear&quot;;</span>
<span class="nc" id="L225">    private SoftResampler resampler = new SoftLinearResampler();</span>

<span class="nc" id="L227">    private int number_of_midi_channels = 16;</span>
<span class="nc" id="L228">    private int maxpoly = 64;</span>
<span class="nc" id="L229">    private long latency = 200000; // 200 msec</span>
<span class="nc" id="L230">    private boolean jitter_correction = false;</span>

    private SoftMainMixer mainmixer;
    private SoftVoice[] voices;

<span class="nc" id="L235">    private Map&lt;String, SoftTuning&gt; tunings</span>
            = new HashMap&lt;String, SoftTuning&gt;();
<span class="nc" id="L237">    private Map&lt;String, SoftInstrument&gt; inslist</span>
            = new HashMap&lt;String, SoftInstrument&gt;();
<span class="nc" id="L239">    private Map&lt;String, ModelInstrument&gt; loadedlist</span>
            = new HashMap&lt;String, ModelInstrument&gt;();

<span class="nc" id="L242">    private ArrayList&lt;Receiver&gt; recvslist = new ArrayList&lt;Receiver&gt;();</span>

    private void getBuffers(ModelInstrument instrument,
            List&lt;ModelByteBuffer&gt; buffers) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">        for (ModelPerformer performer : instrument.getPerformers()) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">            if (performer.getOscillators() != null) {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                for (ModelOscillator osc : performer.getOscillators()) {</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                    if (osc instanceof ModelByteBufferWavetable) {</span>
<span class="nc" id="L250">                        ModelByteBufferWavetable w = (ModelByteBufferWavetable)osc;</span>
<span class="nc" id="L251">                        ModelByteBuffer buff = w.getBuffer();</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                        if (buff != null)</span>
<span class="nc" id="L253">                            buffers.add(buff);</span>
<span class="nc" id="L254">                        buff = w.get8BitExtensionBuffer();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                        if (buff != null)</span>
<span class="nc" id="L256">                            buffers.add(buff);</span>
                    }
<span class="nc" id="L258">                }</span>
            }
        }
<span class="nc" id="L261">    }</span>

    private boolean loadSamples(List&lt;ModelInstrument&gt; instruments) {
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (largemode)</span>
<span class="nc" id="L265">            return true;</span>
<span class="nc" id="L266">        List&lt;ModelByteBuffer&gt; buffers = new ArrayList&lt;ModelByteBuffer&gt;();</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">        for (ModelInstrument instrument : instruments)</span>
<span class="nc" id="L268">            getBuffers(instrument, buffers);</span>
        try {
<span class="nc" id="L270">            ModelByteBuffer.loadAll(buffers);</span>
<span class="nc" id="L271">        } catch (IOException e) {</span>
<span class="nc" id="L272">            return false;</span>
<span class="nc" id="L273">        }</span>
<span class="nc" id="L274">        return true;</span>
    }

    private boolean loadInstruments(List&lt;ModelInstrument&gt; instruments) {
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L279">            return false;</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (!loadSamples(instruments))</span>
<span class="nc" id="L281">            return false;</span>

<span class="nc" id="L283">        synchronized (control_mutex) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (channels != null)</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                for (SoftChannel c : channels)</span>
                {
<span class="nc" id="L287">                    c.current_instrument = null;</span>
<span class="nc" id="L288">                    c.current_director = null;</span>
                }
<span class="nc bnc" id="L290" title="All 2 branches missed.">            for (Instrument instrument : instruments) {</span>
<span class="nc" id="L291">                String pat = patchToString(instrument.getPatch());</span>
<span class="nc" id="L292">                SoftInstrument softins</span>
                        = new SoftInstrument((ModelInstrument) instrument);
<span class="nc" id="L294">                inslist.put(pat, softins);</span>
<span class="nc" id="L295">                loadedlist.put(pat, (ModelInstrument) instrument);</span>
<span class="nc" id="L296">            }</span>
<span class="nc" id="L297">        }</span>

<span class="nc" id="L299">        return true;</span>
    }

    private void processPropertyInfo(Map&lt;String, Object&gt; info) {
<span class="nc" id="L303">        AudioSynthesizerPropertyInfo[] items = getPropertyInfo(info);</span>

<span class="nc" id="L305">        String resamplerType = (String)items[0].value;</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (resamplerType.equalsIgnoreCase(&quot;point&quot;))</span>
        {
<span class="nc" id="L308">            this.resampler = new SoftPointResampler();</span>
<span class="nc" id="L309">            this.resamplerType = &quot;point&quot;;</span>
        }
<span class="nc bnc" id="L311" title="All 2 branches missed.">        else if (resamplerType.equalsIgnoreCase(&quot;linear&quot;))</span>
        {
<span class="nc" id="L313">            this.resampler = new SoftLinearResampler2();</span>
<span class="nc" id="L314">            this.resamplerType = &quot;linear&quot;;</span>
        }
<span class="nc bnc" id="L316" title="All 2 branches missed.">        else if (resamplerType.equalsIgnoreCase(&quot;linear1&quot;))</span>
        {
<span class="nc" id="L318">            this.resampler = new SoftLinearResampler();</span>
<span class="nc" id="L319">            this.resamplerType = &quot;linear1&quot;;</span>
        }
<span class="nc bnc" id="L321" title="All 2 branches missed.">        else if (resamplerType.equalsIgnoreCase(&quot;linear2&quot;))</span>
        {
<span class="nc" id="L323">            this.resampler = new SoftLinearResampler2();</span>
<span class="nc" id="L324">            this.resamplerType = &quot;linear2&quot;;</span>
        }
<span class="nc bnc" id="L326" title="All 2 branches missed.">        else if (resamplerType.equalsIgnoreCase(&quot;cubic&quot;))</span>
        {
<span class="nc" id="L328">            this.resampler = new SoftCubicResampler();</span>
<span class="nc" id="L329">            this.resamplerType = &quot;cubic&quot;;</span>
        }
<span class="nc bnc" id="L331" title="All 2 branches missed.">        else if (resamplerType.equalsIgnoreCase(&quot;lanczos&quot;))</span>
        {
<span class="nc" id="L333">            this.resampler = new SoftLanczosResampler();</span>
<span class="nc" id="L334">            this.resamplerType = &quot;lanczos&quot;;</span>
        }
<span class="nc bnc" id="L336" title="All 2 branches missed.">        else if (resamplerType.equalsIgnoreCase(&quot;sinc&quot;))</span>
        {
<span class="nc" id="L338">            this.resampler = new SoftSincResampler();</span>
<span class="nc" id="L339">            this.resamplerType = &quot;sinc&quot;;</span>
        }

<span class="nc" id="L342">        setFormat((AudioFormat)items[2].value);</span>
<span class="nc" id="L343">        controlrate = (Float)items[1].value;</span>
<span class="nc" id="L344">        latency = (Long)items[3].value;</span>
<span class="nc" id="L345">        deviceid = (Integer)items[4].value;</span>
<span class="nc" id="L346">        maxpoly = (Integer)items[5].value;</span>
<span class="nc" id="L347">        reverb_on = (Boolean)items[6].value;</span>
<span class="nc" id="L348">        chorus_on = (Boolean)items[7].value;</span>
<span class="nc" id="L349">        agc_on = (Boolean)items[8].value;</span>
<span class="nc" id="L350">        largemode = (Boolean)items[9].value;</span>
<span class="nc" id="L351">        number_of_midi_channels = (Integer)items[10].value;</span>
<span class="nc" id="L352">        jitter_correction = (Boolean)items[11].value;</span>
<span class="nc" id="L353">        reverb_light = (Boolean)items[12].value;</span>
<span class="nc" id="L354">        load_default_soundbank = (Boolean)items[13].value;</span>
<span class="nc" id="L355">    }</span>

    private String patchToString(Patch patch) {
<span class="nc bnc" id="L358" title="All 4 branches missed.">        if (patch instanceof ModelPatch &amp;&amp; ((ModelPatch) patch).isPercussion())</span>
<span class="nc" id="L359">            return &quot;p.&quot; + patch.getProgram() + &quot;.&quot; + patch.getBank();</span>
        else
<span class="nc" id="L361">            return patch.getProgram() + &quot;.&quot; + patch.getBank();</span>
    }

    private void setFormat(AudioFormat format) {
<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (format.getChannels() &gt; 2) {</span>
<span class="nc" id="L366">            throw new IllegalArgumentException(</span>
                    &quot;Only mono and stereo audio supported.&quot;);
        }
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (AudioFloatConverter.getConverter(format) == null)</span>
<span class="nc" id="L370">            throw new IllegalArgumentException(&quot;Audio format not supported.&quot;);</span>
<span class="nc" id="L371">        this.format = format;</span>
<span class="nc" id="L372">    }</span>

    void removeReceiver(Receiver recv) {
<span class="nc" id="L375">        boolean perform_close = false;</span>
<span class="nc" id="L376">        synchronized (control_mutex) {</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            if (recvslist.remove(recv)) {</span>
<span class="nc bnc" id="L378" title="All 4 branches missed.">                if (implicitOpen &amp;&amp; recvslist.isEmpty())</span>
<span class="nc" id="L379">                    perform_close = true;</span>
            }
<span class="nc" id="L381">        }</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">        if (perform_close)</span>
<span class="nc" id="L383">            close();</span>
<span class="nc" id="L384">    }</span>

    SoftMainMixer getMainMixer() {
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L388">            return null;</span>
<span class="nc" id="L389">        return mainmixer;</span>
    }

    SoftInstrument findInstrument(int program, int bank, int channel) {

        // Add support for GM2 banks 0x78 and 0x79
        // as specified in DLS 2.2 in Section 1.4.6
        // which allows using percussion and melodic instruments
        // on all channels
<span class="nc bnc" id="L398" title="All 4 branches missed.">        if (bank &gt;&gt; 7 == 0x78 || bank &gt;&gt; 7 == 0x79) {</span>
<span class="nc" id="L399">            SoftInstrument current_instrument</span>
<span class="nc" id="L400">                    = inslist.get(program + &quot;.&quot; + bank);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (current_instrument != null)</span>
<span class="nc" id="L402">                return current_instrument;</span>

            String p_plaf;
<span class="nc bnc" id="L405" title="All 2 branches missed.">            if (bank &gt;&gt; 7 == 0x78)</span>
<span class="nc" id="L406">                p_plaf = &quot;p.&quot;;</span>
            else
<span class="nc" id="L408">                p_plaf = &quot;&quot;;</span>

            // Instrument not found fallback to MSB:bank, LSB:0
<span class="nc" id="L411">            current_instrument = inslist.get(p_plaf + program + &quot;.&quot;</span>
                    + ((bank &amp; 128) &lt;&lt; 7));
<span class="nc bnc" id="L413" title="All 2 branches missed.">            if (current_instrument != null)</span>
<span class="nc" id="L414">                return current_instrument;</span>
            // Instrument not found fallback to MSB:0, LSB:bank
<span class="nc" id="L416">            current_instrument = inslist.get(p_plaf + program + &quot;.&quot;</span>
                    + (bank &amp; 128));
<span class="nc bnc" id="L418" title="All 2 branches missed.">            if (current_instrument != null)</span>
<span class="nc" id="L419">                return current_instrument;</span>
            // Instrument not found fallback to MSB:0, LSB:0
<span class="nc" id="L421">            current_instrument = inslist.get(p_plaf + program + &quot;.0&quot;);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">            if (current_instrument != null)</span>
<span class="nc" id="L423">                return current_instrument;</span>
            // Instrument not found fallback to MSB:0, LSB:0, program=0
<span class="nc" id="L425">            current_instrument = inslist.get(p_plaf + program + &quot;0.0&quot;);</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">            if (current_instrument != null)</span>
<span class="nc" id="L427">                return current_instrument;</span>
<span class="nc" id="L428">            return null;</span>
        }

        // Channel 10 uses percussion instruments
        String p_plaf;
<span class="nc bnc" id="L433" title="All 2 branches missed.">        if (channel == 9)</span>
<span class="nc" id="L434">            p_plaf = &quot;p.&quot;;</span>
        else
<span class="nc" id="L436">            p_plaf = &quot;&quot;;</span>

<span class="nc" id="L438">        SoftInstrument current_instrument</span>
<span class="nc" id="L439">                = inslist.get(p_plaf + program + &quot;.&quot; + bank);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">        if (current_instrument != null)</span>
<span class="nc" id="L441">            return current_instrument;</span>
        // Instrument not found fallback to MSB:0, LSB:0
<span class="nc" id="L443">        current_instrument = inslist.get(p_plaf + program + &quot;.0&quot;);</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">        if (current_instrument != null)</span>
<span class="nc" id="L445">            return current_instrument;</span>
        // Instrument not found fallback to MSB:0, LSB:0, program=0
<span class="nc" id="L447">        current_instrument = inslist.get(p_plaf + &quot;0.0&quot;);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">        if (current_instrument != null)</span>
<span class="nc" id="L449">            return current_instrument;</span>
<span class="nc" id="L450">        return null;</span>
    }

    int getVoiceAllocationMode() {
<span class="nc" id="L454">        return voice_allocation_mode;</span>
    }

    int getGeneralMidiMode() {
<span class="nc" id="L458">        return gmmode;</span>
    }

    void setGeneralMidiMode(int gmmode) {
<span class="nc" id="L462">        this.gmmode = gmmode;</span>
<span class="nc" id="L463">    }</span>

    int getDeviceID() {
<span class="nc" id="L466">        return deviceid;</span>
    }

    float getControlRate() {
<span class="nc" id="L470">        return controlrate;</span>
    }

    SoftVoice[] getVoices() {
<span class="nc" id="L474">        return voices;</span>
    }

    SoftTuning getTuning(Patch patch) {
<span class="nc" id="L478">        String t_id = patchToString(patch);</span>
<span class="nc" id="L479">        SoftTuning tuning = tunings.get(t_id);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (tuning == null) {</span>
<span class="nc" id="L481">            tuning = new SoftTuning(patch);</span>
<span class="nc" id="L482">            tunings.put(t_id, tuning);</span>
        }
<span class="nc" id="L484">        return tuning;</span>
    }

    public long getLatency() {
<span class="nc" id="L488">        synchronized (control_mutex) {</span>
<span class="nc" id="L489">            return latency;</span>
<span class="nc" id="L490">        }</span>
    }

    public AudioFormat getFormat() {
<span class="nc" id="L494">        synchronized (control_mutex) {</span>
<span class="nc" id="L495">            return format;</span>
<span class="nc" id="L496">        }</span>
    }

    public int getMaxPolyphony() {
<span class="nc" id="L500">        synchronized (control_mutex) {</span>
<span class="nc" id="L501">            return maxpoly;</span>
<span class="nc" id="L502">        }</span>
    }

    public MidiChannel[] getChannels() {

<span class="nc" id="L507">        synchronized (control_mutex) {</span>
            // if (external_channels == null) =&gt; the synthesizer is not open,
            // create 16 proxy channels
            // otherwise external_channels has the same length as channels array
<span class="nc bnc" id="L511" title="All 2 branches missed.">            if (external_channels == null) {</span>
<span class="nc" id="L512">                external_channels = new SoftChannelProxy[16];</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">                for (int i = 0; i &lt; external_channels.length; i++)</span>
<span class="nc" id="L514">                    external_channels[i] = new SoftChannelProxy();</span>
            }
            MidiChannel[] ret;
<span class="nc bnc" id="L517" title="All 2 branches missed.">            if (isOpen())</span>
<span class="nc" id="L518">                ret = new MidiChannel[channels.length];</span>
            else
<span class="nc" id="L520">                ret = new MidiChannel[16];</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">            for (int i = 0; i &lt; ret.length; i++)</span>
<span class="nc" id="L522">                ret[i] = external_channels[i];</span>
<span class="nc" id="L523">            return ret;</span>
<span class="nc" id="L524">        }</span>
    }

    public VoiceStatus[] getVoiceStatus() {
<span class="nc bnc" id="L528" title="All 2 branches missed.">        if (!isOpen()) {</span>
<span class="nc" id="L529">            VoiceStatus[] tempVoiceStatusArray</span>
<span class="nc" id="L530">                    = new VoiceStatus[getMaxPolyphony()];</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">            for (int i = 0; i &lt; tempVoiceStatusArray.length; i++) {</span>
<span class="nc" id="L532">                VoiceStatus b = new VoiceStatus();</span>
<span class="nc" id="L533">                b.active = false;</span>
<span class="nc" id="L534">                b.bank = 0;</span>
<span class="nc" id="L535">                b.channel = 0;</span>
<span class="nc" id="L536">                b.note = 0;</span>
<span class="nc" id="L537">                b.program = 0;</span>
<span class="nc" id="L538">                b.volume = 0;</span>
<span class="nc" id="L539">                tempVoiceStatusArray[i] = b;</span>
            }
<span class="nc" id="L541">            return tempVoiceStatusArray;</span>
        }

<span class="nc" id="L544">        synchronized (control_mutex) {</span>
<span class="nc" id="L545">            VoiceStatus[] tempVoiceStatusArray = new VoiceStatus[voices.length];</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">            for (int i = 0; i &lt; voices.length; i++) {</span>
<span class="nc" id="L547">                VoiceStatus a = voices[i];</span>
<span class="nc" id="L548">                VoiceStatus b = new VoiceStatus();</span>
<span class="nc" id="L549">                b.active = a.active;</span>
<span class="nc" id="L550">                b.bank = a.bank;</span>
<span class="nc" id="L551">                b.channel = a.channel;</span>
<span class="nc" id="L552">                b.note = a.note;</span>
<span class="nc" id="L553">                b.program = a.program;</span>
<span class="nc" id="L554">                b.volume = a.volume;</span>
<span class="nc" id="L555">                tempVoiceStatusArray[i] = b;</span>
            }
<span class="nc" id="L557">            return tempVoiceStatusArray;</span>
<span class="nc" id="L558">        }</span>
    }

    public boolean isSoundbankSupported(Soundbank soundbank) {
<span class="nc bnc" id="L562" title="All 2 branches missed.">        for (Instrument ins: soundbank.getInstruments())</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">            if (!(ins instanceof ModelInstrument))</span>
<span class="nc" id="L564">                return false;</span>
<span class="nc" id="L565">        return true;</span>
    }

    public boolean loadInstrument(Instrument instrument) {
<span class="nc bnc" id="L569" title="All 4 branches missed.">        if (instrument == null || (!(instrument instanceof ModelInstrument))) {</span>
<span class="nc" id="L570">            throw new IllegalArgumentException(&quot;Unsupported instrument: &quot; +</span>
                    instrument);
        }
<span class="nc" id="L573">        List&lt;ModelInstrument&gt; instruments = new ArrayList&lt;ModelInstrument&gt;();</span>
<span class="nc" id="L574">        instruments.add((ModelInstrument)instrument);</span>
<span class="nc" id="L575">        return loadInstruments(instruments);</span>
    }

    public void unloadInstrument(Instrument instrument) {
<span class="nc bnc" id="L579" title="All 4 branches missed.">        if (instrument == null || (!(instrument instanceof ModelInstrument))) {</span>
<span class="nc" id="L580">            throw new IllegalArgumentException(&quot;Unsupported instrument: &quot; +</span>
                    instrument);
        }
<span class="nc bnc" id="L583" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L584">            return;</span>

<span class="nc" id="L586">        String pat = patchToString(instrument.getPatch());</span>
<span class="nc" id="L587">        synchronized (control_mutex) {</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">            for (SoftChannel c: channels)</span>
<span class="nc" id="L589">                c.current_instrument = null;</span>
<span class="nc" id="L590">            inslist.remove(pat);</span>
<span class="nc" id="L591">            loadedlist.remove(pat);</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">            for (int i = 0; i &lt; channels.length; i++) {</span>
<span class="nc" id="L593">                channels[i].allSoundOff();</span>
            }
<span class="nc" id="L595">        }</span>
<span class="nc" id="L596">    }</span>

    public boolean remapInstrument(Instrument from, Instrument to) {

<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (from == null)</span>
<span class="nc" id="L601">            throw new NullPointerException();</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if (to == null)</span>
<span class="nc" id="L603">            throw new NullPointerException();</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">        if (!(from instanceof ModelInstrument)) {</span>
<span class="nc" id="L605">            throw new IllegalArgumentException(&quot;Unsupported instrument: &quot; +</span>
<span class="nc" id="L606">                    from.toString());</span>
        }
<span class="nc bnc" id="L608" title="All 2 branches missed.">        if (!(to instanceof ModelInstrument)) {</span>
<span class="nc" id="L609">            throw new IllegalArgumentException(&quot;Unsupported instrument: &quot; +</span>
<span class="nc" id="L610">                    to.toString());</span>
        }
<span class="nc bnc" id="L612" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L613">            return false;</span>

<span class="nc" id="L615">        synchronized (control_mutex) {</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">            if (!loadedlist.containsValue(to))</span>
<span class="nc" id="L617">                throw new IllegalArgumentException(&quot;Instrument to is not loaded.&quot;);</span>
<span class="nc" id="L618">            unloadInstrument(from);</span>
<span class="nc" id="L619">            ModelMappedInstrument mfrom = new ModelMappedInstrument(</span>
<span class="nc" id="L620">                    (ModelInstrument)to, from.getPatch());</span>
<span class="nc" id="L621">            return loadInstrument(mfrom);</span>
<span class="nc" id="L622">        }</span>
    }

    public Soundbank getDefaultSoundbank() {
<span class="nc" id="L626">        synchronized (SoftSynthesizer.class) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">            if (defaultSoundBank != null)</span>
<span class="nc" id="L628">                return defaultSoundBank;</span>

<span class="nc" id="L630">            List&lt;PrivilegedAction&lt;InputStream&gt;&gt; actions =</span>
                new ArrayList&lt;PrivilegedAction&lt;InputStream&gt;&gt;();

<span class="nc" id="L633">            actions.add(new PrivilegedAction&lt;InputStream&gt;() {</span>
                public InputStream run() {
<span class="nc" id="L635">                    File javahome = new File(System.getProperties()</span>
<span class="nc" id="L636">                            .getProperty(&quot;java.home&quot;));</span>
<span class="nc" id="L637">                    File libaudio = new File(new File(javahome, &quot;lib&quot;), &quot;audio&quot;);</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">                    if (libaudio.exists()) {</span>
<span class="nc" id="L639">                        File foundfile = null;</span>
<span class="nc" id="L640">                        File[] files = libaudio.listFiles();</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">                        if (files != null) {</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">                            for (int i = 0; i &lt; files.length; i++) {</span>
<span class="nc" id="L643">                                File file = files[i];</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">                                if (file.isFile()) {</span>
<span class="nc" id="L645">                                    String lname = file.getName().toLowerCase();</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">                                    if (lname.endsWith(&quot;.sf2&quot;)</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">                                            || lname.endsWith(&quot;.dls&quot;)) {</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">                                        if (foundfile == null</span>
<span class="nc" id="L649">                                                || (file.length() &gt; foundfile</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                                                        .length())) {</span>
<span class="nc" id="L651">                                            foundfile = file;</span>
                                        }
                                    }
                                }
                            }
                        }
<span class="nc bnc" id="L657" title="All 2 branches missed.">                        if (foundfile != null) {</span>
                            try {
<span class="nc" id="L659">                                return new FileInputStream(foundfile);</span>
<span class="nc" id="L660">                            } catch (IOException e) {</span>
                            }
                        }
                    }
<span class="nc" id="L664">                    return null;</span>
                }
            });

<span class="nc" id="L668">            actions.add(new PrivilegedAction&lt;InputStream&gt;() {</span>
                public InputStream run() {
<span class="nc" id="L670">                    if (System.getProperties().getProperty(&quot;os.name&quot;)</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">                            .startsWith(&quot;Windows&quot;)) {</span>
<span class="nc" id="L672">                        File gm_dls = new File(System.getenv(&quot;SystemRoot&quot;)</span>
                                + &quot;\\system32\\drivers\\gm.dls&quot;);
<span class="nc bnc" id="L674" title="All 2 branches missed.">                        if (gm_dls.exists()) {</span>
                            try {
<span class="nc" id="L676">                                return new FileInputStream(gm_dls);</span>
<span class="nc" id="L677">                            } catch (IOException e) {</span>
                            }
                        }
                    }
<span class="nc" id="L681">                    return null;</span>
                }
            });

<span class="nc" id="L685">            actions.add(new PrivilegedAction&lt;InputStream&gt;() {</span>
                public InputStream run() {
                    /*
                     * Try to load saved generated soundbank
                     */
<span class="nc" id="L690">                    File userhome = new File(System.getProperty(&quot;user.home&quot;),</span>
                            &quot;.gervill&quot;);
<span class="nc" id="L692">                    File emg_soundbank_file = new File(userhome,</span>
                            &quot;soundbank-emg.sf2&quot;);
<span class="nc bnc" id="L694" title="All 2 branches missed.">                    if (emg_soundbank_file.exists()) {</span>
                        try {
<span class="nc" id="L696">                            return new FileInputStream(emg_soundbank_file);</span>
<span class="nc" id="L697">                        } catch (IOException e) {</span>
                        }
                    }
<span class="nc" id="L700">                    return null;</span>
                }
            });

<span class="nc bnc" id="L704" title="All 2 branches missed.">            for (PrivilegedAction&lt;InputStream&gt; action : actions) {</span>
                try {
<span class="nc" id="L706">                    InputStream is = AccessController.doPrivileged(action);</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">                    if(is == null) continue;</span>
                    Soundbank sbk;
                    try {
<span class="nc" id="L710">                        sbk = MidiSystem.getSoundbank(new BufferedInputStream(is));</span>
                    } finally {
<span class="nc" id="L712">                        is.close();</span>
<span class="nc" id="L713">                    }</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">                    if (sbk != null) {</span>
<span class="nc" id="L715">                        defaultSoundBank = sbk;</span>
<span class="nc" id="L716">                        return defaultSoundBank;</span>
                    }
<span class="nc" id="L718">                } catch (Exception e) {</span>
<span class="nc" id="L719">                }</span>
<span class="nc" id="L720">            }</span>

            try {
                /*
                 * Generate emergency soundbank
                 */
<span class="nc" id="L726">                defaultSoundBank = EmergencySoundbank.createSoundbank();</span>
<span class="nc" id="L727">            } catch (Exception e) {</span>
<span class="nc" id="L728">            }</span>

<span class="nc bnc" id="L730" title="All 2 branches missed.">            if (defaultSoundBank != null) {</span>
                /*
                 * Save generated soundbank to disk for faster future use.
                 */
<span class="nc" id="L734">                OutputStream out = AccessController</span>
<span class="nc" id="L735">                        .doPrivileged(new PrivilegedAction&lt;OutputStream&gt;() {</span>
                            public OutputStream run() {
                                try {
<span class="nc" id="L738">                                    File userhome = new File(System</span>
<span class="nc" id="L739">                                            .getProperty(&quot;user.home&quot;),</span>
                                            &quot;.gervill&quot;);
<span class="nc bnc" id="L741" title="All 2 branches missed.">                                    if (!userhome.exists())</span>
<span class="nc" id="L742">                                        userhome.mkdirs();</span>
<span class="nc" id="L743">                                    File emg_soundbank_file = new File(</span>
                                            userhome, &quot;soundbank-emg.sf2&quot;);
<span class="nc bnc" id="L745" title="All 2 branches missed.">                                    if (emg_soundbank_file.exists())</span>
<span class="nc" id="L746">                                        return null;</span>
<span class="nc" id="L747">                                    return new FileOutputStream(</span>
                                            emg_soundbank_file);
<span class="nc" id="L749">                                } catch (IOException e) {</span>
<span class="nc" id="L750">                                } catch (SecurityException e) {</span>
<span class="nc" id="L751">                                }</span>
<span class="nc" id="L752">                                return null;</span>
                            }
                        });
<span class="nc bnc" id="L755" title="All 2 branches missed.">                if (out != null) {</span>
                    try {
<span class="nc" id="L757">                        ((SF2Soundbank) defaultSoundBank).save(out);</span>
<span class="nc" id="L758">                        out.close();</span>
<span class="nc" id="L759">                    } catch (IOException e) {</span>
<span class="nc" id="L760">                    }</span>
                }
            }
<span class="nc" id="L763">        }</span>
<span class="nc" id="L764">        return defaultSoundBank;</span>
    }

    public Instrument[] getAvailableInstruments() {
<span class="nc" id="L768">        Soundbank defsbk = getDefaultSoundbank();</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">        if (defsbk == null)</span>
<span class="nc" id="L770">            return new Instrument[0];</span>
<span class="nc" id="L771">        Instrument[] inslist_array = defsbk.getInstruments();</span>
<span class="nc" id="L772">        Arrays.sort(inslist_array, new ModelInstrumentComparator());</span>
<span class="nc" id="L773">        return inslist_array;</span>
    }

    public Instrument[] getLoadedInstruments() {
<span class="nc bnc" id="L777" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L778">            return new Instrument[0];</span>

<span class="nc" id="L780">        synchronized (control_mutex) {</span>
<span class="nc" id="L781">            ModelInstrument[] inslist_array =</span>
<span class="nc" id="L782">                    new ModelInstrument[loadedlist.values().size()];</span>
<span class="nc" id="L783">            loadedlist.values().toArray(inslist_array);</span>
<span class="nc" id="L784">            Arrays.sort(inslist_array, new ModelInstrumentComparator());</span>
<span class="nc" id="L785">            return inslist_array;</span>
<span class="nc" id="L786">        }</span>
    }

    public boolean loadAllInstruments(Soundbank soundbank) {
<span class="nc" id="L790">        List&lt;ModelInstrument&gt; instruments = new ArrayList&lt;ModelInstrument&gt;();</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">        for (Instrument ins: soundbank.getInstruments()) {</span>
<span class="nc bnc" id="L792" title="All 4 branches missed.">            if (ins == null || !(ins instanceof ModelInstrument)) {</span>
<span class="nc" id="L793">                throw new IllegalArgumentException(</span>
                        &quot;Unsupported instrument: &quot; + ins);
            }
<span class="nc" id="L796">            instruments.add((ModelInstrument)ins);</span>
        }
<span class="nc" id="L798">        return loadInstruments(instruments);</span>
    }

    public void unloadAllInstruments(Soundbank soundbank) {
<span class="nc bnc" id="L802" title="All 4 branches missed.">        if (soundbank == null || !isSoundbankSupported(soundbank))</span>
<span class="nc" id="L803">            throw new IllegalArgumentException(&quot;Unsupported soundbank: &quot; + soundbank);</span>

<span class="nc bnc" id="L805" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L806">            return;</span>

<span class="nc bnc" id="L808" title="All 2 branches missed.">        for (Instrument ins: soundbank.getInstruments()) {</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">            if (ins instanceof ModelInstrument) {</span>
<span class="nc" id="L810">                unloadInstrument(ins);</span>
            }
        }
<span class="nc" id="L813">    }</span>

    public boolean loadInstruments(Soundbank soundbank, Patch[] patchList) {
<span class="nc" id="L816">        List&lt;ModelInstrument&gt; instruments = new ArrayList&lt;ModelInstrument&gt;();</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">        for (Patch patch: patchList) {</span>
<span class="nc" id="L818">            Instrument ins = soundbank.getInstrument(patch);</span>
<span class="nc bnc" id="L819" title="All 4 branches missed.">            if (ins == null || !(ins instanceof ModelInstrument)) {</span>
<span class="nc" id="L820">                throw new IllegalArgumentException(</span>
                        &quot;Unsupported instrument: &quot; + ins);
            }
<span class="nc" id="L823">            instruments.add((ModelInstrument)ins);</span>
        }
<span class="nc" id="L825">        return loadInstruments(instruments);</span>
    }

    public void unloadInstruments(Soundbank soundbank, Patch[] patchList) {
<span class="nc bnc" id="L829" title="All 4 branches missed.">        if (soundbank == null || !isSoundbankSupported(soundbank))</span>
<span class="nc" id="L830">            throw new IllegalArgumentException(&quot;Unsupported soundbank: &quot; + soundbank);</span>

<span class="nc bnc" id="L832" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L833">            return;</span>

<span class="nc bnc" id="L835" title="All 2 branches missed.">        for (Patch pat: patchList) {</span>
<span class="nc" id="L836">            Instrument ins = soundbank.getInstrument(pat);</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            if (ins instanceof ModelInstrument) {</span>
<span class="nc" id="L838">                unloadInstrument(ins);</span>
            }
        }
<span class="nc" id="L841">    }</span>

    public MidiDevice.Info getDeviceInfo() {
<span class="nc" id="L844">        return info;</span>
    }

    private Properties getStoredProperties() {
<span class="nc" id="L848">        return AccessController</span>
<span class="nc" id="L849">                .doPrivileged(new PrivilegedAction&lt;Properties&gt;() {</span>
                    public Properties run() {
<span class="nc" id="L851">                        Properties p = new Properties();</span>
<span class="nc" id="L852">                        String notePath = &quot;/com/sun/media/sound/softsynthesizer&quot;;</span>
                        try {
<span class="nc" id="L854">                            Preferences prefroot = Preferences.userRoot();</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">                            if (prefroot.nodeExists(notePath)) {</span>
<span class="nc" id="L856">                                Preferences prefs = prefroot.node(notePath);</span>
<span class="nc" id="L857">                                String[] prefs_keys = prefs.keys();</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">                                for (String prefs_key : prefs_keys) {</span>
<span class="nc" id="L859">                                    String val = prefs.get(prefs_key, null);</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">                                    if (val != null)</span>
<span class="nc" id="L861">                                        p.setProperty(prefs_key, val);</span>
                                }
                            }
<span class="nc" id="L864">                        } catch (BackingStoreException e) {</span>
<span class="nc" id="L865">                        } catch (SecurityException e) {</span>
<span class="nc" id="L866">                        }</span>
<span class="nc" id="L867">                        return p;</span>
                    }
                });
    }

    public AudioSynthesizerPropertyInfo[] getPropertyInfo(Map&lt;String, Object&gt; info) {
<span class="nc" id="L873">        List&lt;AudioSynthesizerPropertyInfo&gt; list =</span>
                new ArrayList&lt;AudioSynthesizerPropertyInfo&gt;();

        AudioSynthesizerPropertyInfo item;

        // If info != null or synthesizer is closed
        //   we return how the synthesizer will be set on next open
        // If info == null and synthesizer is open
        //   we return current synthesizer properties.
<span class="nc bnc" id="L882" title="All 4 branches missed.">        boolean o = info == null &amp;&amp; open;</span>

<span class="nc bnc" id="L884" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;interpolation&quot;, o?resamplerType:&quot;linear&quot;);</span>
<span class="nc" id="L885">        item.choices = new String[]{&quot;linear&quot;, &quot;linear1&quot;, &quot;linear2&quot;, &quot;cubic&quot;,</span>
                                    &quot;lanczos&quot;, &quot;sinc&quot;, &quot;point&quot;};
<span class="nc" id="L887">        item.description = &quot;Interpolation method&quot;;</span>
<span class="nc" id="L888">        list.add(item);</span>

<span class="nc bnc" id="L890" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;control rate&quot;, o?controlrate:147f);</span>
<span class="nc" id="L891">        item.description = &quot;Control rate&quot;;</span>
<span class="nc" id="L892">        list.add(item);</span>

<span class="nc bnc" id="L894" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;format&quot;,</span>
                o?format:new AudioFormat(44100, 16, 2, true, false));
<span class="nc" id="L896">        item.description = &quot;Default audio format&quot;;</span>
<span class="nc" id="L897">        list.add(item);</span>

<span class="nc bnc" id="L899" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;latency&quot;, o?latency:120000L);</span>
<span class="nc" id="L900">        item.description = &quot;Default latency&quot;;</span>
<span class="nc" id="L901">        list.add(item);</span>

<span class="nc bnc" id="L903" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;device id&quot;, o?deviceid:0);</span>
<span class="nc" id="L904">        item.description = &quot;Device ID for SysEx Messages&quot;;</span>
<span class="nc" id="L905">        list.add(item);</span>

<span class="nc bnc" id="L907" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;max polyphony&quot;, o?maxpoly:64);</span>
<span class="nc" id="L908">        item.description = &quot;Maximum polyphony&quot;;</span>
<span class="nc" id="L909">        list.add(item);</span>

<span class="nc bnc" id="L911" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;reverb&quot;, o?reverb_on:true);</span>
<span class="nc" id="L912">        item.description = &quot;Turn reverb effect on or off&quot;;</span>
<span class="nc" id="L913">        list.add(item);</span>

<span class="nc bnc" id="L915" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;chorus&quot;, o?chorus_on:true);</span>
<span class="nc" id="L916">        item.description = &quot;Turn chorus effect on or off&quot;;</span>
<span class="nc" id="L917">        list.add(item);</span>

<span class="nc bnc" id="L919" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;auto gain control&quot;, o?agc_on:true);</span>
<span class="nc" id="L920">        item.description = &quot;Turn auto gain control on or off&quot;;</span>
<span class="nc" id="L921">        list.add(item);</span>

<span class="nc bnc" id="L923" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;large mode&quot;, o?largemode:false);</span>
<span class="nc" id="L924">        item.description = &quot;Turn large mode on or off.&quot;;</span>
<span class="nc" id="L925">        list.add(item);</span>

<span class="nc bnc" id="L927" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;midi channels&quot;, o?channels.length:16);</span>
<span class="nc" id="L928">        item.description = &quot;Number of midi channels.&quot;;</span>
<span class="nc" id="L929">        list.add(item);</span>

<span class="nc bnc" id="L931" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;jitter correction&quot;, o?jitter_correction:true);</span>
<span class="nc" id="L932">        item.description = &quot;Turn jitter correction on or off.&quot;;</span>
<span class="nc" id="L933">        list.add(item);</span>

<span class="nc bnc" id="L935" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;light reverb&quot;, o?reverb_light:true);</span>
<span class="nc" id="L936">        item.description = &quot;Turn light reverb mode on or off&quot;;</span>
<span class="nc" id="L937">        list.add(item);</span>

<span class="nc bnc" id="L939" title="All 2 branches missed.">        item = new AudioSynthesizerPropertyInfo(&quot;load default soundbank&quot;, o?load_default_soundbank:true);</span>
<span class="nc" id="L940">        item.description = &quot;Enabled/disable loading default soundbank&quot;;</span>
<span class="nc" id="L941">        list.add(item);</span>

        AudioSynthesizerPropertyInfo[] items;
<span class="nc" id="L944">        items = list.toArray(new AudioSynthesizerPropertyInfo[list.size()]);</span>

<span class="nc" id="L946">        Properties storedProperties = getStoredProperties();</span>

<span class="nc bnc" id="L948" title="All 2 branches missed.">        for (AudioSynthesizerPropertyInfo item2 : items) {</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">            Object v = (info == null) ? null : info.get(item2.name);</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">            v = (v != null) ? v : storedProperties.getProperty(item2.name);</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">            if (v != null) {</span>
<span class="nc" id="L952">                Class c = (item2.valueClass);</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">                if (c.isInstance(v))</span>
<span class="nc" id="L954">                    item2.value = v;</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">                else if (v instanceof String) {</span>
<span class="nc" id="L956">                    String s = (String) v;</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">                    if (c == Boolean.class) {</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">                        if (s.equalsIgnoreCase(&quot;true&quot;))</span>
<span class="nc" id="L959">                            item2.value = Boolean.TRUE;</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">                        if (s.equalsIgnoreCase(&quot;false&quot;))</span>
<span class="nc" id="L961">                            item2.value = Boolean.FALSE;</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">                    } else if (c == AudioFormat.class) {</span>
<span class="nc" id="L963">                        int channels = 2;</span>
<span class="nc" id="L964">                        boolean signed = true;</span>
<span class="nc" id="L965">                        boolean bigendian = false;</span>
<span class="nc" id="L966">                        int bits = 16;</span>
<span class="nc" id="L967">                        float sampleRate = 44100f;</span>
                        try {
<span class="nc" id="L969">                            StringTokenizer st = new StringTokenizer(s, &quot;, &quot;);</span>
<span class="nc" id="L970">                            String prevToken = &quot;&quot;;</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">                            while (st.hasMoreTokens()) {</span>
<span class="nc" id="L972">                                String token = st.nextToken().toLowerCase();</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">                                if (token.equals(&quot;mono&quot;))</span>
<span class="nc" id="L974">                                    channels = 1;</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">                                if (token.startsWith(&quot;channel&quot;))</span>
<span class="nc" id="L976">                                    channels = Integer.parseInt(prevToken);</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">                                if (token.contains(&quot;unsigned&quot;))</span>
<span class="nc" id="L978">                                    signed = false;</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">                                if (token.equals(&quot;big-endian&quot;))</span>
<span class="nc" id="L980">                                    bigendian = true;</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">                                if (token.equals(&quot;bit&quot;))</span>
<span class="nc" id="L982">                                    bits = Integer.parseInt(prevToken);</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">                                if (token.equals(&quot;hz&quot;))</span>
<span class="nc" id="L984">                                    sampleRate = Float.parseFloat(prevToken);</span>
<span class="nc" id="L985">                                prevToken = token;</span>
<span class="nc" id="L986">                            }</span>
<span class="nc" id="L987">                            item2.value = new AudioFormat(sampleRate, bits,</span>
                                    channels, signed, bigendian);
<span class="nc" id="L989">                        } catch (NumberFormatException e) {</span>
<span class="nc" id="L990">                        }</span>

<span class="nc" id="L992">                    } else</span>
                        try {
<span class="nc bnc" id="L994" title="All 2 branches missed.">                            if (c == Byte.class)</span>
<span class="nc" id="L995">                                item2.value = Byte.valueOf(s);</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">                            else if (c == Short.class)</span>
<span class="nc" id="L997">                                item2.value = Short.valueOf(s);</span>
<span class="nc bnc" id="L998" title="All 2 branches missed.">                            else if (c == Integer.class)</span>
<span class="nc" id="L999">                                item2.value = Integer.valueOf(s);</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">                            else if (c == Long.class)</span>
<span class="nc" id="L1001">                                item2.value = Long.valueOf(s);</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">                            else if (c == Float.class)</span>
<span class="nc" id="L1003">                                item2.value = Float.valueOf(s);</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">                            else if (c == Double.class)</span>
<span class="nc" id="L1005">                                item2.value = Double.valueOf(s);</span>
<span class="nc" id="L1006">                        } catch (NumberFormatException e) {</span>
<span class="nc" id="L1007">                        }</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">                } else if (v instanceof Number) {</span>
<span class="nc" id="L1009">                    Number n = (Number) v;</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">                    if (c == Byte.class)</span>
<span class="nc" id="L1011">                        item2.value = Byte.valueOf(n.byteValue());</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">                    if (c == Short.class)</span>
<span class="nc" id="L1013">                        item2.value = Short.valueOf(n.shortValue());</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">                    if (c == Integer.class)</span>
<span class="nc" id="L1015">                        item2.value = Integer.valueOf(n.intValue());</span>
<span class="nc bnc" id="L1016" title="All 2 branches missed.">                    if (c == Long.class)</span>
<span class="nc" id="L1017">                        item2.value = Long.valueOf(n.longValue());</span>
<span class="nc bnc" id="L1018" title="All 2 branches missed.">                    if (c == Float.class)</span>
<span class="nc" id="L1019">                        item2.value = Float.valueOf(n.floatValue());</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">                    if (c == Double.class)</span>
<span class="nc" id="L1021">                        item2.value = Double.valueOf(n.doubleValue());</span>
                }
            }
        }

<span class="nc" id="L1026">        return items;</span>
    }

    public void open() throws MidiUnavailableException {
<span class="nc bnc" id="L1030" title="All 2 branches missed.">        if (isOpen()) {</span>
<span class="nc" id="L1031">            synchronized (control_mutex) {</span>
<span class="nc" id="L1032">                implicitOpen = false;</span>
<span class="nc" id="L1033">            }</span>
<span class="nc" id="L1034">            return;</span>
        }
<span class="nc" id="L1036">        open(null, null);</span>
<span class="nc" id="L1037">    }</span>

    public void open(SourceDataLine line, Map&lt;String, Object&gt; info) throws MidiUnavailableException {
<span class="nc bnc" id="L1040" title="All 2 branches missed.">        if (isOpen()) {</span>
<span class="nc" id="L1041">            synchronized (control_mutex) {</span>
<span class="nc" id="L1042">                implicitOpen = false;</span>
<span class="nc" id="L1043">            }</span>
<span class="nc" id="L1044">            return;</span>
        }
<span class="nc" id="L1046">        synchronized (control_mutex) {</span>
<span class="nc" id="L1047">            Throwable causeException = null;</span>
            try {
<span class="nc bnc" id="L1049" title="All 2 branches missed.">                if (line != null) {</span>
                    // can throw IllegalArgumentException
<span class="nc" id="L1051">                    setFormat(line.getFormat());</span>
                }

<span class="nc" id="L1054">                AudioInputStream ais = openStream(getFormat(), info);</span>

<span class="nc" id="L1056">                weakstream = new WeakAudioStream(ais);</span>
<span class="nc" id="L1057">                ais = weakstream.getAudioInputStream();</span>

<span class="nc bnc" id="L1059" title="All 2 branches missed.">                if (line == null)</span>
                {
<span class="nc bnc" id="L1061" title="All 2 branches missed.">                    if (testline != null) {</span>
<span class="nc" id="L1062">                        line = testline;</span>
                    } else {
                        // can throw LineUnavailableException,
                        // IllegalArgumentException, SecurityException
<span class="nc" id="L1066">                        line = AudioSystem.getSourceDataLine(getFormat());</span>
                    }
                }

<span class="nc" id="L1070">                double latency = this.latency;</span>

<span class="nc bnc" id="L1072" title="All 2 branches missed.">                if (!line.isOpen()) {</span>
<span class="nc" id="L1073">                    int bufferSize = getFormat().getFrameSize()</span>
<span class="nc" id="L1074">                        * (int)(getFormat().getFrameRate() * (latency/1000000f));</span>
                    // can throw LineUnavailableException,
                    // IllegalArgumentException, SecurityException
<span class="nc" id="L1077">                    line.open(getFormat(), bufferSize);</span>

                    // Remember that we opened that line
                    // so we can close again in SoftSynthesizer.close()
<span class="nc" id="L1081">                    sourceDataLine = line;</span>
                }
<span class="nc bnc" id="L1083" title="All 2 branches missed.">                if (!line.isActive())</span>
<span class="nc" id="L1084">                    line.start();</span>

<span class="nc" id="L1086">                int controlbuffersize = 512;</span>
                try {
<span class="nc" id="L1088">                    controlbuffersize = ais.available();</span>
<span class="nc" id="L1089">                } catch (IOException e) {</span>
<span class="nc" id="L1090">                }</span>

                // Tell mixer not fill read buffers fully.
                // This lowers latency, and tells DataPusher
                // to read in smaller amounts.
                //mainmixer.readfully = false;
                //pusher = new DataPusher(line, ais);

<span class="nc" id="L1098">                int buffersize = line.getBufferSize();</span>
<span class="nc" id="L1099">                buffersize -= buffersize % controlbuffersize;</span>

<span class="nc bnc" id="L1101" title="All 2 branches missed.">                if (buffersize &lt; 3 * controlbuffersize)</span>
<span class="nc" id="L1102">                    buffersize = 3 * controlbuffersize;</span>

<span class="nc bnc" id="L1104" title="All 2 branches missed.">                if (jitter_correction) {</span>
<span class="nc" id="L1105">                    ais = new SoftJitterCorrector(ais, buffersize,</span>
                            controlbuffersize);
<span class="nc bnc" id="L1107" title="All 2 branches missed.">                    if(weakstream != null)</span>
<span class="nc" id="L1108">                        weakstream.jitter_stream = ais;</span>
                }
<span class="nc" id="L1110">                pusher = new SoftAudioPusher(line, ais, controlbuffersize);</span>
<span class="nc" id="L1111">                pusher_stream = ais;</span>
<span class="nc" id="L1112">                pusher.start();</span>

<span class="nc bnc" id="L1114" title="All 2 branches missed.">                if(weakstream != null)</span>
                {
<span class="nc" id="L1116">                    weakstream.pusher = pusher;</span>
<span class="nc" id="L1117">                    weakstream.sourceDataLine = sourceDataLine;</span>
                }

<span class="nc" id="L1120">            } catch (LineUnavailableException e) {</span>
<span class="nc" id="L1121">                causeException = e;</span>
<span class="nc" id="L1122">            } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L1123">                causeException = e;</span>
<span class="nc" id="L1124">            } catch (SecurityException e) {</span>
<span class="nc" id="L1125">                causeException = e;</span>
<span class="nc" id="L1126">            }</span>

<span class="nc bnc" id="L1128" title="All 2 branches missed.">            if (causeException != null) {</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">                if (isOpen())</span>
<span class="nc" id="L1130">                    close();</span>
                // am: need MidiUnavailableException(Throwable) ctor!
<span class="nc" id="L1132">                MidiUnavailableException ex = new MidiUnavailableException(</span>
                        &quot;Can not open line&quot;);
<span class="nc" id="L1134">                ex.initCause(causeException);</span>
<span class="nc" id="L1135">                throw ex;</span>
            }

<span class="nc" id="L1138">        }</span>
<span class="nc" id="L1139">    }</span>

    public AudioInputStream openStream(AudioFormat targetFormat,
            Map&lt;String, Object&gt; info) throws MidiUnavailableException {

<span class="nc bnc" id="L1144" title="All 2 branches missed.">        if (isOpen())</span>
<span class="nc" id="L1145">            throw new MidiUnavailableException(&quot;Synthesizer is already open&quot;);</span>

<span class="nc" id="L1147">        synchronized (control_mutex) {</span>

<span class="nc" id="L1149">            gmmode = 0;</span>
<span class="nc" id="L1150">            voice_allocation_mode = 0;</span>

<span class="nc" id="L1152">            processPropertyInfo(info);</span>

<span class="nc" id="L1154">            open = true;</span>
<span class="nc" id="L1155">            implicitOpen = false;</span>

<span class="nc bnc" id="L1157" title="All 2 branches missed.">            if (targetFormat != null)</span>
<span class="nc" id="L1158">                setFormat(targetFormat);</span>

<span class="nc bnc" id="L1160" title="All 2 branches missed.">            if (load_default_soundbank)</span>
            {
<span class="nc" id="L1162">                Soundbank defbank = getDefaultSoundbank();</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">                if (defbank != null) {</span>
<span class="nc" id="L1164">                    loadAllInstruments(defbank);</span>
                }
            }

<span class="nc" id="L1168">            voices = new SoftVoice[maxpoly];</span>
<span class="nc bnc" id="L1169" title="All 2 branches missed.">            for (int i = 0; i &lt; maxpoly; i++)</span>
<span class="nc" id="L1170">                voices[i] = new SoftVoice(this);</span>

<span class="nc" id="L1172">            mainmixer = new SoftMainMixer(this);</span>

<span class="nc" id="L1174">            channels = new SoftChannel[number_of_midi_channels];</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">            for (int i = 0; i &lt; channels.length; i++)</span>
<span class="nc" id="L1176">                channels[i] = new SoftChannel(this, i);</span>

<span class="nc bnc" id="L1178" title="All 2 branches missed.">            if (external_channels == null) {</span>
                // Always create external_channels array
                // with 16 or more channels
                // so getChannels works correctly
                // when the synhtesizer is closed.
<span class="nc bnc" id="L1183" title="All 2 branches missed.">                if (channels.length &lt; 16)</span>
<span class="nc" id="L1184">                    external_channels = new SoftChannelProxy[16];</span>
                else
<span class="nc" id="L1186">                    external_channels = new SoftChannelProxy[channels.length];</span>
<span class="nc bnc" id="L1187" title="All 2 branches missed.">                for (int i = 0; i &lt; external_channels.length; i++)</span>
<span class="nc" id="L1188">                    external_channels[i] = new SoftChannelProxy();</span>
            } else {
                // We must resize external_channels array
                // but we must also copy the old SoftChannelProxy
                // into the new one
<span class="nc bnc" id="L1193" title="All 2 branches missed.">                if (channels.length &gt; external_channels.length) {</span>
<span class="nc" id="L1194">                    SoftChannelProxy[] new_external_channels</span>
                            = new SoftChannelProxy[channels.length];
<span class="nc bnc" id="L1196" title="All 2 branches missed.">                    for (int i = 0; i &lt; external_channels.length; i++)</span>
<span class="nc" id="L1197">                        new_external_channels[i] = external_channels[i];</span>
<span class="nc" id="L1198">                    for (int i = external_channels.length;</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">                            i &lt; new_external_channels.length; i++) {</span>
<span class="nc" id="L1200">                        new_external_channels[i] = new SoftChannelProxy();</span>
                    }
                }
            }

<span class="nc bnc" id="L1205" title="All 2 branches missed.">            for (int i = 0; i &lt; channels.length; i++)</span>
<span class="nc" id="L1206">                external_channels[i].setChannel(channels[i]);</span>

<span class="nc bnc" id="L1208" title="All 2 branches missed.">            for (SoftVoice voice: getVoices())</span>
<span class="nc" id="L1209">                voice.resampler = resampler.openStreamer();</span>

<span class="nc bnc" id="L1211" title="All 2 branches missed.">            for (Receiver recv: getReceivers()) {</span>
<span class="nc" id="L1212">                SoftReceiver srecv = ((SoftReceiver)recv);</span>
<span class="nc" id="L1213">                srecv.open = open;</span>
<span class="nc" id="L1214">                srecv.mainmixer = mainmixer;</span>
<span class="nc" id="L1215">                srecv.midimessages = mainmixer.midimessages;</span>
<span class="nc" id="L1216">            }</span>

<span class="nc" id="L1218">            return mainmixer.getInputStream();</span>
<span class="nc" id="L1219">        }</span>
    }

    public void close() {

<span class="nc bnc" id="L1224" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L1225">            return;</span>

<span class="nc" id="L1227">        SoftAudioPusher pusher_to_be_closed = null;</span>
<span class="nc" id="L1228">        AudioInputStream pusher_stream_to_be_closed = null;</span>
<span class="nc" id="L1229">        synchronized (control_mutex) {</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">            if (pusher != null) {</span>
<span class="nc" id="L1231">                pusher_to_be_closed = pusher;</span>
<span class="nc" id="L1232">                pusher_stream_to_be_closed = pusher_stream;</span>
<span class="nc" id="L1233">                pusher = null;</span>
<span class="nc" id="L1234">                pusher_stream = null;</span>
            }
<span class="nc" id="L1236">        }</span>

<span class="nc bnc" id="L1238" title="All 2 branches missed.">        if (pusher_to_be_closed != null) {</span>
            // Pusher must not be closed synchronized against control_mutex,
            // this may result in synchronized conflict between pusher
            // and current thread.
<span class="nc" id="L1242">            pusher_to_be_closed.stop();</span>

            try {
<span class="nc" id="L1245">                pusher_stream_to_be_closed.close();</span>
<span class="nc" id="L1246">            } catch (IOException e) {</span>
                //e.printStackTrace();
<span class="nc" id="L1248">            }</span>
        }

<span class="nc" id="L1251">        synchronized (control_mutex) {</span>

<span class="nc bnc" id="L1253" title="All 2 branches missed.">            if (mainmixer != null)</span>
<span class="nc" id="L1254">                mainmixer.close();</span>
<span class="nc" id="L1255">            open = false;</span>
<span class="nc" id="L1256">            implicitOpen = false;</span>
<span class="nc" id="L1257">            mainmixer = null;</span>
<span class="nc" id="L1258">            voices = null;</span>
<span class="nc" id="L1259">            channels = null;</span>

<span class="nc bnc" id="L1261" title="All 2 branches missed.">            if (external_channels != null)</span>
<span class="nc bnc" id="L1262" title="All 2 branches missed.">                for (int i = 0; i &lt; external_channels.length; i++)</span>
<span class="nc" id="L1263">                    external_channels[i].setChannel(null);</span>

<span class="nc bnc" id="L1265" title="All 2 branches missed.">            if (sourceDataLine != null) {</span>
<span class="nc" id="L1266">                sourceDataLine.close();</span>
<span class="nc" id="L1267">                sourceDataLine = null;</span>
            }

<span class="nc" id="L1270">            inslist.clear();</span>
<span class="nc" id="L1271">            loadedlist.clear();</span>
<span class="nc" id="L1272">            tunings.clear();</span>

<span class="nc bnc" id="L1274" title="All 2 branches missed.">            while (recvslist.size() != 0)</span>
<span class="nc" id="L1275">                recvslist.get(recvslist.size() - 1).close();</span>

<span class="nc" id="L1277">        }</span>
<span class="nc" id="L1278">    }</span>

    public boolean isOpen() {
<span class="nc" id="L1281">        synchronized (control_mutex) {</span>
<span class="nc" id="L1282">            return open;</span>
<span class="nc" id="L1283">        }</span>
    }

    public long getMicrosecondPosition() {

<span class="nc bnc" id="L1288" title="All 2 branches missed.">        if (!isOpen())</span>
<span class="nc" id="L1289">            return 0;</span>

<span class="nc" id="L1291">        synchronized (control_mutex) {</span>
<span class="nc" id="L1292">            return mainmixer.getMicrosecondPosition();</span>
<span class="nc" id="L1293">        }</span>
    }

    public int getMaxReceivers() {
<span class="nc" id="L1297">        return -1;</span>
    }

    public int getMaxTransmitters() {
<span class="nc" id="L1301">        return 0;</span>
    }

    public Receiver getReceiver() throws MidiUnavailableException {

<span class="nc" id="L1306">        synchronized (control_mutex) {</span>
<span class="nc" id="L1307">            SoftReceiver receiver = new SoftReceiver(this);</span>
<span class="nc" id="L1308">            receiver.open = open;</span>
<span class="nc" id="L1309">            recvslist.add(receiver);</span>
<span class="nc" id="L1310">            return receiver;</span>
<span class="nc" id="L1311">        }</span>
    }

    public List&lt;Receiver&gt; getReceivers() {

<span class="nc" id="L1316">        synchronized (control_mutex) {</span>
<span class="nc" id="L1317">            ArrayList&lt;Receiver&gt; recvs = new ArrayList&lt;Receiver&gt;();</span>
<span class="nc" id="L1318">            recvs.addAll(recvslist);</span>
<span class="nc" id="L1319">            return recvs;</span>
<span class="nc" id="L1320">        }</span>
    }

    public Transmitter getTransmitter() throws MidiUnavailableException {

<span class="nc" id="L1325">        throw new MidiUnavailableException(&quot;No transmitter available&quot;);</span>
    }

    public List&lt;Transmitter&gt; getTransmitters() {

<span class="nc" id="L1330">        return new ArrayList&lt;Transmitter&gt;();</span>
    }

    public Receiver getReceiverReferenceCounting()
            throws MidiUnavailableException {

<span class="nc bnc" id="L1336" title="All 2 branches missed.">        if (!isOpen()) {</span>
<span class="nc" id="L1337">            open();</span>
<span class="nc" id="L1338">            synchronized (control_mutex) {</span>
<span class="nc" id="L1339">                implicitOpen = true;</span>
<span class="nc" id="L1340">            }</span>
        }

<span class="nc" id="L1343">        return getReceiver();</span>
    }

    public Transmitter getTransmitterReferenceCounting()
            throws MidiUnavailableException {

<span class="nc" id="L1349">        throw new MidiUnavailableException(&quot;No transmitter available&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>