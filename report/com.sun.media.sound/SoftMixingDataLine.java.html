<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SoftMixingDataLine.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">SoftMixingDataLine.java</span></div><h1>SoftMixingDataLine.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2008, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.BooleanControl;
import javax.sound.sampled.Control;
import javax.sound.sampled.DataLine;
import javax.sound.sampled.FloatControl;
import javax.sound.sampled.LineEvent;
import javax.sound.sampled.LineListener;
import javax.sound.sampled.Control.Type;

/**
 * General software mixing line.
 *
 * @author Karl Helgason
 */
public abstract class SoftMixingDataLine implements DataLine {

<span class="nc" id="L49">    public static final FloatControl.Type CHORUS_SEND = new FloatControl.Type(</span>
<span class="nc" id="L50">            &quot;Chorus Send&quot;) {</span>
    };

    protected static final class AudioFloatInputStreamResampler extends
            AudioFloatInputStream {

        private final AudioFloatInputStream ais;

        private final AudioFormat targetFormat;

        private float[] skipbuffer;

        private SoftAbstractResampler resampler;

<span class="nc" id="L64">        private final float[] pitch = new float[1];</span>

        private final float[] ibuffer2;

        private final float[][] ibuffer;

<span class="nc" id="L70">        private float ibuffer_index = 0;</span>

<span class="nc" id="L72">        private int ibuffer_len = 0;</span>

<span class="nc" id="L74">        private int nrofchannels = 0;</span>

        private float[][] cbuffer;

<span class="nc" id="L78">        private final int buffer_len = 512;</span>

        private final int pad;

        private final int pad2;

<span class="nc" id="L84">        private final float[] ix = new float[1];</span>

<span class="nc" id="L86">        private final int[] ox = new int[1];</span>

<span class="nc" id="L88">        private float[][] mark_ibuffer = null;</span>

<span class="nc" id="L90">        private float mark_ibuffer_index = 0;</span>

<span class="nc" id="L92">        private int mark_ibuffer_len = 0;</span>

        public AudioFloatInputStreamResampler(AudioFloatInputStream ais,
<span class="nc" id="L95">                AudioFormat format) {</span>
<span class="nc" id="L96">            this.ais = ais;</span>
<span class="nc" id="L97">            AudioFormat sourceFormat = ais.getFormat();</span>
<span class="nc" id="L98">            targetFormat = new AudioFormat(sourceFormat.getEncoding(), format</span>
<span class="nc" id="L99">                    .getSampleRate(), sourceFormat.getSampleSizeInBits(),</span>
<span class="nc" id="L100">                    sourceFormat.getChannels(), sourceFormat.getFrameSize(),</span>
<span class="nc" id="L101">                    format.getSampleRate(), sourceFormat.isBigEndian());</span>
<span class="nc" id="L102">            nrofchannels = targetFormat.getChannels();</span>
<span class="nc" id="L103">            Object interpolation = format.getProperty(&quot;interpolation&quot;);</span>
<span class="nc bnc" id="L104" title="All 4 branches missed.">            if (interpolation != null &amp;&amp; (interpolation instanceof String)) {</span>
<span class="nc" id="L105">                String resamplerType = (String) interpolation;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (resamplerType.equalsIgnoreCase(&quot;point&quot;))</span>
<span class="nc" id="L107">                    this.resampler = new SoftPointResampler();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (resamplerType.equalsIgnoreCase(&quot;linear&quot;))</span>
<span class="nc" id="L109">                    this.resampler = new SoftLinearResampler2();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                if (resamplerType.equalsIgnoreCase(&quot;linear1&quot;))</span>
<span class="nc" id="L111">                    this.resampler = new SoftLinearResampler();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                if (resamplerType.equalsIgnoreCase(&quot;linear2&quot;))</span>
<span class="nc" id="L113">                    this.resampler = new SoftLinearResampler2();</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                if (resamplerType.equalsIgnoreCase(&quot;cubic&quot;))</span>
<span class="nc" id="L115">                    this.resampler = new SoftCubicResampler();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (resamplerType.equalsIgnoreCase(&quot;lanczos&quot;))</span>
<span class="nc" id="L117">                    this.resampler = new SoftLanczosResampler();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                if (resamplerType.equalsIgnoreCase(&quot;sinc&quot;))</span>
<span class="nc" id="L119">                    this.resampler = new SoftSincResampler();</span>
            }
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (resampler == null)</span>
<span class="nc" id="L122">                resampler = new SoftLinearResampler2(); // new</span>
            // SoftLinearResampler2();
<span class="nc" id="L124">            pitch[0] = sourceFormat.getSampleRate() / format.getSampleRate();</span>
<span class="nc" id="L125">            pad = resampler.getPadding();</span>
<span class="nc" id="L126">            pad2 = pad * 2;</span>
<span class="nc" id="L127">            ibuffer = new float[nrofchannels][buffer_len + pad2];</span>
<span class="nc" id="L128">            ibuffer2 = new float[nrofchannels * buffer_len];</span>
<span class="nc" id="L129">            ibuffer_index = buffer_len + pad;</span>
<span class="nc" id="L130">            ibuffer_len = buffer_len;</span>
<span class="nc" id="L131">        }</span>

        public int available() throws IOException {
<span class="nc" id="L134">            return 0;</span>
        }

        public void close() throws IOException {
<span class="nc" id="L138">            ais.close();</span>
<span class="nc" id="L139">        }</span>

        public AudioFormat getFormat() {
<span class="nc" id="L142">            return targetFormat;</span>
        }

        public long getFrameLength() {
<span class="nc" id="L146">            return AudioSystem.NOT_SPECIFIED; // ais.getFrameLength();</span>
        }

        public void mark(int readlimit) {
<span class="nc" id="L150">            ais.mark((int) (readlimit * pitch[0]));</span>
<span class="nc" id="L151">            mark_ibuffer_index = ibuffer_index;</span>
<span class="nc" id="L152">            mark_ibuffer_len = ibuffer_len;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (mark_ibuffer == null) {</span>
<span class="nc" id="L154">                mark_ibuffer = new float[ibuffer.length][ibuffer[0].length];</span>
            }
<span class="nc bnc" id="L156" title="All 2 branches missed.">            for (int c = 0; c &lt; ibuffer.length; c++) {</span>
<span class="nc" id="L157">                float[] from = ibuffer[c];</span>
<span class="nc" id="L158">                float[] to = mark_ibuffer[c];</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">                for (int i = 0; i &lt; to.length; i++) {</span>
<span class="nc" id="L160">                    to[i] = from[i];</span>
                }
            }
<span class="nc" id="L163">        }</span>

        public boolean markSupported() {
<span class="nc" id="L166">            return ais.markSupported();</span>
        }

        private void readNextBuffer() throws IOException {

<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (ibuffer_len == -1)</span>
<span class="nc" id="L172">                return;</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">            for (int c = 0; c &lt; nrofchannels; c++) {</span>
<span class="nc" id="L175">                float[] buff = ibuffer[c];</span>
<span class="nc" id="L176">                int buffer_len_pad = ibuffer_len + pad2;</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                for (int i = ibuffer_len, ix = 0; i &lt; buffer_len_pad; i++, ix++) {</span>
<span class="nc" id="L178">                    buff[ix] = buff[i];</span>
                }
            }

<span class="nc" id="L182">            ibuffer_index -= (ibuffer_len);</span>

<span class="nc" id="L184">            ibuffer_len = ais.read(ibuffer2);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (ibuffer_len &gt;= 0) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                while (ibuffer_len &lt; ibuffer2.length) {</span>
<span class="nc" id="L187">                    int ret = ais.read(ibuffer2, ibuffer_len, ibuffer2.length</span>
                            - ibuffer_len);
<span class="nc bnc" id="L189" title="All 2 branches missed.">                    if (ret == -1)</span>
<span class="nc" id="L190">                        break;</span>
<span class="nc" id="L191">                    ibuffer_len += ret;</span>
<span class="nc" id="L192">                }</span>
<span class="nc" id="L193">                Arrays.fill(ibuffer2, ibuffer_len, ibuffer2.length, 0);</span>
<span class="nc" id="L194">                ibuffer_len /= nrofchannels;</span>
            } else {
<span class="nc" id="L196">                Arrays.fill(ibuffer2, 0, ibuffer2.length, 0);</span>
            }

<span class="nc" id="L199">            int ibuffer2_len = ibuffer2.length;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            for (int c = 0; c &lt; nrofchannels; c++) {</span>
<span class="nc" id="L201">                float[] buff = ibuffer[c];</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                for (int i = c, ix = pad2; i &lt; ibuffer2_len; i += nrofchannels, ix++) {</span>
<span class="nc" id="L203">                    buff[ix] = ibuffer2[i];</span>
                }
            }

<span class="nc" id="L207">        }</span>

        public int read(float[] b, int off, int len) throws IOException {

<span class="nc bnc" id="L211" title="All 4 branches missed.">            if (cbuffer == null || cbuffer[0].length &lt; len / nrofchannels) {</span>
<span class="nc" id="L212">                cbuffer = new float[nrofchannels][len / nrofchannels];</span>
            }
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (ibuffer_len == -1)</span>
<span class="nc" id="L215">                return -1;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">            if (len &lt; 0)</span>
<span class="nc" id="L217">                return 0;</span>
<span class="nc" id="L218">            int remain = len / nrofchannels;</span>
<span class="nc" id="L219">            int destPos = 0;</span>
<span class="nc" id="L220">            int in_end = ibuffer_len;</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            while (remain &gt; 0) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (ibuffer_len &gt;= 0) {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                    if (ibuffer_index &gt;= (ibuffer_len + pad))</span>
<span class="nc" id="L224">                        readNextBuffer();</span>
<span class="nc" id="L225">                    in_end = ibuffer_len + pad;</span>
                }

<span class="nc bnc" id="L228" title="All 2 branches missed.">                if (ibuffer_len &lt; 0) {</span>
<span class="nc" id="L229">                    in_end = pad2;</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                    if (ibuffer_index &gt;= in_end)</span>
<span class="nc" id="L231">                        break;</span>
                }

<span class="nc bnc" id="L234" title="All 2 branches missed.">                if (ibuffer_index &lt; 0)</span>
<span class="nc" id="L235">                    break;</span>
<span class="nc" id="L236">                int preDestPos = destPos;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                for (int c = 0; c &lt; nrofchannels; c++) {</span>
<span class="nc" id="L238">                    ix[0] = ibuffer_index;</span>
<span class="nc" id="L239">                    ox[0] = destPos;</span>
<span class="nc" id="L240">                    float[] buff = ibuffer[c];</span>
<span class="nc" id="L241">                    resampler.interpolate(buff, ix, in_end, pitch, 0,</span>
                            cbuffer[c], ox, len / nrofchannels);
                }
<span class="nc" id="L244">                ibuffer_index = ix[0];</span>
<span class="nc" id="L245">                destPos = ox[0];</span>
<span class="nc" id="L246">                remain -= destPos - preDestPos;</span>
<span class="nc" id="L247">            }</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            for (int c = 0; c &lt; nrofchannels; c++) {</span>
<span class="nc" id="L249">                int ix = 0;</span>
<span class="nc" id="L250">                float[] buff = cbuffer[c];</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                for (int i = c; i &lt; b.length; i += nrofchannels) {</span>
<span class="nc" id="L252">                    b[i] = buff[ix++];</span>
                }
            }
<span class="nc" id="L255">            return len - remain * nrofchannels;</span>
        }

        public void reset() throws IOException {
<span class="nc" id="L259">            ais.reset();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">            if (mark_ibuffer == null)</span>
<span class="nc" id="L261">                return;</span>
<span class="nc" id="L262">            ibuffer_index = mark_ibuffer_index;</span>
<span class="nc" id="L263">            ibuffer_len = mark_ibuffer_len;</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">            for (int c = 0; c &lt; ibuffer.length; c++) {</span>
<span class="nc" id="L265">                float[] from = mark_ibuffer[c];</span>
<span class="nc" id="L266">                float[] to = ibuffer[c];</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                for (int i = 0; i &lt; to.length; i++) {</span>
<span class="nc" id="L268">                    to[i] = from[i];</span>
                }
            }

<span class="nc" id="L272">        }</span>

        public long skip(long len) throws IOException {
<span class="nc bnc" id="L275" title="All 2 branches missed.">            if (len &gt; 0)</span>
<span class="nc" id="L276">                return 0;</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (skipbuffer == null)</span>
<span class="nc" id="L278">                skipbuffer = new float[1024 * targetFormat.getFrameSize()];</span>
<span class="nc" id="L279">            float[] l_skipbuffer = skipbuffer;</span>
<span class="nc" id="L280">            long remain = len;</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            while (remain &gt; 0) {</span>
<span class="nc" id="L282">                int ret = read(l_skipbuffer, 0, (int) Math.min(remain,</span>
                        skipbuffer.length));
<span class="nc bnc" id="L284" title="All 2 branches missed.">                if (ret &lt; 0) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                    if (remain == len)</span>
<span class="nc" id="L286">                        return ret;</span>
                    break;
                }
<span class="nc" id="L289">                remain -= ret;</span>
<span class="nc" id="L290">            }</span>
<span class="nc" id="L291">            return len - remain;</span>

        }

    }

    private final class Gain extends FloatControl {

<span class="nc" id="L299">        private Gain() {</span>

<span class="nc" id="L301">            super(FloatControl.Type.MASTER_GAIN, -80f, 6.0206f, 80f / 128.0f,</span>
                    -1, 0.0f, &quot;dB&quot;, &quot;Minimum&quot;, &quot;&quot;, &quot;Maximum&quot;);
<span class="nc" id="L303">        }</span>

        public void setValue(float newValue) {
<span class="nc" id="L306">            super.setValue(newValue);</span>
<span class="nc" id="L307">            calcVolume();</span>
<span class="nc" id="L308">        }</span>
    }

    private final class Mute extends BooleanControl {

<span class="nc" id="L313">        private Mute() {</span>
<span class="nc" id="L314">            super(BooleanControl.Type.MUTE, false, &quot;True&quot;, &quot;False&quot;);</span>
<span class="nc" id="L315">        }</span>

        public void setValue(boolean newValue) {
<span class="nc" id="L318">            super.setValue(newValue);</span>
<span class="nc" id="L319">            calcVolume();</span>
<span class="nc" id="L320">        }</span>
    }

    private final class ApplyReverb extends BooleanControl {

<span class="nc" id="L325">        private ApplyReverb() {</span>
<span class="nc" id="L326">            super(BooleanControl.Type.APPLY_REVERB, false, &quot;True&quot;, &quot;False&quot;);</span>
<span class="nc" id="L327">        }</span>

        public void setValue(boolean newValue) {
<span class="nc" id="L330">            super.setValue(newValue);</span>
<span class="nc" id="L331">            calcVolume();</span>
<span class="nc" id="L332">        }</span>

    }

    private final class Balance extends FloatControl {

<span class="nc" id="L338">        private Balance() {</span>
<span class="nc" id="L339">            super(FloatControl.Type.BALANCE, -1.0f, 1.0f, (1.0f / 128.0f), -1,</span>
                    0.0f, &quot;&quot;, &quot;Left&quot;, &quot;Center&quot;, &quot;Right&quot;);
<span class="nc" id="L341">        }</span>

        public void setValue(float newValue) {
<span class="nc" id="L344">            super.setValue(newValue);</span>
<span class="nc" id="L345">            calcVolume();</span>
<span class="nc" id="L346">        }</span>

    }

    private final class Pan extends FloatControl {

<span class="nc" id="L352">        private Pan() {</span>
<span class="nc" id="L353">            super(FloatControl.Type.PAN, -1.0f, 1.0f, (1.0f / 128.0f), -1,</span>
                    0.0f, &quot;&quot;, &quot;Left&quot;, &quot;Center&quot;, &quot;Right&quot;);
<span class="nc" id="L355">        }</span>

        public void setValue(float newValue) {
<span class="nc" id="L358">            super.setValue(newValue);</span>
<span class="nc" id="L359">            balance_control.setValue(newValue);</span>
<span class="nc" id="L360">        }</span>

        public float getValue() {
<span class="nc" id="L363">            return balance_control.getValue();</span>
        }

    }

    private final class ReverbSend extends FloatControl {

<span class="nc" id="L370">        private ReverbSend() {</span>
<span class="nc" id="L371">            super(FloatControl.Type.REVERB_SEND, -80f, 6.0206f, 80f / 128.0f,</span>
                    -1, -80f, &quot;dB&quot;, &quot;Minimum&quot;, &quot;&quot;, &quot;Maximum&quot;);
<span class="nc" id="L373">        }</span>

        public void setValue(float newValue) {
<span class="nc" id="L376">            super.setValue(newValue);</span>
<span class="nc" id="L377">            balance_control.setValue(newValue);</span>
<span class="nc" id="L378">        }</span>

    }

    private final class ChorusSend extends FloatControl {

<span class="nc" id="L384">        private ChorusSend() {</span>
<span class="nc" id="L385">            super(CHORUS_SEND, -80f, 6.0206f, 80f / 128.0f, -1, -80f, &quot;dB&quot;,</span>
                    &quot;Minimum&quot;, &quot;&quot;, &quot;Maximum&quot;);
<span class="nc" id="L387">        }</span>

        public void setValue(float newValue) {
<span class="nc" id="L390">            super.setValue(newValue);</span>
<span class="nc" id="L391">            balance_control.setValue(newValue);</span>
<span class="nc" id="L392">        }</span>

    }

<span class="nc" id="L396">    private final Gain gain_control = new Gain();</span>

<span class="nc" id="L398">    private final Mute mute_control = new Mute();</span>

<span class="nc" id="L400">    private final Balance balance_control = new Balance();</span>

<span class="nc" id="L402">    private final Pan pan_control = new Pan();</span>

<span class="nc" id="L404">    private final ReverbSend reverbsend_control = new ReverbSend();</span>

<span class="nc" id="L406">    private final ChorusSend chorussend_control = new ChorusSend();</span>

<span class="nc" id="L408">    private final ApplyReverb apply_reverb = new ApplyReverb();</span>

    private final Control[] controls;

<span class="nc" id="L412">    float leftgain = 1;</span>

<span class="nc" id="L414">    float rightgain = 1;</span>

<span class="nc" id="L416">    float eff1gain = 0;</span>

<span class="nc" id="L418">    float eff2gain = 0;</span>

<span class="nc" id="L420">    List&lt;LineListener&gt; listeners = new ArrayList&lt;LineListener&gt;();</span>

    final Object control_mutex;

    SoftMixingMixer mixer;

    DataLine.Info info;

    protected abstract void processControlLogic();

    protected abstract void processAudioLogic(SoftAudioBuffer[] buffers);

<span class="nc" id="L432">    SoftMixingDataLine(SoftMixingMixer mixer, DataLine.Info info) {</span>
<span class="nc" id="L433">        this.mixer = mixer;</span>
<span class="nc" id="L434">        this.info = info;</span>
<span class="nc" id="L435">        this.control_mutex = mixer.control_mutex;</span>

<span class="nc" id="L437">        controls = new Control[] { gain_control, mute_control, balance_control,</span>
                pan_control, reverbsend_control, chorussend_control,
                apply_reverb };
<span class="nc" id="L440">        calcVolume();</span>
<span class="nc" id="L441">    }</span>

    final void calcVolume() {
<span class="nc" id="L444">        synchronized (control_mutex) {</span>
<span class="nc" id="L445">            double gain = Math.pow(10.0, gain_control.getValue() / 20.0);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (mute_control.getValue())</span>
<span class="nc" id="L447">                gain = 0;</span>
<span class="nc" id="L448">            leftgain = (float) gain;</span>
<span class="nc" id="L449">            rightgain = (float) gain;</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">            if (mixer.getFormat().getChannels() &gt; 1) {</span>
                // -1 = Left, 0 Center, 1 = Right
<span class="nc" id="L452">                double balance = balance_control.getValue();</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                if (balance &gt; 0)</span>
<span class="nc" id="L454">                    leftgain *= (1 - balance);</span>
                else
<span class="nc" id="L456">                    rightgain *= (1 + balance);</span>

            }
<span class="nc" id="L459">        }</span>

<span class="nc" id="L461">        eff1gain = (float) Math.pow(10.0, reverbsend_control.getValue() / 20.0);</span>
<span class="nc" id="L462">        eff2gain = (float) Math.pow(10.0, chorussend_control.getValue() / 20.0);</span>

<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (!apply_reverb.getValue()) {</span>
<span class="nc" id="L465">            eff1gain = 0;</span>
        }
<span class="nc" id="L467">    }</span>

    final void sendEvent(LineEvent event) {
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (listeners.size() == 0)</span>
<span class="nc" id="L471">            return;</span>
<span class="nc" id="L472">        LineListener[] listener_array = listeners</span>
<span class="nc" id="L473">                .toArray(new LineListener[listeners.size()]);</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">        for (LineListener listener : listener_array) {</span>
<span class="nc" id="L475">            listener.update(event);</span>
        }
<span class="nc" id="L477">    }</span>

    public final void addLineListener(LineListener listener) {
<span class="nc" id="L480">        synchronized (control_mutex) {</span>
<span class="nc" id="L481">            listeners.add(listener);</span>
<span class="nc" id="L482">        }</span>
<span class="nc" id="L483">    }</span>

    public final void removeLineListener(LineListener listener) {
<span class="nc" id="L486">        synchronized (control_mutex) {</span>
<span class="nc" id="L487">            listeners.add(listener);</span>
<span class="nc" id="L488">        }</span>
<span class="nc" id="L489">    }</span>

    public final javax.sound.sampled.Line.Info getLineInfo() {
<span class="nc" id="L492">        return info;</span>
    }

    public final Control getControl(Type control) {
<span class="nc bnc" id="L496" title="All 2 branches missed.">        if (control != null) {</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">            for (int i = 0; i &lt; controls.length; i++) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">                if (controls[i].getType() == control) {</span>
<span class="nc" id="L499">                    return controls[i];</span>
                }
            }
        }
<span class="nc" id="L503">        throw new IllegalArgumentException(&quot;Unsupported control type : &quot;</span>
                + control);
    }

    public final Control[] getControls() {
<span class="nc" id="L508">        return Arrays.copyOf(controls, controls.length);</span>
    }

    public final boolean isControlSupported(Type control) {
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (control != null) {</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">            for (int i = 0; i &lt; controls.length; i++) {</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                if (controls[i].getType() == control) {</span>
<span class="nc" id="L515">                    return true;</span>
                }
            }
        }
<span class="nc" id="L519">        return false;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>