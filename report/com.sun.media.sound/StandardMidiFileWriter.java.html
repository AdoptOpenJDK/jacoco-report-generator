<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StandardMidiFileWriter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">StandardMidiFileWriter.java</span></div><h1>StandardMidiFileWriter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.media.sound;

import java.io.DataOutputStream;
import java.io.PipedInputStream;
import java.io.PipedOutputStream;
import java.io.ByteArrayOutputStream;
import java.io.ByteArrayInputStream;
import java.io.SequenceInputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.IOException;
import java.io.OutputStream;

import javax.sound.midi.InvalidMidiDataException;
import javax.sound.midi.MidiEvent;
import javax.sound.midi.MetaMessage;
import javax.sound.midi.Sequence;
import javax.sound.midi.ShortMessage;
import javax.sound.midi.SysexMessage;
import javax.sound.midi.Track;
import javax.sound.midi.spi.MidiFileWriter;


/**
 * MIDI file writer.
 *
 * @author Kara Kytle
 * @author Jan Borgersen
 */
<span class="nc" id="L56">public final class StandardMidiFileWriter extends MidiFileWriter {</span>

    private static final int MThd_MAGIC = 0x4d546864;  // 'MThd'
    private static final int MTrk_MAGIC = 0x4d54726b;  // 'MTrk'

    private static final int ONE_BYTE   = 1;
    private static final int TWO_BYTE   = 2;
    private static final int SYSEX      = 3;
    private static final int META       = 4;
    private static final int ERROR      = 5;
    private static final int IGNORE     = 6;

    private static final int MIDI_TYPE_0 = 0;
    private static final int MIDI_TYPE_1 = 1;

    private static final int bufferSize = 16384;  // buffersize for write
    private DataOutputStream tddos;               // data output stream for track writing



    /**
     * MIDI parser types
     */
<span class="nc" id="L79">    private static final int types[] = {</span>
        MIDI_TYPE_0,
        MIDI_TYPE_1
    };


    /**
     * new
     */
    public int[] getMidiFileTypes() {
<span class="nc" id="L89">        int[] localArray = new int[types.length];</span>
<span class="nc" id="L90">        System.arraycopy(types, 0, localArray, 0, types.length);</span>
<span class="nc" id="L91">        return localArray;</span>
    }

    /**
     * Obtains the file types that this provider can write from the
     * sequence specified.
     * @param sequence the sequence for which midi file type support
     * is queried
     * @return array of file types.  If no file types are supported,
     * returns an array of length 0.
     */
    public int[] getMidiFileTypes(Sequence sequence){
        int typesArray[];
<span class="nc" id="L104">        Track tracks[] = sequence.getTracks();</span>

<span class="nc bnc" id="L106" title="All 2 branches missed.">        if( tracks.length==1 ) {</span>
<span class="nc" id="L107">            typesArray = new int[2];</span>
<span class="nc" id="L108">            typesArray[0] = MIDI_TYPE_0;</span>
<span class="nc" id="L109">            typesArray[1] = MIDI_TYPE_1;</span>
        } else {
<span class="nc" id="L111">            typesArray = new int[1];</span>
<span class="nc" id="L112">            typesArray[0] = MIDI_TYPE_1;</span>
        }

<span class="nc" id="L115">        return typesArray;</span>
    }

    public boolean isFileTypeSupported(int type) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        for(int i=0; i&lt;types.length; i++) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            if( type == types[i] ) {</span>
<span class="nc" id="L121">                return true;</span>
            }
        }
<span class="nc" id="L124">        return false;</span>
    }

    public int write(Sequence in, int type, OutputStream out) throws IOException {
<span class="nc" id="L128">        byte [] buffer = null;</span>

<span class="nc" id="L130">        int bytesRead = 0;</span>
<span class="nc" id="L131">        long bytesWritten = 0;</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">        if( !isFileTypeSupported(type,in) ) {</span>
<span class="nc" id="L134">            throw new IllegalArgumentException(&quot;Could not write MIDI file&quot;);</span>
        }
        // First get the fileStream from this sequence
<span class="nc" id="L137">        InputStream fileStream = getFileStream(type,in);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (fileStream == null) {</span>
<span class="nc" id="L139">            throw new IllegalArgumentException(&quot;Could not write MIDI file&quot;);</span>
        }
<span class="nc" id="L141">        buffer = new byte[bufferSize];</span>

<span class="nc bnc" id="L143" title="All 2 branches missed.">        while( (bytesRead = fileStream.read( buffer )) &gt;= 0 ) {</span>
<span class="nc" id="L144">            out.write( buffer, 0, (int)bytesRead );</span>
<span class="nc" id="L145">            bytesWritten += bytesRead;</span>
        }
        // Done....return bytesWritten
<span class="nc" id="L148">        return (int) bytesWritten;</span>
    }

    public int write(Sequence in, int type, File out) throws IOException {
<span class="nc" id="L152">        FileOutputStream fos = new FileOutputStream(out); // throws IOException</span>
<span class="nc" id="L153">        int bytesWritten = write( in, type, fos );</span>
<span class="nc" id="L154">        fos.close();</span>
<span class="nc" id="L155">        return bytesWritten;</span>
    }

    //=================================================================================


    private InputStream getFileStream(int type, Sequence sequence) throws IOException {
<span class="nc" id="L162">        Track tracks[] = sequence.getTracks();</span>
<span class="nc" id="L163">        int bytesBuilt = 0;</span>
<span class="nc" id="L164">        int headerLength = 14;</span>
<span class="nc" id="L165">        int length = 0;</span>
        int timeFormat;
        float divtype;

<span class="nc" id="L169">        PipedOutputStream   hpos = null;</span>
<span class="nc" id="L170">        DataOutputStream    hdos = null;</span>
<span class="nc" id="L171">        PipedInputStream    headerStream = null;</span>

<span class="nc" id="L173">        InputStream         trackStreams [] = null;</span>
<span class="nc" id="L174">        InputStream         trackStream = null;</span>
<span class="nc" id="L175">        InputStream fStream = null;</span>

        // Determine the filetype to write
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if( type==MIDI_TYPE_0 ) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">            if (tracks.length != 1) {</span>
<span class="nc" id="L180">                return null;</span>
            }
<span class="nc bnc" id="L182" title="All 2 branches missed.">        } else if( type==MIDI_TYPE_1 ) {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (tracks.length &lt; 1) { // $$jb: 05.31.99: we _can_ write TYPE_1 if tracks.length==1</span>
<span class="nc" id="L184">                return null;</span>
            }
        } else {
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if(tracks.length==1) {</span>
<span class="nc" id="L188">                type = MIDI_TYPE_0;</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">            } else if(tracks.length&gt;1) {</span>
<span class="nc" id="L190">                type = MIDI_TYPE_1;</span>
            } else {
<span class="nc" id="L192">                return null;</span>
            }
        }

        // Now build the file one track at a time
        // Note that above we made sure that MIDI_TYPE_0 only happens
        // if tracks.length==1

<span class="nc" id="L200">        trackStreams = new InputStream[tracks.length];</span>
<span class="nc" id="L201">        int trackCount = 0;</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        for(int i=0; i&lt;tracks.length; i++) {</span>
            try {
<span class="nc" id="L204">                trackStreams[trackCount] = writeTrack( tracks[i], type );</span>
<span class="nc" id="L205">                trackCount++;</span>
<span class="nc" id="L206">            } catch (InvalidMidiDataException e) {</span>
                if(Printer.err) Printer.err(&quot;Exception in write: &quot; + e.getMessage());
<span class="nc" id="L208">            }</span>
            //bytesBuilt += trackStreams[i].getLength();
        }

        // Now seqence the track streams
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if( trackCount == 1 ) {</span>
<span class="nc" id="L214">            trackStream = trackStreams[0];</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">        } else if( trackCount &gt; 1 ){</span>
<span class="nc" id="L216">            trackStream = trackStreams[0];</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">            for(int i=1; i&lt;tracks.length; i++) {</span>
                // fix for 5048381: NullPointerException when saving a MIDI sequence
                // don't include failed track streams
<span class="nc bnc" id="L220" title="All 2 branches missed.">                if (trackStreams[i] != null) {</span>
<span class="nc" id="L221">                    trackStream = new SequenceInputStream( trackStream, trackStreams[i]);</span>
                }
            }
        } else {
<span class="nc" id="L225">            throw new IllegalArgumentException(&quot;invalid MIDI data in sequence&quot;);</span>
        }

        // Now build the header...
<span class="nc" id="L229">        hpos = new PipedOutputStream();</span>
<span class="nc" id="L230">        hdos = new DataOutputStream(hpos);</span>
<span class="nc" id="L231">        headerStream = new PipedInputStream(hpos);</span>

        // Write the magic number
<span class="nc" id="L234">        hdos.writeInt( MThd_MAGIC );</span>

        // Write the header length
<span class="nc" id="L237">        hdos.writeInt( headerLength - 8 );</span>

        // Write the filetype
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if(type==MIDI_TYPE_0) {</span>
<span class="nc" id="L241">            hdos.writeShort( 0 );</span>
        } else {
            // MIDI_TYPE_1
<span class="nc" id="L244">            hdos.writeShort( 1 );</span>
        }

        // Write the number of tracks
<span class="nc" id="L248">        hdos.writeShort( (short) trackCount );</span>

        // Determine and write the timing format
<span class="nc" id="L251">        divtype = sequence.getDivisionType();</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if( divtype == Sequence.PPQ ) {</span>
<span class="nc" id="L253">            timeFormat = sequence.getResolution();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        } else if( divtype == Sequence.SMPTE_24) {</span>
<span class="nc" id="L255">            timeFormat = (24&lt;&lt;8) * -1;</span>
<span class="nc" id="L256">            timeFormat += (sequence.getResolution() &amp; 0xFF);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        } else if( divtype == Sequence.SMPTE_25) {</span>
<span class="nc" id="L258">            timeFormat = (25&lt;&lt;8) * -1;</span>
<span class="nc" id="L259">            timeFormat += (sequence.getResolution() &amp; 0xFF);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        } else if( divtype == Sequence.SMPTE_30DROP) {</span>
<span class="nc" id="L261">            timeFormat = (29&lt;&lt;8) * -1;</span>
<span class="nc" id="L262">            timeFormat += (sequence.getResolution() &amp; 0xFF);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">        } else if( divtype == Sequence.SMPTE_30) {</span>
<span class="nc" id="L264">            timeFormat = (30&lt;&lt;8) * -1;</span>
<span class="nc" id="L265">            timeFormat += (sequence.getResolution() &amp; 0xFF);</span>
        } else {
            // $$jb: 04.08.99: What to really do here?
<span class="nc" id="L268">            return null;</span>
        }
<span class="nc" id="L270">        hdos.writeShort( timeFormat );</span>

        // now construct an InputStream to become the FileStream
<span class="nc" id="L273">        fStream = new SequenceInputStream(headerStream, trackStream);</span>
<span class="nc" id="L274">        hdos.close();</span>

<span class="nc" id="L276">        length = bytesBuilt + headerLength;</span>
<span class="nc" id="L277">        return fStream;</span>
    }

    /**
     * Returns ONE_BYTE, TWO_BYTE, SYSEX, META,
     * ERROR, or IGNORE (i.e. invalid for a MIDI file)
     */
    private int getType(int byteValue) {
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if ((byteValue &amp; 0xF0) == 0xF0) {</span>
<span class="nc bnc" id="L286" title="All 3 branches missed.">            switch(byteValue) {</span>
            case 0xF0:
            case 0xF7:
<span class="nc" id="L289">                return SYSEX;</span>
            case 0xFF:
<span class="nc" id="L291">                return META;</span>
            }
<span class="nc" id="L293">            return IGNORE;</span>
        }

<span class="nc bnc" id="L296" title="All 3 branches missed.">        switch(byteValue &amp; 0xF0) {</span>
        case 0x80:
        case 0x90:
        case 0xA0:
        case 0xB0:
        case 0xE0:
<span class="nc" id="L302">            return TWO_BYTE;</span>
        case 0xC0:
        case 0xD0:
<span class="nc" id="L305">            return ONE_BYTE;</span>
        }
<span class="nc" id="L307">        return ERROR;</span>
    }

    private final static long mask = 0x7F;

    private int writeVarInt(long value) throws IOException {
<span class="nc" id="L313">        int len = 1;</span>
<span class="nc" id="L314">        int shift=63; // number of bitwise left-shifts of mask</span>
        // first screen out leading zeros
<span class="nc bnc" id="L316" title="All 4 branches missed.">        while ((shift &gt; 0) &amp;&amp; ((value &amp; (mask &lt;&lt; shift)) == 0)) shift-=7;</span>
        // then write actual values
<span class="nc bnc" id="L318" title="All 2 branches missed.">        while (shift &gt; 0) {</span>
<span class="nc" id="L319">            tddos.writeByte((int) (((value &amp; (mask &lt;&lt; shift)) &gt;&gt; shift) | 0x80));</span>
<span class="nc" id="L320">            shift-=7;</span>
<span class="nc" id="L321">            len++;</span>
        }
<span class="nc" id="L323">        tddos.writeByte((int) (value &amp; mask));</span>
<span class="nc" id="L324">        return len;</span>
    }

    private InputStream writeTrack( Track track, int type ) throws IOException, InvalidMidiDataException {
<span class="nc" id="L328">        int bytesWritten = 0;</span>
<span class="nc" id="L329">        int lastBytesWritten = 0;</span>
<span class="nc" id="L330">        int size = track.size();</span>
<span class="nc" id="L331">        PipedOutputStream thpos = new PipedOutputStream();</span>
<span class="nc" id="L332">        DataOutputStream  thdos = new DataOutputStream(thpos);</span>
<span class="nc" id="L333">        PipedInputStream  thpis = new PipedInputStream(thpos);</span>

<span class="nc" id="L335">        ByteArrayOutputStream tdbos = new ByteArrayOutputStream();</span>
<span class="nc" id="L336">        tddos = new DataOutputStream(tdbos);</span>
<span class="nc" id="L337">        ByteArrayInputStream tdbis = null;</span>

<span class="nc" id="L339">        SequenceInputStream  fStream = null;</span>

<span class="nc" id="L341">        long currentTick = 0;</span>
<span class="nc" id="L342">        long deltaTick = 0;</span>
<span class="nc" id="L343">        long eventTick = 0;</span>
<span class="nc" id="L344">        int runningStatus = -1;</span>

        // -----------------------------
        // Write each event in the track
        // -----------------------------
<span class="nc bnc" id="L349" title="All 2 branches missed.">        for(int i=0; i&lt;size; i++) {</span>
<span class="nc" id="L350">            MidiEvent event = track.get(i);</span>

            int status;
            int eventtype;
            int metatype;
            int data1, data2;
            int length;
<span class="nc" id="L357">            byte data[] = null;</span>
<span class="nc" id="L358">            ShortMessage shortMessage = null;</span>
<span class="nc" id="L359">            MetaMessage  metaMessage  = null;</span>
<span class="nc" id="L360">            SysexMessage sysexMessage = null;</span>

            // get the tick
            // $$jb: this gets easier if we change all system-wide time to delta ticks
<span class="nc" id="L364">            eventTick = event.getTick();</span>
<span class="nc" id="L365">            deltaTick = event.getTick() - currentTick;</span>
<span class="nc" id="L366">            currentTick = event.getTick();</span>

            // get the status byte
<span class="nc" id="L369">            status = event.getMessage().getStatus();</span>
<span class="nc" id="L370">            eventtype = getType( status );</span>

<span class="nc bnc" id="L372" title="All 7 branches missed.">            switch( eventtype ) {</span>
            case ONE_BYTE:
<span class="nc" id="L374">                shortMessage = (ShortMessage) event.getMessage();</span>
<span class="nc" id="L375">                data1 = shortMessage.getData1();</span>
<span class="nc" id="L376">                bytesWritten += writeVarInt( deltaTick );</span>

<span class="nc bnc" id="L378" title="All 2 branches missed.">                if(status!=runningStatus) {</span>
<span class="nc" id="L379">                    runningStatus=status;</span>
<span class="nc" id="L380">                    tddos.writeByte(status);  bytesWritten += 1;</span>
                }
<span class="nc" id="L382">                tddos.writeByte(data1);   bytesWritten += 1;</span>
<span class="nc" id="L383">                break;</span>

            case TWO_BYTE:
<span class="nc" id="L386">                shortMessage = (ShortMessage) event.getMessage();</span>
<span class="nc" id="L387">                data1 = shortMessage.getData1();</span>
<span class="nc" id="L388">                data2 = shortMessage.getData2();</span>

<span class="nc" id="L390">                bytesWritten += writeVarInt( deltaTick );</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">                if(status!=runningStatus) {</span>
<span class="nc" id="L392">                    runningStatus=status;</span>
<span class="nc" id="L393">                    tddos.writeByte(status);  bytesWritten += 1;</span>
                }
<span class="nc" id="L395">                tddos.writeByte(data1);   bytesWritten += 1;</span>
<span class="nc" id="L396">                tddos.writeByte(data2);   bytesWritten += 1;</span>
<span class="nc" id="L397">                break;</span>

            case SYSEX:
<span class="nc" id="L400">                sysexMessage = (SysexMessage) event.getMessage();</span>
<span class="nc" id="L401">                length     = sysexMessage.getLength();</span>
<span class="nc" id="L402">                data       = sysexMessage.getMessage();</span>
<span class="nc" id="L403">                bytesWritten += writeVarInt( deltaTick );</span>

                // $$jb: 04.08.99: always write status for sysex
<span class="nc" id="L406">                runningStatus=status;</span>
<span class="nc" id="L407">                tddos.writeByte( data[0] ); bytesWritten += 1;</span>

                // $$jb: 10.18.99: we don't maintain length in
                // the message data for SysEx (it is not transmitted
                // over the line), so write the calculated length
                // minus the status byte
<span class="nc" id="L413">                bytesWritten += writeVarInt( (data.length-1) );</span>

                // $$jb: 10.18.99: now write the rest of the
                // message
<span class="nc" id="L417">                tddos.write(data, 1, (data.length-1));</span>
<span class="nc" id="L418">                bytesWritten += (data.length-1);</span>
<span class="nc" id="L419">                break;</span>

            case META:
<span class="nc" id="L422">                metaMessage = (MetaMessage) event.getMessage();</span>
<span class="nc" id="L423">                length    = metaMessage.getLength();</span>
<span class="nc" id="L424">                data      = metaMessage.getMessage();</span>
<span class="nc" id="L425">                bytesWritten += writeVarInt( deltaTick );</span>

                // $$jb: 10.18.99: getMessage() returns the
                // entire valid midi message for a file,
                // including the status byte and the var-length-int
                // length value, so we can just write the data
                // here.  note that we must _always_ write the
                // status byte, regardless of runningStatus.
<span class="nc" id="L433">                runningStatus=status;</span>
<span class="nc" id="L434">                tddos.write( data, 0, data.length );</span>
<span class="nc" id="L435">                bytesWritten += data.length;</span>
<span class="nc" id="L436">                break;</span>

            case IGNORE:
                // ignore this event
<span class="nc" id="L440">                break;</span>

            case ERROR:
                // ignore this event
<span class="nc" id="L444">                break;</span>

            default:
<span class="nc" id="L447">                throw new InvalidMidiDataException(&quot;internal file writer error&quot;);</span>
            }
        }
        // ---------------------------------
        // End write each event in the track
        // ---------------------------------

        // Build Track header now that we know length
<span class="nc" id="L455">        thdos.writeInt(MTrk_MAGIC);</span>
<span class="nc" id="L456">        thdos.writeInt(bytesWritten);</span>
<span class="nc" id="L457">        bytesWritten += 8;</span>

        // Now sequence them
<span class="nc" id="L460">        tdbis = new ByteArrayInputStream( tdbos.toByteArray() );</span>
<span class="nc" id="L461">        fStream = new SequenceInputStream(thpis,tdbis);</span>
<span class="nc" id="L462">        thdos.close();</span>
<span class="nc" id="L463">        tddos.close();</span>

<span class="nc" id="L465">        return fStream;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>