<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>SoftChorus.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">SoftChorus.java</span></div><h1>SoftChorus.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.util.Arrays;

/**
 * A chorus effect made using LFO and variable delay. One for each channel
 * (left,right), with different starting phase for stereo effect.
 *
 * @author Karl Helgason
 */
<span class="nc" id="L35">public final class SoftChorus implements SoftAudioProcessor {</span>

    private static class VariableDelay {

        private final float[] delaybuffer;
<span class="nc" id="L40">        private int rovepos = 0;</span>
<span class="nc" id="L41">        private float gain = 1;</span>
<span class="nc" id="L42">        private float rgain = 0;</span>
<span class="nc" id="L43">        private float delay = 0;</span>
<span class="nc" id="L44">        private float lastdelay = 0;</span>
<span class="nc" id="L45">        private float feedback = 0;</span>

<span class="nc" id="L47">        VariableDelay(int maxbuffersize) {</span>
<span class="nc" id="L48">            delaybuffer = new float[maxbuffersize];</span>
<span class="nc" id="L49">        }</span>

        public void setDelay(float delay) {
<span class="nc" id="L52">            this.delay = delay;</span>
<span class="nc" id="L53">        }</span>

        public void setFeedBack(float feedback) {
<span class="nc" id="L56">            this.feedback = feedback;</span>
<span class="nc" id="L57">        }</span>

        public void setGain(float gain) {
<span class="nc" id="L60">            this.gain = gain;</span>
<span class="nc" id="L61">        }</span>

        public void setReverbSendGain(float rgain) {
<span class="nc" id="L64">            this.rgain = rgain;</span>
<span class="nc" id="L65">        }</span>

        public void processMix(float[] in, float[] out, float[] rout) {
<span class="nc" id="L68">            float gain = this.gain;</span>
<span class="nc" id="L69">            float delay = this.delay;</span>
<span class="nc" id="L70">            float feedback = this.feedback;</span>

<span class="nc" id="L72">            float[] delaybuffer = this.delaybuffer;</span>
<span class="nc" id="L73">            int len = in.length;</span>
<span class="nc" id="L74">            float delaydelta = (delay - lastdelay) / len;</span>
<span class="nc" id="L75">            int rnlen = delaybuffer.length;</span>
<span class="nc" id="L76">            int rovepos = this.rovepos;</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (rout == null)</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L80">                    float r = rovepos - (lastdelay + 2) + rnlen;</span>
<span class="nc" id="L81">                    int ri = (int) r;</span>
<span class="nc" id="L82">                    float s = r - ri;</span>
<span class="nc" id="L83">                    float a = delaybuffer[ri % rnlen];</span>
<span class="nc" id="L84">                    float b = delaybuffer[(ri + 1) % rnlen];</span>
<span class="nc" id="L85">                    float o = a * (1 - s) + b * (s);</span>
<span class="nc" id="L86">                    out[i] += o * gain;</span>
<span class="nc" id="L87">                    delaybuffer[rovepos] = in[i] + o * feedback;</span>
<span class="nc" id="L88">                    rovepos = (rovepos + 1) % rnlen;</span>
<span class="nc" id="L89">                    lastdelay += delaydelta;</span>
                }
            else
<span class="nc bnc" id="L92" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L93">                    float r = rovepos - (lastdelay + 2) + rnlen;</span>
<span class="nc" id="L94">                    int ri = (int) r;</span>
<span class="nc" id="L95">                    float s = r - ri;</span>
<span class="nc" id="L96">                    float a = delaybuffer[ri % rnlen];</span>
<span class="nc" id="L97">                    float b = delaybuffer[(ri + 1) % rnlen];</span>
<span class="nc" id="L98">                    float o = a * (1 - s) + b * (s);</span>
<span class="nc" id="L99">                    out[i] += o * gain;</span>
<span class="nc" id="L100">                    rout[i] += o * rgain;</span>
<span class="nc" id="L101">                    delaybuffer[rovepos] = in[i] + o * feedback;</span>
<span class="nc" id="L102">                    rovepos = (rovepos + 1) % rnlen;</span>
<span class="nc" id="L103">                    lastdelay += delaydelta;</span>
                }
<span class="nc" id="L105">            this.rovepos = rovepos;</span>
<span class="nc" id="L106">            lastdelay = delay;</span>
<span class="nc" id="L107">        }</span>

        public void processReplace(float[] in, float[] out, float[] rout) {
<span class="nc" id="L110">            Arrays.fill(out, 0);</span>
<span class="nc" id="L111">            Arrays.fill(rout, 0);</span>
<span class="nc" id="L112">            processMix(in, out, rout);</span>
<span class="nc" id="L113">        }</span>
    }

    private static class LFODelay {

<span class="nc" id="L118">        private double phase = 1;</span>
<span class="nc" id="L119">        private double phase_step = 0;</span>
<span class="nc" id="L120">        private double depth = 0;</span>
        private VariableDelay vdelay;
        private final double samplerate;
        private final double controlrate;

<span class="nc" id="L125">        LFODelay(double samplerate, double controlrate) {</span>
<span class="nc" id="L126">            this.samplerate = samplerate;</span>
<span class="nc" id="L127">            this.controlrate = controlrate;</span>
            // vdelay = new VariableDelay((int)(samplerate*4));
<span class="nc" id="L129">            vdelay = new VariableDelay((int) ((this.depth + 10) * 2));</span>

<span class="nc" id="L131">        }</span>

        public void setDepth(double depth) {
<span class="nc" id="L134">            this.depth = depth * samplerate;</span>
<span class="nc" id="L135">            vdelay = new VariableDelay((int) ((this.depth + 10) * 2));</span>
<span class="nc" id="L136">        }</span>

        public void setRate(double rate) {
<span class="nc" id="L139">            double g = (Math.PI * 2) * (rate / controlrate);</span>
<span class="nc" id="L140">            phase_step = g;</span>
<span class="nc" id="L141">        }</span>

        public void setPhase(double phase) {
<span class="nc" id="L144">            this.phase = phase;</span>
<span class="nc" id="L145">        }</span>

        public void setFeedBack(float feedback) {
<span class="nc" id="L148">            vdelay.setFeedBack(feedback);</span>
<span class="nc" id="L149">        }</span>

        public void setGain(float gain) {
<span class="nc" id="L152">            vdelay.setGain(gain);</span>
<span class="nc" id="L153">        }</span>

        public void setReverbSendGain(float rgain) {
<span class="nc" id="L156">            vdelay.setReverbSendGain(rgain);</span>
<span class="nc" id="L157">        }</span>

        public void processMix(float[] in, float[] out, float[] rout) {
<span class="nc" id="L160">            phase += phase_step;</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            while(phase &gt; (Math.PI * 2)) phase -= (Math.PI * 2);</span>
<span class="nc" id="L162">            vdelay.setDelay((float) (depth * 0.5 * (Math.cos(phase) + 2)));</span>
<span class="nc" id="L163">            vdelay.processMix(in, out, rout);</span>
<span class="nc" id="L164">        }</span>

        public void processReplace(float[] in, float[] out, float[] rout) {
<span class="nc" id="L167">            phase += phase_step;</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            while(phase &gt; (Math.PI * 2)) phase -= (Math.PI * 2);</span>
<span class="nc" id="L169">            vdelay.setDelay((float) (depth * 0.5 * (Math.cos(phase) + 2)));</span>
<span class="nc" id="L170">            vdelay.processReplace(in, out, rout);</span>

<span class="nc" id="L172">        }</span>
    }
<span class="nc" id="L174">    private boolean mix = true;</span>
    private SoftAudioBuffer inputA;
    private SoftAudioBuffer left;
    private SoftAudioBuffer right;
    private SoftAudioBuffer reverb;
    private LFODelay vdelay1L;
    private LFODelay vdelay1R;
<span class="nc" id="L181">    private float rgain = 0;</span>
<span class="nc" id="L182">    private boolean dirty = true;</span>
    private double dirty_vdelay1L_rate;
    private double dirty_vdelay1R_rate;
    private double dirty_vdelay1L_depth;
    private double dirty_vdelay1R_depth;
    private float dirty_vdelay1L_feedback;
    private float dirty_vdelay1R_feedback;
    private float dirty_vdelay1L_reverbsendgain;
    private float dirty_vdelay1R_reverbsendgain;
    private float controlrate;

    public void init(float samplerate, float controlrate) {
<span class="nc" id="L194">        this.controlrate = controlrate;</span>
<span class="nc" id="L195">        vdelay1L = new LFODelay(samplerate, controlrate);</span>
<span class="nc" id="L196">        vdelay1R = new LFODelay(samplerate, controlrate);</span>
<span class="nc" id="L197">        vdelay1L.setGain(1.0f); // %</span>
<span class="nc" id="L198">        vdelay1R.setGain(1.0f); // %</span>
<span class="nc" id="L199">        vdelay1L.setPhase(0.5 * Math.PI);</span>
<span class="nc" id="L200">        vdelay1R.setPhase(0);</span>

<span class="nc" id="L202">        globalParameterControlChange(new int[]{0x01 * 128 + 0x02}, 0, 2);</span>
<span class="nc" id="L203">    }</span>

    public void globalParameterControlChange(int[] slothpath, long param,
            long value) {
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (slothpath.length == 1) {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            if (slothpath[0] == 0x01 * 128 + 0x02) {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                if (param == 0) { // Chorus Type</span>
<span class="nc bnc" id="L210" title="All 7 branches missed.">                    switch ((int)value) {</span>
                    case 0: // Chorus 1 0 (0%) 3 (0.4Hz) 5 (1.9ms) 0 (0%)
<span class="nc" id="L212">                        globalParameterControlChange(slothpath, 3, 0);</span>
<span class="nc" id="L213">                        globalParameterControlChange(slothpath, 1, 3);</span>
<span class="nc" id="L214">                        globalParameterControlChange(slothpath, 2, 5);</span>
<span class="nc" id="L215">                        globalParameterControlChange(slothpath, 4, 0);</span>
<span class="nc" id="L216">                        break;</span>
                    case 1: // Chorus 2 5 (4%) 9 (1.1Hz) 19 (6.3ms) 0 (0%)
<span class="nc" id="L218">                        globalParameterControlChange(slothpath, 3, 5);</span>
<span class="nc" id="L219">                        globalParameterControlChange(slothpath, 1, 9);</span>
<span class="nc" id="L220">                        globalParameterControlChange(slothpath, 2, 19);</span>
<span class="nc" id="L221">                        globalParameterControlChange(slothpath, 4, 0);</span>
<span class="nc" id="L222">                        break;</span>
                    case 2: // Chorus 3 8 (6%) 3 (0.4Hz) 19 (6.3ms) 0 (0%)
<span class="nc" id="L224">                        globalParameterControlChange(slothpath, 3, 8);</span>
<span class="nc" id="L225">                        globalParameterControlChange(slothpath, 1, 3);</span>
<span class="nc" id="L226">                        globalParameterControlChange(slothpath, 2, 19);</span>
<span class="nc" id="L227">                        globalParameterControlChange(slothpath, 4, 0);</span>
<span class="nc" id="L228">                        break;</span>
                    case 3: // Chorus 4 16 (12%) 9 (1.1Hz) 16 (5.3ms) 0 (0%)
<span class="nc" id="L230">                        globalParameterControlChange(slothpath, 3, 16);</span>
<span class="nc" id="L231">                        globalParameterControlChange(slothpath, 1, 9);</span>
<span class="nc" id="L232">                        globalParameterControlChange(slothpath, 2, 16);</span>
<span class="nc" id="L233">                        globalParameterControlChange(slothpath, 4, 0);</span>
<span class="nc" id="L234">                        break;</span>
                    case 4: // FB Chorus 64 (49%) 2 (0.2Hz) 24 (7.8ms) 0 (0%)
<span class="nc" id="L236">                        globalParameterControlChange(slothpath, 3, 64);</span>
<span class="nc" id="L237">                        globalParameterControlChange(slothpath, 1, 2);</span>
<span class="nc" id="L238">                        globalParameterControlChange(slothpath, 2, 24);</span>
<span class="nc" id="L239">                        globalParameterControlChange(slothpath, 4, 0);</span>
<span class="nc" id="L240">                        break;</span>
                    case 5: // Flanger 112 (86%) 1 (0.1Hz) 5 (1.9ms) 0 (0%)
<span class="nc" id="L242">                        globalParameterControlChange(slothpath, 3, 112);</span>
<span class="nc" id="L243">                        globalParameterControlChange(slothpath, 1, 1);</span>
<span class="nc" id="L244">                        globalParameterControlChange(slothpath, 2, 5);</span>
<span class="nc" id="L245">                        globalParameterControlChange(slothpath, 4, 0);</span>
<span class="nc" id="L246">                        break;</span>
                    default:
<span class="nc" id="L248">                        break;</span>
                    }
<span class="nc bnc" id="L250" title="All 2 branches missed.">                } else if (param == 1) { // Mod Rate</span>
<span class="nc" id="L251">                    dirty_vdelay1L_rate = (value * 0.122);</span>
<span class="nc" id="L252">                    dirty_vdelay1R_rate = (value * 0.122);</span>
<span class="nc" id="L253">                    dirty = true;</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                } else if (param == 2) { // Mod Depth</span>
<span class="nc" id="L255">                    dirty_vdelay1L_depth = ((value + 1) / 3200.0);</span>
<span class="nc" id="L256">                    dirty_vdelay1R_depth = ((value + 1) / 3200.0);</span>
<span class="nc" id="L257">                    dirty = true;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                } else if (param == 3) { // Feedback</span>
<span class="nc" id="L259">                    dirty_vdelay1L_feedback = (value * 0.00763f);</span>
<span class="nc" id="L260">                    dirty_vdelay1R_feedback = (value * 0.00763f);</span>
<span class="nc" id="L261">                    dirty = true;</span>
                }
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (param == 4) { // Send to Reverb</span>
<span class="nc" id="L264">                    rgain = value * 0.00787f;</span>
<span class="nc" id="L265">                    dirty_vdelay1L_reverbsendgain = (value * 0.00787f);</span>
<span class="nc" id="L266">                    dirty_vdelay1R_reverbsendgain = (value * 0.00787f);</span>
<span class="nc" id="L267">                    dirty = true;</span>
                }

            }
        }
<span class="nc" id="L272">    }</span>

    public void processControlLogic() {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (dirty) {</span>
<span class="nc" id="L276">            dirty = false;</span>
<span class="nc" id="L277">            vdelay1L.setRate(dirty_vdelay1L_rate);</span>
<span class="nc" id="L278">            vdelay1R.setRate(dirty_vdelay1R_rate);</span>
<span class="nc" id="L279">            vdelay1L.setDepth(dirty_vdelay1L_depth);</span>
<span class="nc" id="L280">            vdelay1R.setDepth(dirty_vdelay1R_depth);</span>
<span class="nc" id="L281">            vdelay1L.setFeedBack(dirty_vdelay1L_feedback);</span>
<span class="nc" id="L282">            vdelay1R.setFeedBack(dirty_vdelay1R_feedback);</span>
<span class="nc" id="L283">            vdelay1L.setReverbSendGain(dirty_vdelay1L_reverbsendgain);</span>
<span class="nc" id="L284">            vdelay1R.setReverbSendGain(dirty_vdelay1R_reverbsendgain);</span>
        }
<span class="nc" id="L286">    }</span>
<span class="nc" id="L287">    double silentcounter = 1000;</span>

    public void processAudio() {

<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (inputA.isSilent()) {</span>
<span class="nc" id="L292">            silentcounter += 1 / controlrate;</span>

<span class="nc bnc" id="L294" title="All 2 branches missed.">            if (silentcounter &gt; 1) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                if (!mix) {</span>
<span class="nc" id="L296">                    left.clear();</span>
<span class="nc" id="L297">                    right.clear();</span>
                }
<span class="nc" id="L299">                return;</span>
            }
        } else
<span class="nc" id="L302">            silentcounter = 0;</span>

<span class="nc" id="L304">        float[] inputA = this.inputA.array();</span>
<span class="nc" id="L305">        float[] left = this.left.array();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">        float[] right = this.right == null ? null : this.right.array();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">        float[] reverb = rgain != 0 ? this.reverb.array() : null;</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (mix) {</span>
<span class="nc" id="L310">            vdelay1L.processMix(inputA, left, reverb);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if (right != null)</span>
<span class="nc" id="L312">                vdelay1R.processMix(inputA, right, reverb);</span>
        } else {
<span class="nc" id="L314">            vdelay1L.processReplace(inputA, left, reverb);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            if (right != null)</span>
<span class="nc" id="L316">                vdelay1R.processReplace(inputA, right, reverb);</span>
        }
<span class="nc" id="L318">    }</span>

    public void setInput(int pin, SoftAudioBuffer input) {
<span class="nc bnc" id="L321" title="All 2 branches missed.">        if (pin == 0)</span>
<span class="nc" id="L322">            inputA = input;</span>
<span class="nc" id="L323">    }</span>

    public void setMixMode(boolean mix) {
<span class="nc" id="L326">        this.mix = mix;</span>
<span class="nc" id="L327">    }</span>

    public void setOutput(int pin, SoftAudioBuffer output) {
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (pin == 0)</span>
<span class="nc" id="L331">            left = output;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (pin == 1)</span>
<span class="nc" id="L333">            right = output;</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (pin == 2)</span>
<span class="nc" id="L335">            reverb = output;</span>
<span class="nc" id="L336">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>