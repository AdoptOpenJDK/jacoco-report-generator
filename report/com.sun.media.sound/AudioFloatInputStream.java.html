<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>AudioFloatInputStream.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">AudioFloatInputStream.java</span></div><h1>AudioFloatInputStream.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.net.URL;

import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.UnsupportedAudioFileException;

/**
 * This class is used to create AudioFloatInputStream from AudioInputStream and
 * byte buffers.
 *
 * @author Karl Helgason
 */
<span class="nc" id="L44">public abstract class AudioFloatInputStream {</span>

    private static class BytaArrayAudioFloatInputStream
            extends AudioFloatInputStream {

<span class="nc" id="L49">        private int pos = 0;</span>
<span class="nc" id="L50">        private int markpos = 0;</span>
        private final AudioFloatConverter converter;
        private final AudioFormat format;
        private final byte[] buffer;
        private final int buffer_offset;
        private final int buffer_len;
        private final int framesize_pc;

        BytaArrayAudioFloatInputStream(AudioFloatConverter converter,
<span class="nc" id="L59">                byte[] buffer, int offset, int len) {</span>
<span class="nc" id="L60">            this.converter = converter;</span>
<span class="nc" id="L61">            this.format = converter.getFormat();</span>
<span class="nc" id="L62">            this.buffer = buffer;</span>
<span class="nc" id="L63">            this.buffer_offset = offset;</span>
<span class="nc" id="L64">            framesize_pc = format.getFrameSize() / format.getChannels();</span>
<span class="nc" id="L65">            this.buffer_len = len / framesize_pc;</span>

<span class="nc" id="L67">        }</span>

        public AudioFormat getFormat() {
<span class="nc" id="L70">            return format;</span>
        }

        public long getFrameLength() {
<span class="nc" id="L74">            return buffer_len;// / format.getFrameSize();</span>
        }

        public int read(float[] b, int off, int len) throws IOException {
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (b == null)</span>
<span class="nc" id="L79">                throw new NullPointerException();</span>
<span class="nc bnc" id="L80" title="All 6 branches missed.">            if (off &lt; 0 || len &lt; 0 || len &gt; b.length - off)</span>
<span class="nc" id="L81">                throw new IndexOutOfBoundsException();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">            if (pos &gt;= buffer_len)</span>
<span class="nc" id="L83">                return -1;</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (len == 0)</span>
<span class="nc" id="L85">                return 0;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (pos + len &gt; buffer_len)</span>
<span class="nc" id="L87">                len = buffer_len - pos;</span>
<span class="nc" id="L88">            converter.toFloatArray(buffer, buffer_offset + pos * framesize_pc,</span>
                    b, off, len);
<span class="nc" id="L90">            pos += len;</span>
<span class="nc" id="L91">            return len;</span>
        }

        public long skip(long len) throws IOException {
<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (pos &gt;= buffer_len)</span>
<span class="nc" id="L96">                return -1;</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            if (len &lt;= 0)</span>
<span class="nc" id="L98">                return 0;</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (pos + len &gt; buffer_len)</span>
<span class="nc" id="L100">                len = buffer_len - pos;</span>
<span class="nc" id="L101">            pos += len;</span>
<span class="nc" id="L102">            return len;</span>
        }

        public int available() throws IOException {
<span class="nc" id="L106">            return buffer_len - pos;</span>
        }

        public void close() throws IOException {
<span class="nc" id="L110">        }</span>

        public void mark(int readlimit) {
<span class="nc" id="L113">            markpos = pos;</span>
<span class="nc" id="L114">        }</span>

        public boolean markSupported() {
<span class="nc" id="L117">            return true;</span>
        }

        public void reset() throws IOException {
<span class="nc" id="L121">            pos = markpos;</span>
<span class="nc" id="L122">        }</span>
    }

<span class="nc" id="L125">    private static class DirectAudioFloatInputStream</span>
            extends AudioFloatInputStream {

        private final AudioInputStream stream;
        private AudioFloatConverter converter;
        private final int framesize_pc; // framesize / channels
        private byte[] buffer;

<span class="nc" id="L133">        DirectAudioFloatInputStream(AudioInputStream stream) {</span>
<span class="nc" id="L134">            converter = AudioFloatConverter.getConverter(stream.getFormat());</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (converter == null) {</span>
<span class="nc" id="L136">                AudioFormat format = stream.getFormat();</span>
                AudioFormat newformat;

<span class="nc" id="L139">                AudioFormat[] formats = AudioSystem.getTargetFormats(</span>
                        AudioFormat.Encoding.PCM_SIGNED, format);
<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (formats.length != 0) {</span>
<span class="nc" id="L142">                    newformat = formats[0];</span>
                } else {
<span class="nc" id="L144">                    float samplerate = format.getSampleRate();</span>
<span class="nc" id="L145">                    int samplesizeinbits = format.getSampleSizeInBits();</span>
<span class="nc" id="L146">                    int framesize = format.getFrameSize();</span>
<span class="nc" id="L147">                    float framerate = format.getFrameRate();</span>
<span class="nc" id="L148">                    samplesizeinbits = 16;</span>
<span class="nc" id="L149">                    framesize = format.getChannels() * (samplesizeinbits / 8);</span>
<span class="nc" id="L150">                    framerate = samplerate;</span>

<span class="nc" id="L152">                    newformat = new AudioFormat(</span>
                            AudioFormat.Encoding.PCM_SIGNED, samplerate,
<span class="nc" id="L154">                            samplesizeinbits, format.getChannels(), framesize,</span>
                            framerate, false);
                }

<span class="nc" id="L158">                stream = AudioSystem.getAudioInputStream(newformat, stream);</span>
<span class="nc" id="L159">                converter = AudioFloatConverter.getConverter(stream.getFormat());</span>
            }
<span class="nc" id="L161">            framesize_pc = stream.getFormat().getFrameSize()</span>
<span class="nc" id="L162">                    / stream.getFormat().getChannels();</span>
<span class="nc" id="L163">            this.stream = stream;</span>
<span class="nc" id="L164">        }</span>

        public AudioFormat getFormat() {
<span class="nc" id="L167">            return stream.getFormat();</span>
        }

        public long getFrameLength() {
<span class="nc" id="L171">            return stream.getFrameLength();</span>
        }

        public int read(float[] b, int off, int len) throws IOException {
<span class="nc" id="L175">            int b_len = len * framesize_pc;</span>
<span class="nc bnc" id="L176" title="All 4 branches missed.">            if (buffer == null || buffer.length &lt; b_len)</span>
<span class="nc" id="L177">                buffer = new byte[b_len];</span>
<span class="nc" id="L178">            int ret = stream.read(buffer, 0, b_len);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">            if (ret == -1)</span>
<span class="nc" id="L180">                return -1;</span>
<span class="nc" id="L181">            converter.toFloatArray(buffer, b, off, ret / framesize_pc);</span>
<span class="nc" id="L182">            return ret / framesize_pc;</span>
        }

        public long skip(long len) throws IOException {
<span class="nc" id="L186">            long b_len = len * framesize_pc;</span>
<span class="nc" id="L187">            long ret = stream.skip(b_len);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (ret == -1)</span>
<span class="nc" id="L189">                return -1;</span>
<span class="nc" id="L190">            return ret / framesize_pc;</span>
        }

        public int available() throws IOException {
<span class="nc" id="L194">            return stream.available() / framesize_pc;</span>
        }

        public void close() throws IOException {
<span class="nc" id="L198">            stream.close();</span>
<span class="nc" id="L199">        }</span>

        public void mark(int readlimit) {
<span class="nc" id="L202">            stream.mark(readlimit * framesize_pc);</span>
<span class="nc" id="L203">        }</span>

        public boolean markSupported() {
<span class="nc" id="L206">            return stream.markSupported();</span>
        }

        public void reset() throws IOException {
<span class="nc" id="L210">            stream.reset();</span>
<span class="nc" id="L211">        }</span>
    }

    public static AudioFloatInputStream getInputStream(URL url)
            throws UnsupportedAudioFileException, IOException {
<span class="nc" id="L216">        return new DirectAudioFloatInputStream(AudioSystem</span>
<span class="nc" id="L217">                .getAudioInputStream(url));</span>
    }

    public static AudioFloatInputStream getInputStream(File file)
            throws UnsupportedAudioFileException, IOException {
<span class="nc" id="L222">        return new DirectAudioFloatInputStream(AudioSystem</span>
<span class="nc" id="L223">                .getAudioInputStream(file));</span>
    }

    public static AudioFloatInputStream getInputStream(InputStream stream)
            throws UnsupportedAudioFileException, IOException {
<span class="nc" id="L228">        return new DirectAudioFloatInputStream(AudioSystem</span>
<span class="nc" id="L229">                .getAudioInputStream(stream));</span>
    }

    public static AudioFloatInputStream getInputStream(
            AudioInputStream stream) {
<span class="nc" id="L234">        return new DirectAudioFloatInputStream(stream);</span>
    }

    public static AudioFloatInputStream getInputStream(AudioFormat format,
            byte[] buffer, int offset, int len) {
<span class="nc" id="L239">        AudioFloatConverter converter = AudioFloatConverter</span>
<span class="nc" id="L240">                .getConverter(format);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (converter != null)</span>
<span class="nc" id="L242">            return new BytaArrayAudioFloatInputStream(converter, buffer,</span>
                    offset, len);

<span class="nc" id="L245">        InputStream stream = new ByteArrayInputStream(buffer, offset, len);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        long aLen = format.getFrameSize() == AudioSystem.NOT_SPECIFIED</span>
<span class="nc" id="L247">                ? AudioSystem.NOT_SPECIFIED : len / format.getFrameSize();</span>
<span class="nc" id="L248">        AudioInputStream astream = new AudioInputStream(stream, format, aLen);</span>
<span class="nc" id="L249">        return getInputStream(astream);</span>
    }

    public abstract AudioFormat getFormat();

    public abstract long getFrameLength();

    public abstract int read(float[] b, int off, int len) throws IOException;

    public final int read(float[] b) throws IOException {
<span class="nc" id="L259">        return read(b, 0, b.length);</span>
    }

    public final float read() throws IOException {
<span class="nc" id="L263">        float[] b = new float[1];</span>
<span class="nc" id="L264">        int ret = read(b, 0, 1);</span>
<span class="nc bnc" id="L265" title="All 4 branches missed.">        if (ret == -1 || ret == 0)</span>
<span class="nc" id="L266">            return 0;</span>
<span class="nc" id="L267">        return b[0];</span>
    }

    public abstract long skip(long len) throws IOException;

    public abstract int available() throws IOException;

    public abstract void close() throws IOException;

    public abstract void mark(int readlimit);

    public abstract boolean markSupported();

    public abstract void reset() throws IOException;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>