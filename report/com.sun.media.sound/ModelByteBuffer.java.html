<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>ModelByteBuffer.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">ModelByteBuffer.java</span></div><h1>ModelByteBuffer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.io.ByteArrayInputStream;
import java.io.DataInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.RandomAccessFile;
import java.util.Collection;

/**
 * This class is a pointer to a binary array either in memory or on disk.
 *
 * @author Karl Helgason
 */
public final class ModelByteBuffer {

<span class="nc" id="L43">    private ModelByteBuffer root = this;</span>
    private File file;
    private long fileoffset;
    private byte[] buffer;
    private long offset;
    private final long len;

    private class RandomFileInputStream extends InputStream {

        private final RandomAccessFile raf;
        private long left;
<span class="nc" id="L54">        private long mark = 0;</span>
<span class="nc" id="L55">        private long markleft = 0;</span>

<span class="nc" id="L57">        RandomFileInputStream() throws IOException {</span>
<span class="nc" id="L58">            raf = new RandomAccessFile(root.file, &quot;r&quot;);</span>
<span class="nc" id="L59">            raf.seek(root.fileoffset + arrayOffset());</span>
<span class="nc" id="L60">            left = capacity();</span>
<span class="nc" id="L61">        }</span>

        public int available() throws IOException {
<span class="nc bnc" id="L64" title="All 2 branches missed.">            if (left &gt; Integer.MAX_VALUE)</span>
<span class="nc" id="L65">                return Integer.MAX_VALUE;</span>
<span class="nc" id="L66">            return (int)left;</span>
        }

        public synchronized void mark(int readlimit) {
            try {
<span class="nc" id="L71">                mark = raf.getFilePointer();</span>
<span class="nc" id="L72">                markleft = left;</span>
<span class="nc" id="L73">            } catch (IOException e) {</span>
                //e.printStackTrace();
<span class="nc" id="L75">            }</span>
<span class="nc" id="L76">        }</span>

        public boolean markSupported() {
<span class="nc" id="L79">            return true;</span>
        }

        public synchronized void reset() throws IOException {
<span class="nc" id="L83">            raf.seek(mark);</span>
<span class="nc" id="L84">            left = markleft;</span>
<span class="nc" id="L85">        }</span>

        public long skip(long n) throws IOException {
<span class="nc bnc" id="L88" title="All 2 branches missed.">            if( n &lt; 0)</span>
<span class="nc" id="L89">                return 0;</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (n &gt; left)</span>
<span class="nc" id="L91">                n = left;</span>
<span class="nc" id="L92">            long p = raf.getFilePointer();</span>
<span class="nc" id="L93">            raf.seek(p + n);</span>
<span class="nc" id="L94">            left -= n;</span>
<span class="nc" id="L95">            return n;</span>
        }

        public int read(byte b[], int off, int len) throws IOException {
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (len &gt; left)</span>
<span class="nc" id="L100">                len = (int)left;</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (left == 0)</span>
<span class="nc" id="L102">                return -1;</span>
<span class="nc" id="L103">            len = raf.read(b, off, len);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (len == -1)</span>
<span class="nc" id="L105">                return -1;</span>
<span class="nc" id="L106">            left -= len;</span>
<span class="nc" id="L107">            return len;</span>
        }

        public int read(byte[] b) throws IOException {
<span class="nc" id="L111">            int len = b.length;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (len &gt; left)</span>
<span class="nc" id="L113">                len = (int)left;</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            if (left == 0)</span>
<span class="nc" id="L115">                return -1;</span>
<span class="nc" id="L116">            len = raf.read(b, 0, len);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">            if (len == -1)</span>
<span class="nc" id="L118">                return -1;</span>
<span class="nc" id="L119">            left -= len;</span>
<span class="nc" id="L120">            return len;</span>
        }

        public int read() throws IOException {
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (left == 0)</span>
<span class="nc" id="L125">                return -1;</span>
<span class="nc" id="L126">            int b = raf.read();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (b == -1)</span>
<span class="nc" id="L128">                return -1;</span>
<span class="nc" id="L129">            left--;</span>
<span class="nc" id="L130">            return b;</span>
        }

        public void close() throws IOException {
<span class="nc" id="L134">            raf.close();</span>
<span class="nc" id="L135">        }</span>
    }

    private ModelByteBuffer(ModelByteBuffer parent,
<span class="nc" id="L139">            long beginIndex, long endIndex, boolean independent) {</span>
<span class="nc" id="L140">        this.root = parent.root;</span>
<span class="nc" id="L141">        this.offset = 0;</span>
<span class="nc" id="L142">        long parent_len = parent.len;</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (beginIndex &lt; 0)</span>
<span class="nc" id="L144">            beginIndex = 0;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (beginIndex &gt; parent_len)</span>
<span class="nc" id="L146">            beginIndex = parent_len;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (endIndex &lt; 0)</span>
<span class="nc" id="L148">            endIndex = 0;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (endIndex &gt; parent_len)</span>
<span class="nc" id="L150">            endIndex = parent_len;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (beginIndex &gt; endIndex)</span>
<span class="nc" id="L152">            beginIndex = endIndex;</span>
<span class="nc" id="L153">        offset = beginIndex;</span>
<span class="nc" id="L154">        len = endIndex - beginIndex;</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (independent) {</span>
<span class="nc" id="L156">            buffer = root.buffer;</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (root.file != null) {</span>
<span class="nc" id="L158">                file = root.file;</span>
<span class="nc" id="L159">                fileoffset = root.fileoffset + arrayOffset();</span>
<span class="nc" id="L160">                offset = 0;</span>
            } else
<span class="nc" id="L162">                offset = arrayOffset();</span>
<span class="nc" id="L163">            root = this;</span>
        }
<span class="nc" id="L165">    }</span>

<span class="nc" id="L167">    public ModelByteBuffer(byte[] buffer) {</span>
<span class="nc" id="L168">        this.buffer = buffer;</span>
<span class="nc" id="L169">        this.offset = 0;</span>
<span class="nc" id="L170">        this.len = buffer.length;</span>
<span class="nc" id="L171">    }</span>

<span class="nc" id="L173">    public ModelByteBuffer(byte[] buffer, int offset, int len) {</span>
<span class="nc" id="L174">        this.buffer = buffer;</span>
<span class="nc" id="L175">        this.offset = offset;</span>
<span class="nc" id="L176">        this.len = len;</span>
<span class="nc" id="L177">    }</span>

<span class="nc" id="L179">    public ModelByteBuffer(File file) {</span>
<span class="nc" id="L180">        this.file = file;</span>
<span class="nc" id="L181">        this.fileoffset = 0;</span>
<span class="nc" id="L182">        this.len = file.length();</span>
<span class="nc" id="L183">    }</span>

<span class="nc" id="L185">    public ModelByteBuffer(File file, long offset, long len) {</span>
<span class="nc" id="L186">        this.file = file;</span>
<span class="nc" id="L187">        this.fileoffset = offset;</span>
<span class="nc" id="L188">        this.len = len;</span>
<span class="nc" id="L189">    }</span>

    public void writeTo(OutputStream out) throws IOException {
<span class="nc bnc" id="L192" title="All 4 branches missed.">        if (root.file != null &amp;&amp; root.buffer == null) {</span>
<span class="nc" id="L193">            InputStream is = getInputStream();</span>
<span class="nc" id="L194">            byte[] buff = new byte[1024];</span>
            int ret;
<span class="nc bnc" id="L196" title="All 2 branches missed.">            while ((ret = is.read(buff)) != -1)</span>
<span class="nc" id="L197">                out.write(buff, 0, ret);</span>
<span class="nc" id="L198">        } else</span>
<span class="nc" id="L199">            out.write(array(), (int) arrayOffset(), (int) capacity());</span>
<span class="nc" id="L200">    }</span>

    public InputStream getInputStream() {
<span class="nc bnc" id="L203" title="All 4 branches missed.">        if (root.file != null &amp;&amp; root.buffer == null) {</span>
            try {
<span class="nc" id="L205">                return new RandomFileInputStream();</span>
<span class="nc" id="L206">            } catch (IOException e) {</span>
                //e.printStackTrace();
<span class="nc" id="L208">                return null;</span>
            }
        }
<span class="nc" id="L211">        return new ByteArrayInputStream(array(),</span>
<span class="nc" id="L212">                (int)arrayOffset(), (int)capacity());</span>
    }

    public ModelByteBuffer subbuffer(long beginIndex) {
<span class="nc" id="L216">        return subbuffer(beginIndex, capacity());</span>
    }

    public ModelByteBuffer subbuffer(long beginIndex, long endIndex) {
<span class="nc" id="L220">        return subbuffer(beginIndex, endIndex, false);</span>
    }

    public ModelByteBuffer subbuffer(long beginIndex, long endIndex,
            boolean independent) {
<span class="nc" id="L225">        return new ModelByteBuffer(this, beginIndex, endIndex, independent);</span>
    }

    public byte[] array() {
<span class="nc" id="L229">        return root.buffer;</span>
    }

    public long arrayOffset() {
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (root != this)</span>
<span class="nc" id="L234">            return root.arrayOffset() + offset;</span>
<span class="nc" id="L235">        return offset;</span>
    }

    public long capacity() {
<span class="nc" id="L239">        return len;</span>
    }

    public ModelByteBuffer getRoot() {
<span class="nc" id="L243">        return root;</span>
    }

    public File getFile() {
<span class="nc" id="L247">        return file;</span>
    }

    public long getFilePointer() {
<span class="nc" id="L251">        return fileoffset;</span>
    }

    public static void loadAll(Collection&lt;ModelByteBuffer&gt; col)
            throws IOException {
<span class="nc" id="L256">        File selfile = null;</span>
<span class="nc" id="L257">        RandomAccessFile raf = null;</span>
        try {
<span class="nc bnc" id="L259" title="All 2 branches missed.">            for (ModelByteBuffer mbuff : col) {</span>
<span class="nc" id="L260">                mbuff = mbuff.root;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                if (mbuff.file == null)</span>
<span class="nc" id="L262">                    continue;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (mbuff.buffer != null)</span>
<span class="nc" id="L264">                    continue;</span>
<span class="nc bnc" id="L265" title="All 4 branches missed.">                if (selfile == null || !selfile.equals(mbuff.file)) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">                    if (raf != null) {</span>
<span class="nc" id="L267">                        raf.close();</span>
<span class="nc" id="L268">                        raf = null;</span>
                    }
<span class="nc" id="L270">                    selfile = mbuff.file;</span>
<span class="nc" id="L271">                    raf = new RandomAccessFile(mbuff.file, &quot;r&quot;);</span>
                }
<span class="nc" id="L273">                raf.seek(mbuff.fileoffset);</span>
<span class="nc" id="L274">                byte[] buffer = new byte[(int) mbuff.capacity()];</span>

<span class="nc" id="L276">                int read = 0;</span>
<span class="nc" id="L277">                int avail = buffer.length;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                while (read != avail) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                    if (avail - read &gt; 65536) {</span>
<span class="nc" id="L280">                        raf.readFully(buffer, read, 65536);</span>
<span class="nc" id="L281">                        read += 65536;</span>
                    } else {
<span class="nc" id="L283">                        raf.readFully(buffer, read, avail - read);</span>
<span class="nc" id="L284">                        read = avail;</span>
                    }

                }

<span class="nc" id="L289">                mbuff.buffer = buffer;</span>
<span class="nc" id="L290">                mbuff.offset = 0;</span>
<span class="nc" id="L291">            }</span>
        } finally {
<span class="nc bnc" id="L293" title="All 4 branches missed.">            if (raf != null)</span>
<span class="nc" id="L294">                raf.close();</span>
        }
<span class="nc" id="L296">    }</span>

    public void load() throws IOException {
<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (root != this) {</span>
<span class="nc" id="L300">            root.load();</span>
<span class="nc" id="L301">            return;</span>
        }
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (buffer != null)</span>
<span class="nc" id="L304">            return;</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (file == null) {</span>
<span class="nc" id="L306">            throw new IllegalStateException(</span>
                    &quot;No file associated with this ByteBuffer!&quot;);
        }

<span class="nc" id="L310">        DataInputStream is = new DataInputStream(getInputStream());</span>
<span class="nc" id="L311">        buffer = new byte[(int) capacity()];</span>
<span class="nc" id="L312">        offset = 0;</span>
<span class="nc" id="L313">        is.readFully(buffer);</span>
<span class="nc" id="L314">        is.close();</span>

<span class="nc" id="L316">    }</span>

    public void unload() {
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (root != this) {</span>
<span class="nc" id="L320">            root.unload();</span>
<span class="nc" id="L321">            return;</span>
        }
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (file == null) {</span>
<span class="nc" id="L324">            throw new IllegalStateException(</span>
                    &quot;No file associated with this ByteBuffer!&quot;);
        }
<span class="nc" id="L327">        root.buffer = null;</span>
<span class="nc" id="L328">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>