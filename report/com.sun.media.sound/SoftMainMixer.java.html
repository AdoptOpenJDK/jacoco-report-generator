<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>SoftMainMixer.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">SoftMainMixer.java</span></div><h1>SoftMainMixer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.io.IOException;
import java.io.InputStream;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Set;
import java.util.TreeMap;
import java.util.Map.Entry;

import javax.sound.midi.MidiMessage;
import javax.sound.midi.Patch;
import javax.sound.midi.ShortMessage;
import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;

/**
 * Software synthesizer main audio mixer.
 *
 * @author Karl Helgason
 */
public final class SoftMainMixer {

    // A private class thats contains a ModelChannelMixer and it's private buffers.
    // This becomes necessary when we want to have separate delay buffers for each channel mixer.
<span class="nc" id="L50">    private class SoftChannelMixerContainer</span>
    {
        ModelChannelMixer mixer;
        SoftAudioBuffer[] buffers;
    }

    public final static int CHANNEL_LEFT = 0;
    public final static int CHANNEL_RIGHT = 1;
    public final static int CHANNEL_MONO = 2;
    public final static int CHANNEL_DELAY_LEFT = 3;
    public final static int CHANNEL_DELAY_RIGHT = 4;
    public final static int CHANNEL_DELAY_MONO = 5;
    public final static int CHANNEL_EFFECT1 = 6;
    public final static int CHANNEL_EFFECT2 = 7;
    public final static int CHANNEL_DELAY_EFFECT1 = 8;
    public final static int CHANNEL_DELAY_EFFECT2 = 9;
    public final static int CHANNEL_LEFT_DRY = 10;
    public final static int CHANNEL_RIGHT_DRY = 11;
    public final static int CHANNEL_SCRATCH1 = 12;
    public final static int CHANNEL_SCRATCH2 = 13;
<span class="nc" id="L70">    boolean active_sensing_on = false;</span>
<span class="nc" id="L71">    private long msec_last_activity = -1;</span>
<span class="nc" id="L72">    private boolean pusher_silent = false;</span>
<span class="nc" id="L73">    private int pusher_silent_count = 0;</span>
<span class="nc" id="L74">    private long sample_pos = 0;</span>
<span class="nc" id="L75">    boolean readfully = true;</span>
    private final Object control_mutex;
    private SoftSynthesizer synth;
<span class="nc" id="L78">    private float samplerate = 44100;</span>
<span class="nc" id="L79">    private int nrofchannels = 2;</span>
<span class="nc" id="L80">    private SoftVoice[] voicestatus = null;</span>
    private SoftAudioBuffer[] buffers;
    private SoftReverb reverb;
    private SoftAudioProcessor chorus;
    private SoftAudioProcessor agc;
<span class="nc" id="L85">    private long msec_buffer_len = 0;</span>
<span class="nc" id="L86">    private int buffer_len = 0;</span>
<span class="nc" id="L87">    TreeMap&lt;Long, Object&gt; midimessages = new TreeMap&lt;Long, Object&gt;();</span>
<span class="nc" id="L88">    private int delay_midievent = 0;</span>
<span class="nc" id="L89">    private int max_delay_midievent = 0;</span>
<span class="nc" id="L90">    double last_volume_left = 1.0;</span>
<span class="nc" id="L91">    double last_volume_right = 1.0;</span>
<span class="nc" id="L92">    private double[] co_master_balance = new double[1];</span>
<span class="nc" id="L93">    private double[] co_master_volume = new double[1];</span>
<span class="nc" id="L94">    private double[] co_master_coarse_tuning = new double[1];</span>
<span class="nc" id="L95">    private double[] co_master_fine_tuning = new double[1];</span>
    private AudioInputStream ais;
<span class="nc" id="L97">    private Set&lt;SoftChannelMixerContainer&gt; registeredMixers = null;</span>
<span class="nc" id="L98">    private Set&lt;ModelChannelMixer&gt; stoppedMixers = null;</span>
<span class="nc" id="L99">    private SoftChannelMixerContainer[] cur_registeredMixers = null;</span>
<span class="nc" id="L100">    SoftControl co_master = new SoftControl() {</span>

<span class="nc" id="L102">        double[] balance = co_master_balance;</span>
<span class="nc" id="L103">        double[] volume = co_master_volume;</span>
<span class="nc" id="L104">        double[] coarse_tuning = co_master_coarse_tuning;</span>
<span class="nc" id="L105">        double[] fine_tuning = co_master_fine_tuning;</span>

        public double[] get(int instance, String name) {
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (name == null)</span>
<span class="nc" id="L109">                return null;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (name.equals(&quot;balance&quot;))</span>
<span class="nc" id="L111">                return balance;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (name.equals(&quot;volume&quot;))</span>
<span class="nc" id="L113">                return volume;</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            if (name.equals(&quot;coarse_tuning&quot;))</span>
<span class="nc" id="L115">                return coarse_tuning;</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (name.equals(&quot;fine_tuning&quot;))</span>
<span class="nc" id="L117">                return fine_tuning;</span>
<span class="nc" id="L118">            return null;</span>
        }
    };

    private void processSystemExclusiveMessage(byte[] data) {
<span class="nc" id="L123">        synchronized (synth.control_mutex) {</span>
<span class="nc" id="L124">            activity();</span>

            // Universal Non-Real-Time SysEx
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if ((data[1] &amp; 0xFF) == 0x7E) {</span>
<span class="nc" id="L128">                int deviceID = data[2] &amp; 0xFF;</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">                if (deviceID == 0x7F || deviceID == synth.getDeviceID()) {</span>
<span class="nc" id="L130">                    int subid1 = data[3] &amp; 0xFF;</span>
                    int subid2;
<span class="nc bnc" id="L132" title="All 4 branches missed.">                    switch (subid1) {</span>
                    case 0x08:  // MIDI Tuning Standard
<span class="nc" id="L134">                        subid2 = data[4] &amp; 0xFF;</span>
<span class="nc bnc" id="L135" title="All 4 branches missed.">                        switch (subid2) {</span>
                        case 0x01:  // BULK TUNING DUMP
                        {
                            // http://www.midi.org/about-midi/tuning.shtml
<span class="nc" id="L139">                            SoftTuning tuning = synth.getTuning(new Patch(0,</span>
                                    data[5] &amp; 0xFF));
<span class="nc" id="L141">                            tuning.load(data);</span>
<span class="nc" id="L142">                            break;</span>
                        }
                        case 0x04:  // KEY-BASED TUNING DUMP
                        case 0x05:  // SCALE/OCTAVE TUNING DUMP, 1 byte format
                        case 0x06:  // SCALE/OCTAVE TUNING DUMP, 2 byte format
                        case 0x07:  // SINGLE NOTE TUNING CHANGE (NON REAL-TIME)
                                    // (BANK)
                        {
                            // http://www.midi.org/about-midi/tuning_extens.shtml
<span class="nc" id="L151">                            SoftTuning tuning = synth.getTuning(new Patch(</span>
                                    data[5] &amp; 0xFF, data[6] &amp; 0xFF));
<span class="nc" id="L153">                            tuning.load(data);</span>
<span class="nc" id="L154">                            break;</span>
                        }
                        case 0x08:  // scale/octave tuning 1-byte form (Non
                                    // Real-Time)
                        case 0x09:  // scale/octave tuning 2-byte form (Non
                                    // Real-Time)
                        {
                            // http://www.midi.org/about-midi/tuning-scale.shtml
<span class="nc" id="L162">                            SoftTuning tuning = new SoftTuning(data);</span>
<span class="nc" id="L163">                            int channelmask = (data[5] &amp; 0xFF) * 16384</span>
                                    + (data[6] &amp; 0xFF) * 128 + (data[7] &amp; 0xFF);
<span class="nc" id="L165">                            SoftChannel[] channels = synth.channels;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                            for (int i = 0; i &lt; channels.length; i++)</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                                if ((channelmask &amp; (1 &lt;&lt; i)) != 0)</span>
<span class="nc" id="L168">                                    channels[i].tuning = tuning;</span>
<span class="nc" id="L169">                            break;</span>
                        }
                        default:
<span class="nc" id="L172">                            break;</span>
                        }
                        break;
                    case 0x09:  // General Midi Message
<span class="nc" id="L176">                        subid2 = data[4] &amp; 0xFF;</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">                        switch (subid2) {</span>
                        case 0x01:  // General Midi 1 On
<span class="nc" id="L179">                            synth.setGeneralMidiMode(1);</span>
<span class="nc" id="L180">                            reset();</span>
<span class="nc" id="L181">                            break;</span>
                        case 0x02:  // General Midi Off
<span class="nc" id="L183">                            synth.setGeneralMidiMode(0);</span>
<span class="nc" id="L184">                            reset();</span>
<span class="nc" id="L185">                            break;</span>
                        case 0x03:  // General MidI Level 2 On
<span class="nc" id="L187">                            synth.setGeneralMidiMode(2);</span>
<span class="nc" id="L188">                            reset();</span>
<span class="nc" id="L189">                            break;</span>
                        default:
<span class="nc" id="L191">                            break;</span>
                        }
                        break;
                    case 0x0A: // DLS Message
<span class="nc" id="L195">                        subid2 = data[4] &amp; 0xFF;</span>
<span class="nc bnc" id="L196" title="All 5 branches missed.">                        switch (subid2) {</span>
                        case 0x01:  // DLS On
<span class="nc bnc" id="L198" title="All 2 branches missed.">                            if (synth.getGeneralMidiMode() == 0)</span>
<span class="nc" id="L199">                                synth.setGeneralMidiMode(1);</span>
<span class="nc" id="L200">                            synth.voice_allocation_mode = 1;</span>
<span class="nc" id="L201">                            reset();</span>
<span class="nc" id="L202">                            break;</span>
                        case 0x02:  // DLS Off
<span class="nc" id="L204">                            synth.setGeneralMidiMode(0);</span>
<span class="nc" id="L205">                            synth.voice_allocation_mode = 0;</span>
<span class="nc" id="L206">                            reset();</span>
<span class="nc" id="L207">                            break;</span>
                        case 0x03:  // DLS Static Voice Allocation Off
<span class="nc" id="L209">                            synth.voice_allocation_mode = 0;</span>
<span class="nc" id="L210">                            break;</span>
                        case 0x04:  // DLS Static Voice Allocation On
<span class="nc" id="L212">                            synth.voice_allocation_mode = 1;</span>
<span class="nc" id="L213">                            break;</span>
                        default:
<span class="nc" id="L215">                            break;</span>
                        }
                        break;

                    default:
                        break;
                    }
                }
            }

            // Universal Real-Time SysEx
<span class="nc bnc" id="L226" title="All 2 branches missed.">            if ((data[1] &amp; 0xFF) == 0x7F) {</span>
<span class="nc" id="L227">                int deviceID = data[2] &amp; 0xFF;</span>
<span class="nc bnc" id="L228" title="All 4 branches missed.">                if (deviceID == 0x7F || deviceID == synth.getDeviceID()) {</span>
<span class="nc" id="L229">                    int subid1 = data[3] &amp; 0xFF;</span>
                    int subid2;
<span class="nc bnc" id="L231" title="All 5 branches missed.">                    switch (subid1) {</span>
                    case 0x04: // Device Control

<span class="nc" id="L234">                        subid2 = data[4] &amp; 0xFF;</span>
<span class="nc bnc" id="L235" title="All 3 branches missed.">                        switch (subid2) {</span>
                        case 0x01: // Master Volume
                        case 0x02: // Master Balane
                        case 0x03: // Master fine tuning
                        case 0x04: // Master coarse tuning
<span class="nc" id="L240">                            int val = (data[5] &amp; 0x7F)</span>
                                    + ((data[6] &amp; 0x7F) * 128);
<span class="nc bnc" id="L242" title="All 2 branches missed.">                            if (subid2 == 0x01)</span>
<span class="nc" id="L243">                                setVolume(val);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                            else if (subid2 == 0x02)</span>
<span class="nc" id="L245">                                setBalance(val);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">                            else if (subid2 == 0x03)</span>
<span class="nc" id="L247">                                setFineTuning(val);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                            else if (subid2 == 0x04)</span>
<span class="nc" id="L249">                                setCoarseTuning(val);</span>
                            break;
                        case 0x05: // Global Parameter Control
<span class="nc" id="L252">                            int ix = 5;</span>
<span class="nc" id="L253">                            int slotPathLen = (data[ix++] &amp; 0xFF);</span>
<span class="nc" id="L254">                            int paramWidth = (data[ix++] &amp; 0xFF);</span>
<span class="nc" id="L255">                            int valueWidth = (data[ix++] &amp; 0xFF);</span>
<span class="nc" id="L256">                            int[] slotPath = new int[slotPathLen];</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                            for (int i = 0; i &lt; slotPathLen; i++) {</span>
<span class="nc" id="L258">                                int msb = (data[ix++] &amp; 0xFF);</span>
<span class="nc" id="L259">                                int lsb = (data[ix++] &amp; 0xFF);</span>
<span class="nc" id="L260">                                slotPath[i] = msb * 128 + lsb;</span>
                            }
<span class="nc" id="L262">                            int paramCount = (data.length - 1 - ix)</span>
                                    / (paramWidth + valueWidth);
<span class="nc" id="L264">                            long[] params = new long[paramCount];</span>
<span class="nc" id="L265">                            long[] values = new long[paramCount];</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">                            for (int i = 0; i &lt; paramCount; i++) {</span>
<span class="nc" id="L267">                                values[i] = 0;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">                                for (int j = 0; j &lt; paramWidth; j++)</span>
<span class="nc" id="L269">                                    params[i] = params[i] * 128</span>
                                            + (data[ix++] &amp; 0xFF);
<span class="nc bnc" id="L271" title="All 2 branches missed.">                                for (int j = 0; j &lt; valueWidth; j++)</span>
<span class="nc" id="L272">                                    values[i] = values[i] * 128</span>
                                            + (data[ix++] &amp; 0xFF);

                            }
<span class="nc" id="L276">                            globalParameterControlChange(slotPath, params, values);</span>
<span class="nc" id="L277">                            break;</span>
                        default:
                            break;
                        }
<span class="nc" id="L281">                        break;</span>

                    case 0x08:  // MIDI Tuning Standard
<span class="nc" id="L284">                        subid2 = data[4] &amp; 0xFF;</span>
<span class="nc bnc" id="L285" title="All 4 branches missed.">                        switch (subid2) {</span>
                        case 0x02:  // SINGLE NOTE TUNING CHANGE (REAL-TIME)
                        {
                            // http://www.midi.org/about-midi/tuning.shtml
<span class="nc" id="L289">                            SoftTuning tuning = synth.getTuning(new Patch(0,</span>
                                    data[5] &amp; 0xFF));
<span class="nc" id="L291">                            tuning.load(data);</span>
<span class="nc" id="L292">                            SoftVoice[] voices = synth.getVoices();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">                            for (int i = 0; i &lt; voices.length; i++)</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                                if (voices[i].active)</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                                    if (voices[i].tuning == tuning)</span>
<span class="nc" id="L296">                                        voices[i].updateTuning(tuning);</span>
<span class="nc" id="L297">                            break;</span>
                        }
                        case 0x07:  // SINGLE NOTE TUNING CHANGE (REAL-TIME)
                                    // (BANK)
                        {
                            // http://www.midi.org/about-midi/tuning_extens.shtml
<span class="nc" id="L303">                            SoftTuning tuning = synth.getTuning(new Patch(</span>
                                    data[5] &amp; 0xFF, data[6] &amp; 0xFF));
<span class="nc" id="L305">                            tuning.load(data);</span>
<span class="nc" id="L306">                            SoftVoice[] voices = synth.getVoices();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                            for (int i = 0; i &lt; voices.length; i++)</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                                if (voices[i].active)</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">                                    if (voices[i].tuning == tuning)</span>
<span class="nc" id="L310">                                        voices[i].updateTuning(tuning);</span>
<span class="nc" id="L311">                            break;</span>
                        }
                        case 0x08:  // scale/octave tuning 1-byte form
                                    //(Real-Time)
                        case 0x09:  // scale/octave tuning 2-byte form
                                    // (Real-Time)
                        {
                            // http://www.midi.org/about-midi/tuning-scale.shtml
<span class="nc" id="L319">                            SoftTuning tuning = new SoftTuning(data);</span>
<span class="nc" id="L320">                            int channelmask = (data[5] &amp; 0xFF) * 16384</span>
                                    + (data[6] &amp; 0xFF) * 128 + (data[7] &amp; 0xFF);
<span class="nc" id="L322">                            SoftChannel[] channels = synth.channels;</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                            for (int i = 0; i &lt; channels.length; i++)</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                                if ((channelmask &amp; (1 &lt;&lt; i)) != 0)</span>
<span class="nc" id="L325">                                    channels[i].tuning = tuning;</span>
<span class="nc" id="L326">                            SoftVoice[] voices = synth.getVoices();</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                            for (int i = 0; i &lt; voices.length; i++)</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                                if (voices[i].active)</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                                    if ((channelmask &amp; (1 &lt;&lt; (voices[i].channel))) != 0)</span>
<span class="nc" id="L330">                                        voices[i].updateTuning(tuning);</span>
<span class="nc" id="L331">                            break;</span>
                        }
                        default:
<span class="nc" id="L334">                            break;</span>
                        }
                        break;
                    case 0x09:  // Control Destination Settings
<span class="nc" id="L338">                        subid2 = data[4] &amp; 0xFF;</span>
<span class="nc bnc" id="L339" title="All 4 branches missed.">                        switch (subid2) {</span>
                        case 0x01: // Channel Pressure
                        {
<span class="nc" id="L342">                            int[] destinations = new int[(data.length - 7) / 2];</span>
<span class="nc" id="L343">                            int[] ranges = new int[(data.length - 7) / 2];</span>
<span class="nc" id="L344">                            int ix = 0;</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                            for (int j = 6; j &lt; data.length - 1; j += 2) {</span>
<span class="nc" id="L346">                                destinations[ix] = data[j] &amp; 0xFF;</span>
<span class="nc" id="L347">                                ranges[ix] = data[j + 1] &amp; 0xFF;</span>
<span class="nc" id="L348">                                ix++;</span>
                            }
<span class="nc" id="L350">                            int channel = data[5] &amp; 0xFF;</span>
<span class="nc" id="L351">                            SoftChannel softchannel = synth.channels[channel];</span>
<span class="nc" id="L352">                            softchannel.mapChannelPressureToDestination(</span>
                                    destinations, ranges);
<span class="nc" id="L354">                            break;</span>
                        }
                        case 0x02: // Poly Pressure
                        {
<span class="nc" id="L358">                            int[] destinations = new int[(data.length - 7) / 2];</span>
<span class="nc" id="L359">                            int[] ranges = new int[(data.length - 7) / 2];</span>
<span class="nc" id="L360">                            int ix = 0;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                            for (int j = 6; j &lt; data.length - 1; j += 2) {</span>
<span class="nc" id="L362">                                destinations[ix] = data[j] &amp; 0xFF;</span>
<span class="nc" id="L363">                                ranges[ix] = data[j + 1] &amp; 0xFF;</span>
<span class="nc" id="L364">                                ix++;</span>
                            }
<span class="nc" id="L366">                            int channel = data[5] &amp; 0xFF;</span>
<span class="nc" id="L367">                            SoftChannel softchannel = synth.channels[channel];</span>
<span class="nc" id="L368">                            softchannel.mapPolyPressureToDestination(</span>
                                    destinations, ranges);
<span class="nc" id="L370">                            break;</span>
                        }
                        case 0x03: // Control Change
                        {
<span class="nc" id="L374">                            int[] destinations = new int[(data.length - 7) / 2];</span>
<span class="nc" id="L375">                            int[] ranges = new int[(data.length - 7) / 2];</span>
<span class="nc" id="L376">                            int ix = 0;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                            for (int j = 7; j &lt; data.length - 1; j += 2) {</span>
<span class="nc" id="L378">                                destinations[ix] = data[j] &amp; 0xFF;</span>
<span class="nc" id="L379">                                ranges[ix] = data[j + 1] &amp; 0xFF;</span>
<span class="nc" id="L380">                                ix++;</span>
                            }
<span class="nc" id="L382">                            int channel = data[5] &amp; 0xFF;</span>
<span class="nc" id="L383">                            SoftChannel softchannel = synth.channels[channel];</span>
<span class="nc" id="L384">                            int control = data[6] &amp; 0xFF;</span>
<span class="nc" id="L385">                            softchannel.mapControlToDestination(control,</span>
                                    destinations, ranges);
<span class="nc" id="L387">                            break;</span>
                        }
                        default:
<span class="nc" id="L390">                            break;</span>
                        }
                        break;

                    case 0x0A:  // Key Based Instrument Control
                    {
<span class="nc" id="L396">                        subid2 = data[4] &amp; 0xFF;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">                        switch (subid2) {</span>
                        case 0x01: // Basic Message
<span class="nc" id="L399">                            int channel = data[5] &amp; 0xFF;</span>
<span class="nc" id="L400">                            int keynumber = data[6] &amp; 0xFF;</span>
<span class="nc" id="L401">                            SoftChannel softchannel = synth.channels[channel];</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">                            for (int j = 7; j &lt; data.length - 1; j += 2) {</span>
<span class="nc" id="L403">                                int controlnumber = data[j] &amp; 0xFF;</span>
<span class="nc" id="L404">                                int controlvalue = data[j + 1] &amp; 0xFF;</span>
<span class="nc" id="L405">                                softchannel.controlChangePerNote(keynumber,</span>
                                        controlnumber, controlvalue);
                            }
<span class="nc" id="L408">                            break;</span>
                        default:
                            break;
                        }
<span class="nc" id="L412">                        break;</span>
                    }
                    default:
                        break;
                    }
                }
            }

<span class="nc" id="L420">        }</span>
<span class="nc" id="L421">    }</span>

    private void processMessages(long timeStamp) {
<span class="nc" id="L424">        Iterator&lt;Entry&lt;Long, Object&gt;&gt; iter = midimessages.entrySet().iterator();</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">        while (iter.hasNext()) {</span>
<span class="nc" id="L426">            Entry&lt;Long, Object&gt; entry = iter.next();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">            if (entry.getKey() &gt;= (timeStamp + msec_buffer_len))</span>
<span class="nc" id="L428">                return;</span>
<span class="nc" id="L429">            long msec_delay = entry.getKey() - timeStamp;</span>
<span class="nc" id="L430">            delay_midievent = (int)(msec_delay * (samplerate / 1000000.0) + 0.5);</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">            if(delay_midievent &gt; max_delay_midievent)</span>
<span class="nc" id="L432">                delay_midievent = max_delay_midievent;</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">            if(delay_midievent &lt; 0)</span>
<span class="nc" id="L434">                delay_midievent = 0;</span>
<span class="nc" id="L435">            processMessage(entry.getValue());</span>
<span class="nc" id="L436">            iter.remove();</span>
<span class="nc" id="L437">        }</span>
<span class="nc" id="L438">        delay_midievent = 0;</span>
<span class="nc" id="L439">    }</span>

    void processAudioBuffers() {

<span class="nc bnc" id="L443" title="All 4 branches missed.">        if(synth.weakstream != null &amp;&amp; synth.weakstream.silent_samples != 0)</span>
        {
<span class="nc" id="L445">            sample_pos += synth.weakstream.silent_samples;</span>
<span class="nc" id="L446">            synth.weakstream.silent_samples = 0;</span>
        }

<span class="nc bnc" id="L449" title="All 2 branches missed.">        for (int i = 0; i &lt; buffers.length; i++) {</span>
<span class="nc bnc" id="L450" title="All 10 branches missed.">            if(i != CHANNEL_DELAY_LEFT &amp;&amp;</span>
                    i != CHANNEL_DELAY_RIGHT &amp;&amp;
                    i != CHANNEL_DELAY_MONO &amp;&amp;
                    i != CHANNEL_DELAY_EFFECT1 &amp;&amp;
                    i != CHANNEL_DELAY_EFFECT2)
<span class="nc" id="L455">                buffers[i].clear();</span>
        }

<span class="nc bnc" id="L458" title="All 2 branches missed.">        if(!buffers[CHANNEL_DELAY_LEFT].isSilent())</span>
        {
<span class="nc" id="L460">            buffers[CHANNEL_LEFT].swap(buffers[CHANNEL_DELAY_LEFT]);</span>
        }
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if(!buffers[CHANNEL_DELAY_RIGHT].isSilent())</span>
        {
<span class="nc" id="L464">            buffers[CHANNEL_RIGHT].swap(buffers[CHANNEL_DELAY_RIGHT]);</span>
        }
<span class="nc bnc" id="L466" title="All 2 branches missed.">        if(!buffers[CHANNEL_DELAY_MONO].isSilent())</span>
        {
<span class="nc" id="L468">            buffers[CHANNEL_MONO].swap(buffers[CHANNEL_DELAY_MONO]);</span>
        }
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if(!buffers[CHANNEL_DELAY_EFFECT1].isSilent())</span>
        {
<span class="nc" id="L472">            buffers[CHANNEL_EFFECT1].swap(buffers[CHANNEL_DELAY_EFFECT1]);</span>
        }
<span class="nc bnc" id="L474" title="All 2 branches missed.">        if(!buffers[CHANNEL_DELAY_EFFECT2].isSilent())</span>
        {
<span class="nc" id="L476">            buffers[CHANNEL_EFFECT2].swap(buffers[CHANNEL_DELAY_EFFECT2]);</span>
        }

        double volume_left;
        double volume_right;

        SoftChannelMixerContainer[] act_registeredMixers;

        // perform control logic
<span class="nc" id="L485">        synchronized (control_mutex) {</span>

<span class="nc" id="L487">            long msec_pos = (long)(sample_pos * (1000000.0 / samplerate));</span>

<span class="nc" id="L489">            processMessages(msec_pos);</span>

<span class="nc bnc" id="L491" title="All 2 branches missed.">            if (active_sensing_on) {</span>
                // Active Sensing
                // if no message occurs for max 1000 ms
                // then do AllSoundOff on all channels
<span class="nc bnc" id="L495" title="All 2 branches missed.">                if ((msec_pos - msec_last_activity) &gt; 1000000) {</span>
<span class="nc" id="L496">                    active_sensing_on = false;</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                    for (SoftChannel c : synth.channels)</span>
<span class="nc" id="L498">                        c.allSoundOff();</span>
                }

            }

<span class="nc bnc" id="L503" title="All 2 branches missed.">            for (int i = 0; i &lt; voicestatus.length; i++)</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">                if (voicestatus[i].active)</span>
<span class="nc" id="L505">                    voicestatus[i].processControlLogic();</span>
<span class="nc" id="L506">            sample_pos += buffer_len;</span>

<span class="nc" id="L508">            double volume = co_master_volume[0];</span>
<span class="nc" id="L509">            volume_left = volume;</span>
<span class="nc" id="L510">            volume_right = volume;</span>

<span class="nc" id="L512">            double balance = co_master_balance[0];</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">            if (balance &gt; 0.5)</span>
<span class="nc" id="L514">                volume_left *= (1 - balance) * 2;</span>
            else
<span class="nc" id="L516">                volume_right *= balance * 2;</span>

<span class="nc" id="L518">            chorus.processControlLogic();</span>
<span class="nc" id="L519">            reverb.processControlLogic();</span>
<span class="nc" id="L520">            agc.processControlLogic();</span>

<span class="nc bnc" id="L522" title="All 2 branches missed.">            if (cur_registeredMixers == null) {</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">                if (registeredMixers != null) {</span>
<span class="nc" id="L524">                    cur_registeredMixers =</span>
<span class="nc" id="L525">                            new SoftChannelMixerContainer[registeredMixers.size()];</span>
<span class="nc" id="L526">                    registeredMixers.toArray(cur_registeredMixers);</span>
                }
            }

<span class="nc" id="L530">            act_registeredMixers = cur_registeredMixers;</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">            if (act_registeredMixers != null)</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">                if (act_registeredMixers.length == 0)</span>
<span class="nc" id="L533">                    act_registeredMixers = null;</span>

<span class="nc" id="L535">        }</span>

<span class="nc bnc" id="L537" title="All 2 branches missed.">        if (act_registeredMixers != null) {</span>

            // Make backup of left,right,mono channels
<span class="nc" id="L540">            SoftAudioBuffer leftbak = buffers[CHANNEL_LEFT];</span>
<span class="nc" id="L541">            SoftAudioBuffer rightbak = buffers[CHANNEL_RIGHT];</span>
<span class="nc" id="L542">            SoftAudioBuffer monobak = buffers[CHANNEL_MONO];</span>
<span class="nc" id="L543">            SoftAudioBuffer delayleftbak = buffers[CHANNEL_DELAY_LEFT];</span>
<span class="nc" id="L544">            SoftAudioBuffer delayrightbak = buffers[CHANNEL_DELAY_RIGHT];</span>
<span class="nc" id="L545">            SoftAudioBuffer delaymonobak = buffers[CHANNEL_DELAY_MONO];</span>

<span class="nc" id="L547">            int bufferlen = buffers[CHANNEL_LEFT].getSize();</span>

<span class="nc" id="L549">            float[][] cbuffer = new float[nrofchannels][];</span>
<span class="nc" id="L550">            float[][] obuffer = new float[nrofchannels][];</span>
<span class="nc" id="L551">            obuffer[0] = leftbak.array();</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">            if (nrofchannels != 1)</span>
<span class="nc" id="L553">                obuffer[1] = rightbak.array();</span>

<span class="nc bnc" id="L555" title="All 2 branches missed.">            for (SoftChannelMixerContainer cmixer : act_registeredMixers) {</span>

                // Reroute default left,right output
                // to channelmixer left,right input/output
<span class="nc" id="L559">                buffers[CHANNEL_LEFT] =  cmixer.buffers[CHANNEL_LEFT];</span>
<span class="nc" id="L560">                buffers[CHANNEL_RIGHT] = cmixer.buffers[CHANNEL_RIGHT];</span>
<span class="nc" id="L561">                buffers[CHANNEL_MONO] = cmixer.buffers[CHANNEL_MONO];</span>
<span class="nc" id="L562">                buffers[CHANNEL_DELAY_LEFT] = cmixer.buffers[CHANNEL_DELAY_LEFT];</span>
<span class="nc" id="L563">                buffers[CHANNEL_DELAY_RIGHT] = cmixer.buffers[CHANNEL_DELAY_RIGHT];</span>
<span class="nc" id="L564">                buffers[CHANNEL_DELAY_MONO] = cmixer.buffers[CHANNEL_DELAY_MONO];</span>

<span class="nc" id="L566">                buffers[CHANNEL_LEFT].clear();</span>
<span class="nc" id="L567">                buffers[CHANNEL_RIGHT].clear();</span>
<span class="nc" id="L568">                buffers[CHANNEL_MONO].clear();</span>

<span class="nc bnc" id="L570" title="All 2 branches missed.">                if(!buffers[CHANNEL_DELAY_LEFT].isSilent())</span>
                {
<span class="nc" id="L572">                    buffers[CHANNEL_LEFT].swap(buffers[CHANNEL_DELAY_LEFT]);</span>
                }
<span class="nc bnc" id="L574" title="All 2 branches missed.">                if(!buffers[CHANNEL_DELAY_RIGHT].isSilent())</span>
                {
<span class="nc" id="L576">                    buffers[CHANNEL_RIGHT].swap(buffers[CHANNEL_DELAY_RIGHT]);</span>
                }
<span class="nc bnc" id="L578" title="All 2 branches missed.">                if(!buffers[CHANNEL_DELAY_MONO].isSilent())</span>
                {
<span class="nc" id="L580">                    buffers[CHANNEL_MONO].swap(buffers[CHANNEL_DELAY_MONO]);</span>
                }

<span class="nc" id="L583">                cbuffer[0] = buffers[CHANNEL_LEFT].array();</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">                if (nrofchannels != 1)</span>
<span class="nc" id="L585">                    cbuffer[1] = buffers[CHANNEL_RIGHT].array();</span>

<span class="nc" id="L587">                boolean hasactivevoices = false;</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">                for (int i = 0; i &lt; voicestatus.length; i++)</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">                    if (voicestatus[i].active)</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">                        if (voicestatus[i].channelmixer == cmixer.mixer) {</span>
<span class="nc" id="L591">                            voicestatus[i].processAudioLogic(buffers);</span>
<span class="nc" id="L592">                            hasactivevoices = true;</span>
                        }

<span class="nc bnc" id="L595" title="All 2 branches missed.">                if(!buffers[CHANNEL_MONO].isSilent())</span>
                {
<span class="nc" id="L597">                    float[] mono = buffers[CHANNEL_MONO].array();</span>
<span class="nc" id="L598">                    float[] left = buffers[CHANNEL_LEFT].array();</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                    if (nrofchannels != 1) {</span>
<span class="nc" id="L600">                        float[] right = buffers[CHANNEL_RIGHT].array();</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">                        for (int i = 0; i &lt; bufferlen; i++) {</span>
<span class="nc" id="L602">                            float v = mono[i];</span>
<span class="nc" id="L603">                            left[i] += v;</span>
<span class="nc" id="L604">                            right[i] += v;</span>
                        }
<span class="nc" id="L606">                    }</span>
                    else
                    {
<span class="nc bnc" id="L609" title="All 2 branches missed.">                        for (int i = 0; i &lt; bufferlen; i++) {</span>
<span class="nc" id="L610">                            left[i] += mono[i];</span>
                        }
                    }
                }

<span class="nc bnc" id="L615" title="All 2 branches missed.">                if (!cmixer.mixer.process(cbuffer, 0, bufferlen)) {</span>
<span class="nc" id="L616">                    synchronized (control_mutex) {</span>
<span class="nc" id="L617">                        registeredMixers.remove(cmixer);</span>
<span class="nc" id="L618">                        cur_registeredMixers = null;</span>
<span class="nc" id="L619">                    }</span>
                }

<span class="nc bnc" id="L622" title="All 2 branches missed.">                for (int i = 0; i &lt; cbuffer.length; i++) {</span>
<span class="nc" id="L623">                    float[] cbuff = cbuffer[i];</span>
<span class="nc" id="L624">                    float[] obuff = obuffer[i];</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                    for (int j = 0; j &lt; bufferlen; j++)</span>
<span class="nc" id="L626">                        obuff[j] += cbuff[j];</span>
                }

<span class="nc bnc" id="L629" title="All 2 branches missed.">                if (!hasactivevoices) {</span>
<span class="nc" id="L630">                    synchronized (control_mutex) {</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">                        if (stoppedMixers != null) {</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                            if (stoppedMixers.contains(cmixer)) {</span>
<span class="nc" id="L633">                                stoppedMixers.remove(cmixer);</span>
<span class="nc" id="L634">                                cmixer.mixer.stop();</span>
                            }
                        }
<span class="nc" id="L637">                    }</span>
                }

            }

<span class="nc" id="L642">            buffers[CHANNEL_LEFT] = leftbak;</span>
<span class="nc" id="L643">            buffers[CHANNEL_RIGHT] = rightbak;</span>
<span class="nc" id="L644">            buffers[CHANNEL_MONO] = monobak;</span>
<span class="nc" id="L645">            buffers[CHANNEL_DELAY_LEFT] = delayleftbak;</span>
<span class="nc" id="L646">            buffers[CHANNEL_DELAY_RIGHT] = delayrightbak;</span>
<span class="nc" id="L647">            buffers[CHANNEL_DELAY_MONO] = delaymonobak;</span>

        }

<span class="nc bnc" id="L651" title="All 2 branches missed.">        for (int i = 0; i &lt; voicestatus.length; i++)</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">            if (voicestatus[i].active)</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">                if (voicestatus[i].channelmixer == null)</span>
<span class="nc" id="L654">                    voicestatus[i].processAudioLogic(buffers);</span>

<span class="nc bnc" id="L656" title="All 2 branches missed.">        if(!buffers[CHANNEL_MONO].isSilent())</span>
        {
<span class="nc" id="L658">            float[] mono = buffers[CHANNEL_MONO].array();</span>
<span class="nc" id="L659">            float[] left = buffers[CHANNEL_LEFT].array();</span>
<span class="nc" id="L660">            int bufferlen = buffers[CHANNEL_LEFT].getSize();</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">            if (nrofchannels != 1) {</span>
<span class="nc" id="L662">                float[] right = buffers[CHANNEL_RIGHT].array();</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">                for (int i = 0; i &lt; bufferlen; i++) {</span>
<span class="nc" id="L664">                    float v = mono[i];</span>
<span class="nc" id="L665">                    left[i] += v;</span>
<span class="nc" id="L666">                    right[i] += v;</span>
                }
<span class="nc" id="L668">            }</span>
            else
            {
<span class="nc bnc" id="L671" title="All 2 branches missed.">                for (int i = 0; i &lt; bufferlen; i++) {</span>
<span class="nc" id="L672">                    left[i] += mono[i];</span>
                }
            }
        }

        // Run effects
<span class="nc bnc" id="L678" title="All 2 branches missed.">        if (synth.chorus_on)</span>
<span class="nc" id="L679">            chorus.processAudio();</span>

<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (synth.reverb_on)</span>
<span class="nc" id="L682">            reverb.processAudio();</span>

<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (nrofchannels == 1)</span>
<span class="nc" id="L685">            volume_left = (volume_left + volume_right) / 2;</span>

        // Set Volume / Balance
<span class="nc bnc" id="L688" title="All 4 branches missed.">        if (last_volume_left != volume_left || last_volume_right != volume_right) {</span>
<span class="nc" id="L689">            float[] left = buffers[CHANNEL_LEFT].array();</span>
<span class="nc" id="L690">            float[] right = buffers[CHANNEL_RIGHT].array();</span>
<span class="nc" id="L691">            int bufferlen = buffers[CHANNEL_LEFT].getSize();</span>

            float amp;
            float amp_delta;
<span class="nc" id="L695">            amp = (float)(last_volume_left * last_volume_left);</span>
<span class="nc" id="L696">            amp_delta = (float)((volume_left * volume_left - amp) / bufferlen);</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">            for (int i = 0; i &lt; bufferlen; i++) {</span>
<span class="nc" id="L698">                amp += amp_delta;</span>
<span class="nc" id="L699">                left[i] *= amp;</span>
            }
<span class="nc bnc" id="L701" title="All 2 branches missed.">            if (nrofchannels != 1) {</span>
<span class="nc" id="L702">                amp = (float)(last_volume_right * last_volume_right);</span>
<span class="nc" id="L703">                amp_delta = (float)((volume_right*volume_right - amp) / bufferlen);</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">                for (int i = 0; i &lt; bufferlen; i++) {</span>
<span class="nc" id="L705">                    amp += amp_delta;</span>
<span class="nc" id="L706">                    right[i] *= volume_right;</span>
                }
            }
<span class="nc" id="L709">            last_volume_left = volume_left;</span>
<span class="nc" id="L710">            last_volume_right = volume_right;</span>

<span class="nc" id="L712">        } else {</span>
<span class="nc bnc" id="L713" title="All 4 branches missed.">            if (volume_left != 1.0 || volume_right != 1.0) {</span>
<span class="nc" id="L714">                float[] left = buffers[CHANNEL_LEFT].array();</span>
<span class="nc" id="L715">                float[] right = buffers[CHANNEL_RIGHT].array();</span>
<span class="nc" id="L716">                int bufferlen = buffers[CHANNEL_LEFT].getSize();</span>
                float amp;
<span class="nc" id="L718">                amp = (float) (volume_left * volume_left);</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">                for (int i = 0; i &lt; bufferlen; i++)</span>
<span class="nc" id="L720">                    left[i] *= amp;</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">                if (nrofchannels != 1) {</span>
<span class="nc" id="L722">                    amp = (float)(volume_right * volume_right);</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">                    for (int i = 0; i &lt; bufferlen; i++)</span>
<span class="nc" id="L724">                        right[i] *= amp;</span>
                }

            }
        }

<span class="nc bnc" id="L730" title="All 2 branches missed.">        if(buffers[CHANNEL_LEFT].isSilent()</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">            &amp;&amp; buffers[CHANNEL_RIGHT].isSilent())</span>
        {

            int midimessages_size;
<span class="nc" id="L735">            synchronized (control_mutex) {</span>
<span class="nc" id="L736">                midimessages_size = midimessages.size();</span>
<span class="nc" id="L737">            }</span>

<span class="nc bnc" id="L739" title="All 2 branches missed.">            if(midimessages_size == 0)</span>
            {
<span class="nc" id="L741">                pusher_silent_count++;</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">                if(pusher_silent_count &gt; 5)</span>
                {
<span class="nc" id="L744">                    pusher_silent_count = 0;</span>
<span class="nc" id="L745">                    synchronized (control_mutex) {</span>
<span class="nc" id="L746">                        pusher_silent = true;</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">                        if(synth.weakstream != null)</span>
<span class="nc" id="L748">                            synth.weakstream.setInputStream(null);</span>
<span class="nc" id="L749">                    }</span>
                }
            }
<span class="nc" id="L752">        }</span>
        else
<span class="nc" id="L754">            pusher_silent_count = 0;</span>

<span class="nc bnc" id="L756" title="All 2 branches missed.">        if (synth.agc_on)</span>
<span class="nc" id="L757">            agc.processAudio();</span>

<span class="nc" id="L759">    }</span>

    // Must only we called within control_mutex synchronization
    public void activity()
    {
<span class="nc" id="L764">        long silent_samples = 0;</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">        if(pusher_silent)</span>
        {
<span class="nc" id="L767">            pusher_silent = false;</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">            if(synth.weakstream != null)</span>
            {
<span class="nc" id="L770">                synth.weakstream.setInputStream(ais);</span>
<span class="nc" id="L771">                silent_samples = synth.weakstream.silent_samples;</span>
            }
        }
<span class="nc" id="L774">        msec_last_activity = (long)((sample_pos + silent_samples)</span>
                * (1000000.0 / samplerate));
<span class="nc" id="L776">    }</span>

    public void stopMixer(ModelChannelMixer mixer) {
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (stoppedMixers == null)</span>
<span class="nc" id="L780">            stoppedMixers = new HashSet&lt;ModelChannelMixer&gt;();</span>
<span class="nc" id="L781">        stoppedMixers.add(mixer);</span>
<span class="nc" id="L782">    }</span>

    public void registerMixer(ModelChannelMixer mixer) {
<span class="nc bnc" id="L785" title="All 2 branches missed.">        if (registeredMixers == null)</span>
<span class="nc" id="L786">            registeredMixers = new HashSet&lt;SoftChannelMixerContainer&gt;();</span>
<span class="nc" id="L787">        SoftChannelMixerContainer mixercontainer = new SoftChannelMixerContainer();</span>
<span class="nc" id="L788">        mixercontainer.buffers = new SoftAudioBuffer[6];</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">        for (int i = 0; i &lt; mixercontainer.buffers.length; i++) {</span>
<span class="nc" id="L790">            mixercontainer.buffers[i] =</span>
<span class="nc" id="L791">                new SoftAudioBuffer(buffer_len, synth.getFormat());</span>
        }
<span class="nc" id="L793">        mixercontainer.mixer = mixer;</span>
<span class="nc" id="L794">        registeredMixers.add(mixercontainer);</span>
<span class="nc" id="L795">        cur_registeredMixers = null;</span>
<span class="nc" id="L796">    }</span>

<span class="nc" id="L798">    public SoftMainMixer(SoftSynthesizer synth) {</span>
<span class="nc" id="L799">        this.synth = synth;</span>

<span class="nc" id="L801">        sample_pos = 0;</span>

<span class="nc" id="L803">        co_master_balance[0] = 0.5;</span>
<span class="nc" id="L804">        co_master_volume[0] = 1;</span>
<span class="nc" id="L805">        co_master_coarse_tuning[0] = 0.5;</span>
<span class="nc" id="L806">        co_master_fine_tuning[0] = 0.5;</span>

<span class="nc" id="L808">        msec_buffer_len = (long) (1000000.0 / synth.getControlRate());</span>
<span class="nc" id="L809">        samplerate = synth.getFormat().getSampleRate();</span>
<span class="nc" id="L810">        nrofchannels = synth.getFormat().getChannels();</span>

<span class="nc" id="L812">        int buffersize = (int) (synth.getFormat().getSampleRate()</span>
<span class="nc" id="L813">                                / synth.getControlRate());</span>

<span class="nc" id="L815">        buffer_len = buffersize;</span>

<span class="nc" id="L817">        max_delay_midievent = buffersize;</span>

<span class="nc" id="L819">        control_mutex = synth.control_mutex;</span>
<span class="nc" id="L820">        buffers = new SoftAudioBuffer[14];</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">        for (int i = 0; i &lt; buffers.length; i++) {</span>
<span class="nc" id="L822">            buffers[i] = new SoftAudioBuffer(buffersize, synth.getFormat());</span>
        }
<span class="nc" id="L824">        voicestatus = synth.getVoices();</span>

<span class="nc" id="L826">        reverb = new SoftReverb();</span>
<span class="nc" id="L827">        chorus = new SoftChorus();</span>
<span class="nc" id="L828">        agc = new SoftLimiter();</span>

<span class="nc" id="L830">        float samplerate = synth.getFormat().getSampleRate();</span>
<span class="nc" id="L831">        float controlrate = synth.getControlRate();</span>
<span class="nc" id="L832">        reverb.init(samplerate, controlrate);</span>
<span class="nc" id="L833">        chorus.init(samplerate, controlrate);</span>
<span class="nc" id="L834">        agc.init(samplerate, controlrate);</span>

<span class="nc" id="L836">        reverb.setLightMode(synth.reverb_light);</span>

<span class="nc" id="L838">        reverb.setMixMode(true);</span>
<span class="nc" id="L839">        chorus.setMixMode(true);</span>
<span class="nc" id="L840">        agc.setMixMode(false);</span>

<span class="nc" id="L842">        chorus.setInput(0, buffers[CHANNEL_EFFECT2]);</span>
<span class="nc" id="L843">        chorus.setOutput(0, buffers[CHANNEL_LEFT]);</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">        if (nrofchannels != 1)</span>
<span class="nc" id="L845">            chorus.setOutput(1, buffers[CHANNEL_RIGHT]);</span>
<span class="nc" id="L846">        chorus.setOutput(2, buffers[CHANNEL_EFFECT1]);</span>

<span class="nc" id="L848">        reverb.setInput(0, buffers[CHANNEL_EFFECT1]);</span>
<span class="nc" id="L849">        reverb.setOutput(0, buffers[CHANNEL_LEFT]);</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">        if (nrofchannels != 1)</span>
<span class="nc" id="L851">            reverb.setOutput(1, buffers[CHANNEL_RIGHT]);</span>

<span class="nc" id="L853">        agc.setInput(0, buffers[CHANNEL_LEFT]);</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">        if (nrofchannels != 1)</span>
<span class="nc" id="L855">            agc.setInput(1, buffers[CHANNEL_RIGHT]);</span>
<span class="nc" id="L856">        agc.setOutput(0, buffers[CHANNEL_LEFT]);</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">        if (nrofchannels != 1)</span>
<span class="nc" id="L858">            agc.setOutput(1, buffers[CHANNEL_RIGHT]);</span>

<span class="nc" id="L860">        InputStream in = new InputStream() {</span>

<span class="nc" id="L862">            private final SoftAudioBuffer[] buffers = SoftMainMixer.this.buffers;</span>
<span class="nc" id="L863">            private final int nrofchannels</span>
<span class="nc" id="L864">                    = SoftMainMixer.this.synth.getFormat().getChannels();</span>
<span class="nc" id="L865">            private final int buffersize = buffers[0].getSize();</span>
<span class="nc" id="L866">            private final byte[] bbuffer = new byte[buffersize</span>
<span class="nc" id="L867">                    * (SoftMainMixer.this.synth.getFormat()</span>
<span class="nc" id="L868">                        .getSampleSizeInBits() / 8)</span>
                    * nrofchannels];
<span class="nc" id="L870">            private int bbuffer_pos = 0;</span>
<span class="nc" id="L871">            private final byte[] single = new byte[1];</span>

            public void fillBuffer() {
                /*
                boolean pusher_silent2;
                synchronized (control_mutex) {
                    pusher_silent2 = pusher_silent;
                }
                if(!pusher_silent2)*/
<span class="nc" id="L880">                processAudioBuffers();</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">                for (int i = 0; i &lt; nrofchannels; i++)</span>
<span class="nc" id="L882">                    buffers[i].get(bbuffer, i);</span>
<span class="nc" id="L883">                bbuffer_pos = 0;</span>
<span class="nc" id="L884">            }</span>

            public int read(byte[] b, int off, int len) {
<span class="nc" id="L887">                int bbuffer_len = bbuffer.length;</span>
<span class="nc" id="L888">                int offlen = off + len;</span>
<span class="nc" id="L889">                int orgoff = off;</span>
<span class="nc" id="L890">                byte[] bbuffer = this.bbuffer;</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">                while (off &lt; offlen) {</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">                    if (available() == 0)</span>
<span class="nc" id="L893">                        fillBuffer();</span>
                    else {
<span class="nc" id="L895">                        int bbuffer_pos = this.bbuffer_pos;</span>
<span class="nc bnc" id="L896" title="All 4 branches missed.">                        while (off &lt; offlen &amp;&amp; bbuffer_pos &lt; bbuffer_len)</span>
<span class="nc" id="L897">                            b[off++] = bbuffer[bbuffer_pos++];</span>
<span class="nc" id="L898">                        this.bbuffer_pos = bbuffer_pos;</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">                        if (!readfully)</span>
<span class="nc" id="L900">                            return off - orgoff;</span>
<span class="nc" id="L901">                    }</span>
                }
<span class="nc" id="L903">                return len;</span>
            }

            public int read() throws IOException {
<span class="nc" id="L907">                int ret = read(single);</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">                if (ret == -1)</span>
<span class="nc" id="L909">                    return -1;</span>
<span class="nc" id="L910">                return single[0] &amp; 0xFF;</span>
            }

            public int available() {
<span class="nc" id="L914">                return bbuffer.length - bbuffer_pos;</span>
            }

            public void close() {
<span class="nc" id="L918">                SoftMainMixer.this.synth.close();</span>
<span class="nc" id="L919">            }</span>
        };

<span class="nc" id="L922">        ais = new AudioInputStream(in, synth.getFormat(), AudioSystem.NOT_SPECIFIED);</span>

<span class="nc" id="L924">    }</span>

    public AudioInputStream getInputStream() {
<span class="nc" id="L927">        return ais;</span>
    }

    public void reset() {

<span class="nc" id="L932">        SoftChannel[] channels = synth.channels;</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">        for (int i = 0; i &lt; channels.length; i++) {</span>
<span class="nc" id="L934">            channels[i].allSoundOff();</span>
<span class="nc" id="L935">            channels[i].resetAllControllers(true);</span>

<span class="nc bnc" id="L937" title="All 2 branches missed.">            if (synth.getGeneralMidiMode() == 2) {</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">                if (i == 9)</span>
<span class="nc" id="L939">                    channels[i].programChange(0, 0x78 * 128);</span>
                else
<span class="nc" id="L941">                    channels[i].programChange(0, 0x79 * 128);</span>
            } else
<span class="nc" id="L943">                channels[i].programChange(0, 0);</span>
        }
<span class="nc" id="L945">        setVolume(0x7F * 128 + 0x7F);</span>
<span class="nc" id="L946">        setBalance(0x40 * 128 + 0x00);</span>
<span class="nc" id="L947">        setCoarseTuning(0x40 * 128 + 0x00);</span>
<span class="nc" id="L948">        setFineTuning(0x40 * 128 + 0x00);</span>
        // Reset Reverb
<span class="nc" id="L950">        globalParameterControlChange(</span>
                new int[]{0x01 * 128 + 0x01}, new long[]{0}, new long[]{4});
        // Reset Chorus
<span class="nc" id="L953">        globalParameterControlChange(</span>
                new int[]{0x01 * 128 + 0x02}, new long[]{0}, new long[]{2});
<span class="nc" id="L955">    }</span>

    public void setVolume(int value) {
<span class="nc" id="L958">        synchronized (control_mutex) {</span>
<span class="nc" id="L959">            co_master_volume[0] = value / 16384.0;</span>
<span class="nc" id="L960">        }</span>
<span class="nc" id="L961">    }</span>

    public void setBalance(int value) {
<span class="nc" id="L964">        synchronized (control_mutex) {</span>
<span class="nc" id="L965">            co_master_balance[0] = value / 16384.0;</span>
<span class="nc" id="L966">        }</span>
<span class="nc" id="L967">    }</span>

    public void setFineTuning(int value) {
<span class="nc" id="L970">        synchronized (control_mutex) {</span>
<span class="nc" id="L971">            co_master_fine_tuning[0] = value / 16384.0;</span>
<span class="nc" id="L972">        }</span>
<span class="nc" id="L973">    }</span>

    public void setCoarseTuning(int value) {
<span class="nc" id="L976">        synchronized (control_mutex) {</span>
<span class="nc" id="L977">            co_master_coarse_tuning[0] = value / 16384.0;</span>
<span class="nc" id="L978">        }</span>
<span class="nc" id="L979">    }</span>

    public int getVolume() {
<span class="nc" id="L982">        synchronized (control_mutex) {</span>
<span class="nc" id="L983">            return (int) (co_master_volume[0] * 16384.0);</span>
<span class="nc" id="L984">        }</span>
    }

    public int getBalance() {
<span class="nc" id="L988">        synchronized (control_mutex) {</span>
<span class="nc" id="L989">            return (int) (co_master_balance[0] * 16384.0);</span>
<span class="nc" id="L990">        }</span>
    }

    public int getFineTuning() {
<span class="nc" id="L994">        synchronized (control_mutex) {</span>
<span class="nc" id="L995">            return (int) (co_master_fine_tuning[0] * 16384.0);</span>
<span class="nc" id="L996">        }</span>
    }

    public int getCoarseTuning() {
<span class="nc" id="L1000">        synchronized (control_mutex) {</span>
<span class="nc" id="L1001">            return (int) (co_master_coarse_tuning[0] * 16384.0);</span>
<span class="nc" id="L1002">        }</span>
    }

    public void globalParameterControlChange(int[] slothpath, long[] params,
            long[] paramsvalue) {
<span class="nc bnc" id="L1007" title="All 2 branches missed.">        if (slothpath.length == 0)</span>
<span class="nc" id="L1008">            return;</span>

<span class="nc" id="L1010">        synchronized (control_mutex) {</span>

            // slothpath: 01xx are reserved only for GM2

<span class="nc bnc" id="L1014" title="All 2 branches missed.">            if (slothpath[0] == 0x01 * 128 + 0x01) {</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">                for (int i = 0; i &lt; paramsvalue.length; i++) {</span>
<span class="nc" id="L1016">                    reverb.globalParameterControlChange(slothpath, params[i],</span>
                            paramsvalue[i]);
                }
            }
<span class="nc bnc" id="L1020" title="All 2 branches missed.">            if (slothpath[0] == 0x01 * 128 + 0x02) {</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">                for (int i = 0; i &lt; paramsvalue.length; i++) {</span>
<span class="nc" id="L1022">                    chorus.globalParameterControlChange(slothpath, params[i],</span>
                            paramsvalue[i]);
                }

            }

<span class="nc" id="L1028">        }</span>
<span class="nc" id="L1029">    }</span>

    public void processMessage(Object object) {
<span class="nc bnc" id="L1032" title="All 2 branches missed.">        if (object instanceof byte[])</span>
<span class="nc" id="L1033">            processMessage((byte[]) object);</span>
<span class="nc bnc" id="L1034" title="All 2 branches missed.">        if (object instanceof MidiMessage)</span>
<span class="nc" id="L1035">            processMessage((MidiMessage)object);</span>
<span class="nc" id="L1036">    }</span>

    public void processMessage(MidiMessage message) {
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        if (message instanceof ShortMessage) {</span>
<span class="nc" id="L1040">            ShortMessage sms = (ShortMessage)message;</span>
<span class="nc" id="L1041">            processMessage(sms.getChannel(), sms.getCommand(),</span>
<span class="nc" id="L1042">                    sms.getData1(), sms.getData2());</span>
<span class="nc" id="L1043">            return;</span>
        }
<span class="nc" id="L1045">        processMessage(message.getMessage());</span>
<span class="nc" id="L1046">    }</span>

    public void processMessage(byte[] data) {
<span class="nc" id="L1049">        int status = 0;</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">        if (data.length &gt; 0)</span>
<span class="nc" id="L1051">            status = data[0] &amp; 0xFF;</span>

<span class="nc bnc" id="L1053" title="All 2 branches missed.">        if (status == 0xF0) {</span>
<span class="nc" id="L1054">            processSystemExclusiveMessage(data);</span>
<span class="nc" id="L1055">            return;</span>
        }

<span class="nc" id="L1058">        int cmd = (status &amp; 0xF0);</span>
<span class="nc" id="L1059">        int ch = (status &amp; 0x0F);</span>

        int data1;
        int data2;
<span class="nc bnc" id="L1063" title="All 2 branches missed.">        if (data.length &gt; 1)</span>
<span class="nc" id="L1064">            data1 = data[1] &amp; 0xFF;</span>
        else
<span class="nc" id="L1066">            data1 = 0;</span>
<span class="nc bnc" id="L1067" title="All 2 branches missed.">        if (data.length &gt; 2)</span>
<span class="nc" id="L1068">            data2 = data[2] &amp; 0xFF;</span>
        else
<span class="nc" id="L1070">            data2 = 0;</span>

<span class="nc" id="L1072">        processMessage(ch, cmd, data1, data2);</span>

<span class="nc" id="L1074">    }</span>

    public void processMessage(int ch, int cmd, int data1, int data2) {
<span class="nc" id="L1077">        synchronized (synth.control_mutex) {</span>
<span class="nc" id="L1078">            activity();</span>
<span class="nc" id="L1079">        }</span>

<span class="nc bnc" id="L1081" title="All 2 branches missed.">        if (cmd == 0xF0) {</span>
<span class="nc" id="L1082">            int status = cmd | ch;</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">            switch (status) {</span>
            case ShortMessage.ACTIVE_SENSING:
<span class="nc" id="L1085">                synchronized (synth.control_mutex) {</span>
<span class="nc" id="L1086">                    active_sensing_on = true;</span>
<span class="nc" id="L1087">                }</span>
<span class="nc" id="L1088">                break;</span>
            default:
                break;
            }
<span class="nc" id="L1092">            return;</span>
        }

<span class="nc" id="L1095">        SoftChannel[] channels = synth.channels;</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">        if (ch &gt;= channels.length)</span>
<span class="nc" id="L1097">            return;</span>
<span class="nc" id="L1098">        SoftChannel softchannel = channels[ch];</span>

<span class="nc bnc" id="L1100" title="All 8 branches missed.">        switch (cmd) {</span>
        case ShortMessage.NOTE_ON:
<span class="nc bnc" id="L1102" title="All 2 branches missed.">            if(delay_midievent != 0)</span>
<span class="nc" id="L1103">                softchannel.noteOn(data1, data2, delay_midievent);</span>
            else
<span class="nc" id="L1105">                softchannel.noteOn(data1, data2);</span>
<span class="nc" id="L1106">            break;</span>
        case ShortMessage.NOTE_OFF:
<span class="nc" id="L1108">            softchannel.noteOff(data1, data2);</span>
<span class="nc" id="L1109">            break;</span>
        case ShortMessage.POLY_PRESSURE:
<span class="nc" id="L1111">            softchannel.setPolyPressure(data1, data2);</span>
<span class="nc" id="L1112">            break;</span>
        case ShortMessage.CONTROL_CHANGE:
<span class="nc" id="L1114">            softchannel.controlChange(data1, data2);</span>
<span class="nc" id="L1115">            break;</span>
        case ShortMessage.PROGRAM_CHANGE:
<span class="nc" id="L1117">            softchannel.programChange(data1);</span>
<span class="nc" id="L1118">            break;</span>
        case ShortMessage.CHANNEL_PRESSURE:
<span class="nc" id="L1120">            softchannel.setChannelPressure(data1);</span>
<span class="nc" id="L1121">            break;</span>
        case ShortMessage.PITCH_BEND:
<span class="nc" id="L1123">            softchannel.setPitchBend(data1 + data2 * 128);</span>
<span class="nc" id="L1124">            break;</span>
        default:
            break;
        }

<span class="nc" id="L1129">    }</span>

    public long getMicrosecondPosition() {
<span class="nc bnc" id="L1132" title="All 2 branches missed.">        if(pusher_silent)</span>
        {
<span class="nc bnc" id="L1134" title="All 2 branches missed.">            if(synth.weakstream != null)</span>
            {
<span class="nc" id="L1136">                return (long)((sample_pos  + synth.weakstream.silent_samples)</span>
                        * (1000000.0 / samplerate));
            }
        }
<span class="nc" id="L1140">        return (long)(sample_pos * (1000000.0 / samplerate));</span>
    }

    public void close() {
<span class="nc" id="L1144">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>