<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SoftReverb.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">SoftReverb.java</span></div><h1>SoftReverb.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.util.Arrays;

/**
 * Reverb effect based on allpass/comb filters. First audio is send to 8
 * parelled comb filters and then mixed together and then finally send thru 3
 * different allpass filters.
 *
 * @author Karl Helgason
 */
<span class="nc" id="L36">public final class SoftReverb implements SoftAudioProcessor {</span>

    private final static class Delay {

        private float[] delaybuffer;
<span class="nc" id="L41">        private int rovepos = 0;</span>

<span class="nc" id="L43">        Delay() {</span>
<span class="nc" id="L44">            delaybuffer = null;</span>
<span class="nc" id="L45">        }</span>

        public void setDelay(int delay) {
<span class="nc bnc" id="L48" title="All 2 branches missed.">            if (delay == 0)</span>
<span class="nc" id="L49">                delaybuffer = null;</span>
            else
<span class="nc" id="L51">                delaybuffer = new float[delay];</span>
<span class="nc" id="L52">            rovepos = 0;</span>
<span class="nc" id="L53">        }</span>

        public void processReplace(float[] inout) {
<span class="nc bnc" id="L56" title="All 2 branches missed.">            if (delaybuffer == null)</span>
<span class="nc" id="L57">                return;</span>
<span class="nc" id="L58">            int len = inout.length;</span>
<span class="nc" id="L59">            int rnlen = delaybuffer.length;</span>
<span class="nc" id="L60">            int rovepos = this.rovepos;</span>

<span class="nc bnc" id="L62" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L63">                float x = inout[i];</span>
<span class="nc" id="L64">                inout[i] = delaybuffer[rovepos];</span>
<span class="nc" id="L65">                delaybuffer[rovepos] = x;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                if (++rovepos == rnlen)</span>
<span class="nc" id="L67">                    rovepos = 0;</span>
            }
<span class="nc" id="L69">            this.rovepos = rovepos;</span>
<span class="nc" id="L70">        }</span>
    }

    private final static class AllPass {

        private final float[] delaybuffer;
        private final int delaybuffersize;
<span class="nc" id="L77">        private int rovepos = 0;</span>
        private float feedback;

<span class="nc" id="L80">        AllPass(int size) {</span>
<span class="nc" id="L81">            delaybuffer = new float[size];</span>
<span class="nc" id="L82">            delaybuffersize = size;</span>
<span class="nc" id="L83">        }</span>

        public void setFeedBack(float feedback) {
<span class="nc" id="L86">            this.feedback = feedback;</span>
<span class="nc" id="L87">        }</span>

        public void processReplace(float inout[]) {
<span class="nc" id="L90">            int len = inout.length;</span>
<span class="nc" id="L91">            int delaybuffersize = this.delaybuffersize;</span>
<span class="nc" id="L92">            int rovepos = this.rovepos;</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L94">                float delayout = delaybuffer[rovepos];</span>
<span class="nc" id="L95">                float input = inout[i];</span>
<span class="nc" id="L96">                inout[i] = delayout - input;</span>
<span class="nc" id="L97">                delaybuffer[rovepos] = input + delayout * feedback;</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (++rovepos == delaybuffersize)</span>
<span class="nc" id="L99">                    rovepos = 0;</span>
            }
<span class="nc" id="L101">            this.rovepos = rovepos;</span>
<span class="nc" id="L102">        }</span>

        public void processReplace(float in[], float out[]) {
<span class="nc" id="L105">            int len = in.length;</span>
<span class="nc" id="L106">            int delaybuffersize = this.delaybuffersize;</span>
<span class="nc" id="L107">            int rovepos = this.rovepos;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L109">                float delayout = delaybuffer[rovepos];</span>
<span class="nc" id="L110">                float input = in[i];</span>
<span class="nc" id="L111">                out[i] = delayout - input;</span>
<span class="nc" id="L112">                delaybuffer[rovepos] = input + delayout * feedback;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                if (++rovepos == delaybuffersize)</span>
<span class="nc" id="L114">                    rovepos = 0;</span>
            }
<span class="nc" id="L116">            this.rovepos = rovepos;</span>
<span class="nc" id="L117">        }</span>
    }

    private final static class Comb {

        private final float[] delaybuffer;
        private final int delaybuffersize;
<span class="nc" id="L124">        private int rovepos = 0;</span>
        private float feedback;
<span class="nc" id="L126">        private float filtertemp = 0;</span>
<span class="nc" id="L127">        private float filtercoeff1 = 0;</span>
<span class="nc" id="L128">        private float filtercoeff2 = 1;</span>

<span class="nc" id="L130">        Comb(int size) {</span>
<span class="nc" id="L131">            delaybuffer = new float[size];</span>
<span class="nc" id="L132">            delaybuffersize = size;</span>
<span class="nc" id="L133">        }</span>

        public void setFeedBack(float feedback) {
<span class="nc" id="L136">            this.feedback = feedback;</span>
<span class="nc" id="L137">            filtercoeff2 = (1 - filtercoeff1)* feedback;</span>
<span class="nc" id="L138">        }</span>

        public void processMix(float in[], float out[]) {
<span class="nc" id="L141">            int len = in.length;</span>
<span class="nc" id="L142">            int delaybuffersize = this.delaybuffersize;</span>
<span class="nc" id="L143">            int rovepos = this.rovepos;</span>
<span class="nc" id="L144">            float filtertemp = this.filtertemp;</span>
<span class="nc" id="L145">            float filtercoeff1 = this.filtercoeff1;</span>
<span class="nc" id="L146">            float filtercoeff2 = this.filtercoeff2;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L148">                float delayout = delaybuffer[rovepos];</span>
                // One Pole Lowpass Filter
<span class="nc" id="L150">                filtertemp = (delayout * filtercoeff2)</span>
                        + (filtertemp * filtercoeff1);
<span class="nc" id="L152">                out[i] += delayout;</span>
<span class="nc" id="L153">                delaybuffer[rovepos] = in[i] + filtertemp;</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                if (++rovepos == delaybuffersize)</span>
<span class="nc" id="L155">                    rovepos = 0;</span>
            }
<span class="nc" id="L157">            this.filtertemp  = filtertemp;</span>
<span class="nc" id="L158">            this.rovepos = rovepos;</span>
<span class="nc" id="L159">        }</span>

        public void processReplace(float in[], float out[]) {
<span class="nc" id="L162">            int len = in.length;</span>
<span class="nc" id="L163">            int delaybuffersize = this.delaybuffersize;</span>
<span class="nc" id="L164">            int rovepos = this.rovepos;</span>
<span class="nc" id="L165">            float filtertemp = this.filtertemp;</span>
<span class="nc" id="L166">            float filtercoeff1 = this.filtercoeff1;</span>
<span class="nc" id="L167">            float filtercoeff2 = this.filtercoeff2;</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L169">                float delayout = delaybuffer[rovepos];</span>
                // One Pole Lowpass Filter
<span class="nc" id="L171">                filtertemp = (delayout * filtercoeff2)</span>
                        + (filtertemp * filtercoeff1);
<span class="nc" id="L173">                out[i] = delayout;</span>
<span class="nc" id="L174">                delaybuffer[rovepos] = in[i] + filtertemp;</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">                if (++rovepos == delaybuffersize)</span>
<span class="nc" id="L176">                    rovepos = 0;</span>
            }
<span class="nc" id="L178">            this.filtertemp  = filtertemp;</span>
<span class="nc" id="L179">            this.rovepos = rovepos;</span>
<span class="nc" id="L180">        }</span>

        public void setDamp(float val) {
<span class="nc" id="L183">            filtercoeff1 = val;</span>
<span class="nc" id="L184">            filtercoeff2 = (1 - filtercoeff1)* feedback;</span>
<span class="nc" id="L185">        }</span>
    }
    private float roomsize;
    private float damp;
<span class="nc" id="L189">    private float gain = 1;</span>
    private Delay delay;
    private Comb[] combL;
    private Comb[] combR;
    private AllPass[] allpassL;
    private AllPass[] allpassR;
    private float[] input;
    private float[] out;
    private float[] pre1;
    private float[] pre2;
    private float[] pre3;
<span class="nc" id="L200">    private boolean denormal_flip = false;</span>
<span class="nc" id="L201">    private boolean mix = true;</span>
    private SoftAudioBuffer inputA;
    private SoftAudioBuffer left;
    private SoftAudioBuffer right;
<span class="nc" id="L205">    private boolean dirty = true;</span>
    private float dirty_roomsize;
    private float dirty_damp;
    private float dirty_predelay;
    private float dirty_gain;
    private float samplerate;
<span class="nc" id="L211">    private boolean light = true;</span>

    public void init(float samplerate, float controlrate) {
<span class="nc" id="L214">        this.samplerate = samplerate;</span>

<span class="nc" id="L216">        double freqscale = ((double) samplerate) / 44100.0;</span>
        // freqscale = 1.0/ freqscale;

<span class="nc" id="L219">        int stereospread = 23;</span>

<span class="nc" id="L221">        delay = new Delay();</span>

<span class="nc" id="L223">        combL = new Comb[8];</span>
<span class="nc" id="L224">        combR = new Comb[8];</span>
<span class="nc" id="L225">        combL[0] = new Comb((int) (freqscale * (1116)));</span>
<span class="nc" id="L226">        combR[0] = new Comb((int) (freqscale * (1116 + stereospread)));</span>
<span class="nc" id="L227">        combL[1] = new Comb((int) (freqscale * (1188)));</span>
<span class="nc" id="L228">        combR[1] = new Comb((int) (freqscale * (1188 + stereospread)));</span>
<span class="nc" id="L229">        combL[2] = new Comb((int) (freqscale * (1277)));</span>
<span class="nc" id="L230">        combR[2] = new Comb((int) (freqscale * (1277 + stereospread)));</span>
<span class="nc" id="L231">        combL[3] = new Comb((int) (freqscale * (1356)));</span>
<span class="nc" id="L232">        combR[3] = new Comb((int) (freqscale * (1356 + stereospread)));</span>
<span class="nc" id="L233">        combL[4] = new Comb((int) (freqscale * (1422)));</span>
<span class="nc" id="L234">        combR[4] = new Comb((int) (freqscale * (1422 + stereospread)));</span>
<span class="nc" id="L235">        combL[5] = new Comb((int) (freqscale * (1491)));</span>
<span class="nc" id="L236">        combR[5] = new Comb((int) (freqscale * (1491 + stereospread)));</span>
<span class="nc" id="L237">        combL[6] = new Comb((int) (freqscale * (1557)));</span>
<span class="nc" id="L238">        combR[6] = new Comb((int) (freqscale * (1557 + stereospread)));</span>
<span class="nc" id="L239">        combL[7] = new Comb((int) (freqscale * (1617)));</span>
<span class="nc" id="L240">        combR[7] = new Comb((int) (freqscale * (1617 + stereospread)));</span>

<span class="nc" id="L242">        allpassL = new AllPass[4];</span>
<span class="nc" id="L243">        allpassR = new AllPass[4];</span>
<span class="nc" id="L244">        allpassL[0] = new AllPass((int) (freqscale * (556)));</span>
<span class="nc" id="L245">        allpassR[0] = new AllPass((int) (freqscale * (556 + stereospread)));</span>
<span class="nc" id="L246">        allpassL[1] = new AllPass((int) (freqscale * (441)));</span>
<span class="nc" id="L247">        allpassR[1] = new AllPass((int) (freqscale * (441 + stereospread)));</span>
<span class="nc" id="L248">        allpassL[2] = new AllPass((int) (freqscale * (341)));</span>
<span class="nc" id="L249">        allpassR[2] = new AllPass((int) (freqscale * (341 + stereospread)));</span>
<span class="nc" id="L250">        allpassL[3] = new AllPass((int) (freqscale * (225)));</span>
<span class="nc" id="L251">        allpassR[3] = new AllPass((int) (freqscale * (225 + stereospread)));</span>

<span class="nc bnc" id="L253" title="All 2 branches missed.">        for (int i = 0; i &lt; allpassL.length; i++) {</span>
<span class="nc" id="L254">            allpassL[i].setFeedBack(0.5f);</span>
<span class="nc" id="L255">            allpassR[i].setFeedBack(0.5f);</span>
        }

        /* Init other settings */
<span class="nc" id="L259">        globalParameterControlChange(new int[]{0x01 * 128 + 0x01}, 0, 4);</span>

<span class="nc" id="L261">    }</span>

    public void setInput(int pin, SoftAudioBuffer input) {
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (pin == 0)</span>
<span class="nc" id="L265">            inputA = input;</span>
<span class="nc" id="L266">    }</span>

    public void setOutput(int pin, SoftAudioBuffer output) {
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (pin == 0)</span>
<span class="nc" id="L270">            left = output;</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (pin == 1)</span>
<span class="nc" id="L272">            right = output;</span>
<span class="nc" id="L273">    }</span>

    public void setMixMode(boolean mix) {
<span class="nc" id="L276">        this.mix = mix;</span>
<span class="nc" id="L277">    }</span>

<span class="nc" id="L279">    private boolean silent = true;</span>

    public void processAudio() {
<span class="nc" id="L282">        boolean silent_input = this.inputA.isSilent();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if(!silent_input)</span>
<span class="nc" id="L284">            silent = false;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if(silent)</span>
        {
<span class="nc bnc" id="L287" title="All 2 branches missed.">            if (!mix) {</span>
<span class="nc" id="L288">                left.clear();</span>
<span class="nc" id="L289">                right.clear();</span>
            }
<span class="nc" id="L291">            return;</span>
        }

<span class="nc" id="L294">        float[] inputA = this.inputA.array();</span>
<span class="nc" id="L295">        float[] left = this.left.array();</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">        float[] right = this.right == null ? null : this.right.array();</span>

<span class="nc" id="L298">        int numsamples = inputA.length;</span>
<span class="nc bnc" id="L299" title="All 4 branches missed.">        if (input == null || input.length &lt; numsamples)</span>
<span class="nc" id="L300">            input = new float[numsamples];</span>

<span class="nc" id="L302">        float again = gain * 0.018f / 2;</span>

<span class="nc bnc" id="L304" title="All 2 branches missed.">        denormal_flip = !denormal_flip;</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if(denormal_flip)</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">            for (int i = 0; i &lt; numsamples; i++)</span>
<span class="nc" id="L307">                input[i] = inputA[i] * again + 1E-20f;</span>
        else
<span class="nc bnc" id="L309" title="All 2 branches missed.">            for (int i = 0; i &lt; numsamples; i++)</span>
<span class="nc" id="L310">                input[i] = inputA[i] * again - 1E-20f;</span>

<span class="nc" id="L312">        delay.processReplace(input);</span>

<span class="nc bnc" id="L314" title="All 4 branches missed.">        if(light &amp;&amp; (right != null))</span>
        {
<span class="nc bnc" id="L316" title="All 4 branches missed.">            if (pre1 == null || pre1.length &lt; numsamples)</span>
            {
<span class="nc" id="L318">                pre1 = new float[numsamples];</span>
<span class="nc" id="L319">                pre2 = new float[numsamples];</span>
<span class="nc" id="L320">                pre3 = new float[numsamples];</span>
            }

<span class="nc bnc" id="L323" title="All 2 branches missed.">            for (int i = 0; i &lt; allpassL.length; i++)</span>
<span class="nc" id="L324">                allpassL[i].processReplace(input);</span>

<span class="nc" id="L326">            combL[0].processReplace(input, pre3);</span>
<span class="nc" id="L327">            combL[1].processReplace(input, pre3);</span>

<span class="nc" id="L329">            combL[2].processReplace(input, pre1);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">            for (int i = 4; i &lt; combL.length-2; i+=2)</span>
<span class="nc" id="L331">                combL[i].processMix(input, pre1);</span>

<span class="nc" id="L333">            combL[3].processReplace(input, pre2);;</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            for (int i = 5; i &lt; combL.length-2; i+=2)</span>
<span class="nc" id="L335">                combL[i].processMix(input, pre2);</span>

<span class="nc bnc" id="L337" title="All 2 branches missed.">            if (!mix)</span>
            {
<span class="nc" id="L339">                Arrays.fill(right, 0);</span>
<span class="nc" id="L340">                Arrays.fill(left, 0);</span>
            }
<span class="nc bnc" id="L342" title="All 2 branches missed.">            for (int i = combR.length-2; i &lt; combR.length; i++)</span>
<span class="nc" id="L343">                combR[i].processMix(input, right);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            for (int i = combL.length-2; i &lt; combL.length; i++)</span>
<span class="nc" id="L345">                combL[i].processMix(input, left);</span>

<span class="nc bnc" id="L347" title="All 2 branches missed.">            for (int i = 0; i &lt; numsamples; i++)</span>
            {
<span class="nc" id="L349">                float p = pre1[i] - pre2[i];</span>
<span class="nc" id="L350">                float m = pre3[i];</span>
<span class="nc" id="L351">                left[i] += m + p;</span>
<span class="nc" id="L352">                right[i] += m - p;</span>
            }
        }
        else
        {
<span class="nc bnc" id="L357" title="All 4 branches missed.">            if (out == null || out.length &lt; numsamples)</span>
<span class="nc" id="L358">                out = new float[numsamples];</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (right != null) {</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                if (!mix)</span>
<span class="nc" id="L362">                    Arrays.fill(right, 0);</span>
<span class="nc" id="L363">                allpassR[0].processReplace(input, out);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">                for (int i = 1; i &lt; allpassR.length; i++)</span>
<span class="nc" id="L365">                    allpassR[i].processReplace(out);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                for (int i = 0; i &lt; combR.length; i++)</span>
<span class="nc" id="L367">                    combR[i].processMix(out, right);</span>
            }

<span class="nc bnc" id="L370" title="All 2 branches missed.">            if (!mix)</span>
<span class="nc" id="L371">                Arrays.fill(left, 0);</span>
<span class="nc" id="L372">            allpassL[0].processReplace(input, out);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">            for (int i = 1; i &lt; allpassL.length; i++)</span>
<span class="nc" id="L374">                allpassL[i].processReplace(out);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            for (int i = 0; i &lt; combL.length; i++)</span>
<span class="nc" id="L376">                combL[i].processMix(out, left);</span>
        }






<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (silent_input) {</span>
<span class="nc" id="L385">            silent = true;</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">            for (int i = 0; i &lt; numsamples; i++)</span>
            {
<span class="nc" id="L388">                float v = left[i];</span>
<span class="nc bnc" id="L389" title="All 4 branches missed.">                if(v &gt; 1E-10 || v &lt; -1E-10)</span>
                {
<span class="nc" id="L391">                    silent = false;</span>
<span class="nc" id="L392">                    break;</span>
                }
            }
        }

<span class="nc" id="L397">    }</span>

    public void globalParameterControlChange(int[] slothpath, long param,
            long value) {
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (slothpath.length == 1) {</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">            if (slothpath[0] == 0x01 * 128 + 0x01) {</span>

<span class="nc bnc" id="L404" title="All 2 branches missed.">                if (param == 0) {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">                    if (value == 0) {</span>
                        // Small Room A small size room with a length
                        // of 5m or so.
<span class="nc" id="L408">                        dirty_roomsize = (1.1f);</span>
<span class="nc" id="L409">                        dirty_damp = (5000);</span>
<span class="nc" id="L410">                        dirty_predelay = (0);</span>
<span class="nc" id="L411">                        dirty_gain = (4);</span>
<span class="nc" id="L412">                        dirty = true;</span>
                    }
<span class="nc bnc" id="L414" title="All 2 branches missed.">                    if (value == 1) {</span>
                        // Medium Room A medium size room with a length
                        // of 10m or so.
<span class="nc" id="L417">                        dirty_roomsize = (1.3f);</span>
<span class="nc" id="L418">                        dirty_damp = (5000);</span>
<span class="nc" id="L419">                        dirty_predelay = (0);</span>
<span class="nc" id="L420">                        dirty_gain = (3);</span>
<span class="nc" id="L421">                        dirty = true;</span>
                    }
<span class="nc bnc" id="L423" title="All 2 branches missed.">                    if (value == 2) {</span>
                        // Large Room A large size room suitable for
                        // live performances.
<span class="nc" id="L426">                        dirty_roomsize = (1.5f);</span>
<span class="nc" id="L427">                        dirty_damp = (5000);</span>
<span class="nc" id="L428">                        dirty_predelay = (0);</span>
<span class="nc" id="L429">                        dirty_gain = (2);</span>
<span class="nc" id="L430">                        dirty = true;</span>
                    }
<span class="nc bnc" id="L432" title="All 2 branches missed.">                    if (value == 3) {</span>
                        // Medium Hall A medium size concert hall.
<span class="nc" id="L434">                        dirty_roomsize = (1.8f);</span>
<span class="nc" id="L435">                        dirty_damp = (24000);</span>
<span class="nc" id="L436">                        dirty_predelay = (0.02f);</span>
<span class="nc" id="L437">                        dirty_gain = (1.5f);</span>
<span class="nc" id="L438">                        dirty = true;</span>
                    }
<span class="nc bnc" id="L440" title="All 2 branches missed.">                    if (value == 4) {</span>
                        // Large Hall A large size concert hall
                        // suitable for a full orchestra.
<span class="nc" id="L443">                        dirty_roomsize = (1.8f);</span>
<span class="nc" id="L444">                        dirty_damp = (24000);</span>
<span class="nc" id="L445">                        dirty_predelay = (0.03f);</span>
<span class="nc" id="L446">                        dirty_gain = (1.5f);</span>
<span class="nc" id="L447">                        dirty = true;</span>
                    }
<span class="nc bnc" id="L449" title="All 2 branches missed.">                    if (value == 8) {</span>
                        // Plate A plate reverb simulation.
<span class="nc" id="L451">                        dirty_roomsize = (1.3f);</span>
<span class="nc" id="L452">                        dirty_damp = (2500);</span>
<span class="nc" id="L453">                        dirty_predelay = (0);</span>
<span class="nc" id="L454">                        dirty_gain = (6);</span>
<span class="nc" id="L455">                        dirty = true;</span>
                    }
<span class="nc bnc" id="L457" title="All 2 branches missed.">                } else if (param == 1) {</span>
<span class="nc" id="L458">                    dirty_roomsize = ((float) (Math.exp((value - 40) * 0.025)));</span>
<span class="nc" id="L459">                    dirty = true;</span>
                }

            }
        }
<span class="nc" id="L464">    }</span>

    public void processControlLogic() {
<span class="nc bnc" id="L467" title="All 2 branches missed.">        if (dirty) {</span>
<span class="nc" id="L468">            dirty = false;</span>
<span class="nc" id="L469">            setRoomSize(dirty_roomsize);</span>
<span class="nc" id="L470">            setDamp(dirty_damp);</span>
<span class="nc" id="L471">            setPreDelay(dirty_predelay);</span>
<span class="nc" id="L472">            setGain(dirty_gain);</span>
        }
<span class="nc" id="L474">    }</span>

    public void setRoomSize(float value) {
<span class="nc" id="L477">        roomsize = 1 - (0.17f / value);</span>

<span class="nc bnc" id="L479" title="All 2 branches missed.">        for (int i = 0; i &lt; combL.length; i++) {</span>
<span class="nc" id="L480">            combL[i].feedback = roomsize;</span>
<span class="nc" id="L481">            combR[i].feedback = roomsize;</span>
        }
<span class="nc" id="L483">    }</span>

    public void setPreDelay(float value) {
<span class="nc" id="L486">        delay.setDelay((int)(value * samplerate));</span>
<span class="nc" id="L487">    }</span>

    public void setGain(float gain) {
<span class="nc" id="L490">        this.gain = gain;</span>
<span class="nc" id="L491">    }</span>

    public void setDamp(float value) {
<span class="nc" id="L494">        double x = (value / samplerate) * (2 * Math.PI);</span>
<span class="nc" id="L495">        double cx = 2 - Math.cos(x);</span>
<span class="nc" id="L496">        damp = (float)(cx - Math.sqrt(cx * cx - 1));</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">        if (damp &gt; 1)</span>
<span class="nc" id="L498">            damp = 1;</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (damp &lt; 0)</span>
<span class="nc" id="L500">            damp = 0;</span>

        // damp = value * 0.4f;
<span class="nc bnc" id="L503" title="All 2 branches missed.">        for (int i = 0; i &lt; combL.length; i++) {</span>
<span class="nc" id="L504">            combL[i].setDamp(damp);</span>
<span class="nc" id="L505">            combR[i].setDamp(damp);</span>
        }

<span class="nc" id="L508">    }</span>

    public void setLightMode(boolean light)
    {
<span class="nc" id="L512">        this.light = light;</span>
<span class="nc" id="L513">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>