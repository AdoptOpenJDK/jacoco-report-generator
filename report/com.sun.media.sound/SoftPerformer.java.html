<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SoftPerformer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">SoftPerformer.java</span></div><h1>SoftPerformer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * This class decodes information from ModelPeformer for use in SoftVoice.
 * It also adds default connections if they where missing in ModelPerformer.
 *
 * @author Karl Helgason
 */
public final class SoftPerformer {

<span class="nc" id="L42">    static ModelConnectionBlock[] defaultconnections</span>
            = new ModelConnectionBlock[42];

    static {
<span class="nc" id="L46">        int o = 0;</span>
<span class="nc" id="L47">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;noteon&quot;, &quot;on&quot;, 0),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            1, new ModelDestination(new ModelIdentifier(&quot;eg&quot;, &quot;on&quot;, 0)));

<span class="nc" id="L55">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;noteon&quot;, &quot;on&quot;, 0),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            1, new ModelDestination(new ModelIdentifier(&quot;eg&quot;, &quot;on&quot;, 1)));

<span class="nc" id="L63">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;eg&quot;, &quot;active&quot;, 0),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            1, new ModelDestination(new ModelIdentifier(&quot;mixer&quot;, &quot;active&quot;, 0)));

<span class="nc" id="L71">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;eg&quot;, 0),
                ModelStandardTransform.DIRECTION_MAX2MIN,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            -960, new ModelDestination(new ModelIdentifier(&quot;mixer&quot;, &quot;gain&quot;)));

<span class="nc" id="L79">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;noteon&quot;, &quot;velocity&quot;),
                ModelStandardTransform.DIRECTION_MAX2MIN,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_CONCAVE),
            -960, new ModelDestination(new ModelIdentifier(&quot;mixer&quot;, &quot;gain&quot;)));

<span class="nc" id="L87">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi&quot;, &quot;pitch&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            new ModelSource(new ModelIdentifier(&quot;midi_rpn&quot;, &quot;0&quot;),
<span class="nc" id="L94">                new ModelTransform() {</span>
                    public double transform(double value) {
<span class="nc" id="L96">                        int v = (int) (value * 16384.0);</span>
<span class="nc" id="L97">                        int msb = v &gt;&gt; 7;</span>
<span class="nc" id="L98">                        int lsb = v &amp; 127;</span>
<span class="nc" id="L99">                        return msb * 100 + lsb;</span>
                    }
                }),
            new ModelDestination(new ModelIdentifier(&quot;osc&quot;, &quot;pitch&quot;)));

<span class="nc" id="L104">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;noteon&quot;, &quot;keynumber&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            12800, new ModelDestination(new ModelIdentifier(&quot;osc&quot;, &quot;pitch&quot;)));

<span class="nc" id="L112">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;7&quot;),
                ModelStandardTransform.DIRECTION_MAX2MIN,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_CONCAVE),
            -960, new ModelDestination(new ModelIdentifier(&quot;mixer&quot;, &quot;gain&quot;)));

<span class="nc" id="L120">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;8&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            1000, new ModelDestination(new ModelIdentifier(&quot;mixer&quot;, &quot;balance&quot;)));

<span class="nc" id="L128">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;10&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            1000, new ModelDestination(new ModelIdentifier(&quot;mixer&quot;, &quot;pan&quot;)));

<span class="nc" id="L136">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;11&quot;),
                ModelStandardTransform.DIRECTION_MAX2MIN,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_CONCAVE),
            -960, new ModelDestination(new ModelIdentifier(&quot;mixer&quot;, &quot;gain&quot;)));

<span class="nc" id="L144">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;91&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            1000, new ModelDestination(new ModelIdentifier(&quot;mixer&quot;, &quot;reverb&quot;)));

<span class="nc" id="L152">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;93&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            1000, new ModelDestination(new ModelIdentifier(&quot;mixer&quot;, &quot;chorus&quot;)));

<span class="nc" id="L160">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;71&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            200, new ModelDestination(new ModelIdentifier(&quot;filter&quot;, &quot;q&quot;)));
<span class="nc" id="L167">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;74&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            9600, new ModelDestination(new ModelIdentifier(&quot;filter&quot;, &quot;freq&quot;)));

<span class="nc" id="L175">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;72&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            6000, new ModelDestination(new ModelIdentifier(&quot;eg&quot;, &quot;release2&quot;)));

<span class="nc" id="L183">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;73&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            2000, new ModelDestination(new ModelIdentifier(&quot;eg&quot;, &quot;attack2&quot;)));

<span class="nc" id="L191">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;75&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            6000, new ModelDestination(new ModelIdentifier(&quot;eg&quot;, &quot;decay2&quot;)));

<span class="nc" id="L199">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;67&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_SWITCH),
            -50, new ModelDestination(ModelDestination.DESTINATION_GAIN));

<span class="nc" id="L207">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_cc&quot;, &quot;67&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_UNIPOLAR,
                ModelStandardTransform.TRANSFORM_SWITCH),
            -2400, new ModelDestination(ModelDestination.DESTINATION_FILTER_FREQ));

<span class="nc" id="L215">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_rpn&quot;, &quot;1&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            100, new ModelDestination(new ModelIdentifier(&quot;osc&quot;, &quot;pitch&quot;)));

<span class="nc" id="L223">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;midi_rpn&quot;, &quot;2&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            12800, new ModelDestination(new ModelIdentifier(&quot;osc&quot;, &quot;pitch&quot;)));

<span class="nc" id="L231">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;master&quot;, &quot;fine_tuning&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            100, new ModelDestination(new ModelIdentifier(&quot;osc&quot;, &quot;pitch&quot;)));

<span class="nc" id="L239">        defaultconnections[o++] = new ModelConnectionBlock(</span>
            new ModelSource(
                new ModelIdentifier(&quot;master&quot;, &quot;coarse_tuning&quot;),
                ModelStandardTransform.DIRECTION_MIN2MAX,
                ModelStandardTransform.POLARITY_BIPOLAR,
                ModelStandardTransform.TRANSFORM_LINEAR),
            12800, new ModelDestination(new ModelIdentifier(&quot;osc&quot;, &quot;pitch&quot;)));

<span class="nc" id="L247">        defaultconnections[o++] = new ModelConnectionBlock(13500,</span>
                new ModelDestination(new ModelIdentifier(&quot;filter&quot;, &quot;freq&quot;, 0)));

<span class="nc" id="L250">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;delay&quot;, 0)));
<span class="nc" id="L253">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;attack&quot;, 0)));
<span class="nc" id="L256">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;hold&quot;, 0)));
<span class="nc" id="L259">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;decay&quot;, 0)));
<span class="nc" id="L262">        defaultconnections[o++] = new ModelConnectionBlock(1000,</span>
                new ModelDestination(new ModelIdentifier(&quot;eg&quot;, &quot;sustain&quot;, 0)));
<span class="nc" id="L264">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;release&quot;, 0)));
<span class="nc" id="L267">        defaultconnections[o++] = new ModelConnectionBlock(1200.0</span>
<span class="nc" id="L268">                * Math.log(0.015) / Math.log(2), new ModelDestination(</span>
                new ModelIdentifier(&quot;eg&quot;, &quot;shutdown&quot;, 0))); // 15 msec default

<span class="nc" id="L271">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;delay&quot;, 1)));
<span class="nc" id="L274">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;attack&quot;, 1)));
<span class="nc" id="L277">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;hold&quot;, 1)));
<span class="nc" id="L280">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;decay&quot;, 1)));
<span class="nc" id="L283">        defaultconnections[o++] = new ModelConnectionBlock(1000,</span>
                new ModelDestination(new ModelIdentifier(&quot;eg&quot;, &quot;sustain&quot;, 1)));
<span class="nc" id="L285">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;eg&quot;, &quot;release&quot;, 1)));

<span class="nc" id="L289">        defaultconnections[o++] = new ModelConnectionBlock(-8.51318,</span>
                new ModelDestination(new ModelIdentifier(&quot;lfo&quot;, &quot;freq&quot;, 0)));
<span class="nc" id="L291">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;lfo&quot;, &quot;delay&quot;, 0)));
<span class="nc" id="L294">        defaultconnections[o++] = new ModelConnectionBlock(-8.51318,</span>
                new ModelDestination(new ModelIdentifier(&quot;lfo&quot;, &quot;freq&quot;, 1)));
<span class="nc" id="L296">        defaultconnections[o++] = new ModelConnectionBlock(</span>
                Float.NEGATIVE_INFINITY, new ModelDestination(
                new ModelIdentifier(&quot;lfo&quot;, &quot;delay&quot;, 1)));

    }
<span class="nc" id="L301">    public int keyFrom = 0;</span>
<span class="nc" id="L302">    public int keyTo = 127;</span>
<span class="nc" id="L303">    public int velFrom = 0;</span>
<span class="nc" id="L304">    public int velTo = 127;</span>
<span class="nc" id="L305">    public int exclusiveClass = 0;</span>
<span class="nc" id="L306">    public boolean selfNonExclusive = false;</span>
<span class="nc" id="L307">    public boolean forcedVelocity = false;</span>
<span class="nc" id="L308">    public boolean forcedKeynumber = false;</span>
    public ModelPerformer performer;
    public ModelConnectionBlock[] connections;
    public ModelOscillator[] oscillators;
<span class="nc" id="L312">    public Map&lt;Integer, int[]&gt; midi_rpn_connections = new HashMap&lt;Integer, int[]&gt;();</span>
<span class="nc" id="L313">    public Map&lt;Integer, int[]&gt; midi_nrpn_connections = new HashMap&lt;Integer, int[]&gt;();</span>
    public int[][] midi_ctrl_connections;
    public int[][] midi_connections;
    public int[] ctrl_connections;
<span class="nc" id="L317">    private List&lt;Integer&gt; ctrl_connections_list = new ArrayList&lt;Integer&gt;();</span>

<span class="nc" id="L319">    private static class KeySortComparator implements Comparator&lt;ModelSource&gt; {</span>

        public int compare(ModelSource o1, ModelSource o2) {
<span class="nc" id="L322">            return o1.getIdentifier().toString().compareTo(</span>
<span class="nc" id="L323">                    o2.getIdentifier().toString());</span>
        }
    }
<span class="nc" id="L326">    private static KeySortComparator keySortComparator = new KeySortComparator();</span>

    private String extractKeys(ModelConnectionBlock conn) {
<span class="nc" id="L329">        StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (conn.getSources() != null) {</span>
<span class="nc" id="L331">            sb.append(&quot;[&quot;);</span>
<span class="nc" id="L332">            ModelSource[] srcs = conn.getSources();</span>
<span class="nc" id="L333">            ModelSource[] srcs2 = new ModelSource[srcs.length];</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            for (int i = 0; i &lt; srcs.length; i++)</span>
<span class="nc" id="L335">                srcs2[i] = srcs[i];</span>
<span class="nc" id="L336">            Arrays.sort(srcs2, keySortComparator);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">            for (int i = 0; i &lt; srcs.length; i++) {</span>
<span class="nc" id="L338">                sb.append(srcs[i].getIdentifier());</span>
<span class="nc" id="L339">                sb.append(&quot;;&quot;);</span>
            }
<span class="nc" id="L341">            sb.append(&quot;]&quot;);</span>
        }
<span class="nc" id="L343">        sb.append(&quot;;&quot;);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (conn.getDestination() != null) {</span>
<span class="nc" id="L345">            sb.append(conn.getDestination().getIdentifier());</span>
        }
<span class="nc" id="L347">        sb.append(&quot;;&quot;);</span>
<span class="nc" id="L348">        return sb.toString();</span>
    }

    private void processSource(ModelSource src, int ix) {
<span class="nc" id="L352">        ModelIdentifier id = src.getIdentifier();</span>
<span class="nc" id="L353">        String o = id.getObject();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (o.equals(&quot;midi_cc&quot;))</span>
<span class="nc" id="L355">            processMidiControlSource(src, ix);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">        else if (o.equals(&quot;midi_rpn&quot;))</span>
<span class="nc" id="L357">            processMidiRpnSource(src, ix);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        else if (o.equals(&quot;midi_nrpn&quot;))</span>
<span class="nc" id="L359">            processMidiNrpnSource(src, ix);</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">        else if (o.equals(&quot;midi&quot;))</span>
<span class="nc" id="L361">            processMidiSource(src, ix);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">        else if (o.equals(&quot;noteon&quot;))</span>
<span class="nc" id="L363">            processNoteOnSource(src, ix);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        else if (o.equals(&quot;osc&quot;))</span>
<span class="nc" id="L365">            return;</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">        else if (o.equals(&quot;mixer&quot;))</span>
<span class="nc" id="L367">            return;</span>
        else
<span class="nc" id="L369">            ctrl_connections_list.add(ix);</span>
<span class="nc" id="L370">    }</span>

    private void processMidiControlSource(ModelSource src, int ix) {
<span class="nc" id="L373">        String v = src.getIdentifier().getVariable();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (v == null)</span>
<span class="nc" id="L375">            return;</span>
<span class="nc" id="L376">        int c = Integer.parseInt(v);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (midi_ctrl_connections[c] == null)</span>
<span class="nc" id="L378">            midi_ctrl_connections[c] = new int[]{ix};</span>
        else {
<span class="nc" id="L380">            int[] olda = midi_ctrl_connections[c];</span>
<span class="nc" id="L381">            int[] newa = new int[olda.length + 1];</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">            for (int i = 0; i &lt; olda.length; i++)</span>
<span class="nc" id="L383">                newa[i] = olda[i];</span>
<span class="nc" id="L384">            newa[newa.length - 1] = ix;</span>
<span class="nc" id="L385">            midi_ctrl_connections[c] = newa;</span>
        }
<span class="nc" id="L387">    }</span>

    private void processNoteOnSource(ModelSource src, int ix) {
<span class="nc" id="L390">        String v = src.getIdentifier().getVariable();</span>
<span class="nc" id="L391">        int c = -1;</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (v.equals(&quot;on&quot;))</span>
<span class="nc" id="L393">            c = 3;</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">        if (v.equals(&quot;keynumber&quot;))</span>
<span class="nc" id="L395">            c = 4;</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">        if (c == -1)</span>
<span class="nc" id="L397">            return;</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (midi_connections[c] == null)</span>
<span class="nc" id="L399">            midi_connections[c] = new int[]{ix};</span>
        else {
<span class="nc" id="L401">            int[] olda = midi_connections[c];</span>
<span class="nc" id="L402">            int[] newa = new int[olda.length + 1];</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">            for (int i = 0; i &lt; olda.length; i++)</span>
<span class="nc" id="L404">                newa[i] = olda[i];</span>
<span class="nc" id="L405">            newa[newa.length - 1] = ix;</span>
<span class="nc" id="L406">            midi_connections[c] = newa;</span>
        }
<span class="nc" id="L408">    }</span>

    private void processMidiSource(ModelSource src, int ix) {
<span class="nc" id="L411">        String v = src.getIdentifier().getVariable();</span>
<span class="nc" id="L412">        int c = -1;</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">        if (v.equals(&quot;pitch&quot;))</span>
<span class="nc" id="L414">            c = 0;</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (v.equals(&quot;channel_pressure&quot;))</span>
<span class="nc" id="L416">            c = 1;</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (v.equals(&quot;poly_pressure&quot;))</span>
<span class="nc" id="L418">            c = 2;</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (c == -1)</span>
<span class="nc" id="L420">            return;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (midi_connections[c] == null)</span>
<span class="nc" id="L422">            midi_connections[c] = new int[]{ix};</span>
        else {
<span class="nc" id="L424">            int[] olda = midi_connections[c];</span>
<span class="nc" id="L425">            int[] newa = new int[olda.length + 1];</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">            for (int i = 0; i &lt; olda.length; i++)</span>
<span class="nc" id="L427">                newa[i] = olda[i];</span>
<span class="nc" id="L428">            newa[newa.length - 1] = ix;</span>
<span class="nc" id="L429">            midi_connections[c] = newa;</span>
        }
<span class="nc" id="L431">    }</span>

    private void processMidiRpnSource(ModelSource src, int ix) {
<span class="nc" id="L434">        String v = src.getIdentifier().getVariable();</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (v == null)</span>
<span class="nc" id="L436">            return;</span>
<span class="nc" id="L437">        int c = Integer.parseInt(v);</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (midi_rpn_connections.get(c) == null)</span>
<span class="nc" id="L439">            midi_rpn_connections.put(c, new int[]{ix});</span>
        else {
<span class="nc" id="L441">            int[] olda = midi_rpn_connections.get(c);</span>
<span class="nc" id="L442">            int[] newa = new int[olda.length + 1];</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">            for (int i = 0; i &lt; olda.length; i++)</span>
<span class="nc" id="L444">                newa[i] = olda[i];</span>
<span class="nc" id="L445">            newa[newa.length - 1] = ix;</span>
<span class="nc" id="L446">            midi_rpn_connections.put(c, newa);</span>
        }
<span class="nc" id="L448">    }</span>

    private void processMidiNrpnSource(ModelSource src, int ix) {
<span class="nc" id="L451">        String v = src.getIdentifier().getVariable();</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (v == null)</span>
<span class="nc" id="L453">            return;</span>
<span class="nc" id="L454">        int c = Integer.parseInt(v);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        if (midi_nrpn_connections.get(c) == null)</span>
<span class="nc" id="L456">            midi_nrpn_connections.put(c, new int[]{ix});</span>
        else {
<span class="nc" id="L458">            int[] olda = midi_nrpn_connections.get(c);</span>
<span class="nc" id="L459">            int[] newa = new int[olda.length + 1];</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">            for (int i = 0; i &lt; olda.length; i++)</span>
<span class="nc" id="L461">                newa[i] = olda[i];</span>
<span class="nc" id="L462">            newa[newa.length - 1] = ix;</span>
<span class="nc" id="L463">            midi_nrpn_connections.put(c, newa);</span>
        }
<span class="nc" id="L465">    }</span>

<span class="nc" id="L467">    public SoftPerformer(ModelPerformer performer) {</span>
<span class="nc" id="L468">        this.performer = performer;</span>

<span class="nc" id="L470">        keyFrom = performer.getKeyFrom();</span>
<span class="nc" id="L471">        keyTo = performer.getKeyTo();</span>
<span class="nc" id="L472">        velFrom = performer.getVelFrom();</span>
<span class="nc" id="L473">        velTo = performer.getVelTo();</span>
<span class="nc" id="L474">        exclusiveClass = performer.getExclusiveClass();</span>
<span class="nc" id="L475">        selfNonExclusive = performer.isSelfNonExclusive();</span>

<span class="nc" id="L477">        Map&lt;String, ModelConnectionBlock&gt; connmap = new HashMap&lt;String, ModelConnectionBlock&gt;();</span>

<span class="nc" id="L479">        List&lt;ModelConnectionBlock&gt; performer_connections = new ArrayList&lt;ModelConnectionBlock&gt;();</span>
<span class="nc" id="L480">        performer_connections.addAll(performer.getConnectionBlocks());</span>

<span class="nc bnc" id="L482" title="All 2 branches missed.">        if (performer.isDefaultConnectionsEnabled()) {</span>

            // Add modulation depth range (RPN 5) to the modulation wheel (cc#1)

<span class="nc" id="L486">            boolean isModulationWheelConectionFound = false;</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">            for (int j = 0; j &lt; performer_connections.size(); j++) {</span>
<span class="nc" id="L488">                ModelConnectionBlock connection = performer_connections.get(j);</span>
<span class="nc" id="L489">                ModelSource[] sources = connection.getSources();</span>
<span class="nc" id="L490">                ModelDestination dest = connection.getDestination();</span>
<span class="nc" id="L491">                boolean isModulationWheelConection = false;</span>
<span class="nc bnc" id="L492" title="All 6 branches missed.">                if (dest != null &amp;&amp; sources != null &amp;&amp; sources.length &gt; 1) {</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                    for (int i = 0; i &lt; sources.length; i++) {</span>
                        // check if connection block has the source &quot;modulation
                        // wheel cc#1&quot;
<span class="nc bnc" id="L496" title="All 2 branches missed.">                        if (sources[i].getIdentifier().getObject().equals(</span>
                                &quot;midi_cc&quot;)) {
<span class="nc" id="L498">                            if (sources[i].getIdentifier().getVariable()</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">                                    .equals(&quot;1&quot;)) {</span>
<span class="nc" id="L500">                                isModulationWheelConection = true;</span>
<span class="nc" id="L501">                                isModulationWheelConectionFound = true;</span>
<span class="nc" id="L502">                                break;</span>
                            }
                        }
                    }
                }
<span class="nc bnc" id="L507" title="All 2 branches missed.">                if (isModulationWheelConection) {</span>

<span class="nc" id="L509">                    ModelConnectionBlock newconnection = new ModelConnectionBlock();</span>
<span class="nc" id="L510">                    newconnection.setSources(connection.getSources());</span>
<span class="nc" id="L511">                    newconnection.setDestination(connection.getDestination());</span>
<span class="nc" id="L512">                    newconnection.addSource(new ModelSource(</span>
                            new ModelIdentifier(&quot;midi_rpn&quot;, &quot;5&quot;)));
<span class="nc" id="L514">                    newconnection.setScale(connection.getScale() * 256.0);</span>
<span class="nc" id="L515">                    performer_connections.set(j, newconnection);</span>
                }
            }

<span class="nc bnc" id="L519" title="All 2 branches missed.">            if (!isModulationWheelConectionFound) {</span>
<span class="nc" id="L520">                ModelConnectionBlock conn = new ModelConnectionBlock(</span>
                        new ModelSource(ModelSource.SOURCE_LFO1,
                        ModelStandardTransform.DIRECTION_MIN2MAX,
                        ModelStandardTransform.POLARITY_BIPOLAR,
                        ModelStandardTransform.TRANSFORM_LINEAR),
                        new ModelSource(new ModelIdentifier(&quot;midi_cc&quot;, &quot;1&quot;, 0),
                        ModelStandardTransform.DIRECTION_MIN2MAX,
                        ModelStandardTransform.POLARITY_UNIPOLAR,
                        ModelStandardTransform.TRANSFORM_LINEAR),
                        50,
                        new ModelDestination(ModelDestination.DESTINATION_PITCH));
<span class="nc" id="L531">                conn.addSource(new ModelSource(new ModelIdentifier(&quot;midi_rpn&quot;,</span>
                        &quot;5&quot;)));
<span class="nc" id="L533">                conn.setScale(conn.getScale() * 256.0);</span>
<span class="nc" id="L534">                performer_connections.add(conn);</span>

            }

            // Let Aftertouch to behave just like modulation wheel (cc#1)
<span class="nc" id="L539">            boolean channel_pressure_set = false;</span>
<span class="nc" id="L540">            boolean poly_pressure = false;</span>
<span class="nc" id="L541">            ModelConnectionBlock mod_cc_1_connection = null;</span>
<span class="nc" id="L542">            int mod_cc_1_connection_src_ix = 0;</span>

<span class="nc bnc" id="L544" title="All 2 branches missed.">            for (ModelConnectionBlock connection : performer_connections) {</span>
<span class="nc" id="L545">                ModelSource[] sources = connection.getSources();</span>
<span class="nc" id="L546">                ModelDestination dest = connection.getDestination();</span>
                // if(dest != null &amp;&amp; sources != null)
<span class="nc bnc" id="L548" title="All 4 branches missed.">                if (dest != null &amp;&amp; sources != null) {</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">                    for (int i = 0; i &lt; sources.length; i++) {</span>
<span class="nc" id="L550">                        ModelIdentifier srcid = sources[i].getIdentifier();</span>
                        // check if connection block has the source &quot;modulation
                        // wheel cc#1&quot;
<span class="nc bnc" id="L553" title="All 2 branches missed.">                        if (srcid.getObject().equals(&quot;midi_cc&quot;)) {</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">                            if (srcid.getVariable().equals(&quot;1&quot;)) {</span>
<span class="nc" id="L555">                                mod_cc_1_connection = connection;</span>
<span class="nc" id="L556">                                mod_cc_1_connection_src_ix = i;</span>
                            }
                        }
                        // check if channel or poly pressure are already
                        // connected
<span class="nc bnc" id="L561" title="All 2 branches missed.">                        if (srcid.getObject().equals(&quot;midi&quot;)) {</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">                            if (srcid.getVariable().equals(&quot;channel_pressure&quot;))</span>
<span class="nc" id="L563">                                channel_pressure_set = true;</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">                            if (srcid.getVariable().equals(&quot;poly_pressure&quot;))</span>
<span class="nc" id="L565">                                poly_pressure = true;</span>
                        }
                    }
                }

<span class="nc" id="L570">            }</span>

<span class="nc bnc" id="L572" title="All 2 branches missed.">            if (mod_cc_1_connection != null) {</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                if (!channel_pressure_set) {</span>
<span class="nc" id="L574">                    ModelConnectionBlock mc = new ModelConnectionBlock();</span>
<span class="nc" id="L575">                    mc.setDestination(mod_cc_1_connection.getDestination());</span>
<span class="nc" id="L576">                    mc.setScale(mod_cc_1_connection.getScale());</span>
<span class="nc" id="L577">                    ModelSource[] src_list = mod_cc_1_connection.getSources();</span>
<span class="nc" id="L578">                    ModelSource[] src_list_new = new ModelSource[src_list.length];</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">                    for (int i = 0; i &lt; src_list_new.length; i++)</span>
<span class="nc" id="L580">                        src_list_new[i] = src_list[i];</span>
<span class="nc" id="L581">                    src_list_new[mod_cc_1_connection_src_ix] = new ModelSource(</span>
                            new ModelIdentifier(&quot;midi&quot;, &quot;channel_pressure&quot;));
<span class="nc" id="L583">                    mc.setSources(src_list_new);</span>
<span class="nc" id="L584">                    connmap.put(extractKeys(mc), mc);</span>
                }
<span class="nc bnc" id="L586" title="All 2 branches missed.">                if (!poly_pressure) {</span>
<span class="nc" id="L587">                    ModelConnectionBlock mc = new ModelConnectionBlock();</span>
<span class="nc" id="L588">                    mc.setDestination(mod_cc_1_connection.getDestination());</span>
<span class="nc" id="L589">                    mc.setScale(mod_cc_1_connection.getScale());</span>
<span class="nc" id="L590">                    ModelSource[] src_list = mod_cc_1_connection.getSources();</span>
<span class="nc" id="L591">                    ModelSource[] src_list_new = new ModelSource[src_list.length];</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">                    for (int i = 0; i &lt; src_list_new.length; i++)</span>
<span class="nc" id="L593">                        src_list_new[i] = src_list[i];</span>
<span class="nc" id="L594">                    src_list_new[mod_cc_1_connection_src_ix] = new ModelSource(</span>
                            new ModelIdentifier(&quot;midi&quot;, &quot;poly_pressure&quot;));
<span class="nc" id="L596">                    mc.setSources(src_list_new);</span>
<span class="nc" id="L597">                    connmap.put(extractKeys(mc), mc);</span>
                }
            }

            // Enable Vibration Sound Controllers : 76, 77, 78
<span class="nc" id="L602">            ModelConnectionBlock found_vib_connection = null;</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">            for (ModelConnectionBlock connection : performer_connections) {</span>
<span class="nc" id="L604">                ModelSource[] sources = connection.getSources();</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">                if (sources.length != 0</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                        &amp;&amp; sources[0].getIdentifier().getObject().equals(&quot;lfo&quot;)) {</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">                    if (connection.getDestination().getIdentifier().equals(</span>
                            ModelDestination.DESTINATION_PITCH)) {
<span class="nc bnc" id="L609" title="All 2 branches missed.">                        if (found_vib_connection == null)</span>
<span class="nc" id="L610">                            found_vib_connection = connection;</span>
                        else {
<span class="nc bnc" id="L612" title="All 2 branches missed.">                            if (found_vib_connection.getSources().length &gt; sources.length)</span>
<span class="nc" id="L613">                                found_vib_connection = connection;</span>
<span class="nc" id="L614">                            else if (found_vib_connection.getSources()[0]</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">                                    .getIdentifier().getInstance() &lt; 1) {</span>
<span class="nc" id="L616">                                if (found_vib_connection.getSources()[0]</span>
<span class="nc" id="L617">                                        .getIdentifier().getInstance() &gt;</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">                                        sources[0].getIdentifier().getInstance()) {</span>
<span class="nc" id="L619">                                    found_vib_connection = connection;</span>
                                }
                            }
                        }

                    }
                }
<span class="nc" id="L626">            }</span>

<span class="nc" id="L628">            int instance = 1;</span>

<span class="nc bnc" id="L630" title="All 2 branches missed.">            if (found_vib_connection != null) {</span>
<span class="nc" id="L631">                instance = found_vib_connection.getSources()[0].getIdentifier()</span>
<span class="nc" id="L632">                        .getInstance();</span>
            }
            ModelConnectionBlock connection;

<span class="nc" id="L636">            connection = new ModelConnectionBlock(</span>
                new ModelSource(new ModelIdentifier(&quot;midi_cc&quot;, &quot;78&quot;),
                    ModelStandardTransform.DIRECTION_MIN2MAX,
                    ModelStandardTransform.POLARITY_BIPOLAR,
                    ModelStandardTransform.TRANSFORM_LINEAR),
                2000, new ModelDestination(
                    new ModelIdentifier(&quot;lfo&quot;, &quot;delay2&quot;, instance)));
<span class="nc" id="L643">            connmap.put(extractKeys(connection), connection);</span>

<span class="nc bnc" id="L645" title="All 2 branches missed.">            final double scale = found_vib_connection == null ? 0</span>
<span class="nc" id="L646">                    : found_vib_connection.getScale();</span>
<span class="nc" id="L647">            connection = new ModelConnectionBlock(</span>
                new ModelSource(new ModelIdentifier(&quot;lfo&quot;, instance)),
                new ModelSource(new ModelIdentifier(&quot;midi_cc&quot;, &quot;77&quot;),
<span class="nc" id="L650">                    new ModelTransform() {</span>
<span class="nc" id="L651">                        double s = scale;</span>
                        public double transform(double value) {
<span class="nc" id="L653">                            value = value * 2 - 1;</span>
<span class="nc" id="L654">                            value *= 600;</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                            if (s == 0) {</span>
<span class="nc" id="L656">                                return value;</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                            } else if (s &gt; 0) {</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                                if (value &lt; -s)</span>
<span class="nc" id="L659">                                    value = -s;</span>
<span class="nc" id="L660">                                return value;</span>
                            } else {
<span class="nc bnc" id="L662" title="All 2 branches missed.">                                if (value &lt; s)</span>
<span class="nc" id="L663">                                    value = -s;</span>
<span class="nc" id="L664">                                return -value;</span>
                            }
                        }
                    }), new ModelDestination(ModelDestination.DESTINATION_PITCH));
<span class="nc" id="L668">            connmap.put(extractKeys(connection), connection);</span>

<span class="nc" id="L670">            connection = new ModelConnectionBlock(</span>
                new ModelSource(new ModelIdentifier(&quot;midi_cc&quot;, &quot;76&quot;),
                    ModelStandardTransform.DIRECTION_MIN2MAX,
                    ModelStandardTransform.POLARITY_BIPOLAR,
                    ModelStandardTransform.TRANSFORM_LINEAR),
                2400, new ModelDestination(
                    new ModelIdentifier(&quot;lfo&quot;, &quot;freq&quot;, instance)));
<span class="nc" id="L677">            connmap.put(extractKeys(connection), connection);</span>

        }

        // Add default connection blocks
<span class="nc bnc" id="L682" title="All 2 branches missed.">        if (performer.isDefaultConnectionsEnabled())</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">            for (ModelConnectionBlock connection : defaultconnections)</span>
<span class="nc" id="L684">                connmap.put(extractKeys(connection), connection);</span>
        // Add connection blocks from modelperformer
<span class="nc bnc" id="L686" title="All 2 branches missed.">        for (ModelConnectionBlock connection : performer_connections)</span>
<span class="nc" id="L687">            connmap.put(extractKeys(connection), connection);</span>
        // seperate connection blocks : Init time, Midi Time, Midi/Control Time,
        // Control Time
<span class="nc" id="L690">        List&lt;ModelConnectionBlock&gt; connections = new ArrayList&lt;ModelConnectionBlock&gt;();</span>

<span class="nc" id="L692">        midi_ctrl_connections = new int[128][];</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">        for (int i = 0; i &lt; midi_ctrl_connections.length; i++) {</span>
<span class="nc" id="L694">            midi_ctrl_connections[i] = null;</span>
        }
<span class="nc" id="L696">        midi_connections = new int[5][];</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">        for (int i = 0; i &lt; midi_connections.length; i++) {</span>
<span class="nc" id="L698">            midi_connections[i] = null;</span>
        }

<span class="nc" id="L701">        int ix = 0;</span>
<span class="nc" id="L702">        boolean mustBeOnTop = false;</span>

<span class="nc bnc" id="L704" title="All 2 branches missed.">        for (ModelConnectionBlock connection : connmap.values()) {</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">            if (connection.getDestination() != null) {</span>
<span class="nc" id="L706">                ModelDestination dest = connection.getDestination();</span>
<span class="nc" id="L707">                ModelIdentifier id = dest.getIdentifier();</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                if (id.getObject().equals(&quot;noteon&quot;)) {</span>
<span class="nc" id="L709">                    mustBeOnTop = true;</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                    if (id.getVariable().equals(&quot;keynumber&quot;))</span>
<span class="nc" id="L711">                        forcedKeynumber = true;</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                    if (id.getVariable().equals(&quot;velocity&quot;))</span>
<span class="nc" id="L713">                        forcedVelocity = true;</span>
                }
            }
<span class="nc bnc" id="L716" title="All 2 branches missed.">            if (mustBeOnTop) {</span>
<span class="nc" id="L717">                connections.add(0, connection);</span>
<span class="nc" id="L718">                mustBeOnTop = false;</span>
            } else
<span class="nc" id="L720">                connections.add(connection);</span>
<span class="nc" id="L721">        }</span>

<span class="nc bnc" id="L723" title="All 2 branches missed.">        for (ModelConnectionBlock connection : connections) {</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">            if (connection.getSources() != null) {</span>
<span class="nc" id="L725">                ModelSource[] srcs = connection.getSources();</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">                for (int i = 0; i &lt; srcs.length; i++) {</span>
<span class="nc" id="L727">                    processSource(srcs[i], ix);</span>
                }
            }
<span class="nc" id="L730">            ix++;</span>
<span class="nc" id="L731">        }</span>

<span class="nc" id="L733">        this.connections = new ModelConnectionBlock[connections.size()];</span>
<span class="nc" id="L734">        connections.toArray(this.connections);</span>

<span class="nc" id="L736">        this.ctrl_connections = new int[ctrl_connections_list.size()];</span>

<span class="nc bnc" id="L738" title="All 2 branches missed.">        for (int i = 0; i &lt; this.ctrl_connections.length; i++)</span>
<span class="nc" id="L739">            this.ctrl_connections[i] = ctrl_connections_list.get(i);</span>

<span class="nc" id="L741">        oscillators = new ModelOscillator[performer.getOscillators().size()];</span>
<span class="nc" id="L742">        performer.getOscillators().toArray(oscillators);</span>

<span class="nc bnc" id="L744" title="All 2 branches missed.">        for (ModelConnectionBlock conn : connections) {</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">            if (conn.getDestination() != null) {</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">                if (isUnnecessaryTransform(conn.getDestination().getTransform())) {</span>
<span class="nc" id="L747">                    conn.getDestination().setTransform(null);</span>
                }
            }
<span class="nc bnc" id="L750" title="All 2 branches missed.">            if (conn.getSources() != null) {</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">                for (ModelSource src : conn.getSources()) {</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">                    if (isUnnecessaryTransform(src.getTransform())) {</span>
<span class="nc" id="L753">                        src.setTransform(null);</span>
                    }
                }
            }
<span class="nc" id="L757">        }</span>

<span class="nc" id="L759">    }</span>

    private static boolean isUnnecessaryTransform(ModelTransform transform) {
<span class="nc bnc" id="L762" title="All 2 branches missed.">        if (transform == null)</span>
<span class="nc" id="L763">            return false;</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">        if (!(transform instanceof ModelStandardTransform))</span>
<span class="nc" id="L765">            return false;</span>
<span class="nc" id="L766">        ModelStandardTransform stransform = (ModelStandardTransform)transform;</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">        if (stransform.getDirection() != ModelStandardTransform.DIRECTION_MIN2MAX)</span>
<span class="nc" id="L768">            return false;</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">        if (stransform.getPolarity() != ModelStandardTransform.POLARITY_UNIPOLAR)</span>
<span class="nc" id="L770">            return false;</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">        if (stransform.getTransform() != ModelStandardTransform.TRANSFORM_LINEAR)</span>
<span class="nc" id="L772">            return false;</span>
<span class="nc" id="L773">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>