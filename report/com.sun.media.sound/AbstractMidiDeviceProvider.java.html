<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>AbstractMidiDeviceProvider.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">AbstractMidiDeviceProvider.java</span></div><h1>AbstractMidiDeviceProvider.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2002, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.media.sound;

import javax.sound.midi.MidiDevice;
import javax.sound.midi.spi.MidiDeviceProvider;


/**
 * Super class for MIDI input or output device provider.
 *
 * @author Florian Bomers
 */
<span class="nc" id="L37">public abstract class AbstractMidiDeviceProvider extends MidiDeviceProvider {</span>

    private static final boolean enabled;

    /**
     * Create objects representing all MIDI output devices on the system.
     */
    static {
        if (Printer.trace) Printer.trace(&quot;AbstractMidiDeviceProvider: static&quot;);
<span class="nc" id="L46">        Platform.initialize();</span>
<span class="nc" id="L47">        enabled = Platform.isMidiIOEnabled();</span>
        if (Printer.trace) Printer.trace(&quot;AbstractMidiDeviceProvider: enabled: &quot; + enabled);

        // $$fb number of MIDI devices may change with time
        // also for memory's sake, do not initialize the arrays here
<span class="nc" id="L52">    }</span>


    final synchronized void readDeviceInfos() {
<span class="nc" id="L56">        Info[] infos = getInfoCache();</span>
<span class="nc" id="L57">        MidiDevice[] devices = getDeviceCache();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (!enabled) {</span>
<span class="nc bnc" id="L59" title="All 4 branches missed.">            if (infos == null || infos.length != 0) {</span>
<span class="nc" id="L60">                setInfoCache(new Info[0]);</span>
            }
<span class="nc bnc" id="L62" title="All 4 branches missed.">            if (devices == null || devices.length != 0) {</span>
<span class="nc" id="L63">                setDeviceCache(new MidiDevice[0]);</span>
            }
<span class="nc" id="L65">            return;</span>
        }

<span class="nc bnc" id="L68" title="All 2 branches missed.">        int oldNumDevices = (infos==null)?-1:infos.length;</span>
<span class="nc" id="L69">        int newNumDevices = getNumDevices();</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (oldNumDevices != newNumDevices) {</span>
            if (Printer.trace) Printer.trace(getClass().toString()
                                             +&quot;: readDeviceInfos: old numDevices: &quot;+oldNumDevices
                                             +&quot;  newNumDevices: &quot;+ newNumDevices);

            // initialize the arrays
<span class="nc" id="L76">            Info[] newInfos = new Info[newNumDevices];</span>
<span class="nc" id="L77">            MidiDevice[] newDevices = new MidiDevice[newNumDevices];</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">            for (int i = 0; i &lt; newNumDevices; i++) {</span>
<span class="nc" id="L80">                Info newInfo = createInfo(i);</span>

                // in case that we are re-reading devices, try to find
                // the previous one and reuse it
<span class="nc bnc" id="L84" title="All 2 branches missed.">                if (infos != null) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    for (int ii = 0; ii &lt; infos.length; ii++) {</span>
<span class="nc" id="L86">                        Info info = infos[ii];</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">                        if (info != null &amp;&amp; info.equalStrings(newInfo)) {</span>
                            // new info matches the still existing info. Use old one
<span class="nc" id="L89">                            newInfos[i] = info;</span>
<span class="nc" id="L90">                            info.setIndex(i);</span>
<span class="nc" id="L91">                            infos[ii] = null; // prevent re-use</span>
<span class="nc" id="L92">                            newDevices[i] = devices[ii];</span>
<span class="nc" id="L93">                            devices[ii] = null;</span>
<span class="nc" id="L94">                            break;</span>
                        }
                    }
                }
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (newInfos[i] == null) {</span>
<span class="nc" id="L99">                    newInfos[i] = newInfo;</span>
                }
            }
            // the remaining MidiDevice.Info instances in the infos array
            // have become obsolete.
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (infos != null) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                for (int i = 0; i &lt; infos.length; i++) {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                    if (infos[i] != null) {</span>
                        // disable this device info
<span class="nc" id="L108">                        infos[i].setIndex(-1);</span>
                    }
                    // what to do with the MidiDevice instances that are left
                    // in the devices array ?? Close them ?
                }
            }
            // commit new list of infos.
<span class="nc" id="L115">            setInfoCache(newInfos);</span>
<span class="nc" id="L116">            setDeviceCache(newDevices);</span>
        }
<span class="nc" id="L118">    }</span>


    public final MidiDevice.Info[] getDeviceInfo() {
<span class="nc" id="L122">        readDeviceInfos();</span>
<span class="nc" id="L123">        Info[] infos = getInfoCache();</span>
<span class="nc" id="L124">        MidiDevice.Info[] localArray = new MidiDevice.Info[infos.length];</span>
<span class="nc" id="L125">        System.arraycopy(infos, 0, localArray, 0, infos.length);</span>
<span class="nc" id="L126">        return localArray;</span>
    }


    public final MidiDevice getDevice(MidiDevice.Info info) {
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (info instanceof Info) {</span>
<span class="nc" id="L132">            readDeviceInfos();</span>
<span class="nc" id="L133">            MidiDevice[] devices = getDeviceCache();</span>
<span class="nc" id="L134">            Info[] infos = getInfoCache();</span>
<span class="nc" id="L135">            Info thisInfo = (Info) info;</span>
<span class="nc" id="L136">            int index = thisInfo.getIndex();</span>
<span class="nc bnc" id="L137" title="All 6 branches missed.">            if (index &gt;= 0 &amp;&amp; index &lt; devices.length &amp;&amp; infos[index] == info) {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                if (devices[index] == null) {</span>
<span class="nc" id="L139">                    devices[index] = createDevice(thisInfo);</span>
                }
<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (devices[index] != null) {</span>
<span class="nc" id="L142">                    return devices[index];</span>
                }
            }
        }

<span class="nc" id="L147">        throw new IllegalArgumentException(&quot;MidiDevice &quot; + info.toString()</span>
                                           + &quot; not supported by this provider.&quot;);
    }


    // INNER CLASSES


    /**
     * Info class for MidiDevices.  Adds an index value for
     * making native references to a particular device.
     */
<span class="nc" id="L159">    static class Info extends MidiDevice.Info {</span>
        private int index;

        Info(String name, String vendor, String description, String version, int index) {
<span class="nc" id="L163">            super(name, vendor, description, version);</span>
<span class="nc" id="L164">            this.index = index;</span>
<span class="nc" id="L165">        }</span>

        final boolean equalStrings(Info info) {
<span class="nc bnc" id="L168" title="All 2 branches missed.">            return      (info != null</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                         &amp;&amp; getName().equals(info.getName())</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                         &amp;&amp; getVendor().equals(info.getVendor())</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                         &amp;&amp; getDescription().equals(info.getDescription())</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                         &amp;&amp; getVersion().equals(info.getVersion()));</span>
        }

        final int getIndex() {
<span class="nc" id="L176">            return index;</span>
        }

        final void setIndex(int index) {
<span class="nc" id="L180">            this.index = index;</span>
<span class="nc" id="L181">        }</span>

    } // class Info


    // ABSTRACT METHODS

    abstract int getNumDevices();
    abstract MidiDevice[] getDeviceCache();
    abstract void setDeviceCache(MidiDevice[] devices);
    abstract Info[] getInfoCache();
    abstract void setInfoCache(Info[] infos);

    abstract Info createInfo(int index);
    abstract MidiDevice createDevice(Info info);
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>