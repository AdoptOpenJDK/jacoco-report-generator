<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JDK13Services.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">JDK13Services.java</span></div><h1>JDK13Services.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.media.sound;

import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Properties;

import javax.sound.midi.Receiver;
import javax.sound.midi.Sequencer;
import javax.sound.midi.Synthesizer;
import javax.sound.midi.Transmitter;
import javax.sound.sampled.Clip;
import javax.sound.sampled.Port;
import javax.sound.sampled.SourceDataLine;
import javax.sound.sampled.TargetDataLine;


/**
 * JDK13Services uses the Service class in JDK 1.3
 * to discover a list of service providers installed
 * in the system.
 *
 * This class is public because it is called from javax.sound.midi.MidiSystem
 * and javax.sound.sampled.AudioSystem. The alternative would be to make
 * JSSecurityManager public, which is considered worse.
 *
 * @author Matthias Pfisterer
 */
public final class JDK13Services {

    /** The default for the length of the period to hold the cache.
        This value is given in milliseconds. It is equivalent to
        1 minute.
    */
    private static final long DEFAULT_CACHING_PERIOD = 60000;

    /** Filename of the properties file for default provider properties.
        This file is searched in the subdirectory &quot;lib&quot; of the JRE directory
        (this behaviour is hardcoded).
    */
    private static final String PROPERTIES_FILENAME = &quot;sound.properties&quot;;

    /** Cache for the providers.
        Class objects of the provider type (MixerProvider, MidiDeviceProvider
        ...) are used as keys. The values are instances of ProviderCache.
    */
<span class="nc" id="L73">    private static final Map providersCacheMap = new HashMap();</span>


    /** The length of the period to hold the cache.
        This value is given in milliseconds.
    */
<span class="nc" id="L79">    private static long cachingPeriod = DEFAULT_CACHING_PERIOD;</span>

    /** Properties loaded from the properties file for default provider
        properties.
    */
    private static Properties properties;


    /** Private, no-args constructor to ensure against instantiation.
     */
<span class="nc" id="L89">    private JDK13Services() {</span>
<span class="nc" id="L90">    }</span>


    /** Set the period provider lists are cached.
        This method is only intended for testing.
     */
    public static void setCachingPeriod(int seconds) {
<span class="nc" id="L97">        cachingPeriod = seconds * 1000L;</span>
<span class="nc" id="L98">    }</span>


    /** Obtains a List containing installed instances of the
        providers for the requested service.
        The List of providers is cached for the period of time given by
        {@link #cachingPeriod cachingPeriod}. During this period, the same
        List instance is returned for the same type of provider. After this
        period, a new instance is constructed and returned. The returned
        List is immutable.
        @param serviceClass The type of providers requested. This should be one
        of AudioFileReader.class, AudioFileWriter.class,
        FormatConversionProvider.class, MixerProvider.class,
        MidiDeviceProvider.class, MidiFileReader.class, MidiFileWriter.class or
        SoundbankReader.class.
        @return A List of providers of the requested type. This List is
        immutable.
     */
    public static synchronized List getProviders(Class serviceClass) {
<span class="nc" id="L117">        ProviderCache cache = (ProviderCache) providersCacheMap.get(serviceClass);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (cache == null) {</span>
<span class="nc" id="L119">            cache = new ProviderCache();</span>
<span class="nc" id="L120">            providersCacheMap.put(serviceClass, cache);</span>
        }
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (cache.providers == null ||</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            System.currentTimeMillis() &gt; cache.lastUpdate + cachingPeriod) {</span>
<span class="nc" id="L124">            cache.providers = Collections.unmodifiableList(JSSecurityManager.getProviders(serviceClass));</span>
<span class="nc" id="L125">            cache.lastUpdate = System.currentTimeMillis();</span>
        }
<span class="nc" id="L127">        return cache.providers;</span>
    }


    /** Obtain the provider class name part of a default provider property.
        @param typeClass The type of the default provider property. This
        should be one of Receiver.class, Transmitter.class, Sequencer.class,
        Synthesizer.class, SourceDataLine.class, TargetDataLine.class,
        Clip.class or Port.class.
        @return The value of the provider class name part of the property
        (the part before the hash sign), if available. If the property is
        not set or the value has no provider class name part, null is returned.
     */
    public static synchronized String getDefaultProviderClassName(Class typeClass) {
<span class="nc" id="L141">        String value = null;</span>
<span class="nc" id="L142">        String defaultProviderSpec = getDefaultProvider(typeClass);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (defaultProviderSpec != null) {</span>
<span class="nc" id="L144">            int hashpos = defaultProviderSpec.indexOf('#');</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (hashpos == 0) {</span>
                // instance name only; leave value as null
<span class="nc bnc" id="L147" title="All 2 branches missed.">            } else if (hashpos &gt; 0) {</span>
<span class="nc" id="L148">                value = defaultProviderSpec.substring(0, hashpos);</span>
            } else {
<span class="nc" id="L150">                value = defaultProviderSpec;</span>
            }
        }
<span class="nc" id="L153">        return value;</span>
    }


    /** Obtain the instance name part of a default provider property.
        @param typeClass The type of the default provider property. This
        should be one of Receiver.class, Transmitter.class, Sequencer.class,
        Synthesizer.class, SourceDataLine.class, TargetDataLine.class,
        Clip.class or Port.class.
        @return The value of the instance name part of the property (the
        part after the hash sign), if available. If the property is not set
        or the value has no instance name part, null is returned.
     */
    public static synchronized String getDefaultInstanceName(Class typeClass) {
<span class="nc" id="L167">        String value = null;</span>
<span class="nc" id="L168">        String defaultProviderSpec = getDefaultProvider(typeClass);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (defaultProviderSpec != null) {</span>
<span class="nc" id="L170">            int hashpos = defaultProviderSpec.indexOf('#');</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">            if (hashpos &gt;= 0 &amp;&amp; hashpos &lt; defaultProviderSpec.length() - 1) {</span>
<span class="nc" id="L172">                value = defaultProviderSpec.substring(hashpos + 1);</span>
            }
        }
<span class="nc" id="L175">        return value;</span>
    }


    /** Obtain the value of a default provider property.
        @param typeClass The type of the default provider property. This
        should be one of Receiver.class, Transmitter.class, Sequencer.class,
        Synthesizer.class, SourceDataLine.class, TargetDataLine.class,
        Clip.class or Port.class.
        @return The complete value of the property, if available.
        If the property is not set, null is returned.
     */
    private static synchronized String getDefaultProvider(Class typeClass) {
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (!SourceDataLine.class.equals(typeClass)</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                &amp;&amp; !TargetDataLine.class.equals(typeClass)</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                &amp;&amp; !Clip.class.equals(typeClass)</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                &amp;&amp; !Port.class.equals(typeClass)</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                &amp;&amp; !Receiver.class.equals(typeClass)</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                &amp;&amp; !Transmitter.class.equals(typeClass)</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                &amp;&amp; !Synthesizer.class.equals(typeClass)</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                &amp;&amp; !Sequencer.class.equals(typeClass)) {</span>
<span class="nc" id="L196">            return null;</span>
        }
        String value;
<span class="nc" id="L199">        String propertyName = typeClass.getName();</span>
<span class="nc" id="L200">        value = JSSecurityManager.getProperty(propertyName);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L202">            value = getProperties().getProperty(propertyName);</span>
        }
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (&quot;&quot;.equals(value)) {</span>
<span class="nc" id="L205">            value = null;</span>
        }
<span class="nc" id="L207">        return value;</span>
    }


    /** Obtain a properties bundle containing property values from the
        properties file. If the properties file could not be loaded,
        the properties bundle is empty.
    */
    private static synchronized Properties getProperties() {
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (properties == null) {</span>
<span class="nc" id="L217">            properties = new Properties();</span>
<span class="nc" id="L218">            JSSecurityManager.loadProperties(properties, PROPERTIES_FILENAME);</span>
        }
<span class="nc" id="L220">        return properties;</span>
    }

    // INNER CLASSES

<span class="nc" id="L225">    private static class ProviderCache {</span>
        // System time of the last update in milliseconds.
        public long lastUpdate;

        // The providers.
        public List providers;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>