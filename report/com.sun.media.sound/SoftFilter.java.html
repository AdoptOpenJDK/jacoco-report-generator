<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>SoftFilter.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.media.sound</a> &gt; <span class="el_source">SoftFilter.java</span></div><h1>SoftFilter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.media.sound;

/**
 * Infinite impulse response (IIR) filter class.
 *
 * The filters where implemented and adapted using algorithms from musicdsp.org
 * archive: 1-RC and C filter, Simple 2-pole LP LP and HP filter, biquad,
 * tweaked butterworth RBJ Audio-EQ-Cookbook, EQ filter kookbook
 *
 * @author Karl Helgason
 */
public final class SoftFilter {

    public final static int FILTERTYPE_LP6 = 0x00;
    public final static int FILTERTYPE_LP12 = 0x01;
    public final static int FILTERTYPE_HP12 = 0x11;
    public final static int FILTERTYPE_BP12 = 0x21;
    public final static int FILTERTYPE_NP12 = 0x31;
    public final static int FILTERTYPE_LP24 = 0x03;
    public final static int FILTERTYPE_HP24 = 0x13;

    //
    // 0x0 = 1st-order, 6 dB/oct
    // 0x1 = 2nd-order, 12 dB/oct
    // 0x2 = 3rd-order, 18 dB/oct
    // 0x3 = 4th-order, 24 db/oct
    //
    // 0x00 = LP, Low Pass Filter
    // 0x10 = HP, High Pass Filter
    // 0x20 = BP, Band Pass Filter
    // 0x30 = NP, Notch or Band Elimination Filter
    //
<span class="nc" id="L57">    private int filtertype = FILTERTYPE_LP6;</span>
    private final float samplerate;
    private float x1;
    private float x2;
    private float y1;
    private float y2;
    private float xx1;
    private float xx2;
    private float yy1;
    private float yy2;
    private float a0;
    private float a1;
    private float a2;
    private float b1;
    private float b2;
    private float q;
<span class="nc" id="L73">    private float gain = 1;</span>
<span class="nc" id="L74">    private float wet = 0;</span>
<span class="nc" id="L75">    private float last_wet = 0;</span>
    private float last_a0;
    private float last_a1;
    private float last_a2;
    private float last_b1;
    private float last_b2;
    private float last_q;
    private float last_gain;
<span class="nc" id="L83">    private boolean last_set = false;</span>
<span class="nc" id="L84">    private double cutoff = 44100;</span>
<span class="nc" id="L85">    private double resonancedB = 0;</span>
<span class="nc" id="L86">    private boolean dirty = true;</span>

<span class="nc" id="L88">    public SoftFilter(float samplerate) {</span>
<span class="nc" id="L89">        this.samplerate = samplerate;</span>
<span class="nc" id="L90">        dirty = true;</span>
<span class="nc" id="L91">    }</span>

    public void setFrequency(double cent) {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (cutoff == cent)</span>
<span class="nc" id="L95">            return;</span>
<span class="nc" id="L96">        cutoff = cent;</span>
<span class="nc" id="L97">        dirty = true;</span>
<span class="nc" id="L98">    }</span>

    public void setResonance(double db) {
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (resonancedB == db)</span>
<span class="nc" id="L102">            return;</span>
<span class="nc" id="L103">        resonancedB = db;</span>
<span class="nc" id="L104">        dirty = true;</span>
<span class="nc" id="L105">    }</span>

    public void reset() {
<span class="nc" id="L108">        dirty = true;</span>
<span class="nc" id="L109">        last_set = false;</span>
<span class="nc" id="L110">        x1 = 0;</span>
<span class="nc" id="L111">        x2 = 0;</span>
<span class="nc" id="L112">        y1 = 0;</span>
<span class="nc" id="L113">        y2 = 0;</span>
<span class="nc" id="L114">        xx1 = 0;</span>
<span class="nc" id="L115">        xx2 = 0;</span>
<span class="nc" id="L116">        yy1 = 0;</span>
<span class="nc" id="L117">        yy2 = 0;</span>
<span class="nc" id="L118">        wet = 0.0f;</span>
<span class="nc" id="L119">        gain = 1.0f;</span>
<span class="nc" id="L120">        a0 = 0;</span>
<span class="nc" id="L121">        a1 = 0;</span>
<span class="nc" id="L122">        a2 = 0;</span>
<span class="nc" id="L123">        b1 = 0;</span>
<span class="nc" id="L124">        b2 = 0;</span>
<span class="nc" id="L125">    }</span>

    public void setFilterType(int filtertype) {
<span class="nc" id="L128">        this.filtertype = filtertype;</span>
<span class="nc" id="L129">    }</span>

    public void processAudio(SoftAudioBuffer sbuffer) {
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (filtertype == FILTERTYPE_LP6)</span>
<span class="nc" id="L133">            filter1(sbuffer);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (filtertype == FILTERTYPE_LP12)</span>
<span class="nc" id="L135">            filter2(sbuffer);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (filtertype == FILTERTYPE_HP12)</span>
<span class="nc" id="L137">            filter2(sbuffer);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (filtertype == FILTERTYPE_BP12)</span>
<span class="nc" id="L139">            filter2(sbuffer);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (filtertype == FILTERTYPE_NP12)</span>
<span class="nc" id="L141">            filter2(sbuffer);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (filtertype == FILTERTYPE_LP24)</span>
<span class="nc" id="L143">            filter4(sbuffer);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (filtertype == FILTERTYPE_HP24)</span>
<span class="nc" id="L145">            filter4(sbuffer);</span>
<span class="nc" id="L146">    }</span>

    public void filter4(SoftAudioBuffer sbuffer) {

<span class="nc" id="L150">        float[] buffer = sbuffer.array();</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (dirty) {</span>
<span class="nc" id="L153">            filter2calc();</span>
<span class="nc" id="L154">            dirty = false;</span>
        }
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (!last_set) {</span>
<span class="nc" id="L157">            last_a0 = a0;</span>
<span class="nc" id="L158">            last_a1 = a1;</span>
<span class="nc" id="L159">            last_a2 = a2;</span>
<span class="nc" id="L160">            last_b1 = b1;</span>
<span class="nc" id="L161">            last_b2 = b2;</span>
<span class="nc" id="L162">            last_gain = gain;</span>
<span class="nc" id="L163">            last_wet = wet;</span>
<span class="nc" id="L164">            last_set = true;</span>
        }

<span class="nc bnc" id="L167" title="All 4 branches missed.">        if (wet &gt; 0 || last_wet &gt; 0) {</span>

<span class="nc" id="L169">            int len = buffer.length;</span>
<span class="nc" id="L170">            float a0 = this.last_a0;</span>
<span class="nc" id="L171">            float a1 = this.last_a1;</span>
<span class="nc" id="L172">            float a2 = this.last_a2;</span>
<span class="nc" id="L173">            float b1 = this.last_b1;</span>
<span class="nc" id="L174">            float b2 = this.last_b2;</span>
<span class="nc" id="L175">            float gain = this.last_gain;</span>
<span class="nc" id="L176">            float wet = this.last_wet;</span>
<span class="nc" id="L177">            float a0_delta = (this.a0 - this.last_a0) / len;</span>
<span class="nc" id="L178">            float a1_delta = (this.a1 - this.last_a1) / len;</span>
<span class="nc" id="L179">            float a2_delta = (this.a2 - this.last_a2) / len;</span>
<span class="nc" id="L180">            float b1_delta = (this.b1 - this.last_b1) / len;</span>
<span class="nc" id="L181">            float b2_delta = (this.b2 - this.last_b2) / len;</span>
<span class="nc" id="L182">            float gain_delta = (this.gain - this.last_gain) / len;</span>
<span class="nc" id="L183">            float wet_delta = (this.wet - this.last_wet) / len;</span>
<span class="nc" id="L184">            float x1 = this.x1;</span>
<span class="nc" id="L185">            float x2 = this.x2;</span>
<span class="nc" id="L186">            float y1 = this.y1;</span>
<span class="nc" id="L187">            float y2 = this.y2;</span>
<span class="nc" id="L188">            float xx1 = this.xx1;</span>
<span class="nc" id="L189">            float xx2 = this.xx2;</span>
<span class="nc" id="L190">            float yy1 = this.yy1;</span>
<span class="nc" id="L191">            float yy2 = this.yy2;</span>

<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (wet_delta != 0) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L195">                    a0 += a0_delta;</span>
<span class="nc" id="L196">                    a1 += a1_delta;</span>
<span class="nc" id="L197">                    a2 += a2_delta;</span>
<span class="nc" id="L198">                    b1 += b1_delta;</span>
<span class="nc" id="L199">                    b2 += b2_delta;</span>
<span class="nc" id="L200">                    gain += gain_delta;</span>
<span class="nc" id="L201">                    wet += wet_delta;</span>
<span class="nc" id="L202">                    float x = buffer[i];</span>
<span class="nc" id="L203">                    float y = (a0*x + a1*x1 + a2*x2 - b1*y1 - b2*y2);</span>
<span class="nc" id="L204">                    float xx = (y * gain) * wet + (x) * (1 - wet);</span>
<span class="nc" id="L205">                    x2 = x1;</span>
<span class="nc" id="L206">                    x1 = x;</span>
<span class="nc" id="L207">                    y2 = y1;</span>
<span class="nc" id="L208">                    y1 = y;</span>
<span class="nc" id="L209">                    float yy = (a0*xx + a1*xx1 + a2*xx2 - b1*yy1 - b2*yy2);</span>
<span class="nc" id="L210">                    buffer[i] = (yy * gain) * wet + (xx) * (1 - wet);</span>
<span class="nc" id="L211">                    xx2 = xx1;</span>
<span class="nc" id="L212">                    xx1 = xx;</span>
<span class="nc" id="L213">                    yy2 = yy1;</span>
<span class="nc" id="L214">                    yy1 = yy;</span>
                }
<span class="nc bnc" id="L216" title="All 10 branches missed.">            } else if (a0_delta == 0 &amp;&amp; a1_delta == 0 &amp;&amp; a2_delta == 0</span>
                    &amp;&amp; b1_delta == 0 &amp;&amp; b2_delta == 0) {
<span class="nc bnc" id="L218" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L219">                    float x = buffer[i];</span>
<span class="nc" id="L220">                    float y = (a0*x + a1*x1 + a2*x2 - b1*y1 - b2*y2);</span>
<span class="nc" id="L221">                    float xx = (y * gain) * wet + (x) * (1 - wet);</span>
<span class="nc" id="L222">                    x2 = x1;</span>
<span class="nc" id="L223">                    x1 = x;</span>
<span class="nc" id="L224">                    y2 = y1;</span>
<span class="nc" id="L225">                    y1 = y;</span>
<span class="nc" id="L226">                    float yy = (a0*xx + a1*xx1 + a2*xx2 - b1*yy1 - b2*yy2);</span>
<span class="nc" id="L227">                    buffer[i] = (yy * gain) * wet + (xx) * (1 - wet);</span>
<span class="nc" id="L228">                    xx2 = xx1;</span>
<span class="nc" id="L229">                    xx1 = xx;</span>
<span class="nc" id="L230">                    yy2 = yy1;</span>
<span class="nc" id="L231">                    yy1 = yy;</span>
                }
            } else {
<span class="nc bnc" id="L234" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L235">                    a0 += a0_delta;</span>
<span class="nc" id="L236">                    a1 += a1_delta;</span>
<span class="nc" id="L237">                    a2 += a2_delta;</span>
<span class="nc" id="L238">                    b1 += b1_delta;</span>
<span class="nc" id="L239">                    b2 += b2_delta;</span>
<span class="nc" id="L240">                    gain += gain_delta;</span>
<span class="nc" id="L241">                    float x = buffer[i];</span>
<span class="nc" id="L242">                    float y = (a0*x + a1*x1 + a2*x2 - b1*y1 - b2*y2);</span>
<span class="nc" id="L243">                    float xx = (y * gain) * wet + (x) * (1 - wet);</span>
<span class="nc" id="L244">                    x2 = x1;</span>
<span class="nc" id="L245">                    x1 = x;</span>
<span class="nc" id="L246">                    y2 = y1;</span>
<span class="nc" id="L247">                    y1 = y;</span>
<span class="nc" id="L248">                    float yy = (a0*xx + a1*xx1 + a2*xx2 - b1*yy1 - b2*yy2);</span>
<span class="nc" id="L249">                    buffer[i] = (yy * gain) * wet + (xx) * (1 - wet);</span>
<span class="nc" id="L250">                    xx2 = xx1;</span>
<span class="nc" id="L251">                    xx1 = xx;</span>
<span class="nc" id="L252">                    yy2 = yy1;</span>
<span class="nc" id="L253">                    yy1 = yy;</span>
                }
            }

<span class="nc bnc" id="L257" title="All 2 branches missed.">            if (Math.abs(x1) &lt; 1.0E-8)</span>
<span class="nc" id="L258">                x1 = 0;</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">            if (Math.abs(x2) &lt; 1.0E-8)</span>
<span class="nc" id="L260">                x2 = 0;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (Math.abs(y1) &lt; 1.0E-8)</span>
<span class="nc" id="L262">                y1 = 0;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (Math.abs(y2) &lt; 1.0E-8)</span>
<span class="nc" id="L264">                y2 = 0;</span>
<span class="nc" id="L265">            this.x1 = x1;</span>
<span class="nc" id="L266">            this.x2 = x2;</span>
<span class="nc" id="L267">            this.y1 = y1;</span>
<span class="nc" id="L268">            this.y2 = y2;</span>
<span class="nc" id="L269">            this.xx1 = xx1;</span>
<span class="nc" id="L270">            this.xx2 = xx2;</span>
<span class="nc" id="L271">            this.yy1 = yy1;</span>
<span class="nc" id="L272">            this.yy2 = yy2;</span>
        }

<span class="nc" id="L275">        this.last_a0 = this.a0;</span>
<span class="nc" id="L276">        this.last_a1 = this.a1;</span>
<span class="nc" id="L277">        this.last_a2 = this.a2;</span>
<span class="nc" id="L278">        this.last_b1 = this.b1;</span>
<span class="nc" id="L279">        this.last_b2 = this.b2;</span>
<span class="nc" id="L280">        this.last_gain = this.gain;</span>
<span class="nc" id="L281">        this.last_wet = this.wet;</span>

<span class="nc" id="L283">    }</span>

    private double sinh(double x) {
<span class="nc" id="L286">        return (Math.exp(x) - Math.exp(-x)) * 0.5;</span>
    }

    public void filter2calc() {

<span class="nc" id="L291">        double resonancedB = this.resonancedB;</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (resonancedB &lt; 0)</span>
<span class="nc" id="L293">            resonancedB = 0;    // Negative dB are illegal.</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (resonancedB &gt; 30)</span>
<span class="nc" id="L295">            resonancedB = 30;   // At least 22.5 dB is needed.</span>
<span class="nc bnc" id="L296" title="All 4 branches missed.">        if (filtertype == FILTERTYPE_LP24 || filtertype == FILTERTYPE_HP24)</span>
<span class="nc" id="L297">            resonancedB *= 0.6;</span>

<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (filtertype == FILTERTYPE_BP12) {</span>
<span class="nc" id="L300">            wet = 1;</span>
<span class="nc" id="L301">            double r = (cutoff / samplerate);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            if (r &gt; 0.45)</span>
<span class="nc" id="L303">                r = 0.45;</span>

<span class="nc" id="L305">            double bandwidth = Math.PI * Math.pow(10.0, -(resonancedB / 20));</span>

<span class="nc" id="L307">            double omega = 2 * Math.PI * r;</span>
<span class="nc" id="L308">            double cs = Math.cos(omega);</span>
<span class="nc" id="L309">            double sn = Math.sin(omega);</span>
<span class="nc" id="L310">            double alpha = sn * sinh((Math.log(2)*bandwidth*omega) / (sn * 2));</span>

<span class="nc" id="L312">            double b0 = alpha;</span>
<span class="nc" id="L313">            double b1 = 0;</span>
<span class="nc" id="L314">            double b2 = -alpha;</span>
<span class="nc" id="L315">            double a0 = 1 + alpha;</span>
<span class="nc" id="L316">            double a1 = -2 * cs;</span>
<span class="nc" id="L317">            double a2 = 1 - alpha;</span>

<span class="nc" id="L319">            double cf = 1.0 / a0;</span>
<span class="nc" id="L320">            this.b1 = (float) (a1 * cf);</span>
<span class="nc" id="L321">            this.b2 = (float) (a2 * cf);</span>
<span class="nc" id="L322">            this.a0 = (float) (b0 * cf);</span>
<span class="nc" id="L323">            this.a1 = (float) (b1 * cf);</span>
<span class="nc" id="L324">            this.a2 = (float) (b2 * cf);</span>
        }

<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (filtertype == FILTERTYPE_NP12) {</span>
<span class="nc" id="L328">            wet = 1;</span>
<span class="nc" id="L329">            double r = (cutoff / samplerate);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if (r &gt; 0.45)</span>
<span class="nc" id="L331">                r = 0.45;</span>

<span class="nc" id="L333">            double bandwidth = Math.PI * Math.pow(10.0, -(resonancedB / 20));</span>

<span class="nc" id="L335">            double omega = 2 * Math.PI * r;</span>
<span class="nc" id="L336">            double cs = Math.cos(omega);</span>
<span class="nc" id="L337">            double sn = Math.sin(omega);</span>
<span class="nc" id="L338">            double alpha = sn * sinh((Math.log(2)*bandwidth*omega) / (sn*2));</span>

<span class="nc" id="L340">            double b0 = 1;</span>
<span class="nc" id="L341">            double b1 = -2 * cs;</span>
<span class="nc" id="L342">            double b2 = 1;</span>
<span class="nc" id="L343">            double a0 = 1 + alpha;</span>
<span class="nc" id="L344">            double a1 = -2 * cs;</span>
<span class="nc" id="L345">            double a2 = 1 - alpha;</span>

<span class="nc" id="L347">            double cf = 1.0 / a0;</span>
<span class="nc" id="L348">            this.b1 = (float)(a1 * cf);</span>
<span class="nc" id="L349">            this.b2 = (float)(a2 * cf);</span>
<span class="nc" id="L350">            this.a0 = (float)(b0 * cf);</span>
<span class="nc" id="L351">            this.a1 = (float)(b1 * cf);</span>
<span class="nc" id="L352">            this.a2 = (float)(b2 * cf);</span>
        }

<span class="nc bnc" id="L355" title="All 4 branches missed.">        if (filtertype == FILTERTYPE_LP12 || filtertype == FILTERTYPE_LP24) {</span>
<span class="nc" id="L356">            double r = (cutoff / samplerate);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            if (r &gt; 0.45) {</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">                if (wet == 0) {</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                    if (resonancedB &lt; 0.00001)</span>
<span class="nc" id="L360">                        wet = 0.0f;</span>
                    else
<span class="nc" id="L362">                        wet = 1.0f;</span>
                }
<span class="nc" id="L364">                r = 0.45;</span>
            } else
<span class="nc" id="L366">                wet = 1.0f;</span>

<span class="nc" id="L368">            double c = 1.0 / (Math.tan(Math.PI * r));</span>
<span class="nc" id="L369">            double csq = c * c;</span>
<span class="nc" id="L370">            double resonance = Math.pow(10.0, -(resonancedB / 20));</span>
<span class="nc" id="L371">            double q = Math.sqrt(2.0f) * resonance;</span>
<span class="nc" id="L372">            double a0 = 1.0 / (1.0 + (q * c) + (csq));</span>
<span class="nc" id="L373">            double a1 = 2.0 * a0;</span>
<span class="nc" id="L374">            double a2 = a0;</span>
<span class="nc" id="L375">            double b1 = (2.0 * a0) * (1.0 - csq);</span>
<span class="nc" id="L376">            double b2 = a0 * (1.0 - (q * c) + csq);</span>

<span class="nc" id="L378">            this.a0 = (float)a0;</span>
<span class="nc" id="L379">            this.a1 = (float)a1;</span>
<span class="nc" id="L380">            this.a2 = (float)a2;</span>
<span class="nc" id="L381">            this.b1 = (float)b1;</span>
<span class="nc" id="L382">            this.b2 = (float)b2;</span>

        }

<span class="nc bnc" id="L386" title="All 4 branches missed.">        if (filtertype == FILTERTYPE_HP12 || filtertype == FILTERTYPE_HP24) {</span>
<span class="nc" id="L387">            double r = (cutoff / samplerate);</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">            if (r &gt; 0.45)</span>
<span class="nc" id="L389">                r = 0.45;</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">            if (r &lt; 0.0001)</span>
<span class="nc" id="L391">                r = 0.0001;</span>
<span class="nc" id="L392">            wet = 1.0f;</span>
<span class="nc" id="L393">            double c = (Math.tan(Math.PI * (r)));</span>
<span class="nc" id="L394">            double csq = c * c;</span>
<span class="nc" id="L395">            double resonance = Math.pow(10.0, -(resonancedB / 20));</span>
<span class="nc" id="L396">            double q = Math.sqrt(2.0f) * resonance;</span>
<span class="nc" id="L397">            double a0 = 1.0 / (1.0 + (q * c) + (csq));</span>
<span class="nc" id="L398">            double a1 = -2.0 * a0;</span>
<span class="nc" id="L399">            double a2 = a0;</span>
<span class="nc" id="L400">            double b1 = (2.0 * a0) * (csq - 1.0);</span>
<span class="nc" id="L401">            double b2 = a0 * (1.0 - (q * c) + csq);</span>

<span class="nc" id="L403">            this.a0 = (float)a0;</span>
<span class="nc" id="L404">            this.a1 = (float)a1;</span>
<span class="nc" id="L405">            this.a2 = (float)a2;</span>
<span class="nc" id="L406">            this.b1 = (float)b1;</span>
<span class="nc" id="L407">            this.b2 = (float)b2;</span>

        }

<span class="nc" id="L411">    }</span>

    public void filter2(SoftAudioBuffer sbuffer) {

<span class="nc" id="L415">        float[] buffer = sbuffer.array();</span>

<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (dirty) {</span>
<span class="nc" id="L418">            filter2calc();</span>
<span class="nc" id="L419">            dirty = false;</span>
        }
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (!last_set) {</span>
<span class="nc" id="L422">            last_a0 = a0;</span>
<span class="nc" id="L423">            last_a1 = a1;</span>
<span class="nc" id="L424">            last_a2 = a2;</span>
<span class="nc" id="L425">            last_b1 = b1;</span>
<span class="nc" id="L426">            last_b2 = b2;</span>
<span class="nc" id="L427">            last_q = q;</span>
<span class="nc" id="L428">            last_gain = gain;</span>
<span class="nc" id="L429">            last_wet = wet;</span>
<span class="nc" id="L430">            last_set = true;</span>
        }

<span class="nc bnc" id="L433" title="All 4 branches missed.">        if (wet &gt; 0 || last_wet &gt; 0) {</span>

<span class="nc" id="L435">            int len = buffer.length;</span>
<span class="nc" id="L436">            float a0 = this.last_a0;</span>
<span class="nc" id="L437">            float a1 = this.last_a1;</span>
<span class="nc" id="L438">            float a2 = this.last_a2;</span>
<span class="nc" id="L439">            float b1 = this.last_b1;</span>
<span class="nc" id="L440">            float b2 = this.last_b2;</span>
<span class="nc" id="L441">            float gain = this.last_gain;</span>
<span class="nc" id="L442">            float wet = this.last_wet;</span>
<span class="nc" id="L443">            float a0_delta = (this.a0 - this.last_a0) / len;</span>
<span class="nc" id="L444">            float a1_delta = (this.a1 - this.last_a1) / len;</span>
<span class="nc" id="L445">            float a2_delta = (this.a2 - this.last_a2) / len;</span>
<span class="nc" id="L446">            float b1_delta = (this.b1 - this.last_b1) / len;</span>
<span class="nc" id="L447">            float b2_delta = (this.b2 - this.last_b2) / len;</span>
<span class="nc" id="L448">            float gain_delta = (this.gain - this.last_gain) / len;</span>
<span class="nc" id="L449">            float wet_delta = (this.wet - this.last_wet) / len;</span>
<span class="nc" id="L450">            float x1 = this.x1;</span>
<span class="nc" id="L451">            float x2 = this.x2;</span>
<span class="nc" id="L452">            float y1 = this.y1;</span>
<span class="nc" id="L453">            float y2 = this.y2;</span>

<span class="nc bnc" id="L455" title="All 2 branches missed.">            if (wet_delta != 0) {</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L457">                    a0 += a0_delta;</span>
<span class="nc" id="L458">                    a1 += a1_delta;</span>
<span class="nc" id="L459">                    a2 += a2_delta;</span>
<span class="nc" id="L460">                    b1 += b1_delta;</span>
<span class="nc" id="L461">                    b2 += b2_delta;</span>
<span class="nc" id="L462">                    gain += gain_delta;</span>
<span class="nc" id="L463">                    wet += wet_delta;</span>
<span class="nc" id="L464">                    float x = buffer[i];</span>
<span class="nc" id="L465">                    float y = (a0*x + a1*x1 + a2*x2 - b1*y1 - b2*y2);</span>
<span class="nc" id="L466">                    buffer[i] = (y * gain) * wet + (x) * (1 - wet);</span>
<span class="nc" id="L467">                    x2 = x1;</span>
<span class="nc" id="L468">                    x1 = x;</span>
<span class="nc" id="L469">                    y2 = y1;</span>
<span class="nc" id="L470">                    y1 = y;</span>
                }
<span class="nc bnc" id="L472" title="All 10 branches missed.">            } else if (a0_delta == 0 &amp;&amp; a1_delta == 0 &amp;&amp; a2_delta == 0</span>
                    &amp;&amp; b1_delta == 0 &amp;&amp; b2_delta == 0) {
<span class="nc bnc" id="L474" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L475">                    float x = buffer[i];</span>
<span class="nc" id="L476">                    float y = (a0*x + a1*x1 + a2*x2 - b1*y1 - b2*y2);</span>
<span class="nc" id="L477">                    buffer[i] = y * gain;</span>
<span class="nc" id="L478">                    x2 = x1;</span>
<span class="nc" id="L479">                    x1 = x;</span>
<span class="nc" id="L480">                    y2 = y1;</span>
<span class="nc" id="L481">                    y1 = y;</span>
                }
            } else {
<span class="nc bnc" id="L484" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L485">                    a0 += a0_delta;</span>
<span class="nc" id="L486">                    a1 += a1_delta;</span>
<span class="nc" id="L487">                    a2 += a2_delta;</span>
<span class="nc" id="L488">                    b1 += b1_delta;</span>
<span class="nc" id="L489">                    b2 += b2_delta;</span>
<span class="nc" id="L490">                    gain += gain_delta;</span>
<span class="nc" id="L491">                    float x = buffer[i];</span>
<span class="nc" id="L492">                    float y = (a0*x + a1*x1 + a2*x2 - b1*y1 - b2*y2);</span>
<span class="nc" id="L493">                    buffer[i] = y * gain;</span>
<span class="nc" id="L494">                    x2 = x1;</span>
<span class="nc" id="L495">                    x1 = x;</span>
<span class="nc" id="L496">                    y2 = y1;</span>
<span class="nc" id="L497">                    y1 = y;</span>
                }
            }

<span class="nc bnc" id="L501" title="All 2 branches missed.">            if (Math.abs(x1) &lt; 1.0E-8)</span>
<span class="nc" id="L502">                x1 = 0;</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">            if (Math.abs(x2) &lt; 1.0E-8)</span>
<span class="nc" id="L504">                x2 = 0;</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">            if (Math.abs(y1) &lt; 1.0E-8)</span>
<span class="nc" id="L506">                y1 = 0;</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">            if (Math.abs(y2) &lt; 1.0E-8)</span>
<span class="nc" id="L508">                y2 = 0;</span>
<span class="nc" id="L509">            this.x1 = x1;</span>
<span class="nc" id="L510">            this.x2 = x2;</span>
<span class="nc" id="L511">            this.y1 = y1;</span>
<span class="nc" id="L512">            this.y2 = y2;</span>
        }

<span class="nc" id="L515">        this.last_a0 = this.a0;</span>
<span class="nc" id="L516">        this.last_a1 = this.a1;</span>
<span class="nc" id="L517">        this.last_a2 = this.a2;</span>
<span class="nc" id="L518">        this.last_b1 = this.b1;</span>
<span class="nc" id="L519">        this.last_b2 = this.b2;</span>
<span class="nc" id="L520">        this.last_q = this.q;</span>
<span class="nc" id="L521">        this.last_gain = this.gain;</span>
<span class="nc" id="L522">        this.last_wet = this.wet;</span>

<span class="nc" id="L524">    }</span>

    public void filter1calc() {
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (cutoff &lt; 120)</span>
<span class="nc" id="L528">            cutoff = 120;</span>
<span class="nc" id="L529">        double c = (7.0 / 6.0) * Math.PI * 2 * cutoff / samplerate;</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (c &gt; 1)</span>
<span class="nc" id="L531">            c = 1;</span>
<span class="nc" id="L532">        a0 = (float)(Math.sqrt(1 - Math.cos(c)) * Math.sqrt(0.5 * Math.PI));</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (resonancedB &lt; 0)</span>
<span class="nc" id="L534">            resonancedB = 0;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (resonancedB &gt; 20)</span>
<span class="nc" id="L536">            resonancedB = 20;</span>
<span class="nc" id="L537">        q = (float)(Math.sqrt(0.5) * Math.pow(10.0, -(resonancedB / 20)));</span>
<span class="nc" id="L538">        gain = (float)Math.pow(10, -((resonancedB)) / 40.0);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (wet == 0.0f)</span>
<span class="nc bnc" id="L540" title="All 4 branches missed.">            if (resonancedB &gt; 0.00001 || c &lt; 0.9999999)</span>
<span class="nc" id="L541">                wet = 1.0f;</span>
<span class="nc" id="L542">    }</span>

    public void filter1(SoftAudioBuffer sbuffer) {

<span class="nc bnc" id="L546" title="All 2 branches missed.">        if (dirty) {</span>
<span class="nc" id="L547">            filter1calc();</span>
<span class="nc" id="L548">            dirty = false;</span>
        }
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (!last_set) {</span>
<span class="nc" id="L551">            last_a0 = a0;</span>
<span class="nc" id="L552">            last_q = q;</span>
<span class="nc" id="L553">            last_gain = gain;</span>
<span class="nc" id="L554">            last_wet = wet;</span>
<span class="nc" id="L555">            last_set = true;</span>
        }

<span class="nc bnc" id="L558" title="All 4 branches missed.">        if (wet &gt; 0 || last_wet &gt; 0) {</span>

<span class="nc" id="L560">            float[] buffer = sbuffer.array();</span>
<span class="nc" id="L561">            int len = buffer.length;</span>
<span class="nc" id="L562">            float a0 = this.last_a0;</span>
<span class="nc" id="L563">            float q = this.last_q;</span>
<span class="nc" id="L564">            float gain = this.last_gain;</span>
<span class="nc" id="L565">            float wet = this.last_wet;</span>
<span class="nc" id="L566">            float a0_delta = (this.a0 - this.last_a0) / len;</span>
<span class="nc" id="L567">            float q_delta = (this.q - this.last_q) / len;</span>
<span class="nc" id="L568">            float gain_delta = (this.gain - this.last_gain) / len;</span>
<span class="nc" id="L569">            float wet_delta = (this.wet - this.last_wet) / len;</span>
<span class="nc" id="L570">            float y2 = this.y2;</span>
<span class="nc" id="L571">            float y1 = this.y1;</span>

<span class="nc bnc" id="L573" title="All 2 branches missed.">            if (wet_delta != 0) {</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L575">                    a0 += a0_delta;</span>
<span class="nc" id="L576">                    q += q_delta;</span>
<span class="nc" id="L577">                    gain += gain_delta;</span>
<span class="nc" id="L578">                    wet += wet_delta;</span>
<span class="nc" id="L579">                    float ga0 = (1 - q * a0);</span>
<span class="nc" id="L580">                    y1 = ga0 * y1 + (a0) * (buffer[i] - y2);</span>
<span class="nc" id="L581">                    y2 = ga0 * y2 + (a0) * y1;</span>
<span class="nc" id="L582">                    buffer[i] = y2 * gain * wet + buffer[i] * (1 - wet);</span>
                }
<span class="nc bnc" id="L584" title="All 4 branches missed.">            } else if (a0_delta == 0 &amp;&amp; q_delta == 0) {</span>
<span class="nc" id="L585">                float ga0 = (1 - q * a0);</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L587">                    y1 = ga0 * y1 + (a0) * (buffer[i] - y2);</span>
<span class="nc" id="L588">                    y2 = ga0 * y2 + (a0) * y1;</span>
<span class="nc" id="L589">                    buffer[i] = y2 * gain;</span>
                }
<span class="nc" id="L591">            } else {</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L593">                    a0 += a0_delta;</span>
<span class="nc" id="L594">                    q += q_delta;</span>
<span class="nc" id="L595">                    gain += gain_delta;</span>
<span class="nc" id="L596">                    float ga0 = (1 - q * a0);</span>
<span class="nc" id="L597">                    y1 = ga0 * y1 + (a0) * (buffer[i] - y2);</span>
<span class="nc" id="L598">                    y2 = ga0 * y2 + (a0) * y1;</span>
<span class="nc" id="L599">                    buffer[i] = y2 * gain;</span>
                }
            }

<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (Math.abs(y2) &lt; 1.0E-8)</span>
<span class="nc" id="L604">                y2 = 0;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">            if (Math.abs(y1) &lt; 1.0E-8)</span>
<span class="nc" id="L606">                y1 = 0;</span>
<span class="nc" id="L607">            this.y2 = y2;</span>
<span class="nc" id="L608">            this.y1 = y1;</span>
        }

<span class="nc" id="L611">        this.last_a0 = this.a0;</span>
<span class="nc" id="L612">        this.last_q = this.q;</span>
<span class="nc" id="L613">        this.last_gain = this.gain;</span>
<span class="nc" id="L614">        this.last_wet = this.wet;</span>
<span class="nc" id="L615">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>