<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>LdapCtxFactory.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.jndi.ldap</a> &gt; <span class="el_source">LdapCtxFactory.java</span></div><h1>LdapCtxFactory.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.jndi.ldap;

import java.util.Hashtable;
import java.util.Vector;
import java.util.Enumeration;

import javax.naming.*;
import javax.naming.directory.*;
import javax.naming.spi.ObjectFactory;
import javax.naming.spi.InitialContextFactory;
import javax.naming.ldap.Control;

import com.sun.jndi.url.ldap.ldapURLContextFactory;

<span class="fc" id="L40">final public class LdapCtxFactory implements ObjectFactory, InitialContextFactory {</span>
    /**
     * The type of each address in an LDAP reference.
     */
    public final static String ADDRESS_TYPE = &quot;URL&quot;;

    // ----------------- ObjectFactory interface --------------------

    public Object getObjectInstance(Object ref, Name name, Context nameCtx,
        Hashtable&lt;?,?&gt; env) throws Exception {

<span class="nc bnc" id="L51" title="All 2 branches missed.">        if (!isLdapRef(ref)) {</span>
<span class="nc" id="L52">            return null;</span>
        }
<span class="nc" id="L54">        ObjectFactory factory = new ldapURLContextFactory();</span>
<span class="nc" id="L55">        String[] urls = getURLs((Reference)ref);</span>
<span class="nc" id="L56">        return factory.getObjectInstance(urls, name, nameCtx, env);</span>
    }

    // ----------------- InitialContext interface  --------------------

    public Context getInitialContext(Hashtable&lt;?,?&gt; envprops)
        throws NamingException {

        try {
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">            String providerUrl = (envprops != null) ?</span>
<span class="pc" id="L66">                (String)envprops.get(Context.PROVIDER_URL) : null;</span>

            // If URL not in environment, use defaults
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">            if (providerUrl == null) {</span>
<span class="nc" id="L70">                return new LdapCtx(&quot;&quot;, LdapCtx.DEFAULT_HOST,</span>
                    LdapCtx.DEFAULT_PORT, envprops, false);
            }

            // Extract URL(s)
<span class="fc" id="L75">            String[] urls = LdapURL.fromList(providerUrl);</span>

<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            if (urls.length == 0) {</span>
<span class="nc" id="L78">                throw new ConfigurationException(Context.PROVIDER_URL +</span>
                    &quot; property does not contain a URL&quot;);
            }

            // Generate an LDAP context
<span class="fc" id="L83">            return getLdapCtxInstance(urls, envprops);</span>

<span class="nc" id="L85">        } catch (LdapReferralException e) {</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (envprops != null &amp;&amp;</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                &quot;throw&quot;.equals(envprops.get(Context.REFERRAL))) {</span>
<span class="nc" id="L89">                throw e;</span>
            }

<span class="nc bnc" id="L92" title="All 2 branches missed.">            Control[] bindCtls = (envprops != null)?</span>
<span class="nc" id="L93">                (Control[])envprops.get(LdapCtx.BIND_CONTROLS) : null;</span>

<span class="nc" id="L95">            return (LdapCtx)e.getReferralContext(envprops, bindCtls);</span>
        }
    }

    /**
     * Returns true if argument is an LDAP reference.
     */
    private static boolean isLdapRef(Object obj) {

<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!(obj instanceof Reference)) {</span>
<span class="nc" id="L105">            return false;</span>
        }
<span class="nc" id="L107">        String thisClassName = LdapCtxFactory.class.getName();</span>
<span class="nc" id="L108">        Reference ref = (Reference)obj;</span>

<span class="nc" id="L110">        return thisClassName.equals(ref.getFactoryClassName());</span>
    }

    /**
     * Returns the URLs contained within an LDAP reference.
     */
    private static String[] getURLs(Reference ref) throws NamingException {

<span class="nc" id="L118">        int size = 0;   // number of URLs</span>
<span class="nc" id="L119">        String[] urls = new String[ref.size()];</span>

<span class="nc" id="L121">        Enumeration&lt;RefAddr&gt; addrs = ref.getAll();</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        while (addrs.hasMoreElements()) {</span>
<span class="nc" id="L123">            RefAddr addr = addrs.nextElement();</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">            if ((addr instanceof StringRefAddr) &amp;&amp;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                addr.getType().equals(ADDRESS_TYPE)) {</span>

<span class="nc" id="L128">                urls[size++] = (String)addr.getContent();</span>
            }
<span class="nc" id="L130">        }</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (size == 0) {</span>
<span class="nc" id="L132">            throw (new ConfigurationException(</span>
                    &quot;Reference contains no valid addresses&quot;));
        }

        // Trim URL array down to size.
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (size == ref.size()) {</span>
<span class="nc" id="L138">            return urls;</span>
        }
<span class="nc" id="L140">        String[] urls2 = new String[size];</span>
<span class="nc" id="L141">        System.arraycopy(urls, 0, urls2, 0, size);</span>
<span class="nc" id="L142">        return urls2;</span>
    }

    // ------------ Utilities used by other classes ----------------

    public static DirContext getLdapCtxInstance(Object urlInfo, Hashtable&lt;?,?&gt; env)
            throws NamingException {

<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if (urlInfo instanceof String) {</span>
<span class="nc" id="L151">            return getUsingURL((String)urlInfo, env);</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        } else if (urlInfo instanceof String[]) {</span>
<span class="fc" id="L153">            return getUsingURLs((String[])urlInfo, env);</span>
        } else {
<span class="nc" id="L155">            throw new IllegalArgumentException(</span>
                &quot;argument must be an LDAP URL String or array of them&quot;);
        }
    }

    private static DirContext getUsingURL(String url, Hashtable&lt;?,?&gt; env)
            throws NamingException {
<span class="fc" id="L162">        DirContext ctx = null;</span>
<span class="fc" id="L163">        LdapURL ldapUrl = new LdapURL(url);</span>
<span class="fc" id="L164">        String dn = ldapUrl.getDN();</span>
<span class="fc" id="L165">        String host = ldapUrl.getHost();</span>
<span class="fc" id="L166">        int port = ldapUrl.getPort();</span>
        String[] hostports;
<span class="fc" id="L168">        String domainName = null;</span>

        // handle a URL with no hostport (ldap:/// or ldaps:///)
        // locate the LDAP service using the URL's distinguished name
<span class="pc bpc" id="L172" title="5 of 6 branches missed.">        if (host == null &amp;&amp;</span>
            port == -1 &amp;&amp;
            dn != null &amp;&amp;
<span class="nc bnc" id="L175" title="All 2 branches missed.">            (domainName = ServiceLocator.mapDnToDomainName(dn)) != null &amp;&amp;</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            (hostports = ServiceLocator.getLdapService(domainName, env))</span>
                != null) {
            // Generate new URLs that include the discovered hostports.
            // Reuse the original URL scheme.
<span class="nc" id="L180">            String scheme = ldapUrl.getScheme() + &quot;://&quot;;</span>
<span class="nc" id="L181">            String[] newUrls = new String[hostports.length];</span>
<span class="nc" id="L182">            String query = ldapUrl.getQuery();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            String urlSuffix = ldapUrl.getPath() + (query != null ? query : &quot;&quot;);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            for (int i = 0; i &lt; hostports.length; i++) {</span>
<span class="nc" id="L185">                newUrls[i] = scheme + hostports[i] + urlSuffix;</span>
            }
<span class="nc" id="L187">            ctx = getUsingURLs(newUrls, env);</span>
            // Associate the derived domain name with the context
<span class="nc" id="L189">            ((LdapCtx)ctx).setDomainName(domainName);</span>

<span class="nc" id="L191">        } else {</span>
<span class="fc" id="L192">            ctx = new LdapCtx(dn, host, port, env, ldapUrl.useSsl());</span>
            // Record the URL that created the context
<span class="fc" id="L194">            ((LdapCtx)ctx).setProviderUrl(url);</span>
        }
<span class="fc" id="L196">        return ctx;</span>
    }

    /*
     * Try each URL until one of them succeeds.
     * If all URLs fail, throw one of the exceptions arbitrarily.
     * Not pretty, but potentially more informative than returning null.
     */
    private static DirContext getUsingURLs(String[] urls, Hashtable&lt;?,?&gt; env)
            throws NamingException {
<span class="fc" id="L206">        NamingException ne = null;</span>
<span class="fc" id="L207">        DirContext ctx = null;</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">        for (int i = 0; i &lt; urls.length; i++) {</span>
            try {
<span class="fc" id="L210">                return getUsingURL(urls[i], env);</span>
<span class="nc" id="L211">            } catch (AuthenticationException e) {</span>
<span class="nc" id="L212">                throw e;</span>
<span class="fc" id="L213">            } catch (NamingException e) {</span>
<span class="fc" id="L214">                ne = e;</span>
            }
        }
<span class="fc" id="L217">        throw ne;</span>
    }

    /**
     * Used by Obj and obj/RemoteToAttrs too so must be public
     */
    public static Attribute createTypeNameAttr(Class&lt;?&gt; cl) {
<span class="nc" id="L224">        Vector&lt;String&gt; v = new Vector&lt;&gt;(10);</span>
<span class="nc" id="L225">        String[] types = getTypeNames(cl, v);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (types.length &gt; 0) {</span>
<span class="nc" id="L227">            BasicAttribute tAttr =</span>
                new BasicAttribute(Obj.JAVA_ATTRIBUTES[Obj.TYPENAME]);
<span class="nc bnc" id="L229" title="All 2 branches missed.">            for (int i = 0; i &lt; types.length; i++) {</span>
<span class="nc" id="L230">                tAttr.add(types[i]);</span>
            }
<span class="nc" id="L232">            return tAttr;</span>
        }
<span class="nc" id="L234">        return null;</span>
    }

    private static String[] getTypeNames(Class&lt;?&gt; currentClass, Vector&lt;String&gt; v) {

<span class="nc" id="L239">        getClassesAux(currentClass, v);</span>
<span class="nc" id="L240">        Class&lt;?&gt;[] members = currentClass.getInterfaces();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        for (int i = 0; i &lt; members.length; i++) {</span>
<span class="nc" id="L242">            getClassesAux(members[i], v);</span>
        }
<span class="nc" id="L244">        String[] ret = new String[v.size()];</span>
<span class="nc" id="L245">        int i = 0;</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">        for (String name : v) {</span>
<span class="nc" id="L248">            ret[i++] = name;</span>
<span class="nc" id="L249">        }</span>
<span class="nc" id="L250">        return ret;</span>
    }

    private static void getClassesAux(Class&lt;?&gt; currentClass, Vector&lt;String&gt; v) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (!v.contains(currentClass.getName())) {</span>
<span class="nc" id="L255">            v.addElement(currentClass.getName());</span>
        }
<span class="nc" id="L257">        currentClass = currentClass.getSuperclass();</span>

<span class="nc bnc" id="L259" title="All 2 branches missed.">        while (currentClass != null) {</span>
<span class="nc" id="L260">            getTypeNames(currentClass, v);</span>
<span class="nc" id="L261">            currentClass = currentClass.getSuperclass();</span>
        }
<span class="nc" id="L263">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>