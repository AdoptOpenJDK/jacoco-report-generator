<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>LdapURL.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.jndi.ldap</a> &gt; <span class="el_source">LdapURL.java</span></div><h1>LdapURL.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2002, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.jndi.ldap;

import javax.naming.*;
import javax.naming.directory.*;
import javax.naming.spi.*;
import java.net.URL;
import java.net.MalformedURLException;
import java.io.UnsupportedEncodingException;
import java.util.StringTokenizer;
import com.sun.jndi.toolkit.url.Uri;
import com.sun.jndi.toolkit.url.UrlUtil;

/*
 * Extract components of an LDAP URL.
 *
 * The format of an LDAP URL is defined in RFC 2255 as follows:
 *
 *     ldapurl    = scheme &quot;://&quot; [hostport] [&quot;/&quot;
 *                  [dn [&quot;?&quot; [attributes] [&quot;?&quot; [scope]
 *                  [&quot;?&quot; [filter] [&quot;?&quot; extensions]]]]]]
 *     scheme     = &quot;ldap&quot;
 *     attributes = attrdesc *(&quot;,&quot; attrdesc)
 *     scope      = &quot;base&quot; / &quot;one&quot; / &quot;sub&quot;
 *     dn         = distinguishedName from Section 3 of [1]
 *     hostport   = hostport from Section 5 of RFC 1738 [5]
 *     attrdesc   = AttributeDescription from Section 4.1.5 of [2]
 *     filter     = filter from Section 4 of [4]
 *     extensions = extension *(&quot;,&quot; extension)
 *     extension  = [&quot;!&quot;] extype [&quot;=&quot; exvalue]
 *     extype     = token / xtoken
 *     exvalue    = LDAPString from section 4.1.2 of [2]
 *     token      = oid from section 4.1 of [3]
 *     xtoken     = (&quot;X-&quot; / &quot;x-&quot;) token
 *
 * For example,
 *
 *     ldap://ldap.itd.umich.edu/o=University%20of%20Michigan,c=US
 *     ldap://host.com:6666/o=IMC,c=US??sub?(cn=Babs%20Jensen)
 *
 * This class also supports ldaps URLs.
 */

final public class LdapURL extends Uri {

<span class="fc" id="L70">    private boolean useSsl = false;</span>
<span class="fc" id="L71">    private String DN = null;</span>
<span class="fc" id="L72">    private String attributes = null;</span>
<span class="fc" id="L73">    private String scope = null;</span>
<span class="fc" id="L74">    private String filter = null;</span>
<span class="fc" id="L75">    private String extensions = null;</span>

    /**
     * Creates an LdapURL object from an LDAP URL string.
     */
    public LdapURL(String url) throws NamingException {

<span class="fc" id="L82">        super();</span>

        try {
<span class="fc" id="L85">            init(url); // scheme, host, port, path, query</span>
<span class="fc" id="L86">            useSsl = scheme.equalsIgnoreCase(&quot;ldaps&quot;);</span>

<span class="pc bpc" id="L88" title="3 of 4 branches missed.">            if (! (scheme.equalsIgnoreCase(&quot;ldap&quot;) || useSsl)) {</span>
<span class="nc" id="L89">                throw new MalformedURLException(&quot;Not an LDAP URL: &quot; + url);</span>
            }

<span class="fc" id="L92">            parsePathAndQuery(); // DN, attributes, scope, filter, extensions</span>

<span class="nc" id="L94">        } catch (MalformedURLException e) {</span>
<span class="nc" id="L95">            NamingException ne = new NamingException(&quot;Cannot parse url: &quot; + url);</span>
<span class="nc" id="L96">            ne.setRootCause(e);</span>
<span class="nc" id="L97">            throw ne;</span>
<span class="nc" id="L98">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L99">            NamingException ne = new NamingException(&quot;Cannot parse url: &quot; + url);</span>
<span class="nc" id="L100">            ne.setRootCause(e);</span>
<span class="nc" id="L101">            throw ne;</span>
<span class="fc" id="L102">        }</span>
<span class="fc" id="L103">    }</span>

    /**
     * Returns true if the URL is an LDAPS URL.
     */
    public boolean useSsl() {
<span class="fc" id="L109">        return useSsl;</span>
    }

    /**
     * Returns the LDAP URL's distinguished name.
     */
    public String getDN() {
<span class="fc" id="L116">        return DN;</span>
    }

    /**
     * Returns the LDAP URL's attributes.
     */
    public String getAttributes() {
<span class="nc" id="L123">        return attributes;</span>
    }

    /**
     * Returns the LDAP URL's scope.
     */
    public String getScope() {
<span class="nc" id="L130">        return scope;</span>
    }

    /**
     * Returns the LDAP URL's filter.
     */
    public String getFilter() {
<span class="nc" id="L137">        return filter;</span>
    }

    /**
     * Returns the LDAP URL's extensions.
     */
    public String getExtensions() {
<span class="nc" id="L144">        return extensions;</span>
    }

    /**
     * Given a space-separated list of LDAP URLs, returns an array of strings.
     */
    public static String[] fromList(String urlList) throws NamingException {

<span class="fc" id="L152">        String[] urls = new String[(urlList.length() + 1) / 2];</span>
<span class="fc" id="L153">        int i = 0;              // next available index in urls</span>
<span class="fc" id="L154">        StringTokenizer st = new StringTokenizer(urlList, &quot; &quot;);</span>

<span class="fc bfc" id="L156" title="All 2 branches covered.">        while (st.hasMoreTokens()) {</span>
<span class="fc" id="L157">            urls[i++] = st.nextToken();</span>
        }
<span class="fc" id="L159">        String[] trimmed = new String[i];</span>
<span class="fc" id="L160">        System.arraycopy(urls, 0, trimmed, 0, i);</span>
<span class="fc" id="L161">        return trimmed;</span>
    }

    /**
     * Derermines whether an LDAP URL has query components.
     */
    public static boolean hasQueryComponents(String url) {
<span class="nc bnc" id="L168" title="All 2 branches missed.">        return (url.lastIndexOf('?') != -1);</span>
    }

    /*
     * Assembles an LDAP or LDAPS URL string from its components.
     * If &quot;host&quot; is an IPv6 literal, it may optionally include delimiting
     * brackets.
     */
    static String toUrlString(String host, int port, String dn, boolean useSsl)
        {

        try {
<span class="nc bnc" id="L180" title="All 2 branches missed.">            String h = (host != null) ? host : &quot;&quot;;</span>
<span class="nc bnc" id="L181" title="All 4 branches missed.">            if ((h.indexOf(':') != -1) &amp;&amp; (h.charAt(0) != '[')) {</span>
<span class="nc" id="L182">                h = &quot;[&quot; + h + &quot;]&quot;;          // IPv6 literal</span>
            }
<span class="nc bnc" id="L184" title="All 2 branches missed.">            String p = (port != -1) ? (&quot;:&quot; + port) : &quot;&quot;;</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            String d = (dn != null) ? (&quot;/&quot; + UrlUtil.encode(dn, &quot;UTF8&quot;)) : &quot;&quot;;</span>

<span class="nc bnc" id="L187" title="All 2 branches missed.">            return useSsl ? &quot;ldaps://&quot; + h + p + d : &quot;ldap://&quot; + h + p + d;</span>
<span class="nc" id="L188">        } catch (UnsupportedEncodingException e) {</span>
            // UTF8 should always be supported
<span class="nc" id="L190">            throw new IllegalStateException(&quot;UTF-8 encoding unavailable&quot;);</span>
        }
    }

    /*
     * Parses the path and query components of an URL and sets this
     * object's fields accordingly.
     */
    private void parsePathAndQuery() throws MalformedURLException,
        UnsupportedEncodingException {

        // path begins with a '/' or is empty

<span class="fc bfc" id="L203" title="All 2 branches covered.">        if (path.equals(&quot;&quot;)) {</span>
<span class="fc" id="L204">            return;</span>
        }

<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        DN = path.startsWith(&quot;/&quot;) ? path.substring(1) : path;</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (DN.length() &gt; 0) {</span>
<span class="fc" id="L209">            DN = UrlUtil.decode(DN, &quot;UTF8&quot;);</span>
        }

        // query begins with a '?' or is null

<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        if (query == null) {</span>
<span class="fc" id="L215">            return;</span>
        }

<span class="nc" id="L218">        int qmark2 = query.indexOf('?', 1);</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (qmark2 &lt; 0) {</span>
<span class="nc" id="L221">            attributes = query.substring(1);</span>
<span class="nc" id="L222">            return;</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        } else if (qmark2 != 1) {</span>
<span class="nc" id="L224">            attributes = query.substring(1, qmark2);</span>
        }

<span class="nc" id="L227">        int qmark3 = query.indexOf('?', qmark2 + 1);</span>

<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (qmark3 &lt; 0) {</span>
<span class="nc" id="L230">            scope = query.substring(qmark2 + 1);</span>
<span class="nc" id="L231">            return;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">        } else if (qmark3 != qmark2 + 1) {</span>
<span class="nc" id="L233">            scope = query.substring(qmark2 + 1, qmark3);</span>
        }

<span class="nc" id="L236">        int qmark4 = query.indexOf('?', qmark3 + 1);</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (qmark4 &lt; 0) {</span>
<span class="nc" id="L239">            filter = query.substring(qmark3 + 1);</span>
        } else {
<span class="nc bnc" id="L241" title="All 2 branches missed.">            if (qmark4 != qmark3 + 1) {</span>
<span class="nc" id="L242">                filter = query.substring(qmark3 + 1, qmark4);</span>
            }
<span class="nc" id="L244">            extensions = query.substring(qmark4 + 1);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (extensions.length() &gt; 0) {</span>
<span class="nc" id="L246">                extensions = UrlUtil.decode(extensions, &quot;UTF8&quot;);</span>
            }
        }
<span class="nc bnc" id="L249" title="All 4 branches missed.">        if (filter != null &amp;&amp; filter.length() &gt; 0) {</span>
<span class="nc" id="L250">            filter = UrlUtil.decode(filter, &quot;UTF8&quot;);</span>
        }
<span class="nc" id="L252">    }</span>

/*
    public static void main(String[] args) throws Exception {

        LdapURL url = new LdapURL(args[0]);

        System.out.println(&quot;Example LDAP URL: &quot; + url.toString());
        System.out.println(&quot;  scheme: &quot; + url.getScheme());
        System.out.println(&quot;    host: &quot; + url.getHost());
        System.out.println(&quot;    port: &quot; + url.getPort());
        System.out.println(&quot;      DN: &quot; + url.getDN());
        System.out.println(&quot;   attrs: &quot; + url.getAttributes());
        System.out.println(&quot;   scope: &quot; + url.getScope());
        System.out.println(&quot;  filter: &quot; + url.getFilter());
        System.out.println(&quot;  extens: &quot; + url.getExtensions());
        System.out.println(&quot;&quot;);
    }
*/
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>