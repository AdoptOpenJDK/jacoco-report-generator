<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>LoopPipe.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.java2d.pipe</a> &gt; <span class="el_source">LoopPipe.java</span></div><h1>LoopPipe.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.java2d.pipe;

import java.awt.Font;
import java.awt.Shape;
import java.awt.BasicStroke;
import java.awt.Polygon;
import java.awt.geom.AffineTransform;
import java.awt.geom.PathIterator;
import java.awt.geom.RoundRectangle2D;
import java.awt.geom.Ellipse2D;
import java.awt.geom.Arc2D;
import java.awt.geom.IllegalPathStateException;
import java.awt.geom.Path2D;
import java.awt.font.GlyphVector;
import sun.java2d.SunGraphics2D;
import sun.java2d.SurfaceData;
import sun.java2d.loops.FontInfo;
import sun.java2d.loops.DrawPolygons;
import sun.java2d.loops.FillParallelogram;
import sun.java2d.loops.DrawParallelogram;
import sun.awt.SunHints;

<span class="nc" id="L48">public class LoopPipe</span>
    implements PixelDrawPipe,
               PixelFillPipe,
               ParallelogramPipe,
               ShapeDrawPipe,
               LoopBasedPipe
{
<span class="nc" id="L55">    final static RenderingEngine RenderEngine = RenderingEngine.getInstance();</span>

    public void drawLine(SunGraphics2D sg2d,
                         int x1, int y1, int x2, int y2)
    {
<span class="nc" id="L60">        int tX = sg2d.transX;</span>
<span class="nc" id="L61">        int tY = sg2d.transY;</span>
<span class="nc" id="L62">        sg2d.loops.drawLineLoop.DrawLine(sg2d, sg2d.getSurfaceData(),</span>
                                         x1 + tX, y1 + tY,
                                         x2 + tX, y2 + tY);
<span class="nc" id="L65">    }</span>

    public void drawRect(SunGraphics2D sg2d,
                         int x, int y, int width, int height)
    {
<span class="nc" id="L70">        sg2d.loops.drawRectLoop.DrawRect(sg2d, sg2d.getSurfaceData(),</span>
                                         x + sg2d.transX,
                                         y + sg2d.transY,
                                         width, height);
<span class="nc" id="L74">    }</span>

    public void drawRoundRect(SunGraphics2D sg2d,
                              int x, int y, int width, int height,
                              int arcWidth, int arcHeight)
    {
<span class="nc" id="L80">        sg2d.shapepipe.draw(sg2d,</span>
                            new RoundRectangle2D.Float(x, y, width, height,
                                                       arcWidth, arcHeight));
<span class="nc" id="L83">    }</span>

    public void drawOval(SunGraphics2D sg2d,
                         int x, int y, int width, int height)
    {
<span class="nc" id="L88">        sg2d.shapepipe.draw(sg2d, new Ellipse2D.Float(x, y, width, height));</span>
<span class="nc" id="L89">    }</span>

    public void drawArc(SunGraphics2D sg2d,
                        int x, int y, int width, int height,
                        int startAngle, int arcAngle)
    {
<span class="nc" id="L95">        sg2d.shapepipe.draw(sg2d, new Arc2D.Float(x, y, width, height,</span>
                                                  startAngle, arcAngle,
                                                  Arc2D.OPEN));
<span class="nc" id="L98">    }</span>

    public void drawPolyline(SunGraphics2D sg2d,
                             int xPoints[], int yPoints[],
                             int nPoints)
    {
<span class="nc" id="L104">        int nPointsArray[] = { nPoints };</span>
<span class="nc" id="L105">        sg2d.loops.drawPolygonsLoop.DrawPolygons(sg2d, sg2d.getSurfaceData(),</span>
                                                 xPoints, yPoints,
                                                 nPointsArray, 1,
                                                 sg2d.transX, sg2d.transY,
                                                 false);
<span class="nc" id="L110">    }</span>

    public void drawPolygon(SunGraphics2D sg2d,
                            int xPoints[], int yPoints[],
                            int nPoints)
    {
<span class="nc" id="L116">        int nPointsArray[] = { nPoints };</span>
<span class="nc" id="L117">        sg2d.loops.drawPolygonsLoop.DrawPolygons(sg2d, sg2d.getSurfaceData(),</span>
                                                 xPoints, yPoints,
                                                 nPointsArray, 1,
                                                 sg2d.transX, sg2d.transY,
                                                 true);
<span class="nc" id="L122">    }</span>

    public void fillRect(SunGraphics2D sg2d,
                         int x, int y, int width, int height)
    {
<span class="nc" id="L127">        sg2d.loops.fillRectLoop.FillRect(sg2d, sg2d.getSurfaceData(),</span>
                                         x + sg2d.transX,
                                         y + sg2d.transY,
                                         width, height);
<span class="nc" id="L131">    }</span>

    public void fillRoundRect(SunGraphics2D sg2d,
                              int x, int y, int width, int height,
                              int arcWidth, int arcHeight)
    {
<span class="nc" id="L137">        sg2d.shapepipe.fill(sg2d,</span>
                            new RoundRectangle2D.Float(x, y, width, height,
                                                       arcWidth, arcHeight));
<span class="nc" id="L140">    }</span>

    public void fillOval(SunGraphics2D sg2d,
                         int x, int y, int width, int height)
    {
<span class="nc" id="L145">        sg2d.shapepipe.fill(sg2d, new Ellipse2D.Float(x, y, width, height));</span>
<span class="nc" id="L146">    }</span>

    public void fillArc(SunGraphics2D sg2d,
                        int x, int y, int width, int height,
                        int startAngle, int arcAngle)
    {
<span class="nc" id="L152">        sg2d.shapepipe.fill(sg2d, new Arc2D.Float(x, y, width, height,</span>
                                                  startAngle, arcAngle,
                                                  Arc2D.PIE));
<span class="nc" id="L155">    }</span>

    public void fillPolygon(SunGraphics2D sg2d,
                            int xPoints[], int yPoints[],
                            int nPoints)
    {
<span class="nc" id="L161">        ShapeSpanIterator sr = getFillSSI(sg2d);</span>

        try {
<span class="nc" id="L164">            sr.setOutputArea(sg2d.getCompClip());</span>
<span class="nc" id="L165">            sr.appendPoly(xPoints, yPoints, nPoints, sg2d.transX, sg2d.transY);</span>
<span class="nc" id="L166">            fillSpans(sg2d, sr);</span>
        } finally {
<span class="nc" id="L168">            sr.dispose();</span>
<span class="nc" id="L169">        }</span>
<span class="nc" id="L170">    }</span>


    public void draw(SunGraphics2D sg2d, Shape s) {
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (sg2d.strokeState == SunGraphics2D.STROKE_THIN) {</span>
            Path2D.Float p2df;
            int transX;
            int transY;
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (sg2d.transformState &lt;= SunGraphics2D.TRANSFORM_INT_TRANSLATE) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (s instanceof Path2D.Float) {</span>
<span class="nc" id="L180">                    p2df = (Path2D.Float)s;</span>
                } else {
<span class="nc" id="L182">                    p2df = new Path2D.Float(s);</span>
                }
<span class="nc" id="L184">                transX = sg2d.transX;</span>
<span class="nc" id="L185">                transY = sg2d.transY;</span>
            } else {
<span class="nc" id="L187">                p2df = new Path2D.Float(s, sg2d.transform);</span>
<span class="nc" id="L188">                transX = 0;</span>
<span class="nc" id="L189">                transY = 0;</span>
            }
<span class="nc" id="L191">            sg2d.loops.drawPathLoop.DrawPath(sg2d, sg2d.getSurfaceData(),</span>
                                             transX, transY, p2df);
<span class="nc" id="L193">            return;</span>
        }

<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (sg2d.strokeState == SunGraphics2D.STROKE_CUSTOM) {</span>
<span class="nc" id="L197">            fill(sg2d, sg2d.stroke.createStrokedShape(s));</span>
<span class="nc" id="L198">            return;</span>
        }

<span class="nc" id="L201">        ShapeSpanIterator sr = getStrokeSpans(sg2d, s);</span>

        try {
<span class="nc" id="L204">            fillSpans(sg2d, sr);</span>
        } finally {
<span class="nc" id="L206">            sr.dispose();</span>
<span class="nc" id="L207">        }</span>
<span class="nc" id="L208">    }</span>

    /**
     * Return a ShapeSpanIterator instance that normalizes as
     * appropriate for a fill operation as per the settings in
     * the specified SunGraphics2D object.
     *
     * The ShapeSpanIterator will be newly constructed and ready
     * to start taking in geometry.
     *
     * Note that the caller is responsible for calling dispose()
     * on the returned ShapeSpanIterator inside a try/finally block:
     * &lt;pre&gt;
     *     ShapeSpanIterator ssi = LoopPipe.getFillSSI(sg2d);
     *     try {
     *         ssi.setOutputArea(clip);
     *         ssi.appendPath(...); // or appendPoly
     *         // iterate the spans from ssi and operate on them
     *     } finally {
     *         ssi.dispose();
     *     }
     * &lt;/pre&gt;
     */
    public static ShapeSpanIterator getFillSSI(SunGraphics2D sg2d) {
<span class="nc bnc" id="L232" title="All 4 branches missed.">        boolean adjust = ((sg2d.stroke instanceof BasicStroke) &amp;&amp;</span>
                          sg2d.strokeHint != SunHints.INTVAL_STROKE_PURE);
<span class="nc" id="L234">        return new ShapeSpanIterator(adjust);</span>
    }

    /*
     * Return a ShapeSpanIterator ready to iterate the spans of the wide
     * outline of Shape s using the attributes of the SunGraphics2D
     * object.
     *
     * The ShapeSpanIterator returned will be fully constructed
     * and filled with the geometry from the Shape widened by the
     * appropriate BasicStroke and normalization parameters taken
     * from the SunGraphics2D object and be ready to start returning
     * spans.
     *
     * Note that the caller is responsible for calling dispose()
     * on the returned ShapeSpanIterator inside a try/finally block.
     * &lt;pre&gt;
     *     ShapeSpanIterator ssi = LoopPipe.getStrokeSpans(sg2d, s);
     *     try {
     *         // iterate the spans from ssi and operate on them
     *     } finally {
     *         ssi.dispose();
     *     }
     * &lt;/pre&gt;
     *
     * REMIND: This should return a SpanIterator interface object
     * but the caller needs to dispose() the object and that method
     * is only on ShapeSpanIterator.
     * TODO: Add a dispose() method to the SpanIterator interface.
     */
    public static ShapeSpanIterator getStrokeSpans(SunGraphics2D sg2d,
                                                   Shape s)
    {
<span class="nc" id="L267">        ShapeSpanIterator sr = new ShapeSpanIterator(false);</span>

        try {
<span class="nc" id="L270">            sr.setOutputArea(sg2d.getCompClip());</span>
<span class="nc" id="L271">            sr.setRule(PathIterator.WIND_NON_ZERO);</span>

<span class="nc" id="L273">            BasicStroke bs = (BasicStroke) sg2d.stroke;</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            boolean thin = (sg2d.strokeState &lt;= SunGraphics2D.STROKE_THINDASHED);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">            boolean normalize =</span>
                (sg2d.strokeHint != SunHints.INTVAL_STROKE_PURE);

<span class="nc" id="L278">            RenderEngine.strokeTo(s,</span>
                                  sg2d.transform, bs,
                                  thin, normalize, false, sr);
<span class="nc" id="L281">        } catch (Throwable t) {</span>
<span class="nc" id="L282">            sr.dispose();</span>
<span class="nc" id="L283">            sr = null;</span>
<span class="nc" id="L284">            throw new InternalError(&quot;Unable to Stroke shape (&quot;+</span>
<span class="nc" id="L285">                                    t.getMessage()+&quot;)&quot;, t);</span>
<span class="nc" id="L286">        }</span>
<span class="nc" id="L287">        return sr;</span>
    }

    public void fill(SunGraphics2D sg2d, Shape s) {
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (sg2d.strokeState == SunGraphics2D.STROKE_THIN) {</span>
            Path2D.Float p2df;
            int transX;
            int transY;
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (sg2d.transformState &lt;= SunGraphics2D.TRANSFORM_INT_TRANSLATE) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                if (s instanceof Path2D.Float) {</span>
<span class="nc" id="L297">                    p2df = (Path2D.Float)s;</span>
                } else {
<span class="nc" id="L299">                    p2df = new Path2D.Float(s);</span>
                }
<span class="nc" id="L301">                transX = sg2d.transX;</span>
<span class="nc" id="L302">                transY = sg2d.transY;</span>
            } else {
<span class="nc" id="L304">                p2df = new Path2D.Float(s, sg2d.transform);</span>
<span class="nc" id="L305">                transX = 0;</span>
<span class="nc" id="L306">                transY = 0;</span>
            }
<span class="nc" id="L308">            sg2d.loops.fillPathLoop.FillPath(sg2d, sg2d.getSurfaceData(),</span>
                                             transX, transY, p2df);
<span class="nc" id="L310">            return;</span>
        }

<span class="nc" id="L313">        ShapeSpanIterator sr = getFillSSI(sg2d);</span>
        try {
<span class="nc" id="L315">            sr.setOutputArea(sg2d.getCompClip());</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            AffineTransform at =</span>
                ((sg2d.transformState == SunGraphics2D.TRANSFORM_ISIDENT)
                 ? null
                 : sg2d.transform);
<span class="nc" id="L320">            sr.appendPath(s.getPathIterator(at));</span>
<span class="nc" id="L321">            fillSpans(sg2d, sr);</span>
        } finally {
<span class="nc" id="L323">            sr.dispose();</span>
<span class="nc" id="L324">        }</span>
<span class="nc" id="L325">    }</span>

    private static void fillSpans(SunGraphics2D sg2d, SpanIterator si) {
        // REMIND: Eventually, the plan is that it will not be possible for
        // fs to be null since the FillSpans loop will be the fundamental
        // loop implemented for any destination type...
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (sg2d.clipState == SunGraphics2D.CLIP_SHAPE) {</span>
<span class="nc" id="L332">            si = sg2d.clipRegion.filter(si);</span>
            // REMIND: Region.filter produces a Java-only iterator
            // with no native counterpart...
        } else {
<span class="nc" id="L336">            sun.java2d.loops.FillSpans fs = sg2d.loops.fillSpansLoop;</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">            if (fs != null) {</span>
<span class="nc" id="L338">                fs.FillSpans(sg2d, sg2d.getSurfaceData(), si);</span>
<span class="nc" id="L339">                return;</span>
            }
        }
<span class="nc" id="L342">        int spanbox[] = new int[4];</span>
<span class="nc" id="L343">        SurfaceData sd = sg2d.getSurfaceData();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">        while (si.nextSpan(spanbox)) {</span>
<span class="nc" id="L345">            int x = spanbox[0];</span>
<span class="nc" id="L346">            int y = spanbox[1];</span>
<span class="nc" id="L347">            int w = spanbox[2] - x;</span>
<span class="nc" id="L348">            int h = spanbox[3] - y;</span>
<span class="nc" id="L349">            sg2d.loops.fillRectLoop.FillRect(sg2d, sd, x, y, w, h);</span>
<span class="nc" id="L350">        }</span>
<span class="nc" id="L351">    }</span>

    public void fillParallelogram(SunGraphics2D sg2d,
                                  double ux1, double uy1,
                                  double ux2, double uy2,
                                  double x, double y,
                                  double dx1, double dy1,
                                  double dx2, double dy2)
    {
<span class="nc" id="L360">        FillParallelogram fp = sg2d.loops.fillParallelogramLoop;</span>
<span class="nc" id="L361">        fp.FillParallelogram(sg2d, sg2d.getSurfaceData(),</span>
                             x, y, dx1, dy1, dx2, dy2);
<span class="nc" id="L363">    }</span>

    public void drawParallelogram(SunGraphics2D sg2d,
                                  double ux1, double uy1,
                                  double ux2, double uy2,
                                  double x, double y,
                                  double dx1, double dy1,
                                  double dx2, double dy2,
                                  double lw1, double lw2)
    {
<span class="nc" id="L373">        DrawParallelogram dp = sg2d.loops.drawParallelogramLoop;</span>
<span class="nc" id="L374">        dp.DrawParallelogram(sg2d, sg2d.getSurfaceData(),</span>
                             x, y, dx1, dy1, dx2, dy2, lw1, lw2);
<span class="nc" id="L376">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>