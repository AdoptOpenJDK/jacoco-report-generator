<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>MembershipKeyImpl.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.nio.ch</a> &gt; <span class="el_source">MembershipKeyImpl.java</span></div><h1>MembershipKeyImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2008, 2009, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.nio.ch;

import java.nio.channels.*;
import java.net.InetAddress;
import java.net.NetworkInterface;
import java.io.IOException;
import java.util.HashSet;

/**
 * MembershipKey implementation.
 */

class MembershipKeyImpl
    extends MembershipKey
{
    private final MulticastChannel ch;
    private final InetAddress group;
    private final NetworkInterface interf;
    private final InetAddress source;

    // true when key is valid
<span class="fc" id="L47">    private volatile boolean valid = true;</span>

    // lock used when creating or accessing blockedSet
<span class="fc" id="L50">    private Object stateLock = new Object();</span>

    // set of source addresses that are blocked
    private HashSet&lt;InetAddress&gt; blockedSet;

    private MembershipKeyImpl(MulticastChannel ch,
                              InetAddress group,
                              NetworkInterface interf,
                              InetAddress source)
<span class="fc" id="L59">    {</span>
<span class="fc" id="L60">        this.ch = ch;</span>
<span class="fc" id="L61">        this.group = group;</span>
<span class="fc" id="L62">        this.interf = interf;</span>
<span class="fc" id="L63">        this.source = source;</span>
<span class="fc" id="L64">    }</span>

    /**
     * MembershipKey will additional context for IPv4 membership
     */
    static class Type4 extends MembershipKeyImpl {
        private final int groupAddress;
        private final int interfAddress;
        private final int sourceAddress;

        Type4(MulticastChannel ch,
              InetAddress group,
              NetworkInterface interf,
              InetAddress source,
              int groupAddress,
              int interfAddress,
              int sourceAddress)
        {
<span class="fc" id="L82">            super(ch, group, interf, source);</span>
<span class="fc" id="L83">            this.groupAddress = groupAddress;</span>
<span class="fc" id="L84">            this.interfAddress = interfAddress;</span>
<span class="fc" id="L85">            this.sourceAddress = sourceAddress;</span>
<span class="fc" id="L86">        }</span>

        int groupAddress() {
<span class="nc" id="L89">            return groupAddress;</span>
        }

        int interfaceAddress() {
<span class="nc" id="L93">            return interfAddress;</span>
        }

        int source() {
<span class="nc" id="L97">            return sourceAddress;</span>
        }
    }

    /**
     * MembershipKey will additional context for IPv6 membership
     */
    static class Type6 extends MembershipKeyImpl {
        private final byte[] groupAddress;
        private final int index;
        private final byte[] sourceAddress;

        Type6(MulticastChannel ch,
              InetAddress group,
              NetworkInterface interf,
              InetAddress source,
              byte[] groupAddress,
              int index,
              byte[] sourceAddress)
        {
<span class="nc" id="L117">            super(ch, group, interf, source);</span>
<span class="nc" id="L118">            this.groupAddress = groupAddress;</span>
<span class="nc" id="L119">            this.index = index;</span>
<span class="nc" id="L120">            this.sourceAddress = sourceAddress;</span>
<span class="nc" id="L121">        }</span>

        byte[] groupAddress() {
<span class="nc" id="L124">            return groupAddress;</span>
        }

        int index() {
<span class="nc" id="L128">            return index;</span>
        }

        byte[] source() {
<span class="nc" id="L132">            return sourceAddress;</span>
        }
    }

    public boolean isValid() {
<span class="nc" id="L137">        return valid;</span>
    }

    // package-private
    void invalidate() {
<span class="fc" id="L142">        valid = false;</span>
<span class="fc" id="L143">    }</span>

    public void drop() {
        // delegate to channel
<span class="nc" id="L147">        ((DatagramChannelImpl)ch).drop(this);</span>
<span class="nc" id="L148">    }</span>

    @Override
    public MulticastChannel channel() {
<span class="nc" id="L152">        return ch;</span>
    }

    @Override
    public InetAddress group() {
<span class="fc" id="L157">        return group;</span>
    }

    @Override
    public NetworkInterface networkInterface() {
<span class="nc" id="L162">        return interf;</span>
    }

    @Override
    public InetAddress sourceAddress() {
<span class="nc" id="L167">        return source;</span>
    }

    @Override
    public MembershipKey block(InetAddress toBlock)
        throws IOException
    {
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (source != null)</span>
<span class="nc" id="L175">            throw new IllegalStateException(&quot;key is source-specific&quot;);</span>

<span class="nc" id="L177">        synchronized (stateLock) {</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">            if ((blockedSet != null) &amp;&amp; blockedSet.contains(toBlock)) {</span>
                // already blocked, nothing to do
<span class="nc" id="L180">                return this;</span>
            }

<span class="nc" id="L183">            ((DatagramChannelImpl)ch).block(this, toBlock);</span>

            // created blocked set if required and add source address
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (blockedSet == null)</span>
<span class="nc" id="L187">                blockedSet = new HashSet&lt;InetAddress&gt;();</span>
<span class="nc" id="L188">            blockedSet.add(toBlock);</span>
<span class="nc" id="L189">        }</span>
<span class="nc" id="L190">        return this;</span>
    }

    @Override
    public MembershipKey unblock(InetAddress toUnblock) {
<span class="nc" id="L195">        synchronized (stateLock) {</span>
<span class="nc bnc" id="L196" title="All 4 branches missed.">            if ((blockedSet == null) || !blockedSet.contains(toUnblock))</span>
<span class="nc" id="L197">                throw new IllegalStateException(&quot;not blocked&quot;);</span>

<span class="nc" id="L199">            ((DatagramChannelImpl)ch).unblock(this, toUnblock);</span>

<span class="nc" id="L201">            blockedSet.remove(toUnblock);</span>
<span class="nc" id="L202">        }</span>
<span class="nc" id="L203">        return this;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L208">        StringBuilder sb = new StringBuilder(64);</span>
<span class="nc" id="L209">        sb.append('&lt;');</span>
<span class="nc" id="L210">        sb.append(group.getHostAddress());</span>
<span class="nc" id="L211">        sb.append(',');</span>
<span class="nc" id="L212">        sb.append(interf.getName());</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        if (source != null) {</span>
<span class="nc" id="L214">            sb.append(',');</span>
<span class="nc" id="L215">            sb.append(source.getHostAddress());</span>
        }
<span class="nc" id="L217">        sb.append('&gt;');</span>
<span class="nc" id="L218">        return sb.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>