<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>PlatformXmlPropertiesProvider.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.util.xml</a> &gt; <span class="el_source">PlatformXmlPropertiesProvider.java</span></div><h1>PlatformXmlPropertiesProvider.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.util.xml;

import java.io.*;
import java.util.*;
import java.nio.charset.*;
import java.util.Map.Entry;
import org.xml.sax.*;
import org.w3c.dom.*;
import javax.xml.parsers.*;
import javax.xml.transform.*;
import javax.xml.transform.dom.*;
import javax.xml.transform.stream.*;

import sun.util.spi.XmlPropertiesProvider;

/**
 * A {@code XmlPropertiesProvider} implementation that uses the JAXP API
 * for parsing.
 *
 * @author  Michael McCloskey
 * @since   1.3
 */
<span class="nc bnc" id="L48" title="All 2 branches missed.">public class PlatformXmlPropertiesProvider extends XmlPropertiesProvider {</span>

    // XML loading and saving methods for Properties

    // The required DTD URI for exported properties
    private static final String PROPS_DTD_URI =
    &quot;http://java.sun.com/dtd/properties.dtd&quot;;

    private static final String PROPS_DTD =
    &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot; +
    &quot;&lt;!-- DTD for properties --&gt;&quot;                +
    &quot;&lt;!ELEMENT properties ( comment?, entry* ) &gt;&quot;+
    &quot;&lt;!ATTLIST properties&quot;                       +
        &quot; version CDATA #FIXED \&quot;1.0\&quot;&gt;&quot;         +
    &quot;&lt;!ELEMENT comment (#PCDATA) &gt;&quot;              +
    &quot;&lt;!ELEMENT entry (#PCDATA) &gt;&quot;                +
    &quot;&lt;!ATTLIST entry &quot;                           +
        &quot; key CDATA #REQUIRED&gt;&quot;;

    /**
     * Version number for the format of exported properties files.
     */
    private static final String EXTERNAL_XML_VERSION = &quot;1.0&quot;;

    @Override
    public void load(Properties props, InputStream in)
        throws IOException, InvalidPropertiesFormatException
    {
<span class="nc" id="L76">        Document doc = null;</span>
        try {
<span class="nc" id="L78">            doc = getLoadingDoc(in);</span>
<span class="nc" id="L79">        } catch (SAXException saxe) {</span>
<span class="nc" id="L80">            throw new InvalidPropertiesFormatException(saxe);</span>
<span class="nc" id="L81">        }</span>
<span class="nc" id="L82">        Element propertiesElement = doc.getDocumentElement();</span>
<span class="nc" id="L83">        String xmlVersion = propertiesElement.getAttribute(&quot;version&quot;);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (xmlVersion.compareTo(EXTERNAL_XML_VERSION) &gt; 0)</span>
<span class="nc" id="L85">            throw new InvalidPropertiesFormatException(</span>
                &quot;Exported Properties file format version &quot; + xmlVersion +
                &quot; is not supported. This java installation can read&quot; +
                &quot; versions &quot; + EXTERNAL_XML_VERSION + &quot; or older. You&quot; +
                &quot; may need to install a newer version of JDK.&quot;);
<span class="nc" id="L90">        importProperties(props, propertiesElement);</span>
<span class="nc" id="L91">    }</span>

    static Document getLoadingDoc(InputStream in)
        throws SAXException, IOException
    {
<span class="nc" id="L96">        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L97">        dbf.setIgnoringElementContentWhitespace(true);</span>
<span class="nc" id="L98">        dbf.setValidating(true);</span>
<span class="nc" id="L99">        dbf.setCoalescing(true);</span>
<span class="nc" id="L100">        dbf.setIgnoringComments(true);</span>
        try {
<span class="nc" id="L102">            DocumentBuilder db = dbf.newDocumentBuilder();</span>
<span class="nc" id="L103">            db.setEntityResolver(new Resolver());</span>
<span class="nc" id="L104">            db.setErrorHandler(new EH());</span>
<span class="nc" id="L105">            InputSource is = new InputSource(in);</span>
<span class="nc" id="L106">            return db.parse(is);</span>
<span class="nc" id="L107">        } catch (ParserConfigurationException x) {</span>
<span class="nc" id="L108">            throw new Error(x);</span>
        }
    }

    static void importProperties(Properties props, Element propertiesElement) {
<span class="nc" id="L113">        NodeList entries = propertiesElement.getChildNodes();</span>
<span class="nc" id="L114">        int numEntries = entries.getLength();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        int start = numEntries &gt; 0 &amp;&amp;</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            entries.item(0).getNodeName().equals(&quot;comment&quot;) ? 1 : 0;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        for (int i=start; i&lt;numEntries; i++) {</span>
<span class="nc" id="L118">            Element entry = (Element)entries.item(i);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (entry.hasAttribute(&quot;key&quot;)) {</span>
<span class="nc" id="L120">                Node n = entry.getFirstChild();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                String val = (n == null) ? &quot;&quot; : n.getNodeValue();</span>
<span class="nc" id="L122">                props.setProperty(entry.getAttribute(&quot;key&quot;), val);</span>
            }
        }
<span class="nc" id="L125">    }</span>

    @Override
    public void store(Properties props, OutputStream os, String comment,
                      String encoding)
        throws IOException
    {
        // fast-fail for unsupported charsets as UnsupportedEncodingException may
        // not be thrown later (see JDK-8000621)
        try {
<span class="nc" id="L135">            Charset.forName(encoding);</span>
<span class="nc" id="L136">        } catch (IllegalCharsetNameException | UnsupportedCharsetException x) {</span>
<span class="nc" id="L137">            throw new UnsupportedEncodingException(encoding);</span>
<span class="nc" id="L138">        }</span>
<span class="nc" id="L139">        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L140">        DocumentBuilder db = null;</span>
        try {
<span class="nc" id="L142">            db = dbf.newDocumentBuilder();</span>
<span class="nc" id="L143">        } catch (ParserConfigurationException pce) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            assert(false);</span>
<span class="nc" id="L145">        }</span>
<span class="nc" id="L146">        Document doc = db.newDocument();</span>
<span class="nc" id="L147">        Element properties =  (Element)</span>
<span class="nc" id="L148">            doc.appendChild(doc.createElement(&quot;properties&quot;));</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (comment != null) {</span>
<span class="nc" id="L151">            Element comments = (Element)properties.appendChild(</span>
<span class="nc" id="L152">                doc.createElement(&quot;comment&quot;));</span>
<span class="nc" id="L153">            comments.appendChild(doc.createTextNode(comment));</span>
        }

<span class="nc" id="L156">        synchronized (props) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            for (Entry&lt;Object, Object&gt; e : props.entrySet()) {</span>
<span class="nc" id="L158">                final Object k = e.getKey();</span>
<span class="nc" id="L159">                final Object v = e.getValue();</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">                if (k instanceof String &amp;&amp; v instanceof String) {</span>
<span class="nc" id="L161">                    Element entry = (Element)properties.appendChild(</span>
<span class="nc" id="L162">                        doc.createElement(&quot;entry&quot;));</span>
<span class="nc" id="L163">                    entry.setAttribute(&quot;key&quot;, (String)k);</span>
<span class="nc" id="L164">                    entry.appendChild(doc.createTextNode((String)v));</span>
                }
<span class="nc" id="L166">            }</span>
<span class="nc" id="L167">        }</span>
<span class="nc" id="L168">        emitDocument(doc, os, encoding);</span>
<span class="nc" id="L169">    }</span>

    static void emitDocument(Document doc, OutputStream os, String encoding)
        throws IOException
    {
<span class="nc" id="L174">        TransformerFactory tf = TransformerFactory.newInstance();</span>
<span class="nc" id="L175">        Transformer t = null;</span>
        try {
<span class="nc" id="L177">            t = tf.newTransformer();</span>
<span class="nc" id="L178">            t.setOutputProperty(OutputKeys.DOCTYPE_SYSTEM, PROPS_DTD_URI);</span>
<span class="nc" id="L179">            t.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);</span>
<span class="nc" id="L180">            t.setOutputProperty(OutputKeys.METHOD, &quot;xml&quot;);</span>
<span class="nc" id="L181">            t.setOutputProperty(OutputKeys.ENCODING, encoding);</span>
<span class="nc" id="L182">        } catch (TransformerConfigurationException tce) {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            assert(false);</span>
<span class="nc" id="L184">        }</span>
<span class="nc" id="L185">        DOMSource doms = new DOMSource(doc);</span>
<span class="nc" id="L186">        StreamResult sr = new StreamResult(os);</span>
        try {
<span class="nc" id="L188">            t.transform(doms, sr);</span>
<span class="nc" id="L189">        } catch (TransformerException te) {</span>
<span class="nc" id="L190">            throw new IOException(te);</span>
<span class="nc" id="L191">        }</span>
<span class="nc" id="L192">    }</span>

<span class="nc" id="L194">    private static class Resolver implements EntityResolver {</span>
        public InputSource resolveEntity(String pid, String sid)
            throws SAXException
        {
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (sid.equals(PROPS_DTD_URI)) {</span>
                InputSource is;
<span class="nc" id="L200">                is = new InputSource(new StringReader(PROPS_DTD));</span>
<span class="nc" id="L201">                is.setSystemId(PROPS_DTD_URI);</span>
<span class="nc" id="L202">                return is;</span>
            }
<span class="nc" id="L204">            throw new SAXException(&quot;Invalid system identifier: &quot; + sid);</span>
        }
    }

<span class="nc" id="L208">    private static class EH implements ErrorHandler {</span>
        public void error(SAXParseException x) throws SAXException {
<span class="nc" id="L210">            throw x;</span>
        }
        public void fatalError(SAXParseException x) throws SAXException {
<span class="nc" id="L213">            throw x;</span>
        }
        public void warning(SAXParseException x) throws SAXException {
<span class="nc" id="L216">            throw x;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>