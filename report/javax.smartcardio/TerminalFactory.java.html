<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TerminalFactory.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">javax.smartcardio</a> &gt; <span class="el_source">TerminalFactory.java</span></div><h1>TerminalFactory.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.smartcardio;

import java.util.*;

import java.security.*;

import sun.security.jca.*;
import sun.security.jca.GetInstance.*;

import sun.security.action.GetPropertyAction;

/**
 * A factory for CardTerminal objects.
 *
 * It allows an application to
 * &lt;ul&gt;
 * &lt;li&gt;obtain a TerminalFactory by calling
 * one of the static factory methods in this class
 * ({@linkplain #getDefault} or {@linkplain #getInstance getInstance()}).
 * &lt;li&gt;use this TerminalFactory object to access the CardTerminals by
 * calling the {@linkplain #terminals} method.
 * &lt;/ul&gt;
 *
 * &lt;p&gt;Each TerminalFactory has a &lt;code&gt;type&lt;/code&gt; indicating how it
 * was implemented. It must be specified when the implementation is obtained
 * using a {@linkplain #getInstance getInstance()} method and can be retrieved
 * via the {@linkplain #getType} method.
 *
 * &lt;P&gt;The following standard type names have been defined:
 * &lt;dl&gt;
 * &lt;dt&gt;&lt;code&gt;PC/SC&lt;/code&gt;
 * &lt;dd&gt;an implementation that calls into the PC/SC Smart Card stack
 * of the host platform.
 * Implementations do not require parameters and accept &quot;null&quot; as argument
 * in the getInstance() calls.
 * &lt;dt&gt;&lt;code&gt;None&lt;/code&gt;
 * &lt;dd&gt;an implementation that does not supply any CardTerminals. On platforms
 * that do not support other implementations,
 * {@linkplain #getDefaultType} returns &lt;code&gt;None&lt;/code&gt; and
 * {@linkplain #getDefault} returns an instance of a &lt;code&gt;None&lt;/code&gt;
 * TerminalFactory. Factories of this type cannot be obtained by calling the
 * &lt;code&gt;getInstance()&lt;/code&gt; methods.
 * &lt;/dl&gt;
 * Additional standard types may be defined in the future.
 *
 * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt;
 * Provider implementations that accept initialization parameters via the
 * &lt;code&gt;getInstance()&lt;/code&gt; methods are strongly
 * encouraged to use a {@linkplain java.util.Properties} object as the
 * representation for String name-value pair based parameters whenever
 * possible. This allows applications to more easily interoperate with
 * multiple providers than if each provider used different provider
 * specific class as parameters.
 *
 * &lt;P&gt;TerminalFactory utilizes an extensible service provider framework.
 * Service providers that wish to add a new implementation should see the
 * {@linkplain TerminalFactorySpi} class for more information.
 *
 * @see CardTerminals
 * @see Provider
 *
 * @since   1.6
 * @author  Andreas Sterbenz
 * @author  JSR 268 Expert Group
 */
public final class TerminalFactory {

    private final static String PROP_NAME =
                        &quot;javax.smartcardio.TerminalFactory.DefaultType&quot;;

    private final static String defaultType;

    private final static TerminalFactory defaultFactory;

    static {
        // lookup up the user specified type, default to PC/SC
<span class="nc" id="L102">        String type = AccessController.doPrivileged</span>
<span class="nc" id="L103">                            (new GetPropertyAction(PROP_NAME, &quot;PC/SC&quot;)).trim();</span>
<span class="nc" id="L104">        TerminalFactory factory = null;</span>
        try {
<span class="nc" id="L106">            factory = TerminalFactory.getInstance(type, null);</span>
<span class="nc" id="L107">        } catch (Exception e) {</span>
            // ignore
<span class="nc" id="L109">        }</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (factory == null) {</span>
            // if that did not work, try the Sun PC/SC factory
            try {
<span class="nc" id="L113">                type = &quot;PC/SC&quot;;</span>
<span class="nc" id="L114">                Provider sun = Security.getProvider(&quot;SunPCSC&quot;);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (sun == null) {</span>
<span class="nc" id="L116">                    Class&lt;?&gt; clazz = Class.forName(&quot;sun.security.smartcardio.SunPCSC&quot;);</span>
<span class="nc" id="L117">                    sun = (Provider)clazz.newInstance();</span>
                }
<span class="nc" id="L119">                factory = TerminalFactory.getInstance(type, null, sun);</span>
<span class="nc" id="L120">            } catch (Exception e) {</span>
                // ignore
<span class="nc" id="L122">            }</span>
        }
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (factory == null) {</span>
<span class="nc" id="L125">            type = &quot;None&quot;;</span>
<span class="nc" id="L126">            factory = new TerminalFactory</span>
                        (NoneFactorySpi.INSTANCE, NoneProvider.INSTANCE, &quot;None&quot;);
        }
<span class="nc" id="L129">        defaultType = type;</span>
<span class="nc" id="L130">        defaultFactory = factory;</span>
<span class="nc" id="L131">    }</span>

    private static final class NoneProvider extends Provider {

        private static final long serialVersionUID = 2745808869881593918L;
<span class="nc" id="L136">        final static Provider INSTANCE = new NoneProvider();</span>
        private NoneProvider() {
<span class="nc" id="L138">            super(&quot;None&quot;, 1.0d, &quot;none&quot;);</span>
<span class="nc" id="L139">        }</span>
    }

    private static final class NoneFactorySpi extends TerminalFactorySpi {
<span class="nc" id="L143">        final static TerminalFactorySpi INSTANCE = new NoneFactorySpi();</span>
<span class="nc" id="L144">        private NoneFactorySpi() {</span>
            // empty
<span class="nc" id="L146">        }</span>
        protected CardTerminals engineTerminals() {
<span class="nc" id="L148">            return NoneCardTerminals.INSTANCE;</span>
        }
    }

    private static final class NoneCardTerminals extends CardTerminals {
<span class="nc" id="L153">        final static CardTerminals INSTANCE = new NoneCardTerminals();</span>
<span class="nc" id="L154">        private NoneCardTerminals() {</span>
            // empty
<span class="nc" id="L156">        }</span>
        public List&lt;CardTerminal&gt; list(State state) throws CardException {
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (state == null) {</span>
<span class="nc" id="L159">                throw new NullPointerException();</span>
            }
<span class="nc" id="L161">            return Collections.emptyList();</span>
        }
        public boolean waitForChange(long timeout) throws CardException {
<span class="nc" id="L164">            throw new IllegalStateException(&quot;no terminals&quot;);</span>
        }
    }

    private final TerminalFactorySpi spi;

    private final Provider provider;

    private final String type;

<span class="nc" id="L174">    private TerminalFactory(TerminalFactorySpi spi, Provider provider, String type) {</span>
<span class="nc" id="L175">        this.spi = spi;</span>
<span class="nc" id="L176">        this.provider = provider;</span>
<span class="nc" id="L177">        this.type = type;</span>
<span class="nc" id="L178">    }</span>

    /**
     * Get the default TerminalFactory type.
     *
     * &lt;p&gt;It is determined as follows:
     *
     * when this class is initialized, the system property
     * &lt;code&gt;javax.smartcardio.TerminalFactory.DefaultType&lt;/code&gt;
     * is examined. If it is set, a TerminalFactory of this type is
     * instantiated by calling the {@linkplain #getInstance
     * getInstance(String,Object)} method passing
     * &lt;code&gt;null&lt;/code&gt; as the value for &lt;code&gt;params&lt;/code&gt;. If the call
     * succeeds, the type becomes the default type and the factory becomes
     * the {@linkplain #getDefault default} factory.
     *
     * &lt;p&gt;If the system property is not set or the getInstance() call fails
     * for any reason, the system defaults to an implementation specific
     * default type and TerminalFactory.
     *
     * @return the default TerminalFactory type
     */
    public static String getDefaultType() {
<span class="nc" id="L201">        return defaultType;</span>
    }

    /**
     * Returns the default TerminalFactory instance. See
     * {@linkplain #getDefaultType} for more information.
     *
     * &lt;p&gt;A default TerminalFactory is always available. However, depending
     * on the implementation, it may not offer any terminals.
     *
     * @return the default TerminalFactory
     */
    public static TerminalFactory getDefault() {
<span class="nc" id="L214">        return defaultFactory;</span>
    }

    /**
     * Returns a TerminalFactory of the specified type that is initialized
     * with the specified parameters.
     *
     * &lt;p&gt; This method traverses the list of registered security Providers,
     * starting with the most preferred Provider.
     * A new TerminalFactory object encapsulating the
     * TerminalFactorySpi implementation from the first
     * Provider that supports the specified type is returned.
     *
     * &lt;p&gt; Note that the list of registered providers may be retrieved via
     * the {@linkplain Security#getProviders() Security.getProviders()} method.
     *
     * &lt;p&gt;The &lt;code&gt;TerminalFactory&lt;/code&gt; is initialized with the
     * specified parameters Object. The type of parameters
     * needed may vary between different types of &lt;code&gt;TerminalFactory&lt;/code&gt;s.
     *
     * @param type the type of the requested TerminalFactory
     * @param params the parameters to pass to the TerminalFactorySpi
     *   implementation, or null if no parameters are needed
     * @return a TerminalFactory of the specified type
     *
     * @throws NullPointerException if type is null
     * @throws NoSuchAlgorithmException if no Provider supports a
     *   TerminalFactorySpi of the specified type
     */
    public static TerminalFactory getInstance(String type, Object params)
            throws NoSuchAlgorithmException {
<span class="nc" id="L245">        Instance instance = GetInstance.getInstance(&quot;TerminalFactory&quot;,</span>
            TerminalFactorySpi.class, type, params);
<span class="nc" id="L247">        return new TerminalFactory((TerminalFactorySpi)instance.impl,</span>
            instance.provider, type);
    }

    /**
     * Returns a TerminalFactory of the specified type that is initialized
     * with the specified parameters.
     *
     * &lt;p&gt; A new TerminalFactory object encapsulating the
     * TerminalFactorySpi implementation from the specified provider
     * is returned.  The specified provider must be registered
     * in the security provider list.
     *
     * &lt;p&gt; Note that the list of registered providers may be retrieved via
     * the {@linkplain Security#getProviders() Security.getProviders()} method.
     *
     * &lt;p&gt;The &lt;code&gt;TerminalFactory&lt;/code&gt; is initialized with the
     * specified parameters Object. The type of parameters
     * needed may vary between different types of &lt;code&gt;TerminalFactory&lt;/code&gt;s.
     *
     * @param type the type of the requested TerminalFactory
     * @param params the parameters to pass to the TerminalFactorySpi
     *   implementation, or null if no parameters are needed
     * @param provider the name of the provider
     * @return a TerminalFactory of the specified type
     *
     * @throws NullPointerException if type is null
     * @throws IllegalArgumentException if provider is null or the empty String
     * @throws NoSuchAlgorithmException if a TerminalFactorySpi implementation
     *   of the specified type is not available from the specified provider
     * @throws NoSuchAlgorithmException if no TerminalFactory of the
     *   specified type could be found
     * @throws NoSuchProviderException if the specified provider could not
     *   be found
     */
    public static TerminalFactory getInstance(String type, Object params,
            String provider) throws NoSuchAlgorithmException, NoSuchProviderException {
<span class="nc" id="L284">        Instance instance = GetInstance.getInstance(&quot;TerminalFactory&quot;,</span>
            TerminalFactorySpi.class, type, params, provider);
<span class="nc" id="L286">        return new TerminalFactory((TerminalFactorySpi)instance.impl,</span>
            instance.provider, type);
    }

    /**
     * Returns a TerminalFactory of the specified type that is initialized
     * with the specified parameters.
     *
     * &lt;p&gt; A new TerminalFactory object encapsulating the
     * TerminalFactorySpi implementation from the specified provider object
     * is returned. Note that the specified provider object does not have to be
     * registered in the provider list.
     *
     * &lt;p&gt;The &lt;code&gt;TerminalFactory&lt;/code&gt; is initialized with the
     * specified parameters Object. The type of parameters
     * needed may vary between different types of &lt;code&gt;TerminalFactory&lt;/code&gt;s.
     *
     * @param type the type of the requested TerminalFactory
     * @param params the parameters to pass to the TerminalFactorySpi
     *   implementation, or null if no parameters are needed
     * @param provider the provider
     * @return a TerminalFactory of the specified type
     *
     * @throws NullPointerException if type is null
     * @throws IllegalArgumentException if provider is null
     * @throws NoSuchAlgorithmException if a TerminalFactorySpi implementation
     *   of the specified type is not available from the specified Provider
     */
    public static TerminalFactory getInstance(String type, Object params,
            Provider provider) throws NoSuchAlgorithmException {
<span class="nc" id="L316">        Instance instance = GetInstance.getInstance(&quot;TerminalFactory&quot;,</span>
            TerminalFactorySpi.class, type, params, provider);
<span class="nc" id="L318">        return new TerminalFactory((TerminalFactorySpi)instance.impl,</span>
            instance.provider, type);
    }

    /**
     * Returns the provider of this TerminalFactory.
     *
     * @return the provider of this TerminalFactory.
     */
    public Provider getProvider() {
<span class="nc" id="L328">        return provider;</span>
    }

    /**
     * Returns the type of this TerminalFactory. This is the value that was
     * specified in the getInstance() method that returned this object.
     *
     * @return the type of this TerminalFactory
     */
    public String getType() {
<span class="nc" id="L338">        return type;</span>
    }

    /**
     * Returns a new CardTerminals object encapsulating the terminals
     * supported by this factory.
     * See the class comment of the {@linkplain CardTerminals} class
     * regarding how the returned objects can be shared and reused.
     *
     * @return a new CardTerminals object encapsulating the terminals
     * supported by this factory.
     */
    public CardTerminals terminals() {
<span class="nc" id="L351">        return spi.engineTerminals();</span>
    }

    /**
     * Returns a string representation of this TerminalFactory.
     *
     * @return a string representation of this TerminalFactory.
     */
    public String toString() {
<span class="nc" id="L360">        return &quot;TerminalFactory for type &quot; + type + &quot; from provider &quot;</span>
<span class="nc" id="L361">            + provider.getName();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>