<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>IIORegistry.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.imageio.spi</a> &gt; <span class="el_source">IIORegistry.java</span></div><h1>IIORegistry.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.imageio.spi;

import java.security.PrivilegedAction;
import java.security.AccessController;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.NoSuchElementException;
import java.util.Set;
import java.util.Vector;
import com.sun.imageio.spi.FileImageInputStreamSpi;
import com.sun.imageio.spi.FileImageOutputStreamSpi;
import com.sun.imageio.spi.InputStreamImageInputStreamSpi;
import com.sun.imageio.spi.OutputStreamImageOutputStreamSpi;
import com.sun.imageio.spi.RAFImageInputStreamSpi;
import com.sun.imageio.spi.RAFImageOutputStreamSpi;
import com.sun.imageio.plugins.gif.GIFImageReaderSpi;
import com.sun.imageio.plugins.gif.GIFImageWriterSpi;
import com.sun.imageio.plugins.jpeg.JPEGImageReaderSpi;
import com.sun.imageio.plugins.jpeg.JPEGImageWriterSpi;
import com.sun.imageio.plugins.png.PNGImageReaderSpi;
import com.sun.imageio.plugins.png.PNGImageWriterSpi;
import com.sun.imageio.plugins.bmp.BMPImageReaderSpi;
import com.sun.imageio.plugins.bmp.BMPImageWriterSpi;
import com.sun.imageio.plugins.wbmp.WBMPImageReaderSpi;
import com.sun.imageio.plugins.wbmp.WBMPImageWriterSpi;
import sun.awt.AppContext;
import java.util.ServiceLoader;
import java.util.ServiceConfigurationError;

/**
 * A registry for service provider instances.  Service provider
 * classes may be detected at run time by means of meta-information in
 * the JAR files containing them.  The intent is that it be relatively
 * inexpensive to load and inspect all available service provider
 * classes.  These classes may them be used to locate and instantiate
 * more heavyweight classes that will perform actual work, in this
 * case instances of &lt;code&gt;ImageReader&lt;/code&gt;,
 * &lt;code&gt;ImageWriter&lt;/code&gt;, &lt;code&gt;ImageTranscoder&lt;/code&gt;,
 * &lt;code&gt;ImageInputStream&lt;/code&gt;, and &lt;code&gt;ImageOutputStream&lt;/code&gt;.
 *
 * &lt;p&gt; Service providers found on the system classpath (typically
 * the &lt;code&gt;lib/ext&lt;/code&gt; directory in the Java
 * installation directory) are automatically loaded as soon as this class is
 * instantiated.
 *
 * &lt;p&gt; When the &lt;code&gt;registerApplicationClasspathSpis&lt;/code&gt; method
 * is called, service provider instances declared in the
 * meta-information section of JAR files on the application class path
 * are loaded.  To declare a service provider, a &lt;code&gt;services&lt;/code&gt;
 * subdirectory is placed within the &lt;code&gt;META-INF&lt;/code&gt; directory
 * that is present in every JAR file.  This directory contains a file
 * for each service provider interface that has one or more
 * implementation classes present in the JAR file.  For example, if
 * the JAR file contained a class named
 * &lt;code&gt;com.mycompany.imageio.MyFormatReaderSpi&lt;/code&gt; which
 * implements the &lt;code&gt;ImageReaderSpi&lt;/code&gt; interface, the JAR file
 * would contain a file named:
 *
 * &lt;pre&gt;
 * META-INF/services/javax.imageio.spi.ImageReaderSpi
 * &lt;/pre&gt;
 *
 * containing the line:
 *
 * &lt;pre&gt;
 * com.mycompany.imageio.MyFormatReaderSpi
 * &lt;/pre&gt;
 *
 * &lt;p&gt; The service provider classes are intended to be lightweight
 * and quick to load.  Implementations of these interfaces
 * should avoid complex dependencies on other classes and on
 * native code.
 *
 * &lt;p&gt; It is also possible to manually add service providers not found
 * automatically, as well as to remove those that are using the
 * interfaces of the &lt;code&gt;ServiceRegistry&lt;/code&gt; class.  Thus
 * the application may customize the contents of the registry as it
 * sees fit.
 *
 * &lt;p&gt; For more details on declaring service providers, and the JAR
 * format in general, see the &lt;a
 * href=&quot;{@docRoot}/../technotes/guides/jar/jar.html&quot;&gt;
 * JAR File Specification&lt;/a&gt;.
 *
 */
public final class IIORegistry extends ServiceRegistry {

    /**
     * A &lt;code&gt;Vector&lt;/code&gt; containing the valid IIO registry
     * categories (superinterfaces) to be used in the constructor.
     */
<span class="fc" id="L118">    private static final Vector initialCategories = new Vector(5);</span>

    static {
<span class="fc" id="L121">        initialCategories.add(ImageReaderSpi.class);</span>
<span class="fc" id="L122">        initialCategories.add(ImageWriterSpi.class);</span>
<span class="fc" id="L123">        initialCategories.add(ImageTranscoderSpi.class);</span>
<span class="fc" id="L124">        initialCategories.add(ImageInputStreamSpi.class);</span>
<span class="fc" id="L125">        initialCategories.add(ImageOutputStreamSpi.class);</span>
<span class="fc" id="L126">    }</span>

    /**
     * Set up the valid service provider categories and automatically
     * register all available service providers.
     *
     * &lt;p&gt; The constructor is private in order to prevent creation of
     * additional instances.
     */
    private IIORegistry() {
<span class="fc" id="L136">        super(initialCategories.iterator());</span>
<span class="fc" id="L137">        registerStandardSpis();</span>
<span class="fc" id="L138">        registerApplicationClasspathSpis();</span>
<span class="fc" id="L139">    }</span>

    /**
     * Returns the default &lt;code&gt;IIORegistry&lt;/code&gt; instance used by
     * the Image I/O API.  This instance should be used for all
     * registry functions.
     *
     * &lt;p&gt; Each &lt;code&gt;ThreadGroup&lt;/code&gt; will receive its own
     * instance; this allows different &lt;code&gt;Applet&lt;/code&gt;s in the
     * same browser (for example) to each have their own registry.
     *
     * @return the default registry for the current
     * &lt;code&gt;ThreadGroup&lt;/code&gt;.
     */
    public static IIORegistry getDefaultInstance() {
<span class="fc" id="L154">        AppContext context = AppContext.getAppContext();</span>
<span class="fc" id="L155">        IIORegistry registry =</span>
<span class="fc" id="L156">            (IIORegistry)context.get(IIORegistry.class);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (registry == null) {</span>
            // Create an instance for this AppContext
<span class="fc" id="L159">            registry = new IIORegistry();</span>
<span class="fc" id="L160">            context.put(IIORegistry.class, registry);</span>
        }
<span class="fc" id="L162">        return registry;</span>
    }

    private void registerStandardSpis() {
        // Hardwire standard SPIs
<span class="fc" id="L167">        registerServiceProvider(new GIFImageReaderSpi());</span>
<span class="fc" id="L168">        registerServiceProvider(new GIFImageWriterSpi());</span>
<span class="fc" id="L169">        registerServiceProvider(new BMPImageReaderSpi());</span>
<span class="fc" id="L170">        registerServiceProvider(new BMPImageWriterSpi());</span>
<span class="fc" id="L171">        registerServiceProvider(new WBMPImageReaderSpi());</span>
<span class="fc" id="L172">        registerServiceProvider(new WBMPImageWriterSpi());</span>
<span class="fc" id="L173">        registerServiceProvider(new PNGImageReaderSpi());</span>
<span class="fc" id="L174">        registerServiceProvider(new PNGImageWriterSpi());</span>
<span class="fc" id="L175">        registerServiceProvider(new JPEGImageReaderSpi());</span>
<span class="fc" id="L176">        registerServiceProvider(new JPEGImageWriterSpi());</span>
<span class="fc" id="L177">        registerServiceProvider(new FileImageInputStreamSpi());</span>
<span class="fc" id="L178">        registerServiceProvider(new FileImageOutputStreamSpi());</span>
<span class="fc" id="L179">        registerServiceProvider(new InputStreamImageInputStreamSpi());</span>
<span class="fc" id="L180">        registerServiceProvider(new OutputStreamImageOutputStreamSpi());</span>
<span class="fc" id="L181">        registerServiceProvider(new RAFImageInputStreamSpi());</span>
<span class="fc" id="L182">        registerServiceProvider(new RAFImageOutputStreamSpi());</span>

<span class="fc" id="L184">        registerInstalledProviders();</span>
<span class="fc" id="L185">    }</span>

    /**
     * Registers all available service providers found on the
     * application class path, using the default
     * &lt;code&gt;ClassLoader&lt;/code&gt;.  This method is typically invoked by
     * the &lt;code&gt;ImageIO.scanForPlugins&lt;/code&gt; method.
     *
     * @see javax.imageio.ImageIO#scanForPlugins
     * @see ClassLoader#getResources
     */
    public void registerApplicationClasspathSpis() {
        // FIX: load only from application classpath

<span class="fc" id="L199">        ClassLoader loader = Thread.currentThread().getContextClassLoader();</span>

<span class="fc" id="L201">        Iterator categories = getCategories();</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">        while (categories.hasNext()) {</span>
<span class="fc" id="L203">            Class&lt;IIOServiceProvider&gt; c = (Class)categories.next();</span>
<span class="fc" id="L204">            Iterator&lt;IIOServiceProvider&gt; riter =</span>
<span class="fc" id="L205">                    ServiceLoader.load(c, loader).iterator();</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">            while (riter.hasNext()) {</span>
                try {
                    // Note that the next() call is required to be inside
                    // the try/catch block; see 6342404.
<span class="nc" id="L210">                    IIOServiceProvider r = riter.next();</span>
<span class="nc" id="L211">                    registerServiceProvider(r);</span>
<span class="nc" id="L212">                } catch (ServiceConfigurationError err) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    if (System.getSecurityManager() != null) {</span>
                        // In the applet case, we will catch the  error so
                        // registration of other plugins can  proceed
<span class="nc" id="L216">                        err.printStackTrace();</span>
                    } else {
                        // In the application case, we will  throw the
                        // error to indicate app/system  misconfiguration
<span class="nc" id="L220">                        throw err;</span>
                    }
<span class="nc" id="L222">                }</span>
            }
<span class="fc" id="L224">        }</span>
<span class="fc" id="L225">    }</span>

    private void registerInstalledProviders() {
        /*
          We need to load installed providers from the
          system classpath (typically the &lt;code&gt;lib/ext&lt;/code&gt;
          directory in in the Java installation directory)
          in the privileged mode in order to
          be able read corresponding jar files even if
          file read capability is restricted (like the
          applet context case).
         */
<span class="fc" id="L237">        PrivilegedAction doRegistration =</span>
<span class="fc" id="L238">            new PrivilegedAction() {</span>
                public Object run() {
<span class="fc" id="L240">                    Iterator categories = getCategories();</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">                    while (categories.hasNext()) {</span>
<span class="fc" id="L242">                        Class&lt;IIOServiceProvider&gt; c = (Class)categories.next();</span>
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">                        for (IIOServiceProvider p : ServiceLoader.loadInstalled(c)) {</span>
<span class="nc" id="L244">                            registerServiceProvider(p);</span>
<span class="nc" id="L245">                        }</span>
<span class="fc" id="L246">                    }</span>
<span class="fc" id="L247">                    return this;</span>
                }
            };

<span class="fc" id="L251">        AccessController.doPrivileged(doRegistration);</span>
<span class="fc" id="L252">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>