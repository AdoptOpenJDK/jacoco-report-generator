<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JCmd.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.tools.jcmd</a> &gt; <span class="el_source">JCmd.java</span></div><h1>JCmd.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2011, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jcmd;

import java.io.InputStream;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.util.List;
import java.util.ArrayList;
import java.util.Comparator;
import java.net.URISyntaxException;

import com.sun.tools.attach.VirtualMachine;
import com.sun.tools.attach.VirtualMachineDescriptor;
import com.sun.tools.attach.AgentLoadException;
import com.sun.tools.attach.AttachNotSupportedException;
import sun.tools.attach.HotSpotVirtualMachine;
import sun.tools.jstat.JStatLogger;
import sun.jvmstat.monitor.Monitor;
import sun.jvmstat.monitor.MonitoredHost;
import sun.jvmstat.monitor.MonitoredVm;
import sun.jvmstat.monitor.MonitoredVmUtil;
import sun.jvmstat.monitor.MonitorException;
import sun.jvmstat.monitor.VmIdentifier;

<span class="nc" id="L49">public class JCmd {</span>
    public static void main(String[] args) {
<span class="nc" id="L51">        Arguments arg = null;</span>
        try {
<span class="nc" id="L53">            arg = new Arguments(args);</span>
<span class="nc" id="L54">        } catch (IllegalArgumentException ex) {</span>
<span class="nc" id="L55">            System.err.println(&quot;Error parsing arguments: &quot; + ex.getMessage()</span>
                               + &quot;\n&quot;);
<span class="nc" id="L57">            Arguments.usage();</span>
<span class="nc" id="L58">            System.exit(1);</span>
<span class="nc" id="L59">        }</span>

<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (arg.isShowUsage()) {</span>
<span class="nc" id="L62">            Arguments.usage();</span>
<span class="nc" id="L63">            System.exit(1);</span>
        }

<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (arg.isListProcesses()) {</span>
<span class="nc" id="L67">            List&lt;VirtualMachineDescriptor&gt; vmds = VirtualMachine.list();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">            for (VirtualMachineDescriptor vmd : vmds) {</span>
<span class="nc" id="L69">                System.out.println(vmd.id() + &quot; &quot; + vmd.displayName());</span>
<span class="nc" id="L70">            }</span>
<span class="nc" id="L71">            System.exit(0);</span>
        }

<span class="nc" id="L74">        List&lt;String&gt; pids = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (arg.getPid() == 0) {</span>
            // find all VMs
<span class="nc" id="L77">            List&lt;VirtualMachineDescriptor&gt; vmds = VirtualMachine.list();</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            for (VirtualMachineDescriptor vmd : vmds) {</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                if (!isJCmdProcess(vmd)) {</span>
<span class="nc" id="L80">                    pids.add(vmd.id());</span>
                }
<span class="nc" id="L82">            }</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        } else if (arg.getProcessSubstring() != null) {</span>
            // use the partial class-name match
<span class="nc" id="L85">            List&lt;VirtualMachineDescriptor&gt; vmds = VirtualMachine.list();</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            for (VirtualMachineDescriptor vmd : vmds) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">                if (isJCmdProcess(vmd)) {</span>
<span class="nc" id="L88">                    continue;</span>
                }
                try {
<span class="nc" id="L91">                    String mainClass = getMainClass(vmd);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                    if (mainClass != null</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                        &amp;&amp; mainClass.indexOf(arg.getProcessSubstring()) != -1) {</span>
<span class="nc" id="L94">                            pids.add(vmd.id());</span>
                    }
<span class="nc" id="L96">                } catch (MonitorException|URISyntaxException e) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                    if (e.getMessage() != null) {</span>
<span class="nc" id="L98">                        System.err.println(e.getMessage());</span>
                    } else {
<span class="nc" id="L100">                        Throwable cause = e.getCause();</span>
<span class="nc bnc" id="L101" title="All 4 branches missed.">                        if ((cause != null) &amp;&amp; (cause.getMessage() != null)) {</span>
<span class="nc" id="L102">                            System.err.println(cause.getMessage());</span>
                        } else {
<span class="nc" id="L104">                            e.printStackTrace();</span>
                        }
                    }
<span class="nc" id="L107">                }</span>
<span class="nc" id="L108">            }</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (pids.isEmpty()) {</span>
<span class="nc" id="L110">                System.err.println(&quot;Could not find any processes matching : '&quot;</span>
<span class="nc" id="L111">                                   + arg.getProcessSubstring() + &quot;'&quot;);</span>
<span class="nc" id="L112">                System.exit(1);</span>
            }
<span class="nc bnc" id="L114" title="All 2 branches missed.">        } else if (arg.getPid() == -1) {</span>
<span class="nc" id="L115">            System.err.println(&quot;Invalid pid specified&quot;);</span>
<span class="nc" id="L116">            System.exit(1);</span>
        } else {
            // Use the found pid
<span class="nc" id="L119">            pids.add(arg.getPid() + &quot;&quot;);</span>
        }

<span class="nc bnc" id="L122" title="All 2 branches missed.">        for (String pid : pids) {</span>
<span class="nc" id="L123">            System.out.println(pid + &quot;:&quot;);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (arg.isListCounters()) {</span>
<span class="nc" id="L125">                listCounters(pid);</span>
            } else {
                try {
<span class="nc" id="L128">                    executeCommandForPid(pid, arg.getCommand());</span>
<span class="nc" id="L129">                } catch(Exception ex) {</span>
<span class="nc" id="L130">                    ex.printStackTrace();</span>
<span class="nc" id="L131">                }</span>
            }
<span class="nc" id="L133">        }</span>
<span class="nc" id="L134">    }</span>

    private static void executeCommandForPid(String pid, String command)
        throws AttachNotSupportedException, IOException,
               UnsupportedEncodingException {
<span class="nc" id="L139">        VirtualMachine vm = VirtualMachine.attach(pid);</span>

        // Cast to HotSpotVirtualMachine as this is an
        // implementation specific method.
<span class="nc" id="L143">        HotSpotVirtualMachine hvm = (HotSpotVirtualMachine) vm;</span>
<span class="nc" id="L144">        String lines[] = command.split(&quot;\\n&quot;);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        for (String line : lines) {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (line.trim().equals(&quot;stop&quot;)) {</span>
<span class="nc" id="L147">                break;</span>
            }
<span class="nc" id="L149">            try (InputStream in = hvm.executeJCmd(line);) {</span>
                // read to EOF and just print output
<span class="nc" id="L151">                byte b[] = new byte[256];</span>
                int n;
                do {
<span class="nc" id="L154">                    n = in.read(b);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                    if (n &gt; 0) {</span>
<span class="nc" id="L156">                        String s = new String(b, 0, n, &quot;UTF-8&quot;);</span>
<span class="nc" id="L157">                        System.out.print(s);</span>
                    }
<span class="nc bnc" id="L159" title="All 2 branches missed.">                } while (n &gt; 0);</span>
<span class="nc bnc" id="L160" title="All 8 branches missed.">            }</span>
        }
<span class="nc" id="L162">        vm.detach();</span>
<span class="nc" id="L163">    }</span>

    private static void listCounters(String pid) {
        // Code from JStat (can't call it directly since it does System.exit)
<span class="nc" id="L167">        VmIdentifier vmId = null;</span>
        try {
<span class="nc" id="L169">            vmId = new VmIdentifier(pid);</span>
<span class="nc" id="L170">        } catch (URISyntaxException e) {</span>
<span class="nc" id="L171">            System.err.println(&quot;Malformed VM Identifier: &quot; + pid);</span>
<span class="nc" id="L172">            return;</span>
<span class="nc" id="L173">        }</span>
        try {
<span class="nc" id="L175">            MonitoredHost monitoredHost = MonitoredHost.getMonitoredHost(vmId);</span>
<span class="nc" id="L176">            MonitoredVm monitoredVm = monitoredHost.getMonitoredVm(vmId, -1);</span>
<span class="nc" id="L177">            JStatLogger logger = new JStatLogger(monitoredVm);</span>
<span class="nc" id="L178">            logger.printSnapShot(&quot;\\w*&quot;, // all names</span>
                    new AscendingMonitorComparator(), // comparator
                    false, // not verbose
                    true, // show unsupported
                    System.out);
<span class="nc" id="L183">            monitoredHost.detach(monitoredVm);</span>
<span class="nc" id="L184">        } catch (MonitorException ex) {</span>
<span class="nc" id="L185">            ex.printStackTrace();</span>
<span class="nc" id="L186">        }</span>
<span class="nc" id="L187">    }</span>

    private static boolean isJCmdProcess(VirtualMachineDescriptor vmd) {
        try {
<span class="nc" id="L191">            String mainClass = getMainClass(vmd);</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">            return mainClass != null &amp;&amp; mainClass.equals(JCmd.class.getName());</span>
<span class="nc" id="L193">        } catch (URISyntaxException|MonitorException ex) {</span>
<span class="nc" id="L194">            return false;</span>
        }
    }

    private static String getMainClass(VirtualMachineDescriptor vmd)
            throws URISyntaxException, MonitorException {
        try {
<span class="nc" id="L201">            String mainClass = null;</span>
<span class="nc" id="L202">            VmIdentifier vmId = new VmIdentifier(vmd.id());</span>
<span class="nc" id="L203">            MonitoredHost monitoredHost = MonitoredHost.getMonitoredHost(vmId);</span>
<span class="nc" id="L204">            MonitoredVm monitoredVm = monitoredHost.getMonitoredVm(vmId, -1);</span>
<span class="nc" id="L205">            mainClass = MonitoredVmUtil.mainClass(monitoredVm, true);</span>
<span class="nc" id="L206">            monitoredHost.detach(monitoredVm);</span>
<span class="nc" id="L207">            return mainClass;</span>
<span class="nc" id="L208">        } catch(NullPointerException e) {</span>
            // There is a potential race, where a running java app is being
            // queried, unfortunately the java app has shutdown after this
            // method is started but before getMonitoredVM is called.
            // If this is the case, then the /tmp/hsperfdata_xxx/pid file
            // will have disappeared and we will get a NullPointerException.
            // Handle this gracefully....
<span class="nc" id="L215">            return null;</span>
        }
    }

    /**
     * Class to compare two Monitor objects by name in ascending order.
     * (from jstat)
     */
<span class="nc" id="L223">    static class AscendingMonitorComparator implements Comparator&lt;Monitor&gt; {</span>

        public int compare(Monitor m1, Monitor m2) {
<span class="nc" id="L226">            String name1 = m1.getName();</span>
<span class="nc" id="L227">            String name2 = m2.getName();</span>
<span class="nc" id="L228">            return name1.compareTo(name2);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>