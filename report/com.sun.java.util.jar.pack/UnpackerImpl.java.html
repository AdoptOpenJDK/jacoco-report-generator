<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UnpackerImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.java.util.jar.pack</a> &gt; <span class="el_source">UnpackerImpl.java</span></div><h1>UnpackerImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.java.util.jar.pack;

import java.beans.PropertyChangeListener;
import java.io.BufferedInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.HashSet;
import java.util.Set;
import java.util.SortedMap;
import java.util.TimeZone;
import java.util.jar.JarEntry;
import java.util.jar.JarInputStream;
import java.util.jar.JarOutputStream;
import java.util.jar.Pack200;
import java.util.zip.CRC32;
import java.util.zip.CheckedOutputStream;
import java.util.zip.ZipEntry;

/*
 * Implementation of the Pack provider.
 * &lt;/pre&gt;&lt;/blockquote&gt;
 * @author John Rose
 * @author Kumar Srinivasan
 */


<span class="nc bnc" id="L56" title="All 2 branches missed.">public class UnpackerImpl extends TLGlobals implements Pack200.Unpacker {</span>


    /**
     * Register a listener for changes to options.
     * @param listener  An object to be invoked when a property is changed.
     */
    public void addPropertyChangeListener(PropertyChangeListener listener) {
<span class="nc" id="L64">        props.addListener(listener);</span>
<span class="nc" id="L65">    }</span>


    /**
     * Remove a listener for the PropertyChange event.
     * @param listener  The PropertyChange listener to be removed.
     */
    public void removePropertyChangeListener(PropertyChangeListener listener) {
<span class="nc" id="L73">        props.removeListener(listener);</span>
<span class="nc" id="L74">    }</span>

<span class="nc" id="L76">    public UnpackerImpl() {}</span>



    /**
     * Get the set of options for the pack and unpack engines.
     * @return A sorted association of option key strings to option values.
     */
    public SortedMap&lt;String, String&gt; properties() {
<span class="nc" id="L85">        return props;</span>
    }

    // Back-pointer to NativeUnpacker, when active.
    Object _nunp;


    public String toString() {
<span class="nc" id="L93">        return Utils.getVersionString();</span>
    }

    //Driver routines

    // The unpack worker...
    /**
     * Takes a packed-stream InputStream, and writes to a JarOutputStream. Internally
     * the entire buffer must be read, it may be more efficient to read the packed-stream
     * to a file and pass the File object, in the alternate method described below.
     * &lt;p&gt;
     * Closes its input but not its output.  (The output can accumulate more elements.)
     * @param in an InputStream.
     * @param out a JarOutputStream.
     * @exception IOException if an error is encountered.
     */
    public synchronized void unpack(InputStream in, JarOutputStream out) throws IOException {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (in == null) {</span>
<span class="nc" id="L111">            throw new NullPointerException(&quot;null input&quot;);</span>
        }
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (out == null) {</span>
<span class="nc" id="L114">            throw new NullPointerException(&quot;null output&quot;);</span>
        }
<span class="nc bnc" id="L116" title="All 4 branches missed.">        assert(Utils.currentInstance.get() == null);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        TimeZone tz = (props.getBoolean(Utils.PACK_DEFAULT_TIMEZONE))</span>
                      ? null
<span class="nc" id="L119">                      : TimeZone.getDefault();</span>

        try {
<span class="nc" id="L122">            Utils.currentInstance.set(this);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            if (tz != null) TimeZone.setDefault(TimeZone.getTimeZone(&quot;UTC&quot;));</span>
<span class="nc" id="L124">            final int verbose = props.getInteger(Utils.DEBUG_VERBOSE);</span>
<span class="nc" id="L125">            BufferedInputStream in0 = new BufferedInputStream(in);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (Utils.isJarMagic(Utils.readMagic(in0))) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                if (verbose &gt; 0)</span>
<span class="nc" id="L128">                    Utils.log.info(&quot;Copying unpacked JAR file...&quot;);</span>
<span class="nc" id="L129">                Utils.copyJarFile(new JarInputStream(in0), out);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            } else if (props.getBoolean(Utils.DEBUG_DISABLE_NATIVE)) {</span>
<span class="nc" id="L131">                (new DoUnpack()).run(in0, out);</span>
<span class="nc" id="L132">                in0.close();</span>
<span class="nc" id="L133">                Utils.markJarFile(out);</span>
            } else {
                try {
<span class="nc" id="L136">                    (new NativeUnpack(this)).run(in0, out);</span>
<span class="nc" id="L137">                } catch (UnsatisfiedLinkError | NoClassDefFoundError ex) {</span>
                    // failover to java implementation
<span class="nc" id="L139">                    (new DoUnpack()).run(in0, out);</span>
<span class="nc" id="L140">                }</span>
<span class="nc" id="L141">                in0.close();</span>
<span class="nc" id="L142">                Utils.markJarFile(out);</span>
            }
        } finally {
<span class="nc" id="L145">            _nunp = null;</span>
<span class="nc" id="L146">            Utils.currentInstance.set(null);</span>
<span class="nc bnc" id="L147" title="All 4 branches missed.">            if (tz != null) TimeZone.setDefault(tz);</span>
        }
<span class="nc" id="L149">    }</span>

    /**
     * Takes an input File containing the pack file, and generates a JarOutputStream.
     * &lt;p&gt;
     * Does not close its output.  (The output can accumulate more elements.)
     * @param in a File.
     * @param out a JarOutputStream.
     * @exception IOException if an error is encountered.
     */
    public synchronized void unpack(File in, JarOutputStream out) throws IOException {
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (in == null) {</span>
<span class="nc" id="L161">            throw new NullPointerException(&quot;null input&quot;);</span>
        }
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (out == null) {</span>
<span class="nc" id="L164">            throw new NullPointerException(&quot;null output&quot;);</span>
        }
        // Use the stream-based implementation.
        // %%% Reconsider if native unpacker learns to memory-map the file.
<span class="nc" id="L168">        try (FileInputStream instr = new FileInputStream(in)) {</span>
<span class="nc" id="L169">            unpack(instr, out);</span>
<span class="nc bnc" id="L170" title="All 8 branches missed.">        }</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (props.getBoolean(Utils.UNPACK_REMOVE_PACKFILE)) {</span>
<span class="nc" id="L172">            in.delete();</span>
        }
<span class="nc" id="L174">    }</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">    private class DoUnpack {</span>
<span class="nc" id="L177">        final int verbose = props.getInteger(Utils.DEBUG_VERBOSE);</span>

        {
<span class="nc" id="L180">            props.setInteger(Pack200.Unpacker.PROGRESS, 0);</span>
        }

        // Here's where the bits are read from disk:
<span class="nc" id="L184">        final Package pkg = new Package();</span>

<span class="nc" id="L186">        final boolean keepModtime</span>
<span class="nc" id="L187">            = Pack200.Packer.KEEP.equals(</span>
<span class="nc" id="L188">              props.getProperty(Utils.UNPACK_MODIFICATION_TIME, Pack200.Packer.KEEP));</span>
<span class="nc" id="L189">        final boolean keepDeflateHint</span>
<span class="nc" id="L190">            = Pack200.Packer.KEEP.equals(</span>
<span class="nc" id="L191">              props.getProperty(Pack200.Unpacker.DEFLATE_HINT, Pack200.Packer.KEEP));</span>
        final int modtime;
        final boolean deflateHint;
        {
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (!keepModtime) {</span>
<span class="nc" id="L196">                modtime = props.getTime(Utils.UNPACK_MODIFICATION_TIME);</span>
            } else {
<span class="nc" id="L198">                modtime = pkg.default_modtime;</span>
            }

<span class="nc bnc" id="L201" title="All 2 branches missed.">            deflateHint = (keepDeflateHint) ? false :</span>
<span class="nc" id="L202">                props.getBoolean(java.util.jar.Pack200.Unpacker.DEFLATE_HINT);</span>
        }

        // Checksum apparatus.
<span class="nc" id="L206">        final CRC32 crc = new CRC32();</span>
<span class="nc" id="L207">        final ByteArrayOutputStream bufOut = new ByteArrayOutputStream();</span>
<span class="nc" id="L208">        final OutputStream crcOut = new CheckedOutputStream(bufOut, crc);</span>

        public void run(BufferedInputStream in, JarOutputStream out) throws IOException {
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (verbose &gt; 0) {</span>
<span class="nc" id="L212">                props.list(System.out);</span>
            }
<span class="nc" id="L214">            for (int seg = 1; ; seg++) {</span>
<span class="nc" id="L215">                unpackSegment(in, out);</span>

                // Try to get another segment.
<span class="nc bnc" id="L218" title="All 2 branches missed.">                if (!Utils.isPackMagic(Utils.readMagic(in)))  break;</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">                if (verbose &gt; 0)</span>
<span class="nc" id="L220">                    Utils.log.info(&quot;Finished segment #&quot;+seg);</span>
            }
<span class="nc" id="L222">        }</span>

        private void unpackSegment(InputStream in, JarOutputStream out) throws IOException {
<span class="nc" id="L225">            props.setProperty(java.util.jar.Pack200.Unpacker.PROGRESS,&quot;0&quot;);</span>
            // Process the output directory or jar output.
<span class="nc" id="L227">            new PackageReader(pkg, in).read();</span>

<span class="nc bnc" id="L229" title="All 2 branches missed.">            if (props.getBoolean(&quot;unpack.strip.debug&quot;))    pkg.stripAttributeKind(&quot;Debug&quot;);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (props.getBoolean(&quot;unpack.strip.compile&quot;))  pkg.stripAttributeKind(&quot;Compile&quot;);</span>
<span class="nc" id="L231">            props.setProperty(java.util.jar.Pack200.Unpacker.PROGRESS,&quot;50&quot;);</span>
<span class="nc" id="L232">            pkg.ensureAllClassFiles();</span>
            // Now write out the files.
<span class="nc" id="L234">            Set&lt;Package.Class&gt; classesToWrite = new HashSet&lt;&gt;(pkg.getClasses());</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">            for (Package.File file : pkg.getFiles()) {</span>
<span class="nc" id="L236">                String name = file.nameString;</span>
<span class="nc" id="L237">                JarEntry je = new JarEntry(Utils.getJarEntryName(name));</span>
                boolean deflate;

<span class="nc bnc" id="L240" title="All 6 branches missed.">                deflate = (keepDeflateHint)</span>
                          ? (((file.options &amp; Constants.FO_DEFLATE_HINT) != 0) ||
                            ((pkg.default_options &amp; Constants.AO_DEFLATE_HINT) != 0))
                          : deflateHint;

<span class="nc bnc" id="L245" title="All 2 branches missed.">                boolean needCRC = !deflate;  // STORE mode requires CRC</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (needCRC)  crc.reset();</span>
<span class="nc" id="L248">                bufOut.reset();</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (file.isClassStub()) {</span>
<span class="nc" id="L250">                    Package.Class cls = file.getStubClass();</span>
<span class="nc bnc" id="L251" title="All 4 branches missed.">                    assert(cls != null);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                    new ClassWriter(cls, needCRC ? crcOut : bufOut).write();</span>
<span class="nc" id="L253">                    classesToWrite.remove(cls);  // for an error check</span>
<span class="nc" id="L254">                } else {</span>
                    // collect data &amp; maybe CRC
<span class="nc bnc" id="L256" title="All 2 branches missed.">                    file.writeTo(needCRC ? crcOut : bufOut);</span>
                }
<span class="nc bnc" id="L258" title="All 2 branches missed.">                je.setMethod(deflate ? JarEntry.DEFLATED : JarEntry.STORED);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                if (needCRC) {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                    if (verbose &gt; 0)</span>
<span class="nc" id="L261">                        Utils.log.info(&quot;stored size=&quot;+bufOut.size()+&quot; and crc=&quot;+crc.getValue());</span>

<span class="nc" id="L263">                    je.setMethod(JarEntry.STORED);</span>
<span class="nc" id="L264">                    je.setSize(bufOut.size());</span>
<span class="nc" id="L265">                    je.setCrc(crc.getValue());</span>
                }
<span class="nc bnc" id="L267" title="All 2 branches missed.">                if (keepModtime) {</span>
<span class="nc" id="L268">                    je.setTime(file.modtime);</span>
                    // Convert back to milliseconds
<span class="nc" id="L270">                    je.setTime((long)file.modtime * 1000);</span>
                } else {
<span class="nc" id="L272">                    je.setTime((long)modtime * 1000);</span>
                }
<span class="nc" id="L274">                out.putNextEntry(je);</span>
<span class="nc" id="L275">                bufOut.writeTo(out);</span>
<span class="nc" id="L276">                out.closeEntry();</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                if (verbose &gt; 0)</span>
<span class="nc" id="L278">                    Utils.log.info(&quot;Writing &quot;+Utils.zeString((ZipEntry)je));</span>
<span class="nc" id="L279">            }</span>
<span class="nc bnc" id="L280" title="All 4 branches missed.">            assert(classesToWrite.isEmpty());</span>
<span class="nc" id="L281">            props.setProperty(java.util.jar.Pack200.Unpacker.PROGRESS,&quot;100&quot;);</span>
<span class="nc" id="L282">            pkg.reset();  // reset for the next segment, if any</span>
<span class="nc" id="L283">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>