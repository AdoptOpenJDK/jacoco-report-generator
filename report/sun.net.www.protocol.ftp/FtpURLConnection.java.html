<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>FtpURLConnection.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.net.www.protocol.ftp</a> &gt; <span class="el_source">FtpURLConnection.java</span></div><h1>FtpURLConnection.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1994, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

/**
 * FTP stream opener.
 */

package sun.net.www.protocol.ftp;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.BufferedInputStream;
import java.io.FilterInputStream;
import java.io.FilterOutputStream;
import java.io.FileNotFoundException;
import java.net.URL;
import java.net.SocketPermission;
import java.net.UnknownHostException;
import java.net.InetSocketAddress;
import java.net.URI;
import java.net.Proxy;
import java.net.ProxySelector;
import java.util.StringTokenizer;
import java.util.Iterator;
import java.security.Permission;
import sun.net.NetworkClient;
import sun.net.www.MessageHeader;
import sun.net.www.MeteredStream;
import sun.net.www.URLConnection;
import sun.net.www.protocol.http.HttpURLConnection;
import sun.net.ftp.FtpClient;
import sun.net.ftp.FtpProtocolException;
import sun.net.ProgressSource;
import sun.net.ProgressMonitor;
import sun.net.www.ParseUtil;
import sun.security.action.GetPropertyAction;


/**
 * This class Opens an FTP input (or output) stream given a URL.
 * It works as a one shot FTP transfer :
 * &lt;UL&gt;
 * &lt;LI&gt;Login&lt;/LI&gt;
 * &lt;LI&gt;Get (or Put) the file&lt;/LI&gt;
 * &lt;LI&gt;Disconnect&lt;/LI&gt;
 * &lt;/UL&gt;
 * You should not have to use it directly in most cases because all will be handled
 * in a abstract layer. Here is an example of how to use the class :
 * &lt;P&gt;
 * &lt;code&gt;URL url = new URL(&quot;ftp://ftp.sun.com/pub/test.txt&quot;);&lt;p&gt;
 * UrlConnection con = url.openConnection();&lt;p&gt;
 * InputStream is = con.getInputStream();&lt;p&gt;
 * ...&lt;p&gt;
 * is.close();&lt;/code&gt;
 *
 * @see sun.net.ftp.FtpClient
 */
public class FtpURLConnection extends URLConnection {

    // In case we have to use proxies, we use HttpURLConnection
<span class="fc" id="L84">    HttpURLConnection http = null;</span>
    private Proxy instProxy;

<span class="fc" id="L87">    InputStream is = null;</span>
<span class="fc" id="L88">    OutputStream os = null;</span>

<span class="fc" id="L90">    FtpClient ftp = null;</span>
    Permission permission;

    String password;
    String user;

    String host;
    String pathname;
    String filename;
    String fullpath;
    int port;
    static final int NONE = 0;
    static final int ASCII = 1;
    static final int BIN = 2;
    static final int DIR = 3;
<span class="fc" id="L105">    int type = NONE;</span>
    /* Redefine timeouts from java.net.URLConnection as we need -1 to mean
     * not set. This is to ensure backward compatibility.
     */
<span class="fc" id="L109">    private int connectTimeout = NetworkClient.DEFAULT_CONNECT_TIMEOUT;;</span>
<span class="fc" id="L110">    private int readTimeout = NetworkClient.DEFAULT_READ_TIMEOUT;;</span>

    /**
     * For FTP URLs we need to have a special InputStream because we
     * need to close 2 sockets after we're done with it :
     *  - The Data socket (for the file).
     *   - The command socket (FtpClient).
     * Since that's the only class that needs to see that, it is an inner class.
     */
    protected class FtpInputStream extends FilterInputStream {
        FtpClient ftp;
<span class="fc" id="L121">        FtpInputStream(FtpClient cl, InputStream fd) {</span>
<span class="fc" id="L122">            super(new BufferedInputStream(fd));</span>
<span class="fc" id="L123">            ftp = cl;</span>
<span class="fc" id="L124">        }</span>

        @Override
        public void close() throws IOException {
<span class="fc" id="L128">            super.close();</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">            if (ftp != null) {</span>
<span class="fc" id="L130">                ftp.close();</span>
            }
<span class="fc" id="L132">        }</span>
    }

    /**
     * For FTP URLs we need to have a special OutputStream because we
     * need to close 2 sockets after we're done with it :
     *  - The Data socket (for the file).
     *   - The command socket (FtpClient).
     * Since that's the only class that needs to see that, it is an inner class.
     */
    protected class FtpOutputStream extends FilterOutputStream {
        FtpClient ftp;
<span class="nc" id="L144">        FtpOutputStream(FtpClient cl, OutputStream fd) {</span>
<span class="nc" id="L145">            super(fd);</span>
<span class="nc" id="L146">            ftp = cl;</span>
<span class="nc" id="L147">        }</span>

        @Override
        public void close() throws IOException {
<span class="nc" id="L151">            super.close();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (ftp != null) {</span>
<span class="nc" id="L153">                ftp.close();</span>
            }
<span class="nc" id="L155">        }</span>
    }

    /**
     * Creates an FtpURLConnection from a URL.
     *
     * @param   url     The &lt;code&gt;URL&lt;/code&gt; to retrieve or store.
     */
    public FtpURLConnection(URL url) {
<span class="nc" id="L164">        this(url, null);</span>
<span class="nc" id="L165">    }</span>

    /**
     * Same as FtpURLconnection(URL) with a per connection proxy specified
     */
    FtpURLConnection(URL url, Proxy p) {
<span class="fc" id="L171">        super(url);</span>
<span class="fc" id="L172">        instProxy = p;</span>
<span class="fc" id="L173">        host = url.getHost();</span>
<span class="fc" id="L174">        port = url.getPort();</span>
<span class="fc" id="L175">        String userInfo = url.getUserInfo();</span>

<span class="fc bfc" id="L177" title="All 2 branches covered.">        if (userInfo != null) { // get the user and password</span>
<span class="fc" id="L178">            int delimiter = userInfo.indexOf(':');</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">            if (delimiter == -1) {</span>
<span class="nc" id="L180">                user = ParseUtil.decode(userInfo);</span>
<span class="nc" id="L181">                password = null;</span>
            } else {
<span class="fc" id="L183">                user = ParseUtil.decode(userInfo.substring(0, delimiter++));</span>
<span class="fc" id="L184">                password = ParseUtil.decode(userInfo.substring(delimiter));</span>
            }
        }
<span class="fc" id="L187">    }</span>

    private void setTimeouts() {
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        if (ftp != null) {</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">            if (connectTimeout &gt;= 0) {</span>
<span class="nc" id="L192">                ftp.setConnectTimeout(connectTimeout);</span>
            }
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">            if (readTimeout &gt;= 0) {</span>
<span class="nc" id="L195">                ftp.setReadTimeout(readTimeout);</span>
            }
        }
<span class="fc" id="L198">    }</span>

    /**
     * Connects to the FTP server and logs in.
     *
     * @throws  FtpLoginException if the login is unsuccessful
     * @throws  FtpProtocolException if an error occurs
     * @throws  UnknownHostException if trying to connect to an unknown host
     */

    public synchronized void connect() throws IOException {
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (connected) {</span>
<span class="nc" id="L210">            return;</span>
        }

<span class="fc" id="L213">        Proxy p = null;</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        if (instProxy == null) { // no per connection proxy specified</span>
            /**
             * Do we have to use a proxy?
             */
<span class="fc" id="L218">            ProxySelector sel = java.security.AccessController.doPrivileged(</span>
<span class="fc" id="L219">                    new java.security.PrivilegedAction&lt;ProxySelector&gt;() {</span>
                        public ProxySelector run() {
<span class="fc" id="L221">                            return ProxySelector.getDefault();</span>
                        }
                    });
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">            if (sel != null) {</span>
<span class="fc" id="L225">                URI uri = sun.net.www.ParseUtil.toURI(url);</span>
<span class="fc" id="L226">                Iterator&lt;Proxy&gt; it = sel.select(uri).iterator();</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">                while (it.hasNext()) {</span>
<span class="fc" id="L228">                    p = it.next();</span>
<span class="pc bpc" id="L229" title="2 of 4 branches missed.">                    if (p == null || p == Proxy.NO_PROXY ||</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                        p.type() == Proxy.Type.SOCKS) {</span>
<span class="nc" id="L231">                        break;</span>
                    }
<span class="nc bnc" id="L233" title="All 2 branches missed.">                    if (p.type() != Proxy.Type.HTTP ||</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                            !(p.address() instanceof InetSocketAddress)) {</span>
<span class="nc" id="L235">                        sel.connectFailed(uri, p.address(), new IOException(&quot;Wrong proxy type&quot;));</span>
<span class="nc" id="L236">                        continue;</span>
                    }
                    // OK, we have an http proxy
<span class="nc" id="L239">                    InetSocketAddress paddr = (InetSocketAddress) p.address();</span>
                    try {
<span class="nc" id="L241">                        http = new HttpURLConnection(url, p);</span>
<span class="nc" id="L242">                        http.setDoInput(getDoInput());</span>
<span class="nc" id="L243">                        http.setDoOutput(getDoOutput());</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                        if (connectTimeout &gt;= 0) {</span>
<span class="nc" id="L245">                            http.setConnectTimeout(connectTimeout);</span>
                        }
<span class="nc bnc" id="L247" title="All 2 branches missed.">                        if (readTimeout &gt;= 0) {</span>
<span class="nc" id="L248">                            http.setReadTimeout(readTimeout);</span>
                        }
<span class="nc" id="L250">                        http.connect();</span>
<span class="nc" id="L251">                        connected = true;</span>
<span class="nc" id="L252">                        return;</span>
<span class="nc" id="L253">                    } catch (IOException ioe) {</span>
<span class="nc" id="L254">                        sel.connectFailed(uri, paddr, ioe);</span>
<span class="nc" id="L255">                        http = null;</span>
                    }
<span class="nc" id="L257">                }</span>
            }
<span class="fc" id="L259">        } else { // per connection proxy specified</span>
<span class="nc" id="L260">            p = instProxy;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (p.type() == Proxy.Type.HTTP) {</span>
<span class="nc" id="L262">                http = new HttpURLConnection(url, instProxy);</span>
<span class="nc" id="L263">                http.setDoInput(getDoInput());</span>
<span class="nc" id="L264">                http.setDoOutput(getDoOutput());</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                if (connectTimeout &gt;= 0) {</span>
<span class="nc" id="L266">                    http.setConnectTimeout(connectTimeout);</span>
                }
<span class="nc bnc" id="L268" title="All 2 branches missed.">                if (readTimeout &gt;= 0) {</span>
<span class="nc" id="L269">                    http.setReadTimeout(readTimeout);</span>
                }
<span class="nc" id="L271">                http.connect();</span>
<span class="nc" id="L272">                connected = true;</span>
<span class="nc" id="L273">                return;</span>
            }
        }

<span class="fc bfc" id="L277" title="All 2 branches covered.">        if (user == null) {</span>
<span class="fc" id="L278">            user = &quot;anonymous&quot;;</span>
<span class="fc" id="L279">            String vers = java.security.AccessController.doPrivileged(</span>
                    new GetPropertyAction(&quot;java.version&quot;));
<span class="fc" id="L281">            password = java.security.AccessController.doPrivileged(</span>
                    new GetPropertyAction(&quot;ftp.protocol.user&quot;,
                                          &quot;Java&quot; + vers + &quot;@&quot;));
        }
        try {
<span class="fc" id="L286">            ftp = FtpClient.create();</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">            if (p != null) {</span>
<span class="fc" id="L288">                ftp.setProxy(p);</span>
            }
<span class="fc" id="L290">            setTimeouts();</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">            if (port != -1) {</span>
<span class="fc" id="L292">                ftp.connect(new InetSocketAddress(host, port));</span>
            } else {
<span class="nc" id="L294">                ftp.connect(new InetSocketAddress(host, FtpClient.defaultPort()));</span>
            }
<span class="nc" id="L296">        } catch (UnknownHostException e) {</span>
            // Maybe do something smart here, like use a proxy like iftp.
            // Just keep throwing for now.
<span class="nc" id="L299">            throw e;</span>
<span class="nc" id="L300">        } catch (FtpProtocolException fe) {</span>
<span class="nc" id="L301">            throw new IOException(fe);</span>
<span class="fc" id="L302">        }</span>
        try {
<span class="fc" id="L304">            ftp.login(user, password.toCharArray());</span>
<span class="fc" id="L305">        } catch (sun.net.ftp.FtpProtocolException e) {</span>
<span class="fc" id="L306">            ftp.close();</span>
            // Backward compatibility
<span class="fc" id="L308">            throw new sun.net.ftp.FtpLoginException(&quot;Invalid username/password&quot;);</span>
<span class="fc" id="L309">        }</span>
<span class="fc" id="L310">        connected = true;</span>
<span class="fc" id="L311">    }</span>


    /*
     * Decodes the path as per the RFC-1738 specifications.
     */
    private void decodePath(String path) {
<span class="fc" id="L318">        int i = path.indexOf(&quot;;type=&quot;);</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">        if (i &gt;= 0) {</span>
<span class="fc" id="L320">            String s1 = path.substring(i + 6, path.length());</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">            if (&quot;i&quot;.equalsIgnoreCase(s1)) {</span>
<span class="nc" id="L322">                type = BIN;</span>
            }
<span class="fc bfc" id="L324" title="All 2 branches covered.">            if (&quot;a&quot;.equalsIgnoreCase(s1)) {</span>
<span class="fc" id="L325">                type = ASCII;</span>
            }
<span class="fc bfc" id="L327" title="All 2 branches covered.">            if (&quot;d&quot;.equalsIgnoreCase(s1)) {</span>
<span class="fc" id="L328">                type = DIR;</span>
            }
<span class="fc" id="L330">            path = path.substring(0, i);</span>
        }
<span class="pc bpc" id="L332" title="2 of 4 branches missed.">        if (path != null &amp;&amp; path.length() &gt; 1 &amp;&amp;</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">                path.charAt(0) == '/') {</span>
<span class="fc" id="L334">            path = path.substring(1);</span>
        }
<span class="pc bpc" id="L336" title="2 of 4 branches missed.">        if (path == null || path.length() == 0) {</span>
<span class="nc" id="L337">            path = &quot;./&quot;;</span>
        }
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">        if (!path.endsWith(&quot;/&quot;)) {</span>
<span class="fc" id="L340">            i = path.lastIndexOf('/');</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">            if (i &gt; 0) {</span>
<span class="fc" id="L342">                filename = path.substring(i + 1, path.length());</span>
<span class="fc" id="L343">                filename = ParseUtil.decode(filename);</span>
<span class="fc" id="L344">                pathname = path.substring(0, i);</span>
            } else {
<span class="fc" id="L346">                filename = ParseUtil.decode(path);</span>
<span class="fc" id="L347">                pathname = null;</span>
            }
        } else {
<span class="nc" id="L350">            pathname = path.substring(0, path.length() - 1);</span>
<span class="nc" id="L351">            filename = null;</span>
        }
<span class="fc bfc" id="L353" title="All 2 branches covered.">        if (pathname != null) {</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">            fullpath = pathname + &quot;/&quot; + (filename != null ? filename : &quot;&quot;);</span>
        } else {
<span class="fc" id="L356">            fullpath = filename;</span>
        }
<span class="fc" id="L358">    }</span>

    /*
     * As part of RFC-1738 it is specified that the path should be
     * interpreted as a series of FTP CWD commands.
     * This is because, '/' is not necessarly the directory delimiter
     * on every systems.
     */
    private void cd(String path) throws FtpProtocolException, IOException {
<span class="pc bpc" id="L367" title="1 of 4 branches missed.">        if (path == null || path.isEmpty()) {</span>
<span class="fc" id="L368">            return;</span>
        }
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">        if (path.indexOf('/') == -1) {</span>
<span class="fc" id="L371">            ftp.changeDirectory(ParseUtil.decode(path));</span>
<span class="fc" id="L372">            return;</span>
        }

<span class="nc" id="L375">        StringTokenizer token = new StringTokenizer(path, &quot;/&quot;);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        while (token.hasMoreTokens()) {</span>
<span class="nc" id="L377">            ftp.changeDirectory(ParseUtil.decode(token.nextToken()));</span>
        }
<span class="nc" id="L379">    }</span>

    /**
     * Get the InputStream to retreive the remote file. It will issue the
     * &quot;get&quot; (or &quot;dir&quot;) command to the ftp server.
     *
     * @return  the &lt;code&gt;InputStream&lt;/code&gt; to the connection.
     *
     * @throws  IOException if already opened for output
     * @throws  FtpProtocolException if errors occur during the transfert.
     */
    @Override
    public InputStream getInputStream() throws IOException {
<span class="fc bfc" id="L392" title="All 2 branches covered.">        if (!connected) {</span>
<span class="fc" id="L393">            connect();</span>
        }

<span class="pc bpc" id="L396" title="1 of 2 branches missed.">        if (http != null) {</span>
<span class="nc" id="L397">            return http.getInputStream();</span>
        }

<span class="pc bpc" id="L400" title="1 of 2 branches missed.">        if (os != null) {</span>
<span class="nc" id="L401">            throw new IOException(&quot;Already opened for output&quot;);</span>
        }

<span class="fc bfc" id="L404" title="All 2 branches covered.">        if (is != null) {</span>
<span class="fc" id="L405">            return is;</span>
        }

<span class="fc" id="L408">        MessageHeader msgh = new MessageHeader();</span>

<span class="fc" id="L410">        boolean isAdir = false;</span>
        try {
<span class="fc" id="L412">            decodePath(url.getPath());</span>
<span class="pc bpc" id="L413" title="1 of 4 branches missed.">            if (filename == null || type == DIR) {</span>
<span class="fc" id="L414">                ftp.setAsciiType();</span>
<span class="fc" id="L415">                cd(pathname);</span>
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">                if (filename == null) {</span>
<span class="nc" id="L417">                    is = new FtpInputStream(ftp, ftp.list(null));</span>
                } else {
<span class="fc" id="L419">                    is = new FtpInputStream(ftp, ftp.nameList(filename));</span>
                }
            } else {
<span class="fc bfc" id="L422" title="All 2 branches covered.">                if (type == ASCII) {</span>
<span class="fc" id="L423">                    ftp.setAsciiType();</span>
                } else {
<span class="fc" id="L425">                    ftp.setBinaryType();</span>
                }
<span class="fc" id="L427">                cd(pathname);</span>
<span class="fc" id="L428">                is = new FtpInputStream(ftp, ftp.getFileStream(filename));</span>
            }

            /* Try to get the size of the file in bytes.  If that is
            successful, then create a MeteredStream. */
            try {
<span class="fc" id="L434">                long l = ftp.getLastTransferSize();</span>
<span class="fc" id="L435">                msgh.add(&quot;content-length&quot;, Long.toString(l));</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">                if (l &gt; 0) {</span>

                    // Wrap input stream with MeteredStream to ensure read() will always return -1
                    // at expected length.

                    // Check if URL should be metered
<span class="nc" id="L442">                    boolean meteredInput = ProgressMonitor.getDefault().shouldMeterInput(url, &quot;GET&quot;);</span>
<span class="nc" id="L443">                    ProgressSource pi = null;</span>

<span class="nc bnc" id="L445" title="All 2 branches missed.">                    if (meteredInput) {</span>
<span class="nc" id="L446">                        pi = new ProgressSource(url, &quot;GET&quot;, l);</span>
<span class="nc" id="L447">                        pi.beginTracking();</span>
                    }

<span class="nc" id="L450">                    is = new MeteredStream(is, pi, l);</span>
                }
<span class="nc" id="L452">            } catch (Exception e) {</span>
<span class="nc" id="L453">                e.printStackTrace();</span>
            /* do nothing, since all we were doing was trying to
            get the size in bytes of the file */
<span class="fc" id="L456">            }</span>

<span class="pc bpc" id="L458" title="1 of 2 branches missed.">            if (isAdir) {</span>
<span class="nc" id="L459">                msgh.add(&quot;content-type&quot;, &quot;text/plain&quot;);</span>
<span class="nc" id="L460">                msgh.add(&quot;access-type&quot;, &quot;directory&quot;);</span>
            } else {
<span class="fc" id="L462">                msgh.add(&quot;access-type&quot;, &quot;file&quot;);</span>
<span class="fc" id="L463">                String ftype = guessContentTypeFromName(fullpath);</span>
<span class="pc bpc" id="L464" title="2 of 4 branches missed.">                if (ftype == null &amp;&amp; is.markSupported()) {</span>
<span class="fc" id="L465">                    ftype = guessContentTypeFromStream(is);</span>
                }
<span class="pc bpc" id="L467" title="1 of 2 branches missed.">                if (ftype != null) {</span>
<span class="nc" id="L468">                    msgh.add(&quot;content-type&quot;, ftype);</span>
                }
            }
<span class="nc" id="L471">        } catch (FileNotFoundException e) {</span>
            try {
<span class="nc" id="L473">                cd(fullpath);</span>
                /* if that worked, then make a directory listing
                and build an html stream with all the files in
                the directory */
<span class="nc" id="L477">                ftp.setAsciiType();</span>

<span class="nc" id="L479">                is = new FtpInputStream(ftp, ftp.list(null));</span>
<span class="nc" id="L480">                msgh.add(&quot;content-type&quot;, &quot;text/plain&quot;);</span>
<span class="nc" id="L481">                msgh.add(&quot;access-type&quot;, &quot;directory&quot;);</span>
<span class="nc" id="L482">            } catch (IOException ex) {</span>
<span class="nc" id="L483">                throw new FileNotFoundException(fullpath);</span>
<span class="nc" id="L484">            } catch (FtpProtocolException ex2) {</span>
<span class="nc" id="L485">                throw new FileNotFoundException(fullpath);</span>
<span class="nc" id="L486">            }</span>
<span class="nc" id="L487">        } catch (FtpProtocolException ftpe) {</span>
<span class="nc" id="L488">            throw new IOException(ftpe);</span>
<span class="pc" id="L489">        }</span>
<span class="fc" id="L490">        setProperties(msgh);</span>
<span class="fc" id="L491">        return is;</span>
    }

    /**
     * Get the OutputStream to store the remote file. It will issue the
     * &quot;put&quot; command to the ftp server.
     *
     * @return  the &lt;code&gt;OutputStream&lt;/code&gt; to the connection.
     *
     * @throws  IOException if already opened for input or the URL
     *          points to a directory
     * @throws  FtpProtocolException if errors occur during the transfert.
     */
    @Override
    public OutputStream getOutputStream() throws IOException {
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (!connected) {</span>
<span class="nc" id="L507">            connect();</span>
        }

<span class="nc bnc" id="L510" title="All 2 branches missed.">        if (http != null) {</span>
<span class="nc" id="L511">            OutputStream out = http.getOutputStream();</span>
            // getInputStream() is neccessary to force a writeRequests()
            // on the http client.
<span class="nc" id="L514">            http.getInputStream();</span>
<span class="nc" id="L515">            return out;</span>
        }

<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (is != null) {</span>
<span class="nc" id="L519">            throw new IOException(&quot;Already opened for input&quot;);</span>
        }

<span class="nc bnc" id="L522" title="All 2 branches missed.">        if (os != null) {</span>
<span class="nc" id="L523">            return os;</span>
        }

<span class="nc" id="L526">        decodePath(url.getPath());</span>
<span class="nc bnc" id="L527" title="All 4 branches missed.">        if (filename == null || filename.length() == 0) {</span>
<span class="nc" id="L528">            throw new IOException(&quot;illegal filename for a PUT&quot;);</span>
        }
        try {
<span class="nc bnc" id="L531" title="All 2 branches missed.">            if (pathname != null) {</span>
<span class="nc" id="L532">                cd(pathname);</span>
            }
<span class="nc bnc" id="L534" title="All 2 branches missed.">            if (type == ASCII) {</span>
<span class="nc" id="L535">                ftp.setAsciiType();</span>
            } else {
<span class="nc" id="L537">                ftp.setBinaryType();</span>
            }
<span class="nc" id="L539">            os = new FtpOutputStream(ftp, ftp.putFileStream(filename, false));</span>
<span class="nc" id="L540">        } catch (FtpProtocolException e) {</span>
<span class="nc" id="L541">            throw new IOException(e);</span>
<span class="nc" id="L542">        }</span>
<span class="nc" id="L543">        return os;</span>
    }

    String guessContentTypeFromFilename(String fname) {
<span class="nc" id="L547">        return guessContentTypeFromName(fname);</span>
    }

    /**
     * Gets the &lt;code&gt;Permission&lt;/code&gt; associated with the host &amp; port.
     *
     * @return  The &lt;code&gt;Permission&lt;/code&gt; object.
     */
    @Override
    public Permission getPermission() {
<span class="nc bnc" id="L557" title="All 2 branches missed.">        if (permission == null) {</span>
<span class="nc" id="L558">            int urlport = url.getPort();</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">            urlport = urlport &lt; 0 ? FtpClient.defaultPort() : urlport;</span>
<span class="nc" id="L560">            String urlhost = this.host + &quot;:&quot; + urlport;</span>
<span class="nc" id="L561">            permission = new SocketPermission(urlhost, &quot;connect&quot;);</span>
        }
<span class="nc" id="L563">        return permission;</span>
    }

    /**
     * Sets the general request property. If a property with the key already
     * exists, overwrite its value with the new value.
     *
     * @param   key     the keyword by which the request is known
     *                  (e.g., &quot;&lt;code&gt;accept&lt;/code&gt;&quot;).
     * @param   value   the value associated with it.
     * @throws IllegalStateException if already connected
     * @see #getRequestProperty(java.lang.String)
     */
    @Override
    public void setRequestProperty(String key, String value) {
<span class="nc" id="L578">        super.setRequestProperty(key, value);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">        if (&quot;type&quot;.equals(key)) {</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">            if (&quot;i&quot;.equalsIgnoreCase(value)) {</span>
<span class="nc" id="L581">                type = BIN;</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">            } else if (&quot;a&quot;.equalsIgnoreCase(value)) {</span>
<span class="nc" id="L583">                type = ASCII;</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">            } else if (&quot;d&quot;.equalsIgnoreCase(value)) {</span>
<span class="nc" id="L585">                type = DIR;</span>
            } else {
<span class="nc" id="L587">                throw new IllegalArgumentException(</span>
                        &quot;Value of '&quot; + key +
                        &quot;' request property was '&quot; + value +
                        &quot;' when it must be either 'i', 'a' or 'd'&quot;);
            }
        }
<span class="nc" id="L593">    }</span>

    /**
     * Returns the value of the named general request property for this
     * connection.
     *
     * @param key the keyword by which the request is known (e.g., &quot;accept&quot;).
     * @return  the value of the named general request property for this
     *           connection.
     * @throws IllegalStateException if already connected
     * @see #setRequestProperty(java.lang.String, java.lang.String)
     */
    @Override
    public String getRequestProperty(String key) {
<span class="fc" id="L607">        String value = super.getRequestProperty(key);</span>

<span class="pc bpc" id="L609" title="1 of 2 branches missed.">        if (value == null) {</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">            if (&quot;type&quot;.equals(key)) {</span>
<span class="nc bnc" id="L611" title="All 4 branches missed.">                value = (type == ASCII ? &quot;a&quot; : type == DIR ? &quot;d&quot; : &quot;i&quot;);</span>
            }
        }

<span class="fc" id="L615">        return value;</span>
    }

    @Override
    public void setConnectTimeout(int timeout) {
<span class="nc bnc" id="L620" title="All 2 branches missed.">        if (timeout &lt; 0) {</span>
<span class="nc" id="L621">            throw new IllegalArgumentException(&quot;timeouts can't be negative&quot;);</span>
        }
<span class="nc" id="L623">        connectTimeout = timeout;</span>
<span class="nc" id="L624">    }</span>

    @Override
    public int getConnectTimeout() {
<span class="nc bnc" id="L628" title="All 2 branches missed.">        return (connectTimeout &lt; 0 ? 0 : connectTimeout);</span>
    }

    @Override
    public void setReadTimeout(int timeout) {
<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (timeout &lt; 0) {</span>
<span class="nc" id="L634">            throw new IllegalArgumentException(&quot;timeouts can't be negative&quot;);</span>
        }
<span class="nc" id="L636">        readTimeout = timeout;</span>
<span class="nc" id="L637">    }</span>

    @Override
    public int getReadTimeout() {
<span class="nc bnc" id="L641" title="All 2 branches missed.">        return readTimeout &lt; 0 ? 0 : readTimeout;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>