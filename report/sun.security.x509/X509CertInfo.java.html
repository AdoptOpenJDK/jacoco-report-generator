<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>X509CertInfo.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.security.x509</a> &gt; <span class="el_source">X509CertInfo.java</span></div><h1>X509CertInfo.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.x509;

import java.io.IOException;
import java.io.OutputStream;

import java.security.cert.*;
import java.util.*;

import sun.security.util.*;
import sun.misc.HexDumpEncoder;


/**
 * The X509CertInfo class represents X.509 certificate information.
 *
 * &lt;P&gt;X.509 certificates have several base data elements, including:&lt;UL&gt;
 *
 * &lt;LI&gt;The &lt;em&gt;Subject Name&lt;/em&gt;, an X.500 Distinguished Name for
 *      the entity (subject) for which the certificate was issued.
 *
 * &lt;LI&gt;The &lt;em&gt;Subject Public Key&lt;/em&gt;, the public key of the subject.
 *      This is one of the most important parts of the certificate.
 *
 * &lt;LI&gt;The &lt;em&gt;Validity Period&lt;/em&gt;, a time period (e.g. six months)
 *      within which the certificate is valid (unless revoked).
 *
 * &lt;LI&gt;The &lt;em&gt;Issuer Name&lt;/em&gt;, an X.500 Distinguished Name for the
 *      Certificate Authority (CA) which issued the certificate.
 *
 * &lt;LI&gt;A &lt;em&gt;Serial Number&lt;/em&gt; assigned by the CA, for use in
 *      certificate revocation and other applications.
 *
 * @author Amit Kapoor
 * @author Hemma Prafullchandra
 * @see CertAttrSet
 * @see X509CertImpl
 */
public class X509CertInfo implements CertAttrSet&lt;String&gt; {
    /**
     * Identifier for this attribute, to be used with the
     * get, set, delete methods of Certificate, x509 type.
     */
    public static final String IDENT = &quot;x509.info&quot;;
    // Certificate attribute names
    public static final String NAME = &quot;info&quot;;
    public static final String DN_NAME = &quot;dname&quot;;
    public static final String VERSION = CertificateVersion.NAME;
    public static final String SERIAL_NUMBER = CertificateSerialNumber.NAME;
    public static final String ALGORITHM_ID = CertificateAlgorithmId.NAME;
    public static final String ISSUER = &quot;issuer&quot;;
    public static final String SUBJECT = &quot;subject&quot;;
    public static final String VALIDITY = CertificateValidity.NAME;
    public static final String KEY = CertificateX509Key.NAME;
    public static final String ISSUER_ID = &quot;issuerID&quot;;
    public static final String SUBJECT_ID = &quot;subjectID&quot;;
    public static final String EXTENSIONS = CertificateExtensions.NAME;

    // X509.v1 data
<span class="pc" id="L84">    protected CertificateVersion version = new CertificateVersion();</span>
<span class="pc" id="L85">    protected CertificateSerialNumber   serialNum = null;</span>
<span class="pc" id="L86">    protected CertificateAlgorithmId    algId = null;</span>
<span class="pc" id="L87">    protected X500Name                  issuer = null;</span>
<span class="pc" id="L88">    protected X500Name                  subject = null;</span>
<span class="pc" id="L89">    protected CertificateValidity       interval = null;</span>
<span class="pc" id="L90">    protected CertificateX509Key        pubKey = null;</span>

    // X509.v2 &amp; v3 extensions
<span class="pc" id="L93">    protected UniqueIdentity   issuerUniqueId = null;</span>
<span class="pc" id="L94">    protected UniqueIdentity  subjectUniqueId = null;</span>

    // X509.v3 extensions
<span class="pc" id="L97">    protected CertificateExtensions     extensions = null;</span>

    // Attribute numbers for internal manipulation
    private static final int ATTR_VERSION = 1;
    private static final int ATTR_SERIAL = 2;
    private static final int ATTR_ALGORITHM = 3;
    private static final int ATTR_ISSUER = 4;
    private static final int ATTR_VALIDITY = 5;
    private static final int ATTR_SUBJECT = 6;
    private static final int ATTR_KEY = 7;
    private static final int ATTR_ISSUER_ID = 8;
    private static final int ATTR_SUBJECT_ID = 9;
    private static final int ATTR_EXTENSIONS = 10;

    // DER encoded CertificateInfo data
<span class="pc" id="L112">    private byte[]      rawCertInfo = null;</span>

    // The certificate attribute name to integer mapping stored here
<span class="fc" id="L115">    private static final Map&lt;String,Integer&gt; map = new HashMap&lt;String,Integer&gt;();</span>
    static {
<span class="fc" id="L117">        map.put(VERSION, Integer.valueOf(ATTR_VERSION));</span>
<span class="fc" id="L118">        map.put(SERIAL_NUMBER, Integer.valueOf(ATTR_SERIAL));</span>
<span class="fc" id="L119">        map.put(ALGORITHM_ID, Integer.valueOf(ATTR_ALGORITHM));</span>
<span class="fc" id="L120">        map.put(ISSUER, Integer.valueOf(ATTR_ISSUER));</span>
<span class="fc" id="L121">        map.put(VALIDITY, Integer.valueOf(ATTR_VALIDITY));</span>
<span class="fc" id="L122">        map.put(SUBJECT, Integer.valueOf(ATTR_SUBJECT));</span>
<span class="fc" id="L123">        map.put(KEY, Integer.valueOf(ATTR_KEY));</span>
<span class="fc" id="L124">        map.put(ISSUER_ID, Integer.valueOf(ATTR_ISSUER_ID));</span>
<span class="fc" id="L125">        map.put(SUBJECT_ID, Integer.valueOf(ATTR_SUBJECT_ID));</span>
<span class="fc" id="L126">        map.put(EXTENSIONS, Integer.valueOf(ATTR_EXTENSIONS));</span>
<span class="fc" id="L127">    }</span>

    /**
     * Construct an uninitialized X509CertInfo on which &lt;a href=&quot;#decode&quot;&gt;
     * decode&lt;/a&gt; must later be called (or which may be deserialized).
     */
<span class="nc" id="L133">    public X509CertInfo() { }</span>

    /**
     * Unmarshals a certificate from its encoded form, parsing the
     * encoded bytes.  This form of constructor is used by agents which
     * need to examine and use certificate contents.  That is, this is
     * one of the more commonly used constructors.  Note that the buffer
     * must include only a certificate, and no &quot;garbage&quot; may be left at
     * the end.  If you need to ignore data at the end of a certificate,
     * use another constructor.
     *
     * @param cert the encoded bytes, with no trailing data.
     * @exception CertificateParsingException on parsing errors.
     */
<span class="nc" id="L147">    public X509CertInfo(byte[] cert) throws CertificateParsingException {</span>
        try {
<span class="nc" id="L149">            DerValue    in = new DerValue(cert);</span>

<span class="nc" id="L151">            parse(in);</span>
<span class="nc" id="L152">        } catch (IOException e) {</span>
<span class="nc" id="L153">            throw new CertificateParsingException(e);</span>
<span class="nc" id="L154">        }</span>
<span class="nc" id="L155">    }</span>

    /**
     * Unmarshal a certificate from its encoded form, parsing a DER value.
     * This form of constructor is used by agents which need to examine
     * and use certificate contents.
     *
     * @param derVal the der value containing the encoded cert.
     * @exception CertificateParsingException on parsing errors.
     */
<span class="fc" id="L165">    public X509CertInfo(DerValue derVal) throws CertificateParsingException {</span>
        try {
<span class="fc" id="L167">            parse(derVal);</span>
<span class="fc" id="L168">        } catch (IOException e) {</span>
<span class="fc" id="L169">            throw new CertificateParsingException(e);</span>
<span class="fc" id="L170">        }</span>
<span class="fc" id="L171">    }</span>

    /**
     * Appends the certificate to an output stream.
     *
     * @param out an output stream to which the certificate is appended.
     * @exception CertificateException on encoding errors.
     * @exception IOException on other errors.
     */
    public void encode(OutputStream out)
    throws CertificateException, IOException {
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (rawCertInfo == null) {</span>
<span class="nc" id="L183">            DerOutputStream tmp = new DerOutputStream();</span>
<span class="nc" id="L184">            emit(tmp);</span>
<span class="nc" id="L185">            rawCertInfo = tmp.toByteArray();</span>
        }
<span class="nc" id="L187">        out.write(rawCertInfo.clone());</span>
<span class="nc" id="L188">    }</span>

    /**
     * Return an enumeration of names of attributes existing within this
     * attribute.
     */
    public Enumeration&lt;String&gt; getElements() {
<span class="nc" id="L195">        AttributeNameEnumeration elements = new AttributeNameEnumeration();</span>
<span class="nc" id="L196">        elements.addElement(VERSION);</span>
<span class="nc" id="L197">        elements.addElement(SERIAL_NUMBER);</span>
<span class="nc" id="L198">        elements.addElement(ALGORITHM_ID);</span>
<span class="nc" id="L199">        elements.addElement(ISSUER);</span>
<span class="nc" id="L200">        elements.addElement(VALIDITY);</span>
<span class="nc" id="L201">        elements.addElement(SUBJECT);</span>
<span class="nc" id="L202">        elements.addElement(KEY);</span>
<span class="nc" id="L203">        elements.addElement(ISSUER_ID);</span>
<span class="nc" id="L204">        elements.addElement(SUBJECT_ID);</span>
<span class="nc" id="L205">        elements.addElement(EXTENSIONS);</span>

<span class="nc" id="L207">        return elements.elements();</span>
    }

    /**
     * Return the name of this attribute.
     */
    public String getName() {
<span class="nc" id="L214">        return(NAME);</span>
    }

    /**
     * Returns the encoded certificate info.
     *
     * @exception CertificateEncodingException on encoding information errors.
     */
    public byte[] getEncodedInfo() throws CertificateEncodingException {
        try {
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">            if (rawCertInfo == null) {</span>
<span class="nc" id="L225">                DerOutputStream tmp = new DerOutputStream();</span>
<span class="nc" id="L226">                emit(tmp);</span>
<span class="nc" id="L227">                rawCertInfo = tmp.toByteArray();</span>
            }
<span class="fc" id="L229">            return rawCertInfo.clone();</span>
<span class="nc" id="L230">        } catch (IOException e) {</span>
<span class="nc" id="L231">            throw new CertificateEncodingException(e.toString());</span>
<span class="nc" id="L232">        } catch (CertificateException e) {</span>
<span class="nc" id="L233">            throw new CertificateEncodingException(e.toString());</span>
        }
    }

    /**
     * Compares two X509CertInfo objects.  This is false if the
     * certificates are not both X.509 certs, otherwise it
     * compares them as binary data.
     *
     * @param other the object being compared with this one
     * @return true iff the certificates are equivalent
     */
    public boolean equals(Object other) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (other instanceof X509CertInfo) {</span>
<span class="nc" id="L247">            return equals((X509CertInfo) other);</span>
        } else {
<span class="nc" id="L249">            return false;</span>
        }
    }

    /**
     * Compares two certificates, returning false if any data
     * differs between the two.
     *
     * @param other the object being compared with this one
     * @return true iff the certificates are equivalent
     */
    public boolean equals(X509CertInfo other) {
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (this == other) {</span>
<span class="nc" id="L262">            return(true);</span>
<span class="nc bnc" id="L263" title="All 4 branches missed.">        } else if (rawCertInfo == null || other.rawCertInfo == null) {</span>
<span class="nc" id="L264">            return(false);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        } else if (rawCertInfo.length != other.rawCertInfo.length) {</span>
<span class="nc" id="L266">            return(false);</span>
        }
<span class="nc bnc" id="L268" title="All 2 branches missed.">        for (int i = 0; i &lt; rawCertInfo.length; i++) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            if (rawCertInfo[i] != other.rawCertInfo[i]) {</span>
<span class="nc" id="L270">                return(false);</span>
            }
        }
<span class="nc" id="L273">        return(true);</span>
    }

    /**
     * Calculates a hash code value for the object.  Objects
     * which are equal will also have the same hashcode.
     */
    public int hashCode() {
<span class="nc" id="L281">        int     retval = 0;</span>

<span class="nc bnc" id="L283" title="All 2 branches missed.">        for (int i = 1; i &lt; rawCertInfo.length; i++) {</span>
<span class="nc" id="L284">            retval += rawCertInfo[i] * i;</span>
        }
<span class="nc" id="L286">        return(retval);</span>
    }

    /**
     * Returns a printable representation of the certificate.
     */
    public String toString() {

<span class="pc bpc" id="L294" title="6 of 12 branches missed.">        if (subject == null || pubKey == null || interval == null</span>
            || issuer == null || algId == null || serialNum == null) {
<span class="nc" id="L296">                throw new NullPointerException(&quot;X.509 cert is incomplete&quot;);</span>
        }
<span class="fc" id="L298">        StringBuilder sb = new StringBuilder();</span>

<span class="fc" id="L300">        sb.append(&quot;[\n&quot;);</span>
<span class="fc" id="L301">        sb.append(&quot;  &quot; + version.toString() + &quot;\n&quot;);</span>
<span class="fc" id="L302">        sb.append(&quot;  Subject: &quot; + subject.toString() + &quot;\n&quot;);</span>
<span class="fc" id="L303">        sb.append(&quot;  Signature Algorithm: &quot; + algId.toString() + &quot;\n&quot;);</span>
<span class="fc" id="L304">        sb.append(&quot;  Key:  &quot; + pubKey.toString() + &quot;\n&quot;);</span>
<span class="fc" id="L305">        sb.append(&quot;  &quot; + interval.toString() + &quot;\n&quot;);</span>
<span class="fc" id="L306">        sb.append(&quot;  Issuer: &quot; + issuer.toString() + &quot;\n&quot;);</span>
<span class="fc" id="L307">        sb.append(&quot;  &quot; + serialNum.toString() + &quot;\n&quot;);</span>

        // optional v2, v3 extras
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">        if (issuerUniqueId != null) {</span>
<span class="nc" id="L311">            sb.append(&quot;  Issuer Id:\n&quot; + issuerUniqueId.toString() + &quot;\n&quot;);</span>
        }
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">        if (subjectUniqueId != null) {</span>
<span class="nc" id="L314">            sb.append(&quot;  Subject Id:\n&quot; + subjectUniqueId.toString() + &quot;\n&quot;);</span>
        }
<span class="fc bfc" id="L316" title="All 2 branches covered.">        if (extensions != null) {</span>
<span class="fc" id="L317">            Collection&lt;Extension&gt; allExts = extensions.getAllExtensions();</span>
<span class="fc" id="L318">            Extension[] exts = allExts.toArray(new Extension[0]);</span>
<span class="fc" id="L319">            sb.append(&quot;\nCertificate Extensions: &quot; + exts.length);</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">            for (int i = 0; i &lt; exts.length; i++) {</span>
<span class="fc" id="L321">                sb.append(&quot;\n[&quot; + (i+1) + &quot;]: &quot;);</span>
<span class="fc" id="L322">                Extension ext = exts[i];</span>
                try {
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">                    if (OIDMap.getClass(ext.getExtensionId()) == null) {</span>
<span class="nc" id="L325">                        sb.append(ext.toString());</span>
<span class="nc" id="L326">                        byte[] extValue = ext.getExtensionValue();</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                        if (extValue != null) {</span>
<span class="nc" id="L328">                            DerOutputStream out = new DerOutputStream();</span>
<span class="nc" id="L329">                            out.putOctetString(extValue);</span>
<span class="nc" id="L330">                            extValue = out.toByteArray();</span>
<span class="nc" id="L331">                            HexDumpEncoder enc = new HexDumpEncoder();</span>
<span class="nc" id="L332">                            sb.append(&quot;Extension unknown: &quot;</span>
                                      + &quot;DER encoded OCTET string =\n&quot;
<span class="nc" id="L334">                                      + enc.encodeBuffer(extValue) + &quot;\n&quot;);</span>
                        }
<span class="nc" id="L336">                    } else</span>
<span class="fc" id="L337">                        sb.append(ext.toString()); //sub-class exists</span>
<span class="nc" id="L338">                } catch (Exception e) {</span>
<span class="nc" id="L339">                    sb.append(&quot;, Error parsing this extension&quot;);</span>
<span class="fc" id="L340">                }</span>
            }
<span class="fc" id="L342">            Map&lt;String,Extension&gt; invalid = extensions.getUnparseableExtensions();</span>
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">            if (invalid.isEmpty() == false) {</span>
<span class="nc" id="L344">                sb.append(&quot;\nUnparseable certificate extensions: &quot; + invalid.size());</span>
<span class="nc" id="L345">                int i = 1;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                for (Extension ext : invalid.values()) {</span>
<span class="nc" id="L347">                    sb.append(&quot;\n[&quot; + (i++) + &quot;]: &quot;);</span>
<span class="nc" id="L348">                    sb.append(ext);</span>
<span class="nc" id="L349">                }</span>
            }
        }
<span class="fc" id="L352">        sb.append(&quot;\n]&quot;);</span>
<span class="fc" id="L353">        return sb.toString();</span>
    }

    /**
     * Set the certificate attribute.
     *
     * @params name the name of the Certificate attribute.
     * @params val the value of the Certificate attribute.
     * @exception CertificateException on invalid attributes.
     * @exception IOException on other errors.
     */
    public void set(String name, Object val)
    throws CertificateException, IOException {
<span class="nc" id="L366">        X509AttributeName attrName = new X509AttributeName(name);</span>

<span class="nc" id="L368">        int attr = attributeMap(attrName.getPrefix());</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (attr == 0) {</span>
<span class="nc" id="L370">            throw new CertificateException(&quot;Attribute name not recognized: &quot;</span>
                                           + name);
        }
        // set rawCertInfo to null, so that we are forced to re-encode
<span class="nc" id="L374">        rawCertInfo = null;</span>
<span class="nc" id="L375">        String suffix = attrName.getSuffix();</span>

<span class="nc bnc" id="L377" title="All 11 branches missed.">        switch (attr) {</span>
        case ATTR_VERSION:
<span class="nc bnc" id="L379" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L380">                setVersion(val);</span>
            } else {
<span class="nc" id="L382">                version.set(suffix, val);</span>
            }
<span class="nc" id="L384">            break;</span>

        case ATTR_SERIAL:
<span class="nc bnc" id="L387" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L388">                setSerialNumber(val);</span>
            } else {
<span class="nc" id="L390">                serialNum.set(suffix, val);</span>
            }
<span class="nc" id="L392">            break;</span>

        case ATTR_ALGORITHM:
<span class="nc bnc" id="L395" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L396">                setAlgorithmId(val);</span>
            } else {
<span class="nc" id="L398">                algId.set(suffix, val);</span>
            }
<span class="nc" id="L400">            break;</span>

        case ATTR_ISSUER:
<span class="nc" id="L403">            setIssuer(val);</span>
<span class="nc" id="L404">            break;</span>

        case ATTR_VALIDITY:
<span class="nc bnc" id="L407" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L408">                setValidity(val);</span>
            } else {
<span class="nc" id="L410">                interval.set(suffix, val);</span>
            }
<span class="nc" id="L412">            break;</span>

        case ATTR_SUBJECT:
<span class="nc" id="L415">            setSubject(val);</span>
<span class="nc" id="L416">            break;</span>

        case ATTR_KEY:
<span class="nc bnc" id="L419" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L420">                setKey(val);</span>
            } else {
<span class="nc" id="L422">                pubKey.set(suffix, val);</span>
            }
<span class="nc" id="L424">            break;</span>

        case ATTR_ISSUER_ID:
<span class="nc" id="L427">            setIssuerUniqueId(val);</span>
<span class="nc" id="L428">            break;</span>

        case ATTR_SUBJECT_ID:
<span class="nc" id="L431">            setSubjectUniqueId(val);</span>
<span class="nc" id="L432">            break;</span>

        case ATTR_EXTENSIONS:
<span class="nc bnc" id="L435" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L436">                setExtensions(val);</span>
            } else {
<span class="nc bnc" id="L438" title="All 2 branches missed.">                if (extensions == null)</span>
<span class="nc" id="L439">                    extensions = new CertificateExtensions();</span>
<span class="nc" id="L440">                extensions.set(suffix, val);</span>
            }
            break;
        }
<span class="nc" id="L444">    }</span>

    /**
     * Delete the certificate attribute.
     *
     * @params name the name of the Certificate attribute.
     * @exception CertificateException on invalid attributes.
     * @exception IOException on other errors.
     */
    public void delete(String name)
    throws CertificateException, IOException {
<span class="nc" id="L455">        X509AttributeName attrName = new X509AttributeName(name);</span>

<span class="nc" id="L457">        int attr = attributeMap(attrName.getPrefix());</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">        if (attr == 0) {</span>
<span class="nc" id="L459">            throw new CertificateException(&quot;Attribute name not recognized: &quot;</span>
                                           + name);
        }
        // set rawCertInfo to null, so that we are forced to re-encode
<span class="nc" id="L463">        rawCertInfo = null;</span>
<span class="nc" id="L464">        String suffix = attrName.getSuffix();</span>

<span class="nc bnc" id="L466" title="All 11 branches missed.">        switch (attr) {</span>
        case ATTR_VERSION:
<span class="nc bnc" id="L468" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L469">                version = null;</span>
            } else {
<span class="nc" id="L471">                version.delete(suffix);</span>
            }
<span class="nc" id="L473">            break;</span>
        case (ATTR_SERIAL):
<span class="nc bnc" id="L475" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L476">                serialNum = null;</span>
            } else {
<span class="nc" id="L478">                serialNum.delete(suffix);</span>
            }
<span class="nc" id="L480">            break;</span>
        case (ATTR_ALGORITHM):
<span class="nc bnc" id="L482" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L483">                algId = null;</span>
            } else {
<span class="nc" id="L485">                algId.delete(suffix);</span>
            }
<span class="nc" id="L487">            break;</span>
        case (ATTR_ISSUER):
<span class="nc" id="L489">            issuer = null;</span>
<span class="nc" id="L490">            break;</span>
        case (ATTR_VALIDITY):
<span class="nc bnc" id="L492" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L493">                interval = null;</span>
            } else {
<span class="nc" id="L495">                interval.delete(suffix);</span>
            }
<span class="nc" id="L497">            break;</span>
        case (ATTR_SUBJECT):
<span class="nc" id="L499">            subject = null;</span>
<span class="nc" id="L500">            break;</span>
        case (ATTR_KEY):
<span class="nc bnc" id="L502" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L503">                pubKey = null;</span>
            } else {
<span class="nc" id="L505">                pubKey.delete(suffix);</span>
            }
<span class="nc" id="L507">            break;</span>
        case (ATTR_ISSUER_ID):
<span class="nc" id="L509">            issuerUniqueId = null;</span>
<span class="nc" id="L510">            break;</span>
        case (ATTR_SUBJECT_ID):
<span class="nc" id="L512">            subjectUniqueId = null;</span>
<span class="nc" id="L513">            break;</span>
        case (ATTR_EXTENSIONS):
<span class="nc bnc" id="L515" title="All 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L516">                extensions = null;</span>
            } else {
<span class="nc bnc" id="L518" title="All 2 branches missed.">                if (extensions != null)</span>
<span class="nc" id="L519">                   extensions.delete(suffix);</span>
            }
            break;
        }
<span class="nc" id="L523">    }</span>

    /**
     * Get the certificate attribute.
     *
     * @params name the name of the Certificate attribute.
     *
     * @exception CertificateException on invalid attributes.
     * @exception IOException on other errors.
     */
    public Object get(String name)
    throws CertificateException, IOException {
<span class="fc" id="L535">        X509AttributeName attrName = new X509AttributeName(name);</span>

<span class="fc" id="L537">        int attr = attributeMap(attrName.getPrefix());</span>
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">        if (attr == 0) {</span>
<span class="nc" id="L539">            throw new CertificateParsingException(</span>
                          &quot;Attribute name not recognized: &quot; + name);
        }
<span class="fc" id="L542">        String suffix = attrName.getSuffix();</span>

<span class="pc bpc" id="L544" title="3 of 11 branches missed.">        switch (attr) { // frequently used attributes first</span>
        case (ATTR_EXTENSIONS):
<span class="fc bfc" id="L546" title="All 2 branches covered.">            if (suffix == null) {</span>
<span class="fc" id="L547">                return(extensions);</span>
            } else {
<span class="fc bfc" id="L549" title="All 2 branches covered.">                if (extensions == null) {</span>
<span class="fc" id="L550">                    return null;</span>
                } else {
<span class="fc" id="L552">                    return(extensions.get(suffix));</span>
                }
            }
        case (ATTR_SUBJECT):
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L557">                return(subject);</span>
            } else {
<span class="fc" id="L559">                return(getX500Name(suffix, false));</span>
            }
        case (ATTR_ISSUER):
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L563">                return(issuer);</span>
            } else {
<span class="fc" id="L565">                return(getX500Name(suffix, true));</span>
            }
        case (ATTR_KEY):
<span class="pc bpc" id="L568" title="1 of 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L569">                return(pubKey);</span>
            } else {
<span class="fc" id="L571">                return(pubKey.get(suffix));</span>
            }
        case (ATTR_ALGORITHM):
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L575">                return(algId);</span>
            } else {
<span class="fc" id="L577">                return(algId.get(suffix));</span>
            }
        case (ATTR_VALIDITY):
<span class="fc bfc" id="L580" title="All 2 branches covered.">            if (suffix == null) {</span>
<span class="fc" id="L581">                return(interval);</span>
            } else {
<span class="fc" id="L583">                return(interval.get(suffix));</span>
            }
        case (ATTR_VERSION):
<span class="pc bpc" id="L586" title="1 of 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L587">                return(version);</span>
            } else {
<span class="fc" id="L589">                return(version.get(suffix));</span>
            }
        case (ATTR_SERIAL):
<span class="pc bpc" id="L592" title="1 of 2 branches missed.">            if (suffix == null) {</span>
<span class="nc" id="L593">                return(serialNum);</span>
            } else {
<span class="fc" id="L595">                return(serialNum.get(suffix));</span>
            }
        case (ATTR_ISSUER_ID):
<span class="nc" id="L598">            return(issuerUniqueId);</span>
        case (ATTR_SUBJECT_ID):
<span class="nc" id="L600">            return(subjectUniqueId);</span>
        }
<span class="nc" id="L602">        return null;</span>
    }

    /*
     * Get the Issuer or Subject name
     */
    private Object getX500Name(String name, boolean getIssuer)
        throws IOException {
<span class="fc bfc" id="L610" title="All 2 branches covered.">        if (name.equalsIgnoreCase(X509CertInfo.DN_NAME)) {</span>
<span class="fc bfc" id="L611" title="All 2 branches covered.">            return getIssuer ? issuer : subject;</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">        } else if (name.equalsIgnoreCase(&quot;x500principal&quot;)) {</span>
<span class="fc bfc" id="L613" title="All 2 branches covered.">            return getIssuer ? issuer.asX500Principal()</span>
<span class="fc" id="L614">                             : subject.asX500Principal();</span>
        } else {
<span class="nc" id="L616">            throw new IOException(&quot;Attribute name not recognized.&quot;);</span>
        }
    }

    /*
     * This routine unmarshals the certificate information.
     */
    private void parse(DerValue val)
    throws CertificateParsingException, IOException {
        DerInputStream  in;
        DerValue        tmp;

<span class="pc bpc" id="L628" title="1 of 2 branches missed.">        if (val.tag != DerValue.tag_Sequence) {</span>
<span class="nc" id="L629">            throw new CertificateParsingException(&quot;signed fields invalid&quot;);</span>
        }
<span class="fc" id="L631">        rawCertInfo = val.toByteArray();</span>

<span class="fc" id="L633">        in = val.data;</span>

        // Version
<span class="fc" id="L636">        tmp = in.getDerValue();</span>
<span class="fc bfc" id="L637" title="All 2 branches covered.">        if (tmp.isContextSpecific((byte)0)) {</span>
<span class="fc" id="L638">            version = new CertificateVersion(tmp);</span>
<span class="fc" id="L639">            tmp = in.getDerValue();</span>
        }

        // Serial number ... an integer
<span class="fc" id="L643">        serialNum = new CertificateSerialNumber(tmp);</span>

        // Algorithm Identifier
<span class="fc" id="L646">        algId = new CertificateAlgorithmId(in);</span>

        // Issuer name
<span class="fc" id="L649">        issuer = new X500Name(in);</span>
<span class="pc bpc" id="L650" title="1 of 2 branches missed.">        if (issuer.isEmpty()) {</span>
<span class="nc" id="L651">            throw new CertificateParsingException(</span>
                &quot;Empty issuer DN not allowed in X509Certificates&quot;);
        }

        // validity:  SEQUENCE { start date, end date }
<span class="fc" id="L656">        interval = new CertificateValidity(in);</span>

        // subject name
<span class="fc" id="L659">        subject = new X500Name(in);</span>
<span class="fc bfc" id="L660" title="All 2 branches covered.">        if ((version.compare(CertificateVersion.V1) == 0) &amp;&amp;</span>
<span class="pc bpc" id="L661" title="1 of 2 branches missed.">                subject.isEmpty()) {</span>
<span class="nc" id="L662">            throw new CertificateParsingException(</span>
                      &quot;Empty subject DN not allowed in v1 certificate&quot;);
        }

        // public key
<span class="fc" id="L667">        pubKey = new CertificateX509Key(in);</span>

        // If more data available, make sure version is not v1.
<span class="fc bfc" id="L670" title="All 2 branches covered.">        if (in.available() != 0) {</span>
<span class="pc bpc" id="L671" title="1 of 2 branches missed.">            if (version.compare(CertificateVersion.V1) == 0) {</span>
<span class="nc" id="L672">                throw new CertificateParsingException(</span>
                          &quot;no more data allowed for version 1 certificate&quot;);
            }
        } else {
<span class="fc" id="L676">            return;</span>
        }

        // Get the issuerUniqueId if present
<span class="fc" id="L680">        tmp = in.getDerValue();</span>
<span class="pc bpc" id="L681" title="1 of 2 branches missed.">        if (tmp.isContextSpecific((byte)1)) {</span>
<span class="nc" id="L682">            issuerUniqueId = new UniqueIdentity(tmp);</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">            if (in.available() == 0)</span>
<span class="nc" id="L684">                return;</span>
<span class="nc" id="L685">            tmp = in.getDerValue();</span>
        }

        // Get the subjectUniqueId if present.
<span class="pc bpc" id="L689" title="1 of 2 branches missed.">        if (tmp.isContextSpecific((byte)2)) {</span>
<span class="nc" id="L690">            subjectUniqueId = new UniqueIdentity(tmp);</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">            if (in.available() == 0)</span>
<span class="nc" id="L692">                return;</span>
<span class="nc" id="L693">            tmp = in.getDerValue();</span>
        }

        // Get the extensions.
<span class="pc bpc" id="L697" title="1 of 2 branches missed.">        if (version.compare(CertificateVersion.V3) != 0) {</span>
<span class="nc" id="L698">            throw new CertificateParsingException(</span>
                      &quot;Extensions not allowed in v2 certificate&quot;);
        }
<span class="pc bpc" id="L701" title="2 of 4 branches missed.">        if (tmp.isConstructed() &amp;&amp; tmp.isContextSpecific((byte)3)) {</span>
<span class="fc" id="L702">            extensions = new CertificateExtensions(tmp.data);</span>
        }

        // verify X.509 V3 Certificate
<span class="fc" id="L706">        verifyCert(subject, extensions);</span>

<span class="fc" id="L708">    }</span>

    /*
     * Verify if X.509 V3 Certificate is compliant with RFC 3280.
     */
    private void verifyCert(X500Name subject,
        CertificateExtensions extensions)
        throws CertificateParsingException, IOException {

        // if SubjectName is empty, check for SubjectAlternativeNameExtension
<span class="fc bfc" id="L718" title="All 2 branches covered.">        if (subject.isEmpty()) {</span>
<span class="pc bpc" id="L719" title="1 of 2 branches missed.">            if (extensions == null) {</span>
<span class="nc" id="L720">                throw new CertificateParsingException(&quot;X.509 Certificate is &quot; +</span>
                        &quot;incomplete: subject field is empty, and certificate &quot; +
                        &quot;has no extensions&quot;);
            }
<span class="fc" id="L724">            SubjectAlternativeNameExtension subjectAltNameExt = null;</span>
<span class="fc" id="L725">            SubjectAlternativeNameExtension extValue = null;</span>
<span class="fc" id="L726">            GeneralNames names = null;</span>
            try {
<span class="fc" id="L728">                subjectAltNameExt = (SubjectAlternativeNameExtension)</span>
<span class="fc" id="L729">                        extensions.get(SubjectAlternativeNameExtension.NAME);</span>
<span class="fc" id="L730">                names = subjectAltNameExt.get(</span>
                        SubjectAlternativeNameExtension.SUBJECT_NAME);
<span class="nc" id="L732">            } catch (IOException e) {</span>
<span class="nc" id="L733">                throw new CertificateParsingException(&quot;X.509 Certificate is &quot; +</span>
                        &quot;incomplete: subject field is empty, and &quot; +
                        &quot;SubjectAlternativeName extension is absent&quot;);
<span class="fc" id="L736">            }</span>

            // SubjectAlternativeName extension is empty or not marked critical
<span class="pc bpc" id="L739" title="2 of 4 branches missed.">            if (names == null || names.isEmpty()) {</span>
<span class="nc" id="L740">                throw new CertificateParsingException(&quot;X.509 Certificate is &quot; +</span>
                        &quot;incomplete: subject field is empty, and &quot; +
                        &quot;SubjectAlternativeName extension is empty&quot;);
<span class="pc bpc" id="L743" title="1 of 2 branches missed.">            } else if (subjectAltNameExt.isCritical() == false) {</span>
<span class="nc" id="L744">                throw new CertificateParsingException(&quot;X.509 Certificate is &quot; +</span>
                        &quot;incomplete: SubjectAlternativeName extension MUST &quot; +
                        &quot;be marked critical when subject field is empty&quot;);
            }
        }
<span class="fc" id="L749">    }</span>

    /*
     * Marshal the contents of a &quot;raw&quot; certificate into a DER sequence.
     */
    private void emit(DerOutputStream out)
    throws CertificateException, IOException {
<span class="nc" id="L756">        DerOutputStream tmp = new DerOutputStream();</span>

        // version number, iff not V1
<span class="nc" id="L759">        version.encode(tmp);</span>

        // Encode serial number, issuer signing algorithm, issuer name
        // and validity
<span class="nc" id="L763">        serialNum.encode(tmp);</span>
<span class="nc" id="L764">        algId.encode(tmp);</span>

<span class="nc bnc" id="L766" title="All 2 branches missed.">        if ((version.compare(CertificateVersion.V1) == 0) &amp;&amp;</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">            (issuer.toString() == null))</span>
<span class="nc" id="L768">            throw new CertificateParsingException(</span>
                      &quot;Null issuer DN not allowed in v1 certificate&quot;);

<span class="nc" id="L771">        issuer.encode(tmp);</span>
<span class="nc" id="L772">        interval.encode(tmp);</span>

        // Encode subject (principal) and associated key
<span class="nc bnc" id="L775" title="All 2 branches missed.">        if ((version.compare(CertificateVersion.V1) == 0) &amp;&amp;</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">            (subject.toString() == null))</span>
<span class="nc" id="L777">            throw new CertificateParsingException(</span>
                      &quot;Null subject DN not allowed in v1 certificate&quot;);
<span class="nc" id="L779">        subject.encode(tmp);</span>
<span class="nc" id="L780">        pubKey.encode(tmp);</span>

        // Encode issuerUniqueId &amp; subjectUniqueId.
<span class="nc bnc" id="L783" title="All 2 branches missed.">        if (issuerUniqueId != null) {</span>
<span class="nc" id="L784">            issuerUniqueId.encode(tmp, DerValue.createTag(DerValue.TAG_CONTEXT,</span>
                                                          false,(byte)1));
        }
<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (subjectUniqueId != null) {</span>
<span class="nc" id="L788">            subjectUniqueId.encode(tmp, DerValue.createTag(DerValue.TAG_CONTEXT,</span>
                                                           false,(byte)2));
        }

        // Write all the extensions.
<span class="nc bnc" id="L793" title="All 2 branches missed.">        if (extensions != null) {</span>
<span class="nc" id="L794">            extensions.encode(tmp);</span>
        }

        // Wrap the data; encoding of the &quot;raw&quot; cert is now complete.
<span class="nc" id="L798">        out.write(DerValue.tag_Sequence, tmp);</span>
<span class="nc" id="L799">    }</span>

    /**
     * Returns the integer attribute number for the passed attribute name.
     */
    private int attributeMap(String name) {
<span class="fc" id="L805">        Integer num = map.get(name);</span>
<span class="pc bpc" id="L806" title="1 of 2 branches missed.">        if (num == null) {</span>
<span class="nc" id="L807">            return 0;</span>
        }
<span class="fc" id="L809">        return num.intValue();</span>
    }

    /**
     * Set the version number of the certificate.
     *
     * @params val the Object class value for the Extensions
     * @exception CertificateException on invalid data.
     */
    private void setVersion(Object val) throws CertificateException {
<span class="nc bnc" id="L819" title="All 2 branches missed.">        if (!(val instanceof CertificateVersion)) {</span>
<span class="nc" id="L820">            throw new CertificateException(&quot;Version class type invalid.&quot;);</span>
        }
<span class="nc" id="L822">        version = (CertificateVersion)val;</span>
<span class="nc" id="L823">    }</span>

    /**
     * Set the serial number of the certificate.
     *
     * @params val the Object class value for the CertificateSerialNumber
     * @exception CertificateException on invalid data.
     */
    private void setSerialNumber(Object val) throws CertificateException {
<span class="nc bnc" id="L832" title="All 2 branches missed.">        if (!(val instanceof CertificateSerialNumber)) {</span>
<span class="nc" id="L833">            throw new CertificateException(&quot;SerialNumber class type invalid.&quot;);</span>
        }
<span class="nc" id="L835">        serialNum = (CertificateSerialNumber)val;</span>
<span class="nc" id="L836">    }</span>

    /**
     * Set the algorithm id of the certificate.
     *
     * @params val the Object class value for the AlgorithmId
     * @exception CertificateException on invalid data.
     */
    private void setAlgorithmId(Object val) throws CertificateException {
<span class="nc bnc" id="L845" title="All 2 branches missed.">        if (!(val instanceof CertificateAlgorithmId)) {</span>
<span class="nc" id="L846">            throw new CertificateException(</span>
                             &quot;AlgorithmId class type invalid.&quot;);
        }
<span class="nc" id="L849">        algId = (CertificateAlgorithmId)val;</span>
<span class="nc" id="L850">    }</span>

    /**
     * Set the issuer name of the certificate.
     *
     * @params val the Object class value for the issuer
     * @exception CertificateException on invalid data.
     */
    private void setIssuer(Object val) throws CertificateException {
<span class="nc bnc" id="L859" title="All 2 branches missed.">        if (!(val instanceof X500Name)) {</span>
<span class="nc" id="L860">            throw new CertificateException(</span>
                             &quot;Issuer class type invalid.&quot;);
        }
<span class="nc" id="L863">        issuer = (X500Name)val;</span>
<span class="nc" id="L864">    }</span>

    /**
     * Set the validity interval of the certificate.
     *
     * @params val the Object class value for the CertificateValidity
     * @exception CertificateException on invalid data.
     */
    private void setValidity(Object val) throws CertificateException {
<span class="nc bnc" id="L873" title="All 2 branches missed.">        if (!(val instanceof CertificateValidity)) {</span>
<span class="nc" id="L874">            throw new CertificateException(</span>
                             &quot;CertificateValidity class type invalid.&quot;);
        }
<span class="nc" id="L877">        interval = (CertificateValidity)val;</span>
<span class="nc" id="L878">    }</span>

    /**
     * Set the subject name of the certificate.
     *
     * @params val the Object class value for the Subject
     * @exception CertificateException on invalid data.
     */
    private void setSubject(Object val) throws CertificateException {
<span class="nc bnc" id="L887" title="All 2 branches missed.">        if (!(val instanceof X500Name)) {</span>
<span class="nc" id="L888">            throw new CertificateException(</span>
                             &quot;Subject class type invalid.&quot;);
        }
<span class="nc" id="L891">        subject = (X500Name)val;</span>
<span class="nc" id="L892">    }</span>

    /**
     * Set the public key in the certificate.
     *
     * @params val the Object class value for the PublicKey
     * @exception CertificateException on invalid data.
     */
    private void setKey(Object val) throws CertificateException {
<span class="nc bnc" id="L901" title="All 2 branches missed.">        if (!(val instanceof CertificateX509Key)) {</span>
<span class="nc" id="L902">            throw new CertificateException(</span>
                             &quot;Key class type invalid.&quot;);
        }
<span class="nc" id="L905">        pubKey = (CertificateX509Key)val;</span>
<span class="nc" id="L906">    }</span>

    /**
     * Set the Issuer Unique Identity in the certificate.
     *
     * @params val the Object class value for the IssuerUniqueId
     * @exception CertificateException
     */
    private void setIssuerUniqueId(Object val) throws CertificateException {
<span class="nc bnc" id="L915" title="All 2 branches missed.">        if (version.compare(CertificateVersion.V2) &lt; 0) {</span>
<span class="nc" id="L916">            throw new CertificateException(&quot;Invalid version&quot;);</span>
        }
<span class="nc bnc" id="L918" title="All 2 branches missed.">        if (!(val instanceof UniqueIdentity)) {</span>
<span class="nc" id="L919">            throw new CertificateException(</span>
                             &quot;IssuerUniqueId class type invalid.&quot;);
        }
<span class="nc" id="L922">        issuerUniqueId = (UniqueIdentity)val;</span>
<span class="nc" id="L923">    }</span>

    /**
     * Set the Subject Unique Identity in the certificate.
     *
     * @params val the Object class value for the SubjectUniqueId
     * @exception CertificateException
     */
    private void setSubjectUniqueId(Object val) throws CertificateException {
<span class="nc bnc" id="L932" title="All 2 branches missed.">        if (version.compare(CertificateVersion.V2) &lt; 0) {</span>
<span class="nc" id="L933">            throw new CertificateException(&quot;Invalid version&quot;);</span>
        }
<span class="nc bnc" id="L935" title="All 2 branches missed.">        if (!(val instanceof UniqueIdentity)) {</span>
<span class="nc" id="L936">            throw new CertificateException(</span>
                             &quot;SubjectUniqueId class type invalid.&quot;);
        }
<span class="nc" id="L939">        subjectUniqueId = (UniqueIdentity)val;</span>
<span class="nc" id="L940">    }</span>

    /**
     * Set the extensions in the certificate.
     *
     * @params val the Object class value for the Extensions
     * @exception CertificateException
     */
    private void setExtensions(Object val) throws CertificateException {
<span class="nc bnc" id="L949" title="All 2 branches missed.">        if (version.compare(CertificateVersion.V3) &lt; 0) {</span>
<span class="nc" id="L950">            throw new CertificateException(&quot;Invalid version&quot;);</span>
        }
<span class="nc bnc" id="L952" title="All 2 branches missed.">        if (!(val instanceof CertificateExtensions)) {</span>
<span class="nc" id="L953">          throw new CertificateException(</span>
                             &quot;Extensions class type invalid.&quot;);
        }
<span class="nc" id="L956">        extensions = (CertificateExtensions)val;</span>
<span class="nc" id="L957">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>