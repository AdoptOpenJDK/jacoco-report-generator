<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DistributionPoint.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.x509</a> &gt; <span class="el_source">DistributionPoint.java</span></div><h1>DistributionPoint.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2002, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.x509;

import java.io.IOException;
import java.util.*;

import sun.security.util.BitArray;
import sun.security.util.DerOutputStream;
import sun.security.util.DerValue;

/**
 * Represent the DistributionPoint sequence used in the CRL
 * Distribution Points Extension (OID = 2.5.29.31).
 * &lt;p&gt;
 * The ASN.1 definition for this is:
 * &lt;pre&gt;
 * DistributionPoint ::= SEQUENCE {
 *      distributionPoint       [0]     DistributionPointName OPTIONAL,
 *      reasons                 [1]     ReasonFlags OPTIONAL,
 *      cRLIssuer               [2]     GeneralNames OPTIONAL }
 *
 * DistributionPointName ::= CHOICE {
 *      fullName                [0]     GeneralNames,
 *      nameRelativeToCRLIssuer [1]     RelativeDistinguishedName }
 *
 * ReasonFlags ::= BIT STRING {
 *      unused                  (0),
 *      keyCompromise           (1),
 *      cACompromise            (2),
 *      affiliationChanged      (3),
 *      superseded              (4),
 *      cessationOfOperation    (5),
 *      certificateHold         (6),
 *      privilegeWithdrawn      (7),
 *      aACompromise            (8) }
 *
 * GeneralNames ::= SEQUENCE SIZE (1..MAX) OF GeneralName
 *
 * GeneralName ::= CHOICE {
 *         otherName                   [0] INSTANCE OF OTHER-NAME,
 *         rfc822Name                  [1] IA5String,
 *         dNSName                     [2] IA5String,
 *         x400Address                 [3] ORAddress,
 *         directoryName               [4] Name,
 *         ediPartyName                [5] EDIPartyName,
 *         uniformResourceIdentifier   [6] IA5String,
 *         iPAddress                   [7] OCTET STRING,
 *         registeredID                [8] OBJECT IDENTIFIER }
 *
 * RelativeDistinguishedName ::=
 *   SET OF AttributeTypeAndValue
 *
 * AttributeTypeAndValue ::= SEQUENCE {
 *   type     AttributeType,
 *   value    AttributeValue }
 *
 * AttributeType ::= OBJECT IDENTIFIER
 *
 * AttributeValue ::= ANY DEFINED BY AttributeType
 * &lt;/pre&gt;
 * &lt;p&gt;
 * Instances of this class are designed to be immutable. However, since this
 * is an internal API we do not use defensive cloning for values for
 * performance reasons. It is the responsibility of the consumer to ensure
 * that no mutable elements are modified.
 *
 * @author Anne Anderson
 * @author Andreas Sterbenz
 * @since 1.4.2
 * @see CRLDistributionPointsExtension
 */
public class DistributionPoint {

    // reason flag bits
    // NOTE that these are NOT quite the same as the CRL reason code extension
    public final static int KEY_COMPROMISE         = 1;
    public final static int CA_COMPROMISE          = 2;
    public final static int AFFILIATION_CHANGED    = 3;
    public final static int SUPERSEDED             = 4;
    public final static int CESSATION_OF_OPERATION = 5;
    public final static int CERTIFICATE_HOLD       = 6;
    public final static int PRIVILEGE_WITHDRAWN    = 7;
    public final static int AA_COMPROMISE          = 8;

<span class="fc" id="L109">    private static final String[] REASON_STRINGS = {</span>
        null,
        &quot;key compromise&quot;,
        &quot;CA compromise&quot;,
        &quot;affiliation changed&quot;,
        &quot;superseded&quot;,
        &quot;cessation of operation&quot;,
        &quot;certificate hold&quot;,
        &quot;privilege withdrawn&quot;,
        &quot;AA compromise&quot;,
    };

    // context specific tag values
    private static final byte TAG_DIST_PT = 0;
    private static final byte TAG_REASONS = 1;
    private static final byte TAG_ISSUER = 2;

    private static final byte TAG_FULL_NAME = 0;
    private static final byte TAG_REL_NAME = 1;

    // only one of fullName and relativeName can be set
    private GeneralNames fullName;
    private RDN relativeName;

    // reasonFlags or null
    private boolean[] reasonFlags;

    // crlIssuer or null
    private GeneralNames crlIssuer;

    // cached hashCode value
    private volatile int hashCode;

    /**
     * Constructor for the class using GeneralNames for DistributionPointName
     *
     * @param fullName the GeneralNames of the distribution point; may be null
     * @param reasons the CRL reasons included in the CRL at this distribution
     *        point; may be null
     * @param issuer the name(s) of the CRL issuer for the CRL at this
     *        distribution point; may be null
     */
    public DistributionPoint(GeneralNames fullName, boolean[] reasonFlags,
<span class="fc" id="L152">            GeneralNames crlIssuer) {</span>
<span class="pc bpc" id="L153" title="3 of 4 branches missed.">        if ((fullName == null) &amp;&amp; (crlIssuer == null)) {</span>
<span class="nc" id="L154">            throw new IllegalArgumentException</span>
                        (&quot;fullName and crlIssuer may not both be null&quot;);
        }
<span class="fc" id="L157">        this.fullName = fullName;</span>
<span class="fc" id="L158">        this.reasonFlags = reasonFlags;</span>
<span class="fc" id="L159">        this.crlIssuer = crlIssuer;</span>
<span class="fc" id="L160">    }</span>

    /**
     * Constructor for the class using RelativeDistinguishedName for
     * DistributionPointName
     *
     * @param relativeName the RelativeDistinguishedName of the distribution
     *        point; may not be null
     * @param reasons the CRL reasons included in the CRL at this distribution
     *        point; may be null
     * @param issuer the name(s) of the CRL issuer for the CRL at this
     *        distribution point; may not be null or empty.
     */
    public DistributionPoint(RDN relativeName, boolean[] reasonFlags,
<span class="nc" id="L174">            GeneralNames crlIssuer) {</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">        if ((relativeName == null) &amp;&amp; (crlIssuer == null)) {</span>
<span class="nc" id="L176">            throw new IllegalArgumentException</span>
                        (&quot;relativeName and crlIssuer may not both be null&quot;);
        }
<span class="nc" id="L179">        this.relativeName = relativeName;</span>
<span class="nc" id="L180">        this.reasonFlags = reasonFlags;</span>
<span class="nc" id="L181">        this.crlIssuer = crlIssuer;</span>
<span class="nc" id="L182">    }</span>

    /**
     * Create the object from the passed DER encoded form.
     *
     * @param val the DER encoded form of the DistributionPoint
     * @throws IOException on error
     */
<span class="fc" id="L190">    public DistributionPoint(DerValue val) throws IOException {</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        if (val.tag != DerValue.tag_Sequence) {</span>
<span class="nc" id="L192">            throw new IOException(&quot;Invalid encoding of DistributionPoint.&quot;);</span>
        }

        // Note that all the fields in DistributionPoint are defined as
        // being OPTIONAL, i.e., there could be an empty SEQUENCE, resulting
        // in val.data being null.
<span class="pc bpc" id="L198" title="1 of 4 branches missed.">        while ((val.data != null) &amp;&amp; (val.data.available() != 0)) {</span>
<span class="fc" id="L199">            DerValue opt = val.data.getDerValue();</span>

<span class="pc bpc" id="L201" title="2 of 4 branches missed.">            if (opt.isContextSpecific(TAG_DIST_PT) &amp;&amp; opt.isConstructed()) {</span>
<span class="pc bpc" id="L202" title="2 of 4 branches missed.">                if ((fullName != null) || (relativeName != null)) {</span>
<span class="nc" id="L203">                    throw new IOException(&quot;Duplicate DistributionPointName in &quot;</span>
                                          + &quot;DistributionPoint.&quot;);
                }
<span class="fc" id="L206">                DerValue distPnt = opt.data.getDerValue();</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">                if (distPnt.isContextSpecific(TAG_FULL_NAME)</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">                        &amp;&amp; distPnt.isConstructed()) {</span>
<span class="fc" id="L209">                    distPnt.resetTag(DerValue.tag_Sequence);</span>
<span class="fc" id="L210">                    fullName = new GeneralNames(distPnt);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                } else if (distPnt.isContextSpecific(TAG_REL_NAME)</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                        &amp;&amp; distPnt.isConstructed()) {</span>
<span class="nc" id="L213">                    distPnt.resetTag(DerValue.tag_Set);</span>
<span class="nc" id="L214">                    relativeName = new RDN(distPnt);</span>
                } else {
<span class="nc" id="L216">                    throw new IOException(&quot;Invalid DistributionPointName in &quot;</span>
                                          + &quot;DistributionPoint&quot;);
                }
<span class="pc bnc" id="L219" title="All 2 branches missed.">            } else if (opt.isContextSpecific(TAG_REASONS)</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                                                &amp;&amp; !opt.isConstructed()) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if (reasonFlags != null) {</span>
<span class="nc" id="L222">                    throw new IOException(&quot;Duplicate Reasons in &quot; +</span>
                                          &quot;DistributionPoint.&quot;);
                }
<span class="nc" id="L225">                opt.resetTag(DerValue.tag_BitString);</span>
<span class="nc" id="L226">                reasonFlags = (opt.getUnalignedBitString()).toBooleanArray();</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            } else if (opt.isContextSpecific(TAG_ISSUER)</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                                                &amp;&amp; opt.isConstructed()) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                if (crlIssuer != null) {</span>
<span class="nc" id="L230">                    throw new IOException(&quot;Duplicate CRLIssuer in &quot; +</span>
                                          &quot;DistributionPoint.&quot;);
                }
<span class="nc" id="L233">                opt.resetTag(DerValue.tag_Sequence);</span>
<span class="nc" id="L234">                crlIssuer = new GeneralNames(opt);</span>
            } else {
<span class="nc" id="L236">                throw new IOException(&quot;Invalid encoding of &quot; +</span>
                                      &quot;DistributionPoint.&quot;);
            }
<span class="fc" id="L239">        }</span>
<span class="pc bpc" id="L240" title="4 of 6 branches missed.">        if ((crlIssuer == null) &amp;&amp; (fullName == null) &amp;&amp; (relativeName == null)) {</span>
<span class="nc" id="L241">            throw new IOException(&quot;One of fullName, relativeName, &quot;</span>
                + &quot; and crlIssuer has to be set&quot;);
        }
<span class="fc" id="L244">    }</span>

    /**
     * Return the full distribution point name or null if not set.
     */
    public GeneralNames getFullName() {
<span class="nc" id="L250">        return fullName;</span>
    }

    /**
     * Return the relative distribution point name or null if not set.
     */
    public RDN getRelativeName() {
<span class="nc" id="L257">        return relativeName;</span>
    }

    /**
     * Return the reason flags or null if not set.
     */
    public boolean[] getReasonFlags() {
<span class="fc" id="L264">        return reasonFlags;</span>
    }

    /**
     * Return the CRL issuer name or null if not set.
     */
    public GeneralNames getCRLIssuer() {
<span class="fc" id="L271">        return crlIssuer;</span>
    }

    /**
     * Write the DistributionPoint value to the DerOutputStream.
     *
     * @param out the DerOutputStream to write the extension to.
     * @exception IOException on error.
     */
    public void encode(DerOutputStream out) throws IOException {
<span class="nc" id="L281">        DerOutputStream tagged = new DerOutputStream();</span>

        // NOTE: only one of pointNames and pointRDN can be set
<span class="nc bnc" id="L284" title="All 4 branches missed.">        if ((fullName != null) || (relativeName != null)) {</span>
<span class="nc" id="L285">            DerOutputStream distributionPoint = new DerOutputStream();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (fullName != null) {</span>
<span class="nc" id="L287">                DerOutputStream derOut = new DerOutputStream();</span>
<span class="nc" id="L288">                fullName.encode(derOut);</span>
<span class="nc" id="L289">                distributionPoint.writeImplicit(</span>
<span class="nc" id="L290">                    DerValue.createTag(DerValue.TAG_CONTEXT, true, TAG_FULL_NAME),</span>
                    derOut);
<span class="nc bnc" id="L292" title="All 2 branches missed.">            } else if (relativeName != null) {</span>
<span class="nc" id="L293">                DerOutputStream derOut = new DerOutputStream();</span>
<span class="nc" id="L294">                relativeName.encode(derOut);</span>
<span class="nc" id="L295">                distributionPoint.writeImplicit(</span>
<span class="nc" id="L296">                    DerValue.createTag(DerValue.TAG_CONTEXT, true, TAG_REL_NAME),</span>
                    derOut);
            }
<span class="nc" id="L299">            tagged.write(</span>
<span class="nc" id="L300">                DerValue.createTag(DerValue.TAG_CONTEXT, true, TAG_DIST_PT),</span>
                distributionPoint);
        }
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (reasonFlags != null) {</span>
<span class="nc" id="L304">            DerOutputStream reasons = new DerOutputStream();</span>
<span class="nc" id="L305">            BitArray rf = new BitArray(reasonFlags);</span>
<span class="nc" id="L306">            reasons.putTruncatedUnalignedBitString(rf);</span>
<span class="nc" id="L307">            tagged.writeImplicit(</span>
<span class="nc" id="L308">                DerValue.createTag(DerValue.TAG_CONTEXT, false, TAG_REASONS),</span>
                reasons);
        }
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if (crlIssuer != null) {</span>
<span class="nc" id="L312">            DerOutputStream issuer = new DerOutputStream();</span>
<span class="nc" id="L313">            crlIssuer.encode(issuer);</span>
<span class="nc" id="L314">            tagged.writeImplicit(</span>
<span class="nc" id="L315">                DerValue.createTag(DerValue.TAG_CONTEXT, true, TAG_ISSUER),</span>
                issuer);
        }
<span class="nc" id="L318">        out.write(DerValue.tag_Sequence, tagged);</span>
<span class="nc" id="L319">    }</span>

    /**
     * Compare an object to this DistributionPoint for equality.
     *
     * @param obj Object to be compared to this
     * @return true if objects match; false otherwise
     */
    public boolean equals(Object obj) {
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (this == obj) {</span>
<span class="nc" id="L329">            return true;</span>
        }
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (obj instanceof DistributionPoint == false) {</span>
<span class="nc" id="L332">            return false;</span>
        }
<span class="nc" id="L334">        DistributionPoint other = (DistributionPoint)obj;</span>

<span class="nc bnc" id="L336" title="All 2 branches missed.">        boolean equal = Objects.equals(this.fullName, other.fullName)</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                     &amp;&amp; Objects.equals(this.relativeName, other.relativeName)</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                     &amp;&amp; Objects.equals(this.crlIssuer, other.crlIssuer)</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">                     &amp;&amp; Arrays.equals(this.reasonFlags, other.reasonFlags);</span>
<span class="nc" id="L340">        return equal;</span>
    }

    public int hashCode() {
<span class="nc" id="L344">        int hash = hashCode;</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">        if (hash == 0) {</span>
<span class="nc" id="L346">            hash = 1;</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (fullName != null) {</span>
<span class="nc" id="L348">                hash += fullName.hashCode();</span>
            }
<span class="nc bnc" id="L350" title="All 2 branches missed.">            if (relativeName != null) {</span>
<span class="nc" id="L351">                hash += relativeName.hashCode();</span>
            }
<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (crlIssuer != null) {</span>
<span class="nc" id="L354">                hash += crlIssuer.hashCode();</span>
            }
<span class="nc bnc" id="L356" title="All 2 branches missed.">            if (reasonFlags != null) {</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">                for (int i = 0; i &lt; reasonFlags.length; i++) {</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">                    if (reasonFlags[i]) {</span>
<span class="nc" id="L359">                        hash += i;</span>
                    }
                }
            }
<span class="nc" id="L363">            hashCode = hash;</span>
        }
<span class="nc" id="L365">        return hash;</span>
    }

    /**
     * Return a string representation for reasonFlag bit 'reason'.
     */
    private static String reasonToString(int reason) {
<span class="nc bnc" id="L372" title="All 4 branches missed.">        if ((reason &gt; 0) &amp;&amp; (reason &lt; REASON_STRINGS.length)) {</span>
<span class="nc" id="L373">            return REASON_STRINGS[reason];</span>
        }
<span class="nc" id="L375">        return &quot;Unknown reason &quot; + reason;</span>
    }

    /**
     * Return a printable string of the Distribution Point.
     */
    public String toString() {
<span class="nc" id="L382">        StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">        if (fullName != null) {</span>
<span class="nc" id="L384">            sb.append(&quot;DistributionPoint:\n     &quot; + fullName + &quot;\n&quot;);</span>
        }
<span class="nc bnc" id="L386" title="All 2 branches missed.">        if (relativeName != null) {</span>
<span class="nc" id="L387">            sb.append(&quot;DistributionPoint:\n     &quot; + relativeName + &quot;\n&quot;);</span>
        }

<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (reasonFlags != null) {</span>
<span class="nc" id="L391">            sb.append(&quot;   ReasonFlags:\n&quot;);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">            for (int i = 0; i &lt; reasonFlags.length; i++) {</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">                if (reasonFlags[i]) {</span>
<span class="nc" id="L394">                    sb.append(&quot;    &quot; + reasonToString(i) + &quot;\n&quot;);</span>
                }
            }
        }
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (crlIssuer != null) {</span>
<span class="nc" id="L399">            sb.append(&quot;   CRLIssuer:&quot; + crlIssuer + &quot;\n&quot;);</span>
        }
<span class="nc" id="L401">        return sb.toString();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>