<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>SignatureAlgorithm.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.org.apache.xml.internal.security.algorithms</a> &gt; <span class="el_source">SignatureAlgorithm.java</span></div><h1>SignatureAlgorithm.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package com.sun.org.apache.xml.internal.security.algorithms;

import java.security.Key;
import java.security.SecureRandom;
import java.security.spec.AlgorithmParameterSpec;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

import com.sun.org.apache.xml.internal.security.algorithms.implementations.IntegrityHmac;
import com.sun.org.apache.xml.internal.security.algorithms.implementations.SignatureBaseRSA;
import com.sun.org.apache.xml.internal.security.algorithms.implementations.SignatureDSA;
import com.sun.org.apache.xml.internal.security.algorithms.implementations.SignatureECDSA;
import com.sun.org.apache.xml.internal.security.exceptions.AlgorithmAlreadyRegisteredException;
import com.sun.org.apache.xml.internal.security.exceptions.XMLSecurityException;
import com.sun.org.apache.xml.internal.security.signature.XMLSignature;
import com.sun.org.apache.xml.internal.security.signature.XMLSignatureException;
import com.sun.org.apache.xml.internal.security.utils.Constants;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

/**
 * Allows selection of digital signature's algorithm, private keys, other
 * security parameters, and algorithm's ID.
 *
 * @author Christian Geuer-Pollmann
 */
public class SignatureAlgorithm extends Algorithm {

    /** {@link org.apache.commons.logging} logging facility */
<span class="nc" id="L53">    private static java.util.logging.Logger log =</span>
<span class="nc" id="L54">        java.util.logging.Logger.getLogger(SignatureAlgorithm.class.getName());</span>

    /** All available algorithm classes are registered here */
<span class="nc" id="L57">    private static Map&lt;String, Class&lt;? extends SignatureAlgorithmSpi&gt;&gt; algorithmHash =</span>
        new ConcurrentHashMap&lt;String, Class&lt;? extends SignatureAlgorithmSpi&gt;&gt;();

    /** Field signatureAlgorithm */
    private final SignatureAlgorithmSpi signatureAlgorithm;

    private final String algorithmURI;

    /**
     * Constructor SignatureAlgorithm
     *
     * @param doc
     * @param algorithmURI
     * @throws XMLSecurityException
     */
    public SignatureAlgorithm(Document doc, String algorithmURI) throws XMLSecurityException {
<span class="nc" id="L73">        super(doc, algorithmURI);</span>
<span class="nc" id="L74">        this.algorithmURI = algorithmURI;</span>

<span class="nc" id="L76">        signatureAlgorithm = getSignatureAlgorithmSpi(algorithmURI);</span>
<span class="nc" id="L77">        signatureAlgorithm.engineGetContextFromElement(this.constructionElement);</span>
<span class="nc" id="L78">    }</span>

    /**
     * Constructor SignatureAlgorithm
     *
     * @param doc
     * @param algorithmURI
     * @param hmacOutputLength
     * @throws XMLSecurityException
     */
    public SignatureAlgorithm(
        Document doc, String algorithmURI, int hmacOutputLength
    ) throws XMLSecurityException {
<span class="nc" id="L91">        super(doc, algorithmURI);</span>
<span class="nc" id="L92">        this.algorithmURI = algorithmURI;</span>

<span class="nc" id="L94">        signatureAlgorithm = getSignatureAlgorithmSpi(algorithmURI);</span>
<span class="nc" id="L95">        signatureAlgorithm.engineGetContextFromElement(this.constructionElement);</span>

<span class="nc" id="L97">        signatureAlgorithm.engineSetHMACOutputLength(hmacOutputLength);</span>
<span class="nc" id="L98">        ((IntegrityHmac)signatureAlgorithm).engineAddContextToElement(constructionElement);</span>
<span class="nc" id="L99">    }</span>

    /**
     * Constructor SignatureAlgorithm
     *
     * @param element
     * @param baseURI
     * @throws XMLSecurityException
     */
    public SignatureAlgorithm(Element element, String baseURI) throws XMLSecurityException {
<span class="nc" id="L109">        this(element, baseURI, false);</span>
<span class="nc" id="L110">    }</span>

    /**
     * Constructor SignatureAlgorithm
     *
     * @param element
     * @param baseURI
     * @param secureValidation
     * @throws XMLSecurityException
     */
    public SignatureAlgorithm(
        Element element, String baseURI, boolean secureValidation
    ) throws XMLSecurityException {
<span class="nc" id="L123">        super(element, baseURI);</span>
<span class="nc" id="L124">        algorithmURI = this.getURI();</span>

<span class="nc" id="L126">        Attr attr = element.getAttributeNodeNS(null, &quot;Id&quot;);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (attr != null) {</span>
<span class="nc" id="L128">            element.setIdAttributeNode(attr, true);</span>
        }

<span class="nc bnc" id="L131" title="All 4 branches missed.">        if (secureValidation &amp;&amp; (XMLSignature.ALGO_ID_MAC_HMAC_NOT_RECOMMENDED_MD5.equals(algorithmURI)</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            || XMLSignature.ALGO_ID_SIGNATURE_NOT_RECOMMENDED_RSA_MD5.equals(algorithmURI))) {</span>
<span class="nc" id="L133">            Object exArgs[] = { algorithmURI };</span>

<span class="nc" id="L135">            throw new XMLSecurityException(&quot;signature.signatureAlgorithm&quot;, exArgs);</span>
        }

<span class="nc" id="L138">        signatureAlgorithm = getSignatureAlgorithmSpi(algorithmURI);</span>
<span class="nc" id="L139">        signatureAlgorithm.engineGetContextFromElement(this.constructionElement);</span>
<span class="nc" id="L140">    }</span>

    /**
     * Get a SignatureAlgorithmSpi object corresponding to the algorithmURI argument
     */
    private static SignatureAlgorithmSpi getSignatureAlgorithmSpi(String algorithmURI)
        throws XMLSignatureException {
        try {
<span class="nc" id="L148">            Class&lt;? extends SignatureAlgorithmSpi&gt; implementingClass =</span>
<span class="nc" id="L149">                algorithmHash.get(algorithmURI);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L151">                log.log(java.util.logging.Level.FINE, &quot;Create URI \&quot;&quot; + algorithmURI + &quot;\&quot; class \&quot;&quot;</span>
                   + implementingClass + &quot;\&quot;&quot;);
            }
<span class="nc" id="L154">            return implementingClass.newInstance();</span>
<span class="nc" id="L155">        }  catch (IllegalAccessException ex) {</span>
<span class="nc" id="L156">            Object exArgs[] = { algorithmURI, ex.getMessage() };</span>
<span class="nc" id="L157">            throw new XMLSignatureException(&quot;algorithms.NoSuchAlgorithm&quot;, exArgs, ex);</span>
<span class="nc" id="L158">        } catch (InstantiationException ex) {</span>
<span class="nc" id="L159">            Object exArgs[] = { algorithmURI, ex.getMessage() };</span>
<span class="nc" id="L160">            throw new XMLSignatureException(&quot;algorithms.NoSuchAlgorithm&quot;, exArgs, ex);</span>
<span class="nc" id="L161">        } catch (NullPointerException ex) {</span>
<span class="nc" id="L162">            Object exArgs[] = { algorithmURI, ex.getMessage() };</span>
<span class="nc" id="L163">            throw new XMLSignatureException(&quot;algorithms.NoSuchAlgorithm&quot;, exArgs, ex);</span>
        }
    }


    /**
     * Proxy method for {@link java.security.Signature#sign()}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @return the result of the {@link java.security.Signature#sign()} method
     * @throws XMLSignatureException
     */
    public byte[] sign() throws XMLSignatureException {
<span class="nc" id="L176">        return signatureAlgorithm.engineSign();</span>
    }

    /**
     * Proxy method for {@link java.security.Signature#getAlgorithm}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @return the result of the {@link java.security.Signature#getAlgorithm} method
     */
    public String getJCEAlgorithmString() {
<span class="nc" id="L186">        return signatureAlgorithm.engineGetJCEAlgorithmString();</span>
    }

    /**
     * Method getJCEProviderName
     *
     * @return The Provider of this Signature Algorithm
     */
    public String getJCEProviderName() {
<span class="nc" id="L195">        return signatureAlgorithm.engineGetJCEProviderName();</span>
    }

    /**
     * Proxy method for {@link java.security.Signature#update(byte[])}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param input
     * @throws XMLSignatureException
     */
    public void update(byte[] input) throws XMLSignatureException {
<span class="nc" id="L206">        signatureAlgorithm.engineUpdate(input);</span>
<span class="nc" id="L207">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#update(byte)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param input
     * @throws XMLSignatureException
     */
    public void update(byte input) throws XMLSignatureException {
<span class="nc" id="L217">        signatureAlgorithm.engineUpdate(input);</span>
<span class="nc" id="L218">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#update(byte[], int, int)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param buf
     * @param offset
     * @param len
     * @throws XMLSignatureException
     */
    public void update(byte buf[], int offset, int len) throws XMLSignatureException {
<span class="nc" id="L230">        signatureAlgorithm.engineUpdate(buf, offset, len);</span>
<span class="nc" id="L231">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#initSign(java.security.PrivateKey)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param signingKey
     * @throws XMLSignatureException
     */
    public void initSign(Key signingKey) throws XMLSignatureException {
<span class="nc" id="L241">        signatureAlgorithm.engineInitSign(signingKey);</span>
<span class="nc" id="L242">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#initSign(java.security.PrivateKey,
     * java.security.SecureRandom)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param signingKey
     * @param secureRandom
     * @throws XMLSignatureException
     */
    public void initSign(Key signingKey, SecureRandom secureRandom) throws XMLSignatureException {
<span class="nc" id="L254">        signatureAlgorithm.engineInitSign(signingKey, secureRandom);</span>
<span class="nc" id="L255">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#initSign(java.security.PrivateKey)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param signingKey
     * @param algorithmParameterSpec
     * @throws XMLSignatureException
     */
    public void initSign(
        Key signingKey, AlgorithmParameterSpec algorithmParameterSpec
    ) throws XMLSignatureException {
<span class="nc" id="L268">        signatureAlgorithm.engineInitSign(signingKey, algorithmParameterSpec);</span>
<span class="nc" id="L269">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#setParameter(
     * java.security.spec.AlgorithmParameterSpec)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param params
     * @throws XMLSignatureException
     */
    public void setParameter(AlgorithmParameterSpec params) throws XMLSignatureException {
<span class="nc" id="L280">        signatureAlgorithm.engineSetParameter(params);</span>
<span class="nc" id="L281">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#initVerify(java.security.PublicKey)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param verificationKey
     * @throws XMLSignatureException
     */
    public void initVerify(Key verificationKey) throws XMLSignatureException {
<span class="nc" id="L291">        signatureAlgorithm.engineInitVerify(verificationKey);</span>
<span class="nc" id="L292">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#verify(byte[])}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param signature
     * @return true if if the signature is valid.
     *
     * @throws XMLSignatureException
     */
    public boolean verify(byte[] signature) throws XMLSignatureException {
<span class="nc" id="L304">        return signatureAlgorithm.engineVerify(signature);</span>
    }

    /**
     * Returns the URI representation of Transformation algorithm
     *
     * @return the URI representation of Transformation algorithm
     */
    public final String getURI() {
<span class="nc" id="L313">        return constructionElement.getAttributeNS(null, Constants._ATT_ALGORITHM);</span>
    }

    /**
     * Registers implementing class of the Transform algorithm with algorithmURI
     *
     * @param algorithmURI algorithmURI URI representation of &lt;code&gt;Transform algorithm&lt;/code&gt;.
     * @param implementingClass &lt;code&gt;implementingClass&lt;/code&gt; the implementing class of
     * {@link SignatureAlgorithmSpi}
     * @throws AlgorithmAlreadyRegisteredException if specified algorithmURI is already registered
     * @throws XMLSignatureException
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public static void register(String algorithmURI, String implementingClass)
       throws AlgorithmAlreadyRegisteredException, ClassNotFoundException,
           XMLSignatureException {
<span class="nc bnc" id="L329" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L330">            log.log(java.util.logging.Level.FINE, &quot;Try to register &quot; + algorithmURI + &quot; &quot; + implementingClass);</span>
        }

        // are we already registered?
<span class="nc" id="L334">        Class&lt;? extends SignatureAlgorithmSpi&gt; registeredClass = algorithmHash.get(algorithmURI);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (registeredClass != null) {</span>
<span class="nc" id="L336">            Object exArgs[] = { algorithmURI, registeredClass };</span>
<span class="nc" id="L337">            throw new AlgorithmAlreadyRegisteredException(</span>
                &quot;algorithm.alreadyRegistered&quot;, exArgs
            );
        }
        try {
<span class="nc" id="L342">            Class&lt;? extends SignatureAlgorithmSpi&gt; clazz =</span>
                (Class&lt;? extends SignatureAlgorithmSpi&gt;)
<span class="nc" id="L344">                    ClassLoaderUtils.loadClass(implementingClass, SignatureAlgorithm.class);</span>
<span class="nc" id="L345">            algorithmHash.put(algorithmURI, clazz);</span>
<span class="nc" id="L346">        } catch (NullPointerException ex) {</span>
<span class="nc" id="L347">            Object exArgs[] = { algorithmURI, ex.getMessage() };</span>
<span class="nc" id="L348">            throw new XMLSignatureException(&quot;algorithms.NoSuchAlgorithm&quot;, exArgs, ex);</span>
<span class="nc" id="L349">        }</span>
<span class="nc" id="L350">    }</span>

    /**
     * Registers implementing class of the Transform algorithm with algorithmURI
     *
     * @param algorithmURI algorithmURI URI representation of &lt;code&gt;Transform algorithm&lt;/code&gt;.
     * @param implementingClass &lt;code&gt;implementingClass&lt;/code&gt; the implementing class of
     * {@link SignatureAlgorithmSpi}
     * @throws AlgorithmAlreadyRegisteredException if specified algorithmURI is already registered
     * @throws XMLSignatureException
     */
    public static void register(String algorithmURI, Class&lt;? extends SignatureAlgorithmSpi&gt; implementingClass)
       throws AlgorithmAlreadyRegisteredException, ClassNotFoundException,
           XMLSignatureException {
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L365">            log.log(java.util.logging.Level.FINE, &quot;Try to register &quot; + algorithmURI + &quot; &quot; + implementingClass);</span>
        }

        // are we already registered?
<span class="nc" id="L369">        Class&lt;? extends SignatureAlgorithmSpi&gt; registeredClass = algorithmHash.get(algorithmURI);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        if (registeredClass != null) {</span>
<span class="nc" id="L371">            Object exArgs[] = { algorithmURI, registeredClass };</span>
<span class="nc" id="L372">            throw new AlgorithmAlreadyRegisteredException(</span>
                &quot;algorithm.alreadyRegistered&quot;, exArgs
            );
        }
<span class="nc" id="L376">        algorithmHash.put(algorithmURI, implementingClass);</span>
<span class="nc" id="L377">    }</span>

    /**
     * This method registers the default algorithms.
     */
    public static void registerDefaultAlgorithms() {
<span class="nc" id="L383">        algorithmHash.put(SignatureDSA.URI, SignatureDSA.class);</span>
<span class="nc" id="L384">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_RSA_SHA1, SignatureBaseRSA.SignatureRSASHA1.class
        );
<span class="nc" id="L387">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_MAC_HMAC_SHA1, IntegrityHmac.IntegrityHmacSHA1.class
        );
<span class="nc" id="L390">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_NOT_RECOMMENDED_RSA_MD5,
            SignatureBaseRSA.SignatureRSAMD5.class
        );
<span class="nc" id="L394">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_RSA_RIPEMD160,
            SignatureBaseRSA.SignatureRSARIPEMD160.class
        );
<span class="nc" id="L398">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_RSA_SHA256, SignatureBaseRSA.SignatureRSASHA256.class
        );
<span class="nc" id="L401">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_RSA_SHA384, SignatureBaseRSA.SignatureRSASHA384.class
        );
<span class="nc" id="L404">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_RSA_SHA512, SignatureBaseRSA.SignatureRSASHA512.class
        );
<span class="nc" id="L407">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_ECDSA_SHA1, SignatureECDSA.SignatureECDSASHA1.class
        );
<span class="nc" id="L410">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_ECDSA_SHA256, SignatureECDSA.SignatureECDSASHA256.class
        );
<span class="nc" id="L413">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_ECDSA_SHA384, SignatureECDSA.SignatureECDSASHA384.class
        );
<span class="nc" id="L416">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_SIGNATURE_ECDSA_SHA512, SignatureECDSA.SignatureECDSASHA512.class
        );
<span class="nc" id="L419">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_MAC_HMAC_NOT_RECOMMENDED_MD5, IntegrityHmac.IntegrityHmacMD5.class
        );
<span class="nc" id="L422">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_MAC_HMAC_RIPEMD160, IntegrityHmac.IntegrityHmacRIPEMD160.class
        );
<span class="nc" id="L425">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_MAC_HMAC_SHA256, IntegrityHmac.IntegrityHmacSHA256.class
        );
<span class="nc" id="L428">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_MAC_HMAC_SHA384, IntegrityHmac.IntegrityHmacSHA384.class
        );
<span class="nc" id="L431">        algorithmHash.put(</span>
            XMLSignature.ALGO_ID_MAC_HMAC_SHA512, IntegrityHmac.IntegrityHmacSHA512.class
        );
<span class="nc" id="L434">    }</span>

    /**
     * Method getBaseNamespace
     *
     * @return URI of this element
     */
    public String getBaseNamespace() {
<span class="nc" id="L442">        return Constants.SignatureSpecNS;</span>
    }

    /**
     * Method getBaseLocalName
     *
     * @return Local name
     */
    public String getBaseLocalName() {
<span class="nc" id="L451">        return Constants._TAG_SIGNATUREMETHOD;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>