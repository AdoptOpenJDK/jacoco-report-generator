<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ActionPropertyChangeListener.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing</a> &gt; <span class="el_source">ActionPropertyChangeListener.java</span></div><h1>ActionPropertyChangeListener.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2006, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package javax.swing;

import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.io.*;
import java.lang.ref.WeakReference;
import java.lang.ref.ReferenceQueue;

/**
 * A package-private PropertyChangeListener which listens for
 * property changes on an Action and updates the properties
 * of an ActionEvent source.
 * &lt;p&gt;
 * Subclasses must override the actionPropertyChanged method,
 * which is invoked from the propertyChange method as long as
 * the target is still valid.
 * &lt;/p&gt;
 * &lt;p&gt;
 * WARNING WARNING WARNING WARNING WARNING WARNING:&lt;br&gt;
 * Do NOT create an annonymous inner class that extends this!  If you do
 * a strong reference will be held to the containing class, which in most
 * cases defeats the purpose of this class.
 *
 * @param T the type of JComponent the underlying Action is attached to
 *
 * @author Georges Saab
 * @see AbstractButton
 */
abstract class ActionPropertyChangeListener&lt;T extends JComponent&gt;
        implements PropertyChangeListener, Serializable {
    private static ReferenceQueue&lt;JComponent&gt; queue;

    // WeakReference's aren't serializable.
    private transient OwnedWeakReference&lt;T&gt; target;
    // The Component's that reference an Action do so through a strong
    // reference, so that there is no need to check for serialized.
    private Action action;

    private static ReferenceQueue&lt;JComponent&gt; getQueue() {
<span class="nc" id="L64">        synchronized(ActionPropertyChangeListener.class) {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (queue == null) {</span>
<span class="nc" id="L66">                queue = new ReferenceQueue&lt;JComponent&gt;();</span>
            }
<span class="nc" id="L68">        }</span>
<span class="nc" id="L69">        return queue;</span>
    }

    public ActionPropertyChangeListener(T c, Action a) {
<span class="nc" id="L73">        super();</span>
<span class="nc" id="L74">        setTarget(c);</span>
<span class="nc" id="L75">        this.action = a;</span>
<span class="nc" id="L76">    }</span>

    /**
     * PropertyChangeListener method.  If the target has been gc'ed this
     * will remove the &lt;code&gt;PropertyChangeListener&lt;/code&gt; from the Action,
     * otherwise this will invoke actionPropertyChanged.
     */
    public final void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L84">        T target = getTarget();</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L86">            getAction().removePropertyChangeListener(this);</span>
        } else {
<span class="nc" id="L88">            actionPropertyChanged(target, getAction(), e);</span>
        }
<span class="nc" id="L90">    }</span>

    /**
     * Invoked when a property changes on the Action and the target
     * still exists.
     */
    protected abstract void actionPropertyChanged(T target, Action action,
                                                  PropertyChangeEvent e);

    private void setTarget(T c) {
<span class="nc" id="L100">        ReferenceQueue&lt;JComponent&gt; queue = getQueue();</span>
        // Check to see whether any old buttons have
        // been enqueued for GC.  If so, look up their
        // PCL instance and remove it from its Action.
        OwnedWeakReference&lt;?&gt; r;
<span class="nc bnc" id="L105" title="All 2 branches missed.">        while ((r = (OwnedWeakReference)queue.poll()) != null) {</span>
<span class="nc" id="L106">            ActionPropertyChangeListener&lt;?&gt; oldPCL = r.getOwner();</span>
<span class="nc" id="L107">            Action oldAction = oldPCL.getAction();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (oldAction!=null) {</span>
<span class="nc" id="L109">                oldAction.removePropertyChangeListener(oldPCL);</span>
            }
<span class="nc" id="L111">        }</span>
<span class="nc" id="L112">        this.target = new OwnedWeakReference&lt;T&gt;(c, queue, this);</span>
<span class="nc" id="L113">    }</span>

    public T getTarget() {
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (target == null) {</span>
            // Will only happen if serialized and real target was null
<span class="nc" id="L118">            return null;</span>
        }
<span class="nc" id="L120">        return this.target.get();</span>
    }

    public Action getAction() {
<span class="nc" id="L124">          return action;</span>
    }

    private void writeObject(ObjectOutputStream s) throws IOException {
<span class="nc" id="L128">        s.defaultWriteObject();</span>
<span class="nc" id="L129">        s.writeObject(getTarget());</span>
<span class="nc" id="L130">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    private void readObject(ObjectInputStream s)
                     throws IOException, ClassNotFoundException {
<span class="nc" id="L135">        s.defaultReadObject();</span>
<span class="nc" id="L136">        T target = (T)s.readObject();</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (target != null) {</span>
<span class="nc" id="L138">            setTarget(target);</span>
        }
<span class="nc" id="L140">    }</span>


    private static class OwnedWeakReference&lt;U extends JComponent&gt; extends
                              WeakReference&lt;U&gt; {
        private ActionPropertyChangeListener&lt;?&gt; owner;

        OwnedWeakReference(U target, ReferenceQueue&lt;? super U&gt; queue,
                           ActionPropertyChangeListener&lt;?&gt; owner) {
<span class="nc" id="L149">            super(target, queue);</span>
<span class="nc" id="L150">            this.owner = owner;</span>
<span class="nc" id="L151">        }</span>

        public ActionPropertyChangeListener&lt;?&gt; getOwner() {
<span class="nc" id="L154">            return owner;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>