<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JPopupMenu.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing</a> &gt; <span class="el_source">JPopupMenu.java</span></div><h1>JPopupMenu.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing;

import java.awt.*;
import java.awt.event.*;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.Serializable;
import java.beans.*;

import java.util.Locale;
import java.util.Vector;
import java.util.Hashtable;
import javax.accessibility.*;
import javax.swing.plaf.PopupMenuUI;
import javax.swing.plaf.ComponentUI;
import javax.swing.plaf.basic.BasicComboPopup;
import javax.swing.event.*;

import sun.awt.SunToolkit;
import sun.security.util.SecurityConstants;

import java.applet.Applet;

/**
 * An implementation of a popup menu -- a small window that pops up
 * and displays a series of choices. A &lt;code&gt;JPopupMenu&lt;/code&gt; is used for the
 * menu that appears when the user selects an item on the menu bar.
 * It is also used for &quot;pull-right&quot; menu that appears when the
 * selects a menu item that activates it. Finally, a &lt;code&gt;JPopupMenu&lt;/code&gt;
 * can also be used anywhere else you want a menu to appear.  For
 * example, when the user right-clicks in a specified area.
 * &lt;p&gt;
 * For information and examples of using popup menus, see
 * &lt;a
 href=&quot;http://docs.oracle.com/javase/tutorial/uiswing/components/menu.html&quot;&gt;How to Use Menus&lt;/a&gt;
 * in &lt;em&gt;The Java Tutorial.&lt;/em&gt;
 * &lt;p&gt;
 * &lt;strong&gt;Warning:&lt;/strong&gt; Swing is not thread safe. For more
 * information see &lt;a
 * href=&quot;package-summary.html#threading&quot;&gt;Swing's Threading
 * Policy&lt;/a&gt;.
 * &lt;p&gt;
 * &lt;strong&gt;Warning:&lt;/strong&gt;
 * Serialized objects of this class will not be compatible with
 * future Swing releases. The current serialization support is
 * appropriate for short term storage or RMI between applications running
 * the same version of Swing.  As of 1.4, support for long term storage
 * of all JavaBeans&amp;trade;
 * has been added to the &lt;code&gt;java.beans&lt;/code&gt; package.
 * Please see {@link java.beans.XMLEncoder}.
 *
 * @beaninfo
 *   attribute: isContainer false
 * description: A small window that pops up and displays a series of choices.
 *
 * @author Georges Saab
 * @author David Karlton
 * @author Arnaud Weber
 */
@SuppressWarnings(&quot;serial&quot;)
public class JPopupMenu extends JComponent implements Accessible,MenuElement {

    /**
     * @see #getUIClassID
     * @see #readObject
     */
    private static final String uiClassID = &quot;PopupMenuUI&quot;;

    /**
     * Key used in AppContext to determine if light way popups are the default.
     */
<span class="nc" id="L98">    private static final Object defaultLWPopupEnabledKey =</span>
        new StringBuffer(&quot;JPopupMenu.defaultLWPopupEnabledKey&quot;);

    /** Bug#4425878-Property javax.swing.adjustPopupLocationToFit introduced */
<span class="nc" id="L102">    static boolean popupPostionFixDisabled = false;</span>

    static {
<span class="nc" id="L105">        popupPostionFixDisabled = java.security.AccessController.doPrivileged(</span>
                new sun.security.action.GetPropertyAction(
<span class="nc" id="L107">                &quot;javax.swing.adjustPopupLocationToFit&quot;,&quot;&quot;)).equals(&quot;false&quot;);</span>

    }

    transient  Component invoker;
    transient  Popup popup;
    transient  Frame frame;
    private    int desiredLocationX,desiredLocationY;

<span class="nc" id="L116">    private    String     label                   = null;</span>
<span class="nc" id="L117">    private    boolean   paintBorder              = true;</span>
<span class="nc" id="L118">    private    Insets    margin                   = null;</span>

    /**
     * Used to indicate if lightweight popups should be used.
     */
<span class="nc" id="L123">    private    boolean   lightWeightPopup         = true;</span>

    /*
     * Model for the selected subcontrol.
     */
    private SingleSelectionModel selectionModel;

    /* Lock object used in place of class object for synchronization.
     * (4187686)
     */
<span class="nc" id="L133">    private static final Object classLock = new Object();</span>

    /* diagnostic aids -- should be false for production builds. */
    private static final boolean TRACE =   false; // trace creates and disposes
    private static final boolean VERBOSE = false; // show reuse hits/misses
    private static final boolean DEBUG =   false;  // show bad params, misc.

    /**
     *  Sets the default value of the &lt;code&gt;lightWeightPopupEnabled&lt;/code&gt;
     *  property.
     *
     *  @param aFlag &lt;code&gt;true&lt;/code&gt; if popups can be lightweight,
     *               otherwise &lt;code&gt;false&lt;/code&gt;
     *  @see #getDefaultLightWeightPopupEnabled
     *  @see #setLightWeightPopupEnabled
     */
    public static void setDefaultLightWeightPopupEnabled(boolean aFlag) {
<span class="nc" id="L150">        SwingUtilities.appContextPut(defaultLWPopupEnabledKey,</span>
<span class="nc" id="L151">                                     Boolean.valueOf(aFlag));</span>
<span class="nc" id="L152">    }</span>

    /**
     *  Gets the &lt;code&gt;defaultLightWeightPopupEnabled&lt;/code&gt; property,
     *  which by default is &lt;code&gt;true&lt;/code&gt;.
     *
     *  @return the value of the &lt;code&gt;defaultLightWeightPopupEnabled&lt;/code&gt;
     *          property
     *
     *  @see #setDefaultLightWeightPopupEnabled
     */
    public static boolean getDefaultLightWeightPopupEnabled() {
<span class="nc" id="L164">        Boolean b = (Boolean)</span>
<span class="nc" id="L165">            SwingUtilities.appContextGet(defaultLWPopupEnabledKey);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (b == null) {</span>
<span class="nc" id="L167">            SwingUtilities.appContextPut(defaultLWPopupEnabledKey,</span>
                                         Boolean.TRUE);
<span class="nc" id="L169">            return true;</span>
        }
<span class="nc" id="L171">        return b.booleanValue();</span>
    }

    /**
     * Constructs a &lt;code&gt;JPopupMenu&lt;/code&gt; without an &quot;invoker&quot;.
     */
    public JPopupMenu() {
<span class="nc" id="L178">        this(null);</span>
<span class="nc" id="L179">    }</span>

    /**
     * Constructs a &lt;code&gt;JPopupMenu&lt;/code&gt; with the specified title.
     *
     * @param label  the string that a UI may use to display as a title
     * for the popup menu.
     */
<span class="nc" id="L187">    public JPopupMenu(String label) {</span>
<span class="nc" id="L188">        this.label = label;</span>
<span class="nc" id="L189">        lightWeightPopup = getDefaultLightWeightPopupEnabled();</span>
<span class="nc" id="L190">        setSelectionModel(new DefaultSingleSelectionModel());</span>
<span class="nc" id="L191">        enableEvents(AWTEvent.MOUSE_EVENT_MASK);</span>
<span class="nc" id="L192">        setFocusTraversalKeysEnabled(false);</span>
<span class="nc" id="L193">        updateUI();</span>
<span class="nc" id="L194">    }</span>



    /**
     * Returns the look and feel (L&amp;amp;F) object that renders this component.
     *
     * @return the &lt;code&gt;PopupMenuUI&lt;/code&gt; object that renders this component
     */
    public PopupMenuUI getUI() {
<span class="nc" id="L204">        return (PopupMenuUI)ui;</span>
    }

    /**
     * Sets the L&amp;amp;F object that renders this component.
     *
     * @param ui the new &lt;code&gt;PopupMenuUI&lt;/code&gt; L&amp;amp;F object
     * @see UIDefaults#getUI
     * @beaninfo
     *        bound: true
     *       hidden: true
     *    attribute: visualUpdate true
     *  description: The UI object that implements the Component's LookAndFeel.
     */
    public void setUI(PopupMenuUI ui) {
<span class="nc" id="L219">        super.setUI(ui);</span>
<span class="nc" id="L220">    }</span>

    /**
     * Resets the UI property to a value from the current look and feel.
     *
     * @see JComponent#updateUI
     */
    public void updateUI() {
<span class="nc" id="L228">        setUI((PopupMenuUI)UIManager.getUI(this));</span>
<span class="nc" id="L229">    }</span>


    /**
     * Returns the name of the L&amp;amp;F class that renders this component.
     *
     * @return the string &quot;PopupMenuUI&quot;
     * @see JComponent#getUIClassID
     * @see UIDefaults#getUI
     */
    public String getUIClassID() {
<span class="nc" id="L240">        return uiClassID;</span>
    }

    protected void processFocusEvent(FocusEvent evt) {
<span class="nc" id="L244">        super.processFocusEvent(evt);</span>
<span class="nc" id="L245">    }</span>

    /**
     * Processes key stroke events such as mnemonics and accelerators.
     *
     * @param evt  the key event to be processed
     */
    protected void processKeyEvent(KeyEvent evt) {
<span class="nc" id="L253">        MenuSelectionManager.defaultManager().processKeyEvent(evt);</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (evt.isConsumed()) {</span>
<span class="nc" id="L255">            return;</span>
        }
<span class="nc" id="L257">        super.processKeyEvent(evt);</span>
<span class="nc" id="L258">    }</span>


    /**
     * Returns the model object that handles single selections.
     *
     * @return the &lt;code&gt;selectionModel&lt;/code&gt; property
     * @see SingleSelectionModel
     */
    public SingleSelectionModel getSelectionModel() {
<span class="nc" id="L268">        return selectionModel;</span>
    }

    /**
     * Sets the model object to handle single selections.
     *
     * @param model the new &lt;code&gt;SingleSelectionModel&lt;/code&gt;
     * @see SingleSelectionModel
     * @beaninfo
     * description: The selection model for the popup menu
     *      expert: true
     */
    public void setSelectionModel(SingleSelectionModel model) {
<span class="nc" id="L281">        selectionModel = model;</span>
<span class="nc" id="L282">    }</span>

    /**
     * Appends the specified menu item to the end of this menu.
     *
     * @param menuItem the &lt;code&gt;JMenuItem&lt;/code&gt; to add
     * @return the &lt;code&gt;JMenuItem&lt;/code&gt; added
     */
    public JMenuItem add(JMenuItem menuItem) {
<span class="nc" id="L291">        super.add(menuItem);</span>
<span class="nc" id="L292">        return menuItem;</span>
    }

    /**
     * Creates a new menu item with the specified text and appends
     * it to the end of this menu.
     *
     * @param s the string for the menu item to be added
     */
    public JMenuItem add(String s) {
<span class="nc" id="L302">        return add(new JMenuItem(s));</span>
    }

    /**
     * Appends a new menu item to the end of the menu which
     * dispatches the specified &lt;code&gt;Action&lt;/code&gt; object.
     *
     * @param a the &lt;code&gt;Action&lt;/code&gt; to add to the menu
     * @return the new menu item
     * @see Action
     */
    public JMenuItem add(Action a) {
<span class="nc" id="L314">        JMenuItem mi = createActionComponent(a);</span>
<span class="nc" id="L315">        mi.setAction(a);</span>
<span class="nc" id="L316">        add(mi);</span>
<span class="nc" id="L317">        return mi;</span>
    }

    /**
     * Returns an point which has been adjusted to take into account of the
     * desktop bounds, taskbar and multi-monitor configuration.
     * &lt;p&gt;
     * This adustment may be cancelled by invoking the application with
     * -Djavax.swing.adjustPopupLocationToFit=false
     */
    Point adjustPopupLocationToFitScreen(int xPosition, int yPosition) {
<span class="nc" id="L328">        Point popupLocation = new Point(xPosition, yPosition);</span>

<span class="nc bnc" id="L330" title="All 4 branches missed.">        if(popupPostionFixDisabled == true || GraphicsEnvironment.isHeadless()) {</span>
<span class="nc" id="L331">            return popupLocation;</span>
        }

        // Get screen bounds
        Rectangle scrBounds;
<span class="nc" id="L336">        GraphicsConfiguration gc = getCurrentGraphicsConfiguration(popupLocation);</span>
<span class="nc" id="L337">        Toolkit toolkit = Toolkit.getDefaultToolkit();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if(gc != null) {</span>
            // If we have GraphicsConfiguration use it to get screen bounds
<span class="nc" id="L340">            scrBounds = gc.getBounds();</span>
        } else {
            // If we don't have GraphicsConfiguration use primary screen
<span class="nc" id="L343">            scrBounds = new Rectangle(toolkit.getScreenSize());</span>
        }

        // Calculate the screen size that popup should fit
<span class="nc" id="L347">        Dimension popupSize = JPopupMenu.this.getPreferredSize();</span>
<span class="nc" id="L348">        long popupRightX = (long)popupLocation.x + (long)popupSize.width;</span>
<span class="nc" id="L349">        long popupBottomY = (long)popupLocation.y + (long)popupSize.height;</span>
<span class="nc" id="L350">        int scrWidth = scrBounds.width;</span>
<span class="nc" id="L351">        int scrHeight = scrBounds.height;</span>

<span class="nc bnc" id="L353" title="All 2 branches missed.">        if (!canPopupOverlapTaskBar()) {</span>
            // Insets include the task bar. Take them into account.
<span class="nc" id="L355">            Insets scrInsets = toolkit.getScreenInsets(gc);</span>
<span class="nc" id="L356">            scrBounds.x += scrInsets.left;</span>
<span class="nc" id="L357">            scrBounds.y += scrInsets.top;</span>
<span class="nc" id="L358">            scrWidth -= scrInsets.left + scrInsets.right;</span>
<span class="nc" id="L359">            scrHeight -= scrInsets.top + scrInsets.bottom;</span>
        }
<span class="nc" id="L361">        int scrRightX = scrBounds.x + scrWidth;</span>
<span class="nc" id="L362">        int scrBottomY = scrBounds.y + scrHeight;</span>

        // Ensure that popup menu fits the screen
<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (popupRightX &gt; (long) scrRightX) {</span>
<span class="nc" id="L366">            popupLocation.x = scrRightX - popupSize.width;</span>
        }

<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (popupBottomY &gt; (long) scrBottomY) {</span>
<span class="nc" id="L370">            popupLocation.y = scrBottomY - popupSize.height;</span>
        }

<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (popupLocation.x &lt; scrBounds.x) {</span>
<span class="nc" id="L374">            popupLocation.x = scrBounds.x;</span>
        }

<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (popupLocation.y &lt; scrBounds.y) {</span>
<span class="nc" id="L378">            popupLocation.y = scrBounds.y;</span>
        }

<span class="nc" id="L381">        return popupLocation;</span>
    }

    /**
     * Tries to find GraphicsConfiguration
     * that contains the mouse cursor position.
     * Can return null.
     */
    private GraphicsConfiguration getCurrentGraphicsConfiguration(
            Point popupLocation) {
<span class="nc" id="L391">        GraphicsConfiguration gc = null;</span>
        GraphicsEnvironment ge =
<span class="nc" id="L393">            GraphicsEnvironment.getLocalGraphicsEnvironment();</span>
<span class="nc" id="L394">        GraphicsDevice[] gd = ge.getScreenDevices();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">        for(int i = 0; i &lt; gd.length; i++) {</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">            if(gd[i].getType() == GraphicsDevice.TYPE_RASTER_SCREEN) {</span>
<span class="nc" id="L397">                GraphicsConfiguration dgc =</span>
<span class="nc" id="L398">                    gd[i].getDefaultConfiguration();</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">                if(dgc.getBounds().contains(popupLocation)) {</span>
<span class="nc" id="L400">                    gc = dgc;</span>
<span class="nc" id="L401">                    break;</span>
                }
            }
        }
        // If not found and we have invoker, ask invoker about his gc
<span class="nc bnc" id="L406" title="All 4 branches missed.">        if(gc == null &amp;&amp; getInvoker() != null) {</span>
<span class="nc" id="L407">            gc = getInvoker().getGraphicsConfiguration();</span>
        }
<span class="nc" id="L409">        return gc;</span>
    }

    /**
     * Returns whether popup is allowed to be shown above the task bar.
     */
    static boolean canPopupOverlapTaskBar() {
<span class="nc" id="L416">        boolean result = true;</span>

<span class="nc" id="L418">        Toolkit tk = Toolkit.getDefaultToolkit();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (tk instanceof SunToolkit) {</span>
<span class="nc" id="L420">            result = ((SunToolkit)tk).canPopupOverlapTaskBar();</span>
        }

<span class="nc" id="L423">        return result;</span>
    }

    /**
     * Factory method which creates the &lt;code&gt;JMenuItem&lt;/code&gt; for
     * &lt;code&gt;Actions&lt;/code&gt; added to the &lt;code&gt;JPopupMenu&lt;/code&gt;.
     *
     * @param a the &lt;code&gt;Action&lt;/code&gt; for the menu item to be added
     * @return the new menu item
     * @see Action
     *
     * @since 1.3
     */
    protected JMenuItem createActionComponent(Action a) {
<span class="nc" id="L437">        JMenuItem mi = new JMenuItem() {</span>
            protected PropertyChangeListener createActionPropertyChangeListener(Action a) {
<span class="nc" id="L439">                PropertyChangeListener pcl = createActionChangeListener(this);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                if (pcl == null) {</span>
<span class="nc" id="L441">                    pcl = super.createActionPropertyChangeListener(a);</span>
                }
<span class="nc" id="L443">                return pcl;</span>
            }
        };
<span class="nc" id="L446">        mi.setHorizontalTextPosition(JButton.TRAILING);</span>
<span class="nc" id="L447">        mi.setVerticalTextPosition(JButton.CENTER);</span>
<span class="nc" id="L448">        return mi;</span>
    }

    /**
     * Returns a properly configured &lt;code&gt;PropertyChangeListener&lt;/code&gt;
     * which updates the control as changes to the &lt;code&gt;Action&lt;/code&gt; occur.
     */
    protected PropertyChangeListener createActionChangeListener(JMenuItem b) {
<span class="nc" id="L456">        return b.createActionPropertyChangeListener0(b.getAction());</span>
    }

    /**
     * Removes the component at the specified index from this popup menu.
     *
     * @param       pos the position of the item to be removed
     * @exception   IllegalArgumentException if the value of
     *                          &lt;code&gt;pos&lt;/code&gt; &amp;lt; 0, or if the value of
     *                          &lt;code&gt;pos&lt;/code&gt; is greater than the
     *                          number of items
     */
    public void remove(int pos) {
<span class="nc bnc" id="L469" title="All 2 branches missed.">        if (pos &lt; 0) {</span>
<span class="nc" id="L470">            throw new IllegalArgumentException(&quot;index less than zero.&quot;);</span>
        }
<span class="nc bnc" id="L472" title="All 2 branches missed.">        if (pos &gt; getComponentCount() -1) {</span>
<span class="nc" id="L473">            throw new IllegalArgumentException(&quot;index greater than the number of items.&quot;);</span>
        }
<span class="nc" id="L475">        super.remove(pos);</span>
<span class="nc" id="L476">    }</span>

    /**
     * Sets the value of the &lt;code&gt;lightWeightPopupEnabled&lt;/code&gt; property,
     * which by default is &lt;code&gt;true&lt;/code&gt;.
     * By default, when a look and feel displays a popup,
     * it can choose to
     * use a lightweight (all-Java) popup.
     * Lightweight popup windows are more efficient than heavyweight
     * (native peer) windows,
     * but lightweight and heavyweight components do not mix well in a GUI.
     * If your application mixes lightweight and heavyweight components,
     * you should disable lightweight popups.
     * Some look and feels might always use heavyweight popups,
     * no matter what the value of this property.
     *
     * @param aFlag  &lt;code&gt;false&lt;/code&gt; to disable lightweight popups
     * @beaninfo
     * description: Determines whether lightweight popups are used when possible
     *      expert: true
     *
     * @see #isLightWeightPopupEnabled
     */
    public void setLightWeightPopupEnabled(boolean aFlag) {
        // NOTE: this use to set the flag on a shared JPopupMenu, which meant
        // this effected ALL JPopupMenus.
<span class="nc" id="L502">        lightWeightPopup = aFlag;</span>
<span class="nc" id="L503">    }</span>

    /**
     * Gets the &lt;code&gt;lightWeightPopupEnabled&lt;/code&gt; property.
     *
     * @return the value of the &lt;code&gt;lightWeightPopupEnabled&lt;/code&gt; property
     * @see #setLightWeightPopupEnabled
     */
    public boolean isLightWeightPopupEnabled() {
<span class="nc" id="L512">        return lightWeightPopup;</span>
    }

    /**
     * Returns the popup menu's label
     *
     * @return a string containing the popup menu's label
     * @see #setLabel
     */
    public String getLabel() {
<span class="nc" id="L522">        return label;</span>
    }

    /**
     * Sets the popup menu's label.  Different look and feels may choose
     * to display or not display this.
     *
     * @param label a string specifying the label for the popup menu
     *
     * @see #setLabel
     * @beaninfo
     * description: The label for the popup menu.
     *       bound: true
     */
    public void setLabel(String label) {
<span class="nc" id="L537">        String oldValue = this.label;</span>
<span class="nc" id="L538">        this.label = label;</span>
<span class="nc" id="L539">        firePropertyChange(&quot;label&quot;, oldValue, label);</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">        if (accessibleContext != null) {</span>
<span class="nc" id="L541">            accessibleContext.firePropertyChange(</span>
                AccessibleContext.ACCESSIBLE_VISIBLE_DATA_PROPERTY,
                oldValue, label);
        }
<span class="nc" id="L545">        invalidate();</span>
<span class="nc" id="L546">        repaint();</span>
<span class="nc" id="L547">    }</span>

    /**
     * Appends a new separator at the end of the menu.
     */
    public void addSeparator() {
<span class="nc" id="L553">        add( new JPopupMenu.Separator() );</span>
<span class="nc" id="L554">    }</span>

    /**
     * Inserts a menu item for the specified &lt;code&gt;Action&lt;/code&gt; object at
     * a given position.
     *
     * @param a  the &lt;code&gt;Action&lt;/code&gt; object to insert
     * @param index      specifies the position at which to insert the
     *                   &lt;code&gt;Action&lt;/code&gt;, where 0 is the first
     * @exception IllegalArgumentException if &lt;code&gt;index&lt;/code&gt; &amp;lt; 0
     * @see Action
     */
    public void insert(Action a, int index) {
<span class="nc" id="L567">        JMenuItem mi = createActionComponent(a);</span>
<span class="nc" id="L568">        mi.setAction(a);</span>
<span class="nc" id="L569">        insert(mi, index);</span>
<span class="nc" id="L570">    }</span>

    /**
     * Inserts the specified component into the menu at a given
     * position.
     *
     * @param component  the &lt;code&gt;Component&lt;/code&gt; to insert
     * @param index      specifies the position at which
     *                   to insert the component, where 0 is the first
     * @exception IllegalArgumentException if &lt;code&gt;index&lt;/code&gt; &amp;lt; 0
     */
    public void insert(Component component, int index) {
<span class="nc bnc" id="L582" title="All 2 branches missed.">        if (index &lt; 0) {</span>
<span class="nc" id="L583">            throw new IllegalArgumentException(&quot;index less than zero.&quot;);</span>
        }

<span class="nc" id="L586">        int nitems = getComponentCount();</span>
        // PENDING(ges): Why not use an array?
<span class="nc" id="L588">        Vector&lt;Component&gt; tempItems = new Vector&lt;Component&gt;();</span>

        /* Remove the item at index, nitems-index times
           storing them in a temporary vector in the
           order they appear on the menu.
           */
<span class="nc bnc" id="L594" title="All 2 branches missed.">        for (int i = index ; i &lt; nitems; i++) {</span>
<span class="nc" id="L595">            tempItems.addElement(getComponent(index));</span>
<span class="nc" id="L596">            remove(index);</span>
        }

<span class="nc" id="L599">        add(component);</span>

        /* Add the removed items back to the menu, they are
           already in the correct order in the temp vector.
           */
<span class="nc bnc" id="L604" title="All 2 branches missed.">        for (Component tempItem : tempItems) {</span>
<span class="nc" id="L605">            add(tempItem);</span>
<span class="nc" id="L606">        }</span>
<span class="nc" id="L607">    }</span>

    /**
     *  Adds a &lt;code&gt;PopupMenu&lt;/code&gt; listener.
     *
     *  @param l  the &lt;code&gt;PopupMenuListener&lt;/code&gt; to add
     */
    public void addPopupMenuListener(PopupMenuListener l) {
<span class="nc" id="L615">        listenerList.add(PopupMenuListener.class,l);</span>
<span class="nc" id="L616">    }</span>

    /**
     * Removes a &lt;code&gt;PopupMenu&lt;/code&gt; listener.
     *
     * @param l  the &lt;code&gt;PopupMenuListener&lt;/code&gt; to remove
     */
    public void removePopupMenuListener(PopupMenuListener l) {
<span class="nc" id="L624">        listenerList.remove(PopupMenuListener.class,l);</span>
<span class="nc" id="L625">    }</span>

    /**
     * Returns an array of all the &lt;code&gt;PopupMenuListener&lt;/code&gt;s added
     * to this JMenuItem with addPopupMenuListener().
     *
     * @return all of the &lt;code&gt;PopupMenuListener&lt;/code&gt;s added or an empty
     *         array if no listeners have been added
     * @since 1.4
     */
    public PopupMenuListener[] getPopupMenuListeners() {
<span class="nc" id="L636">        return listenerList.getListeners(PopupMenuListener.class);</span>
    }

    /**
     * Adds a &lt;code&gt;MenuKeyListener&lt;/code&gt; to the popup menu.
     *
     * @param l the &lt;code&gt;MenuKeyListener&lt;/code&gt; to be added
     * @since 1.5
     */
    public void addMenuKeyListener(MenuKeyListener l) {
<span class="nc" id="L646">        listenerList.add(MenuKeyListener.class, l);</span>
<span class="nc" id="L647">    }</span>

    /**
     * Removes a &lt;code&gt;MenuKeyListener&lt;/code&gt; from the popup menu.
     *
     * @param l the &lt;code&gt;MenuKeyListener&lt;/code&gt; to be removed
     * @since 1.5
     */
    public void removeMenuKeyListener(MenuKeyListener l) {
<span class="nc" id="L656">        listenerList.remove(MenuKeyListener.class, l);</span>
<span class="nc" id="L657">    }</span>

    /**
     * Returns an array of all the &lt;code&gt;MenuKeyListener&lt;/code&gt;s added
     * to this JPopupMenu with addMenuKeyListener().
     *
     * @return all of the &lt;code&gt;MenuKeyListener&lt;/code&gt;s added or an empty
     *         array if no listeners have been added
     * @since 1.5
     */
    public MenuKeyListener[] getMenuKeyListeners() {
<span class="nc" id="L668">        return listenerList.getListeners(MenuKeyListener.class);</span>
    }

    /**
     * Notifies &lt;code&gt;PopupMenuListener&lt;/code&gt;s that this popup menu will
     * become visible.
     */
    protected void firePopupMenuWillBecomeVisible() {
<span class="nc" id="L676">        Object[] listeners = listenerList.getListenerList();</span>
<span class="nc" id="L677">        PopupMenuEvent e=null;</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">        for (int i = listeners.length-2; i&gt;=0; i-=2) {</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">            if (listeners[i]==PopupMenuListener.class) {</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                if (e == null)</span>
<span class="nc" id="L681">                    e = new PopupMenuEvent(this);</span>
<span class="nc" id="L682">                ((PopupMenuListener)listeners[i+1]).popupMenuWillBecomeVisible(e);</span>
            }
        }
<span class="nc" id="L685">    }</span>

    /**
     * Notifies &lt;code&gt;PopupMenuListener&lt;/code&gt;s that this popup menu will
     * become invisible.
     */
    protected void firePopupMenuWillBecomeInvisible() {
<span class="nc" id="L692">        Object[] listeners = listenerList.getListenerList();</span>
<span class="nc" id="L693">        PopupMenuEvent e=null;</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">        for (int i = listeners.length-2; i&gt;=0; i-=2) {</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">            if (listeners[i]==PopupMenuListener.class) {</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                if (e == null)</span>
<span class="nc" id="L697">                    e = new PopupMenuEvent(this);</span>
<span class="nc" id="L698">                ((PopupMenuListener)listeners[i+1]).popupMenuWillBecomeInvisible(e);</span>
            }
        }
<span class="nc" id="L701">    }</span>

    /**
     * Notifies &lt;code&gt;PopupMenuListeners&lt;/code&gt; that this popup menu is
     * cancelled.
     */
    protected void firePopupMenuCanceled() {
<span class="nc" id="L708">        Object[] listeners = listenerList.getListenerList();</span>
<span class="nc" id="L709">        PopupMenuEvent e=null;</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">        for (int i = listeners.length-2; i&gt;=0; i-=2) {</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">            if (listeners[i]==PopupMenuListener.class) {</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                if (e == null)</span>
<span class="nc" id="L713">                    e = new PopupMenuEvent(this);</span>
<span class="nc" id="L714">                ((PopupMenuListener)listeners[i+1]).popupMenuCanceled(e);</span>
            }
        }
<span class="nc" id="L717">    }</span>

    /**
     * Always returns true since popups, by definition, should always
     * be on top of all other windows.
     * @return true
     */
    // package private
    boolean alwaysOnTop() {
<span class="nc" id="L726">        return true;</span>
    }

    /**
     * Lays out the container so that it uses the minimum space
     * needed to display its contents.
     */
    public void pack() {
<span class="nc bnc" id="L734" title="All 2 branches missed.">        if(popup != null) {</span>
<span class="nc" id="L735">            Dimension pref = getPreferredSize();</span>

<span class="nc bnc" id="L737" title="All 4 branches missed.">            if (pref == null || pref.width != getWidth() ||</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">                                pref.height != getHeight()) {</span>
<span class="nc" id="L739">                popup = getPopup();</span>
            } else {
<span class="nc" id="L741">                validate();</span>
            }
        }
<span class="nc" id="L744">    }</span>

    /**
     * Sets the visibility of the popup menu.
     *
     * @param b true to make the popup visible, or false to
     *          hide it
     * @beaninfo
     *           bound: true
     *     description: Makes the popup visible
     */
    public void setVisible(boolean b) {
        if (DEBUG) {
            System.out.println(&quot;JPopupMenu.setVisible &quot; + b);
        }

        // Is it a no-op?
<span class="nc bnc" id="L761" title="All 2 branches missed.">        if (b == isVisible())</span>
<span class="nc" id="L762">            return;</span>

        // if closing, first close all Submenus
<span class="nc bnc" id="L765" title="All 2 branches missed.">        if (b == false) {</span>

            // 4234793: This is a workaround because JPopupMenu.firePopupMenuCanceled is
            // a protected method and cannot be called from BasicPopupMenuUI directly
            // The real solution could be to make
            // firePopupMenuCanceled public and call it directly.
<span class="nc" id="L771">            Boolean doCanceled = (Boolean)getClientProperty(&quot;JPopupMenu.firePopupMenuCanceled&quot;);</span>
<span class="nc bnc" id="L772" title="All 4 branches missed.">            if (doCanceled != null &amp;&amp; doCanceled == Boolean.TRUE) {</span>
<span class="nc" id="L773">                putClientProperty(&quot;JPopupMenu.firePopupMenuCanceled&quot;, Boolean.FALSE);</span>
<span class="nc" id="L774">                firePopupMenuCanceled();</span>
            }
<span class="nc" id="L776">            getSelectionModel().clearSelection();</span>

<span class="nc" id="L778">        } else {</span>
            // This is a popup menu with MenuElement children,
            // set selection path before popping up!
<span class="nc bnc" id="L781" title="All 2 branches missed.">            if (isPopupMenu()) {</span>
<span class="nc" id="L782">                MenuElement me[] = new MenuElement[1];</span>
<span class="nc" id="L783">                me[0] = this;</span>
<span class="nc" id="L784">                MenuSelectionManager.defaultManager().setSelectedPath(me);</span>
            }
        }

<span class="nc bnc" id="L788" title="All 2 branches missed.">        if(b) {</span>
<span class="nc" id="L789">            firePopupMenuWillBecomeVisible();</span>
<span class="nc" id="L790">            popup = getPopup();</span>
<span class="nc" id="L791">            firePropertyChange(&quot;visible&quot;, Boolean.FALSE, Boolean.TRUE);</span>


<span class="nc bnc" id="L794" title="All 2 branches missed.">        } else if(popup != null) {</span>
<span class="nc" id="L795">            firePopupMenuWillBecomeInvisible();</span>
<span class="nc" id="L796">            popup.hide();</span>
<span class="nc" id="L797">            popup = null;</span>
<span class="nc" id="L798">            firePropertyChange(&quot;visible&quot;, Boolean.TRUE, Boolean.FALSE);</span>
            // 4694797: When popup menu is made invisible, selected path
            // should be cleared
<span class="nc bnc" id="L801" title="All 2 branches missed.">            if (isPopupMenu()) {</span>
<span class="nc" id="L802">                MenuSelectionManager.defaultManager().clearSelectedPath();</span>
            }
        }
<span class="nc" id="L805">    }</span>

    /**
     * Returns a &lt;code&gt;Popup&lt;/code&gt; instance from the
     * &lt;code&gt;PopupMenuUI&lt;/code&gt; that has had &lt;code&gt;show&lt;/code&gt; invoked on
     * it. If the current &lt;code&gt;popup&lt;/code&gt; is non-null,
     * this will invoke &lt;code&gt;dispose&lt;/code&gt; of it, and then
     * &lt;code&gt;show&lt;/code&gt; the new one.
     * &lt;p&gt;
     * This does NOT fire any events, it is up the caller to dispatch
     * the necessary events.
     */
    private Popup getPopup() {
<span class="nc" id="L818">        Popup oldPopup = popup;</span>

<span class="nc bnc" id="L820" title="All 2 branches missed.">        if (oldPopup != null) {</span>
<span class="nc" id="L821">            oldPopup.hide();</span>
        }
<span class="nc" id="L823">        PopupFactory popupFactory = PopupFactory.getSharedInstance();</span>

<span class="nc bnc" id="L825" title="All 2 branches missed.">        if (isLightWeightPopupEnabled()) {</span>
<span class="nc" id="L826">            popupFactory.setPopupType(PopupFactory.LIGHT_WEIGHT_POPUP);</span>
        }
        else {
<span class="nc" id="L829">            popupFactory.setPopupType(PopupFactory.HEAVY_WEIGHT_POPUP);</span>
        }

        // adjust the location of the popup
<span class="nc" id="L833">        Point p = adjustPopupLocationToFitScreen(desiredLocationX,desiredLocationY);</span>
<span class="nc" id="L834">        desiredLocationX = p.x;</span>
<span class="nc" id="L835">        desiredLocationY = p.y;</span>

<span class="nc" id="L837">        Popup newPopup = getUI().getPopup(this, desiredLocationX,</span>
                                          desiredLocationY);

<span class="nc" id="L840">        popupFactory.setPopupType(PopupFactory.LIGHT_WEIGHT_POPUP);</span>
<span class="nc" id="L841">        newPopup.show();</span>
<span class="nc" id="L842">        return newPopup;</span>
    }

    /**
     * Returns true if the popup menu is visible (currently
     * being displayed).
     */
    public boolean isVisible() {
<span class="nc bnc" id="L850" title="All 2 branches missed.">        return popup != null;</span>
    }

    /**
     * Sets the location of the upper left corner of the
     * popup menu using x, y coordinates.
     * &lt;p&gt;
     * The method changes the geometry-related data. Therefore,
     * the native windowing system may ignore such requests, or it may modify
     * the requested data, so that the {@code JPopupMenu} object is placed and sized
     * in a way that corresponds closely to the desktop settings.
     *
     * @param x the x coordinate of the popup's new position
     *          in the screen's coordinate space
     * @param y the y coordinate of the popup's new position
     *          in the screen's coordinate space
     * @beaninfo
     * description: The location of the popup menu.
     */
    public void setLocation(int x, int y) {
<span class="nc" id="L870">        int oldX = desiredLocationX;</span>
<span class="nc" id="L871">        int oldY = desiredLocationY;</span>

<span class="nc" id="L873">        desiredLocationX = x;</span>
<span class="nc" id="L874">        desiredLocationY = y;</span>
<span class="nc bnc" id="L875" title="All 6 branches missed.">        if(popup != null &amp;&amp; (x != oldX || y != oldY)) {</span>
<span class="nc" id="L876">            popup = getPopup();</span>
        }
<span class="nc" id="L878">    }</span>

    /**
     * Returns true if the popup menu is a standalone popup menu
     * rather than the submenu of a &lt;code&gt;JMenu&lt;/code&gt;.
     *
     * @return true if this menu is a standalone popup menu, otherwise false
     */
    private boolean isPopupMenu() {
<span class="nc bnc" id="L887" title="All 4 branches missed.">        return  ((invoker != null) &amp;&amp; !(invoker instanceof JMenu));</span>
    }

    /**
     * Returns the component which is the 'invoker' of this
     * popup menu.
     *
     * @return the &lt;code&gt;Component&lt;/code&gt; in which the popup menu is displayed
     */
    public Component getInvoker() {
<span class="nc" id="L897">        return this.invoker;</span>
    }

    /**
     * Sets the invoker of this popup menu -- the component in which
     * the popup menu menu is to be displayed.
     *
     * @param invoker the &lt;code&gt;Component&lt;/code&gt; in which the popup
     *          menu is displayed
     * @beaninfo
     * description: The invoking component for the popup menu
     *      expert: true
     */
    public void setInvoker(Component invoker) {
<span class="nc" id="L911">        Component oldInvoker = this.invoker;</span>
<span class="nc" id="L912">        this.invoker = invoker;</span>
<span class="nc bnc" id="L913" title="All 4 branches missed.">        if ((oldInvoker != this.invoker) &amp;&amp; (ui != null)) {</span>
<span class="nc" id="L914">            ui.uninstallUI(this);</span>
<span class="nc" id="L915">            ui.installUI(this);</span>
        }
<span class="nc" id="L917">        invalidate();</span>
<span class="nc" id="L918">    }</span>

    /**
     * Displays the popup menu at the position x,y in the coordinate
     * space of the component invoker.
     *
     * @param invoker the component in whose space the popup menu is to appear
     * @param x the x coordinate in invoker's coordinate space at which
     * the popup menu is to be displayed
     * @param y the y coordinate in invoker's coordinate space at which
     * the popup menu is to be displayed
     */
    public void show(Component invoker, int x, int y) {
        if (DEBUG) {
            System.out.println(&quot;in JPopupMenu.show &quot; );
        }
<span class="nc" id="L934">        setInvoker(invoker);</span>
<span class="nc" id="L935">        Frame newFrame = getFrame(invoker);</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">        if (newFrame != frame) {</span>
            // Use the invoker's frame so that events
            // are propagated properly
<span class="nc bnc" id="L939" title="All 2 branches missed.">            if (newFrame!=null) {</span>
<span class="nc" id="L940">                this.frame = newFrame;</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">                if(popup != null) {</span>
<span class="nc" id="L942">                    setVisible(false);</span>
                }
            }
        }
        Point invokerOrigin;
<span class="nc bnc" id="L947" title="All 2 branches missed.">        if (invoker != null) {</span>
<span class="nc" id="L948">            invokerOrigin = invoker.getLocationOnScreen();</span>

            // To avoid integer overflow
            long lx, ly;
<span class="nc" id="L952">            lx = ((long) invokerOrigin.x) +</span>
                 ((long) x);
<span class="nc" id="L954">            ly = ((long) invokerOrigin.y) +</span>
                 ((long) y);
<span class="nc bnc" id="L956" title="All 2 branches missed.">            if(lx &gt; Integer.MAX_VALUE) lx = Integer.MAX_VALUE;</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">            if(lx &lt; Integer.MIN_VALUE) lx = Integer.MIN_VALUE;</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">            if(ly &gt; Integer.MAX_VALUE) ly = Integer.MAX_VALUE;</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">            if(ly &lt; Integer.MIN_VALUE) ly = Integer.MIN_VALUE;</span>

<span class="nc" id="L961">            setLocation((int) lx, (int) ly);</span>
<span class="nc" id="L962">        } else {</span>
<span class="nc" id="L963">            setLocation(x, y);</span>
        }
<span class="nc" id="L965">        setVisible(true);</span>
<span class="nc" id="L966">    }</span>

    /**
     * Returns the popup menu which is at the root of the menu system
     * for this popup menu.
     *
     * @return the topmost grandparent &lt;code&gt;JPopupMenu&lt;/code&gt;
     */
    JPopupMenu getRootPopupMenu() {
<span class="nc" id="L975">        JPopupMenu mp = this;</span>
<span class="nc bnc" id="L976" title="All 4 branches missed.">        while((mp!=null) &amp;&amp; (mp.isPopupMenu()!=true) &amp;&amp;</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">              (mp.getInvoker() != null) &amp;&amp;</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">              (mp.getInvoker().getParent() != null) &amp;&amp;</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">              (mp.getInvoker().getParent() instanceof JPopupMenu)</span>
              ) {
<span class="nc" id="L981">            mp = (JPopupMenu) mp.getInvoker().getParent();</span>
        }
<span class="nc" id="L983">        return mp;</span>
    }

    /**
     * Returns the component at the specified index.
     *
     * @param i  the index of the component, where 0 is the first
     * @return the &lt;code&gt;Component&lt;/code&gt; at that index
     * @deprecated replaced by {@link java.awt.Container#getComponent(int)}
     */
    @Deprecated
    public Component getComponentAtIndex(int i) {
<span class="nc" id="L995">        return getComponent(i);</span>
    }

    /**
     * Returns the index of the specified component.
     *
     * @param  c the &lt;code&gt;Component&lt;/code&gt; to find
     * @return the index of the component, where 0 is the first;
     *         or -1 if the component is not found
     */
    public int getComponentIndex(Component c) {
<span class="nc" id="L1006">        int ncomponents = this.getComponentCount();</span>
<span class="nc" id="L1007">        Component[] component = this.getComponents();</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">        for (int i = 0 ; i &lt; ncomponents ; i++) {</span>
<span class="nc" id="L1009">            Component comp = component[i];</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">            if (comp == c)</span>
<span class="nc" id="L1011">                return i;</span>
        }
<span class="nc" id="L1013">        return -1;</span>
    }

    /**
     * Sets the size of the Popup window using a &lt;code&gt;Dimension&lt;/code&gt; object.
     * This is equivalent to &lt;code&gt;setPreferredSize(d)&lt;/code&gt;.
     *
     * @param d   the &lt;code&gt;Dimension&lt;/code&gt; specifying the new size
     * of this component.
     * @beaninfo
     * description: The size of the popup menu
     */
    public void setPopupSize(Dimension d) {
<span class="nc" id="L1026">        Dimension oldSize = getPreferredSize();</span>

<span class="nc" id="L1028">        setPreferredSize(d);</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">        if (popup != null) {</span>
<span class="nc" id="L1030">            Dimension newSize = getPreferredSize();</span>

<span class="nc bnc" id="L1032" title="All 2 branches missed.">            if (!oldSize.equals(newSize)) {</span>
<span class="nc" id="L1033">                popup = getPopup();</span>
            }
        }
<span class="nc" id="L1036">    }</span>

    /**
     * Sets the size of the Popup window to the specified width and
     * height. This is equivalent to
     *  &lt;code&gt;setPreferredSize(new Dimension(width, height))&lt;/code&gt;.
     *
     * @param width the new width of the Popup in pixels
     * @param height the new height of the Popup in pixels
     * @beaninfo
     * description: The size of the popup menu
     */
    public void setPopupSize(int width, int height) {
<span class="nc" id="L1049">        setPopupSize(new Dimension(width, height));</span>
<span class="nc" id="L1050">    }</span>

    /**
     * Sets the currently selected component,  This will result
     * in a change to the selection model.
     *
     * @param sel the &lt;code&gt;Component&lt;/code&gt; to select
     * @beaninfo
     * description: The selected component on the popup menu
     *      expert: true
     *      hidden: true
     */
    public void setSelected(Component sel) {
<span class="nc" id="L1063">        SingleSelectionModel model = getSelectionModel();</span>
<span class="nc" id="L1064">        int index = getComponentIndex(sel);</span>
<span class="nc" id="L1065">        model.setSelectedIndex(index);</span>
<span class="nc" id="L1066">    }</span>

    /**
     * Checks whether the border should be painted.
     *
     * @return true if the border is painted, false otherwise
     * @see #setBorderPainted
     */
    public boolean isBorderPainted() {
<span class="nc" id="L1075">        return paintBorder;</span>
    }

    /**
     * Sets whether the border should be painted.
     *
     * @param b if true, the border is painted.
     * @see #isBorderPainted
     * @beaninfo
     * description: Is the border of the popup menu painted
     */
    public void setBorderPainted(boolean b) {
<span class="nc" id="L1087">        paintBorder = b;</span>
<span class="nc" id="L1088">        repaint();</span>
<span class="nc" id="L1089">    }</span>

    /**
     * Paints the popup menu's border if the &lt;code&gt;borderPainted&lt;/code&gt;
     * property is &lt;code&gt;true&lt;/code&gt;.
     * @param g  the &lt;code&gt;Graphics&lt;/code&gt; object
     *
     * @see JComponent#paint
     * @see JComponent#setBorder
     */
    protected void paintBorder(Graphics g) {
<span class="nc bnc" id="L1100" title="All 2 branches missed.">        if (isBorderPainted()) {</span>
<span class="nc" id="L1101">            super.paintBorder(g);</span>
        }
<span class="nc" id="L1103">    }</span>

    /**
     * Returns the margin, in pixels, between the popup menu's border and
     * its containers.
     *
     * @return an &lt;code&gt;Insets&lt;/code&gt; object containing the margin values.
     */
    public Insets getMargin() {
<span class="nc bnc" id="L1112" title="All 2 branches missed.">        if(margin == null) {</span>
<span class="nc" id="L1113">            return new Insets(0,0,0,0);</span>
        } else {
<span class="nc" id="L1115">            return margin;</span>
        }
    }


    /**
     * Examines the list of menu items to determine whether
     * &lt;code&gt;popup&lt;/code&gt; is a popup menu.
     *
     * @param popup  a &lt;code&gt;JPopupMenu&lt;/code&gt;
     * @return true if &lt;code&gt;popup&lt;/code&gt;
     */
    boolean isSubPopupMenu(JPopupMenu popup) {
<span class="nc" id="L1128">        int ncomponents = this.getComponentCount();</span>
<span class="nc" id="L1129">        Component[] component = this.getComponents();</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">        for (int i = 0 ; i &lt; ncomponents ; i++) {</span>
<span class="nc" id="L1131">            Component comp = component[i];</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">            if (comp instanceof JMenu) {</span>
<span class="nc" id="L1133">                JMenu menu = (JMenu)comp;</span>
<span class="nc" id="L1134">                JPopupMenu subPopup = menu.getPopupMenu();</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">                if (subPopup == popup)</span>
<span class="nc" id="L1136">                    return true;</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">                if (subPopup.isSubPopupMenu(popup))</span>
<span class="nc" id="L1138">                    return true;</span>
            }
        }
<span class="nc" id="L1141">        return false;</span>
    }


    private static Frame getFrame(Component c) {
<span class="nc" id="L1146">        Component w = c;</span>

<span class="nc bnc" id="L1148" title="All 4 branches missed.">        while(!(w instanceof Frame) &amp;&amp; (w!=null)) {</span>
<span class="nc" id="L1149">            w = w.getParent();</span>
        }
<span class="nc" id="L1151">        return (Frame)w;</span>
    }


    /**
     * Returns a string representation of this &lt;code&gt;JPopupMenu&lt;/code&gt;.
     * This method
     * is intended to be used only for debugging purposes, and the
     * content and format of the returned string may vary between
     * implementations. The returned string may be empty but may not
     * be &lt;code&gt;null&lt;/code&gt;.
     *
     * @return  a string representation of this &lt;code&gt;JPopupMenu&lt;/code&gt;.
     */
    protected String paramString() {
<span class="nc bnc" id="L1166" title="All 2 branches missed.">        String labelString = (label != null ?</span>
                              label : &quot;&quot;);
<span class="nc bnc" id="L1168" title="All 2 branches missed.">        String paintBorderString = (paintBorder ?</span>
                                    &quot;true&quot; : &quot;false&quot;);
<span class="nc bnc" id="L1170" title="All 2 branches missed.">        String marginString = (margin != null ?</span>
<span class="nc" id="L1171">                              margin.toString() : &quot;&quot;);</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">        String lightWeightPopupEnabledString = (isLightWeightPopupEnabled() ?</span>
                                                &quot;true&quot; : &quot;false&quot;);
<span class="nc" id="L1174">        return super.paramString() +</span>
            &quot;,desiredLocationX=&quot; + desiredLocationX +
            &quot;,desiredLocationY=&quot; + desiredLocationY +
        &quot;,label=&quot; + labelString +
        &quot;,lightWeightPopupEnabled=&quot; + lightWeightPopupEnabledString +
        &quot;,margin=&quot; + marginString +
        &quot;,paintBorder=&quot; + paintBorderString;
    }

/////////////////
// Accessibility support
////////////////

    /**
     * Gets the AccessibleContext associated with this JPopupMenu.
     * For JPopupMenus, the AccessibleContext takes the form of an
     * AccessibleJPopupMenu.
     * A new AccessibleJPopupMenu instance is created if necessary.
     *
     * @return an AccessibleJPopupMenu that serves as the
     *         AccessibleContext of this JPopupMenu
     */
    public AccessibleContext getAccessibleContext() {
<span class="nc bnc" id="L1197" title="All 2 branches missed.">        if (accessibleContext == null) {</span>
<span class="nc" id="L1198">            accessibleContext = new AccessibleJPopupMenu();</span>
        }
<span class="nc" id="L1200">        return accessibleContext;</span>
    }

    /**
     * This class implements accessibility support for the
     * &lt;code&gt;JPopupMenu&lt;/code&gt; class.  It provides an implementation of the
     * Java Accessibility API appropriate to popup menu user-interface
     * elements.
     */
    @SuppressWarnings(&quot;serial&quot;)
    protected class AccessibleJPopupMenu extends AccessibleJComponent
        implements PropertyChangeListener {

        /**
         * AccessibleJPopupMenu constructor
         *
         * @since 1.5
         */
<span class="nc" id="L1218">        protected AccessibleJPopupMenu() {</span>
<span class="nc" id="L1219">            JPopupMenu.this.addPropertyChangeListener(this);</span>
<span class="nc" id="L1220">        }</span>

        /**
         * Get the role of this object.
         *
         * @return an instance of AccessibleRole describing the role of
         * the object
         */
        public AccessibleRole getAccessibleRole() {
<span class="nc" id="L1229">            return AccessibleRole.POPUP_MENU;</span>
        }

        /**
         * This method gets called when a bound property is changed.
         * @param e A &lt;code&gt;PropertyChangeEvent&lt;/code&gt; object describing
         * the event source and the property that has changed. Must not be null.
         *
         * @throws NullPointerException if the parameter is null.
         * @since 1.5
         */
        public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L1241">            String propertyName = e.getPropertyName();</span>
<span class="nc bnc" id="L1242" title="All 2 branches missed.">            if (propertyName == &quot;visible&quot;) {</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">                if (e.getOldValue() == Boolean.FALSE &amp;&amp;</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">                    e.getNewValue() == Boolean.TRUE) {</span>
<span class="nc" id="L1245">                    handlePopupIsVisibleEvent(true);</span>

<span class="nc bnc" id="L1247" title="All 2 branches missed.">                } else if (e.getOldValue() == Boolean.TRUE &amp;&amp;</span>
<span class="nc bnc" id="L1248" title="All 2 branches missed.">                           e.getNewValue() == Boolean.FALSE) {</span>
<span class="nc" id="L1249">                    handlePopupIsVisibleEvent(false);</span>
                }
            }
<span class="nc" id="L1252">        }</span>

        /*
         * Handles popup &quot;visible&quot; PropertyChangeEvent
         */
        private void handlePopupIsVisibleEvent(boolean visible) {
<span class="nc bnc" id="L1258" title="All 2 branches missed.">            if (visible) {</span>
                // notify listeners that the popup became visible
<span class="nc" id="L1260">                firePropertyChange(ACCESSIBLE_STATE_PROPERTY,</span>
                                   null, AccessibleState.VISIBLE);
                // notify listeners that a popup list item is selected
<span class="nc" id="L1263">                fireActiveDescendant();</span>
            } else {
                // notify listeners that the popup became hidden
<span class="nc" id="L1266">                firePropertyChange(ACCESSIBLE_STATE_PROPERTY,</span>
                                   AccessibleState.VISIBLE, null);
            }
<span class="nc" id="L1269">        }</span>

        /*
         * Fires AccessibleActiveDescendant PropertyChangeEvent to notify listeners
         * on the popup menu invoker that a popup list item has been selected
         */
        private void fireActiveDescendant() {
<span class="nc bnc" id="L1276" title="All 2 branches missed.">            if (JPopupMenu.this instanceof BasicComboPopup) {</span>
                // get the popup list
<span class="nc" id="L1278">                JList&lt;?&gt; popupList = ((BasicComboPopup)JPopupMenu.this).getList();</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">                if (popupList == null) {</span>
<span class="nc" id="L1280">                    return;</span>
                }

                // get the first selected item
<span class="nc" id="L1284">                AccessibleContext ac = popupList.getAccessibleContext();</span>
<span class="nc" id="L1285">                AccessibleSelection selection = ac.getAccessibleSelection();</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">                if (selection == null) {</span>
<span class="nc" id="L1287">                    return;</span>
                }
<span class="nc" id="L1289">                Accessible a = selection.getAccessibleSelection(0);</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">                if (a == null) {</span>
<span class="nc" id="L1291">                    return;</span>
                }
<span class="nc" id="L1293">                AccessibleContext selectedItem = a.getAccessibleContext();</span>

                // fire the event with the popup invoker as the source.
<span class="nc bnc" id="L1296" title="All 4 branches missed.">                if (selectedItem != null &amp;&amp; invoker != null) {</span>
<span class="nc" id="L1297">                    AccessibleContext invokerContext = invoker.getAccessibleContext();</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">                    if (invokerContext != null) {</span>
                        // Check invokerContext because Component.getAccessibleContext
                        // returns null. Classes that extend Component are responsible
                        // for returning a non-null AccessibleContext.
<span class="nc" id="L1302">                        invokerContext.firePropertyChange(</span>
                            ACCESSIBLE_ACTIVE_DESCENDANT_PROPERTY,
                            null, selectedItem);
                    }
                }
            }
<span class="nc" id="L1308">        }</span>
    } // inner class AccessibleJPopupMenu


////////////
// Serialization support.
////////////
    private void writeObject(ObjectOutputStream s) throws IOException {
<span class="nc" id="L1316">        Vector&lt;Object&gt; values = new Vector&lt;Object&gt;();</span>

<span class="nc" id="L1318">        s.defaultWriteObject();</span>
        // Save the invoker, if its Serializable.
<span class="nc bnc" id="L1320" title="All 4 branches missed.">        if(invoker != null &amp;&amp; invoker instanceof Serializable) {</span>
<span class="nc" id="L1321">            values.addElement(&quot;invoker&quot;);</span>
<span class="nc" id="L1322">            values.addElement(invoker);</span>
        }
        // Save the popup, if its Serializable.
<span class="nc bnc" id="L1325" title="All 4 branches missed.">        if(popup != null &amp;&amp; popup instanceof Serializable) {</span>
<span class="nc" id="L1326">            values.addElement(&quot;popup&quot;);</span>
<span class="nc" id="L1327">            values.addElement(popup);</span>
        }
<span class="nc" id="L1329">        s.writeObject(values);</span>

<span class="nc bnc" id="L1331" title="All 2 branches missed.">        if (getUIClassID().equals(uiClassID)) {</span>
<span class="nc" id="L1332">            byte count = JComponent.getWriteObjCounter(this);</span>
<span class="nc" id="L1333">            JComponent.setWriteObjCounter(this, --count);</span>
<span class="nc bnc" id="L1334" title="All 4 branches missed.">            if (count == 0 &amp;&amp; ui != null) {</span>
<span class="nc" id="L1335">                ui.installUI(this);</span>
            }
        }
<span class="nc" id="L1338">    }</span>

    // implements javax.swing.MenuElement
    private void readObject(ObjectInputStream s)
        throws IOException, ClassNotFoundException {
<span class="nc" id="L1343">        s.defaultReadObject();</span>

<span class="nc" id="L1345">        Vector&lt;?&gt;          values = (Vector)s.readObject();</span>
<span class="nc" id="L1346">        int             indexCounter = 0;</span>
<span class="nc" id="L1347">        int             maxCounter = values.size();</span>

<span class="nc bnc" id="L1349" title="All 2 branches missed.">        if(indexCounter &lt; maxCounter &amp;&amp; values.elementAt(indexCounter).</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">           equals(&quot;invoker&quot;)) {</span>
<span class="nc" id="L1351">            invoker = (Component)values.elementAt(++indexCounter);</span>
<span class="nc" id="L1352">            indexCounter++;</span>
        }
<span class="nc bnc" id="L1354" title="All 2 branches missed.">        if(indexCounter &lt; maxCounter &amp;&amp; values.elementAt(indexCounter).</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">           equals(&quot;popup&quot;)) {</span>
<span class="nc" id="L1356">            popup = (Popup)values.elementAt(++indexCounter);</span>
<span class="nc" id="L1357">            indexCounter++;</span>
        }
<span class="nc" id="L1359">    }</span>


    /**
     * This method is required to conform to the
     * &lt;code&gt;MenuElement&lt;/code&gt; interface, but it not implemented.
     * @see MenuElement#processMouseEvent(MouseEvent, MenuElement[], MenuSelectionManager)
     */
<span class="nc" id="L1367">    public void processMouseEvent(MouseEvent event,MenuElement path[],MenuSelectionManager manager) {}</span>

    /**
     * Processes a key event forwarded from the
     * &lt;code&gt;MenuSelectionManager&lt;/code&gt; and changes the menu selection,
     * if necessary, by using &lt;code&gt;MenuSelectionManager&lt;/code&gt;'s API.
     * &lt;p&gt;
     * Note: you do not have to forward the event to sub-components.
     * This is done automatically by the &lt;code&gt;MenuSelectionManager&lt;/code&gt;.
     *
     * @param e  a &lt;code&gt;KeyEvent&lt;/code&gt;
     * @param path the &lt;code&gt;MenuElement&lt;/code&gt; path array
     * @param manager   the &lt;code&gt;MenuSelectionManager&lt;/code&gt;
     */
    public void processKeyEvent(KeyEvent e, MenuElement path[],
                                MenuSelectionManager manager) {
<span class="nc" id="L1383">        MenuKeyEvent mke = new MenuKeyEvent(e.getComponent(), e.getID(),</span>
<span class="nc" id="L1384">                                             e.getWhen(), e.getModifiers(),</span>
<span class="nc" id="L1385">                                             e.getKeyCode(), e.getKeyChar(),</span>
                                             path, manager);
<span class="nc" id="L1387">        processMenuKeyEvent(mke);</span>

<span class="nc bnc" id="L1389" title="All 2 branches missed.">        if (mke.isConsumed())  {</span>
<span class="nc" id="L1390">            e.consume();</span>
    }
<span class="nc" id="L1392">    }</span>

    /**
     * Handles a keystroke in a menu.
     *
     * @param e  a &lt;code&gt;MenuKeyEvent&lt;/code&gt; object
     * @since 1.5
     */
    private void processMenuKeyEvent(MenuKeyEvent e) {
<span class="nc bnc" id="L1401" title="All 4 branches missed.">        switch (e.getID()) {</span>
        case KeyEvent.KEY_PRESSED:
<span class="nc" id="L1403">            fireMenuKeyPressed(e); break;</span>
        case KeyEvent.KEY_RELEASED:
<span class="nc" id="L1405">            fireMenuKeyReleased(e); break;</span>
        case KeyEvent.KEY_TYPED:
<span class="nc" id="L1407">            fireMenuKeyTyped(e); break;</span>
        default:
            break;
        }
<span class="nc" id="L1411">    }</span>

    /**
     * Notifies all listeners that have registered interest for
     * notification on this event type.
     *
     * @param event a &lt;code&gt;MenuKeyEvent&lt;/code&gt;
     * @see EventListenerList
     */
    private void fireMenuKeyPressed(MenuKeyEvent event) {
<span class="nc" id="L1421">        Object[] listeners = listenerList.getListenerList();</span>
<span class="nc bnc" id="L1422" title="All 2 branches missed.">        for (int i = listeners.length-2; i&gt;=0; i-=2) {</span>
<span class="nc bnc" id="L1423" title="All 2 branches missed.">            if (listeners[i]==MenuKeyListener.class) {</span>
<span class="nc" id="L1424">                ((MenuKeyListener)listeners[i+1]).menuKeyPressed(event);</span>
            }
        }
<span class="nc" id="L1427">    }</span>

    /**
     * Notifies all listeners that have registered interest for
     * notification on this event type.
     *
     * @param event a &lt;code&gt;MenuKeyEvent&lt;/code&gt;
     * @see EventListenerList
     */
    private void fireMenuKeyReleased(MenuKeyEvent event) {
<span class="nc" id="L1437">        Object[] listeners = listenerList.getListenerList();</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">        for (int i = listeners.length-2; i&gt;=0; i-=2) {</span>
<span class="nc bnc" id="L1439" title="All 2 branches missed.">            if (listeners[i]==MenuKeyListener.class) {</span>
<span class="nc" id="L1440">                ((MenuKeyListener)listeners[i+1]).menuKeyReleased(event);</span>
            }
        }
<span class="nc" id="L1443">    }</span>

    /**
     * Notifies all listeners that have registered interest for
     * notification on this event type.
     *
     * @param event a &lt;code&gt;MenuKeyEvent&lt;/code&gt;
     * @see EventListenerList
     */
    private void fireMenuKeyTyped(MenuKeyEvent event) {
<span class="nc" id="L1453">        Object[] listeners = listenerList.getListenerList();</span>
<span class="nc bnc" id="L1454" title="All 2 branches missed.">        for (int i = listeners.length-2; i&gt;=0; i-=2) {</span>
<span class="nc bnc" id="L1455" title="All 2 branches missed.">            if (listeners[i]==MenuKeyListener.class) {</span>
<span class="nc" id="L1456">                ((MenuKeyListener)listeners[i+1]).menuKeyTyped(event);</span>
            }
        }
<span class="nc" id="L1459">    }</span>

    /**
     * Messaged when the menubar selection changes to activate or
     * deactivate this menu. This implements the
     * &lt;code&gt;javax.swing.MenuElement&lt;/code&gt; interface.
     * Overrides &lt;code&gt;MenuElement.menuSelectionChanged&lt;/code&gt;.
     *
     * @param isIncluded  true if this menu is active, false if
     *        it is not
     * @see MenuElement#menuSelectionChanged(boolean)
     */
    public void menuSelectionChanged(boolean isIncluded) {
        if (DEBUG) {
            System.out.println(&quot;In JPopupMenu.menuSelectionChanged &quot; + isIncluded);
        }
<span class="nc bnc" id="L1475" title="All 2 branches missed.">        if(invoker instanceof JMenu) {</span>
<span class="nc" id="L1476">            JMenu m = (JMenu) invoker;</span>
<span class="nc bnc" id="L1477" title="All 2 branches missed.">            if(isIncluded)</span>
<span class="nc" id="L1478">                m.setPopupMenuVisible(true);</span>
            else
<span class="nc" id="L1480">                m.setPopupMenuVisible(false);</span>
        }
<span class="nc bnc" id="L1482" title="All 4 branches missed.">        if (isPopupMenu() &amp;&amp; !isIncluded)</span>
<span class="nc" id="L1483">          setVisible(false);</span>
<span class="nc" id="L1484">    }</span>

    /**
     * Returns an array of &lt;code&gt;MenuElement&lt;/code&gt;s containing the submenu
     * for this menu component.  It will only return items conforming to
     * the &lt;code&gt;JMenuElement&lt;/code&gt; interface.
     * If popup menu is &lt;code&gt;null&lt;/code&gt; returns
     * an empty array.  This method is required to conform to the
     * &lt;code&gt;MenuElement&lt;/code&gt; interface.
     *
     * @return an array of &lt;code&gt;MenuElement&lt;/code&gt; objects
     * @see MenuElement#getSubElements
     */
    public MenuElement[] getSubElements() {
        MenuElement result[];
<span class="nc" id="L1499">        Vector&lt;MenuElement&gt; tmp = new Vector&lt;MenuElement&gt;();</span>
<span class="nc" id="L1500">        int c = getComponentCount();</span>
        int i;
        Component m;

<span class="nc bnc" id="L1504" title="All 2 branches missed.">        for(i=0 ; i &lt; c ; i++) {</span>
<span class="nc" id="L1505">            m = getComponent(i);</span>
<span class="nc bnc" id="L1506" title="All 2 branches missed.">            if(m instanceof MenuElement)</span>
<span class="nc" id="L1507">                tmp.addElement((MenuElement) m);</span>
        }

<span class="nc" id="L1510">        result = new MenuElement[tmp.size()];</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">        for(i=0,c=tmp.size() ; i &lt; c ; i++)</span>
<span class="nc" id="L1512">            result[i] = tmp.elementAt(i);</span>
<span class="nc" id="L1513">        return result;</span>
    }

    /**
     * Returns this &lt;code&gt;JPopupMenu&lt;/code&gt; component.
     * @return this &lt;code&gt;JPopupMenu&lt;/code&gt; object
     * @see MenuElement#getComponent
     */
    public Component getComponent() {
<span class="nc" id="L1522">        return this;</span>
    }


    /**
     * A popup menu-specific separator.
     */
    @SuppressWarnings(&quot;serial&quot;)
    static public class Separator extends JSeparator
    {
        public Separator( )
        {
<span class="nc" id="L1534">            super( JSeparator.HORIZONTAL );</span>
<span class="nc" id="L1535">        }</span>

        /**
         * Returns the name of the L&amp;amp;F class that renders this component.
         *
         * @return the string &quot;PopupMenuSeparatorUI&quot;
         * @see JComponent#getUIClassID
         * @see UIDefaults#getUI
         */
        public String getUIClassID()
        {
<span class="nc" id="L1546">            return &quot;PopupMenuSeparatorUI&quot;;</span>

        }
    }

    /**
     * Returns true if the &lt;code&gt;MouseEvent&lt;/code&gt; is considered a popup trigger
     * by the &lt;code&gt;JPopupMenu&lt;/code&gt;'s currently installed UI.
     *
     * @return true if the mouse event is a popup trigger
     * @since 1.3
     */
    public boolean isPopupTrigger(MouseEvent e) {
<span class="nc" id="L1559">        return getUI().isPopupTrigger(e);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>