<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>MLetParser.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">javax.management.loading</a> &gt; <span class="el_source">MLetParser.java</span></div><h1>MLetParser.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.management.loading;

import static com.sun.jmx.defaults.JmxProperties.MLET_LOGGER;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.Reader;
import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Level;

/**
 * This class is used for parsing URLs.
 *
 * @since 1.5
 */
class MLetParser {

/*
  * ------------------------------------------
  *   PRIVATE VARIABLES
  * ------------------------------------------
  */

    /**
     * The current character
     */
    private int c;

    /**
     * Tag to parse.
     */
<span class="nc" id="L64">    private static String tag = &quot;mlet&quot;;</span>


  /*
  * ------------------------------------------
  *   CONSTRUCTORS
  * ------------------------------------------
  */

    /**
     * Create an MLet parser object
     */
<span class="nc" id="L76">    public MLetParser() {</span>
<span class="nc" id="L77">    }</span>

    /*
     * ------------------------------------------
     *   PUBLIC METHODS
     * ------------------------------------------
     */

    /**
     * Scan spaces.
     */
    public void skipSpace(Reader in) throws IOException {
<span class="nc bnc" id="L89" title="All 10 branches missed.">        while ((c &gt;= 0) &amp;&amp; ((c == ' ') || (c == '\t') || (c == '\n') || (c == '\r'))) {</span>
<span class="nc" id="L90">            c = in.read();</span>
        }
<span class="nc" id="L92">    }</span>

    /**
     * Scan identifier
     */
    public String scanIdentifier(Reader in) throws IOException {
<span class="nc" id="L98">        StringBuilder buf = new StringBuilder();</span>
        while (true) {
<span class="nc bnc" id="L100" title="All 14 branches missed.">            if (((c &gt;= 'a') &amp;&amp; (c &lt;= 'z')) ||</span>
                ((c &gt;= 'A') &amp;&amp; (c &lt;= 'Z')) ||
                ((c &gt;= '0') &amp;&amp; (c &lt;= '9')) || (c == '_')) {
<span class="nc" id="L103">                buf.append((char)c);</span>
<span class="nc" id="L104">                c = in.read();</span>
            } else {
<span class="nc" id="L106">                return buf.toString();</span>
            }
        }
    }

    /**
     * Scan tag
     */
    public Map&lt;String,String&gt; scanTag(Reader in) throws IOException {
<span class="nc" id="L115">        Map&lt;String,String&gt; atts = new HashMap&lt;String,String&gt;();</span>
<span class="nc" id="L116">        skipSpace(in);</span>
<span class="nc bnc" id="L117" title="All 4 branches missed.">        while (c &gt;= 0 &amp;&amp; c != '&gt;') {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (c == '&lt;')</span>
<span class="nc" id="L119">                throw new IOException(&quot;Missing '&gt;' in tag&quot;);</span>
<span class="nc" id="L120">            String att = scanIdentifier(in);</span>
<span class="nc" id="L121">            String val = &quot;&quot;;</span>
<span class="nc" id="L122">            skipSpace(in);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            if (c == '=') {</span>
<span class="nc" id="L124">                int quote = -1;</span>
<span class="nc" id="L125">                c = in.read();</span>
<span class="nc" id="L126">                skipSpace(in);</span>
<span class="nc bnc" id="L127" title="All 4 branches missed.">                if ((c == '\'') || (c == '\&quot;')) {</span>
<span class="nc" id="L128">                    quote = c;</span>
<span class="nc" id="L129">                    c = in.read();</span>
                }
<span class="nc" id="L131">                StringBuilder buf = new StringBuilder();</span>
<span class="nc bnc" id="L132" title="All 18 branches missed.">                while ((c &gt; 0) &amp;&amp;</span>
                       (((quote &lt; 0) &amp;&amp; (c != ' ') &amp;&amp; (c != '\t') &amp;&amp;
                         (c != '\n') &amp;&amp; (c != '\r') &amp;&amp; (c != '&gt;'))
                        || ((quote &gt;= 0) &amp;&amp; (c != quote)))) {
<span class="nc" id="L136">                    buf.append((char)c);</span>
<span class="nc" id="L137">                    c = in.read();</span>
                }
<span class="nc bnc" id="L139" title="All 2 branches missed.">                if (c == quote) {</span>
<span class="nc" id="L140">                    c = in.read();</span>
                }
<span class="nc" id="L142">                skipSpace(in);</span>
<span class="nc" id="L143">                val = buf.toString();</span>
            }
<span class="nc" id="L145">            atts.put(att.toLowerCase(), val);</span>
<span class="nc" id="L146">            skipSpace(in);</span>
<span class="nc" id="L147">        }</span>
<span class="nc" id="L148">        return atts;</span>
    }

    /**
     * Scan an html file for {@literal &lt;mlet&gt;} tags.
     */
    public List&lt;MLetContent&gt; parse(URL url) throws IOException {
<span class="nc" id="L155">        String mth = &quot;parse&quot;;</span>
        // Warning Messages
<span class="nc" id="L157">        String requiresTypeWarning = &quot;&lt;arg type=... value=...&gt; tag requires type parameter.&quot;;</span>
<span class="nc" id="L158">        String requiresValueWarning = &quot;&lt;arg type=... value=...&gt; tag requires value parameter.&quot;;</span>
<span class="nc" id="L159">        String paramOutsideWarning = &quot;&lt;arg&gt; tag outside &lt;mlet&gt; ... &lt;/mlet&gt;.&quot;;</span>
<span class="nc" id="L160">        String requiresCodeWarning = &quot;&lt;mlet&gt; tag requires either code or object parameter.&quot;;</span>
<span class="nc" id="L161">        String requiresJarsWarning = &quot;&lt;mlet&gt; tag requires archive parameter.&quot;;</span>

        URLConnection conn;

<span class="nc" id="L165">        conn = url.openConnection();</span>
<span class="nc" id="L166">        Reader in = new BufferedReader(new InputStreamReader(conn.getInputStream(),</span>
                                                             &quot;UTF-8&quot;));

        // The original URL may have been redirected - this
        // sets it to whatever URL/codebase we ended up getting
        //
<span class="nc" id="L172">        url = conn.getURL();</span>

<span class="nc" id="L174">        List&lt;MLetContent&gt; mlets = new ArrayList&lt;MLetContent&gt;();</span>
<span class="nc" id="L175">        Map&lt;String,String&gt; atts = null;</span>

<span class="nc" id="L177">        List&lt;String&gt; types = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L178">        List&lt;String&gt; values = new ArrayList&lt;String&gt;();</span>

        // debug(&quot;parse&quot;,&quot;*** Parsing &quot; + url );
        while(true) {
<span class="nc" id="L182">            c = in.read();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (c == -1)</span>
<span class="nc" id="L184">                break;</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (c == '&lt;') {</span>
<span class="nc" id="L186">                c = in.read();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                if (c == '/') {</span>
<span class="nc" id="L188">                    c = in.read();</span>
<span class="nc" id="L189">                    String nm = scanIdentifier(in);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                    if (c != '&gt;')</span>
<span class="nc" id="L191">                        throw new IOException(&quot;Missing '&gt;' in tag&quot;);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                    if (nm.equalsIgnoreCase(tag)) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                        if (atts != null) {</span>
<span class="nc" id="L194">                            mlets.add(new MLetContent(url, atts, types, values));</span>
                        }
<span class="nc" id="L196">                        atts = null;</span>
<span class="nc" id="L197">                        types = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L198">                        values = new ArrayList&lt;String&gt;();</span>
                    }
<span class="nc" id="L200">                } else {</span>
<span class="nc" id="L201">                    String nm = scanIdentifier(in);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                    if (nm.equalsIgnoreCase(&quot;arg&quot;)) {</span>
<span class="nc" id="L203">                        Map&lt;String,String&gt; t = scanTag(in);</span>
<span class="nc" id="L204">                        String att = t.get(&quot;type&quot;);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                        if (att == null) {</span>
<span class="nc" id="L206">                            MLET_LOGGER.logp(Level.FINER,</span>
<span class="nc" id="L207">                                    MLetParser.class.getName(),</span>
                                    mth, requiresTypeWarning);
<span class="nc" id="L209">                            throw new IOException(requiresTypeWarning);</span>
                        } else {
<span class="nc bnc" id="L211" title="All 2 branches missed.">                            if (atts != null) {</span>
<span class="nc" id="L212">                                types.add(att);</span>
                            } else {
<span class="nc" id="L214">                                MLET_LOGGER.logp(Level.FINER,</span>
<span class="nc" id="L215">                                        MLetParser.class.getName(),</span>
                                        mth, paramOutsideWarning);
<span class="nc" id="L217">                                throw new IOException(paramOutsideWarning);</span>
                            }
                        }
<span class="nc" id="L220">                        String val = t.get(&quot;value&quot;);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                        if (val == null) {</span>
<span class="nc" id="L222">                            MLET_LOGGER.logp(Level.FINER,</span>
<span class="nc" id="L223">                                    MLetParser.class.getName(),</span>
                                    mth, requiresValueWarning);
<span class="nc" id="L225">                            throw new IOException(requiresValueWarning);</span>
                        } else {
<span class="nc bnc" id="L227" title="All 2 branches missed.">                            if (atts != null) {</span>
<span class="nc" id="L228">                                values.add(val);</span>
                            } else {
<span class="nc" id="L230">                                MLET_LOGGER.logp(Level.FINER,</span>
<span class="nc" id="L231">                                        MLetParser.class.getName(),</span>
                                        mth, paramOutsideWarning);
<span class="nc" id="L233">                                throw new IOException(paramOutsideWarning);</span>
                            }
                        }
<span class="nc" id="L236">                    } else {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                        if (nm.equalsIgnoreCase(tag)) {</span>
<span class="nc" id="L238">                            atts = scanTag(in);</span>
<span class="nc bnc" id="L239" title="All 4 branches missed.">                            if (atts.get(&quot;code&quot;) == null &amp;&amp; atts.get(&quot;object&quot;) == null) {</span>
<span class="nc" id="L240">                                MLET_LOGGER.logp(Level.FINER,</span>
<span class="nc" id="L241">                                        MLetParser.class.getName(),</span>
                                        mth, requiresCodeWarning);
<span class="nc" id="L243">                                throw new IOException(requiresCodeWarning);</span>
                            }
<span class="nc bnc" id="L245" title="All 2 branches missed.">                            if (atts.get(&quot;archive&quot;) == null) {</span>
<span class="nc" id="L246">                                MLET_LOGGER.logp(Level.FINER,</span>
<span class="nc" id="L247">                                        MLetParser.class.getName(),</span>
                                        mth, requiresJarsWarning);
<span class="nc" id="L249">                                throw new IOException(requiresJarsWarning);</span>
                            }
                        }
                    }
<span class="nc" id="L253">                }</span>
            }
        }
<span class="nc" id="L256">        in.close();</span>
<span class="nc" id="L257">        return mlets;</span>
    }

    /**
     * Parse the document pointed by the URL urlname
     */
    public List&lt;MLetContent&gt; parseURL(String urlname) throws IOException {
        // Parse the document
        //
        URL url;
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (urlname.indexOf(':') &lt;= 1) {</span>
<span class="nc" id="L268">            String userDir = System.getProperty(&quot;user.dir&quot;);</span>
            String prot;
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (userDir.charAt(0) == '/' ||</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                userDir.charAt(0) == File.separatorChar) {</span>
<span class="nc" id="L272">                prot = &quot;file:&quot;;</span>
            } else {
<span class="nc" id="L274">                prot = &quot;file:/&quot;;</span>
            }
<span class="nc" id="L276">            url =</span>
<span class="nc" id="L277">                new URL(prot + userDir.replace(File.separatorChar, '/') + &quot;/&quot;);</span>
<span class="nc" id="L278">            url = new URL(url, urlname);</span>
<span class="nc" id="L279">        } else {</span>
<span class="nc" id="L280">            url = new URL(urlname);</span>
        }
        // Return list of parsed MLets
        //
<span class="nc" id="L284">        return parse(url);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>