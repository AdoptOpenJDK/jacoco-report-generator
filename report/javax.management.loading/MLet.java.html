<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MLet.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">javax.management.loading</a> &gt; <span class="el_source">MLet.java</span></div><h1>MLet.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.management.loading;

// Java import
import com.sun.jmx.defaults.JmxProperties;

import com.sun.jmx.defaults.ServiceName;

import com.sun.jmx.remote.util.EnvHelp;

import java.io.Externalizable;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.ObjectInput;
import java.io.ObjectInputStream;
import java.io.ObjectOutput;
import java.lang.reflect.Constructor;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLStreamHandlerFactory;
import java.nio.file.Files;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.logging.Level;
import java.util.Map;
import java.util.Set;
import java.util.StringTokenizer;

import javax.management.InstanceAlreadyExistsException;
import javax.management.InstanceNotFoundException;
import javax.management.MBeanException;
import javax.management.MBeanRegistration;
import javax.management.MBeanRegistrationException;
import javax.management.MBeanServer;
import javax.management.NotCompliantMBeanException;
import javax.management.ObjectInstance;
import javax.management.ObjectName;
import javax.management.ReflectionException;

import static com.sun.jmx.defaults.JmxProperties.MLET_LIB_DIR;
import static com.sun.jmx.defaults.JmxProperties.MLET_LOGGER;
import com.sun.jmx.defaults.ServiceName;
import javax.management.ServiceNotFoundException;

/**
 * Allows you to instantiate and register one or several MBeans in the MBean server
 * coming from a remote URL. M-let is a shortcut for management applet. The m-let service does this
 * by loading an m-let text file, which specifies information on the MBeans to be obtained.
 * The information on each MBean is specified in a single instance of a tag, called the MLET tag.
 * The location of the m-let text file is specified by a URL.
 * &lt;p&gt;
 * The &lt;CODE&gt;MLET&lt;/CODE&gt; tag has the following syntax:
 * &lt;p&gt;
 * &amp;lt;&lt;CODE&gt;MLET&lt;/CODE&gt;&lt;BR&gt;
 *      &lt;CODE&gt;CODE = &lt;/CODE&gt;&lt;VAR&gt;class&lt;/VAR&gt;&lt;CODE&gt; | OBJECT = &lt;/CODE&gt;&lt;VAR&gt;serfile&lt;/VAR&gt;&lt;BR&gt;
 *      &lt;CODE&gt;ARCHIVE = &amp;quot;&lt;/CODE&gt;&lt;VAR&gt;archiveList&lt;/VAR&gt;&lt;CODE&gt;&amp;quot;&lt;/CODE&gt;&lt;BR&gt;
 *      &lt;CODE&gt;[CODEBASE = &lt;/CODE&gt;&lt;VAR&gt;codebaseURL&lt;/VAR&gt;&lt;CODE&gt;]&lt;/CODE&gt;&lt;BR&gt;
 *      &lt;CODE&gt;[NAME = &lt;/CODE&gt;&lt;VAR&gt;mbeanname&lt;/VAR&gt;&lt;CODE&gt;]&lt;/CODE&gt;&lt;BR&gt;
 *      &lt;CODE&gt;[VERSION = &lt;/CODE&gt;&lt;VAR&gt;version&lt;/VAR&gt;&lt;CODE&gt;]&lt;/CODE&gt;&lt;BR&gt;
 * &amp;gt;&lt;BR&gt;
 *      &lt;CODE&gt;[&lt;/CODE&gt;&lt;VAR&gt;arglist&lt;/VAR&gt;&lt;CODE&gt;]&lt;/CODE&gt;&lt;BR&gt;
 * &amp;lt;&lt;CODE&gt;/MLET&lt;/CODE&gt;&amp;gt;
 * &lt;p&gt;
 * where:
 * &lt;DL&gt;
 * &lt;DT&gt;&lt;CODE&gt;CODE = &lt;/CODE&gt;&lt;VAR&gt;class&lt;/VAR&gt;&lt;/DT&gt;
 * &lt;DD&gt;
 * This attribute specifies the full Java class name, including package name, of the MBean to be obtained.
 * The compiled &lt;CODE&gt;.class&lt;/CODE&gt; file of the MBean must be contained in one of the &lt;CODE&gt;.jar&lt;/CODE&gt; files specified by the &lt;CODE&gt;ARCHIVE&lt;/CODE&gt;
 * attribute. Either &lt;CODE&gt;CODE&lt;/CODE&gt; or &lt;CODE&gt;OBJECT&lt;/CODE&gt; must be present.
 * &lt;/DD&gt;
 * &lt;DT&gt;&lt;CODE&gt;OBJECT = &lt;/CODE&gt;&lt;VAR&gt;serfile&lt;/VAR&gt;&lt;/DT&gt;
 * &lt;DD&gt;
 * This attribute specifies the &lt;CODE&gt;.ser&lt;/CODE&gt; file that contains a serialized representation of the MBean to be obtained.
 * This file must be contained in one of the &lt;CODE&gt;.jar&lt;/CODE&gt; files specified by the &lt;CODE&gt;ARCHIVE&lt;/CODE&gt; attribute. If the &lt;CODE&gt;.jar&lt;/CODE&gt; file contains a directory hierarchy, specify the path of the file within this hierarchy. Otherwise  a match will not be found. Either &lt;CODE&gt;CODE&lt;/CODE&gt; or &lt;CODE&gt;OBJECT&lt;/CODE&gt; must be present.
 * &lt;/DD&gt;
 * &lt;DT&gt;&lt;CODE&gt;ARCHIVE = &amp;quot;&lt;/CODE&gt;&lt;VAR&gt;archiveList&lt;/VAR&gt;&lt;CODE&gt;&amp;quot;&lt;/CODE&gt;&lt;/DT&gt;
 * &lt;DD&gt;
 * This mandatory attribute specifies one or more &lt;CODE&gt;.jar&lt;/CODE&gt; files
 * containing MBeans or other resources used by
 * the MBean to be obtained. One of the &lt;CODE&gt;.jar&lt;/CODE&gt; files must contain the file specified by the &lt;CODE&gt;CODE&lt;/CODE&gt; or &lt;CODE&gt;OBJECT&lt;/CODE&gt; attribute.
 * If archivelist contains more than one file:
 * &lt;UL&gt;
 * &lt;LI&gt;Each file must be separated from the one that follows it by a comma (,).
 * &lt;LI&gt;&lt;VAR&gt;archivelist&lt;/VAR&gt; must be enclosed in double quote marks.
 * &lt;/UL&gt;
 * All &lt;CODE&gt;.jar&lt;/CODE&gt; files in &lt;VAR&gt;archivelist&lt;/VAR&gt; must be stored in the directory specified by the code base URL.
 * &lt;/DD&gt;
 * &lt;DT&gt;&lt;CODE&gt;CODEBASE = &lt;/CODE&gt;&lt;VAR&gt;codebaseURL&lt;/VAR&gt;&lt;/DT&gt;
 * &lt;DD&gt;
 * This optional attribute specifies the code base URL of the MBean to be obtained. It identifies the directory that contains
 * the &lt;CODE&gt;.jar&lt;/CODE&gt; files specified by the &lt;CODE&gt;ARCHIVE&lt;/CODE&gt; attribute. Specify this attribute only if the &lt;CODE&gt;.jar&lt;/CODE&gt; files are not in the same
 * directory as the m-let text file. If this attribute is not specified, the base URL of the m-let text file is used.
 * &lt;/DD&gt;
 * &lt;DT&gt;&lt;CODE&gt;NAME = &lt;/CODE&gt;&lt;VAR&gt;mbeanname&lt;/VAR&gt;&lt;/DT&gt;
 * &lt;DD&gt;
 * This optional attribute specifies the object name to be assigned to the
 * MBean instance when the m-let service registers it. If
 * &lt;VAR&gt;mbeanname&lt;/VAR&gt; starts with the colon character (:), the domain
 * part of the object name is the default domain of the MBean server,
 * as returned by {@link javax.management.MBeanServer#getDefaultDomain()}.
 * &lt;/DD&gt;
 * &lt;DT&gt;&lt;CODE&gt;VERSION = &lt;/CODE&gt;&lt;VAR&gt;version&lt;/VAR&gt;&lt;/DT&gt;
 * &lt;DD&gt;
 * This optional attribute specifies the version number of the MBean and
 * associated &lt;CODE&gt;.jar&lt;/CODE&gt; files to be obtained. This version number can
 * be used to specify that the &lt;CODE&gt;.jar&lt;/CODE&gt; files are loaded from the
 * server to update those stored locally in the cache the next time the m-let
 * text file is loaded. &lt;VAR&gt;version&lt;/VAR&gt; must be a series of non-negative
 * decimal integers each separated by a period from the one that precedes it.
 * &lt;/DD&gt;
 * &lt;DT&gt;&lt;VAR&gt;arglist&lt;/VAR&gt;&lt;/DT&gt;
 * &lt;DD&gt;
 * This optional attribute specifies a list of one or more parameters for the
 * MBean to be instantiated. This list describes the parameters to be passed the MBean's constructor.
 * Use the following syntax to specify each item in
 * &lt;VAR&gt;arglist&lt;/VAR&gt;:
 * &lt;DL&gt;
 * &lt;DT&gt;&amp;lt;&lt;CODE&gt;ARG TYPE=&lt;/CODE&gt;&lt;VAR&gt;argumentType&lt;/VAR&gt; &lt;CODE&gt;VALUE=&lt;/CODE&gt;&lt;VAR&gt;value&lt;/VAR&gt;&amp;gt;&lt;/DT&gt;
 * &lt;DD&gt;where:
 * &lt;UL&gt;
 * &lt;LI&gt;&lt;VAR&gt;argumentType&lt;/VAR&gt; is the type of the argument that will be passed as parameter to the MBean's constructor.&lt;/UL&gt;
 * &lt;/DD&gt;
 * &lt;/DL&gt;
 * &lt;P&gt;The arguments' type in the argument list should be a Java primitive type or a Java basic type
 * (&lt;CODE&gt;java.lang.Boolean, java.lang.Byte, java.lang.Short, java.lang.Long, java.lang.Integer, java.lang.Float, java.lang.Double, java.lang.String&lt;/CODE&gt;).
 * &lt;/DD&gt;
 * &lt;/DL&gt;
 *
 * When an m-let text file is loaded, an
 * instance of each MBean specified in the file is created and registered.
 * &lt;P&gt;
 * The m-let service extends the &lt;CODE&gt;java.net.URLClassLoader&lt;/CODE&gt; and can be used to load remote classes
 * and jar files in the VM of the agent.
 * &lt;p&gt;&lt;STRONG&gt;Note - &lt;/STRONG&gt; The &lt;CODE&gt;MLet&lt;/CODE&gt; class loader uses the {@link javax.management.MBeanServerFactory#getClassLoaderRepository(javax.management.MBeanServer)}
 * to load classes that could not be found in the loaded jar files.
 *
 * @since 1.5
 */
public class MLet extends java.net.URLClassLoader
     implements MLetMBean, MBeanRegistration, Externalizable {

     private static final long serialVersionUID = 3636148327800330130L;

     /*
     * ------------------------------------------
     *   PRIVATE VARIABLES
     * ------------------------------------------
     */

     /**
      * The reference to the MBean server.
      * @serial
      */
<span class="nc" id="L186">     private MBeanServer server = null;</span>


     /**
      * The list of instances of the &lt;CODE&gt;MLetContent&lt;/CODE&gt;
      * class found at the specified URL.
      * @serial
      */
<span class="nc" id="L194">     private List&lt;MLetContent&gt; mletList = new ArrayList&lt;MLetContent&gt;();</span>


     /**
      * The directory used for storing libraries locally before they are loaded.
      */
     private String libraryDirectory;


     /**
      * The object name of the MLet Service.
      * @serial
      */
<span class="nc" id="L207">     private ObjectName mletObjectName = null;</span>

     /**
      * The URLs of the MLet Service.
      * @serial
      */
<span class="nc" id="L213">     private URL[] myUrls = null;</span>

     /**
      * What ClassLoaderRepository, if any, to use if this MLet
      * doesn't find an asked-for class.
      */
     private transient ClassLoaderRepository currentClr;

     /**
      * True if we should consult the {@link ClassLoaderRepository}
      * when we do not find a class ourselves.
      */
     private transient boolean delegateToCLR;

     /**
      * objects maps from primitive classes to primitive object classes.
      */
<span class="nc" id="L230">     private Map&lt;String,Class&lt;?&gt;&gt; primitiveClasses =</span>
         new HashMap&lt;String,Class&lt;?&gt;&gt;(8) ;
     {
<span class="nc" id="L233">         primitiveClasses.put(Boolean.TYPE.toString(), Boolean.class);</span>
<span class="nc" id="L234">         primitiveClasses.put(Character.TYPE.toString(), Character.class);</span>
<span class="nc" id="L235">         primitiveClasses.put(Byte.TYPE.toString(), Byte.class);</span>
<span class="nc" id="L236">         primitiveClasses.put(Short.TYPE.toString(), Short.class);</span>
<span class="nc" id="L237">         primitiveClasses.put(Integer.TYPE.toString(), Integer.class);</span>
<span class="nc" id="L238">         primitiveClasses.put(Long.TYPE.toString(), Long.class);</span>
<span class="nc" id="L239">         primitiveClasses.put(Float.TYPE.toString(), Float.class);</span>
<span class="nc" id="L240">         primitiveClasses.put(Double.TYPE.toString(), Double.class);</span>

     }


     /*
      * ------------------------------------------
      *  CONSTRUCTORS
      * ------------------------------------------
      */

     /*
      * The constructor stuff would be considerably simplified if our
      * parent, URLClassLoader, specified that its one- and
      * two-argument constructors were equivalent to its
      * three-argument constructor with trailing null arguments.  But
      * it doesn't, which prevents us from having all the constructors
      * but one call this(...args...).
      */

     /**
      * Constructs a new MLet using the default delegation parent ClassLoader.
      */
     public MLet() {
<span class="nc" id="L264">         this(new URL[0]);</span>
<span class="nc" id="L265">     }</span>

     /**
      * Constructs a new MLet for the specified URLs using the default
      * delegation parent ClassLoader.  The URLs will be searched in
      * the order specified for classes and resources after first
      * searching in the parent class loader.
      *
      * @param  urls  The URLs from which to load classes and resources.
      *
      */
     public MLet(URL[] urls) {
<span class="nc" id="L277">         this(urls, true);</span>
<span class="nc" id="L278">     }</span>

     /**
      * Constructs a new MLet for the given URLs. The URLs will be
      * searched in the order specified for classes and resources
      * after first searching in the specified parent class loader.
      * The parent argument will be used as the parent class loader
      * for delegation.
      *
      * @param  urls  The URLs from which to load classes and resources.
      * @param  parent The parent class loader for delegation.
      *
      */
     public MLet(URL[] urls, ClassLoader parent) {
<span class="nc" id="L292">         this(urls, parent, true);</span>
<span class="nc" id="L293">     }</span>

     /**
      * Constructs a new MLet for the specified URLs, parent class
      * loader, and URLStreamHandlerFactory. The parent argument will
      * be used as the parent class loader for delegation. The factory
      * argument will be used as the stream handler factory to obtain
      * protocol handlers when creating new URLs.
      *
      * @param  urls  The URLs from which to load classes and resources.
      * @param  parent The parent class loader for delegation.
      * @param  factory  The URLStreamHandlerFactory to use when creating URLs.
      *
      */
     public MLet(URL[] urls,
                 ClassLoader parent,
                 URLStreamHandlerFactory factory) {
<span class="nc" id="L310">         this(urls, parent, factory, true);</span>
<span class="nc" id="L311">     }</span>

     /**
      * Constructs a new MLet for the specified URLs using the default
      * delegation parent ClassLoader.  The URLs will be searched in
      * the order specified for classes and resources after first
      * searching in the parent class loader.
      *
      * @param  urls  The URLs from which to load classes and resources.
      * @param  delegateToCLR  True if, when a class is not found in
      * either the parent ClassLoader or the URLs, the MLet should delegate
      * to its containing MBeanServer's {@link ClassLoaderRepository}.
      *
      */
     public MLet(URL[] urls, boolean delegateToCLR) {
<span class="nc" id="L326">         super(urls);</span>
<span class="nc" id="L327">         init(delegateToCLR);</span>
<span class="nc" id="L328">     }</span>

     /**
      * Constructs a new MLet for the given URLs. The URLs will be
      * searched in the order specified for classes and resources
      * after first searching in the specified parent class loader.
      * The parent argument will be used as the parent class loader
      * for delegation.
      *
      * @param  urls  The URLs from which to load classes and resources.
      * @param  parent The parent class loader for delegation.
      * @param  delegateToCLR  True if, when a class is not found in
      * either the parent ClassLoader or the URLs, the MLet should delegate
      * to its containing MBeanServer's {@link ClassLoaderRepository}.
      *
      */
     public MLet(URL[] urls, ClassLoader parent, boolean delegateToCLR) {
<span class="nc" id="L345">         super(urls, parent);</span>
<span class="nc" id="L346">         init(delegateToCLR);</span>
<span class="nc" id="L347">     }</span>

     /**
      * Constructs a new MLet for the specified URLs, parent class
      * loader, and URLStreamHandlerFactory. The parent argument will
      * be used as the parent class loader for delegation. The factory
      * argument will be used as the stream handler factory to obtain
      * protocol handlers when creating new URLs.
      *
      * @param  urls  The URLs from which to load classes and resources.
      * @param  parent The parent class loader for delegation.
      * @param  factory  The URLStreamHandlerFactory to use when creating URLs.
      * @param  delegateToCLR  True if, when a class is not found in
      * either the parent ClassLoader or the URLs, the MLet should delegate
      * to its containing MBeanServer's {@link ClassLoaderRepository}.
      *
      */
     public MLet(URL[] urls,
                 ClassLoader parent,
                 URLStreamHandlerFactory factory,
                 boolean delegateToCLR) {
<span class="nc" id="L368">         super(urls, parent, factory);</span>
<span class="nc" id="L369">         init(delegateToCLR);</span>
<span class="nc" id="L370">     }</span>

     private void init(boolean delegateToCLR) {
<span class="nc" id="L373">         this.delegateToCLR = delegateToCLR;</span>

         try {
<span class="nc" id="L376">             libraryDirectory = System.getProperty(MLET_LIB_DIR);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">             if (libraryDirectory == null)</span>
<span class="nc" id="L378">                 libraryDirectory = getTmpDir();</span>
<span class="nc" id="L379">         } catch (SecurityException e) {</span>
             // OK : We don't do AccessController.doPrivileged, but we don't
             //      stop the user from creating an MLet just because they
             //      can't read the MLET_LIB_DIR or java.io.tmpdir properties
             //      either.
<span class="nc" id="L384">         }</span>
<span class="nc" id="L385">     }</span>


     /*
      * ------------------------------------------
      *  PUBLIC METHODS
      * ------------------------------------------
      */


     /**
      * Appends the specified URL to the list of URLs to search for classes and
      * resources.
      */
     public void addURL(URL url) {
<span class="nc bnc" id="L400" title="All 2 branches missed.">         if (!Arrays.asList(getURLs()).contains(url))</span>
<span class="nc" id="L401">             super.addURL(url);</span>
<span class="nc" id="L402">     }</span>

     /**
      * Appends the specified URL to the list of URLs to search for classes and
      * resources.
      * @exception ServiceNotFoundException The specified URL is malformed.
      */
     public void addURL(String url) throws ServiceNotFoundException {
         try {
<span class="nc" id="L411">             URL ur = new URL(url);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">             if (!Arrays.asList(getURLs()).contains(ur))</span>
<span class="nc" id="L413">                 super.addURL(ur);</span>
<span class="nc" id="L414">         } catch (MalformedURLException e) {</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">             if (MLET_LOGGER.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L416">                 MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                         &quot;addUrl&quot;, &quot;Malformed URL: &quot; + url, e);
             }
<span class="nc" id="L419">             throw new</span>
                 ServiceNotFoundException(&quot;The specified URL is malformed&quot;);
<span class="nc" id="L421">         }</span>
<span class="nc" id="L422">     }</span>

     /** Returns the search path of URLs for loading classes and resources.
      * This includes the original list of URLs specified to the constructor,
      * along with any URLs subsequently appended by the addURL() method.
      */
     public URL[] getURLs() {
<span class="nc" id="L429">         return super.getURLs();</span>
     }

     /**
      * Loads a text file containing MLET tags that define the MBeans to
      * be added to the MBean server. The location of the text file is specified by
      * a URL. The MBeans specified in the MLET file will be instantiated and
      * registered in the MBean server.
      *
      * @param url The URL of the text file to be loaded as URL object.
      *
      * @return  A set containing one entry per MLET tag in the m-let text file loaded.
      * Each entry specifies either the ObjectInstance for the created MBean, or a throwable object
      * (that is, an error or an exception) if the MBean could not be created.
      *
      * @exception ServiceNotFoundException One of the following errors has occurred: The m-let text file does
      * not contain an MLET tag, the m-let text file is not found, a mandatory
      * attribute of the MLET tag is not specified, the value of url is
      * null.
      * @exception IllegalStateException MLet MBean is not registered with an MBeanServer.
      */
     public Set&lt;Object&gt; getMBeansFromURL(URL url)
             throws ServiceNotFoundException  {
<span class="nc bnc" id="L452" title="All 2 branches missed.">         if (url == null) {</span>
<span class="nc" id="L453">             throw new ServiceNotFoundException(&quot;The specified URL is null&quot;);</span>
         }
<span class="nc" id="L455">         return getMBeansFromURL(url.toString());</span>
     }

     /**
      * Loads a text file containing MLET tags that define the MBeans to
      * be added to the MBean server. The location of the text file is specified by
      * a URL. The MBeans specified in the MLET file will be instantiated and
      * registered in the MBean server.
      *
      * @param url The URL of the text file to be loaded as String object.
      *
      * @return A set containing one entry per MLET tag in the m-let
      * text file loaded.  Each entry specifies either the
      * ObjectInstance for the created MBean, or a throwable object
      * (that is, an error or an exception) if the MBean could not be
      * created.
      *
      * @exception ServiceNotFoundException One of the following
      * errors has occurred: The m-let text file does not contain an
      * MLET tag, the m-let text file is not found, a mandatory
      * attribute of the MLET tag is not specified, the url is
      * malformed.
      * @exception IllegalStateException MLet MBean is not registered
      * with an MBeanServer.
      *
      */
     public Set&lt;Object&gt; getMBeansFromURL(String url)
             throws ServiceNotFoundException  {

<span class="nc" id="L484">         String mth = &quot;getMBeansFromURL&quot;;</span>

<span class="nc bnc" id="L486" title="All 2 branches missed.">         if (server == null) {</span>
<span class="nc" id="L487">             throw new IllegalStateException(&quot;This MLet MBean is not &quot; +</span>
                                             &quot;registered with an MBeanServer.&quot;);
         }
         // Parse arguments
<span class="nc bnc" id="L491" title="All 2 branches missed.">         if (url == null) {</span>
<span class="nc" id="L492">             MLET_LOGGER.logp(Level.FINER, MLet.class.getName(),</span>
                     mth, &quot;URL is null&quot;);
<span class="nc" id="L494">             throw new ServiceNotFoundException(&quot;The specified URL is null&quot;);</span>
         } else {
<span class="nc" id="L496">             url = url.replace(File.separatorChar,'/');</span>
         }
<span class="nc bnc" id="L498" title="All 2 branches missed.">         if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L499">             MLET_LOGGER.logp(Level.FINER, MLet.class.getName(),</span>
                     mth, &quot;&lt;URL = &quot; + url + &quot;&gt;&quot;);
         }

         // Parse URL
         try {
<span class="nc" id="L505">             MLetParser parser = new MLetParser();</span>
<span class="nc" id="L506">             mletList = parser.parseURL(url);</span>
<span class="nc" id="L507">         } catch (Exception e) {</span>
<span class="nc" id="L508">             final String msg =</span>
                 &quot;Problems while parsing URL [&quot; + url +
<span class="nc" id="L510">                 &quot;], got exception [&quot; + e.toString() + &quot;]&quot;;</span>
<span class="nc" id="L511">             MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth, msg);</span>
<span class="nc" id="L512">             throw EnvHelp.initCause(new ServiceNotFoundException(msg), e);</span>
<span class="nc" id="L513">         }</span>

         // Check that the list of MLets is not empty
<span class="nc bnc" id="L516" title="All 2 branches missed.">         if (mletList.size() == 0) {</span>
<span class="nc" id="L517">             final String msg =</span>
                 &quot;File &quot; + url + &quot; not found or MLET tag not defined in file&quot;;
<span class="nc" id="L519">             MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth, msg);</span>
<span class="nc" id="L520">             throw new ServiceNotFoundException(msg);</span>
         }

         // Walk through the list of MLets
<span class="nc" id="L524">         Set&lt;Object&gt; mbeans = new HashSet&lt;Object&gt;();</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">         for (MLetContent elmt : mletList) {</span>
             // Initialize local variables
<span class="nc" id="L527">             String code = elmt.getCode();</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">             if (code != null) {</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">                 if (code.endsWith(&quot;.class&quot;)) {</span>
<span class="nc" id="L530">                     code = code.substring(0, code.length() - 6);</span>
                 }
             }
<span class="nc" id="L533">             String name = elmt.getName();</span>
<span class="nc" id="L534">             URL codebase = elmt.getCodeBase();</span>
<span class="nc" id="L535">             String version = elmt.getVersion();</span>
<span class="nc" id="L536">             String serName = elmt.getSerializedObject();</span>
<span class="nc" id="L537">             String jarFiles = elmt.getJarFiles();</span>
<span class="nc" id="L538">             URL documentBase = elmt.getDocumentBase();</span>

             // Display debug information
<span class="nc bnc" id="L541" title="All 2 branches missed.">             if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L542">                 final StringBuilder strb = new StringBuilder()</span>
<span class="nc" id="L543">                 .append(&quot;\n\tMLET TAG     = &quot;).append(elmt.getAttributes())</span>
<span class="nc" id="L544">                 .append(&quot;\n\tCODEBASE     = &quot;).append(codebase)</span>
<span class="nc" id="L545">                 .append(&quot;\n\tARCHIVE      = &quot;).append(jarFiles)</span>
<span class="nc" id="L546">                 .append(&quot;\n\tCODE         = &quot;).append(code)</span>
<span class="nc" id="L547">                 .append(&quot;\n\tOBJECT       = &quot;).append(serName)</span>
<span class="nc" id="L548">                 .append(&quot;\n\tNAME         = &quot;).append(name)</span>
<span class="nc" id="L549">                 .append(&quot;\n\tVERSION      = &quot;).append(version)</span>
<span class="nc" id="L550">                 .append(&quot;\n\tDOCUMENT URL = &quot;).append(documentBase);</span>
<span class="nc" id="L551">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(),</span>
<span class="nc" id="L552">                         mth, strb.toString());</span>
             }

             // Load classes from JAR files
<span class="nc" id="L556">             StringTokenizer st = new StringTokenizer(jarFiles, &quot;,&quot;, false);</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">             while (st.hasMoreTokens()) {</span>
<span class="nc" id="L558">                 String tok = st.nextToken().trim();</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">                 if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L560">                     MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                             &quot;Load archive for codebase &lt;&quot; + codebase +
                             &quot;&gt;, file &lt;&quot; + tok + &quot;&gt;&quot;);
                 }
                 // Check which is the codebase to be used for loading the jar file.
                 // If we are using the base MLet implementation then it will be
                 // always the remote server but if the service has been extended in
                 // order to support caching and versioning then this method will
                 // return the appropriate one.
                 //
                 try {
<span class="nc" id="L571">                     codebase = check(version, codebase, tok, elmt);</span>
<span class="nc" id="L572">                 } catch (Exception ex) {</span>
<span class="nc" id="L573">                     MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                             mth, &quot;Got unexpected exception&quot;, ex);
<span class="nc" id="L575">                     mbeans.add(ex);</span>
<span class="nc" id="L576">                     continue;</span>
<span class="nc" id="L577">                 }</span>

                 // Appends the specified JAR file URL to the list of
                 // URLs to search for classes and resources.
                 try {
<span class="nc" id="L582">                     if (!Arrays.asList(getURLs())</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">                         .contains(new URL(codebase.toString() + tok))) {</span>
<span class="nc" id="L584">                         addURL(codebase + tok);</span>
                     }
<span class="nc" id="L586">                 } catch (MalformedURLException me) {</span>
                     // OK : Ignore jar file if its name provokes the
                     // URL to be an invalid one.
<span class="nc" id="L589">                 }</span>

<span class="nc" id="L591">             }</span>
             // Instantiate the class specified in the
             // CODE or OBJECT section of the MLet tag
             //
             Object o;
             ObjectInstance objInst;

<span class="nc bnc" id="L598" title="All 4 branches missed.">             if (code != null &amp;&amp; serName != null) {</span>
                 final String msg =
                     &quot;CODE and OBJECT parameters cannot be specified at the &quot; +
                     &quot;same time in tag MLET&quot;;
<span class="nc" id="L602">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth, msg);</span>
<span class="nc" id="L603">                 mbeans.add(new Error(msg));</span>
<span class="nc" id="L604">                 continue;</span>
             }
<span class="nc bnc" id="L606" title="All 4 branches missed.">             if (code == null &amp;&amp; serName == null) {</span>
                 final String msg =
                     &quot;Either CODE or OBJECT parameter must be specified in &quot; +
                     &quot;tag MLET&quot;;
<span class="nc" id="L610">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth, msg);</span>
<span class="nc" id="L611">                 mbeans.add(new Error(msg));</span>
<span class="nc" id="L612">                 continue;</span>
             }
             try {
<span class="nc bnc" id="L615" title="All 2 branches missed.">                 if (code != null) {</span>

<span class="nc" id="L617">                     List&lt;String&gt; signat = elmt.getParameterTypes();</span>
<span class="nc" id="L618">                     List&lt;String&gt; stringPars = elmt.getParameterValues();</span>
<span class="nc" id="L619">                     List&lt;Object&gt; objectPars = new ArrayList&lt;Object&gt;();</span>

<span class="nc bnc" id="L621" title="All 2 branches missed.">                     for (int i = 0; i &lt; signat.size(); i++) {</span>
<span class="nc" id="L622">                         objectPars.add(constructParameter(stringPars.get(i),</span>
<span class="nc" id="L623">                                                           signat.get(i)));</span>
                     }
<span class="nc bnc" id="L625" title="All 2 branches missed.">                     if (signat.isEmpty()) {</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">                         if (name == null) {</span>
<span class="nc" id="L627">                             objInst = server.createMBean(code, null,</span>
                                                          mletObjectName);
                         } else {
<span class="nc" id="L630">                             objInst = server.createMBean(code,</span>
                                                          new ObjectName(name),
                                                          mletObjectName);
                         }
                     } else {
<span class="nc" id="L635">                         Object[] parms = objectPars.toArray();</span>
<span class="nc" id="L636">                         String[] signature = new String[signat.size()];</span>
<span class="nc" id="L637">                         signat.toArray(signature);</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">                         if (MLET_LOGGER.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L639">                             final StringBuilder strb = new StringBuilder();</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">                             for (int i = 0; i &lt; signature.length; i++) {</span>
<span class="nc" id="L641">                                 strb.append(&quot;\n\tSignature     = &quot;)</span>
<span class="nc" id="L642">                                 .append(signature[i])</span>
<span class="nc" id="L643">                                 .append(&quot;\t\nParams        = &quot;)</span>
<span class="nc" id="L644">                                 .append(parms[i]);</span>
                             }
<span class="nc" id="L646">                             MLET_LOGGER.logp(Level.FINEST,</span>
<span class="nc" id="L647">                                     MLet.class.getName(),</span>
<span class="nc" id="L648">                                     mth, strb.toString());</span>
                         }
<span class="nc bnc" id="L650" title="All 2 branches missed.">                         if (name == null) {</span>
<span class="nc" id="L651">                             objInst =</span>
<span class="nc" id="L652">                                 server.createMBean(code, null, mletObjectName,</span>
                                                    parms, signature);
                         } else {
<span class="nc" id="L655">                             objInst =</span>
<span class="nc" id="L656">                                 server.createMBean(code, new ObjectName(name),</span>
                                                    mletObjectName, parms,
                                                    signature);
                         }
                     }
<span class="nc" id="L661">                 } else {</span>
<span class="nc" id="L662">                     o = loadSerializedObject(codebase,serName);</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">                     if (name == null) {</span>
<span class="nc" id="L664">                         server.registerMBean(o, null);</span>
                     } else {
<span class="nc" id="L666">                         server.registerMBean(o,  new ObjectName(name));</span>
                     }
<span class="nc" id="L668">                     objInst = new ObjectInstance(name, o.getClass().getName());</span>
                 }
<span class="nc" id="L670">             } catch (ReflectionException  ex) {</span>
<span class="nc" id="L671">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;ReflectionException&quot;, ex);
<span class="nc" id="L673">                 mbeans.add(ex);</span>
<span class="nc" id="L674">                 continue;</span>
<span class="nc" id="L675">             } catch (InstanceAlreadyExistsException  ex) {</span>
<span class="nc" id="L676">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;InstanceAlreadyExistsException&quot;, ex);
<span class="nc" id="L678">                 mbeans.add(ex);</span>
<span class="nc" id="L679">                 continue;</span>
<span class="nc" id="L680">             } catch (MBeanRegistrationException ex) {</span>
<span class="nc" id="L681">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;MBeanRegistrationException&quot;, ex);
<span class="nc" id="L683">                 mbeans.add(ex);</span>
<span class="nc" id="L684">                 continue;</span>
<span class="nc" id="L685">             } catch (MBeanException  ex) {</span>
<span class="nc" id="L686">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;MBeanException&quot;, ex);
<span class="nc" id="L688">                 mbeans.add(ex);</span>
<span class="nc" id="L689">                 continue;</span>
<span class="nc" id="L690">             } catch (NotCompliantMBeanException  ex) {</span>
<span class="nc" id="L691">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;NotCompliantMBeanException&quot;, ex);
<span class="nc" id="L693">                 mbeans.add(ex);</span>
<span class="nc" id="L694">                 continue;</span>
<span class="nc" id="L695">             } catch (InstanceNotFoundException   ex) {</span>
<span class="nc" id="L696">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;InstanceNotFoundException&quot;, ex);
<span class="nc" id="L698">                 mbeans.add(ex);</span>
<span class="nc" id="L699">                 continue;</span>
<span class="nc" id="L700">             } catch (IOException ex) {</span>
<span class="nc" id="L701">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;IOException&quot;, ex);
<span class="nc" id="L703">                 mbeans.add(ex);</span>
<span class="nc" id="L704">                 continue;</span>
<span class="nc" id="L705">             } catch (SecurityException ex) {</span>
<span class="nc" id="L706">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;SecurityException&quot;, ex);
<span class="nc" id="L708">                 mbeans.add(ex);</span>
<span class="nc" id="L709">                 continue;</span>
<span class="nc" id="L710">             } catch (Exception ex) {</span>
<span class="nc" id="L711">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;Exception&quot;, ex);
<span class="nc" id="L713">                 mbeans.add(ex);</span>
<span class="nc" id="L714">                 continue;</span>
<span class="nc" id="L715">             } catch (Error ex) {</span>
<span class="nc" id="L716">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         &quot;Error&quot;, ex);
<span class="nc" id="L718">                 mbeans.add(ex);</span>
<span class="nc" id="L719">                 continue;</span>
<span class="nc" id="L720">             }</span>
<span class="nc" id="L721">             mbeans.add(objInst);</span>
<span class="nc" id="L722">         }</span>
<span class="nc" id="L723">         return mbeans;</span>
     }

     /**
      * Gets the current directory used by the library loader for
      * storing native libraries before they are loaded into memory.
      *
      * @return The current directory used by the library loader.
      *
      * @see #setLibraryDirectory
      *
      * @throws UnsupportedOperationException if this implementation
      * does not support storing native libraries in this way.
      */
     public synchronized String getLibraryDirectory() {
<span class="nc" id="L738">         return libraryDirectory;</span>
     }

     /**
      * Sets the directory used by the library loader for storing
      * native libraries before they are loaded into memory.
      *
      * @param libdir The directory used by the library loader.
      *
      * @see #getLibraryDirectory
      *
      * @throws UnsupportedOperationException if this implementation
      * does not support storing native libraries in this way.
      */
     public synchronized void setLibraryDirectory(String libdir) {
<span class="nc" id="L753">         libraryDirectory = libdir;</span>
<span class="nc" id="L754">     }</span>

     /**
      * Allows the m-let to perform any operations it needs before
      * being registered in the MBean server. If the ObjectName is
      * null, the m-let provides a default name for its registration
      * &amp;lt;defaultDomain&amp;gt;:type=MLet
      *
      * @param server The MBean server in which the m-let will be registered.
      * @param name The object name of the m-let.
      *
      * @return  The name of the m-let registered.
      *
      * @exception java.lang.Exception This exception should be caught by the MBean server and re-thrown
      *as an MBeanRegistrationException.
      */
     public ObjectName preRegister(MBeanServer server, ObjectName name)
             throws Exception {

         // Initialize local pointer to the MBean server
<span class="nc" id="L774">         setMBeanServer(server);</span>

         // If no name is specified return a default name for the MLet
<span class="nc bnc" id="L777" title="All 2 branches missed.">         if (name == null) {</span>
<span class="nc" id="L778">             name = new ObjectName(server.getDefaultDomain() + &quot;:&quot; + ServiceName.MLET);</span>
         }

<span class="nc" id="L781">        this.mletObjectName = name;</span>
<span class="nc" id="L782">        return this.mletObjectName;</span>
     }

     /**
      * Allows the m-let to perform any operations needed after having been
      * registered in the MBean server or after the registration has failed.
      *
      * @param registrationDone Indicates whether or not the m-let has
      * been successfully registered in the MBean server. The value
      * false means that either the registration phase has failed.
      *
      */
     public void postRegister (Boolean registrationDone) {
<span class="nc" id="L795">     }</span>

     /**
      * Allows the m-let to perform any operations it needs before being unregistered
      * by the MBean server.
      *
      * @exception java.lang.Exception This exception should be caught
      * by the MBean server and re-thrown as an
      * MBeanRegistrationException.
      */
     public void preDeregister() throws java.lang.Exception {
<span class="nc" id="L806">     }</span>


     /**
      * Allows the m-let to perform any operations needed after having been
      * unregistered in the MBean server.
      */
     public void postDeregister() {
<span class="nc" id="L814">     }</span>

     /**
      * &lt;p&gt;Save this MLet's contents to the given {@link ObjectOutput}.
      * Not all implementations support this method.  Those that do not
      * throw {@link UnsupportedOperationException}.  A subclass may
      * override this method to support it or to change the format of
      * the written data.&lt;/p&gt;
      *
      * &lt;p&gt;The format of the written data is not specified, but if
      * an implementation supports {@link #writeExternal} it must
      * also support {@link #readExternal} in such a way that what is
      * written by the former can be read by the latter.&lt;/p&gt;
      *
      * @param out The object output stream to write to.
      *
      * @exception IOException If a problem occurred while writing.
      * @exception UnsupportedOperationException If this
      * implementation does not support this operation.
      */
     public void writeExternal(ObjectOutput out)
             throws IOException, UnsupportedOperationException {
<span class="nc" id="L836">         throw new UnsupportedOperationException(&quot;MLet.writeExternal&quot;);</span>
     }

     /**
      * &lt;p&gt;Restore this MLet's contents from the given {@link ObjectInput}.
      * Not all implementations support this method.  Those that do not
      * throw {@link UnsupportedOperationException}.  A subclass may
      * override this method to support it or to change the format of
      * the read data.&lt;/p&gt;
      *
      * &lt;p&gt;The format of the read data is not specified, but if an
      * implementation supports {@link #readExternal} it must also
      * support {@link #writeExternal} in such a way that what is
      * written by the latter can be read by the former.&lt;/p&gt;
      *
      * @param in The object input stream to read from.
      *
      * @exception IOException if a problem occurred while reading.
      * @exception ClassNotFoundException if the class for the object
      * being restored cannot be found.
      * @exception UnsupportedOperationException if this
      * implementation does not support this operation.
      */
     public void readExternal(ObjectInput in)
             throws IOException, ClassNotFoundException,
                    UnsupportedOperationException {
<span class="nc" id="L862">         throw new UnsupportedOperationException(&quot;MLet.readExternal&quot;);</span>
     }

     /*
      * ------------------------------------------
      *  PACKAGE METHODS
      * ------------------------------------------
      */

     /**
      * &lt;p&gt;Load a class, using the given {@link ClassLoaderRepository} if
      * the class is not found in this MLet's URLs.  The given
      * ClassLoaderRepository can be null, in which case a {@link
      * ClassNotFoundException} occurs immediately if the class is not
      * found in this MLet's URLs.&lt;/p&gt;
      *
      * @param name The name of the class we want to load.
      * @param clr  The ClassLoaderRepository that will be used to search
      *             for the given class, if it is not found in this
      *             ClassLoader.  May be null.
      * @return The resulting Class object.
      * @exception ClassNotFoundException The specified class could not be
      *            found in this ClassLoader nor in the given
      *            ClassLoaderRepository.
      *
      */
     public synchronized Class&lt;?&gt; loadClass(String name,
                                            ClassLoaderRepository clr)
              throws ClassNotFoundException {
<span class="nc" id="L891">         final ClassLoaderRepository before=currentClr;</span>
         try {
<span class="nc" id="L893">             currentClr = clr;</span>
<span class="nc" id="L894">             return loadClass(name);</span>
         } finally {
<span class="nc" id="L896">             currentClr = before;</span>
         }
     }

     /*
      * ------------------------------------------
      *  PROTECTED METHODS
      * ------------------------------------------
      */

     /**
      * This is the main method for class loaders that is being redefined.
      *
      * @param name The name of the class.
      *
      * @return The resulting Class object.
      *
      * @exception ClassNotFoundException The specified class could not be
      *            found.
      */
     protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {
         /* currentClr is context sensitive - used to avoid recursion
            in the class loader repository.  (This is no longer
            necessary with the new CLR semantics but is kept for
            compatibility with code that might have called the
            two-parameter loadClass explicitly.)  */
<span class="nc" id="L922">         return findClass(name, currentClr);</span>
     }

     /**
      * Called by {@link MLet#findClass(java.lang.String)}.
      *
      * @param name The name of the class that we want to load/find.
      * @param clr The ClassLoaderRepository that can be used to search
      *            for the given class. This parameter is
      *            &lt;code&gt;null&lt;/code&gt; when called from within the
      *            {@link javax.management.MBeanServerFactory#getClassLoaderRepository(javax.management.MBeanServer) Class Loader Repository}.
      * @exception ClassNotFoundException The specified class could not be
      *            found.
      *
      **/
     Class&lt;?&gt; findClass(String name, ClassLoaderRepository clr)
         throws ClassNotFoundException {
<span class="nc" id="L939">         Class&lt;?&gt; c = null;</span>
<span class="nc" id="L940">         MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), &quot;findClass&quot;, name);</span>
         // Try looking in the JAR:
         try {
<span class="nc" id="L943">             c = super.findClass(name);</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">             if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L945">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(),</span>
                         &quot;findClass&quot;,
                         &quot;Class &quot; + name + &quot; loaded through MLet classloader&quot;);
             }
<span class="nc" id="L949">         } catch (ClassNotFoundException e) {</span>
             // Drop through
<span class="nc bnc" id="L951" title="All 2 branches missed.">             if (MLET_LOGGER.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L952">                 MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                         &quot;findClass&quot;,
                         &quot;Class &quot; + name + &quot; not found locally&quot;);
             }
<span class="nc" id="L956">         }</span>
         // if we are not called from the ClassLoaderRepository
<span class="nc bnc" id="L958" title="All 6 branches missed.">         if (c == null &amp;&amp; delegateToCLR &amp;&amp; clr != null) {</span>
             // Try the classloader repository:
             //
             try {
<span class="nc bnc" id="L962" title="All 2 branches missed.">                 if (MLET_LOGGER.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L963">                     MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                             &quot;findClass&quot;,
                             &quot;Class &quot; + name + &quot; : looking in CLR&quot;);
                 }
<span class="nc" id="L967">                 c = clr.loadClassBefore(this, name);</span>
                 // The loadClassBefore method never returns null.
                 // If the class is not found we get an exception.
<span class="nc bnc" id="L970" title="All 2 branches missed.">                 if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L971">                     MLET_LOGGER.logp(Level.FINER, MLet.class.getName(),</span>
                             &quot;findClass&quot;,
                             &quot;Class &quot; + name + &quot; loaded through &quot; +
                             &quot;the default classloader repository&quot;);
                 }
<span class="nc" id="L976">             } catch (ClassNotFoundException e) {</span>
                 // Drop through
<span class="nc bnc" id="L978" title="All 2 branches missed.">                 if (MLET_LOGGER.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L979">                     MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                             &quot;findClass&quot;,
                             &quot;Class &quot; + name + &quot; not found in CLR&quot;);
                 }
<span class="nc" id="L983">             }</span>
         }
<span class="nc bnc" id="L985" title="All 2 branches missed.">         if (c == null) {</span>
<span class="nc" id="L986">             MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                     &quot;findClass&quot;, &quot;Failed to load class &quot; + name);
<span class="nc" id="L988">             throw new ClassNotFoundException(name);</span>
         }
<span class="nc" id="L990">         return c;</span>
     }

     /**
      * Returns the absolute path name of a native library. The VM
      * invokes this method to locate the native libraries that belong
      * to classes loaded with this class loader. Libraries are
      * searched in the JAR files using first just the native library
      * name and if not found the native library name together with
      * the architecture-specific path name
      * (&lt;code&gt;OSName/OSArch/OSVersion/lib/nativelibname&lt;/code&gt;), i.e.
      * &lt;p&gt;
      * the library stat on Solaris SPARC 5.7 will be searched in the JAR file as:
      * &lt;OL&gt;
      * &lt;LI&gt;libstat.so
      * &lt;LI&gt;SunOS/sparc/5.7/lib/libstat.so
      * &lt;/OL&gt;
      * the library stat on Windows NT 4.0 will be searched in the JAR file as:
      * &lt;OL&gt;
      * &lt;LI&gt;stat.dll
      * &lt;LI&gt;WindowsNT/x86/4.0/lib/stat.dll
      * &lt;/OL&gt;
      *
      * &lt;p&gt;More specifically, let &lt;em&gt;{@code nativelibname}&lt;/em&gt; be the result of
      * {@link System#mapLibraryName(java.lang.String)
      * System.mapLibraryName}{@code (libname)}.  Then the following names are
      * searched in the JAR files, in order:&lt;br&gt;
      * &lt;em&gt;{@code nativelibname}&lt;/em&gt;&lt;br&gt;
      * {@code &lt;os.name&gt;/&lt;os.arch&gt;/&lt;os.version&gt;/lib/}&lt;em&gt;{@code nativelibname}&lt;/em&gt;&lt;br&gt;
      * where {@code &lt;X&gt;} means {@code System.getProperty(X)} with any
      * spaces in the result removed, and {@code /} stands for the
      * file separator character ({@link File#separator}).
      * &lt;p&gt;
      * If this method returns &lt;code&gt;null&lt;/code&gt;, i.e. the libraries
      * were not found in any of the JAR files loaded with this class
      * loader, the VM searches the library along the path specified
      * as the &lt;code&gt;java.library.path&lt;/code&gt; property.
      *
      * @param libname The library name.
      *
      * @return The absolute path of the native library.
      */
     protected String findLibrary(String libname) {

         String abs_path;
<span class="nc" id="L1035">         String mth = &quot;findLibrary&quot;;</span>

         // Get the platform-specific string representing a native library.
         //
<span class="nc" id="L1039">         String nativelibname = System.mapLibraryName(libname);</span>

         //
         // See if the native library is accessible as a resource through the JAR file.
         //
<span class="nc bnc" id="L1044" title="All 2 branches missed.">         if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L1045">             MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                     &quot;Search &quot; + libname + &quot; in all JAR files&quot;);
         }

         // First try to locate the library in the JAR file using only
         // the native library name.  e.g. if user requested a load
         // for &quot;foo&quot; on Solaris SPARC 5.7 we try to load &quot;libfoo.so&quot;
         // from the JAR file.
         //
<span class="nc bnc" id="L1054" title="All 2 branches missed.">         if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L1055">             MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                     &quot;loadLibraryAsResource(&quot; + nativelibname + &quot;)&quot;);
         }
<span class="nc" id="L1058">         abs_path = loadLibraryAsResource(nativelibname);</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">         if (abs_path != null) {</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">             if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L1061">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         nativelibname + &quot; loaded, absolute path = &quot; + abs_path);
             }
<span class="nc" id="L1064">             return abs_path;</span>
         }

         // Next try to locate it using the native library name and
         // the architecture-specific path name.  e.g. if user
         // requested a load for &quot;foo&quot; on Solaris SPARC 5.7 we try to
         // load &quot;SunOS/sparc/5.7/lib/libfoo.so&quot; from the JAR file.
         //
<span class="nc" id="L1072">         nativelibname = removeSpace(System.getProperty(&quot;os.name&quot;)) + File.separator +</span>
<span class="nc" id="L1073">             removeSpace(System.getProperty(&quot;os.arch&quot;)) + File.separator +</span>
<span class="nc" id="L1074">             removeSpace(System.getProperty(&quot;os.version&quot;)) + File.separator +</span>
             &quot;lib&quot; + File.separator + nativelibname;
<span class="nc bnc" id="L1076" title="All 2 branches missed.">         if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L1077">             MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                     &quot;loadLibraryAsResource(&quot; + nativelibname + &quot;)&quot;);
         }

<span class="nc" id="L1081">         abs_path = loadLibraryAsResource(nativelibname);</span>
<span class="nc bnc" id="L1082" title="All 2 branches missed.">         if (abs_path != null) {</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">             if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L1084">                 MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                         nativelibname + &quot; loaded, absolute path = &quot; + abs_path);
             }
<span class="nc" id="L1087">             return abs_path;</span>
         }

         //
         // All paths exhausted, library not found in JAR file.
         //

<span class="nc bnc" id="L1094" title="All 2 branches missed.">         if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L1095">             MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                     libname + &quot; not found in any JAR file&quot;);
<span class="nc" id="L1097">             MLET_LOGGER.logp(Level.FINER, MLet.class.getName(), mth,</span>
                     &quot;Search &quot; + libname + &quot; along the path &quot; +
                     &quot;specified as the java.library.path property&quot;);
         }

         // Let the VM search the library along the path
         // specified as the java.library.path property.
         //
<span class="nc" id="L1105">         return null;</span>
     }


     /*
      * ------------------------------------------
      *  PRIVATE METHODS
      * ------------------------------------------
      */

     private String getTmpDir() {
         // JDK 1.4
<span class="nc" id="L1117">         String tmpDir = System.getProperty(&quot;java.io.tmpdir&quot;);</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">         if (tmpDir != null) return tmpDir;</span>

         // JDK &lt; 1.4
<span class="nc" id="L1121">         File tmpFile = null;</span>
         try {
             // Try to guess the system temporary dir...
<span class="nc" id="L1124">             tmpFile = File.createTempFile(&quot;tmp&quot;,&quot;jmx&quot;);</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">             if (tmpFile == null) return null;</span>
<span class="nc" id="L1126">             final File tmpDirFile = tmpFile.getParentFile();</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">             if (tmpDirFile == null) return null;</span>
<span class="nc" id="L1128">             return tmpDirFile.getAbsolutePath();</span>
<span class="nc" id="L1129">         } catch (Exception x) {</span>
<span class="nc" id="L1130">             MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                     &quot;getTmpDir&quot;, &quot;Failed to determine system temporary dir&quot;);
<span class="nc" id="L1132">             return null;</span>
         } finally {
             // Cleanup ...
<span class="nc bnc" id="L1135" title="All 10 branches missed.">             if (tmpFile!=null) {</span>
                 try {
<span class="nc" id="L1137">                     boolean deleted = tmpFile.delete();</span>
<span class="nc bnc" id="L1138" title="All 10 branches missed.">                     if (!deleted) {</span>
<span class="nc" id="L1139">                         MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                                 &quot;getTmpDir&quot;, &quot;Failed to delete temp file&quot;);
                     }
<span class="nc" id="L1142">                 } catch (Exception x) {</span>
<span class="nc" id="L1143">                     MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                             &quot;getTmpDir&quot;, &quot;Failed to delete temporary file&quot;, x);
<span class="nc" id="L1145">                 }</span>
             }
        }
     }

     /**
      * Search the specified native library in any of the JAR files
      * loaded by this classloader.  If the library is found copy it
      * into the library directory and return the absolute path.  If
      * the library is not found then return null.
      */
     private synchronized String loadLibraryAsResource(String libname) {
         try {
<span class="nc" id="L1158">             InputStream is = getResourceAsStream(</span>
<span class="nc" id="L1159">                     libname.replace(File.separatorChar,'/'));</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">             if (is != null) {</span>
                 try {
<span class="nc" id="L1162">                     File directory = new File(libraryDirectory);</span>
<span class="nc" id="L1163">                     directory.mkdirs();</span>
<span class="nc" id="L1164">                     File file = Files.createTempFile(directory.toPath(),</span>
                                                      libname + &quot;.&quot;, null)
<span class="nc" id="L1166">                                      .toFile();</span>
<span class="nc" id="L1167">                     file.deleteOnExit();</span>
<span class="nc" id="L1168">                     FileOutputStream fileOutput = new FileOutputStream(file);</span>
                     try {
<span class="nc" id="L1170">                         byte[] buf = new byte[4096];</span>
                         int n;
<span class="nc bnc" id="L1172" title="All 2 branches missed.">                         while ((n = is.read(buf)) &gt;= 0) {</span>
<span class="nc" id="L1173">                            fileOutput.write(buf, 0, n);</span>
                         }
                     } finally {
<span class="nc" id="L1176">                         fileOutput.close();</span>
<span class="nc" id="L1177">                     }</span>
<span class="nc bnc" id="L1178" title="All 2 branches missed.">                     if (file.exists()) {</span>
<span class="nc" id="L1179">                         return file.getAbsolutePath();</span>
                     }
                 } finally {
<span class="nc" id="L1182">                     is.close();</span>
<span class="nc" id="L1183">                 }</span>
             }
<span class="nc" id="L1185">         } catch (Exception e) {</span>
<span class="nc" id="L1186">             MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                     &quot;loadLibraryAsResource&quot;,
                     &quot;Failed to load library : &quot; + libname, e);
<span class="nc" id="L1189">             return null;</span>
<span class="nc" id="L1190">         }</span>
<span class="nc" id="L1191">         return null;</span>
     }

   /**
    * Removes any white space from a string. This is used to
    * convert strings such as &quot;Windows NT&quot; to &quot;WindowsNT&quot;.
    */
     private static String removeSpace(String s) {
<span class="nc" id="L1199">         return s.trim().replace(&quot; &quot;, &quot;&quot;);</span>
     }

     /**
      * &lt;p&gt;This method is to be overridden when extending this service to
      * support caching and versioning.  It is called from {@link
      * #getMBeansFromURL getMBeansFromURL} when the version,
      * codebase, and jarfile have been extracted from the MLet file,
      * and can be used to verify that it is all right to load the
      * given MBean, or to replace the given URL with a different one.&lt;/p&gt;
      *
      * &lt;p&gt;The default implementation of this method returns
      * &lt;code&gt;codebase&lt;/code&gt; unchanged.&lt;/p&gt;
      *
      * @param version The version number of the &lt;CODE&gt;.jar&lt;/CODE&gt;
      * file stored locally.
      * @param codebase The base URL of the remote &lt;CODE&gt;.jar&lt;/CODE&gt; file.
      * @param jarfile The name of the &lt;CODE&gt;.jar&lt;/CODE&gt; file to be loaded.
      * @param mlet The &lt;CODE&gt;MLetContent&lt;/CODE&gt; instance that
      * represents the &lt;CODE&gt;MLET&lt;/CODE&gt; tag.
      *
      * @return the codebase to use for the loaded MBean.  The returned
      * value should not be null.
      *
      * @exception Exception if the MBean is not to be loaded for some
      * reason.  The exception will be added to the set returned by
      * {@link #getMBeansFromURL getMBeansFromURL}.
      *
      */
     protected URL check(String version, URL codebase, String jarfile,
                         MLetContent mlet)
             throws Exception {
<span class="nc" id="L1231">         return codebase;</span>
     }

    /**
     * Loads the serialized object specified by the &lt;CODE&gt;OBJECT&lt;/CODE&gt;
     * attribute of the &lt;CODE&gt;MLET&lt;/CODE&gt; tag.
     *
     * @param codebase The &lt;CODE&gt;codebase&lt;/CODE&gt;.
     * @param filename The name of the file containing the serialized object.
     * @return The serialized object.
     * @exception ClassNotFoundException The specified serialized
     * object could not be found.
     * @exception IOException An I/O error occurred while loading
     * serialized object.
     */
     private Object loadSerializedObject(URL codebase, String filename)
             throws IOException, ClassNotFoundException {
<span class="nc bnc" id="L1248" title="All 2 branches missed.">        if (filename != null) {</span>
<span class="nc" id="L1249">            filename = filename.replace(File.separatorChar,'/');</span>
        }
<span class="nc bnc" id="L1251" title="All 2 branches missed.">        if (MLET_LOGGER.isLoggable(Level.FINER)) {</span>
<span class="nc" id="L1252">            MLET_LOGGER.logp(Level.FINER, MLet.class.getName(),</span>
<span class="nc" id="L1253">                    &quot;loadSerializedObject&quot;, codebase.toString() + filename);</span>
        }
<span class="nc" id="L1255">        InputStream is = getResourceAsStream(filename);</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">        if (is != null) {</span>
            try {
<span class="nc" id="L1258">                ObjectInputStream ois = new MLetObjectInputStream(is, this);</span>
<span class="nc" id="L1259">                Object serObject = ois.readObject();</span>
<span class="nc" id="L1260">                ois.close();</span>
<span class="nc" id="L1261">                return serObject;</span>
<span class="nc" id="L1262">            } catch (IOException e) {</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed.">                if (MLET_LOGGER.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L1264">                    MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                            &quot;loadSerializedObject&quot;,
                            &quot;Exception while deserializing &quot; + filename, e);
                }
<span class="nc" id="L1268">                throw e;</span>
<span class="nc" id="L1269">            } catch (ClassNotFoundException e) {</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">                if (MLET_LOGGER.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L1271">                    MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                            &quot;loadSerializedObject&quot;,
                            &quot;Exception while deserializing &quot; + filename, e);
                }
<span class="nc" id="L1275">                throw e;</span>
            }
        } else {
<span class="nc bnc" id="L1278" title="All 2 branches missed.">            if (MLET_LOGGER.isLoggable(Level.FINEST)) {</span>
<span class="nc" id="L1279">                MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                        &quot;loadSerializedObject&quot;, &quot;Error: File &quot; + filename +
                        &quot; containing serialized object not found&quot;);
            }
<span class="nc" id="L1283">            throw new Error(&quot;File &quot; + filename + &quot; containing serialized object not found&quot;);</span>
        }
     }

     /**
      * Converts the String value of the constructor's parameter to
      * a basic Java object with the type of the parameter.
      */
     private  Object constructParameter(String param, String type) {
         // check if it is a primitive type
<span class="nc" id="L1293">         Class&lt;?&gt; c = primitiveClasses.get(type);</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">         if (c != null) {</span>
            try {
<span class="nc" id="L1296">                Constructor&lt;?&gt; cons =</span>
<span class="nc" id="L1297">                    c.getConstructor(String.class);</span>
<span class="nc" id="L1298">                Object[] oo = new Object[1];</span>
<span class="nc" id="L1299">                oo[0]=param;</span>
<span class="nc" id="L1300">                return(cons.newInstance(oo));</span>

<span class="nc" id="L1302">            } catch (Exception  e) {</span>
<span class="nc" id="L1303">                MLET_LOGGER.logp(Level.FINEST, MLet.class.getName(),</span>
                        &quot;constructParameter&quot;, &quot;Got unexpected exception&quot;, e);
            }
        }
<span class="nc bnc" id="L1307" title="All 2 branches missed.">        if (type.compareTo(&quot;java.lang.Boolean&quot;) == 0)</span>
<span class="nc" id="L1308">             return Boolean.valueOf(param);</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">        if (type.compareTo(&quot;java.lang.Byte&quot;) == 0)</span>
<span class="nc" id="L1310">             return new Byte(param);</span>
<span class="nc bnc" id="L1311" title="All 2 branches missed.">        if (type.compareTo(&quot;java.lang.Short&quot;) == 0)</span>
<span class="nc" id="L1312">             return new Short(param);</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">        if (type.compareTo(&quot;java.lang.Long&quot;) == 0)</span>
<span class="nc" id="L1314">             return new Long(param);</span>
<span class="nc bnc" id="L1315" title="All 2 branches missed.">        if (type.compareTo(&quot;java.lang.Integer&quot;) == 0)</span>
<span class="nc" id="L1316">             return new Integer(param);</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">        if (type.compareTo(&quot;java.lang.Float&quot;) == 0)</span>
<span class="nc" id="L1318">             return new Float(param);</span>
<span class="nc bnc" id="L1319" title="All 2 branches missed.">        if (type.compareTo(&quot;java.lang.Double&quot;) == 0)</span>
<span class="nc" id="L1320">             return new Double(param);</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">        if (type.compareTo(&quot;java.lang.String&quot;) == 0)</span>
<span class="nc" id="L1322">             return param;</span>

<span class="nc" id="L1324">        return param;</span>
     }

    private synchronized void setMBeanServer(final MBeanServer server) {
<span class="nc" id="L1328">        this.server = server;</span>
<span class="nc" id="L1329">        PrivilegedAction&lt;ClassLoaderRepository&gt; act =</span>
<span class="nc" id="L1330">            new PrivilegedAction&lt;ClassLoaderRepository&gt;() {</span>
                public ClassLoaderRepository run() {
<span class="nc" id="L1332">                    return server.getClassLoaderRepository();</span>
                }
            };
<span class="nc" id="L1335">        currentClr = AccessController.doPrivileged(act);</span>
<span class="nc" id="L1336">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>