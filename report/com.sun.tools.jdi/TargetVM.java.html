<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TargetVM.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.tools.jdi</a> &gt; <span class="el_source">TargetVM.java</span></div><h1>TargetVM.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1998, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.tools.jdi;

import com.sun.jdi.*;
import com.sun.jdi.event.*;
import com.sun.jdi.connect.spi.Connection;
import com.sun.jdi.event.EventSet;

import java.util.*;
import java.io.IOException;

public class TargetVM implements Runnable {
<span class="nc" id="L37">    private Map&lt;String, Packet&gt; waitingQueue = new HashMap&lt;String, Packet&gt;(32,0.75f);</span>
<span class="nc" id="L38">    private boolean shouldListen = true;</span>
<span class="nc" id="L39">    private List&lt;EventQueue&gt; eventQueues = Collections.synchronizedList(new ArrayList&lt;EventQueue&gt;(2));</span>
    private VirtualMachineImpl vm;
    private Connection connection;
    private Thread readerThread;
<span class="nc" id="L43">    private EventController eventController = null;</span>
<span class="nc" id="L44">    private boolean eventsHeld = false;</span>

    /*
     * TO DO: The limit numbers below are somewhat arbitrary and should
     * be configurable in the future.
     */
    static private final int OVERLOADED_QUEUE = 2000;
    static private final int UNDERLOADED_QUEUE = 100;

<span class="nc" id="L53">    TargetVM(VirtualMachineImpl vm, Connection connection) {</span>
<span class="nc" id="L54">        this.vm = vm;</span>
<span class="nc" id="L55">        this.connection = connection;</span>
<span class="nc" id="L56">        this.readerThread = new Thread(vm.threadGroupForJDI(),</span>
                                       this, &quot;JDI Target VM Interface&quot;);
<span class="nc" id="L58">        this.readerThread.setDaemon(true);</span>
<span class="nc" id="L59">    }</span>

    void start() {
<span class="nc" id="L62">        readerThread.start();</span>
<span class="nc" id="L63">    }</span>

    private void dumpPacket(Packet packet, boolean sending) {
<span class="nc bnc" id="L66" title="All 2 branches missed.">        String direction = sending ? &quot;Sending&quot; : &quot;Receiving&quot;;</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (sending) {</span>
<span class="nc" id="L68">            vm.printTrace(direction + &quot; Command. id=&quot; + packet.id +</span>
                          &quot;, length=&quot; + packet.data.length +
                          &quot;, commandSet=&quot; + packet.cmdSet +
                          &quot;, command=&quot; + packet.cmd +
                          &quot;, flags=&quot; + packet.flags);
        } else {
<span class="nc bnc" id="L74" title="All 2 branches missed.">            String type = (packet.flags &amp; Packet.Reply) != 0 ?</span>
                          &quot;Reply&quot; : &quot;Event&quot;;
<span class="nc" id="L76">            vm.printTrace(direction + &quot; &quot; + type + &quot;. id=&quot; + packet.id +</span>
                          &quot;, length=&quot; + packet.data.length +
                          &quot;, errorCode=&quot; + packet.errorCode +
                          &quot;, flags=&quot; + packet.flags);
        }
<span class="nc" id="L81">        StringBuffer line = new StringBuffer(80);</span>
<span class="nc" id="L82">        line.append(&quot;0000: &quot;);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (int i = 0; i &lt; packet.data.length; i++) {</span>
<span class="nc bnc" id="L84" title="All 4 branches missed.">            if ((i &gt; 0) &amp;&amp; (i % 16 == 0)) {</span>
<span class="nc" id="L85">                vm.printTrace(line.toString());</span>
<span class="nc" id="L86">                line.setLength(0);</span>
<span class="nc" id="L87">                line.append(String.valueOf(i));</span>
<span class="nc" id="L88">                line.append(&quot;: &quot;);</span>
<span class="nc" id="L89">                int len = line.length();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">                for (int j = 0; j &lt; 6 - len; j++) {</span>
<span class="nc" id="L91">                    line.insert(0, '0');</span>
                }
            }
<span class="nc" id="L94">            int val = 0xff &amp; packet.data[i];</span>
<span class="nc" id="L95">            String str = Integer.toHexString(val);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (str.length() == 1) {</span>
<span class="nc" id="L97">                line.append('0');</span>
            }
<span class="nc" id="L99">            line.append(str);</span>
<span class="nc" id="L100">            line.append(' ');</span>
        }
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (line.length() &gt; 6) {</span>
<span class="nc" id="L103">            vm.printTrace(line.toString());</span>
        }
<span class="nc" id="L105">    }</span>

    public void run() {
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if ((vm.traceFlags &amp; VirtualMachine.TRACE_SENDS) != 0) {</span>
<span class="nc" id="L109">            vm.printTrace(&quot;Target VM interface thread running&quot;);</span>
        }
<span class="nc" id="L111">        Packet p=null,p2;</span>
        String idString;

<span class="nc bnc" id="L114" title="All 2 branches missed.">        while(shouldListen) {</span>

<span class="nc" id="L116">            boolean done = false;</span>
            try {
<span class="nc" id="L118">                byte b[] = connection.readPacket();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (b.length == 0) {</span>
<span class="nc" id="L120">                    done = true;</span>
                }
<span class="nc" id="L122">                p = Packet.fromByteArray(b);</span>
<span class="nc" id="L123">            } catch (IOException e) {</span>
<span class="nc" id="L124">                done = true;</span>
<span class="nc" id="L125">            }</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (done) {</span>
<span class="nc" id="L128">                shouldListen = false;</span>
                try {
<span class="nc" id="L130">                    connection.close();</span>
<span class="nc" id="L131">                } catch (IOException ioe) { }</span>
<span class="nc" id="L132">                break;</span>
            }

<span class="nc bnc" id="L135" title="All 2 branches missed.">            if ((vm.traceFlags &amp; VirtualMachineImpl.TRACE_RAW_RECEIVES) != 0)  {</span>
<span class="nc" id="L136">                dumpPacket(p, false);</span>
            }

<span class="nc bnc" id="L139" title="All 2 branches missed.">            if((p.flags &amp; Packet.Reply) == 0) {</span>
                // It's a command
<span class="nc" id="L141">                handleVMCommand(p);</span>
            } else {
                /*if(p.errorCode != Packet.ReplyNoError) {
                    System.err.println(&quot;Packet &quot; + p.id + &quot; returned failure = &quot; + p.errorCode);
                }*/

<span class="nc" id="L147">                vm.state().notifyCommandComplete(p.id);</span>
<span class="nc" id="L148">                idString = String.valueOf(p.id);</span>

<span class="nc" id="L150">                synchronized(waitingQueue) {</span>
<span class="nc" id="L151">                    p2 = waitingQueue.get(idString);</span>

<span class="nc bnc" id="L153" title="All 2 branches missed.">                    if (p2 != null)</span>
<span class="nc" id="L154">                        waitingQueue.remove(idString);</span>
<span class="nc" id="L155">                }</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">                if(p2 == null) {</span>
                    // Whoa! a reply without a sender. Problem.
                    // FIX ME! Need to post an error.

<span class="nc" id="L161">                    System.err.println(&quot;Recieved reply with no sender!&quot;);</span>
<span class="nc" id="L162">                    continue;</span>
                }
<span class="nc" id="L164">                p2.errorCode = p.errorCode;</span>
<span class="nc" id="L165">                p2.data = p.data;</span>
<span class="nc" id="L166">                p2.replied = true;</span>

<span class="nc" id="L168">                synchronized(p2) {</span>
<span class="nc" id="L169">                    p2.notify();</span>
<span class="nc" id="L170">                }</span>
            }
<span class="nc" id="L172">        }</span>

        // inform the VM mamager that this VM is history
<span class="nc" id="L175">        vm.vmManager.disposeVirtualMachine(vm);</span>

        // close down all the event queues
        // Closing a queue causes a VMDisconnectEvent to
        // be put onto the queue.
<span class="nc" id="L180">        synchronized(eventQueues) {</span>
<span class="nc" id="L181">            Iterator&lt;EventQueue&gt; iter = eventQueues.iterator();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L183">                ((EventQueueImpl)iter.next()).close();</span>
            }
<span class="nc" id="L185">        }</span>

        // indirectly throw VMDisconnectedException to
        // command requesters.
<span class="nc" id="L189">        synchronized(waitingQueue) {</span>
<span class="nc" id="L190">            Iterator&lt;Packet&gt; iter = waitingQueue.values().iterator();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L192">                Packet packet = iter.next();</span>
<span class="nc" id="L193">                synchronized(packet) {</span>
<span class="nc" id="L194">                    packet.notify();</span>
<span class="nc" id="L195">                }</span>
<span class="nc" id="L196">            }</span>
<span class="nc" id="L197">            waitingQueue.clear();</span>
<span class="nc" id="L198">        }</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">        if ((vm.traceFlags &amp; VirtualMachine.TRACE_SENDS) != 0) {</span>
<span class="nc" id="L201">            vm.printTrace(&quot;Target VM interface thread exiting&quot;);</span>
        }
<span class="nc" id="L203">    }</span>

    protected void handleVMCommand(Packet p) {
<span class="nc bnc" id="L206" title="All 2 branches missed.">        switch (p.cmdSet) {</span>
            case JDWP.Event.COMMAND_SET:
<span class="nc" id="L208">                handleEventCmdSet(p);</span>
<span class="nc" id="L209">                break;</span>

            default:
<span class="nc" id="L212">                System.err.println(&quot;Ignoring cmd &quot; + p.id + &quot;/&quot; +</span>
                                   p.cmdSet + &quot;/&quot; + p.cmd + &quot; from the VM&quot;);
<span class="nc" id="L214">                return;</span>
        }
<span class="nc" id="L216">    }</span>

    /* Events should not be constructed on this thread (the thread
     * which reads all data from the transport). This means that the
     * packet cannot be converted to real JDI objects as that may
     * involve further communications with the back end which would
     * deadlock.
     *
     * Instead the whole packet is passed for lazy eval by a queue
     * reading thread.
     */
    protected void handleEventCmdSet(Packet p) {
<span class="nc" id="L228">        EventSet eventSet = new EventSetImpl(vm, p);</span>

<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (eventSet != null) {</span>
<span class="nc" id="L231">            queueEventSet(eventSet);</span>
        }
<span class="nc" id="L233">    }</span>

    private EventController eventController() {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (eventController == null) {</span>
<span class="nc" id="L237">            eventController = new EventController(vm);</span>
        }
<span class="nc" id="L239">        return eventController;</span>
    }

    private synchronized void controlEventFlow(int maxQueueSize) {
<span class="nc bnc" id="L243" title="All 4 branches missed.">        if (!eventsHeld &amp;&amp; (maxQueueSize &gt; OVERLOADED_QUEUE)) {</span>
<span class="nc" id="L244">            eventController().hold();</span>
<span class="nc" id="L245">            eventsHeld = true;</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">        } else if (eventsHeld &amp;&amp; (maxQueueSize &lt; UNDERLOADED_QUEUE)) {</span>
<span class="nc" id="L247">            eventController().release();</span>
<span class="nc" id="L248">            eventsHeld = false;</span>
        }
<span class="nc" id="L250">    }</span>

    void notifyDequeueEventSet() {
<span class="nc" id="L253">        int maxQueueSize = 0;</span>
<span class="nc" id="L254">        synchronized(eventQueues) {</span>
<span class="nc" id="L255">            Iterator&lt;EventQueue&gt; iter = eventQueues.iterator();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L257">                EventQueueImpl queue = (EventQueueImpl)iter.next();</span>
<span class="nc" id="L258">                maxQueueSize = Math.max(maxQueueSize, queue.size());</span>
<span class="nc" id="L259">            }</span>
<span class="nc" id="L260">        }</span>
<span class="nc" id="L261">        controlEventFlow(maxQueueSize);</span>
<span class="nc" id="L262">    }</span>

    private void queueEventSet(EventSet eventSet) {
<span class="nc" id="L265">        int maxQueueSize = 0;</span>

<span class="nc" id="L267">        synchronized(eventQueues) {</span>
<span class="nc" id="L268">            Iterator&lt;EventQueue&gt; iter = eventQueues.iterator();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L270">                EventQueueImpl queue = (EventQueueImpl)iter.next();</span>
<span class="nc" id="L271">                queue.enqueue(eventSet);</span>
<span class="nc" id="L272">                maxQueueSize = Math.max(maxQueueSize, queue.size());</span>
<span class="nc" id="L273">            }</span>
<span class="nc" id="L274">        }</span>

<span class="nc" id="L276">        controlEventFlow(maxQueueSize);</span>
<span class="nc" id="L277">    }</span>

    void send(Packet packet) {
<span class="nc" id="L280">        String id = String.valueOf(packet.id);</span>

<span class="nc" id="L282">        synchronized(waitingQueue) {</span>
<span class="nc" id="L283">            waitingQueue.put(id, packet);</span>
<span class="nc" id="L284">        }</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">        if ((vm.traceFlags &amp; VirtualMachineImpl.TRACE_RAW_SENDS) != 0) {</span>
<span class="nc" id="L287">            dumpPacket(packet, true);</span>
        }

        try {
<span class="nc" id="L291">            connection.writePacket(packet.toByteArray());</span>
<span class="nc" id="L292">        } catch (IOException e) {</span>
<span class="nc" id="L293">            throw new VMDisconnectedException(e.getMessage());</span>
<span class="nc" id="L294">        }</span>
<span class="nc" id="L295">    }</span>

    void waitForReply(Packet packet) {
<span class="nc" id="L298">        synchronized(packet) {</span>
<span class="nc bnc" id="L299" title="All 4 branches missed.">            while ((!packet.replied) &amp;&amp; shouldListen) {</span>
<span class="nc" id="L300">                try { packet.wait(); } catch (InterruptedException e) {;}</span>
            }

<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (!packet.replied) {</span>
<span class="nc" id="L304">                throw new VMDisconnectedException();</span>
            }
<span class="nc" id="L306">        }</span>
<span class="nc" id="L307">    }</span>

    void addEventQueue(EventQueueImpl queue) {
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if ((vm.traceFlags &amp; VirtualMachine.TRACE_EVENTS) != 0) {</span>
<span class="nc" id="L311">            vm.printTrace(&quot;New event queue added&quot;);</span>
        }
<span class="nc" id="L313">        eventQueues.add(queue);</span>
<span class="nc" id="L314">    }</span>

    void stopListening() {
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if ((vm.traceFlags &amp; VirtualMachine.TRACE_EVENTS) != 0) {</span>
<span class="nc" id="L318">            vm.printTrace(&quot;Target VM i/f closing event queues&quot;);</span>
        }
<span class="nc" id="L320">        shouldListen = false;</span>
        try {
<span class="nc" id="L322">            connection.close();</span>
<span class="nc" id="L323">        } catch (IOException ioe) { }</span>
<span class="nc" id="L324">    }</span>

    static private class EventController extends Thread {
        VirtualMachineImpl vm;
<span class="nc" id="L328">        int controlRequest = 0;</span>

        EventController(VirtualMachineImpl vm) {
<span class="nc" id="L331">            super(vm.threadGroupForJDI(), &quot;JDI Event Control Thread&quot;);</span>
<span class="nc" id="L332">            this.vm = vm;</span>
<span class="nc" id="L333">            setDaemon(true);</span>
<span class="nc" id="L334">            setPriority((MAX_PRIORITY + NORM_PRIORITY)/2);</span>
<span class="nc" id="L335">            super.start();</span>
<span class="nc" id="L336">        }</span>

        synchronized void hold() {
<span class="nc" id="L339">            controlRequest++;</span>
<span class="nc" id="L340">            notifyAll();</span>
<span class="nc" id="L341">        }</span>

        synchronized void release() {
<span class="nc" id="L344">            controlRequest--;</span>
<span class="nc" id="L345">            notifyAll();</span>
<span class="nc" id="L346">        }</span>

        public void run() {
            while(true) {
                int currentRequest;
<span class="nc" id="L351">                synchronized(this) {</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                    while (controlRequest == 0) {</span>
<span class="nc" id="L353">                        try {wait();} catch (InterruptedException e) {}</span>
                    }
<span class="nc" id="L355">                    currentRequest = controlRequest;</span>
<span class="nc" id="L356">                    controlRequest = 0;</span>
<span class="nc" id="L357">                }</span>
                try {
<span class="nc bnc" id="L359" title="All 2 branches missed.">                    if (currentRequest &gt; 0) {</span>
<span class="nc" id="L360">                        JDWP.VirtualMachine.HoldEvents.process(vm);</span>
                    } else {
<span class="nc" id="L362">                        JDWP.VirtualMachine.ReleaseEvents.process(vm);</span>
                    }
<span class="nc" id="L364">                } catch (JDWPException e) {</span>
                    /*
                     * Don't want to terminate the thread, so the
                     * stack trace is printed and we continue.
                     */
<span class="nc" id="L369">                    e.toJDIException().printStackTrace(System.err);</span>
<span class="nc" id="L370">                }</span>
<span class="nc" id="L371">            }</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>