<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>EventRequestManagerImpl.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.tools.jdi</a> &gt; <span class="el_source">EventRequestManagerImpl.java</span></div><h1>EventRequestManagerImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1998, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.tools.jdi;

import com.sun.jdi.*;
import com.sun.jdi.request.*;
import com.sun.tools.jdi.JDWP;

import java.util.*;

/**
 * This interface is used to create and remove Breakpoints, Watchpoints,
 * etc.
 * It include implementations of all the request interfaces..
 */
// Warnings from List filters and List[] requestLists is  hard to fix.
// Remove SuppressWarning when we fix the warnings from List filters
// and List[] requestLists. The generic array is not supported.
@SuppressWarnings(&quot;unchecked&quot;)
class EventRequestManagerImpl extends MirrorImpl
                                       implements EventRequestManager
{
    List&lt;? extends EventRequest&gt;[] requestLists;
<span class="nc" id="L47">    private static int methodExitEventCmd = 0;</span>

    static int JDWPtoJDISuspendPolicy(byte jdwpPolicy) {
<span class="nc bnc" id="L50" title="All 4 branches missed.">        switch(jdwpPolicy) {</span>
            case JDWP.SuspendPolicy.ALL:
<span class="nc" id="L52">                return EventRequest.SUSPEND_ALL;</span>
            case JDWP.SuspendPolicy.EVENT_THREAD:
<span class="nc" id="L54">                return EventRequest.SUSPEND_EVENT_THREAD;</span>
        case JDWP.SuspendPolicy.NONE:
<span class="nc" id="L56">                return EventRequest.SUSPEND_NONE;</span>
            default:
<span class="nc" id="L58">                throw new IllegalArgumentException(&quot;Illegal policy constant: &quot; + jdwpPolicy);</span>
        }
    }

    static byte JDItoJDWPSuspendPolicy(int jdiPolicy) {
<span class="nc bnc" id="L63" title="All 4 branches missed.">        switch(jdiPolicy) {</span>
            case EventRequest.SUSPEND_ALL:
<span class="nc" id="L65">                return JDWP.SuspendPolicy.ALL;</span>
            case EventRequest.SUSPEND_EVENT_THREAD:
<span class="nc" id="L67">                return JDWP.SuspendPolicy.EVENT_THREAD;</span>
            case EventRequest.SUSPEND_NONE:
<span class="nc" id="L69">                return JDWP.SuspendPolicy.NONE;</span>
            default:
<span class="nc" id="L71">                throw new IllegalArgumentException(&quot;Illegal policy constant: &quot; + jdiPolicy);</span>
        }
    }

    /*
     * Override superclass back to default equality
     */
    public boolean equals(Object obj) {
<span class="nc bnc" id="L79" title="All 2 branches missed.">        return this == obj;</span>
    }

    public int hashCode() {
<span class="nc" id="L83">        return System.identityHashCode(this);</span>
    }

    abstract class EventRequestImpl extends MirrorImpl implements EventRequest {
        int id;

        /*
         * This list is not protected by a synchronized wrapper. All
         * access/modification should be protected by synchronizing on
         * the enclosing instance of EventRequestImpl.
         */
<span class="nc" id="L94">        List&lt;Object&gt; filters = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L96">        boolean isEnabled = false;</span>
<span class="nc" id="L97">        boolean deleted = false;</span>
<span class="nc" id="L98">        byte suspendPolicy = JDWP.SuspendPolicy.ALL;</span>
<span class="nc" id="L99">        private Map&lt;Object, Object&gt; clientProperties = null;</span>

<span class="nc" id="L101">        EventRequestImpl() {</span>
<span class="nc" id="L102">            super(EventRequestManagerImpl.this.vm);</span>
<span class="nc" id="L103">        }</span>


        /*
         * Override superclass back to default equality
         */
        public boolean equals(Object obj) {
<span class="nc bnc" id="L110" title="All 2 branches missed.">            return this == obj;</span>
        }

        public int hashCode() {
<span class="nc" id="L114">            return System.identityHashCode(this);</span>
        }

        abstract int eventCmd();

        InvalidRequestStateException invalidState() {
<span class="nc" id="L120">            return new InvalidRequestStateException(toString());</span>
        }

        String state() {
<span class="nc bnc" id="L124" title="All 2 branches missed.">            return deleted? &quot; (deleted)&quot; :</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                (isEnabled()? &quot; (enabled)&quot; : &quot; (disabled)&quot;);</span>
        }

        /**
         * @return all the event request of this kind
         */
        List requestList() {
<span class="nc" id="L132">            return EventRequestManagerImpl.this.requestList(eventCmd());</span>
        }

        /**
         * delete the event request
         */
        void delete() {
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (!deleted) {</span>
<span class="nc" id="L140">                requestList().remove(this);</span>
<span class="nc" id="L141">                disable(); /* must do BEFORE delete */</span>
<span class="nc" id="L142">                deleted = true;</span>
            }
<span class="nc" id="L144">        }</span>

        public boolean isEnabled() {
<span class="nc" id="L147">            return isEnabled;</span>
        }

        public void enable() {
<span class="nc" id="L151">            setEnabled(true);</span>
<span class="nc" id="L152">        }</span>

        public void disable() {
<span class="nc" id="L155">            setEnabled(false);</span>
<span class="nc" id="L156">        }</span>

        public synchronized void setEnabled(boolean val) {
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (deleted) {</span>
<span class="nc" id="L160">                throw invalidState();</span>
            } else {
<span class="nc bnc" id="L162" title="All 2 branches missed.">                if (val != isEnabled) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                    if (isEnabled) {</span>
<span class="nc" id="L164">                        clear();</span>
                    } else {
<span class="nc" id="L166">                        set();</span>
                    }
                }
            }
<span class="nc" id="L170">        }</span>

        public synchronized void addCountFilter(int count) {
<span class="nc bnc" id="L173" title="All 4 branches missed.">            if (isEnabled() || deleted) {</span>
<span class="nc" id="L174">                throw invalidState();</span>
            }
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (count &lt; 1) {</span>
<span class="nc" id="L177">                throw new IllegalArgumentException(&quot;count is less than one&quot;);</span>
            }
<span class="nc" id="L179">            filters.add(JDWP.EventRequest.Set.Modifier.Count.create(count));</span>
<span class="nc" id="L180">        }</span>

        public void setSuspendPolicy(int policy) {
<span class="nc bnc" id="L183" title="All 4 branches missed.">            if (isEnabled() || deleted) {</span>
<span class="nc" id="L184">                throw invalidState();</span>
            }
<span class="nc" id="L186">            suspendPolicy = JDItoJDWPSuspendPolicy(policy);</span>
<span class="nc" id="L187">        }</span>

        public int suspendPolicy() {
<span class="nc" id="L190">            return JDWPtoJDISuspendPolicy(suspendPolicy);</span>
        }

        /**
         * set (enable) the event request
         */
        synchronized void set() {
<span class="nc" id="L197">            JDWP.EventRequest.Set.Modifier[] mods =</span>
<span class="nc" id="L198">                filters.toArray(</span>
<span class="nc" id="L199">                    new JDWP.EventRequest.Set.Modifier[filters.size()]);</span>
            try {
<span class="nc" id="L201">                id = JDWP.EventRequest.Set.process(vm, (byte)eventCmd(),</span>
                                                   suspendPolicy, mods).requestID;
<span class="nc" id="L203">            } catch (JDWPException exc) {</span>
<span class="nc" id="L204">                throw exc.toJDIException();</span>
<span class="nc" id="L205">            }</span>
<span class="nc" id="L206">            isEnabled = true;</span>
<span class="nc" id="L207">        }</span>

        synchronized void clear() {
            try {
<span class="nc" id="L211">                JDWP.EventRequest.Clear.process(vm, (byte)eventCmd(), id);</span>
<span class="nc" id="L212">            } catch (JDWPException exc) {</span>
<span class="nc" id="L213">                throw exc.toJDIException();</span>
<span class="nc" id="L214">            }</span>
<span class="nc" id="L215">            isEnabled = false;</span>
<span class="nc" id="L216">        }</span>

        /**
         * @return a small Map
         * @see #putProperty
         * @see #getProperty
         */
        private Map&lt;Object, Object&gt; getProperties() {
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (clientProperties == null) {</span>
<span class="nc" id="L225">                clientProperties = new HashMap&lt;Object, Object&gt;(2);</span>
            }
<span class="nc" id="L227">            return clientProperties;</span>
        }

        /**
         * Returns the value of the property with the specified key.  Only
         * properties added with &lt;code&gt;putProperty&lt;/code&gt; will return
         * a non-null value.
         *
         * @return the value of this property or null
         * @see #putProperty
         */
        public final Object getProperty(Object key) {
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if (clientProperties == null) {</span>
<span class="nc" id="L240">                return null;</span>
            } else {
<span class="nc" id="L242">                return getProperties().get(key);</span>
            }
        }

        /**
         * Add an arbitrary key/value &quot;property&quot; to this component.
         *
         * @see #getProperty
         */
        public final void putProperty(Object key, Object value) {
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (value != null) {</span>
<span class="nc" id="L253">                getProperties().put(key, value);</span>
            } else {
<span class="nc" id="L255">                getProperties().remove(key);</span>
            }
<span class="nc" id="L257">        }</span>
    }

<span class="nc" id="L260">    abstract class ThreadVisibleEventRequestImpl extends EventRequestImpl {</span>
        public synchronized void addThreadFilter(ThreadReference thread) {
<span class="nc" id="L262">            validateMirror(thread);</span>
<span class="nc bnc" id="L263" title="All 4 branches missed.">            if (isEnabled() || deleted) {</span>
<span class="nc" id="L264">                throw invalidState();</span>
            }
<span class="nc" id="L266">            filters.add(JDWP.EventRequest.Set.Modifier.ThreadOnly</span>
<span class="nc" id="L267">                                      .create((ThreadReferenceImpl)thread));</span>
<span class="nc" id="L268">        }</span>
    }

<span class="nc" id="L271">    abstract class ClassVisibleEventRequestImpl</span>
                                  extends ThreadVisibleEventRequestImpl {
        public synchronized void addClassFilter(ReferenceType clazz) {
<span class="nc" id="L274">            validateMirror(clazz);</span>
<span class="nc bnc" id="L275" title="All 4 branches missed.">            if (isEnabled() || deleted) {</span>
<span class="nc" id="L276">                throw invalidState();</span>
            }
<span class="nc" id="L278">            filters.add(JDWP.EventRequest.Set.Modifier.ClassOnly</span>
<span class="nc" id="L279">                                      .create((ReferenceTypeImpl)clazz));</span>
<span class="nc" id="L280">        }</span>

        public synchronized void addClassFilter(String classPattern) {
<span class="nc bnc" id="L283" title="All 4 branches missed.">            if (isEnabled() || deleted) {</span>
<span class="nc" id="L284">                throw invalidState();</span>
            }
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (classPattern == null) {</span>
<span class="nc" id="L287">                throw new NullPointerException();</span>
            }
<span class="nc" id="L289">            filters.add(JDWP.EventRequest.Set.Modifier.ClassMatch</span>
<span class="nc" id="L290">                                      .create(classPattern));</span>
<span class="nc" id="L291">        }</span>

        public synchronized void addClassExclusionFilter(String classPattern) {
<span class="nc bnc" id="L294" title="All 4 branches missed.">            if (isEnabled() || deleted) {</span>
<span class="nc" id="L295">                throw invalidState();</span>
            }
<span class="nc bnc" id="L297" title="All 2 branches missed.">            if (classPattern == null) {</span>
<span class="nc" id="L298">                throw new NullPointerException();</span>
            }
<span class="nc" id="L300">            filters.add(JDWP.EventRequest.Set.Modifier.ClassExclude</span>
<span class="nc" id="L301">                                      .create(classPattern));</span>
<span class="nc" id="L302">        }</span>

        public synchronized void addInstanceFilter(ObjectReference instance) {
<span class="nc" id="L305">            validateMirror(instance);</span>
<span class="nc bnc" id="L306" title="All 4 branches missed.">            if (isEnabled() || deleted) {</span>
<span class="nc" id="L307">                throw invalidState();</span>
            }
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (!vm.canUseInstanceFilters()) {</span>
<span class="nc" id="L310">                throw new UnsupportedOperationException(</span>
                     &quot;target does not support instance filters&quot;);
            }
<span class="nc" id="L313">            filters.add(JDWP.EventRequest.Set.Modifier.InstanceOnly</span>
<span class="nc" id="L314">                                      .create((ObjectReferenceImpl)instance));</span>
<span class="nc" id="L315">        }</span>
    }

    class BreakpointRequestImpl extends ClassVisibleEventRequestImpl
                                     implements BreakpointRequest {
        private final Location location;

<span class="nc" id="L322">        BreakpointRequestImpl(Location location) {</span>
<span class="nc" id="L323">            this.location = location;</span>
<span class="nc" id="L324">            filters.add(0,JDWP.EventRequest.Set.Modifier.LocationOnly</span>
<span class="nc" id="L325">                                                 .create(location));</span>
<span class="nc" id="L326">            requestList().add(this);</span>
<span class="nc" id="L327">        }</span>

        public Location location() {
<span class="nc" id="L330">            return location;</span>
        }

        int eventCmd() {
<span class="nc" id="L334">            return JDWP.EventKind.BREAKPOINT;</span>
        }

        public String toString() {
<span class="nc" id="L338">            return &quot;breakpoint request &quot; + location() + state();</span>
        }
    }

    class ClassPrepareRequestImpl extends ClassVisibleEventRequestImpl
                                     implements ClassPrepareRequest {
<span class="nc" id="L344">        ClassPrepareRequestImpl() {</span>
<span class="nc" id="L345">            requestList().add(this);</span>
<span class="nc" id="L346">        }</span>

        int eventCmd() {
<span class="nc" id="L349">            return JDWP.EventKind.CLASS_PREPARE;</span>
        }

        public synchronized void addSourceNameFilter(String sourceNamePattern) {
<span class="nc bnc" id="L353" title="All 4 branches missed.">            if (isEnabled() || deleted) {</span>
<span class="nc" id="L354">                throw invalidState();</span>
            }
<span class="nc bnc" id="L356" title="All 2 branches missed.">            if (!vm.canUseSourceNameFilters()) {</span>
<span class="nc" id="L357">                throw new UnsupportedOperationException(</span>
                     &quot;target does not support source name filters&quot;);
            }
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (sourceNamePattern == null) {</span>
<span class="nc" id="L361">                throw new NullPointerException();</span>
            }

<span class="nc" id="L364">            filters.add(JDWP.EventRequest.Set.Modifier.SourceNameMatch</span>
<span class="nc" id="L365">                                      .create(sourceNamePattern));</span>
<span class="nc" id="L366">        }</span>

        public String toString() {
<span class="nc" id="L369">            return &quot;class prepare request &quot; + state();</span>
        }
    }

    class ClassUnloadRequestImpl extends ClassVisibleEventRequestImpl
                                     implements ClassUnloadRequest {
<span class="nc" id="L375">        ClassUnloadRequestImpl() {</span>
<span class="nc" id="L376">            requestList().add(this);</span>
<span class="nc" id="L377">        }</span>

        int eventCmd() {
<span class="nc" id="L380">            return JDWP.EventKind.CLASS_UNLOAD;</span>
        }

        public String toString() {
<span class="nc" id="L384">            return &quot;class unload request &quot; + state();</span>
        }
    }

    class ExceptionRequestImpl extends ClassVisibleEventRequestImpl
                                      implements ExceptionRequest {
<span class="nc" id="L390">        ReferenceType exception = null;</span>
<span class="nc" id="L391">        boolean caught = true;</span>
<span class="nc" id="L392">        boolean uncaught = true;</span>

        ExceptionRequestImpl(ReferenceType refType,
<span class="nc" id="L395">                          boolean notifyCaught, boolean notifyUncaught) {</span>
<span class="nc" id="L396">            exception = refType;</span>
<span class="nc" id="L397">            caught = notifyCaught;</span>
<span class="nc" id="L398">            uncaught = notifyUncaught;</span>
            {
                ReferenceTypeImpl exc;
<span class="nc bnc" id="L401" title="All 2 branches missed.">                if (exception == null) {</span>
<span class="nc" id="L402">                    exc = new ClassTypeImpl(vm, 0);</span>
                } else {
<span class="nc" id="L404">                    exc = (ReferenceTypeImpl)exception;</span>
                }
<span class="nc" id="L406">                filters.add(JDWP.EventRequest.Set.Modifier.ExceptionOnly.</span>
<span class="nc" id="L407">                            create(exc, caught, uncaught));</span>
            }
<span class="nc" id="L409">            requestList().add(this);</span>
<span class="nc" id="L410">        }</span>

        public ReferenceType exception() {
<span class="nc" id="L413">            return exception;</span>
        }

        public boolean notifyCaught() {
<span class="nc" id="L417">            return caught;</span>
        }

        public boolean notifyUncaught() {
<span class="nc" id="L421">            return uncaught;</span>
        }

        int eventCmd() {
<span class="nc" id="L425">            return JDWP.EventKind.EXCEPTION;</span>
        }

        public String toString() {
<span class="nc" id="L429">            return &quot;exception request &quot; + exception() + state();</span>
        }
    }

    class MethodEntryRequestImpl extends ClassVisibleEventRequestImpl
                                      implements MethodEntryRequest {
<span class="nc" id="L435">        MethodEntryRequestImpl() {</span>
<span class="nc" id="L436">            requestList().add(this);</span>
<span class="nc" id="L437">        }</span>

        int eventCmd() {
<span class="nc" id="L440">            return JDWP.EventKind.METHOD_ENTRY;</span>
        }

        public String toString() {
<span class="nc" id="L444">            return &quot;method entry request &quot; + state();</span>
        }
    }

    class MethodExitRequestImpl extends ClassVisibleEventRequestImpl
                                      implements MethodExitRequest {
<span class="nc" id="L450">        MethodExitRequestImpl() {</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">            if (methodExitEventCmd == 0) {</span>
                /*
                 * If we can get return values, then we always get them.
                 * Thus, for JDI MethodExitRequests, we always use the
                 * same JDWP EventKind.  Here we decide which to use and
                 * save it so that it will be used for all future
                 * MethodExitRequests.
                 *
                 * This call to canGetMethodReturnValues can't
                 * be done in the EventRequestManager ctor because that is too early.
                 */
<span class="nc bnc" id="L462" title="All 2 branches missed.">                if (vm.canGetMethodReturnValues()) {</span>
<span class="nc" id="L463">                    methodExitEventCmd = JDWP.EventKind.METHOD_EXIT_WITH_RETURN_VALUE;</span>
                } else {
<span class="nc" id="L465">                    methodExitEventCmd = JDWP.EventKind.METHOD_EXIT;</span>
                }
            }
<span class="nc" id="L468">            requestList().add(this);</span>
<span class="nc" id="L469">        }</span>

        int eventCmd() {
<span class="nc" id="L472">            return EventRequestManagerImpl.methodExitEventCmd;</span>
        }

        public String toString() {
<span class="nc" id="L476">            return &quot;method exit request &quot; + state();</span>
        }
    }

    class MonitorContendedEnterRequestImpl extends ClassVisibleEventRequestImpl
                                      implements MonitorContendedEnterRequest {
<span class="nc" id="L482">        MonitorContendedEnterRequestImpl() {</span>
<span class="nc" id="L483">            requestList().add(this);</span>
<span class="nc" id="L484">        }</span>

        int eventCmd() {
<span class="nc" id="L487">            return JDWP.EventKind.MONITOR_CONTENDED_ENTER;</span>
        }

        public String toString() {
<span class="nc" id="L491">            return &quot;monitor contended enter request &quot; + state();</span>
        }
    }

    class MonitorContendedEnteredRequestImpl extends ClassVisibleEventRequestImpl
                                      implements MonitorContendedEnteredRequest {
<span class="nc" id="L497">        MonitorContendedEnteredRequestImpl() {</span>
<span class="nc" id="L498">            requestList().add(this);</span>
<span class="nc" id="L499">        }</span>

        int eventCmd() {
<span class="nc" id="L502">            return JDWP.EventKind.MONITOR_CONTENDED_ENTERED;</span>
        }

        public String toString() {
<span class="nc" id="L506">            return &quot;monitor contended entered request &quot; + state();</span>
        }
    }

    class MonitorWaitRequestImpl extends ClassVisibleEventRequestImpl
                                 implements MonitorWaitRequest {
<span class="nc" id="L512">        MonitorWaitRequestImpl() {</span>
<span class="nc" id="L513">            requestList().add(this);</span>
<span class="nc" id="L514">        }</span>

        int eventCmd() {
<span class="nc" id="L517">            return JDWP.EventKind.MONITOR_WAIT;</span>
        }

        public String toString() {
<span class="nc" id="L521">            return &quot;monitor wait request &quot; + state();</span>
        }
    }

    class MonitorWaitedRequestImpl extends ClassVisibleEventRequestImpl
                                 implements MonitorWaitedRequest {
<span class="nc" id="L527">        MonitorWaitedRequestImpl() {</span>
<span class="nc" id="L528">            requestList().add(this);</span>
<span class="nc" id="L529">        }</span>

        int eventCmd() {
<span class="nc" id="L532">            return JDWP.EventKind.MONITOR_WAITED;</span>
        }

        public String toString() {
<span class="nc" id="L536">            return &quot;monitor waited request &quot; + state();</span>
        }
    }

    class StepRequestImpl extends ClassVisibleEventRequestImpl
                                      implements StepRequest {
        ThreadReferenceImpl thread;
        int size;
        int depth;

<span class="nc" id="L546">        StepRequestImpl(ThreadReference thread, int size, int depth) {</span>
<span class="nc" id="L547">            this.thread = (ThreadReferenceImpl)thread;</span>
<span class="nc" id="L548">            this.size = size;</span>
<span class="nc" id="L549">            this.depth = depth;</span>

            /*
             * Translate size and depth to corresponding JDWP values.
             */
            int jdwpSize;
<span class="nc bnc" id="L555" title="All 3 branches missed.">            switch (size) {</span>
                case STEP_MIN:
<span class="nc" id="L557">                    jdwpSize = JDWP.StepSize.MIN;</span>
<span class="nc" id="L558">                    break;</span>
                case STEP_LINE:
<span class="nc" id="L560">                    jdwpSize = JDWP.StepSize.LINE;</span>
<span class="nc" id="L561">                    break;</span>
                default:
<span class="nc" id="L563">                    throw new IllegalArgumentException(&quot;Invalid step size&quot;);</span>
            }

            int jdwpDepth;
<span class="nc bnc" id="L567" title="All 4 branches missed.">            switch (depth) {</span>
                case STEP_INTO:
<span class="nc" id="L569">                    jdwpDepth = JDWP.StepDepth.INTO;</span>
<span class="nc" id="L570">                    break;</span>
                case STEP_OVER:
<span class="nc" id="L572">                    jdwpDepth = JDWP.StepDepth.OVER;</span>
<span class="nc" id="L573">                    break;</span>
                case STEP_OUT:
<span class="nc" id="L575">                    jdwpDepth = JDWP.StepDepth.OUT;</span>
<span class="nc" id="L576">                    break;</span>
                default:
<span class="nc" id="L578">                    throw new IllegalArgumentException(&quot;Invalid step depth&quot;);</span>
            }

            /*
             * Make sure this isn't a duplicate
             */
<span class="nc" id="L584">            List&lt;StepRequest&gt; requests = stepRequests();</span>
<span class="nc" id="L585">            Iterator&lt;StepRequest&gt; iter = requests.iterator();</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L587">                StepRequest request = iter.next();</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">                if ((request != this) &amp;&amp;</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">                        request.isEnabled() &amp;&amp;</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">                        request.thread().equals(thread)) {</span>
<span class="nc" id="L591">                    throw new DuplicateRequestException(</span>
                        &quot;Only one step request allowed per thread&quot;);
                }
<span class="nc" id="L594">            }</span>

<span class="nc" id="L596">            filters.add(JDWP.EventRequest.Set.Modifier.Step.</span>
<span class="nc" id="L597">                        create(this.thread, jdwpSize, jdwpDepth));</span>
<span class="nc" id="L598">            requestList().add(this);</span>

<span class="nc" id="L600">        }</span>
        public int depth() {
<span class="nc" id="L602">            return depth;</span>
        }

        public int size() {
<span class="nc" id="L606">            return size;</span>
        }

        public ThreadReference thread() {
<span class="nc" id="L610">            return thread;</span>
        }

        int eventCmd() {
<span class="nc" id="L614">            return JDWP.EventKind.SINGLE_STEP;</span>
        }

        public String toString() {
<span class="nc" id="L618">            return &quot;step request &quot; + thread() + state();</span>
        }
    }

    class ThreadDeathRequestImpl extends ThreadVisibleEventRequestImpl
                                      implements ThreadDeathRequest {
<span class="nc" id="L624">        ThreadDeathRequestImpl() {</span>
<span class="nc" id="L625">            requestList().add(this);</span>
<span class="nc" id="L626">        }</span>

        int eventCmd() {
<span class="nc" id="L629">            return JDWP.EventKind.THREAD_DEATH;</span>
        }

        public String toString() {
<span class="nc" id="L633">            return &quot;thread death request &quot; + state();</span>
        }
    }

    class ThreadStartRequestImpl extends ThreadVisibleEventRequestImpl
                                      implements ThreadStartRequest {
<span class="nc" id="L639">        ThreadStartRequestImpl() {</span>
<span class="nc" id="L640">            requestList().add(this);</span>
<span class="nc" id="L641">        }</span>

        int eventCmd() {
<span class="nc" id="L644">            return JDWP.EventKind.THREAD_START;</span>
        }

        public String toString() {
<span class="nc" id="L648">            return &quot;thread start request &quot; + state();</span>
        }
    }

    abstract class WatchpointRequestImpl extends ClassVisibleEventRequestImpl
                                      implements WatchpointRequest {
        final Field field;

<span class="nc" id="L656">        WatchpointRequestImpl(Field field) {</span>
<span class="nc" id="L657">            this.field = field;</span>
<span class="nc" id="L658">            filters.add(0,</span>
<span class="nc" id="L659">                   JDWP.EventRequest.Set.Modifier.FieldOnly.create(</span>
<span class="nc" id="L660">                    (ReferenceTypeImpl)field.declaringType(),</span>
<span class="nc" id="L661">                    ((FieldImpl)field).ref()));</span>
<span class="nc" id="L662">        }</span>

        public Field field() {
<span class="nc" id="L665">            return field;</span>
        }
    }

    class AccessWatchpointRequestImpl extends WatchpointRequestImpl
                                  implements AccessWatchpointRequest {
<span class="nc" id="L671">        AccessWatchpointRequestImpl(Field field) {</span>
<span class="nc" id="L672">            super(field);</span>
<span class="nc" id="L673">            requestList().add(this);</span>
<span class="nc" id="L674">        }</span>

        int eventCmd() {
<span class="nc" id="L677">            return JDWP.EventKind.FIELD_ACCESS;</span>
        }

        public String toString() {
<span class="nc" id="L681">            return &quot;access watchpoint request &quot; + field + state();</span>
        }
    }

    class ModificationWatchpointRequestImpl extends WatchpointRequestImpl
                                  implements ModificationWatchpointRequest {
<span class="nc" id="L687">        ModificationWatchpointRequestImpl(Field field) {</span>
<span class="nc" id="L688">            super(field);</span>
<span class="nc" id="L689">            requestList().add(this);</span>
<span class="nc" id="L690">        }</span>

        int eventCmd() {
<span class="nc" id="L693">            return JDWP.EventKind.FIELD_MODIFICATION;</span>
        }

        public String toString() {
<span class="nc" id="L697">            return &quot;modification watchpoint request &quot; + field + state();</span>
        }
    }

    class VMDeathRequestImpl extends EventRequestImpl
                                        implements VMDeathRequest {
<span class="nc" id="L703">        VMDeathRequestImpl() {</span>
<span class="nc" id="L704">            requestList().add(this);</span>
<span class="nc" id="L705">        }</span>

        int eventCmd() {
<span class="nc" id="L708">            return JDWP.EventKind.VM_DEATH;</span>
        }

        public String toString() {
<span class="nc" id="L712">            return &quot;VM death request &quot; + state();</span>
        }
    }

    /**
     * Constructor.
     */
    EventRequestManagerImpl(VirtualMachine vm) {
<span class="nc" id="L720">        super(vm);</span>
<span class="nc" id="L721">        java.lang.reflect.Field[] ekinds =</span>
<span class="nc" id="L722">            JDWP.EventKind.class.getDeclaredFields();</span>
<span class="nc" id="L723">        int highest = 0;</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">        for (int i = 0; i &lt; ekinds.length; ++i) {</span>
            int val;
            try {
<span class="nc" id="L727">                val = ekinds[i].getInt(null);</span>
<span class="nc" id="L728">            } catch (IllegalAccessException exc) {</span>
<span class="nc" id="L729">                throw new RuntimeException(&quot;Got: &quot; + exc);</span>
<span class="nc" id="L730">            }</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">            if (val &gt; highest) {</span>
<span class="nc" id="L732">                highest = val;</span>
            }
        }
<span class="nc" id="L735">        requestLists = new List[highest+1];</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">        for (int i=0; i &lt;= highest; i++) {</span>
<span class="nc" id="L737">            requestLists[i] = new ArrayList&lt;&gt;();</span>
        }
<span class="nc" id="L739">    }</span>

    public ClassPrepareRequest createClassPrepareRequest() {
<span class="nc" id="L742">        return new ClassPrepareRequestImpl();</span>
    }

    public ClassUnloadRequest createClassUnloadRequest() {
<span class="nc" id="L746">        return new ClassUnloadRequestImpl();</span>
    }

    public ExceptionRequest createExceptionRequest(ReferenceType refType,
                                                   boolean notifyCaught,
                                                   boolean notifyUncaught) {
<span class="nc" id="L752">        validateMirrorOrNull(refType);</span>
<span class="nc" id="L753">        return new ExceptionRequestImpl(refType, notifyCaught, notifyUncaught);</span>
    }

    public StepRequest createStepRequest(ThreadReference thread,
                                         int size, int depth) {
<span class="nc" id="L758">        validateMirror(thread);</span>
<span class="nc" id="L759">        return new StepRequestImpl(thread, size, depth);</span>
    }

    public ThreadDeathRequest createThreadDeathRequest() {
<span class="nc" id="L763">        return new ThreadDeathRequestImpl();</span>
    }

    public ThreadStartRequest createThreadStartRequest() {
<span class="nc" id="L767">        return new ThreadStartRequestImpl();</span>
    }

    public MethodEntryRequest createMethodEntryRequest() {
<span class="nc" id="L771">        return new MethodEntryRequestImpl();</span>
    }

    public MethodExitRequest createMethodExitRequest() {
<span class="nc" id="L775">        return new MethodExitRequestImpl();</span>
    }

    public MonitorContendedEnterRequest createMonitorContendedEnterRequest() {
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (!vm.canRequestMonitorEvents()) {</span>
<span class="nc" id="L780">            throw new UnsupportedOperationException(</span>
          &quot;target VM does not support requesting Monitor events&quot;);
        }
<span class="nc" id="L783">        return new MonitorContendedEnterRequestImpl();</span>
    }

    public MonitorContendedEnteredRequest createMonitorContendedEnteredRequest() {
<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (!vm.canRequestMonitorEvents()) {</span>
<span class="nc" id="L788">            throw new UnsupportedOperationException(</span>
          &quot;target VM does not support requesting Monitor events&quot;);
        }
<span class="nc" id="L791">        return new MonitorContendedEnteredRequestImpl();</span>
    }

    public MonitorWaitRequest createMonitorWaitRequest() {
<span class="nc bnc" id="L795" title="All 2 branches missed.">        if (!vm.canRequestMonitorEvents()) {</span>
<span class="nc" id="L796">            throw new UnsupportedOperationException(</span>
          &quot;target VM does not support requesting Monitor events&quot;);
        }
<span class="nc" id="L799">        return new MonitorWaitRequestImpl();</span>
    }

    public MonitorWaitedRequest createMonitorWaitedRequest() {
<span class="nc bnc" id="L803" title="All 2 branches missed.">        if (!vm.canRequestMonitorEvents()) {</span>
<span class="nc" id="L804">            throw new UnsupportedOperationException(</span>
          &quot;target VM does not support requesting Monitor events&quot;);
        }
<span class="nc" id="L807">        return new MonitorWaitedRequestImpl();</span>
    }

    public BreakpointRequest createBreakpointRequest(Location location) {
<span class="nc" id="L811">        validateMirror(location);</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">        if (location.codeIndex() == -1) {</span>
<span class="nc" id="L813">            throw new NativeMethodException(&quot;Cannot set breakpoints on native methods&quot;);</span>
        }
<span class="nc" id="L815">        return new BreakpointRequestImpl(location);</span>
    }

    public AccessWatchpointRequest
                              createAccessWatchpointRequest(Field field) {
<span class="nc" id="L820">        validateMirror(field);</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">        if (!vm.canWatchFieldAccess()) {</span>
<span class="nc" id="L822">            throw new UnsupportedOperationException(</span>
          &quot;target VM does not support access watchpoints&quot;);
        }
<span class="nc" id="L825">        return new AccessWatchpointRequestImpl(field);</span>
    }

    public ModificationWatchpointRequest
                        createModificationWatchpointRequest(Field field) {
<span class="nc" id="L830">        validateMirror(field);</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">        if (!vm.canWatchFieldModification()) {</span>
<span class="nc" id="L832">            throw new UnsupportedOperationException(</span>
          &quot;target VM does not support modification watchpoints&quot;);
        }
<span class="nc" id="L835">        return new ModificationWatchpointRequestImpl(field);</span>
    }

    public VMDeathRequest createVMDeathRequest() {
<span class="nc bnc" id="L839" title="All 2 branches missed.">        if (!vm.canRequestVMDeathEvent()) {</span>
<span class="nc" id="L840">            throw new UnsupportedOperationException(</span>
          &quot;target VM does not support requesting VM death events&quot;);
        }
<span class="nc" id="L843">        return new VMDeathRequestImpl();</span>
    }

    public void deleteEventRequest(EventRequest eventRequest) {
<span class="nc" id="L847">        validateMirror(eventRequest);</span>
<span class="nc" id="L848">        ((EventRequestImpl)eventRequest).delete();</span>
<span class="nc" id="L849">    }</span>

    public void deleteEventRequests(List&lt;? extends EventRequest&gt; eventRequests) {
<span class="nc" id="L852">        validateMirrors(eventRequests);</span>
        // copy the eventRequests to avoid ConcurrentModificationException
<span class="nc" id="L854">        Iterator&lt;? extends EventRequest&gt; iter = (new ArrayList&lt;&gt;(eventRequests)).iterator();</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">        while (iter.hasNext()) {</span>
<span class="nc" id="L856">            ((EventRequestImpl)iter.next()).delete();</span>
        }
<span class="nc" id="L858">    }</span>

    public void deleteAllBreakpoints() {
<span class="nc" id="L861">        requestList(JDWP.EventKind.BREAKPOINT).clear();</span>

        try {
<span class="nc" id="L864">            JDWP.EventRequest.ClearAllBreakpoints.process(vm);</span>
<span class="nc" id="L865">        } catch (JDWPException exc) {</span>
<span class="nc" id="L866">            throw exc.toJDIException();</span>
<span class="nc" id="L867">        }</span>
<span class="nc" id="L868">    }</span>

    public List&lt;StepRequest&gt; stepRequests() {
<span class="nc" id="L871">        return (List&lt;StepRequest&gt;)unmodifiableRequestList(JDWP.EventKind.SINGLE_STEP);</span>
    }

    public List&lt;ClassPrepareRequest&gt; classPrepareRequests() {
<span class="nc" id="L875">        return (List&lt;ClassPrepareRequest&gt;)unmodifiableRequestList(JDWP.EventKind.CLASS_PREPARE);</span>
    }

    public List&lt;ClassUnloadRequest&gt; classUnloadRequests() {
<span class="nc" id="L879">        return (List&lt;ClassUnloadRequest&gt;)unmodifiableRequestList(JDWP.EventKind.CLASS_UNLOAD);</span>
    }

    public List&lt;ThreadStartRequest&gt; threadStartRequests() {
<span class="nc" id="L883">        return (List&lt;ThreadStartRequest&gt;)unmodifiableRequestList(JDWP.EventKind.THREAD_START);</span>
    }

    public List&lt;ThreadDeathRequest&gt; threadDeathRequests() {
<span class="nc" id="L887">        return (List&lt;ThreadDeathRequest&gt;)unmodifiableRequestList(JDWP.EventKind.THREAD_DEATH);</span>
    }

    public List&lt;ExceptionRequest&gt; exceptionRequests() {
<span class="nc" id="L891">        return (List&lt;ExceptionRequest&gt;)unmodifiableRequestList(JDWP.EventKind.EXCEPTION);</span>
    }

    public List&lt;BreakpointRequest&gt; breakpointRequests() {
<span class="nc" id="L895">        return (List&lt;BreakpointRequest&gt;)unmodifiableRequestList(JDWP.EventKind.BREAKPOINT);</span>
    }

    public List&lt;AccessWatchpointRequest&gt; accessWatchpointRequests() {
<span class="nc" id="L899">        return (List&lt;AccessWatchpointRequest&gt;)unmodifiableRequestList(JDWP.EventKind.FIELD_ACCESS);</span>
    }

    public List&lt;ModificationWatchpointRequest&gt; modificationWatchpointRequests() {
<span class="nc" id="L903">        return (List&lt;ModificationWatchpointRequest&gt;)unmodifiableRequestList(JDWP.EventKind.FIELD_MODIFICATION);</span>
    }

    public List&lt;MethodEntryRequest&gt; methodEntryRequests() {
<span class="nc" id="L907">        return (List&lt;MethodEntryRequest&gt;)unmodifiableRequestList(JDWP.EventKind.METHOD_ENTRY);</span>
    }

    public List&lt;MethodExitRequest&gt; methodExitRequests() {
<span class="nc" id="L911">        return (List&lt;MethodExitRequest&gt;)unmodifiableRequestList(</span>
                               EventRequestManagerImpl.methodExitEventCmd);
    }

    public List&lt;MonitorContendedEnterRequest&gt; monitorContendedEnterRequests() {
<span class="nc" id="L916">        return (List&lt;MonitorContendedEnterRequest&gt;)unmodifiableRequestList(JDWP.EventKind.MONITOR_CONTENDED_ENTER);</span>
    }

    public List&lt;MonitorContendedEnteredRequest&gt; monitorContendedEnteredRequests() {
<span class="nc" id="L920">        return (List&lt;MonitorContendedEnteredRequest&gt;)unmodifiableRequestList(JDWP.EventKind.MONITOR_CONTENDED_ENTERED);</span>
    }

    public List&lt;MonitorWaitRequest&gt; monitorWaitRequests() {
<span class="nc" id="L924">        return (List&lt;MonitorWaitRequest&gt;)unmodifiableRequestList(JDWP.EventKind.MONITOR_WAIT);</span>
    }

    public List&lt;MonitorWaitedRequest&gt; monitorWaitedRequests() {
<span class="nc" id="L928">        return (List&lt;MonitorWaitedRequest&gt;)unmodifiableRequestList(JDWP.EventKind.MONITOR_WAITED);</span>
    }

    public List&lt;VMDeathRequest&gt; vmDeathRequests() {
<span class="nc" id="L932">        return (List&lt;VMDeathRequest&gt;)unmodifiableRequestList(JDWP.EventKind.VM_DEATH);</span>
    }

    List&lt;? extends EventRequest&gt; unmodifiableRequestList(int eventCmd) {
<span class="nc" id="L936">        return Collections.unmodifiableList(requestList(eventCmd));</span>
    }

    EventRequest request(int eventCmd, int requestId) {
<span class="nc" id="L940">        List&lt;? extends EventRequest&gt; rl = requestList(eventCmd);</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">        for (int i = rl.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L942">            EventRequestImpl er = (EventRequestImpl)rl.get(i);</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">            if (er.id == requestId) {</span>
<span class="nc" id="L944">                return er;</span>
            }
        }
<span class="nc" id="L947">        return null;</span>
    }

    List&lt;? extends EventRequest&gt;  requestList(int eventCmd) {
<span class="nc" id="L951">        return requestLists[eventCmd];</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>