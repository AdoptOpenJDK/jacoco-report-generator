<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SDE.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.tools.jdi</a> &gt; <span class="el_source">SDE.java</span></div><h1>SDE.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2001, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.tools.jdi;

import com.sun.jdi.*;

import java.util.*;
import java.io.File;

class SDE {
    private static final int INIT_SIZE_FILE = 3;
    private static final int INIT_SIZE_LINE = 100;
    private static final int INIT_SIZE_STRATUM = 3;

    static final String BASE_STRATUM_NAME = &quot;Java&quot;;

    /* for C capatibility */
<span class="nc" id="L41">    static final String NullString = null;</span>

<span class="nc" id="L43">    private class FileTableRecord {</span>
        int fileId;
        String sourceName;
        String sourcePath; // do not read - use accessor
<span class="nc" id="L47">        boolean isConverted = false;</span>

        /**
         * Return the sourcePath, computing it if not set.
         * If set, convert '/' in the sourcePath to the
         * local file separator.
         */
        String getSourcePath(ReferenceTypeImpl refType) {
<span class="nc bnc" id="L55" title="All 2 branches missed.">            if (!isConverted) {</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">                if (sourcePath == null) {</span>
<span class="nc" id="L57">                    sourcePath = refType.baseSourceDir() + sourceName;</span>
                } else {
<span class="nc" id="L59">                    StringBuffer buf = new StringBuffer();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">                    for (int i = 0; i &lt; sourcePath.length(); ++i) {</span>
<span class="nc" id="L61">                        char ch = sourcePath.charAt(i);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">                        if (ch == '/') {</span>
<span class="nc" id="L63">                            buf.append(File.separatorChar);</span>
                        } else {
<span class="nc" id="L65">                            buf.append(ch);</span>
                        }
                    }
<span class="nc" id="L68">                    sourcePath = buf.toString();</span>
                }
<span class="nc" id="L70">                isConverted = true;</span>
            }
<span class="nc" id="L72">            return sourcePath;</span>
        }
    }

<span class="nc" id="L76">    private class LineTableRecord {</span>
        int jplsStart;
        int jplsEnd;
        int jplsLineInc;
        int njplsStart;
        int njplsEnd;
        int fileId;
    }

<span class="nc" id="L85">    private class StratumTableRecord {</span>
        String id;
        int fileIndex;
        int lineIndex;
    }

    class Stratum {
        private final int sti; /* stratum index */

<span class="nc" id="L94">        private Stratum(int sti) {</span>
<span class="nc" id="L95">            this.sti = sti;</span>
<span class="nc" id="L96">        }</span>

        String id() {
<span class="nc" id="L99">            return stratumTable[sti].id;</span>
        }

        boolean isJava() {
<span class="nc bnc" id="L103" title="All 2 branches missed.">            return sti == baseStratumIndex;</span>
        }

        /**
         * Return all the sourceNames for this stratum.
         * Look from our starting fileIndex upto the starting
         * fileIndex of next stratum - can do this since there
         * is always a terminator stratum.
         * Default sourceName (the first one) must be first.
         */
        List&lt;String&gt; sourceNames(ReferenceTypeImpl refType) {
            int i;
<span class="nc" id="L115">            int fileIndexStart = stratumTable[sti].fileIndex;</span>
            /* one past end */
<span class="nc" id="L117">            int fileIndexEnd = stratumTable[sti+1].fileIndex;</span>
<span class="nc" id="L118">            List&lt;String&gt; result = new ArrayList&lt;String&gt;(fileIndexEnd - fileIndexStart);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            for (i = fileIndexStart; i &lt; fileIndexEnd; ++i) {</span>
<span class="nc" id="L120">                result.add(fileTable[i].sourceName);</span>
            }
<span class="nc" id="L122">            return result;</span>
        }

        /**
         * Return all the sourcePaths for this stratum.
         * Look from our starting fileIndex upto the starting
         * fileIndex of next stratum - can do this since there
         * is always a terminator stratum.
         * Default sourcePath (the first one) must be first.
         */
        List&lt;String&gt; sourcePaths(ReferenceTypeImpl refType) {
            int i;
<span class="nc" id="L134">            int fileIndexStart = stratumTable[sti].fileIndex;</span>
            /* one past end */
<span class="nc" id="L136">            int fileIndexEnd = stratumTable[sti+1].fileIndex;</span>
<span class="nc" id="L137">            List&lt;String&gt; result = new ArrayList&lt;String&gt;(fileIndexEnd - fileIndexStart);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            for (i = fileIndexStart; i &lt; fileIndexEnd; ++i) {</span>
<span class="nc" id="L139">                result.add(fileTable[i].getSourcePath(refType));</span>
            }
<span class="nc" id="L141">            return result;</span>
        }

        LineStratum lineStratum(ReferenceTypeImpl refType,
                                int jplsLine) {
<span class="nc" id="L146">            int lti = stiLineTableIndex(sti, jplsLine);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (lti &lt; 0) {</span>
<span class="nc" id="L148">                return null;</span>
            } else {
<span class="nc" id="L150">                return new LineStratum(sti, lti, refType,</span>
                                       jplsLine);
            }
        }
    }

    class LineStratum {
        private final int sti; /* stratum index */
        private final int lti; /* line table index */
        private final ReferenceTypeImpl refType;
        private final int jplsLine;
<span class="nc" id="L161">        private String sourceName = null;</span>
<span class="nc" id="L162">        private String sourcePath = null;</span>

        private LineStratum(int sti, int lti,
                            ReferenceTypeImpl refType,
<span class="nc" id="L166">                            int jplsLine) {</span>
<span class="nc" id="L167">            this.sti = sti;</span>
<span class="nc" id="L168">            this.lti = lti;</span>
<span class="nc" id="L169">            this.refType = refType;</span>
<span class="nc" id="L170">            this.jplsLine = jplsLine;</span>
<span class="nc" id="L171">        }</span>

        public boolean equals(Object obj) {
<span class="nc bnc" id="L174" title="All 2 branches missed.">            if (obj instanceof LineStratum) {</span>
<span class="nc" id="L175">                LineStratum other = (LineStratum)obj;</span>
<span class="nc bnc" id="L176" title="All 4 branches missed.">                return (lti == other.lti) &amp;&amp;</span>
                       (sti == other.sti) &amp;&amp;
<span class="nc bnc" id="L178" title="All 2 branches missed.">                       (lineNumber() == other.lineNumber()) &amp;&amp;</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                       (refType.equals(other.refType));</span>
            } else {
<span class="nc" id="L181">                return false;</span>
            }
        }

        @Override
        public int hashCode() {
<span class="nc" id="L187">            return (lineNumber() * 17) ^ refType.hashCode();</span>
        }

        int lineNumber() {
<span class="nc" id="L191">            return stiLineNumber(sti, lti, jplsLine);</span>
        }

        /**
         * Fetch the source name and source path for
         * this line, converting or constructing
         * the source path if needed.
         */
        void getSourceInfo() {
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (sourceName != null) {</span>
                // already done
<span class="nc" id="L202">                return;</span>
            }
<span class="nc" id="L204">            int fti = stiFileTableIndex(sti, lti);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">            if (fti == -1) {</span>
<span class="nc" id="L206">                throw new InternalError(</span>
              &quot;Bad SourceDebugExtension, no matching source id &quot; +
<span class="nc" id="L208">              lineTable[lti].fileId + &quot; jplsLine: &quot; + jplsLine);</span>
            }
<span class="nc" id="L210">            FileTableRecord ftr = fileTable[fti];</span>
<span class="nc" id="L211">            sourceName = ftr.sourceName;</span>
<span class="nc" id="L212">            sourcePath = ftr.getSourcePath(refType);</span>
<span class="nc" id="L213">        }</span>

        String sourceName() {
<span class="nc" id="L216">            getSourceInfo();</span>
<span class="nc" id="L217">            return sourceName;</span>
        }

        String sourcePath() {
<span class="nc" id="L221">            getSourceInfo();</span>
<span class="nc" id="L222">            return sourcePath;</span>
        }
    }

<span class="nc" id="L226">    private FileTableRecord[] fileTable = null;</span>
<span class="nc" id="L227">    private LineTableRecord[] lineTable = null;</span>
<span class="nc" id="L228">    private StratumTableRecord[] stratumTable = null;</span>

<span class="nc" id="L230">    private int fileIndex = 0;</span>
<span class="nc" id="L231">    private int lineIndex = 0;</span>
<span class="nc" id="L232">    private int stratumIndex = 0;</span>
<span class="nc" id="L233">    private int currentFileId = 0;</span>

<span class="nc" id="L235">    private int defaultStratumIndex = -1;</span>
<span class="nc" id="L236">    private int baseStratumIndex = -2; /* so as not to match -1 above */</span>
<span class="nc" id="L237">    private int sdePos = 0;</span>

    final String sourceDebugExtension;
<span class="nc" id="L240">    String jplsFilename = null;</span>
<span class="nc" id="L241">    String defaultStratumId = null;</span>
<span class="nc" id="L242">    boolean isValid = false;</span>

<span class="nc" id="L244">    SDE(String sourceDebugExtension) {</span>
<span class="nc" id="L245">        this.sourceDebugExtension = sourceDebugExtension;</span>
<span class="nc" id="L246">        decode();</span>
<span class="nc" id="L247">    }</span>

<span class="nc" id="L249">    SDE() {</span>
<span class="nc" id="L250">        this.sourceDebugExtension = null;</span>
<span class="nc" id="L251">        createProxyForAbsentSDE();</span>
<span class="nc" id="L252">    }</span>

    char sdePeek() {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (sdePos &gt;= sourceDebugExtension.length()) {</span>
<span class="nc" id="L256">            syntax();</span>
        }
<span class="nc" id="L258">        return sourceDebugExtension.charAt(sdePos);</span>
    }

    char sdeRead() {
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (sdePos &gt;= sourceDebugExtension.length()) {</span>
<span class="nc" id="L263">            syntax();</span>
        }
<span class="nc" id="L265">        return sourceDebugExtension.charAt(sdePos++);</span>
    }

    void sdeAdvance() {
<span class="nc" id="L269">        sdePos++;</span>
<span class="nc" id="L270">    }</span>

    void syntax() {
<span class="nc" id="L273">        throw new InternalError(&quot;bad SourceDebugExtension syntax - position &quot; +</span>
                                sdePos);
    }

    void syntax(String msg) {
<span class="nc" id="L278">        throw new InternalError(&quot;bad SourceDebugExtension syntax: &quot; + msg);</span>
    }

    void assureLineTableSize() {
<span class="nc bnc" id="L282" title="All 2 branches missed.">        int len = lineTable == null? 0 : lineTable.length;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (lineIndex &gt;= len) {</span>
            int i;
<span class="nc bnc" id="L285" title="All 2 branches missed.">            int newLen = len == 0? INIT_SIZE_LINE : len * 2;</span>
<span class="nc" id="L286">            LineTableRecord[] newTable = new LineTableRecord[newLen];</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">            for (i = 0; i &lt; len; ++i) {</span>
<span class="nc" id="L288">                newTable[i] = lineTable[i];</span>
            }
<span class="nc bnc" id="L290" title="All 2 branches missed.">            for (; i &lt; newLen; ++i) {</span>
<span class="nc" id="L291">                newTable[i] = new LineTableRecord();</span>
            }
<span class="nc" id="L293">            lineTable = newTable;</span>
        }
<span class="nc" id="L295">    }</span>

    void assureFileTableSize() {
<span class="nc bnc" id="L298" title="All 2 branches missed.">        int len = fileTable == null? 0 : fileTable.length;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (fileIndex &gt;= len) {</span>
            int i;
<span class="nc bnc" id="L301" title="All 2 branches missed.">            int newLen = len == 0? INIT_SIZE_FILE : len * 2;</span>
<span class="nc" id="L302">            FileTableRecord[] newTable = new FileTableRecord[newLen];</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            for (i = 0; i &lt; len; ++i) {</span>
<span class="nc" id="L304">                newTable[i] = fileTable[i];</span>
            }
<span class="nc bnc" id="L306" title="All 2 branches missed.">            for (; i &lt; newLen; ++i) {</span>
<span class="nc" id="L307">                newTable[i] = new FileTableRecord();</span>
            }
<span class="nc" id="L309">            fileTable = newTable;</span>
        }
<span class="nc" id="L311">    }</span>

    void assureStratumTableSize() {
<span class="nc bnc" id="L314" title="All 2 branches missed.">        int len = stratumTable == null? 0 : stratumTable.length;</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (stratumIndex &gt;= len) {</span>
            int i;
<span class="nc bnc" id="L317" title="All 2 branches missed.">            int newLen = len == 0? INIT_SIZE_STRATUM : len * 2;</span>
<span class="nc" id="L318">            StratumTableRecord[] newTable = new StratumTableRecord[newLen];</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            for (i = 0; i &lt; len; ++i) {</span>
<span class="nc" id="L320">                newTable[i] = stratumTable[i];</span>
            }
<span class="nc bnc" id="L322" title="All 2 branches missed.">            for (; i &lt; newLen; ++i) {</span>
<span class="nc" id="L323">                newTable[i] = new StratumTableRecord();</span>
            }
<span class="nc" id="L325">            stratumTable = newTable;</span>
        }
<span class="nc" id="L327">    }</span>

    String readLine() {
<span class="nc" id="L330">        StringBuffer sb = new StringBuffer();</span>
        char ch;

<span class="nc" id="L333">        ignoreWhite();</span>
<span class="nc bnc" id="L334" title="All 4 branches missed.">        while (((ch = sdeRead()) != '\n') &amp;&amp; (ch != '\r')) {</span>
<span class="nc" id="L335">            sb.append(ch);</span>
        }
        // check for CR LF
<span class="nc bnc" id="L338" title="All 4 branches missed.">        if ((ch == '\r') &amp;&amp; (sdePeek() == '\n')) {</span>
<span class="nc" id="L339">            sdeRead();</span>
        }
<span class="nc" id="L341">        ignoreWhite(); // leading white</span>
<span class="nc" id="L342">        return sb.toString();</span>
    }

    private int defaultStratumTableIndex() {
<span class="nc bnc" id="L346" title="All 4 branches missed.">        if ((defaultStratumIndex == -1) &amp;&amp; (defaultStratumId != null)) {</span>
<span class="nc" id="L347">            defaultStratumIndex =</span>
<span class="nc" id="L348">                stratumTableIndex(defaultStratumId);</span>
        }
<span class="nc" id="L350">        return defaultStratumIndex;</span>
    }

    int stratumTableIndex(String stratumId) {
        int i;

<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (stratumId == null) {</span>
<span class="nc" id="L357">            return defaultStratumTableIndex();</span>
        }
<span class="nc bnc" id="L359" title="All 2 branches missed.">        for (i = 0; i &lt; (stratumIndex-1); ++i) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (stratumTable[i].id.equals(stratumId)) {</span>
<span class="nc" id="L361">                return i;</span>
            }
        }
<span class="nc" id="L364">        return defaultStratumTableIndex();</span>
    }

    Stratum stratum(String stratumID) {
<span class="nc" id="L368">        int sti = stratumTableIndex(stratumID);</span>
<span class="nc" id="L369">        return new Stratum(sti);</span>
    }

    List&lt;String&gt; availableStrata() {
<span class="nc" id="L373">        List&lt;String&gt; strata = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L375" title="All 2 branches missed.">        for (int i = 0; i &lt; (stratumIndex-1); ++i) {</span>
<span class="nc" id="L376">            StratumTableRecord rec = stratumTable[i];</span>
<span class="nc" id="L377">            strata.add(rec.id);</span>
        }
<span class="nc" id="L379">        return strata;</span>
    }

/*****************************
 * below functions/methods are written to compile under either Java or C
 *
 * Needed support functions:
 *   sdePeek()
 *   sdeRead()
 *   sdeAdvance()
 *   readLine()
 *   assureLineTableSize()
 *   assureFileTableSize()
 *   assureStratumTableSize()
 *   syntax()
 *
 *   stratumTableIndex(String)
 *
 * Needed support variables:
 *   lineTable
 *   lineIndex
 *   fileTable
 *   fileIndex
 *   currentFileId
 *
 * Needed types:
 *   String
 *
 * Needed constants:
 *   NullString
 */

    void ignoreWhite() {
        char ch;

<span class="nc bnc" id="L414" title="All 4 branches missed.">        while (((ch = sdePeek()) == ' ') || (ch == '\t')) {</span>
<span class="nc" id="L415">            sdeAdvance();</span>
        }
<span class="nc" id="L417">    }</span>

    void ignoreLine() {
        char ch;

<span class="nc bnc" id="L422" title="All 4 branches missed.">        while (((ch = sdeRead()) != '\n') &amp;&amp; (ch != '\r')) {</span>
        }
        /* check for CR LF */
<span class="nc bnc" id="L425" title="All 4 branches missed.">        if ((ch == '\r') &amp;&amp; (sdePeek() == '\n')) {</span>
<span class="nc" id="L426">            sdeAdvance();</span>
        }
<span class="nc" id="L428">        ignoreWhite(); /* leading white */</span>
<span class="nc" id="L429">    }</span>

    int readNumber() {
<span class="nc" id="L432">        int value = 0;</span>
        char ch;

<span class="nc" id="L435">        ignoreWhite();</span>
<span class="nc bnc" id="L436" title="All 4 branches missed.">        while (((ch = sdePeek()) &gt;= '0') &amp;&amp; (ch &lt;= '9')) {</span>
<span class="nc" id="L437">            sdeAdvance();</span>
<span class="nc" id="L438">            value = (value * 10) + ch - '0';</span>
        }
<span class="nc" id="L440">        ignoreWhite();</span>
<span class="nc" id="L441">        return value;</span>
    }

    void storeFile(int fileId, String sourceName, String sourcePath) {
<span class="nc" id="L445">        assureFileTableSize();</span>
<span class="nc" id="L446">        fileTable[fileIndex].fileId = fileId;</span>
<span class="nc" id="L447">        fileTable[fileIndex].sourceName = sourceName;</span>
<span class="nc" id="L448">        fileTable[fileIndex].sourcePath = sourcePath;</span>
<span class="nc" id="L449">        ++fileIndex;</span>
<span class="nc" id="L450">    }</span>

    void fileLine() {
<span class="nc" id="L453">        int hasAbsolute = 0; /* acts as boolean */</span>
        int fileId;
        String sourceName;
<span class="nc" id="L456">        String sourcePath = null;</span>

        /* is there an absolute filename? */
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (sdePeek() == '+') {</span>
<span class="nc" id="L460">            sdeAdvance();</span>
<span class="nc" id="L461">            hasAbsolute = 1;</span>
        }
<span class="nc" id="L463">        fileId = readNumber();</span>
<span class="nc" id="L464">        sourceName = readLine();</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (hasAbsolute == 1) {</span>
<span class="nc" id="L466">            sourcePath = readLine();</span>
        }

<span class="nc" id="L469">        storeFile(fileId, sourceName, sourcePath);</span>
<span class="nc" id="L470">    }</span>

    void storeLine(int jplsStart, int jplsEnd, int jplsLineInc,
                  int njplsStart, int njplsEnd, int fileId) {
<span class="nc" id="L474">        assureLineTableSize();</span>
<span class="nc" id="L475">        lineTable[lineIndex].jplsStart = jplsStart;</span>
<span class="nc" id="L476">        lineTable[lineIndex].jplsEnd = jplsEnd;</span>
<span class="nc" id="L477">        lineTable[lineIndex].jplsLineInc = jplsLineInc;</span>
<span class="nc" id="L478">        lineTable[lineIndex].njplsStart = njplsStart;</span>
<span class="nc" id="L479">        lineTable[lineIndex].njplsEnd = njplsEnd;</span>
<span class="nc" id="L480">        lineTable[lineIndex].fileId = fileId;</span>
<span class="nc" id="L481">        ++lineIndex;</span>
<span class="nc" id="L482">    }</span>

    /**
     * Parse line translation info.  Syntax is
     *     &lt;NJ-start-line&gt; [ # &lt;file-id&gt; ] [ , &lt;line-count&gt; ] :
     *                 &lt;J-start-line&gt; [ , &lt;line-increment&gt; ] CR
     */
    void lineLine() {
<span class="nc" id="L490">        int lineCount = 1;</span>
<span class="nc" id="L491">        int lineIncrement = 1;</span>
        int njplsStart;
        int jplsStart;

<span class="nc" id="L495">        njplsStart = readNumber();</span>

        /* is there a fileID? */
<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (sdePeek() == '#') {</span>
<span class="nc" id="L499">            sdeAdvance();</span>
<span class="nc" id="L500">            currentFileId = readNumber();</span>
        }

        /* is there a line count? */
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (sdePeek() == ',') {</span>
<span class="nc" id="L505">            sdeAdvance();</span>
<span class="nc" id="L506">            lineCount = readNumber();</span>
        }

<span class="nc bnc" id="L509" title="All 2 branches missed.">        if (sdeRead() != ':') {</span>
<span class="nc" id="L510">            syntax();</span>
        }
<span class="nc" id="L512">        jplsStart = readNumber();</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (sdePeek() == ',') {</span>
<span class="nc" id="L514">            sdeAdvance();</span>
<span class="nc" id="L515">            lineIncrement = readNumber();</span>
        }
<span class="nc" id="L517">        ignoreLine(); /* flush the rest */</span>

<span class="nc" id="L519">        storeLine(jplsStart,</span>
                  jplsStart + (lineCount * lineIncrement) -1,
                  lineIncrement,
                  njplsStart,
                  njplsStart + lineCount -1,
                  currentFileId);
<span class="nc" id="L525">    }</span>

    /**
     * Until the next stratum section, everything after this
     * is in stratumId - so, store the current indicies.
     */
    void storeStratum(String stratumId) {
        /* remove redundant strata */
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (stratumIndex &gt; 0) {</span>
<span class="nc bnc" id="L534" title="All 4 branches missed.">            if ((stratumTable[stratumIndex-1].fileIndex</span>
                                            == fileIndex) &amp;&amp;
                (stratumTable[stratumIndex-1].lineIndex
                                            == lineIndex)) {
                /* nothing changed overwrite it */
<span class="nc" id="L539">                --stratumIndex;</span>
            }
        }
        /* store the results */
<span class="nc" id="L543">        assureStratumTableSize();</span>
<span class="nc" id="L544">        stratumTable[stratumIndex].id = stratumId;</span>
<span class="nc" id="L545">        stratumTable[stratumIndex].fileIndex = fileIndex;</span>
<span class="nc" id="L546">        stratumTable[stratumIndex].lineIndex = lineIndex;</span>
<span class="nc" id="L547">        ++stratumIndex;</span>
<span class="nc" id="L548">        currentFileId = 0;</span>
<span class="nc" id="L549">    }</span>

    /**
     * The beginning of a stratum's info
     */
    void stratumSection() {
<span class="nc" id="L555">        storeStratum(readLine());</span>
<span class="nc" id="L556">    }</span>

    void fileSection() {
<span class="nc" id="L559">        ignoreLine();</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">        while (sdePeek() != '*') {</span>
<span class="nc" id="L561">            fileLine();</span>
        }
<span class="nc" id="L563">    }</span>

    void lineSection() {
<span class="nc" id="L566">        ignoreLine();</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">        while (sdePeek() != '*') {</span>
<span class="nc" id="L568">            lineLine();</span>
        }
<span class="nc" id="L570">    }</span>

    /**
     * Ignore a section we don't know about.
     */
    void ignoreSection() {
<span class="nc" id="L576">        ignoreLine();</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">        while (sdePeek() != '*') {</span>
<span class="nc" id="L578">            ignoreLine();</span>
        }
<span class="nc" id="L580">    }</span>

    /**
     * A base &quot;Java&quot; stratum is always available, though
     * it is not in the SourceDebugExtension.
     * Create the base stratum.
     */
    void createJavaStratum() {
<span class="nc" id="L588">        baseStratumIndex = stratumIndex;</span>
<span class="nc" id="L589">        storeStratum(BASE_STRATUM_NAME);</span>
<span class="nc" id="L590">        storeFile(1, jplsFilename, NullString);</span>
        /* JPL line numbers cannot exceed 65535 */
<span class="nc" id="L592">        storeLine(1, 65536, 1, 1, 65536, 1);</span>
<span class="nc" id="L593">        storeStratum(&quot;Aux&quot;); /* in case they don't declare */</span>
<span class="nc" id="L594">    }</span>

    /**
     * Decode a SourceDebugExtension which is in SourceMap format.
     * This is the entry point into the recursive descent parser.
     */
    void decode() {
        /* check for &quot;SMAP&quot; - allow EOF if not ours */
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if ((sourceDebugExtension.length() &lt; 4) ||</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">            (sdeRead() != 'S') ||</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">            (sdeRead() != 'M') ||</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">            (sdeRead() != 'A') ||</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">            (sdeRead() != 'P')) {</span>
<span class="nc" id="L607">            return; /* not our info */</span>
        }
<span class="nc" id="L609">        ignoreLine(); /* flush the rest */</span>
<span class="nc" id="L610">        jplsFilename = readLine();</span>
<span class="nc" id="L611">        defaultStratumId = readLine();</span>
<span class="nc" id="L612">        createJavaStratum();</span>
        while (true) {
<span class="nc bnc" id="L614" title="All 2 branches missed.">            if (sdeRead() != '*') {</span>
<span class="nc" id="L615">                syntax();</span>
            }
<span class="nc bnc" id="L617" title="All 5 branches missed.">            switch (sdeRead()) {</span>
                case 'S':
<span class="nc" id="L619">                    stratumSection();</span>
<span class="nc" id="L620">                    break;</span>
                case 'F':
<span class="nc" id="L622">                    fileSection();</span>
<span class="nc" id="L623">                    break;</span>
                case 'L':
<span class="nc" id="L625">                    lineSection();</span>
<span class="nc" id="L626">                    break;</span>
                case 'E':
                    /* set end points */
<span class="nc" id="L629">                    storeStratum(&quot;*terminator*&quot;);</span>
<span class="nc" id="L630">                    isValid = true;</span>
<span class="nc" id="L631">                    return;</span>
                default:
<span class="nc" id="L633">                    ignoreSection();</span>
            }
        }
    }

    void createProxyForAbsentSDE() {
<span class="nc" id="L639">        jplsFilename = null;</span>
<span class="nc" id="L640">        defaultStratumId = BASE_STRATUM_NAME;</span>
<span class="nc" id="L641">        defaultStratumIndex = stratumIndex;</span>
<span class="nc" id="L642">        createJavaStratum();</span>
<span class="nc" id="L643">        storeStratum(&quot;*terminator*&quot;);</span>
<span class="nc" id="L644">    }</span>

    /***************** query functions ***********************/

    private int stiLineTableIndex(int sti, int jplsLine) {
        int i;
        int lineIndexStart;
        int lineIndexEnd;

<span class="nc" id="L653">        lineIndexStart = stratumTable[sti].lineIndex;</span>
        /* one past end */
<span class="nc" id="L655">        lineIndexEnd = stratumTable[sti+1].lineIndex;</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">        for (i = lineIndexStart; i &lt; lineIndexEnd; ++i) {</span>
<span class="nc bnc" id="L657" title="All 4 branches missed.">            if ((jplsLine &gt;= lineTable[i].jplsStart) &amp;&amp;</span>
                            (jplsLine &lt;= lineTable[i].jplsEnd)) {
<span class="nc" id="L659">                return i;</span>
            }
        }
<span class="nc" id="L662">        return -1;</span>
    }

    private int stiLineNumber(int sti, int lti, int jplsLine) {
<span class="nc" id="L666">        return lineTable[lti].njplsStart +</span>
                (((jplsLine - lineTable[lti].jplsStart) /
                                   lineTable[lti].jplsLineInc));
    }

    private int fileTableIndex(int sti, int fileId) {
        int i;
<span class="nc" id="L673">        int fileIndexStart = stratumTable[sti].fileIndex;</span>
        /* one past end */
<span class="nc" id="L675">        int fileIndexEnd = stratumTable[sti+1].fileIndex;</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">        for (i = fileIndexStart; i &lt; fileIndexEnd; ++i) {</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">            if (fileTable[i].fileId == fileId) {</span>
<span class="nc" id="L678">                return i;</span>
            }
        }
<span class="nc" id="L681">        return -1;</span>
    }

    private int stiFileTableIndex(int sti, int lti) {
<span class="nc" id="L685">        return fileTableIndex(sti, lineTable[lti].fileId);</span>
    }

    boolean isValid() {
<span class="nc" id="L689">        return isValid;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>