<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>VirtualMachineManagerImpl.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.tools.jdi</a> &gt; <span class="el_source">VirtualMachineManagerImpl.java</span></div><h1>VirtualMachineManagerImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1998, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.tools.jdi;

import com.sun.jdi.*;
import com.sun.jdi.connect.*;
import com.sun.jdi.connect.spi.*;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.util.List;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.ResourceBundle;
import java.io.IOException;

import java.util.ServiceLoader;

/* Public for use by com.sun.jdi.Bootstrap */
public class VirtualMachineManagerImpl implements VirtualMachineManagerService {
<span class="nc" id="L44">    private List&lt;Connector&gt; connectors = new ArrayList&lt;Connector&gt;();</span>
<span class="nc" id="L45">    private LaunchingConnector defaultConnector = null;</span>
<span class="nc" id="L46">    private List&lt;VirtualMachine&gt; targets = new ArrayList&lt;VirtualMachine&gt;();</span>
    private final ThreadGroup mainGroupForJDI;
<span class="nc" id="L48">    private ResourceBundle messages = null;</span>
<span class="nc" id="L49">    private int vmSequenceNumber = 0;</span>
    private static final int majorVersion = 1;
    private static final int minorVersion = 6;

<span class="nc" id="L53">    private static final Object lock = new Object();</span>
    private static VirtualMachineManagerImpl vmm;

    public static VirtualMachineManager virtualMachineManager() {
<span class="nc" id="L57">        SecurityManager sm = System.getSecurityManager();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (sm != null) {</span>
<span class="nc" id="L59">            JDIPermission vmmPermission =</span>
                new JDIPermission(&quot;virtualMachineManager&quot;);
<span class="nc" id="L61">            sm.checkPermission(vmmPermission);</span>
        }
<span class="nc" id="L63">        synchronized (lock) {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">            if (vmm == null) {</span>
<span class="nc" id="L65">                vmm = new VirtualMachineManagerImpl();</span>
            }
<span class="nc" id="L67">        }</span>
<span class="nc" id="L68">        return vmm;</span>
    }

<span class="nc" id="L71">    protected VirtualMachineManagerImpl() {</span>

        /*
         * Create a top-level thread group
         */
<span class="nc" id="L76">        ThreadGroup top = Thread.currentThread().getThreadGroup();</span>
<span class="nc" id="L77">        ThreadGroup parent = null;</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        while ((parent = top.getParent()) != null) {</span>
<span class="nc" id="L79">            top = parent;</span>
        }
<span class="nc" id="L81">        mainGroupForJDI = new ThreadGroup(top, &quot;JDI main&quot;);</span>

        /*
         * Load the connectors
         */
<span class="nc" id="L86">        ServiceLoader&lt;Connector&gt; connectorLoader =</span>
<span class="nc" id="L87">            ServiceLoader.load(Connector.class, Connector.class.getClassLoader());</span>

<span class="nc" id="L89">        Iterator&lt;Connector&gt; connectors = connectorLoader.iterator();</span>

<span class="nc bnc" id="L91" title="All 2 branches missed.">        while (connectors.hasNext()) {</span>
            Connector connector;

            try {
<span class="nc" id="L95">                connector = connectors.next();</span>
<span class="nc" id="L96">            } catch (ThreadDeath x) {</span>
<span class="nc" id="L97">                throw x;</span>
<span class="nc" id="L98">            } catch (Exception x) {</span>
<span class="nc" id="L99">                System.err.println(x);</span>
<span class="nc" id="L100">                continue;</span>
<span class="nc" id="L101">            } catch (Error x) {</span>
<span class="nc" id="L102">                System.err.println(x);</span>
<span class="nc" id="L103">                continue;</span>
<span class="nc" id="L104">            }</span>

<span class="nc" id="L106">            addConnector(connector);</span>
<span class="nc" id="L107">        }</span>

        /*
         * Load any transport services and encapsulate them with
         * an attaching and listening connector.
         */
<span class="nc" id="L113">        ServiceLoader&lt;TransportService&gt; transportLoader =</span>
<span class="nc" id="L114">            ServiceLoader.load(TransportService.class,</span>
<span class="nc" id="L115">                               TransportService.class.getClassLoader());</span>

<span class="nc" id="L117">        Iterator&lt;TransportService&gt; transportServices =</span>
<span class="nc" id="L118">            transportLoader.iterator();</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        while (transportServices.hasNext()) {</span>
            TransportService transportService;

            try {
<span class="nc" id="L124">                transportService = transportServices.next();</span>
<span class="nc" id="L125">            } catch (ThreadDeath x) {</span>
<span class="nc" id="L126">                throw x;</span>
<span class="nc" id="L127">            } catch (Exception x) {</span>
<span class="nc" id="L128">                System.err.println(x);</span>
<span class="nc" id="L129">                continue;</span>
<span class="nc" id="L130">            } catch (Error x) {</span>
<span class="nc" id="L131">                System.err.println(x);</span>
<span class="nc" id="L132">                continue;</span>
<span class="nc" id="L133">            }</span>

<span class="nc" id="L135">            addConnector(GenericAttachingConnector.create(transportService));</span>
<span class="nc" id="L136">            addConnector(GenericListeningConnector.create(transportService));</span>
<span class="nc" id="L137">        }</span>

        // no connectors found
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (allConnectors().size() == 0) {</span>
<span class="nc" id="L141">            throw new Error(&quot;no Connectors loaded&quot;);</span>
        }

        // Set the default launcher. In order to be compatible
        // 1.2/1.3/1.4 we try to make the default launcher
        // &quot;com.sun.jdi.CommandLineLaunch&quot;. If this connector
        // isn't found then we arbitarly pick the first connector.
        //
<span class="nc" id="L149">        boolean found = false;</span>
<span class="nc" id="L150">        List&lt;LaunchingConnector&gt; launchers = launchingConnectors();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        for (LaunchingConnector lc: launchers) {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (lc.name().equals(&quot;com.sun.jdi.CommandLineLaunch&quot;)) {</span>
<span class="nc" id="L153">                setDefaultConnector(lc);</span>
<span class="nc" id="L154">                found = true;</span>
<span class="nc" id="L155">                break;</span>
            }
<span class="nc" id="L157">        }</span>
<span class="nc bnc" id="L158" title="All 4 branches missed.">        if (!found &amp;&amp; launchers.size() &gt; 0) {</span>
<span class="nc" id="L159">            setDefaultConnector(launchers.get(0));</span>
        }

<span class="nc" id="L162">    }</span>

    public LaunchingConnector defaultConnector() {
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (defaultConnector == null) {</span>
<span class="nc" id="L166">            throw new Error(&quot;no default LaunchingConnector&quot;);</span>
        }
<span class="nc" id="L168">        return defaultConnector;</span>
    }

    public void setDefaultConnector(LaunchingConnector connector) {
<span class="nc" id="L172">        defaultConnector = connector;</span>
<span class="nc" id="L173">    }</span>

    public List&lt;LaunchingConnector&gt; launchingConnectors() {
<span class="nc" id="L176">        List&lt;LaunchingConnector&gt; launchingConnectors = new ArrayList&lt;LaunchingConnector&gt;(connectors.size());</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        for (Connector connector: connectors) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (connector instanceof LaunchingConnector) {</span>
<span class="nc" id="L179">                launchingConnectors.add((LaunchingConnector)connector);</span>
            }
<span class="nc" id="L181">        }</span>
<span class="nc" id="L182">        return Collections.unmodifiableList(launchingConnectors);</span>
    }

    public List&lt;AttachingConnector&gt; attachingConnectors() {
<span class="nc" id="L186">        List&lt;AttachingConnector&gt; attachingConnectors = new ArrayList&lt;AttachingConnector&gt;(connectors.size());</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">        for (Connector connector: connectors) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (connector instanceof AttachingConnector) {</span>
<span class="nc" id="L189">                attachingConnectors.add((AttachingConnector)connector);</span>
            }
<span class="nc" id="L191">        }</span>
<span class="nc" id="L192">        return Collections.unmodifiableList(attachingConnectors);</span>
    }

    public List&lt;ListeningConnector&gt; listeningConnectors() {
<span class="nc" id="L196">        List&lt;ListeningConnector&gt; listeningConnectors = new ArrayList&lt;ListeningConnector&gt;(connectors.size());</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">        for (Connector connector: connectors) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (connector instanceof ListeningConnector) {</span>
<span class="nc" id="L199">                listeningConnectors.add((ListeningConnector)connector);</span>
            }
<span class="nc" id="L201">        }</span>
<span class="nc" id="L202">        return Collections.unmodifiableList(listeningConnectors);</span>
    }

    public List&lt;Connector&gt; allConnectors() {
<span class="nc" id="L206">        return Collections.unmodifiableList(connectors);</span>
    }

    public List&lt;VirtualMachine&gt; connectedVirtualMachines() {
<span class="nc" id="L210">        return Collections.unmodifiableList(targets);</span>
    }

    public void addConnector(Connector connector) {
<span class="nc" id="L214">        connectors.add(connector);</span>
<span class="nc" id="L215">    }</span>

    public void removeConnector(Connector connector) {
<span class="nc" id="L218">        connectors.remove(connector);</span>
<span class="nc" id="L219">    }</span>

    public synchronized VirtualMachine createVirtualMachine(
                                        Connection connection,
                                        Process process) throws IOException {

<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (!connection.isOpen()) {</span>
<span class="nc" id="L226">            throw new IllegalStateException(&quot;connection is not open&quot;);</span>
        }

        VirtualMachine vm;
        try {
<span class="nc" id="L231">            vm = new VirtualMachineImpl(this, connection, process,</span>
                                                   ++vmSequenceNumber);
<span class="nc" id="L233">        } catch (VMDisconnectedException e) {</span>
<span class="nc" id="L234">            throw new IOException(e.getMessage());</span>
<span class="nc" id="L235">        }</span>
<span class="nc" id="L236">        targets.add(vm);</span>
<span class="nc" id="L237">        return vm;</span>
    }

    public VirtualMachine createVirtualMachine(Connection connection) throws IOException {
<span class="nc" id="L241">        return createVirtualMachine(connection, null);</span>
    }

    public void addVirtualMachine(VirtualMachine vm) {
<span class="nc" id="L245">        targets.add(vm);</span>
<span class="nc" id="L246">    }</span>

    void disposeVirtualMachine(VirtualMachine vm) {
<span class="nc" id="L249">        targets.remove(vm);</span>
<span class="nc" id="L250">    }</span>

    public int majorInterfaceVersion() {
<span class="nc" id="L253">        return majorVersion;</span>
    }

    public int minorInterfaceVersion() {
<span class="nc" id="L257">        return minorVersion;</span>
    }

    ThreadGroup mainGroupForJDI() {
<span class="nc" id="L261">        return mainGroupForJDI;</span>
    }

    String getString(String key) {
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (messages == null) {</span>
<span class="nc" id="L266">            messages = ResourceBundle.getBundle(&quot;com.sun.tools.jdi.resources.jdi&quot;);</span>
        }
<span class="nc" id="L268">        return messages.getString(key);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>