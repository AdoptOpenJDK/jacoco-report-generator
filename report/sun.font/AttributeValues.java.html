<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>AttributeValues.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.font</a> &gt; <span class="el_source">AttributeValues.java</span></div><h1>AttributeValues.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

/*
 *
 * (C) Copyright IBM Corp. 2005 - All Rights Reserved
 *
 * The original version of this source code and documentation is
 * copyrighted and owned by IBM. These materials are provided
 * under terms of a License Agreement between IBM and Sun.
 * This technology is protected by multiple US and International
 * patents. This notice and attribution to IBM may not be removed.
 */

package sun.font;

import static sun.font.EAttribute.*;
import static java.lang.Math.*;

import java.awt.Font;
import java.awt.Paint;
import java.awt.Toolkit;
import java.awt.font.GraphicAttribute;
import java.awt.font.NumericShaper;
import java.awt.font.TextAttribute;
import java.awt.font.TransformAttribute;
import java.awt.geom.AffineTransform;
import java.awt.geom.NoninvertibleTransformException;
import java.awt.geom.Point2D;
import java.awt.im.InputMethodHighlight;
import java.io.Serializable;
import java.text.Annotation;
import java.text.AttributedCharacterIterator.Attribute;
import java.util.Map;
import java.util.HashMap;
import java.util.Hashtable;

<span class="fc" id="L60">public final class AttributeValues implements Cloneable {</span>
    private int defined;
    private int nondefault;

<span class="fc" id="L64">    private String family = &quot;Default&quot;;</span>
<span class="fc" id="L65">    private float weight = 1f;</span>
<span class="fc" id="L66">    private float width = 1f;</span>
    private float posture; // 0f
<span class="fc" id="L68">    private float size = 12f;</span>
    private float tracking; // 0f
    private NumericShaper numericShaping; // null
    private AffineTransform transform; // null == identity
    private GraphicAttribute charReplacement; // null
    private Paint foreground; // null
    private Paint background; // null
<span class="fc" id="L75">    private float justification = 1f;</span>
    private Object imHighlight; // null
    // (can be either Attribute wrapping IMH, or IMH itself
    private Font font; // here for completeness, don't actually use
<span class="fc" id="L79">    private byte imUnderline = -1; // same default as underline</span>
    private byte superscript; // 0
<span class="fc" id="L81">    private byte underline = -1; // arrgh, value for ON is 0</span>
<span class="fc" id="L82">    private byte runDirection = -2; // BIDI.DIRECTION_DEFAULT_LEFT_TO_RIGHT</span>
    private byte bidiEmbedding; // 0
    private byte kerning; // 0
    private byte ligatures; // 0
    private boolean strikethrough; // false
    private boolean swapColors; // false

    private AffineTransform baselineTransform; // derived from transform
    private AffineTransform charTransform; // derived from transform

<span class="fc" id="L92">    private static final AttributeValues DEFAULT = new AttributeValues();</span>

    // type-specific API
<span class="nc" id="L95">    public String getFamily() { return family; }</span>
<span class="nc" id="L96">    public void setFamily(String f) { this.family = f; update(EFAMILY); }</span>

<span class="nc" id="L98">    public float getWeight() { return weight; }</span>
<span class="nc" id="L99">    public void setWeight(float f) { this.weight = f; update(EWEIGHT); }</span>

<span class="nc" id="L101">    public float getWidth() { return width; }</span>
<span class="nc" id="L102">    public void setWidth(float f) { this.width = f; update(EWIDTH); }</span>

<span class="nc" id="L104">    public float getPosture() { return posture; }</span>
<span class="nc" id="L105">    public void setPosture(float f) { this.posture = f; update(EPOSTURE); }</span>

<span class="nc" id="L107">    public float getSize() { return size; }</span>
<span class="nc" id="L108">    public void setSize(float f) { this.size = f; update(ESIZE); }</span>

<span class="nc" id="L110">    public AffineTransform getTransform() { return transform; }</span>
    public void setTransform(AffineTransform f) {
<span class="nc bnc" id="L112" title="All 4 branches missed.">        this.transform = (f == null || f.isIdentity())</span>
            ? DEFAULT.transform
            : new AffineTransform(f);
<span class="nc" id="L115">        updateDerivedTransforms();</span>
<span class="nc" id="L116">        update(ETRANSFORM);</span>
<span class="nc" id="L117">    }</span>
    public void setTransform(TransformAttribute f) {
<span class="nc bnc" id="L119" title="All 4 branches missed.">        this.transform = (f == null || f.isIdentity())</span>
            ? DEFAULT.transform
<span class="nc" id="L121">            : f.getTransform();</span>
<span class="nc" id="L122">        updateDerivedTransforms();</span>
<span class="nc" id="L123">        update(ETRANSFORM);</span>
<span class="nc" id="L124">    }</span>

<span class="nc" id="L126">    public int getSuperscript() { return superscript; }</span>
    public void setSuperscript(int f) {
<span class="nc" id="L128">      this.superscript = (byte)f; update(ESUPERSCRIPT); }</span>

<span class="nc" id="L130">    public Font getFont() { return font; }</span>
<span class="nc" id="L131">    public void setFont(Font f) { this.font = f; update(EFONT); }</span>

<span class="nc" id="L133">    public GraphicAttribute getCharReplacement() { return charReplacement; }</span>
    public void setCharReplacement(GraphicAttribute f) {
<span class="nc" id="L135">      this.charReplacement = f; update(ECHAR_REPLACEMENT); }</span>

<span class="nc" id="L137">    public Paint getForeground() { return foreground; }</span>
    public void setForeground(Paint f) {
<span class="nc" id="L139">      this.foreground = f; update(EFOREGROUND); }</span>

<span class="nc" id="L141">    public Paint getBackground() { return background; }</span>
    public void setBackground(Paint f) {
<span class="nc" id="L143">      this.background = f; update(EBACKGROUND); }</span>

<span class="nc" id="L145">    public int getUnderline() { return underline; }</span>
    public void setUnderline(int f) {
<span class="nc" id="L147">      this.underline = (byte)f; update(EUNDERLINE); }</span>

<span class="nc" id="L149">    public boolean getStrikethrough() { return strikethrough; }</span>
    public void setStrikethrough(boolean f) {
<span class="nc" id="L151">      this.strikethrough = f; update(ESTRIKETHROUGH); }</span>

<span class="nc" id="L153">    public int getRunDirection() { return runDirection; }</span>
    public void setRunDirection(int f) {
<span class="nc" id="L155">      this.runDirection = (byte)f; update(ERUN_DIRECTION); }</span>

<span class="nc" id="L157">    public int getBidiEmbedding() { return bidiEmbedding; }</span>
    public void setBidiEmbedding(int f) {
<span class="nc" id="L159">      this.bidiEmbedding = (byte)f; update(EBIDI_EMBEDDING); }</span>

<span class="nc" id="L161">    public float getJustification() { return justification; }</span>
    public void setJustification(float f) {
<span class="nc" id="L163">      this.justification = f; update(EJUSTIFICATION); }</span>

<span class="nc" id="L165">    public Object getInputMethodHighlight() { return imHighlight; }</span>
    public void setInputMethodHighlight(Annotation f) {
<span class="nc" id="L167">      this.imHighlight = f; update(EINPUT_METHOD_HIGHLIGHT); }</span>
    public void setInputMethodHighlight(InputMethodHighlight f) {
<span class="nc" id="L169">      this.imHighlight = f; update(EINPUT_METHOD_HIGHLIGHT); }</span>

<span class="nc" id="L171">    public int getInputMethodUnderline() { return imUnderline; }</span>
    public void setInputMethodUnderline(int f) {
<span class="nc" id="L173">      this.imUnderline = (byte)f; update(EINPUT_METHOD_UNDERLINE); }</span>

<span class="nc" id="L175">    public boolean getSwapColors() { return swapColors; }</span>
    public void setSwapColors(boolean f) {
<span class="nc" id="L177">      this.swapColors = f; update(ESWAP_COLORS); }</span>

<span class="nc" id="L179">    public NumericShaper getNumericShaping() { return numericShaping; }</span>
    public void setNumericShaping(NumericShaper f) {
<span class="nc" id="L181">      this.numericShaping = f; update(ENUMERIC_SHAPING); }</span>

<span class="nc" id="L183">    public int getKerning() { return kerning; }</span>
    public void setKerning(int f) {
<span class="nc" id="L185">      this.kerning = (byte)f; update(EKERNING); }</span>

<span class="nc" id="L187">    public float getTracking() { return tracking; }</span>
    public void setTracking(float f) {
<span class="nc" id="L189">      this.tracking = (byte)f; update(ETRACKING); }</span>

<span class="nc" id="L191">    public int getLigatures() { return ligatures; }</span>
    public void setLigatures(int f) {
<span class="nc" id="L193">      this.ligatures = (byte)f; update(ELIGATURES); }</span>


<span class="nc" id="L196">    public AffineTransform getBaselineTransform() { return baselineTransform; }</span>
<span class="nc" id="L197">    public AffineTransform getCharTransform() { return charTransform; }</span>

    // mask api

    public static int getMask(EAttribute att) {
<span class="fc" id="L202">        return att.mask;</span>
    }

    public static int getMask(EAttribute ... atts) {
<span class="fc" id="L206">        int mask = 0;</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">        for (EAttribute a: atts) {</span>
<span class="fc" id="L208">            mask |= a.mask;</span>
        }
<span class="fc" id="L210">        return mask;</span>
    }

<span class="fc" id="L213">    public static final int MASK_ALL =</span>
<span class="fc" id="L214">        getMask(EAttribute.class.getEnumConstants());</span>

    public void unsetDefault() {
<span class="nc" id="L217">        defined &amp;= nondefault;</span>
<span class="nc" id="L218">    }</span>

    public void defineAll(int mask) {
<span class="nc" id="L221">        defined |= mask;</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if ((defined &amp; EBASELINE_TRANSFORM.mask) != 0) {</span>
<span class="nc" id="L223">            throw new InternalError(&quot;can't define derived attribute&quot;);</span>
        }
<span class="nc" id="L225">    }</span>

    public boolean allDefined(int mask) {
<span class="nc bnc" id="L228" title="All 2 branches missed.">        return (defined &amp; mask) == mask;</span>
    }

    public boolean anyDefined(int mask) {
<span class="nc bnc" id="L232" title="All 2 branches missed.">        return (defined &amp; mask) != 0;</span>
    }

    public boolean anyNonDefault(int mask) {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        return (nondefault &amp; mask) != 0;</span>
    }

    // generic EAttribute API

    public boolean isDefined(EAttribute a) {
<span class="nc bnc" id="L242" title="All 2 branches missed.">        return (defined &amp; a.mask) != 0;</span>
    }

    public boolean isNonDefault(EAttribute a) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">        return (nondefault &amp; a.mask) != 0;</span>
    }

    public void setDefault(EAttribute a) {
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (a.att == null) {</span>
<span class="nc" id="L251">            throw new InternalError(&quot;can't set default derived attribute: &quot; + a);</span>
        }
<span class="nc" id="L253">        i_set(a, DEFAULT);</span>
<span class="nc" id="L254">        defined |= a.mask;</span>
<span class="nc" id="L255">        nondefault &amp;= ~a.mask;</span>
<span class="nc" id="L256">    }</span>

    public void unset(EAttribute a) {
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (a.att == null) {</span>
<span class="nc" id="L260">            throw new InternalError(&quot;can't unset derived attribute: &quot; + a);</span>
        }
<span class="nc" id="L262">        i_set(a, DEFAULT);</span>
<span class="nc" id="L263">        defined &amp;= ~a.mask;</span>
<span class="nc" id="L264">        nondefault &amp;= ~a.mask;</span>
<span class="nc" id="L265">    }</span>

    public void set(EAttribute a, AttributeValues src) {
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (a.att == null) {</span>
<span class="nc" id="L269">            throw new InternalError(&quot;can't set derived attribute: &quot; + a);</span>
        }
<span class="nc bnc" id="L271" title="All 4 branches missed.">        if (src == null || src == DEFAULT) {</span>
<span class="nc" id="L272">            setDefault(a);</span>
        } else {
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if ((src.defined &amp; a.mask) != 0) {</span>
<span class="nc" id="L275">                i_set(a, src);</span>
<span class="nc" id="L276">                update(a);</span>
            }
        }
<span class="nc" id="L279">    }</span>

    public void set(EAttribute a, Object o) {
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (a.att == null) {</span>
<span class="nc" id="L283">            throw new InternalError(&quot;can't set derived attribute: &quot; + a);</span>
        }
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (o != null) {</span>
            try {
<span class="nc" id="L287">                i_set(a, o);</span>
<span class="nc" id="L288">                update(a);</span>
<span class="nc" id="L289">                return;</span>
<span class="nc" id="L290">            } catch (Exception e) {</span>
            }
        }
<span class="nc" id="L293">        setDefault(a);</span>
<span class="nc" id="L294">    }</span>

    public Object get(EAttribute a) {
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (a.att == null) {</span>
<span class="nc" id="L298">            throw new InternalError(&quot;can't get derived attribute: &quot; + a);</span>
        }
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if ((nondefault &amp; a.mask) != 0) {</span>
<span class="nc" id="L301">            return i_get(a);</span>
        }
<span class="nc" id="L303">        return null;</span>
    }

    // merging

    public AttributeValues merge(Map&lt;? extends Attribute, ?&gt;map) {
<span class="nc" id="L309">        return merge(map, MASK_ALL);</span>
    }

    public AttributeValues merge(Map&lt;? extends Attribute, ?&gt;map,
                                 int mask) {
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (map instanceof AttributeMap &amp;&amp;</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            ((AttributeMap) map).getValues() != null) {</span>
<span class="nc" id="L316">            merge(((AttributeMap)map).getValues(), mask);</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">        } else if (map != null &amp;&amp; !map.isEmpty()) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">            for (Map.Entry&lt;? extends Attribute, ?&gt; e: map.entrySet()) {</span>
                try {
<span class="nc" id="L320">                    EAttribute ea = EAttribute.forAttribute(e.getKey());</span>
<span class="nc bnc" id="L321" title="All 4 branches missed.">                    if (ea!= null &amp;&amp; (mask &amp; ea.mask) != 0) {</span>
<span class="nc" id="L322">                        set(ea, e.getValue());</span>
                    }
<span class="nc" id="L324">                } catch (ClassCastException cce) {</span>
                    // IGNORED
<span class="nc" id="L326">                }</span>
<span class="nc" id="L327">            }</span>
        }
<span class="nc" id="L329">        return this;</span>
    }

    public AttributeValues merge(AttributeValues src) {
<span class="nc" id="L333">        return merge(src, MASK_ALL);</span>
    }

    public AttributeValues merge(AttributeValues src, int mask) {
<span class="nc" id="L337">        int m = mask &amp; src.defined;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        for (EAttribute ea: EAttribute.atts) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (m == 0) {</span>
<span class="nc" id="L340">                break;</span>
            }
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if ((m &amp; ea.mask) != 0) {</span>
<span class="nc" id="L343">                m &amp;= ~ea.mask;</span>
<span class="nc" id="L344">                i_set(ea, src);</span>
<span class="nc" id="L345">                update(ea);</span>
            }
        }
<span class="nc" id="L348">        return this;</span>
    }

    // creation API

    public static AttributeValues fromMap(Map&lt;? extends Attribute, ?&gt; map) {
<span class="nc" id="L354">        return fromMap(map, MASK_ALL);</span>
    }

    public static AttributeValues fromMap(Map&lt;? extends Attribute, ?&gt; map,
                                          int mask) {
<span class="nc" id="L359">        return new AttributeValues().merge(map, mask);</span>
    }

    public Map&lt;TextAttribute, Object&gt; toMap(Map&lt;TextAttribute, Object&gt; fill) {
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (fill == null) {</span>
<span class="nc" id="L364">            fill = new HashMap&lt;TextAttribute, Object&gt;();</span>
        }

<span class="nc bnc" id="L367" title="All 2 branches missed.">        for (int m = defined, i = 0; m != 0; ++i) {</span>
<span class="nc" id="L368">            EAttribute ea = EAttribute.atts[i];</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">            if ((m &amp; ea.mask) != 0) {</span>
<span class="nc" id="L370">                m &amp;= ~ea.mask;</span>
<span class="nc" id="L371">                fill.put(ea.att, get(ea));</span>
            }
        }

<span class="nc" id="L375">        return fill;</span>
    }

    // key must be serializable, so use String, not Object
    private static final String DEFINED_KEY =
        &quot;sun.font.attributevalues.defined_key&quot;;

    public static boolean is16Hashtable(Hashtable&lt;Object, Object&gt; ht) {
<span class="nc" id="L383">        return ht.containsKey(DEFINED_KEY);</span>
    }

    public static AttributeValues
    fromSerializableHashtable(Hashtable&lt;Object, Object&gt; ht)
    {
<span class="nc" id="L389">        AttributeValues result = new AttributeValues();</span>
<span class="nc bnc" id="L390" title="All 4 branches missed.">        if (ht != null &amp;&amp; !ht.isEmpty()) {</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">            for (Map.Entry&lt;Object, Object&gt; e: ht.entrySet()) {</span>
<span class="nc" id="L392">                Object key = e.getKey();</span>
<span class="nc" id="L393">                Object val = e.getValue();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">                if (key.equals(DEFINED_KEY)) {</span>
<span class="nc" id="L395">                    result.defineAll(((Integer)val).intValue());</span>
                } else {
                    try {
<span class="nc" id="L398">                        EAttribute ea =</span>
<span class="nc" id="L399">                            EAttribute.forAttribute((Attribute)key);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">                        if (ea != null) {</span>
<span class="nc" id="L401">                            result.set(ea, val);</span>
                        }
                    }
<span class="nc" id="L404">                    catch (ClassCastException ex) {</span>
<span class="nc" id="L405">                    }</span>
                }
<span class="nc" id="L407">            }</span>
        }
<span class="nc" id="L409">        return result;</span>
    }

    public Hashtable&lt;Object, Object&gt; toSerializableHashtable() {
<span class="nc" id="L413">        Hashtable ht = new Hashtable();</span>
<span class="nc" id="L414">        int hashkey = defined;</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">        for (int m = defined, i = 0; m != 0; ++i) {</span>
<span class="nc" id="L416">            EAttribute ea = EAttribute.atts[i];</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">            if ((m &amp; ea.mask) != 0) {</span>
<span class="nc" id="L418">                m &amp;= ~ea.mask;</span>
<span class="nc" id="L419">                Object o = get(ea);</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">                if (o == null) {</span>
                    // hashkey will handle it
<span class="nc bnc" id="L422" title="All 2 branches missed.">                } else if (o instanceof Serializable) { // check all...</span>
<span class="nc" id="L423">                    ht.put(ea.att, o);</span>
                } else {
<span class="nc" id="L425">                    hashkey &amp;= ~ea.mask;</span>
                }
            }
        }
<span class="nc" id="L429">        ht.put(DEFINED_KEY, Integer.valueOf(hashkey));</span>

<span class="nc" id="L431">        return ht;</span>
    }

    // boilerplate
    public int hashCode() {
<span class="nc" id="L436">        return defined &lt;&lt; 8 ^ nondefault;</span>
    }

    public boolean equals(Object rhs) {
        try {
<span class="nc" id="L441">            return equals((AttributeValues)rhs);</span>
        }
<span class="nc" id="L443">        catch (ClassCastException e) {</span>
        }
<span class="nc" id="L445">        return false;</span>
    }

    public boolean equals(AttributeValues rhs) {
        // test in order of most likely to differ and easiest to compare
        // also assumes we're generally calling this only if family,
        // size, weight, posture are the same

<span class="nc bnc" id="L453" title="All 2 branches missed.">        if (rhs == null) return false;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">        if (rhs == this) return true;</span>

<span class="nc bnc" id="L456" title="All 24 branches missed.">        return defined == rhs.defined</span>
            &amp;&amp; nondefault == rhs.nondefault
            &amp;&amp; underline == rhs.underline
            &amp;&amp; strikethrough == rhs.strikethrough
            &amp;&amp; superscript == rhs.superscript
            &amp;&amp; width == rhs.width
            &amp;&amp; kerning == rhs.kerning
            &amp;&amp; tracking == rhs.tracking
            &amp;&amp; ligatures == rhs.ligatures
            &amp;&amp; runDirection == rhs.runDirection
            &amp;&amp; bidiEmbedding == rhs.bidiEmbedding
            &amp;&amp; swapColors == rhs.swapColors
<span class="nc bnc" id="L468" title="All 2 branches missed.">            &amp;&amp; equals(transform, rhs.transform)</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">            &amp;&amp; equals(foreground, rhs.foreground)</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">            &amp;&amp; equals(background, rhs.background)</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">            &amp;&amp; equals(numericShaping, rhs.numericShaping)</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">            &amp;&amp; equals(justification, rhs.justification)</span>
<span class="nc bnc" id="L473" title="All 8 branches missed.">            &amp;&amp; equals(charReplacement, rhs.charReplacement)</span>
            &amp;&amp; size == rhs.size
            &amp;&amp; weight == rhs.weight
            &amp;&amp; posture == rhs.posture
<span class="nc bnc" id="L477" title="All 2 branches missed.">            &amp;&amp; equals(family, rhs.family)</span>
<span class="nc bnc" id="L478" title="All 4 branches missed.">            &amp;&amp; equals(font, rhs.font)</span>
            &amp;&amp; imUnderline == rhs.imUnderline
<span class="nc bnc" id="L480" title="All 2 branches missed.">            &amp;&amp; equals(imHighlight, rhs.imHighlight);</span>
    }

    public AttributeValues clone() {
        try {
<span class="nc" id="L485">            AttributeValues result = (AttributeValues)super.clone();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">            if (transform != null) { // AffineTransform is mutable</span>
<span class="nc" id="L487">                result.transform = new AffineTransform(transform);</span>
<span class="nc" id="L488">                result.updateDerivedTransforms();</span>
            }
            // if transform is null, derived transforms are null
            // so there's nothing to do
<span class="nc" id="L492">            return result;</span>
        }
<span class="nc" id="L494">        catch (CloneNotSupportedException e) {</span>
            // never happens
<span class="nc" id="L496">            return null;</span>
        }
    }

    public String toString() {
<span class="nc" id="L501">        StringBuilder b = new StringBuilder();</span>
<span class="nc" id="L502">        b.append('{');</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">        for (int m = defined, i = 0; m != 0; ++i) {</span>
<span class="nc" id="L504">            EAttribute ea = EAttribute.atts[i];</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">            if ((m &amp; ea.mask) != 0) {</span>
<span class="nc" id="L506">                m &amp;= ~ea.mask;</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                if (b.length() &gt; 1) {</span>
<span class="nc" id="L508">                    b.append(&quot;, &quot;);</span>
                }
<span class="nc" id="L510">                b.append(ea);</span>
<span class="nc" id="L511">                b.append('=');</span>
<span class="nc bnc" id="L512" title="All 24 branches missed.">                switch (ea) {</span>
<span class="nc" id="L513">                case EFAMILY: b.append('&quot;');</span>
<span class="nc" id="L514">                  b.append(family);</span>
<span class="nc" id="L515">                  b.append('&quot;'); break;</span>
<span class="nc" id="L516">                case EWEIGHT: b.append(weight); break;</span>
<span class="nc" id="L517">                case EWIDTH: b.append(width); break;</span>
<span class="nc" id="L518">                case EPOSTURE: b.append(posture); break;</span>
<span class="nc" id="L519">                case ESIZE: b.append(size); break;</span>
<span class="nc" id="L520">                case ETRANSFORM: b.append(transform); break;</span>
<span class="nc" id="L521">                case ESUPERSCRIPT: b.append(superscript); break;</span>
<span class="nc" id="L522">                case EFONT: b.append(font); break;</span>
<span class="nc" id="L523">                case ECHAR_REPLACEMENT: b.append(charReplacement); break;</span>
<span class="nc" id="L524">                case EFOREGROUND: b.append(foreground); break;</span>
<span class="nc" id="L525">                case EBACKGROUND: b.append(background); break;</span>
<span class="nc" id="L526">                case EUNDERLINE: b.append(underline); break;</span>
<span class="nc" id="L527">                case ESTRIKETHROUGH: b.append(strikethrough); break;</span>
<span class="nc" id="L528">                case ERUN_DIRECTION: b.append(runDirection); break;</span>
<span class="nc" id="L529">                case EBIDI_EMBEDDING: b.append(bidiEmbedding); break;</span>
<span class="nc" id="L530">                case EJUSTIFICATION: b.append(justification); break;</span>
<span class="nc" id="L531">                case EINPUT_METHOD_HIGHLIGHT: b.append(imHighlight); break;</span>
<span class="nc" id="L532">                case EINPUT_METHOD_UNDERLINE: b.append(imUnderline); break;</span>
<span class="nc" id="L533">                case ESWAP_COLORS: b.append(swapColors); break;</span>
<span class="nc" id="L534">                case ENUMERIC_SHAPING: b.append(numericShaping); break;</span>
<span class="nc" id="L535">                case EKERNING: b.append(kerning); break;</span>
<span class="nc" id="L536">                case ELIGATURES: b.append(ligatures); break;</span>
<span class="nc" id="L537">                case ETRACKING: b.append(tracking); break;</span>
<span class="nc" id="L538">                default: throw new InternalError();</span>
                }
<span class="nc bnc" id="L540" title="All 2 branches missed.">                if ((nondefault &amp; ea.mask) == 0) {</span>
<span class="nc" id="L541">                    b.append('*');</span>
                }
            }
        }
<span class="nc" id="L545">        b.append(&quot;[btx=&quot; + baselineTransform + &quot;, ctx=&quot; + charTransform + &quot;]&quot;);</span>
<span class="nc" id="L546">        b.append('}');</span>
<span class="nc" id="L547">        return b.toString();</span>
    }

    // internal utilities

    private static boolean equals(Object lhs, Object rhs) {
<span class="nc bnc" id="L553" title="All 4 branches missed.">        return lhs == null ? rhs == null : lhs.equals(rhs);</span>
    }

    private void update(EAttribute a) {
<span class="nc" id="L557">        defined |= a.mask;</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (i_validate(a)) {</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">            if (i_equals(a, DEFAULT)) {</span>
<span class="nc" id="L560">                nondefault &amp;= ~a.mask;</span>
            } else {
<span class="nc" id="L562">                nondefault |= a.mask;</span>
            }
        } else {
<span class="nc" id="L565">            setDefault(a);</span>
        }
<span class="nc" id="L567">    }</span>

    // dispatch

    private void i_set(EAttribute a, AttributeValues src) {
<span class="nc bnc" id="L572" title="All 24 branches missed.">        switch (a) {</span>
<span class="nc" id="L573">        case EFAMILY: family = src.family; break;</span>
<span class="nc" id="L574">        case EWEIGHT: weight = src.weight; break;</span>
<span class="nc" id="L575">        case EWIDTH: width = src.width; break;</span>
<span class="nc" id="L576">        case EPOSTURE: posture = src.posture; break;</span>
<span class="nc" id="L577">        case ESIZE: size = src.size; break;</span>
<span class="nc" id="L578">        case ETRANSFORM: transform = src.transform; updateDerivedTransforms(); break;</span>
<span class="nc" id="L579">        case ESUPERSCRIPT: superscript = src.superscript; break;</span>
<span class="nc" id="L580">        case EFONT: font = src.font; break;</span>
<span class="nc" id="L581">        case ECHAR_REPLACEMENT: charReplacement = src.charReplacement; break;</span>
<span class="nc" id="L582">        case EFOREGROUND: foreground = src.foreground; break;</span>
<span class="nc" id="L583">        case EBACKGROUND: background = src.background; break;</span>
<span class="nc" id="L584">        case EUNDERLINE: underline = src.underline; break;</span>
<span class="nc" id="L585">        case ESTRIKETHROUGH: strikethrough = src.strikethrough; break;</span>
<span class="nc" id="L586">        case ERUN_DIRECTION: runDirection = src.runDirection; break;</span>
<span class="nc" id="L587">        case EBIDI_EMBEDDING: bidiEmbedding = src.bidiEmbedding; break;</span>
<span class="nc" id="L588">        case EJUSTIFICATION: justification = src.justification; break;</span>
<span class="nc" id="L589">        case EINPUT_METHOD_HIGHLIGHT: imHighlight = src.imHighlight; break;</span>
<span class="nc" id="L590">        case EINPUT_METHOD_UNDERLINE: imUnderline = src.imUnderline; break;</span>
<span class="nc" id="L591">        case ESWAP_COLORS: swapColors = src.swapColors; break;</span>
<span class="nc" id="L592">        case ENUMERIC_SHAPING: numericShaping = src.numericShaping; break;</span>
<span class="nc" id="L593">        case EKERNING: kerning = src.kerning; break;</span>
<span class="nc" id="L594">        case ELIGATURES: ligatures = src.ligatures; break;</span>
<span class="nc" id="L595">        case ETRACKING: tracking = src.tracking; break;</span>
<span class="nc" id="L596">        default: throw new InternalError();</span>
        }
<span class="nc" id="L598">    }</span>

    private boolean i_equals(EAttribute a, AttributeValues src) {
<span class="nc bnc" id="L601" title="All 24 branches missed.">        switch (a) {</span>
<span class="nc" id="L602">        case EFAMILY: return equals(family, src.family);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">        case EWEIGHT: return weight == src.weight;</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">        case EWIDTH: return width == src.width;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        case EPOSTURE: return posture == src.posture;</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">        case ESIZE: return size == src.size;</span>
<span class="nc" id="L607">        case ETRANSFORM: return equals(transform, src.transform);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">        case ESUPERSCRIPT: return superscript == src.superscript;</span>
<span class="nc" id="L609">        case EFONT: return equals(font, src.font);</span>
<span class="nc" id="L610">        case ECHAR_REPLACEMENT: return equals(charReplacement, src.charReplacement);</span>
<span class="nc" id="L611">        case EFOREGROUND: return equals(foreground, src.foreground);</span>
<span class="nc" id="L612">        case EBACKGROUND: return equals(background, src.background);</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">        case EUNDERLINE: return underline == src.underline;</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">        case ESTRIKETHROUGH: return strikethrough == src.strikethrough;</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">        case ERUN_DIRECTION: return runDirection == src.runDirection;</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">        case EBIDI_EMBEDDING: return bidiEmbedding == src.bidiEmbedding;</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">        case EJUSTIFICATION: return justification == src.justification;</span>
<span class="nc" id="L618">        case EINPUT_METHOD_HIGHLIGHT: return equals(imHighlight, src.imHighlight);</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">        case EINPUT_METHOD_UNDERLINE: return imUnderline == src.imUnderline;</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">        case ESWAP_COLORS: return swapColors == src.swapColors;</span>
<span class="nc" id="L621">        case ENUMERIC_SHAPING: return equals(numericShaping, src.numericShaping);</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">        case EKERNING: return kerning == src.kerning;</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">        case ELIGATURES: return ligatures == src.ligatures;</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">        case ETRACKING: return tracking == src.tracking;</span>
<span class="nc" id="L625">        default: throw new InternalError();</span>
        }
    }

    private void i_set(EAttribute a, Object o) {
<span class="nc bnc" id="L630" title="All 24 branches missed.">        switch (a) {</span>
<span class="nc" id="L631">        case EFAMILY: family = ((String)o).trim(); break;</span>
<span class="nc" id="L632">        case EWEIGHT: weight = ((Number)o).floatValue(); break;</span>
<span class="nc" id="L633">        case EWIDTH: width = ((Number)o).floatValue(); break;</span>
<span class="nc" id="L634">        case EPOSTURE: posture = ((Number)o).floatValue(); break;</span>
<span class="nc" id="L635">        case ESIZE: size = ((Number)o).floatValue(); break;</span>
        case ETRANSFORM: {
<span class="nc bnc" id="L637" title="All 2 branches missed.">            if (o instanceof TransformAttribute) {</span>
<span class="nc" id="L638">                TransformAttribute ta = (TransformAttribute)o;</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                if (ta.isIdentity()) {</span>
<span class="nc" id="L640">                    transform = null;</span>
                } else {
<span class="nc" id="L642">                    transform = ta.getTransform();</span>
                }
<span class="nc" id="L644">            } else {</span>
<span class="nc" id="L645">                transform = new AffineTransform((AffineTransform)o);</span>
            }
<span class="nc" id="L647">            updateDerivedTransforms();</span>
<span class="nc" id="L648">        } break;</span>
<span class="nc" id="L649">        case ESUPERSCRIPT: superscript = (byte)((Integer)o).intValue(); break;</span>
<span class="nc" id="L650">        case EFONT: font = (Font)o; break;</span>
<span class="nc" id="L651">        case ECHAR_REPLACEMENT: charReplacement = (GraphicAttribute)o; break;</span>
<span class="nc" id="L652">        case EFOREGROUND: foreground = (Paint)o; break;</span>
<span class="nc" id="L653">        case EBACKGROUND: background = (Paint)o; break;</span>
<span class="nc" id="L654">        case EUNDERLINE: underline = (byte)((Integer)o).intValue(); break;</span>
<span class="nc" id="L655">        case ESTRIKETHROUGH: strikethrough = ((Boolean)o).booleanValue(); break;</span>
        case ERUN_DIRECTION: {
<span class="nc bnc" id="L657" title="All 2 branches missed.">            if (o instanceof Boolean) {</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                runDirection = (byte)(TextAttribute.RUN_DIRECTION_LTR.equals(o) ? 0 : 1);</span>
            } else {
<span class="nc" id="L660">                runDirection = (byte)((Integer)o).intValue();</span>
            }
<span class="nc" id="L662">        } break;</span>
<span class="nc" id="L663">        case EBIDI_EMBEDDING: bidiEmbedding = (byte)((Integer)o).intValue(); break;</span>
<span class="nc" id="L664">        case EJUSTIFICATION: justification = ((Number)o).floatValue(); break;</span>
        case EINPUT_METHOD_HIGHLIGHT: {
<span class="nc bnc" id="L666" title="All 2 branches missed.">            if (o instanceof Annotation) {</span>
<span class="nc" id="L667">                Annotation at = (Annotation)o;</span>
<span class="nc" id="L668">                imHighlight = (InputMethodHighlight)at.getValue();</span>
<span class="nc" id="L669">            } else {</span>
<span class="nc" id="L670">                imHighlight = (InputMethodHighlight)o;</span>
            }
<span class="nc" id="L672">        } break;</span>
<span class="nc" id="L673">        case EINPUT_METHOD_UNDERLINE: imUnderline = (byte)((Integer)o).intValue();</span>
<span class="nc" id="L674">          break;</span>
<span class="nc" id="L675">        case ESWAP_COLORS: swapColors = ((Boolean)o).booleanValue(); break;</span>
<span class="nc" id="L676">        case ENUMERIC_SHAPING: numericShaping = (NumericShaper)o; break;</span>
<span class="nc" id="L677">        case EKERNING: kerning = (byte)((Integer)o).intValue(); break;</span>
<span class="nc" id="L678">        case ELIGATURES: ligatures = (byte)((Integer)o).intValue(); break;</span>
<span class="nc" id="L679">        case ETRACKING: tracking = ((Number)o).floatValue(); break;</span>
<span class="nc" id="L680">        default: throw new InternalError();</span>
        }
<span class="nc" id="L682">    }</span>

    private Object i_get(EAttribute a) {
<span class="nc bnc" id="L685" title="All 24 branches missed.">        switch (a) {</span>
<span class="nc" id="L686">        case EFAMILY: return family;</span>
<span class="nc" id="L687">        case EWEIGHT: return Float.valueOf(weight);</span>
<span class="nc" id="L688">        case EWIDTH: return Float.valueOf(width);</span>
<span class="nc" id="L689">        case EPOSTURE: return Float.valueOf(posture);</span>
<span class="nc" id="L690">        case ESIZE: return Float.valueOf(size);</span>
        case ETRANSFORM:
<span class="nc bnc" id="L692" title="All 2 branches missed.">            return transform == null</span>
                ? TransformAttribute.IDENTITY
                : new TransformAttribute(transform);
<span class="nc" id="L695">        case ESUPERSCRIPT: return Integer.valueOf(superscript);</span>
<span class="nc" id="L696">        case EFONT: return font;</span>
<span class="nc" id="L697">        case ECHAR_REPLACEMENT: return charReplacement;</span>
<span class="nc" id="L698">        case EFOREGROUND: return foreground;</span>
<span class="nc" id="L699">        case EBACKGROUND: return background;</span>
<span class="nc" id="L700">        case EUNDERLINE: return Integer.valueOf(underline);</span>
<span class="nc" id="L701">        case ESTRIKETHROUGH: return Boolean.valueOf(strikethrough);</span>
        case ERUN_DIRECTION: {
<span class="nc bnc" id="L703" title="All 3 branches missed.">            switch (runDirection) {</span>
                // todo: figure out a way to indicate this value
                // case -1: return Integer.valueOf(runDirection);
<span class="nc" id="L706">            case 0: return TextAttribute.RUN_DIRECTION_LTR;</span>
<span class="nc" id="L707">            case 1: return TextAttribute.RUN_DIRECTION_RTL;</span>
<span class="nc" id="L708">            default: return null;</span>
            }
        } // not reachable
<span class="nc" id="L711">        case EBIDI_EMBEDDING: return Integer.valueOf(bidiEmbedding);</span>
<span class="nc" id="L712">        case EJUSTIFICATION: return Float.valueOf(justification);</span>
<span class="nc" id="L713">        case EINPUT_METHOD_HIGHLIGHT: return imHighlight;</span>
<span class="nc" id="L714">        case EINPUT_METHOD_UNDERLINE: return Integer.valueOf(imUnderline);</span>
<span class="nc" id="L715">        case ESWAP_COLORS: return Boolean.valueOf(swapColors);</span>
<span class="nc" id="L716">        case ENUMERIC_SHAPING: return numericShaping;</span>
<span class="nc" id="L717">        case EKERNING: return Integer.valueOf(kerning);</span>
<span class="nc" id="L718">        case ELIGATURES: return Integer.valueOf(ligatures);</span>
<span class="nc" id="L719">        case ETRACKING: return Float.valueOf(tracking);</span>
<span class="nc" id="L720">        default: throw new InternalError();</span>
        }
    }

    private boolean i_validate(EAttribute a) {
<span class="nc bnc" id="L725" title="All 24 branches missed.">        switch (a) {</span>
<span class="nc bnc" id="L726" title="All 4 branches missed.">        case EFAMILY: if (family == null || family.length() == 0)</span>
<span class="nc" id="L727">          family = DEFAULT.family; return true;</span>
<span class="nc bnc" id="L728" title="All 4 branches missed.">        case EWEIGHT: return weight &gt; 0 &amp;&amp; weight &lt; 10;</span>
<span class="nc bnc" id="L729" title="All 4 branches missed.">        case EWIDTH: return width &gt;= .5f &amp;&amp; width &lt; 10;</span>
<span class="nc bnc" id="L730" title="All 4 branches missed.">        case EPOSTURE: return posture &gt;= -1 &amp;&amp; posture &lt;= 1;</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">        case ESIZE: return size &gt;= 0;</span>
<span class="nc bnc" id="L732" title="All 4 branches missed.">        case ETRANSFORM: if (transform != null &amp;&amp; transform.isIdentity())</span>
<span class="nc" id="L733">            transform = DEFAULT.transform; return true;</span>
<span class="nc bnc" id="L734" title="All 4 branches missed.">        case ESUPERSCRIPT: return superscript &gt;= -7 &amp;&amp; superscript &lt;= 7;</span>
<span class="nc" id="L735">        case EFONT: return true;</span>
<span class="nc" id="L736">        case ECHAR_REPLACEMENT: return true;</span>
<span class="nc" id="L737">        case EFOREGROUND: return true;</span>
<span class="nc" id="L738">        case EBACKGROUND: return true;</span>
<span class="nc bnc" id="L739" title="All 4 branches missed.">        case EUNDERLINE: return underline &gt;= -1 &amp;&amp; underline &lt; 6;</span>
<span class="nc" id="L740">        case ESTRIKETHROUGH: return true;</span>
<span class="nc bnc" id="L741" title="All 4 branches missed.">        case ERUN_DIRECTION: return runDirection &gt;= -2 &amp;&amp; runDirection &lt;= 1;</span>
<span class="nc bnc" id="L742" title="All 4 branches missed.">        case EBIDI_EMBEDDING: return bidiEmbedding &gt;= -61 &amp;&amp; bidiEmbedding &lt; 62;</span>
<span class="nc" id="L743">        case EJUSTIFICATION: justification = max(0, min (justification, 1));</span>
<span class="nc" id="L744">            return true;</span>
<span class="nc" id="L745">        case EINPUT_METHOD_HIGHLIGHT: return true;</span>
<span class="nc bnc" id="L746" title="All 4 branches missed.">        case EINPUT_METHOD_UNDERLINE: return imUnderline &gt;= -1 &amp;&amp; imUnderline &lt; 6;</span>
<span class="nc" id="L747">        case ESWAP_COLORS: return true;</span>
<span class="nc" id="L748">        case ENUMERIC_SHAPING: return true;</span>
<span class="nc bnc" id="L749" title="All 4 branches missed.">        case EKERNING: return kerning &gt;= 0 &amp;&amp; kerning &lt;= 1;</span>
<span class="nc bnc" id="L750" title="All 4 branches missed.">        case ELIGATURES: return ligatures &gt;= 0 &amp;&amp; ligatures &lt;= 1;</span>
<span class="nc bnc" id="L751" title="All 4 branches missed.">        case ETRACKING: return tracking &gt;= -1 &amp;&amp; tracking &lt;= 10;</span>
<span class="nc" id="L752">        default: throw new InternalError(&quot;unknown attribute: &quot; + a);</span>
        }
    }

    // Until textlayout is fixed to use AttributeValues, we'll end up
    // creating a map from the values for it.  This is a compromise between
    // creating the whole map and just checking a particular value.
    // Plan to remove these.
    public static float getJustification(Map&lt;?, ?&gt; map) {
<span class="nc bnc" id="L761" title="All 2 branches missed.">        if (map != null) {</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">            if (map instanceof AttributeMap &amp;&amp;</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">                ((AttributeMap) map).getValues() != null) {</span>
<span class="nc" id="L764">                return ((AttributeMap)map).getValues().justification;</span>
            }
<span class="nc" id="L766">            Object obj = map.get(TextAttribute.JUSTIFICATION);</span>
<span class="nc bnc" id="L767" title="All 4 branches missed.">            if (obj != null &amp;&amp; obj instanceof Number) {</span>
<span class="nc" id="L768">                return max(0, min(1, ((Number)obj).floatValue()));</span>
            }
        }
<span class="nc" id="L771">        return DEFAULT.justification;</span>
    }

    public static NumericShaper getNumericShaping(Map&lt;?, ?&gt; map) {
<span class="nc bnc" id="L775" title="All 2 branches missed.">        if (map != null) {</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">            if (map instanceof AttributeMap &amp;&amp;</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                ((AttributeMap) map).getValues() != null) {</span>
<span class="nc" id="L778">                return ((AttributeMap)map).getValues().numericShaping;</span>
            }
<span class="nc" id="L780">            Object obj = map.get(TextAttribute.NUMERIC_SHAPING);</span>
<span class="nc bnc" id="L781" title="All 4 branches missed.">            if (obj != null &amp;&amp; obj instanceof NumericShaper) {</span>
<span class="nc" id="L782">                return (NumericShaper)obj;</span>
            }
        }
<span class="nc" id="L785">        return DEFAULT.numericShaping;</span>
    }

    /**
     * If this has an imHighlight, create copy of this with those attributes
     * applied to it.  Otherwise return this unchanged.
     */
    public AttributeValues applyIMHighlight() {
<span class="nc bnc" id="L793" title="All 2 branches missed.">        if (imHighlight != null) {</span>
<span class="nc" id="L794">            InputMethodHighlight hl = null;</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">            if (imHighlight instanceof InputMethodHighlight) {</span>
<span class="nc" id="L796">                hl = (InputMethodHighlight)imHighlight;</span>
            } else {
<span class="nc" id="L798">                hl = (InputMethodHighlight)((Annotation)imHighlight).getValue();</span>
            }

<span class="nc" id="L801">            Map imStyles = hl.getStyle();</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">            if (imStyles == null) {</span>
<span class="nc" id="L803">                Toolkit tk = Toolkit.getDefaultToolkit();</span>
<span class="nc" id="L804">                imStyles = tk.mapInputMethodHighlight(hl);</span>
            }

<span class="nc bnc" id="L807" title="All 2 branches missed.">            if (imStyles != null) {</span>
<span class="nc" id="L808">                return clone().merge(imStyles);</span>
            }
        }

<span class="nc" id="L812">        return this;</span>
    }

    public static AffineTransform getBaselineTransform(Map&lt;?, ?&gt; map) {
<span class="nc bnc" id="L816" title="All 2 branches missed.">        if (map != null) {</span>
<span class="nc" id="L817">            AttributeValues av = null;</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">            if (map instanceof AttributeMap &amp;&amp;</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">                ((AttributeMap) map).getValues() != null) {</span>
<span class="nc" id="L820">                av = ((AttributeMap)map).getValues();</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">            } else if (map.get(TextAttribute.TRANSFORM) != null) {</span>
<span class="nc" id="L822">                av = AttributeValues.fromMap((Map&lt;Attribute, ?&gt;)map); // yuck</span>
            }
<span class="nc bnc" id="L824" title="All 2 branches missed.">            if (av != null) {</span>
<span class="nc" id="L825">                return av.baselineTransform;</span>
            }
        }
<span class="nc" id="L828">        return null;</span>
    }

    public static AffineTransform getCharTransform(Map&lt;?, ?&gt; map) {
<span class="nc bnc" id="L832" title="All 2 branches missed.">        if (map != null) {</span>
<span class="nc" id="L833">            AttributeValues av = null;</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">            if (map instanceof AttributeMap &amp;&amp;</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">                ((AttributeMap) map).getValues() != null) {</span>
<span class="nc" id="L836">                av = ((AttributeMap)map).getValues();</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            } else if (map.get(TextAttribute.TRANSFORM) != null) {</span>
<span class="nc" id="L838">                av = AttributeValues.fromMap((Map&lt;Attribute, ?&gt;)map); // yuck</span>
            }
<span class="nc bnc" id="L840" title="All 2 branches missed.">            if (av != null) {</span>
<span class="nc" id="L841">                return av.charTransform;</span>
            }
        }
<span class="nc" id="L844">        return null;</span>
    }

    public void updateDerivedTransforms() {
        // this also updates the mask for the baseline transform
<span class="nc bnc" id="L849" title="All 2 branches missed.">        if (transform == null) {</span>
<span class="nc" id="L850">            baselineTransform = null;</span>
<span class="nc" id="L851">            charTransform = null;</span>
        } else {
<span class="nc" id="L853">            charTransform = new AffineTransform(transform);</span>
<span class="nc" id="L854">            baselineTransform = extractXRotation(charTransform, true);</span>

<span class="nc bnc" id="L856" title="All 2 branches missed.">            if (charTransform.isIdentity()) {</span>
<span class="nc" id="L857">              charTransform = null;</span>
            }

<span class="nc bnc" id="L860" title="All 2 branches missed.">            if (baselineTransform.isIdentity()) {</span>
<span class="nc" id="L861">              baselineTransform = null;</span>
            }
        }

<span class="nc bnc" id="L865" title="All 2 branches missed.">        if (baselineTransform == null) {</span>
<span class="nc" id="L866">            nondefault &amp;= ~EBASELINE_TRANSFORM.mask;</span>
        } else {
<span class="nc" id="L868">            nondefault |= EBASELINE_TRANSFORM.mask;</span>
        }
<span class="nc" id="L870">    }</span>

    public static AffineTransform extractXRotation(AffineTransform tx,
                                                   boolean andTranslation) {
<span class="nc" id="L874">        return extractRotation(new Point2D.Double(1, 0), tx, andTranslation);</span>
    }

    public static AffineTransform extractYRotation(AffineTransform tx,
                                                   boolean andTranslation) {
<span class="nc" id="L879">        return extractRotation(new Point2D.Double(0, 1), tx, andTranslation);</span>
    }

    private static AffineTransform extractRotation(Point2D.Double pt,
        AffineTransform tx, boolean andTranslation) {

<span class="nc" id="L885">        tx.deltaTransform(pt, pt);</span>
<span class="nc" id="L886">        AffineTransform rtx = AffineTransform.getRotateInstance(pt.x, pt.y);</span>

        try {
<span class="nc" id="L889">            AffineTransform rtxi = rtx.createInverse();</span>
<span class="nc" id="L890">            double dx = tx.getTranslateX();</span>
<span class="nc" id="L891">            double dy = tx.getTranslateY();</span>
<span class="nc" id="L892">            tx.preConcatenate(rtxi);</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">            if (andTranslation) {</span>
<span class="nc bnc" id="L894" title="All 4 branches missed.">                if (dx != 0 || dy != 0) {</span>
<span class="nc" id="L895">                    tx.setTransform(tx.getScaleX(), tx.getShearY(),</span>
<span class="nc" id="L896">                                    tx.getShearX(), tx.getScaleY(), 0, 0);</span>
<span class="nc" id="L897">                    rtx.setTransform(rtx.getScaleX(), rtx.getShearY(),</span>
<span class="nc" id="L898">                                     rtx.getShearX(), rtx.getScaleY(), dx, dy);</span>
                }
            }
        }
<span class="nc" id="L902">        catch (NoninvertibleTransformException e) {</span>
<span class="nc" id="L903">            return null;</span>
<span class="nc" id="L904">        }</span>
<span class="nc" id="L905">        return rtx;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>