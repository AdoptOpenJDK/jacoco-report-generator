<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>PrintJob2D.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.print</a> &gt; <span class="el_source">PrintJob2D.java</span></div><h1>PrintJob2D.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2007, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.print;

import java.awt.Dimension;
import java.awt.Frame;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.PrintJob;
import java.awt.JobAttributes;
import java.awt.JobAttributes.*;
import java.awt.PageAttributes;
import java.awt.PageAttributes.*;

import java.awt.print.PageFormat;
import java.awt.print.Paper;
import java.awt.print.Printable;
import java.awt.print.PrinterException;
import java.awt.print.PrinterJob;

import java.io.File;
import java.io.FilePermission;
import java.io.IOException;

import java.net.URI;
import java.net.URISyntaxException;

import java.util.ArrayList;
import java.util.Properties;

import javax.print.PrintService;
import javax.print.attribute.HashPrintRequestAttributeSet;
import javax.print.attribute.PrintRequestAttributeSet;
import javax.print.attribute.ResolutionSyntax;
import javax.print.attribute.Size2DSyntax;
import javax.print.attribute.standard.Chromaticity;
import javax.print.attribute.standard.Copies;
import javax.print.attribute.standard.Destination;
import javax.print.attribute.standard.DialogTypeSelection;
import javax.print.attribute.standard.JobName;
import javax.print.attribute.standard.MediaSize;
import javax.print.attribute.standard.PrintQuality;
import javax.print.attribute.standard.PrinterResolution;
import javax.print.attribute.standard.SheetCollate;
import javax.print.attribute.standard.Sides;
import javax.print.attribute.standard.Media;
import javax.print.attribute.standard.OrientationRequested;
import javax.print.attribute.standard.MediaSizeName;
import javax.print.attribute.standard.PageRanges;

import sun.print.SunPageSelection;
import sun.print.SunMinMaxPage;

/**
 * A class which initiates and executes a print job using
 * the underlying PrinterJob graphics conversions.
 *
 * @see Toolkit#getPrintJob
 *
 */
public class PrintJob2D extends PrintJob implements Printable, Runnable {

<span class="nc" id="L86">    private static final MediaType SIZES[] = {</span>
        MediaType.ISO_4A0, MediaType.ISO_2A0, MediaType.ISO_A0,
        MediaType.ISO_A1, MediaType.ISO_A2, MediaType.ISO_A3,
        MediaType.ISO_A4, MediaType.ISO_A5, MediaType.ISO_A6,
        MediaType.ISO_A7, MediaType.ISO_A8, MediaType.ISO_A9,
        MediaType.ISO_A10, MediaType.ISO_B0, MediaType.ISO_B1,
        MediaType.ISO_B2, MediaType.ISO_B3, MediaType.ISO_B4,
        MediaType.ISO_B5, MediaType.ISO_B6, MediaType.ISO_B7,
        MediaType.ISO_B8, MediaType.ISO_B9, MediaType.ISO_B10,
        MediaType.JIS_B0, MediaType.JIS_B1, MediaType.JIS_B2,
        MediaType.JIS_B3, MediaType.JIS_B4, MediaType.JIS_B5,
        MediaType.JIS_B6, MediaType.JIS_B7, MediaType.JIS_B8,
        MediaType.JIS_B9, MediaType.JIS_B10, MediaType.ISO_C0,
        MediaType.ISO_C1, MediaType.ISO_C2, MediaType.ISO_C3,
        MediaType.ISO_C4, MediaType.ISO_C5, MediaType.ISO_C6,
        MediaType.ISO_C7, MediaType.ISO_C8, MediaType.ISO_C9,
        MediaType.ISO_C10, MediaType.ISO_DESIGNATED_LONG,
        MediaType.EXECUTIVE, MediaType.FOLIO, MediaType.INVOICE,
        MediaType.LEDGER, MediaType.NA_LETTER, MediaType.NA_LEGAL,
        MediaType.QUARTO, MediaType.A, MediaType.B,
        MediaType.C, MediaType.D, MediaType.E,
        MediaType.NA_10X15_ENVELOPE, MediaType.NA_10X14_ENVELOPE,
        MediaType.NA_10X13_ENVELOPE, MediaType.NA_9X12_ENVELOPE,
        MediaType.NA_9X11_ENVELOPE, MediaType.NA_7X9_ENVELOPE,
        MediaType.NA_6X9_ENVELOPE, MediaType.NA_NUMBER_9_ENVELOPE,
        MediaType.NA_NUMBER_10_ENVELOPE, MediaType.NA_NUMBER_11_ENVELOPE,
        MediaType.NA_NUMBER_12_ENVELOPE, MediaType.NA_NUMBER_14_ENVELOPE,
        MediaType.INVITE_ENVELOPE, MediaType.ITALY_ENVELOPE,
        MediaType.MONARCH_ENVELOPE, MediaType.PERSONAL_ENVELOPE
    };

    /* This array maps the above array to the objects used by the
     * javax.print APIs
         */
<span class="nc" id="L120">    private static final MediaSizeName JAVAXSIZES[] = {</span>
        null, null, MediaSizeName.ISO_A0,
        MediaSizeName.ISO_A1, MediaSizeName.ISO_A2, MediaSizeName.ISO_A3,
        MediaSizeName.ISO_A4, MediaSizeName.ISO_A5, MediaSizeName.ISO_A6,
        MediaSizeName.ISO_A7, MediaSizeName.ISO_A8, MediaSizeName.ISO_A9,
        MediaSizeName.ISO_A10, MediaSizeName.ISO_B0, MediaSizeName.ISO_B1,
        MediaSizeName.ISO_B2, MediaSizeName.ISO_B3, MediaSizeName.ISO_B4,
        MediaSizeName.ISO_B5,  MediaSizeName.ISO_B6, MediaSizeName.ISO_B7,
        MediaSizeName.ISO_B8, MediaSizeName.ISO_B9, MediaSizeName.ISO_B10,
        MediaSizeName.JIS_B0, MediaSizeName.JIS_B1, MediaSizeName.JIS_B2,
        MediaSizeName.JIS_B3, MediaSizeName.JIS_B4, MediaSizeName.JIS_B5,
        MediaSizeName.JIS_B6, MediaSizeName.JIS_B7, MediaSizeName.JIS_B8,
        MediaSizeName.JIS_B9, MediaSizeName.JIS_B10, MediaSizeName.ISO_C0,
        MediaSizeName.ISO_C1, MediaSizeName.ISO_C2, MediaSizeName.ISO_C3,
        MediaSizeName.ISO_C4, MediaSizeName.ISO_C5, MediaSizeName.ISO_C6,
        null, null, null, null,
        MediaSizeName.ISO_DESIGNATED_LONG, MediaSizeName.EXECUTIVE,
        MediaSizeName.FOLIO, MediaSizeName.INVOICE, MediaSizeName.LEDGER,
        MediaSizeName.NA_LETTER, MediaSizeName.NA_LEGAL,
        MediaSizeName.QUARTO, MediaSizeName.A, MediaSizeName.B,
        MediaSizeName.C, MediaSizeName.D, MediaSizeName.E,
        MediaSizeName.NA_10X15_ENVELOPE, MediaSizeName.NA_10X14_ENVELOPE,
        MediaSizeName.NA_10X13_ENVELOPE, MediaSizeName.NA_9X12_ENVELOPE,
        MediaSizeName.NA_9X11_ENVELOPE, MediaSizeName.NA_7X9_ENVELOPE,
        MediaSizeName.NA_6X9_ENVELOPE,
        MediaSizeName.NA_NUMBER_9_ENVELOPE,
        MediaSizeName.NA_NUMBER_10_ENVELOPE,
        MediaSizeName.NA_NUMBER_11_ENVELOPE,
        MediaSizeName.NA_NUMBER_12_ENVELOPE,
        MediaSizeName.NA_NUMBER_14_ENVELOPE,
        null, MediaSizeName.ITALY_ENVELOPE,
        MediaSizeName.MONARCH_ENVELOPE, MediaSizeName.PERSONAL_ENVELOPE,
    };


    // widths and lengths in PostScript points (1/72 in.)
<span class="nc" id="L156">    private static final int WIDTHS[] = {</span>
        /*iso-4a0*/ 4768, /*iso-2a0*/ 3370, /*iso-a0*/ 2384, /*iso-a1*/ 1684,
        /*iso-a2*/ 1191, /*iso-a3*/ 842, /*iso-a4*/ 595, /*iso-a5*/ 420,
        /*iso-a6*/ 298, /*iso-a7*/ 210, /*iso-a8*/ 147, /*iso-a9*/ 105,
        /*iso-a10*/ 74, /*iso-b0*/ 2835, /*iso-b1*/ 2004, /*iso-b2*/ 1417,
        /*iso-b3*/ 1001, /*iso-b4*/ 709, /*iso-b5*/ 499, /*iso-b6*/ 354,
        /*iso-b7*/ 249, /*iso-b8*/ 176, /*iso-b9*/ 125, /*iso-b10*/ 88,
        /*jis-b0*/ 2920, /*jis-b1*/ 2064, /*jis-b2*/ 1460, /*jis-b3*/ 1032,
        /*jis-b4*/ 729, /*jis-b5*/ 516, /*jis-b6*/ 363, /*jis-b7*/ 258,
        /*jis-b8*/ 181, /*jis-b9*/ 128, /*jis-b10*/ 91, /*iso-c0*/ 2599,
        /*iso-c1*/ 1837, /*iso-c2*/ 1298, /*iso-c3*/ 918, /*iso-c4*/ 649,
        /*iso-c5*/ 459, /*iso-c6*/ 323, /*iso-c7*/ 230, /*iso-c8*/ 162,
        /*iso-c9*/ 113, /*iso-c10*/ 79, /*iso-designated-long*/ 312,
        /*executive*/ 522, /*folio*/ 612, /*invoice*/ 396, /*ledger*/ 792,
        /*na-letter*/ 612, /*na-legal*/ 612, /*quarto*/ 609, /*a*/ 612,
        /*b*/ 792, /*c*/ 1224, /*d*/ 1584, /*e*/ 2448,
        /*na-10x15-envelope*/ 720, /*na-10x14-envelope*/ 720,
        /*na-10x13-envelope*/ 720, /*na-9x12-envelope*/ 648,
        /*na-9x11-envelope*/ 648, /*na-7x9-envelope*/ 504,
        /*na-6x9-envelope*/ 432, /*na-number-9-envelope*/ 279,
        /*na-number-10-envelope*/ 297, /*na-number-11-envelope*/ 324,
        /*na-number-12-envelope*/ 342, /*na-number-14-envelope*/ 360,
        /*invite-envelope*/ 624, /*italy-envelope*/ 312,
        /*monarch-envelope*/ 279, /*personal-envelope*/ 261
    };
<span class="nc" id="L181">    private static final int LENGTHS[] = {</span>
        /*iso-4a0*/ 6741, /*iso-2a0*/ 4768, /*iso-a0*/ 3370, /*iso-a1*/ 2384,
        /*iso-a2*/ 1684, /*iso-a3*/ 1191, /*iso-a4*/ 842, /*iso-a5*/ 595,
        /*iso-a6*/ 420, /*iso-a7*/ 298, /*iso-a8*/ 210, /*iso-a9*/ 147,
        /*iso-a10*/ 105, /*iso-b0*/ 4008, /*iso-b1*/ 2835, /*iso-b2*/ 2004,
        /*iso-b3*/ 1417, /*iso-b4*/ 1001, /*iso-b5*/ 729, /*iso-b6*/ 499,
        /*iso-b7*/ 354, /*iso-b8*/ 249, /*iso-b9*/ 176, /*iso-b10*/ 125,
        /*jis-b0*/ 4127, /*jis-b1*/ 2920, /*jis-b2*/ 2064, /*jis-b3*/ 1460,
        /*jis-b4*/ 1032, /*jis-b5*/ 729, /*jis-b6*/ 516, /*jis-b7*/ 363,
        /*jis-b8*/ 258, /*jis-b9*/ 181, /*jis-b10*/ 128, /*iso-c0*/ 3677,
        /*iso-c1*/ 2599, /*iso-c2*/ 1837, /*iso-c3*/ 1298, /*iso-c4*/ 918,
        /*iso-c5*/ 649, /*iso-c6*/ 459, /*iso-c7*/ 323, /*iso-c8*/ 230,
        /*iso-c9*/ 162, /*iso-c10*/ 113, /*iso-designated-long*/ 624,
        /*executive*/ 756, /*folio*/ 936, /*invoice*/ 612, /*ledger*/ 1224,
        /*na-letter*/ 792, /*na-legal*/ 1008, /*quarto*/ 780, /*a*/ 792,
        /*b*/ 1224, /*c*/ 1584, /*d*/ 2448, /*e*/ 3168,
        /*na-10x15-envelope*/ 1080, /*na-10x14-envelope*/ 1008,
        /*na-10x13-envelope*/ 936, /*na-9x12-envelope*/ 864,
        /*na-9x11-envelope*/ 792, /*na-7x9-envelope*/ 648,
        /*na-6x9-envelope*/ 648, /*na-number-9-envelope*/ 639,
        /*na-number-10-envelope*/ 684, /*na-number-11-envelope*/ 747,
        /*na-number-12-envelope*/ 792, /*na-number-14-envelope*/ 828,
        /*invite-envelope*/ 624, /*italy-envelope*/ 652,
        /*monarch-envelope*/ 540, /*personal-envelope*/ 468
    };


    private Frame frame;
<span class="nc" id="L209">    private String docTitle = &quot;&quot;;</span>
    private JobAttributes jobAttributes;
    private PageAttributes pageAttributes;
    private PrintRequestAttributeSet attributes;

    /*
     * Displays the native or cross-platform dialog and allows the
     * user to update job &amp; page attributes
     */

    /**
     * The PrinterJob being uses to implement the PrintJob.
     */
    private PrinterJob printerJob;

    /**
     * The size of the page being used for the PrintJob.
     */
    private PageFormat pageFormat;

    /**
     * The PrinterJob and the application run on different
     * threads and communicate through a pair of message
     * queues. This queue is the list of Graphics that
     * the PrinterJob has requested rendering for, but
     * for which the application has not yet called getGraphics().
     * In practice the length of this message queue is always
     * 0 or 1.
     */
<span class="nc" id="L238">    private MessageQ graphicsToBeDrawn = new MessageQ(&quot;tobedrawn&quot;);</span>

    /**
     * Used to communicate between the application's thread
     * and the PrinterJob's thread this message queue holds
     * the list of Graphics into which the application has
     * finished drawing, but that have not yet been returned
     * to the PrinterJob thread. Again, in practice, the
     * length of this message queue is always 0 or 1.
     */
<span class="nc" id="L248">    private MessageQ graphicsDrawn = new MessageQ(&quot;drawn&quot;);</span>

    /**
     * The last Graphics returned to the application via
     * getGraphics. This is the Graphics into which the
     * application is currently drawing.
     */
    private Graphics2D currentGraphics;

    /**
     * The zero based index of the page currently being rendered
     * by the application.
     */
<span class="nc" id="L261">    private int pageIndex = -1;</span>

    // The following Strings are maintained for backward-compatibility with
    // Properties based print control.
    private final static String DEST_PROP = &quot;awt.print.destination&quot;;
    private final static String PRINTER = &quot;printer&quot;;
    private final static String FILE = &quot;file&quot;;

    private final static String PRINTER_PROP = &quot;awt.print.printer&quot;;

    private final static String FILENAME_PROP = &quot;awt.print.fileName&quot;;

    private final static String NUMCOPIES_PROP = &quot;awt.print.numCopies&quot;;

    private final static String OPTIONS_PROP = &quot;awt.print.options&quot;;

    private final static String ORIENT_PROP = &quot;awt.print.orientation&quot;;
    private final static String PORTRAIT = &quot;portrait&quot;;
    private final static String LANDSCAPE = &quot;landscape&quot;;

    private final static String PAPERSIZE_PROP = &quot;awt.print.paperSize&quot;;
    private final static String LETTER = &quot;letter&quot;;
    private final static String LEGAL = &quot;legal&quot;;
    private final static String EXECUTIVE = &quot;executive&quot;;
    private final static String A4 = &quot;a4&quot;;

    private Properties props;

<span class="nc" id="L289">    private String options = &quot;&quot;; // REMIND: needs implementation</span>

    /**
     * The thread on which PrinterJob is running.
     * This is different than the applications thread.
     */
    private Thread printerJobThread;

    public PrintJob2D(Frame frame,  String doctitle,
<span class="nc" id="L298">                      final Properties props) {</span>
<span class="nc" id="L299">        this.props = props;</span>
<span class="nc" id="L300">        this.jobAttributes = new JobAttributes();</span>
<span class="nc" id="L301">        this.pageAttributes = new PageAttributes();</span>
<span class="nc" id="L302">        translateInputProps();</span>
<span class="nc" id="L303">        initPrintJob2D(frame, doctitle,</span>
                       this.jobAttributes, this.pageAttributes);
<span class="nc" id="L305">    }</span>

    public PrintJob2D(Frame frame,  String doctitle,
                      JobAttributes jobAttributes,
<span class="nc" id="L309">                      PageAttributes pageAttributes) {</span>
<span class="nc" id="L310">        initPrintJob2D(frame, doctitle, jobAttributes, pageAttributes);</span>
<span class="nc" id="L311">    }</span>

    private void initPrintJob2D(Frame frame,  String doctitle,
                                JobAttributes jobAttributes,
                                PageAttributes pageAttributes) {

<span class="nc" id="L317">        SecurityManager security = System.getSecurityManager();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (security != null) {</span>
<span class="nc" id="L319">            security.checkPrintJobAccess();</span>
        }

<span class="nc bnc" id="L322" title="All 4 branches missed.">        if (frame == null &amp;&amp;</span>
            (jobAttributes == null ||
<span class="nc bnc" id="L324" title="All 2 branches missed.">             jobAttributes.getDialog() == DialogType.NATIVE)) {</span>
<span class="nc" id="L325">            throw new NullPointerException(&quot;Frame must not be null&quot;);</span>
        }
<span class="nc" id="L327">        this.frame = frame;</span>

<span class="nc bnc" id="L329" title="All 2 branches missed.">        this.docTitle = (doctitle == null) ? &quot;&quot; : doctitle;</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">        this.jobAttributes = (jobAttributes != null)</span>
            ? jobAttributes : new JobAttributes();
<span class="nc bnc" id="L332" title="All 2 branches missed.">        this.pageAttributes = (pageAttributes != null)</span>
            ? pageAttributes : new PageAttributes();

        // Currently, we always reduce page ranges to xxx or xxx-xxx
<span class="nc" id="L336">        int[][] pageRanges = this.jobAttributes.getPageRanges();</span>
<span class="nc" id="L337">        int first = pageRanges[0][0];</span>
<span class="nc" id="L338">        int last = pageRanges[pageRanges.length - 1][1];</span>
<span class="nc" id="L339">        this.jobAttributes.setPageRanges(new int[][] {</span>
            new int[] { first, last }
        });
<span class="nc" id="L342">        this.jobAttributes.setToPage(last);</span>
<span class="nc" id="L343">        this.jobAttributes.setFromPage(first);</span>


        // Verify that the cross feed and feed resolutions are the same
<span class="nc" id="L347">        int[] res = this.pageAttributes.getPrinterResolution();</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (res[0] != res[1]) {</span>
<span class="nc" id="L349">            throw new IllegalArgumentException(&quot;Differing cross feed and feed&quot;+</span>
                                               &quot; resolutions not supported.&quot;);
        }

        // Verify that the app has access to the file system
<span class="nc" id="L354">        DestinationType dest= this.jobAttributes.getDestination();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (dest == DestinationType.FILE) {</span>
<span class="nc" id="L356">            throwPrintToFile();</span>

            // check if given filename is valid
<span class="nc" id="L359">            String destStr = jobAttributes.getFileName();</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if ((destStr != null) &amp;&amp;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                (jobAttributes.getDialog() == JobAttributes.DialogType.NONE)) {</span>

<span class="nc" id="L363">                File f = new File(destStr);</span>
                try {
                    // check if this is a new file and if filename chars are valid
                    // createNewFile returns false if file exists
<span class="nc bnc" id="L367" title="All 2 branches missed.">                    if (f.createNewFile()) {</span>
<span class="nc" id="L368">                        f.delete();</span>
                    }
<span class="nc" id="L370">                } catch (IOException ioe) {</span>
<span class="nc" id="L371">                    throw new IllegalArgumentException(&quot;Cannot write to file:&quot;+</span>
                                                       destStr);
<span class="nc" id="L373">                } catch (SecurityException se) {</span>
                    //There is already file read/write access so at this point
                    // only delete access is denied.  Just ignore it because in
                    // most cases the file created in createNewFile gets overwritten
                    // anyway.
<span class="nc" id="L378">                }</span>

<span class="nc" id="L380">                 File pFile = f.getParentFile();</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">                 if ((f.exists() &amp;&amp;</span>
<span class="nc bnc" id="L382" title="All 6 branches missed.">                      (!f.isFile() || !f.canWrite())) ||</span>
                     ((pFile != null) &amp;&amp;
<span class="nc bnc" id="L384" title="All 6 branches missed.">                      (!pFile.exists() || (pFile.exists() &amp;&amp; !pFile.canWrite())))) {</span>
<span class="nc" id="L385">                     throw new IllegalArgumentException(&quot;Cannot write to file:&quot;+</span>
                                                        destStr);
                 }
            }
        }
<span class="nc" id="L390">    }</span>

    public boolean printDialog() {

<span class="nc" id="L394">        boolean proceedWithPrint = false;</span>

<span class="nc" id="L396">        printerJob = PrinterJob.getPrinterJob();</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (printerJob == null) {</span>
<span class="nc" id="L398">            return false;</span>
        }
<span class="nc" id="L400">        DialogType d = this.jobAttributes.getDialog();</span>
<span class="nc" id="L401">        PrintService pServ = printerJob.getPrintService();</span>
<span class="nc bnc" id="L402" title="All 4 branches missed.">        if ((pServ == null) &amp;&amp;  (d == DialogType.NONE)){</span>
<span class="nc" id="L403">            return false;</span>
        }
<span class="nc" id="L405">        copyAttributes(pServ);</span>

<span class="nc" id="L407">        DefaultSelectionType select =</span>
<span class="nc" id="L408">            this.jobAttributes.getDefaultSelection();</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">        if (select == DefaultSelectionType.RANGE) {</span>
<span class="nc" id="L410">            attributes.add(SunPageSelection.RANGE);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">        } else if (select == DefaultSelectionType.SELECTION) {</span>
<span class="nc" id="L412">            attributes.add(SunPageSelection.SELECTION);</span>
        } else {
<span class="nc" id="L414">            attributes.add(SunPageSelection.ALL);</span>
        }

<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (frame != null) {</span>
<span class="nc" id="L418">             attributes.add(new DialogOwner(frame));</span>
         }

<span class="nc bnc" id="L421" title="All 2 branches missed.">        if ( d == DialogType.NONE) {</span>
<span class="nc" id="L422">            proceedWithPrint = true;</span>
        } else {
<span class="nc bnc" id="L424" title="All 2 branches missed.">            if (d == DialogType.NATIVE) {</span>
<span class="nc" id="L425">                attributes.add(DialogTypeSelection.NATIVE);</span>
            }  else { //  (d == DialogType.COMMON)
<span class="nc" id="L427">                attributes.add(DialogTypeSelection.COMMON);</span>
            }
<span class="nc bnc" id="L429" title="All 2 branches missed.">            if (proceedWithPrint = printerJob.printDialog(attributes)) {</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">                if (pServ == null) {</span>
                    // Windows gives an option to install a service
                    // when it detects there are no printers so
                    // we make sure we get the updated print service.
<span class="nc" id="L434">                    pServ = printerJob.getPrintService();</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">                    if (pServ == null) {</span>
<span class="nc" id="L436">                        return false;</span>
                    }
                }
<span class="nc" id="L439">                updateAttributes();</span>
<span class="nc" id="L440">                translateOutputProps();</span>
            }
        }

<span class="nc bnc" id="L444" title="All 2 branches missed.">        if (proceedWithPrint) {</span>

<span class="nc" id="L446">            JobName jname = (JobName)attributes.get(JobName.class);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">            if (jname != null) {</span>
<span class="nc" id="L448">                printerJob.setJobName(jname.toString());</span>
            }

<span class="nc" id="L451">            pageFormat = new PageFormat();</span>

<span class="nc" id="L453">            Media media = (Media)attributes.get(Media.class);</span>
<span class="nc" id="L454">            MediaSize mediaSize =  null;</span>
<span class="nc bnc" id="L455" title="All 4 branches missed.">            if (media != null  &amp;&amp; media instanceof MediaSizeName) {</span>
<span class="nc" id="L456">                mediaSize = MediaSize.getMediaSizeForName((MediaSizeName)media);</span>
            }

<span class="nc" id="L459">            Paper p = pageFormat.getPaper();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">            if (mediaSize != null) {</span>
<span class="nc" id="L461">                p.setSize(mediaSize.getX(MediaSize.INCH)*72.0,</span>
<span class="nc" id="L462">                          mediaSize.getY(MediaSize.INCH)*72.0);</span>
            }

<span class="nc bnc" id="L465" title="All 2 branches missed.">            if (pageAttributes.getOrigin()==OriginType.PRINTABLE) {</span>
                // AWT uses 1/4&quot; borders by default
<span class="nc" id="L467">                p.setImageableArea(18.0, 18.0,</span>
<span class="nc" id="L468">                                   p.getWidth()-36.0,</span>
<span class="nc" id="L469">                                   p.getHeight()-36.0);</span>
            } else {
<span class="nc" id="L471">                p.setImageableArea(0.0,0.0,p.getWidth(),p.getHeight());</span>
            }

<span class="nc" id="L474">            pageFormat.setPaper(p);</span>

<span class="nc" id="L476">            OrientationRequested orient =</span>
<span class="nc" id="L477">               (OrientationRequested)attributes.get(OrientationRequested.class);</span>
<span class="nc bnc" id="L478" title="All 4 branches missed.">            if (orient!= null &amp;&amp;</span>
                orient == OrientationRequested.REVERSE_LANDSCAPE) {
<span class="nc" id="L480">                pageFormat.setOrientation(PageFormat.REVERSE_LANDSCAPE);</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">            } else if (orient == OrientationRequested.LANDSCAPE) {</span>
<span class="nc" id="L482">                pageFormat.setOrientation(PageFormat.LANDSCAPE);</span>
            } else {
<span class="nc" id="L484">                pageFormat.setOrientation(PageFormat.PORTRAIT);</span>
                }

<span class="nc" id="L487">            printerJob.setPrintable(this, pageFormat);</span>

        }

<span class="nc" id="L491">        return proceedWithPrint;</span>
    }

    private void updateAttributes() {
<span class="nc" id="L495">        Copies c = (Copies)attributes.get(Copies.class);</span>
<span class="nc" id="L496">        jobAttributes.setCopies(c.getValue());</span>

<span class="nc" id="L498">        SunPageSelection sel =</span>
<span class="nc" id="L499">            (SunPageSelection)attributes.get(SunPageSelection.class);</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">        if (sel == SunPageSelection.RANGE) {</span>
<span class="nc" id="L501">            jobAttributes.setDefaultSelection(DefaultSelectionType.RANGE);</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">        } else if (sel == SunPageSelection.SELECTION) {</span>
<span class="nc" id="L503">            jobAttributes.setDefaultSelection(DefaultSelectionType.SELECTION);</span>
        } else {
<span class="nc" id="L505">            jobAttributes.setDefaultSelection(DefaultSelectionType.ALL);</span>
        }

<span class="nc" id="L508">        Destination dest = (Destination)attributes.get(Destination.class);</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">        if (dest != null) {</span>
<span class="nc" id="L510">            jobAttributes.setDestination(DestinationType.FILE);</span>
<span class="nc" id="L511">            jobAttributes.setFileName(dest.getURI().getPath());</span>
        } else {
<span class="nc" id="L513">            jobAttributes.setDestination(DestinationType.PRINTER);</span>
        }

<span class="nc" id="L516">        PrintService serv = printerJob.getPrintService();</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">        if (serv != null) {</span>
<span class="nc" id="L518">            jobAttributes.setPrinter(serv.getName());</span>
        }

<span class="nc" id="L521">        PageRanges range = (PageRanges)attributes.get(PageRanges.class);</span>
<span class="nc" id="L522">        int[][] members = range.getMembers();</span>
<span class="nc" id="L523">        jobAttributes.setPageRanges(members);</span>

<span class="nc" id="L525">        SheetCollate collation =</span>
<span class="nc" id="L526">            (SheetCollate)attributes.get(SheetCollate.class);</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (collation == SheetCollate.COLLATED) {</span>
<span class="nc" id="L528">            jobAttributes.setMultipleDocumentHandling(</span>
            MultipleDocumentHandlingType.SEPARATE_DOCUMENTS_COLLATED_COPIES);
        } else {
<span class="nc" id="L531">            jobAttributes.setMultipleDocumentHandling(</span>
            MultipleDocumentHandlingType.SEPARATE_DOCUMENTS_UNCOLLATED_COPIES);
        }

<span class="nc" id="L535">        Sides sides = (Sides)attributes.get(Sides.class);</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">        if (sides == Sides.TWO_SIDED_LONG_EDGE) {</span>
<span class="nc" id="L537">            jobAttributes.setSides(SidesType.TWO_SIDED_LONG_EDGE);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">        } else if (sides == Sides.TWO_SIDED_SHORT_EDGE) {</span>
<span class="nc" id="L539">            jobAttributes.setSides(SidesType.TWO_SIDED_SHORT_EDGE);</span>
        } else {
<span class="nc" id="L541">            jobAttributes.setSides(SidesType.ONE_SIDED);</span>
        }

        // PageAttributes

<span class="nc" id="L546">        Chromaticity color =</span>
<span class="nc" id="L547">            (Chromaticity)attributes.get(Chromaticity.class);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (color == Chromaticity.COLOR) {</span>
<span class="nc" id="L549">            pageAttributes.setColor(ColorType.COLOR);</span>
        } else {
<span class="nc" id="L551">            pageAttributes.setColor(ColorType.MONOCHROME);</span>
        }

<span class="nc" id="L554">        OrientationRequested orient =</span>
<span class="nc" id="L555">            (OrientationRequested)attributes.get(OrientationRequested.class);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">        if (orient == OrientationRequested.LANDSCAPE) {</span>
<span class="nc" id="L557">            pageAttributes.setOrientationRequested(</span>
                                       OrientationRequestedType.LANDSCAPE);
        } else {
<span class="nc" id="L560">            pageAttributes.setOrientationRequested(</span>
                                       OrientationRequestedType.PORTRAIT);
        }

<span class="nc" id="L564">        PrintQuality qual = (PrintQuality)attributes.get(PrintQuality.class);</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (qual == PrintQuality.DRAFT) {</span>
<span class="nc" id="L566">            pageAttributes.setPrintQuality(PrintQualityType.DRAFT);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">        } else if (qual == PrintQuality.HIGH) {</span>
<span class="nc" id="L568">            pageAttributes.setPrintQuality(PrintQualityType.HIGH);</span>
        } else { // NORMAL
<span class="nc" id="L570">            pageAttributes.setPrintQuality(PrintQualityType.NORMAL);</span>
        }

<span class="nc" id="L573">        Media msn = (Media)attributes.get(Media.class);</span>
<span class="nc bnc" id="L574" title="All 4 branches missed.">        if (msn != null &amp;&amp; msn instanceof MediaSizeName) {</span>
<span class="nc" id="L575">            MediaType mType = unMapMedia((MediaSizeName)msn);</span>

<span class="nc bnc" id="L577" title="All 2 branches missed.">            if (mType != null) {</span>
<span class="nc" id="L578">                pageAttributes.setMedia(mType);</span>
            }
        }
<span class="nc" id="L581">        debugPrintAttributes(false, false);</span>
<span class="nc" id="L582">    }</span>

    private void debugPrintAttributes(boolean ja, boolean pa ) {
<span class="nc bnc" id="L585" title="All 2 branches missed.">        if (ja) {</span>
<span class="nc" id="L586">            System.out.println(&quot;new Attributes\ncopies = &quot;+</span>
<span class="nc" id="L587">                               jobAttributes.getCopies()+</span>
                               &quot;\nselection = &quot;+
<span class="nc" id="L589">                               jobAttributes.getDefaultSelection()+</span>
<span class="nc" id="L590">                               &quot;\ndest &quot;+jobAttributes.getDestination()+</span>
<span class="nc" id="L591">                               &quot;\nfile &quot;+jobAttributes.getFileName()+</span>
<span class="nc" id="L592">                               &quot;\nfromPage &quot;+jobAttributes.getFromPage()+</span>
<span class="nc" id="L593">                               &quot;\ntoPage &quot;+jobAttributes.getToPage()+</span>
                               &quot;\ncollation &quot;+
<span class="nc" id="L595">                               jobAttributes.getMultipleDocumentHandling()+</span>
<span class="nc" id="L596">                               &quot;\nPrinter &quot;+jobAttributes.getPrinter()+</span>
<span class="nc" id="L597">                               &quot;\nSides2 &quot;+jobAttributes.getSides()</span>
                               );
        }

<span class="nc bnc" id="L601" title="All 2 branches missed.">        if (pa) {</span>
<span class="nc" id="L602">            System.out.println(&quot;new Attributes\ncolor = &quot;+</span>
<span class="nc" id="L603">                               pageAttributes.getColor()+</span>
                               &quot;\norientation = &quot;+
<span class="nc" id="L605">                               pageAttributes.getOrientationRequested()+</span>
<span class="nc" id="L606">                               &quot;\nquality &quot;+pageAttributes.getPrintQuality()+</span>
<span class="nc" id="L607">                               &quot;\nMedia2 &quot;+pageAttributes.getMedia()</span>
                               );
        }
<span class="nc" id="L610">    }</span>


    /* From JobAttributes we will copy job name and duplex printing
     * and destination.
     * The majority of the rest of the attributes are reflected
     * attributes.
     *
     * From PageAttributes we copy color, media size, orientation,
     * origin type, resolution and print quality.
     * We use the media, orientation in creating the page format, and
     * the origin type to set its imageable area.
     *
     * REMIND: Interpretation of resolution, additional media sizes.
     */
    private void copyAttributes(PrintService printServ) {

<span class="nc" id="L627">        attributes = new HashPrintRequestAttributeSet();</span>
<span class="nc" id="L628">        attributes.add(new JobName(docTitle, null));</span>
<span class="nc" id="L629">        PrintService pServ = printServ;</span>

<span class="nc" id="L631">        String printerName = jobAttributes.getPrinter();</span>
<span class="nc bnc" id="L632" title="All 4 branches missed.">        if (printerName != null &amp;&amp; printerName != &quot;&quot;</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">            &amp;&amp; !printerName.equals(pServ.getName())) {</span>

            // Search for the given printerName in the list of PrintServices
<span class="nc" id="L636">            PrintService []services = PrinterJob.lookupPrintServices();</span>
            try {
<span class="nc bnc" id="L638" title="All 2 branches missed.">                for (int i=0; i&lt;services.length; i++) {</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                    if (printerName.equals(services[i].getName())) {</span>
<span class="nc" id="L640">                        printerJob.setPrintService(services[i]);</span>
<span class="nc" id="L641">                        pServ = services[i];</span>
<span class="nc" id="L642">                        break;</span>
                    }
                }
<span class="nc" id="L645">            } catch (PrinterException pe) {</span>
<span class="nc" id="L646">            }</span>
        }

<span class="nc" id="L649">        DestinationType dest = jobAttributes.getDestination();</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">        if (dest == DestinationType.FILE &amp;&amp;</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">            pServ.isAttributeCategorySupported(Destination.class)) {</span>

<span class="nc" id="L653">            String fileName = jobAttributes.getFileName();</span>

            Destination defaultDest;
<span class="nc bnc" id="L656" title="All 2 branches missed.">            if (fileName == null &amp;&amp; (defaultDest = (Destination)pServ.</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                    getDefaultAttributeValue(Destination.class)) != null) {</span>
<span class="nc" id="L658">                attributes.add(defaultDest);</span>
            } else {
<span class="nc" id="L660">                URI uri = null;</span>
                try {
<span class="nc bnc" id="L662" title="All 2 branches missed.">                    if (fileName != null) {</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">                        if (fileName.equals(&quot;&quot;)) {</span>
<span class="nc" id="L664">                            fileName = &quot;.&quot;;</span>
                        }
                    } else {
                        // defaultDest should not be null.  The following code
                        // is only added to safeguard against a possible
                        // buggy implementation of a PrintService having a
                        // null default Destination.
<span class="nc" id="L671">                        fileName = &quot;out.prn&quot;;</span>
                    }
<span class="nc" id="L673">                    uri = (new File(fileName)).toURI();</span>
<span class="nc" id="L674">                } catch (SecurityException se) {</span>
                    try {
                        // '\\' file separator is illegal character in opaque
                        // part and causes URISyntaxException, so we replace
                        // it with '/'
<span class="nc" id="L679">                        fileName = fileName.replace('\\', '/');</span>
<span class="nc" id="L680">                        uri = new URI(&quot;file:&quot;+fileName);</span>
<span class="nc" id="L681">                    } catch (URISyntaxException e) {</span>
<span class="nc" id="L682">                    }</span>
<span class="nc" id="L683">                }</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">                if (uri != null) {</span>
<span class="nc" id="L685">                    attributes.add(new Destination(uri));</span>
                }
            }
        }
<span class="nc" id="L689">        attributes.add(new SunMinMaxPage(jobAttributes.getMinPage(),</span>
<span class="nc" id="L690">                                         jobAttributes.getMaxPage()));</span>
<span class="nc" id="L691">        SidesType sType = jobAttributes.getSides();</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">        if (sType == SidesType.TWO_SIDED_LONG_EDGE) {</span>
<span class="nc" id="L693">            attributes.add(Sides.TWO_SIDED_LONG_EDGE);</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">        } else if (sType == SidesType.TWO_SIDED_SHORT_EDGE) {</span>
<span class="nc" id="L695">            attributes.add(Sides.TWO_SIDED_SHORT_EDGE);</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">        } else if (sType == SidesType.ONE_SIDED) {</span>
<span class="nc" id="L697">            attributes.add(Sides.ONE_SIDED);</span>
        }

<span class="nc" id="L700">        MultipleDocumentHandlingType hType =</span>
<span class="nc" id="L701">          jobAttributes.getMultipleDocumentHandling();</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">        if (hType ==</span>
            MultipleDocumentHandlingType.SEPARATE_DOCUMENTS_COLLATED_COPIES) {
<span class="nc" id="L704">          attributes.add(SheetCollate.COLLATED);</span>
        } else {
<span class="nc" id="L706">          attributes.add(SheetCollate.UNCOLLATED);</span>
        }

<span class="nc" id="L709">        attributes.add(new Copies(jobAttributes.getCopies()));</span>

<span class="nc" id="L711">        attributes.add(new PageRanges(jobAttributes.getFromPage(),</span>
<span class="nc" id="L712">                                      jobAttributes.getToPage()));</span>

<span class="nc bnc" id="L714" title="All 2 branches missed.">        if (pageAttributes.getColor() == ColorType.COLOR) {</span>
<span class="nc" id="L715">            attributes.add(Chromaticity.COLOR);</span>
        } else {
<span class="nc" id="L717">            attributes.add(Chromaticity.MONOCHROME);</span>
        }

<span class="nc" id="L720">        pageFormat = printerJob.defaultPage();</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (pageAttributes.getOrientationRequested() ==</span>
            OrientationRequestedType.LANDSCAPE) {
<span class="nc" id="L723">            pageFormat.setOrientation(PageFormat.LANDSCAPE);</span>
<span class="nc" id="L724">                attributes.add(OrientationRequested.LANDSCAPE);</span>
        } else {
<span class="nc" id="L726">                pageFormat.setOrientation(PageFormat.PORTRAIT);</span>
<span class="nc" id="L727">                attributes.add(OrientationRequested.PORTRAIT);</span>
        }

<span class="nc" id="L730">        MediaType media = pageAttributes.getMedia();</span>
<span class="nc" id="L731">        MediaSizeName msn = mapMedia(media);</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">        if (msn != null) {</span>
<span class="nc" id="L733">            attributes.add(msn);</span>
        }

<span class="nc" id="L736">        PrintQualityType qType =</span>
<span class="nc" id="L737">            pageAttributes.getPrintQuality();</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">        if (qType == PrintQualityType.DRAFT) {</span>
<span class="nc" id="L739">            attributes.add(PrintQuality.DRAFT);</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">        } else if (qType == PrintQualityType.NORMAL) {</span>
<span class="nc" id="L741">            attributes.add(PrintQuality.NORMAL);</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">        } else if (qType == PrintQualityType.HIGH) {</span>
<span class="nc" id="L743">            attributes.add(PrintQuality.HIGH);</span>
        }
<span class="nc" id="L745">    }</span>

    /**
     * Gets a Graphics object that will draw to the next page.
     * The page is sent to the printer when the graphics
     * object is disposed.  This graphics object will also implement
     * the PrintGraphics interface.
     * @see PrintGraphics
     */
    public Graphics getGraphics() {

<span class="nc" id="L756">        Graphics printGraphics = null;</span>

<span class="nc" id="L758">        synchronized (this) {</span>
<span class="nc" id="L759">            ++pageIndex;</span>

            // Thread should not be created after end has been called.
            // One way to detect this is if any of the graphics queue
            //  has been closed.
<span class="nc bnc" id="L764" title="All 4 branches missed.">            if (pageIndex == 0 &amp;&amp; !graphicsToBeDrawn.isClosed()) {</span>

            /* We start a thread on which the PrinterJob will run.
             * The PrinterJob will ask for pages on that thread
             * and will use a message queue to fulfill the application's
             * requests for a Graphics on the application's
             * thread.
             */

<span class="nc" id="L773">                startPrinterJobThread();</span>

            }
<span class="nc" id="L776">            notify();</span>
<span class="nc" id="L777">        }</span>

        /* If the application has already been handed back
         * a graphics then we need to put that graphics into
         * the drawn queue so that the PrinterJob thread can
         * return to the print system.
         */
<span class="nc bnc" id="L784" title="All 2 branches missed.">        if (currentGraphics != null) {</span>
<span class="nc" id="L785">            graphicsDrawn.append(currentGraphics);</span>
<span class="nc" id="L786">            currentGraphics = null;</span>
        }

        /* We'll block here until a new graphics becomes
         * available.
         */

<span class="nc" id="L793">        currentGraphics = graphicsToBeDrawn.pop();</span>

<span class="nc bnc" id="L795" title="All 2 branches missed.">        if (currentGraphics instanceof PeekGraphics) {</span>
<span class="nc" id="L796">            ( (PeekGraphics) currentGraphics).setAWTDrawingOnly();</span>
<span class="nc" id="L797">            graphicsDrawn.append(currentGraphics);</span>
<span class="nc" id="L798">            currentGraphics = graphicsToBeDrawn.pop();</span>
        }


<span class="nc bnc" id="L802" title="All 2 branches missed.">        if (currentGraphics != null) {</span>

            /* In the PrintJob API, the origin is at the upper-
             * left of the imageable area when using the new &quot;printable&quot;
             * origin attribute, otherwise its the physical origin (for
             * backwards compatibility. We emulate this by createing
             * a PageFormat which matches and then performing the
             * translate to the origin. This is a no-op if physical
             * origin is specified.
             */
<span class="nc" id="L812">            currentGraphics.translate(pageFormat.getImageableX(),</span>
<span class="nc" id="L813">                                      pageFormat.getImageableY());</span>

            /* Scale to accommodate AWT's notion of printer resolution */
<span class="nc" id="L816">            double awtScale = 72.0/getPageResolutionInternal();</span>
<span class="nc" id="L817">            currentGraphics.scale(awtScale, awtScale);</span>

            /* The caller wants a Graphics instance but we do
             * not want them to make 2D calls. We can't hand
             * back a Graphics2D. The returned Graphics also
             * needs to implement PrintGraphics, so we wrap
             * the Graphics2D instance. The PrintJob API has
             * the application dispose of the Graphics so
             * we create a copy of the one returned by PrinterJob.
             */
<span class="nc" id="L827">            printGraphics = new ProxyPrintGraphics(currentGraphics.create(),</span>
                                                   this);

        }

<span class="nc" id="L832">        return printGraphics;</span>
    }

    /**
     * Returns the dimensions of the page in pixels.
     * The resolution of the page is chosen so that it
     * is similar to the screen resolution.
     * Except (since 1.3) when the application specifies a resolution.
     * In that case it it scaled accordingly.
     */
    public Dimension getPageDimension() {
        double wid, hgt, scale;
<span class="nc bnc" id="L844" title="All 2 branches missed.">        if (pageAttributes != null &amp;&amp;</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">            pageAttributes.getOrigin()==OriginType.PRINTABLE) {</span>
<span class="nc" id="L846">            wid = pageFormat.getImageableWidth();</span>
<span class="nc" id="L847">            hgt = pageFormat.getImageableHeight();</span>
        } else {
<span class="nc" id="L849">            wid = pageFormat.getWidth();</span>
<span class="nc" id="L850">            hgt = pageFormat.getHeight();</span>
        }
<span class="nc" id="L852">        scale = getPageResolutionInternal() / 72.0;</span>
<span class="nc" id="L853">        return new Dimension((int)(wid * scale), (int)(hgt * scale));</span>
    }

     private double getPageResolutionInternal() {
<span class="nc bnc" id="L857" title="All 2 branches missed.">        if (pageAttributes != null) {</span>
<span class="nc" id="L858">            int []res = pageAttributes.getPrinterResolution();</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">            if (res[2] == 3) {</span>
<span class="nc" id="L860">                return res[0];</span>
            } else /* if (res[2] == 4) */ {
<span class="nc" id="L862">                return (res[0] * 2.54);</span>
            }
        } else {
<span class="nc" id="L865">            return 72.0;</span>
        }
    }

    /**
     * Returns the resolution of the page in pixels per inch.
     * Note that this doesn't have to correspond to the physical
     * resolution of the printer.
     */
    public int getPageResolution() {
<span class="nc" id="L875">        return (int)getPageResolutionInternal();</span>
    }

    /**
     * Returns true if the last page will be printed first.
     */
    public boolean lastPageFirst() {
<span class="nc" id="L882">        return false;</span>
    }

    /**
     * Ends the print job and does any necessary cleanup.
     */
    public synchronized void end() {

        /* Prevent the PrinterJob thread from appending any more
         * graphics to the to-be-drawn queue
         */
<span class="nc" id="L893">        graphicsToBeDrawn.close();</span>

        /* If we have a currentGraphics it was the last one returned to the
         * PrintJob client. Append it to the drawn queue so that print()
         * will return allowing the page to be flushed.
         * This really ought to happen in dispose() but for whatever reason
         * that isn't how the old PrintJob worked even though its spec
         * said dispose() flushed the page.
         */
<span class="nc bnc" id="L902" title="All 2 branches missed.">        if (currentGraphics != null) {</span>
<span class="nc" id="L903">            graphicsDrawn.append(currentGraphics);</span>
        }
<span class="nc" id="L905">        graphicsDrawn.closeWhenEmpty();</span>

        /* Wait for the PrinterJob.print() thread to terminate, ensuring
         * that RasterPrinterJob has made its end doc call, and resources
         * are released, files closed etc.
         */
<span class="nc bnc" id="L911" title="All 4 branches missed.">        if( printerJobThread != null &amp;&amp; printerJobThread.isAlive() ){</span>
            try {
<span class="nc" id="L913">                printerJobThread.join();</span>
<span class="nc" id="L914">            } catch (InterruptedException e) {</span>
<span class="nc" id="L915">            }</span>
        }
<span class="nc" id="L917">    }</span>

    /**
     * Ends this print job once it is no longer referenced.
     * @see #end
     */
    public void finalize() {
<span class="nc" id="L924">        end();</span>
<span class="nc" id="L925">    }</span>

    /**
     * Prints the page at the specified index into the specified
     * {@link Graphics} context in the specified
     * format.  A &lt;code&gt;PrinterJob&lt;/code&gt; calls the
     * &lt;code&gt;Printable&lt;/code&gt; interface to request that a page be
     * rendered into the context specified by
     * &lt;code&gt;graphics&lt;/code&gt;.  The format of the page to be drawn is
     * specified by &lt;code&gt;pageFormat&lt;/code&gt;.  The zero based index
     * of the requested page is specified by &lt;code&gt;pageIndex&lt;/code&gt;.
     * If the requested page does not exist then this method returns
     * NO_SUCH_PAGE; otherwise PAGE_EXISTS is returned.
     * The &lt;code&gt;Graphics&lt;/code&gt; class or subclass implements the
     * {@link PrinterGraphics} interface to provide additional
     * information.  If the &lt;code&gt;Printable&lt;/code&gt; object
     * aborts the print job then it throws a {@link PrinterException}.
     * @param graphics the context into which the page is drawn
     * @param pageFormat the size and orientation of the page being drawn
     * @param pageIndex the zero based index of the page to be drawn
     * @return PAGE_EXISTS if the page is rendered successfully
     *         or NO_SUCH_PAGE if &lt;code&gt;pageIndex&lt;/code&gt; specifies a
     *         non-existent page.
     * @exception java.awt.print.PrinterException
     *         thrown when the print job is terminated.
     */
    public int print(Graphics graphics, PageFormat pageFormat, int pageIndex)
                 throws PrinterException {

        int result;

        /* This method will be called by the PrinterJob on a thread other
         * that the application's thread. We hold on to the graphics
         * until we can rendevous with the application's thread and
         * hand over the graphics. The application then does all the
         * drawing. When the application is done drawing we rendevous
         * again with the PrinterJob thread and release the Graphics
         * so that it knows we are done.
         */

        /* Add the graphics to the message queue of graphics to
         * be rendered. This is really a one slot queue. The
         * application's thread will come along and remove the
         * graphics from the queue when the app asks for a graphics.
         */
<span class="nc" id="L970">        graphicsToBeDrawn.append( (Graphics2D) graphics);</span>

        /* We now wait for the app's thread to finish drawing on
         * the Graphics. This thread will sleep until the application
         * release the graphics by placing it in the graphics drawn
         * message queue. If the application signals that it is
         * finished drawing the entire document then we'll get null
         * returned when we try and pop a finished graphic.
         */
<span class="nc bnc" id="L979" title="All 2 branches missed.">        if (graphicsDrawn.pop() != null) {</span>
<span class="nc" id="L980">            result = PAGE_EXISTS;</span>
        } else {
<span class="nc" id="L982">            result = NO_SUCH_PAGE;</span>
        }

<span class="nc" id="L985">        return result;</span>
    }

    private void startPrinterJobThread() {

<span class="nc" id="L990">        printerJobThread = new Thread(this, &quot;printerJobThread&quot;);</span>
<span class="nc" id="L991">        printerJobThread.start();</span>
<span class="nc" id="L992">    }</span>


    public void run() {

        try {
<span class="nc" id="L998">            printerJob.print(attributes);</span>
<span class="nc" id="L999">        } catch (PrinterException e) {</span>
            //REMIND: need to store this away and not rethrow it.
<span class="nc" id="L1001">        }</span>

        /* Close the message queues so that nobody is stuck
         * waiting for one.
         */
<span class="nc" id="L1006">        graphicsToBeDrawn.closeWhenEmpty();</span>
<span class="nc" id="L1007">        graphicsDrawn.close();</span>
<span class="nc" id="L1008">    }</span>

    private class MessageQ {

<span class="nc" id="L1012">        private String qid=&quot;noname&quot;;</span>

<span class="nc" id="L1014">        private ArrayList queue = new ArrayList();</span>

<span class="nc" id="L1016">        MessageQ(String id) {</span>
<span class="nc" id="L1017">          qid = id;</span>
<span class="nc" id="L1018">        }</span>

        synchronized void closeWhenEmpty() {

<span class="nc bnc" id="L1022" title="All 4 branches missed.">            while (queue != null &amp;&amp; queue.size() &gt; 0) {</span>
                try {
<span class="nc" id="L1024">                    wait(1000);</span>
<span class="nc" id="L1025">                } catch (InterruptedException e) {</span>
                    // do nothing.
<span class="nc" id="L1027">                }</span>
            }

<span class="nc" id="L1030">            queue = null;</span>
<span class="nc" id="L1031">            notifyAll();</span>
<span class="nc" id="L1032">        }</span>

        synchronized void close() {
<span class="nc" id="L1035">            queue = null;</span>
<span class="nc" id="L1036">            notifyAll();</span>
<span class="nc" id="L1037">        }</span>

        synchronized boolean append(Graphics2D g) {

<span class="nc" id="L1041">            boolean queued = false;</span>

<span class="nc bnc" id="L1043" title="All 2 branches missed.">            if (queue != null) {</span>
<span class="nc" id="L1044">                queue.add(g);</span>
<span class="nc" id="L1045">                queued = true;</span>
<span class="nc" id="L1046">                notify();</span>
            }

<span class="nc" id="L1049">            return queued;</span>
        }

        synchronized Graphics2D pop() {
<span class="nc" id="L1053">            Graphics2D g = null;</span>

<span class="nc bnc" id="L1055" title="All 4 branches missed.">            while (g == null &amp;&amp; queue != null) {</span>

<span class="nc bnc" id="L1057" title="All 2 branches missed.">                if (queue.size() &gt; 0) {</span>
<span class="nc" id="L1058">                    g = (Graphics2D) queue.remove(0);</span>
<span class="nc" id="L1059">                    notify();</span>

                } else {
                    try {
<span class="nc" id="L1063">                        wait(2000);</span>
<span class="nc" id="L1064">                    } catch (InterruptedException e) {</span>
                        // do nothing.
<span class="nc" id="L1066">                    }</span>
                }
            }

<span class="nc" id="L1070">            return g;</span>
        }

        synchronized boolean isClosed() {
<span class="nc bnc" id="L1074" title="All 2 branches missed.">            return queue == null;</span>
        }

    }


    private static int[] getSize(MediaType mType) {
<span class="nc" id="L1081">        int []dim = new int[2];</span>
<span class="nc" id="L1082">        dim[0] = 612;</span>
<span class="nc" id="L1083">        dim[1] = 792;</span>

<span class="nc bnc" id="L1085" title="All 2 branches missed.">        for (int i=0; i &lt; SIZES.length; i++) {</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">            if (SIZES[i] == mType) {</span>
<span class="nc" id="L1087">                dim[0] = WIDTHS[i];</span>
<span class="nc" id="L1088">                dim[1] = LENGTHS[i];</span>
<span class="nc" id="L1089">                break;</span>
            }
        }
<span class="nc" id="L1092">        return dim;</span>
    }

    public static MediaSizeName mapMedia(MediaType mType) {
<span class="nc" id="L1096">        MediaSizeName media = null;</span>

        // JAVAXSIZES.length and SIZES.length must be equal!
        // Attempt to recover by getting the smaller size.
<span class="nc" id="L1100">        int length = Math.min(SIZES.length, JAVAXSIZES.length);</span>

<span class="nc bnc" id="L1102" title="All 2 branches missed.">        for (int i=0; i &lt; length; i++) {</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">            if (SIZES[i] == mType) {</span>
<span class="nc bnc" id="L1104" title="All 2 branches missed.">                if ((JAVAXSIZES[i] != null) &amp;&amp;</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">                    MediaSize.getMediaSizeForName(JAVAXSIZES[i]) != null) {</span>
<span class="nc" id="L1106">                    media = JAVAXSIZES[i];</span>
<span class="nc" id="L1107">                    break;</span>
                } else {
                    /* create Custom Media */
<span class="nc" id="L1110">                    media = new CustomMediaSizeName(SIZES[i].toString());</span>

<span class="nc" id="L1112">                    float w = (float)Math.rint(WIDTHS[i]  / 72.0);</span>
<span class="nc" id="L1113">                    float h = (float)Math.rint(LENGTHS[i] / 72.0);</span>
<span class="nc bnc" id="L1114" title="All 4 branches missed.">                    if (w &gt; 0.0 &amp;&amp; h &gt; 0.0) {</span>
                        // add new created MediaSize to our static map
                        // so it will be found when we call findMedia
<span class="nc" id="L1117">                        new MediaSize(w, h, Size2DSyntax.INCH, media);</span>
                    }

                    break;
                }
            }
        }
<span class="nc" id="L1124">        return media;</span>
    }


    public static MediaType unMapMedia(MediaSizeName mSize) {
<span class="nc" id="L1129">        MediaType media = null;</span>

        // JAVAXSIZES.length and SIZES.length must be equal!
        // Attempt to recover by getting the smaller size.
<span class="nc" id="L1133">        int length = Math.min(SIZES.length, JAVAXSIZES.length);</span>

<span class="nc bnc" id="L1135" title="All 2 branches missed.">        for (int i=0; i &lt; length; i++) {</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">            if (JAVAXSIZES[i] == mSize) {</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">                if (SIZES[i] != null) {</span>
<span class="nc" id="L1138">                    media = SIZES[i];</span>
<span class="nc" id="L1139">                    break;</span>
                }
            }
        }
<span class="nc" id="L1143">        return media;</span>
    }

    private void translateInputProps() {
<span class="nc bnc" id="L1147" title="All 2 branches missed.">        if (props == null) {</span>
<span class="nc" id="L1148">            return;</span>
        }

        String str;

<span class="nc" id="L1153">        str = props.getProperty(DEST_PROP);</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">        if (str != null) {</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">            if (str.equals(PRINTER)) {</span>
<span class="nc" id="L1156">                jobAttributes.setDestination(DestinationType.PRINTER);</span>
<span class="nc bnc" id="L1157" title="All 2 branches missed.">            } else if (str.equals(FILE)) {</span>
<span class="nc" id="L1158">                jobAttributes.setDestination(DestinationType.FILE);</span>
            }
        }
<span class="nc" id="L1161">        str = props.getProperty(PRINTER_PROP);</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">        if (str != null) {</span>
<span class="nc" id="L1163">            jobAttributes.setPrinter(str);</span>
        }
<span class="nc" id="L1165">        str = props.getProperty(FILENAME_PROP);</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">        if (str != null) {</span>
<span class="nc" id="L1167">            jobAttributes.setFileName(str);</span>
        }
<span class="nc" id="L1169">        str = props.getProperty(NUMCOPIES_PROP);</span>
<span class="nc bnc" id="L1170" title="All 2 branches missed.">        if (str != null) {</span>
<span class="nc" id="L1171">            jobAttributes.setCopies(Integer.parseInt(str));</span>
        }

<span class="nc" id="L1174">        this.options = props.getProperty(OPTIONS_PROP, &quot;&quot;);</span>

<span class="nc" id="L1176">        str = props.getProperty(ORIENT_PROP);</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">        if (str != null) {</span>
<span class="nc bnc" id="L1178" title="All 2 branches missed.">            if (str.equals(PORTRAIT)) {</span>
<span class="nc" id="L1179">                pageAttributes.setOrientationRequested(</span>
                                        OrientationRequestedType.PORTRAIT);
<span class="nc bnc" id="L1181" title="All 2 branches missed.">            } else if (str.equals(LANDSCAPE)) {</span>
<span class="nc" id="L1182">                pageAttributes.setOrientationRequested(</span>
                                        OrientationRequestedType.LANDSCAPE);
            }
        }
<span class="nc" id="L1186">        str = props.getProperty(PAPERSIZE_PROP);</span>
<span class="nc bnc" id="L1187" title="All 2 branches missed.">        if (str != null) {</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">            if (str.equals(LETTER)) {</span>
<span class="nc" id="L1189">                pageAttributes.setMedia(SIZES[MediaType.LETTER.hashCode()]);</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">            } else if (str.equals(LEGAL)) {</span>
<span class="nc" id="L1191">                pageAttributes.setMedia(SIZES[MediaType.LEGAL.hashCode()]);</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">            } else if (str.equals(EXECUTIVE)) {</span>
<span class="nc" id="L1193">                pageAttributes.setMedia(SIZES[MediaType.EXECUTIVE.hashCode()]);</span>
<span class="nc bnc" id="L1194" title="All 2 branches missed.">            } else if (str.equals(A4)) {</span>
<span class="nc" id="L1195">                pageAttributes.setMedia(SIZES[MediaType.A4.hashCode()]);</span>
            }
        }
<span class="nc" id="L1198">    }</span>

    private void translateOutputProps() {
<span class="nc bnc" id="L1201" title="All 2 branches missed.">        if (props == null) {</span>
<span class="nc" id="L1202">            return;</span>
        }

        String str;

<span class="nc" id="L1207">        props.setProperty(DEST_PROP,</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">            (jobAttributes.getDestination() == DestinationType.PRINTER) ?</span>
                          PRINTER : FILE);
<span class="nc" id="L1210">        str = jobAttributes.getPrinter();</span>
<span class="nc bnc" id="L1211" title="All 4 branches missed.">        if (str != null &amp;&amp; !str.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1212">            props.setProperty(PRINTER_PROP, str);</span>
        }
<span class="nc" id="L1214">        str = jobAttributes.getFileName();</span>
<span class="nc bnc" id="L1215" title="All 4 branches missed.">        if (str != null &amp;&amp; !str.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1216">            props.setProperty(FILENAME_PROP, str);</span>
        }
<span class="nc" id="L1218">        int copies = jobAttributes.getCopies();</span>
<span class="nc bnc" id="L1219" title="All 2 branches missed.">        if (copies &gt; 0) {</span>
<span class="nc" id="L1220">            props.setProperty(NUMCOPIES_PROP, &quot;&quot; + copies);</span>
        }
<span class="nc" id="L1222">        str = this.options;</span>
<span class="nc bnc" id="L1223" title="All 4 branches missed.">        if (str != null &amp;&amp; !str.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1224">            props.setProperty(OPTIONS_PROP, str);</span>
        }
<span class="nc" id="L1226">        props.setProperty(ORIENT_PROP,</span>
<span class="nc bnc" id="L1227" title="All 2 branches missed.">            (pageAttributes.getOrientationRequested() ==</span>
             OrientationRequestedType.PORTRAIT)
                          ? PORTRAIT : LANDSCAPE);
<span class="nc" id="L1230">        MediaType media = SIZES[pageAttributes.getMedia().hashCode()];</span>
<span class="nc bnc" id="L1231" title="All 2 branches missed.">        if (media == MediaType.LETTER) {</span>
<span class="nc" id="L1232">            str = LETTER;</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">        } else if (media == MediaType.LEGAL) {</span>
<span class="nc" id="L1234">            str = LEGAL;</span>
<span class="nc bnc" id="L1235" title="All 2 branches missed.">        } else if (media == MediaType.EXECUTIVE) {</span>
<span class="nc" id="L1236">            str = EXECUTIVE;</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">        } else if (media == MediaType.A4) {</span>
<span class="nc" id="L1238">            str = A4;</span>
        } else {
<span class="nc" id="L1240">            str = media.toString();</span>
        }
<span class="nc" id="L1242">        props.setProperty(PAPERSIZE_PROP, str);</span>
<span class="nc" id="L1243">    }</span>

    private void throwPrintToFile() {
<span class="nc" id="L1246">        SecurityManager security = System.getSecurityManager();</span>
<span class="nc" id="L1247">        FilePermission printToFilePermission = null;</span>
<span class="nc bnc" id="L1248" title="All 2 branches missed.">        if (security != null) {</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">            if (printToFilePermission == null) {</span>
<span class="nc" id="L1250">                printToFilePermission =</span>
                    new FilePermission(&quot;&lt;&lt;ALL FILES&gt;&gt;&quot;, &quot;read,write&quot;);
            }
<span class="nc" id="L1253">            security.checkPermission(printToFilePermission);</span>
        }
<span class="nc" id="L1255">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>