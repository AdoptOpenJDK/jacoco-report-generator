<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>PSStreamPrintJob.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.print</a> &gt; <span class="el_source">PSStreamPrintJob.java</span></div><h1>PSStreamPrintJob.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2005, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.print;

import java.net.URL;
import java.io.InputStream;
import java.io.IOException;
import java.io.Reader;
import java.util.Vector;

import javax.print.CancelablePrintJob;
import javax.print.Doc;
import javax.print.DocFlavor;
import javax.print.DocPrintJob;
import javax.print.PrintService;
import javax.print.PrintException;
import javax.print.event.PrintJobEvent;
import javax.print.event.PrintJobListener;
import javax.print.event.PrintJobAttributeListener;

import javax.print.attribute.Attribute;
import javax.print.attribute.AttributeSet;
import javax.print.attribute.AttributeSetUtilities;
import javax.print.attribute.DocAttributeSet;
import javax.print.attribute.HashPrintJobAttributeSet;
import javax.print.attribute.HashPrintRequestAttributeSet;
import javax.print.attribute.PrintJobAttribute;
import javax.print.attribute.PrintJobAttributeSet;
import javax.print.attribute.PrintRequestAttribute;
import javax.print.attribute.PrintRequestAttributeSet;
import javax.print.attribute.standard.Copies;
import javax.print.attribute.standard.DocumentName;
import javax.print.attribute.standard.Fidelity;
import javax.print.attribute.standard.JobName;
import javax.print.attribute.standard.JobOriginatingUserName;
import javax.print.attribute.standard.Media;
import javax.print.attribute.standard.MediaSize;
import javax.print.attribute.standard.MediaSizeName;
import javax.print.attribute.standard.OrientationRequested;
import javax.print.attribute.standard.RequestingUserName;

import java.awt.print.*;

public class PSStreamPrintJob implements CancelablePrintJob {

    transient private Vector jobListeners;
    transient private Vector attrListeners;
    transient private Vector listenedAttributeSets;

    private PSStreamPrintService service;
    private boolean fidelity;
<span class="nc" id="L75">    private boolean printing = false;</span>
<span class="nc" id="L76">    private boolean printReturned = false;</span>
<span class="nc" id="L77">    private PrintRequestAttributeSet reqAttrSet = null;</span>
<span class="nc" id="L78">    private PrintJobAttributeSet jobAttrSet = null;</span>
    private PrinterJob job;
    private Doc doc;
    /* these variables used globally to store reference to the print
     * data retrieved as a stream. On completion these are always closed
     * if non-null.
     */
<span class="nc" id="L85">    private InputStream instream = null;</span>
<span class="nc" id="L86">    private Reader reader = null;</span>

    /* default values overridden by those extracted from the attributes */
<span class="nc" id="L89">    private String jobName = &quot;Java Printing&quot;;</span>
<span class="nc" id="L90">    private int copies = 1;</span>
<span class="nc" id="L91">    private MediaSize     mediaSize = MediaSize.NA.LETTER;</span>
<span class="nc" id="L92">    private OrientationRequested orient = OrientationRequested.PORTRAIT;</span>

<span class="nc" id="L94">    PSStreamPrintJob(PSStreamPrintService service) {</span>
<span class="nc" id="L95">        this.service = service;</span>
<span class="nc" id="L96">    }</span>

    public PrintService getPrintService() {
<span class="nc" id="L99">        return service;</span>
    }

    public PrintJobAttributeSet getAttributes() {
<span class="nc" id="L103">        synchronized (this) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (jobAttrSet == null) {</span>
                /* just return an empty set until the job is submitted */
<span class="nc" id="L106">                PrintJobAttributeSet jobSet = new HashPrintJobAttributeSet();</span>
<span class="nc" id="L107">                return AttributeSetUtilities.unmodifiableView(jobSet);</span>
            } else {
<span class="nc" id="L109">                return jobAttrSet;</span>
            }
<span class="nc" id="L111">        }</span>
    }

    public void addPrintJobListener(PrintJobListener listener) {
<span class="nc" id="L115">        synchronized (this) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (listener == null) {</span>
<span class="nc" id="L117">                return;</span>
            }
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (jobListeners == null) {</span>
<span class="nc" id="L120">                jobListeners = new Vector();</span>
            }
<span class="nc" id="L122">            jobListeners.add(listener);</span>
<span class="nc" id="L123">        }</span>
<span class="nc" id="L124">    }</span>

    public void removePrintJobListener(PrintJobListener listener) {
<span class="nc" id="L127">        synchronized (this) {</span>
<span class="nc bnc" id="L128" title="All 4 branches missed.">            if (listener == null || jobListeners == null ) {</span>
<span class="nc" id="L129">                return;</span>
            }
<span class="nc" id="L131">            jobListeners.remove(listener);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            if (jobListeners.isEmpty()) {</span>
<span class="nc" id="L133">                jobListeners = null;</span>
            }
<span class="nc" id="L135">        }</span>
<span class="nc" id="L136">    }</span>

    /* Closes any stream already retrieved for the data.
     * We want to avoid unnecessarily asking the Doc to create a stream only
     * to get a reference in order to close it because the job failed.
     * If the representation class is itself a &quot;stream&quot;, this
     * closes that stream too.
     */
    private void closeDataStreams() {

<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (doc == null) {</span>
<span class="nc" id="L147">            return;</span>
        }

<span class="nc" id="L150">        Object data = null;</span>

        try {
<span class="nc" id="L153">            data = doc.getPrintData();</span>
<span class="nc" id="L154">        } catch (IOException e) {</span>
<span class="nc" id="L155">            return;</span>
<span class="nc" id="L156">        }</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (instream != null) {</span>
            try {
<span class="nc" id="L160">                instream.close();</span>
<span class="nc" id="L161">            } catch (IOException e) {</span>
            } finally {
<span class="nc" id="L163">                instream = null;</span>
<span class="nc" id="L164">            }</span>
        }
<span class="nc bnc" id="L166" title="All 2 branches missed.">        else if (reader != null) {</span>
            try {
<span class="nc" id="L168">                reader.close();</span>
<span class="nc" id="L169">            } catch (IOException e) {</span>
            } finally {
<span class="nc" id="L171">                reader = null;</span>
<span class="nc" id="L172">            }</span>
        }
<span class="nc bnc" id="L174" title="All 2 branches missed.">        else if (data instanceof InputStream) {</span>
            try {
<span class="nc" id="L176">                ((InputStream)data).close();</span>
<span class="nc" id="L177">            } catch (IOException e) {</span>
<span class="nc" id="L178">            }</span>
        }
<span class="nc bnc" id="L180" title="All 2 branches missed.">        else if (data instanceof Reader) {</span>
            try {
<span class="nc" id="L182">                ((Reader)data).close();</span>
<span class="nc" id="L183">            } catch (IOException e) {</span>
<span class="nc" id="L184">            }</span>
        }
<span class="nc" id="L186">    }</span>

    private void notifyEvent(int reason) {
<span class="nc" id="L189">        synchronized (this) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (jobListeners != null) {</span>
                PrintJobListener listener;
<span class="nc" id="L192">                PrintJobEvent event = new PrintJobEvent(this, reason);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                for (int i = 0; i &lt; jobListeners.size(); i++) {</span>
<span class="nc" id="L194">                    listener = (PrintJobListener)(jobListeners.elementAt(i));</span>
<span class="nc bnc" id="L195" title="All 6 branches missed.">                    switch (reason) {</span>

                        case PrintJobEvent.JOB_CANCELED :
<span class="nc" id="L198">                            listener.printJobCanceled(event);</span>
<span class="nc" id="L199">                            break;</span>

                        case PrintJobEvent.JOB_FAILED :
<span class="nc" id="L202">                            listener.printJobFailed(event);</span>
<span class="nc" id="L203">                            break;</span>

                        case PrintJobEvent.DATA_TRANSFER_COMPLETE :
<span class="nc" id="L206">                            listener.printDataTransferCompleted(event);</span>
<span class="nc" id="L207">                            break;</span>

                        case PrintJobEvent.NO_MORE_EVENTS :
<span class="nc" id="L210">                            listener.printJobNoMoreEvents(event);</span>
<span class="nc" id="L211">                            break;</span>

                        case PrintJobEvent.JOB_COMPLETE :
<span class="nc" id="L214">                            listener.printJobCompleted(event);</span>
<span class="nc" id="L215">                            break;</span>

                        default:
                            break;
                    }
                }
            }
<span class="nc" id="L222">       }</span>
<span class="nc" id="L223">    }</span>

    public void addPrintJobAttributeListener(
                                  PrintJobAttributeListener listener,
                                  PrintJobAttributeSet attributes) {
<span class="nc" id="L228">        synchronized (this) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">            if (listener == null) {</span>
<span class="nc" id="L230">                return;</span>
            }
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (attrListeners == null) {</span>
<span class="nc" id="L233">                attrListeners = new Vector();</span>
<span class="nc" id="L234">                listenedAttributeSets = new Vector();</span>
            }
<span class="nc" id="L236">            attrListeners.add(listener);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (attributes == null) {</span>
<span class="nc" id="L238">                attributes = new HashPrintJobAttributeSet();</span>
            }
<span class="nc" id="L240">            listenedAttributeSets.add(attributes);</span>
<span class="nc" id="L241">        }</span>
<span class="nc" id="L242">    }</span>

    public void removePrintJobAttributeListener(
                                        PrintJobAttributeListener listener) {
<span class="nc" id="L246">        synchronized (this) {</span>
<span class="nc bnc" id="L247" title="All 4 branches missed.">            if (listener == null || attrListeners == null ) {</span>
<span class="nc" id="L248">                return;</span>
            }
<span class="nc" id="L250">            int index = attrListeners.indexOf(listener);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (index == -1) {</span>
<span class="nc" id="L252">                return;</span>
            } else {
<span class="nc" id="L254">                attrListeners.remove(index);</span>
<span class="nc" id="L255">                listenedAttributeSets.remove(index);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                if (attrListeners.isEmpty()) {</span>
<span class="nc" id="L257">                    attrListeners = null;</span>
<span class="nc" id="L258">                    listenedAttributeSets = null;</span>
                }
            }
<span class="nc" id="L261">        }</span>
<span class="nc" id="L262">    }</span>

    public void print(Doc doc, PrintRequestAttributeSet attributes)
        throws PrintException {

<span class="nc" id="L267">        synchronized (this) {</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (printing) {</span>
<span class="nc" id="L269">                throw new PrintException(&quot;already printing&quot;);</span>
            } else {
<span class="nc" id="L271">                printing = true;</span>
            }
<span class="nc" id="L273">        }</span>

<span class="nc" id="L275">        this.doc = doc;</span>
        /* check if the parameters are valid before doing much processing */
<span class="nc" id="L277">        DocFlavor flavor = doc.getDocFlavor();</span>
        Object data;

        try {
<span class="nc" id="L281">            data = doc.getPrintData();</span>
<span class="nc" id="L282">        } catch (IOException e) {</span>
<span class="nc" id="L283">            notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L284">            throw new PrintException(&quot;can't get print data: &quot; + e.toString());</span>
<span class="nc" id="L285">        }</span>

<span class="nc bnc" id="L287" title="All 4 branches missed.">        if (flavor == null || (!service.isDocFlavorSupported(flavor))) {</span>
<span class="nc" id="L288">            notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L289">            throw new PrintJobFlavorException(&quot;invalid flavor&quot;, flavor);</span>
        }

<span class="nc" id="L292">        initializeAttributeSets(doc, attributes);</span>

<span class="nc" id="L294">        getAttributeValues(flavor);</span>

<span class="nc" id="L296">        String repClassName = flavor.getRepresentationClassName();</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (flavor.equals(DocFlavor.INPUT_STREAM.GIF) ||</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">            flavor.equals(DocFlavor.INPUT_STREAM.JPEG) ||</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            flavor.equals(DocFlavor.INPUT_STREAM.PNG) ||</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">            flavor.equals(DocFlavor.BYTE_ARRAY.GIF) ||</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">            flavor.equals(DocFlavor.BYTE_ARRAY.JPEG) ||</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            flavor.equals(DocFlavor.BYTE_ARRAY.PNG)) {</span>
            try {
<span class="nc" id="L304">                instream = doc.getStreamForBytes();</span>
<span class="nc" id="L305">                printableJob(new ImagePrinter(instream), reqAttrSet);</span>
<span class="nc" id="L306">                return;</span>
<span class="nc" id="L307">            } catch (ClassCastException cce) {</span>
<span class="nc" id="L308">                notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L309">                throw new PrintException(cce);</span>
<span class="nc" id="L310">            } catch (IOException ioe) {</span>
<span class="nc" id="L311">                notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L312">                throw new PrintException(ioe);</span>
            }
<span class="nc bnc" id="L314" title="All 2 branches missed.">        } else if (flavor.equals(DocFlavor.URL.GIF) ||</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                   flavor.equals(DocFlavor.URL.JPEG) ||</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                   flavor.equals(DocFlavor.URL.PNG)) {</span>
            try {
<span class="nc" id="L318">                printableJob(new ImagePrinter((URL)data), reqAttrSet);</span>
<span class="nc" id="L319">                return;</span>
<span class="nc" id="L320">            } catch (ClassCastException cce) {</span>
<span class="nc" id="L321">                notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L322">                throw new PrintException(cce);</span>
            }
<span class="nc bnc" id="L324" title="All 2 branches missed.">        } else if (repClassName.equals(&quot;java.awt.print.Pageable&quot;)) {</span>
            try {
<span class="nc" id="L326">                pageableJob((Pageable)doc.getPrintData(), reqAttrSet);</span>
<span class="nc" id="L327">                return;</span>
<span class="nc" id="L328">            } catch (ClassCastException cce) {</span>
<span class="nc" id="L329">                notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L330">                throw new PrintException(cce);</span>
<span class="nc" id="L331">            } catch (IOException ioe) {</span>
<span class="nc" id="L332">                notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L333">                throw new PrintException(ioe);</span>
            }
<span class="nc bnc" id="L335" title="All 2 branches missed.">        } else if (repClassName.equals(&quot;java.awt.print.Printable&quot;)) {</span>
            try {
<span class="nc" id="L337">                printableJob((Printable)doc.getPrintData(), reqAttrSet);</span>
<span class="nc" id="L338">                return;</span>
<span class="nc" id="L339">            } catch (ClassCastException cce) {</span>
<span class="nc" id="L340">                notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L341">                throw new PrintException(cce);</span>
<span class="nc" id="L342">            } catch (IOException ioe) {</span>
<span class="nc" id="L343">                notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L344">                throw new PrintException(ioe);</span>
            }
        } else {
<span class="nc" id="L347">            notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L348">            throw new PrintException(&quot;unrecognized class: &quot;+repClassName);</span>
        }
    }

    public void printableJob(Printable printable,
                             PrintRequestAttributeSet attributes)
        throws PrintException {
        try {
<span class="nc" id="L356">            synchronized(this) {</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">                if (job != null) { // shouldn't happen</span>
<span class="nc" id="L358">                    throw new PrintException(&quot;already printing&quot;);</span>
                } else {
<span class="nc" id="L360">                    job = new PSPrinterJob();</span>
                }
<span class="nc" id="L362">            }</span>
<span class="nc" id="L363">            job.setPrintService(getPrintService());</span>
<span class="nc" id="L364">            PageFormat pf = new PageFormat();</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (mediaSize != null) {</span>
<span class="nc" id="L366">                Paper p = new Paper();</span>
<span class="nc" id="L367">                p.setSize(mediaSize.getX(MediaSize.INCH)*72.0,</span>
<span class="nc" id="L368">                          mediaSize.getY(MediaSize.INCH)*72.0);</span>
<span class="nc" id="L369">                p.setImageableArea(72.0, 72.0, p.getWidth()-144.0,</span>
<span class="nc" id="L370">                                   p.getHeight()-144.0);</span>
<span class="nc" id="L371">                pf.setPaper(p);</span>
            }
<span class="nc bnc" id="L373" title="All 2 branches missed.">            if (orient == OrientationRequested.REVERSE_LANDSCAPE) {</span>
<span class="nc" id="L374">                pf.setOrientation(PageFormat.REVERSE_LANDSCAPE);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            } else if (orient == OrientationRequested.LANDSCAPE) {</span>
<span class="nc" id="L376">                pf.setOrientation(PageFormat.LANDSCAPE);</span>
            }
<span class="nc" id="L378">            job.setPrintable(printable, pf);</span>
<span class="nc" id="L379">            job.print(attributes);</span>
<span class="nc" id="L380">            notifyEvent(PrintJobEvent.JOB_COMPLETE);</span>
<span class="nc" id="L381">            return;</span>
<span class="nc" id="L382">        } catch (PrinterException pe) {</span>
<span class="nc" id="L383">            notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L384">            throw new PrintException(pe);</span>
        } finally {
<span class="nc" id="L386">            printReturned = true;</span>
        }
    }

    public void pageableJob(Pageable pageable,
                            PrintRequestAttributeSet attributes)
        throws PrintException {
        try {
<span class="nc" id="L394">            synchronized(this) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">                if (job != null) { // shouldn't happen</span>
<span class="nc" id="L396">                    throw new PrintException(&quot;already printing&quot;);</span>
                } else {
<span class="nc" id="L398">                    job = new PSPrinterJob();</span>
                }
<span class="nc" id="L400">            }</span>
<span class="nc" id="L401">            job.setPrintService(getPrintService());</span>
<span class="nc" id="L402">            job.setPageable(pageable);</span>
<span class="nc" id="L403">            job.print(attributes);</span>
<span class="nc" id="L404">            notifyEvent(PrintJobEvent.JOB_COMPLETE);</span>
<span class="nc" id="L405">            return;</span>
<span class="nc" id="L406">        } catch (PrinterException pe) {</span>
<span class="nc" id="L407">            notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L408">            throw new PrintException(pe);</span>
        } finally {
<span class="nc" id="L410">            printReturned = true;</span>
        }
    }

    /* There's some inefficiency here as the job set is created even though
     * it may never be requested.
     */
    private synchronized void
        initializeAttributeSets(Doc doc, PrintRequestAttributeSet reqSet) {

<span class="nc" id="L420">        reqAttrSet = new HashPrintRequestAttributeSet();</span>
<span class="nc" id="L421">        jobAttrSet = new HashPrintJobAttributeSet();</span>

        Attribute[] attrs;
<span class="nc bnc" id="L424" title="All 2 branches missed.">        if (reqSet != null) {</span>
<span class="nc" id="L425">            reqAttrSet.addAll(reqSet);</span>
<span class="nc" id="L426">            attrs = reqSet.toArray();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">            for (int i=0; i&lt;attrs.length; i++) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">                if (attrs[i] instanceof PrintJobAttribute) {</span>
<span class="nc" id="L429">                    jobAttrSet.add(attrs[i]);</span>
                }
            }
        }

<span class="nc" id="L434">        DocAttributeSet docSet = doc.getAttributes();</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (docSet != null) {</span>
<span class="nc" id="L436">            attrs = docSet.toArray();</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">            for (int i=0; i&lt;attrs.length; i++) {</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">                if (attrs[i] instanceof PrintRequestAttribute) {</span>
<span class="nc" id="L439">                    reqAttrSet.add(attrs[i]);</span>
                }
<span class="nc bnc" id="L441" title="All 2 branches missed.">                if (attrs[i] instanceof PrintJobAttribute) {</span>
<span class="nc" id="L442">                    jobAttrSet.add(attrs[i]);</span>
                }
            }
        }

        /* add the user name to the job */
<span class="nc" id="L448">        String userName = &quot;&quot;;</span>
        try {
<span class="nc" id="L450">          userName = System.getProperty(&quot;user.name&quot;);</span>
<span class="nc" id="L451">        } catch (SecurityException se) {</span>
<span class="nc" id="L452">        }</span>

<span class="nc bnc" id="L454" title="All 4 branches missed.">        if (userName == null || userName.equals(&quot;&quot;)) {</span>
<span class="nc" id="L455">            RequestingUserName ruName =</span>
<span class="nc" id="L456">                (RequestingUserName)reqSet.get(RequestingUserName.class);</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">            if (ruName != null) {</span>
<span class="nc" id="L458">                jobAttrSet.add(</span>
<span class="nc" id="L459">                    new JobOriginatingUserName(ruName.getValue(),</span>
<span class="nc" id="L460">                                               ruName.getLocale()));</span>
            } else {
<span class="nc" id="L462">                jobAttrSet.add(new JobOriginatingUserName(&quot;&quot;, null));</span>
            }
<span class="nc" id="L464">        } else {</span>
<span class="nc" id="L465">            jobAttrSet.add(new JobOriginatingUserName(userName, null));</span>
        }

        /* if no job name supplied use doc name (if supplied), if none and
         * its a URL use that, else finally anything .. */
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (jobAttrSet.get(JobName.class) == null) {</span>
            JobName jobName;
<span class="nc bnc" id="L472" title="All 4 branches missed.">            if (docSet != null &amp;&amp; docSet.get(DocumentName.class) != null) {</span>
<span class="nc" id="L473">                DocumentName docName =</span>
<span class="nc" id="L474">                    (DocumentName)docSet.get(DocumentName.class);</span>
<span class="nc" id="L475">                jobName = new JobName(docName.getValue(), docName.getLocale());</span>
<span class="nc" id="L476">                jobAttrSet.add(jobName);</span>
<span class="nc" id="L477">            } else {</span>
<span class="nc" id="L478">                String str = &quot;JPS Job:&quot; + doc;</span>
                try {
<span class="nc" id="L480">                    Object printData = doc.getPrintData();</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">                    if (printData instanceof URL) {</span>
<span class="nc" id="L482">                        str = ((URL)(doc.getPrintData())).toString();</span>
                    }
<span class="nc" id="L484">                } catch (IOException e) {</span>
<span class="nc" id="L485">                }</span>
<span class="nc" id="L486">                jobName = new JobName(str, null);</span>
<span class="nc" id="L487">                jobAttrSet.add(jobName);</span>
            }
        }

<span class="nc" id="L491">        jobAttrSet = AttributeSetUtilities.unmodifiableView(jobAttrSet);</span>
<span class="nc" id="L492">    }</span>

    private void getAttributeValues(DocFlavor flavor) throws PrintException {

        Attribute attr;
        Class category;

<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (reqAttrSet.get(Fidelity.class) == Fidelity.FIDELITY_TRUE) {</span>
<span class="nc" id="L500">            fidelity = true;</span>
        } else {
<span class="nc" id="L502">            fidelity = false;</span>
        }

<span class="nc" id="L505">        Attribute []attrs = reqAttrSet.toArray();</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        for (int i=0; i&lt;attrs.length; i++) {</span>
<span class="nc" id="L507">            attr = attrs[i];</span>
<span class="nc" id="L508">            category = attr.getCategory();</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">            if (fidelity == true) {</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                if (!service.isAttributeCategorySupported(category)) {</span>
<span class="nc" id="L511">                    notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L512">                    throw new PrintJobAttributeException(</span>
                        &quot;unsupported category: &quot; + category, category, null);
<span class="nc" id="L514">                } else if</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                    (!service.isAttributeValueSupported(attr, flavor, null)) {</span>
<span class="nc" id="L516">                    notifyEvent(PrintJobEvent.JOB_FAILED);</span>
<span class="nc" id="L517">                    throw new PrintJobAttributeException(</span>
                        &quot;unsupported attribute: &quot; + attr, null, attr);
                }
            }
<span class="nc bnc" id="L521" title="All 2 branches missed.">            if (category == JobName.class) {</span>
<span class="nc" id="L522">                jobName = ((JobName)attr).getValue();</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">            } else if (category == Copies.class) {</span>
<span class="nc" id="L524">                copies = ((Copies)attr).getValue();</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">            } else if (category == Media.class) {</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">                if (attr instanceof MediaSizeName &amp;&amp;</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                    service.isAttributeValueSupported(attr, null, null)) {</span>
<span class="nc" id="L528">                    mediaSize =</span>
<span class="nc" id="L529">                        MediaSize.getMediaSizeForName((MediaSizeName)attr);</span>
                }
<span class="nc bnc" id="L531" title="All 2 branches missed.">            } else if (category == OrientationRequested.class) {</span>
<span class="nc" id="L532">                orient = (OrientationRequested)attr;</span>
            }
        }
<span class="nc" id="L535">    }</span>

    /* Cancel PrinterJob jobs that haven't yet completed. */
    public void cancel() throws PrintException {
<span class="nc" id="L539">        synchronized (this) {</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">            if (!printing) {</span>
<span class="nc" id="L541">                throw new PrintException(&quot;Job is not yet submitted.&quot;);</span>
<span class="nc bnc" id="L542" title="All 4 branches missed.">            } else if (job != null &amp;&amp; !printReturned) {</span>
<span class="nc" id="L543">                job.cancel();</span>
<span class="nc" id="L544">                notifyEvent(PrintJobEvent.JOB_CANCELED);</span>
<span class="nc" id="L545">                return;</span>
            } else {
<span class="nc" id="L547">                throw new PrintException(&quot;Job could not be cancelled.&quot;);</span>
            }
<span class="nc" id="L549">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>