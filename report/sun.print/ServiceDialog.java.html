<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ServiceDialog.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.print</a> &gt; <span class="el_source">ServiceDialog.java</span></div><h1>ServiceDialog.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.print;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Container;
import java.awt.Dialog;
import java.awt.FlowLayout;
import java.awt.Frame;
import java.awt.GraphicsConfiguration;
import java.awt.GridBagLayout;
import java.awt.GridBagConstraints;
import java.awt.GridLayout;
import java.awt.Insets;
import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.FocusEvent;
import java.awt.event.FocusListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.awt.event.WindowEvent;
import java.awt.event.WindowAdapter;
import java.awt.print.PrinterJob;
import java.io.File;
import java.io.FilePermission;
import java.io.IOException;
import java.net.URI;
import java.net.URL;
import java.text.DecimalFormat;
import java.util.Locale;
import java.util.ResourceBundle;
import java.util.Vector;
import javax.print.*;
import javax.print.attribute.*;
import javax.print.attribute.standard.*;
import javax.swing.*;
import javax.swing.border.Border;
import javax.swing.border.EmptyBorder;
import javax.swing.border.TitledBorder;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.event.PopupMenuEvent;
import javax.swing.event.PopupMenuListener;
import javax.swing.text.NumberFormatter;
import sun.print.SunPageSelection;
import java.awt.event.KeyEvent;
import java.net.URISyntaxException;
import java.lang.reflect.Field;


/**
 * A class which implements a cross-platform print dialog.
 *
 * @author  Chris Campbell
 */
public class ServiceDialog extends JDialog implements ActionListener {

    /**
     * Waiting print status (user response pending).
     */
    public final static int WAITING = 0;

    /**
     * Approve print status (user activated &quot;Print&quot; or &quot;OK&quot;).
     */
    public final static int APPROVE = 1;

    /**
     * Cancel print status (user activated &quot;Cancel&quot;);
     */
    public final static int CANCEL = 2;

    private static final String strBundle = &quot;sun.print.resources.serviceui&quot;;
<span class="nc" id="L102">    private static final Insets panelInsets = new Insets(6, 6, 6, 6);</span>
<span class="nc" id="L103">    private static final Insets compInsets = new Insets(3, 6, 3, 6);</span>

    private static ResourceBundle messageRB;
    private JTabbedPane tpTabs;
    private JButton btnCancel, btnApprove;
    private PrintService[] services;
    private int defaultServiceIndex;
    private PrintRequestAttributeSet asOriginal;
    private HashPrintRequestAttributeSet asCurrent;
    private PrintService psCurrent;
    private DocFlavor docFlavor;
    private int status;

    private ValidatingFileChooser jfc;

    private GeneralPanel pnlGeneral;
    private PageSetupPanel pnlPageSetup;
    private AppearancePanel pnlAppearance;

<span class="nc" id="L122">    private boolean isAWT = false;</span>
    static {
<span class="nc" id="L124">        initResource();</span>
    }


    /**
     * Constructor for the &quot;standard&quot; print dialog (containing all relevant
     * tabs)
     */
    public ServiceDialog(GraphicsConfiguration gc,
                         int x, int y,
                         PrintService[] services,
                         int defaultServiceIndex,
                         DocFlavor flavor,
                         PrintRequestAttributeSet attributes,
                         Dialog dialog)
    {
<span class="nc" id="L140">        super(dialog, getMsg(&quot;dialog.printtitle&quot;), true, gc);</span>
<span class="nc" id="L141">        initPrintDialog(x, y, services, defaultServiceIndex,</span>
                        flavor, attributes);
<span class="nc" id="L143">    }</span>



    /**
     * Constructor for the &quot;standard&quot; print dialog (containing all relevant
     * tabs)
     */
    public ServiceDialog(GraphicsConfiguration gc,
                         int x, int y,
                         PrintService[] services,
                         int defaultServiceIndex,
                         DocFlavor flavor,
                         PrintRequestAttributeSet attributes,
                         Frame frame)
    {
<span class="nc" id="L159">        super(frame, getMsg(&quot;dialog.printtitle&quot;), true, gc);</span>
<span class="nc" id="L160">        initPrintDialog(x, y, services, defaultServiceIndex,</span>
                        flavor, attributes);
<span class="nc" id="L162">    }</span>


    /**
     * Initialize print dialog.
     */
    void initPrintDialog(int x, int y,
                         PrintService[] services,
                         int defaultServiceIndex,
                         DocFlavor flavor,
                         PrintRequestAttributeSet attributes)
    {
<span class="nc" id="L174">        this.services = services;</span>
<span class="nc" id="L175">        this.defaultServiceIndex = defaultServiceIndex;</span>
<span class="nc" id="L176">        this.asOriginal = attributes;</span>
<span class="nc" id="L177">        this.asCurrent = new HashPrintRequestAttributeSet(attributes);</span>
<span class="nc" id="L178">        this.psCurrent = services[defaultServiceIndex];</span>
<span class="nc" id="L179">        this.docFlavor = flavor;</span>
<span class="nc" id="L180">        SunPageSelection pages =</span>
<span class="nc" id="L181">            (SunPageSelection)attributes.get(SunPageSelection.class);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (pages != null) {</span>
<span class="nc" id="L183">            isAWT = true;</span>
        }

<span class="nc" id="L186">        Container c = getContentPane();</span>
<span class="nc" id="L187">        c.setLayout(new BorderLayout());</span>

<span class="nc" id="L189">        tpTabs = new JTabbedPane();</span>
<span class="nc" id="L190">        tpTabs.setBorder(new EmptyBorder(5, 5, 5, 5));</span>

<span class="nc" id="L192">        String gkey = getMsg(&quot;tab.general&quot;);</span>
<span class="nc" id="L193">        int gmnemonic = getVKMnemonic(&quot;tab.general&quot;);</span>
<span class="nc" id="L194">        pnlGeneral = new GeneralPanel();</span>
<span class="nc" id="L195">        tpTabs.add(gkey, pnlGeneral);</span>
<span class="nc" id="L196">        tpTabs.setMnemonicAt(0, gmnemonic);</span>

<span class="nc" id="L198">        String pkey = getMsg(&quot;tab.pagesetup&quot;);</span>
<span class="nc" id="L199">        int pmnemonic = getVKMnemonic(&quot;tab.pagesetup&quot;);</span>
<span class="nc" id="L200">        pnlPageSetup = new PageSetupPanel();</span>
<span class="nc" id="L201">        tpTabs.add(pkey, pnlPageSetup);</span>
<span class="nc" id="L202">        tpTabs.setMnemonicAt(1, pmnemonic);</span>

<span class="nc" id="L204">        String akey = getMsg(&quot;tab.appearance&quot;);</span>
<span class="nc" id="L205">        int amnemonic = getVKMnemonic(&quot;tab.appearance&quot;);</span>
<span class="nc" id="L206">        pnlAppearance = new AppearancePanel();</span>
<span class="nc" id="L207">        tpTabs.add(akey, pnlAppearance);</span>
<span class="nc" id="L208">        tpTabs.setMnemonicAt(2, amnemonic);</span>

<span class="nc" id="L210">        c.add(tpTabs, BorderLayout.CENTER);</span>

<span class="nc" id="L212">        updatePanels();</span>

<span class="nc" id="L214">        JPanel pnlSouth = new JPanel(new FlowLayout(FlowLayout.TRAILING));</span>
<span class="nc" id="L215">        btnApprove = createExitButton(&quot;button.print&quot;, this);</span>
<span class="nc" id="L216">        pnlSouth.add(btnApprove);</span>
<span class="nc" id="L217">        getRootPane().setDefaultButton(btnApprove);</span>
<span class="nc" id="L218">        btnCancel = createExitButton(&quot;button.cancel&quot;, this);</span>
<span class="nc" id="L219">        handleEscKey(btnCancel);</span>
<span class="nc" id="L220">        pnlSouth.add(btnCancel);</span>
<span class="nc" id="L221">        c.add(pnlSouth, BorderLayout.SOUTH);</span>

<span class="nc" id="L223">        addWindowListener(new WindowAdapter() {</span>
            public void windowClosing(WindowEvent event) {
<span class="nc" id="L225">                dispose(CANCEL);</span>
<span class="nc" id="L226">            }</span>
        });

<span class="nc" id="L229">        getAccessibleContext().setAccessibleDescription(getMsg(&quot;dialog.printtitle&quot;));</span>
<span class="nc" id="L230">        setResizable(false);</span>
<span class="nc" id="L231">        setLocation(x, y);</span>
<span class="nc" id="L232">        pack();</span>
<span class="nc" id="L233">    }</span>

   /**
     * Constructor for the solitary &quot;page setup&quot; dialog
     */
    public ServiceDialog(GraphicsConfiguration gc,
                         int x, int y,
                         PrintService ps,
                         DocFlavor flavor,
                         PrintRequestAttributeSet attributes,
                         Dialog dialog)
    {
<span class="nc" id="L245">        super(dialog, getMsg(&quot;dialog.pstitle&quot;), true, gc);</span>
<span class="nc" id="L246">        initPageDialog(x, y, ps, flavor, attributes);</span>
<span class="nc" id="L247">    }</span>

    /**
     * Constructor for the solitary &quot;page setup&quot; dialog
     */
    public ServiceDialog(GraphicsConfiguration gc,
                         int x, int y,
                         PrintService ps,
                         DocFlavor flavor,
                         PrintRequestAttributeSet attributes,
                         Frame frame)
    {
<span class="nc" id="L259">        super(frame, getMsg(&quot;dialog.pstitle&quot;), true, gc);</span>
<span class="nc" id="L260">        initPageDialog(x, y, ps, flavor, attributes);</span>
<span class="nc" id="L261">    }</span>


    /**
     * Initialize &quot;page setup&quot; dialog
     */
    void initPageDialog(int x, int y,
                         PrintService ps,
                         DocFlavor flavor,
                         PrintRequestAttributeSet attributes)
    {
<span class="nc" id="L272">        this.psCurrent = ps;</span>
<span class="nc" id="L273">        this.docFlavor = flavor;</span>
<span class="nc" id="L274">        this.asOriginal = attributes;</span>
<span class="nc" id="L275">        this.asCurrent = new HashPrintRequestAttributeSet(attributes);</span>

<span class="nc" id="L277">        Container c = getContentPane();</span>
<span class="nc" id="L278">        c.setLayout(new BorderLayout());</span>

<span class="nc" id="L280">        pnlPageSetup = new PageSetupPanel();</span>
<span class="nc" id="L281">        c.add(pnlPageSetup, BorderLayout.CENTER);</span>

<span class="nc" id="L283">        pnlPageSetup.updateInfo();</span>

<span class="nc" id="L285">        JPanel pnlSouth = new JPanel(new FlowLayout(FlowLayout.TRAILING));</span>
<span class="nc" id="L286">        btnApprove = createExitButton(&quot;button.ok&quot;, this);</span>
<span class="nc" id="L287">        pnlSouth.add(btnApprove);</span>
<span class="nc" id="L288">        getRootPane().setDefaultButton(btnApprove);</span>
<span class="nc" id="L289">        btnCancel = createExitButton(&quot;button.cancel&quot;, this);</span>
<span class="nc" id="L290">        handleEscKey(btnCancel);</span>
<span class="nc" id="L291">        pnlSouth.add(btnCancel);</span>
<span class="nc" id="L292">        c.add(pnlSouth, BorderLayout.SOUTH);</span>

<span class="nc" id="L294">        addWindowListener(new WindowAdapter() {</span>
            public void windowClosing(WindowEvent event) {
<span class="nc" id="L296">                dispose(CANCEL);</span>
<span class="nc" id="L297">            }</span>
        });

<span class="nc" id="L300">        getAccessibleContext().setAccessibleDescription(getMsg(&quot;dialog.pstitle&quot;));</span>
<span class="nc" id="L301">        setResizable(false);</span>
<span class="nc" id="L302">        setLocation(x, y);</span>
<span class="nc" id="L303">        pack();</span>
<span class="nc" id="L304">    }</span>

    /**
     * Performs Cancel when Esc key is pressed.
     */
    private void handleEscKey(JButton btnCancel) {
<span class="nc" id="L310">        Action cancelKeyAction = new AbstractAction() {</span>
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L312">                dispose(CANCEL);</span>
<span class="nc" id="L313">            }</span>
        };
<span class="nc" id="L315">        KeyStroke cancelKeyStroke =</span>
<span class="nc" id="L316">            KeyStroke.getKeyStroke((char)KeyEvent.VK_ESCAPE, 0);</span>
<span class="nc" id="L317">        InputMap inputMap =</span>
<span class="nc" id="L318">            btnCancel.getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW);</span>
<span class="nc" id="L319">        ActionMap actionMap = btnCancel.getActionMap();</span>

<span class="nc bnc" id="L321" title="All 4 branches missed.">        if (inputMap != null &amp;&amp; actionMap != null) {</span>
<span class="nc" id="L322">            inputMap.put(cancelKeyStroke, &quot;cancel&quot;);</span>
<span class="nc" id="L323">            actionMap.put(&quot;cancel&quot;, cancelKeyAction);</span>
        }
<span class="nc" id="L325">    }</span>


    /**
     * Returns the current status of the dialog (whether the user has selected
     * the &quot;Print&quot; or &quot;Cancel&quot; button)
     */
    public int getStatus() {
<span class="nc" id="L333">        return status;</span>
    }

    /**
     * Returns an AttributeSet based on whether or not the user cancelled the
     * dialog.  If the user selected &quot;Print&quot; we return their new selections,
     * otherwise we return the attributes that were passed in initially.
     */
    public PrintRequestAttributeSet getAttributes() {
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (status == APPROVE) {</span>
<span class="nc" id="L343">            return asCurrent;</span>
        } else {
<span class="nc" id="L345">            return asOriginal;</span>
        }
    }

    /**
     * Returns a PrintService based on whether or not the user cancelled the
     * dialog.  If the user selected &quot;Print&quot; we return the user's selection
     * for the PrintService, otherwise we return null.
     */
    public PrintService getPrintService() {
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (status == APPROVE) {</span>
<span class="nc" id="L356">            return psCurrent;</span>
        } else {
<span class="nc" id="L358">            return null;</span>
        }
    }

    /**
     * Sets the current status flag for the dialog and disposes it (thus
     * returning control of the parent frame back to the user)
     */
    public void dispose(int status) {
<span class="nc" id="L367">        this.status = status;</span>

<span class="nc" id="L369">        super.dispose();</span>
<span class="nc" id="L370">    }</span>

    public void actionPerformed(ActionEvent e) {
<span class="nc" id="L373">        Object source = e.getSource();</span>
<span class="nc" id="L374">        boolean approved = false;</span>

<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (source == btnApprove) {</span>
<span class="nc" id="L377">            approved = true;</span>

<span class="nc bnc" id="L379" title="All 2 branches missed.">            if (pnlGeneral != null) {</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">                if (pnlGeneral.isPrintToFileRequested()) {</span>
<span class="nc" id="L381">                    approved = showFileChooser();</span>
                } else {
<span class="nc" id="L383">                    asCurrent.remove(Destination.class);</span>
                }
            }
        }

<span class="nc bnc" id="L388" title="All 2 branches missed.">        dispose(approved ? APPROVE : CANCEL);</span>
<span class="nc" id="L389">    }</span>

    /**
     * Displays a JFileChooser that allows the user to select the destination
     * for &quot;Print To File&quot;
     */
    private boolean showFileChooser() {
<span class="nc" id="L396">        Class dstCategory = Destination.class;</span>

<span class="nc" id="L398">        Destination dst = (Destination)asCurrent.get(dstCategory);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (dst == null) {</span>
<span class="nc" id="L400">            dst = (Destination)asOriginal.get(dstCategory);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (dst == null) {</span>
<span class="nc" id="L402">                dst = (Destination)psCurrent.getDefaultAttributeValue(dstCategory);</span>
                // &quot;dst&quot; should not be null. The following code
                // is only added to safeguard against a possible
                // buggy implementation of a PrintService having a
                // null default Destination.
<span class="nc bnc" id="L407" title="All 2 branches missed.">                if (dst == null) {</span>
                    try {
<span class="nc" id="L409">                        dst = new Destination(new URI(&quot;file:out.prn&quot;));</span>
<span class="nc" id="L410">                    } catch (URISyntaxException e) {</span>
<span class="nc" id="L411">                    }</span>
                }
            }
        }

        File fileDest;
<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (dst != null) {</span>
            try {
<span class="nc" id="L419">                fileDest = new File(dst.getURI());</span>
<span class="nc" id="L420">            } catch (Exception e) {</span>
                // all manner of runtime exceptions possible
<span class="nc" id="L422">                fileDest = new File(&quot;out.prn&quot;);</span>
<span class="nc" id="L423">            }</span>
        } else {
<span class="nc" id="L425">            fileDest = new File(&quot;out.prn&quot;);</span>
        }

<span class="nc" id="L428">        ValidatingFileChooser jfc = new ValidatingFileChooser();</span>
<span class="nc" id="L429">        jfc.setApproveButtonText(getMsg(&quot;button.ok&quot;));</span>
<span class="nc" id="L430">        jfc.setDialogTitle(getMsg(&quot;dialog.printtofile&quot;));</span>
<span class="nc" id="L431">        jfc.setDialogType(JFileChooser.SAVE_DIALOG);</span>
<span class="nc" id="L432">        jfc.setSelectedFile(fileDest);</span>

<span class="nc" id="L434">        int returnVal = jfc.showDialog(this, null);</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (returnVal == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L436">            fileDest = jfc.getSelectedFile();</span>

            try {
<span class="nc" id="L439">                asCurrent.add(new Destination(fileDest.toURI()));</span>
<span class="nc" id="L440">            } catch (Exception e) {</span>
<span class="nc" id="L441">                asCurrent.remove(dstCategory);</span>
<span class="nc" id="L442">            }</span>
        } else {
<span class="nc" id="L444">            asCurrent.remove(dstCategory);</span>
        }

<span class="nc bnc" id="L447" title="All 2 branches missed.">        return (returnVal == JFileChooser.APPROVE_OPTION);</span>
    }

    /**
     * Updates each of the top level panels
     */
    private void updatePanels() {
<span class="nc" id="L454">        pnlGeneral.updateInfo();</span>
<span class="nc" id="L455">        pnlPageSetup.updateInfo();</span>
<span class="nc" id="L456">        pnlAppearance.updateInfo();</span>
<span class="nc" id="L457">    }</span>

    /**
     * Initialize ResourceBundle
     */
    public static void initResource() {
<span class="nc" id="L463">        java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L464">            new java.security.PrivilegedAction() {</span>
                public Object run() {
                    try {
<span class="nc" id="L467">                        messageRB = ResourceBundle.getBundle(strBundle);</span>
<span class="nc" id="L468">                        return null;</span>
<span class="nc" id="L469">                    } catch (java.util.MissingResourceException e) {</span>
<span class="nc" id="L470">                        throw new Error(&quot;Fatal: Resource for ServiceUI &quot; +</span>
                                        &quot;is missing&quot;);
                    }
                }
            }
        );
<span class="nc" id="L476">    }</span>

    /**
     * Returns message string from resource
     */
    public static String getMsg(String key) {
        try {
<span class="nc" id="L483">            return removeMnemonics(messageRB.getString(key));</span>
<span class="nc" id="L484">        } catch (java.util.MissingResourceException e) {</span>
<span class="nc" id="L485">            throw new Error(&quot;Fatal: Resource for ServiceUI is broken; &quot; +</span>
                            &quot;there is no &quot; + key + &quot; key in resource&quot;);
        }
    }

    private static String removeMnemonics(String s) {
<span class="nc" id="L491">        int i = s.indexOf('&amp;');</span>
<span class="nc" id="L492">        int len = s.length();</span>
<span class="nc bnc" id="L493" title="All 4 branches missed.">        if (i &lt; 0 || i == (len - 1)) {</span>
<span class="nc" id="L494">            return s;</span>
        }
<span class="nc" id="L496">        int j = s.indexOf('&amp;', i+1);</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">        if (j == i+1) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">            if (j+1 == len) {</span>
<span class="nc" id="L499">                return s.substring(0, i+1);  // string ends with &amp;&amp;</span>
            } else {
<span class="nc" id="L501">                return s.substring(0, i+1) + removeMnemonics(s.substring(j+1));</span>
            }
        }
        // ok first &amp; not double &amp;&amp;
<span class="nc bnc" id="L505" title="All 2 branches missed.">        if (i == 0) {</span>
<span class="nc" id="L506">            return removeMnemonics(s.substring(1));</span>
        } else {
<span class="nc" id="L508">            return (s.substring(0, i) + removeMnemonics(s.substring(i+1)));</span>
        }
    }


    /**
     * Returns mnemonic character from resource
     */
    private static char getMnemonic(String key) {
<span class="nc" id="L517">        String str = messageRB.getString(key).replace(&quot;&amp;&amp;&quot;, &quot;&quot;);</span>
<span class="nc" id="L518">        int index = str.indexOf('&amp;');</span>
<span class="nc bnc" id="L519" title="All 4 branches missed.">        if (0 &lt;= index &amp;&amp; index &lt; str.length() - 1) {</span>
<span class="nc" id="L520">            char c = str.charAt(index + 1);</span>
<span class="nc" id="L521">            return Character.toUpperCase(c);</span>
        } else {
<span class="nc" id="L523">            return (char)0;</span>
        }
    }

    /**
     * Returns the mnemonic as a KeyEvent.VK constant from the resource.
     */
<span class="nc" id="L530">    static Class _keyEventClazz = null;</span>
    private static int getVKMnemonic(String key) {
<span class="nc" id="L532">        String s = String.valueOf(getMnemonic(key));</span>
<span class="nc bnc" id="L533" title="All 4 branches missed.">        if ( s == null || s.length() != 1) {</span>
<span class="nc" id="L534">            return 0;</span>
        }
<span class="nc" id="L536">        String vkString = &quot;VK_&quot; + s.toUpperCase();</span>

        try {
<span class="nc bnc" id="L539" title="All 2 branches missed.">            if (_keyEventClazz == null) {</span>
<span class="nc" id="L540">                _keyEventClazz= Class.forName(&quot;java.awt.event.KeyEvent&quot;,</span>
<span class="nc" id="L541">                                 true, (ServiceDialog.class).getClassLoader());</span>
            }
<span class="nc" id="L543">            Field field = _keyEventClazz.getDeclaredField(vkString);</span>
<span class="nc" id="L544">            int value = field.getInt(null);</span>
<span class="nc" id="L545">            return value;</span>
<span class="nc" id="L546">        } catch (Exception e) {</span>
        }
<span class="nc" id="L548">        return 0;</span>
    }

    /**
     * Returns URL for image resource
     */
    private static URL getImageResource(final String key) {
<span class="nc" id="L555">        URL url = (URL)java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L556">                       new java.security.PrivilegedAction() {</span>
                public Object run() {
<span class="nc" id="L558">                    URL url = ServiceDialog.class.getResource(</span>
                                                  &quot;resources/&quot; + key);
<span class="nc" id="L560">                    return url;</span>
                }
        });

<span class="nc bnc" id="L564" title="All 2 branches missed.">        if (url == null) {</span>
<span class="nc" id="L565">            throw new Error(&quot;Fatal: Resource for ServiceUI is broken; &quot; +</span>
                            &quot;there is no &quot; + key + &quot; key in resource&quot;);
        }

<span class="nc" id="L569">        return url;</span>
    }

    /**
     * Creates a new JButton and sets its text, mnemonic, and ActionListener
     */
    private static JButton createButton(String key, ActionListener al) {
<span class="nc" id="L576">        JButton btn = new JButton(getMsg(key));</span>
<span class="nc" id="L577">        btn.setMnemonic(getMnemonic(key));</span>
<span class="nc" id="L578">        btn.addActionListener(al);</span>

<span class="nc" id="L580">        return btn;</span>
    }

    /**
     * Creates a new JButton and sets its text, and ActionListener
     */
    private static JButton createExitButton(String key, ActionListener al) {
<span class="nc" id="L587">        String str = getMsg(key);</span>
<span class="nc" id="L588">        JButton btn = new JButton(str);</span>
<span class="nc" id="L589">        btn.addActionListener(al);</span>
<span class="nc" id="L590">        btn.getAccessibleContext().setAccessibleDescription(str);</span>
<span class="nc" id="L591">        return btn;</span>
    }

    /**
     * Creates a new JCheckBox and sets its text, mnemonic, and ActionListener
     */
    private static JCheckBox createCheckBox(String key, ActionListener al) {
<span class="nc" id="L598">        JCheckBox cb = new JCheckBox(getMsg(key));</span>
<span class="nc" id="L599">        cb.setMnemonic(getMnemonic(key));</span>
<span class="nc" id="L600">        cb.addActionListener(al);</span>

<span class="nc" id="L602">        return cb;</span>
    }

    /**
     * Creates a new JRadioButton and sets its text, mnemonic,
     * and ActionListener
     */
    private static JRadioButton createRadioButton(String key,
                                                  ActionListener al)
    {
<span class="nc" id="L612">        JRadioButton rb = new JRadioButton(getMsg(key));</span>
<span class="nc" id="L613">        rb.setMnemonic(getMnemonic(key));</span>
<span class="nc" id="L614">        rb.addActionListener(al);</span>

<span class="nc" id="L616">        return rb;</span>
    }

  /**
   * Creates a  pop-up dialog for &quot;no print service&quot;
   */
    public static void showNoPrintService(GraphicsConfiguration gc)
    {
<span class="nc" id="L624">        Frame dlgFrame = new Frame(gc);</span>
<span class="nc" id="L625">        JOptionPane.showMessageDialog(dlgFrame,</span>
<span class="nc" id="L626">                                      getMsg(&quot;dialog.noprintermsg&quot;));</span>
<span class="nc" id="L627">        dlgFrame.dispose();</span>
<span class="nc" id="L628">    }</span>

    /**
     * Sets the constraints for the GridBagLayout and adds the Component
     * to the given Container
     */
    private static void addToGB(Component comp, Container cont,
                                GridBagLayout gridbag,
                                GridBagConstraints constraints)
    {
<span class="nc" id="L638">        gridbag.setConstraints(comp, constraints);</span>
<span class="nc" id="L639">        cont.add(comp);</span>
<span class="nc" id="L640">    }</span>

    /**
     * Adds the AbstractButton to both the given ButtonGroup and Container
     */
    private static void addToBG(AbstractButton button, Container cont,
                                ButtonGroup bg)
    {
<span class="nc" id="L648">        bg.add(button);</span>
<span class="nc" id="L649">        cont.add(button);</span>
<span class="nc" id="L650">    }</span>




    /**
     * The &quot;General&quot; tab.  Includes the controls for PrintService,
     * PageRange, and Copies/Collate.
     */
    private class GeneralPanel extends JPanel {

        private PrintServicePanel pnlPrintService;
        private PrintRangePanel pnlPrintRange;
        private CopiesPanel pnlCopies;

<span class="nc" id="L665">        public GeneralPanel() {</span>
<span class="nc" id="L666">            super();</span>

<span class="nc" id="L668">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L669">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L671">            setLayout(gridbag);</span>

<span class="nc" id="L673">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L674">            c.insets = panelInsets;</span>
<span class="nc" id="L675">            c.weightx = 1.0;</span>
<span class="nc" id="L676">            c.weighty = 1.0;</span>

<span class="nc" id="L678">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L679">            pnlPrintService = new PrintServicePanel();</span>
<span class="nc" id="L680">            addToGB(pnlPrintService, this, gridbag, c);</span>

<span class="nc" id="L682">            c.gridwidth = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L683">            pnlPrintRange = new PrintRangePanel();</span>
<span class="nc" id="L684">            addToGB(pnlPrintRange, this, gridbag, c);</span>

<span class="nc" id="L686">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L687">            pnlCopies = new CopiesPanel();</span>
<span class="nc" id="L688">            addToGB(pnlCopies, this, gridbag, c);</span>
<span class="nc" id="L689">        }</span>

        public boolean isPrintToFileRequested() {
<span class="nc" id="L692">            return (pnlPrintService.isPrintToFileSelected());</span>
        }

        public void updateInfo() {
<span class="nc" id="L696">            pnlPrintService.updateInfo();</span>
<span class="nc" id="L697">            pnlPrintRange.updateInfo();</span>
<span class="nc" id="L698">            pnlCopies.updateInfo();</span>
<span class="nc" id="L699">        }</span>
    }

    private class PrintServicePanel extends JPanel
        implements ActionListener, ItemListener, PopupMenuListener
    {
<span class="nc" id="L705">        private final String strTitle = getMsg(&quot;border.printservice&quot;);</span>
        private FilePermission printToFilePermission;
        private JButton btnProperties;
        private JCheckBox cbPrintToFile;
        private JComboBox cbName;
        private JLabel lblType, lblStatus, lblInfo;
        private ServiceUIFactory uiFactory;
<span class="nc" id="L712">        private boolean changedService = false;</span>
        private boolean filePermission;

<span class="nc" id="L715">        public PrintServicePanel() {</span>
<span class="nc" id="L716">            super();</span>

<span class="nc" id="L718">            uiFactory = psCurrent.getServiceUIFactory();</span>

<span class="nc" id="L720">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L721">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L723">            setLayout(gridbag);</span>
<span class="nc" id="L724">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L726">            String[] psnames = new String[services.length];</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">            for (int i = 0; i &lt; psnames.length; i++) {</span>
<span class="nc" id="L728">                psnames[i] = services[i].getName();</span>
            }
<span class="nc" id="L730">            cbName = new JComboBox(psnames);</span>
<span class="nc" id="L731">            cbName.setSelectedIndex(defaultServiceIndex);</span>
<span class="nc" id="L732">            cbName.addItemListener(this);</span>
<span class="nc" id="L733">            cbName.addPopupMenuListener(this);</span>

<span class="nc" id="L735">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L736">            c.insets = compInsets;</span>

<span class="nc" id="L738">            c.weightx = 0.0;</span>
<span class="nc" id="L739">            JLabel lblName = new JLabel(getMsg(&quot;label.psname&quot;), JLabel.TRAILING);</span>
<span class="nc" id="L740">            lblName.setDisplayedMnemonic(getMnemonic(&quot;label.psname&quot;));</span>
<span class="nc" id="L741">            lblName.setLabelFor(cbName);</span>
<span class="nc" id="L742">            addToGB(lblName, this, gridbag, c);</span>
<span class="nc" id="L743">            c.weightx = 1.0;</span>
<span class="nc" id="L744">            c.gridwidth = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L745">            addToGB(cbName, this, gridbag, c);</span>
<span class="nc" id="L746">            c.weightx = 0.0;</span>
<span class="nc" id="L747">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L748">            btnProperties = createButton(&quot;button.properties&quot;, this);</span>
<span class="nc" id="L749">            addToGB(btnProperties, this, gridbag, c);</span>

<span class="nc" id="L751">            c.weighty = 1.0;</span>
<span class="nc" id="L752">            lblStatus = addLabel(getMsg(&quot;label.status&quot;), gridbag, c);</span>
<span class="nc" id="L753">            lblStatus.setLabelFor(null);</span>

<span class="nc" id="L755">            lblType = addLabel(getMsg(&quot;label.pstype&quot;), gridbag, c);</span>
<span class="nc" id="L756">            lblType.setLabelFor(null);</span>

<span class="nc" id="L758">            c.gridwidth = 1;</span>
<span class="nc" id="L759">            addToGB(new JLabel(getMsg(&quot;label.info&quot;), JLabel.TRAILING),</span>
                    this, gridbag, c);
<span class="nc" id="L761">            c.gridwidth = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L762">            lblInfo = new JLabel();</span>
<span class="nc" id="L763">            lblInfo.setLabelFor(null);</span>

<span class="nc" id="L765">            addToGB(lblInfo, this, gridbag, c);</span>

<span class="nc" id="L767">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L768">            cbPrintToFile = createCheckBox(&quot;checkbox.printtofile&quot;, this);</span>
<span class="nc" id="L769">            addToGB(cbPrintToFile, this, gridbag, c);</span>

<span class="nc" id="L771">            filePermission = allowedToPrintToFile();</span>
<span class="nc" id="L772">        }</span>

        public boolean isPrintToFileSelected() {
<span class="nc" id="L775">            return cbPrintToFile.isSelected();</span>
        }

        private JLabel addLabel(String text,
                                GridBagLayout gridbag, GridBagConstraints c)
        {
<span class="nc" id="L781">            c.gridwidth = 1;</span>
<span class="nc" id="L782">            addToGB(new JLabel(text, JLabel.TRAILING), this, gridbag, c);</span>

<span class="nc" id="L784">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L785">            JLabel label = new JLabel();</span>
<span class="nc" id="L786">            addToGB(label, this, gridbag, c);</span>

<span class="nc" id="L788">            return label;</span>
        }

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L792">            Object source = e.getSource();</span>

<span class="nc bnc" id="L794" title="All 2 branches missed.">            if (source == btnProperties) {</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">                if (uiFactory != null) {</span>
<span class="nc" id="L796">                    JDialog dialog = (JDialog)uiFactory.getUI(</span>
                                               ServiceUIFactory.MAIN_UIROLE,
                                               ServiceUIFactory.JDIALOG_UI);

<span class="nc bnc" id="L800" title="All 2 branches missed.">                    if (dialog != null) {</span>
<span class="nc" id="L801">                        dialog.show();</span>
                    } else {
<span class="nc" id="L803">                        DocumentPropertiesUI docPropertiesUI = null;</span>
                        try {
<span class="nc" id="L805">                            docPropertiesUI =</span>
                                (DocumentPropertiesUI)uiFactory.getUI
<span class="nc" id="L807">                                (DocumentPropertiesUI.DOCUMENTPROPERTIES_ROLE,</span>
                                 DocumentPropertiesUI.DOCPROPERTIESCLASSNAME);
<span class="nc" id="L809">                        } catch (Exception ex) {</span>
<span class="nc" id="L810">                        }</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">                        if (docPropertiesUI != null) {</span>
<span class="nc" id="L812">                            PrinterJobWrapper wrapper = (PrinterJobWrapper)</span>
<span class="nc" id="L813">                                asCurrent.get(PrinterJobWrapper.class);</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">                            if (wrapper == null) {</span>
<span class="nc" id="L815">                                return; // should not happen, defensive only.</span>
                            }
<span class="nc" id="L817">                            PrinterJob job = wrapper.getPrinterJob();</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">                            if (job == null) {</span>
<span class="nc" id="L819">                                return;  // should not happen, defensive only.</span>
                            }
<span class="nc" id="L821">                            PrintRequestAttributeSet newAttrs =</span>
                               docPropertiesUI.showDocumentProperties
<span class="nc" id="L823">                               (job, ServiceDialog.this, psCurrent, asCurrent);</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">                            if (newAttrs != null) {</span>
<span class="nc" id="L825">                                asCurrent.addAll(newAttrs);</span>
<span class="nc" id="L826">                                updatePanels();</span>
                            }
                        }
                    }
                }
            }
<span class="nc" id="L832">        }</span>

        public void itemStateChanged(ItemEvent e) {
<span class="nc bnc" id="L835" title="All 2 branches missed.">            if (e.getStateChange() == ItemEvent.SELECTED) {</span>
<span class="nc" id="L836">                int index = cbName.getSelectedIndex();</span>

<span class="nc bnc" id="L838" title="All 4 branches missed.">                if ((index &gt;= 0) &amp;&amp; (index &lt; services.length)) {</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">                    if (!services[index].equals(psCurrent)) {</span>
<span class="nc" id="L840">                        psCurrent = services[index];</span>
<span class="nc" id="L841">                        uiFactory = psCurrent.getServiceUIFactory();</span>
<span class="nc" id="L842">                        changedService = true;</span>

<span class="nc" id="L844">                        Destination dest =</span>
<span class="nc" id="L845">                            (Destination)asOriginal.get(Destination.class);</span>
                        // to preserve the state of Print To File
<span class="nc bnc" id="L847" title="All 4 branches missed.">                        if ((dest != null || isPrintToFileSelected())</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">                            &amp;&amp; psCurrent.isAttributeCategorySupported(</span>
                                                        Destination.class)) {

<span class="nc bnc" id="L851" title="All 2 branches missed.">                            if (dest != null) {</span>
<span class="nc" id="L852">                                asCurrent.add(dest);</span>
                            } else {
<span class="nc" id="L854">                                dest = (Destination)psCurrent.</span>
<span class="nc" id="L855">                                    getDefaultAttributeValue(Destination.class);</span>
                                // &quot;dest&quot; should not be null. The following code
                                // is only added to safeguard against a possible
                                // buggy implementation of a PrintService having a
                                // null default Destination.
<span class="nc bnc" id="L860" title="All 2 branches missed.">                                if (dest == null) {</span>
                                    try {
<span class="nc" id="L862">                                        dest =</span>
                                            new Destination(new URI(&quot;file:out.prn&quot;));
<span class="nc" id="L864">                                    } catch (URISyntaxException ue) {</span>
<span class="nc" id="L865">                                    }</span>
                                }

<span class="nc bnc" id="L868" title="All 2 branches missed.">                                if (dest != null) {</span>
<span class="nc" id="L869">                                    asCurrent.add(dest);</span>
                                }
                            }
                        } else {
<span class="nc" id="L873">                            asCurrent.remove(Destination.class);</span>
                        }
                    }
                }
            }
<span class="nc" id="L878">        }</span>

        public void popupMenuWillBecomeVisible(PopupMenuEvent e) {
<span class="nc" id="L881">            changedService = false;</span>
<span class="nc" id="L882">        }</span>

        public void popupMenuWillBecomeInvisible(PopupMenuEvent e) {
<span class="nc bnc" id="L885" title="All 2 branches missed.">            if (changedService) {</span>
<span class="nc" id="L886">                changedService = false;</span>
<span class="nc" id="L887">                updatePanels();</span>
            }
<span class="nc" id="L889">        }</span>

        public void popupMenuCanceled(PopupMenuEvent e) {
<span class="nc" id="L892">        }</span>

        /**
         * We disable the &quot;Print To File&quot; checkbox if this returns false
         */
        private boolean allowedToPrintToFile() {
            try {
<span class="nc" id="L899">                throwPrintToFile();</span>
<span class="nc" id="L900">                return true;</span>
<span class="nc" id="L901">            } catch (SecurityException e) {</span>
<span class="nc" id="L902">                return false;</span>
            }
        }

        /**
         * Break this out as it may be useful when we allow API to
         * specify printing to a file. In that case its probably right
         * to throw a SecurityException if the permission is not granted.
         */
        private void throwPrintToFile() {
<span class="nc" id="L912">            SecurityManager security = System.getSecurityManager();</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">            if (security != null) {</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">                if (printToFilePermission == null) {</span>
<span class="nc" id="L915">                    printToFilePermission =</span>
                        new FilePermission(&quot;&lt;&lt;ALL FILES&gt;&gt;&quot;, &quot;read,write&quot;);
                }
<span class="nc" id="L918">                security.checkPermission(printToFilePermission);</span>
            }
<span class="nc" id="L920">        }</span>

        public void updateInfo() {
<span class="nc" id="L923">            Class dstCategory = Destination.class;</span>
<span class="nc" id="L924">            boolean dstSupported = false;</span>
<span class="nc" id="L925">            boolean dstSelected = false;</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">            boolean dstAllowed = filePermission ?</span>
<span class="nc" id="L927">                allowedToPrintToFile() : false;</span>

            // setup Destination (print-to-file) widgets
<span class="nc bnc" id="L930" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(dstCategory)) {</span>
<span class="nc" id="L931">                dstSupported = true;</span>
            }
<span class="nc" id="L933">            Destination dst = (Destination)asCurrent.get(dstCategory);</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">            if (dst != null) {</span>
<span class="nc" id="L935">                dstSelected = true;</span>
            }
<span class="nc bnc" id="L937" title="All 4 branches missed.">            cbPrintToFile.setEnabled(dstSupported &amp;&amp; dstAllowed);</span>
<span class="nc bnc" id="L938" title="All 6 branches missed.">            cbPrintToFile.setSelected(dstSelected &amp;&amp; dstAllowed</span>
                                      &amp;&amp; dstSupported);

            // setup PrintService information widgets
<span class="nc" id="L942">            Attribute type = psCurrent.getAttribute(PrinterMakeAndModel.class);</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">            if (type != null) {</span>
<span class="nc" id="L944">                lblType.setText(type.toString());</span>
            }
<span class="nc" id="L946">            Attribute status =</span>
<span class="nc" id="L947">                psCurrent.getAttribute(PrinterIsAcceptingJobs.class);</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">            if (status != null) {</span>
<span class="nc" id="L949">                lblStatus.setText(getMsg(status.toString()));</span>
            }
<span class="nc" id="L951">            Attribute info = psCurrent.getAttribute(PrinterInfo.class);</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">            if (info != null) {</span>
<span class="nc" id="L953">                lblInfo.setText(info.toString());</span>
            }
<span class="nc bnc" id="L955" title="All 2 branches missed.">            btnProperties.setEnabled(uiFactory != null);</span>
<span class="nc" id="L956">        }</span>
    }

    private class PrintRangePanel extends JPanel
        implements ActionListener, FocusListener
    {
<span class="nc" id="L962">        private final String strTitle = getMsg(&quot;border.printrange&quot;);</span>
<span class="nc" id="L963">        private final PageRanges prAll = new PageRanges(1, Integer.MAX_VALUE);</span>
        private JRadioButton rbAll, rbPages, rbSelect;
        private JFormattedTextField tfRangeFrom, tfRangeTo;
        private JLabel lblRangeTo;
        private boolean prSupported;

<span class="nc" id="L969">        public PrintRangePanel() {</span>
<span class="nc" id="L970">            super();</span>

<span class="nc" id="L972">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L973">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L975">            setLayout(gridbag);</span>
<span class="nc" id="L976">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L978">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L979">            c.insets = compInsets;</span>
<span class="nc" id="L980">            c.gridwidth = GridBagConstraints.REMAINDER;</span>

<span class="nc" id="L982">            ButtonGroup bg = new ButtonGroup();</span>
<span class="nc" id="L983">            JPanel pnlTop = new JPanel(new FlowLayout(FlowLayout.LEADING));</span>
<span class="nc" id="L984">            rbAll = createRadioButton(&quot;radiobutton.rangeall&quot;, this);</span>
<span class="nc" id="L985">            rbAll.setSelected(true);</span>
<span class="nc" id="L986">            bg.add(rbAll);</span>
<span class="nc" id="L987">            pnlTop.add(rbAll);</span>
<span class="nc" id="L988">            addToGB(pnlTop, this, gridbag, c);</span>

            // Selection never seemed to work so I'm commenting this part.
            /*
            if (isAWT) {
                JPanel pnlMiddle  =
                    new JPanel(new FlowLayout(FlowLayout.LEADING));
                rbSelect =
                    createRadioButton(&quot;radiobutton.selection&quot;, this);
                bg.add(rbSelect);
                pnlMiddle.add(rbSelect);
                addToGB(pnlMiddle, this, gridbag, c);
            }
            */

<span class="nc" id="L1003">            JPanel pnlBottom = new JPanel(new FlowLayout(FlowLayout.LEADING));</span>
<span class="nc" id="L1004">            rbPages = createRadioButton(&quot;radiobutton.rangepages&quot;, this);</span>
<span class="nc" id="L1005">            bg.add(rbPages);</span>
<span class="nc" id="L1006">            pnlBottom.add(rbPages);</span>
<span class="nc" id="L1007">            DecimalFormat format = new DecimalFormat(&quot;####0&quot;);</span>
<span class="nc" id="L1008">            format.setMinimumFractionDigits(0);</span>
<span class="nc" id="L1009">            format.setMaximumFractionDigits(0);</span>
<span class="nc" id="L1010">            format.setMinimumIntegerDigits(0);</span>
<span class="nc" id="L1011">            format.setMaximumIntegerDigits(5);</span>
<span class="nc" id="L1012">            format.setParseIntegerOnly(true);</span>
<span class="nc" id="L1013">            format.setDecimalSeparatorAlwaysShown(false);</span>
<span class="nc" id="L1014">            NumberFormatter nf = new NumberFormatter(format);</span>
<span class="nc" id="L1015">            nf.setMinimum(new Integer(1));</span>
<span class="nc" id="L1016">            nf.setMaximum(new Integer(Integer.MAX_VALUE));</span>
<span class="nc" id="L1017">            nf.setAllowsInvalid(true);</span>
<span class="nc" id="L1018">            nf.setCommitsOnValidEdit(true);</span>
<span class="nc" id="L1019">            tfRangeFrom = new JFormattedTextField(nf);</span>
<span class="nc" id="L1020">            tfRangeFrom.setColumns(4);</span>
<span class="nc" id="L1021">            tfRangeFrom.setEnabled(false);</span>
<span class="nc" id="L1022">            tfRangeFrom.addActionListener(this);</span>
<span class="nc" id="L1023">            tfRangeFrom.addFocusListener(this);</span>
<span class="nc" id="L1024">            tfRangeFrom.setFocusLostBehavior(</span>
                JFormattedTextField.PERSIST);
<span class="nc" id="L1026">            tfRangeFrom.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1027">                                          getMsg(&quot;radiobutton.rangepages&quot;));</span>
<span class="nc" id="L1028">            pnlBottom.add(tfRangeFrom);</span>
<span class="nc" id="L1029">            lblRangeTo = new JLabel(getMsg(&quot;label.rangeto&quot;));</span>
<span class="nc" id="L1030">            lblRangeTo.setEnabled(false);</span>
<span class="nc" id="L1031">            pnlBottom.add(lblRangeTo);</span>
            NumberFormatter nfto;
            try {
<span class="nc" id="L1034">                nfto = (NumberFormatter)nf.clone();</span>
<span class="nc" id="L1035">            } catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L1036">                nfto = new NumberFormatter();</span>
<span class="nc" id="L1037">            }</span>
<span class="nc" id="L1038">            tfRangeTo = new JFormattedTextField(nfto);</span>
<span class="nc" id="L1039">            tfRangeTo.setColumns(4);</span>
<span class="nc" id="L1040">            tfRangeTo.setEnabled(false);</span>
<span class="nc" id="L1041">            tfRangeTo.addFocusListener(this);</span>
<span class="nc" id="L1042">            tfRangeTo.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1043">                                          getMsg(&quot;label.rangeto&quot;));</span>
<span class="nc" id="L1044">            pnlBottom.add(tfRangeTo);</span>
<span class="nc" id="L1045">            addToGB(pnlBottom, this, gridbag, c);</span>
<span class="nc" id="L1046">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1049">            Object source = e.getSource();</span>
<span class="nc" id="L1050">            SunPageSelection select = SunPageSelection.ALL;</span>

<span class="nc" id="L1052">            setupRangeWidgets();</span>

<span class="nc bnc" id="L1054" title="All 2 branches missed.">            if (source == rbAll) {</span>
<span class="nc" id="L1055">                asCurrent.add(prAll);</span>
<span class="nc bnc" id="L1056" title="All 2 branches missed.">            } else if (source == rbSelect) {</span>
<span class="nc" id="L1057">                select = SunPageSelection.SELECTION;</span>
<span class="nc bnc" id="L1058" title="All 6 branches missed.">            } else if (source == rbPages ||</span>
                       source == tfRangeFrom ||
                       source == tfRangeTo) {
<span class="nc" id="L1061">                updateRangeAttribute();</span>
<span class="nc" id="L1062">                select = SunPageSelection.RANGE;</span>
            }

<span class="nc bnc" id="L1065" title="All 2 branches missed.">            if (isAWT) {</span>
<span class="nc" id="L1066">                asCurrent.add(select);</span>
            }
<span class="nc" id="L1068">        }</span>

        public void focusLost(FocusEvent e) {
<span class="nc" id="L1071">            Object source = e.getSource();</span>

<span class="nc bnc" id="L1073" title="All 4 branches missed.">            if ((source == tfRangeFrom) || (source == tfRangeTo)) {</span>
<span class="nc" id="L1074">                updateRangeAttribute();</span>
            }
<span class="nc" id="L1076">        }</span>

<span class="nc" id="L1078">        public void focusGained(FocusEvent e) {}</span>

        private void setupRangeWidgets() {
<span class="nc bnc" id="L1081" title="All 4 branches missed.">            boolean rangeEnabled = (rbPages.isSelected() &amp;&amp; prSupported);</span>
<span class="nc" id="L1082">            tfRangeFrom.setEnabled(rangeEnabled);</span>
<span class="nc" id="L1083">            tfRangeTo.setEnabled(rangeEnabled);</span>
<span class="nc" id="L1084">            lblRangeTo.setEnabled(rangeEnabled);</span>
<span class="nc" id="L1085">        }</span>

        private void updateRangeAttribute() {
<span class="nc" id="L1088">            String strFrom = tfRangeFrom.getText();</span>
<span class="nc" id="L1089">            String strTo = tfRangeTo.getText();</span>

            int min;
            int max;

            try {
<span class="nc" id="L1095">                min = Integer.parseInt(strFrom);</span>
<span class="nc" id="L1096">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L1097">                min = 1;</span>
<span class="nc" id="L1098">            }</span>

            try {
<span class="nc" id="L1101">                max = Integer.parseInt(strTo);</span>
<span class="nc" id="L1102">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L1103">                max = min;</span>
<span class="nc" id="L1104">            }</span>

<span class="nc bnc" id="L1106" title="All 2 branches missed.">            if (min &lt; 1) {</span>
<span class="nc" id="L1107">                min = 1;</span>
<span class="nc" id="L1108">                tfRangeFrom.setValue(new Integer(1));</span>
            }

<span class="nc bnc" id="L1111" title="All 2 branches missed.">            if (max &lt; min) {</span>
<span class="nc" id="L1112">                max = min;</span>
<span class="nc" id="L1113">                tfRangeTo.setValue(new Integer(min));</span>
            }

<span class="nc" id="L1116">            PageRanges pr = new PageRanges(min, max);</span>
<span class="nc" id="L1117">            asCurrent.add(pr);</span>
<span class="nc" id="L1118">        }</span>

        public void updateInfo() {
<span class="nc" id="L1121">            Class prCategory = PageRanges.class;</span>
<span class="nc" id="L1122">            prSupported = false;</span>

<span class="nc bnc" id="L1124" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(prCategory) ||</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">                   isAWT) {</span>
<span class="nc" id="L1126">                prSupported = true;</span>
            }

<span class="nc" id="L1129">            SunPageSelection select = SunPageSelection.ALL;</span>
<span class="nc" id="L1130">            int min = 1;</span>
<span class="nc" id="L1131">            int max = 1;</span>

<span class="nc" id="L1133">            PageRanges pr = (PageRanges)asCurrent.get(prCategory);</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">            if (pr != null) {</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">                if (!pr.equals(prAll)) {</span>
<span class="nc" id="L1136">                    select = SunPageSelection.RANGE;</span>

<span class="nc" id="L1138">                    int[][] members = pr.getMembers();</span>
<span class="nc bnc" id="L1139" title="All 4 branches missed.">                    if ((members.length &gt; 0) &amp;&amp;</span>
                        (members[0].length &gt; 1)) {
<span class="nc" id="L1141">                        min = members[0][0];</span>
<span class="nc" id="L1142">                        max = members[0][1];</span>
                    }
                }
            }

<span class="nc bnc" id="L1147" title="All 2 branches missed.">            if (isAWT) {</span>
<span class="nc" id="L1148">                select = (SunPageSelection)asCurrent.get(</span>
                                                SunPageSelection.class);
            }

<span class="nc bnc" id="L1152" title="All 2 branches missed.">            if (select == SunPageSelection.ALL) {</span>
<span class="nc" id="L1153">                rbAll.setSelected(true);</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">            } else if (select == SunPageSelection.SELECTION) {</span>
                // Comment this for now -  rbSelect is not initialized
                // because Selection button is not added.
                // See PrintRangePanel above.

                //rbSelect.setSelected(true);
            } else { // RANGE
<span class="nc" id="L1161">                rbPages.setSelected(true);</span>
            }
<span class="nc" id="L1163">            tfRangeFrom.setValue(new Integer(min));</span>
<span class="nc" id="L1164">            tfRangeTo.setValue(new Integer(max));</span>
<span class="nc" id="L1165">            rbAll.setEnabled(prSupported);</span>
<span class="nc" id="L1166">            rbPages.setEnabled(prSupported);</span>
<span class="nc" id="L1167">            setupRangeWidgets();</span>
<span class="nc" id="L1168">        }</span>
    }

    private class CopiesPanel extends JPanel
        implements ActionListener, ChangeListener
    {
<span class="nc" id="L1174">        private final String strTitle = getMsg(&quot;border.copies&quot;);</span>
        private SpinnerNumberModel snModel;
        private JSpinner spinCopies;
        private JLabel lblCopies;
        private JCheckBox cbCollate;
        private boolean scSupported;

<span class="nc" id="L1181">        public CopiesPanel() {</span>
<span class="nc" id="L1182">            super();</span>

<span class="nc" id="L1184">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L1185">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L1187">            setLayout(gridbag);</span>
<span class="nc" id="L1188">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L1190">            c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L1191">            c.insets = compInsets;</span>

<span class="nc" id="L1193">            lblCopies = new JLabel(getMsg(&quot;label.numcopies&quot;), JLabel.TRAILING);</span>
<span class="nc" id="L1194">            lblCopies.setDisplayedMnemonic(getMnemonic(&quot;label.numcopies&quot;));</span>
<span class="nc" id="L1195">            lblCopies.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1196">                                             getMsg(&quot;label.numcopies&quot;));</span>
<span class="nc" id="L1197">            addToGB(lblCopies, this, gridbag, c);</span>

<span class="nc" id="L1199">            snModel = new SpinnerNumberModel(1, 1, 999, 1);</span>
<span class="nc" id="L1200">            spinCopies = new JSpinner(snModel);</span>
<span class="nc" id="L1201">            lblCopies.setLabelFor(spinCopies);</span>
            // REMIND
<span class="nc" id="L1203">            ((JSpinner.NumberEditor)spinCopies.getEditor()).getTextField().setColumns(3);</span>
<span class="nc" id="L1204">            spinCopies.addChangeListener(this);</span>
<span class="nc" id="L1205">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1206">            addToGB(spinCopies, this, gridbag, c);</span>

<span class="nc" id="L1208">            cbCollate = createCheckBox(&quot;checkbox.collate&quot;, this);</span>
<span class="nc" id="L1209">            cbCollate.setEnabled(false);</span>
<span class="nc" id="L1210">            addToGB(cbCollate, this, gridbag, c);</span>
<span class="nc" id="L1211">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L1214" title="All 2 branches missed.">            if (cbCollate.isSelected()) {</span>
<span class="nc" id="L1215">                asCurrent.add(SheetCollate.COLLATED);</span>
            } else {
<span class="nc" id="L1217">                asCurrent.add(SheetCollate.UNCOLLATED);</span>
            }
<span class="nc" id="L1219">        }</span>

        public void stateChanged(ChangeEvent e) {
<span class="nc" id="L1222">            updateCollateCB();</span>

<span class="nc" id="L1224">            asCurrent.add(new Copies(snModel.getNumber().intValue()));</span>
<span class="nc" id="L1225">        }</span>

        private void updateCollateCB() {
<span class="nc" id="L1228">            int num = snModel.getNumber().intValue();</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">            if (isAWT) {</span>
<span class="nc" id="L1230">                cbCollate.setEnabled(true);</span>
            } else {
<span class="nc bnc" id="L1232" title="All 4 branches missed.">                cbCollate.setEnabled((num &gt; 1) &amp;&amp; scSupported);</span>
            }
<span class="nc" id="L1234">        }</span>

        public void updateInfo() {
<span class="nc" id="L1237">            Class cpCategory = Copies.class;</span>
<span class="nc" id="L1238">            Class csCategory = CopiesSupported.class;</span>
<span class="nc" id="L1239">            Class scCategory = SheetCollate.class;</span>
<span class="nc" id="L1240">            boolean cpSupported = false;</span>
<span class="nc" id="L1241">            scSupported = false;</span>

            // setup Copies spinner
<span class="nc bnc" id="L1244" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(cpCategory)) {</span>
<span class="nc" id="L1245">                cpSupported = true;</span>
            }
<span class="nc" id="L1247">            CopiesSupported cs =</span>
<span class="nc" id="L1248">                (CopiesSupported)psCurrent.getSupportedAttributeValues(</span>
                                                       cpCategory, null, null);
<span class="nc bnc" id="L1250" title="All 2 branches missed.">            if (cs == null) {</span>
<span class="nc" id="L1251">                cs = new CopiesSupported(1, 999);</span>
            }
<span class="nc" id="L1253">            Copies cp = (Copies)asCurrent.get(cpCategory);</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">            if (cp == null) {</span>
<span class="nc" id="L1255">                cp = (Copies)psCurrent.getDefaultAttributeValue(cpCategory);</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">                if (cp == null) {</span>
<span class="nc" id="L1257">                    cp = new Copies(1);</span>
                }
            }
<span class="nc" id="L1260">            spinCopies.setEnabled(cpSupported);</span>
<span class="nc" id="L1261">            lblCopies.setEnabled(cpSupported);</span>

<span class="nc" id="L1263">            int[][] members = cs.getMembers();</span>
            int min, max;
<span class="nc bnc" id="L1265" title="All 4 branches missed.">            if ((members.length &gt; 0) &amp;&amp; (members[0].length &gt; 0)) {</span>
<span class="nc" id="L1266">                min = members[0][0];</span>
<span class="nc" id="L1267">                max = members[0][1];</span>
            } else {
<span class="nc" id="L1269">                min = 1;</span>
<span class="nc" id="L1270">                max = Integer.MAX_VALUE;</span>
            }
<span class="nc" id="L1272">            snModel.setMinimum(new Integer(min));</span>
<span class="nc" id="L1273">            snModel.setMaximum(new Integer(max));</span>

<span class="nc" id="L1275">            int value = cp.getValue();</span>
<span class="nc bnc" id="L1276" title="All 4 branches missed.">            if ((value &lt; min) || (value &gt; max)) {</span>
<span class="nc" id="L1277">                value = min;</span>
            }
<span class="nc" id="L1279">            snModel.setValue(new Integer(value));</span>

            // setup Collate checkbox
<span class="nc bnc" id="L1282" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(scCategory)) {</span>
<span class="nc" id="L1283">                scSupported = true;</span>
            }
<span class="nc" id="L1285">            SheetCollate sc = (SheetCollate)asCurrent.get(scCategory);</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">            if (sc == null) {</span>
<span class="nc" id="L1287">                sc = (SheetCollate)psCurrent.getDefaultAttributeValue(scCategory);</span>
<span class="nc bnc" id="L1288" title="All 2 branches missed.">                if (sc == null) {</span>
<span class="nc" id="L1289">                    sc = SheetCollate.UNCOLLATED;</span>
                }
            }
<span class="nc bnc" id="L1292" title="All 2 branches missed.">            cbCollate.setSelected(sc == SheetCollate.COLLATED);</span>
<span class="nc" id="L1293">            updateCollateCB();</span>
<span class="nc" id="L1294">        }</span>
    }




    /**
     * The &quot;Page Setup&quot; tab.  Includes the controls for MediaSource/MediaTray,
     * OrientationRequested, and Sides.
     */
    private class PageSetupPanel extends JPanel {

        private MediaPanel pnlMedia;
        private OrientationPanel pnlOrientation;
        private MarginsPanel pnlMargins;

<span class="nc" id="L1310">        public PageSetupPanel() {</span>
<span class="nc" id="L1311">            super();</span>

<span class="nc" id="L1313">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L1314">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L1316">            setLayout(gridbag);</span>

<span class="nc" id="L1318">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L1319">            c.insets = panelInsets;</span>
<span class="nc" id="L1320">            c.weightx = 1.0;</span>
<span class="nc" id="L1321">            c.weighty = 1.0;</span>

<span class="nc" id="L1323">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1324">            pnlMedia = new MediaPanel();</span>
<span class="nc" id="L1325">            addToGB(pnlMedia, this, gridbag, c);</span>

<span class="nc" id="L1327">            pnlOrientation = new OrientationPanel();</span>
<span class="nc" id="L1328">            c.gridwidth = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L1329">            addToGB(pnlOrientation, this, gridbag, c);</span>

<span class="nc" id="L1331">            pnlMargins = new MarginsPanel();</span>
<span class="nc" id="L1332">            pnlOrientation.addOrientationListener(pnlMargins);</span>
<span class="nc" id="L1333">            pnlMedia.addMediaListener(pnlMargins);</span>
<span class="nc" id="L1334">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1335">            addToGB(pnlMargins, this, gridbag, c);</span>
<span class="nc" id="L1336">        }</span>

        public void updateInfo() {
<span class="nc" id="L1339">            pnlMedia.updateInfo();</span>
<span class="nc" id="L1340">            pnlOrientation.updateInfo();</span>
<span class="nc" id="L1341">            pnlMargins.updateInfo();</span>
<span class="nc" id="L1342">        }</span>
    }

    private class MarginsPanel extends JPanel
                               implements ActionListener, FocusListener {

<span class="nc" id="L1348">        private final String strTitle = getMsg(&quot;border.margins&quot;);</span>
        private JFormattedTextField leftMargin, rightMargin,
                                    topMargin, bottomMargin;
        private JLabel lblLeft, lblRight, lblTop, lblBottom;
<span class="nc" id="L1352">        private int units = MediaPrintableArea.MM;</span>
        // storage for the last margin values calculated, -ve is uninitialised
<span class="nc" id="L1354">        private float lmVal = -1f,rmVal = -1f, tmVal = -1f, bmVal = -1f;</span>
        // storage for margins as objects mapped into orientation for display
        private Float lmObj,rmObj,tmObj,bmObj;

<span class="nc" id="L1358">        public MarginsPanel() {</span>
<span class="nc" id="L1359">            super();</span>

<span class="nc" id="L1361">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L1362">            GridBagConstraints c = new GridBagConstraints();</span>
<span class="nc" id="L1363">            c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L1364">            c.weightx = 1.0;</span>
<span class="nc" id="L1365">            c.weighty = 0.0;</span>
<span class="nc" id="L1366">            c.insets = compInsets;</span>

<span class="nc" id="L1368">            setLayout(gridbag);</span>
<span class="nc" id="L1369">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L1371">            String unitsKey = &quot;label.millimetres&quot;;</span>
<span class="nc" id="L1372">            String defaultCountry = Locale.getDefault().getCountry();</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">            if (defaultCountry != null &amp;&amp;</span>
<span class="nc bnc" id="L1374" title="All 2 branches missed.">                (defaultCountry.equals(&quot;&quot;) ||</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">                 defaultCountry.equals(Locale.US.getCountry()) ||</span>
<span class="nc bnc" id="L1376" title="All 2 branches missed.">                 defaultCountry.equals(Locale.CANADA.getCountry()))) {</span>
<span class="nc" id="L1377">                unitsKey = &quot;label.inches&quot;;</span>
<span class="nc" id="L1378">                units = MediaPrintableArea.INCH;</span>
            }
<span class="nc" id="L1380">            String unitsMsg = getMsg(unitsKey);</span>

            DecimalFormat format;
<span class="nc bnc" id="L1383" title="All 2 branches missed.">            if (units == MediaPrintableArea.MM) {</span>
<span class="nc" id="L1384">                format = new DecimalFormat(&quot;###.##&quot;);</span>
<span class="nc" id="L1385">                format.setMaximumIntegerDigits(3);</span>
            } else {
<span class="nc" id="L1387">                format = new DecimalFormat(&quot;##.##&quot;);</span>
<span class="nc" id="L1388">                format.setMaximumIntegerDigits(2);</span>
            }

<span class="nc" id="L1391">            format.setMinimumFractionDigits(1);</span>
<span class="nc" id="L1392">            format.setMaximumFractionDigits(2);</span>
<span class="nc" id="L1393">            format.setMinimumIntegerDigits(1);</span>
<span class="nc" id="L1394">            format.setParseIntegerOnly(false);</span>
<span class="nc" id="L1395">            format.setDecimalSeparatorAlwaysShown(true);</span>
<span class="nc" id="L1396">            NumberFormatter nf = new NumberFormatter(format);</span>
<span class="nc" id="L1397">            nf.setMinimum(new Float(0.0f));</span>
<span class="nc" id="L1398">            nf.setMaximum(new Float(999.0f));</span>
<span class="nc" id="L1399">            nf.setAllowsInvalid(true);</span>
<span class="nc" id="L1400">            nf.setCommitsOnValidEdit(true);</span>

<span class="nc" id="L1402">            leftMargin = new JFormattedTextField(nf);</span>
<span class="nc" id="L1403">            leftMargin.addFocusListener(this);</span>
<span class="nc" id="L1404">            leftMargin.addActionListener(this);</span>
<span class="nc" id="L1405">            leftMargin.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1406">                                              getMsg(&quot;label.leftmargin&quot;));</span>
<span class="nc" id="L1407">            rightMargin = new JFormattedTextField(nf);</span>
<span class="nc" id="L1408">            rightMargin.addFocusListener(this);</span>
<span class="nc" id="L1409">            rightMargin.addActionListener(this);</span>
<span class="nc" id="L1410">            rightMargin.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1411">                                              getMsg(&quot;label.rightmargin&quot;));</span>
<span class="nc" id="L1412">            topMargin = new JFormattedTextField(nf);</span>
<span class="nc" id="L1413">            topMargin.addFocusListener(this);</span>
<span class="nc" id="L1414">            topMargin.addActionListener(this);</span>
<span class="nc" id="L1415">            topMargin.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1416">                                              getMsg(&quot;label.topmargin&quot;));</span>
<span class="nc" id="L1417">            topMargin = new JFormattedTextField(nf);</span>
<span class="nc" id="L1418">            bottomMargin = new JFormattedTextField(nf);</span>
<span class="nc" id="L1419">            bottomMargin.addFocusListener(this);</span>
<span class="nc" id="L1420">            bottomMargin.addActionListener(this);</span>
<span class="nc" id="L1421">            bottomMargin.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1422">                                              getMsg(&quot;label.bottommargin&quot;));</span>
<span class="nc" id="L1423">            topMargin = new JFormattedTextField(nf);</span>
<span class="nc" id="L1424">            c.gridwidth = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L1425">            lblLeft = new JLabel(getMsg(&quot;label.leftmargin&quot;) + &quot; &quot; + unitsMsg,</span>
                                 JLabel.LEADING);
<span class="nc" id="L1427">            lblLeft.setDisplayedMnemonic(getMnemonic(&quot;label.leftmargin&quot;));</span>
<span class="nc" id="L1428">            lblLeft.setLabelFor(leftMargin);</span>
<span class="nc" id="L1429">            addToGB(lblLeft, this, gridbag, c);</span>

<span class="nc" id="L1431">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1432">            lblRight = new JLabel(getMsg(&quot;label.rightmargin&quot;) + &quot; &quot; + unitsMsg,</span>
                                  JLabel.LEADING);
<span class="nc" id="L1434">            lblRight.setDisplayedMnemonic(getMnemonic(&quot;label.rightmargin&quot;));</span>
<span class="nc" id="L1435">            lblRight.setLabelFor(rightMargin);</span>
<span class="nc" id="L1436">            addToGB(lblRight, this, gridbag, c);</span>

<span class="nc" id="L1438">            c.gridwidth = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L1439">            addToGB(leftMargin, this, gridbag, c);</span>

<span class="nc" id="L1441">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1442">            addToGB(rightMargin, this, gridbag, c);</span>

            // add an invisible spacing component.
<span class="nc" id="L1445">            addToGB(new JPanel(), this, gridbag, c);</span>

<span class="nc" id="L1447">            c.gridwidth = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L1448">            lblTop = new JLabel(getMsg(&quot;label.topmargin&quot;) + &quot; &quot; + unitsMsg,</span>
                                JLabel.LEADING);
<span class="nc" id="L1450">            lblTop.setDisplayedMnemonic(getMnemonic(&quot;label.topmargin&quot;));</span>
<span class="nc" id="L1451">            lblTop.setLabelFor(topMargin);</span>
<span class="nc" id="L1452">            addToGB(lblTop, this, gridbag, c);</span>

<span class="nc" id="L1454">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1455">            lblBottom = new JLabel(getMsg(&quot;label.bottommargin&quot;) +</span>
                                   &quot; &quot; + unitsMsg, JLabel.LEADING);
<span class="nc" id="L1457">            lblBottom.setDisplayedMnemonic(getMnemonic(&quot;label.bottommargin&quot;));</span>
<span class="nc" id="L1458">            lblBottom.setLabelFor(bottomMargin);</span>
<span class="nc" id="L1459">            addToGB(lblBottom, this, gridbag, c);</span>

<span class="nc" id="L1461">            c.gridwidth = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L1462">            addToGB(topMargin, this, gridbag, c);</span>

<span class="nc" id="L1464">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1465">            addToGB(bottomMargin, this, gridbag, c);</span>

<span class="nc" id="L1467">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1470">            Object source = e.getSource();</span>
<span class="nc" id="L1471">            updateMargins(source);</span>
<span class="nc" id="L1472">        }</span>

        public void focusLost(FocusEvent e) {
<span class="nc" id="L1475">            Object source = e.getSource();</span>
<span class="nc" id="L1476">            updateMargins(source);</span>
<span class="nc" id="L1477">        }</span>

<span class="nc" id="L1479">        public void focusGained(FocusEvent e) {}</span>

        /* Get the numbers, use to create a MPA.
         * If its valid, accept it and update the attribute set.
         * If its not valid, then reject it and call updateInfo()
         * to re-establish the previous entries.
         */
        public void updateMargins(Object source) {
<span class="nc bnc" id="L1487" title="All 2 branches missed.">            if (!(source instanceof JFormattedTextField)) {</span>
<span class="nc" id="L1488">                return;</span>
            } else {
<span class="nc" id="L1490">                JFormattedTextField tf = (JFormattedTextField)source;</span>
<span class="nc" id="L1491">                Float val = (Float)tf.getValue();</span>
<span class="nc bnc" id="L1492" title="All 2 branches missed.">                if (val == null) {</span>
<span class="nc" id="L1493">                    return;</span>
                }
<span class="nc bnc" id="L1495" title="All 4 branches missed.">                if (tf == leftMargin &amp;&amp; val.equals(lmObj)) {</span>
<span class="nc" id="L1496">                    return;</span>
                }
<span class="nc bnc" id="L1498" title="All 4 branches missed.">                if (tf == rightMargin &amp;&amp; val.equals(rmObj)) {</span>
<span class="nc" id="L1499">                    return;</span>
                }
<span class="nc bnc" id="L1501" title="All 4 branches missed.">                if (tf == topMargin &amp;&amp; val.equals(tmObj)) {</span>
<span class="nc" id="L1502">                    return;</span>
                }
<span class="nc bnc" id="L1504" title="All 4 branches missed.">                if (tf == bottomMargin &amp;&amp; val.equals(bmObj)) {</span>
<span class="nc" id="L1505">                    return;</span>
                }
            }

<span class="nc" id="L1509">            Float lmTmpObj = (Float)leftMargin.getValue();</span>
<span class="nc" id="L1510">            Float rmTmpObj = (Float)rightMargin.getValue();</span>
<span class="nc" id="L1511">            Float tmTmpObj = (Float)topMargin.getValue();</span>
<span class="nc" id="L1512">            Float bmTmpObj = (Float)bottomMargin.getValue();</span>

<span class="nc" id="L1514">            float lm = lmTmpObj.floatValue();</span>
<span class="nc" id="L1515">            float rm = rmTmpObj.floatValue();</span>
<span class="nc" id="L1516">            float tm = tmTmpObj.floatValue();</span>
<span class="nc" id="L1517">            float bm = bmTmpObj.floatValue();</span>

            /* adjust for orientation */
<span class="nc" id="L1520">            Class orCategory = OrientationRequested.class;</span>
<span class="nc" id="L1521">            OrientationRequested or =</span>
<span class="nc" id="L1522">                (OrientationRequested)asCurrent.get(orCategory);</span>

<span class="nc bnc" id="L1524" title="All 2 branches missed.">            if (or == null) {</span>
<span class="nc" id="L1525">                or = (OrientationRequested)</span>
<span class="nc" id="L1526">                     psCurrent.getDefaultAttributeValue(orCategory);</span>
            }

            float tmp;
<span class="nc bnc" id="L1530" title="All 2 branches missed.">            if (or == OrientationRequested.REVERSE_PORTRAIT) {</span>
<span class="nc" id="L1531">                tmp = lm; lm = rm; rm = tmp;</span>
<span class="nc" id="L1532">                tmp = tm; tm = bm; bm = tmp;</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">            } else if (or == OrientationRequested.LANDSCAPE) {</span>
<span class="nc" id="L1534">                tmp = lm;</span>
<span class="nc" id="L1535">                lm = tm;</span>
<span class="nc" id="L1536">                tm = rm;</span>
<span class="nc" id="L1537">                rm = bm;</span>
<span class="nc" id="L1538">                bm = tmp;</span>
<span class="nc bnc" id="L1539" title="All 2 branches missed.">            } else if (or == OrientationRequested.REVERSE_LANDSCAPE) {</span>
<span class="nc" id="L1540">                tmp = lm;</span>
<span class="nc" id="L1541">                lm = bm;</span>
<span class="nc" id="L1542">                bm = rm;</span>
<span class="nc" id="L1543">                rm = tm;</span>
<span class="nc" id="L1544">                tm = tmp;</span>
            }
            MediaPrintableArea mpa;
<span class="nc bnc" id="L1547" title="All 2 branches missed.">            if ((mpa = validateMargins(lm, rm, tm, bm)) != null) {</span>
<span class="nc" id="L1548">                asCurrent.add(mpa);</span>
<span class="nc" id="L1549">                lmVal = lm;</span>
<span class="nc" id="L1550">                rmVal = rm;</span>
<span class="nc" id="L1551">                tmVal = tm;</span>
<span class="nc" id="L1552">                bmVal = bm;</span>
<span class="nc" id="L1553">                lmObj = lmTmpObj;</span>
<span class="nc" id="L1554">                rmObj = rmTmpObj;</span>
<span class="nc" id="L1555">                tmObj = tmTmpObj;</span>
<span class="nc" id="L1556">                bmObj = bmTmpObj;</span>
            } else {
<span class="nc bnc" id="L1558" title="All 8 branches missed.">                if (lmObj == null || rmObj == null ||</span>
                    tmObj == null || rmObj == null) {
<span class="nc" id="L1560">                    return;</span>
                } else {
<span class="nc" id="L1562">                    leftMargin.setValue(lmObj);</span>
<span class="nc" id="L1563">                    rightMargin.setValue(rmObj);</span>
<span class="nc" id="L1564">                    topMargin.setValue(tmObj);</span>
<span class="nc" id="L1565">                    bottomMargin.setValue(bmObj);</span>

                }
            }
<span class="nc" id="L1569">        }</span>

        /*
         * This method either accepts the values and creates a new
         * MediaPrintableArea, or does nothing.
         * It should not attempt to create a printable area from anything
         * other than the exact values passed in.
         * But REMIND/TBD: it would be user friendly to replace margins the
         * user entered but are out of bounds with the minimum.
         * At that point this method will need to take responsibility for
         * updating the &quot;stored&quot; values and the UI.
         */
        private MediaPrintableArea validateMargins(float lm, float rm,
                                                   float tm, float bm) {

<span class="nc" id="L1584">            Class mpaCategory = MediaPrintableArea.class;</span>
            MediaPrintableArea mpa;
<span class="nc" id="L1586">            MediaPrintableArea mpaMax = null;</span>
<span class="nc" id="L1587">            MediaSize mediaSize = null;</span>

<span class="nc" id="L1589">            Media media = (Media)asCurrent.get(Media.class);</span>
<span class="nc bnc" id="L1590" title="All 4 branches missed.">            if (media == null || !(media instanceof MediaSizeName)) {</span>
<span class="nc" id="L1591">                media = (Media)psCurrent.getDefaultAttributeValue(Media.class);</span>
            }
<span class="nc bnc" id="L1593" title="All 4 branches missed.">            if (media != null &amp;&amp; (media instanceof MediaSizeName)) {</span>
<span class="nc" id="L1594">                MediaSizeName msn = (MediaSizeName)media;</span>
<span class="nc" id="L1595">                mediaSize = MediaSize.getMediaSizeForName(msn);</span>
            }
<span class="nc bnc" id="L1597" title="All 2 branches missed.">            if (mediaSize == null) {</span>
<span class="nc" id="L1598">                mediaSize = new MediaSize(8.5f, 11f, Size2DSyntax.INCH);</span>
            }

<span class="nc bnc" id="L1601" title="All 2 branches missed.">            if (media != null) {</span>
<span class="nc" id="L1602">                PrintRequestAttributeSet tmpASet =</span>
<span class="nc" id="L1603">                    new HashPrintRequestAttributeSet(asCurrent);</span>
<span class="nc" id="L1604">                tmpASet.add(media);</span>

<span class="nc" id="L1606">                Object values =</span>
<span class="nc" id="L1607">                    psCurrent.getSupportedAttributeValues(mpaCategory,</span>
<span class="nc" id="L1608">                                                          docFlavor,</span>
                                                          tmpASet);
<span class="nc bnc" id="L1610" title="All 4 branches missed.">                if (values instanceof MediaPrintableArea[] &amp;&amp;</span>
                    ((MediaPrintableArea[])values).length &gt; 0) {
<span class="nc" id="L1612">                    mpaMax = ((MediaPrintableArea[])values)[0];</span>

                }
            }
<span class="nc bnc" id="L1616" title="All 2 branches missed.">            if (mpaMax == null) {</span>
<span class="nc" id="L1617">                mpaMax = new MediaPrintableArea(0f, 0f,</span>
<span class="nc" id="L1618">                                                mediaSize.getX(units),</span>
<span class="nc" id="L1619">                                                mediaSize.getY(units),</span>
                                                units);
            }

<span class="nc" id="L1623">            float wid = mediaSize.getX(units);</span>
<span class="nc" id="L1624">            float hgt = mediaSize.getY(units);</span>
<span class="nc" id="L1625">            float pax = lm;</span>
<span class="nc" id="L1626">            float pay = tm;</span>
<span class="nc" id="L1627">            float paw = wid - lm - rm;</span>
<span class="nc" id="L1628">            float pah = hgt - tm - bm;</span>

<span class="nc bnc" id="L1630" title="All 8 branches missed.">            if (paw &lt;= 0f || pah &lt;= 0f || pax &lt; 0f || pay &lt; 0f ||</span>
<span class="nc bnc" id="L1631" title="All 4 branches missed.">                pax &lt; mpaMax.getX(units) || paw &gt; mpaMax.getWidth(units) ||</span>
<span class="nc bnc" id="L1632" title="All 4 branches missed.">                pay &lt; mpaMax.getY(units) || pah &gt; mpaMax.getHeight(units)) {</span>
<span class="nc" id="L1633">                return null;</span>
            } else {
<span class="nc" id="L1635">                return new MediaPrintableArea(lm, tm, paw, pah, units);</span>
            }
        }

        /* This is complex as a MediaPrintableArea is valid only within
         * a particular context of media size.
         * So we need a MediaSize as well as a MediaPrintableArea.
         * MediaSize can be obtained from MediaSizeName.
         * If the application specifies a MediaPrintableArea, we accept it
         * to the extent its valid for the Media they specify. If they
         * don't specify a Media, then the default is assumed.
         *
         * If an application doesn't define a MediaPrintableArea, we need to
         * create a suitable one, this is created using the specified (or
         * default) Media and default 1 inch margins. This is validated
         * against the paper in case this is too large for tiny media.
         */
        public void updateInfo() {

<span class="nc bnc" id="L1654" title="All 2 branches missed.">            if (isAWT) {</span>
<span class="nc" id="L1655">                leftMargin.setEnabled(false);</span>
<span class="nc" id="L1656">                rightMargin.setEnabled(false);</span>
<span class="nc" id="L1657">                topMargin.setEnabled(false);</span>
<span class="nc" id="L1658">                bottomMargin.setEnabled(false);</span>
<span class="nc" id="L1659">                lblLeft.setEnabled(false);</span>
<span class="nc" id="L1660">                lblRight.setEnabled(false);</span>
<span class="nc" id="L1661">                lblTop.setEnabled(false);</span>
<span class="nc" id="L1662">                lblBottom.setEnabled(false);</span>
<span class="nc" id="L1663">                return;</span>
            }

<span class="nc" id="L1666">            Class mpaCategory = MediaPrintableArea.class;</span>
<span class="nc" id="L1667">            MediaPrintableArea mpa =</span>
<span class="nc" id="L1668">                 (MediaPrintableArea)asCurrent.get(mpaCategory);</span>
<span class="nc" id="L1669">            MediaPrintableArea mpaMax = null;</span>
<span class="nc" id="L1670">            MediaSize mediaSize = null;</span>

<span class="nc" id="L1672">            Media media = (Media)asCurrent.get(Media.class);</span>
<span class="nc bnc" id="L1673" title="All 4 branches missed.">            if (media == null || !(media instanceof MediaSizeName)) {</span>
<span class="nc" id="L1674">                media = (Media)psCurrent.getDefaultAttributeValue(Media.class);</span>
            }
<span class="nc bnc" id="L1676" title="All 4 branches missed.">            if (media != null &amp;&amp; (media instanceof MediaSizeName)) {</span>
<span class="nc" id="L1677">                MediaSizeName msn = (MediaSizeName)media;</span>
<span class="nc" id="L1678">                mediaSize = MediaSize.getMediaSizeForName(msn);</span>
            }
<span class="nc bnc" id="L1680" title="All 2 branches missed.">            if (mediaSize == null) {</span>
<span class="nc" id="L1681">                mediaSize = new MediaSize(8.5f, 11f, Size2DSyntax.INCH);</span>
            }

<span class="nc bnc" id="L1684" title="All 2 branches missed.">            if (media != null) {</span>
<span class="nc" id="L1685">                PrintRequestAttributeSet tmpASet =</span>
<span class="nc" id="L1686">                    new HashPrintRequestAttributeSet(asCurrent);</span>
<span class="nc" id="L1687">                tmpASet.add(media);</span>

<span class="nc" id="L1689">                Object values =</span>
<span class="nc" id="L1690">                    psCurrent.getSupportedAttributeValues(mpaCategory,</span>
<span class="nc" id="L1691">                                                          docFlavor,</span>
                                                          tmpASet);
<span class="nc bnc" id="L1693" title="All 4 branches missed.">                if (values instanceof MediaPrintableArea[] &amp;&amp;</span>
                    ((MediaPrintableArea[])values).length &gt; 0) {
<span class="nc" id="L1695">                    mpaMax = ((MediaPrintableArea[])values)[0];</span>

<span class="nc bnc" id="L1697" title="All 2 branches missed.">                } else if (values instanceof MediaPrintableArea) {</span>
<span class="nc" id="L1698">                    mpaMax = (MediaPrintableArea)values;</span>
                }
            }
<span class="nc bnc" id="L1701" title="All 2 branches missed.">            if (mpaMax == null) {</span>
<span class="nc" id="L1702">                mpaMax = new MediaPrintableArea(0f, 0f,</span>
<span class="nc" id="L1703">                                                mediaSize.getX(units),</span>
<span class="nc" id="L1704">                                                mediaSize.getY(units),</span>
                                                units);
            }

            /*
             * At this point we now know as best we can :-
             * - the media size
             * - the maximum corresponding printable area
             * - the media printable area specified by the client, if any.
             * The next step is to create a default MPA if none was specified.
             * 1&quot; margins are used unless they are disproportionately
             * large compared to the size of the media.
             */

<span class="nc" id="L1718">            float wid = mediaSize.getX(MediaPrintableArea.INCH);</span>
<span class="nc" id="L1719">            float hgt = mediaSize.getY(MediaPrintableArea.INCH);</span>
<span class="nc" id="L1720">            float maxMarginRatio = 5f;</span>
            float xMgn, yMgn;
<span class="nc bnc" id="L1722" title="All 2 branches missed.">            if (wid &gt; maxMarginRatio) {</span>
<span class="nc" id="L1723">                xMgn = 1f;</span>
            } else {
<span class="nc" id="L1725">                xMgn = wid / maxMarginRatio;</span>
            }
<span class="nc bnc" id="L1727" title="All 2 branches missed.">            if (hgt &gt; maxMarginRatio) {</span>
<span class="nc" id="L1728">                yMgn = 1f;</span>
            } else {
<span class="nc" id="L1730">                yMgn = hgt / maxMarginRatio;</span>
            }

<span class="nc bnc" id="L1733" title="All 2 branches missed.">            if (mpa == null) {</span>
<span class="nc" id="L1734">                mpa = new MediaPrintableArea(xMgn, yMgn,</span>
                                             wid-(2*xMgn), hgt-(2*yMgn),
                                             MediaPrintableArea.INCH);
<span class="nc" id="L1737">                asCurrent.add(mpa);</span>
            }
<span class="nc" id="L1739">            float pax = mpa.getX(units);</span>
<span class="nc" id="L1740">            float pay = mpa.getY(units);</span>
<span class="nc" id="L1741">            float paw = mpa.getWidth(units);</span>
<span class="nc" id="L1742">            float pah = mpa.getHeight(units);</span>
<span class="nc" id="L1743">            float paxMax = mpaMax.getX(units);</span>
<span class="nc" id="L1744">            float payMax = mpaMax.getY(units);</span>
<span class="nc" id="L1745">            float pawMax = mpaMax.getWidth(units);</span>
<span class="nc" id="L1746">            float pahMax = mpaMax.getHeight(units);</span>


<span class="nc" id="L1749">            boolean invalid = false;</span>

            // If the paper is set to something which is too small to
            // accommodate a specified printable area, perhaps carried
            // over from a larger paper, the adjustment that needs to be
            // performed should seem the most natural from a user's viewpoint.
            // Since the user is specifying margins, then we are biased
            // towards keeping the margins as close to what is specified as
            // possible, shrinking or growing the printable area.
            // But the API uses printable area, so you need to know the
            // media size in which the margins were previously interpreted,
            // or at least have a record of the margins.
            // In the case that this is the creation of this UI we do not
            // have this record, so we are somewhat reliant on the client
            // to supply a reasonable default
<span class="nc" id="L1764">            wid = mediaSize.getX(units);</span>
<span class="nc" id="L1765">            hgt = mediaSize.getY(units);</span>
<span class="nc bnc" id="L1766" title="All 2 branches missed.">            if (lmVal &gt;= 0f) {</span>
<span class="nc" id="L1767">                invalid = true;</span>

<span class="nc bnc" id="L1769" title="All 2 branches missed.">                if (lmVal + rmVal &gt; wid) {</span>
                    // margins impossible, but maintain P.A if can
<span class="nc bnc" id="L1771" title="All 2 branches missed.">                    if (paw &gt; pawMax) {</span>
<span class="nc" id="L1772">                        paw = pawMax;</span>
                    }
                    // try to centre the printable area.
<span class="nc" id="L1775">                    pax = (wid - paw)/2f;</span>
                } else {
<span class="nc bnc" id="L1777" title="All 2 branches missed.">                    pax = (lmVal &gt;= paxMax) ? lmVal : paxMax;</span>
<span class="nc" id="L1778">                    paw = wid - pax - rmVal;</span>
                }
<span class="nc bnc" id="L1780" title="All 2 branches missed.">                if (tmVal + bmVal &gt; hgt) {</span>
<span class="nc bnc" id="L1781" title="All 2 branches missed.">                    if (pah &gt; pahMax) {</span>
<span class="nc" id="L1782">                        pah = pahMax;</span>
                    }
<span class="nc" id="L1784">                    pay = (hgt - pah)/2f;</span>
                } else {
<span class="nc bnc" id="L1786" title="All 2 branches missed.">                    pay = (tmVal &gt;= payMax) ? tmVal : payMax;</span>
<span class="nc" id="L1787">                    pah = hgt - pay - bmVal;</span>
                }
            }
<span class="nc bnc" id="L1790" title="All 2 branches missed.">            if (pax &lt; paxMax) {</span>
<span class="nc" id="L1791">                invalid = true;</span>
<span class="nc" id="L1792">                pax = paxMax;</span>
            }
<span class="nc bnc" id="L1794" title="All 2 branches missed.">            if (pay &lt; payMax) {</span>
<span class="nc" id="L1795">                invalid = true;</span>
<span class="nc" id="L1796">                pay = payMax;</span>
            }
<span class="nc bnc" id="L1798" title="All 2 branches missed.">            if (paw &gt; pawMax) {</span>
<span class="nc" id="L1799">                invalid = true;</span>
<span class="nc" id="L1800">                paw = pawMax;</span>
            }
<span class="nc bnc" id="L1802" title="All 2 branches missed.">            if (pah &gt; pahMax) {</span>
<span class="nc" id="L1803">                invalid = true;</span>
<span class="nc" id="L1804">                pah = pahMax;</span>
            }

<span class="nc bnc" id="L1807" title="All 4 branches missed.">            if ((pax + paw &gt; paxMax + pawMax) || (paw &lt;= 0f)) {</span>
<span class="nc" id="L1808">                invalid = true;</span>
<span class="nc" id="L1809">                pax = paxMax;</span>
<span class="nc" id="L1810">                paw = pawMax;</span>
            }
<span class="nc bnc" id="L1812" title="All 4 branches missed.">            if ((pay + pah &gt; payMax + pahMax) || (pah &lt;= 0f)) {</span>
<span class="nc" id="L1813">                invalid = true;</span>
<span class="nc" id="L1814">                pay = payMax;</span>
<span class="nc" id="L1815">                pah = pahMax;</span>
            }

<span class="nc bnc" id="L1818" title="All 2 branches missed.">            if (invalid) {</span>
<span class="nc" id="L1819">                mpa = new MediaPrintableArea(pax, pay, paw, pah, units);</span>
<span class="nc" id="L1820">                asCurrent.add(mpa);</span>
            }

            /* We now have a valid printable area.
             * Turn it into margins, using the mediaSize
             */
<span class="nc" id="L1826">            lmVal = pax;</span>
<span class="nc" id="L1827">            tmVal = pay;</span>
<span class="nc" id="L1828">            rmVal = mediaSize.getX(units) - pax - paw;</span>
<span class="nc" id="L1829">            bmVal = mediaSize.getY(units) - pay - pah;</span>

<span class="nc" id="L1831">            lmObj = new Float(lmVal);</span>
<span class="nc" id="L1832">            rmObj = new Float(rmVal);</span>
<span class="nc" id="L1833">            tmObj = new Float(tmVal);</span>
<span class="nc" id="L1834">            bmObj = new Float(bmVal);</span>

            /* Now we know the values to use, we need to assign them
             * to the fields appropriate for the orientation.
             * Note: if orientation changes this method must be called.
             */
<span class="nc" id="L1840">            Class orCategory = OrientationRequested.class;</span>
<span class="nc" id="L1841">            OrientationRequested or =</span>
<span class="nc" id="L1842">                (OrientationRequested)asCurrent.get(orCategory);</span>

<span class="nc bnc" id="L1844" title="All 2 branches missed.">            if (or == null) {</span>
<span class="nc" id="L1845">                or = (OrientationRequested)</span>
<span class="nc" id="L1846">                     psCurrent.getDefaultAttributeValue(orCategory);</span>
            }

            Float tmp;

<span class="nc bnc" id="L1851" title="All 2 branches missed.">            if (or == OrientationRequested.REVERSE_PORTRAIT) {</span>
<span class="nc" id="L1852">                tmp = lmObj; lmObj = rmObj; rmObj = tmp;</span>
<span class="nc" id="L1853">                tmp = tmObj; tmObj = bmObj; bmObj = tmp;</span>
<span class="nc bnc" id="L1854" title="All 2 branches missed.">            }  else if (or == OrientationRequested.LANDSCAPE) {</span>
<span class="nc" id="L1855">                tmp = lmObj;</span>
<span class="nc" id="L1856">                lmObj = bmObj;</span>
<span class="nc" id="L1857">                bmObj = rmObj;</span>
<span class="nc" id="L1858">                rmObj = tmObj;</span>
<span class="nc" id="L1859">                tmObj = tmp;</span>
<span class="nc bnc" id="L1860" title="All 2 branches missed.">            }  else if (or == OrientationRequested.REVERSE_LANDSCAPE) {</span>
<span class="nc" id="L1861">                tmp = lmObj;</span>
<span class="nc" id="L1862">                lmObj = tmObj;</span>
<span class="nc" id="L1863">                tmObj = rmObj;</span>
<span class="nc" id="L1864">                rmObj = bmObj;</span>
<span class="nc" id="L1865">                bmObj = tmp;</span>
            }

<span class="nc" id="L1868">            leftMargin.setValue(lmObj);</span>
<span class="nc" id="L1869">            rightMargin.setValue(rmObj);</span>
<span class="nc" id="L1870">            topMargin.setValue(tmObj);</span>
<span class="nc" id="L1871">            bottomMargin.setValue(bmObj);</span>
<span class="nc" id="L1872">        }</span>
    }

    private class MediaPanel extends JPanel implements ItemListener {

<span class="nc" id="L1877">        private final String strTitle = getMsg(&quot;border.media&quot;);</span>
        private JLabel lblSize, lblSource;
        private JComboBox cbSize, cbSource;
<span class="nc" id="L1880">        private Vector sizes = new Vector();</span>
<span class="nc" id="L1881">        private Vector sources = new Vector();</span>
<span class="nc" id="L1882">        private MarginsPanel pnlMargins = null;</span>

<span class="nc" id="L1884">        public MediaPanel() {</span>
<span class="nc" id="L1885">            super();</span>

<span class="nc" id="L1887">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L1888">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L1890">            setLayout(gridbag);</span>
<span class="nc" id="L1891">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L1893">            cbSize = new JComboBox();</span>
<span class="nc" id="L1894">            cbSource = new JComboBox();</span>

<span class="nc" id="L1896">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L1897">            c.insets = compInsets;</span>
<span class="nc" id="L1898">            c.weighty = 1.0;</span>

<span class="nc" id="L1900">            c.weightx = 0.0;</span>
<span class="nc" id="L1901">            lblSize = new JLabel(getMsg(&quot;label.size&quot;), JLabel.TRAILING);</span>
<span class="nc" id="L1902">            lblSize.setDisplayedMnemonic(getMnemonic(&quot;label.size&quot;));</span>
<span class="nc" id="L1903">            lblSize.setLabelFor(cbSize);</span>
<span class="nc" id="L1904">            addToGB(lblSize, this, gridbag, c);</span>
<span class="nc" id="L1905">            c.weightx = 1.0;</span>
<span class="nc" id="L1906">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1907">            addToGB(cbSize, this, gridbag, c);</span>

<span class="nc" id="L1909">            c.weightx = 0.0;</span>
<span class="nc" id="L1910">            c.gridwidth = 1;</span>
<span class="nc" id="L1911">            lblSource = new JLabel(getMsg(&quot;label.source&quot;), JLabel.TRAILING);</span>
<span class="nc" id="L1912">            lblSource.setDisplayedMnemonic(getMnemonic(&quot;label.source&quot;));</span>
<span class="nc" id="L1913">            lblSource.setLabelFor(cbSource);</span>
<span class="nc" id="L1914">            addToGB(lblSource, this, gridbag, c);</span>
<span class="nc" id="L1915">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1916">            addToGB(cbSource, this, gridbag, c);</span>
<span class="nc" id="L1917">        }</span>

        private String getMediaName(String key) {
            try {
                // replace characters that would be invalid in
                // a resource key with valid characters
<span class="nc" id="L1923">                String newkey = key.replace(' ', '-');</span>
<span class="nc" id="L1924">                newkey = newkey.replace('#', 'n');</span>

<span class="nc" id="L1926">                return messageRB.getString(newkey);</span>
<span class="nc" id="L1927">            } catch (java.util.MissingResourceException e) {</span>
<span class="nc" id="L1928">                return key;</span>
            }
        }

        public void itemStateChanged(ItemEvent e) {
<span class="nc" id="L1933">            Object source = e.getSource();</span>

<span class="nc bnc" id="L1935" title="All 2 branches missed.">            if (e.getStateChange() == ItemEvent.SELECTED) {</span>
<span class="nc bnc" id="L1936" title="All 2 branches missed.">                if (source == cbSize) {</span>
<span class="nc" id="L1937">                    int index = cbSize.getSelectedIndex();</span>

<span class="nc bnc" id="L1939" title="All 4 branches missed.">                    if ((index &gt;= 0) &amp;&amp; (index &lt; sizes.size())) {</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">                        if ((cbSource.getItemCount() &gt; 1) &amp;&amp;</span>
<span class="nc bnc" id="L1941" title="All 2 branches missed.">                            (cbSource.getSelectedIndex() &gt;= 1))</span>
                        {
<span class="nc" id="L1943">                            int src = cbSource.getSelectedIndex() - 1;</span>
<span class="nc" id="L1944">                            MediaTray mt = (MediaTray)sources.get(src);</span>
<span class="nc" id="L1945">                            asCurrent.add(new SunAlternateMedia(mt));</span>
                        }
<span class="nc" id="L1947">                        asCurrent.add((MediaSizeName)sizes.get(index));</span>
                    }
<span class="nc bnc" id="L1949" title="All 2 branches missed.">                } else if (source == cbSource) {</span>
<span class="nc" id="L1950">                    int index = cbSource.getSelectedIndex();</span>

<span class="nc bnc" id="L1952" title="All 4 branches missed.">                    if ((index &gt;= 1) &amp;&amp; (index &lt; (sources.size() + 1))) {</span>
<span class="nc" id="L1953">                       asCurrent.remove(SunAlternateMedia.class);</span>
<span class="nc" id="L1954">                       MediaTray newTray = (MediaTray)sources.get(index - 1);</span>
<span class="nc" id="L1955">                       Media m = (Media)asCurrent.get(Media.class);</span>
<span class="nc bnc" id="L1956" title="All 4 branches missed.">                       if (m == null || m instanceof MediaTray) {</span>
<span class="nc" id="L1957">                           asCurrent.add(newTray);</span>
<span class="nc bnc" id="L1958" title="All 2 branches missed.">                       } else if (m instanceof MediaSizeName) {</span>
<span class="nc" id="L1959">                           MediaSizeName msn = (MediaSizeName)m;</span>
<span class="nc" id="L1960">                           Media def = (Media)psCurrent.getDefaultAttributeValue(Media.class);</span>
<span class="nc bnc" id="L1961" title="All 4 branches missed.">                           if (def instanceof MediaSizeName &amp;&amp; def.equals(msn)) {</span>
<span class="nc" id="L1962">                               asCurrent.add(newTray);</span>
                           } else {
                               /* Non-default paper size, so need to store tray
                                * as SunAlternateMedia
                                */
<span class="nc" id="L1967">                               asCurrent.add(new SunAlternateMedia(newTray));</span>
                           }
                       }
<span class="nc bnc" id="L1970" title="All 2 branches missed.">                    } else if (index == 0) {</span>
<span class="nc" id="L1971">                        asCurrent.remove(SunAlternateMedia.class);</span>
<span class="nc bnc" id="L1972" title="All 2 branches missed.">                        if (cbSize.getItemCount() &gt; 0) {</span>
<span class="nc" id="L1973">                            int size = cbSize.getSelectedIndex();</span>
<span class="nc" id="L1974">                            asCurrent.add((MediaSizeName)sizes.get(size));</span>
                        }
                    }
                }
            // orientation affects display of margins.
<span class="nc bnc" id="L1979" title="All 2 branches missed.">                if (pnlMargins != null) {</span>
<span class="nc" id="L1980">                    pnlMargins.updateInfo();</span>
                }
            }
<span class="nc" id="L1983">        }</span>


        /* this is ad hoc to keep things simple */
        public void addMediaListener(MarginsPanel pnl) {
<span class="nc" id="L1988">            pnlMargins = pnl;</span>
<span class="nc" id="L1989">        }</span>
        public void updateInfo() {
<span class="nc" id="L1991">            Class mdCategory = Media.class;</span>
<span class="nc" id="L1992">            Class amCategory = SunAlternateMedia.class;</span>
<span class="nc" id="L1993">            boolean mediaSupported = false;</span>

<span class="nc" id="L1995">            cbSize.removeItemListener(this);</span>
<span class="nc" id="L1996">            cbSize.removeAllItems();</span>
<span class="nc" id="L1997">            cbSource.removeItemListener(this);</span>
<span class="nc" id="L1998">            cbSource.removeAllItems();</span>
<span class="nc" id="L1999">            cbSource.addItem(getMediaName(&quot;auto-select&quot;));</span>

<span class="nc" id="L2001">            sizes.clear();</span>
<span class="nc" id="L2002">            sources.clear();</span>

<span class="nc bnc" id="L2004" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(mdCategory)) {</span>
<span class="nc" id="L2005">                mediaSupported = true;</span>

<span class="nc" id="L2007">                Object values =</span>
<span class="nc" id="L2008">                    psCurrent.getSupportedAttributeValues(mdCategory,</span>
<span class="nc" id="L2009">                                                          docFlavor,</span>
<span class="nc" id="L2010">                                                          asCurrent);</span>

<span class="nc bnc" id="L2012" title="All 2 branches missed.">                if (values instanceof Media[]) {</span>
<span class="nc" id="L2013">                    Media[] media = (Media[])values;</span>

<span class="nc bnc" id="L2015" title="All 2 branches missed.">                    for (int i = 0; i &lt; media.length; i++) {</span>
<span class="nc" id="L2016">                        Media medium = media[i];</span>

<span class="nc bnc" id="L2018" title="All 2 branches missed.">                        if (medium instanceof MediaSizeName) {</span>
<span class="nc" id="L2019">                            sizes.add(medium);</span>
<span class="nc" id="L2020">                            cbSize.addItem(getMediaName(medium.toString()));</span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">                        } else if (medium instanceof MediaTray) {</span>
<span class="nc" id="L2022">                            sources.add(medium);</span>
<span class="nc" id="L2023">                            cbSource.addItem(getMediaName(medium.toString()));</span>
                        }
                    }
                }
            }

<span class="nc bnc" id="L2029" title="All 4 branches missed.">            boolean msSupported = (mediaSupported &amp;&amp; (sizes.size() &gt; 0));</span>
<span class="nc" id="L2030">            lblSize.setEnabled(msSupported);</span>
<span class="nc" id="L2031">            cbSize.setEnabled(msSupported);</span>

<span class="nc bnc" id="L2033" title="All 2 branches missed.">            if (isAWT) {</span>
<span class="nc" id="L2034">                cbSource.setEnabled(false);</span>
<span class="nc" id="L2035">                lblSource.setEnabled(false);</span>
            } else {
<span class="nc" id="L2037">                cbSource.setEnabled(mediaSupported);</span>
            }

<span class="nc bnc" id="L2040" title="All 2 branches missed.">            if (mediaSupported) {</span>

<span class="nc" id="L2042">                Media medium = (Media)asCurrent.get(mdCategory);</span>

               // initialize size selection to default
<span class="nc" id="L2045">                Media defMedia = (Media)psCurrent.getDefaultAttributeValue(mdCategory);</span>
<span class="nc bnc" id="L2046" title="All 2 branches missed.">                if (defMedia instanceof MediaSizeName) {</span>
<span class="nc bnc" id="L2047" title="All 2 branches missed.">                    cbSize.setSelectedIndex(sizes.size() &gt; 0 ? sizes.indexOf(defMedia) : -1);</span>
                }

<span class="nc bnc" id="L2050" title="All 2 branches missed.">                if (medium == null ||</span>
<span class="nc bnc" id="L2051" title="All 2 branches missed.">                    !psCurrent.isAttributeValueSupported(medium,</span>
<span class="nc" id="L2052">                                                         docFlavor, asCurrent)) {</span>

<span class="nc" id="L2054">                    medium = defMedia;</span>

<span class="nc bnc" id="L2056" title="All 2 branches missed.">                    if (medium == null) {</span>
<span class="nc bnc" id="L2057" title="All 2 branches missed.">                        if (sizes.size() &gt; 0) {</span>
<span class="nc" id="L2058">                            medium = (Media)sizes.get(0);</span>
                        }
                    }
<span class="nc bnc" id="L2061" title="All 2 branches missed.">                    if (medium != null) {</span>
<span class="nc" id="L2062">                        asCurrent.add(medium);</span>
                    }
                }
<span class="nc bnc" id="L2065" title="All 2 branches missed.">                if (medium != null) {</span>
<span class="nc bnc" id="L2066" title="All 2 branches missed.">                    if (medium instanceof MediaSizeName) {</span>
<span class="nc" id="L2067">                        MediaSizeName ms = (MediaSizeName)medium;</span>
<span class="nc" id="L2068">                        cbSize.setSelectedIndex(sizes.indexOf(ms));</span>
<span class="nc bnc" id="L2069" title="All 2 branches missed.">                    } else if (medium instanceof MediaTray) {</span>
<span class="nc" id="L2070">                        MediaTray mt = (MediaTray)medium;</span>
<span class="nc" id="L2071">                        cbSource.setSelectedIndex(sources.indexOf(mt) + 1);</span>
<span class="nc" id="L2072">                    }</span>
                } else {
<span class="nc bnc" id="L2074" title="All 2 branches missed.">                    cbSize.setSelectedIndex(sizes.size() &gt; 0 ? 0 : -1);</span>
<span class="nc" id="L2075">                    cbSource.setSelectedIndex(0);</span>
                }

<span class="nc" id="L2078">                SunAlternateMedia alt = (SunAlternateMedia)asCurrent.get(amCategory);</span>
<span class="nc bnc" id="L2079" title="All 2 branches missed.">                if (alt != null) {</span>
<span class="nc" id="L2080">                    Media md = alt.getMedia();</span>
<span class="nc bnc" id="L2081" title="All 2 branches missed.">                    if (md instanceof MediaTray) {</span>
<span class="nc" id="L2082">                        MediaTray mt = (MediaTray)md;</span>
<span class="nc" id="L2083">                        cbSource.setSelectedIndex(sources.indexOf(mt) + 1);</span>
                    }
                }

<span class="nc" id="L2087">                int selIndex = cbSize.getSelectedIndex();</span>
<span class="nc bnc" id="L2088" title="All 4 branches missed.">                if ((selIndex &gt;= 0) &amp;&amp; (selIndex &lt; sizes.size())) {</span>
<span class="nc" id="L2089">                  asCurrent.add((MediaSizeName)sizes.get(selIndex));</span>
                }

<span class="nc" id="L2092">                selIndex = cbSource.getSelectedIndex();</span>
<span class="nc bnc" id="L2093" title="All 4 branches missed.">                if ((selIndex &gt;= 1) &amp;&amp; (selIndex &lt; (sources.size()+1))) {</span>
<span class="nc" id="L2094">                    MediaTray mt = (MediaTray)sources.get(selIndex-1);</span>
<span class="nc bnc" id="L2095" title="All 2 branches missed.">                    if (medium instanceof MediaTray) {</span>
<span class="nc" id="L2096">                        asCurrent.add(mt);</span>
                    } else {
<span class="nc" id="L2098">                        asCurrent.add(new SunAlternateMedia(mt));</span>
                    }
                }


            }
<span class="nc" id="L2104">            cbSize.addItemListener(this);</span>
<span class="nc" id="L2105">            cbSource.addItemListener(this);</span>
<span class="nc" id="L2106">        }</span>
    }

    private class OrientationPanel extends JPanel
        implements ActionListener
    {
<span class="nc" id="L2112">        private final String strTitle = getMsg(&quot;border.orientation&quot;);</span>
        private IconRadioButton rbPortrait, rbLandscape,
                                rbRevPortrait, rbRevLandscape;
<span class="nc" id="L2115">        private MarginsPanel pnlMargins = null;</span>

<span class="nc" id="L2117">        public OrientationPanel() {</span>
<span class="nc" id="L2118">            super();</span>

<span class="nc" id="L2120">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L2121">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L2123">            setLayout(gridbag);</span>
<span class="nc" id="L2124">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L2126">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L2127">            c.insets = compInsets;</span>
<span class="nc" id="L2128">            c.weighty = 1.0;</span>
<span class="nc" id="L2129">            c.gridwidth = GridBagConstraints.REMAINDER;</span>

<span class="nc" id="L2131">            ButtonGroup bg = new ButtonGroup();</span>
<span class="nc" id="L2132">            rbPortrait = new IconRadioButton(&quot;radiobutton.portrait&quot;,</span>
                                             &quot;orientPortrait.png&quot;, true,
                                             bg, this);
<span class="nc" id="L2135">            rbPortrait.addActionListener(this);</span>
<span class="nc" id="L2136">            addToGB(rbPortrait, this, gridbag, c);</span>
<span class="nc" id="L2137">            rbLandscape = new IconRadioButton(&quot;radiobutton.landscape&quot;,</span>
                                              &quot;orientLandscape.png&quot;, false,
                                              bg, this);
<span class="nc" id="L2140">            rbLandscape.addActionListener(this);</span>
<span class="nc" id="L2141">            addToGB(rbLandscape, this, gridbag, c);</span>
<span class="nc" id="L2142">            rbRevPortrait = new IconRadioButton(&quot;radiobutton.revportrait&quot;,</span>
                                                &quot;orientRevPortrait.png&quot;, false,
                                                bg, this);
<span class="nc" id="L2145">            rbRevPortrait.addActionListener(this);</span>
<span class="nc" id="L2146">            addToGB(rbRevPortrait, this, gridbag, c);</span>
<span class="nc" id="L2147">            rbRevLandscape = new IconRadioButton(&quot;radiobutton.revlandscape&quot;,</span>
                                                 &quot;orientRevLandscape.png&quot;, false,
                                                 bg, this);
<span class="nc" id="L2150">            rbRevLandscape.addActionListener(this);</span>
<span class="nc" id="L2151">            addToGB(rbRevLandscape, this, gridbag, c);</span>
<span class="nc" id="L2152">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L2155">            Object source = e.getSource();</span>

<span class="nc bnc" id="L2157" title="All 2 branches missed.">            if (rbPortrait.isSameAs(source)) {</span>
<span class="nc" id="L2158">                asCurrent.add(OrientationRequested.PORTRAIT);</span>
<span class="nc bnc" id="L2159" title="All 2 branches missed.">            } else if (rbLandscape.isSameAs(source)) {</span>
<span class="nc" id="L2160">                asCurrent.add(OrientationRequested.LANDSCAPE);</span>
<span class="nc bnc" id="L2161" title="All 2 branches missed.">            } else if (rbRevPortrait.isSameAs(source)) {</span>
<span class="nc" id="L2162">                asCurrent.add(OrientationRequested.REVERSE_PORTRAIT);</span>
<span class="nc bnc" id="L2163" title="All 2 branches missed.">            } else if (rbRevLandscape.isSameAs(source)) {</span>
<span class="nc" id="L2164">                asCurrent.add(OrientationRequested.REVERSE_LANDSCAPE);</span>
            }
            // orientation affects display of margins.
<span class="nc bnc" id="L2167" title="All 2 branches missed.">            if (pnlMargins != null) {</span>
<span class="nc" id="L2168">                pnlMargins.updateInfo();</span>
            }
<span class="nc" id="L2170">        }</span>

        /* This is ad hoc to keep things simple */
        void addOrientationListener(MarginsPanel pnl) {
<span class="nc" id="L2174">            pnlMargins = pnl;</span>
<span class="nc" id="L2175">        }</span>

        public void updateInfo() {
<span class="nc" id="L2178">            Class orCategory = OrientationRequested.class;</span>
<span class="nc" id="L2179">            boolean pSupported = false;</span>
<span class="nc" id="L2180">            boolean lSupported = false;</span>
<span class="nc" id="L2181">            boolean rpSupported = false;</span>
<span class="nc" id="L2182">            boolean rlSupported = false;</span>

<span class="nc bnc" id="L2184" title="All 2 branches missed.">            if (isAWT) {</span>
<span class="nc" id="L2185">                pSupported = true;</span>
<span class="nc" id="L2186">                lSupported = true;</span>
            } else
<span class="nc bnc" id="L2188" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(orCategory)) {</span>
<span class="nc" id="L2189">                Object values =</span>
<span class="nc" id="L2190">                    psCurrent.getSupportedAttributeValues(orCategory,</span>
<span class="nc" id="L2191">                                                          docFlavor,</span>
<span class="nc" id="L2192">                                                          asCurrent);</span>

<span class="nc bnc" id="L2194" title="All 2 branches missed.">                if (values instanceof OrientationRequested[]) {</span>
<span class="nc" id="L2195">                    OrientationRequested[] ovalues =</span>
                        (OrientationRequested[])values;

<span class="nc bnc" id="L2198" title="All 2 branches missed.">                    for (int i = 0; i &lt; ovalues.length; i++) {</span>
<span class="nc" id="L2199">                        OrientationRequested value = ovalues[i];</span>

<span class="nc bnc" id="L2201" title="All 2 branches missed.">                        if (value == OrientationRequested.PORTRAIT) {</span>
<span class="nc" id="L2202">                            pSupported = true;</span>
<span class="nc bnc" id="L2203" title="All 2 branches missed.">                        } else if (value == OrientationRequested.LANDSCAPE) {</span>
<span class="nc" id="L2204">                            lSupported = true;</span>
<span class="nc bnc" id="L2205" title="All 2 branches missed.">                        } else if (value == OrientationRequested.REVERSE_PORTRAIT) {</span>
<span class="nc" id="L2206">                            rpSupported = true;</span>
<span class="nc bnc" id="L2207" title="All 2 branches missed.">                        } else if (value == OrientationRequested.REVERSE_LANDSCAPE) {</span>
<span class="nc" id="L2208">                            rlSupported = true;</span>
                        }
                    }
                }
            }


<span class="nc" id="L2215">            rbPortrait.setEnabled(pSupported);</span>
<span class="nc" id="L2216">            rbLandscape.setEnabled(lSupported);</span>
<span class="nc" id="L2217">            rbRevPortrait.setEnabled(rpSupported);</span>
<span class="nc" id="L2218">            rbRevLandscape.setEnabled(rlSupported);</span>

<span class="nc" id="L2220">            OrientationRequested or = (OrientationRequested)asCurrent.get(orCategory);</span>
<span class="nc bnc" id="L2221" title="All 2 branches missed.">            if (or == null ||</span>
<span class="nc bnc" id="L2222" title="All 2 branches missed.">                !psCurrent.isAttributeValueSupported(or, docFlavor, asCurrent)) {</span>

<span class="nc" id="L2224">                or = (OrientationRequested)psCurrent.getDefaultAttributeValue(orCategory);</span>
                // need to validate if default is not supported
<span class="nc bnc" id="L2226" title="All 2 branches missed.">                if ((or != null) &amp;&amp;</span>
<span class="nc bnc" id="L2227" title="All 2 branches missed.">                   !psCurrent.isAttributeValueSupported(or, docFlavor, asCurrent)) {</span>
<span class="nc" id="L2228">                    or = null;</span>
<span class="nc" id="L2229">                    Object values =</span>
<span class="nc" id="L2230">                        psCurrent.getSupportedAttributeValues(orCategory,</span>
<span class="nc" id="L2231">                                                              docFlavor,</span>
<span class="nc" id="L2232">                                                              asCurrent);</span>
<span class="nc bnc" id="L2233" title="All 2 branches missed.">                    if (values instanceof OrientationRequested[]) {</span>
<span class="nc" id="L2234">                        OrientationRequested[] orValues =</span>
                                            (OrientationRequested[])values;
<span class="nc bnc" id="L2236" title="All 2 branches missed.">                        if (orValues.length &gt; 1) {</span>
                            // get the first in the list
<span class="nc" id="L2238">                            or = orValues[0];</span>
                        }
                    }
                }

<span class="nc bnc" id="L2243" title="All 2 branches missed.">                if (or == null) {</span>
<span class="nc" id="L2244">                    or = OrientationRequested.PORTRAIT;</span>
                }
<span class="nc" id="L2246">                asCurrent.add(or);</span>
            }

<span class="nc bnc" id="L2249" title="All 2 branches missed.">            if (or == OrientationRequested.PORTRAIT) {</span>
<span class="nc" id="L2250">                rbPortrait.setSelected(true);</span>
<span class="nc bnc" id="L2251" title="All 2 branches missed.">            } else if (or == OrientationRequested.LANDSCAPE) {</span>
<span class="nc" id="L2252">                rbLandscape.setSelected(true);</span>
<span class="nc bnc" id="L2253" title="All 2 branches missed.">            } else if (or == OrientationRequested.REVERSE_PORTRAIT) {</span>
<span class="nc" id="L2254">                rbRevPortrait.setSelected(true);</span>
            } else { // if (or == OrientationRequested.REVERSE_LANDSCAPE)
<span class="nc" id="L2256">                rbRevLandscape.setSelected(true);</span>
            }
<span class="nc" id="L2258">        }</span>
    }



    /**
     * The &quot;Appearance&quot; tab.  Includes the controls for Chromaticity,
     * PrintQuality, JobPriority, JobName, and other related job attributes.
     */
    private class AppearancePanel extends JPanel {

        private ChromaticityPanel pnlChromaticity;
        private QualityPanel pnlQuality;
        private JobAttributesPanel pnlJobAttributes;
        private SidesPanel pnlSides;

<span class="nc" id="L2274">        public AppearancePanel() {</span>
<span class="nc" id="L2275">            super();</span>

<span class="nc" id="L2277">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L2278">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L2280">            setLayout(gridbag);</span>

<span class="nc" id="L2282">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L2283">            c.insets = panelInsets;</span>
<span class="nc" id="L2284">            c.weightx = 1.0;</span>
<span class="nc" id="L2285">            c.weighty = 1.0;</span>

<span class="nc" id="L2287">            c.gridwidth = GridBagConstraints.RELATIVE;</span>
<span class="nc" id="L2288">            pnlChromaticity = new ChromaticityPanel();</span>
<span class="nc" id="L2289">            addToGB(pnlChromaticity, this, gridbag, c);</span>

<span class="nc" id="L2291">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L2292">            pnlQuality = new QualityPanel();</span>
<span class="nc" id="L2293">            addToGB(pnlQuality, this, gridbag, c);</span>

<span class="nc" id="L2295">            c.gridwidth = 1;</span>
<span class="nc" id="L2296">            pnlSides = new SidesPanel();</span>
<span class="nc" id="L2297">            addToGB(pnlSides, this, gridbag, c);</span>

<span class="nc" id="L2299">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L2300">            pnlJobAttributes = new JobAttributesPanel();</span>
<span class="nc" id="L2301">            addToGB(pnlJobAttributes, this, gridbag, c);</span>

<span class="nc" id="L2303">        }</span>

        public void updateInfo() {
<span class="nc" id="L2306">            pnlChromaticity.updateInfo();</span>
<span class="nc" id="L2307">            pnlQuality.updateInfo();</span>
<span class="nc" id="L2308">            pnlSides.updateInfo();</span>
<span class="nc" id="L2309">            pnlJobAttributes.updateInfo();</span>
<span class="nc" id="L2310">        }</span>
    }

    private class ChromaticityPanel extends JPanel
        implements ActionListener
    {
<span class="nc" id="L2316">        private final String strTitle = getMsg(&quot;border.chromaticity&quot;);</span>
        private JRadioButton rbMonochrome, rbColor;

<span class="nc" id="L2319">        public ChromaticityPanel() {</span>
<span class="nc" id="L2320">            super();</span>

<span class="nc" id="L2322">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L2323">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L2325">            setLayout(gridbag);</span>
<span class="nc" id="L2326">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L2328">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L2329">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L2330">            c.weighty = 1.0;</span>

<span class="nc" id="L2332">            ButtonGroup bg = new ButtonGroup();</span>
<span class="nc" id="L2333">            rbMonochrome = createRadioButton(&quot;radiobutton.monochrome&quot;, this);</span>
<span class="nc" id="L2334">            rbMonochrome.setSelected(true);</span>
<span class="nc" id="L2335">            bg.add(rbMonochrome);</span>
<span class="nc" id="L2336">            addToGB(rbMonochrome, this, gridbag, c);</span>
<span class="nc" id="L2337">            rbColor = createRadioButton(&quot;radiobutton.color&quot;, this);</span>
<span class="nc" id="L2338">            bg.add(rbColor);</span>
<span class="nc" id="L2339">            addToGB(rbColor, this, gridbag, c);</span>
<span class="nc" id="L2340">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L2343">            Object source = e.getSource();</span>

            // REMIND: use isSameAs if we move to a IconRB in the future
<span class="nc bnc" id="L2346" title="All 2 branches missed.">            if (source == rbMonochrome) {</span>
<span class="nc" id="L2347">                asCurrent.add(Chromaticity.MONOCHROME);</span>
<span class="nc bnc" id="L2348" title="All 2 branches missed.">            } else if (source == rbColor) {</span>
<span class="nc" id="L2349">                asCurrent.add(Chromaticity.COLOR);</span>
            }
<span class="nc" id="L2351">        }</span>

        public void updateInfo() {
<span class="nc" id="L2354">            Class chCategory = Chromaticity.class;</span>
<span class="nc" id="L2355">            boolean monoSupported = false;</span>
<span class="nc" id="L2356">            boolean colorSupported = false;</span>

<span class="nc bnc" id="L2358" title="All 2 branches missed.">            if (isAWT) {</span>
<span class="nc" id="L2359">                monoSupported = true;</span>
<span class="nc" id="L2360">                colorSupported = true;</span>
            } else
<span class="nc bnc" id="L2362" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(chCategory)) {</span>
<span class="nc" id="L2363">                Object values =</span>
<span class="nc" id="L2364">                    psCurrent.getSupportedAttributeValues(chCategory,</span>
<span class="nc" id="L2365">                                                          docFlavor,</span>
<span class="nc" id="L2366">                                                          asCurrent);</span>

<span class="nc bnc" id="L2368" title="All 2 branches missed.">                if (values instanceof Chromaticity[]) {</span>
<span class="nc" id="L2369">                    Chromaticity[] cvalues = (Chromaticity[])values;</span>

<span class="nc bnc" id="L2371" title="All 2 branches missed.">                    for (int i = 0; i &lt; cvalues.length; i++) {</span>
<span class="nc" id="L2372">                        Chromaticity value = cvalues[i];</span>

<span class="nc bnc" id="L2374" title="All 2 branches missed.">                        if (value == Chromaticity.MONOCHROME) {</span>
<span class="nc" id="L2375">                            monoSupported = true;</span>
<span class="nc bnc" id="L2376" title="All 2 branches missed.">                        } else if (value == Chromaticity.COLOR) {</span>
<span class="nc" id="L2377">                            colorSupported = true;</span>
                        }
                    }
                }
            }


<span class="nc" id="L2384">            rbMonochrome.setEnabled(monoSupported);</span>
<span class="nc" id="L2385">            rbColor.setEnabled(colorSupported);</span>

<span class="nc" id="L2387">            Chromaticity ch = (Chromaticity)asCurrent.get(chCategory);</span>
<span class="nc bnc" id="L2388" title="All 2 branches missed.">            if (ch == null) {</span>
<span class="nc" id="L2389">                ch = (Chromaticity)psCurrent.getDefaultAttributeValue(chCategory);</span>
<span class="nc bnc" id="L2390" title="All 2 branches missed.">                if (ch == null) {</span>
<span class="nc" id="L2391">                    ch = Chromaticity.MONOCHROME;</span>
                }
            }

<span class="nc bnc" id="L2395" title="All 2 branches missed.">            if (ch == Chromaticity.MONOCHROME) {</span>
<span class="nc" id="L2396">                rbMonochrome.setSelected(true);</span>
            } else { // if (ch == Chromaticity.COLOR)
<span class="nc" id="L2398">                rbColor.setSelected(true);</span>
            }
<span class="nc" id="L2400">        }</span>
    }

    private class QualityPanel extends JPanel
        implements ActionListener
    {
<span class="nc" id="L2406">        private final String strTitle = getMsg(&quot;border.quality&quot;);</span>
        private JRadioButton rbDraft, rbNormal, rbHigh;

<span class="nc" id="L2409">        public QualityPanel() {</span>
<span class="nc" id="L2410">            super();</span>

<span class="nc" id="L2412">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L2413">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L2415">            setLayout(gridbag);</span>
<span class="nc" id="L2416">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L2418">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L2419">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L2420">            c.weighty = 1.0;</span>

<span class="nc" id="L2422">            ButtonGroup bg = new ButtonGroup();</span>
<span class="nc" id="L2423">            rbDraft = createRadioButton(&quot;radiobutton.draftq&quot;, this);</span>
<span class="nc" id="L2424">            bg.add(rbDraft);</span>
<span class="nc" id="L2425">            addToGB(rbDraft, this, gridbag, c);</span>
<span class="nc" id="L2426">            rbNormal = createRadioButton(&quot;radiobutton.normalq&quot;, this);</span>
<span class="nc" id="L2427">            rbNormal.setSelected(true);</span>
<span class="nc" id="L2428">            bg.add(rbNormal);</span>
<span class="nc" id="L2429">            addToGB(rbNormal, this, gridbag, c);</span>
<span class="nc" id="L2430">            rbHigh = createRadioButton(&quot;radiobutton.highq&quot;, this);</span>
<span class="nc" id="L2431">            bg.add(rbHigh);</span>
<span class="nc" id="L2432">            addToGB(rbHigh, this, gridbag, c);</span>
<span class="nc" id="L2433">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L2436">            Object source = e.getSource();</span>

<span class="nc bnc" id="L2438" title="All 2 branches missed.">            if (source == rbDraft) {</span>
<span class="nc" id="L2439">                asCurrent.add(PrintQuality.DRAFT);</span>
<span class="nc bnc" id="L2440" title="All 2 branches missed.">            } else if (source == rbNormal) {</span>
<span class="nc" id="L2441">                asCurrent.add(PrintQuality.NORMAL);</span>
<span class="nc bnc" id="L2442" title="All 2 branches missed.">            } else if (source == rbHigh) {</span>
<span class="nc" id="L2443">                asCurrent.add(PrintQuality.HIGH);</span>
            }
<span class="nc" id="L2445">        }</span>

        public void updateInfo() {
<span class="nc" id="L2448">            Class pqCategory = PrintQuality.class;</span>
<span class="nc" id="L2449">            boolean draftSupported = false;</span>
<span class="nc" id="L2450">            boolean normalSupported = false;</span>
<span class="nc" id="L2451">            boolean highSupported = false;</span>

<span class="nc bnc" id="L2453" title="All 2 branches missed.">            if (isAWT) {</span>
<span class="nc" id="L2454">                draftSupported = true;</span>
<span class="nc" id="L2455">                normalSupported = true;</span>
<span class="nc" id="L2456">                highSupported = true;</span>
            } else
<span class="nc bnc" id="L2458" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(pqCategory)) {</span>
<span class="nc" id="L2459">                Object values =</span>
<span class="nc" id="L2460">                    psCurrent.getSupportedAttributeValues(pqCategory,</span>
<span class="nc" id="L2461">                                                          docFlavor,</span>
<span class="nc" id="L2462">                                                          asCurrent);</span>

<span class="nc bnc" id="L2464" title="All 2 branches missed.">                if (values instanceof PrintQuality[]) {</span>
<span class="nc" id="L2465">                    PrintQuality[] qvalues = (PrintQuality[])values;</span>

<span class="nc bnc" id="L2467" title="All 2 branches missed.">                    for (int i = 0; i &lt; qvalues.length; i++) {</span>
<span class="nc" id="L2468">                        PrintQuality value = qvalues[i];</span>

<span class="nc bnc" id="L2470" title="All 2 branches missed.">                        if (value == PrintQuality.DRAFT) {</span>
<span class="nc" id="L2471">                            draftSupported = true;</span>
<span class="nc bnc" id="L2472" title="All 2 branches missed.">                        } else if (value == PrintQuality.NORMAL) {</span>
<span class="nc" id="L2473">                            normalSupported = true;</span>
<span class="nc bnc" id="L2474" title="All 2 branches missed.">                        } else if (value == PrintQuality.HIGH) {</span>
<span class="nc" id="L2475">                            highSupported = true;</span>
                        }
                    }
                }
            }

<span class="nc" id="L2481">            rbDraft.setEnabled(draftSupported);</span>
<span class="nc" id="L2482">            rbNormal.setEnabled(normalSupported);</span>
<span class="nc" id="L2483">            rbHigh.setEnabled(highSupported);</span>

<span class="nc" id="L2485">            PrintQuality pq = (PrintQuality)asCurrent.get(pqCategory);</span>
<span class="nc bnc" id="L2486" title="All 2 branches missed.">            if (pq == null) {</span>
<span class="nc" id="L2487">                pq = (PrintQuality)psCurrent.getDefaultAttributeValue(pqCategory);</span>
<span class="nc bnc" id="L2488" title="All 2 branches missed.">                if (pq == null) {</span>
<span class="nc" id="L2489">                    pq = PrintQuality.NORMAL;</span>
                }
            }

<span class="nc bnc" id="L2493" title="All 2 branches missed.">            if (pq == PrintQuality.DRAFT) {</span>
<span class="nc" id="L2494">                rbDraft.setSelected(true);</span>
<span class="nc bnc" id="L2495" title="All 2 branches missed.">            } else if (pq == PrintQuality.NORMAL) {</span>
<span class="nc" id="L2496">                rbNormal.setSelected(true);</span>
            } else { // if (pq == PrintQuality.HIGH)
<span class="nc" id="L2498">                rbHigh.setSelected(true);</span>
            }
<span class="nc" id="L2500">        }</span>


    }
    private class SidesPanel extends JPanel
        implements ActionListener
    {
<span class="nc" id="L2507">        private final String strTitle = getMsg(&quot;border.sides&quot;);</span>
        private IconRadioButton rbOneSide, rbTumble, rbDuplex;

<span class="nc" id="L2510">        public SidesPanel() {</span>
<span class="nc" id="L2511">            super();</span>

<span class="nc" id="L2513">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L2514">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L2516">            setLayout(gridbag);</span>
<span class="nc" id="L2517">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L2519">            c.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L2520">            c.insets = compInsets;</span>
<span class="nc" id="L2521">            c.weighty = 1.0;</span>
<span class="nc" id="L2522">            c.gridwidth = GridBagConstraints.REMAINDER;</span>

<span class="nc" id="L2524">            ButtonGroup bg = new ButtonGroup();</span>
<span class="nc" id="L2525">            rbOneSide = new IconRadioButton(&quot;radiobutton.oneside&quot;,</span>
                                            &quot;oneside.png&quot;, true,
                                            bg, this);
<span class="nc" id="L2528">            rbOneSide.addActionListener(this);</span>
<span class="nc" id="L2529">            addToGB(rbOneSide, this, gridbag, c);</span>
<span class="nc" id="L2530">            rbTumble = new IconRadioButton(&quot;radiobutton.tumble&quot;,</span>
                                           &quot;tumble.png&quot;, false,
                                           bg, this);
<span class="nc" id="L2533">            rbTumble.addActionListener(this);</span>
<span class="nc" id="L2534">            addToGB(rbTumble, this, gridbag, c);</span>
<span class="nc" id="L2535">            rbDuplex = new IconRadioButton(&quot;radiobutton.duplex&quot;,</span>
                                           &quot;duplex.png&quot;, false,
                                           bg, this);
<span class="nc" id="L2538">            rbDuplex.addActionListener(this);</span>
<span class="nc" id="L2539">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L2540">            addToGB(rbDuplex, this, gridbag, c);</span>
<span class="nc" id="L2541">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L2544">            Object source = e.getSource();</span>

<span class="nc bnc" id="L2546" title="All 2 branches missed.">            if (rbOneSide.isSameAs(source)) {</span>
<span class="nc" id="L2547">                asCurrent.add(Sides.ONE_SIDED);</span>
<span class="nc bnc" id="L2548" title="All 2 branches missed.">            } else if (rbTumble.isSameAs(source)) {</span>
<span class="nc" id="L2549">                asCurrent.add(Sides.TUMBLE);</span>
<span class="nc bnc" id="L2550" title="All 2 branches missed.">            } else if (rbDuplex.isSameAs(source)) {</span>
<span class="nc" id="L2551">                asCurrent.add(Sides.DUPLEX);</span>
            }
<span class="nc" id="L2553">        }</span>

        public void updateInfo() {
<span class="nc" id="L2556">            Class sdCategory = Sides.class;</span>
<span class="nc" id="L2557">            boolean osSupported = false;</span>
<span class="nc" id="L2558">            boolean tSupported = false;</span>
<span class="nc" id="L2559">            boolean dSupported = false;</span>

<span class="nc bnc" id="L2561" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(sdCategory)) {</span>
<span class="nc" id="L2562">                Object values =</span>
<span class="nc" id="L2563">                    psCurrent.getSupportedAttributeValues(sdCategory,</span>
<span class="nc" id="L2564">                                                          docFlavor,</span>
<span class="nc" id="L2565">                                                          asCurrent);</span>

<span class="nc bnc" id="L2567" title="All 2 branches missed.">                if (values instanceof Sides[]) {</span>
<span class="nc" id="L2568">                    Sides[] svalues = (Sides[])values;</span>

<span class="nc bnc" id="L2570" title="All 2 branches missed.">                    for (int i = 0; i &lt; svalues.length; i++) {</span>
<span class="nc" id="L2571">                        Sides value = svalues[i];</span>

<span class="nc bnc" id="L2573" title="All 2 branches missed.">                        if (value == Sides.ONE_SIDED) {</span>
<span class="nc" id="L2574">                            osSupported = true;</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">                        } else if (value == Sides.TUMBLE) {</span>
<span class="nc" id="L2576">                            tSupported = true;</span>
<span class="nc bnc" id="L2577" title="All 2 branches missed.">                        } else if (value == Sides.DUPLEX) {</span>
<span class="nc" id="L2578">                            dSupported = true;</span>
                        }
                    }
                }
            }
<span class="nc" id="L2583">            rbOneSide.setEnabled(osSupported);</span>
<span class="nc" id="L2584">            rbTumble.setEnabled(tSupported);</span>
<span class="nc" id="L2585">            rbDuplex.setEnabled(dSupported);</span>

<span class="nc" id="L2587">            Sides sd = (Sides)asCurrent.get(sdCategory);</span>
<span class="nc bnc" id="L2588" title="All 2 branches missed.">            if (sd == null) {</span>
<span class="nc" id="L2589">                sd = (Sides)psCurrent.getDefaultAttributeValue(sdCategory);</span>
<span class="nc bnc" id="L2590" title="All 2 branches missed.">                if (sd == null) {</span>
<span class="nc" id="L2591">                    sd = Sides.ONE_SIDED;</span>
                }
            }

<span class="nc bnc" id="L2595" title="All 2 branches missed.">            if (sd == Sides.ONE_SIDED) {</span>
<span class="nc" id="L2596">                rbOneSide.setSelected(true);</span>
<span class="nc bnc" id="L2597" title="All 2 branches missed.">            } else if (sd == Sides.TUMBLE) {</span>
<span class="nc" id="L2598">                rbTumble.setSelected(true);</span>
            } else { // if (sd == Sides.DUPLEX)
<span class="nc" id="L2600">                rbDuplex.setSelected(true);</span>
            }
<span class="nc" id="L2602">        }</span>
    }



    private class JobAttributesPanel extends JPanel
        implements ActionListener, ChangeListener, FocusListener
    {
<span class="nc" id="L2610">        private final String strTitle = getMsg(&quot;border.jobattributes&quot;);</span>
        private JLabel lblPriority, lblJobName, lblUserName;
        private JSpinner spinPriority;
        private SpinnerNumberModel snModel;
        private JCheckBox cbJobSheets;
        private JTextField tfJobName, tfUserName;

<span class="nc" id="L2617">        public JobAttributesPanel() {</span>
<span class="nc" id="L2618">            super();</span>

<span class="nc" id="L2620">            GridBagLayout gridbag = new GridBagLayout();</span>
<span class="nc" id="L2621">            GridBagConstraints c = new GridBagConstraints();</span>

<span class="nc" id="L2623">            setLayout(gridbag);</span>
<span class="nc" id="L2624">            setBorder(BorderFactory.createTitledBorder(strTitle));</span>

<span class="nc" id="L2626">            c.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L2627">            c.insets = compInsets;</span>
<span class="nc" id="L2628">            c.weighty = 1.0;</span>

<span class="nc" id="L2630">            cbJobSheets = createCheckBox(&quot;checkbox.jobsheets&quot;, this);</span>
<span class="nc" id="L2631">            c.anchor = GridBagConstraints.LINE_START;</span>
<span class="nc" id="L2632">            addToGB(cbJobSheets, this, gridbag, c);</span>

<span class="nc" id="L2634">            JPanel pnlTop = new JPanel();</span>
<span class="nc" id="L2635">            lblPriority = new JLabel(getMsg(&quot;label.priority&quot;), JLabel.TRAILING);</span>
<span class="nc" id="L2636">            lblPriority.setDisplayedMnemonic(getMnemonic(&quot;label.priority&quot;));</span>

<span class="nc" id="L2638">            pnlTop.add(lblPriority);</span>
<span class="nc" id="L2639">            snModel = new SpinnerNumberModel(1, 1, 100, 1);</span>
<span class="nc" id="L2640">            spinPriority = new JSpinner(snModel);</span>
<span class="nc" id="L2641">            lblPriority.setLabelFor(spinPriority);</span>
            // REMIND
<span class="nc" id="L2643">            ((JSpinner.NumberEditor)spinPriority.getEditor()).getTextField().setColumns(3);</span>
<span class="nc" id="L2644">            spinPriority.addChangeListener(this);</span>
<span class="nc" id="L2645">            pnlTop.add(spinPriority);</span>
<span class="nc" id="L2646">            c.anchor = GridBagConstraints.LINE_END;</span>
<span class="nc" id="L2647">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L2648">            pnlTop.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L2649">                                       getMsg(&quot;label.priority&quot;));</span>
<span class="nc" id="L2650">            addToGB(pnlTop, this, gridbag, c);</span>

<span class="nc" id="L2652">            c.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L2653">            c.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L2654">            c.weightx = 0.0;</span>
<span class="nc" id="L2655">            c.gridwidth = 1;</span>
<span class="nc" id="L2656">            char jmnemonic = getMnemonic(&quot;label.jobname&quot;);</span>
<span class="nc" id="L2657">            lblJobName = new JLabel(getMsg(&quot;label.jobname&quot;), JLabel.TRAILING);</span>
<span class="nc" id="L2658">            lblJobName.setDisplayedMnemonic(jmnemonic);</span>
<span class="nc" id="L2659">            addToGB(lblJobName, this, gridbag, c);</span>
<span class="nc" id="L2660">            c.weightx = 1.0;</span>
<span class="nc" id="L2661">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L2662">            tfJobName = new JTextField();</span>
<span class="nc" id="L2663">            lblJobName.setLabelFor(tfJobName);</span>
<span class="nc" id="L2664">            tfJobName.addFocusListener(this);</span>
<span class="nc" id="L2665">            tfJobName.setFocusAccelerator(jmnemonic);</span>
<span class="nc" id="L2666">            tfJobName.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L2667">                                             getMsg(&quot;label.jobname&quot;));</span>
<span class="nc" id="L2668">            addToGB(tfJobName, this, gridbag, c);</span>

<span class="nc" id="L2670">            c.weightx = 0.0;</span>
<span class="nc" id="L2671">            c.gridwidth = 1;</span>
<span class="nc" id="L2672">            char umnemonic = getMnemonic(&quot;label.username&quot;);</span>
<span class="nc" id="L2673">            lblUserName = new JLabel(getMsg(&quot;label.username&quot;), JLabel.TRAILING);</span>
<span class="nc" id="L2674">            lblUserName.setDisplayedMnemonic(umnemonic);</span>
<span class="nc" id="L2675">            addToGB(lblUserName, this, gridbag, c);</span>
<span class="nc" id="L2676">            c.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L2677">            tfUserName = new JTextField();</span>
<span class="nc" id="L2678">            lblUserName.setLabelFor(tfUserName);</span>
<span class="nc" id="L2679">            tfUserName.addFocusListener(this);</span>
<span class="nc" id="L2680">            tfUserName.setFocusAccelerator(umnemonic);</span>
<span class="nc" id="L2681">            tfUserName.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L2682">                                             getMsg(&quot;label.username&quot;));</span>
<span class="nc" id="L2683">            addToGB(tfUserName, this, gridbag, c);</span>
<span class="nc" id="L2684">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L2687" title="All 2 branches missed.">            if (cbJobSheets.isSelected()) {</span>
<span class="nc" id="L2688">                asCurrent.add(JobSheets.STANDARD);</span>
            } else {
<span class="nc" id="L2690">                asCurrent.add(JobSheets.NONE);</span>
            }
<span class="nc" id="L2692">        }</span>

        public void stateChanged(ChangeEvent e) {
<span class="nc" id="L2695">            asCurrent.add(new JobPriority(snModel.getNumber().intValue()));</span>
<span class="nc" id="L2696">        }</span>

        public void focusLost(FocusEvent e) {
<span class="nc" id="L2699">            Object source = e.getSource();</span>

<span class="nc bnc" id="L2701" title="All 2 branches missed.">            if (source == tfJobName) {</span>
<span class="nc" id="L2702">                asCurrent.add(new JobName(tfJobName.getText(),</span>
<span class="nc" id="L2703">                                          Locale.getDefault()));</span>
<span class="nc bnc" id="L2704" title="All 2 branches missed.">            } else if (source == tfUserName) {</span>
<span class="nc" id="L2705">                asCurrent.add(new RequestingUserName(tfUserName.getText(),</span>
<span class="nc" id="L2706">                                                     Locale.getDefault()));</span>
            }
<span class="nc" id="L2708">        }</span>

<span class="nc" id="L2710">        public void focusGained(FocusEvent e) {}</span>

        public void updateInfo() {
<span class="nc" id="L2713">            Class jsCategory = JobSheets.class;</span>
<span class="nc" id="L2714">            Class jpCategory = JobPriority.class;</span>
<span class="nc" id="L2715">            Class jnCategory = JobName.class;</span>
<span class="nc" id="L2716">            Class unCategory = RequestingUserName.class;</span>
<span class="nc" id="L2717">            boolean jsSupported = false;</span>
<span class="nc" id="L2718">            boolean jpSupported = false;</span>
<span class="nc" id="L2719">            boolean jnSupported = false;</span>
<span class="nc" id="L2720">            boolean unSupported = false;</span>

            // setup JobSheets checkbox
<span class="nc bnc" id="L2723" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(jsCategory)) {</span>
<span class="nc" id="L2724">                jsSupported = true;</span>
            }
<span class="nc" id="L2726">            JobSheets js = (JobSheets)asCurrent.get(jsCategory);</span>
<span class="nc bnc" id="L2727" title="All 2 branches missed.">            if (js == null) {</span>
<span class="nc" id="L2728">                js = (JobSheets)psCurrent.getDefaultAttributeValue(jsCategory);</span>
<span class="nc bnc" id="L2729" title="All 2 branches missed.">                if (js == null) {</span>
<span class="nc" id="L2730">                    js = JobSheets.NONE;</span>
                }
            }
<span class="nc bnc" id="L2733" title="All 2 branches missed.">            cbJobSheets.setSelected(js != JobSheets.NONE);</span>
<span class="nc" id="L2734">            cbJobSheets.setEnabled(jsSupported);</span>

            // setup JobPriority spinner
<span class="nc bnc" id="L2737" title="All 4 branches missed.">            if (!isAWT &amp;&amp; psCurrent.isAttributeCategorySupported(jpCategory)) {</span>
<span class="nc" id="L2738">                jpSupported = true;</span>
            }
<span class="nc" id="L2740">            JobPriority jp = (JobPriority)asCurrent.get(jpCategory);</span>
<span class="nc bnc" id="L2741" title="All 2 branches missed.">            if (jp == null) {</span>
<span class="nc" id="L2742">                jp = (JobPriority)psCurrent.getDefaultAttributeValue(jpCategory);</span>
<span class="nc bnc" id="L2743" title="All 2 branches missed.">                if (jp == null) {</span>
<span class="nc" id="L2744">                    jp = new JobPriority(1);</span>
                }
            }
<span class="nc" id="L2747">            int value = jp.getValue();</span>
<span class="nc bnc" id="L2748" title="All 4 branches missed.">            if ((value &lt; 1) || (value &gt; 100)) {</span>
<span class="nc" id="L2749">                value = 1;</span>
            }
<span class="nc" id="L2751">            snModel.setValue(new Integer(value));</span>
<span class="nc" id="L2752">            lblPriority.setEnabled(jpSupported);</span>
<span class="nc" id="L2753">            spinPriority.setEnabled(jpSupported);</span>

            // setup JobName text field
<span class="nc bnc" id="L2756" title="All 2 branches missed.">            if (psCurrent.isAttributeCategorySupported(jnCategory)) {</span>
<span class="nc" id="L2757">                jnSupported = true;</span>
            }
<span class="nc" id="L2759">            JobName jn = (JobName)asCurrent.get(jnCategory);</span>
<span class="nc bnc" id="L2760" title="All 2 branches missed.">            if (jn == null) {</span>
<span class="nc" id="L2761">                jn = (JobName)psCurrent.getDefaultAttributeValue(jnCategory);</span>
<span class="nc bnc" id="L2762" title="All 2 branches missed.">                if (jn == null) {</span>
<span class="nc" id="L2763">                    jn = new JobName(&quot;&quot;, Locale.getDefault());</span>
                }
            }
<span class="nc" id="L2766">            tfJobName.setText(jn.getValue());</span>
<span class="nc" id="L2767">            tfJobName.setEnabled(jnSupported);</span>
<span class="nc" id="L2768">            lblJobName.setEnabled(jnSupported);</span>

            // setup RequestingUserName text field
<span class="nc bnc" id="L2771" title="All 4 branches missed.">            if (!isAWT &amp;&amp; psCurrent.isAttributeCategorySupported(unCategory)) {</span>
<span class="nc" id="L2772">                unSupported = true;</span>
            }
<span class="nc" id="L2774">            RequestingUserName un = (RequestingUserName)asCurrent.get(unCategory);</span>
<span class="nc bnc" id="L2775" title="All 2 branches missed.">            if (un == null) {</span>
<span class="nc" id="L2776">                un = (RequestingUserName)psCurrent.getDefaultAttributeValue(unCategory);</span>
<span class="nc bnc" id="L2777" title="All 2 branches missed.">                if (un == null) {</span>
<span class="nc" id="L2778">                    un = new RequestingUserName(&quot;&quot;, Locale.getDefault());</span>
                }
            }
<span class="nc" id="L2781">            tfUserName.setText(un.getValue());</span>
<span class="nc" id="L2782">            tfUserName.setEnabled(unSupported);</span>
<span class="nc" id="L2783">            lblUserName.setEnabled(unSupported);</span>
<span class="nc" id="L2784">        }</span>
    }




    /**
     * A special widget that groups a JRadioButton with an associated icon,
     * placed to the left of the radio button.
     */
    private class IconRadioButton extends JPanel {

        private JRadioButton rb;
        private JLabel lbl;

        public IconRadioButton(String key, String img, boolean selected,
                               ButtonGroup bg, ActionListener al)
<span class="nc" id="L2801">        {</span>
<span class="nc" id="L2802">            super(new FlowLayout(FlowLayout.LEADING));</span>
<span class="nc" id="L2803">            final URL imgURL = getImageResource(img);</span>
<span class="nc" id="L2804">            Icon icon = (Icon)java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L2805">                                 new java.security.PrivilegedAction() {</span>
                public Object run() {
<span class="nc" id="L2807">                    Icon icon = new ImageIcon(imgURL);</span>
<span class="nc" id="L2808">                    return icon;</span>
                }
            });
<span class="nc" id="L2811">            lbl = new JLabel(icon);</span>
<span class="nc" id="L2812">            add(lbl);</span>

<span class="nc" id="L2814">            rb = createRadioButton(key, al);</span>
<span class="nc" id="L2815">            rb.setSelected(selected);</span>
<span class="nc" id="L2816">            addToBG(rb, this, bg);</span>
<span class="nc" id="L2817">        }</span>

        public void addActionListener(ActionListener al) {
<span class="nc" id="L2820">            rb.addActionListener(al);</span>
<span class="nc" id="L2821">        }</span>

        public boolean isSameAs(Object source) {
<span class="nc bnc" id="L2824" title="All 2 branches missed.">            return (rb == source);</span>
        }

        public void setEnabled(boolean enabled) {
<span class="nc" id="L2828">            rb.setEnabled(enabled);</span>
<span class="nc" id="L2829">            lbl.setEnabled(enabled);</span>
<span class="nc" id="L2830">        }</span>

        public boolean isSelected() {
<span class="nc" id="L2833">            return rb.isSelected();</span>
        }

        public void setSelected(boolean selected) {
<span class="nc" id="L2837">            rb.setSelected(selected);</span>
<span class="nc" id="L2838">        }</span>
    }

    /**
     * Similar in functionality to the default JFileChooser, except this
     * chooser will pop up a &quot;Do you want to overwrite...&quot; dialog if the
     * user selects a file that already exists.
     */
<span class="nc" id="L2846">    private class ValidatingFileChooser extends JFileChooser {</span>
        public void approveSelection() {
<span class="nc" id="L2848">            File selected = getSelectedFile();</span>
            boolean exists;

            try {
<span class="nc" id="L2852">                exists = selected.exists();</span>
<span class="nc" id="L2853">            } catch (SecurityException e) {</span>
<span class="nc" id="L2854">                exists = false;</span>
<span class="nc" id="L2855">            }</span>

<span class="nc bnc" id="L2857" title="All 2 branches missed.">            if (exists) {</span>
                int val;
<span class="nc" id="L2859">                val = JOptionPane.showConfirmDialog(this,</span>
<span class="nc" id="L2860">                                                    getMsg(&quot;dialog.overwrite&quot;),</span>
<span class="nc" id="L2861">                                                    getMsg(&quot;dialog.owtitle&quot;),</span>
                                                    JOptionPane.YES_NO_OPTION);
<span class="nc bnc" id="L2863" title="All 2 branches missed.">                if (val != JOptionPane.YES_OPTION) {</span>
<span class="nc" id="L2864">                    return;</span>
                }
            }

            try {
<span class="nc bnc" id="L2869" title="All 2 branches missed.">                if (selected.createNewFile()) {</span>
<span class="nc" id="L2870">                    selected.delete();</span>
                }
<span class="nc" id="L2872">            }  catch (IOException ioe) {</span>
<span class="nc" id="L2873">                JOptionPane.showMessageDialog(this,</span>
<span class="nc" id="L2874">                                   getMsg(&quot;dialog.writeerror&quot;)+&quot; &quot;+selected,</span>
<span class="nc" id="L2875">                                   getMsg(&quot;dialog.owtitle&quot;),</span>
                                   JOptionPane.WARNING_MESSAGE);
<span class="nc" id="L2877">                return;</span>
<span class="nc" id="L2878">            } catch (SecurityException se) {</span>
                //There is already file read/write access so at this point
                // only delete access is denied.  Just ignore it because in
                // most cases the file created in createNewFile gets
                // overwritten anyway.
<span class="nc" id="L2883">            }</span>
<span class="nc" id="L2884">            File pFile = selected.getParentFile();</span>
<span class="nc bnc" id="L2885" title="All 2 branches missed.">            if ((selected.exists() &amp;&amp;</span>
<span class="nc bnc" id="L2886" title="All 6 branches missed.">                      (!selected.isFile() || !selected.canWrite())) ||</span>
                     ((pFile != null) &amp;&amp;
<span class="nc bnc" id="L2888" title="All 6 branches missed.">                      (!pFile.exists() || (pFile.exists() &amp;&amp; !pFile.canWrite())))) {</span>
<span class="nc" id="L2889">                JOptionPane.showMessageDialog(this,</span>
<span class="nc" id="L2890">                                   getMsg(&quot;dialog.writeerror&quot;)+&quot; &quot;+selected,</span>
<span class="nc" id="L2891">                                   getMsg(&quot;dialog.owtitle&quot;),</span>
                                   JOptionPane.WARNING_MESSAGE);
<span class="nc" id="L2893">                return;</span>
            }

<span class="nc" id="L2896">            super.approveSelection();</span>
<span class="nc" id="L2897">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>