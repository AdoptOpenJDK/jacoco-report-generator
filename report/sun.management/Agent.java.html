<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>Agent.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.management</a> &gt; <span class="el_source">Agent.java</span></div><h1>Agent.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package sun.management;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.lang.management.ManagementFactory;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.net.InetAddress;
import java.net.Socket;
import java.net.UnknownHostException;
import java.text.MessageFormat;
import java.util.MissingResourceException;
import java.util.Properties;
import java.util.ResourceBundle;

import javax.management.remote.JMXConnectorServer;
import javax.management.remote.JMXServiceURL;

import static sun.management.AgentConfigurationError.*;
import sun.management.jmxremote.ConnectorBootstrap;
import sun.management.jdp.JdpController;
import sun.management.jdp.JdpException;
import sun.misc.VMSupport;

/**
 * This Agent is started by the VM when -Dcom.sun.management.snmp or
 * -Dcom.sun.management.jmxremote is set. This class will be loaded by the
 * system class loader. Also jmx framework could be started by jcmd
 */
<span class="nc" id="L58">public class Agent {</span>
    // management properties

    private static Properties mgmtProps;
    private static ResourceBundle messageRB;
    private static final String CONFIG_FILE =
            &quot;com.sun.management.config.file&quot;;
    private static final String SNMP_PORT =
            &quot;com.sun.management.snmp.port&quot;;
    private static final String JMXREMOTE =
            &quot;com.sun.management.jmxremote&quot;;
    private static final String JMXREMOTE_PORT =
            &quot;com.sun.management.jmxremote.port&quot;;
    private static final String RMI_PORT =
            &quot;com.sun.management.jmxremote.rmi.port&quot;;
    private static final String ENABLE_THREAD_CONTENTION_MONITORING =
            &quot;com.sun.management.enableThreadContentionMonitoring&quot;;
    private static final String LOCAL_CONNECTOR_ADDRESS_PROP =
            &quot;com.sun.management.jmxremote.localConnectorAddress&quot;;
    private static final String SNMP_ADAPTOR_BOOTSTRAP_CLASS_NAME =
            &quot;sun.management.snmp.AdaptorBootstrap&quot;;

    private static final String JDP_DEFAULT_ADDRESS = &quot;224.0.23.178&quot;;
    private static final int JDP_DEFAULT_PORT = 7095;

    // The only active agent allowed
<span class="nc" id="L84">    private static JMXConnectorServer jmxServer = null;</span>

    // Parse string com.sun.management.prop=xxx,com.sun.management.prop=yyyy
    // and return property set if args is null or empty
    // return empty property set
    private static Properties parseString(String args) {
<span class="nc" id="L90">        Properties argProps = new Properties();</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (args != null) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            for (String option : args.split(&quot;,&quot;)) {</span>
<span class="nc" id="L93">                String s[] = option.split(&quot;=&quot;, 2);</span>
<span class="nc" id="L94">                String name = s[0].trim();</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                String value = (s.length &gt; 1) ? s[1].trim() : &quot;&quot;;</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">                if (!name.startsWith(&quot;com.sun.management.&quot;)) {</span>
<span class="nc" id="L98">                    error(INVALID_OPTION, name);</span>
                }

<span class="nc" id="L101">                argProps.setProperty(name, value);</span>
            }
        }

<span class="nc" id="L105">        return argProps;</span>
    }

    // invoked by -javaagent or -Dcom.sun.management.agent.class
    public static void premain(String args) throws Exception {
<span class="nc" id="L110">        agentmain(args);</span>
<span class="nc" id="L111">    }</span>

    // invoked by attach mechanism
    public static void agentmain(String args) throws Exception {
<span class="nc bnc" id="L115" title="All 4 branches missed.">        if (args == null || args.length() == 0) {</span>
<span class="nc" id="L116">            args = JMXREMOTE;           // default to local management</span>
        }

<span class="nc" id="L119">        Properties arg_props = parseString(args);</span>

        // Read properties from the config file
<span class="nc" id="L122">        Properties config_props = new Properties();</span>
<span class="nc" id="L123">        String fname = arg_props.getProperty(CONFIG_FILE);</span>
<span class="nc" id="L124">        readConfiguration(fname, config_props);</span>

        // Arguments override config file
<span class="nc" id="L127">        config_props.putAll(arg_props);</span>
<span class="nc" id="L128">        startAgent(config_props);</span>
<span class="nc" id="L129">    }</span>

    // jcmd ManagementAgent.start_local entry point
    // Also called due to command-line via startAgent()
    private static synchronized void startLocalManagementAgent() {
<span class="nc" id="L134">        Properties agentProps = VMSupport.getAgentProperties();</span>

        // start local connector if not started
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (agentProps.get(LOCAL_CONNECTOR_ADDRESS_PROP) == null) {</span>
<span class="nc" id="L138">            JMXConnectorServer cs = ConnectorBootstrap.startLocalConnectorServer();</span>
<span class="nc" id="L139">            String address = cs.getAddress().toString();</span>
            // Add the local connector address to the agent properties
<span class="nc" id="L141">            agentProps.put(LOCAL_CONNECTOR_ADDRESS_PROP, address);</span>

            try {
                // export the address to the instrumentation buffer
<span class="nc" id="L145">                ConnectorAddressLink.export(address);</span>
<span class="nc" id="L146">            } catch (Exception x) {</span>
                // Connector server started but unable to export address
                // to instrumentation buffer - non-fatal error.
<span class="nc" id="L149">                warning(EXPORT_ADDRESS_FAILED, x.getMessage());</span>
<span class="nc" id="L150">            }</span>
        }
<span class="nc" id="L152">    }</span>

    // jcmd ManagementAgent.start entry point
    // This method starts the remote JMX agent and starts neither
    // the local JMX agent nor the SNMP agent
    // @see #startLocalManagementAgent and also @see #startAgent.
    private static synchronized void startRemoteManagementAgent(String args) throws Exception {
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (jmxServer != null) {</span>
<span class="nc" id="L160">            throw new RuntimeException(getText(INVALID_STATE, &quot;Agent already started&quot;));</span>
        }

<span class="nc" id="L163">        Properties argProps = parseString(args);</span>
<span class="nc" id="L164">        Properties configProps = new Properties();</span>

        // Load the management properties from the config file
        // if config file is not specified readConfiguration implicitly
        // reads &lt;java.home&gt;/lib/management/management.properties

<span class="nc" id="L170">        String fname = System.getProperty(CONFIG_FILE);</span>
<span class="nc" id="L171">        readConfiguration(fname, configProps);</span>

        // management properties can be overridden by system properties
        // which take precedence
<span class="nc" id="L175">        Properties sysProps = System.getProperties();</span>
<span class="nc" id="L176">        synchronized (sysProps) {</span>
<span class="nc" id="L177">            configProps.putAll(sysProps);</span>
<span class="nc" id="L178">        }</span>

        // if user specifies config file into command line for either
        // jcmd utilities or attach command it overrides properties set in
        // command line at the time of VM start
<span class="nc" id="L183">        String fnameUser = argProps.getProperty(CONFIG_FILE);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (fnameUser != null) {</span>
<span class="nc" id="L185">            readConfiguration(fnameUser, configProps);</span>
        }

        // arguments specified in command line of jcmd utilities
        // override both system properties and one set by config file
        // specified in jcmd command line
<span class="nc" id="L191">        configProps.putAll(argProps);</span>

        // jcmd doesn't allow to change ThreadContentionMonitoring, but user
        // can specify this property inside config file, so enable optional
        // monitoring functionality if this property is set
<span class="nc" id="L196">        final String enableThreadContentionMonitoring =</span>
<span class="nc" id="L197">                configProps.getProperty(ENABLE_THREAD_CONTENTION_MONITORING);</span>

<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (enableThreadContentionMonitoring != null) {</span>
<span class="nc" id="L200">            ManagementFactory.getThreadMXBean().</span>
<span class="nc" id="L201">                    setThreadContentionMonitoringEnabled(true);</span>
        }

<span class="nc" id="L204">        String jmxremotePort = configProps.getProperty(JMXREMOTE_PORT);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (jmxremotePort != null) {</span>
<span class="nc" id="L206">            jmxServer = ConnectorBootstrap.</span>
<span class="nc" id="L207">                    startRemoteConnectorServer(jmxremotePort, configProps);</span>

<span class="nc" id="L209">            startDiscoveryService(configProps);</span>
        }
<span class="nc" id="L211">    }</span>

    private static synchronized void stopRemoteManagementAgent() throws Exception {

<span class="nc" id="L215">        JdpController.stopDiscoveryService();</span>

<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (jmxServer != null) {</span>
<span class="nc" id="L218">            ConnectorBootstrap.unexportRegistry();</span>

            // Attempt to stop already stopped agent
            // Don't cause any errors.
<span class="nc" id="L222">            jmxServer.stop();</span>
<span class="nc" id="L223">            jmxServer = null;</span>
        }
<span class="nc" id="L225">    }</span>

    private static void startAgent(Properties props) throws Exception {
<span class="nc" id="L228">        String snmpPort = props.getProperty(SNMP_PORT);</span>
<span class="nc" id="L229">        String jmxremote = props.getProperty(JMXREMOTE);</span>
<span class="nc" id="L230">        String jmxremotePort = props.getProperty(JMXREMOTE_PORT);</span>

        // Enable optional monitoring functionality if requested
<span class="nc" id="L233">        final String enableThreadContentionMonitoring =</span>
<span class="nc" id="L234">                props.getProperty(ENABLE_THREAD_CONTENTION_MONITORING);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (enableThreadContentionMonitoring != null) {</span>
<span class="nc" id="L236">            ManagementFactory.getThreadMXBean().</span>
<span class="nc" id="L237">                    setThreadContentionMonitoringEnabled(true);</span>
        }

        try {
<span class="nc bnc" id="L241" title="All 2 branches missed.">            if (snmpPort != null) {</span>
<span class="nc" id="L242">                loadSnmpAgent(snmpPort, props);</span>
            }

            /*
             * If the jmxremote.port property is set then we start the
             * RMIConnectorServer for remote M&amp;M.
             *
             * If the jmxremote or jmxremote.port properties are set then
             * we start a RMIConnectorServer for local M&amp;M. The address
             * of this &quot;local&quot; server is exported as a counter to the jstat
             * instrumentation buffer.
             */
<span class="nc bnc" id="L254" title="All 4 branches missed.">            if (jmxremote != null || jmxremotePort != null) {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                if (jmxremotePort != null) {</span>
<span class="nc" id="L256">                    jmxServer = ConnectorBootstrap.</span>
<span class="nc" id="L257">                            startRemoteConnectorServer(jmxremotePort, props);</span>
<span class="nc" id="L258">                    startDiscoveryService(props);</span>
                }
<span class="nc" id="L260">                startLocalManagementAgent();</span>
            }

<span class="nc" id="L263">        } catch (AgentConfigurationError e) {</span>
<span class="nc" id="L264">            error(e.getError(), e.getParams());</span>
<span class="nc" id="L265">        } catch (Exception e) {</span>
<span class="nc" id="L266">            error(e);</span>
<span class="nc" id="L267">        }</span>
<span class="nc" id="L268">    }</span>

    private static void startDiscoveryService(Properties props)
            throws IOException {
        // Start discovery service if requested
<span class="nc" id="L273">        String discoveryPort = props.getProperty(&quot;com.sun.management.jdp.port&quot;);</span>
<span class="nc" id="L274">        String discoveryAddress = props.getProperty(&quot;com.sun.management.jdp.address&quot;);</span>
<span class="nc" id="L275">        String discoveryShouldStart = props.getProperty(&quot;com.sun.management.jmxremote.autodiscovery&quot;);</span>

        // Decide whether we should start autodicovery service.
        // To start autodiscovery following conditions should be met:
        // autodiscovery==true OR (autodicovery==null AND jdp.port != NULL)

<span class="nc" id="L281">        boolean shouldStart = false;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (discoveryShouldStart == null){</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            shouldStart = (discoveryPort != null);</span>
        }
        else{
            try{
<span class="nc" id="L287">               shouldStart = Boolean.parseBoolean(discoveryShouldStart);</span>
<span class="nc" id="L288">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L289">                throw new AgentConfigurationError(&quot;Couldn't parse autodiscovery argument&quot;);</span>
<span class="nc" id="L290">            }</span>
        }

<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (shouldStart) {</span>
            // port and address are required arguments and have no default values
            InetAddress address;
            try {
<span class="nc bnc" id="L297" title="All 2 branches missed.">                address = (discoveryAddress == null) ?</span>
<span class="nc" id="L298">                        InetAddress.getByName(JDP_DEFAULT_ADDRESS) : InetAddress.getByName(discoveryAddress);</span>
<span class="nc" id="L299">            } catch (UnknownHostException e) {</span>
<span class="nc" id="L300">                throw new AgentConfigurationError(&quot;Unable to broadcast to requested address&quot;, e);</span>
<span class="nc" id="L301">            }</span>

<span class="nc" id="L303">            int port = JDP_DEFAULT_PORT;</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            if (discoveryPort != null) {</span>
               try {
<span class="nc" id="L306">                  port = Integer.parseInt(discoveryPort);</span>
<span class="nc" id="L307">               } catch (NumberFormatException e) {</span>
<span class="nc" id="L308">                 throw new AgentConfigurationError(&quot;Couldn't parse JDP port argument&quot;);</span>
<span class="nc" id="L309">               }</span>
            }

            // Rebuilding service URL to broadcast it
<span class="nc" id="L313">            String jmxremotePort = props.getProperty(JMXREMOTE_PORT);</span>
<span class="nc" id="L314">            String rmiPort = props.getProperty(RMI_PORT);</span>

<span class="nc" id="L316">            JMXServiceURL url = jmxServer.getAddress();</span>
<span class="nc" id="L317">            String hostname = url.getHost();</span>

<span class="nc bnc" id="L319" title="All 2 branches missed.">            String jmxUrlStr = (rmiPort != null)</span>
<span class="nc" id="L320">                    ? String.format(</span>
                    &quot;service:jmx:rmi://%s:%s/jndi/rmi://%s:%s/jmxrmi&quot;,
                    hostname, rmiPort, hostname, jmxremotePort)
<span class="nc" id="L323">                    : String.format(</span>
                    &quot;service:jmx:rmi:///jndi/rmi://%s:%s/jmxrmi&quot;, hostname, jmxremotePort);

<span class="nc" id="L326">            String instanceName = props.getProperty(&quot;com.sun.management.jdp.name&quot;);</span>

            try{
<span class="nc" id="L329">               JdpController.startDiscoveryService(address, port, instanceName, jmxUrlStr);</span>
            }
<span class="nc" id="L331">            catch(JdpException e){</span>
<span class="nc" id="L332">                throw new AgentConfigurationError(&quot;Couldn't start JDP service&quot;, e);</span>
<span class="nc" id="L333">            }</span>
        }
<span class="nc" id="L335">    }</span>

    public static Properties loadManagementProperties() {
<span class="nc" id="L338">        Properties props = new Properties();</span>

        // Load the management properties from the config file

<span class="nc" id="L342">        String fname = System.getProperty(CONFIG_FILE);</span>
<span class="nc" id="L343">        readConfiguration(fname, props);</span>

        // management properties can be overridden by system properties
        // which take precedence
<span class="nc" id="L347">        Properties sysProps = System.getProperties();</span>
<span class="nc" id="L348">        synchronized (sysProps) {</span>
<span class="nc" id="L349">            props.putAll(sysProps);</span>
<span class="nc" id="L350">        }</span>

<span class="nc" id="L352">        return props;</span>
    }

    public static synchronized Properties getManagementProperties() {
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (mgmtProps == null) {</span>
<span class="nc" id="L357">            String configFile = System.getProperty(CONFIG_FILE);</span>
<span class="nc" id="L358">            String snmpPort = System.getProperty(SNMP_PORT);</span>
<span class="nc" id="L359">            String jmxremote = System.getProperty(JMXREMOTE);</span>
<span class="nc" id="L360">            String jmxremotePort = System.getProperty(JMXREMOTE_PORT);</span>

<span class="nc bnc" id="L362" title="All 8 branches missed.">            if (configFile == null &amp;&amp; snmpPort == null</span>
                    &amp;&amp; jmxremote == null &amp;&amp; jmxremotePort == null) {
                // return if out-of-the-management option is not specified
<span class="nc" id="L365">                return null;</span>
            }
<span class="nc" id="L367">            mgmtProps = loadManagementProperties();</span>
        }
<span class="nc" id="L369">        return mgmtProps;</span>
    }

    private static void loadSnmpAgent(String snmpPort, Properties props) {
        try {
            // invoke the following through reflection:
            //     AdaptorBootstrap.initialize(snmpPort, props);
<span class="nc" id="L376">            final Class&lt;?&gt; adaptorClass =</span>
<span class="nc" id="L377">                    Class.forName(SNMP_ADAPTOR_BOOTSTRAP_CLASS_NAME, true, null);</span>
<span class="nc" id="L378">            final Method initializeMethod =</span>
<span class="nc" id="L379">                    adaptorClass.getMethod(&quot;initialize&quot;,</span>
                    String.class, Properties.class);
<span class="nc" id="L381">            initializeMethod.invoke(null, snmpPort, props);</span>
<span class="nc" id="L382">        } catch (ClassNotFoundException | NoSuchMethodException | IllegalAccessException x) {</span>
            // snmp runtime doesn't exist - initialization fails
<span class="nc" id="L384">            throw new UnsupportedOperationException(&quot;Unsupported management property: &quot; + SNMP_PORT, x);</span>
<span class="nc" id="L385">        } catch (InvocationTargetException x) {</span>
<span class="nc" id="L386">            final Throwable cause = x.getCause();</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">            if (cause instanceof RuntimeException) {</span>
<span class="nc" id="L388">                throw (RuntimeException) cause;</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">            } else if (cause instanceof Error) {</span>
<span class="nc" id="L390">                throw (Error) cause;</span>
            }
            // should not happen...
<span class="nc" id="L393">            throw new UnsupportedOperationException(&quot;Unsupported management property: &quot; + SNMP_PORT, cause);</span>
<span class="nc" id="L394">        }</span>
<span class="nc" id="L395">    }</span>

    // read config file and initialize the properties
    private static void readConfiguration(String fname, Properties p) {
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (fname == null) {</span>
<span class="nc" id="L400">            String home = System.getProperty(&quot;java.home&quot;);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (home == null) {</span>
<span class="nc" id="L402">                throw new Error(&quot;Can't find java.home ??&quot;);</span>
            }
<span class="nc" id="L404">            StringBuffer defaultFileName = new StringBuffer(home);</span>
<span class="nc" id="L405">            defaultFileName.append(File.separator).append(&quot;lib&quot;);</span>
<span class="nc" id="L406">            defaultFileName.append(File.separator).append(&quot;management&quot;);</span>
<span class="nc" id="L407">            defaultFileName.append(File.separator).append(&quot;management.properties&quot;);</span>
            // Set file name
<span class="nc" id="L409">            fname = defaultFileName.toString();</span>
        }
<span class="nc" id="L411">        final File configFile = new File(fname);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">        if (!configFile.exists()) {</span>
<span class="nc" id="L413">            error(CONFIG_FILE_NOT_FOUND, fname);</span>
        }

<span class="nc" id="L416">        InputStream in = null;</span>
        try {
<span class="nc" id="L418">            in = new FileInputStream(configFile);</span>
<span class="nc" id="L419">            BufferedInputStream bin = new BufferedInputStream(in);</span>
<span class="nc" id="L420">            p.load(bin);</span>
<span class="nc" id="L421">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L422">            error(CONFIG_FILE_OPEN_FAILED, e.getMessage());</span>
<span class="nc" id="L423">        } catch (IOException e) {</span>
<span class="nc" id="L424">            error(CONFIG_FILE_OPEN_FAILED, e.getMessage());</span>
<span class="nc" id="L425">        } catch (SecurityException e) {</span>
<span class="nc" id="L426">            error(CONFIG_FILE_ACCESS_DENIED, fname);</span>
        } finally {
<span class="nc bnc" id="L428" title="All 10 branches missed.">            if (in != null) {</span>
                try {
<span class="nc" id="L430">                    in.close();</span>
<span class="nc" id="L431">                } catch (IOException e) {</span>
<span class="nc" id="L432">                    error(CONFIG_FILE_CLOSE_FAILED, fname);</span>
<span class="nc" id="L433">                }</span>
            }
        }
<span class="nc" id="L436">    }</span>

    public static void startAgent() throws Exception {
<span class="nc" id="L439">        String prop = System.getProperty(&quot;com.sun.management.agent.class&quot;);</span>

        // -Dcom.sun.management.agent.class not set so read management
        // properties and start agent
<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (prop == null) {</span>
            // initialize management properties
<span class="nc" id="L445">            Properties props = getManagementProperties();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (props != null) {</span>
<span class="nc" id="L447">                startAgent(props);</span>
            }
<span class="nc" id="L449">            return;</span>
        }

        // -Dcom.sun.management.agent.class=&lt;agent classname&gt;:&lt;agent args&gt;
<span class="nc" id="L453">        String[] values = prop.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L454" title="All 4 branches missed.">        if (values.length &lt; 1 || values.length &gt; 2) {</span>
<span class="nc" id="L455">            error(AGENT_CLASS_INVALID, &quot;\&quot;&quot; + prop + &quot;\&quot;&quot;);</span>
        }
<span class="nc" id="L457">        String cname = values[0];</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">        String args = (values.length == 2 ? values[1] : null);</span>

<span class="nc bnc" id="L460" title="All 4 branches missed.">        if (cname == null || cname.length() == 0) {</span>
<span class="nc" id="L461">            error(AGENT_CLASS_INVALID, &quot;\&quot;&quot; + prop + &quot;\&quot;&quot;);</span>
        }

<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (cname != null) {</span>
            try {
                // Instantiate the named class.
                // invoke the premain(String args) method
<span class="nc" id="L468">                Class&lt;?&gt; clz = ClassLoader.getSystemClassLoader().loadClass(cname);</span>
<span class="nc" id="L469">                Method premain = clz.getMethod(&quot;premain&quot;,</span>
                        new Class&lt;?&gt;[]{String.class});
<span class="nc" id="L471">                premain.invoke(null, /* static */</span>
                        new Object[]{args});
<span class="nc" id="L473">            } catch (ClassNotFoundException ex) {</span>
<span class="nc" id="L474">                error(AGENT_CLASS_NOT_FOUND, &quot;\&quot;&quot; + cname + &quot;\&quot;&quot;);</span>
<span class="nc" id="L475">            } catch (NoSuchMethodException ex) {</span>
<span class="nc" id="L476">                error(AGENT_CLASS_PREMAIN_NOT_FOUND, &quot;\&quot;&quot; + cname + &quot;\&quot;&quot;);</span>
<span class="nc" id="L477">            } catch (SecurityException ex) {</span>
<span class="nc" id="L478">                error(AGENT_CLASS_ACCESS_DENIED);</span>
<span class="nc" id="L479">            } catch (Exception ex) {</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">                String msg = (ex.getCause() == null</span>
<span class="nc" id="L481">                        ? ex.getMessage()</span>
<span class="nc" id="L482">                        : ex.getCause().getMessage());</span>
<span class="nc" id="L483">                error(AGENT_CLASS_FAILED, msg);</span>
<span class="nc" id="L484">            }</span>
        }
<span class="nc" id="L486">    }</span>

    public static void error(String key) {
<span class="nc" id="L489">        String keyText = getText(key);</span>
<span class="nc" id="L490">        System.err.print(getText(&quot;agent.err.error&quot;) + &quot;: &quot; + keyText);</span>
<span class="nc" id="L491">        throw new RuntimeException(keyText);</span>
    }

    public static void error(String key, String[] params) {
<span class="nc bnc" id="L495" title="All 4 branches missed.">        if (params == null || params.length == 0) {</span>
<span class="nc" id="L496">            error(key);</span>
        } else {
<span class="nc" id="L498">            StringBuffer message = new StringBuffer(params[0]);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">            for (int i = 1; i &lt; params.length; i++) {</span>
<span class="nc" id="L500">                message.append(&quot; &quot; + params[i]);</span>
            }
<span class="nc" id="L502">            error(key, message.toString());</span>
        }
<span class="nc" id="L504">    }</span>

    public static void error(String key, String message) {
<span class="nc" id="L507">        String keyText = getText(key);</span>
<span class="nc" id="L508">        System.err.print(getText(&quot;agent.err.error&quot;) + &quot;: &quot; + keyText);</span>
<span class="nc" id="L509">        System.err.println(&quot;: &quot; + message);</span>
<span class="nc" id="L510">        throw new RuntimeException(keyText);</span>
    }

    public static void error(Exception e) {
<span class="nc" id="L514">        e.printStackTrace();</span>
<span class="nc" id="L515">        System.err.println(getText(AGENT_EXCEPTION) + &quot;: &quot; + e.toString());</span>
<span class="nc" id="L516">        throw new RuntimeException(e);</span>
    }

    public static void warning(String key, String message) {
<span class="nc" id="L520">        System.err.print(getText(&quot;agent.err.warning&quot;) + &quot;: &quot; + getText(key));</span>
<span class="nc" id="L521">        System.err.println(&quot;: &quot; + message);</span>
<span class="nc" id="L522">    }</span>

    private static void initResource() {
        try {
<span class="nc" id="L526">            messageRB =</span>
<span class="nc" id="L527">                    ResourceBundle.getBundle(&quot;sun.managementresources.agent&quot;);</span>
<span class="nc" id="L528">        } catch (MissingResourceException e) {</span>
<span class="nc" id="L529">            throw new Error(&quot;Fatal: Resource for management agent is missing&quot;);</span>
<span class="nc" id="L530">        }</span>
<span class="nc" id="L531">    }</span>

    public static String getText(String key) {
<span class="nc bnc" id="L534" title="All 2 branches missed.">        if (messageRB == null) {</span>
<span class="nc" id="L535">            initResource();</span>
        }
        try {
<span class="nc" id="L538">            return messageRB.getString(key);</span>
<span class="nc" id="L539">        } catch (MissingResourceException e) {</span>
<span class="nc" id="L540">            return &quot;Missing management agent resource bundle: key = \&quot;&quot; + key + &quot;\&quot;&quot;;</span>
        }
    }

    public static String getText(String key, String... args) {
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (messageRB == null) {</span>
<span class="nc" id="L546">            initResource();</span>
        }
<span class="nc" id="L548">        String format = messageRB.getString(key);</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">        if (format == null) {</span>
<span class="nc" id="L550">            format = &quot;missing resource key: key = \&quot;&quot; + key + &quot;\&quot;, &quot;</span>
                    + &quot;arguments = \&quot;{0}\&quot;, \&quot;{1}\&quot;, \&quot;{2}\&quot;&quot;;
        }
<span class="nc" id="L553">        return MessageFormat.format(format, (Object[]) args);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>