<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>URLClassPath.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.misc</a> &gt; <span class="el_source">URLClassPath.java</span></div><h1>URLClassPath.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.misc;

import java.util.*;
import java.util.jar.JarFile;
import sun.misc.JarIndex;
import sun.misc.InvalidJarIndexException;
import sun.net.www.ParseUtil;
import java.util.zip.ZipEntry;
import java.util.jar.JarEntry;
import java.util.jar.Manifest;
import java.util.jar.Attributes;
import java.util.jar.Attributes.Name;
import java.net.JarURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.net.HttpURLConnection;
import java.net.URLStreamHandler;
import java.net.URLStreamHandlerFactory;
import java.io.*;
import java.security.AccessController;
import java.security.AccessControlException;
import java.security.CodeSigner;
import java.security.Permission;
import java.security.PrivilegedAction;
import java.security.PrivilegedExceptionAction;
import java.security.cert.Certificate;
import sun.misc.FileURLMapper;
import sun.net.util.URLUtil;

/**
 * This class is used to maintain a search path of URLs for loading classes
 * and resources from both JAR files and directories.
 *
 * @author  David Connelly
 */
public class URLClassPath {
    final static String USER_AGENT_JAVA_VERSION = &quot;UA-Java-Version&quot;;
    final static String JAVA_VERSION;
    private static final boolean DEBUG;
    private static final boolean DISABLE_JAR_CHECKING;

    static {
<span class="fc" id="L69">        JAVA_VERSION = java.security.AccessController.doPrivileged(</span>
            new sun.security.action.GetPropertyAction(&quot;java.version&quot;));
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        DEBUG        = (java.security.AccessController.doPrivileged(</span>
            new sun.security.action.GetPropertyAction(&quot;sun.misc.URLClassPath.debug&quot;)) != null);
<span class="fc" id="L73">        String p = java.security.AccessController.doPrivileged(</span>
            new sun.security.action.GetPropertyAction(&quot;sun.misc.URLClassPath.disableJarChecking&quot;));
<span class="pc bpc" id="L75" title="5 of 6 branches missed.">        DISABLE_JAR_CHECKING = p != null ? p.equals(&quot;true&quot;) || p.equals(&quot;&quot;) : false;</span>
<span class="fc" id="L76">    }</span>

    /* The original search path of URLs. */
<span class="fc" id="L79">    private ArrayList&lt;URL&gt; path = new ArrayList&lt;URL&gt;();</span>

    /* The stack of unopened URLs */
<span class="fc" id="L82">    Stack&lt;URL&gt; urls = new Stack&lt;URL&gt;();</span>

    /* The resulting search path of Loaders */
<span class="fc" id="L85">    ArrayList&lt;Loader&gt; loaders = new ArrayList&lt;Loader&gt;();</span>

    /* Map of each URL opened to its corresponding Loader */
<span class="fc" id="L88">    HashMap&lt;String, Loader&gt; lmap = new HashMap&lt;String, Loader&gt;();</span>

    /* The jar protocol handler to use when creating new URLs */
    private URLStreamHandler jarHandler;

    /* Whether this URLClassLoader has been closed yet */
<span class="fc" id="L94">    private boolean closed = false;</span>

    /**
     * Creates a new URLClassPath for the given URLs. The URLs will be
     * searched in the order specified for classes and resources. A URL
     * ending with a '/' is assumed to refer to a directory. Otherwise,
     * the URL is assumed to refer to a JAR file.
     *
     * @param urls the directory and JAR file URLs to search for classes
     *        and resources
     * @param factory the URLStreamHandlerFactory to use when creating new URLs
     */
<span class="fc" id="L106">    public URLClassPath(URL[] urls, URLStreamHandlerFactory factory) {</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">        for (int i = 0; i &lt; urls.length; i++) {</span>
<span class="fc" id="L108">            path.add(urls[i]);</span>
        }
<span class="fc" id="L110">        push(urls);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">        if (factory != null) {</span>
<span class="fc" id="L112">            jarHandler = factory.createURLStreamHandler(&quot;jar&quot;);</span>
        }
<span class="fc" id="L114">    }</span>

    public URLClassPath(URL[] urls) {
<span class="fc" id="L117">        this(urls, null);</span>
<span class="fc" id="L118">    }</span>

    public synchronized List&lt;IOException&gt; closeLoaders() {
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        if (closed) {</span>
<span class="nc" id="L122">            return Collections.emptyList();</span>
        }
<span class="fc" id="L124">        List&lt;IOException&gt; result = new LinkedList&lt;IOException&gt;();</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">        for (Loader loader : loaders) {</span>
            try {
<span class="fc" id="L127">                loader.close();</span>
<span class="nc" id="L128">            } catch (IOException e) {</span>
<span class="nc" id="L129">                result.add (e);</span>
<span class="fc" id="L130">            }</span>
<span class="fc" id="L131">        }</span>
<span class="fc" id="L132">        closed = true;</span>
<span class="fc" id="L133">        return result;</span>
    }

    /**
     * Appends the specified URL to the search path of directory and JAR
     * file URLs from which to load classes and resources.
     * &lt;p&gt;
     * If the URL specified is null or is already in the list of
     * URLs, then invoking this method has no effect.
     */
    public synchronized void addURL(URL url) {
<span class="fc bfc" id="L144" title="All 2 branches covered.">        if (closed)</span>
<span class="fc" id="L145">            return;</span>
<span class="fc" id="L146">        synchronized (urls) {</span>
<span class="fc bfc" id="L147" title="All 4 branches covered.">            if (url == null || path.contains(url))</span>
<span class="fc" id="L148">                return;</span>

<span class="fc" id="L150">            urls.add(0, url);</span>
<span class="fc" id="L151">            path.add(url);</span>
<span class="pc" id="L152">        }</span>
<span class="fc" id="L153">    }</span>

    /**
     * Returns the original search path of URLs.
     */
    public URL[] getURLs() {
<span class="fc" id="L159">        synchronized (urls) {</span>
<span class="fc" id="L160">            return path.toArray(new URL[path.size()]);</span>
<span class="nc" id="L161">        }</span>
    }

    /**
     * Finds the resource with the specified name on the URL search path
     * or null if not found or security check fails.
     *
     * @param name      the name of the resource
     * @param check     whether to perform a security check
     * @return a &lt;code&gt;URL&lt;/code&gt; for the resource, or &lt;code&gt;null&lt;/code&gt;
     * if the resource could not be found.
     */
    public URL findResource(String name, boolean check) {
        Loader loader;
<span class="fc bfc" id="L175" title="All 2 branches covered.">        for (int i = 0; (loader = getLoader(i)) != null; i++) {</span>
<span class="fc" id="L176">            URL url = loader.findResource(name, check);</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">            if (url != null) {</span>
<span class="fc" id="L178">                return url;</span>
            }
        }
<span class="fc" id="L181">        return null;</span>
    }

    /**
     * Finds the first Resource on the URL search path which has the specified
     * name. Returns null if no Resource could be found.
     *
     * @param name the name of the Resource
     * @param check     whether to perform a security check
     * @return the Resource, or null if not found
     */
    public Resource getResource(String name, boolean check) {
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if (DEBUG) {</span>
<span class="nc" id="L194">            System.err.println(&quot;URLClassPath.getResource(\&quot;&quot; + name + &quot;\&quot;)&quot;);</span>
        }

        Loader loader;
<span class="fc bfc" id="L198" title="All 2 branches covered.">        for (int i = 0; (loader = getLoader(i)) != null; i++) {</span>
<span class="fc" id="L199">            Resource res = loader.getResource(name, check);</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">            if (res != null) {</span>
<span class="fc" id="L201">                return res;</span>
            }
        }
<span class="fc" id="L204">        return null;</span>
    }

    /**
     * Finds all resources on the URL search path with the given name.
     * Returns an enumeration of the URL objects.
     *
     * @param name the resource name
     * @return an Enumeration of all the urls having the specified name
     */
    public Enumeration&lt;URL&gt; findResources(final String name,
                                     final boolean check) {
<span class="fc" id="L216">        return new Enumeration&lt;URL&gt;() {</span>
<span class="fc" id="L217">            private int index = 0;</span>
<span class="fc" id="L218">            private URL url = null;</span>

            private boolean next() {
<span class="fc bfc" id="L221" title="All 2 branches covered.">                if (url != null) {</span>
<span class="fc" id="L222">                    return true;</span>
                } else {
                    Loader loader;
<span class="fc bfc" id="L225" title="All 2 branches covered.">                    while ((loader = getLoader(index++)) != null) {</span>
<span class="fc" id="L226">                        url = loader.findResource(name, check);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">                        if (url != null) {</span>
<span class="fc" id="L228">                            return true;</span>
                        }
                    }
<span class="fc" id="L231">                    return false;</span>
                }
            }

            public boolean hasMoreElements() {
<span class="fc" id="L236">                return next();</span>
            }

            public URL nextElement() {
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">                if (!next()) {</span>
<span class="nc" id="L241">                    throw new NoSuchElementException();</span>
                }
<span class="fc" id="L243">                URL u = url;</span>
<span class="fc" id="L244">                url = null;</span>
<span class="fc" id="L245">                return u;</span>
            }
        };
    }

    public Resource getResource(String name) {
<span class="fc" id="L251">        return getResource(name, true);</span>
    }

    /**
     * Finds all resources on the URL search path with the given name.
     * Returns an enumeration of the Resource objects.
     *
     * @param name the resource name
     * @return an Enumeration of all the resources having the specified name
     */
    public Enumeration&lt;Resource&gt; getResources(final String name,
                                    final boolean check) {
<span class="fc" id="L263">        return new Enumeration&lt;Resource&gt;() {</span>
<span class="fc" id="L264">            private int index = 0;</span>
<span class="fc" id="L265">            private Resource res = null;</span>

            private boolean next() {
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">                if (res != null) {</span>
<span class="nc" id="L269">                    return true;</span>
                } else {
                    Loader loader;
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">                    while ((loader = getLoader(index++)) != null) {</span>
<span class="nc" id="L273">                        res = loader.getResource(name, check);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                        if (res != null) {</span>
<span class="nc" id="L275">                            return true;</span>
                        }
                    }
<span class="fc" id="L278">                    return false;</span>
                }
            }

            public boolean hasMoreElements() {
<span class="fc" id="L283">                return next();</span>
            }

            public Resource nextElement() {
<span class="nc bnc" id="L287" title="All 2 branches missed.">                if (!next()) {</span>
<span class="nc" id="L288">                    throw new NoSuchElementException();</span>
                }
<span class="nc" id="L290">                Resource r = res;</span>
<span class="nc" id="L291">                res = null;</span>
<span class="nc" id="L292">                return r;</span>
            }
        };
    }

    public Enumeration&lt;Resource&gt; getResources(final String name) {
<span class="fc" id="L298">        return getResources(name, true);</span>
    }

    /*
     * Returns the Loader at the specified position in the URL search
     * path. The URLs are opened and expanded as needed. Returns null
     * if the specified index is out of range.
     */
     private synchronized Loader getLoader(int index) {
<span class="fc bfc" id="L307" title="All 2 branches covered.">        if (closed) {</span>
<span class="fc" id="L308">            return null;</span>
        }
         // Expand URL search path until the request can be satisfied
         // or the URL stack is empty.
<span class="fc bfc" id="L312" title="All 2 branches covered.">        while (loaders.size() &lt; index + 1) {</span>
            // Pop the next URL from the URL stack
            URL url;
<span class="fc" id="L315">            synchronized (urls) {</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">                if (urls.empty()) {</span>
<span class="fc" id="L317">                    return null;</span>
                } else {
<span class="fc" id="L319">                    url = urls.pop();</span>
                }
<span class="pc" id="L321">            }</span>
            // Skip this URL if it already has a Loader. (Loader
            // may be null in the case where URL has not been opened
            // but is referenced by a JAR index.)
<span class="fc" id="L325">            String urlNoFragString = URLUtil.urlNoFragString(url);</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">            if (lmap.containsKey(urlNoFragString)) {</span>
<span class="fc" id="L327">                continue;</span>
            }
            // Otherwise, create a new Loader for the URL.
            Loader loader;
            try {
<span class="fc" id="L332">                loader = getLoader(url);</span>
                // If the loader defines a local class path then add the
                // URLs to the list of URLs to be opened.
<span class="fc" id="L335">                URL[] urls = loader.getClassPath();</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">                if (urls != null) {</span>
<span class="fc" id="L337">                    push(urls);</span>
                }
<span class="fc" id="L339">            } catch (IOException e) {</span>
                // Silently ignore for now...
<span class="fc" id="L341">                continue;</span>
<span class="fc" id="L342">            }</span>
            // Finally, add the Loader to the search path.
<span class="fc" id="L344">            loaders.add(loader);</span>
<span class="fc" id="L345">            lmap.put(urlNoFragString, loader);</span>
<span class="fc" id="L346">        }</span>
<span class="fc" id="L347">        return loaders.get(index);</span>
    }

    /*
     * Returns the Loader for the specified base URL.
     */
    private Loader getLoader(final URL url) throws IOException {
        try {
<span class="fc" id="L355">            return java.security.AccessController.doPrivileged(</span>
<span class="fc" id="L356">                new java.security.PrivilegedExceptionAction&lt;Loader&gt;() {</span>
                public Loader run() throws IOException {
<span class="fc" id="L358">                    String file = url.getFile();</span>
<span class="pc bpc" id="L359" title="1 of 4 branches missed.">                    if (file != null &amp;&amp; file.endsWith(&quot;/&quot;)) {</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">                        if (&quot;file&quot;.equals(url.getProtocol())) {</span>
<span class="fc" id="L361">                            return new FileLoader(url);</span>
                        } else {
<span class="fc" id="L363">                            return new Loader(url);</span>
                        }
                    } else {
<span class="fc" id="L366">                        return new JarLoader(url, jarHandler, lmap);</span>
                    }
                }
            });
<span class="fc" id="L370">        } catch (java.security.PrivilegedActionException pae) {</span>
<span class="fc" id="L371">            throw (IOException)pae.getException();</span>
        }
    }

    /*
     * Pushes the specified URLs onto the list of unopened URLs.
     */
    private void push(URL[] us) {
<span class="fc" id="L379">        synchronized (urls) {</span>
<span class="fc bfc" id="L380" title="All 2 branches covered.">            for (int i = us.length - 1; i &gt;= 0; --i) {</span>
<span class="fc" id="L381">                urls.push(us[i]);</span>
            }
<span class="pc" id="L383">        }</span>
<span class="fc" id="L384">    }</span>

    /**
     * Convert class path specification into an array of file URLs.
     *
     * The path of the file is encoded before conversion into URL
     * form so that reserved characters can safely appear in the path.
     */
    public static URL[] pathToURLs(String path) {
<span class="fc" id="L393">        StringTokenizer st = new StringTokenizer(path, File.pathSeparator);</span>
<span class="fc" id="L394">        URL[] urls = new URL[st.countTokens()];</span>
<span class="fc" id="L395">        int count = 0;</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">        while (st.hasMoreTokens()) {</span>
<span class="fc" id="L397">            File f = new File(st.nextToken());</span>
            try {
<span class="fc" id="L399">                f = new File(f.getCanonicalPath());</span>
<span class="nc" id="L400">            } catch (IOException x) {</span>
                // use the non-canonicalized filename
<span class="fc" id="L402">            }</span>
            try {
<span class="fc" id="L404">                urls[count++] = ParseUtil.fileToEncodedURL(f);</span>
<span class="pc" id="L405">            } catch (IOException x) { }</span>
<span class="fc" id="L406">        }</span>

<span class="pc bpc" id="L408" title="1 of 2 branches missed.">        if (urls.length != count) {</span>
<span class="nc" id="L409">            URL[] tmp = new URL[count];</span>
<span class="nc" id="L410">            System.arraycopy(urls, 0, tmp, 0, count);</span>
<span class="nc" id="L411">            urls = tmp;</span>
        }
<span class="fc" id="L413">        return urls;</span>
    }

    /*
     * Check whether the resource URL should be returned.
     * Return null on security check failure.
     * Called by java.net.URLClassLoader.
     */
    public URL checkURL(URL url) {
        try {
<span class="fc" id="L423">            check(url);</span>
<span class="nc" id="L424">        } catch (Exception e) {</span>
<span class="nc" id="L425">            return null;</span>
<span class="fc" id="L426">        }</span>

<span class="fc" id="L428">        return url;</span>
    }

    /*
     * Check whether the resource URL should be returned.
     * Throw exception on failure.
     * Called internally within this file.
     */
    static void check(URL url) throws IOException {
<span class="fc" id="L437">        SecurityManager security = System.getSecurityManager();</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">        if (security != null) {</span>
<span class="fc" id="L439">            URLConnection urlConnection = url.openConnection();</span>
<span class="fc" id="L440">            Permission perm = urlConnection.getPermission();</span>
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">            if (perm != null) {</span>
                try {
<span class="fc" id="L443">                    security.checkPermission(perm);</span>
<span class="nc" id="L444">                } catch (SecurityException se) {</span>
                    // fallback to checkRead/checkConnect for pre 1.2
                    // security managers
<span class="nc bnc" id="L447" title="All 2 branches missed.">                    if ((perm instanceof java.io.FilePermission) &amp;&amp;</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">                        perm.getActions().indexOf(&quot;read&quot;) != -1) {</span>
<span class="nc" id="L449">                        security.checkRead(perm.getName());</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">                    } else if ((perm instanceof</span>
                        java.net.SocketPermission) &amp;&amp;
<span class="nc bnc" id="L452" title="All 2 branches missed.">                        perm.getActions().indexOf(&quot;connect&quot;) != -1) {</span>
<span class="nc" id="L453">                        URL locUrl = url;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                        if (urlConnection instanceof JarURLConnection) {</span>
<span class="nc" id="L455">                            locUrl = ((JarURLConnection)urlConnection).getJarFileURL();</span>
                        }
<span class="nc" id="L457">                        security.checkConnect(locUrl.getHost(),</span>
<span class="nc" id="L458">                                              locUrl.getPort());</span>
<span class="nc" id="L459">                    } else {</span>
<span class="nc" id="L460">                        throw se;</span>
                    }
<span class="fc" id="L462">                }</span>
            }
        }
<span class="fc" id="L465">    }</span>

    /**
     * Inner class used to represent a loader of resources and classes
     * from a base URL.
     */
    private static class Loader implements Closeable {
        private final URL base;
        private JarFile jarfile; // if this points to a jar file

        /*
         * Creates a new Loader for the specified URL.
         */
<span class="fc" id="L478">        Loader(URL url) {</span>
<span class="fc" id="L479">            base = url;</span>
<span class="fc" id="L480">        }</span>

        /*
         * Returns the base URL for this Loader.
         */
        URL getBaseURL() {
<span class="fc" id="L486">            return base;</span>
        }

        URL findResource(final String name, boolean check) {
            URL url;
            try {
<span class="fc" id="L492">                url = new URL(base, ParseUtil.encodePath(name, false));</span>
<span class="nc" id="L493">            } catch (MalformedURLException e) {</span>
<span class="nc" id="L494">                throw new IllegalArgumentException(&quot;name&quot;);</span>
<span class="fc" id="L495">            }</span>

            try {
<span class="pc bpc" id="L498" title="1 of 2 branches missed.">                if (check) {</span>
<span class="fc" id="L499">                    URLClassPath.check(url);</span>
                }

                /*
                 * For a HTTP connection we use the HEAD method to
                 * check if the resource exists.
                 */
<span class="fc" id="L506">                URLConnection uc = url.openConnection();</span>
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">                if (uc instanceof HttpURLConnection) {</span>
<span class="nc" id="L508">                    HttpURLConnection hconn = (HttpURLConnection)uc;</span>
<span class="nc" id="L509">                    hconn.setRequestMethod(&quot;HEAD&quot;);</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                    if (hconn.getResponseCode() &gt;= HttpURLConnection.HTTP_BAD_REQUEST) {</span>
<span class="nc" id="L511">                        return null;</span>
                    }
<span class="nc" id="L513">                } else {</span>
                    // our best guess for the other cases
<span class="fc" id="L515">                    uc.setUseCaches(false);</span>
<span class="fc" id="L516">                    InputStream is = uc.getInputStream();</span>
<span class="fc" id="L517">                    is.close();</span>
                }
<span class="fc" id="L519">                return url;</span>
<span class="fc" id="L520">            } catch (Exception e) {</span>
<span class="fc" id="L521">                return null;</span>
            }
        }

        Resource getResource(final String name, boolean check) {
            final URL url;
            try {
<span class="fc" id="L528">                url = new URL(base, ParseUtil.encodePath(name, false));</span>
<span class="nc" id="L529">            } catch (MalformedURLException e) {</span>
<span class="nc" id="L530">                throw new IllegalArgumentException(&quot;name&quot;);</span>
<span class="fc" id="L531">            }</span>
            final URLConnection uc;
            try {
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">                if (check) {</span>
<span class="nc" id="L535">                    URLClassPath.check(url);</span>
                }
<span class="fc" id="L537">                uc = url.openConnection();</span>
<span class="fc" id="L538">                InputStream in = uc.getInputStream();</span>
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">                if (uc instanceof JarURLConnection) {</span>
                    /* Need to remember the jar file so it can be closed
                     * in a hurry.
                     */
<span class="fc" id="L543">                    JarURLConnection juc = (JarURLConnection)uc;</span>
<span class="fc" id="L544">                    jarfile = JarLoader.checkJar(juc.getJarFile());</span>
                }
<span class="fc" id="L546">            } catch (Exception e) {</span>
<span class="fc" id="L547">                return null;</span>
<span class="fc" id="L548">            }</span>
<span class="fc" id="L549">            return new Resource() {</span>
<span class="nc" id="L550">                public String getName() { return name; }</span>
<span class="nc" id="L551">                public URL getURL() { return url; }</span>
<span class="fc" id="L552">                public URL getCodeSourceURL() { return base; }</span>
                public InputStream getInputStream() throws IOException {
<span class="fc" id="L554">                    return uc.getInputStream();</span>
                }
                public int getContentLength() throws IOException {
<span class="fc" id="L557">                    return uc.getContentLength();</span>
                }
            };
        }

        /*
         * Returns the Resource for the specified name, or null if not
         * found or the caller does not have the permission to get the
         * resource.
         */
        Resource getResource(final String name) {
<span class="nc" id="L568">            return getResource(name, true);</span>
        }

        /*
         * close this loader and release all resources
         * method overridden in sub-classes
         */
        public void close () throws IOException {
<span class="fc bfc" id="L576" title="All 2 branches covered.">            if (jarfile != null) {</span>
<span class="fc" id="L577">                jarfile.close();</span>
            }
<span class="fc" id="L579">        }</span>

        /*
         * Returns the local class path for this loader, or null if none.
         */
        URL[] getClassPath() throws IOException {
<span class="fc" id="L585">            return null;</span>
        }
    }

    /*
     * Inner class used to represent a Loader of resources from a JAR URL.
     */
    static class JarLoader extends Loader {
        private JarFile jar;
        private URL csu;
        private JarIndex index;
        private MetaIndex metaIndex;
        private URLStreamHandler handler;
        private HashMap&lt;String, Loader&gt; lmap;
<span class="fc" id="L599">        private boolean closed = false;</span>
<span class="fc" id="L600">        private static final sun.misc.JavaUtilZipFileAccess zipAccess =</span>
<span class="fc" id="L601">                sun.misc.SharedSecrets.getJavaUtilZipFileAccess();</span>

        /*
         * Creates a new JarLoader for the specified URL referring to
         * a JAR file.
         */
        JarLoader(URL url, URLStreamHandler jarHandler,
                  HashMap&lt;String, Loader&gt; loaderMap)
            throws IOException
        {
<span class="fc" id="L611">            super(new URL(&quot;jar&quot;, &quot;&quot;, -1, url + &quot;!/&quot;, jarHandler));</span>
<span class="fc" id="L612">            csu = url;</span>
<span class="fc" id="L613">            handler = jarHandler;</span>
<span class="fc" id="L614">            lmap = loaderMap;</span>

<span class="fc bfc" id="L616" title="All 2 branches covered.">            if (!isOptimizable(url)) {</span>
<span class="fc" id="L617">                ensureOpen();</span>
            } else {
<span class="fc" id="L619">                 String fileName = url.getFile();</span>
<span class="pc bpc" id="L620" title="1 of 2 branches missed.">                if (fileName != null) {</span>
<span class="fc" id="L621">                    fileName = ParseUtil.decode(fileName);</span>
<span class="fc" id="L622">                    File f = new File(fileName);</span>
<span class="fc" id="L623">                    metaIndex = MetaIndex.forJar(f);</span>
                    // If the meta index is found but the file is not
                    // installed, set metaIndex to null. A typical
                    // senario is charsets.jar which won't be installed
                    // when the user is running in certain locale environment.
                    // The side effect of null metaIndex will cause
                    // ensureOpen get called so that IOException is thrown.
<span class="pc bpc" id="L630" title="1 of 4 branches missed.">                    if (metaIndex != null &amp;&amp; !f.exists()) {</span>
<span class="nc" id="L631">                        metaIndex = null;</span>
                    }
                }

                // metaIndex is null when either there is no such jar file
                // entry recorded in meta-index file or such jar file is
                // missing in JRE. See bug 6340399.
<span class="fc bfc" id="L638" title="All 2 branches covered.">                if (metaIndex == null) {</span>
<span class="fc" id="L639">                    ensureOpen();</span>
                }
            }
<span class="fc" id="L642">        }</span>

        @Override
        public void close () throws IOException {
            // closing is synchronized at higher level
<span class="pc bpc" id="L647" title="1 of 2 branches missed.">            if (!closed) {</span>
<span class="fc" id="L648">                closed = true;</span>
                // in case not already open.
<span class="fc" id="L650">                ensureOpen();</span>
<span class="fc" id="L651">                jar.close();</span>
            }
<span class="fc" id="L653">        }</span>

        JarFile getJarFile () {
<span class="nc" id="L656">            return jar;</span>
        }

        private boolean isOptimizable(URL url) {
<span class="fc" id="L660">            return &quot;file&quot;.equals(url.getProtocol());</span>
        }

        private void ensureOpen() throws IOException {
<span class="fc bfc" id="L664" title="All 2 branches covered.">            if (jar == null) {</span>
                try {
<span class="fc" id="L666">                    java.security.AccessController.doPrivileged(</span>
<span class="fc" id="L667">                        new java.security.PrivilegedExceptionAction&lt;Void&gt;() {</span>
                            public Void run() throws IOException {
<span class="pc bpc" id="L669" title="1 of 2 branches missed.">                                if (DEBUG) {</span>
<span class="nc" id="L670">                                    System.err.println(&quot;Opening &quot; + csu);</span>
<span class="nc" id="L671">                                    Thread.dumpStack();</span>
                                }

<span class="fc" id="L674">                                jar = getJarFile(csu);</span>
<span class="fc" id="L675">                                index = JarIndex.getJarIndex(jar, metaIndex);</span>
<span class="fc bfc" id="L676" title="All 2 branches covered.">                                if (index != null) {</span>
<span class="fc" id="L677">                                    String[] jarfiles = index.getJarFiles();</span>
                                // Add all the dependent URLs to the lmap so that loaders
                                // will not be created for them by URLClassPath.getLoader(int)
                                // if the same URL occurs later on the main class path.  We set
                                // Loader to null here to avoid creating a Loader for each
                                // URL until we actually need to try to load something from them.
<span class="fc bfc" id="L683" title="All 2 branches covered.">                                    for(int i = 0; i &lt; jarfiles.length; i++) {</span>
                                        try {
<span class="fc" id="L685">                                            URL jarURL = new URL(csu, jarfiles[i]);</span>
                                            // If a non-null loader already exists, leave it alone.
<span class="fc" id="L687">                                            String urlNoFragString = URLUtil.urlNoFragString(jarURL);</span>
<span class="fc bfc" id="L688" title="All 2 branches covered.">                                            if (!lmap.containsKey(urlNoFragString)) {</span>
<span class="fc" id="L689">                                                lmap.put(urlNoFragString, null);</span>
                                            }
<span class="nc" id="L691">                                        } catch (MalformedURLException e) {</span>
<span class="nc" id="L692">                                            continue;</span>
<span class="fc" id="L693">                                        }</span>
                                    }
                                }
<span class="fc" id="L696">                                return null;</span>
                            }
                        }
                    );
<span class="fc" id="L700">                } catch (java.security.PrivilegedActionException pae) {</span>
<span class="fc" id="L701">                    throw (IOException)pae.getException();</span>
<span class="fc" id="L702">                }</span>
            }
<span class="fc" id="L704">        }</span>

        /* Throws if the given jar file is does not start with the correct LOC */
        static JarFile checkJar(JarFile jar) throws IOException {
<span class="pc bpc" id="L708" title="1 of 4 branches missed.">            if (System.getSecurityManager() != null &amp;&amp; !DISABLE_JAR_CHECKING</span>
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">                &amp;&amp; !zipAccess.startsWithLocHeader(jar)) {</span>
<span class="nc" id="L710">                IOException x = new IOException(&quot;Invalid Jar file&quot;);</span>
                try {
<span class="nc" id="L712">                    jar.close();</span>
<span class="nc" id="L713">                } catch (IOException ex) {</span>
<span class="nc" id="L714">                    x.addSuppressed(ex);</span>
<span class="nc" id="L715">                }</span>
<span class="nc" id="L716">                throw x;</span>
            }

<span class="fc" id="L719">            return jar;</span>
        }

        private JarFile getJarFile(URL url) throws IOException {
            // Optimize case where url refers to a local jar file
<span class="fc bfc" id="L724" title="All 2 branches covered.">            if (isOptimizable(url)) {</span>
<span class="fc" id="L725">                FileURLMapper p = new FileURLMapper (url);</span>
<span class="fc bfc" id="L726" title="All 2 branches covered.">                if (!p.exists()) {</span>
<span class="fc" id="L727">                    throw new FileNotFoundException(p.getPath());</span>
                }
<span class="fc" id="L729">                return checkJar(new JarFile(p.getPath()));</span>
            }
<span class="fc" id="L731">            URLConnection uc = getBaseURL().openConnection();</span>
<span class="fc" id="L732">            uc.setRequestProperty(USER_AGENT_JAVA_VERSION, JAVA_VERSION);</span>
<span class="fc" id="L733">            JarFile jarFile = ((JarURLConnection)uc).getJarFile();</span>
<span class="fc" id="L734">            return checkJar(jarFile);</span>
        }

        /*
         * Returns the index of this JarLoader if it exists.
         */
        JarIndex getIndex() {
            try {
<span class="fc" id="L742">                ensureOpen();</span>
<span class="nc" id="L743">            } catch (IOException e) {</span>
<span class="nc" id="L744">                throw new InternalError(e);</span>
<span class="fc" id="L745">            }</span>
<span class="fc" id="L746">            return index;</span>
        }

        /*
         * Creates the resource and if the check flag is set to true, checks if
         * is its okay to return the resource.
         */
        Resource checkResource(final String name, boolean check,
            final JarEntry entry) {

            final URL url;
            try {
<span class="fc" id="L758">                url = new URL(getBaseURL(), ParseUtil.encodePath(name, false));</span>
<span class="fc bfc" id="L759" title="All 2 branches covered.">                if (check) {</span>
<span class="fc" id="L760">                    URLClassPath.check(url);</span>
                }
<span class="nc" id="L762">            } catch (MalformedURLException e) {</span>
<span class="nc" id="L763">                return null;</span>
                // throw new IllegalArgumentException(&quot;name&quot;);
<span class="nc" id="L765">            } catch (IOException e) {</span>
<span class="nc" id="L766">                return null;</span>
<span class="nc" id="L767">            } catch (AccessControlException e) {</span>
<span class="nc" id="L768">                return null;</span>
<span class="fc" id="L769">            }</span>

<span class="fc" id="L771">            return new Resource() {</span>
<span class="nc" id="L772">                public String getName() { return name; }</span>
<span class="fc" id="L773">                public URL getURL() { return url; }</span>
<span class="fc" id="L774">                public URL getCodeSourceURL() { return csu; }</span>
                public InputStream getInputStream() throws IOException
<span class="fc" id="L776">                    { return jar.getInputStream(entry); }</span>
                public int getContentLength()
<span class="fc" id="L778">                    { return (int)entry.getSize(); }</span>
                public Manifest getManifest() throws IOException
<span class="fc" id="L780">                    { return jar.getManifest(); };</span>
                public Certificate[] getCertificates()
<span class="nc" id="L782">                    { return entry.getCertificates(); };</span>
                public CodeSigner[] getCodeSigners()
<span class="fc" id="L784">                    { return entry.getCodeSigners(); };</span>
            };
        }


        /*
         * Returns true iff atleast one resource in the jar file has the same
         * package name as that of the specified resource name.
         */
        boolean validIndex(final String name) {
<span class="fc" id="L794">            String packageName = name;</span>
            int pos;
<span class="pc bpc" id="L796" title="1 of 2 branches missed.">            if((pos = name.lastIndexOf(&quot;/&quot;)) != -1) {</span>
<span class="fc" id="L797">                packageName = name.substring(0, pos);</span>
            }

            String entryName;
            ZipEntry entry;
<span class="fc" id="L802">            Enumeration&lt;JarEntry&gt; enum_ = jar.entries();</span>
<span class="pc bpc" id="L803" title="1 of 2 branches missed.">            while (enum_.hasMoreElements()) {</span>
<span class="fc" id="L804">                entry = enum_.nextElement();</span>
<span class="fc" id="L805">                entryName = entry.getName();</span>
<span class="pc bpc" id="L806" title="1 of 2 branches missed.">                if((pos = entryName.lastIndexOf(&quot;/&quot;)) != -1)</span>
<span class="fc" id="L807">                    entryName = entryName.substring(0, pos);</span>
<span class="fc bfc" id="L808" title="All 2 branches covered.">                if (entryName.equals(packageName)) {</span>
<span class="fc" id="L809">                    return true;</span>
                }
            }
<span class="nc" id="L812">            return false;</span>
        }

        /*
         * Returns the URL for a resource with the specified name
         */
        URL findResource(final String name, boolean check) {
<span class="fc" id="L819">            Resource rsc = getResource(name, check);</span>
<span class="fc bfc" id="L820" title="All 2 branches covered.">            if (rsc != null) {</span>
<span class="fc" id="L821">                return rsc.getURL();</span>
            }
<span class="fc" id="L823">            return null;</span>
        }

        /*
         * Returns the JAR Resource for the specified name.
         */
        Resource getResource(final String name, boolean check) {
<span class="fc bfc" id="L830" title="All 2 branches covered.">            if (metaIndex != null) {</span>
<span class="fc bfc" id="L831" title="All 2 branches covered.">                if (!metaIndex.mayContain(name)) {</span>
<span class="fc" id="L832">                    return null;</span>
                }
            }

            try {
<span class="fc" id="L837">                ensureOpen();</span>
<span class="nc" id="L838">            } catch (IOException e) {</span>
<span class="nc" id="L839">                throw new InternalError(e);</span>
<span class="fc" id="L840">            }</span>
<span class="fc" id="L841">            final JarEntry entry = jar.getJarEntry(name);</span>
<span class="fc bfc" id="L842" title="All 2 branches covered.">            if (entry != null)</span>
<span class="fc" id="L843">                return checkResource(name, check, entry);</span>

<span class="fc bfc" id="L845" title="All 2 branches covered.">            if (index == null)</span>
<span class="fc" id="L846">                return null;</span>

<span class="fc" id="L848">            HashSet&lt;String&gt; visited = new HashSet&lt;String&gt;();</span>
<span class="fc" id="L849">            return getResource(name, check, visited);</span>
        }

        /*
         * Version of getResource() that tracks the jar files that have been
         * visited by linking through the index files. This helper method uses
         * a HashSet to store the URLs of jar files that have been searched and
         * uses it to avoid going into an infinite loop, looking for a
         * non-existent resource
         */
        Resource getResource(final String name, boolean check,
                             Set&lt;String&gt; visited) {

            Resource res;
            String[] jarFiles;
<span class="fc" id="L864">            int count = 0;</span>
<span class="fc" id="L865">            LinkedList&lt;String&gt; jarFilesList = null;</span>

            /* If there no jar files in the index that can potential contain
             * this resource then return immediately.
             */
<span class="fc bfc" id="L870" title="All 2 branches covered.">            if((jarFilesList = index.get(name)) == null)</span>
<span class="fc" id="L871">                return null;</span>

            do {
<span class="fc" id="L874">                int size = jarFilesList.size();</span>
<span class="fc" id="L875">                jarFiles = jarFilesList.toArray(new String[size]);</span>
                /* loop through the mapped jar file list */
<span class="pc bpc" id="L877" title="1 of 2 branches missed.">                while(count &lt; size) {</span>
<span class="fc" id="L878">                    String jarName = jarFiles[count++];</span>
                    JarLoader newLoader;
                    final URL url;

                    try{
<span class="fc" id="L883">                        url = new URL(csu, jarName);</span>
<span class="fc" id="L884">                        String urlNoFragString = URLUtil.urlNoFragString(url);</span>
<span class="fc bfc" id="L885" title="All 2 branches covered.">                        if ((newLoader = (JarLoader)lmap.get(urlNoFragString)) == null) {</span>
                            /* no loader has been set up for this jar file
                             * before
                             */
<span class="fc" id="L889">                            newLoader = AccessController.doPrivileged(</span>
<span class="fc" id="L890">                                new PrivilegedExceptionAction&lt;JarLoader&gt;() {</span>
                                    public JarLoader run() throws IOException {
<span class="fc" id="L892">                                        return new JarLoader(url, handler,</span>
<span class="fc" id="L893">                                            lmap);</span>
                                    }
                                });

                            /* this newly opened jar file has its own index,
                             * merge it into the parent's index, taking into
                             * account the relative path.
                             */
<span class="fc" id="L901">                            JarIndex newIndex = newLoader.getIndex();</span>
<span class="fc bfc" id="L902" title="All 2 branches covered.">                            if(newIndex != null) {</span>
<span class="fc" id="L903">                                int pos = jarName.lastIndexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L904" title="1 of 2 branches missed.">                                newIndex.merge(this.index, (pos == -1 ?</span>
<span class="nc" id="L905">                                    null : jarName.substring(0, pos + 1)));</span>
                            }

                            /* put it in the global hashtable */
<span class="fc" id="L909">                            lmap.put(urlNoFragString, newLoader);</span>
                        }
<span class="nc" id="L911">                    } catch (java.security.PrivilegedActionException pae) {</span>
<span class="nc" id="L912">                        continue;</span>
<span class="nc" id="L913">                    } catch (MalformedURLException e) {</span>
<span class="nc" id="L914">                        continue;</span>
<span class="fc" id="L915">                    }</span>


                    /* Note that the addition of the url to the list of visited
                     * jars incorporates a check for presence in the hashmap
                     */
<span class="fc bfc" id="L921" title="All 2 branches covered.">                    boolean visitedURL = !visited.add(URLUtil.urlNoFragString(url));</span>
<span class="fc bfc" id="L922" title="All 2 branches covered.">                    if (!visitedURL) {</span>
                        try {
<span class="fc" id="L924">                            newLoader.ensureOpen();</span>
<span class="nc" id="L925">                        } catch (IOException e) {</span>
<span class="nc" id="L926">                            throw new InternalError(e);</span>
<span class="fc" id="L927">                        }</span>
<span class="fc" id="L928">                        final JarEntry entry = newLoader.jar.getJarEntry(name);</span>
<span class="fc bfc" id="L929" title="All 2 branches covered.">                        if (entry != null) {</span>
<span class="fc" id="L930">                            return newLoader.checkResource(name, check, entry);</span>
                        }

                        /* Verify that at least one other resource with the
                         * same package name as the lookedup resource is
                         * present in the new jar
                         */
<span class="pc bpc" id="L937" title="1 of 2 branches missed.">                        if (!newLoader.validIndex(name)) {</span>
                            /* the mapping is wrong */
<span class="nc" id="L939">                            throw new InvalidJarIndexException(&quot;Invalid index&quot;);</span>
                        }
                    }

                    /* If newLoader is the current loader or if it is a
                     * loader that has already been searched or if the new
                     * loader does not have an index then skip it
                     * and move on to the next loader.
                     */
<span class="fc bfc" id="L948" title="All 4 branches covered.">                    if (visitedURL || newLoader == this ||</span>
<span class="pc bpc" id="L949" title="1 of 2 branches missed.">                            newLoader.getIndex() == null) {</span>
<span class="nc" id="L950">                        continue;</span>
                    }

                    /* Process the index of the new loader
                     */
<span class="pc bpc" id="L955" title="1 of 2 branches missed.">                    if((res = newLoader.getResource(name, check, visited))</span>
                            != null) {
<span class="fc" id="L957">                        return res;</span>
                    }
<span class="nc" id="L959">                }</span>
                // Get the list of jar files again as the list could have grown
                // due to merging of index files.
<span class="nc" id="L962">                jarFilesList = index.get(name);</span>

            // If the count is unchanged, we are done.
<span class="nc bnc" id="L965" title="All 2 branches missed.">            } while(count &lt; jarFilesList.size());</span>
<span class="nc" id="L966">            return null;</span>
        }


        /*
         * Returns the JAR file local class path, or null if none.
         */
        URL[] getClassPath() throws IOException {
<span class="fc bfc" id="L974" title="All 2 branches covered.">            if (index != null) {</span>
<span class="fc" id="L975">                return null;</span>
            }

<span class="fc bfc" id="L978" title="All 2 branches covered.">            if (metaIndex != null) {</span>
<span class="fc" id="L979">                return null;</span>
            }

<span class="fc" id="L982">            ensureOpen();</span>
<span class="fc" id="L983">            parseExtensionsDependencies();</span>

<span class="fc bfc" id="L985" title="All 2 branches covered.">            if (SharedSecrets.javaUtilJarAccess().jarFileHasClassPathAttribute(jar)) { // Only get manifest when necessary</span>
<span class="fc" id="L986">                Manifest man = jar.getManifest();</span>
<span class="pc bpc" id="L987" title="1 of 2 branches missed.">                if (man != null) {</span>
<span class="fc" id="L988">                    Attributes attr = man.getMainAttributes();</span>
<span class="pc bpc" id="L989" title="1 of 2 branches missed.">                    if (attr != null) {</span>
<span class="fc" id="L990">                        String value = attr.getValue(Name.CLASS_PATH);</span>
<span class="pc bpc" id="L991" title="1 of 2 branches missed.">                        if (value != null) {</span>
<span class="fc" id="L992">                            return parseClassPath(csu, value);</span>
                        }
                    }
                }
            }
<span class="fc" id="L997">            return null;</span>
        }

        /*
         * parse the standard extension dependencies
         */
        private void  parseExtensionsDependencies() throws IOException {
<span class="fc" id="L1004">            ExtensionDependency.checkExtensionsDependencies(jar);</span>
<span class="fc" id="L1005">        }</span>

        /*
         * Parses value of the Class-Path manifest attribute and returns
         * an array of URLs relative to the specified base URL.
         */
        private URL[] parseClassPath(URL base, String value)
            throws MalformedURLException
        {
<span class="fc" id="L1014">            StringTokenizer st = new StringTokenizer(value);</span>
<span class="fc" id="L1015">            URL[] urls = new URL[st.countTokens()];</span>
<span class="fc" id="L1016">            int i = 0;</span>
<span class="fc bfc" id="L1017" title="All 2 branches covered.">            while (st.hasMoreTokens()) {</span>
<span class="fc" id="L1018">                String path = st.nextToken();</span>
<span class="fc" id="L1019">                urls[i] = new URL(base, path);</span>
<span class="fc" id="L1020">                i++;</span>
<span class="fc" id="L1021">            }</span>
<span class="fc" id="L1022">            return urls;</span>
        }
    }

    /*
     * Inner class used to represent a loader of classes and resources
     * from a file URL that refers to a directory.
     */
    private static class FileLoader extends Loader {
        /* Canonicalized File */
        private File dir;

        FileLoader(URL url) throws IOException {
<span class="fc" id="L1035">            super(url);</span>
<span class="pc bpc" id="L1036" title="1 of 2 branches missed.">            if (!&quot;file&quot;.equals(url.getProtocol())) {</span>
<span class="nc" id="L1037">                throw new IllegalArgumentException(&quot;url&quot;);</span>
            }
<span class="fc" id="L1039">            String path = url.getFile().replace('/', File.separatorChar);</span>
<span class="fc" id="L1040">            path = ParseUtil.decode(path);</span>
<span class="fc" id="L1041">            dir = (new File(path)).getCanonicalFile();</span>
<span class="fc" id="L1042">        }</span>

        /*
         * Returns the URL for a resource with the specified name
         */
        URL findResource(final String name, boolean check) {
<span class="fc" id="L1048">            Resource rsc = getResource(name, check);</span>
<span class="fc bfc" id="L1049" title="All 2 branches covered.">            if (rsc != null) {</span>
<span class="fc" id="L1050">                return rsc.getURL();</span>
            }
<span class="fc" id="L1052">            return null;</span>
        }

        Resource getResource(final String name, boolean check) {
            final URL url;
            try {
<span class="fc" id="L1058">                URL normalizedBase = new URL(getBaseURL(), &quot;.&quot;);</span>
<span class="fc" id="L1059">                url = new URL(getBaseURL(), ParseUtil.encodePath(name, false));</span>

<span class="pc bpc" id="L1061" title="1 of 2 branches missed.">                if (url.getFile().startsWith(normalizedBase.getFile()) == false) {</span>
                    // requested resource had ../..'s in path
<span class="nc" id="L1063">                    return null;</span>
                }

<span class="fc bfc" id="L1066" title="All 2 branches covered.">                if (check)</span>
<span class="fc" id="L1067">                    URLClassPath.check(url);</span>

                final File file;
<span class="pc bpc" id="L1070" title="1 of 2 branches missed.">                if (name.indexOf(&quot;..&quot;) != -1) {</span>
<span class="nc" id="L1071">                    file = (new File(dir, name.replace('/', File.separatorChar)))</span>
<span class="nc" id="L1072">                          .getCanonicalFile();</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">                    if ( !((file.getPath()).startsWith(dir.getPath())) ) {</span>
                        /* outside of base dir */
<span class="nc" id="L1075">                        return null;</span>
                    }
                } else {
<span class="fc" id="L1078">                    file = new File(dir, name.replace('/', File.separatorChar));</span>
                }

<span class="fc bfc" id="L1081" title="All 2 branches covered.">                if (file.exists()) {</span>
<span class="fc" id="L1082">                    return new Resource() {</span>
<span class="nc" id="L1083">                        public String getName() { return name; };</span>
<span class="fc" id="L1084">                        public URL getURL() { return url; };</span>
<span class="fc" id="L1085">                        public URL getCodeSourceURL() { return getBaseURL(); };</span>
                        public InputStream getInputStream() throws IOException
<span class="fc" id="L1087">                            { return new FileInputStream(file); };</span>
                        public int getContentLength() throws IOException
<span class="fc" id="L1089">                            { return (int)file.length(); };</span>
                    };
                }
<span class="nc" id="L1092">            } catch (Exception e) {</span>
<span class="nc" id="L1093">                return null;</span>
<span class="fc" id="L1094">            }</span>
<span class="fc" id="L1095">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>