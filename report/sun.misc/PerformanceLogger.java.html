<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PerformanceLogger.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.misc</a> &gt; <span class="el_source">PerformanceLogger.java</span></div><h1>PerformanceLogger.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2002, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */



package sun.misc;

import java.util.Vector;
import java.io.FileWriter;
import java.io.File;
import java.io.OutputStreamWriter;
import java.io.Writer;

/**
 * This class is intended to be a central place for the jdk to
 * log timing events of interest.  There is pre-defined event
 * of startTime, as well as a general
 * mechanism of setting arbitrary times in an array.
 * All unreserved times in the array can be used by callers
 * in application-defined situations.  The caller is responsible
 * for setting and getting all times and for doing whatever
 * analysis is interesting; this class is merely a central container
 * for those timing values.
 * Note that, due to the variables in this class being static,
 * use of particular time values by multiple applets will cause
 * confusing results.  For example, if plugin runs two applets
 * simultaneously, the initTime for those applets will collide
 * and the results may be undefined.
 * &lt;P&gt;
 * To automatically track startup performance in an app or applet,
 * use the command-line parameter sun.perflog as follows:&lt;BR&gt;
 *     -Dsun.perflog[=file:&lt;filename&gt;]
 * &lt;BR&gt;
 * where simply using the parameter with no value will enable output
 * to the console and a value of &quot;file:&lt;filename&gt;&quot; will cause
 * that given filename to be created and used for all output.
 * &lt;P&gt;
 * By default, times are measured using System.currentTimeMillis().  To use
 * System.nanoTime() instead, add the command-line parameter:&lt;BR&gt;
       -Dsun.perflog.nano=true
 * &lt;BR&gt;
 * &lt;P&gt;
 * &lt;B&gt;Warning: Use at your own risk!&lt;/B&gt;
 * This class is intended for internal testing
 * purposes only and may be removed at any time.  More
 * permanent monitoring and profiling APIs are expected to be
 * developed for future releases and this class will cease to
 * exist once those APIs are in place.
 * @author Chet Haase
 */
<span class="nc" id="L73">public class PerformanceLogger {</span>

    // Timing values of global interest
    private static final int START_INDEX    = 0;    // VM start
    private static final int LAST_RESERVED  = START_INDEX;

<span class="fc" id="L79">    private static boolean perfLoggingOn = false;</span>
<span class="fc" id="L80">    private static boolean useNanoTime = false;</span>
    private static Vector&lt;TimeData&gt; times;
<span class="fc" id="L82">    private static String logFileName = null;</span>
<span class="fc" id="L83">    private static Writer logWriter = null;</span>
    private static long baseTime;

    static {
<span class="fc" id="L87">        String perfLoggingProp =</span>
<span class="fc" id="L88">            java.security.AccessController.doPrivileged(</span>
            new sun.security.action.GetPropertyAction(&quot;sun.perflog&quot;));
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (perfLoggingProp != null) {</span>
<span class="nc" id="L91">            perfLoggingOn = true;</span>

            // Check if we should use nanoTime
<span class="nc" id="L94">            String perfNanoProp =</span>
<span class="nc" id="L95">                java.security.AccessController.doPrivileged(</span>
                new sun.security.action.GetPropertyAction(&quot;sun.perflog.nano&quot;));
<span class="nc bnc" id="L97" title="All 2 branches missed.">            if (perfNanoProp != null) {</span>
<span class="nc" id="L98">                useNanoTime = true;</span>
            }

            // Now, figure out what the user wants to do with the data
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (perfLoggingProp.regionMatches(true, 0, &quot;file:&quot;, 0, 5)) {</span>
<span class="nc" id="L103">                logFileName = perfLoggingProp.substring(5);</span>
            }
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (logFileName != null) {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if (logWriter == null) {</span>
<span class="nc" id="L107">                    java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L108">                    new java.security.PrivilegedAction&lt;Void&gt;() {</span>
                        public Void run() {
                            try {
<span class="nc" id="L111">                                File logFile = new File(logFileName);</span>
<span class="nc" id="L112">                                logFile.createNewFile();</span>
<span class="nc" id="L113">                                logWriter = new FileWriter(logFile);</span>
<span class="nc" id="L114">                            } catch (Exception e) {</span>
<span class="nc" id="L115">                                System.out.println(e + &quot;: Creating logfile &quot; +</span>
<span class="nc" id="L116">                                                   logFileName +</span>
                                                   &quot;.  Log to console&quot;);
<span class="nc" id="L118">                            }</span>
<span class="nc" id="L119">                            return null;</span>
                        }
                    });
                }
            }
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (logWriter == null) {</span>
<span class="nc" id="L125">                logWriter = new OutputStreamWriter(System.out);</span>
            }
        }
<span class="fc" id="L128">        times = new Vector&lt;TimeData&gt;(10);</span>
        // Reserve predefined slots
<span class="fc bfc" id="L130" title="All 2 branches covered.">        for (int i = 0; i &lt;= LAST_RESERVED; ++i) {</span>
<span class="fc" id="L131">            times.add(new TimeData(&quot;Time &quot; + i + &quot; not set&quot;, 0));</span>
        }
<span class="fc" id="L133">    }</span>

    /**
     * Returns status of whether logging is enabled or not.  This is
     * provided as a convenience method so that users do not have to
     * perform the same GetPropertyAction check as above to determine whether
     * to enable performance logging.
     */
    public static boolean loggingEnabled() {
<span class="fc" id="L142">        return perfLoggingOn;</span>
    }


    /**
     * Internal class used to store time/message data together.
     */
<span class="nc" id="L149">    static class TimeData {</span>
        String message;
        long time;

<span class="fc" id="L153">        TimeData(String message, long time) {</span>
<span class="fc" id="L154">            this.message = message;</span>
<span class="fc" id="L155">            this.time = time;</span>
<span class="fc" id="L156">        }</span>

        String getMessage() {
<span class="nc" id="L159">            return message;</span>
        }

        long getTime() {
<span class="nc" id="L163">            return time;</span>
        }
    }

    /**
     * Return the current time, in millis or nanos as appropriate
     */
    private static long getCurrentTime() {
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (useNanoTime) {</span>
<span class="nc" id="L172">            return System.nanoTime();</span>
        } else {
<span class="nc" id="L174">            return System.currentTimeMillis();</span>
        }
    }

    /**
     * Sets the start time.  Ideally, this is the earliest time available
     * during the startup of a Java applet or application.  This time is
     * later used to analyze the difference between the initial startup
     * time and other events in the system (such as an applet's init time).
     */
    public static void setStartTime(String message) {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (loggingEnabled()) {</span>
<span class="nc" id="L186">            long nowTime = getCurrentTime();</span>
<span class="nc" id="L187">            setStartTime(message, nowTime);</span>
        }
<span class="nc" id="L189">    }</span>

    /**
     * Sets the base time, output can then
     * be displayed as offsets from the base time;.
     */
    public static void setBaseTime(long time) {
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (loggingEnabled()) {</span>
<span class="nc" id="L197">            baseTime = time;</span>
        }
<span class="nc" id="L199">    }</span>

    /**
     * Sets the start time.
     * This version of the method is
     * given the time to log, instead of expecting this method to
     * get the time itself.  This is done in case the time was
     * recorded much earlier than this method was called.
     */
    public static void setStartTime(String message, long time) {
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (loggingEnabled()) {</span>
<span class="nc" id="L210">            times.set(START_INDEX, new TimeData(message, time));</span>
        }
<span class="nc" id="L212">    }</span>

    /**
     * Gets the start time, which should be the time when
     * the java process started, prior to the VM actually being
     * loaded.
     */
    public static long getStartTime() {
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (loggingEnabled()) {</span>
<span class="nc" id="L221">            return times.get(START_INDEX).getTime();</span>
        } else {
<span class="nc" id="L223">            return 0;</span>
        }
    }

    /**
     * Sets the value of a given time and returns the index of the
     * slot that that time was stored in.
     */
    public static int setTime(String message) {
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (loggingEnabled()) {</span>
<span class="nc" id="L233">            long nowTime = getCurrentTime();</span>
<span class="nc" id="L234">            return setTime(message, nowTime);</span>
        } else {
<span class="nc" id="L236">            return 0;</span>
        }
    }

    /**
     * Sets the value of a given time and returns the index of the
     * slot that that time was stored in.
     * This version of the method is
     * given the time to log, instead of expecting this method to
     * get the time itself.  This is done in case the time was
     * recorded much earlier than this method was called.
     */
    public static int setTime(String message, long time) {
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (loggingEnabled()) {</span>
            // times is already synchronized, but we need to ensure that
            // the size used in times.set() is the same used when returning
            // the index of that operation.
<span class="nc" id="L253">            synchronized (times) {</span>
<span class="nc" id="L254">                times.add(new TimeData(message, time));</span>
<span class="nc" id="L255">                return (times.size() - 1);</span>
<span class="nc" id="L256">            }</span>
        } else {
<span class="nc" id="L258">            return 0;</span>
        }
    }

    /**
     * Returns time at given index.
     */
    public static long getTimeAtIndex(int index) {
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (loggingEnabled()) {</span>
<span class="nc" id="L267">            return times.get(index).getTime();</span>
        } else {
<span class="nc" id="L269">            return 0;</span>
        }
    }

    /**
     * Returns message at given index.
     */
    public static String getMessageAtIndex(int index) {
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (loggingEnabled()) {</span>
<span class="nc" id="L278">            return times.get(index).getMessage();</span>
        } else {
<span class="nc" id="L280">            return null;</span>
        }
    }

    /**
     * Outputs all data to parameter-specified Writer object
     */
    public static void outputLog(Writer writer) {
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (loggingEnabled()) {</span>
            try {
<span class="nc" id="L290">                synchronized(times) {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">                    for (int i = 0; i &lt; times.size(); ++i) {</span>
<span class="nc" id="L292">                        TimeData td = times.get(i);</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">                        if (td != null) {</span>
<span class="nc" id="L294">                            writer.write(i + &quot; &quot; + td.getMessage() + &quot;: &quot; +</span>
<span class="nc" id="L295">                                         (td.getTime() - baseTime) + &quot;\n&quot;);</span>

                        }
                    }
<span class="nc" id="L299">                }</span>
<span class="nc" id="L300">                writer.flush();</span>
<span class="nc" id="L301">            } catch (Exception e) {</span>
<span class="nc" id="L302">                System.out.println(e + &quot;: Writing performance log to &quot; +</span>
                                   writer);
<span class="nc" id="L304">            }</span>
        }
<span class="nc" id="L306">    }</span>

    /**
     * Outputs all data to whatever location the user specified
     * via sun.perflog command-line parameter.
     */
    public static void outputLog() {
<span class="nc" id="L313">        outputLog(logWriter);</span>
<span class="nc" id="L314">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>