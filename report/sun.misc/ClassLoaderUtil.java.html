<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>ClassLoaderUtil.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.misc</a> &gt; <span class="el_source">ClassLoaderUtil.java</span></div><h1>ClassLoaderUtil.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2006, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.misc;

/**
 * Provides utility functions related to URLClassLoaders or subclasses of it.
 *
 *                  W  A  R  N  I  N  G
 *
 * This class uses undocumented, unpublished, private data structures inside
 * java.net.URLClassLoader and sun.misc.URLClassPath.  Use with extreme caution.
 *
 * @author      tjquinn
 */


import java.io.IOException;
import java.net.URLClassLoader;
import java.util.*;
import java.util.jar.JarFile;

<span class="nc" id="L45">public class ClassLoaderUtil {</span>

    /**
     * Releases resources held by a URLClassLoader. A new classloader must
     * be created before the underlying resources can be accessed again.
     * @param classLoader the instance of URLClassLoader (or a subclass)
     */
    public static void releaseLoader(URLClassLoader classLoader) {
<span class="nc" id="L53">        releaseLoader(classLoader, null);</span>
<span class="nc" id="L54">    }</span>

    /**
     * Releases resources held by a URLClassLoader.  Notably, close the jars
     * opened by the loader. Initializes and updates the List of
     * jars that have been successfully closed.
     * &lt;p&gt;
     * @param classLoader the instance of URLClassLoader (or a subclass)
     * @param jarsClosed a List of Strings that will contain the names of jars
     *  successfully closed; can be null if the caller does not need the information returned
     * @return a List of IOExceptions reporting jars that failed to close; null
     * indicates that an error other than an IOException occurred attempting to
     * release the loader; empty indicates a successful release; non-empty
     * indicates at least one error attempting to close an open jar.
     */
    public static List&lt;IOException&gt; releaseLoader(URLClassLoader classLoader, List&lt;String&gt; jarsClosed) {

<span class="nc" id="L71">        List&lt;IOException&gt; ioExceptions = new LinkedList&lt;IOException&gt;();</span>

        try {
            /* Records all IOExceptions thrown while closing jar files. */

<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (jarsClosed != null) {</span>
<span class="nc" id="L77">                jarsClosed.clear();</span>
            }

<span class="nc" id="L80">            URLClassPath ucp = SharedSecrets.getJavaNetAccess()</span>
<span class="nc" id="L81">                                                .getURLClassPath(classLoader);</span>
<span class="nc" id="L82">            ArrayList&lt;?&gt; loaders = ucp.loaders;</span>
<span class="nc" id="L83">            Stack&lt;?&gt; urls = ucp.urls;</span>
<span class="nc" id="L84">            HashMap&lt;?,?&gt; lmap = ucp.lmap;</span>

            /*
             *The urls variable in the URLClassPath object holds URLs that have not yet
             *been used to resolve a resource or load a class and, therefore, do
             *not yet have a loader associated with them.  Clear the stack so any
             *future requests that might incorrectly reach the loader cannot be
             *resolved and cannot open a jar file after we think we've closed
             *them all.
             */
<span class="nc" id="L94">            synchronized(urls) {</span>
<span class="nc" id="L95">                urls.clear();</span>
<span class="nc" id="L96">            }</span>

            /*
             *Also clear the map of URLs to loaders so the class loader cannot use
             *previously-opened jar files - they are about to be closed.
             */
<span class="nc" id="L102">            synchronized(lmap) {</span>
<span class="nc" id="L103">                lmap.clear();</span>
<span class="nc" id="L104">            }</span>

            /*
             *The URLClassPath object's path variable records the list of all URLs that are on
             *the URLClassPath's class path.  Leave that unchanged.  This might
             *help someone trying to debug why a released class loader is still used.
             *Because the stack and lmap are now clear, code that incorrectly uses a
             *the released class loader will trigger an exception if the
             *class or resource would have been resolved by the class
             *loader (and no other) if it had not been released.
             *
             *The list of URLs might provide some hints to the person as to where
             *in the code the class loader was set up, which might in turn suggest
             *where in the code the class loader needs to stop being used.
             *The URLClassPath does not use the path variable to open new jar
             *files - it uses the urls Stack for that - so leaving the path variable
             *will not by itself allow the class loader to continue handling requests.
             */

            /*
             *For each loader, close the jar file associated with that loader.
             *
             *The URLClassPath's use of loaders is sync-ed on the entire URLClassPath
             *object.
             */
<span class="nc" id="L129">            synchronized (ucp) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                for (Object o : loaders) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                    if (o != null) {</span>
                        /*
                         *If the loader is a JarLoader inner class and its jarFile
                         *field is non-null then try to close that jar file.  Add
                         *it to the list of closed files if successful.
                         */
<span class="nc bnc" id="L137" title="All 2 branches missed.">                        if (o instanceof URLClassPath.JarLoader) {</span>
<span class="nc" id="L138">                                URLClassPath.JarLoader jl = (URLClassPath.JarLoader)o;</span>
<span class="nc" id="L139">                                JarFile jarFile = jl.getJarFile();</span>
                                try {
<span class="nc bnc" id="L141" title="All 2 branches missed.">                                    if (jarFile != null) {</span>
<span class="nc" id="L142">                                        jarFile.close();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                                        if (jarsClosed != null) {</span>
<span class="nc" id="L144">                                            jarsClosed.add(jarFile.getName());</span>
                                        }
                                    }
<span class="nc" id="L147">                                } catch (IOException ioe) {</span>
                                    /*
                                     *Wrap the IOException to identify which jar
                                     *could not be closed and add it to the list
                                     *of IOExceptions to be returned to the caller.
                                     */
<span class="nc bnc" id="L153" title="All 2 branches missed.">                                    String jarFileName = (jarFile == null) ? &quot;filename not available&quot;:jarFile.getName();</span>
<span class="nc" id="L154">                                    String msg = &quot;Error closing JAR file: &quot; + jarFileName;</span>
<span class="nc" id="L155">                                    IOException newIOE = new IOException(msg);</span>
<span class="nc" id="L156">                                    newIOE.initCause(ioe);</span>
<span class="nc" id="L157">                                    ioExceptions.add(newIOE);</span>
<span class="nc" id="L158">                                }</span>
                        }
                    }
<span class="nc" id="L161">                }</span>
                /*
                 *Now clear the loaders ArrayList.
                 */
<span class="nc" id="L165">                loaders.clear();</span>
<span class="nc" id="L166">            }</span>
<span class="nc" id="L167">        } catch (Throwable t) {</span>
<span class="nc" id="L168">            throw new RuntimeException (t);</span>
<span class="nc" id="L169">        }</span>
<span class="nc" id="L170">        return ioExceptions;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>