<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Launcher.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.misc</a> &gt; <span class="el_source">Launcher.java</span></div><h1>Launcher.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1998, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.misc;

import java.io.File;
import java.io.IOException;
import java.io.FilePermission;
import java.net.URL;
import java.net.URLClassLoader;
import java.net.MalformedURLException;
import java.net.URLStreamHandler;
import java.net.URLStreamHandlerFactory;
import java.util.HashSet;
import java.util.StringTokenizer;
import java.util.Set;
import java.util.Vector;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.security.PrivilegedExceptionAction;
import java.security.AccessControlContext;
import java.security.PermissionCollection;
import java.security.Permissions;
import java.security.Permission;
import java.security.ProtectionDomain;
import java.security.CodeSource;
import sun.security.util.SecurityConstants;
import sun.net.www.ParseUtil;

/**
 * This class is used by the system to launch the main application.
Launcher */
public class Launcher {
<span class="fc" id="L56">    private static URLStreamHandlerFactory factory = new Factory();</span>
<span class="fc" id="L57">    private static Launcher launcher = new Launcher();</span>
<span class="fc" id="L58">    private static String bootClassPath =</span>
<span class="fc" id="L59">        System.getProperty(&quot;sun.boot.class.path&quot;);</span>

    public static Launcher getLauncher() {
<span class="fc" id="L62">        return launcher;</span>
    }

    private ClassLoader loader;

<span class="fc" id="L67">    public Launcher() {</span>
        // Create the extension class loader
        ClassLoader extcl;
        try {
<span class="fc" id="L71">            extcl = ExtClassLoader.getExtClassLoader();</span>
<span class="nc" id="L72">        } catch (IOException e) {</span>
<span class="nc" id="L73">            throw new InternalError(</span>
                &quot;Could not create extension class loader&quot;, e);
<span class="fc" id="L75">        }</span>

        // Now create the class loader to use to launch the application
        try {
<span class="fc" id="L79">            loader = AppClassLoader.getAppClassLoader(extcl);</span>
<span class="nc" id="L80">        } catch (IOException e) {</span>
<span class="nc" id="L81">            throw new InternalError(</span>
                &quot;Could not create application class loader&quot;, e);
<span class="fc" id="L83">        }</span>

        // Also set the context class loader for the primordial thread.
<span class="fc" id="L86">        Thread.currentThread().setContextClassLoader(loader);</span>

        // Finally, install a security manager if requested
<span class="fc" id="L89">        String s = System.getProperty(&quot;java.security.manager&quot;);</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (s != null) {</span>
<span class="fc" id="L91">            SecurityManager sm = null;</span>
<span class="fc bfc" id="L92" title="All 4 branches covered.">            if (&quot;&quot;.equals(s) || &quot;default&quot;.equals(s)) {</span>
<span class="fc" id="L93">                sm = new java.lang.SecurityManager();</span>
            } else {
                try {
<span class="fc" id="L96">                    sm = (SecurityManager)loader.loadClass(s).newInstance();</span>
<span class="nc" id="L97">                } catch (IllegalAccessException e) {</span>
<span class="nc" id="L98">                } catch (InstantiationException e) {</span>
<span class="nc" id="L99">                } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L100">                } catch (ClassCastException e) {</span>
<span class="pc" id="L101">                }</span>
            }
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">            if (sm != null) {</span>
<span class="fc" id="L104">                System.setSecurityManager(sm);</span>
            } else {
<span class="nc" id="L106">                throw new InternalError(</span>
                    &quot;Could not create SecurityManager: &quot; + s);
            }
        }
<span class="fc" id="L110">    }</span>

    /*
     * Returns the class loader used to launch the main application.
     */
    public ClassLoader getClassLoader() {
<span class="fc" id="L116">        return loader;</span>
    }

    /*
     * The class loader used for loading installed extensions.
     */
    static class ExtClassLoader extends URLClassLoader {

        static {
<span class="fc" id="L125">            ClassLoader.registerAsParallelCapable();</span>
<span class="fc" id="L126">        }</span>

        /**
         * create an ExtClassLoader. The ExtClassLoader is created
         * within a context that limits which files it can read
         */
        public static ExtClassLoader getExtClassLoader() throws IOException
        {
<span class="fc" id="L134">            final File[] dirs = getExtDirs();</span>

            try {
                // Prior implementations of this doPrivileged() block supplied
                // aa synthesized ACC via a call to the private method
                // ExtClassLoader.getContext().

<span class="fc" id="L141">                return AccessController.doPrivileged(</span>
<span class="fc" id="L142">                    new PrivilegedExceptionAction&lt;ExtClassLoader&gt;() {</span>
                        public ExtClassLoader run() throws IOException {
<span class="fc" id="L144">                            int len = dirs.length;</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">                            for (int i = 0; i &lt; len; i++) {</span>
<span class="fc" id="L146">                                MetaIndex.registerDirectory(dirs[i]);</span>
                            }
<span class="fc" id="L148">                            return new ExtClassLoader(dirs);</span>
                        }
                    });
<span class="nc" id="L151">            } catch (java.security.PrivilegedActionException e) {</span>
<span class="nc" id="L152">                throw (IOException) e.getException();</span>
            }
        }

        void addExtURL(URL url) {
<span class="nc" id="L157">            super.addURL(url);</span>
<span class="nc" id="L158">        }</span>

        /*
         * Creates a new ExtClassLoader for the specified directories.
         */
        public ExtClassLoader(File[] dirs) throws IOException {
<span class="fc" id="L164">            super(getExtURLs(dirs), null, factory);</span>
<span class="fc" id="L165">        }</span>

        private static File[] getExtDirs() {
<span class="fc" id="L168">            String s = System.getProperty(&quot;java.ext.dirs&quot;);</span>
            File[] dirs;
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">            if (s != null) {</span>
<span class="fc" id="L171">                StringTokenizer st =</span>
                    new StringTokenizer(s, File.pathSeparator);
<span class="fc" id="L173">                int count = st.countTokens();</span>
<span class="fc" id="L174">                dirs = new File[count];</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">                for (int i = 0; i &lt; count; i++) {</span>
<span class="fc" id="L176">                    dirs[i] = new File(st.nextToken());</span>
                }
<span class="fc" id="L178">            } else {</span>
<span class="nc" id="L179">                dirs = new File[0];</span>
            }
<span class="fc" id="L181">            return dirs;</span>
        }

        private static URL[] getExtURLs(File[] dirs) throws IOException {
<span class="fc" id="L185">            Vector&lt;URL&gt; urls = new Vector&lt;URL&gt;();</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">            for (int i = 0; i &lt; dirs.length; i++) {</span>
<span class="fc" id="L187">                String[] files = dirs[i].list();</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">                if (files != null) {</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">                    for (int j = 0; j &lt; files.length; j++) {</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">                        if (!files[j].equals(&quot;meta-index&quot;)) {</span>
<span class="fc" id="L191">                            File f = new File(dirs[i], files[j]);</span>
<span class="fc" id="L192">                            urls.add(getFileURL(f));</span>
                        }
                    }
                }
            }
<span class="fc" id="L197">            URL[] ua = new URL[urls.size()];</span>
<span class="fc" id="L198">            urls.copyInto(ua);</span>
<span class="fc" id="L199">            return ua;</span>
        }

        /*
         * Searches the installed extension directories for the specified
         * library name. For each extension directory, we first look for
         * the native library in the subdirectory whose name is the value
         * of the system property &lt;code&gt;os.arch&lt;/code&gt;. Failing that, we
         * look in the extension directory itself.
         */
        public String findLibrary(String name) {
<span class="fc" id="L210">            name = System.mapLibraryName(name);</span>
<span class="fc" id="L211">            URL[] urls = super.getURLs();</span>
<span class="fc" id="L212">            File prevDir = null;</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">            for (int i = 0; i &lt; urls.length; i++) {</span>
                // Get the ext directory from the URL
<span class="fc" id="L215">                File dir = new File(urls[i].getPath()).getParentFile();</span>
<span class="pc bpc" id="L216" title="1 of 4 branches missed.">                if (dir != null &amp;&amp; !dir.equals(prevDir)) {</span>
                    // Look in architecture-specific subdirectory first
                    // Read from the saved system properties to avoid deadlock
<span class="fc" id="L219">                    String arch = VM.getSavedProperty(&quot;os.arch&quot;);</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">                    if (arch != null) {</span>
<span class="fc" id="L221">                        File file = new File(new File(dir, arch), name);</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">                        if (file.exists()) {</span>
<span class="nc" id="L223">                            return file.getAbsolutePath();</span>
                        }
                    }
                    // Then check the extension directory
<span class="fc" id="L227">                    File file = new File(dir, name);</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">                    if (file.exists()) {</span>
<span class="nc" id="L229">                        return file.getAbsolutePath();</span>
                    }
                }
<span class="fc" id="L232">                prevDir = dir;</span>
            }
<span class="fc" id="L234">            return null;</span>
        }

        private static AccessControlContext getContext(File[] dirs)
            throws IOException
        {
<span class="nc" id="L240">            PathPermissions perms =</span>
                new PathPermissions(dirs);

<span class="nc" id="L243">            ProtectionDomain domain = new ProtectionDomain(</span>
<span class="nc" id="L244">                new CodeSource(perms.getCodeBase(),</span>
                    (java.security.cert.Certificate[]) null),
                perms);

<span class="nc" id="L248">            AccessControlContext acc =</span>
                new AccessControlContext(new ProtectionDomain[] { domain });

<span class="nc" id="L251">            return acc;</span>
        }
    }

    /**
     * The class loader used for loading from java.class.path.
     * runs in a restricted security context.
     */
<span class="fc bfc" id="L259" title="All 2 branches covered.">    static class AppClassLoader extends URLClassLoader {</span>

        static {
<span class="fc" id="L262">            ClassLoader.registerAsParallelCapable();</span>
<span class="fc" id="L263">        }</span>

        public static ClassLoader getAppClassLoader(final ClassLoader extcl)
            throws IOException
        {
<span class="fc" id="L268">            final String s = System.getProperty(&quot;java.class.path&quot;);</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">            final File[] path = (s == null) ? new File[0] : getClassPath(s);</span>

            // Note: on bugid 4256530
            // Prior implementations of this doPrivileged() block supplied
            // a rather restrictive ACC via a call to the private method
            // AppClassLoader.getContext(). This proved overly restrictive
            // when loading  classes. Specifically it prevent
            // accessClassInPackage.sun.* grants from being honored.
            //
<span class="fc" id="L278">            return AccessController.doPrivileged(</span>
<span class="fc" id="L279">                new PrivilegedAction&lt;AppClassLoader&gt;() {</span>
                    public AppClassLoader run() {
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">                    URL[] urls =</span>
<span class="fc" id="L282">                        (s == null) ? new URL[0] : pathToURLs(path);</span>
<span class="fc" id="L283">                    return new AppClassLoader(urls, extcl);</span>
                }
            });
        }

        /*
         * Creates a new AppClassLoader
         */
        AppClassLoader(URL[] urls, ClassLoader parent) {
<span class="fc" id="L292">            super(urls, parent, factory);</span>
<span class="fc" id="L293">        }</span>

        /**
         * Override loadClass so we can checkPackageAccess.
         */
        public Class&lt;?&gt; loadClass(String name, boolean resolve)
            throws ClassNotFoundException
        {
<span class="fc" id="L301">            int i = name.lastIndexOf('.');</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">            if (i != -1) {</span>
<span class="fc" id="L303">                SecurityManager sm = System.getSecurityManager();</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">                if (sm != null) {</span>
<span class="fc" id="L305">                    sm.checkPackageAccess(name.substring(0, i));</span>
                }
            }
<span class="fc" id="L308">            return (super.loadClass(name, resolve));</span>
        }

        /**
         * allow any classes loaded from classpath to exit the VM.
         */
        protected PermissionCollection getPermissions(CodeSource codesource)
        {
<span class="fc" id="L316">            PermissionCollection perms = super.getPermissions(codesource);</span>
<span class="fc" id="L317">            perms.add(new RuntimePermission(&quot;exitVM&quot;));</span>
<span class="fc" id="L318">            return perms;</span>
        }

        /**
         * This class loader supports dynamic additions to the class path
         * at runtime.
         *
         * @see java.lang.instrument.Instrumentation#appendToSystemClassPathSearch
         */
        private void appendToClassPathForInstrumentation(String path) {
<span class="nc bnc" id="L328" title="All 4 branches missed.">            assert(Thread.holdsLock(this));</span>

            // addURL is a no-op if path already contains the URL
<span class="nc" id="L331">            super.addURL( getFileURL(new File(path)) );</span>
<span class="nc" id="L332">        }</span>

        /**
         * create a context that can read any directories (recursively)
         * mentioned in the class path. In the case of a jar, it has to
         * be the directory containing the jar, not just the jar, as jar
         * files might refer to other jar files.
         */

        private static AccessControlContext getContext(File[] cp)
            throws java.net.MalformedURLException
        {
<span class="nc" id="L344">            PathPermissions perms =</span>
                new PathPermissions(cp);

<span class="nc" id="L347">            ProtectionDomain domain =</span>
<span class="nc" id="L348">                new ProtectionDomain(new CodeSource(perms.getCodeBase(),</span>
                    (java.security.cert.Certificate[]) null),
                perms);

<span class="nc" id="L352">            AccessControlContext acc =</span>
                new AccessControlContext(new ProtectionDomain[] { domain });

<span class="nc" id="L355">            return acc;</span>
        }
    }

<span class="nc" id="L359">    private static class BootClassPathHolder {</span>
        static final URLClassPath bcp;
        static {
            URL[] urls;
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">            if (bootClassPath != null) {</span>
<span class="nc" id="L364">                urls = AccessController.doPrivileged(</span>
<span class="nc" id="L365">                    new PrivilegedAction&lt;URL[]&gt;() {</span>
                        public URL[] run() {
<span class="nc" id="L367">                            File[] classPath = getClassPath(bootClassPath);</span>
<span class="nc" id="L368">                            int len = classPath.length;</span>
<span class="nc" id="L369">                            Set&lt;File&gt; seenDirs = new HashSet&lt;File&gt;();</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">                            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L371">                                File curEntry = classPath[i];</span>
                                // Negative test used to properly handle
                                // nonexistent jars on boot class path
<span class="nc bnc" id="L374" title="All 2 branches missed.">                                if (!curEntry.isDirectory()) {</span>
<span class="nc" id="L375">                                    curEntry = curEntry.getParentFile();</span>
                                }
<span class="nc bnc" id="L377" title="All 4 branches missed.">                                if (curEntry != null &amp;&amp; seenDirs.add(curEntry)) {</span>
<span class="nc" id="L378">                                    MetaIndex.registerDirectory(curEntry);</span>
                                }
                            }
<span class="nc" id="L381">                            return pathToURLs(classPath);</span>
                        }
                    }
                );
            } else {
<span class="fc" id="L386">                urls = new URL[0];</span>
            }
<span class="fc" id="L388">            bcp = new URLClassPath(urls, factory);</span>
<span class="fc" id="L389">        }</span>
    }

    public static URLClassPath getBootstrapClassPath() {
<span class="fc" id="L393">        return BootClassPathHolder.bcp;</span>
    }

    private static URL[] pathToURLs(File[] path) {
<span class="fc" id="L397">        URL[] urls = new URL[path.length];</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">        for (int i = 0; i &lt; path.length; i++) {</span>
<span class="fc" id="L399">            urls[i] = getFileURL(path[i]);</span>
        }
        // DEBUG
        //for (int i = 0; i &lt; urls.length; i++) {
        //  System.out.println(&quot;urls[&quot; + i + &quot;] = &quot; + '&quot;' + urls[i] + '&quot;');
        //}
<span class="fc" id="L405">        return urls;</span>
    }

    private static File[] getClassPath(String cp) {
        File[] path;
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">        if (cp != null) {</span>
<span class="fc" id="L411">            int count = 0, maxCount = 1;</span>
<span class="fc" id="L412">            int pos = 0, lastPos = 0;</span>
            // Count the number of separators first
<span class="fc bfc" id="L414" title="All 2 branches covered.">            while ((pos = cp.indexOf(File.pathSeparator, lastPos)) != -1) {</span>
<span class="fc" id="L415">                maxCount++;</span>
<span class="fc" id="L416">                lastPos = pos + 1;</span>
            }
<span class="fc" id="L418">            path = new File[maxCount];</span>
<span class="fc" id="L419">            lastPos = pos = 0;</span>
            // Now scan for each path component
<span class="fc bfc" id="L421" title="All 2 branches covered.">            while ((pos = cp.indexOf(File.pathSeparator, lastPos)) != -1) {</span>
<span class="fc bfc" id="L422" title="All 2 branches covered.">                if (pos - lastPos &gt; 0) {</span>
<span class="fc" id="L423">                    path[count++] = new File(cp.substring(lastPos, pos));</span>
                } else {
                    // empty path component translates to &quot;.&quot;
<span class="fc" id="L426">                    path[count++] = new File(&quot;.&quot;);</span>
                }
<span class="fc" id="L428">                lastPos = pos + 1;</span>
            }
            // Make sure we include the last path component
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">            if (lastPos &lt; cp.length()) {</span>
<span class="fc" id="L432">                path[count++] = new File(cp.substring(lastPos));</span>
            } else {
<span class="nc" id="L434">                path[count++] = new File(&quot;.&quot;);</span>
            }
            // Trim array to correct size
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">            if (count != maxCount) {</span>
<span class="nc" id="L438">                File[] tmp = new File[count];</span>
<span class="nc" id="L439">                System.arraycopy(path, 0, tmp, 0, count);</span>
<span class="nc" id="L440">                path = tmp;</span>
            }
<span class="fc" id="L442">        } else {</span>
<span class="nc" id="L443">            path = new File[0];</span>
        }
        // DEBUG
        //for (int i = 0; i &lt; path.length; i++) {
        //  System.out.println(&quot;path[&quot; + i + &quot;] = &quot; + '&quot;' + path[i] + '&quot;');
        //}
<span class="fc" id="L449">        return path;</span>
    }

    private static URLStreamHandler fileHandler;

    static URL getFileURL(File file) {
        try {
<span class="fc" id="L456">            file = file.getCanonicalFile();</span>
<span class="pc" id="L457">        } catch (IOException e) {}</span>

        try {
<span class="fc" id="L460">            return ParseUtil.fileToEncodedURL(file);</span>
<span class="nc" id="L461">        } catch (MalformedURLException e) {</span>
            // Should never happen since we specify the protocol...
<span class="nc" id="L463">            throw new InternalError(e);</span>
        }
    }

    /*
     * The stream handler factory for loading system protocol handlers.
     */
<span class="fc" id="L470">    private static class Factory implements URLStreamHandlerFactory {</span>
<span class="fc" id="L471">        private static String PREFIX = &quot;sun.net.www.protocol&quot;;</span>

        public URLStreamHandler createURLStreamHandler(String protocol) {
<span class="fc" id="L474">            String name = PREFIX + &quot;.&quot; + protocol + &quot;.Handler&quot;;</span>
            try {
<span class="fc" id="L476">                Class&lt;?&gt; c = Class.forName(name);</span>
<span class="fc" id="L477">                return (URLStreamHandler)c.newInstance();</span>
<span class="nc" id="L478">            } catch (ReflectiveOperationException e) {</span>
<span class="nc" id="L479">                throw new InternalError(&quot;could not load &quot; + protocol +</span>
                                        &quot;system protocol handler&quot;, e);
            }
        }
    }
}

class PathPermissions extends PermissionCollection {
    // use serialVersionUID from JDK 1.2.2 for interoperability
    private static final long serialVersionUID = 8133287259134945693L;

    private File path[];
    private Permissions perms;

    URL codeBase;

    PathPermissions(File path[])
<span class="nc" id="L496">    {</span>
<span class="nc" id="L497">        this.path = path;</span>
<span class="nc" id="L498">        this.perms = null;</span>
<span class="nc" id="L499">        this.codeBase = null;</span>
<span class="nc" id="L500">    }</span>

    URL getCodeBase()
    {
<span class="nc" id="L504">        return codeBase;</span>
    }

    public void add(java.security.Permission permission) {
<span class="nc" id="L508">        throw new SecurityException(&quot;attempt to add a permission&quot;);</span>
    }

    private synchronized void init()
    {
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (perms != null)</span>
<span class="nc" id="L514">            return;</span>

<span class="nc" id="L516">        perms = new Permissions();</span>

        // this is needed to be able to create the classloader itself!
<span class="nc" id="L519">        perms.add(SecurityConstants.CREATE_CLASSLOADER_PERMISSION);</span>

        // add permission to read any &quot;java.*&quot; property
<span class="nc" id="L522">        perms.add(new java.util.PropertyPermission(&quot;java.*&quot;,</span>
            SecurityConstants.PROPERTY_READ_ACTION));

<span class="nc" id="L525">        AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span>
            public Void run() {
<span class="nc bnc" id="L527" title="All 2 branches missed.">                for (int i=0; i &lt; path.length; i++) {</span>
<span class="nc" id="L528">                    File f = path[i];</span>
                    String path;
                    try {
<span class="nc" id="L531">                        path = f.getCanonicalPath();</span>
<span class="nc" id="L532">                    } catch (IOException ioe) {</span>
<span class="nc" id="L533">                        path = f.getAbsolutePath();</span>
<span class="nc" id="L534">                    }</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                    if (i == 0) {</span>
<span class="nc" id="L536">                        codeBase = Launcher.getFileURL(new File(path));</span>
                    }
<span class="nc bnc" id="L538" title="All 2 branches missed.">                    if (f.isDirectory()) {</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">                        if (path.endsWith(File.separator)) {</span>
<span class="nc" id="L540">                            perms.add(new FilePermission(path+&quot;-&quot;,</span>
                                SecurityConstants.FILE_READ_ACTION));
                        } else {
<span class="nc" id="L543">                            perms.add(new FilePermission(</span>
                                path + File.separator+&quot;-&quot;,
                                SecurityConstants.FILE_READ_ACTION));
                        }
                    } else {
<span class="nc" id="L548">                        int endIndex = path.lastIndexOf(File.separatorChar);</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">                        if (endIndex != -1) {</span>
<span class="nc" id="L550">                            path = path.substring(0, endIndex+1) + &quot;-&quot;;</span>
<span class="nc" id="L551">                            perms.add(new FilePermission(path,</span>
                                SecurityConstants.FILE_READ_ACTION));
                        } else {
                            // XXX?
                        }
                    }
                }
<span class="nc" id="L558">                return null;</span>
            }
        });
<span class="nc" id="L561">    }</span>

    public boolean implies(java.security.Permission permission) {
<span class="nc bnc" id="L564" title="All 2 branches missed.">        if (perms == null)</span>
<span class="nc" id="L565">            init();</span>
<span class="nc" id="L566">        return perms.implies(permission);</span>
    }

    public java.util.Enumeration&lt;Permission&gt; elements() {
<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (perms == null)</span>
<span class="nc" id="L571">            init();</span>
<span class="nc" id="L572">        synchronized (perms) {</span>
<span class="nc" id="L573">            return perms.elements();</span>
<span class="nc" id="L574">        }</span>
    }

    public String toString() {
<span class="nc bnc" id="L578" title="All 2 branches missed.">        if (perms == null)</span>
<span class="nc" id="L579">            init();</span>
<span class="nc" id="L580">        return perms.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>