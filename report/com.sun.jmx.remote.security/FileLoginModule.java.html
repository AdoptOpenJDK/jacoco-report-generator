<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>FileLoginModule.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.jmx.remote.security</a> &gt; <span class="el_source">FileLoginModule.java</span></div><h1>FileLoginModule.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.jmx.remote.security;

import com.sun.jmx.mbeanserver.GetPropertyAction;
import com.sun.jmx.mbeanserver.Util;
import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FilePermission;
import java.io.IOException;
import java.security.AccessControlException;
import java.security.AccessController;
import java.util.Arrays;
import java.util.Hashtable;
import java.util.Map;
import java.util.Properties;

import javax.security.auth.*;
import javax.security.auth.callback.*;
import javax.security.auth.login.*;
import javax.security.auth.spi.*;
import javax.management.remote.JMXPrincipal;

import com.sun.jmx.remote.util.ClassLogger;
import com.sun.jmx.remote.util.EnvHelp;
import sun.management.jmxremote.ConnectorBootstrap;

/**
 * This {@link LoginModule} performs file-based authentication.
 *
 * &lt;p&gt; A supplied username and password is verified against the
 * corresponding user credentials stored in a designated password file.
 * If successful then a new {@link JMXPrincipal} is created with the
 * user's name and it is associated with the current {@link Subject}.
 * Such principals may be identified and granted management privileges in
 * the access control file for JMX remote management or in a Java security
 * policy.
 *
 * &lt;p&gt; The password file comprises a list of key-value pairs as specified in
 * {@link Properties}. The key represents a user's name and the value is its
 * associated cleartext password. By default, the following password file is
 * used:
 * &lt;pre&gt;
 *     ${java.home}/lib/management/jmxremote.password
 * &lt;/pre&gt;
 * A different password file can be specified via the &lt;code&gt;passwordFile&lt;/code&gt;
 * configuration option.
 *
 * &lt;p&gt; This module recognizes the following &lt;code&gt;Configuration&lt;/code&gt; options:
 * &lt;dl&gt;
 * &lt;dt&gt; &lt;code&gt;passwordFile&lt;/code&gt; &lt;/dt&gt;
 * &lt;dd&gt; the path to an alternative password file. It is used instead of
 *      the default password file.&lt;/dd&gt;
 *
 * &lt;dt&gt; &lt;code&gt;useFirstPass&lt;/code&gt; &lt;/dt&gt;
 * &lt;dd&gt; if &lt;code&gt;true&lt;/code&gt;, this module retrieves the username and password
 *      from the module's shared state, using &quot;javax.security.auth.login.name&quot;
 *      and &quot;javax.security.auth.login.password&quot; as the respective keys. The
 *      retrieved values are used for authentication. If authentication fails,
 *      no attempt for a retry is made, and the failure is reported back to
 *      the calling application.&lt;/dd&gt;
 *
 * &lt;dt&gt; &lt;code&gt;tryFirstPass&lt;/code&gt; &lt;/dt&gt;
 * &lt;dd&gt; if &lt;code&gt;true&lt;/code&gt;, this module retrieves the username and password
 *      from the module's shared state, using &quot;javax.security.auth.login.name&quot;
 *       and &quot;javax.security.auth.login.password&quot; as the respective keys.  The
 *      retrieved values are used for authentication. If authentication fails,
 *      the module uses the CallbackHandler to retrieve a new username and
 *      password, and another attempt to authenticate is made. If the
 *      authentication fails, the failure is reported back to the calling
 *      application.&lt;/dd&gt;
 *
 * &lt;dt&gt; &lt;code&gt;storePass&lt;/code&gt; &lt;/dt&gt;
 * &lt;dd&gt; if &lt;code&gt;true&lt;/code&gt;, this module stores the username and password
 *      obtained from the CallbackHandler in the module's shared state, using
 *      &quot;javax.security.auth.login.name&quot; and
 *      &quot;javax.security.auth.login.password&quot; as the respective keys.  This is
 *      not performed if existing values already exist for the username and
 *      password in the shared state, or if authentication fails.&lt;/dd&gt;
 *
 * &lt;dt&gt; &lt;code&gt;clearPass&lt;/code&gt; &lt;/dt&gt;
 * &lt;dd&gt; if &lt;code&gt;true&lt;/code&gt;, this module clears the username and password
 *      stored in the module's shared state after both phases of authentication
 *      (login and commit) have completed.&lt;/dd&gt;
 * &lt;/dl&gt;
 */
<span class="nc" id="L111">public class FileLoginModule implements LoginModule {</span>

    // Location of the default password file
<span class="nc" id="L114">    private static final String DEFAULT_PASSWORD_FILE_NAME =</span>
<span class="nc" id="L115">        AccessController.doPrivileged(new GetPropertyAction(&quot;java.home&quot;)) +</span>
        File.separatorChar + &quot;lib&quot; +
        File.separatorChar + &quot;management&quot; + File.separatorChar +
        ConnectorBootstrap.DefaultValues.PASSWORD_FILE_NAME;

    // Key to retrieve the stored username
    private static final String USERNAME_KEY =
        &quot;javax.security.auth.login.name&quot;;

    // Key to retrieve the stored password
    private static final String PASSWORD_KEY =
        &quot;javax.security.auth.login.password&quot;;

    // Log messages
<span class="nc" id="L129">    private static final ClassLogger logger =</span>
        new ClassLogger(&quot;javax.management.remote.misc&quot;, &quot;FileLoginModule&quot;);

    // Configurable options
<span class="nc" id="L133">    private boolean useFirstPass = false;</span>
<span class="nc" id="L134">    private boolean tryFirstPass = false;</span>
<span class="nc" id="L135">    private boolean storePass = false;</span>
<span class="nc" id="L136">    private boolean clearPass = false;</span>

    // Authentication status
<span class="nc" id="L139">    private boolean succeeded = false;</span>
<span class="nc" id="L140">    private boolean commitSucceeded = false;</span>

    // Supplied username and password
    private String username;
    private char[] password;
    private JMXPrincipal user;

    // Initial state
    private Subject subject;
    private CallbackHandler callbackHandler;
    private Map&lt;String, Object&gt; sharedState;
    private Map&lt;String, ?&gt; options;
    private String passwordFile;
    private String passwordFileDisplayName;
    private boolean userSuppliedPasswordFile;
    private boolean hasJavaHomePermission;
    private Properties userCredentials;

    /**
     * Initialize this &lt;code&gt;LoginModule&lt;/code&gt;.
     *
     * @param subject the &lt;code&gt;Subject&lt;/code&gt; to be authenticated.
     * @param callbackHandler a &lt;code&gt;CallbackHandler&lt;/code&gt; to acquire the
     *                  user's name and password.
     * @param sharedState shared &lt;code&gt;LoginModule&lt;/code&gt; state.
     * @param options options specified in the login
     *                  &lt;code&gt;Configuration&lt;/code&gt; for this particular
     *                  &lt;code&gt;LoginModule&lt;/code&gt;.
     */
    public void initialize(Subject subject, CallbackHandler callbackHandler,
                           Map&lt;String,?&gt; sharedState,
                           Map&lt;String,?&gt; options)
    {

<span class="nc" id="L174">        this.subject = subject;</span>
<span class="nc" id="L175">        this.callbackHandler = callbackHandler;</span>
<span class="nc" id="L176">        this.sharedState = Util.cast(sharedState);</span>
<span class="nc" id="L177">        this.options = options;</span>

        // initialize any configured options
<span class="nc" id="L180">        tryFirstPass =</span>
<span class="nc" id="L181">                &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;tryFirstPass&quot;));</span>
<span class="nc" id="L182">        useFirstPass =</span>
<span class="nc" id="L183">                &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;useFirstPass&quot;));</span>
<span class="nc" id="L184">        storePass =</span>
<span class="nc" id="L185">                &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;storePass&quot;));</span>
<span class="nc" id="L186">        clearPass =</span>
<span class="nc" id="L187">                &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;clearPass&quot;));</span>

<span class="nc" id="L189">        passwordFile = (String)options.get(&quot;passwordFile&quot;);</span>
<span class="nc" id="L190">        passwordFileDisplayName = passwordFile;</span>
<span class="nc" id="L191">        userSuppliedPasswordFile = true;</span>

        // set the location of the password file
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (passwordFile == null) {</span>
<span class="nc" id="L195">            passwordFile = DEFAULT_PASSWORD_FILE_NAME;</span>
<span class="nc" id="L196">            userSuppliedPasswordFile = false;</span>
            try {
<span class="nc" id="L198">                System.getProperty(&quot;java.home&quot;);</span>
<span class="nc" id="L199">                hasJavaHomePermission = true;</span>
<span class="nc" id="L200">                passwordFileDisplayName = passwordFile;</span>
<span class="nc" id="L201">            } catch (SecurityException e) {</span>
<span class="nc" id="L202">                hasJavaHomePermission = false;</span>
<span class="nc" id="L203">                passwordFileDisplayName =</span>
                        ConnectorBootstrap.DefaultValues.PASSWORD_FILE_NAME;
<span class="nc" id="L205">            }</span>
        }
<span class="nc" id="L207">    }</span>

    /**
     * Begin user authentication (Authentication Phase 1).
     *
     * &lt;p&gt; Acquire the user's name and password and verify them against
     * the corresponding credentials from the password file.
     *
     * @return true always, since this &lt;code&gt;LoginModule&lt;/code&gt;
     *          should not be ignored.
     * @exception FailedLoginException if the authentication fails.
     * @exception LoginException if this &lt;code&gt;LoginModule&lt;/code&gt;
     *          is unable to perform the authentication.
     */
    public boolean login() throws LoginException {

        try {
<span class="nc" id="L224">            loadPasswordFile();</span>
<span class="nc" id="L225">        } catch (IOException ioe) {</span>
<span class="nc" id="L226">            LoginException le = new LoginException(</span>
                    &quot;Error: unable to load the password file: &quot; +
                    passwordFileDisplayName);
<span class="nc" id="L229">            throw EnvHelp.initCause(le, ioe);</span>
<span class="nc" id="L230">        }</span>

<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (userCredentials == null) {</span>
<span class="nc" id="L233">            throw new LoginException</span>
                (&quot;Error: unable to locate the users' credentials.&quot;);
        }

<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (logger.debugOn()) {</span>
<span class="nc" id="L238">            logger.debug(&quot;login&quot;,</span>
                    &quot;Using password file: &quot; + passwordFileDisplayName);
        }

        // attempt the authentication
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (tryFirstPass) {</span>

            try {
                // attempt the authentication by getting the
                // username and password from shared state
<span class="nc" id="L248">                attemptAuthentication(true);</span>

                // authentication succeeded
<span class="nc" id="L251">                succeeded = true;</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                if (logger.debugOn()) {</span>
<span class="nc" id="L253">                    logger.debug(&quot;login&quot;,</span>
                        &quot;Authentication using cached password has succeeded&quot;);
                }
<span class="nc" id="L256">                return true;</span>

<span class="nc" id="L258">            } catch (LoginException le) {</span>
                // authentication failed -- try again below by prompting
<span class="nc" id="L260">                cleanState();</span>
<span class="nc" id="L261">                logger.debug(&quot;login&quot;,</span>
                    &quot;Authentication using cached password has failed&quot;);
<span class="nc" id="L263">            }</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">        } else if (useFirstPass) {</span>

            try {
                // attempt the authentication by getting the
                // username and password from shared state
<span class="nc" id="L270">                attemptAuthentication(true);</span>

                // authentication succeeded
<span class="nc" id="L273">                succeeded = true;</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                if (logger.debugOn()) {</span>
<span class="nc" id="L275">                    logger.debug(&quot;login&quot;,</span>
                        &quot;Authentication using cached password has succeeded&quot;);
                }
<span class="nc" id="L278">                return true;</span>

<span class="nc" id="L280">            } catch (LoginException le) {</span>
                // authentication failed
<span class="nc" id="L282">                cleanState();</span>
<span class="nc" id="L283">                logger.debug(&quot;login&quot;,</span>
                    &quot;Authentication using cached password has failed&quot;);

<span class="nc" id="L286">                throw le;</span>
            }
        }

<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (logger.debugOn()) {</span>
<span class="nc" id="L291">            logger.debug(&quot;login&quot;, &quot;Acquiring password&quot;);</span>
        }

        // attempt the authentication using the supplied username and password
        try {
<span class="nc" id="L296">            attemptAuthentication(false);</span>

            // authentication succeeded
<span class="nc" id="L299">            succeeded = true;</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">            if (logger.debugOn()) {</span>
<span class="nc" id="L301">                logger.debug(&quot;login&quot;, &quot;Authentication has succeeded&quot;);</span>
            }
<span class="nc" id="L303">            return true;</span>

<span class="nc" id="L305">        } catch (LoginException le) {</span>
<span class="nc" id="L306">            cleanState();</span>
<span class="nc" id="L307">            logger.debug(&quot;login&quot;, &quot;Authentication has failed&quot;);</span>

<span class="nc" id="L309">            throw le;</span>
        }
    }

    /**
     * Complete user authentication (Authentication Phase 2).
     *
     * &lt;p&gt; This method is called if the LoginContext's
     * overall authentication has succeeded
     * (all the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL
     * LoginModules have succeeded).
     *
     * &lt;p&gt; If this LoginModule's own authentication attempt
     * succeeded (checked by retrieving the private state saved by the
     * &lt;code&gt;login&lt;/code&gt; method), then this method associates a
     * &lt;code&gt;JMXPrincipal&lt;/code&gt; with the &lt;code&gt;Subject&lt;/code&gt; located in the
     * &lt;code&gt;LoginModule&lt;/code&gt;.  If this LoginModule's own
     * authentication attempted failed, then this method removes
     * any state that was originally saved.
     *
     * @exception LoginException if the commit fails
     * @return true if this LoginModule's own login and commit
     *          attempts succeeded, or false otherwise.
     */
    public boolean commit() throws LoginException {

<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (succeeded == false) {</span>
<span class="nc" id="L336">            return false;</span>
        } else {
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if (subject.isReadOnly()) {</span>
<span class="nc" id="L339">                cleanState();</span>
<span class="nc" id="L340">                throw new LoginException(&quot;Subject is read-only&quot;);</span>
            }
            // add Principals to the Subject
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if (!subject.getPrincipals().contains(user)) {</span>
<span class="nc" id="L344">                subject.getPrincipals().add(user);</span>
            }

<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (logger.debugOn()) {</span>
<span class="nc" id="L348">                logger.debug(&quot;commit&quot;,</span>
                    &quot;Authentication has completed successfully&quot;);
            }
        }
        // in any case, clean out state
<span class="nc" id="L353">        cleanState();</span>
<span class="nc" id="L354">        commitSucceeded = true;</span>
<span class="nc" id="L355">        return true;</span>
    }

    /**
     * Abort user authentication (Authentication Phase 2).
     *
     * &lt;p&gt; This method is called if the LoginContext's overall authentication
     * failed (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL
     * LoginModules did not succeed).
     *
     * &lt;p&gt; If this LoginModule's own authentication attempt
     * succeeded (checked by retrieving the private state saved by the
     * &lt;code&gt;login&lt;/code&gt; and &lt;code&gt;commit&lt;/code&gt; methods),
     * then this method cleans up any state that was originally saved.
     *
     * @exception LoginException if the abort fails.
     * @return false if this LoginModule's own login and/or commit attempts
     *          failed, and true otherwise.
     */
    public boolean abort() throws LoginException {

<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (logger.debugOn()) {</span>
<span class="nc" id="L377">            logger.debug(&quot;abort&quot;,</span>
                &quot;Authentication has not completed successfully&quot;);
        }

<span class="nc bnc" id="L381" title="All 2 branches missed.">        if (succeeded == false) {</span>
<span class="nc" id="L382">            return false;</span>
<span class="nc bnc" id="L383" title="All 4 branches missed.">        } else if (succeeded == true &amp;&amp; commitSucceeded == false) {</span>

            // Clean out state
<span class="nc" id="L386">            succeeded = false;</span>
<span class="nc" id="L387">            cleanState();</span>
<span class="nc" id="L388">            user = null;</span>
        } else {
            // overall authentication succeeded and commit succeeded,
            // but someone else's commit failed
<span class="nc" id="L392">            logout();</span>
        }
<span class="nc" id="L394">        return true;</span>
    }

    /**
     * Logout a user.
     *
     * &lt;p&gt; This method removes the Principals
     * that were added by the &lt;code&gt;commit&lt;/code&gt; method.
     *
     * @exception LoginException if the logout fails.
     * @return true in all cases since this &lt;code&gt;LoginModule&lt;/code&gt;
     *          should not be ignored.
     */
    public boolean logout() throws LoginException {
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (subject.isReadOnly()) {</span>
<span class="nc" id="L409">            cleanState();</span>
<span class="nc" id="L410">            throw new LoginException (&quot;Subject is read-only&quot;);</span>
        }
<span class="nc" id="L412">        subject.getPrincipals().remove(user);</span>

        // clean out state
<span class="nc" id="L415">        cleanState();</span>
<span class="nc" id="L416">        succeeded = false;</span>
<span class="nc" id="L417">        commitSucceeded = false;</span>
<span class="nc" id="L418">        user = null;</span>

<span class="nc bnc" id="L420" title="All 2 branches missed.">        if (logger.debugOn()) {</span>
<span class="nc" id="L421">            logger.debug(&quot;logout&quot;, &quot;Subject is being logged out&quot;);</span>
        }

<span class="nc" id="L424">        return true;</span>
    }

    /**
     * Attempt authentication
     *
     * @param usePasswdFromSharedState a flag to tell this method whether
     *          to retrieve the password from the sharedState.
     */
    @SuppressWarnings(&quot;unchecked&quot;)  // sharedState used as Map&lt;String,Object&gt;
    private void attemptAuthentication(boolean usePasswdFromSharedState)
        throws LoginException {

        // get the username and password
<span class="nc" id="L438">        getUsernamePassword(usePasswdFromSharedState);</span>

        String localPassword;

        // userCredentials is initialized in login()
<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (((localPassword = userCredentials.getProperty(username)) == null) ||</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            (! localPassword.equals(new String(password)))) {</span>

            // username not found or passwords do not match
<span class="nc bnc" id="L447" title="All 2 branches missed.">            if (logger.debugOn()) {</span>
<span class="nc" id="L448">                logger.debug(&quot;login&quot;, &quot;Invalid username or password&quot;);</span>
            }
<span class="nc" id="L450">            throw new FailedLoginException(&quot;Invalid username or password&quot;);</span>
        }

        // Save the username and password in the shared state
        // only if authentication succeeded
<span class="nc bnc" id="L455" title="All 2 branches missed.">        if (storePass &amp;&amp;</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">            !sharedState.containsKey(USERNAME_KEY) &amp;&amp;</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">            !sharedState.containsKey(PASSWORD_KEY)) {</span>
<span class="nc" id="L458">            sharedState.put(USERNAME_KEY, username);</span>
<span class="nc" id="L459">            sharedState.put(PASSWORD_KEY, password);</span>
        }

        // Create a new user principal
<span class="nc" id="L463">        user = new JMXPrincipal(username);</span>

<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (logger.debugOn()) {</span>
<span class="nc" id="L466">            logger.debug(&quot;login&quot;,</span>
                &quot;User '&quot; + username + &quot;' successfully validated&quot;);
        }
<span class="nc" id="L469">    }</span>

    /*
     * Read the password file.
     */
    private void loadPasswordFile() throws IOException {
        FileInputStream fis;
        try {
<span class="nc" id="L477">            fis = new FileInputStream(passwordFile);</span>
<span class="nc" id="L478">        } catch (SecurityException e) {</span>
<span class="nc bnc" id="L479" title="All 4 branches missed.">            if (userSuppliedPasswordFile || hasJavaHomePermission) {</span>
<span class="nc" id="L480">                throw e;</span>
            } else {
<span class="nc" id="L482">                final FilePermission fp =</span>
                        new FilePermission(passwordFileDisplayName, &quot;read&quot;);
<span class="nc" id="L484">                AccessControlException ace = new AccessControlException(</span>
<span class="nc" id="L485">                        &quot;access denied &quot; + fp.toString());</span>
<span class="nc" id="L486">                ace.setStackTrace(e.getStackTrace());</span>
<span class="nc" id="L487">                throw ace;</span>
            }
<span class="nc" id="L489">        }</span>
        try {
<span class="nc" id="L491">            final BufferedInputStream bis = new BufferedInputStream(fis);</span>
            try {
<span class="nc" id="L493">                userCredentials = new Properties();</span>
<span class="nc" id="L494">                userCredentials.load(bis);</span>
            } finally {
<span class="nc" id="L496">                bis.close();</span>
<span class="nc" id="L497">            }</span>
        } finally {
<span class="nc" id="L499">            fis.close();</span>
<span class="nc" id="L500">        }</span>
<span class="nc" id="L501">    }</span>

    /**
     * Get the username and password.
     * This method does not return any value.
     * Instead, it sets global name and password variables.
     *
     * &lt;p&gt; Also note that this method will set the username and password
     * values in the shared state in case subsequent LoginModules
     * want to use them via use/tryFirstPass.
     *
     * @param usePasswdFromSharedState boolean that tells this method whether
     *          to retrieve the password from the sharedState.
     */
    private void getUsernamePassword(boolean usePasswdFromSharedState)
        throws LoginException {

<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (usePasswdFromSharedState) {</span>
            // use the password saved by the first module in the stack
<span class="nc" id="L520">            username = (String)sharedState.get(USERNAME_KEY);</span>
<span class="nc" id="L521">            password = (char[])sharedState.get(PASSWORD_KEY);</span>
<span class="nc" id="L522">            return;</span>
        }

        // acquire username and password
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (callbackHandler == null)</span>
<span class="nc" id="L527">            throw new LoginException(&quot;Error: no CallbackHandler available &quot; +</span>
                &quot;to garner authentication information from the user&quot;);

<span class="nc" id="L530">        Callback[] callbacks = new Callback[2];</span>
<span class="nc" id="L531">        callbacks[0] = new NameCallback(&quot;username&quot;);</span>
<span class="nc" id="L532">        callbacks[1] = new PasswordCallback(&quot;password&quot;, false);</span>

        try {
<span class="nc" id="L535">            callbackHandler.handle(callbacks);</span>
<span class="nc" id="L536">            username = ((NameCallback)callbacks[0]).getName();</span>
<span class="nc" id="L537">            char[] tmpPassword = ((PasswordCallback)callbacks[1]).getPassword();</span>
<span class="nc" id="L538">            password = new char[tmpPassword.length];</span>
<span class="nc" id="L539">            System.arraycopy(tmpPassword, 0,</span>
                                password, 0, tmpPassword.length);
<span class="nc" id="L541">            ((PasswordCallback)callbacks[1]).clearPassword();</span>

<span class="nc" id="L543">        } catch (IOException ioe) {</span>
<span class="nc" id="L544">            LoginException le = new LoginException(ioe.toString());</span>
<span class="nc" id="L545">            throw EnvHelp.initCause(le, ioe);</span>
<span class="nc" id="L546">        } catch (UnsupportedCallbackException uce) {</span>
<span class="nc" id="L547">            LoginException le = new LoginException(</span>
<span class="nc" id="L548">                                    &quot;Error: &quot; + uce.getCallback().toString() +</span>
                                    &quot; not available to garner authentication &quot; +
                                    &quot;information from the user&quot;);
<span class="nc" id="L551">            throw EnvHelp.initCause(le, uce);</span>
<span class="nc" id="L552">        }</span>
<span class="nc" id="L553">    }</span>

    /**
     * Clean out state because of a failed authentication attempt
     */
    private void cleanState() {
<span class="nc" id="L559">        username = null;</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">        if (password != null) {</span>
<span class="nc" id="L561">            Arrays.fill(password, ' ');</span>
<span class="nc" id="L562">            password = null;</span>
        }

<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (clearPass) {</span>
<span class="nc" id="L566">            sharedState.remove(USERNAME_KEY);</span>
<span class="nc" id="L567">            sharedState.remove(PASSWORD_KEY);</span>
        }
<span class="nc" id="L569">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>