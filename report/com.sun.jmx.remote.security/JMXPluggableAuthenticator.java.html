<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JMXPluggableAuthenticator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.jmx.remote.security</a> &gt; <span class="el_source">JMXPluggableAuthenticator.java</span></div><h1>JMXPluggableAuthenticator.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.jmx.remote.security;

import java.io.IOException;
import java.security.AccessController;
import java.security.Principal;
import java.security.PrivilegedAction;
import java.security.PrivilegedActionException;
import java.security.PrivilegedExceptionAction;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;
import javax.management.remote.JMXPrincipal;
import javax.management.remote.JMXAuthenticator;
import javax.security.auth.AuthPermission;
import javax.security.auth.Subject;
import javax.security.auth.callback.*;
import javax.security.auth.login.AppConfigurationEntry;
import javax.security.auth.login.Configuration;
import javax.security.auth.login.LoginContext;
import javax.security.auth.login.LoginException;
import javax.security.auth.spi.LoginModule;
import com.sun.jmx.remote.util.ClassLogger;
import com.sun.jmx.remote.util.EnvHelp;

/**
 * &lt;p&gt;This class represents a
 * &lt;a href=&quot;{@docRoot}/../guide/security/jaas/JAASRefGuide.html&quot;&gt;JAAS&lt;/a&gt;
 * based implementation of the {@link JMXAuthenticator} interface.&lt;/p&gt;
 *
 * &lt;p&gt;Authentication is performed by passing the supplied user's credentials
 * to one or more authentication mechanisms ({@link LoginModule}) for
 * verification. An authentication mechanism acquires the user's credentials
 * by calling {@link NameCallback} and/or {@link PasswordCallback}.
 * If authentication is successful then an authenticated {@link Subject}
 * filled in with a {@link Principal} is returned.  Authorization checks
 * will then be performed based on this &lt;code&gt;Subject&lt;/code&gt;.&lt;/p&gt;
 *
 * &lt;p&gt;By default, a single file-based authentication mechanism
 * {@link FileLoginModule} is configured (&lt;code&gt;FileLoginConfig&lt;/code&gt;).&lt;/p&gt;
 *
 * &lt;p&gt;To override the default configuration use the
 * &lt;code&gt;com.sun.management.jmxremote.login.config&lt;/code&gt; management property
 * described in the JRE/lib/management/management.properties file.
 * Set this property to the name of a JAAS configuration entry and ensure that
 * the entry is loaded by the installed {@link Configuration}. In addition,
 * ensure that the authentication mechanisms specified in the entry acquire
 * the user's credentials by calling {@link NameCallback} and
 * {@link PasswordCallback} and that they return a {@link Subject} filled-in
 * with a {@link Principal}, for those users that are successfully
 * authenticated.&lt;/p&gt;
 */
public final class JMXPluggableAuthenticator implements JMXAuthenticator {

    /**
     * Creates an instance of &lt;code&gt;JMXPluggableAuthenticator&lt;/code&gt;
     * and initializes it with a {@link LoginContext}.
     *
     * @param env the environment containing configuration properties for the
     *            authenticator. Can be null, which is equivalent to an empty
     *            Map.
     * @exception SecurityException if the authentication mechanism cannot be
     *            initialized.
     */
<span class="nc" id="L90">    public JMXPluggableAuthenticator(Map&lt;?, ?&gt; env) {</span>

<span class="nc" id="L92">        String loginConfigName = null;</span>
<span class="nc" id="L93">        String passwordFile = null;</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (env != null) {</span>
<span class="nc" id="L96">            loginConfigName = (String) env.get(LOGIN_CONFIG_PROP);</span>
<span class="nc" id="L97">            passwordFile = (String) env.get(PASSWORD_FILE_PROP);</span>
        }

        try {

<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (loginConfigName != null) {</span>
                // use the supplied JAAS login configuration
<span class="nc" id="L104">                loginContext =</span>
                    new LoginContext(loginConfigName, new JMXCallbackHandler());

            } else {
                // use the default JAAS login configuration (file-based)
<span class="nc" id="L109">                SecurityManager sm = System.getSecurityManager();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                if (sm != null) {</span>
<span class="nc" id="L111">                    sm.checkPermission(</span>
                            new AuthPermission(&quot;createLoginContext.&quot; +
                                               LOGIN_CONFIG_NAME));
                }

<span class="nc" id="L116">                final String pf = passwordFile;</span>
                try {
<span class="nc" id="L118">                    loginContext = AccessController.doPrivileged(</span>
<span class="nc" id="L119">                        new PrivilegedExceptionAction&lt;LoginContext&gt;() {</span>
                            public LoginContext run() throws LoginException {
<span class="nc" id="L121">                                return new LoginContext(</span>
                                                LOGIN_CONFIG_NAME,
                                                null,
                                                new JMXCallbackHandler(),
                                                new FileLoginConfig(pf));
                            }
                        });
<span class="nc" id="L128">                } catch (PrivilegedActionException pae) {</span>
<span class="nc" id="L129">                    throw (LoginException) pae.getException();</span>
<span class="nc" id="L130">                }</span>
            }

<span class="nc" id="L133">        } catch (LoginException le) {</span>
<span class="nc" id="L134">            authenticationFailure(&quot;authenticate&quot;, le);</span>

<span class="nc" id="L136">        } catch (SecurityException se) {</span>
<span class="nc" id="L137">            authenticationFailure(&quot;authenticate&quot;, se);</span>
<span class="nc" id="L138">        }</span>
<span class="nc" id="L139">    }</span>

    /**
     * Authenticate the &lt;code&gt;MBeanServerConnection&lt;/code&gt; client
     * with the given client credentials.
     *
     * @param credentials the user-defined credentials to be passed in
     * to the server in order to authenticate the user before creating
     * the &lt;code&gt;MBeanServerConnection&lt;/code&gt;.  This parameter must
     * be a two-element &lt;code&gt;String[]&lt;/code&gt; containing the client's
     * username and password in that order.
     *
     * @return the authenticated subject containing a
     * &lt;code&gt;JMXPrincipal(username)&lt;/code&gt;.
     *
     * @exception SecurityException if the server cannot authenticate the user
     * with the provided credentials.
     */
    public Subject authenticate(Object credentials) {
        // Verify that credentials is of type String[].
        //
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (!(credentials instanceof String[])) {</span>
            // Special case for null so we get a more informative message
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (credentials == null)</span>
<span class="nc" id="L163">                authenticationFailure(&quot;authenticate&quot;, &quot;Credentials required&quot;);</span>

<span class="nc" id="L165">            final String message =</span>
                &quot;Credentials should be String[] instead of &quot; +
<span class="nc" id="L167">                 credentials.getClass().getName();</span>
<span class="nc" id="L168">            authenticationFailure(&quot;authenticate&quot;, message);</span>
        }
        // Verify that the array contains two elements.
        //
<span class="nc" id="L172">        final String[] aCredentials = (String[]) credentials;</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (aCredentials.length != 2) {</span>
<span class="nc" id="L174">            final String message =</span>
                &quot;Credentials should have 2 elements not &quot; +
                aCredentials.length;
<span class="nc" id="L177">            authenticationFailure(&quot;authenticate&quot;, message);</span>
        }
        // Verify that username exists and the associated
        // password matches the one supplied by the client.
        //
<span class="nc" id="L182">        username = aCredentials[0];</span>
<span class="nc" id="L183">        password = aCredentials[1];</span>
<span class="nc bnc" id="L184" title="All 4 branches missed.">        if (username == null || password == null) {</span>
            final String message = &quot;Username or password is null&quot;;
<span class="nc" id="L186">            authenticationFailure(&quot;authenticate&quot;, message);</span>
        }

        // Perform authentication
        try {
<span class="nc" id="L191">            loginContext.login();</span>
<span class="nc" id="L192">            final Subject subject = loginContext.getSubject();</span>
<span class="nc" id="L193">            AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span>
                    public Void run() {
<span class="nc" id="L195">                        subject.setReadOnly();</span>
<span class="nc" id="L196">                        return null;</span>
                    }
                });

<span class="nc" id="L200">            return subject;</span>

<span class="nc" id="L202">        } catch (LoginException le) {</span>
<span class="nc" id="L203">            authenticationFailure(&quot;authenticate&quot;, le);</span>
        }
<span class="nc" id="L205">        return null;</span>
    }

    private static void authenticationFailure(String method, String message)
        throws SecurityException {
<span class="nc" id="L210">        final String msg = &quot;Authentication failed! &quot; + message;</span>
<span class="nc" id="L211">        final SecurityException e = new SecurityException(msg);</span>
<span class="nc" id="L212">        logException(method, msg, e);</span>
<span class="nc" id="L213">        throw e;</span>
    }

    private static void authenticationFailure(String method,
                                              Exception exception)
        throws SecurityException {
        String msg;
        SecurityException se;
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (exception instanceof SecurityException) {</span>
<span class="nc" id="L222">            msg = exception.getMessage();</span>
<span class="nc" id="L223">            se = (SecurityException) exception;</span>
        } else {
<span class="nc" id="L225">            msg = &quot;Authentication failed! &quot; + exception.getMessage();</span>
<span class="nc" id="L226">            final SecurityException e = new SecurityException(msg);</span>
<span class="nc" id="L227">            EnvHelp.initCause(e, exception);</span>
<span class="nc" id="L228">            se = e;</span>
        }
<span class="nc" id="L230">        logException(method, msg, se);</span>
<span class="nc" id="L231">        throw se;</span>
    }

    private static void logException(String method,
                                     String message,
                                     Exception e) {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (logger.traceOn()) {</span>
<span class="nc" id="L238">            logger.trace(method, message);</span>
        }
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (logger.debugOn()) {</span>
<span class="nc" id="L241">            logger.debug(method, e);</span>
        }
<span class="nc" id="L243">    }</span>

    private LoginContext loginContext;
    private String username;
    private String password;
    private static final String LOGIN_CONFIG_PROP =
        &quot;jmx.remote.x.login.config&quot;;
    private static final String LOGIN_CONFIG_NAME = &quot;JMXPluggableAuthenticator&quot;;
    private static final String PASSWORD_FILE_PROP =
        &quot;jmx.remote.x.password.file&quot;;
<span class="nc" id="L253">    private static final ClassLogger logger =</span>
        new ClassLogger(&quot;javax.management.remote.misc&quot;, LOGIN_CONFIG_NAME);

/**
 * This callback handler supplies the username and password (which was
 * originally supplied by the JMX user) to the JAAS login module performing
 * the authentication. No interactive user prompting is required because the
 * credentials are already available to this class (via its enclosing class).
 */
<span class="nc" id="L262">private final class JMXCallbackHandler implements CallbackHandler {</span>

    /**
     * Sets the username and password in the appropriate Callback object.
     */
    public void handle(Callback[] callbacks)
        throws IOException, UnsupportedCallbackException {

<span class="nc bnc" id="L270" title="All 2 branches missed.">        for (int i = 0; i &lt; callbacks.length; i++) {</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">            if (callbacks[i] instanceof NameCallback) {</span>
<span class="nc" id="L272">                ((NameCallback)callbacks[i]).setName(username);</span>

<span class="nc bnc" id="L274" title="All 2 branches missed.">            } else if (callbacks[i] instanceof PasswordCallback) {</span>
<span class="nc" id="L275">                ((PasswordCallback)callbacks[i])</span>
<span class="nc" id="L276">                    .setPassword(password.toCharArray());</span>

            } else {
<span class="nc" id="L279">                throw new UnsupportedCallbackException</span>
                    (callbacks[i], &quot;Unrecognized Callback&quot;);
            }
        }
<span class="nc" id="L283">    }</span>
}

/**
 * This class defines the JAAS configuration for file-based authentication.
 * It is equivalent to the following textual configuration entry:
 * &lt;pre&gt;
 *     JMXPluggableAuthenticator {
 *         com.sun.jmx.remote.security.FileLoginModule required;
 *     };
 * &lt;/pre&gt;
 */
private static class FileLoginConfig extends Configuration {

    // The JAAS configuration for file-based authentication
    private AppConfigurationEntry[] entries;

    // The classname of the login module for file-based authentication
<span class="nc" id="L301">    private static final String FILE_LOGIN_MODULE =</span>
<span class="nc" id="L302">        FileLoginModule.class.getName();</span>

    // The option that identifies the password file to use
    private static final String PASSWORD_FILE_OPTION = &quot;passwordFile&quot;;

    /**
     * Creates an instance of &lt;code&gt;FileLoginConfig&lt;/code&gt;
     *
     * @param passwordFile A filepath that identifies the password file to use.
     *                     If null then the default password file is used.
     */
<span class="nc" id="L313">    public FileLoginConfig(String passwordFile) {</span>

        Map&lt;String, String&gt; options;
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (passwordFile != null) {</span>
<span class="nc" id="L317">            options = new HashMap&lt;String, String&gt;(1);</span>
<span class="nc" id="L318">            options.put(PASSWORD_FILE_OPTION, passwordFile);</span>
        } else {
<span class="nc" id="L320">            options = Collections.emptyMap();</span>
        }

<span class="nc" id="L323">        entries = new AppConfigurationEntry[] {</span>
            new AppConfigurationEntry(FILE_LOGIN_MODULE,
                AppConfigurationEntry.LoginModuleControlFlag.REQUIRED,
                    options)
        };
<span class="nc" id="L328">    }</span>

    /**
     * Gets the JAAS configuration for file-based authentication
     */
    public AppConfigurationEntry[] getAppConfigurationEntry(String name) {

<span class="nc bnc" id="L335" title="All 2 branches missed.">        return name.equals(LOGIN_CONFIG_NAME) ? entries : null;</span>
    }

    /**
     * Refreshes the configuration.
     */
    public void refresh() {
        // the configuration is fixed
<span class="nc" id="L343">    }</span>
}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>