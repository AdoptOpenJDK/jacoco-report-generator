<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JLightweightFrame.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.swing</a> &gt; <span class="el_source">JLightweightFrame.java</span></div><h1>JLightweightFrame.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.swing;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Container;
import java.awt.Dimension;
import java.awt.EventQueue;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.MouseInfo;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.event.ContainerEvent;
import java.awt.event.ContainerListener;
import java.awt.image.BufferedImage;
import java.awt.image.DataBufferInt;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.security.AccessController;

import javax.swing.JLayeredPane;
import javax.swing.JPanel;
import javax.swing.JRootPane;
import javax.swing.LayoutFocusTraversalPolicy;
import javax.swing.RootPaneContainer;
import javax.swing.SwingUtilities;

import sun.awt.LightweightFrame;
import sun.security.action.GetPropertyAction;

/**
 * The frame serves as a lightweight container which paints its content
 * to an offscreen image and provides access to the image's data via the
 * {@link LightweightContent} interface. Note, that it may not be shown
 * as a standalone toplevel frame. Its purpose is to provide functionality
 * for lightweight embedding.
 *
 * @author Artem Ananiev
 * @author Anton Tarasov
 */
public final class JLightweightFrame extends LightweightFrame implements RootPaneContainer {

<span class="nc" id="L69">    private final JRootPane rootPane = new JRootPane();</span>

    private LightweightContent content;

    private Component component;
    private JPanel contentPane;

    private BufferedImage bbImage;

    /**
     * {@code copyBufferEnabled}, true by default, defines the following strategy.
     * A duplicating (copy) buffer is created for the original pixel buffer.
     * The copy buffer is synchronized with the original buffer every time the
     * latter changes. {@code JLightweightFrame} passes the copy buffer array
     * to the {@link LightweightContent#imageBufferReset} method. The code spot
     * which synchronizes two buffers becomes the only critical section guarded
     * by the lock (managed with the {@link LightweightContent#paintLock()},
     * {@link LightweightContent#paintUnlock()} methods).
     */
    private boolean copyBufferEnabled;
    private int[] copyBuffer;

    private PropertyChangeListener layoutSizeListener;

    static {
<span class="nc" id="L94">        SwingAccessor.setJLightweightFrameAccessor(new SwingAccessor.JLightweightFrameAccessor() {</span>
            @Override
            public void updateCursor(JLightweightFrame frame) {
<span class="nc" id="L97">                frame.updateClientCursor();</span>
<span class="nc" id="L98">            }</span>
        });
<span class="nc" id="L100">    }</span>

    /**
     * Constructs a new, initially invisible {@code JLightweightFrame}
     * instance.
     */
    public JLightweightFrame() {
<span class="nc" id="L107">        super();</span>
<span class="nc" id="L108">        copyBufferEnabled = &quot;true&quot;.equals(AccessController.</span>
<span class="nc" id="L109">            doPrivileged(new GetPropertyAction(&quot;swing.jlf.copyBufferEnabled&quot;, &quot;true&quot;)));</span>

<span class="nc" id="L111">        add(rootPane, BorderLayout.CENTER);</span>
<span class="nc" id="L112">        setFocusTraversalPolicy(new LayoutFocusTraversalPolicy());</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (getGraphicsConfiguration().isTranslucencyCapable()) {</span>
<span class="nc" id="L114">            setBackground(new Color(0, 0, 0, 0));</span>
        }

<span class="nc" id="L117">        layoutSizeListener = new PropertyChangeListener() {</span>
            @Override
            public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L120">                Dimension d = (Dimension)e.getNewValue();</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (&quot;preferredSize&quot;.equals(e.getPropertyName())) {</span>
<span class="nc" id="L123">                    content.preferredSizeChanged(d.width, d.height);</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">                } else if (&quot;maximumSize&quot;.equals(e.getPropertyName())) {</span>
<span class="nc" id="L126">                    content.maximumSizeChanged(d.width, d.height);</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">                } else if (&quot;minimumSize&quot;.equals(e.getPropertyName())) {</span>
<span class="nc" id="L129">                    content.minimumSizeChanged(d.width, d.height);</span>
                }
<span class="nc" id="L131">            }</span>
        };
<span class="nc" id="L133">    }</span>

    /**
     * Sets the {@link LightweightContent} instance for this frame.
     * The {@code JComponent} object returned by the
     * {@link LightweightContent#getComponent()} method is immediately
     * added to the frame's content pane.
     *
     * @param content the {@link LightweightContent} instance
     */
    public void setContent(final LightweightContent content) {
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (content == null) {</span>
<span class="nc" id="L145">            System.err.println(&quot;JLightweightFrame.setContent: content may not be null!&quot;);</span>
<span class="nc" id="L146">            return;</span>
        }
<span class="nc" id="L148">        this.content = content;</span>
<span class="nc" id="L149">        this.component = content.getComponent();</span>

<span class="nc" id="L151">        Dimension d = this.component.getPreferredSize();</span>
<span class="nc" id="L152">        content.preferredSizeChanged(d.width, d.height);</span>

<span class="nc" id="L154">        d = this.component.getMaximumSize();</span>
<span class="nc" id="L155">        content.maximumSizeChanged(d.width, d.height);</span>

<span class="nc" id="L157">        d = this.component.getMinimumSize();</span>
<span class="nc" id="L158">        content.minimumSizeChanged(d.width, d.height);</span>

<span class="nc" id="L160">        initInterior();</span>
<span class="nc" id="L161">    }</span>

    @Override
    public Graphics getGraphics() {
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (bbImage == null) return null;</span>

<span class="nc" id="L167">        Graphics2D g = bbImage.createGraphics();</span>
<span class="nc" id="L168">        g.setBackground(getBackground());</span>
<span class="nc" id="L169">        g.setColor(getForeground());</span>
<span class="nc" id="L170">        g.setFont(getFont());</span>
<span class="nc" id="L171">        return g;</span>
    }

    /**
     * {@inheritDoc}
     *
     * @see LightweightContent#focusGrabbed()
     */
    @Override
    public void grabFocus() {
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (content != null) content.focusGrabbed();</span>
<span class="nc" id="L182">    }</span>

    /**
     * {@inheritDoc}
     *
     * @see LightweightContent#focusUngrabbed()
     */
    @Override
    public void ungrabFocus() {
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (content != null) content.focusUngrabbed();</span>
<span class="nc" id="L192">    }</span>

    private void syncCopyBuffer(boolean reset, int x, int y, int w, int h) {
<span class="nc" id="L195">        content.paintLock();</span>
        try {
<span class="nc" id="L197">            int[] srcBuffer = ((DataBufferInt)bbImage.getRaster().getDataBuffer()).getData();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (reset) {</span>
<span class="nc" id="L199">                copyBuffer = new int[srcBuffer.length];</span>
            }
<span class="nc" id="L201">            int linestride = bbImage.getWidth();</span>

<span class="nc bnc" id="L203" title="All 2 branches missed.">            for (int i=0; i&lt;h; i++) {</span>
<span class="nc" id="L204">                int from = (y + i) * linestride + x;</span>
<span class="nc" id="L205">                System.arraycopy(srcBuffer, from, copyBuffer, from, w);</span>
            }
        } finally {
<span class="nc" id="L208">            content.paintUnlock();</span>
<span class="nc" id="L209">        }</span>
<span class="nc" id="L210">    }</span>

    private void initInterior() {
<span class="nc" id="L213">        contentPane = new JPanel() {</span>
            @Override
            public void paint(Graphics g) {
<span class="nc bnc" id="L216" title="All 2 branches missed.">                if (!copyBufferEnabled) {</span>
<span class="nc" id="L217">                    content.paintLock();</span>
                }
                try {
<span class="nc" id="L220">                    super.paint(g);</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">                    final Rectangle clip = g.getClipBounds() != null ?</span>
<span class="nc" id="L223">                            g.getClipBounds() :</span>
<span class="nc" id="L224">                            new Rectangle(0, 0, contentPane.getWidth(), contentPane.getHeight());</span>

<span class="nc" id="L226">                    clip.x = Math.max(0, clip.x);</span>
<span class="nc" id="L227">                    clip.y = Math.max(0, clip.y);</span>
<span class="nc" id="L228">                    clip.width = Math.min(contentPane.getWidth(), clip.width);</span>
<span class="nc" id="L229">                    clip.height = Math.min(contentPane.getHeight(), clip.height);</span>

<span class="nc" id="L231">                    EventQueue.invokeLater(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc bnc" id="L234" title="All 2 branches missed.">                            if (copyBufferEnabled) {</span>
<span class="nc" id="L235">                                syncCopyBuffer(false, clip.x, clip.y, clip.width, clip.height);</span>
                            }
<span class="nc" id="L237">                            content.imageUpdated(clip.x, clip.y, clip.width, clip.height);</span>
<span class="nc" id="L238">                        }</span>
                    });
                } finally {
<span class="nc bnc" id="L241" title="All 4 branches missed.">                    if (!copyBufferEnabled) {</span>
<span class="nc" id="L242">                        content.paintUnlock();</span>
                    }
                }
<span class="nc" id="L245">            }</span>
            @Override
            protected boolean isPaintingOrigin() {
<span class="nc" id="L248">                return true;</span>
            }
        };
<span class="nc" id="L251">        contentPane.setLayout(new BorderLayout());</span>
<span class="nc" id="L252">        contentPane.add(component);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (&quot;true&quot;.equals(AccessController.</span>
<span class="nc" id="L254">            doPrivileged(new GetPropertyAction(&quot;swing.jlf.contentPaneTransparent&quot;, &quot;false&quot;))))</span>
        {
<span class="nc" id="L256">            contentPane.setOpaque(false);</span>
        }
<span class="nc" id="L258">        setContentPane(contentPane);</span>

<span class="nc" id="L260">        contentPane.addContainerListener(new ContainerListener() {</span>
            @Override
            public void componentAdded(ContainerEvent e) {
<span class="nc" id="L263">                Component c = JLightweightFrame.this.component;</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                if (e.getChild() == c) {</span>
<span class="nc" id="L265">                    c.addPropertyChangeListener(&quot;preferredSize&quot;, layoutSizeListener);</span>
<span class="nc" id="L266">                    c.addPropertyChangeListener(&quot;maximumSize&quot;, layoutSizeListener);</span>
<span class="nc" id="L267">                    c.addPropertyChangeListener(&quot;minimumSize&quot;, layoutSizeListener);</span>
                }
<span class="nc" id="L269">            }</span>
            @Override
            public void componentRemoved(ContainerEvent e) {
<span class="nc" id="L272">                Component c = JLightweightFrame.this.component;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                if (e.getChild() == c) {</span>
<span class="nc" id="L274">                    c.removePropertyChangeListener(layoutSizeListener);</span>
                }
<span class="nc" id="L276">            }</span>
        });
<span class="nc" id="L278">    }</span>

    @SuppressWarnings(&quot;deprecation&quot;)
    @Override public void reshape(int x, int y, int width, int height) {
<span class="nc" id="L282">        super.reshape(x, y, width, height);</span>

<span class="nc bnc" id="L284" title="All 4 branches missed.">        if (width == 0 || height == 0) {</span>
<span class="nc" id="L285">            return;</span>
        }
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (!copyBufferEnabled) {</span>
<span class="nc" id="L288">            content.paintLock();</span>
        }
        try {
<span class="nc bnc" id="L291" title="All 6 branches missed.">            if ((bbImage == null) || (width != bbImage.getWidth()) || (height != bbImage.getHeight())) {</span>
<span class="nc" id="L292">                boolean createBB = true;</span>
<span class="nc" id="L293">                int newW = width;</span>
<span class="nc" id="L294">                int newH = height;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                if (bbImage != null) {</span>
<span class="nc" id="L296">                    int oldW = bbImage.getWidth();</span>
<span class="nc" id="L297">                    int oldH = bbImage.getHeight();</span>
<span class="nc bnc" id="L298" title="All 4 branches missed.">                    if ((oldW &gt;= newW) &amp;&amp; (oldH &gt;= newH)) {</span>
<span class="nc" id="L299">                        createBB = false;</span>
                    } else {
<span class="nc bnc" id="L301" title="All 2 branches missed.">                        if (oldW &gt;= newW) {</span>
<span class="nc" id="L302">                            newW = oldW;</span>
                        } else {
<span class="nc" id="L304">                            newW = Math.max((int)(oldW * 1.2), width);</span>
                        }
<span class="nc bnc" id="L306" title="All 2 branches missed.">                        if (oldH &gt;= newH) {</span>
<span class="nc" id="L307">                            newH = oldH;</span>
                        } else {
<span class="nc" id="L309">                            newH = Math.max((int)(oldH * 1.2), height);</span>
                        }
                    }
                }
<span class="nc bnc" id="L313" title="All 2 branches missed.">                if (createBB) {</span>
<span class="nc" id="L314">                    BufferedImage oldBB = bbImage;</span>
<span class="nc" id="L315">                    bbImage = new BufferedImage(newW, newH, BufferedImage.TYPE_INT_ARGB_PRE);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                    if (oldBB != null) {</span>
<span class="nc" id="L317">                        Graphics g = bbImage.getGraphics();</span>
                        try {
<span class="nc" id="L319">                            g.drawImage(oldBB, 0, 0, newW, newH, null);</span>
                        } finally {
<span class="nc" id="L321">                            g.dispose();</span>
<span class="nc" id="L322">                            oldBB.flush();</span>
<span class="nc" id="L323">                        }</span>
                    }
<span class="nc" id="L325">                    int[] pixels = ((DataBufferInt)bbImage.getRaster().getDataBuffer()).getData();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                    if (copyBufferEnabled) {</span>
<span class="nc" id="L327">                        syncCopyBuffer(true, 0, 0, width, height);</span>
<span class="nc" id="L328">                        pixels = copyBuffer;</span>
                    }
<span class="nc" id="L330">                    content.imageBufferReset(pixels, 0, 0, width, height, bbImage.getWidth());</span>
<span class="nc" id="L331">                    return;</span>
                }
            }
<span class="nc" id="L334">            content.imageReshaped(0, 0, width, height);</span>

        } finally {
<span class="nc bnc" id="L337" title="All 6 branches missed.">            if (!copyBufferEnabled) {</span>
<span class="nc" id="L338">                content.paintUnlock();</span>
            }
        }
<span class="nc" id="L341">    }</span>

    @Override
    public JRootPane getRootPane() {
<span class="nc" id="L345">        return rootPane;</span>
    }

    @Override
    public void setContentPane(Container contentPane) {
<span class="nc" id="L350">        getRootPane().setContentPane(contentPane);</span>
<span class="nc" id="L351">    }</span>

    @Override
    public Container getContentPane() {
<span class="nc" id="L355">        return getRootPane().getContentPane();</span>
    }

    @Override
    public void setLayeredPane(JLayeredPane layeredPane) {
<span class="nc" id="L360">        getRootPane().setLayeredPane(layeredPane);</span>
<span class="nc" id="L361">    }</span>

    @Override
    public JLayeredPane getLayeredPane() {
<span class="nc" id="L365">        return getRootPane().getLayeredPane();</span>
    }

    @Override
    public void setGlassPane(Component glassPane) {
<span class="nc" id="L370">        getRootPane().setGlassPane(glassPane);</span>
<span class="nc" id="L371">    }</span>

    @Override
    public Component getGlassPane() {
<span class="nc" id="L375">        return getRootPane().getGlassPane();</span>
    }


    /*
     * Notifies client toolkit that it should change a cursor.
     *
     * Called from the peer via SwingAccessor, because the
     * Component.updateCursorImmediately method is final
     * and could not be overridden.
     */
    private void updateClientCursor() {
<span class="nc" id="L387">        Point p = MouseInfo.getPointerInfo().getLocation();</span>
<span class="nc" id="L388">        SwingUtilities.convertPointFromScreen(p, this);</span>
<span class="nc" id="L389">        Component target = SwingUtilities.getDeepestComponentAt(this, p.x, p.y);</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (target != null) {</span>
<span class="nc" id="L391">            content.setCursor(target.getCursor());</span>
        }
<span class="nc" id="L393">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>