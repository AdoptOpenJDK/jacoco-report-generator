<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>FilePane.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.swing</a> &gt; <span class="el_source">FilePane.java</span></div><h1>FilePane.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, 2009, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package sun.swing;

import java.awt.*;
import java.awt.event.*;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.io.*;
import java.text.DateFormat;
import java.text.MessageFormat;
import java.util.*;
import java.util.List;
import java.util.concurrent.Callable;

import javax.accessibility.AccessibleContext;
import javax.swing.*;
import javax.swing.border.*;
import javax.swing.event.*;
import javax.swing.filechooser.*;
import javax.swing.plaf.basic.*;
import javax.swing.table.*;
import javax.swing.text.*;

import sun.awt.shell.*;

/**
 * &lt;b&gt;WARNING:&lt;/b&gt; This class is an implementation detail and is only
 * public so that it can be used by two packages. You should NOT consider
 * this public API.
 * &lt;p&gt;
 * This component is intended to be used in a subclass of
 * javax.swing.plaf.basic.BasicFileChooserUI. It realies heavily on the
 * implementation of BasicFileChooserUI, and is intended to be API compatible
 * with earlier implementations of MetalFileChooserUI and WindowsFileChooserUI.
 *
 * @author Leif Samuelsson
 */
public class FilePane extends JPanel implements PropertyChangeListener {
    // Constants for actions. These are used for the actions' ACTION_COMMAND_KEY
    // and as keys in the action maps for FilePane and the corresponding UI classes

    public final static String ACTION_APPROVE_SELECTION = &quot;approveSelection&quot;;
    public final static String ACTION_CANCEL            = &quot;cancelSelection&quot;;
    public final static String ACTION_EDIT_FILE_NAME    = &quot;editFileName&quot;;
    public final static String ACTION_REFRESH           = &quot;refresh&quot;;
    public final static String ACTION_CHANGE_TO_PARENT_DIRECTORY = &quot;Go Up&quot;;
    public final static String ACTION_NEW_FOLDER        = &quot;New Folder&quot;;
    public final static String ACTION_VIEW_LIST         = &quot;viewTypeList&quot;;
    public final static String ACTION_VIEW_DETAILS      = &quot;viewTypeDetails&quot;;

    private Action[] actions;

    // &quot;enums&quot; for setViewType()
    public  static final int VIEWTYPE_LIST     = 0;
    public  static final int VIEWTYPE_DETAILS  = 1;
    private static final int VIEWTYPE_COUNT    = 2;

<span class="nc" id="L81">    private int viewType = -1;</span>
<span class="nc" id="L82">    private JPanel[] viewPanels = new JPanel[VIEWTYPE_COUNT];</span>
    private JPanel currentViewPanel;
    private String[] viewTypeActionNames;

<span class="nc" id="L86">    private String filesListAccessibleName = null;</span>
<span class="nc" id="L87">    private String filesDetailsAccessibleName = null;</span>

    private JPopupMenu contextMenu;
    private JMenu viewMenu;

    private String viewMenuLabelText;
    private String refreshActionLabelText;
    private String newFolderActionLabelText;

    private String kiloByteString;
    private String megaByteString;
    private String gigaByteString;

    private String renameErrorTitleText;
    private String renameErrorText;
    private String renameErrorFileExistsText;

<span class="nc" id="L104">    private static final Cursor waitCursor =</span>
<span class="nc" id="L105">        Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR);</span>

<span class="nc" id="L107">    private final KeyListener detailsKeyListener = new KeyAdapter() {</span>
        private final long timeFactor;

<span class="nc" id="L110">        private final StringBuilder typedString = new StringBuilder();</span>

<span class="nc" id="L112">        private long lastTime = 1000L;</span>

        {
<span class="nc" id="L115">            Long l = (Long) UIManager.get(&quot;Table.timeFactor&quot;);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            timeFactor = (l != null) ? l : 1000L;</span>
<span class="nc" id="L117">        }</span>

        /**
         * Moves the keyboard focus to the first element whose prefix matches
         * the sequence of alphanumeric keys pressed by the user with delay
         * less than value of &lt;code&gt;timeFactor&lt;/code&gt;. Subsequent same key
         * presses move the keyboard focus to the next object that starts with
         * the same letter until another key is pressed, then it is treated
         * as the prefix with appropriate number of the same letters followed
         * by first typed another letter.
         */
        public void keyTyped(KeyEvent e) {
<span class="nc" id="L129">            BasicDirectoryModel model = getModel();</span>
<span class="nc" id="L130">            int rowCount = model.getSize();</span>

<span class="nc bnc" id="L132" title="All 4 branches missed.">            if (detailsTable == null || rowCount == 0 ||</span>
<span class="nc bnc" id="L133" title="All 6 branches missed.">                    e.isAltDown() || e.isControlDown() || e.isMetaDown()) {</span>
<span class="nc" id="L134">                return;</span>
            }

<span class="nc" id="L137">            InputMap inputMap = detailsTable.getInputMap(JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);</span>
<span class="nc" id="L138">            KeyStroke key = KeyStroke.getKeyStrokeForEvent(e);</span>

<span class="nc bnc" id="L140" title="All 4 branches missed.">            if (inputMap != null &amp;&amp; inputMap.get(key) != null) {</span>
<span class="nc" id="L141">                return;</span>
            }

<span class="nc" id="L144">            int startIndex = detailsTable.getSelectionModel().getLeadSelectionIndex();</span>

<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (startIndex &lt; 0) {</span>
<span class="nc" id="L147">                startIndex = 0;</span>
            }

<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (startIndex &gt;= rowCount) {</span>
<span class="nc" id="L151">                startIndex = rowCount - 1;</span>
            }

<span class="nc" id="L154">            char c = e.getKeyChar();</span>

<span class="nc" id="L156">            long time = e.getWhen();</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (time - lastTime &lt; timeFactor) {</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">                if (typedString.length() == 1 &amp;&amp; typedString.charAt(0) == c) {</span>
                    // Subsequent same key presses move the keyboard focus to the next
                    // object that starts with the same letter.
<span class="nc" id="L162">                    startIndex++;</span>
                } else {
<span class="nc" id="L164">                    typedString.append(c);</span>
                }
            } else {
<span class="nc" id="L167">                startIndex++;</span>

<span class="nc" id="L169">                typedString.setLength(0);</span>
<span class="nc" id="L170">                typedString.append(c);</span>
            }

<span class="nc" id="L173">            lastTime = time;</span>

<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (startIndex &gt;= rowCount) {</span>
<span class="nc" id="L176">                startIndex = 0;</span>
            }

            // Find next file
<span class="nc" id="L180">            int index = getNextMatch(startIndex, rowCount - 1);</span>

<span class="nc bnc" id="L182" title="All 4 branches missed.">            if (index &lt; 0 &amp;&amp; startIndex &gt; 0) { // wrap</span>
<span class="nc" id="L183">                index = getNextMatch(0, startIndex - 1);</span>
            }

<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (index &gt;= 0) {</span>
<span class="nc" id="L187">                detailsTable.getSelectionModel().setSelectionInterval(index, index);</span>

<span class="nc" id="L189">                Rectangle cellRect = detailsTable.getCellRect(index,</span>
<span class="nc" id="L190">                        detailsTable.convertColumnIndexToView(COLUMN_FILENAME), false);</span>
<span class="nc" id="L191">                detailsTable.scrollRectToVisible(cellRect);</span>
            }
<span class="nc" id="L193">        }</span>

        private int getNextMatch(int startIndex, int finishIndex) {
<span class="nc" id="L196">            BasicDirectoryModel model = getModel();</span>
<span class="nc" id="L197">            JFileChooser fileChooser = getFileChooser();</span>
<span class="nc" id="L198">            DetailsTableRowSorter rowSorter = getRowSorter();</span>

<span class="nc" id="L200">            String prefix = typedString.toString().toLowerCase();</span>

            // Search element
<span class="nc bnc" id="L203" title="All 2 branches missed.">            for (int index = startIndex; index &lt;= finishIndex; index++) {</span>
<span class="nc" id="L204">                File file = (File) model.getElementAt(rowSorter.convertRowIndexToModel(index));</span>

<span class="nc" id="L206">                String fileName = fileChooser.getName(file).toLowerCase();</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">                if (fileName.startsWith(prefix)) {</span>
<span class="nc" id="L209">                    return index;</span>
                }
            }

<span class="nc" id="L213">            return -1;</span>
        }
    };

<span class="nc" id="L217">    private FocusListener editorFocusListener = new FocusAdapter() {</span>
        public void focusLost(FocusEvent e) {
<span class="nc bnc" id="L219" title="All 2 branches missed.">            if (! e.isTemporary()) {</span>
<span class="nc" id="L220">                applyEdit();</span>
            }
<span class="nc" id="L222">        }</span>
    };

<span class="nc" id="L225">    private static FocusListener repaintListener = new FocusListener() {</span>
        public void focusGained(FocusEvent fe) {
<span class="nc" id="L227">            repaintSelection(fe.getSource());</span>
<span class="nc" id="L228">        }</span>

        public void focusLost(FocusEvent fe) {
<span class="nc" id="L231">            repaintSelection(fe.getSource());</span>
<span class="nc" id="L232">        }</span>

        private void repaintSelection(Object source) {
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if (source instanceof JList) {</span>
<span class="nc" id="L236">                repaintListSelection((JList)source);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            } else if (source instanceof JTable) {</span>
<span class="nc" id="L238">                repaintTableSelection((JTable)source);</span>
            }
<span class="nc" id="L240">        }</span>

        private void repaintListSelection(JList list) {
<span class="nc" id="L243">            int[] indices = list.getSelectedIndices();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">            for (int i : indices) {</span>
<span class="nc" id="L245">                Rectangle bounds = list.getCellBounds(i, i);</span>
<span class="nc" id="L246">                list.repaint(bounds);</span>
            }
<span class="nc" id="L248">        }</span>

        private void repaintTableSelection(JTable table) {
<span class="nc" id="L251">            int minRow = table.getSelectionModel().getMinSelectionIndex();</span>
<span class="nc" id="L252">            int maxRow = table.getSelectionModel().getMaxSelectionIndex();</span>
<span class="nc bnc" id="L253" title="All 4 branches missed.">            if (minRow == -1 || maxRow == -1) {</span>
<span class="nc" id="L254">                return;</span>
            }

<span class="nc" id="L257">            int col0 = table.convertColumnIndexToView(COLUMN_FILENAME);</span>

<span class="nc" id="L259">            Rectangle first = table.getCellRect(minRow, col0, false);</span>
<span class="nc" id="L260">            Rectangle last = table.getCellRect(maxRow, col0, false);</span>
<span class="nc" id="L261">            Rectangle dirty = first.union(last);</span>
<span class="nc" id="L262">            table.repaint(dirty);</span>
<span class="nc" id="L263">        }</span>
    };

<span class="nc" id="L266">    private boolean smallIconsView = false;</span>
    private Border  listViewBorder;
    private Color   listViewBackground;
    private boolean listViewWindowsStyle;
    private boolean readOnly;
<span class="nc" id="L271">    private boolean fullRowSelection = false;</span>

    private ListSelectionModel listSelectionModel;
    private JList list;
    private JTable detailsTable;

    private static final int COLUMN_FILENAME = 0;

    // Provides a way to recognize a newly created folder, so it can
    // be selected when it appears in the model.
    private File newFolderFile;

    // Used for accessing methods in the corresponding UI class
    private FileChooserUIAccessor fileChooserUIAccessor;
    private DetailsTableModel detailsTableModel;
    private DetailsTableRowSorter rowSorter;

    public FilePane(FileChooserUIAccessor fileChooserUIAccessor) {
<span class="nc" id="L289">        super(new BorderLayout());</span>

<span class="nc" id="L291">        this.fileChooserUIAccessor = fileChooserUIAccessor;</span>

<span class="nc" id="L293">        installDefaults();</span>
<span class="nc" id="L294">        createActionMap();</span>
<span class="nc" id="L295">    }</span>

    public void uninstallUI() {
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (getModel() != null) {</span>
<span class="nc" id="L299">            getModel().removePropertyChangeListener(this);</span>
        }
<span class="nc" id="L301">    }</span>

    protected JFileChooser getFileChooser() {
<span class="nc" id="L304">        return fileChooserUIAccessor.getFileChooser();</span>
    }

    protected BasicDirectoryModel getModel() {
<span class="nc" id="L308">        return fileChooserUIAccessor.getModel();</span>
    }

    public int getViewType() {
<span class="nc" id="L312">        return viewType;</span>
    }

    public void setViewType(int viewType) {
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (viewType == this.viewType) {</span>
<span class="nc" id="L317">            return;</span>
        }

<span class="nc" id="L320">        int oldValue = this.viewType;</span>
<span class="nc" id="L321">        this.viewType = viewType;</span>

<span class="nc" id="L323">        JPanel createdViewPanel = null;</span>
<span class="nc" id="L324">        Component newFocusOwner = null;</span>

<span class="nc bnc" id="L326" title="All 3 branches missed.">        switch (viewType) {</span>
          case VIEWTYPE_LIST:
<span class="nc bnc" id="L328" title="All 2 branches missed.">            if (viewPanels[viewType] == null) {</span>
<span class="nc" id="L329">                createdViewPanel = fileChooserUIAccessor.createList();</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">                if (createdViewPanel == null) {</span>
<span class="nc" id="L331">                    createdViewPanel = createList();</span>
                }

<span class="nc" id="L334">                list = (JList) findChildComponent(createdViewPanel, JList.class);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">                if (listSelectionModel == null) {</span>
<span class="nc" id="L336">                    listSelectionModel = list.getSelectionModel();</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                    if (detailsTable != null) {</span>
<span class="nc" id="L338">                        detailsTable.setSelectionModel(listSelectionModel);</span>
                    }
                } else {
<span class="nc" id="L341">                    list.setSelectionModel(listSelectionModel);</span>
                }
            }
<span class="nc" id="L344">            list.setLayoutOrientation(JList.VERTICAL_WRAP);</span>
<span class="nc" id="L345">            newFocusOwner = list;</span>
<span class="nc" id="L346">            break;</span>

          case VIEWTYPE_DETAILS:
<span class="nc bnc" id="L349" title="All 2 branches missed.">            if (viewPanels[viewType] == null) {</span>
<span class="nc" id="L350">                createdViewPanel = fileChooserUIAccessor.createDetailsView();</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                if (createdViewPanel == null) {</span>
<span class="nc" id="L352">                    createdViewPanel = createDetailsView();</span>
                }

<span class="nc" id="L355">                detailsTable = (JTable) findChildComponent(createdViewPanel, JTable.class);</span>
<span class="nc" id="L356">                detailsTable.setRowHeight(Math.max(detailsTable.getFont().getSize() + 4, 16 + 1));</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">                if (listSelectionModel != null) {</span>
<span class="nc" id="L358">                    detailsTable.setSelectionModel(listSelectionModel);</span>
                }
            }
<span class="nc" id="L361">            newFocusOwner = detailsTable;</span>
            break;
        }

<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (createdViewPanel != null) {</span>
<span class="nc" id="L366">            viewPanels[viewType] = createdViewPanel;</span>
<span class="nc" id="L367">            recursivelySetInheritsPopupMenu(createdViewPanel, true);</span>
        }

<span class="nc" id="L370">        boolean isFocusOwner = false;</span>

<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (currentViewPanel != null) {</span>
            Component owner = DefaultKeyboardFocusManager.
<span class="nc" id="L374">                    getCurrentKeyboardFocusManager().getPermanentFocusOwner();</span>

<span class="nc bnc" id="L376" title="All 4 branches missed.">            isFocusOwner = owner == detailsTable || owner == list;</span>

<span class="nc" id="L378">            remove(currentViewPanel);</span>
        }

<span class="nc" id="L381">        currentViewPanel = viewPanels[viewType];</span>
<span class="nc" id="L382">        add(currentViewPanel, BorderLayout.CENTER);</span>

<span class="nc bnc" id="L384" title="All 4 branches missed.">        if (isFocusOwner &amp;&amp; newFocusOwner != null) {</span>
<span class="nc" id="L385">            newFocusOwner.requestFocusInWindow();</span>
        }

<span class="nc" id="L388">        revalidate();</span>
<span class="nc" id="L389">        repaint();</span>
<span class="nc" id="L390">        updateViewMenu();</span>
<span class="nc" id="L391">        firePropertyChange(&quot;viewType&quot;, oldValue, viewType);</span>
<span class="nc" id="L392">    }</span>

    class ViewTypeAction extends AbstractAction {
        private int viewType;

<span class="nc" id="L397">        ViewTypeAction(int viewType) {</span>
<span class="nc" id="L398">            super(viewTypeActionNames[viewType]);</span>
<span class="nc" id="L399">            this.viewType = viewType;</span>

            String cmd;
<span class="nc bnc" id="L402" title="All 3 branches missed.">            switch (viewType) {</span>
<span class="nc" id="L403">                case VIEWTYPE_LIST:    cmd = ACTION_VIEW_LIST;    break;</span>
<span class="nc" id="L404">                case VIEWTYPE_DETAILS: cmd = ACTION_VIEW_DETAILS; break;</span>
<span class="nc" id="L405">                default:               cmd = (String)getValue(Action.NAME);</span>
            }
<span class="nc" id="L407">            putValue(Action.ACTION_COMMAND_KEY, cmd);</span>
<span class="nc" id="L408">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L411">            setViewType(viewType);</span>
<span class="nc" id="L412">        }</span>
    }

    public Action getViewTypeAction(int viewType) {
<span class="nc" id="L416">        return new ViewTypeAction(viewType);</span>
    }

    private static void recursivelySetInheritsPopupMenu(Container container, boolean b) {
<span class="nc bnc" id="L420" title="All 2 branches missed.">        if (container instanceof JComponent) {</span>
<span class="nc" id="L421">            ((JComponent)container).setInheritsPopupMenu(b);</span>
        }
<span class="nc" id="L423">        int n = container.getComponentCount();</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">        for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L425">            recursivelySetInheritsPopupMenu((Container)container.getComponent(i), b);</span>
        }
<span class="nc" id="L427">    }</span>

    protected void installDefaults() {
<span class="nc" id="L430">        Locale l = getFileChooser().getLocale();</span>

<span class="nc" id="L432">        listViewBorder       = UIManager.getBorder(&quot;FileChooser.listViewBorder&quot;);</span>
<span class="nc" id="L433">        listViewBackground   = UIManager.getColor(&quot;FileChooser.listViewBackground&quot;);</span>
<span class="nc" id="L434">        listViewWindowsStyle = UIManager.getBoolean(&quot;FileChooser.listViewWindowsStyle&quot;);</span>
<span class="nc" id="L435">        readOnly             = UIManager.getBoolean(&quot;FileChooser.readOnly&quot;);</span>

        // TODO: On windows, get the following localized strings from the OS

<span class="nc" id="L439">        viewMenuLabelText =</span>
<span class="nc" id="L440">                        UIManager.getString(&quot;FileChooser.viewMenuLabelText&quot;, l);</span>
<span class="nc" id="L441">        refreshActionLabelText =</span>
<span class="nc" id="L442">                        UIManager.getString(&quot;FileChooser.refreshActionLabelText&quot;, l);</span>
<span class="nc" id="L443">        newFolderActionLabelText =</span>
<span class="nc" id="L444">                        UIManager.getString(&quot;FileChooser.newFolderActionLabelText&quot;, l);</span>

<span class="nc" id="L446">        viewTypeActionNames = new String[VIEWTYPE_COUNT];</span>
<span class="nc" id="L447">        viewTypeActionNames[VIEWTYPE_LIST] =</span>
<span class="nc" id="L448">                        UIManager.getString(&quot;FileChooser.listViewActionLabelText&quot;, l);</span>
<span class="nc" id="L449">        viewTypeActionNames[VIEWTYPE_DETAILS] =</span>
<span class="nc" id="L450">                        UIManager.getString(&quot;FileChooser.detailsViewActionLabelText&quot;, l);</span>

<span class="nc" id="L452">        kiloByteString = UIManager.getString(&quot;FileChooser.fileSizeKiloBytes&quot;, l);</span>
<span class="nc" id="L453">        megaByteString = UIManager.getString(&quot;FileChooser.fileSizeMegaBytes&quot;, l);</span>
<span class="nc" id="L454">        gigaByteString = UIManager.getString(&quot;FileChooser.fileSizeGigaBytes&quot;, l);</span>
<span class="nc" id="L455">        fullRowSelection = UIManager.getBoolean(&quot;FileView.fullRowSelection&quot;);</span>

<span class="nc" id="L457">        filesListAccessibleName = UIManager.getString(&quot;FileChooser.filesListAccessibleName&quot;, l);</span>
<span class="nc" id="L458">        filesDetailsAccessibleName = UIManager.getString(&quot;FileChooser.filesDetailsAccessibleName&quot;, l);</span>

<span class="nc" id="L460">        renameErrorTitleText = UIManager.getString(&quot;FileChooser.renameErrorTitleText&quot;, l);</span>
<span class="nc" id="L461">        renameErrorText = UIManager.getString(&quot;FileChooser.renameErrorText&quot;, l);</span>
<span class="nc" id="L462">        renameErrorFileExistsText = UIManager.getString(&quot;FileChooser.renameErrorFileExistsText&quot;, l);</span>
<span class="nc" id="L463">    }</span>

    /**
     * Fetches the command list for the FilePane. These commands
     * are useful for binding to events, such as in a keymap.
     *
     * @return the command list
     */
    public Action[] getActions() {
<span class="nc bnc" id="L472" title="All 2 branches missed.">        if (actions == null) {</span>
            class FilePaneAction extends AbstractAction {
                FilePaneAction(String name) {
<span class="nc" id="L475">                    this(name, name);</span>
<span class="nc" id="L476">                }</span>

<span class="nc" id="L478">                FilePaneAction(String name, String cmd) {</span>
<span class="nc" id="L479">                    super(name);</span>
<span class="nc" id="L480">                    putValue(Action.ACTION_COMMAND_KEY, cmd);</span>
<span class="nc" id="L481">                }</span>

                public void actionPerformed(ActionEvent e) {
<span class="nc" id="L484">                    String cmd = (String)getValue(Action.ACTION_COMMAND_KEY);</span>

<span class="nc bnc" id="L486" title="All 2 branches missed.">                    if (cmd == ACTION_CANCEL) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">                        if (editFile != null) {</span>
<span class="nc" id="L488">                           cancelEdit();</span>
                        } else {
<span class="nc" id="L490">                           getFileChooser().cancelSelection();</span>
                        }
<span class="nc bnc" id="L492" title="All 2 branches missed.">                    } else if (cmd == ACTION_EDIT_FILE_NAME) {</span>
<span class="nc" id="L493">                        JFileChooser fc = getFileChooser();</span>
<span class="nc" id="L494">                        int index = listSelectionModel.getMinSelectionIndex();</span>
<span class="nc bnc" id="L495" title="All 4 branches missed.">                        if (index &gt;= 0 &amp;&amp; editFile == null &amp;&amp;</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">                            (!fc.isMultiSelectionEnabled() ||</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                             fc.getSelectedFiles().length &lt;= 1)) {</span>

<span class="nc" id="L499">                            editFileName(index);</span>
                        }
<span class="nc bnc" id="L501" title="All 2 branches missed.">                    } else if (cmd == ACTION_REFRESH) {</span>
<span class="nc" id="L502">                        getFileChooser().rescanCurrentDirectory();</span>
                    }
<span class="nc" id="L504">                }</span>

                public boolean isEnabled() {
<span class="nc" id="L507">                    String cmd = (String)getValue(Action.ACTION_COMMAND_KEY);</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                    if (cmd == ACTION_CANCEL) {</span>
<span class="nc" id="L509">                        return getFileChooser().isEnabled();</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                    } else if (cmd == ACTION_EDIT_FILE_NAME) {</span>
<span class="nc bnc" id="L511" title="All 4 branches missed.">                        return !readOnly &amp;&amp; getFileChooser().isEnabled();</span>
                    } else {
<span class="nc" id="L513">                        return true;</span>
                    }
                }
            }

<span class="nc" id="L518">            ArrayList&lt;Action&gt; actionList = new ArrayList&lt;Action&gt;(8);</span>
            Action action;

<span class="nc" id="L521">            actionList.add(new FilePaneAction(ACTION_CANCEL));</span>
<span class="nc" id="L522">            actionList.add(new FilePaneAction(ACTION_EDIT_FILE_NAME));</span>
<span class="nc" id="L523">            actionList.add(new FilePaneAction(refreshActionLabelText, ACTION_REFRESH));</span>

<span class="nc" id="L525">            action = fileChooserUIAccessor.getApproveSelectionAction();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L527">                actionList.add(action);</span>
            }
<span class="nc" id="L529">            action = fileChooserUIAccessor.getChangeToParentDirectoryAction();</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L531">                actionList.add(action);</span>
            }
<span class="nc" id="L533">            action = getNewFolderAction();</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L535">                actionList.add(action);</span>
            }
<span class="nc" id="L537">            action = getViewTypeAction(VIEWTYPE_LIST);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L539">                actionList.add(action);</span>
            }
<span class="nc" id="L541">            action = getViewTypeAction(VIEWTYPE_DETAILS);</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L543">                actionList.add(action);</span>
            }
<span class="nc" id="L545">            actions = actionList.toArray(new Action[actionList.size()]);</span>
        }

<span class="nc" id="L548">        return actions;</span>
    }

    protected void createActionMap() {
<span class="nc" id="L552">        addActionsToMap(super.getActionMap(), getActions());</span>
<span class="nc" id="L553">    }</span>


    public static void addActionsToMap(ActionMap map, Action[] actions) {
<span class="nc bnc" id="L557" title="All 4 branches missed.">        if (map != null &amp;&amp; actions != null) {</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">            for (Action a : actions) {</span>
<span class="nc" id="L559">                String cmd = (String)a.getValue(Action.ACTION_COMMAND_KEY);</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">                if (cmd == null) {</span>
<span class="nc" id="L561">                    cmd = (String)a.getValue(Action.NAME);</span>
                }
<span class="nc" id="L563">                map.put(cmd, a);</span>
            }
        }
<span class="nc" id="L566">    }</span>


    private void updateListRowCount(JList list) {
<span class="nc bnc" id="L570" title="All 2 branches missed.">        if (smallIconsView) {</span>
<span class="nc" id="L571">            list.setVisibleRowCount(getModel().getSize() / 3);</span>
        } else {
<span class="nc" id="L573">            list.setVisibleRowCount(-1);</span>
        }
<span class="nc" id="L575">    }</span>

    public JPanel createList() {
<span class="nc" id="L578">        JPanel p = new JPanel(new BorderLayout());</span>
<span class="nc" id="L579">        final JFileChooser fileChooser = getFileChooser();</span>
<span class="nc" id="L580">        final JList&lt;Object&gt; list = new JList&lt;Object&gt;() {</span>
            public int getNextMatch(String prefix, int startIndex, Position.Bias bias) {
<span class="nc" id="L582">                ListModel model = getModel();</span>
<span class="nc" id="L583">                int max = model.getSize();</span>
<span class="nc bnc" id="L584" title="All 6 branches missed.">                if (prefix == null || startIndex &lt; 0 || startIndex &gt;= max) {</span>
<span class="nc" id="L585">                    throw new IllegalArgumentException();</span>
                }
                // start search from the next element before/after the selected element
<span class="nc bnc" id="L588" title="All 2 branches missed.">                boolean backwards = (bias == Position.Bias.Backward);</span>
<span class="nc bnc" id="L589" title="All 8 branches missed.">                for (int i = startIndex; backwards ? i &gt;= 0 : i &lt; max; i += (backwards ?  -1 : 1)) {</span>
<span class="nc" id="L590">                    String filename = fileChooser.getName((File)model.getElementAt(i));</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">                    if (filename.regionMatches(true, 0, prefix, 0, prefix.length())) {</span>
<span class="nc" id="L592">                        return i;</span>
                    }
                }
<span class="nc" id="L595">                return -1;</span>
            }
        };
<span class="nc" id="L598">        list.setCellRenderer(new FileRenderer());</span>
<span class="nc" id="L599">        list.setLayoutOrientation(JList.VERTICAL_WRAP);</span>

        // 4835633 : tell BasicListUI that this is a file list
<span class="nc" id="L602">        list.putClientProperty(&quot;List.isFileList&quot;, Boolean.TRUE);</span>

<span class="nc bnc" id="L604" title="All 2 branches missed.">        if (listViewWindowsStyle) {</span>
<span class="nc" id="L605">            list.addFocusListener(repaintListener);</span>
        }

<span class="nc" id="L608">        updateListRowCount(list);</span>

<span class="nc" id="L610">        getModel().addListDataListener(new ListDataListener() {</span>
            public void intervalAdded(ListDataEvent e) {
<span class="nc" id="L612">                updateListRowCount(list);</span>
<span class="nc" id="L613">            }</span>
            public void intervalRemoved(ListDataEvent e) {
<span class="nc" id="L615">                updateListRowCount(list);</span>
<span class="nc" id="L616">            }</span>
            public void contentsChanged(ListDataEvent e) {
<span class="nc bnc" id="L618" title="All 2 branches missed.">                if (isShowing()) {</span>
<span class="nc" id="L619">                    clearSelection();</span>
                }
<span class="nc" id="L621">                updateListRowCount(list);</span>
<span class="nc" id="L622">            }</span>
        });

<span class="nc" id="L625">        getModel().addPropertyChangeListener(this);</span>

<span class="nc bnc" id="L627" title="All 2 branches missed.">        if (fileChooser.isMultiSelectionEnabled()) {</span>
<span class="nc" id="L628">            list.setSelectionMode(ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);</span>
        } else {
<span class="nc" id="L630">            list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
        }
<span class="nc" id="L632">        list.setModel(new SortableListModel());</span>

<span class="nc" id="L634">        list.addListSelectionListener(createListSelectionListener());</span>
<span class="nc" id="L635">        list.addMouseListener(getMouseHandler());</span>

<span class="nc" id="L637">        JScrollPane scrollpane = new JScrollPane(list);</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">        if (listViewBackground != null) {</span>
<span class="nc" id="L639">            list.setBackground(listViewBackground);</span>
        }
<span class="nc bnc" id="L641" title="All 2 branches missed.">        if (listViewBorder != null) {</span>
<span class="nc" id="L642">            scrollpane.setBorder(listViewBorder);</span>
        }

<span class="nc" id="L645">        list.putClientProperty(AccessibleContext.ACCESSIBLE_NAME_PROPERTY, filesListAccessibleName);</span>

<span class="nc" id="L647">        p.add(scrollpane, BorderLayout.CENTER);</span>
<span class="nc" id="L648">        return p;</span>
    }

    /**
     * This model allows for sorting JList
     */
    private class SortableListModel extends AbstractListModel&lt;Object&gt;
            implements TableModelListener, RowSorterListener {

<span class="nc" id="L657">        public SortableListModel() {</span>
<span class="nc" id="L658">            getDetailsTableModel().addTableModelListener(this);</span>
<span class="nc" id="L659">            getRowSorter().addRowSorterListener(this);</span>
<span class="nc" id="L660">        }</span>

        public int getSize() {
<span class="nc" id="L663">            return getModel().getSize();</span>
        }

        public Object getElementAt(int index) {
            // JList doesn't support RowSorter so far, so we put it into the list model
<span class="nc" id="L668">            return getModel().getElementAt(getRowSorter().convertRowIndexToModel(index));</span>
        }

        public void tableChanged(TableModelEvent e) {
<span class="nc" id="L672">            fireContentsChanged(this, 0, getSize());</span>
<span class="nc" id="L673">        }</span>

        public void sorterChanged(RowSorterEvent e) {
<span class="nc" id="L676">            fireContentsChanged(this, 0, getSize());</span>
<span class="nc" id="L677">        }</span>
    }

    private DetailsTableModel getDetailsTableModel() {
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if(detailsTableModel == null) {</span>
<span class="nc" id="L682">            detailsTableModel = new DetailsTableModel(getFileChooser());</span>
        }
<span class="nc" id="L684">        return detailsTableModel;</span>
    }

    class DetailsTableModel extends AbstractTableModel implements ListDataListener {
        JFileChooser chooser;
        BasicDirectoryModel directoryModel;

        ShellFolderColumnInfo[] columns;
        int[] columnMap;

<span class="nc" id="L694">        DetailsTableModel(JFileChooser fc) {</span>
<span class="nc" id="L695">            this.chooser = fc;</span>
<span class="nc" id="L696">            directoryModel = getModel();</span>
<span class="nc" id="L697">            directoryModel.addListDataListener(this);</span>

<span class="nc" id="L699">            updateColumnInfo();</span>
<span class="nc" id="L700">        }</span>

        void updateColumnInfo() {
<span class="nc" id="L703">            File dir = chooser.getCurrentDirectory();</span>
<span class="nc bnc" id="L704" title="All 4 branches missed.">            if (dir != null &amp;&amp; usesShellFolder(chooser)) {</span>
                try {
<span class="nc" id="L706">                    dir = ShellFolder.getShellFolder(dir);</span>
<span class="nc" id="L707">                } catch (FileNotFoundException e) {</span>
                    // Leave dir without changing
<span class="nc" id="L709">                }</span>
            }

<span class="nc" id="L712">            ShellFolderColumnInfo[] allColumns = ShellFolder.getFolderColumns(dir);</span>

<span class="nc" id="L714">            ArrayList&lt;ShellFolderColumnInfo&gt; visibleColumns =</span>
                    new ArrayList&lt;ShellFolderColumnInfo&gt;();
<span class="nc" id="L716">            columnMap = new int[allColumns.length];</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">            for (int i = 0; i &lt; allColumns.length; i++) {</span>
<span class="nc" id="L718">                ShellFolderColumnInfo column = allColumns[i];</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">                if (column.isVisible()) {</span>
<span class="nc" id="L720">                    columnMap[visibleColumns.size()] = i;</span>
<span class="nc" id="L721">                    visibleColumns.add(column);</span>
                }
            }

<span class="nc" id="L725">            columns = new ShellFolderColumnInfo[visibleColumns.size()];</span>
<span class="nc" id="L726">            visibleColumns.toArray(columns);</span>
<span class="nc" id="L727">            columnMap = Arrays.copyOf(columnMap, columns.length);</span>

<span class="nc" id="L729">            List&lt;? extends RowSorter.SortKey&gt; sortKeys =</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">                    (rowSorter == null) ? null : rowSorter.getSortKeys();</span>
<span class="nc" id="L731">            fireTableStructureChanged();</span>
<span class="nc" id="L732">            restoreSortKeys(sortKeys);</span>
<span class="nc" id="L733">        }</span>

        private void restoreSortKeys(List&lt;? extends RowSorter.SortKey&gt; sortKeys) {
<span class="nc bnc" id="L736" title="All 2 branches missed.">            if (sortKeys != null) {</span>
                // check if preserved sortKeys are valid for this folder
<span class="nc bnc" id="L738" title="All 2 branches missed.">                for (int i = 0; i &lt; sortKeys.size(); i++) {</span>
<span class="nc" id="L739">                    RowSorter.SortKey sortKey = sortKeys.get(i);</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">                    if (sortKey.getColumn() &gt;= columns.length) {</span>
<span class="nc" id="L741">                        sortKeys = null;</span>
<span class="nc" id="L742">                        break;</span>
                    }
                }
<span class="nc bnc" id="L745" title="All 2 branches missed.">                if (sortKeys != null) {</span>
<span class="nc" id="L746">                    rowSorter.setSortKeys(sortKeys);</span>
                }
            }
<span class="nc" id="L749">        }</span>

        public int getRowCount() {
<span class="nc" id="L752">            return directoryModel.getSize();</span>
        }

        public int getColumnCount() {
<span class="nc" id="L756">            return columns.length;</span>
        }

        public Object getValueAt(int row, int col) {
            // Note: It is very important to avoid getting info on drives, as
            // this will trigger &quot;No disk in A:&quot; and similar dialogs.
            //
            // Use (f.exists() &amp;&amp; !chooser.getFileSystemView().isFileSystemRoot(f)) to
            // determine if it is safe to call methods directly on f.
<span class="nc" id="L765">            return getFileColumnValue((File)directoryModel.getElementAt(row), col);</span>
        }

        private Object getFileColumnValue(File f, int col) {
<span class="nc bnc" id="L769" title="All 2 branches missed.">            return (col == COLUMN_FILENAME)</span>
                    ? f // always return the file itself for the 1st column
<span class="nc" id="L771">                    : ShellFolder.getFolderColumnValue(f, columnMap[col]);</span>
        }

        public void setValueAt(Object value, int row, int col) {
<span class="nc bnc" id="L775" title="All 2 branches missed.">            if (col == COLUMN_FILENAME) {</span>
<span class="nc" id="L776">                final JFileChooser chooser = getFileChooser();</span>
<span class="nc" id="L777">                File f = (File)getValueAt(row, col);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">                if (f != null) {</span>
<span class="nc" id="L779">                    String oldDisplayName = chooser.getName(f);</span>
<span class="nc" id="L780">                    String oldFileName = f.getName();</span>
<span class="nc" id="L781">                    String newDisplayName = ((String)value).trim();</span>
                    String newFileName;

<span class="nc bnc" id="L784" title="All 2 branches missed.">                    if (!newDisplayName.equals(oldDisplayName)) {</span>
<span class="nc" id="L785">                        newFileName = newDisplayName;</span>
                        //Check if extension is hidden from user
<span class="nc" id="L787">                        int i1 = oldFileName.length();</span>
<span class="nc" id="L788">                        int i2 = oldDisplayName.length();</span>
<span class="nc bnc" id="L789" title="All 4 branches missed.">                        if (i1 &gt; i2 &amp;&amp; oldFileName.charAt(i2) == '.') {</span>
<span class="nc" id="L790">                            newFileName = newDisplayName + oldFileName.substring(i2);</span>
                        }

                        // rename
<span class="nc" id="L794">                        FileSystemView fsv = chooser.getFileSystemView();</span>
<span class="nc" id="L795">                        final File f2 = fsv.createFileObject(f.getParentFile(), newFileName);</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">                        if (f2.exists()) {</span>
<span class="nc" id="L797">                            JOptionPane.showMessageDialog(chooser, MessageFormat.format(renameErrorFileExistsText,</span>
<span class="nc" id="L798">                                    oldFileName), renameErrorTitleText, JOptionPane.ERROR_MESSAGE);</span>
                        } else {
<span class="nc bnc" id="L800" title="All 2 branches missed.">                            if (FilePane.this.getModel().renameFile(f, f2)) {</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">                                if (fsv.isParent(chooser.getCurrentDirectory(), f2)) {</span>
                                    // The setSelectedFile method produces a new setValueAt invocation while the JTable
                                    // is editing. Postpone file selection to be sure that edit mode of the JTable
                                    // is completed
<span class="nc" id="L805">                                    SwingUtilities.invokeLater(new Runnable() {</span>
                                        public void run() {
<span class="nc bnc" id="L807" title="All 2 branches missed.">                                            if (chooser.isMultiSelectionEnabled()) {</span>
<span class="nc" id="L808">                                                chooser.setSelectedFiles(new File[]{f2});</span>
                                            } else {
<span class="nc" id="L810">                                                chooser.setSelectedFile(f2);</span>
                                            }
<span class="nc" id="L812">                                        }</span>
                                    });
                                } else {
                                    // Could be because of delay in updating Desktop folder
                                    // chooser.setSelectedFile(null);
                                }
                            } else {
<span class="nc" id="L819">                                JOptionPane.showMessageDialog(chooser, MessageFormat.format(renameErrorText, oldFileName),</span>
<span class="nc" id="L820">                                        renameErrorTitleText, JOptionPane.ERROR_MESSAGE);</span>
                            }
                        }
                    }
                }
            }
<span class="nc" id="L826">        }</span>

        public boolean isCellEditable(int row, int column) {
<span class="nc" id="L829">            File currentDirectory = getFileChooser().getCurrentDirectory();</span>
<span class="nc bnc" id="L830" title="All 6 branches missed.">            return (!readOnly &amp;&amp; column == COLUMN_FILENAME &amp;&amp; canWrite(currentDirectory));</span>
        }

        public void contentsChanged(ListDataEvent e) {
            // Update the selection after the model has been updated
<span class="nc" id="L835">            new DelayedSelectionUpdater();</span>
<span class="nc" id="L836">            fireTableDataChanged();</span>
<span class="nc" id="L837">        }</span>

        public void intervalAdded(ListDataEvent e) {
<span class="nc" id="L840">            int i0 = e.getIndex0();</span>
<span class="nc" id="L841">            int i1 = e.getIndex1();</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">            if (i0 == i1) {</span>
<span class="nc" id="L843">                File file = (File)getModel().getElementAt(i0);</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">                if (file.equals(newFolderFile)) {</span>
<span class="nc" id="L845">                    new DelayedSelectionUpdater(file);</span>
<span class="nc" id="L846">                    newFolderFile = null;</span>
                }
            }

<span class="nc" id="L850">            fireTableRowsInserted(e.getIndex0(), e.getIndex1());</span>
<span class="nc" id="L851">        }</span>
        public void intervalRemoved(ListDataEvent e) {
<span class="nc" id="L853">            fireTableRowsDeleted(e.getIndex0(), e.getIndex1());</span>
<span class="nc" id="L854">        }</span>

        public ShellFolderColumnInfo[] getColumns() {
<span class="nc" id="L857">            return columns;</span>
        }
    }


    private void updateDetailsColumnModel(JTable table) {
<span class="nc bnc" id="L863" title="All 2 branches missed.">        if (table != null) {</span>
<span class="nc" id="L864">            ShellFolderColumnInfo[] columns = detailsTableModel.getColumns();</span>

<span class="nc" id="L866">            TableColumnModel columnModel = new DefaultTableColumnModel();</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">            for (int i = 0; i &lt; columns.length; i++) {</span>
<span class="nc" id="L868">                ShellFolderColumnInfo dataItem = columns[i];</span>
<span class="nc" id="L869">                TableColumn column = new TableColumn(i);</span>

<span class="nc" id="L871">                String title = dataItem.getTitle();</span>
<span class="nc bnc" id="L872" title="All 6 branches missed.">                if (title != null &amp;&amp; title.startsWith(&quot;FileChooser.&quot;) &amp;&amp; title.endsWith(&quot;HeaderText&quot;)) {</span>
                    // the column must have a string resource that we try to get
<span class="nc" id="L874">                    String uiTitle = UIManager.getString(title, table.getLocale());</span>
<span class="nc bnc" id="L875" title="All 2 branches missed.">                    if (uiTitle != null) {</span>
<span class="nc" id="L876">                        title = uiTitle;</span>
                    }
                }
<span class="nc" id="L879">                column.setHeaderValue(title);</span>

<span class="nc" id="L881">                Integer width = dataItem.getWidth();</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">                if (width != null) {</span>
<span class="nc" id="L883">                    column.setPreferredWidth(width);</span>
                    // otherwise we let JTable to decide the actual width
                }

<span class="nc" id="L887">                columnModel.addColumn(column);</span>
            }

            // Install cell editor for editing file name
<span class="nc bnc" id="L891" title="All 4 branches missed.">            if (!readOnly &amp;&amp; columnModel.getColumnCount() &gt; COLUMN_FILENAME) {</span>
<span class="nc" id="L892">                columnModel.getColumn(COLUMN_FILENAME).</span>
<span class="nc" id="L893">                        setCellEditor(getDetailsTableCellEditor());</span>
            }

<span class="nc" id="L896">            table.setColumnModel(columnModel);</span>
        }
<span class="nc" id="L898">    }</span>

    private DetailsTableRowSorter getRowSorter() {
<span class="nc bnc" id="L901" title="All 2 branches missed.">        if (rowSorter == null) {</span>
<span class="nc" id="L902">            rowSorter = new DetailsTableRowSorter();</span>
        }
<span class="nc" id="L904">        return rowSorter;</span>
    }

    private class DetailsTableRowSorter extends TableRowSorter&lt;TableModel&gt; {
<span class="nc" id="L908">        public DetailsTableRowSorter() {</span>
<span class="nc" id="L909">            setModelWrapper(new SorterModelWrapper());</span>
<span class="nc" id="L910">        }</span>

        public void updateComparators(ShellFolderColumnInfo [] columns) {
<span class="nc bnc" id="L913" title="All 2 branches missed.">            for (int i = 0; i &lt; columns.length; i++) {</span>
<span class="nc" id="L914">                Comparator c = columns[i].getComparator();</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">                if (c != null) {</span>
<span class="nc" id="L916">                    c = new DirectoriesFirstComparatorWrapper(i, c);</span>
                }
<span class="nc" id="L918">                setComparator(i, c);</span>
            }
<span class="nc" id="L920">        }</span>

        @Override
        public void sort() {
<span class="nc" id="L924">            ShellFolder.invoke(new Callable&lt;Void&gt;() {</span>
                public Void call() {
<span class="nc" id="L926">                    DetailsTableRowSorter.super.sort();</span>
<span class="nc" id="L927">                    return null;</span>
                }
            });
<span class="nc" id="L930">        }</span>

        public void modelStructureChanged() {
<span class="nc" id="L933">            super.modelStructureChanged();</span>
<span class="nc" id="L934">            updateComparators(detailsTableModel.getColumns());</span>
<span class="nc" id="L935">        }</span>

<span class="nc" id="L937">        private class SorterModelWrapper extends ModelWrapper&lt;TableModel, Integer&gt; {</span>
            public TableModel getModel() {
<span class="nc" id="L939">                return getDetailsTableModel();</span>
            }

            public int getColumnCount() {
<span class="nc" id="L943">                return getDetailsTableModel().getColumnCount();</span>
            }

            public int getRowCount() {
<span class="nc" id="L947">                return getDetailsTableModel().getRowCount();</span>
            }

            public Object getValueAt(int row, int column) {
<span class="nc" id="L951">                return FilePane.this.getModel().getElementAt(row);</span>
            }

            public Integer getIdentifier(int row) {
<span class="nc" id="L955">                return row;</span>
            }
        }
    }

    /**
     * This class sorts directories before files, comparing directory to
     * directory and file to file using the wrapped comparator.
     */
    private class DirectoriesFirstComparatorWrapper implements Comparator&lt;File&gt; {
        private Comparator comparator;
        private int column;

<span class="nc" id="L968">        public DirectoriesFirstComparatorWrapper(int column, Comparator comparator) {</span>
<span class="nc" id="L969">            this.column = column;</span>
<span class="nc" id="L970">            this.comparator = comparator;</span>
<span class="nc" id="L971">        }</span>

        public int compare(File f1, File f2) {
<span class="nc bnc" id="L974" title="All 4 branches missed.">            if (f1 != null &amp;&amp; f2 != null) {</span>
<span class="nc" id="L975">                boolean traversable1 = getFileChooser().isTraversable(f1);</span>
<span class="nc" id="L976">                boolean traversable2 = getFileChooser().isTraversable(f2);</span>
                // directories go first
<span class="nc bnc" id="L978" title="All 4 branches missed.">                if (traversable1 &amp;&amp; !traversable2) {</span>
<span class="nc" id="L979">                    return -1;</span>
                }
<span class="nc bnc" id="L981" title="All 4 branches missed.">                if (!traversable1 &amp;&amp; traversable2) {</span>
<span class="nc" id="L982">                    return 1;</span>
                }
            }
<span class="nc bnc" id="L985" title="All 2 branches missed.">            if (detailsTableModel.getColumns()[column].isCompareByColumn()) {</span>
<span class="nc" id="L986">                return comparator.compare(</span>
<span class="nc" id="L987">                        getDetailsTableModel().getFileColumnValue(f1, column),</span>
<span class="nc" id="L988">                        getDetailsTableModel().getFileColumnValue(f2, column)</span>
                );
            }
            // For this column we need to pass the file itself (not a
            // column value) to the comparator
<span class="nc" id="L993">            return comparator.compare(f1, f2);</span>
        }
    }

    private DetailsTableCellEditor tableCellEditor;

    private DetailsTableCellEditor getDetailsTableCellEditor() {
<span class="nc bnc" id="L1000" title="All 2 branches missed.">        if (tableCellEditor == null) {</span>
<span class="nc" id="L1001">            tableCellEditor = new DetailsTableCellEditor(new JTextField());</span>
        }
<span class="nc" id="L1003">        return tableCellEditor;</span>
    }

    private class DetailsTableCellEditor extends DefaultCellEditor {
        private final JTextField tf;

<span class="nc" id="L1009">        public DetailsTableCellEditor(JTextField tf) {</span>
<span class="nc" id="L1010">            super(tf);</span>
<span class="nc" id="L1011">            this.tf = tf;</span>
<span class="nc" id="L1012">            tf.setName(&quot;Table.editor&quot;);</span>
<span class="nc" id="L1013">            tf.addFocusListener(editorFocusListener);</span>
<span class="nc" id="L1014">        }</span>

        public Component getTableCellEditorComponent(JTable table, Object value,
                                                     boolean isSelected, int row, int column) {
<span class="nc" id="L1018">            Component comp = super.getTableCellEditorComponent(table, value,</span>
                    isSelected, row, column);
<span class="nc bnc" id="L1020" title="All 2 branches missed.">            if (value instanceof File) {</span>
<span class="nc" id="L1021">                tf.setText(getFileChooser().getName((File) value));</span>
<span class="nc" id="L1022">                tf.selectAll();</span>
            }
<span class="nc" id="L1024">            return comp;</span>
        }
    }


    class DetailsTableCellRenderer extends DefaultTableCellRenderer {
        JFileChooser chooser;
        DateFormat df;

<span class="nc" id="L1033">        DetailsTableCellRenderer(JFileChooser chooser) {</span>
<span class="nc" id="L1034">            this.chooser = chooser;</span>
<span class="nc" id="L1035">            df = DateFormat.getDateTimeInstance(DateFormat.SHORT, DateFormat.SHORT,</span>
<span class="nc" id="L1036">                                                chooser.getLocale());</span>
<span class="nc" id="L1037">        }</span>

        public void setBounds(int x, int y, int width, int height) {
<span class="nc bnc" id="L1040" title="All 2 branches missed.">        if (getHorizontalAlignment() == SwingConstants.LEADING &amp;&amp;</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">                    !fullRowSelection) {</span>
                // Restrict width to actual text
<span class="nc" id="L1043">                width = Math.min(width, this.getPreferredSize().width+4);</span>
            } else {
<span class="nc" id="L1045">                x -= 4;</span>
            }
<span class="nc" id="L1047">            super.setBounds(x, y, width, height);</span>
<span class="nc" id="L1048">        }</span>


        public Insets getInsets(Insets i) {
            // Provide some space between columns
<span class="nc" id="L1053">            i = super.getInsets(i);</span>
<span class="nc" id="L1054">            i.left  += 4;</span>
<span class="nc" id="L1055">            i.right += 4;</span>
<span class="nc" id="L1056">            return i;</span>
        }

        public Component getTableCellRendererComponent(JTable table, Object value,
                              boolean isSelected, boolean hasFocus, int row, int column) {

<span class="nc bnc" id="L1062" title="All 2 branches missed.">            if ((table.convertColumnIndexToModel(column) != COLUMN_FILENAME ||</span>
<span class="nc bnc" id="L1063" title="All 4 branches missed.">                    (listViewWindowsStyle &amp;&amp; !table.isFocusOwner())) &amp;&amp;</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">                    !fullRowSelection) {</span>
<span class="nc" id="L1065">                isSelected = false;</span>
            }

<span class="nc" id="L1068">            super.getTableCellRendererComponent(table, value, isSelected,</span>
                                                       hasFocus, row, column);

<span class="nc" id="L1071">            setIcon(null);</span>

<span class="nc" id="L1073">            int modelColumn = table.convertColumnIndexToModel(column);</span>
<span class="nc" id="L1074">            ShellFolderColumnInfo columnInfo = detailsTableModel.getColumns()[modelColumn];</span>

<span class="nc" id="L1076">            Integer alignment = columnInfo.getAlignment();</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">            if (alignment == null) {</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">                alignment = (value instanceof Number)</span>
                        ? SwingConstants.RIGHT
                        : SwingConstants.LEADING;
            }

<span class="nc" id="L1083">            setHorizontalAlignment(alignment);</span>

            // formatting cell text
            // TODO: it's rather a temporary trick, to be revised
            String text;

<span class="nc bnc" id="L1089" title="All 2 branches missed.">            if (value == null) {</span>
<span class="nc" id="L1090">                text = &quot;&quot;;</span>

<span class="nc bnc" id="L1092" title="All 2 branches missed.">            } else if (value instanceof File) {</span>
<span class="nc" id="L1093">                File file = (File)value;</span>
<span class="nc" id="L1094">                text = chooser.getName(file);</span>
<span class="nc" id="L1095">                Icon icon = chooser.getIcon(file);</span>
<span class="nc" id="L1096">                setIcon(icon);</span>

<span class="nc bnc" id="L1098" title="All 2 branches missed.">            } else if (value instanceof Long) {</span>
<span class="nc" id="L1099">                long len = ((Long) value) / 1024L;</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">                if (listViewWindowsStyle) {</span>
<span class="nc" id="L1101">                    text = MessageFormat.format(kiloByteString, len + 1);</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">                } else if (len &lt; 1024L) {</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">                    text = MessageFormat.format(kiloByteString, (len == 0L) ? 1L : len);</span>
                } else {
<span class="nc" id="L1105">                    len /= 1024L;</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">                    if (len &lt; 1024L) {</span>
<span class="nc" id="L1107">                        text = MessageFormat.format(megaByteString, len);</span>
                    } else {
<span class="nc" id="L1109">                        len /= 1024L;</span>
<span class="nc" id="L1110">                        text = MessageFormat.format(gigaByteString, len);</span>
                    }
                }

<span class="nc bnc" id="L1114" title="All 2 branches missed.">            } else if (value instanceof Date) {</span>
<span class="nc" id="L1115">                text = df.format((Date)value);</span>

            } else {
<span class="nc" id="L1118">                text = value.toString();</span>
            }

<span class="nc" id="L1121">            setText(text);</span>

<span class="nc" id="L1123">            return this;</span>
        }
    }

    public JPanel createDetailsView() {
<span class="nc" id="L1128">        final JFileChooser chooser = getFileChooser();</span>

<span class="nc" id="L1130">        JPanel p = new JPanel(new BorderLayout());</span>

<span class="nc" id="L1132">        final JTable detailsTable = new JTable(getDetailsTableModel()) {</span>
            // Handle Escape key events here
            protected boolean processKeyBinding(KeyStroke ks, KeyEvent e, int condition, boolean pressed) {
<span class="nc bnc" id="L1135" title="All 4 branches missed.">                if (e.getKeyCode() == KeyEvent.VK_ESCAPE &amp;&amp; getCellEditor() == null) {</span>
                    // We are not editing, forward to filechooser.
<span class="nc" id="L1137">                    chooser.dispatchEvent(e);</span>
<span class="nc" id="L1138">                    return true;</span>
                }
<span class="nc" id="L1140">                return super.processKeyBinding(ks, e, condition, pressed);</span>
            }

            public void tableChanged(TableModelEvent e) {
<span class="nc" id="L1144">                super.tableChanged(e);</span>

<span class="nc bnc" id="L1146" title="All 2 branches missed.">                if (e.getFirstRow() == TableModelEvent.HEADER_ROW) {</span>
                    // update header with possibly changed column set
<span class="nc" id="L1148">                    updateDetailsColumnModel(this);</span>
                }
<span class="nc" id="L1150">            }</span>
        };

<span class="nc" id="L1153">        detailsTable.setRowSorter(getRowSorter());</span>
<span class="nc" id="L1154">        detailsTable.setAutoCreateColumnsFromModel(false);</span>
<span class="nc" id="L1155">        detailsTable.setComponentOrientation(chooser.getComponentOrientation());</span>
<span class="nc" id="L1156">        detailsTable.setAutoResizeMode(JTable.AUTO_RESIZE_OFF);</span>
<span class="nc" id="L1157">        detailsTable.setShowGrid(false);</span>
<span class="nc" id="L1158">        detailsTable.putClientProperty(&quot;JTable.autoStartsEdit&quot;, Boolean.FALSE);</span>
<span class="nc" id="L1159">        detailsTable.addKeyListener(detailsKeyListener);</span>

<span class="nc" id="L1161">        Font font = list.getFont();</span>
<span class="nc" id="L1162">        detailsTable.setFont(font);</span>
<span class="nc" id="L1163">        detailsTable.setIntercellSpacing(new Dimension(0, 0));</span>

<span class="nc" id="L1165">        TableCellRenderer headerRenderer =</span>
<span class="nc" id="L1166">                new AlignableTableHeaderRenderer(detailsTable.getTableHeader().getDefaultRenderer());</span>
<span class="nc" id="L1167">        detailsTable.getTableHeader().setDefaultRenderer(headerRenderer);</span>
<span class="nc" id="L1168">        TableCellRenderer cellRenderer = new DetailsTableCellRenderer(chooser);</span>
<span class="nc" id="L1169">        detailsTable.setDefaultRenderer(Object.class, cellRenderer);</span>

        // So that drag can be started on a mouse press
<span class="nc" id="L1172">        detailsTable.getColumnModel().getSelectionModel().</span>
<span class="nc" id="L1173">            setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>

<span class="nc" id="L1175">        detailsTable.addMouseListener(getMouseHandler());</span>
        // No need to addListSelectionListener because selections are forwarded
        // to our JList.

        // 4835633 : tell BasicTableUI that this is a file list
<span class="nc" id="L1180">        detailsTable.putClientProperty(&quot;Table.isFileList&quot;, Boolean.TRUE);</span>

<span class="nc bnc" id="L1182" title="All 2 branches missed.">        if (listViewWindowsStyle) {</span>
<span class="nc" id="L1183">            detailsTable.addFocusListener(repaintListener);</span>
        }

        // TAB/SHIFT-TAB should transfer focus and ENTER should select an item.
        // We don't want them to navigate within the table
<span class="nc" id="L1188">        ActionMap am = SwingUtilities.getUIActionMap(detailsTable);</span>
<span class="nc" id="L1189">        am.remove(&quot;selectNextRowCell&quot;);</span>
<span class="nc" id="L1190">        am.remove(&quot;selectPreviousRowCell&quot;);</span>
<span class="nc" id="L1191">        am.remove(&quot;selectNextColumnCell&quot;);</span>
<span class="nc" id="L1192">        am.remove(&quot;selectPreviousColumnCell&quot;);</span>
<span class="nc" id="L1193">        detailsTable.setFocusTraversalKeys(KeyboardFocusManager.FORWARD_TRAVERSAL_KEYS,</span>
                     null);
<span class="nc" id="L1195">        detailsTable.setFocusTraversalKeys(KeyboardFocusManager.BACKWARD_TRAVERSAL_KEYS,</span>
                     null);

<span class="nc" id="L1198">        JScrollPane scrollpane = new JScrollPane(detailsTable);</span>
<span class="nc" id="L1199">        scrollpane.setComponentOrientation(chooser.getComponentOrientation());</span>
<span class="nc" id="L1200">        LookAndFeel.installColors(scrollpane.getViewport(), &quot;Table.background&quot;, &quot;Table.foreground&quot;);</span>

        // Adjust width of first column so the table fills the viewport when
        // first displayed (temporary listener).
<span class="nc" id="L1204">        scrollpane.addComponentListener(new ComponentAdapter() {</span>
            public void componentResized(ComponentEvent e) {
<span class="nc" id="L1206">                JScrollPane sp = (JScrollPane)e.getComponent();</span>
<span class="nc" id="L1207">                fixNameColumnWidth(sp.getViewport().getSize().width);</span>
<span class="nc" id="L1208">                sp.removeComponentListener(this);</span>
<span class="nc" id="L1209">            }</span>
        });

        // 4835633.
        // If the mouse is pressed in the area below the Details view table, the
        // event is not dispatched to the Table MouseListener but to the
        // scrollpane.  Listen for that here so we can clear the selection.
<span class="nc" id="L1216">        scrollpane.addMouseListener(new MouseAdapter() {</span>
            public void mousePressed(MouseEvent e) {
<span class="nc" id="L1218">                JScrollPane jsp = ((JScrollPane)e.getComponent());</span>
<span class="nc" id="L1219">                JTable table = (JTable)jsp.getViewport().getView();</span>

<span class="nc bnc" id="L1221" title="All 4 branches missed.">                if (!e.isShiftDown() || table.getSelectionModel().getSelectionMode() == ListSelectionModel.SINGLE_SELECTION) {</span>
<span class="nc" id="L1222">                    clearSelection();</span>
<span class="nc" id="L1223">                    TableCellEditor tce = table.getCellEditor();</span>
<span class="nc bnc" id="L1224" title="All 2 branches missed.">                    if (tce != null) {</span>
<span class="nc" id="L1225">                        tce.stopCellEditing();</span>
                    }
                }
<span class="nc" id="L1228">            }</span>
        });

<span class="nc" id="L1231">        detailsTable.setForeground(list.getForeground());</span>
<span class="nc" id="L1232">        detailsTable.setBackground(list.getBackground());</span>

<span class="nc bnc" id="L1234" title="All 2 branches missed.">        if (listViewBorder != null) {</span>
<span class="nc" id="L1235">            scrollpane.setBorder(listViewBorder);</span>
        }
<span class="nc" id="L1237">        p.add(scrollpane, BorderLayout.CENTER);</span>

<span class="nc" id="L1239">        detailsTableModel.fireTableStructureChanged();</span>

<span class="nc" id="L1241">        detailsTable.putClientProperty(AccessibleContext.ACCESSIBLE_NAME_PROPERTY, filesDetailsAccessibleName);</span>

<span class="nc" id="L1243">        return p;</span>
    } // createDetailsView

    private class AlignableTableHeaderRenderer implements TableCellRenderer {
        TableCellRenderer wrappedRenderer;

<span class="nc" id="L1249">        public AlignableTableHeaderRenderer(TableCellRenderer wrappedRenderer) {</span>
<span class="nc" id="L1250">            this.wrappedRenderer = wrappedRenderer;</span>
<span class="nc" id="L1251">        }</span>

        public Component getTableCellRendererComponent(
                                JTable table, Object value, boolean isSelected,
                                boolean hasFocus, int row, int column) {

<span class="nc" id="L1257">            Component c = wrappedRenderer.getTableCellRendererComponent(</span>
                                table, value, isSelected, hasFocus, row, column);

<span class="nc" id="L1260">            int modelColumn = table.convertColumnIndexToModel(column);</span>
<span class="nc" id="L1261">            ShellFolderColumnInfo columnInfo = detailsTableModel.getColumns()[modelColumn];</span>

<span class="nc" id="L1263">            Integer alignment = columnInfo.getAlignment();</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">            if (alignment == null) {</span>
<span class="nc" id="L1265">                alignment = SwingConstants.CENTER;</span>
            }
<span class="nc bnc" id="L1267" title="All 2 branches missed.">            if (c instanceof JLabel) {</span>
<span class="nc" id="L1268">                ((JLabel) c).setHorizontalAlignment(alignment);</span>
            }

<span class="nc" id="L1271">            return c;</span>
        }
    }

    private void fixNameColumnWidth(int viewWidth) {
<span class="nc" id="L1276">        TableColumn nameCol = detailsTable.getColumnModel().getColumn(COLUMN_FILENAME);</span>
<span class="nc" id="L1277">        int tableWidth = detailsTable.getPreferredSize().width;</span>

<span class="nc bnc" id="L1279" title="All 2 branches missed.">        if (tableWidth &lt; viewWidth) {</span>
<span class="nc" id="L1280">            nameCol.setPreferredWidth(nameCol.getPreferredWidth() + viewWidth - tableWidth);</span>
        }
<span class="nc" id="L1282">    }</span>

    private class DelayedSelectionUpdater implements Runnable {
        File editFile;

        DelayedSelectionUpdater() {
<span class="nc" id="L1288">            this(null);</span>
<span class="nc" id="L1289">        }</span>

<span class="nc" id="L1291">        DelayedSelectionUpdater(File editFile) {</span>
<span class="nc" id="L1292">            this.editFile = editFile;</span>
<span class="nc bnc" id="L1293" title="All 2 branches missed.">            if (isShowing()) {</span>
<span class="nc" id="L1294">                SwingUtilities.invokeLater(this);</span>
            }
<span class="nc" id="L1296">        }</span>

        public void run() {
<span class="nc" id="L1299">            setFileSelected();</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">            if (editFile != null) {</span>
<span class="nc" id="L1301">                editFileName(getRowSorter().convertRowIndexToView(</span>
<span class="nc" id="L1302">                        getModel().indexOf(editFile)));</span>
<span class="nc" id="L1303">                editFile = null;</span>
            }
<span class="nc" id="L1305">        }</span>
    }


    /**
     * Creates a selection listener for the list of files and directories.
     *
     * @return a &lt;code&gt;ListSelectionListener&lt;/code&gt;
     */
    public ListSelectionListener createListSelectionListener() {
<span class="nc" id="L1315">        return fileChooserUIAccessor.createListSelectionListener();</span>
    }

<span class="nc" id="L1318">    int lastIndex = -1;</span>
<span class="nc" id="L1319">    File editFile = null;</span>

    private int getEditIndex() {
<span class="nc" id="L1322">        return lastIndex;</span>
    }

    private void setEditIndex(int i) {
<span class="nc" id="L1326">        lastIndex = i;</span>
<span class="nc" id="L1327">    }</span>

    private void resetEditIndex() {
<span class="nc" id="L1330">        lastIndex = -1;</span>
<span class="nc" id="L1331">    }</span>

    private void cancelEdit() {
<span class="nc bnc" id="L1334" title="All 2 branches missed.">        if (editFile != null) {</span>
<span class="nc" id="L1335">            editFile = null;</span>
<span class="nc" id="L1336">            list.remove(editCell);</span>
<span class="nc" id="L1337">            repaint();</span>
<span class="nc bnc" id="L1338" title="All 4 branches missed.">        } else if (detailsTable != null &amp;&amp; detailsTable.isEditing()) {</span>
<span class="nc" id="L1339">            detailsTable.getCellEditor().cancelCellEditing();</span>
        }
<span class="nc" id="L1341">    }</span>

<span class="nc" id="L1343">    JTextField editCell = null;</span>

    /**
     * @param index visual index of the file to be edited
     */
    private void editFileName(int index) {
<span class="nc" id="L1349">        JFileChooser chooser = getFileChooser();</span>
<span class="nc" id="L1350">        File currentDirectory = chooser.getCurrentDirectory();</span>

<span class="nc bnc" id="L1352" title="All 4 branches missed.">        if (readOnly || !canWrite(currentDirectory)) {</span>
<span class="nc" id="L1353">            return;</span>
        }

<span class="nc" id="L1356">        ensureIndexIsVisible(index);</span>
<span class="nc bnc" id="L1357" title="All 3 branches missed.">        switch (viewType) {</span>
          case VIEWTYPE_LIST:
<span class="nc" id="L1359">            editFile = (File)getModel().getElementAt(getRowSorter().convertRowIndexToModel(index));</span>
<span class="nc" id="L1360">            Rectangle r = list.getCellBounds(index, index);</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">            if (editCell == null) {</span>
<span class="nc" id="L1362">                editCell = new JTextField();</span>
<span class="nc" id="L1363">                editCell.setName(&quot;Tree.cellEditor&quot;);</span>
<span class="nc" id="L1364">                editCell.addActionListener(new EditActionListener());</span>
<span class="nc" id="L1365">                editCell.addFocusListener(editorFocusListener);</span>
<span class="nc" id="L1366">                editCell.setNextFocusableComponent(list);</span>
            }
<span class="nc" id="L1368">            list.add(editCell);</span>
<span class="nc" id="L1369">            editCell.setText(chooser.getName(editFile));</span>
<span class="nc" id="L1370">            ComponentOrientation orientation = list.getComponentOrientation();</span>
<span class="nc" id="L1371">            editCell.setComponentOrientation(orientation);</span>

<span class="nc" id="L1373">            Icon icon = chooser.getIcon(editFile);</span>

            // PENDING - grab padding (4) below from defaults table.
<span class="nc bnc" id="L1376" title="All 2 branches missed.">            int editX = icon == null ? 20 : icon.getIconWidth() + 4;</span>

<span class="nc bnc" id="L1378" title="All 2 branches missed.">            if (orientation.isLeftToRight()) {</span>
<span class="nc" id="L1379">                editCell.setBounds(editX + r.x, r.y, r.width - editX, r.height);</span>
            } else {
<span class="nc" id="L1381">                editCell.setBounds(r.x, r.y, r.width - editX, r.height);</span>
            }
<span class="nc" id="L1383">            editCell.requestFocus();</span>
<span class="nc" id="L1384">            editCell.selectAll();</span>
<span class="nc" id="L1385">            break;</span>

          case VIEWTYPE_DETAILS:
<span class="nc" id="L1388">            detailsTable.editCellAt(index, COLUMN_FILENAME);</span>
            break;
        }
<span class="nc" id="L1391">    }</span>


<span class="nc" id="L1394">    class EditActionListener implements ActionListener {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1396">            applyEdit();</span>
<span class="nc" id="L1397">        }</span>
    }

    private void applyEdit() {
<span class="nc bnc" id="L1401" title="All 4 branches missed.">        if (editFile != null &amp;&amp; editFile.exists()) {</span>
<span class="nc" id="L1402">            JFileChooser chooser = getFileChooser();</span>
<span class="nc" id="L1403">            String oldDisplayName = chooser.getName(editFile);</span>
<span class="nc" id="L1404">            String oldFileName = editFile.getName();</span>
<span class="nc" id="L1405">            String newDisplayName = editCell.getText().trim();</span>
            String newFileName;

<span class="nc bnc" id="L1408" title="All 2 branches missed.">            if (!newDisplayName.equals(oldDisplayName)) {</span>
<span class="nc" id="L1409">                newFileName = newDisplayName;</span>
                //Check if extension is hidden from user
<span class="nc" id="L1411">                int i1 = oldFileName.length();</span>
<span class="nc" id="L1412">                int i2 = oldDisplayName.length();</span>
<span class="nc bnc" id="L1413" title="All 4 branches missed.">                if (i1 &gt; i2 &amp;&amp; oldFileName.charAt(i2) == '.') {</span>
<span class="nc" id="L1414">                    newFileName = newDisplayName + oldFileName.substring(i2);</span>
                }

                // rename
<span class="nc" id="L1418">                FileSystemView fsv = chooser.getFileSystemView();</span>
<span class="nc" id="L1419">                File f2 = fsv.createFileObject(editFile.getParentFile(), newFileName);</span>
<span class="nc bnc" id="L1420" title="All 2 branches missed.">                if (f2.exists()) {</span>
<span class="nc" id="L1421">                    JOptionPane.showMessageDialog(chooser, MessageFormat.format(renameErrorFileExistsText, oldFileName),</span>
                            renameErrorTitleText, JOptionPane.ERROR_MESSAGE);
                } else {
<span class="nc bnc" id="L1424" title="All 2 branches missed.">                    if (getModel().renameFile(editFile, f2)) {</span>
<span class="nc bnc" id="L1425" title="All 2 branches missed.">                        if (fsv.isParent(chooser.getCurrentDirectory(), f2)) {</span>
<span class="nc bnc" id="L1426" title="All 2 branches missed.">                            if (chooser.isMultiSelectionEnabled()) {</span>
<span class="nc" id="L1427">                                chooser.setSelectedFiles(new File[]{f2});</span>
                            } else {
<span class="nc" id="L1429">                                chooser.setSelectedFile(f2);</span>
                            }
                        } else {
                            //Could be because of delay in updating Desktop folder
                            //chooser.setSelectedFile(null);
                        }
                    } else {
<span class="nc" id="L1436">                        JOptionPane.showMessageDialog(chooser, MessageFormat.format(renameErrorText, oldFileName),</span>
                                renameErrorTitleText, JOptionPane.ERROR_MESSAGE);
                    }
                }
            }
        }
<span class="nc bnc" id="L1442" title="All 4 branches missed.">        if (detailsTable != null &amp;&amp; detailsTable.isEditing()) {</span>
<span class="nc" id="L1443">            detailsTable.getCellEditor().stopCellEditing();</span>
        }
<span class="nc" id="L1445">        cancelEdit();</span>
<span class="nc" id="L1446">    }</span>

    protected Action newFolderAction;

    public Action getNewFolderAction() {
<span class="nc bnc" id="L1451" title="All 4 branches missed.">        if (!readOnly &amp;&amp; newFolderAction == null) {</span>
<span class="nc" id="L1452">            newFolderAction = new AbstractAction(newFolderActionLabelText) {</span>
                private Action basicNewFolderAction;

                // Initializer
                {
<span class="nc" id="L1457">                    putValue(Action.ACTION_COMMAND_KEY, FilePane.ACTION_NEW_FOLDER);</span>

<span class="nc" id="L1459">                    File currentDirectory = getFileChooser().getCurrentDirectory();</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">                    if (currentDirectory != null) {</span>
<span class="nc" id="L1461">                        setEnabled(canWrite(currentDirectory));</span>
                    }
<span class="nc" id="L1463">                }</span>

                public void actionPerformed(ActionEvent ev) {
<span class="nc bnc" id="L1466" title="All 2 branches missed.">                    if (basicNewFolderAction == null) {</span>
<span class="nc" id="L1467">                        basicNewFolderAction = fileChooserUIAccessor.getNewFolderAction();</span>
                    }
<span class="nc" id="L1469">                    JFileChooser fc = getFileChooser();</span>
<span class="nc" id="L1470">                    File oldFile = fc.getSelectedFile();</span>
<span class="nc" id="L1471">                    basicNewFolderAction.actionPerformed(ev);</span>
<span class="nc" id="L1472">                    File newFile = fc.getSelectedFile();</span>
<span class="nc bnc" id="L1473" title="All 6 branches missed.">                    if (newFile != null &amp;&amp; !newFile.equals(oldFile) &amp;&amp; newFile.isDirectory()) {</span>
<span class="nc" id="L1474">                        newFolderFile = newFile;</span>
                    }
<span class="nc" id="L1476">                }</span>
            };
        }
<span class="nc" id="L1479">        return newFolderAction;</span>
    }

<span class="nc" id="L1482">    protected class FileRenderer extends DefaultListCellRenderer  {</span>

        public Component getListCellRendererComponent(JList list, Object value,
                                                      int index, boolean isSelected,
                                                      boolean cellHasFocus) {

<span class="nc bnc" id="L1488" title="All 4 branches missed.">            if (listViewWindowsStyle &amp;&amp; !list.isFocusOwner()) {</span>
<span class="nc" id="L1489">                isSelected = false;</span>
            }

<span class="nc" id="L1492">            super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);</span>
<span class="nc" id="L1493">            File file = (File) value;</span>
<span class="nc" id="L1494">            String fileName = getFileChooser().getName(file);</span>
<span class="nc" id="L1495">            setText(fileName);</span>
<span class="nc" id="L1496">            setFont(list.getFont());</span>

<span class="nc" id="L1498">            Icon icon = getFileChooser().getIcon(file);</span>
<span class="nc bnc" id="L1499" title="All 2 branches missed.">            if (icon != null) {</span>
<span class="nc" id="L1500">                setIcon(icon);</span>
            } else {
<span class="nc bnc" id="L1502" title="All 2 branches missed.">                if (getFileChooser().getFileSystemView().isTraversable(file)) {</span>
<span class="nc" id="L1503">                    setText(fileName+File.separator);</span>
                }
            }

<span class="nc" id="L1507">            return this;</span>
        }
    }


    void setFileSelected() {
<span class="nc bnc" id="L1513" title="All 4 branches missed.">        if (getFileChooser().isMultiSelectionEnabled() &amp;&amp; !isDirectorySelected()) {</span>
<span class="nc" id="L1514">            File[] files = getFileChooser().getSelectedFiles(); // Should be selected</span>
<span class="nc" id="L1515">            Object[] selectedObjects = list.getSelectedValues(); // Are actually selected</span>

<span class="nc" id="L1517">            listSelectionModel.setValueIsAdjusting(true);</span>
            try {
<span class="nc" id="L1519">                int lead = listSelectionModel.getLeadSelectionIndex();</span>
<span class="nc" id="L1520">                int anchor = listSelectionModel.getAnchorSelectionIndex();</span>

<span class="nc" id="L1522">                Arrays.sort(files);</span>
<span class="nc" id="L1523">                Arrays.sort(selectedObjects);</span>

<span class="nc" id="L1525">                int shouldIndex = 0;</span>
<span class="nc" id="L1526">                int actuallyIndex = 0;</span>

                // Remove files that shouldn't be selected and add files which should be selected
                // Note: Assume files are already sorted in compareTo order.
<span class="nc bnc" id="L1530" title="All 4 branches missed.">                while (shouldIndex &lt; files.length &amp;&amp;</span>
                       actuallyIndex &lt; selectedObjects.length) {
<span class="nc" id="L1532">                    int comparison = files[shouldIndex].compareTo((File)selectedObjects[actuallyIndex]);</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">                    if (comparison &lt; 0) {</span>
<span class="nc" id="L1534">                        doSelectFile(files[shouldIndex++]);</span>
<span class="nc bnc" id="L1535" title="All 2 branches missed.">                    } else if (comparison &gt; 0) {</span>
<span class="nc" id="L1536">                        doDeselectFile(selectedObjects[actuallyIndex++]);</span>
                    } else {
                        // Do nothing
<span class="nc" id="L1539">                        shouldIndex++;</span>
<span class="nc" id="L1540">                        actuallyIndex++;</span>
                    }

<span class="nc" id="L1543">                }</span>

<span class="nc bnc" id="L1545" title="All 2 branches missed.">                while (shouldIndex &lt; files.length) {</span>
<span class="nc" id="L1546">                    doSelectFile(files[shouldIndex++]);</span>
                }

<span class="nc bnc" id="L1549" title="All 2 branches missed.">                while (actuallyIndex &lt; selectedObjects.length) {</span>
<span class="nc" id="L1550">                    doDeselectFile(selectedObjects[actuallyIndex++]);</span>
                }

                // restore the anchor and lead
<span class="nc bnc" id="L1554" title="All 2 branches missed.">                if (listSelectionModel instanceof DefaultListSelectionModel) {</span>
<span class="nc" id="L1555">                    ((DefaultListSelectionModel)listSelectionModel).</span>
<span class="nc" id="L1556">                        moveLeadSelectionIndex(lead);</span>
<span class="nc" id="L1557">                    listSelectionModel.setAnchorSelectionIndex(anchor);</span>
                }
            } finally {
<span class="nc" id="L1560">                listSelectionModel.setValueIsAdjusting(false);</span>
<span class="nc" id="L1561">            }</span>
<span class="nc" id="L1562">        } else {</span>
<span class="nc" id="L1563">            JFileChooser chooser = getFileChooser();</span>
            File f;
<span class="nc bnc" id="L1565" title="All 2 branches missed.">            if (isDirectorySelected()) {</span>
<span class="nc" id="L1566">                f = getDirectory();</span>
            } else {
<span class="nc" id="L1568">                f = chooser.getSelectedFile();</span>
            }
            int i;
<span class="nc bnc" id="L1571" title="All 4 branches missed.">            if (f != null &amp;&amp; (i = getModel().indexOf(f)) &gt;= 0) {</span>
<span class="nc" id="L1572">                int viewIndex = getRowSorter().convertRowIndexToView(i);</span>
<span class="nc" id="L1573">                listSelectionModel.setSelectionInterval(viewIndex, viewIndex);</span>
<span class="nc" id="L1574">                ensureIndexIsVisible(viewIndex);</span>
<span class="nc" id="L1575">            } else {</span>
<span class="nc" id="L1576">                clearSelection();</span>
            }
        }
<span class="nc" id="L1579">    }</span>

    private void doSelectFile(File fileToSelect) {
<span class="nc" id="L1582">        int index = getModel().indexOf(fileToSelect);</span>
        // could be missed in the current directory if it changed
<span class="nc bnc" id="L1584" title="All 2 branches missed.">        if (index &gt;= 0) {</span>
<span class="nc" id="L1585">            index = getRowSorter().convertRowIndexToView(index);</span>
<span class="nc" id="L1586">            listSelectionModel.addSelectionInterval(index, index);</span>
        }
<span class="nc" id="L1588">    }</span>

    private void doDeselectFile(Object fileToDeselect) {
<span class="nc" id="L1591">        int index = getRowSorter().convertRowIndexToView(</span>
<span class="nc" id="L1592">                                getModel().indexOf(fileToDeselect));</span>
<span class="nc" id="L1593">        listSelectionModel.removeSelectionInterval(index, index);</span>
<span class="nc" id="L1594">    }</span>

    /* The following methods are used by the PropertyChange Listener */

    private void doSelectedFileChanged(PropertyChangeEvent e) {
<span class="nc" id="L1599">        applyEdit();</span>
<span class="nc" id="L1600">        File f = (File) e.getNewValue();</span>
<span class="nc" id="L1601">        JFileChooser fc = getFileChooser();</span>
<span class="nc bnc" id="L1602" title="All 2 branches missed.">        if (f != null</span>
<span class="nc bnc" id="L1603" title="All 4 branches missed.">            &amp;&amp; ((fc.isFileSelectionEnabled() &amp;&amp; !f.isDirectory())</span>
<span class="nc bnc" id="L1604" title="All 4 branches missed.">                || (f.isDirectory() &amp;&amp; fc.isDirectorySelectionEnabled()))) {</span>

<span class="nc" id="L1606">            setFileSelected();</span>
        }
<span class="nc" id="L1608">    }</span>

    private void doSelectedFilesChanged(PropertyChangeEvent e) {
<span class="nc" id="L1611">        applyEdit();</span>
<span class="nc" id="L1612">        File[] files = (File[]) e.getNewValue();</span>
<span class="nc" id="L1613">        JFileChooser fc = getFileChooser();</span>
<span class="nc bnc" id="L1614" title="All 6 branches missed.">        if (files != null</span>
            &amp;&amp; files.length &gt; 0
<span class="nc bnc" id="L1616" title="All 4 branches missed.">            &amp;&amp; (files.length &gt; 1 || fc.isDirectorySelectionEnabled() || !files[0].isDirectory())) {</span>
<span class="nc" id="L1617">            setFileSelected();</span>
        }
<span class="nc" id="L1619">    }</span>

    private void doDirectoryChanged(PropertyChangeEvent e) {
<span class="nc" id="L1622">        getDetailsTableModel().updateColumnInfo();</span>

<span class="nc" id="L1624">        JFileChooser fc = getFileChooser();</span>
<span class="nc" id="L1625">        FileSystemView fsv = fc.getFileSystemView();</span>

<span class="nc" id="L1627">        applyEdit();</span>
<span class="nc" id="L1628">        resetEditIndex();</span>
<span class="nc" id="L1629">        ensureIndexIsVisible(0);</span>
<span class="nc" id="L1630">        File currentDirectory = fc.getCurrentDirectory();</span>
<span class="nc bnc" id="L1631" title="All 2 branches missed.">        if (currentDirectory != null) {</span>
<span class="nc bnc" id="L1632" title="All 2 branches missed.">            if (!readOnly) {</span>
<span class="nc" id="L1633">                getNewFolderAction().setEnabled(canWrite(currentDirectory));</span>
            }
<span class="nc bnc" id="L1635" title="All 2 branches missed.">            fileChooserUIAccessor.getChangeToParentDirectoryAction().setEnabled(!fsv.isRoot(currentDirectory));</span>
        }
<span class="nc bnc" id="L1637" title="All 2 branches missed.">        if (list != null) {</span>
<span class="nc" id="L1638">            list.clearSelection();</span>
        }
<span class="nc" id="L1640">    }</span>

    private void doFilterChanged(PropertyChangeEvent e) {
<span class="nc" id="L1643">        applyEdit();</span>
<span class="nc" id="L1644">        resetEditIndex();</span>
<span class="nc" id="L1645">        clearSelection();</span>
<span class="nc" id="L1646">    }</span>

    private void doFileSelectionModeChanged(PropertyChangeEvent e) {
<span class="nc" id="L1649">        applyEdit();</span>
<span class="nc" id="L1650">        resetEditIndex();</span>
<span class="nc" id="L1651">        clearSelection();</span>
<span class="nc" id="L1652">    }</span>

    private void doMultiSelectionChanged(PropertyChangeEvent e) {
<span class="nc bnc" id="L1655" title="All 2 branches missed.">        if (getFileChooser().isMultiSelectionEnabled()) {</span>
<span class="nc" id="L1656">            listSelectionModel.setSelectionMode(ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);</span>
        } else {
<span class="nc" id="L1658">            listSelectionModel.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L1659">            clearSelection();</span>
<span class="nc" id="L1660">            getFileChooser().setSelectedFiles(null);</span>
        }
<span class="nc" id="L1662">    }</span>

    /*
     * Listen for filechooser property changes, such as
     * the selected file changing, or the type of the dialog changing.
     */
    public void propertyChange(PropertyChangeEvent e) {
<span class="nc bnc" id="L1669" title="All 2 branches missed.">            if (viewType == -1) {</span>
<span class="nc" id="L1670">                setViewType(VIEWTYPE_LIST);</span>
            }

<span class="nc" id="L1673">        String s = e.getPropertyName();</span>
<span class="nc bnc" id="L1674" title="All 2 branches missed.">        if (s.equals(JFileChooser.SELECTED_FILE_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L1675">            doSelectedFileChanged(e);</span>
<span class="nc bnc" id="L1676" title="All 2 branches missed.">        } else if (s.equals(JFileChooser.SELECTED_FILES_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L1677">            doSelectedFilesChanged(e);</span>
<span class="nc bnc" id="L1678" title="All 2 branches missed.">        } else if (s.equals(JFileChooser.DIRECTORY_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L1679">            doDirectoryChanged(e);</span>
<span class="nc bnc" id="L1680" title="All 2 branches missed.">        } else if (s.equals(JFileChooser.FILE_FILTER_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L1681">            doFilterChanged(e);</span>
<span class="nc bnc" id="L1682" title="All 2 branches missed.">        } else if (s.equals(JFileChooser.FILE_SELECTION_MODE_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L1683">            doFileSelectionModeChanged(e);</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">        } else if (s.equals(JFileChooser.MULTI_SELECTION_ENABLED_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L1685">            doMultiSelectionChanged(e);</span>
<span class="nc bnc" id="L1686" title="All 2 branches missed.">        } else if (s.equals(JFileChooser.CANCEL_SELECTION)) {</span>
<span class="nc" id="L1687">            applyEdit();</span>
<span class="nc bnc" id="L1688" title="All 2 branches missed.">        } else if (s.equals(&quot;busy&quot;)) {</span>
<span class="nc bnc" id="L1689" title="All 2 branches missed.">            setCursor((Boolean)e.getNewValue() ? waitCursor : null);</span>
<span class="nc bnc" id="L1690" title="All 2 branches missed.">        } else if (s.equals(&quot;componentOrientation&quot;)) {</span>
<span class="nc" id="L1691">            ComponentOrientation o = (ComponentOrientation)e.getNewValue();</span>
<span class="nc" id="L1692">            JFileChooser cc = (JFileChooser)e.getSource();</span>
<span class="nc bnc" id="L1693" title="All 2 branches missed.">            if (o != e.getOldValue()) {</span>
<span class="nc" id="L1694">                cc.applyComponentOrientation(o);</span>
            }
<span class="nc bnc" id="L1696" title="All 2 branches missed.">            if (detailsTable != null) {</span>
<span class="nc" id="L1697">                detailsTable.setComponentOrientation(o);</span>
<span class="nc" id="L1698">                detailsTable.getParent().getParent().setComponentOrientation(o);</span>
            }
        }
<span class="nc" id="L1701">    }</span>

    private void ensureIndexIsVisible(int i) {
<span class="nc bnc" id="L1704" title="All 2 branches missed.">        if (i &gt;= 0) {</span>
<span class="nc bnc" id="L1705" title="All 2 branches missed.">            if (list != null) {</span>
<span class="nc" id="L1706">                list.ensureIndexIsVisible(i);</span>
            }
<span class="nc bnc" id="L1708" title="All 2 branches missed.">            if (detailsTable != null) {</span>
<span class="nc" id="L1709">                detailsTable.scrollRectToVisible(detailsTable.getCellRect(i, COLUMN_FILENAME, true));</span>
            }
        }
<span class="nc" id="L1712">    }</span>

    public void ensureFileIsVisible(JFileChooser fc, File f) {
<span class="nc" id="L1715">        int modelIndex = getModel().indexOf(f);</span>
<span class="nc bnc" id="L1716" title="All 2 branches missed.">        if (modelIndex &gt;= 0) {</span>
<span class="nc" id="L1717">            ensureIndexIsVisible(getRowSorter().convertRowIndexToView(modelIndex));</span>
        }
<span class="nc" id="L1719">    }</span>

    public void rescanCurrentDirectory() {
<span class="nc" id="L1722">        getModel().validateFileCache();</span>
<span class="nc" id="L1723">    }</span>

    public void clearSelection() {
<span class="nc bnc" id="L1726" title="All 2 branches missed.">        if (listSelectionModel != null) {</span>
<span class="nc" id="L1727">            listSelectionModel.clearSelection();</span>
<span class="nc bnc" id="L1728" title="All 2 branches missed.">            if (listSelectionModel instanceof DefaultListSelectionModel) {</span>
<span class="nc" id="L1729">                ((DefaultListSelectionModel)listSelectionModel).moveLeadSelectionIndex(0);</span>
<span class="nc" id="L1730">                listSelectionModel.setAnchorSelectionIndex(0);</span>
            }
        }
<span class="nc" id="L1733">    }</span>

    public JMenu getViewMenu() {
<span class="nc bnc" id="L1736" title="All 2 branches missed.">        if (viewMenu == null) {</span>
<span class="nc" id="L1737">            viewMenu = new JMenu(viewMenuLabelText);</span>
<span class="nc" id="L1738">            ButtonGroup viewButtonGroup = new ButtonGroup();</span>

<span class="nc bnc" id="L1740" title="All 2 branches missed.">            for (int i = 0; i &lt; VIEWTYPE_COUNT; i++) {</span>
<span class="nc" id="L1741">                JRadioButtonMenuItem mi =</span>
                    new JRadioButtonMenuItem(new ViewTypeAction(i));
<span class="nc" id="L1743">                viewButtonGroup.add(mi);</span>
<span class="nc" id="L1744">                viewMenu.add(mi);</span>
            }
<span class="nc" id="L1746">            updateViewMenu();</span>
        }
<span class="nc" id="L1748">        return viewMenu;</span>
    }

    private void updateViewMenu() {
<span class="nc bnc" id="L1752" title="All 2 branches missed.">        if (viewMenu != null) {</span>
<span class="nc" id="L1753">            Component[] comps = viewMenu.getMenuComponents();</span>
<span class="nc bnc" id="L1754" title="All 2 branches missed.">            for (Component comp : comps) {</span>
<span class="nc bnc" id="L1755" title="All 2 branches missed.">                if (comp instanceof JRadioButtonMenuItem) {</span>
<span class="nc" id="L1756">                    JRadioButtonMenuItem mi = (JRadioButtonMenuItem) comp;</span>
<span class="nc bnc" id="L1757" title="All 2 branches missed.">                    if (((ViewTypeAction)mi.getAction()).viewType == viewType) {</span>
<span class="nc" id="L1758">                        mi.setSelected(true);</span>
                    }
                }
            }
        }
<span class="nc" id="L1763">    }</span>

    public JPopupMenu getComponentPopupMenu() {
<span class="nc" id="L1766">        JPopupMenu popupMenu = getFileChooser().getComponentPopupMenu();</span>
<span class="nc bnc" id="L1767" title="All 2 branches missed.">        if (popupMenu != null) {</span>
<span class="nc" id="L1768">            return popupMenu;</span>
        }

<span class="nc" id="L1771">        JMenu viewMenu = getViewMenu();</span>
<span class="nc bnc" id="L1772" title="All 2 branches missed.">        if (contextMenu == null) {</span>
<span class="nc" id="L1773">            contextMenu = new JPopupMenu();</span>
<span class="nc bnc" id="L1774" title="All 2 branches missed.">            if (viewMenu != null) {</span>
<span class="nc" id="L1775">                contextMenu.add(viewMenu);</span>
<span class="nc bnc" id="L1776" title="All 2 branches missed.">                if (listViewWindowsStyle) {</span>
<span class="nc" id="L1777">                    contextMenu.addSeparator();</span>
                }
            }
<span class="nc" id="L1780">            ActionMap actionMap = getActionMap();</span>
<span class="nc" id="L1781">            Action refreshAction   = actionMap.get(ACTION_REFRESH);</span>
<span class="nc" id="L1782">            Action newFolderAction = actionMap.get(ACTION_NEW_FOLDER);</span>
<span class="nc bnc" id="L1783" title="All 2 branches missed.">            if (refreshAction != null) {</span>
<span class="nc" id="L1784">                contextMenu.add(refreshAction);</span>
<span class="nc bnc" id="L1785" title="All 4 branches missed.">                if (listViewWindowsStyle &amp;&amp; newFolderAction != null) {</span>
<span class="nc" id="L1786">                    contextMenu.addSeparator();</span>
                }
            }
<span class="nc bnc" id="L1789" title="All 2 branches missed.">            if (newFolderAction != null) {</span>
<span class="nc" id="L1790">                contextMenu.add(newFolderAction);</span>
            }
        }
<span class="nc bnc" id="L1793" title="All 2 branches missed.">        if (viewMenu != null) {</span>
<span class="nc" id="L1794">            viewMenu.getPopupMenu().setInvoker(viewMenu);</span>
        }
<span class="nc" id="L1796">        return contextMenu;</span>
    }


    private Handler handler;

    protected Handler getMouseHandler() {
<span class="nc bnc" id="L1803" title="All 2 branches missed.">        if (handler == null) {</span>
<span class="nc" id="L1804">            handler = new Handler();</span>
        }
<span class="nc" id="L1806">        return handler;</span>
    }

<span class="nc" id="L1809">    private class Handler implements MouseListener {</span>
        private MouseListener doubleClickListener;

        public void mouseClicked(MouseEvent evt) {
<span class="nc" id="L1813">            JComponent source = (JComponent)evt.getSource();</span>

            int index;
<span class="nc bnc" id="L1816" title="All 2 branches missed.">            if (source instanceof JList) {</span>
<span class="nc" id="L1817">                index = SwingUtilities2.loc2IndexFileList(list, evt.getPoint());</span>
<span class="nc bnc" id="L1818" title="All 2 branches missed.">            } else if (source instanceof JTable) {</span>
<span class="nc" id="L1819">                JTable table = (JTable)source;</span>
<span class="nc" id="L1820">                Point p = evt.getPoint();</span>
<span class="nc" id="L1821">                index = table.rowAtPoint(p);</span>

<span class="nc" id="L1823">                boolean pointOutsidePrefSize =</span>
<span class="nc" id="L1824">                        SwingUtilities2.pointOutsidePrefSize(</span>
<span class="nc" id="L1825">                            table, index, table.columnAtPoint(p), p);</span>

<span class="nc bnc" id="L1827" title="All 4 branches missed.">                if (pointOutsidePrefSize &amp;&amp; !fullRowSelection) {</span>
<span class="nc" id="L1828">                    return;</span>
                }

                // Translate point from table to list
<span class="nc bnc" id="L1832" title="All 4 branches missed.">                if (index &gt;= 0 &amp;&amp; list != null &amp;&amp;</span>
<span class="nc bnc" id="L1833" title="All 2 branches missed.">                    listSelectionModel.isSelectedIndex(index)) {</span>

                    // Make a new event with the list as source, placing the
                    // click in the corresponding list cell.
<span class="nc" id="L1837">                    Rectangle r = list.getCellBounds(index, index);</span>
<span class="nc" id="L1838">                    evt = new MouseEvent(list, evt.getID(),</span>
<span class="nc" id="L1839">                                         evt.getWhen(), evt.getModifiers(),</span>
                                         r.x + 1, r.y + r.height/2,
<span class="nc" id="L1841">                                         evt.getXOnScreen(),</span>
<span class="nc" id="L1842">                                         evt.getYOnScreen(),</span>
<span class="nc" id="L1843">                                         evt.getClickCount(), evt.isPopupTrigger(),</span>
<span class="nc" id="L1844">                                         evt.getButton());</span>
                }
<span class="nc" id="L1846">            } else {</span>
<span class="nc" id="L1847">                return;</span>
            }

<span class="nc bnc" id="L1850" title="All 4 branches missed.">            if (index &gt;= 0 &amp;&amp; SwingUtilities.isLeftMouseButton(evt)) {</span>
<span class="nc" id="L1851">                JFileChooser fc = getFileChooser();</span>

                // For single click, we handle editing file name
<span class="nc bnc" id="L1854" title="All 4 branches missed.">                if (evt.getClickCount() == 1 &amp;&amp; source instanceof JList) {</span>
<span class="nc bnc" id="L1855" title="All 6 branches missed.">                    if ((!fc.isMultiSelectionEnabled() || fc.getSelectedFiles().length &lt;= 1)</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">                        &amp;&amp; index &gt;= 0 &amp;&amp; listSelectionModel.isSelectedIndex(index)</span>
<span class="nc bnc" id="L1857" title="All 4 branches missed.">                        &amp;&amp; getEditIndex() == index &amp;&amp; editFile == null) {</span>

<span class="nc" id="L1859">                        editFileName(index);</span>
                    } else {
<span class="nc bnc" id="L1861" title="All 2 branches missed.">                        if (index &gt;= 0) {</span>
<span class="nc" id="L1862">                            setEditIndex(index);</span>
                        } else {
<span class="nc" id="L1864">                            resetEditIndex();</span>
                        }
                    }
<span class="nc bnc" id="L1867" title="All 2 branches missed.">                } else if (evt.getClickCount() == 2) {</span>
                    // on double click (open or drill down one directory) be
                    // sure to clear the edit index
<span class="nc" id="L1870">                    resetEditIndex();</span>
                }
            }

            // Forward event to Basic
<span class="nc bnc" id="L1875" title="All 2 branches missed.">            if (getDoubleClickListener() != null) {</span>
<span class="nc" id="L1876">                getDoubleClickListener().mouseClicked(evt);</span>
            }
<span class="nc" id="L1878">        }</span>

        public void mouseEntered(MouseEvent evt) {
<span class="nc" id="L1881">            JComponent source = (JComponent)evt.getSource();</span>
<span class="nc bnc" id="L1882" title="All 2 branches missed.">            if (source instanceof JTable) {</span>
<span class="nc" id="L1883">                JTable table = (JTable)evt.getSource();</span>

<span class="nc" id="L1885">                TransferHandler th1 = getFileChooser().getTransferHandler();</span>
<span class="nc" id="L1886">                TransferHandler th2 = table.getTransferHandler();</span>
<span class="nc bnc" id="L1887" title="All 2 branches missed.">                if (th1 != th2) {</span>
<span class="nc" id="L1888">                    table.setTransferHandler(th1);</span>
                }

<span class="nc" id="L1891">                boolean dragEnabled = getFileChooser().getDragEnabled();</span>
<span class="nc bnc" id="L1892" title="All 2 branches missed.">                if (dragEnabled != table.getDragEnabled()) {</span>
<span class="nc" id="L1893">                    table.setDragEnabled(dragEnabled);</span>
                }
<span class="nc bnc" id="L1895" title="All 2 branches missed.">            } else if (source instanceof JList) {</span>
                // Forward event to Basic
<span class="nc bnc" id="L1897" title="All 2 branches missed.">                if (getDoubleClickListener() != null) {</span>
<span class="nc" id="L1898">                    getDoubleClickListener().mouseEntered(evt);</span>
                }
            }
<span class="nc" id="L1901">        }</span>

        public void mouseExited(MouseEvent evt) {
<span class="nc bnc" id="L1904" title="All 2 branches missed.">            if (evt.getSource() instanceof JList) {</span>
                // Forward event to Basic
<span class="nc bnc" id="L1906" title="All 2 branches missed.">                if (getDoubleClickListener() != null) {</span>
<span class="nc" id="L1907">                    getDoubleClickListener().mouseExited(evt);</span>
                }
            }
<span class="nc" id="L1910">        }</span>

        public void mousePressed(MouseEvent evt) {
<span class="nc bnc" id="L1913" title="All 2 branches missed.">            if (evt.getSource() instanceof JList) {</span>
                // Forward event to Basic
<span class="nc bnc" id="L1915" title="All 2 branches missed.">                if (getDoubleClickListener() != null) {</span>
<span class="nc" id="L1916">                    getDoubleClickListener().mousePressed(evt);</span>
                }
            }
<span class="nc" id="L1919">        }</span>

        public void mouseReleased(MouseEvent evt) {
<span class="nc bnc" id="L1922" title="All 2 branches missed.">            if (evt.getSource() instanceof JList) {</span>
                // Forward event to Basic
<span class="nc bnc" id="L1924" title="All 2 branches missed.">                if (getDoubleClickListener() != null) {</span>
<span class="nc" id="L1925">                    getDoubleClickListener().mouseReleased(evt);</span>
                }
            }
<span class="nc" id="L1928">        }</span>

        private MouseListener getDoubleClickListener() {
            // Lazy creation of Basic's listener
<span class="nc bnc" id="L1932" title="All 4 branches missed.">            if (doubleClickListener == null &amp;&amp; list != null) {</span>
<span class="nc" id="L1933">                doubleClickListener =</span>
<span class="nc" id="L1934">                    fileChooserUIAccessor.createDoubleClickListener(list);</span>
            }
<span class="nc" id="L1936">            return doubleClickListener;</span>
        }
    }

    /**
     * Property to remember whether a directory is currently selected in the UI.
     *
     * @return &lt;code&gt;true&lt;/code&gt; iff a directory is currently selected.
     */
    protected boolean isDirectorySelected() {
<span class="nc" id="L1946">        return fileChooserUIAccessor.isDirectorySelected();</span>
    }


    /**
     * Property to remember the directory that is currently selected in the UI.
     *
     * @return the value of the &lt;code&gt;directory&lt;/code&gt; property
     * @see javax.swing.plaf.basic.BasicFileChooserUI#setDirectory
     */
    protected File getDirectory() {
<span class="nc" id="L1957">        return fileChooserUIAccessor.getDirectory();</span>
    }

    private Component findChildComponent(Container container, Class cls) {
<span class="nc" id="L1961">        int n = container.getComponentCount();</span>
<span class="nc bnc" id="L1962" title="All 2 branches missed.">        for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L1963">            Component comp = container.getComponent(i);</span>
<span class="nc bnc" id="L1964" title="All 2 branches missed.">            if (cls.isInstance(comp)) {</span>
<span class="nc" id="L1965">                return comp;</span>
<span class="nc bnc" id="L1966" title="All 2 branches missed.">            } else if (comp instanceof Container) {</span>
<span class="nc" id="L1967">                Component c = findChildComponent((Container)comp, cls);</span>
<span class="nc bnc" id="L1968" title="All 2 branches missed.">                if (c != null) {</span>
<span class="nc" id="L1969">                    return c;</span>
                }
            }
        }
<span class="nc" id="L1973">        return null;</span>
    }

    public boolean canWrite(File f) {
        // Return false for non FileSystem files or if file doesn't exist.
<span class="nc bnc" id="L1978" title="All 2 branches missed.">        if (!f.exists()) {</span>
<span class="nc" id="L1979">            return false;</span>
        }

<span class="nc bnc" id="L1982" title="All 2 branches missed.">        if (f instanceof ShellFolder) {</span>
<span class="nc" id="L1983">            return f.canWrite();</span>
        } else {
<span class="nc bnc" id="L1985" title="All 2 branches missed.">            if (usesShellFolder(getFileChooser())) {</span>
                try {
<span class="nc" id="L1987">                    return ShellFolder.getShellFolder(f).canWrite();</span>
<span class="nc" id="L1988">                } catch (FileNotFoundException ex) {</span>
                    // File doesn't exist
<span class="nc" id="L1990">                    return false;</span>
                }
            } else {
                // Ordinary file
<span class="nc" id="L1994">                return f.canWrite();</span>
            }
        }
    }

    /**
     * Returns true if specified FileChooser should use ShellFolder
     */
    public static boolean usesShellFolder(JFileChooser chooser) {
<span class="nc" id="L2003">        Boolean prop = (Boolean) chooser.getClientProperty(&quot;FileChooser.useShellFolder&quot;);</span>

<span class="nc bnc" id="L2005" title="All 2 branches missed.">        return prop == null ? chooser.getFileSystemView().equals(FileSystemView.getFileSystemView())</span>
<span class="nc" id="L2006">                : prop.booleanValue();</span>
    }

    // This interface is used to access methods in the FileChooserUI
    // that are not public.
    public interface FileChooserUIAccessor {
        public JFileChooser getFileChooser();
        public BasicDirectoryModel getModel();
        public JPanel createList();
        public JPanel createDetailsView();
        public boolean isDirectorySelected();
        public File getDirectory();
        public Action getApproveSelectionAction();
        public Action getChangeToParentDirectoryAction();
        public Action getNewFolderAction();
        public MouseListener createDoubleClickListener(JList list);
        public ListSelectionListener createListSelectionListener();
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>