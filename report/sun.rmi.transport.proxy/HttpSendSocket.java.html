<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>HttpSendSocket.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.rmi.transport.proxy</a> &gt; <span class="el_source">HttpSendSocket.java</span></div><h1>HttpSendSocket.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1996, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package sun.rmi.transport.proxy;

import java.io.*;
import java.net.*;

import sun.rmi.runtime.Log;

/**
 * The HttpSendSocket class extends the java.net.Socket class
 * by enclosing the data output stream in, then extracting the input
 * stream from, an HTTP protocol transmission.
 *
 * NOTES:
 *
 * Since the length of the output request must be known before the
 * HTTP header can be completed, all of the output is buffered by
 * an HttpOutputStream object until either an attempt is made to
 * read from this socket, or the socket is explicitly closed.
 *
 * On the first read attempt to read from this socket, the buffered
 * output is sent to the destination as the body of an HTTP POST
 * request.  All reads will then acquire data from the body of
 * the response.  A subsequent attempt to write to this socket will
 * throw an IOException.
 */
class HttpSendSocket extends Socket implements RMISocketInfo {

    /** the host to connect to */
    protected String host;

    /** the port to connect to */
    protected int port;

    /** the URL to forward through */
    protected URL url;

    /** the object managing this connection through the URL */
<span class="fc" id="L62">    protected URLConnection conn = null;</span>

    /** internal input stream for this socket */
<span class="fc" id="L65">    protected InputStream in = null;</span>

    /** internal output stream for this socket */
<span class="fc" id="L68">    protected OutputStream out = null;</span>

    /** the notifying input stream returned to users */
    protected HttpSendInputStream inNotifier;

    /** the notifying output stream returned to users */
    protected HttpSendOutputStream outNotifier;

    /**
     * Line separator string.  This is the value of the line.separator
     * property at the moment that the socket was created.
     */
<span class="fc" id="L80">    private String lineSeparator =</span>
<span class="fc" id="L81">        java.security.AccessController.doPrivileged(</span>
            new sun.security.action.GetPropertyAction(&quot;line.separator&quot;));

    /**
     * Create a stream socket and connect it to the specified port on
     * the specified host.
     * @param host the host
     * @param port the port
     */
    public HttpSendSocket(String host, int port, URL url) throws IOException
    {
<span class="fc" id="L92">        super((SocketImpl)null);        // no underlying SocketImpl for this object</span>

<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if (RMIMasterSocketFactory.proxyLog.isLoggable(Log.VERBOSE)) {</span>
<span class="nc" id="L95">            RMIMasterSocketFactory.proxyLog.log(Log.VERBOSE,</span>
                &quot;host = &quot; + host + &quot;, port = &quot; + port + &quot;, url = &quot; + url);
        }

<span class="fc" id="L99">        this.host = host;</span>
<span class="fc" id="L100">        this.port = port;</span>
<span class="fc" id="L101">        this.url = url;</span>

<span class="fc" id="L103">        inNotifier = new HttpSendInputStream(null, this);</span>
<span class="fc" id="L104">        outNotifier = new HttpSendOutputStream(writeNotify(), this);</span>
<span class="fc" id="L105">    }</span>

    /**
     * Create a stream socket and connect it to the specified port on
     * the specified host.
     * @param host the host
     * @param port the port
     */
    public HttpSendSocket(String host, int port) throws IOException
    {
<span class="nc" id="L115">        this(host, port, new URL(&quot;http&quot;, host, port, &quot;/&quot;));</span>
<span class="nc" id="L116">    }</span>

    /**
     * Create a stream socket and connect it to the specified address on
     * the specified port.
     * @param address the address
     * @param port the port
     */
    public HttpSendSocket(InetAddress address, int port) throws IOException
    {
<span class="nc" id="L126">        this(address.getHostName(), port);</span>
<span class="nc" id="L127">    }</span>

    /**
     * Indicate that this socket is not reusable.
     */
    public boolean isReusable()
    {
<span class="fc" id="L134">        return false;</span>
    }

    /**
     * Create a new socket connection to host (or proxy), and prepare to
     * send HTTP transmission.
     */
    public synchronized OutputStream writeNotify() throws IOException
    {
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (conn != null) {</span>
<span class="nc" id="L144">            throw new IOException(&quot;attempt to write on HttpSendSocket after &quot; +</span>
                                  &quot;request has been sent&quot;);
        }

<span class="fc" id="L148">        conn = url.openConnection();</span>
<span class="fc" id="L149">        conn.setDoOutput(true);</span>
<span class="fc" id="L150">        conn.setUseCaches(false);</span>
<span class="fc" id="L151">        conn.setRequestProperty(&quot;Content-type&quot;, &quot;application/octet-stream&quot;);</span>

<span class="fc" id="L153">        inNotifier.deactivate();</span>
<span class="fc" id="L154">        in = null;</span>

<span class="fc" id="L156">        return out = conn.getOutputStream();</span>
    }

    /**
     * Send HTTP output transmission and prepare to receive response.
     */
    public synchronized InputStream readNotify() throws IOException
    {
<span class="fc" id="L164">        RMIMasterSocketFactory.proxyLog.log(Log.VERBOSE,</span>
            &quot;sending request and activating input stream&quot;);

<span class="fc" id="L167">        outNotifier.deactivate();</span>
<span class="fc" id="L168">        out.close();</span>
<span class="fc" id="L169">        out = null;</span>

        try {
<span class="fc" id="L172">            in = conn.getInputStream();</span>
<span class="nc" id="L173">        } catch (IOException e) {</span>
<span class="nc" id="L174">            RMIMasterSocketFactory.proxyLog.log(Log.BRIEF,</span>
                &quot;failed to get input stream, exception: &quot;, e);

<span class="nc" id="L177">            throw new IOException(&quot;HTTP request failed&quot;);</span>
<span class="fc" id="L178">        }</span>

        /*
         * If an HTTP error response is returned, sometimes an IOException
         * is thrown, which is handled above, and other times it isn't, and
         * the error response body will be available for reading.
         * As a safety net to catch any such unexpected HTTP behavior, we
         * verify that the content type of the response is what the
         * HttpOutputStream generates: &quot;application/octet-stream&quot;.
         * (Servers' error responses will generally be &quot;text/html&quot;.)
         * Any error response body is printed to the log.
         */
<span class="fc" id="L190">        String contentType = conn.getContentType();</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        if (contentType == null ||</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            !conn.getContentType().equals(&quot;application/octet-stream&quot;))</span>
        {
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (RMIMasterSocketFactory.proxyLog.isLoggable(Log.BRIEF)) {</span>
                String message;
<span class="nc bnc" id="L196" title="All 2 branches missed.">                if (contentType == null) {</span>
<span class="nc" id="L197">                    message = &quot;missing content type in response&quot; +</span>
                        lineSeparator;
                } else {
<span class="nc" id="L200">                    message = &quot;invalid content type in response: &quot; +</span>
                        contentType + lineSeparator;
                }

<span class="nc" id="L204">                message += &quot;HttpSendSocket.readNotify: response body: &quot;;</span>
                try {
<span class="nc" id="L206">                    BufferedReader din = new BufferedReader(new InputStreamReader(in));</span>
                    String line;
<span class="nc bnc" id="L208" title="All 2 branches missed.">                    while ((line = din.readLine()) != null)</span>
<span class="nc" id="L209">                        message += line + lineSeparator;</span>
<span class="nc" id="L210">                } catch (IOException e) {</span>
<span class="nc" id="L211">                }</span>
<span class="nc" id="L212">                RMIMasterSocketFactory.proxyLog.log(Log.BRIEF, message);</span>
            }

<span class="nc" id="L215">            throw new IOException(&quot;HTTP request failed&quot;);</span>
        }

<span class="fc" id="L218">        return in;</span>
    }

    /**
     * Get the address to which the socket is connected.
     */
    public InetAddress getInetAddress()
    {
        try {
<span class="nc" id="L227">            return InetAddress.getByName(host);</span>
<span class="nc" id="L228">        } catch (UnknownHostException e) {</span>
<span class="nc" id="L229">            return null;        // null if couldn't resolve destination host</span>
        }
    }

    /**
     * Get the local address to which the socket is bound.
     */
    public InetAddress getLocalAddress()
    {
        try {
<span class="nc" id="L239">            return InetAddress.getLocalHost();</span>
<span class="nc" id="L240">        } catch (UnknownHostException e) {</span>
<span class="nc" id="L241">            return null;        // null if couldn't determine local host</span>
        }
    }

    /**
     * Get the remote port to which the socket is connected.
     */
    public int getPort()
    {
<span class="nc" id="L250">        return port;</span>
    }

    /**
     * Get the local port to which the socket is connected.
     */
    public int getLocalPort()
    {
<span class="nc" id="L258">        return -1;      // request not applicable to this socket type</span>
    }

    /**
     * Get an InputStream for this socket.
     */
    public InputStream getInputStream() throws IOException
    {
<span class="fc" id="L266">        return inNotifier;</span>
    }

    /**
     * Get an OutputStream for this socket.
     */
    public OutputStream getOutputStream() throws IOException
    {
<span class="fc" id="L274">        return outNotifier;</span>
    }

    /**
     * Enable/disable TCP_NODELAY.
     * This operation has no effect for an HttpSendSocket.
     */
    public void setTcpNoDelay(boolean on) throws SocketException
    {
<span class="fc" id="L283">    }</span>

    /**
     * Retrieve whether TCP_NODELAY is enabled.
     */
    public boolean getTcpNoDelay() throws SocketException
    {
<span class="nc" id="L290">        return false;   // imply option is disabled</span>
    }

    /**
     * Enable/disable SO_LINGER with the specified linger time.
     * This operation has no effect for an HttpSendSocket.
     */
    public void setSoLinger(boolean on, int val) throws SocketException
    {
<span class="nc" id="L299">    }</span>

    /**
     * Retrive setting for SO_LINGER.
     */
    public int getSoLinger() throws SocketException
    {
<span class="nc" id="L306">        return -1;      // imply option is disabled</span>
    }

    /**
     * Enable/disable SO_TIMEOUT with the specified timeout
     * This operation has no effect for an HttpSendSocket.
     */
    public synchronized void setSoTimeout(int timeout) throws SocketException
    {
<span class="nc" id="L315">    }</span>

    /**
     * Retrive setting for SO_TIMEOUT.
     */
    public synchronized int getSoTimeout() throws SocketException
    {
<span class="nc" id="L322">        return 0;       // imply option is disabled</span>
    }

    /**
     * Close the socket.
     */
    public synchronized void close() throws IOException
    {
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">        if (out != null) // push out transmission if not done</span>
<span class="nc" id="L331">            out.close();</span>
<span class="fc" id="L332">    }</span>

    /**
     * Return string representation of this pseudo-socket.
     */
    public String toString()
    {
<span class="nc" id="L339">        return &quot;HttpSendSocket[host=&quot; + host +</span>
               &quot;,port=&quot; + port +
               &quot;,url=&quot; + url + &quot;]&quot;;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>