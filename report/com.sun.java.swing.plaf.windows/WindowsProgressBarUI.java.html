<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>WindowsProgressBarUI.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.java.swing.plaf.windows</a> &gt; <span class="el_source">WindowsProgressBarUI.java</span></div><h1>WindowsProgressBarUI.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2006, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.java.swing.plaf.windows;

import javax.swing.plaf.basic.*;
import javax.swing.plaf.*;
import javax.swing.*;
import java.awt.*;

import static com.sun.java.swing.plaf.windows.TMSchema.*;
import static com.sun.java.swing.plaf.windows.XPStyle.Skin;


/**
 * Windows rendition of the component.
 * &lt;p&gt;
 * &lt;strong&gt;Warning:&lt;/strong&gt;
 * Serialized objects of this class will not be compatible with
 * future Swing releases.  The current serialization support is appropriate
 * for short term storage or RMI between applications running the same
 * version of Swing.  A future release of Swing will provide support for
 * long term persistence.
 *
 * @author Michael C. Albers
 */
<span class="nc" id="L49">public class WindowsProgressBarUI extends BasicProgressBarUI</span>
{

    private Rectangle previousFullBox;
    private Insets indeterminateInsets;

    public static ComponentUI createUI(JComponent x) {
<span class="nc" id="L56">        return new WindowsProgressBarUI();</span>
    }


    protected void installDefaults() {
<span class="nc" id="L61">        super.installDefaults();</span>

<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (XPStyle.getXP() != null) {</span>
<span class="nc" id="L64">            LookAndFeel.installProperty(progressBar, &quot;opaque&quot;, Boolean.FALSE);</span>
<span class="nc" id="L65">            progressBar.setBorder(null);</span>
<span class="nc" id="L66">            indeterminateInsets = UIManager.getInsets(&quot;ProgressBar.indeterminateInsets&quot;);</span>
        }
<span class="nc" id="L68">    }</span>

    /**
     * Returns the baseline.
     *
     * @throws NullPointerException {@inheritDoc}
     * @throws IllegalArgumentException {@inheritDoc}
     * @see javax.swing.JComponent#getBaseline(int, int)
     * @since 1.6
     */
    public int getBaseline(JComponent c, int width, int height) {
<span class="nc" id="L79">        int baseline = super.getBaseline(c, width, height);</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">        if (XPStyle.getXP() != null &amp;&amp; progressBar.isStringPainted() &amp;&amp;</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                progressBar.getOrientation() == JProgressBar.HORIZONTAL) {</span>
<span class="nc" id="L82">            FontMetrics metrics = progressBar.</span>
<span class="nc" id="L83">                    getFontMetrics(progressBar.getFont());</span>
<span class="nc" id="L84">            int y = progressBar.getInsets().top;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (progressBar.isIndeterminate()) {</span>
<span class="nc" id="L86">                y = -1;</span>
<span class="nc" id="L87">                height--;</span>
            }
            else {
<span class="nc" id="L90">                y = 0;</span>
<span class="nc" id="L91">                height -= 3;</span>
            }
<span class="nc" id="L93">            baseline = y + (height + metrics.getAscent() -</span>
<span class="nc" id="L94">                        metrics.getLeading() -</span>
<span class="nc" id="L95">                        metrics.getDescent()) / 2;</span>
        }
<span class="nc" id="L97">        return baseline;</span>
    }

    protected Dimension getPreferredInnerHorizontal() {
<span class="nc" id="L101">        XPStyle xp = XPStyle.getXP();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (xp != null) {</span>
<span class="nc" id="L103">             Skin skin = xp.getSkin(progressBar, Part.PP_BAR);</span>
<span class="nc" id="L104">             return new Dimension(</span>
<span class="nc" id="L105">                     (int)super.getPreferredInnerHorizontal().getWidth(),</span>
<span class="nc" id="L106">                     skin.getHeight());</span>
         }
<span class="nc" id="L108">         return super.getPreferredInnerHorizontal();</span>
    }

    protected Dimension getPreferredInnerVertical() {
<span class="nc" id="L112">         XPStyle xp = XPStyle.getXP();</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">         if (xp != null) {</span>
<span class="nc" id="L114">             Skin skin = xp.getSkin(progressBar, Part.PP_BARVERT);</span>
<span class="nc" id="L115">             return new Dimension(</span>
<span class="nc" id="L116">                     skin.getWidth(),</span>
<span class="nc" id="L117">                     (int)super.getPreferredInnerVertical().getHeight());</span>
         }
<span class="nc" id="L119">         return super.getPreferredInnerVertical();</span>
    }

    protected void paintDeterminate(Graphics g, JComponent c) {
<span class="nc" id="L123">        XPStyle xp = XPStyle.getXP();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (xp != null) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            boolean vertical = (progressBar.getOrientation() == JProgressBar.VERTICAL);</span>
<span class="nc" id="L126">            boolean isLeftToRight = WindowsGraphicsUtils.isLeftToRight(c);</span>
<span class="nc" id="L127">            int barRectWidth = progressBar.getWidth();</span>
<span class="nc" id="L128">            int barRectHeight = progressBar.getHeight()-1;</span>
            // amount of progress to draw
<span class="nc" id="L130">            int amountFull = getAmountFull(null, barRectWidth, barRectHeight);</span>

<span class="nc" id="L132">            paintXPBackground(g, vertical, barRectWidth, barRectHeight);</span>
            // Paint progress
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (progressBar.isStringPainted()) {</span>
                // Do not paint the standard stripes from the skin, because they obscure
                // the text
<span class="nc" id="L137">                g.setColor(progressBar.getForeground());</span>
<span class="nc" id="L138">                barRectHeight -= 2;</span>
<span class="nc" id="L139">                barRectWidth -= 2;</span>

<span class="nc bnc" id="L141" title="All 4 branches missed.">                if (barRectWidth &lt;= 0 || barRectHeight &lt;= 0) {</span>
<span class="nc" id="L142">                    return;</span>
                }

<span class="nc" id="L145">                Graphics2D g2 = (Graphics2D)g;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                g2.setStroke(new BasicStroke((float)(vertical ? barRectWidth : barRectHeight),</span>
                                             BasicStroke.CAP_BUTT, BasicStroke.JOIN_BEVEL));
<span class="nc bnc" id="L148" title="All 2 branches missed.">                if (!vertical) {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">                    if (isLeftToRight) {</span>
<span class="nc" id="L150">                        g2.drawLine(2,              barRectHeight / 2 + 1,</span>
                                    amountFull - 2, barRectHeight / 2 + 1);
                    } else {
<span class="nc" id="L153">                        g2.drawLine(2 + barRectWidth,</span>
                                    barRectHeight / 2 + 1,
                                    2 + barRectWidth - (amountFull - 2),
                                    barRectHeight / 2 + 1);
                    }
<span class="nc" id="L158">                    paintString(g, 0, 0, barRectWidth, barRectHeight, amountFull, null);</span>
                } else {
<span class="nc" id="L160">                    g2.drawLine(barRectWidth/2 + 1, barRectHeight + 1,</span>
                                barRectWidth/2 + 1, barRectHeight + 1 - amountFull + 2);
<span class="nc" id="L162">                    paintString(g, 2, 2, barRectWidth, barRectHeight, amountFull, null);</span>
                }

<span class="nc" id="L165">            } else {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                Skin skin = xp.getSkin(progressBar, vertical ? Part.PP_CHUNKVERT : Part.PP_CHUNK);</span>
                int thickness;
<span class="nc bnc" id="L168" title="All 2 branches missed.">                if (vertical) {</span>
<span class="nc" id="L169">                    thickness = barRectWidth - 5;</span>
                } else {
<span class="nc" id="L171">                    thickness = barRectHeight - 5;</span>
                }

<span class="nc" id="L174">                int chunkSize = xp.getInt(progressBar, Part.PP_PROGRESS, null, Prop.PROGRESSCHUNKSIZE, 2);</span>
<span class="nc" id="L175">                int spaceSize = xp.getInt(progressBar, Part.PP_PROGRESS, null, Prop.PROGRESSSPACESIZE, 0);</span>
<span class="nc" id="L176">                int nChunks = (amountFull-4) / (chunkSize + spaceSize);</span>

                // See if we can squeeze in an extra chunk without spacing after
<span class="nc bnc" id="L179" title="All 4 branches missed.">                if (spaceSize &gt; 0 &amp;&amp; (nChunks * (chunkSize + spaceSize) + chunkSize) &lt; (amountFull-4)) {</span>
<span class="nc" id="L180">                    nChunks++;</span>
                }

<span class="nc bnc" id="L183" title="All 2 branches missed.">                for (int i = 0; i &lt; nChunks; i++) {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                    if (vertical) {</span>
<span class="nc" id="L185">                        skin.paintSkin(g,</span>
                                       3, barRectHeight - i * (chunkSize + spaceSize) - chunkSize - 2,
                                       thickness, chunkSize, null);
                    } else {
<span class="nc bnc" id="L189" title="All 2 branches missed.">                        if (isLeftToRight) {</span>
<span class="nc" id="L190">                            skin.paintSkin(g,</span>
                                           4 + i * (chunkSize + spaceSize), 2,
                                           chunkSize, thickness, null);
                        } else {
<span class="nc" id="L194">                            skin.paintSkin(g,</span>
                                           barRectWidth - (2 + (i+1) * (chunkSize + spaceSize)), 2,
                                           chunkSize, thickness, null);
                        }
                    }
                }
            }
<span class="nc" id="L201">        } else {</span>
<span class="nc" id="L202">            super.paintDeterminate(g, c);</span>
        }
<span class="nc" id="L204">    }</span>


    /**
     * {@inheritDoc}
     * @since 1.6
     */
    protected void setAnimationIndex(int newValue) {
<span class="nc" id="L212">        super.setAnimationIndex(newValue);</span>
<span class="nc" id="L213">        XPStyle xp = XPStyle.getXP();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (xp != null) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (boxRect != null) {</span>
                // get the full repaint area and add it the
                // previous one so we can erase it
<span class="nc" id="L218">                Rectangle chunk = getFullChunkBounds(boxRect);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">                if (previousFullBox != null) {</span>
<span class="nc" id="L220">                    chunk.add(previousFullBox);</span>
                }
<span class="nc" id="L222">                progressBar.repaint(chunk);</span>
<span class="nc" id="L223">            } else {</span>
<span class="nc" id="L224">                progressBar.repaint();</span>
            }
        }
<span class="nc" id="L227">    }</span>


    /**
     * {@inheritDoc}
     * @since 1.6
     */
    protected int getBoxLength(int availableLength, int otherDimension) {
<span class="nc" id="L235">        XPStyle xp = XPStyle.getXP();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (xp != null) {</span>
<span class="nc" id="L237">            return 6; // an apparently hard coded value in Windows</span>
        }
<span class="nc" id="L239">        return super.getBoxLength(availableLength, otherDimension);</span>
    }

    /**
     * {@inheritDoc}
     * @since 1.6
     */
    protected Rectangle getBox(Rectangle r) {
<span class="nc" id="L247">        Rectangle rect = super.getBox(r);</span>

<span class="nc" id="L249">        XPStyle xp = XPStyle.getXP();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (xp != null) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            boolean vertical = (progressBar.getOrientation()</span>
                                 == JProgressBar.VERTICAL);
<span class="nc bnc" id="L253" title="All 2 branches missed.">            Part part = vertical ? Part.PP_BARVERT : Part.PP_BAR;</span>
<span class="nc" id="L254">            Insets ins = indeterminateInsets;</span>

<span class="nc" id="L256">            int currentFrame = getAnimationIndex();</span>
<span class="nc" id="L257">            int framecount = getFrameCount()/2;</span>

<span class="nc" id="L259">            int gap = xp.getInt(progressBar, Part.PP_PROGRESS, null,</span>
                    Prop.PROGRESSSPACESIZE, 0);
<span class="nc" id="L261">            currentFrame = currentFrame % framecount;</span>

            // this code adjusts the chunk size to properly account for the
            // size and gap specified in the XP style. It also does it's own
            // box placement for the chunk animation. This is required because
            // the inherited algorithm from BasicProgressBarUI goes back and
            // forth whereas XP only goes in one direction. XP also has ghosted
            // trailing chunks to create the illusion of speed. This code
            // adjusts the pixel length of the animation to account for the
            // trails.
<span class="nc bnc" id="L271" title="All 2 branches missed.">            if (!vertical) {</span>
<span class="nc" id="L272">                rect.y = rect.y + ins.top;</span>
<span class="nc" id="L273">                rect.height = progressBar.getHeight() - ins.top - ins.bottom;</span>
<span class="nc" id="L274">                int len = progressBar.getWidth() - ins.left - ins.right;</span>
<span class="nc" id="L275">                len += (rect.width+gap)*2; // add 2x for the trails</span>
<span class="nc" id="L276">                double delta = (double)(len) / (double)framecount;</span>
<span class="nc" id="L277">                rect.x = (int)(delta * currentFrame) + ins.left;</span>
<span class="nc" id="L278">            } else {</span>
<span class="nc" id="L279">                rect.x = rect.x + ins.left;</span>
<span class="nc" id="L280">                rect.width = progressBar.getWidth() - ins.left - ins.right;</span>
<span class="nc" id="L281">                int len = progressBar.getHeight() - ins.top - ins.bottom;</span>
<span class="nc" id="L282">                len += (rect.height+gap)*2; // add 2x for the trails</span>
<span class="nc" id="L283">                double delta = (double)(len) / (double)framecount;</span>
<span class="nc" id="L284">                rect.y = (int)(delta * currentFrame) + ins.top;</span>
            }
        }
<span class="nc" id="L287">        return rect;</span>
    }


    protected void paintIndeterminate(Graphics g, JComponent c) {
<span class="nc" id="L292">        XPStyle xp = XPStyle.getXP();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if (xp != null) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">            boolean vertical = (progressBar.getOrientation()</span>
                                 == JProgressBar.VERTICAL);
<span class="nc" id="L296">            int barRectWidth = progressBar.getWidth();</span>
<span class="nc" id="L297">            int barRectHeight = progressBar.getHeight();</span>
<span class="nc" id="L298">            paintXPBackground(g, vertical, barRectWidth, barRectHeight);</span>

            // Paint the bouncing box.
<span class="nc" id="L301">            boxRect = getBox(boxRect);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            if (boxRect != null) {</span>
<span class="nc" id="L303">                g.setColor(progressBar.getForeground());</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                if (!(g instanceof Graphics2D)) {</span>
<span class="nc" id="L305">                    return;</span>
                }
<span class="nc" id="L307">                paintIndeterminateFrame(boxRect, (Graphics2D)g, vertical,</span>
                                        barRectWidth, barRectHeight);
<span class="nc bnc" id="L309" title="All 2 branches missed.">                if (progressBar.isStringPainted()) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                    if (!vertical) {</span>
<span class="nc" id="L311">                        paintString(g, -1, -1, barRectWidth, barRectHeight, 0, null);</span>
                    } else {
<span class="nc" id="L313">                        paintString(g, 1, 1, barRectWidth, barRectHeight, 0, null);</span>
                    }
                }
            }
<span class="nc" id="L317">        } else {</span>
<span class="nc" id="L318">            super.paintIndeterminate(g, c);</span>
        }
<span class="nc" id="L320">    }</span>

    private Rectangle getFullChunkBounds(Rectangle box) {
<span class="nc bnc" id="L323" title="All 2 branches missed.">        boolean vertical = (progressBar.getOrientation() == JProgressBar.VERTICAL);</span>
<span class="nc" id="L324">        XPStyle xp = XPStyle.getXP();</span>
<span class="nc" id="L325">        int gap = xp.getInt(progressBar, Part.PP_PROGRESS, null,</span>
                            Prop.PROGRESSSPACESIZE, 0);

<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (!vertical) {</span>
<span class="nc" id="L329">            int chunksize = box.width+gap;</span>
<span class="nc" id="L330">            return new Rectangle(box.x-chunksize*2, box.y, chunksize*3, box.height);</span>
        } else {
<span class="nc" id="L332">            int chunksize = box.height+gap;</span>
<span class="nc" id="L333">            return new Rectangle(box.x, box.y-chunksize*2, box.width, chunksize*3);</span>
        }
    }

    private void paintIndeterminateFrame(Rectangle box, Graphics2D g,
                                          boolean vertical,
                                          int bgwidth, int bgheight) {
<span class="nc" id="L340">        XPStyle xp = XPStyle.getXP();</span>

        // create a new graphics to keep drawing surface state
<span class="nc" id="L343">        Graphics2D gfx = (Graphics2D)g.create();</span>

<span class="nc bnc" id="L345" title="All 2 branches missed.">        Part part = vertical ? Part.PP_BARVERT : Part.PP_BAR;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">        Part chunk = vertical ? Part.PP_CHUNKVERT : Part.PP_CHUNK;</span>

        // calculate the chunk offsets
<span class="nc" id="L349">        int gap = xp.getInt(progressBar, Part.PP_PROGRESS, null,</span>
                            Prop.PROGRESSSPACESIZE, 0);
<span class="nc" id="L351">        int deltax = 0;</span>
<span class="nc" id="L352">        int deltay = 0;</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">        if (!vertical) {</span>
<span class="nc" id="L354">            deltax = -box.width - gap;</span>
<span class="nc" id="L355">            deltay = 0;</span>
        } else {
<span class="nc" id="L357">            deltax = 0;</span>
<span class="nc" id="L358">            deltay = -box.height - gap;</span>
        }

        // Calculate the area of the chunks combined
<span class="nc" id="L362">        Rectangle fullBox = getFullChunkBounds(box);</span>

        // save this box for the next time
<span class="nc" id="L365">        previousFullBox = fullBox;</span>

        // this is the entire progress bar minus the track and borders
<span class="nc" id="L368">        Insets ins = indeterminateInsets;</span>
<span class="nc" id="L369">        Rectangle progbarExtents = new Rectangle(ins.left, ins.top,</span>
                                                 bgwidth  - ins.left - ins.right,
                                                 bgheight - ins.top  - ins.bottom);

        // only paint where the chunks overlap with the progress bar drawing area
<span class="nc" id="L374">        Rectangle repaintArea = progbarExtents.intersection(fullBox);</span>

        // adjust the cliprect to chop the chunks when they go off the end
<span class="nc" id="L377">        gfx.clip(repaintArea);</span>

        // get the skin
<span class="nc" id="L380">        XPStyle.Skin skin = xp.getSkin(progressBar, chunk);</span>

        // do the drawing
<span class="nc" id="L383">        gfx.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER, 0.8f));</span>
<span class="nc" id="L384">        skin.paintSkin(gfx, box.x, box.y, box.width, box.height, null);</span>
<span class="nc" id="L385">        box.translate(deltax, deltay);</span>
<span class="nc" id="L386">        gfx.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER, 0.5f));</span>
<span class="nc" id="L387">        skin.paintSkin(gfx, box.x, box.y, box.width, box.height, null);</span>
<span class="nc" id="L388">        box.translate(deltax, deltay);</span>
<span class="nc" id="L389">        gfx.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER, 0.2f));</span>
<span class="nc" id="L390">        skin.paintSkin(gfx, box.x, box.y, box.width, box.height, null);</span>

        // get rid of our clip and composite changes
<span class="nc" id="L393">        gfx.dispose();</span>
<span class="nc" id="L394">    }</span>

    private void paintXPBackground(Graphics g, boolean vertical,
                                   int barRectWidth, int barRectHeight) {
<span class="nc" id="L398">        XPStyle xp = XPStyle.getXP();</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">        Part part = vertical ? Part.PP_BARVERT : Part.PP_BAR;</span>
<span class="nc" id="L400">        Skin skin = xp.getSkin(progressBar, part);</span>

        // Paint background
<span class="nc" id="L403">        skin.paintSkin(g, 0, 0, barRectWidth, barRectHeight, null);</span>
<span class="nc" id="L404">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>