<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DesktopProperty.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.java.swing.plaf.windows</a> &gt; <span class="el_source">DesktopProperty.java</span></div><h1>DesktopProperty.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2001, 2009, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.java.swing.plaf.windows;

import java.awt.*;
import java.beans.*;
import java.lang.ref.*;
import javax.swing.*;
import javax.swing.plaf.*;

/**
 * Wrapper for a value from the desktop. The value is lazily looked up, and
 * can be accessed using the &lt;code&gt;UIManager.ActiveValue&lt;/code&gt; method
 * &lt;code&gt;createValue&lt;/code&gt;. If the underlying desktop property changes this
 * will force the UIs to update all known Frames. You can invoke
 * &lt;code&gt;invalidate&lt;/code&gt; to force the value to be fetched again.
 *
 */
// NOTE: Don't rely on this class staying in this location. It is likely
// to move to a different package in the future.
public class DesktopProperty implements UIDefaults.ActiveValue {
    /**
     * Indicates if an updateUI call is pending.
     */
    private static boolean updatePending;

    /**
     * ReferenceQueue of unreferenced WeakPCLs.
     */
<span class="nc" id="L52">    private static final ReferenceQueue&lt;DesktopProperty&gt; queue = new ReferenceQueue&lt;DesktopProperty&gt;();</span>

    /**
     * PropertyChangeListener attached to the Toolkit.
     */
    private WeakPCL pcl;
    /**
     * Key used to lookup value from desktop.
     */
    private final String key;
    /**
     * Value to return.
     */
    private Object value;
    /**
     * Fallback value in case we get null from desktop.
     */
    private final Object fallback;


    /**
     * Cleans up any lingering state held by unrefeernced
     * DesktopProperties.
     */
    static void flushUnreferencedProperties() {
        WeakPCL pcl;

<span class="nc bnc" id="L79" title="All 2 branches missed.">        while ((pcl = (WeakPCL)queue.poll()) != null) {</span>
<span class="nc" id="L80">            pcl.dispose();</span>
        }
<span class="nc" id="L82">    }</span>


    /**
     * Sets whether or not an updateUI call is pending.
     */
    private static synchronized void setUpdatePending(boolean update) {
<span class="nc" id="L89">        updatePending = update;</span>
<span class="nc" id="L90">    }</span>

    /**
     * Returns true if a UI update is pending.
     */
    private static synchronized boolean isUpdatePending() {
<span class="nc" id="L96">        return updatePending;</span>
    }

    /**
     * Updates the UIs of all the known Frames.
     */
    private static void updateAllUIs() {
        // Check if the current UI is WindowsLookAndfeel and flush the XP style map.
        // Note: Change the package test if this class is moved to a different package.
<span class="nc" id="L105">        Class uiClass = UIManager.getLookAndFeel().getClass();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (uiClass.getPackage().equals(DesktopProperty.class.getPackage())) {</span>
<span class="nc" id="L107">            XPStyle.invalidateStyle();</span>
        }
<span class="nc" id="L109">        Frame appFrames[] = Frame.getFrames();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        for (Frame appFrame : appFrames) {</span>
<span class="nc" id="L111">            updateWindowUI(appFrame);</span>
        }
<span class="nc" id="L113">    }</span>

    /**
     * Updates the UI of the passed in window and all its children.
     */
    private static void updateWindowUI(Window window) {
<span class="nc" id="L119">        SwingUtilities.updateComponentTreeUI(window);</span>
<span class="nc" id="L120">        Window ownedWins[] = window.getOwnedWindows();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        for (Window ownedWin : ownedWins) {</span>
<span class="nc" id="L122">            updateWindowUI(ownedWin);</span>
        }
<span class="nc" id="L124">    }</span>


    /**
     * Creates a DesktopProperty.
     *
     * @param key Key used in looking up desktop value.
     * @param fallback Value used if desktop property is null.
     */
<span class="nc" id="L133">    public DesktopProperty(String key, Object fallback) {</span>
<span class="nc" id="L134">        this.key = key;</span>
<span class="nc" id="L135">        this.fallback = fallback;</span>
        // The only sure fire way to clear our references is to create a
        // Thread and wait for a reference to be added to the queue.
        // Because it is so rare that you will actually change the look
        // and feel, this stepped is forgoed and a middle ground of
        // flushing references from the constructor is instead done.
        // The implication is that once one DesktopProperty is created
        // there will most likely be n (number of DesktopProperties created
        // by the LookAndFeel) WeakPCLs around, but this number will not
        // grow past n.
<span class="nc" id="L145">        flushUnreferencedProperties();</span>
<span class="nc" id="L146">    }</span>

    /**
     * UIManager.LazyValue method, returns the value from the desktop
     * or the fallback value if the desktop value is null.
     */
    public Object createValue(UIDefaults table) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L154">            value = configureValue(getValueFromDesktop());</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (value == null) {</span>
<span class="nc" id="L156">                value = configureValue(getDefaultValue());</span>
            }
        }
<span class="nc" id="L159">        return value;</span>
    }

    /**
     * Returns the value from the desktop.
     */
    protected Object getValueFromDesktop() {
<span class="nc" id="L166">        Toolkit toolkit = Toolkit.getDefaultToolkit();</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (pcl == null) {</span>
<span class="nc" id="L169">            pcl = new WeakPCL(this, getKey(), UIManager.getLookAndFeel());</span>
<span class="nc" id="L170">            toolkit.addPropertyChangeListener(getKey(), pcl);</span>
        }

<span class="nc" id="L173">        return toolkit.getDesktopProperty(getKey());</span>
    }

    /**
     * Returns the value to use if the desktop property is null.
     */
    protected Object getDefaultValue() {
<span class="nc" id="L180">        return fallback;</span>
    }

    /**
     * Invalidates the current value.
     *
     * @param laf the LookAndFeel this DesktopProperty was created with
     */
    public void invalidate(LookAndFeel laf) {
<span class="nc" id="L189">        invalidate();</span>
<span class="nc" id="L190">    }</span>

    /**
     * Invalides the current value so that the next invocation of
     * &lt;code&gt;createValue&lt;/code&gt; will ask for the property again.
     */
    public void invalidate() {
<span class="nc" id="L197">        value = null;</span>
<span class="nc" id="L198">    }</span>

    /**
     * Requests that all components in the GUI hierarchy be updated
     * to reflect dynamic changes in this look&amp;feel.  This update occurs
     * by uninstalling and re-installing the UI objects. Requests are
     * batched and collapsed into a single update pass because often
     * many desktop properties will change at once.
     */
    protected void updateUI() {
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (!isUpdatePending()) {</span>
<span class="nc" id="L209">            setUpdatePending(true);</span>
<span class="nc" id="L210">            Runnable uiUpdater = new Runnable() {</span>
                public void run() {
<span class="nc" id="L212">                    updateAllUIs();</span>
<span class="nc" id="L213">                    setUpdatePending(false);</span>
<span class="nc" id="L214">                }</span>
            };
<span class="nc" id="L216">            SwingUtilities.invokeLater(uiUpdater);</span>
        }
<span class="nc" id="L218">    }</span>

    /**
     * Configures the value as appropriate for a defaults property in
     * the UIDefaults table.
     */
    protected Object configureValue(Object value) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (value != null) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            if (value instanceof Color) {</span>
<span class="nc" id="L227">                return new ColorUIResource((Color)value);</span>
            }
<span class="nc bnc" id="L229" title="All 2 branches missed.">            else if (value instanceof Font) {</span>
<span class="nc" id="L230">                return new FontUIResource((Font)value);</span>
            }
<span class="nc bnc" id="L232" title="All 2 branches missed.">            else if (value instanceof UIDefaults.LazyValue) {</span>
<span class="nc" id="L233">                value = ((UIDefaults.LazyValue)value).createValue(null);</span>
            }
<span class="nc bnc" id="L235" title="All 2 branches missed.">            else if (value instanceof UIDefaults.ActiveValue) {</span>
<span class="nc" id="L236">                value = ((UIDefaults.ActiveValue)value).createValue(null);</span>
            }
        }
<span class="nc" id="L239">        return value;</span>
    }

    /**
     * Returns the key used to lookup the desktop properties value.
     */
    protected String getKey() {
<span class="nc" id="L246">        return key;</span>
    }



    /**
     * As there is typically only one Toolkit, the PropertyChangeListener
     * is handled via a WeakReference so as not to pin down the
     * DesktopProperty.
     */
    private static class WeakPCL extends WeakReference&lt;DesktopProperty&gt;
                               implements PropertyChangeListener {
        private String key;
        private LookAndFeel laf;

        WeakPCL(DesktopProperty target, String key, LookAndFeel laf) {
<span class="nc" id="L262">            super(target, queue);</span>
<span class="nc" id="L263">            this.key = key;</span>
<span class="nc" id="L264">            this.laf = laf;</span>
<span class="nc" id="L265">        }</span>

        public void propertyChange(PropertyChangeEvent pce) {
<span class="nc" id="L268">            DesktopProperty property = get();</span>

<span class="nc bnc" id="L270" title="All 4 branches missed.">            if (property == null || laf != UIManager.getLookAndFeel()) {</span>
                // The property was GC'ed, we're no longer interested in
                // PropertyChanges, remove the listener.
<span class="nc" id="L273">                dispose();</span>
            }
            else {
<span class="nc" id="L276">                property.invalidate(laf);</span>
<span class="nc" id="L277">                property.updateUI();</span>
            }
<span class="nc" id="L279">        }</span>

        void dispose() {
<span class="nc" id="L282">            Toolkit.getDefaultToolkit().removePropertyChangeListener(key, this);</span>
<span class="nc" id="L283">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>