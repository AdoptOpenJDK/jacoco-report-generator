<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>WindowsFileChooserUI.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.java.swing.plaf.windows</a> &gt; <span class="el_source">WindowsFileChooserUI.java</span></div><h1>WindowsFileChooserUI.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2009, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.java.swing.plaf.windows;

import javax.swing.*;
import javax.swing.border.*;
import javax.swing.filechooser.*;
import javax.swing.event.*;
import javax.swing.plaf.*;
import javax.swing.plaf.basic.*;
import java.awt.*;
import java.awt.event.*;
import java.awt.image.BufferedImage;
import java.beans.*;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.*;
import java.security.AccessController;
import java.security.PrivilegedAction;

import sun.awt.shell.ShellFolder;
import sun.swing.*;

import javax.accessibility.*;

/**
 * Windows L&amp;F implementation of a FileChooser.
 *
 * @author Jeff Dinkins
 */
public class WindowsFileChooserUI extends BasicFileChooserUI {

    // The following are private because the implementation of the
    // Windows FileChooser L&amp;F is not complete yet.

    private JPanel centerPanel;

    private JLabel lookInLabel;
    private JComboBox&lt;File&gt; directoryComboBox;
    private DirectoryComboBoxModel directoryComboBoxModel;
<span class="nc" id="L65">    private ActionListener directoryComboBoxAction = new DirectoryComboBoxAction();</span>

    private FilterComboBoxModel filterComboBoxModel;

    private JTextField filenameTextField;
    private FilePane filePane;
    private WindowsPlacesBar placesBar;

    private JButton approveButton;
    private JButton cancelButton;

    private JPanel buttonPanel;
    private JPanel bottomPanel;

    private JComboBox&lt;FileFilter&gt; filterComboBox;

<span class="nc" id="L81">    private static final Dimension hstrut10 = new Dimension(10, 1);</span>

<span class="nc" id="L83">    private static final Dimension vstrut4  = new Dimension(1, 4);</span>
<span class="nc" id="L84">    private static final Dimension vstrut6  = new Dimension(1, 6);</span>
<span class="nc" id="L85">    private static final Dimension vstrut8  = new Dimension(1, 8);</span>

<span class="nc" id="L87">    private static final Insets shrinkwrap = new Insets(0,0,0,0);</span>

    // Preferred and Minimum sizes for the dialog box
<span class="nc" id="L90">    private static int PREF_WIDTH = 425;</span>
<span class="nc" id="L91">    private static int PREF_HEIGHT = 245;</span>
<span class="nc" id="L92">    private static Dimension PREF_SIZE = new Dimension(PREF_WIDTH, PREF_HEIGHT);</span>

<span class="nc" id="L94">    private static int MIN_WIDTH = 425;</span>
<span class="nc" id="L95">    private static int MIN_HEIGHT = 245;</span>
<span class="nc" id="L96">    private static Dimension MIN_SIZE = new Dimension(MIN_WIDTH, MIN_HEIGHT);</span>

<span class="nc" id="L98">    private static int LIST_PREF_WIDTH = 444;</span>
<span class="nc" id="L99">    private static int LIST_PREF_HEIGHT = 138;</span>
<span class="nc" id="L100">    private static Dimension LIST_PREF_SIZE = new Dimension(LIST_PREF_WIDTH, LIST_PREF_HEIGHT);</span>

    // Labels, mnemonics, and tooltips (oh my!)
<span class="nc" id="L103">    private int    lookInLabelMnemonic = 0;</span>
<span class="nc" id="L104">    private String lookInLabelText = null;</span>
<span class="nc" id="L105">    private String saveInLabelText = null;</span>

<span class="nc" id="L107">    private int    fileNameLabelMnemonic = 0;</span>
<span class="nc" id="L108">    private String fileNameLabelText = null;</span>
<span class="nc" id="L109">    private int    folderNameLabelMnemonic = 0;</span>
<span class="nc" id="L110">    private String folderNameLabelText = null;</span>

<span class="nc" id="L112">    private int    filesOfTypeLabelMnemonic = 0;</span>
<span class="nc" id="L113">    private String filesOfTypeLabelText = null;</span>

<span class="nc" id="L115">    private String upFolderToolTipText = null;</span>
<span class="nc" id="L116">    private String upFolderAccessibleName = null;</span>

<span class="nc" id="L118">    private String newFolderToolTipText = null;</span>
<span class="nc" id="L119">    private String newFolderAccessibleName = null;</span>

<span class="nc" id="L121">    private String viewMenuButtonToolTipText = null;</span>
<span class="nc" id="L122">    private String viewMenuButtonAccessibleName = null;</span>

<span class="nc" id="L124">    private BasicFileView fileView = new WindowsFileView();</span>

    private JLabel fileNameLabel;

    private void populateFileNameLabel() {
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (getFileChooser().getFileSelectionMode() == JFileChooser.DIRECTORIES_ONLY) {</span>
<span class="nc" id="L130">            fileNameLabel.setText(folderNameLabelText);</span>
<span class="nc" id="L131">            fileNameLabel.setDisplayedMnemonic(folderNameLabelMnemonic);</span>
        } else {
<span class="nc" id="L133">            fileNameLabel.setText(fileNameLabelText);</span>
<span class="nc" id="L134">            fileNameLabel.setDisplayedMnemonic(fileNameLabelMnemonic);</span>
        }
<span class="nc" id="L136">    }</span>

    //
    // ComponentUI Interface Implementation methods
    //
    public static ComponentUI createUI(JComponent c) {
<span class="nc" id="L142">        return new WindowsFileChooserUI((JFileChooser) c);</span>
    }

    public WindowsFileChooserUI(JFileChooser filechooser) {
<span class="nc" id="L146">        super(filechooser);</span>
<span class="nc" id="L147">    }</span>

    public void installUI(JComponent c) {
<span class="nc" id="L150">        super.installUI(c);</span>
<span class="nc" id="L151">    }</span>

    public void uninstallComponents(JFileChooser fc) {
<span class="nc" id="L154">        fc.removeAll();</span>
<span class="nc" id="L155">    }</span>

<span class="nc" id="L157">    private class WindowsFileChooserUIAccessor implements FilePane.FileChooserUIAccessor {</span>
        public JFileChooser getFileChooser() {
<span class="nc" id="L159">            return WindowsFileChooserUI.this.getFileChooser();</span>
        }

        public BasicDirectoryModel getModel() {
<span class="nc" id="L163">            return WindowsFileChooserUI.this.getModel();</span>
        }

        public JPanel createList() {
<span class="nc" id="L167">            return WindowsFileChooserUI.this.createList(getFileChooser());</span>
        }

        public JPanel createDetailsView() {
<span class="nc" id="L171">            return WindowsFileChooserUI.this.createDetailsView(getFileChooser());</span>
        }

        public boolean isDirectorySelected() {
<span class="nc" id="L175">            return WindowsFileChooserUI.this.isDirectorySelected();</span>
        }

        public File getDirectory() {
<span class="nc" id="L179">            return WindowsFileChooserUI.this.getDirectory();</span>
        }

        public Action getChangeToParentDirectoryAction() {
<span class="nc" id="L183">            return WindowsFileChooserUI.this.getChangeToParentDirectoryAction();</span>
        }

        public Action getApproveSelectionAction() {
<span class="nc" id="L187">            return WindowsFileChooserUI.this.getApproveSelectionAction();</span>
        }

        public Action getNewFolderAction() {
<span class="nc" id="L191">            return WindowsFileChooserUI.this.getNewFolderAction();</span>
        }

        public MouseListener createDoubleClickListener(JList list) {
<span class="nc" id="L195">            return WindowsFileChooserUI.this.createDoubleClickListener(getFileChooser(),</span>
                                                                       list);
        }

        public ListSelectionListener createListSelectionListener() {
<span class="nc" id="L200">            return WindowsFileChooserUI.this.createListSelectionListener(getFileChooser());</span>
        }
    }

    public void installComponents(JFileChooser fc) {
<span class="nc" id="L205">        filePane = new FilePane(new WindowsFileChooserUIAccessor());</span>
<span class="nc" id="L206">        fc.addPropertyChangeListener(filePane);</span>

<span class="nc" id="L208">        FileSystemView fsv = fc.getFileSystemView();</span>

<span class="nc" id="L210">        fc.setBorder(new EmptyBorder(4, 10, 10, 10));</span>
<span class="nc" id="L211">        fc.setLayout(new BorderLayout(8, 8));</span>

<span class="nc" id="L213">        updateUseShellFolder();</span>

        // ********************************* //
        // **** Construct the top panel **** //
        // ********************************* //

        // Directory manipulation buttons
<span class="nc" id="L220">        JToolBar topPanel = new JToolBar();</span>
<span class="nc" id="L221">        topPanel.setFloatable(false);</span>
<span class="nc" id="L222">        topPanel.putClientProperty(&quot;JToolBar.isRollover&quot;, Boolean.TRUE);</span>

        // Add the top panel to the fileChooser
<span class="nc" id="L225">        fc.add(topPanel, BorderLayout.NORTH);</span>

        // ComboBox Label
<span class="nc" id="L228">        lookInLabel = new JLabel(lookInLabelText, JLabel.TRAILING) {</span>
            public Dimension getPreferredSize() {
<span class="nc" id="L230">                return getMinimumSize();</span>
            }

            public Dimension getMinimumSize() {
<span class="nc" id="L234">                Dimension d = super.getPreferredSize();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                if (placesBar != null) {</span>
<span class="nc" id="L236">                    d.width = Math.max(d.width, placesBar.getWidth());</span>
                }
<span class="nc" id="L238">                return d;</span>
            }
        };
<span class="nc" id="L241">        lookInLabel.setDisplayedMnemonic(lookInLabelMnemonic);</span>
<span class="nc" id="L242">        lookInLabel.setAlignmentX(JComponent.LEFT_ALIGNMENT);</span>
<span class="nc" id="L243">        lookInLabel.setAlignmentY(JComponent.CENTER_ALIGNMENT);</span>
<span class="nc" id="L244">        topPanel.add(lookInLabel);</span>
<span class="nc" id="L245">        topPanel.add(Box.createRigidArea(new Dimension(8,0)));</span>

        // CurrentDir ComboBox
<span class="nc" id="L248">        directoryComboBox = new JComboBox&lt;File&gt;() {</span>
            public Dimension getMinimumSize() {
<span class="nc" id="L250">                Dimension d = super.getMinimumSize();</span>
<span class="nc" id="L251">                d.width = 60;</span>
<span class="nc" id="L252">                return d;</span>
            }

            public Dimension getPreferredSize() {
<span class="nc" id="L256">                Dimension d = super.getPreferredSize();</span>
                // Must be small enough to not affect total width.
<span class="nc" id="L258">                d.width = 150;</span>
<span class="nc" id="L259">                return d;</span>
            }
        };
<span class="nc" id="L262">        directoryComboBox.putClientProperty( &quot;JComboBox.lightweightKeyboardNavigation&quot;, &quot;Lightweight&quot; );</span>
<span class="nc" id="L263">        lookInLabel.setLabelFor(directoryComboBox);</span>
<span class="nc" id="L264">        directoryComboBoxModel = createDirectoryComboBoxModel(fc);</span>
<span class="nc" id="L265">        directoryComboBox.setModel(directoryComboBoxModel);</span>
<span class="nc" id="L266">        directoryComboBox.addActionListener(directoryComboBoxAction);</span>
<span class="nc" id="L267">        directoryComboBox.setRenderer(createDirectoryComboBoxRenderer(fc));</span>
<span class="nc" id="L268">        directoryComboBox.setAlignmentX(JComponent.LEFT_ALIGNMENT);</span>
<span class="nc" id="L269">        directoryComboBox.setAlignmentY(JComponent.CENTER_ALIGNMENT);</span>
<span class="nc" id="L270">        directoryComboBox.setMaximumRowCount(8);</span>

<span class="nc" id="L272">        topPanel.add(directoryComboBox);</span>
<span class="nc" id="L273">        topPanel.add(Box.createRigidArea(hstrut10));</span>

        // Up Button
<span class="nc" id="L276">        JButton upFolderButton = createToolButton(getChangeToParentDirectoryAction(), upFolderIcon,</span>
            upFolderToolTipText, upFolderAccessibleName);
<span class="nc" id="L278">        topPanel.add(upFolderButton);</span>

        // New Directory Button
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (!UIManager.getBoolean(&quot;FileChooser.readOnly&quot;)) {</span>
<span class="nc" id="L282">            JButton newFolderButton = createToolButton(filePane.getNewFolderAction(), newFolderIcon,</span>
                newFolderToolTipText, newFolderAccessibleName);
<span class="nc" id="L284">            topPanel.add(newFolderButton);</span>
        }

        // View button group
<span class="nc" id="L288">        ButtonGroup viewButtonGroup = new ButtonGroup();</span>

        // Popup Menu
<span class="nc" id="L291">        final JPopupMenu viewTypePopupMenu = new JPopupMenu();</span>

<span class="nc" id="L293">        final JRadioButtonMenuItem listViewMenuItem = new JRadioButtonMenuItem(</span>
<span class="nc" id="L294">                filePane.getViewTypeAction(FilePane.VIEWTYPE_LIST));</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        listViewMenuItem.setSelected(filePane.getViewType() == FilePane.VIEWTYPE_LIST);</span>
<span class="nc" id="L296">        viewTypePopupMenu.add(listViewMenuItem);</span>
<span class="nc" id="L297">        viewButtonGroup.add(listViewMenuItem);</span>

<span class="nc" id="L299">        final JRadioButtonMenuItem detailsViewMenuItem = new JRadioButtonMenuItem(</span>
<span class="nc" id="L300">                filePane.getViewTypeAction(FilePane.VIEWTYPE_DETAILS));</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">        detailsViewMenuItem.setSelected(filePane.getViewType() == FilePane.VIEWTYPE_DETAILS);</span>
<span class="nc" id="L302">        viewTypePopupMenu.add(detailsViewMenuItem);</span>
<span class="nc" id="L303">        viewButtonGroup.add(detailsViewMenuItem);</span>

        // Create icon for viewMenuButton
<span class="nc" id="L306">        BufferedImage image = new BufferedImage(viewMenuIcon.getIconWidth() + 7, viewMenuIcon.getIconHeight(),</span>
                BufferedImage.TYPE_INT_ARGB);
<span class="nc" id="L308">        Graphics graphics = image.getGraphics();</span>
<span class="nc" id="L309">        viewMenuIcon.paintIcon(filePane, graphics, 0, 0);</span>
<span class="nc" id="L310">        int x = image.getWidth() - 5;</span>
<span class="nc" id="L311">        int y = image.getHeight() / 2 - 1;</span>
<span class="nc" id="L312">        graphics.setColor(Color.BLACK);</span>
<span class="nc" id="L313">        graphics.fillPolygon(new int[]{x, x + 5, x + 2}, new int[]{y, y, y + 3}, 3);</span>

        // Details Button
<span class="nc" id="L316">        final JButton viewMenuButton = createToolButton(null, new ImageIcon(image), viewMenuButtonToolTipText,</span>
                viewMenuButtonAccessibleName);

<span class="nc" id="L319">        viewMenuButton.addMouseListener(new MouseAdapter() {</span>
            public void mousePressed(MouseEvent e) {
<span class="nc bnc" id="L321" title="All 4 branches missed.">                if (SwingUtilities.isLeftMouseButton(e) &amp;&amp; !viewMenuButton.isSelected()) {</span>
<span class="nc" id="L322">                    viewMenuButton.setSelected(true);</span>

<span class="nc" id="L324">                    viewTypePopupMenu.show(viewMenuButton, 0, viewMenuButton.getHeight());</span>
                }
<span class="nc" id="L326">            }</span>
        });
<span class="nc" id="L328">        viewMenuButton.addKeyListener(new KeyAdapter() {</span>
            public void keyPressed(KeyEvent e) {
                // Forbid keyboard actions if the button is not in rollover state
<span class="nc bnc" id="L331" title="All 4 branches missed.">                if (e.getKeyCode() == KeyEvent.VK_SPACE &amp;&amp; viewMenuButton.getModel().isRollover()) {</span>
<span class="nc" id="L332">                    viewMenuButton.setSelected(true);</span>

<span class="nc" id="L334">                    viewTypePopupMenu.show(viewMenuButton, 0, viewMenuButton.getHeight());</span>
                }
<span class="nc" id="L336">            }</span>
        });
<span class="nc" id="L338">        viewTypePopupMenu.addPopupMenuListener(new PopupMenuListener() {</span>
            public void popupMenuWillBecomeVisible(PopupMenuEvent e) {
<span class="nc" id="L340">            }</span>

            public void popupMenuWillBecomeInvisible(PopupMenuEvent e) {
<span class="nc" id="L343">                SwingUtilities.invokeLater(new Runnable() {</span>
                    public void run() {
<span class="nc" id="L345">                        viewMenuButton.setSelected(false);</span>
<span class="nc" id="L346">                    }</span>
                });
<span class="nc" id="L348">            }</span>

            public void popupMenuCanceled(PopupMenuEvent e) {
<span class="nc" id="L351">            }</span>
        });

<span class="nc" id="L354">        topPanel.add(viewMenuButton);</span>

<span class="nc" id="L356">        topPanel.add(Box.createRigidArea(new Dimension(80, 0)));</span>

<span class="nc" id="L358">        filePane.addPropertyChangeListener(new PropertyChangeListener() {</span>
            public void propertyChange(PropertyChangeEvent e) {
<span class="nc bnc" id="L360" title="All 2 branches missed.">                if (&quot;viewType&quot;.equals(e.getPropertyName())) {</span>
<span class="nc bnc" id="L361" title="All 3 branches missed.">                    switch (filePane.getViewType()) {</span>
                        case FilePane.VIEWTYPE_LIST:
<span class="nc" id="L363">                            listViewMenuItem.setSelected(true);</span>
<span class="nc" id="L364">                            break;</span>

                        case FilePane.VIEWTYPE_DETAILS:
<span class="nc" id="L367">                            detailsViewMenuItem.setSelected(true);</span>
                            break;
                    }
                }
<span class="nc" id="L371">            }</span>
        });

        // ************************************** //
        // ******* Add the directory pane ******* //
        // ************************************** //
<span class="nc" id="L377">        centerPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L378">        centerPanel.add(getAccessoryPanel(), BorderLayout.AFTER_LINE_ENDS);</span>
<span class="nc" id="L379">        JComponent accessory = fc.getAccessory();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if(accessory != null) {</span>
<span class="nc" id="L381">            getAccessoryPanel().add(accessory);</span>
        }
<span class="nc" id="L383">        filePane.setPreferredSize(LIST_PREF_SIZE);</span>
<span class="nc" id="L384">        centerPanel.add(filePane, BorderLayout.CENTER);</span>
<span class="nc" id="L385">        fc.add(centerPanel, BorderLayout.CENTER);</span>

        // ********************************** //
        // **** Construct the bottom panel ** //
        // ********************************** //
<span class="nc" id="L390">        getBottomPanel().setLayout(new BoxLayout(getBottomPanel(), BoxLayout.LINE_AXIS));</span>

        // Add the bottom panel to file chooser
<span class="nc" id="L393">        centerPanel.add(getBottomPanel(), BorderLayout.SOUTH);</span>

        // labels
<span class="nc" id="L396">        JPanel labelPanel = new JPanel();</span>
<span class="nc" id="L397">        labelPanel.setLayout(new BoxLayout(labelPanel, BoxLayout.PAGE_AXIS));</span>
<span class="nc" id="L398">        labelPanel.add(Box.createRigidArea(vstrut4));</span>

<span class="nc" id="L400">        fileNameLabel = new JLabel();</span>
<span class="nc" id="L401">        populateFileNameLabel();</span>
<span class="nc" id="L402">        fileNameLabel.setAlignmentY(0);</span>
<span class="nc" id="L403">        labelPanel.add(fileNameLabel);</span>

<span class="nc" id="L405">        labelPanel.add(Box.createRigidArea(new Dimension(1,12)));</span>

<span class="nc" id="L407">        JLabel ftl = new JLabel(filesOfTypeLabelText);</span>
<span class="nc" id="L408">        ftl.setDisplayedMnemonic(filesOfTypeLabelMnemonic);</span>
<span class="nc" id="L409">        labelPanel.add(ftl);</span>

<span class="nc" id="L411">        getBottomPanel().add(labelPanel);</span>
<span class="nc" id="L412">        getBottomPanel().add(Box.createRigidArea(new Dimension(15, 0)));</span>

        // file entry and filters
<span class="nc" id="L415">        JPanel fileAndFilterPanel = new JPanel();</span>
<span class="nc" id="L416">        fileAndFilterPanel.add(Box.createRigidArea(vstrut8));</span>
<span class="nc" id="L417">        fileAndFilterPanel.setLayout(new BoxLayout(fileAndFilterPanel, BoxLayout.Y_AXIS));</span>


<span class="nc" id="L420">        filenameTextField = new JTextField(35) {</span>
            public Dimension getMaximumSize() {
<span class="nc" id="L422">                return new Dimension(Short.MAX_VALUE, super.getPreferredSize().height);</span>
            }
        };

<span class="nc" id="L426">        fileNameLabel.setLabelFor(filenameTextField);</span>
<span class="nc" id="L427">        filenameTextField.addFocusListener(</span>
<span class="nc" id="L428">            new FocusAdapter() {</span>
                public void focusGained(FocusEvent e) {
<span class="nc bnc" id="L430" title="All 2 branches missed.">                    if (!getFileChooser().isMultiSelectionEnabled()) {</span>
<span class="nc" id="L431">                        filePane.clearSelection();</span>
                    }
<span class="nc" id="L433">                }</span>
            }
        );

<span class="nc bnc" id="L437" title="All 2 branches missed.">        if (fc.isMultiSelectionEnabled()) {</span>
<span class="nc" id="L438">            setFileName(fileNameString(fc.getSelectedFiles()));</span>
        } else {
<span class="nc" id="L440">            setFileName(fileNameString(fc.getSelectedFile()));</span>
        }

<span class="nc" id="L443">        fileAndFilterPanel.add(filenameTextField);</span>
<span class="nc" id="L444">        fileAndFilterPanel.add(Box.createRigidArea(vstrut8));</span>

<span class="nc" id="L446">        filterComboBoxModel = createFilterComboBoxModel();</span>
<span class="nc" id="L447">        fc.addPropertyChangeListener(filterComboBoxModel);</span>
<span class="nc" id="L448">        filterComboBox = new JComboBox&lt;FileFilter&gt;(filterComboBoxModel);</span>
<span class="nc" id="L449">        ftl.setLabelFor(filterComboBox);</span>
<span class="nc" id="L450">        filterComboBox.setRenderer(createFilterComboBoxRenderer());</span>
<span class="nc" id="L451">        fileAndFilterPanel.add(filterComboBox);</span>

<span class="nc" id="L453">        getBottomPanel().add(fileAndFilterPanel);</span>
<span class="nc" id="L454">        getBottomPanel().add(Box.createRigidArea(new Dimension(30, 0)));</span>

        // buttons
<span class="nc" id="L457">        getButtonPanel().setLayout(new BoxLayout(getButtonPanel(), BoxLayout.Y_AXIS));</span>

<span class="nc" id="L459">        approveButton = new JButton(getApproveButtonText(fc)) {</span>
            public Dimension getMaximumSize() {
<span class="nc bnc" id="L461" title="All 2 branches missed.">                return approveButton.getPreferredSize().width &gt; cancelButton.getPreferredSize().width ?</span>
<span class="nc" id="L462">                       approveButton.getPreferredSize() : cancelButton.getPreferredSize();</span>
            }
        };
<span class="nc" id="L465">        Insets buttonMargin = approveButton.getMargin();</span>
<span class="nc" id="L466">        buttonMargin = new InsetsUIResource(buttonMargin.top,    buttonMargin.left  + 5,</span>
                                            buttonMargin.bottom, buttonMargin.right + 5);
<span class="nc" id="L468">        approveButton.setMargin(buttonMargin);</span>
<span class="nc" id="L469">        approveButton.setMnemonic(getApproveButtonMnemonic(fc));</span>
<span class="nc" id="L470">        approveButton.addActionListener(getApproveSelectionAction());</span>
<span class="nc" id="L471">        approveButton.setToolTipText(getApproveButtonToolTipText(fc));</span>
<span class="nc" id="L472">        getButtonPanel().add(Box.createRigidArea(vstrut6));</span>
<span class="nc" id="L473">        getButtonPanel().add(approveButton);</span>
<span class="nc" id="L474">        getButtonPanel().add(Box.createRigidArea(vstrut4));</span>

<span class="nc" id="L476">        cancelButton = new JButton(cancelButtonText) {</span>
            public Dimension getMaximumSize() {
<span class="nc bnc" id="L478" title="All 2 branches missed.">                return approveButton.getPreferredSize().width &gt; cancelButton.getPreferredSize().width ?</span>
<span class="nc" id="L479">                       approveButton.getPreferredSize() : cancelButton.getPreferredSize();</span>
            }
        };
<span class="nc" id="L482">        cancelButton.setMargin(buttonMargin);</span>
<span class="nc" id="L483">        cancelButton.setToolTipText(cancelButtonToolTipText);</span>
<span class="nc" id="L484">        cancelButton.addActionListener(getCancelSelectionAction());</span>
<span class="nc" id="L485">        getButtonPanel().add(cancelButton);</span>

<span class="nc bnc" id="L487" title="All 2 branches missed.">        if(fc.getControlButtonsAreShown()) {</span>
<span class="nc" id="L488">            addControlButtons();</span>
        }
<span class="nc" id="L490">    }</span>

    private void updateUseShellFolder() {
        // Decide whether to use the ShellFolder class to populate shortcut
        // panel and combobox.
<span class="nc" id="L495">        JFileChooser fc = getFileChooser();</span>

<span class="nc bnc" id="L497" title="All 2 branches missed.">        if (FilePane.usesShellFolder(fc)) {</span>
<span class="nc bnc" id="L498" title="All 4 branches missed.">            if (placesBar == null &amp;&amp; !UIManager.getBoolean(&quot;FileChooser.noPlacesBar&quot;)) {</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">                placesBar = new WindowsPlacesBar(fc, XPStyle.getXP() != null);</span>
<span class="nc" id="L500">                fc.add(placesBar, BorderLayout.BEFORE_LINE_BEGINS);</span>
<span class="nc" id="L501">                fc.addPropertyChangeListener(placesBar);</span>
            }
        } else {
<span class="nc bnc" id="L504" title="All 2 branches missed.">            if (placesBar != null) {</span>
<span class="nc" id="L505">                fc.remove(placesBar);</span>
<span class="nc" id="L506">                fc.removePropertyChangeListener(placesBar);</span>
<span class="nc" id="L507">                placesBar = null;</span>
            }
        }
<span class="nc" id="L510">    }</span>

    protected JPanel getButtonPanel() {
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if(buttonPanel == null) {</span>
<span class="nc" id="L514">            buttonPanel = new JPanel();</span>
        }
<span class="nc" id="L516">        return buttonPanel;</span>
    }

    protected JPanel getBottomPanel() {
<span class="nc bnc" id="L520" title="All 2 branches missed.">        if(bottomPanel == null) {</span>
<span class="nc" id="L521">            bottomPanel = new JPanel();</span>
        }
<span class="nc" id="L523">        return bottomPanel;</span>
    }

    protected void installStrings(JFileChooser fc) {
<span class="nc" id="L527">        super.installStrings(fc);</span>

<span class="nc" id="L529">        Locale l = fc.getLocale();</span>

<span class="nc" id="L531">        lookInLabelMnemonic = getMnemonic(&quot;FileChooser.lookInLabelMnemonic&quot;, l);</span>
<span class="nc" id="L532">        lookInLabelText = UIManager.getString(&quot;FileChooser.lookInLabelText&quot;,l);</span>
<span class="nc" id="L533">        saveInLabelText = UIManager.getString(&quot;FileChooser.saveInLabelText&quot;,l);</span>

<span class="nc" id="L535">        fileNameLabelMnemonic = getMnemonic(&quot;FileChooser.fileNameLabelMnemonic&quot;, l);</span>
<span class="nc" id="L536">        fileNameLabelText = UIManager.getString(&quot;FileChooser.fileNameLabelText&quot;,l);</span>
<span class="nc" id="L537">        folderNameLabelMnemonic = getMnemonic(&quot;FileChooser.folderNameLabelMnemonic&quot;, l);</span>
<span class="nc" id="L538">        folderNameLabelText = UIManager.getString(&quot;FileChooser.folderNameLabelText&quot;,l);</span>

<span class="nc" id="L540">        filesOfTypeLabelMnemonic = getMnemonic(&quot;FileChooser.filesOfTypeLabelMnemonic&quot;, l);</span>
<span class="nc" id="L541">        filesOfTypeLabelText = UIManager.getString(&quot;FileChooser.filesOfTypeLabelText&quot;,l);</span>

<span class="nc" id="L543">        upFolderToolTipText =  UIManager.getString(&quot;FileChooser.upFolderToolTipText&quot;,l);</span>
<span class="nc" id="L544">        upFolderAccessibleName = UIManager.getString(&quot;FileChooser.upFolderAccessibleName&quot;,l);</span>

<span class="nc" id="L546">        newFolderToolTipText = UIManager.getString(&quot;FileChooser.newFolderToolTipText&quot;,l);</span>
<span class="nc" id="L547">        newFolderAccessibleName = UIManager.getString(&quot;FileChooser.newFolderAccessibleName&quot;,l);</span>

<span class="nc" id="L549">        viewMenuButtonToolTipText = UIManager.getString(&quot;FileChooser.viewMenuButtonToolTipText&quot;,l);</span>
<span class="nc" id="L550">        viewMenuButtonAccessibleName = UIManager.getString(&quot;FileChooser.viewMenuButtonAccessibleName&quot;,l);</span>
<span class="nc" id="L551">    }</span>

    private Integer getMnemonic(String key, Locale l) {
<span class="nc" id="L554">        return SwingUtilities2.getUIDefaultsInt(key, l);</span>
    }

    protected void installListeners(JFileChooser fc) {
<span class="nc" id="L558">        super.installListeners(fc);</span>
<span class="nc" id="L559">        ActionMap actionMap = getActionMap();</span>
<span class="nc" id="L560">        SwingUtilities.replaceUIActionMap(fc, actionMap);</span>
<span class="nc" id="L561">    }</span>

    protected ActionMap getActionMap() {
<span class="nc" id="L564">        return createActionMap();</span>
    }

    protected ActionMap createActionMap() {
<span class="nc" id="L568">        ActionMap map = new ActionMapUIResource();</span>
<span class="nc" id="L569">        FilePane.addActionsToMap(map, filePane.getActions());</span>
<span class="nc" id="L570">        return map;</span>
    }

    protected JPanel createList(JFileChooser fc) {
<span class="nc" id="L574">        return filePane.createList();</span>
    }

    protected JPanel createDetailsView(JFileChooser fc) {
<span class="nc" id="L578">        return filePane.createDetailsView();</span>
    }

    /**
     * Creates a selection listener for the list of files and directories.
     *
     * @param fc a &lt;code&gt;JFileChooser&lt;/code&gt;
     * @return a &lt;code&gt;ListSelectionListener&lt;/code&gt;
     */
    public ListSelectionListener createListSelectionListener(JFileChooser fc) {
<span class="nc" id="L588">        return super.createListSelectionListener(fc);</span>
    }

    // Obsolete class, not used in this version.
<span class="nc" id="L592">    protected class WindowsNewFolderAction extends NewFolderAction {</span>
    }

    // Obsolete class, not used in this version.
<span class="nc" id="L596">    protected class SingleClickListener extends MouseAdapter {</span>
    }

    // Obsolete class, not used in this version.
<span class="nc" id="L600">    protected class FileRenderer extends DefaultListCellRenderer  {</span>
    }

    public void uninstallUI(JComponent c) {
        // Remove listeners
<span class="nc" id="L605">        c.removePropertyChangeListener(filterComboBoxModel);</span>
<span class="nc" id="L606">        c.removePropertyChangeListener(filePane);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">        if (placesBar != null) {</span>
<span class="nc" id="L608">            c.removePropertyChangeListener(placesBar);</span>
        }
<span class="nc" id="L610">        cancelButton.removeActionListener(getCancelSelectionAction());</span>
<span class="nc" id="L611">        approveButton.removeActionListener(getApproveSelectionAction());</span>
<span class="nc" id="L612">        filenameTextField.removeActionListener(getApproveSelectionAction());</span>

<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (filePane != null) {</span>
<span class="nc" id="L615">            filePane.uninstallUI();</span>
<span class="nc" id="L616">            filePane = null;</span>
        }

<span class="nc" id="L619">        super.uninstallUI(c);</span>
<span class="nc" id="L620">    }</span>

    /**
     * Returns the preferred size of the specified
     * &lt;code&gt;JFileChooser&lt;/code&gt;.
     * The preferred size is at least as large,
     * in both height and width,
     * as the preferred size recommended
     * by the file chooser's layout manager.
     *
     * @param c  a &lt;code&gt;JFileChooser&lt;/code&gt;
     * @return   a &lt;code&gt;Dimension&lt;/code&gt; specifying the preferred
     *           width and height of the file chooser
     */
    public Dimension getPreferredSize(JComponent c) {
<span class="nc" id="L635">        int prefWidth = PREF_SIZE.width;</span>
<span class="nc" id="L636">        Dimension d = c.getLayout().preferredLayoutSize(c);</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">        if (d != null) {</span>
<span class="nc bnc" id="L638" title="All 4 branches missed.">            return new Dimension(d.width &lt; prefWidth ? prefWidth : d.width,</span>
                                 d.height &lt; PREF_SIZE.height ? PREF_SIZE.height : d.height);
        } else {
<span class="nc" id="L641">            return new Dimension(prefWidth, PREF_SIZE.height);</span>
        }
    }

    /**
     * Returns the minimum size of the &lt;code&gt;JFileChooser&lt;/code&gt;.
     *
     * @param c  a &lt;code&gt;JFileChooser&lt;/code&gt;
     * @return   a &lt;code&gt;Dimension&lt;/code&gt; specifying the minimum
     *           width and height of the file chooser
     */
    public Dimension getMinimumSize(JComponent c) {
<span class="nc" id="L653">        return MIN_SIZE;</span>
    }

    /**
     * Returns the maximum size of the &lt;code&gt;JFileChooser&lt;/code&gt;.
     *
     * @param c  a &lt;code&gt;JFileChooser&lt;/code&gt;
     * @return   a &lt;code&gt;Dimension&lt;/code&gt; specifying the maximum
     *           width and height of the file chooser
     */
    public Dimension getMaximumSize(JComponent c) {
<span class="nc" id="L664">        return new Dimension(Integer.MAX_VALUE, Integer.MAX_VALUE);</span>
    }

    private String fileNameString(File file) {
<span class="nc bnc" id="L668" title="All 2 branches missed.">        if (file == null) {</span>
<span class="nc" id="L669">            return null;</span>
        } else {
<span class="nc" id="L671">            JFileChooser fc = getFileChooser();</span>
<span class="nc bnc" id="L672" title="All 4 branches missed.">            if ((fc.isDirectorySelectionEnabled() &amp;&amp; !fc.isFileSelectionEnabled()) ||</span>
<span class="nc bnc" id="L673" title="All 6 branches missed.">                (fc.isDirectorySelectionEnabled() &amp;&amp; fc.isFileSelectionEnabled() &amp;&amp; fc.getFileSystemView().isFileSystemRoot(file))){</span>
<span class="nc" id="L674">                return file.getPath();</span>
            } else {
<span class="nc" id="L676">                return file.getName();</span>
            }
        }
    }

    private String fileNameString(File[] files) {
<span class="nc" id="L682">        StringBuffer buf = new StringBuffer();</span>
<span class="nc bnc" id="L683" title="All 4 branches missed.">        for (int i = 0; files != null &amp;&amp; i &lt; files.length; i++) {</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">            if (i &gt; 0) {</span>
<span class="nc" id="L685">                buf.append(&quot; &quot;);</span>
            }
<span class="nc bnc" id="L687" title="All 2 branches missed.">            if (files.length &gt; 1) {</span>
<span class="nc" id="L688">                buf.append(&quot;\&quot;&quot;);</span>
            }
<span class="nc" id="L690">            buf.append(fileNameString(files[i]));</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">            if (files.length &gt; 1) {</span>
<span class="nc" id="L692">                buf.append(&quot;\&quot;&quot;);</span>
            }
        }
<span class="nc" id="L695">        return buf.toString();</span>
    }

    /* The following methods are used by the PropertyChange Listener */

    private void doSelectedFileChanged(PropertyChangeEvent e) {
<span class="nc" id="L701">        File f = (File) e.getNewValue();</span>
<span class="nc" id="L702">        JFileChooser fc = getFileChooser();</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">        if (f != null</span>
<span class="nc bnc" id="L704" title="All 4 branches missed.">            &amp;&amp; ((fc.isFileSelectionEnabled() &amp;&amp; !f.isDirectory())</span>
<span class="nc bnc" id="L705" title="All 4 branches missed.">                || (f.isDirectory() &amp;&amp; fc.isDirectorySelectionEnabled()))) {</span>

<span class="nc" id="L707">            setFileName(fileNameString(f));</span>
        }
<span class="nc" id="L709">    }</span>

    private void doSelectedFilesChanged(PropertyChangeEvent e) {
<span class="nc" id="L712">        File[] files = (File[]) e.getNewValue();</span>
<span class="nc" id="L713">        JFileChooser fc = getFileChooser();</span>
<span class="nc bnc" id="L714" title="All 6 branches missed.">        if (files != null</span>
            &amp;&amp; files.length &gt; 0
<span class="nc bnc" id="L716" title="All 4 branches missed.">            &amp;&amp; (files.length &gt; 1 || fc.isDirectorySelectionEnabled() || !files[0].isDirectory())) {</span>
<span class="nc" id="L717">            setFileName(fileNameString(files));</span>
        }
<span class="nc" id="L719">    }</span>

    private void doDirectoryChanged(PropertyChangeEvent e) {
<span class="nc" id="L722">        JFileChooser fc = getFileChooser();</span>
<span class="nc" id="L723">        FileSystemView fsv = fc.getFileSystemView();</span>

<span class="nc" id="L725">        clearIconCache();</span>
<span class="nc" id="L726">        File currentDirectory = fc.getCurrentDirectory();</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">        if(currentDirectory != null) {</span>
<span class="nc" id="L728">            directoryComboBoxModel.addItem(currentDirectory);</span>

<span class="nc bnc" id="L730" title="All 4 branches missed.">            if (fc.isDirectorySelectionEnabled() &amp;&amp; !fc.isFileSelectionEnabled()) {</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">                if (fsv.isFileSystem(currentDirectory)) {</span>
<span class="nc" id="L732">                    setFileName(currentDirectory.getPath());</span>
                } else {
<span class="nc" id="L734">                    setFileName(null);</span>
                }
            }
        }
<span class="nc" id="L738">    }</span>

    private void doFilterChanged(PropertyChangeEvent e) {
<span class="nc" id="L741">        clearIconCache();</span>
<span class="nc" id="L742">    }</span>

    private void doFileSelectionModeChanged(PropertyChangeEvent e) {
<span class="nc bnc" id="L745" title="All 2 branches missed.">        if (fileNameLabel != null) {</span>
<span class="nc" id="L746">            populateFileNameLabel();</span>
        }
<span class="nc" id="L748">        clearIconCache();</span>

<span class="nc" id="L750">        JFileChooser fc = getFileChooser();</span>
<span class="nc" id="L751">        File currentDirectory = fc.getCurrentDirectory();</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">        if (currentDirectory != null</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">            &amp;&amp; fc.isDirectorySelectionEnabled()</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">            &amp;&amp; !fc.isFileSelectionEnabled()</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">            &amp;&amp; fc.getFileSystemView().isFileSystem(currentDirectory)) {</span>

<span class="nc" id="L757">            setFileName(currentDirectory.getPath());</span>
        } else {
<span class="nc" id="L759">            setFileName(null);</span>
        }
<span class="nc" id="L761">    }</span>

    private void doAccessoryChanged(PropertyChangeEvent e) {
<span class="nc bnc" id="L764" title="All 2 branches missed.">        if(getAccessoryPanel() != null) {</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">            if(e.getOldValue() != null) {</span>
<span class="nc" id="L766">                getAccessoryPanel().remove((JComponent) e.getOldValue());</span>
            }
<span class="nc" id="L768">            JComponent accessory = (JComponent) e.getNewValue();</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">            if(accessory != null) {</span>
<span class="nc" id="L770">                getAccessoryPanel().add(accessory, BorderLayout.CENTER);</span>
            }
        }
<span class="nc" id="L773">    }</span>

    private void doApproveButtonTextChanged(PropertyChangeEvent e) {
<span class="nc" id="L776">        JFileChooser chooser = getFileChooser();</span>
<span class="nc" id="L777">        approveButton.setText(getApproveButtonText(chooser));</span>
<span class="nc" id="L778">        approveButton.setToolTipText(getApproveButtonToolTipText(chooser));</span>
<span class="nc" id="L779">        approveButton.setMnemonic(getApproveButtonMnemonic(chooser));</span>
<span class="nc" id="L780">    }</span>

    private void doDialogTypeChanged(PropertyChangeEvent e) {
<span class="nc" id="L783">        JFileChooser chooser = getFileChooser();</span>
<span class="nc" id="L784">        approveButton.setText(getApproveButtonText(chooser));</span>
<span class="nc" id="L785">        approveButton.setToolTipText(getApproveButtonToolTipText(chooser));</span>
<span class="nc" id="L786">        approveButton.setMnemonic(getApproveButtonMnemonic(chooser));</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (chooser.getDialogType() == JFileChooser.SAVE_DIALOG) {</span>
<span class="nc" id="L788">            lookInLabel.setText(saveInLabelText);</span>
        } else {
<span class="nc" id="L790">            lookInLabel.setText(lookInLabelText);</span>
        }
<span class="nc" id="L792">    }</span>

    private void doApproveButtonMnemonicChanged(PropertyChangeEvent e) {
<span class="nc" id="L795">        approveButton.setMnemonic(getApproveButtonMnemonic(getFileChooser()));</span>
<span class="nc" id="L796">    }</span>

    private void doControlButtonsChanged(PropertyChangeEvent e) {
<span class="nc bnc" id="L799" title="All 2 branches missed.">        if(getFileChooser().getControlButtonsAreShown()) {</span>
<span class="nc" id="L800">            addControlButtons();</span>
        } else {
<span class="nc" id="L802">            removeControlButtons();</span>
        }
<span class="nc" id="L804">    }</span>

    /*
     * Listen for filechooser property changes, such as
     * the selected file changing, or the type of the dialog changing.
     */
    public PropertyChangeListener createPropertyChangeListener(JFileChooser fc) {
<span class="nc" id="L811">        return new PropertyChangeListener() {</span>
            public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L813">                String s = e.getPropertyName();</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">                if(s.equals(JFileChooser.SELECTED_FILE_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L815">                    doSelectedFileChanged(e);</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">                } else if (s.equals(JFileChooser.SELECTED_FILES_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L817">                    doSelectedFilesChanged(e);</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">                } else if(s.equals(JFileChooser.DIRECTORY_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L819">                    doDirectoryChanged(e);</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">                } else if(s.equals(JFileChooser.FILE_FILTER_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L821">                    doFilterChanged(e);</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">                } else if(s.equals(JFileChooser.FILE_SELECTION_MODE_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L823">                    doFileSelectionModeChanged(e);</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">                } else if(s.equals(JFileChooser.ACCESSORY_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L825">                    doAccessoryChanged(e);</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">                } else if (s.equals(JFileChooser.APPROVE_BUTTON_TEXT_CHANGED_PROPERTY) ||</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">                           s.equals(JFileChooser.APPROVE_BUTTON_TOOL_TIP_TEXT_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L828">                    doApproveButtonTextChanged(e);</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                } else if(s.equals(JFileChooser.DIALOG_TYPE_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L830">                    doDialogTypeChanged(e);</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                } else if(s.equals(JFileChooser.APPROVE_BUTTON_MNEMONIC_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L832">                    doApproveButtonMnemonicChanged(e);</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">                } else if(s.equals(JFileChooser.CONTROL_BUTTONS_ARE_SHOWN_CHANGED_PROPERTY)) {</span>
<span class="nc" id="L834">                    doControlButtonsChanged(e);</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">                } else if (s == &quot;FileChooser.useShellFolder&quot;) {</span>
<span class="nc" id="L836">                    updateUseShellFolder();</span>
<span class="nc" id="L837">                    doDirectoryChanged(e);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">                } else if (s.equals(&quot;componentOrientation&quot;)) {</span>
<span class="nc" id="L839">                    ComponentOrientation o = (ComponentOrientation)e.getNewValue();</span>
<span class="nc" id="L840">                    JFileChooser cc = (JFileChooser)e.getSource();</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">                    if (o != e.getOldValue()) {</span>
<span class="nc" id="L842">                        cc.applyComponentOrientation(o);</span>
                    }
<span class="nc bnc" id="L844" title="All 2 branches missed.">                } else if (s.equals(&quot;ancestor&quot;)) {</span>
<span class="nc bnc" id="L845" title="All 4 branches missed.">                    if (e.getOldValue() == null &amp;&amp; e.getNewValue() != null) {</span>
                        // Ancestor was added, set initial focus
<span class="nc" id="L847">                        filenameTextField.selectAll();</span>
<span class="nc" id="L848">                        filenameTextField.requestFocus();</span>
                    }
                }
<span class="nc" id="L851">            }</span>
        };
    }


    protected void removeControlButtons() {
<span class="nc" id="L857">        getBottomPanel().remove(getButtonPanel());</span>
<span class="nc" id="L858">    }</span>

    protected void addControlButtons() {
<span class="nc" id="L861">        getBottomPanel().add(getButtonPanel());</span>
<span class="nc" id="L862">    }</span>

    public void ensureFileIsVisible(JFileChooser fc, File f) {
<span class="nc" id="L865">        filePane.ensureFileIsVisible(fc, f);</span>
<span class="nc" id="L866">    }</span>

    public void rescanCurrentDirectory(JFileChooser fc) {
<span class="nc" id="L869">        filePane.rescanCurrentDirectory();</span>
<span class="nc" id="L870">    }</span>

    public String getFileName() {
<span class="nc bnc" id="L873" title="All 2 branches missed.">        if(filenameTextField != null) {</span>
<span class="nc" id="L874">            return filenameTextField.getText();</span>
        } else {
<span class="nc" id="L876">            return null;</span>
        }
    }

    public void setFileName(String filename) {
<span class="nc bnc" id="L881" title="All 2 branches missed.">        if(filenameTextField != null) {</span>
<span class="nc" id="L882">            filenameTextField.setText(filename);</span>
        }
<span class="nc" id="L884">    }</span>

    /**
     * Property to remember whether a directory is currently selected in the UI.
     * This is normally called by the UI on a selection event.
     *
     * @param directorySelected if a directory is currently selected.
     * @since 1.4
     */
    protected void setDirectorySelected(boolean directorySelected) {
<span class="nc" id="L894">        super.setDirectorySelected(directorySelected);</span>
<span class="nc" id="L895">        JFileChooser chooser = getFileChooser();</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">        if(directorySelected) {</span>
<span class="nc" id="L897">            approveButton.setText(directoryOpenButtonText);</span>
<span class="nc" id="L898">            approveButton.setToolTipText(directoryOpenButtonToolTipText);</span>
<span class="nc" id="L899">            approveButton.setMnemonic(directoryOpenButtonMnemonic);</span>
        } else {
<span class="nc" id="L901">            approveButton.setText(getApproveButtonText(chooser));</span>
<span class="nc" id="L902">            approveButton.setToolTipText(getApproveButtonToolTipText(chooser));</span>
<span class="nc" id="L903">            approveButton.setMnemonic(getApproveButtonMnemonic(chooser));</span>
        }
<span class="nc" id="L905">    }</span>

    public String getDirectoryName() {
        // PENDING(jeff) - get the name from the directory combobox
<span class="nc" id="L909">        return null;</span>
    }

    public void setDirectoryName(String dirname) {
        // PENDING(jeff) - set the name in the directory combobox
<span class="nc" id="L914">    }</span>

    protected DirectoryComboBoxRenderer createDirectoryComboBoxRenderer(JFileChooser fc) {
<span class="nc" id="L917">        return new DirectoryComboBoxRenderer();</span>
    }

    private static JButton createToolButton(Action a, Icon defaultIcon, String toolTipText, String accessibleName) {
<span class="nc" id="L921">        final JButton result = new JButton(a);</span>

<span class="nc" id="L923">        result.setText(null);</span>
<span class="nc" id="L924">        result.setIcon(defaultIcon);</span>
<span class="nc" id="L925">        result.setToolTipText(toolTipText);</span>
<span class="nc" id="L926">        result.setRequestFocusEnabled(false);</span>
<span class="nc" id="L927">        result.putClientProperty(AccessibleContext.ACCESSIBLE_NAME_PROPERTY, accessibleName);</span>
<span class="nc" id="L928">        result.putClientProperty(WindowsLookAndFeel.HI_RES_DISABLED_ICON_CLIENT_KEY, Boolean.TRUE);</span>
<span class="nc" id="L929">        result.setAlignmentX(JComponent.LEFT_ALIGNMENT);</span>
<span class="nc" id="L930">        result.setAlignmentY(JComponent.CENTER_ALIGNMENT);</span>
<span class="nc" id="L931">        result.setMargin(shrinkwrap);</span>
<span class="nc" id="L932">        result.setFocusPainted(false);</span>

<span class="nc" id="L934">        result.setModel(new DefaultButtonModel() {</span>
            public void setPressed(boolean b) {
                // Forbid keyboard actions if the button is not in rollover state
<span class="nc bnc" id="L937" title="All 4 branches missed.">                if (!b || isRollover()) {</span>
<span class="nc" id="L938">                    super.setPressed(b);</span>
                }
<span class="nc" id="L940">            }</span>

            public void setRollover(boolean b) {
<span class="nc bnc" id="L943" title="All 4 branches missed.">                if (b &amp;&amp; !isRollover()) {</span>
                    // Reset other buttons
<span class="nc bnc" id="L945" title="All 2 branches missed.">                    for (Component component : result.getParent().getComponents()) {</span>
<span class="nc bnc" id="L946" title="All 4 branches missed.">                        if (component instanceof JButton &amp;&amp; component != result) {</span>
<span class="nc" id="L947">                            ((JButton) component).getModel().setRollover(false);</span>
                        }
                    }
                }

<span class="nc" id="L952">                super.setRollover(b);</span>
<span class="nc" id="L953">            }</span>

            public void setSelected(boolean b) {
<span class="nc" id="L956">                super.setSelected(b);</span>

<span class="nc bnc" id="L958" title="All 2 branches missed.">                if (b) {</span>
<span class="nc" id="L959">                    stateMask |= PRESSED | ARMED;</span>
                } else {
<span class="nc" id="L961">                    stateMask &amp;= ~(PRESSED | ARMED);</span>
                }
<span class="nc" id="L963">            }</span>
        });

<span class="nc" id="L966">        result.addFocusListener(new FocusAdapter() {</span>
            public void focusGained(FocusEvent e) {
<span class="nc" id="L968">                result.getModel().setRollover(true);</span>
<span class="nc" id="L969">            }</span>

            public void focusLost(FocusEvent e) {
<span class="nc" id="L972">                result.getModel().setRollover(false);</span>
<span class="nc" id="L973">            }</span>
        });

<span class="nc" id="L976">        return result;</span>
    }

    //
    // Renderer for DirectoryComboBox
    //
<span class="nc" id="L982">    class DirectoryComboBoxRenderer extends DefaultListCellRenderer  {</span>
<span class="nc" id="L983">        IndentIcon ii = new IndentIcon();</span>
        public Component getListCellRendererComponent(JList list, Object value,
                                                      int index, boolean isSelected,
                                                      boolean cellHasFocus) {

<span class="nc" id="L988">            super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);</span>

<span class="nc bnc" id="L990" title="All 2 branches missed.">            if (value == null) {</span>
<span class="nc" id="L991">                setText(&quot;&quot;);</span>
<span class="nc" id="L992">                return this;</span>
            }
<span class="nc" id="L994">            File directory = (File)value;</span>
<span class="nc" id="L995">            setText(getFileChooser().getName(directory));</span>
<span class="nc" id="L996">            Icon icon = getFileChooser().getIcon(directory);</span>
<span class="nc" id="L997">            ii.icon = icon;</span>
<span class="nc" id="L998">            ii.depth = directoryComboBoxModel.getDepth(index);</span>
<span class="nc" id="L999">            setIcon(ii);</span>

<span class="nc" id="L1001">            return this;</span>
        }
    }

    final static int space = 10;
<span class="nc" id="L1006">    class IndentIcon implements Icon {</span>

<span class="nc" id="L1008">        Icon icon = null;</span>
<span class="nc" id="L1009">        int depth = 0;</span>

        public void paintIcon(Component c, Graphics g, int x, int y) {
<span class="nc bnc" id="L1012" title="All 2 branches missed.">            if (c.getComponentOrientation().isLeftToRight()) {</span>
<span class="nc" id="L1013">                icon.paintIcon(c, g, x+depth*space, y);</span>
            } else {
<span class="nc" id="L1015">                icon.paintIcon(c, g, x, y);</span>
            }
<span class="nc" id="L1017">        }</span>

        public int getIconWidth() {
<span class="nc" id="L1020">            return icon.getIconWidth() + depth*space;</span>
        }

        public int getIconHeight() {
<span class="nc" id="L1024">            return icon.getIconHeight();</span>
        }

    }

    //
    // DataModel for DirectoryComboxbox
    //
    protected DirectoryComboBoxModel createDirectoryComboBoxModel(JFileChooser fc) {
<span class="nc" id="L1033">        return new DirectoryComboBoxModel();</span>
    }

    /**
     * Data model for a type-face selection combo-box.
     */
    protected class DirectoryComboBoxModel extends AbstractListModel&lt;File&gt; implements ComboBoxModel&lt;File&gt; {
<span class="nc" id="L1040">        Vector&lt;File&gt; directories = new Vector&lt;File&gt;();</span>
<span class="nc" id="L1041">        int[] depths = null;</span>
<span class="nc" id="L1042">        File selectedDirectory = null;</span>
<span class="nc" id="L1043">        JFileChooser chooser = getFileChooser();</span>
<span class="nc" id="L1044">        FileSystemView fsv = chooser.getFileSystemView();</span>

<span class="nc" id="L1046">        public DirectoryComboBoxModel() {</span>
            // Add the current directory to the model, and make it the
            // selectedDirectory
<span class="nc" id="L1049">            File dir = getFileChooser().getCurrentDirectory();</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">            if(dir != null) {</span>
<span class="nc" id="L1051">                addItem(dir);</span>
            }
<span class="nc" id="L1053">        }</span>

        /**
         * Adds the directory to the model and sets it to be selected,
         * additionally clears out the previous selected directory and
         * the paths leading up to it, if any.
         */
        private void addItem(File directory) {

<span class="nc bnc" id="L1062" title="All 2 branches missed.">            if(directory == null) {</span>
<span class="nc" id="L1063">                return;</span>
            }

<span class="nc" id="L1066">            boolean useShellFolder = FilePane.usesShellFolder(chooser);</span>

<span class="nc" id="L1068">            directories.clear();</span>

            File[] baseFolders;
<span class="nc bnc" id="L1071" title="All 2 branches missed.">            if (useShellFolder) {</span>
<span class="nc" id="L1072">                baseFolders = AccessController.doPrivileged(new PrivilegedAction&lt;File[]&gt;() {</span>
                    public File[] run() {
<span class="nc" id="L1074">                        return (File[]) ShellFolder.get(&quot;fileChooserComboBoxFolders&quot;);</span>
                    }
                });
            } else {
<span class="nc" id="L1078">                baseFolders = fsv.getRoots();</span>
            }
<span class="nc" id="L1080">            directories.addAll(Arrays.asList(baseFolders));</span>

            // Get the canonical (full) path. This has the side
            // benefit of removing extraneous chars from the path,
            // for example /foo/bar/ becomes /foo/bar
            File canonical;
            try {
<span class="nc" id="L1087">                canonical = directory.getCanonicalFile();</span>
<span class="nc" id="L1088">            } catch (IOException e) {</span>
                // Maybe drive is not ready. Can't abort here.
<span class="nc" id="L1090">                canonical = directory;</span>
<span class="nc" id="L1091">            }</span>

            // create File instances of each directory leading up to the top
            try {
<span class="nc bnc" id="L1095" title="All 2 branches missed.">                File sf = useShellFolder ? ShellFolder.getShellFolder(canonical)</span>
                                         : canonical;
<span class="nc" id="L1097">                File f = sf;</span>
<span class="nc" id="L1098">                Vector&lt;File&gt; path = new Vector&lt;File&gt;(10);</span>
                do {
<span class="nc" id="L1100">                    path.addElement(f);</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">                } while ((f = f.getParentFile()) != null);</span>

<span class="nc" id="L1103">                int pathCount = path.size();</span>
                // Insert chain at appropriate place in vector
<span class="nc bnc" id="L1105" title="All 2 branches missed.">                for (int i = 0; i &lt; pathCount; i++) {</span>
<span class="nc" id="L1106">                    f = path.get(i);</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">                    if (directories.contains(f)) {</span>
<span class="nc" id="L1108">                        int topIndex = directories.indexOf(f);</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">                        for (int j = i-1; j &gt;= 0; j--) {</span>
<span class="nc" id="L1110">                            directories.insertElementAt(path.get(j), topIndex+i-j);</span>
                        }
<span class="nc" id="L1112">                        break;</span>
                    }
                }
<span class="nc" id="L1115">                calculateDepths();</span>
<span class="nc" id="L1116">                setSelectedItem(sf);</span>
<span class="nc" id="L1117">            } catch (FileNotFoundException ex) {</span>
<span class="nc" id="L1118">                calculateDepths();</span>
<span class="nc" id="L1119">            }</span>
<span class="nc" id="L1120">        }</span>

        private void calculateDepths() {
<span class="nc" id="L1123">            depths = new int[directories.size()];</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">            for (int i = 0; i &lt; depths.length; i++) {</span>
<span class="nc" id="L1125">                File dir = directories.get(i);</span>
<span class="nc" id="L1126">                File parent = dir.getParentFile();</span>
<span class="nc" id="L1127">                depths[i] = 0;</span>
<span class="nc bnc" id="L1128" title="All 2 branches missed.">                if (parent != null) {</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">                    for (int j = i-1; j &gt;= 0; j--) {</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">                        if (parent.equals(directories.get(j))) {</span>
<span class="nc" id="L1131">                            depths[i] = depths[j] + 1;</span>
<span class="nc" id="L1132">                            break;</span>
                        }
                    }
                }
            }
<span class="nc" id="L1137">        }</span>

        public int getDepth(int i) {
<span class="nc bnc" id="L1140" title="All 6 branches missed.">            return (depths != null &amp;&amp; i &gt;= 0 &amp;&amp; i &lt; depths.length) ? depths[i] : 0;</span>
        }

        public void setSelectedItem(Object selectedDirectory) {
<span class="nc" id="L1144">            this.selectedDirectory = (File)selectedDirectory;</span>
<span class="nc" id="L1145">            fireContentsChanged(this, -1, -1);</span>
<span class="nc" id="L1146">        }</span>

        public Object getSelectedItem() {
<span class="nc" id="L1149">            return selectedDirectory;</span>
        }

        public int getSize() {
<span class="nc" id="L1153">            return directories.size();</span>
        }

        public File getElementAt(int index) {
<span class="nc" id="L1157">            return directories.elementAt(index);</span>
        }
    }

    //
    // Renderer for Types ComboBox
    //
    protected FilterComboBoxRenderer createFilterComboBoxRenderer() {
<span class="nc" id="L1165">        return new FilterComboBoxRenderer();</span>
    }

    /**
     * Render different type sizes and styles.
     */
<span class="nc" id="L1171">    public class FilterComboBoxRenderer extends DefaultListCellRenderer {</span>
        public Component getListCellRendererComponent(JList list,
            Object value, int index, boolean isSelected,
            boolean cellHasFocus) {

<span class="nc" id="L1176">            super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);</span>

<span class="nc bnc" id="L1178" title="All 4 branches missed.">            if (value != null &amp;&amp; value instanceof FileFilter) {</span>
<span class="nc" id="L1179">                setText(((FileFilter)value).getDescription());</span>
            }

<span class="nc" id="L1182">            return this;</span>
        }
    }

    //
    // DataModel for Types Comboxbox
    //
    protected FilterComboBoxModel createFilterComboBoxModel() {
<span class="nc" id="L1190">        return new FilterComboBoxModel();</span>
    }

    /**
     * Data model for a type-face selection combo-box.
     */
<span class="nc" id="L1196">    protected class FilterComboBoxModel extends AbstractFilterComboBoxModel {</span>
        protected JFileChooser getFileChooser() {
<span class="nc" id="L1198">            return WindowsFileChooserUI.this.getFileChooser();</span>
        }
    }

    public void valueChanged(ListSelectionEvent e) {
<span class="nc" id="L1203">        JFileChooser fc = getFileChooser();</span>
<span class="nc" id="L1204">        File f = fc.getSelectedFile();</span>
<span class="nc bnc" id="L1205" title="All 6 branches missed.">        if (!e.getValueIsAdjusting() &amp;&amp; f != null &amp;&amp; !getFileChooser().isTraversable(f)) {</span>
<span class="nc" id="L1206">            setFileName(fileNameString(f));</span>
        }
<span class="nc" id="L1208">    }</span>

    /**
     * Acts when DirectoryComboBox has changed the selected item.
     */
<span class="nc" id="L1213">    protected class DirectoryComboBoxAction implements ActionListener {</span>




        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1219">            File f = (File)directoryComboBox.getSelectedItem();</span>
<span class="nc" id="L1220">            getFileChooser().setCurrentDirectory(f);</span>
<span class="nc" id="L1221">        }</span>
    }

    protected JButton getApproveButton(JFileChooser fc) {
<span class="nc" id="L1225">        return approveButton;</span>
    }

    public FileView getFileView(JFileChooser fc) {
<span class="nc" id="L1229">        return fileView;</span>
    }

    // ***********************
    // * FileView operations *
    // ***********************
<span class="nc" id="L1235">    protected class WindowsFileView extends BasicFileView {</span>
        /* FileView type descriptions */

        public Icon getIcon(File f) {
<span class="nc" id="L1239">            Icon icon = getCachedIcon(f);</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">            if (icon != null) {</span>
<span class="nc" id="L1241">                return icon;</span>
            }
<span class="nc bnc" id="L1243" title="All 2 branches missed.">            if (f != null) {</span>
<span class="nc" id="L1244">                icon = getFileChooser().getFileSystemView().getSystemIcon(f);</span>
            }
<span class="nc bnc" id="L1246" title="All 2 branches missed.">            if (icon == null) {</span>
<span class="nc" id="L1247">                icon = super.getIcon(f);</span>
            }
<span class="nc" id="L1249">            cacheIcon(f, icon);</span>
<span class="nc" id="L1250">            return icon;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>