<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ToolkitImage.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.awt.image</a> &gt; <span class="el_source">ToolkitImage.java</span></div><h1>ToolkitImage.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1995, 2004, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.awt.image;

import java.util.Hashtable;
import java.util.Enumeration;

import java.awt.Component;
import java.awt.Color;
import java.awt.Graphics;
import java.awt.Image;
import java.awt.image.BufferedImage;
import java.awt.image.ColorModel;
import java.awt.image.ImageProducer;
import java.awt.image.ImageConsumer;
import java.awt.image.ImageObserver;
import sun.awt.image.ImageRepresentation;
import sun.awt.image.FileImageSource;

public class ToolkitImage extends Image {

    /**
     * The object which is used to reconstruct the original image data
     * as needed.
     */
    ImageProducer source;

    InputStreamImageSource src;

    ImageRepresentation imagerep;

    static {
        /* ensure that the necessary native libraries are loaded */
<span class="nc" id="L57">        NativeLibLoader.loadLibraries();</span>
<span class="nc" id="L58">    }</span>

<span class="nc" id="L60">    protected ToolkitImage() {</span>
<span class="nc" id="L61">    }</span>

    /**
     * Construct an image from an ImageProducer object.
     */
<span class="nc" id="L66">    public ToolkitImage(ImageProducer is) {</span>
<span class="nc" id="L67">        source = is;</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (is instanceof InputStreamImageSource) {</span>
<span class="nc" id="L69">            src = (InputStreamImageSource) is;</span>
        }
<span class="nc" id="L71">    }</span>

    public ImageProducer getSource() {
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L75">            src.checkSecurity(null, false);</span>
        }
<span class="nc" id="L77">        return source;</span>
    }

<span class="nc" id="L80">    private int width = -1;</span>
<span class="nc" id="L81">    private int height = -1;</span>
    private Hashtable properties;

    private int availinfo;

    /**
     * Return the width of the original image source.
     * If the width isn't known, then the image is reconstructed.
     */
    public int getWidth() {
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L92">            src.checkSecurity(null, false);</span>
        }
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if ((availinfo &amp; ImageObserver.WIDTH) == 0) {</span>
<span class="nc" id="L95">            reconstruct(ImageObserver.WIDTH);</span>
        }
<span class="nc" id="L97">        return width;</span>
    }

    /**
     * Return the width of the original image source.
     * If the width isn't known, then the ImageObserver object will be
     * notified when the data is available.
     */
    public synchronized int getWidth(ImageObserver iw) {
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L107">            src.checkSecurity(null, false);</span>
        }
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if ((availinfo &amp; ImageObserver.WIDTH) == 0) {</span>
<span class="nc" id="L110">            addWatcher(iw, true);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if ((availinfo &amp; ImageObserver.WIDTH) == 0) {</span>
<span class="nc" id="L112">                return -1;</span>
            }
        }
<span class="nc" id="L115">        return width;</span>
    }

    /**
     * Return the height of the original image source.
     * If the height isn't known, then the image is reconstructed.
     */
    public int getHeight() {
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L124">            src.checkSecurity(null, false);</span>
        }
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if ((availinfo &amp; ImageObserver.HEIGHT) == 0) {</span>
<span class="nc" id="L127">            reconstruct(ImageObserver.HEIGHT);</span>
        }
<span class="nc" id="L129">        return height;</span>
    }

    /**
     * Return the height of the original image source.
     * If the height isn't known, then the ImageObserver object will be
     * notified when the data is available.
     */
    public synchronized int getHeight(ImageObserver iw) {
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L139">            src.checkSecurity(null, false);</span>
        }
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if ((availinfo &amp; ImageObserver.HEIGHT) == 0) {</span>
<span class="nc" id="L142">            addWatcher(iw, true);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if ((availinfo &amp; ImageObserver.HEIGHT) == 0) {</span>
<span class="nc" id="L144">                return -1;</span>
            }
        }
<span class="nc" id="L147">        return height;</span>
    }

    /**
     * Return a property of the image by name.  Individual property names
     * are defined by the various image formats.  If a property is not
     * defined for a particular image, then this method will return the
     * UndefinedProperty object.  If the properties for this image are
     * not yet known, then this method will return null and the ImageObserver
     * object will be notified later.  The property name &quot;comment&quot; should
     * be used to store an optional comment which can be presented to
     * the user as a description of the image, its source, or its author.
     */
    public Object getProperty(String name, ImageObserver observer) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (name == null) {</span>
<span class="nc" id="L162">            throw new NullPointerException(&quot;null property name is not allowed&quot;);</span>
        }

<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L166">            src.checkSecurity(null, false);</span>
        }
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (properties == null) {</span>
<span class="nc" id="L169">            addWatcher(observer, true);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (properties == null) {</span>
<span class="nc" id="L171">                return null;</span>
            }
        }
<span class="nc" id="L174">        Object o = properties.get(name);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (o == null) {</span>
<span class="nc" id="L176">            o = Image.UndefinedProperty;</span>
        }
<span class="nc" id="L178">        return o;</span>
    }

    public boolean hasError() {
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L183">            src.checkSecurity(null, false);</span>
        }
<span class="nc bnc" id="L185" title="All 2 branches missed.">        return (availinfo &amp; ImageObserver.ERROR) != 0;</span>
    }

    public int check(ImageObserver iw) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L190">            src.checkSecurity(null, false);</span>
        }
<span class="nc bnc" id="L192" title="All 4 branches missed.">        if ((availinfo &amp; ImageObserver.ERROR) == 0 &amp;&amp;</span>
            ((~availinfo) &amp; (ImageObserver.WIDTH |
                             ImageObserver.HEIGHT |
                             ImageObserver.PROPERTIES)) != 0) {
<span class="nc" id="L196">            addWatcher(iw, false);</span>
        }
<span class="nc" id="L198">        return availinfo;</span>
    }

    public void preload(ImageObserver iw) {
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L203">            src.checkSecurity(null, false);</span>
        }
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if ((availinfo &amp; ImageObserver.ALLBITS) == 0) {</span>
<span class="nc" id="L206">            addWatcher(iw, true);</span>
        }
<span class="nc" id="L208">    }</span>

    private synchronized void addWatcher(ImageObserver iw, boolean load) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if ((availinfo &amp; ImageObserver.ERROR) != 0) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (iw != null) {</span>
<span class="nc" id="L213">                iw.imageUpdate(this, ImageObserver.ERROR|ImageObserver.ABORT,</span>
                               -1, -1, -1, -1);
            }
<span class="nc" id="L216">            return;</span>
        }
<span class="nc" id="L218">        ImageRepresentation ir = getImageRep();</span>
<span class="nc" id="L219">        ir.addWatcher(iw);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (load) {</span>
<span class="nc" id="L221">            ir.startProduction();</span>
        }
<span class="nc" id="L223">    }</span>

    private synchronized void reconstruct(int flags) {
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if ((flags &amp; ~availinfo) != 0) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if ((availinfo &amp; ImageObserver.ERROR) != 0) {</span>
<span class="nc" id="L228">                return;</span>
            }
<span class="nc" id="L230">            ImageRepresentation ir = getImageRep();</span>
<span class="nc" id="L231">            ir.startProduction();</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            while ((flags &amp; ~availinfo) != 0) {</span>
                try {
<span class="nc" id="L234">                    wait();</span>
<span class="nc" id="L235">                } catch (InterruptedException e) {</span>
<span class="nc" id="L236">                    Thread.currentThread().interrupt();</span>
<span class="nc" id="L237">                    return;</span>
<span class="nc" id="L238">                }</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                if ((availinfo &amp; ImageObserver.ERROR) != 0) {</span>
<span class="nc" id="L240">                    return;</span>
                }
            }
        }
<span class="nc" id="L244">    }</span>

    synchronized void addInfo(int newinfo) {
<span class="nc" id="L247">        availinfo |= newinfo;</span>
<span class="nc" id="L248">        notifyAll();</span>
<span class="nc" id="L249">    }</span>

    void setDimensions(int w, int h) {
<span class="nc" id="L252">        width = w;</span>
<span class="nc" id="L253">        height = h;</span>
<span class="nc" id="L254">        addInfo(ImageObserver.WIDTH | ImageObserver.HEIGHT);</span>
<span class="nc" id="L255">    }</span>

    void setProperties(Hashtable props) {
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (props == null) {</span>
<span class="nc" id="L259">            props = new Hashtable();</span>
        }
<span class="nc" id="L261">        properties = props;</span>
<span class="nc" id="L262">        addInfo(ImageObserver.PROPERTIES);</span>
<span class="nc" id="L263">    }</span>

    synchronized void infoDone(int status) {
<span class="nc bnc" id="L266" title="All 4 branches missed.">        if (status == ImageConsumer.IMAGEERROR ||</span>
            ((~availinfo) &amp; (ImageObserver.WIDTH |
                             ImageObserver.HEIGHT)) != 0) {
<span class="nc" id="L269">            addInfo(ImageObserver.ERROR);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        } else if ((availinfo &amp; ImageObserver.PROPERTIES) == 0) {</span>
<span class="nc" id="L271">            setProperties(null);</span>
        }
<span class="nc" id="L273">    }</span>

    public void flush() {
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L277">            src.checkSecurity(null, false);</span>
        }

        ImageRepresentation ir;
<span class="nc" id="L281">        synchronized (this) {</span>
<span class="nc" id="L282">            availinfo &amp;= ~ImageObserver.ERROR;</span>
<span class="nc" id="L283">            ir = imagerep;</span>
<span class="nc" id="L284">            imagerep = null;</span>
<span class="nc" id="L285">        }</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (ir != null) {</span>
<span class="nc" id="L287">            ir.abort();</span>
        }
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L290">            src.flush();</span>
        }
<span class="nc" id="L292">    }</span>

    protected ImageRepresentation makeImageRep() {
<span class="nc" id="L295">        return new ImageRepresentation(this, ColorModel.getRGBdefault(),</span>
                                       false);
    }

    public synchronized ImageRepresentation getImageRep() {
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L301">            src.checkSecurity(null, false);</span>
        }
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (imagerep == null) {</span>
<span class="nc" id="L304">            imagerep = makeImageRep();</span>
        }
<span class="nc" id="L306">        return imagerep;</span>
    }

    public Graphics getGraphics() {
<span class="nc" id="L310">        throw new UnsupportedOperationException(&quot;getGraphics() not valid for images &quot; +</span>
                                     &quot;created with createImage(producer)&quot;);
    }

    /* this method is needed by printing code */
    public ColorModel getColorModel() {
<span class="nc" id="L316">        ImageRepresentation imageRep = getImageRep();</span>
<span class="nc" id="L317">        return imageRep.getColorModel();</span>
    }

    /* this method is needed by printing code */
    public BufferedImage getBufferedImage() {
<span class="nc" id="L322">        ImageRepresentation imageRep = getImageRep();</span>
<span class="nc" id="L323">        return imageRep.getBufferedImage();</span>
    }

    public void setAccelerationPriority(float priority) {
<span class="nc" id="L327">        super.setAccelerationPriority(priority);</span>
<span class="nc" id="L328">        ImageRepresentation imageRep = getImageRep();</span>
<span class="nc" id="L329">        imageRep.setAccelerationPriority(accelerationPriority);</span>
<span class="nc" id="L330">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>