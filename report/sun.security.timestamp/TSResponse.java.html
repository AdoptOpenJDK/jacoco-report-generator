<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>TSResponse.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.timestamp</a> &gt; <span class="el_source">TSResponse.java</span></div><h1>TSResponse.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.timestamp;

import java.io.IOException;
import sun.security.pkcs.PKCS7;
import sun.security.util.Debug;
import sun.security.util.DerValue;

/**
 * This class provides the response corresponding to a timestamp request,
 * as defined in
 * &lt;a href=&quot;http://www.ietf.org/rfc/rfc3161.txt&quot;&gt;RFC 3161&lt;/a&gt;.
 *
 * The TimeStampResp ASN.1 type has the following definition:
 * &lt;pre&gt;
 *
 *     TimeStampResp ::= SEQUENCE {
 *         status            PKIStatusInfo,
 *         timeStampToken    TimeStampToken OPTIONAL ]
 *
 *     PKIStatusInfo ::= SEQUENCE {
 *         status        PKIStatus,
 *         statusString  PKIFreeText OPTIONAL,
 *         failInfo      PKIFailureInfo OPTIONAL }
 *
 *     PKIStatus ::= INTEGER {
 *         granted                (0),
 *           -- when the PKIStatus contains the value zero a TimeStampToken, as
 *           -- requested, is present.
 *         grantedWithMods        (1),
 *           -- when the PKIStatus contains the value one a TimeStampToken,
 *           -- with modifications, is present.
 *         rejection              (2),
 *         waiting                (3),
 *         revocationWarning      (4),
 *           -- this message contains a warning that a revocation is
 *           -- imminent
 *         revocationNotification (5)
 *           -- notification that a revocation has occurred }
 *
 *     PKIFreeText ::= SEQUENCE SIZE (1..MAX) OF UTF8String
 *           -- text encoded as UTF-8 String (note:  each UTF8String SHOULD
 *           -- include an RFC 1766 language tag to indicate the language
 *           -- of the contained text)
 *
 *     PKIFailureInfo ::= BIT STRING {
 *         badAlg              (0),
 *           -- unrecognized or unsupported Algorithm Identifier
 *         badRequest          (2),
 *           -- transaction not permitted or supported
 *         badDataFormat       (5),
 *           -- the data submitted has the wrong format
 *         timeNotAvailable    (14),
 *           -- the TSA's time source is not available
 *         unacceptedPolicy    (15),
 *           -- the requested TSA policy is not supported by the TSA
 *         unacceptedExtension (16),
 *           -- the requested extension is not supported by the TSA
 *         addInfoNotAvailable (17)
 *           -- the additional information requested could not be understood
 *           -- or is not available
 *         systemFailure       (25)
 *           -- the request cannot be handled due to system failure }
 *
 *     TimeStampToken ::= ContentInfo
 *         -- contentType is id-signedData
 *         -- content is SignedData
 *         -- eContentType within SignedData is id-ct-TSTInfo
 *         -- eContent within SignedData is TSTInfo
 *
 * &lt;/pre&gt;
 *
 * @since 1.5
 * @author Vincent Ryan
 * @see Timestamper
 */

public class TSResponse {

    // Status codes (from RFC 3161)

    /**
     * The requested timestamp was granted.
     */
    public static final int GRANTED = 0;

    /**
     * The requested timestamp was granted with some modifications.
     */
    public static final int GRANTED_WITH_MODS = 1;

    /**
     * The requested timestamp was not granted.
     */
    public static final int REJECTION = 2;

    /**
     * The requested timestamp has not yet been processed.
     */
    public static final int WAITING = 3;

    /**
     * A warning that a certificate revocation is imminent.
     */
    public static final int REVOCATION_WARNING = 4;

    /**
     * Notification that a certificate revocation has occurred.
     */
    public static final int REVOCATION_NOTIFICATION = 5;

    // Failure codes (from RFC 3161)

    /**
     * Unrecognized or unsupported algorithm identifier.
     */
    public static final int BAD_ALG = 0;

    /**
     * The requested transaction is not permitted or supported.
     */
    public static final int BAD_REQUEST = 2;

    /**
     * The data submitted has the wrong format.
     */
    public static final int BAD_DATA_FORMAT = 5;

    /**
     * The TSA's time source is not available.
     */
    public static final int TIME_NOT_AVAILABLE = 14;

    /**
     * The requested TSA policy is not supported by the TSA.
     */
    public static final int UNACCEPTED_POLICY = 15;

    /**
     * The requested extension is not supported by the TSA.
     */
    public static final int UNACCEPTED_EXTENSION = 16;

    /**
     * The additional information requested could not be understood or is not
     * available.
     */
    public static final int ADD_INFO_NOT_AVAILABLE = 17;

    /**
     * The request cannot be handled due to system failure.
     */
    public static final int SYSTEM_FAILURE = 25;

<span class="nc" id="L179">    private static final Debug debug = Debug.getInstance(&quot;ts&quot;);</span>

    private int status;

<span class="nc" id="L183">    private String[] statusString = null;</span>

<span class="nc" id="L185">    private boolean[] failureInfo = null;</span>

<span class="nc" id="L187">    private byte[] encodedTsToken = null;</span>

<span class="nc" id="L189">    private PKCS7 tsToken = null;</span>

    private TimestampToken tstInfo;

    /**
     * Constructs an object to store the response to a timestamp request.
     *
     * @param status A buffer containing the ASN.1 BER encoded response.
     * @throws IOException The exception is thrown if a problem is encountered
     *         parsing the timestamp response.
     */
<span class="nc" id="L200">    TSResponse(byte[] tsReply) throws IOException {</span>
<span class="nc" id="L201">        parse(tsReply);</span>
<span class="nc" id="L202">    }</span>

    /**
     * Retrieve the status code returned by the TSA.
     */
    public int getStatusCode() {
<span class="nc" id="L208">        return status;</span>
    }

    /**
     * Retrieve the status messages returned by the TSA.
     *
     * @return If null then no status messages were received.
     */
    public String[] getStatusMessages() {
<span class="nc" id="L217">        return statusString;</span>
    }

    /**
     * Retrieve the failure info returned by the TSA.
     *
     * @return the failure info, or null if no failure code was received.
     */
    public boolean[] getFailureInfo() {
<span class="nc" id="L226">        return failureInfo;</span>
    }

    public String getStatusCodeAsText() {

<span class="nc bnc" id="L231" title="All 7 branches missed.">        switch (status)  {</span>
        case GRANTED:
<span class="nc" id="L233">            return &quot;the timestamp request was granted.&quot;;</span>

        case GRANTED_WITH_MODS:
<span class="nc" id="L236">            return</span>
                &quot;the timestamp request was granted with some modifications.&quot;;

        case REJECTION:
<span class="nc" id="L240">            return &quot;the timestamp request was rejected.&quot;;</span>

        case WAITING:
<span class="nc" id="L243">            return &quot;the timestamp request has not yet been processed.&quot;;</span>

        case REVOCATION_WARNING:
<span class="nc" id="L246">            return &quot;warning: a certificate revocation is imminent.&quot;;</span>

        case REVOCATION_NOTIFICATION:
<span class="nc" id="L249">            return &quot;notification: a certificate revocation has occurred.&quot;;</span>

        default:
<span class="nc" id="L252">            return (&quot;unknown status code &quot; + status + &quot;.&quot;);</span>
        }
    }

    private boolean isSet(int position) {
<span class="nc" id="L257">        return failureInfo[position];</span>
    }

    public String getFailureCodeAsText() {

<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (failureInfo == null) {</span>
<span class="nc" id="L263">            return &quot;&quot;;</span>
        }

        try {
<span class="nc bnc" id="L267" title="All 2 branches missed.">            if (isSet(BAD_ALG))</span>
<span class="nc" id="L268">                return &quot;Unrecognized or unsupported algorithm identifier.&quot;;</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            if (isSet(BAD_REQUEST))</span>
<span class="nc" id="L270">                return &quot;The requested transaction is not permitted or &quot; +</span>
                       &quot;supported.&quot;;
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (isSet(BAD_DATA_FORMAT))</span>
<span class="nc" id="L273">                return &quot;The data submitted has the wrong format.&quot;;</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (isSet(TIME_NOT_AVAILABLE))</span>
<span class="nc" id="L275">                return &quot;The TSA's time source is not available.&quot;;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if (isSet(UNACCEPTED_POLICY))</span>
<span class="nc" id="L277">                return &quot;The requested TSA policy is not supported by the TSA.&quot;;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">            if (isSet(UNACCEPTED_EXTENSION))</span>
<span class="nc" id="L279">                return &quot;The requested extension is not supported by the TSA.&quot;;</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">            if (isSet(ADD_INFO_NOT_AVAILABLE))</span>
<span class="nc" id="L281">                return &quot;The additional information requested could not be &quot; +</span>
                       &quot;understood or is not available.&quot;;
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (isSet(SYSTEM_FAILURE))</span>
<span class="nc" id="L284">                return &quot;The request cannot be handled due to system failure.&quot;;</span>
<span class="nc" id="L285">        } catch (ArrayIndexOutOfBoundsException ex) {}</span>

<span class="nc" id="L287">        return (&quot;unknown failure code&quot;);</span>
    }

    /**
     * Retrieve the timestamp token returned by the TSA.
     *
     * @return If null then no token was received.
     */
    public PKCS7 getToken() {
<span class="nc" id="L296">        return tsToken;</span>
    }

    public TimestampToken getTimestampToken() {
<span class="nc" id="L300">        return tstInfo;</span>
    }

    /**
     * Retrieve the ASN.1 BER encoded timestamp token returned by the TSA.
     *
     * @return If null then no token was received.
     */
    public byte[] getEncodedToken() {
<span class="nc" id="L309">        return encodedTsToken;</span>
    }

    /*
     * Parses the timestamp response.
     *
     * @param status A buffer containing the ASN.1 BER encoded response.
     * @throws IOException The exception is thrown if a problem is encountered
     *         parsing the timestamp response.
     */
    private void parse(byte[] tsReply) throws IOException {
        // Decode TimeStampResp

<span class="nc" id="L322">        DerValue derValue = new DerValue(tsReply);</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (derValue.tag != DerValue.tag_Sequence) {</span>
<span class="nc" id="L324">            throw new IOException(&quot;Bad encoding for timestamp response&quot;);</span>
        }

        // Parse status

<span class="nc" id="L329">        DerValue statusInfo = derValue.data.getDerValue();</span>
<span class="nc" id="L330">        this.status = statusInfo.data.getInteger();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (debug != null) {</span>
<span class="nc" id="L332">            debug.println(&quot;timestamp response: status=&quot; + this.status);</span>
        }
        // Parse statusString, if present
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (statusInfo.data.available() &gt; 0) {</span>
<span class="nc" id="L336">            byte tag = (byte)statusInfo.data.peekByte();</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">            if (tag == DerValue.tag_SequenceOf) {</span>
<span class="nc" id="L338">                DerValue[] strings = statusInfo.data.getSequence(1);</span>
<span class="nc" id="L339">                statusString = new String[strings.length];</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                for (int i = 0; i &lt; strings.length; i++) {</span>
<span class="nc" id="L341">                    statusString[i] = strings[i].getUTF8String();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                    if (debug != null) {</span>
<span class="nc" id="L343">                        debug.println(&quot;timestamp response: statusString=&quot; +</span>
                                      statusString[i]);
                    }
                }
            }
        }
        // Parse failInfo, if present
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (statusInfo.data.available() &gt; 0) {</span>
<span class="nc" id="L351">            this.failureInfo</span>
<span class="nc" id="L352">                = statusInfo.data.getUnalignedBitString().toBooleanArray();</span>
        }

        // Parse timeStampToken, if present
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (derValue.data.available() &gt; 0) {</span>
<span class="nc" id="L357">            DerValue timestampToken = derValue.data.getDerValue();</span>
<span class="nc" id="L358">            encodedTsToken = timestampToken.toByteArray();</span>
<span class="nc" id="L359">            tsToken = new PKCS7(encodedTsToken);</span>
<span class="nc" id="L360">            tstInfo = new TimestampToken(tsToken.getContentInfo().getData());</span>
        }

        // Check the format of the timestamp response
<span class="nc bnc" id="L364" title="All 4 branches missed.">        if (this.status == 0 || this.status == 1) {</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (tsToken == null) {</span>
<span class="nc" id="L366">                throw new TimestampException(</span>
                    &quot;Bad encoding for timestamp response: &quot; +
                    &quot;expected a timeStampToken element to be present&quot;);
            }
<span class="nc bnc" id="L370" title="All 2 branches missed.">        } else if (tsToken != null) {</span>
<span class="nc" id="L371">            throw new TimestampException(</span>
                &quot;Bad encoding for timestamp response: &quot; +
                &quot;expected no timeStampToken element to be present&quot;);
        }
<span class="nc" id="L375">    }</span>

    final static class TimestampException extends IOException {
        private static final long serialVersionUID = -1631631794891940953L;

        TimestampException(String message) {
<span class="nc" id="L381">            super(message);</span>
<span class="nc" id="L382">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>