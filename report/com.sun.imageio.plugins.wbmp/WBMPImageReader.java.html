<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>WBMPImageReader.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.imageio.plugins.wbmp</a> &gt; <span class="el_source">WBMPImageReader.java</span></div><h1>WBMPImageReader.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.imageio.plugins.wbmp;

import java.awt.Rectangle;
import java.awt.image.BufferedImage;
import java.awt.image.DataBufferByte;
import java.awt.image.MultiPixelPackedSampleModel;
import java.awt.image.Raster;
import java.awt.image.WritableRaster;

import javax.imageio.IIOException;
import javax.imageio.ImageReader;
import javax.imageio.ImageReadParam;
import javax.imageio.ImageTypeSpecifier;
import javax.imageio.metadata.IIOMetadata;
import javax.imageio.spi.ImageReaderSpi;
import javax.imageio.stream.ImageInputStream;

import java.io.*;
import java.util.ArrayList;
import java.util.Iterator;

import com.sun.imageio.plugins.common.I18N;
import com.sun.imageio.plugins.common.ReaderUtil;

/** This class is the Java Image IO plugin reader for WBMP images.
 *  It may subsample the image, clip the image,
 *  and shift the decoded image origin if the proper decoding parameter
 *  are set in the provided &lt;code&gt;WBMPImageReadParam&lt;/code&gt;.
 */
public class WBMPImageReader extends ImageReader {
    /** The input stream where reads from */
<span class="nc" id="L57">    private ImageInputStream iis = null;</span>

    /** Indicates whether the header is read. */
<span class="nc" id="L60">    private boolean gotHeader = false;</span>

    /** The original image width. */
    private int width;

    /** The original image height. */
    private int height;

    private int wbmpType;

    private WBMPMetadata metadata;

    /** Constructs &lt;code&gt;WBMPImageReader&lt;/code&gt; from the provided
     *  &lt;code&gt;ImageReaderSpi&lt;/code&gt;.
     */
    public WBMPImageReader(ImageReaderSpi originator) {
<span class="nc" id="L76">        super(originator);</span>
<span class="nc" id="L77">    }</span>

    /** Overrides the method defined in the superclass. */
    public void setInput(Object input,
                         boolean seekForwardOnly,
                         boolean ignoreMetadata) {
<span class="nc" id="L83">        super.setInput(input, seekForwardOnly, ignoreMetadata);</span>
<span class="nc" id="L84">        iis = (ImageInputStream) input; // Always works</span>
<span class="nc" id="L85">        gotHeader = false;</span>
<span class="nc" id="L86">    }</span>

    /** Overrides the method defined in the superclass. */
    public int getNumImages(boolean allowSearch) throws IOException {
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (iis == null) {</span>
<span class="nc" id="L91">            throw new IllegalStateException(I18N.getString(&quot;GetNumImages0&quot;));</span>
        }
<span class="nc bnc" id="L93" title="All 4 branches missed.">        if (seekForwardOnly &amp;&amp; allowSearch) {</span>
<span class="nc" id="L94">            throw new IllegalStateException(I18N.getString(&quot;GetNumImages1&quot;));</span>
        }
<span class="nc" id="L96">        return 1;</span>
    }

    public int getWidth(int imageIndex) throws IOException {
<span class="nc" id="L100">        checkIndex(imageIndex);</span>
<span class="nc" id="L101">        readHeader();</span>
<span class="nc" id="L102">        return width;</span>
    }

    public int getHeight(int imageIndex) throws IOException {
<span class="nc" id="L106">        checkIndex(imageIndex);</span>
<span class="nc" id="L107">        readHeader();</span>
<span class="nc" id="L108">        return height;</span>
    }

    public boolean isRandomAccessEasy(int imageIndex) throws IOException {
<span class="nc" id="L112">        checkIndex(imageIndex);</span>
<span class="nc" id="L113">        return true;</span>
    }

    private void checkIndex(int imageIndex) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (imageIndex != 0) {</span>
<span class="nc" id="L118">            throw new IndexOutOfBoundsException(I18N.getString(&quot;WBMPImageReader0&quot;));</span>
        }
<span class="nc" id="L120">    }</span>

    public void readHeader() throws IOException {
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (gotHeader)</span>
<span class="nc" id="L124">            return;</span>

<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (iis == null) {</span>
<span class="nc" id="L127">            throw new IllegalStateException(&quot;Input source not set!&quot;);</span>
        }

<span class="nc" id="L130">        metadata = new WBMPMetadata();</span>

<span class="nc" id="L132">        wbmpType = iis.readByte();   // TypeField</span>
<span class="nc" id="L133">        byte fixHeaderField = iis.readByte();</span>

        // check for valid wbmp image
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (fixHeaderField != 0</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            || !isValidWbmpType(wbmpType))</span>
        {
<span class="nc" id="L139">            throw new IIOException(I18N.getString(&quot;WBMPImageReader2&quot;));</span>
        }

<span class="nc" id="L142">        metadata.wbmpType = wbmpType;</span>

        // Read image width
<span class="nc" id="L145">        width = ReaderUtil.readMultiByteInteger(iis);</span>
<span class="nc" id="L146">        metadata.width = width;</span>

        // Read image height
<span class="nc" id="L149">        height = ReaderUtil.readMultiByteInteger(iis);</span>
<span class="nc" id="L150">        metadata.height = height;</span>

<span class="nc" id="L152">        gotHeader = true;</span>
<span class="nc" id="L153">    }</span>

    public Iterator getImageTypes(int imageIndex)
        throws IOException {
<span class="nc" id="L157">        checkIndex(imageIndex);</span>
<span class="nc" id="L158">        readHeader();</span>

<span class="nc" id="L160">        BufferedImage bi =</span>
            new BufferedImage(1, 1, BufferedImage.TYPE_BYTE_BINARY);
<span class="nc" id="L162">        ArrayList list = new ArrayList(1);</span>
<span class="nc" id="L163">        list.add(new ImageTypeSpecifier(bi));</span>
<span class="nc" id="L164">        return list.iterator();</span>
    }

    public ImageReadParam getDefaultReadParam() {
<span class="nc" id="L168">        return new ImageReadParam();</span>
    }

    public IIOMetadata getImageMetadata(int imageIndex)
        throws IOException {
<span class="nc" id="L173">        checkIndex(imageIndex);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (metadata == null) {</span>
<span class="nc" id="L175">            readHeader();</span>
        }
<span class="nc" id="L177">        return metadata;</span>
    }

    public IIOMetadata getStreamMetadata() throws IOException {
<span class="nc" id="L181">        return null;</span>
    }

    public BufferedImage read(int imageIndex, ImageReadParam param)
        throws IOException {

<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (iis == null) {</span>
<span class="nc" id="L188">            throw new IllegalStateException(I18N.getString(&quot;WBMPImageReader1&quot;));</span>
        }

<span class="nc" id="L191">        checkIndex(imageIndex);</span>
<span class="nc" id="L192">        clearAbortRequest();</span>
<span class="nc" id="L193">        processImageStarted(imageIndex);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (param == null)</span>
<span class="nc" id="L195">            param = getDefaultReadParam();</span>

        //read header
<span class="nc" id="L198">        readHeader();</span>

<span class="nc" id="L200">        Rectangle sourceRegion = new Rectangle(0, 0, 0, 0);</span>
<span class="nc" id="L201">        Rectangle destinationRegion = new Rectangle(0, 0, 0, 0);</span>

<span class="nc" id="L203">        computeRegions(param, this.width, this.height,</span>
<span class="nc" id="L204">                       param.getDestination(),</span>
                       sourceRegion,
                       destinationRegion);

<span class="nc" id="L208">        int scaleX = param.getSourceXSubsampling();</span>
<span class="nc" id="L209">        int scaleY = param.getSourceYSubsampling();</span>
<span class="nc" id="L210">        int xOffset = param.getSubsamplingXOffset();</span>
<span class="nc" id="L211">        int yOffset = param.getSubsamplingYOffset();</span>

        // If the destination is provided, then use it.  Otherwise, create new one
<span class="nc" id="L214">        BufferedImage bi = param.getDestination();</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (bi == null)</span>
<span class="nc" id="L217">            bi = new BufferedImage(destinationRegion.x + destinationRegion.width,</span>
                              destinationRegion.y + destinationRegion.height,
                              BufferedImage.TYPE_BYTE_BINARY);

<span class="nc" id="L221">        boolean noTransform =</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            destinationRegion.equals(new Rectangle(0, 0, width, height)) &amp;&amp;</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            destinationRegion.equals(new Rectangle(0, 0, bi.getWidth(), bi.getHeight()));</span>

        // Get the image data.
<span class="nc" id="L226">        WritableRaster tile = bi.getWritableTile(0, 0);</span>

        // Get the SampleModel.
<span class="nc" id="L229">        MultiPixelPackedSampleModel sm =</span>
<span class="nc" id="L230">            (MultiPixelPackedSampleModel)bi.getSampleModel();</span>

<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (noTransform) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">            if (abortRequested()) {</span>
<span class="nc" id="L234">                processReadAborted();</span>
<span class="nc" id="L235">                return bi;</span>
            }

            // If noTransform is necessary, read the data.
<span class="nc" id="L239">            iis.read(((DataBufferByte)tile.getDataBuffer()).getData(),</span>
<span class="nc" id="L240">                     0, height*sm.getScanlineStride());</span>
<span class="nc" id="L241">            processImageUpdate(bi,</span>
                               0, 0,
                               width, height, 1, 1,
                               new int[]{0});
<span class="nc" id="L245">            processImageProgress(100.0F);</span>
        } else {
<span class="nc" id="L247">            int len = (this.width + 7) / 8;</span>
<span class="nc" id="L248">            byte[] buf = new byte[len];</span>
<span class="nc" id="L249">            byte[] data = ((DataBufferByte)tile.getDataBuffer()).getData();</span>
<span class="nc" id="L250">            int lineStride = sm.getScanlineStride();</span>
<span class="nc" id="L251">            iis.skipBytes(len * sourceRegion.y);</span>
<span class="nc" id="L252">            int skipLength = len * (scaleY - 1);</span>

            // cache the values to avoid duplicated computation
<span class="nc" id="L255">            int[] srcOff = new int[destinationRegion.width];</span>
<span class="nc" id="L256">            int[] destOff = new int[destinationRegion.width];</span>
<span class="nc" id="L257">            int[] srcPos = new int[destinationRegion.width];</span>
<span class="nc" id="L258">            int[] destPos = new int[destinationRegion.width];</span>

<span class="nc" id="L260">            for (int i = destinationRegion.x, x = sourceRegion.x, j = 0;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                i &lt; destinationRegion.x + destinationRegion.width;</span>
<span class="nc" id="L262">                    i++, j++, x += scaleX) {</span>
<span class="nc" id="L263">                srcPos[j] = x &gt;&gt; 3;</span>
<span class="nc" id="L264">                srcOff[j] = 7 - (x &amp; 7);</span>
<span class="nc" id="L265">                destPos[j] = i &gt;&gt; 3;</span>
<span class="nc" id="L266">                destOff[j] = 7 - (i &amp; 7);</span>
            }

<span class="nc" id="L269">            for (int j = 0, y = sourceRegion.y,</span>
<span class="nc" id="L270">                k = destinationRegion.y * lineStride;</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                j &lt; destinationRegion.height; j++, y+=scaleY) {</span>

<span class="nc bnc" id="L273" title="All 2 branches missed.">                if (abortRequested())</span>
<span class="nc" id="L274">                    break;</span>
<span class="nc" id="L275">                iis.read(buf, 0, len);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                for (int i = 0; i &lt; destinationRegion.width; i++) {</span>
                    //get the bit and assign to the data buffer of the raster
<span class="nc" id="L278">                    int v = (buf[srcPos[i]] &gt;&gt; srcOff[i]) &amp; 1;</span>
<span class="nc" id="L279">                    data[k + destPos[i]] |= v &lt;&lt; destOff[i];</span>
                }

<span class="nc" id="L282">                k += lineStride;</span>
<span class="nc" id="L283">                iis.skipBytes(skipLength);</span>
<span class="nc" id="L284">                        processImageUpdate(bi,</span>
                                           0, j,
                                           destinationRegion.width, 1, 1, 1,
                                           new int[]{0});
<span class="nc" id="L288">                        processImageProgress(100.0F*j/destinationRegion.height);</span>
            }
        }

<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (abortRequested())</span>
<span class="nc" id="L293">            processReadAborted();</span>
        else
<span class="nc" id="L295">            processImageComplete();</span>
<span class="nc" id="L296">        return bi;</span>
    }

    public boolean canReadRaster() {
<span class="nc" id="L300">        return true;</span>
    }

    public Raster readRaster(int imageIndex,
                             ImageReadParam param) throws IOException {
<span class="nc" id="L305">        BufferedImage bi = read(imageIndex, param);</span>
<span class="nc" id="L306">        return bi.getData();</span>
    }

    public void reset() {
<span class="nc" id="L310">        super.reset();</span>
<span class="nc" id="L311">        iis = null;</span>
<span class="nc" id="L312">        gotHeader = false;</span>
<span class="nc" id="L313">    }</span>

    /*
     * This method verifies that given byte is valid wbmp type marker.
     * At the moment only 0x0 marker is described by wbmp spec.
     */
    boolean isValidWbmpType(int type) {
<span class="nc bnc" id="L320" title="All 2 branches missed.">        return type == 0;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>