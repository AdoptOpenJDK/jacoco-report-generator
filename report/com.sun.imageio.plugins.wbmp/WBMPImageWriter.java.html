<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WBMPImageWriter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.imageio.plugins.wbmp</a> &gt; <span class="el_source">WBMPImageWriter.java</span></div><h1>WBMPImageWriter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.imageio.plugins.wbmp;

import java.awt.Point;
import java.awt.Rectangle;
import java.awt.image.ColorModel;
import java.awt.image.DataBuffer;
import java.awt.image.DataBufferByte;
import java.awt.image.IndexColorModel;
import java.awt.image.MultiPixelPackedSampleModel;
import java.awt.image.Raster;
import java.awt.image.RenderedImage;
import java.awt.image.SampleModel;
import java.awt.image.WritableRaster;

import java.io.IOException;

import javax.imageio.IIOImage;
import javax.imageio.IIOException;
import javax.imageio.ImageTypeSpecifier;
import javax.imageio.ImageWriteParam;
import javax.imageio.ImageWriter;
import javax.imageio.metadata.IIOMetadata;
import javax.imageio.metadata.IIOMetadataFormatImpl;
import javax.imageio.metadata.IIOInvalidTreeException;
import javax.imageio.spi.ImageWriterSpi;
import javax.imageio.stream.ImageOutputStream;

import com.sun.imageio.plugins.common.I18N;

/**
 * The Java Image IO plugin writer for encoding a binary RenderedImage into
 * a WBMP format.
 *
 * The encoding process may clip, subsample using the parameters
 * specified in the &lt;code&gt;ImageWriteParam&lt;/code&gt;.
 *
 * @see com.sun.media.imageio.plugins.WBMPImageWriteParam
 */
public class WBMPImageWriter extends ImageWriter {
    /** The output stream to write into */
<span class="nc" id="L66">    private ImageOutputStream stream = null;</span>

    // Get the number of bits required to represent an int.
    private static int getNumBits(int intValue) {
<span class="nc" id="L70">        int numBits = 32;</span>
<span class="nc" id="L71">        int mask = 0x80000000;</span>
<span class="nc bnc" id="L72" title="All 4 branches missed.">        while(mask != 0 &amp;&amp; (intValue &amp; mask) == 0) {</span>
<span class="nc" id="L73">            numBits--;</span>
<span class="nc" id="L74">            mask &gt;&gt;&gt;= 1;</span>
        }
<span class="nc" id="L76">        return numBits;</span>
    }

    // Convert an int value to WBMP multi-byte format.
    private static byte[] intToMultiByte(int intValue) {
<span class="nc" id="L81">        int numBitsLeft = getNumBits(intValue);</span>
<span class="nc" id="L82">        byte[] multiBytes = new byte[(numBitsLeft + 6)/7];</span>

<span class="nc" id="L84">        int maxIndex = multiBytes.length - 1;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        for(int b = 0; b &lt;= maxIndex; b++) {</span>
<span class="nc" id="L86">            multiBytes[b] = (byte)((intValue &gt;&gt;&gt; ((maxIndex - b)*7))&amp;0x7f);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if(b != maxIndex) {</span>
<span class="nc" id="L88">                multiBytes[b] |= (byte)0x80;</span>
            }
        }

<span class="nc" id="L92">        return multiBytes;</span>
    }

    /** Constructs &lt;code&gt;WBMPImageWriter&lt;/code&gt; based on the provided
     *  &lt;code&gt;ImageWriterSpi&lt;/code&gt;.
     */
    public WBMPImageWriter(ImageWriterSpi originator) {
<span class="nc" id="L99">        super(originator);</span>
<span class="nc" id="L100">    }</span>

    public void setOutput(Object output) {
<span class="nc" id="L103">        super.setOutput(output); // validates output</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (output != null) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (!(output instanceof ImageOutputStream))</span>
<span class="nc" id="L106">                throw new IllegalArgumentException(I18N.getString(&quot;WBMPImageWriter&quot;));</span>
<span class="nc" id="L107">            this.stream = (ImageOutputStream)output;</span>
        } else
<span class="nc" id="L109">            this.stream = null;</span>
<span class="nc" id="L110">    }</span>

    public IIOMetadata getDefaultStreamMetadata(ImageWriteParam param) {
<span class="nc" id="L113">        return null;</span>
    }

    public IIOMetadata getDefaultImageMetadata(ImageTypeSpecifier imageType,
                                               ImageWriteParam param) {
<span class="nc" id="L118">        WBMPMetadata meta = new WBMPMetadata();</span>
<span class="nc" id="L119">        meta.wbmpType = 0; // default wbmp level</span>
<span class="nc" id="L120">        return meta;</span>
    }

    public IIOMetadata convertStreamMetadata(IIOMetadata inData,
                                             ImageWriteParam param) {
<span class="nc" id="L125">        return null;</span>
    }

    public IIOMetadata convertImageMetadata(IIOMetadata metadata,
                                            ImageTypeSpecifier type,
                                            ImageWriteParam param) {
<span class="nc" id="L131">        return null;</span>
    }

    public boolean canWriteRasters() {
<span class="nc" id="L135">        return true;</span>
    }

    public void write(IIOMetadata streamMetadata,
                      IIOImage image,
                      ImageWriteParam param) throws IOException {

<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (stream == null) {</span>
<span class="nc" id="L143">            throw new IllegalStateException(I18N.getString(&quot;WBMPImageWriter3&quot;));</span>
        }

<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (image == null) {</span>
<span class="nc" id="L147">            throw new IllegalArgumentException(I18N.getString(&quot;WBMPImageWriter4&quot;));</span>
        }

<span class="nc" id="L150">        clearAbortRequest();</span>
<span class="nc" id="L151">        processImageStarted(0);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (param == null)</span>
<span class="nc" id="L153">            param = getDefaultWriteParam();</span>

<span class="nc" id="L155">        RenderedImage input = null;</span>
<span class="nc" id="L156">        Raster inputRaster = null;</span>
<span class="nc" id="L157">        boolean writeRaster = image.hasRaster();</span>
<span class="nc" id="L158">        Rectangle sourceRegion = param.getSourceRegion();</span>
<span class="nc" id="L159">        SampleModel sampleModel = null;</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (writeRaster) {</span>
<span class="nc" id="L162">            inputRaster = image.getRaster();</span>
<span class="nc" id="L163">            sampleModel = inputRaster.getSampleModel();</span>
        } else {
<span class="nc" id="L165">            input = image.getRenderedImage();</span>
<span class="nc" id="L166">            sampleModel = input.getSampleModel();</span>

<span class="nc" id="L168">            inputRaster = input.getData();</span>
        }

<span class="nc" id="L171">        checkSampleModel(sampleModel);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (sourceRegion == null)</span>
<span class="nc" id="L173">            sourceRegion = inputRaster.getBounds();</span>
        else
<span class="nc" id="L175">            sourceRegion = sourceRegion.intersection(inputRaster.getBounds());</span>

<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (sourceRegion.isEmpty())</span>
<span class="nc" id="L178">            throw new RuntimeException(I18N.getString(&quot;WBMPImageWriter1&quot;));</span>

<span class="nc" id="L180">        int scaleX = param.getSourceXSubsampling();</span>
<span class="nc" id="L181">        int scaleY = param.getSourceYSubsampling();</span>
<span class="nc" id="L182">        int xOffset = param.getSubsamplingXOffset();</span>
<span class="nc" id="L183">        int yOffset = param.getSubsamplingYOffset();</span>

<span class="nc" id="L185">        sourceRegion.translate(xOffset, yOffset);</span>
<span class="nc" id="L186">        sourceRegion.width -= xOffset;</span>
<span class="nc" id="L187">        sourceRegion.height -= yOffset;</span>

<span class="nc" id="L189">        int minX = sourceRegion.x / scaleX;</span>
<span class="nc" id="L190">        int minY = sourceRegion.y / scaleY;</span>
<span class="nc" id="L191">        int w = (sourceRegion.width + scaleX - 1) / scaleX;</span>
<span class="nc" id="L192">        int h = (sourceRegion.height + scaleY - 1) / scaleY;</span>

<span class="nc" id="L194">        Rectangle destinationRegion = new Rectangle(minX, minY, w, h);</span>
<span class="nc" id="L195">        sampleModel = sampleModel.createCompatibleSampleModel(w, h);</span>

<span class="nc" id="L197">        SampleModel destSM= sampleModel;</span>

        // If the data are not formatted nominally then reformat.
<span class="nc bnc" id="L200" title="All 4 branches missed.">        if(sampleModel.getDataType() != DataBuffer.TYPE_BYTE ||</span>
           !(sampleModel instanceof MultiPixelPackedSampleModel) ||
<span class="nc bnc" id="L202" title="All 2 branches missed.">           ((MultiPixelPackedSampleModel)sampleModel).getDataBitOffset() != 0) {</span>
<span class="nc" id="L203">           destSM =</span>
                new MultiPixelPackedSampleModel(DataBuffer.TYPE_BYTE,
                                                w, h, 1,
                                                w + 7 &gt;&gt; 3, 0);
        }

<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!destinationRegion.equals(sourceRegion)) {</span>
<span class="nc bnc" id="L210" title="All 4 branches missed.">            if (scaleX == 1 &amp;&amp; scaleY == 1)</span>
<span class="nc" id="L211">                inputRaster = inputRaster.createChild(inputRaster.getMinX(),</span>
<span class="nc" id="L212">                                                      inputRaster.getMinY(),</span>
                                                      w, h, minX, minY, null);
            else {
<span class="nc" id="L215">                WritableRaster ras = Raster.createWritableRaster(destSM,</span>
                                                                 new Point(minX, minY));

<span class="nc" id="L218">                byte[] data = ((DataBufferByte)ras.getDataBuffer()).getData();</span>

<span class="nc" id="L220">                for(int j = minY, y = sourceRegion.y, k = 0;</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                    j &lt; minY + h; j++, y += scaleY) {</span>

<span class="nc" id="L223">                    for (int i = 0, x = sourceRegion.x;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                        i &lt;w; i++, x +=scaleX) {</span>
<span class="nc" id="L225">                        int v = inputRaster.getSample(x, y, 0);</span>
<span class="nc" id="L226">                        data[k + (i &gt;&gt; 3)] |= v &lt;&lt; (7 - (i &amp; 7));</span>
                    }
<span class="nc" id="L228">                    k += w + 7 &gt;&gt; 3;</span>
                }
<span class="nc" id="L230">                inputRaster = ras;</span>
            }
        }

        // If the data are not formatted nominally then reformat.
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if(!destSM.equals(inputRaster.getSampleModel())) {</span>
<span class="nc" id="L236">            WritableRaster raster =</span>
<span class="nc" id="L237">                Raster.createWritableRaster(destSM,</span>
<span class="nc" id="L238">                                            new Point(inputRaster.getMinX(),</span>
<span class="nc" id="L239">                                                      inputRaster.getMinY()));</span>
<span class="nc" id="L240">            raster.setRect(inputRaster);</span>
<span class="nc" id="L241">            inputRaster = raster;</span>
        }

        // Check whether the image is white-is-zero.
<span class="nc" id="L245">        boolean isWhiteZero = false;</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">        if(!writeRaster &amp;&amp; input.getColorModel() instanceof IndexColorModel) {</span>
<span class="nc" id="L247">            IndexColorModel icm = (IndexColorModel)input.getColorModel();</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            isWhiteZero = icm.getRed(0) &gt; icm.getRed(1);</span>
        }

        // Get the line stride, bytes per row, and data array.
<span class="nc" id="L252">        int lineStride =</span>
<span class="nc" id="L253">            ((MultiPixelPackedSampleModel)destSM).getScanlineStride();</span>
<span class="nc" id="L254">        int bytesPerRow = (w + 7)/8;</span>
<span class="nc" id="L255">        byte[] bdata = ((DataBufferByte)inputRaster.getDataBuffer()).getData();</span>

        // Write WBMP header.
<span class="nc" id="L258">        stream.write(0); // TypeField</span>
<span class="nc" id="L259">        stream.write(0); // FixHeaderField</span>
<span class="nc" id="L260">        stream.write(intToMultiByte(w)); // width</span>
<span class="nc" id="L261">        stream.write(intToMultiByte(h)); // height</span>

        // Write the data.
<span class="nc bnc" id="L264" title="All 4 branches missed.">        if(!isWhiteZero &amp;&amp; lineStride == bytesPerRow) {</span>
            // Write the entire image.
<span class="nc" id="L266">            stream.write(bdata, 0, h * bytesPerRow);</span>
<span class="nc" id="L267">            processImageProgress(100.0F);</span>
        } else {
            // Write the image row-by-row.
<span class="nc" id="L270">            int offset = 0;</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">            if(!isWhiteZero) {</span>
                // Black-is-zero
<span class="nc bnc" id="L273" title="All 2 branches missed.">                for(int row = 0; row &lt; h; row++) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                    if (abortRequested())</span>
<span class="nc" id="L275">                        break;</span>
<span class="nc" id="L276">                    stream.write(bdata, offset, bytesPerRow);</span>
<span class="nc" id="L277">                    offset += lineStride;</span>
<span class="nc" id="L278">                    processImageProgress(100.0F * row / h);</span>
                }
            } else {
                // White-is-zero: need to invert data.
<span class="nc" id="L282">                byte[] inverted = new byte[bytesPerRow];</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                for(int row = 0; row &lt; h; row++) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                    if (abortRequested())</span>
<span class="nc" id="L285">                        break;</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">                    for(int col = 0; col &lt; bytesPerRow; col++) {</span>
<span class="nc" id="L287">                        inverted[col] = (byte)(~(bdata[col+offset]));</span>
                    }
<span class="nc" id="L289">                    stream.write(inverted, 0, bytesPerRow);</span>
<span class="nc" id="L290">                    offset += lineStride;</span>
<span class="nc" id="L291">                    processImageProgress(100.0F * row / h);</span>
                }
            }
        }

<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (abortRequested())</span>
<span class="nc" id="L297">            processWriteAborted();</span>
        else {
<span class="nc" id="L299">            processImageComplete();</span>
<span class="nc" id="L300">            stream.flushBefore(stream.getStreamPosition());</span>
        }
<span class="nc" id="L302">    }</span>

    public void reset() {
<span class="nc" id="L305">        super.reset();</span>
<span class="nc" id="L306">        stream = null;</span>
<span class="nc" id="L307">    }</span>

    private void checkSampleModel(SampleModel sm) {
<span class="nc" id="L310">        int type = sm.getDataType();</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">        if (type &lt; DataBuffer.TYPE_BYTE || type &gt; DataBuffer.TYPE_INT</span>
<span class="nc bnc" id="L312" title="All 4 branches missed.">            || sm.getNumBands() != 1 || sm.getSampleSize(0) != 1)</span>
<span class="nc" id="L313">            throw new IllegalArgumentException(I18N.getString(&quot;WBMPImageWriter2&quot;));</span>
<span class="nc" id="L314">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>