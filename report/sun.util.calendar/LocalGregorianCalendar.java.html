<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>LocalGregorianCalendar.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.util.calendar</a> &gt; <span class="el_source">LocalGregorianCalendar.java</span></div><h1>LocalGregorianCalendar.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.util.calendar;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import java.util.StringTokenizer;
import java.util.TimeZone;

/**
 *
 * @author Masayoshi Okutsu
 * @since 1.6
 */

public class LocalGregorianCalendar extends BaseCalendar {
    private String name;
    private Era[] eras;

    public static class Date extends BaseCalendar.Date {

        protected Date() {
<span class="nc" id="L48">            super();</span>
<span class="nc" id="L49">        }</span>

        protected Date(TimeZone zone) {
<span class="fc" id="L52">            super(zone);</span>
<span class="fc" id="L53">        }</span>

<span class="pc" id="L55">        private int gregorianYear = FIELD_UNDEFINED;</span>

        @Override
        public Date setEra(Era era) {
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">            if (getEra() != era) {</span>
<span class="fc" id="L60">                super.setEra(era);</span>
<span class="fc" id="L61">                gregorianYear = FIELD_UNDEFINED;</span>
            }
<span class="fc" id="L63">            return this;</span>
        }

        @Override
        public Date addYear(int localYear) {
<span class="fc" id="L68">            super.addYear(localYear);</span>
<span class="fc" id="L69">            gregorianYear += localYear;</span>
<span class="fc" id="L70">            return this;</span>
        }

        @Override
        public Date setYear(int localYear) {
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">            if (getYear() != localYear) {</span>
<span class="fc" id="L76">                super.setYear(localYear);</span>
<span class="fc" id="L77">                gregorianYear = FIELD_UNDEFINED;</span>
            }
<span class="fc" id="L79">            return this;</span>
        }

        @Override
        public int getNormalizedYear() {
<span class="fc" id="L84">            return gregorianYear;</span>
        }

        @Override
        public void setNormalizedYear(int normalizedYear) {
<span class="fc" id="L89">            this.gregorianYear = normalizedYear;</span>
<span class="fc" id="L90">        }</span>

        void setLocalEra(Era era) {
<span class="fc" id="L93">            super.setEra(era);</span>
<span class="fc" id="L94">        }</span>

        void setLocalYear(int year) {
<span class="fc" id="L97">            super.setYear(year);</span>
<span class="fc" id="L98">        }</span>

        @Override
        public String toString() {
<span class="nc" id="L102">            String time = super.toString();</span>
<span class="nc" id="L103">            time = time.substring(time.indexOf('T'));</span>
<span class="nc" id="L104">            StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L105">            Era era = getEra();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (era != null) {</span>
<span class="nc" id="L107">                String abbr = era.getAbbreviation();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (abbr != null) {</span>
<span class="nc" id="L109">                    sb.append(abbr);</span>
                }
            }
<span class="nc" id="L112">            sb.append(getYear()).append('.');</span>
<span class="nc" id="L113">            CalendarUtils.sprintf0d(sb, getMonth(), 2).append('.');</span>
<span class="nc" id="L114">            CalendarUtils.sprintf0d(sb, getDayOfMonth(), 2);</span>
<span class="nc" id="L115">            sb.append(time);</span>
<span class="nc" id="L116">            return sb.toString();</span>
        }
    }

    static LocalGregorianCalendar getLocalGregorianCalendar(String name) {
        Properties calendarProps;
        try {
<span class="fc" id="L123">            calendarProps = CalendarSystem.getCalendarProperties();</span>
<span class="nc" id="L124">        } catch (IOException | IllegalArgumentException e) {</span>
<span class="nc" id="L125">            throw new InternalError(e);</span>
<span class="fc" id="L126">        }</span>
        // Parse calendar.*.eras
<span class="fc" id="L128">        String props = calendarProps.getProperty(&quot;calendar.&quot; + name + &quot;.eras&quot;);</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        if (props == null) {</span>
<span class="nc" id="L130">            return null;</span>
        }
<span class="fc" id="L132">        List&lt;Era&gt; eras = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L133">        StringTokenizer eraTokens = new StringTokenizer(props, &quot;;&quot;);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        while (eraTokens.hasMoreTokens()) {</span>
<span class="fc" id="L135">            String items = eraTokens.nextToken().trim();</span>
<span class="fc" id="L136">            StringTokenizer itemTokens = new StringTokenizer(items, &quot;,&quot;);</span>
<span class="fc" id="L137">            String eraName = null;</span>
<span class="fc" id="L138">            boolean localTime = true;</span>
<span class="fc" id="L139">            long since = 0;</span>
<span class="fc" id="L140">            String abbr = null;</span>

<span class="fc bfc" id="L142" title="All 2 branches covered.">            while (itemTokens.hasMoreTokens()) {</span>
<span class="fc" id="L143">                String item = itemTokens.nextToken();</span>
<span class="fc" id="L144">                int index = item.indexOf('=');</span>
                // it must be in the key=value form.
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">                if (index == -1) {</span>
<span class="nc" id="L147">                    return null;</span>
                }
<span class="fc" id="L149">                String key = item.substring(0, index);</span>
<span class="fc" id="L150">                String value = item.substring(index + 1);</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">                if (&quot;name&quot;.equals(key)) {</span>
<span class="fc" id="L152">                    eraName = value;</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">                } else if (&quot;since&quot;.equals(key)) {</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">                    if (value.endsWith(&quot;u&quot;)) {</span>
<span class="nc" id="L155">                        localTime = false;</span>
<span class="nc" id="L156">                        since = Long.parseLong(value.substring(0, value.length() - 1));</span>
                    } else {
<span class="fc" id="L158">                        since = Long.parseLong(value);</span>
                    }
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">                } else if (&quot;abbr&quot;.equals(key)) {</span>
<span class="fc" id="L161">                    abbr = value;</span>
                } else {
<span class="nc" id="L163">                    throw new RuntimeException(&quot;Unknown key word: &quot; + key);</span>
                }
<span class="fc" id="L165">            }</span>
<span class="fc" id="L166">            Era era = new Era(eraName, abbr, since, localTime);</span>
<span class="fc" id="L167">            eras.add(era);</span>
<span class="fc" id="L168">        }</span>
<span class="fc" id="L169">        Era[] eraArray = new Era[eras.size()];</span>
<span class="fc" id="L170">        eras.toArray(eraArray);</span>

<span class="fc" id="L172">        return new LocalGregorianCalendar(name, eraArray);</span>
    }

<span class="fc" id="L175">    private LocalGregorianCalendar(String name, Era[] eras) {</span>
<span class="fc" id="L176">        this.name = name;</span>
<span class="fc" id="L177">        this.eras = eras;</span>
<span class="fc" id="L178">        setEras(eras);</span>
<span class="fc" id="L179">    }</span>

    @Override
    public String getName() {
<span class="nc" id="L183">        return name;</span>
    }

    @Override
    public Date getCalendarDate() {
<span class="nc" id="L188">        return getCalendarDate(System.currentTimeMillis(), newCalendarDate());</span>
    }

    @Override
    public Date getCalendarDate(long millis) {
<span class="nc" id="L193">        return getCalendarDate(millis, newCalendarDate());</span>
    }

    @Override
    public Date getCalendarDate(long millis, TimeZone zone) {
<span class="nc" id="L198">        return getCalendarDate(millis, newCalendarDate(zone));</span>
    }

    @Override
    public Date getCalendarDate(long millis, CalendarDate date) {
<span class="fc" id="L203">        Date ldate = (Date) super.getCalendarDate(millis, date);</span>
<span class="fc" id="L204">        return adjustYear(ldate, millis, ldate.getZoneOffset());</span>
    }

    private Date adjustYear(Date ldate, long millis, int zoneOffset) {
        int i;
<span class="fc bfc" id="L209" title="All 2 branches covered.">        for (i = eras.length - 1; i &gt;= 0; --i) {</span>
<span class="fc" id="L210">            Era era = eras[i];</span>
<span class="fc" id="L211">            long since = era.getSince(null);</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">            if (era.isLocalTime()) {</span>
<span class="fc" id="L213">                since -= zoneOffset;</span>
            }
<span class="fc bfc" id="L215" title="All 2 branches covered.">            if (millis &gt;= since) {</span>
<span class="fc" id="L216">                ldate.setLocalEra(era);</span>
<span class="fc" id="L217">                int y = ldate.getNormalizedYear() - era.getSinceDate().getYear() + 1;</span>
<span class="fc" id="L218">                ldate.setLocalYear(y);</span>
<span class="fc" id="L219">                break;</span>
            }
        }
<span class="fc bfc" id="L222" title="All 2 branches covered.">        if (i &lt; 0) {</span>
<span class="fc" id="L223">            ldate.setLocalEra(null);</span>
<span class="fc" id="L224">            ldate.setLocalYear(ldate.getNormalizedYear());</span>
        }
<span class="fc" id="L226">        ldate.setNormalized(true);</span>
<span class="fc" id="L227">        return ldate;</span>
    }

    @Override
    public Date newCalendarDate() {
<span class="nc" id="L232">        return new Date();</span>
    }

    @Override
    public Date newCalendarDate(TimeZone zone) {
<span class="fc" id="L237">        return new Date(zone);</span>
    }

    @Override
    public boolean validate(CalendarDate date) {
<span class="nc" id="L242">        Date ldate = (Date) date;</span>
<span class="nc" id="L243">        Era era = ldate.getEra();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (era != null) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (!validateEra(era)) {</span>
<span class="nc" id="L246">                return false;</span>
            }
<span class="nc" id="L248">            ldate.setNormalizedYear(era.getSinceDate().getYear() + ldate.getYear() - 1);</span>
<span class="nc" id="L249">            Date tmp = newCalendarDate(date.getZone());</span>
<span class="nc" id="L250">            tmp.setEra(era).setDate(date.getYear(), date.getMonth(), date.getDayOfMonth());</span>
<span class="nc" id="L251">            normalize(tmp);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (tmp.getEra() != era) {</span>
<span class="nc" id="L253">                return false;</span>
            }
<span class="nc" id="L255">        } else {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (date.getYear() &gt;= eras[0].getSinceDate().getYear()) {</span>
<span class="nc" id="L257">                return false;</span>
            }
<span class="nc" id="L259">            ldate.setNormalizedYear(ldate.getYear());</span>
        }
<span class="nc" id="L261">        return super.validate(ldate);</span>
    }

    private boolean validateEra(Era era) {
        // Validate the era
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">        for (int i = 0; i &lt; eras.length; i++) {</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">            if (era == eras[i]) {</span>
<span class="fc" id="L268">                return true;</span>
            }
        }
<span class="nc" id="L271">        return false;</span>
    }

    @Override
    public boolean normalize(CalendarDate date) {
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">        if (date.isNormalized()) {</span>
<span class="nc" id="L277">            return true;</span>
        }

<span class="fc" id="L280">        normalizeYear(date);</span>
<span class="fc" id="L281">        Date ldate = (Date) date;</span>

        // Normalize it as a Gregorian date and get its millisecond value
<span class="fc" id="L284">        super.normalize(ldate);</span>

<span class="fc" id="L286">        boolean hasMillis = false;</span>
<span class="fc" id="L287">        long millis = 0;</span>
<span class="fc" id="L288">        int year = ldate.getNormalizedYear();</span>
        int i;
<span class="fc" id="L290">        Era era = null;</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">        for (i = eras.length - 1; i &gt;= 0; --i) {</span>
<span class="fc" id="L292">            era = eras[i];</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">            if (era.isLocalTime()) {</span>
<span class="fc" id="L294">                CalendarDate sinceDate = era.getSinceDate();</span>
<span class="fc" id="L295">                int sinceYear = sinceDate.getYear();</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">                if (year &gt; sinceYear) {</span>
<span class="fc" id="L297">                    break;</span>
                }
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">                if (year == sinceYear) {</span>
<span class="nc" id="L300">                    int month = ldate.getMonth();</span>
<span class="nc" id="L301">                    int sinceMonth = sinceDate.getMonth();</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                    if (month &gt; sinceMonth) {</span>
<span class="nc" id="L303">                        break;</span>
                    }
<span class="nc bnc" id="L305" title="All 2 branches missed.">                    if (month == sinceMonth) {</span>
<span class="nc" id="L306">                        int day = ldate.getDayOfMonth();</span>
<span class="nc" id="L307">                        int sinceDay = sinceDate.getDayOfMonth();</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                        if (day &gt; sinceDay) {</span>
<span class="nc" id="L309">                            break;</span>
                        }
<span class="nc bnc" id="L311" title="All 2 branches missed.">                        if (day == sinceDay) {</span>
<span class="nc" id="L312">                            long timeOfDay = ldate.getTimeOfDay();</span>
<span class="nc" id="L313">                            long sinceTimeOfDay = sinceDate.getTimeOfDay();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                            if (timeOfDay &gt;= sinceTimeOfDay) {</span>
<span class="nc" id="L315">                                break;</span>
                            }
<span class="nc" id="L317">                            --i;</span>
<span class="nc" id="L318">                            break;</span>
                        }
                    }
                }
<span class="fc" id="L322">            } else {</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                if (!hasMillis) {</span>
<span class="nc" id="L324">                    millis  = super.getTime(date);</span>
<span class="nc" id="L325">                    hasMillis = true;</span>
                }

<span class="nc" id="L328">                long since = era.getSince(date.getZone());</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                if (millis &gt;= since) {</span>
<span class="nc" id="L330">                    break;</span>
                }
            }
        }
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">        if (i &gt;= 0) {</span>
<span class="fc" id="L335">            ldate.setLocalEra(era);</span>
<span class="fc" id="L336">            int y = ldate.getNormalizedYear() - era.getSinceDate().getYear() + 1;</span>
<span class="fc" id="L337">            ldate.setLocalYear(y);</span>
<span class="fc" id="L338">        } else {</span>
            // Set Gregorian year with no era
<span class="nc" id="L340">            ldate.setEra(null);</span>
<span class="nc" id="L341">            ldate.setLocalYear(year);</span>
<span class="nc" id="L342">            ldate.setNormalizedYear(year);</span>
        }
<span class="fc" id="L344">        ldate.setNormalized(true);</span>
<span class="fc" id="L345">        return true;</span>
    }

    @Override
    void normalizeMonth(CalendarDate date) {
<span class="fc" id="L350">        normalizeYear(date);</span>
<span class="fc" id="L351">        super.normalizeMonth(date);</span>
<span class="fc" id="L352">    }</span>

    void normalizeYear(CalendarDate date) {
<span class="fc" id="L355">        Date ldate = (Date) date;</span>
        // Set the supposed-to-be-correct Gregorian year first
        // e.g., Showa 90 becomes 2015 (1926 + 90 - 1).
<span class="fc" id="L358">        Era era = ldate.getEra();</span>
<span class="pc bpc" id="L359" title="2 of 4 branches missed.">        if (era == null || !validateEra(era)) {</span>
<span class="nc" id="L360">            ldate.setNormalizedYear(ldate.getYear());</span>
        } else {
<span class="fc" id="L362">            ldate.setNormalizedYear(era.getSinceDate().getYear() + ldate.getYear() - 1);</span>
        }
<span class="fc" id="L364">    }</span>

    /**
     * Returns whether the specified Gregorian year is a leap year.
     * @see #isLeapYear(Era, int)
     */
    @Override
    public boolean isLeapYear(int gregorianYear) {
<span class="fc" id="L372">        return CalendarUtils.isGregorianLeapYear(gregorianYear);</span>
    }

    public boolean isLeapYear(Era era, int year) {
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (era == null) {</span>
<span class="nc" id="L377">            return isLeapYear(year);</span>
        }
<span class="nc" id="L379">        int gyear = era.getSinceDate().getYear() + year - 1;</span>
<span class="nc" id="L380">        return isLeapYear(gyear);</span>
    }

    @Override
    public void getCalendarDateFromFixedDate(CalendarDate date, long fixedDate) {
<span class="fc" id="L385">        Date ldate = (Date) date;</span>
<span class="fc" id="L386">        super.getCalendarDateFromFixedDate(ldate, fixedDate);</span>
<span class="fc" id="L387">        adjustYear(ldate, (fixedDate - EPOCH_OFFSET) * DAY_IN_MILLIS, 0);</span>
<span class="fc" id="L388">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>