<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JulianCalendar.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.util.calendar</a> &gt; <span class="el_source">JulianCalendar.java</span></div><h1>JulianCalendar.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, 2005, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.util.calendar;

import java.util.TimeZone;

/**
 * Julian calendar implementation.
 *
 * @author Masayoshi Okutsu
 * @since 1.5
 */
<span class="pc bpc" id="L36" title="1 of 2 branches missed.">public class JulianCalendar extends BaseCalendar {</span>

    private static final int BCE = 0;
    private static final int CE = 1;

<span class="fc" id="L41">    private static final Era[] eras = {</span>
        new Era(&quot;BeforeCommonEra&quot;, &quot;B.C.E.&quot;, Long.MIN_VALUE, false),
        new Era(&quot;CommonEra&quot;, &quot;C.E.&quot;, -62135709175808L, true)
    };
    private static final int JULIAN_EPOCH = -1;

    private static class Date extends BaseCalendar.Date {
        protected Date() {
<span class="nc" id="L49">            super();</span>
<span class="nc" id="L50">            setCache(1, -1L, 365); // January 1, 1 CE (Julian)</span>
<span class="nc" id="L51">        }</span>

        protected Date(TimeZone zone) {
<span class="fc" id="L54">            super(zone);</span>
<span class="fc" id="L55">            setCache(1, -1L, 365); // January 1, 1 CE (Julian)</span>
<span class="fc" id="L56">        }</span>

        public Date setEra(Era era) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">            if (era == null) {</span>
<span class="nc" id="L60">                throw new NullPointerException();</span>
            }
<span class="nc bnc" id="L62" title="All 4 branches missed.">            if (era != eras[0] || era != eras[1]) {</span>
<span class="nc" id="L63">                throw new IllegalArgumentException(&quot;unknown era: &quot; + era);</span>
            }
<span class="nc" id="L65">            super.setEra(era);</span>
<span class="nc" id="L66">            return this;</span>
        }

        protected void setKnownEra(Era era) {
<span class="fc" id="L70">            super.setEra(era);</span>
<span class="fc" id="L71">        }</span>

        public int getNormalizedYear() {
<span class="fc bfc" id="L74" title="All 2 branches covered.">            if (getEra() == eras[BCE]) {</span>
<span class="fc" id="L75">                return 1 - getYear();</span>
            }
<span class="fc" id="L77">            return getYear();</span>
        }

        // Use the year numbering ..., -2, -1, 0, 1, 2, ... for
        // normalized years. This differs from &quot;Calendrical
        // Calculations&quot; in which the numbering is ..., -2, -1, 1, 2,
        // ...
        public void setNormalizedYear(int year) {
<span class="fc bfc" id="L85" title="All 2 branches covered.">            if (year &lt;= 0) {</span>
<span class="fc" id="L86">                setYear(1 - year);</span>
<span class="fc" id="L87">                setKnownEra(eras[BCE]);</span>
            } else {
<span class="fc" id="L89">                setYear(year);</span>
<span class="fc" id="L90">                setKnownEra(eras[CE]);</span>
            }
<span class="fc" id="L92">        }</span>

        public String toString() {
<span class="nc" id="L95">            String time = super.toString();</span>
<span class="nc" id="L96">            time = time.substring(time.indexOf('T'));</span>
<span class="nc" id="L97">            StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L98">            Era era = getEra();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (era != null) {</span>
<span class="nc" id="L100">                String n = era.getAbbreviation();</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                if (n != null) {</span>
<span class="nc" id="L102">                    sb.append(n).append(' ');</span>
                }
            }
<span class="nc" id="L105">            sb.append(getYear()).append('-');</span>
<span class="nc" id="L106">            CalendarUtils.sprintf0d(sb, getMonth(), 2).append('-');</span>
<span class="nc" id="L107">            CalendarUtils.sprintf0d(sb, getDayOfMonth(), 2);</span>
<span class="nc" id="L108">            sb.append(time);</span>
<span class="nc" id="L109">            return sb.toString();</span>
        }
    }

<span class="fc" id="L113">    JulianCalendar() {</span>
<span class="fc" id="L114">        setEras(eras);</span>
<span class="fc" id="L115">    }</span>

    public String getName() {
<span class="nc" id="L118">        return &quot;julian&quot;;</span>
    }

    public Date getCalendarDate() {
<span class="nc" id="L122">        return getCalendarDate(System.currentTimeMillis(), newCalendarDate());</span>
    }

    public Date getCalendarDate(long millis) {
<span class="nc" id="L126">        return getCalendarDate(millis, newCalendarDate());</span>
    }

    public Date getCalendarDate(long millis, CalendarDate date) {
<span class="fc" id="L130">        return (Date) super.getCalendarDate(millis, date);</span>
    }

    public Date getCalendarDate(long millis, TimeZone zone) {
<span class="nc" id="L134">        return getCalendarDate(millis, newCalendarDate(zone));</span>
    }

    public Date newCalendarDate() {
<span class="nc" id="L138">        return new Date();</span>
    }

    public Date newCalendarDate(TimeZone zone) {
<span class="fc" id="L142">        return new Date(zone);</span>
    }

    /**
     * @param jyear normalized Julian year
     */
    public long getFixedDate(int jyear, int month, int dayOfMonth, BaseCalendar.Date cache) {
<span class="pc bpc" id="L149" title="1 of 4 branches missed.">        boolean isJan1 = month == JANUARY &amp;&amp; dayOfMonth == 1;</span>

        // Look up the one year cache
<span class="fc bfc" id="L152" title="All 4 branches covered.">        if (cache != null &amp;&amp; cache.hit(jyear)) {</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">            if (isJan1) {</span>
<span class="fc" id="L154">                return cache.getCachedJan1();</span>
            }
<span class="fc" id="L156">            return cache.getCachedJan1() + getDayOfYear(jyear, month, dayOfMonth) - 1;</span>
        }

<span class="fc" id="L159">        long y = jyear;</span>
<span class="fc" id="L160">        long days = JULIAN_EPOCH - 1 + (365 * (y - 1)) + dayOfMonth;</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">        if (y &gt; 0) {</span>
            // CE years
<span class="fc" id="L163">            days += (y - 1) / 4;</span>
        } else {
            // BCE years
<span class="fc" id="L166">            days += CalendarUtils.floorDivide(y - 1, 4);</span>
        }
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (month &gt; 0) {</span>
<span class="fc" id="L169">            days += ((367 * (long) month) - 362) / 12;</span>
        } else {
<span class="nc" id="L171">            days += CalendarUtils.floorDivide((367 * (long) month) - 362, 12);</span>
        }
<span class="fc bfc" id="L173" title="All 2 branches covered.">        if (month &gt; FEBRUARY) {</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">            days -= CalendarUtils.isJulianLeapYear(jyear) ? 1 : 2;</span>
        }

        // If it's January 1, update the cache.
<span class="fc bfc" id="L178" title="All 4 branches covered.">        if (cache != null &amp;&amp; isJan1) {</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">            cache.setCache(jyear, days, CalendarUtils.isJulianLeapYear(jyear) ? 366 : 365);</span>
        }

<span class="fc" id="L182">        return days;</span>
    }

    public void getCalendarDateFromFixedDate(CalendarDate date, long fixedDate) {
<span class="fc" id="L186">        Date jdate = (Date) date;</span>
<span class="fc" id="L187">        long fd = 4 * (fixedDate - JULIAN_EPOCH) + 1464;</span>
        int year;
<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (fd &gt;= 0) {</span>
<span class="fc" id="L190">            year = (int)(fd / 1461);</span>
        } else {
<span class="fc" id="L192">            year = (int) CalendarUtils.floorDivide(fd, 1461);</span>
        }
<span class="fc" id="L194">        int priorDays = (int)(fixedDate - getFixedDate(year, JANUARY, 1, jdate));</span>
<span class="fc" id="L195">        boolean isLeap = CalendarUtils.isJulianLeapYear(year);</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (fixedDate &gt;= getFixedDate(year, MARCH, 1, jdate)) {</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">            priorDays += isLeap ? 1 : 2;</span>
        }
<span class="fc" id="L199">        int month = 12 * priorDays + 373;</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">        if (month &gt; 0) {</span>
<span class="fc" id="L201">            month /= 367;</span>
        } else {
<span class="nc" id="L203">            month = CalendarUtils.floorDivide(month, 367);</span>
        }
<span class="fc" id="L205">        int dayOfMonth = (int)(fixedDate - getFixedDate(year, month, 1, jdate)) + 1;</span>
<span class="fc" id="L206">        int dayOfWeek = getDayOfWeekFromFixedDate(fixedDate);</span>
<span class="pc bpc" id="L207" title="2 of 4 branches missed.">        assert dayOfWeek &gt; 0 : &quot;negative day of week &quot; + dayOfWeek;</span>
<span class="fc" id="L208">        jdate.setNormalizedYear(year);</span>
<span class="fc" id="L209">        jdate.setMonth(month);</span>
<span class="fc" id="L210">        jdate.setDayOfMonth(dayOfMonth);</span>
<span class="fc" id="L211">        jdate.setDayOfWeek(dayOfWeek);</span>
<span class="fc" id="L212">        jdate.setLeapYear(isLeap);</span>
<span class="fc" id="L213">        jdate.setNormalized(true);</span>
<span class="fc" id="L214">    }</span>

    /**
     * Returns the normalized Julian year number of the given fixed date.
     */
    public int getYearFromFixedDate(long fixedDate) {
<span class="nc" id="L220">        int year = (int) CalendarUtils.floorDivide(4 * (fixedDate - JULIAN_EPOCH) + 1464, 1461);</span>
<span class="nc" id="L221">        return year;</span>
    }

    public int getDayOfWeek(CalendarDate date) {
        // TODO: should replace this with a faster calculation, such
        // as cache table lookup
<span class="nc" id="L227">        long fixedDate = getFixedDate(date);</span>
<span class="nc" id="L228">        return getDayOfWeekFromFixedDate(fixedDate);</span>
    }

    boolean isLeapYear(int jyear) {
<span class="fc" id="L232">        return CalendarUtils.isJulianLeapYear(jyear);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>