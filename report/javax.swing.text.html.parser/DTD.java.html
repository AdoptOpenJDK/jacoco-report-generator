<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>DTD.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">javax.swing.text.html.parser</a> &gt; <span class="el_source">DTD.java</span></div><h1>DTD.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1998, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing.text.html.parser;

import sun.awt.AppContext;

import java.io.PrintStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.io.IOException;
import java.io.FileNotFoundException;
import java.io.BufferedInputStream;
import java.io.DataInputStream;
import java.util.Hashtable;
import java.util.Vector;
import java.util.BitSet;
import java.util.StringTokenizer;
import java.util.Enumeration;
import java.util.Properties;
import java.net.URL;

/**
 * The representation of an SGML DTD.  DTD describes a document
 * syntax and is used in parsing of HTML documents.  It contains
 * a list of elements and their attributes as well as a list of
 * entities defined in the DTD.
 *
 * @see Element
 * @see AttributeList
 * @see ContentModel
 * @see Parser
 * @author Arthur van Hoff
 */
public
class DTD implements DTDConstants {
    public String name;
<span class="nc" id="L61">    public Vector&lt;Element&gt; elements = new Vector&lt;Element&gt;();</span>
<span class="nc" id="L62">    public Hashtable&lt;String,Element&gt; elementHash</span>
        = new Hashtable&lt;String,Element&gt;();
<span class="nc" id="L64">    public Hashtable&lt;Object,Entity&gt; entityHash</span>
        = new Hashtable&lt;Object,Entity&gt;();
<span class="nc" id="L66">    public final Element pcdata = getElement(&quot;#pcdata&quot;);</span>
<span class="nc" id="L67">    public final Element html = getElement(&quot;html&quot;);</span>
<span class="nc" id="L68">    public final Element meta = getElement(&quot;meta&quot;);</span>
<span class="nc" id="L69">    public final Element base = getElement(&quot;base&quot;);</span>
<span class="nc" id="L70">    public final Element isindex = getElement(&quot;isindex&quot;);</span>
<span class="nc" id="L71">    public final Element head = getElement(&quot;head&quot;);</span>
<span class="nc" id="L72">    public final Element body = getElement(&quot;body&quot;);</span>
<span class="nc" id="L73">    public final Element applet = getElement(&quot;applet&quot;);</span>
<span class="nc" id="L74">    public final Element param = getElement(&quot;param&quot;);</span>
<span class="nc" id="L75">    public final Element p = getElement(&quot;p&quot;);</span>
<span class="nc" id="L76">    public final Element title = getElement(&quot;title&quot;);</span>
<span class="nc" id="L77">    final Element style = getElement(&quot;style&quot;);</span>
<span class="nc" id="L78">    final Element link = getElement(&quot;link&quot;);</span>
<span class="nc" id="L79">    final Element script = getElement(&quot;script&quot;);</span>

    public static final int FILE_VERSION = 1;

    /**
     * Creates a new DTD with the specified name.
     * @param name the name, as a &lt;code&gt;String&lt;/code&gt; of the new DTD
     */
<span class="nc" id="L87">    protected DTD(String name) {</span>
<span class="nc" id="L88">        this.name = name;</span>
<span class="nc" id="L89">        defEntity(&quot;#RE&quot;, GENERAL, '\r');</span>
<span class="nc" id="L90">        defEntity(&quot;#RS&quot;, GENERAL, '\n');</span>
<span class="nc" id="L91">        defEntity(&quot;#SPACE&quot;, GENERAL, ' ');</span>
<span class="nc" id="L92">        defineElement(&quot;unknown&quot;, EMPTY, false, true, null, null, null, null);</span>
<span class="nc" id="L93">    }</span>

    /**
     * Gets the name of the DTD.
     * @return the name of the DTD
     */
    public String getName() {
<span class="nc" id="L100">        return name;</span>
    }

    /**
     * Gets an entity by name.
     * @return the &lt;code&gt;Entity&lt;/code&gt; corresponding to the
     *   &lt;code&gt;name&lt;/code&gt; &lt;code&gt;String&lt;/code&gt;
     */
    public Entity getEntity(String name) {
<span class="nc" id="L109">        return entityHash.get(name);</span>
    }

    /**
     * Gets a character entity.
     * @return the &lt;code&gt;Entity&lt;/code&gt; corresponding to the
     *    &lt;code&gt;ch&lt;/code&gt; character
     */
    public Entity getEntity(int ch) {
<span class="nc" id="L118">        return entityHash.get(Integer.valueOf(ch));</span>
    }

    /**
     * Returns &lt;code&gt;true&lt;/code&gt; if the element is part of the DTD,
     * otherwise returns &lt;code&gt;false&lt;/code&gt;.
     *
     * @param  name the requested &lt;code&gt;String&lt;/code&gt;
     * @return &lt;code&gt;true&lt;/code&gt; if &lt;code&gt;name&lt;/code&gt; exists as
     *   part of the DTD, otherwise returns &lt;code&gt;false&lt;/code&gt;
     */
    boolean elementExists(String name) {
<span class="nc bnc" id="L130" title="All 4 branches missed.">        return !&quot;unknown&quot;.equals(name) &amp;&amp; (elementHash.get(name) != null);</span>
    }

    /**
     * Gets an element by name. A new element is
     * created if the element doesn't exist.
     *
     * @param name the requested &lt;code&gt;String&lt;/code&gt;
     * @return the &lt;code&gt;Element&lt;/code&gt; corresponding to
     *   &lt;code&gt;name&lt;/code&gt;, which may be newly created
     */
    public Element getElement(String name) {
<span class="nc" id="L142">        Element e = elementHash.get(name);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (e == null) {</span>
<span class="nc" id="L144">            e = new Element(name, elements.size());</span>
<span class="nc" id="L145">            elements.addElement(e);</span>
<span class="nc" id="L146">            elementHash.put(name, e);</span>
        }
<span class="nc" id="L148">        return e;</span>
    }

    /**
     * Gets an element by index.
     *
     * @param index the requested index
     * @return the &lt;code&gt;Element&lt;/code&gt; corresponding to
     *   &lt;code&gt;index&lt;/code&gt;
     */
    public Element getElement(int index) {
<span class="nc" id="L159">        return elements.elementAt(index);</span>
    }

    /**
     * Defines an entity.  If the &lt;code&gt;Entity&lt;/code&gt; specified
     * by &lt;code&gt;name&lt;/code&gt;, &lt;code&gt;type&lt;/code&gt;, and &lt;code&gt;data&lt;/code&gt;
     * exists, it is returned; otherwise a new &lt;code&gt;Entity&lt;/code&gt;
     * is created and is returned.
     *
     * @param name the name of the &lt;code&gt;Entity&lt;/code&gt; as a &lt;code&gt;String&lt;/code&gt;
     * @param type the type of the &lt;code&gt;Entity&lt;/code&gt;
     * @param data the &lt;code&gt;Entity&lt;/code&gt;'s data
     * @return the &lt;code&gt;Entity&lt;/code&gt; requested or a new &lt;code&gt;Entity&lt;/code&gt;
     *   if not found
     */
    public Entity defineEntity(String name, int type, char data[]) {
<span class="nc" id="L175">        Entity ent = entityHash.get(name);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (ent == null) {</span>
<span class="nc" id="L177">            ent = new Entity(name, type, data);</span>
<span class="nc" id="L178">            entityHash.put(name, ent);</span>
<span class="nc bnc" id="L179" title="All 4 branches missed.">            if (((type &amp; GENERAL) != 0) &amp;&amp; (data.length == 1)) {</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                switch (type &amp; ~GENERAL) {</span>
                  case CDATA:
                  case SDATA:
<span class="nc" id="L183">                      entityHash.put(Integer.valueOf(data[0]), ent);</span>
                    break;
                }
            }
        }
<span class="nc" id="L188">        return ent;</span>
    }

    /**
     * Returns the &lt;code&gt;Element&lt;/code&gt; which matches the
     * specified parameters.  If one doesn't exist, a new
     * one is created and returned.
     *
     * @param name the name of the &lt;code&gt;Element&lt;/code&gt;
     * @param type the type of the &lt;code&gt;Element&lt;/code&gt;
     * @param omitStart &lt;code&gt;true&lt;/code&gt; if start should be omitted
     * @param omitEnd  &lt;code&gt;true&lt;/code&gt; if end should be omitted
     * @param content  the &lt;code&gt;ContentModel&lt;/code&gt;
     * @param atts the &lt;code&gt;AttributeList&lt;/code&gt; specifying the
     *    &lt;code&gt;Element&lt;/code&gt;
     * @return the &lt;code&gt;Element&lt;/code&gt; specified
     */
    public Element defineElement(String name, int type,
                       boolean omitStart, boolean omitEnd, ContentModel content,
                       BitSet exclusions, BitSet inclusions, AttributeList atts) {
<span class="nc" id="L208">        Element e = getElement(name);</span>
<span class="nc" id="L209">        e.type = type;</span>
<span class="nc" id="L210">        e.oStart = omitStart;</span>
<span class="nc" id="L211">        e.oEnd = omitEnd;</span>
<span class="nc" id="L212">        e.content = content;</span>
<span class="nc" id="L213">        e.exclusions = exclusions;</span>
<span class="nc" id="L214">        e.inclusions = inclusions;</span>
<span class="nc" id="L215">        e.atts = atts;</span>
<span class="nc" id="L216">        return e;</span>
    }

    /**
     * Defines attributes for an {@code Element}.
     *
     * @param name the name of the &lt;code&gt;Element&lt;/code&gt;
     * @param atts the &lt;code&gt;AttributeList&lt;/code&gt; specifying the
     *    &lt;code&gt;Element&lt;/code&gt;
     */
    public void defineAttributes(String name, AttributeList atts) {
<span class="nc" id="L227">        Element e = getElement(name);</span>
<span class="nc" id="L228">        e.atts = atts;</span>
<span class="nc" id="L229">    }</span>

    /**
     * Creates and returns a character &lt;code&gt;Entity&lt;/code&gt;.
     * @param name the entity's name
     * @return the new character &lt;code&gt;Entity&lt;/code&gt;
     */
    public Entity defEntity(String name, int type, int ch) {
<span class="nc" id="L237">        char data[] = {(char)ch};</span>
<span class="nc" id="L238">        return defineEntity(name, type, data);</span>
    }

    /**
     * Creates and returns an &lt;code&gt;Entity&lt;/code&gt;.
     * @param name the entity's name
     * @return the new &lt;code&gt;Entity&lt;/code&gt;
     */
    protected Entity defEntity(String name, int type, String str) {
<span class="nc" id="L247">        int len = str.length();</span>
<span class="nc" id="L248">        char data[] = new char[len];</span>
<span class="nc" id="L249">        str.getChars(0, len, data, 0);</span>
<span class="nc" id="L250">        return defineEntity(name, type, data);</span>
    }

    /**
     * Creates and returns an &lt;code&gt;Element&lt;/code&gt;.
     * @param name the element's name
     * @return the new &lt;code&gt;Element&lt;/code&gt;
     */
    protected Element defElement(String name, int type,
                       boolean omitStart, boolean omitEnd, ContentModel content,
                       String[] exclusions, String[] inclusions, AttributeList atts) {
<span class="nc" id="L261">        BitSet excl = null;</span>
<span class="nc bnc" id="L262" title="All 4 branches missed.">        if (exclusions != null &amp;&amp; exclusions.length &gt; 0) {</span>
<span class="nc" id="L263">            excl = new BitSet();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">            for (String str : exclusions) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                if (str.length() &gt; 0) {</span>
<span class="nc" id="L266">                    excl.set(getElement(str).getIndex());</span>
                }
            }
        }
<span class="nc" id="L270">        BitSet incl = null;</span>
<span class="nc bnc" id="L271" title="All 4 branches missed.">        if (inclusions != null &amp;&amp; inclusions.length &gt; 0) {</span>
<span class="nc" id="L272">            incl = new BitSet();</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            for (String str : inclusions) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                if (str.length() &gt; 0) {</span>
<span class="nc" id="L275">                    incl.set(getElement(str).getIndex());</span>
                }
            }
        }
<span class="nc" id="L279">        return defineElement(name, type, omitStart, omitEnd, content, excl, incl, atts);</span>
    }

    /**
     * Creates and returns an &lt;code&gt;AttributeList&lt;/code&gt;.
     * @param name the attribute list's name
     * @return the new &lt;code&gt;AttributeList&lt;/code&gt;
     */
    protected AttributeList defAttributeList(String name, int type, int modifier, String value, String values, AttributeList atts) {
<span class="nc" id="L288">        Vector&lt;String&gt; vals = null;</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (values != null) {</span>
<span class="nc" id="L290">            vals = new Vector&lt;String&gt;();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            for (StringTokenizer s = new StringTokenizer(values, &quot;|&quot;) ; s.hasMoreTokens() ;) {</span>
<span class="nc" id="L292">                String str = s.nextToken();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">                if (str.length() &gt; 0) {</span>
<span class="nc" id="L294">                    vals.addElement(str);</span>
                }
<span class="nc" id="L296">            }</span>
        }
<span class="nc" id="L298">        return new AttributeList(name, type, modifier, value, vals, atts);</span>
    }

    /**
     * Creates and returns a new content model.
     * @param type the type of the new content model
     * @return the new &lt;code&gt;ContentModel&lt;/code&gt;
     */
    protected ContentModel defContentModel(int type, Object obj, ContentModel next) {
<span class="nc" id="L307">        return new ContentModel(type, obj, next);</span>
    }

    /**
     * Returns a string representation of this DTD.
     * @return the string representation of this DTD
     */
    public String toString() {
<span class="nc" id="L315">        return name;</span>
    }

    /**
     * The hashtable key of DTDs in AppContext.
     */
<span class="nc" id="L321">    private static final Object DTD_HASH_KEY = new Object();</span>

    public static void putDTDHash(String name, DTD dtd) {
<span class="nc" id="L324">        getDtdHash().put(name, dtd);</span>
<span class="nc" id="L325">    }</span>

    /**
     * Returns a DTD with the specified &lt;code&gt;name&lt;/code&gt;.  If
     * a DTD with that name doesn't exist, one is created
     * and returned.  Any uppercase characters in the name
     * are converted to lowercase.
     *
     * @param name the name of the DTD
     * @return the DTD which corresponds to &lt;code&gt;name&lt;/code&gt;
     */
    public static DTD getDTD(String name) throws IOException {
<span class="nc" id="L337">        name = name.toLowerCase();</span>
<span class="nc" id="L338">        DTD dtd = getDtdHash().get(name);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (dtd == null)</span>
<span class="nc" id="L340">          dtd = new DTD(name);</span>

<span class="nc" id="L342">        return dtd;</span>
    }

    private static Hashtable&lt;String, DTD&gt; getDtdHash() {
<span class="nc" id="L346">        AppContext appContext = AppContext.getAppContext();</span>

<span class="nc" id="L348">        Hashtable&lt;String, DTD&gt; result = (Hashtable&lt;String, DTD&gt;) appContext.get(DTD_HASH_KEY);</span>

<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (result == null) {</span>
<span class="nc" id="L351">            result = new Hashtable&lt;String, DTD&gt;();</span>

<span class="nc" id="L353">            appContext.put(DTD_HASH_KEY, result);</span>
        }

<span class="nc" id="L356">        return result;</span>
    }

    /**
     * Recreates a DTD from an archived format.
     * @param in  the &lt;code&gt;DataInputStream&lt;/code&gt; to read from
     */
    public void read(DataInputStream in) throws IOException {
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (in.readInt() != FILE_VERSION) {</span>
        }

        //
        // Read the list of names
        //
<span class="nc" id="L370">        String[] names = new String[in.readShort()];</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">        for (int i = 0; i &lt; names.length; i++) {</span>
<span class="nc" id="L372">            names[i] = in.readUTF();</span>
        }


        //
        // Read the entities
        //
<span class="nc" id="L379">        int num = in.readShort();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">        for (int i = 0; i &lt; num; i++) {</span>
<span class="nc" id="L381">            short nameId = in.readShort();</span>
<span class="nc" id="L382">            int type = in.readByte();</span>
<span class="nc" id="L383">            String name = in.readUTF();</span>
<span class="nc" id="L384">            defEntity(names[nameId], type | GENERAL, name);</span>
        }

        // Read the elements
        //
<span class="nc" id="L389">        num = in.readShort();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">        for (int i = 0; i &lt; num; i++) {</span>
<span class="nc" id="L391">            short nameId = in.readShort();</span>
<span class="nc" id="L392">            int type = in.readByte();</span>
<span class="nc" id="L393">            byte flags = in.readByte();</span>
<span class="nc" id="L394">            ContentModel m = readContentModel(in, names);</span>
<span class="nc" id="L395">            String[] exclusions = readNameArray(in, names);</span>
<span class="nc" id="L396">            String[] inclusions = readNameArray(in, names);</span>
<span class="nc" id="L397">            AttributeList atts = readAttributeList(in, names);</span>
<span class="nc bnc" id="L398" title="All 4 branches missed.">            defElement(names[nameId], type,</span>
                       ((flags &amp; 0x01) != 0), ((flags &amp; 0x02) != 0),
                       m, exclusions, inclusions, atts);
        }
<span class="nc" id="L402">    }</span>

    private ContentModel readContentModel(DataInputStream in, String[] names)
                throws IOException {
<span class="nc" id="L406">        byte flag = in.readByte();</span>
<span class="nc bnc" id="L407" title="All 4 branches missed.">        switch(flag) {</span>
            case 0:             // null
<span class="nc" id="L409">                return null;</span>
            case 1: {           // content_c
<span class="nc" id="L411">                int type = in.readByte();</span>
<span class="nc" id="L412">                ContentModel m = readContentModel(in, names);</span>
<span class="nc" id="L413">                ContentModel next = readContentModel(in, names);</span>
<span class="nc" id="L414">                return defContentModel(type, m, next);</span>
            }
            case 2: {           // content_e
<span class="nc" id="L417">                int type = in.readByte();</span>
<span class="nc" id="L418">                Element el = getElement(names[in.readShort()]);</span>
<span class="nc" id="L419">                ContentModel next = readContentModel(in, names);</span>
<span class="nc" id="L420">                return defContentModel(type, el, next);</span>
            }
        default:
<span class="nc" id="L423">                throw new IOException(&quot;bad bdtd&quot;);</span>
        }
    }

    private String[] readNameArray(DataInputStream in, String[] names)
                throws IOException {
<span class="nc" id="L429">        int num = in.readShort();</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (num == 0) {</span>
<span class="nc" id="L431">            return null;</span>
        }
<span class="nc" id="L433">        String[] result = new String[num];</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">        for (int i = 0; i &lt; num; i++) {</span>
<span class="nc" id="L435">            result[i] = names[in.readShort()];</span>
        }
<span class="nc" id="L437">        return result;</span>
    }


    private AttributeList readAttributeList(DataInputStream in, String[] names)
                throws IOException  {
<span class="nc" id="L443">        AttributeList result = null;</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">        for (int num = in.readByte(); num &gt; 0; --num) {</span>
<span class="nc" id="L445">            short nameId = in.readShort();</span>
<span class="nc" id="L446">            int type = in.readByte();</span>
<span class="nc" id="L447">            int modifier = in.readByte();</span>
<span class="nc" id="L448">            short valueId = in.readShort();</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">            String value = (valueId == -1) ? null : names[valueId];</span>
<span class="nc" id="L450">            Vector&lt;String&gt; values = null;</span>
<span class="nc" id="L451">            short numValues = in.readShort();</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">            if (numValues &gt; 0) {</span>
<span class="nc" id="L453">                values = new Vector&lt;String&gt;(numValues);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                for (int i = 0; i &lt; numValues; i++) {</span>
<span class="nc" id="L455">                    values.addElement(names[in.readShort()]);</span>
                }
            }
<span class="nc" id="L458">result = new AttributeList(names[nameId], type, modifier, value,</span>
                                       values, result);
            // We reverse the order of the linked list by doing this, but
            // that order isn't important.
        }
<span class="nc" id="L463">        return result;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>