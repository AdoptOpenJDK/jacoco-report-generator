<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>JndiLoginModule.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.security.auth.module</a> &gt; <span class="el_source">JndiLoginModule.java</span></div><h1>JndiLoginModule.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.security.auth.module;

import javax.security.auth.*;
import javax.security.auth.callback.*;
import javax.security.auth.login.*;
import javax.security.auth.spi.*;
import javax.naming.*;
import javax.naming.directory.*;

import java.security.AccessController;
import java.security.PrivilegedAction;
import java.util.Map;
import java.util.LinkedList;
import java.util.ResourceBundle;

import com.sun.security.auth.UnixPrincipal;
import com.sun.security.auth.UnixNumericUserPrincipal;
import com.sun.security.auth.UnixNumericGroupPrincipal;


/**
 * &lt;p&gt; The module prompts for a username and password
 * and then verifies the password against the password stored in
 * a directory service configured under JNDI.
 *
 * &lt;p&gt; This &lt;code&gt;LoginModule&lt;/code&gt; interoperates with
 * any conformant JNDI service provider.  To direct this
 * &lt;code&gt;LoginModule&lt;/code&gt; to use a specific JNDI service provider,
 * two options must be specified in the login &lt;code&gt;Configuration&lt;/code&gt;
 * for this &lt;code&gt;LoginModule&lt;/code&gt;.
 * &lt;pre&gt;
 *      user.provider.url=&lt;b&gt;name_service_url&lt;/b&gt;
 *      group.provider.url=&lt;b&gt;name_service_url&lt;/b&gt;
 * &lt;/pre&gt;
 *
 * &lt;b&gt;name_service_url&lt;/b&gt; specifies
 * the directory service and path where this &lt;code&gt;LoginModule&lt;/code&gt;
 * can access the relevant user and group information.  Because this
 * &lt;code&gt;LoginModule&lt;/code&gt; only performs one-level searches to
 * find the relevant user information, the &lt;code&gt;URL&lt;/code&gt;
 * must point to a directory one level above where the user and group
 * information is stored in the directory service.
 * For example, to instruct this &lt;code&gt;LoginModule&lt;/code&gt;
 * to contact a NIS server, the following URLs must be specified:
 * &lt;pre&gt;
 *    user.provider.url=&quot;nis://&lt;b&gt;NISServerHostName&lt;/b&gt;/&lt;b&gt;NISDomain&lt;/b&gt;/user&quot;
 *    group.provider.url=&quot;nis://&lt;b&gt;NISServerHostName&lt;/b&gt;/&lt;b&gt;NISDomain&lt;/b&gt;/system/group&quot;
 * &lt;/pre&gt;
 *
 * &lt;b&gt;NISServerHostName&lt;/b&gt; specifies the server host name of the
 * NIS server (for example, &lt;i&gt;nis.sun.com&lt;/i&gt;, and &lt;b&gt;NISDomain&lt;/b&gt;
 * specifies the domain for that NIS server (for example, &lt;i&gt;jaas.sun.com&lt;/i&gt;.
 * To contact an LDAP server, the following URLs must be specified:
 * &lt;pre&gt;
 *    user.provider.url=&quot;ldap://&lt;b&gt;LDAPServerHostName&lt;/b&gt;/&lt;b&gt;LDAPName&lt;/b&gt;&quot;
 *    group.provider.url=&quot;ldap://&lt;b&gt;LDAPServerHostName&lt;/b&gt;/&lt;b&gt;LDAPName&lt;/b&gt;&quot;
 * &lt;/pre&gt;
 *
 * &lt;b&gt;LDAPServerHostName&lt;/b&gt; specifies the server host name of the
 * LDAP server, which may include a port number
 * (for example, &lt;i&gt;ldap.sun.com:389&lt;/i&gt;),
 * and &lt;b&gt;LDAPName&lt;/b&gt; specifies the entry name in the LDAP directory
 * (for example, &lt;i&gt;ou=People,o=Sun,c=US&lt;/i&gt; and &lt;i&gt;ou=Groups,o=Sun,c=US&lt;/i&gt;
 * for user and group information, respectively).
 *
 * &lt;p&gt; The format in which the user's information must be stored in
 * the directory service is specified in RFC 2307.  Specifically,
 * this &lt;code&gt;LoginModule&lt;/code&gt; will search for the user's entry in the
 * directory service using the user's &lt;i&gt;uid&lt;/i&gt; attribute,
 * where &lt;i&gt;uid=&lt;b&gt;username&lt;/b&gt;&lt;/i&gt;.  If the search succeeds,
 * this &lt;code&gt;LoginModule&lt;/code&gt; will then
 * obtain the user's encrypted password from the retrieved entry
 * using the &lt;i&gt;userPassword&lt;/i&gt; attribute.
 * This &lt;code&gt;LoginModule&lt;/code&gt; assumes that the password is stored
 * as a byte array, which when converted to a &lt;code&gt;String&lt;/code&gt;,
 * has the following format:
 * &lt;pre&gt;
 *      &quot;{crypt}&lt;b&gt;encrypted_password&lt;/b&gt;&quot;
 * &lt;/pre&gt;
 *
 * The LDAP directory server must be configured
 * to permit read access to the userPassword attribute.
 * If the user entered a valid username and password,
 * this &lt;code&gt;LoginModule&lt;/code&gt; associates a
 * &lt;code&gt;UnixPrincipal&lt;/code&gt;, &lt;code&gt;UnixNumericUserPrincipal&lt;/code&gt;,
 * and the relevant UnixNumericGroupPrincipals with the
 * &lt;code&gt;Subject&lt;/code&gt;.
 *
 * &lt;p&gt; This LoginModule also recognizes the following &lt;code&gt;Configuration&lt;/code&gt;
 * options:
 * &lt;pre&gt;
 *    debug          if, true, debug messages are output to System.out.
 *
 *    useFirstPass   if, true, this LoginModule retrieves the
 *                   username and password from the module's shared state,
 *                   using &quot;javax.security.auth.login.name&quot; and
 *                   &quot;javax.security.auth.login.password&quot; as the respective
 *                   keys.  The retrieved values are used for authentication.
 *                   If authentication fails, no attempt for a retry is made,
 *                   and the failure is reported back to the calling
 *                   application.
 *
 *    tryFirstPass   if, true, this LoginModule retrieves the
 *                   the username and password from the module's shared state,
 *                   using &quot;javax.security.auth.login.name&quot; and
 *                   &quot;javax.security.auth.login.password&quot; as the respective
 *                   keys.  The retrieved values are used for authentication.
 *                   If authentication fails, the module uses the
 *                   CallbackHandler to retrieve a new username and password,
 *                   and another attempt to authenticate is made.
 *                   If the authentication fails, the failure is reported
 *                   back to the calling application.
 *
 *    storePass      if, true, this LoginModule stores the username and password
 *                   obtained from the CallbackHandler in the module's
 *                   shared state, using &quot;javax.security.auth.login.name&quot; and
 *                   &quot;javax.security.auth.login.password&quot; as the respective
 *                   keys.  This is not performed if existing values already
 *                   exist for the username and password in the shared state,
 *                   or if authentication fails.
 *
 *    clearPass     if, true, this &lt;code&gt;LoginModule&lt;/code&gt; clears the
 *                  username and password stored in the module's shared state
 *                  after both phases of authentication (login and commit)
 *                  have completed.
 * &lt;/pre&gt;
 *
 */
@jdk.Exported
<span class="nc" id="L155">public class JndiLoginModule implements LoginModule {</span>

<span class="nc" id="L157">    private static final ResourceBundle rb = AccessController.doPrivileged(</span>
<span class="nc" id="L158">            new PrivilegedAction&lt;ResourceBundle&gt;() {</span>
                public ResourceBundle run() {
<span class="nc" id="L160">                    return ResourceBundle.getBundle(</span>
                            &quot;sun.security.util.AuthResources&quot;);
                }
            }
    );

    /** JNDI Provider */
<span class="nc" id="L167">    public final String USER_PROVIDER = &quot;user.provider.url&quot;;</span>
<span class="nc" id="L168">    public final String GROUP_PROVIDER = &quot;group.provider.url&quot;;</span>

    // configurable options
<span class="nc" id="L171">    private boolean debug = false;</span>
<span class="nc" id="L172">    private boolean strongDebug = false;</span>
    private String userProvider;
    private String groupProvider;
<span class="nc" id="L175">    private boolean useFirstPass = false;</span>
<span class="nc" id="L176">    private boolean tryFirstPass = false;</span>
<span class="nc" id="L177">    private boolean storePass = false;</span>
<span class="nc" id="L178">    private boolean clearPass = false;</span>

    // the authentication status
<span class="nc" id="L181">    private boolean succeeded = false;</span>
<span class="nc" id="L182">    private boolean commitSucceeded = false;</span>

    // username, password, and JNDI context
    private String username;
    private char[] password;
    DirContext ctx;

    // the user (assume it is a UnixPrincipal)
    private UnixPrincipal userPrincipal;
    private UnixNumericUserPrincipal UIDPrincipal;
    private UnixNumericGroupPrincipal GIDPrincipal;
<span class="nc" id="L193">    private LinkedList&lt;UnixNumericGroupPrincipal&gt; supplementaryGroups =</span>
                                new LinkedList&lt;&gt;();

    // initial state
    private Subject subject;
    private CallbackHandler callbackHandler;
    private Map&lt;String, Object&gt; sharedState;
    private Map&lt;String, ?&gt; options;

    private static final String CRYPT = &quot;{crypt}&quot;;
    private static final String USER_PWD = &quot;userPassword&quot;;
    private static final String USER_UID = &quot;uidNumber&quot;;
    private static final String USER_GID = &quot;gidNumber&quot;;
    private static final String GROUP_ID = &quot;gidNumber&quot;;
    private static final String NAME = &quot;javax.security.auth.login.name&quot;;
    private static final String PWD = &quot;javax.security.auth.login.password&quot;;

    /**
     * Initialize this &lt;code&gt;LoginModule&lt;/code&gt;.
     *
     * &lt;p&gt;
     *
     * @param subject the &lt;code&gt;Subject&lt;/code&gt; to be authenticated. &lt;p&gt;
     *
     * @param callbackHandler a &lt;code&gt;CallbackHandler&lt;/code&gt; for communicating
     *                  with the end user (prompting for usernames and
     *                  passwords, for example). &lt;p&gt;
     *
     * @param sharedState shared &lt;code&gt;LoginModule&lt;/code&gt; state. &lt;p&gt;
     *
     * @param options options specified in the login
     *                  &lt;code&gt;Configuration&lt;/code&gt; for this particular
     *                  &lt;code&gt;LoginModule&lt;/code&gt;.
     */
    // Unchecked warning from (Map&lt;String, Object&gt;)sharedState is safe
    // since javax.security.auth.login.LoginContext passes a raw HashMap.
    // Unchecked warnings from options.get(String) are safe since we are
    // passing known keys.
    @SuppressWarnings(&quot;unchecked&quot;)
    public void initialize(Subject subject, CallbackHandler callbackHandler,
                           Map&lt;String,?&gt; sharedState,
                           Map&lt;String,?&gt; options) {

<span class="nc" id="L236">        this.subject = subject;</span>
<span class="nc" id="L237">        this.callbackHandler = callbackHandler;</span>
<span class="nc" id="L238">        this.sharedState = (Map&lt;String, Object&gt;)sharedState;</span>
<span class="nc" id="L239">        this.options = options;</span>

        // initialize any configured options
<span class="nc" id="L242">        debug = &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;debug&quot;));</span>
<span class="nc" id="L243">        strongDebug =</span>
<span class="nc" id="L244">                &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;strongDebug&quot;));</span>
<span class="nc" id="L245">        userProvider = (String)options.get(USER_PROVIDER);</span>
<span class="nc" id="L246">        groupProvider = (String)options.get(GROUP_PROVIDER);</span>
<span class="nc" id="L247">        tryFirstPass =</span>
<span class="nc" id="L248">                &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;tryFirstPass&quot;));</span>
<span class="nc" id="L249">        useFirstPass =</span>
<span class="nc" id="L250">                &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;useFirstPass&quot;));</span>
<span class="nc" id="L251">        storePass =</span>
<span class="nc" id="L252">                &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;storePass&quot;));</span>
<span class="nc" id="L253">        clearPass =</span>
<span class="nc" id="L254">                &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;clearPass&quot;));</span>
<span class="nc" id="L255">    }</span>

    /**
     * &lt;p&gt; Prompt for username and password.
     * Verify the password against the relevant name service.
     *
     * &lt;p&gt;
     *
     * @return true always, since this &lt;code&gt;LoginModule&lt;/code&gt;
     *          should not be ignored.
     *
     * @exception FailedLoginException if the authentication fails. &lt;p&gt;
     *
     * @exception LoginException if this &lt;code&gt;LoginModule&lt;/code&gt;
     *          is unable to perform the authentication.
     */
    public boolean login() throws LoginException {

<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (userProvider == null) {</span>
<span class="nc" id="L274">            throw new LoginException</span>
                (&quot;Error: Unable to locate JNDI user provider&quot;);
        }
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (groupProvider == null) {</span>
<span class="nc" id="L278">            throw new LoginException</span>
                (&quot;Error: Unable to locate JNDI group provider&quot;);
        }

<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L283">            System.out.println(&quot;\t\t[JndiLoginModule] user provider: &quot; +</span>
                                userProvider);
<span class="nc" id="L285">            System.out.println(&quot;\t\t[JndiLoginModule] group provider: &quot; +</span>
                                groupProvider);
        }

        // attempt the authentication
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (tryFirstPass) {</span>

            try {
                // attempt the authentication by getting the
                // username and password from shared state
<span class="nc" id="L295">                attemptAuthentication(true);</span>

                // authentication succeeded
<span class="nc" id="L298">                succeeded = true;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L300">                    System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;tryFirstPass succeeded&quot;);
                }
<span class="nc" id="L303">                return true;</span>
<span class="nc" id="L304">            } catch (LoginException le) {</span>
                // authentication failed -- try again below by prompting
<span class="nc" id="L306">                cleanState();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L308">                    System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;tryFirstPass failed with:&quot; +
<span class="nc" id="L310">                                le.toString());</span>
                }
<span class="nc" id="L312">            }</span>

<span class="nc bnc" id="L314" title="All 2 branches missed.">        } else if (useFirstPass) {</span>

            try {
                // attempt the authentication by getting the
                // username and password from shared state
<span class="nc" id="L319">                attemptAuthentication(true);</span>

                // authentication succeeded
<span class="nc" id="L322">                succeeded = true;</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L324">                    System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;useFirstPass succeeded&quot;);
                }
<span class="nc" id="L327">                return true;</span>
<span class="nc" id="L328">            } catch (LoginException le) {</span>
                // authentication failed
<span class="nc" id="L330">                cleanState();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L332">                    System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;useFirstPass failed&quot;);
                }
<span class="nc" id="L335">                throw le;</span>
            }
        }

        // attempt the authentication by prompting for the username and pwd
        try {
<span class="nc" id="L341">            attemptAuthentication(false);</span>

            // authentication succeeded
<span class="nc" id="L344">           succeeded = true;</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L346">                System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;regular authentication succeeded&quot;);
            }
<span class="nc" id="L349">            return true;</span>
<span class="nc" id="L350">        } catch (LoginException le) {</span>
<span class="nc" id="L351">            cleanState();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L353">                System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;regular authentication failed&quot;);
            }
<span class="nc" id="L356">            throw le;</span>
        }
    }

    /**
     * Abstract method to commit the authentication process (phase 2).
     *
     * &lt;p&gt; This method is called if the LoginContext's
     * overall authentication succeeded
     * (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL LoginModules
     * succeeded).
     *
     * &lt;p&gt; If this LoginModule's own authentication attempt
     * succeeded (checked by retrieving the private state saved by the
     * &lt;code&gt;login&lt;/code&gt; method), then this method associates a
     * &lt;code&gt;UnixPrincipal&lt;/code&gt;
     * with the &lt;code&gt;Subject&lt;/code&gt; located in the
     * &lt;code&gt;LoginModule&lt;/code&gt;.  If this LoginModule's own
     * authentication attempted failed, then this method removes
     * any state that was originally saved.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the commit fails
     *
     * @return true if this LoginModule's own login and commit
     *          attempts succeeded, or false otherwise.
     */
    public boolean commit() throws LoginException {

<span class="nc bnc" id="L386" title="All 2 branches missed.">        if (succeeded == false) {</span>
<span class="nc" id="L387">            return false;</span>
        } else {
<span class="nc bnc" id="L389" title="All 2 branches missed.">            if (subject.isReadOnly()) {</span>
<span class="nc" id="L390">                cleanState();</span>
<span class="nc" id="L391">                throw new LoginException (&quot;Subject is Readonly&quot;);</span>
            }
            // add Principals to the Subject
<span class="nc bnc" id="L394" title="All 2 branches missed.">            if (!subject.getPrincipals().contains(userPrincipal))</span>
<span class="nc" id="L395">                subject.getPrincipals().add(userPrincipal);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">            if (!subject.getPrincipals().contains(UIDPrincipal))</span>
<span class="nc" id="L397">                subject.getPrincipals().add(UIDPrincipal);</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">            if (!subject.getPrincipals().contains(GIDPrincipal))</span>
<span class="nc" id="L399">                subject.getPrincipals().add(GIDPrincipal);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">            for (int i = 0; i &lt; supplementaryGroups.size(); i++) {</span>
<span class="nc" id="L401">                if (!subject.getPrincipals().contains</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">                        (supplementaryGroups.get(i)))</span>
<span class="nc" id="L403">                    subject.getPrincipals().add(supplementaryGroups.get(i));</span>
            }

<span class="nc bnc" id="L406" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L407">                System.out.println(&quot;\t\t[JndiLoginModule]: &quot; +</span>
                                   &quot;added UnixPrincipal,&quot;);
<span class="nc" id="L409">                System.out.println(&quot;\t\t\t\tUnixNumericUserPrincipal,&quot;);</span>
<span class="nc" id="L410">                System.out.println(&quot;\t\t\t\tUnixNumericGroupPrincipal(s),&quot;);</span>
<span class="nc" id="L411">                System.out.println(&quot;\t\t\t to Subject&quot;);</span>
            }
        }
        // in any case, clean out state
<span class="nc" id="L415">        cleanState();</span>
<span class="nc" id="L416">        commitSucceeded = true;</span>
<span class="nc" id="L417">        return true;</span>
    }

    /**
     * &lt;p&gt; This method is called if the LoginContext's
     * overall authentication failed.
     * (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL LoginModules
     * did not succeed).
     *
     * &lt;p&gt; If this LoginModule's own authentication attempt
     * succeeded (checked by retrieving the private state saved by the
     * &lt;code&gt;login&lt;/code&gt; and &lt;code&gt;commit&lt;/code&gt; methods),
     * then this method cleans up any state that was originally saved.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the abort fails.
     *
     * @return false if this LoginModule's own login and/or commit attempts
     *          failed, and true otherwise.
     */
    public boolean abort() throws LoginException {
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (debug)</span>
<span class="nc" id="L440">            System.out.println(&quot;\t\t[JndiLoginModule]: &quot; +</span>
                &quot;aborted authentication failed&quot;);

<span class="nc bnc" id="L443" title="All 2 branches missed.">        if (succeeded == false) {</span>
<span class="nc" id="L444">            return false;</span>
<span class="nc bnc" id="L445" title="All 4 branches missed.">        } else if (succeeded == true &amp;&amp; commitSucceeded == false) {</span>

            // Clean out state
<span class="nc" id="L448">            succeeded = false;</span>
<span class="nc" id="L449">            cleanState();</span>

<span class="nc" id="L451">            userPrincipal = null;</span>
<span class="nc" id="L452">            UIDPrincipal = null;</span>
<span class="nc" id="L453">            GIDPrincipal = null;</span>
<span class="nc" id="L454">            supplementaryGroups = new LinkedList&lt;UnixNumericGroupPrincipal&gt;();</span>
        } else {
            // overall authentication succeeded and commit succeeded,
            // but someone else's commit failed
<span class="nc" id="L458">            logout();</span>
        }
<span class="nc" id="L460">        return true;</span>
    }

    /**
     * Logout a user.
     *
     * &lt;p&gt; This method removes the Principals
     * that were added by the &lt;code&gt;commit&lt;/code&gt; method.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the logout fails.
     *
     * @return true in all cases since this &lt;code&gt;LoginModule&lt;/code&gt;
     *          should not be ignored.
     */
    public boolean logout() throws LoginException {
<span class="nc bnc" id="L477" title="All 2 branches missed.">        if (subject.isReadOnly()) {</span>
<span class="nc" id="L478">            cleanState();</span>
<span class="nc" id="L479">            throw new LoginException (&quot;Subject is Readonly&quot;);</span>
        }
<span class="nc" id="L481">        subject.getPrincipals().remove(userPrincipal);</span>
<span class="nc" id="L482">        subject.getPrincipals().remove(UIDPrincipal);</span>
<span class="nc" id="L483">        subject.getPrincipals().remove(GIDPrincipal);</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">        for (int i = 0; i &lt; supplementaryGroups.size(); i++) {</span>
<span class="nc" id="L485">            subject.getPrincipals().remove(supplementaryGroups.get(i));</span>
        }


        // clean out state
<span class="nc" id="L490">        cleanState();</span>
<span class="nc" id="L491">        succeeded = false;</span>
<span class="nc" id="L492">        commitSucceeded = false;</span>

<span class="nc" id="L494">        userPrincipal = null;</span>
<span class="nc" id="L495">        UIDPrincipal = null;</span>
<span class="nc" id="L496">        GIDPrincipal = null;</span>
<span class="nc" id="L497">        supplementaryGroups = new LinkedList&lt;UnixNumericGroupPrincipal&gt;();</span>

<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L500">            System.out.println(&quot;\t\t[JndiLoginModule]: &quot; +</span>
                &quot;logged out Subject&quot;);
        }
<span class="nc" id="L503">        return true;</span>
    }

    /**
     * Attempt authentication
     *
     * &lt;p&gt;
     *
     * @param getPasswdFromSharedState boolean that tells this method whether
     *          to retrieve the password from the sharedState.
     */
    private void attemptAuthentication(boolean getPasswdFromSharedState)
    throws LoginException {

<span class="nc" id="L517">        String encryptedPassword = null;</span>

        // first get the username and password
<span class="nc" id="L520">        getUsernamePassword(getPasswdFromSharedState);</span>

        try {

            // get the user's passwd entry from the user provider URL
<span class="nc" id="L525">            InitialContext iCtx = new InitialContext();</span>
<span class="nc" id="L526">            ctx = (DirContext)iCtx.lookup(userProvider);</span>

            /*
            SearchControls controls = new SearchControls
                                        (SearchControls.ONELEVEL_SCOPE,
                                        0,
                                        5000,
                                        new String[] { USER_PWD },
                                        false,
                                        false);
            */

<span class="nc" id="L538">            SearchControls controls = new SearchControls();</span>
<span class="nc" id="L539">            NamingEnumeration&lt;SearchResult&gt; ne = ctx.search(&quot;&quot;,</span>
                                        &quot;(uid=&quot; + username + &quot;)&quot;,
                                        controls);
<span class="nc bnc" id="L542" title="All 2 branches missed.">            if (ne.hasMore()) {</span>
<span class="nc" id="L543">                SearchResult result = ne.next();</span>
<span class="nc" id="L544">                Attributes attributes = result.getAttributes();</span>

                // get the password

                // this module works only if the LDAP directory server
                // is configured to permit read access to the userPassword
                // attribute. The directory administrator need to grant
                // this access.
                //
                // A workaround would be to make the server do authentication
                // by setting the Context.SECURITY_PRINCIPAL
                // and Context.SECURITY_CREDENTIALS property.
                // However, this would make it not work with systems that
                // don't do authentication at the server (like NIS).
                //
                // Setting the SECURITY_* properties and using &quot;simple&quot;
                // authentication for LDAP is recommended only for secure
                // channels. For nonsecure channels, SSL is recommended.

<span class="nc" id="L563">                Attribute pwd = attributes.get(USER_PWD);</span>
<span class="nc" id="L564">                String encryptedPwd = new String((byte[])pwd.get(), &quot;UTF8&quot;);</span>
<span class="nc" id="L565">                encryptedPassword = encryptedPwd.substring(CRYPT.length());</span>

                // check the password
<span class="nc" id="L568">                if (verifyPassword</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">                    (encryptedPassword, new String(password)) == true) {</span>

                    // authentication succeeded
<span class="nc bnc" id="L572" title="All 2 branches missed.">                    if (debug)</span>
<span class="nc" id="L573">                        System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;attemptAuthentication() succeeded&quot;);

                } else {
                    // authentication failed
<span class="nc bnc" id="L578" title="All 2 branches missed.">                    if (debug)</span>
<span class="nc" id="L579">                        System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;attemptAuthentication() failed&quot;);
<span class="nc" id="L581">                    throw new FailedLoginException(&quot;Login incorrect&quot;);</span>
                }

                // save input as shared state only if
                // authentication succeeded
<span class="nc bnc" id="L586" title="All 2 branches missed.">                if (storePass &amp;&amp;</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">                    !sharedState.containsKey(NAME) &amp;&amp;</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">                    !sharedState.containsKey(PWD)) {</span>
<span class="nc" id="L589">                    sharedState.put(NAME, username);</span>
<span class="nc" id="L590">                    sharedState.put(PWD, password);</span>
                }

                // create the user principal
<span class="nc" id="L594">                userPrincipal = new UnixPrincipal(username);</span>

                // get the UID
<span class="nc" id="L597">                Attribute uid = attributes.get(USER_UID);</span>
<span class="nc" id="L598">                String uidNumber = (String)uid.get();</span>
<span class="nc" id="L599">                UIDPrincipal = new UnixNumericUserPrincipal(uidNumber);</span>
<span class="nc bnc" id="L600" title="All 4 branches missed.">                if (debug &amp;&amp; uidNumber != null) {</span>
<span class="nc" id="L601">                    System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;user: '&quot; + username + &quot;' has UID: &quot; +
                                uidNumber);
                }

                // get the GID
<span class="nc" id="L607">                Attribute gid = attributes.get(USER_GID);</span>
<span class="nc" id="L608">                String gidNumber = (String)gid.get();</span>
<span class="nc" id="L609">                GIDPrincipal = new UnixNumericGroupPrincipal</span>
                                (gidNumber, true);
<span class="nc bnc" id="L611" title="All 4 branches missed.">                if (debug &amp;&amp; gidNumber != null) {</span>
<span class="nc" id="L612">                    System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;user: '&quot; + username + &quot;' has GID: &quot; +
                                gidNumber);
                }

                // get the supplementary groups from the group provider URL
<span class="nc" id="L618">                ctx = (DirContext)iCtx.lookup(groupProvider);</span>
<span class="nc" id="L619">                ne = ctx.search(&quot;&quot;, new BasicAttributes(&quot;memberUid&quot;, username));</span>

<span class="nc bnc" id="L621" title="All 2 branches missed.">                while (ne.hasMore()) {</span>
<span class="nc" id="L622">                    result = ne.next();</span>
<span class="nc" id="L623">                    attributes = result.getAttributes();</span>

<span class="nc" id="L625">                    gid = attributes.get(GROUP_ID);</span>
<span class="nc" id="L626">                    String suppGid = (String)gid.get();</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                    if (!gidNumber.equals(suppGid)) {</span>
<span class="nc" id="L628">                        UnixNumericGroupPrincipal suppPrincipal =</span>
                            new UnixNumericGroupPrincipal(suppGid, false);
<span class="nc" id="L630">                        supplementaryGroups.add(suppPrincipal);</span>
<span class="nc bnc" id="L631" title="All 4 branches missed.">                        if (debug &amp;&amp; suppGid != null) {</span>
<span class="nc" id="L632">                            System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;user: '&quot; + username +
                                &quot;' has Supplementary Group: &quot; +
                                suppGid);
                        }
                    }
<span class="nc" id="L638">                }</span>

<span class="nc" id="L640">            } else {</span>
                // bad username
<span class="nc bnc" id="L642" title="All 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L643">                    System.out.println(&quot;\t\t[JndiLoginModule]: User not found&quot;);</span>
                }
<span class="nc" id="L645">                throw new FailedLoginException(&quot;User not found&quot;);</span>
            }
<span class="nc" id="L647">        } catch (NamingException ne) {</span>
            // bad username
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L650">                System.out.println(&quot;\t\t[JndiLoginModule]:  User not found&quot;);</span>
<span class="nc" id="L651">                ne.printStackTrace();</span>
            }
<span class="nc" id="L653">            throw new FailedLoginException(&quot;User not found&quot;);</span>
<span class="nc" id="L654">        } catch (java.io.UnsupportedEncodingException uee) {</span>
            // password stored in incorrect format
<span class="nc bnc" id="L656" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L657">                System.out.println(&quot;\t\t[JndiLoginModule]:  &quot; +</span>
                                &quot;password incorrectly encoded&quot;);
<span class="nc" id="L659">                uee.printStackTrace();</span>
            }
<span class="nc" id="L661">            throw new LoginException(&quot;Login failure due to incorrect &quot; +</span>
                                &quot;password encoding in the password database&quot;);
<span class="nc" id="L663">        }</span>

        // authentication succeeded
<span class="nc" id="L666">    }</span>

    /**
     * Get the username and password.
     * This method does not return any value.
     * Instead, it sets global name and password variables.
     *
     * &lt;p&gt; Also note that this method will set the username and password
     * values in the shared state in case subsequent LoginModules
     * want to use them via use/tryFirstPass.
     *
     * &lt;p&gt;
     *
     * @param getPasswdFromSharedState boolean that tells this method whether
     *          to retrieve the password from the sharedState.
     */
    private void getUsernamePassword(boolean getPasswdFromSharedState)
    throws LoginException {

<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (getPasswdFromSharedState) {</span>
            // use the password saved by the first module in the stack
<span class="nc" id="L687">            username = (String)sharedState.get(NAME);</span>
<span class="nc" id="L688">            password = (char[])sharedState.get(PWD);</span>
<span class="nc" id="L689">            return;</span>
        }

        // prompt for a username and password
<span class="nc bnc" id="L693" title="All 2 branches missed.">        if (callbackHandler == null)</span>
<span class="nc" id="L694">            throw new LoginException(&quot;Error: no CallbackHandler available &quot; +</span>
                &quot;to garner authentication information from the user&quot;);

<span class="nc" id="L697">        String protocol = userProvider.substring(0, userProvider.indexOf(&quot;:&quot;));</span>

<span class="nc" id="L699">        Callback[] callbacks = new Callback[2];</span>
<span class="nc" id="L700">        callbacks[0] = new NameCallback(protocol + &quot; &quot;</span>
<span class="nc" id="L701">                                            + rb.getString(&quot;username.&quot;));</span>
<span class="nc" id="L702">        callbacks[1] = new PasswordCallback(protocol + &quot; &quot; +</span>
<span class="nc" id="L703">                                                rb.getString(&quot;password.&quot;),</span>
                                            false);

        try {
<span class="nc" id="L707">            callbackHandler.handle(callbacks);</span>
<span class="nc" id="L708">            username = ((NameCallback)callbacks[0]).getName();</span>
<span class="nc" id="L709">            char[] tmpPassword = ((PasswordCallback)callbacks[1]).getPassword();</span>
<span class="nc" id="L710">            password = new char[tmpPassword.length];</span>
<span class="nc" id="L711">            System.arraycopy(tmpPassword, 0,</span>
                                password, 0, tmpPassword.length);
<span class="nc" id="L713">            ((PasswordCallback)callbacks[1]).clearPassword();</span>

<span class="nc" id="L715">        } catch (java.io.IOException ioe) {</span>
<span class="nc" id="L716">            throw new LoginException(ioe.toString());</span>
<span class="nc" id="L717">        } catch (UnsupportedCallbackException uce) {</span>
<span class="nc" id="L718">            throw new LoginException(&quot;Error: &quot; + uce.getCallback().toString() +</span>
                        &quot; not available to garner authentication information &quot; +
                        &quot;from the user&quot;);
<span class="nc" id="L721">        }</span>

        // print debugging information
<span class="nc bnc" id="L724" title="All 2 branches missed.">        if (strongDebug) {</span>
<span class="nc" id="L725">            System.out.println(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;user entered username: &quot; +
                                username);
<span class="nc" id="L728">            System.out.print(&quot;\t\t[JndiLoginModule] &quot; +</span>
                                &quot;user entered password: &quot;);
<span class="nc bnc" id="L730" title="All 2 branches missed.">            for (int i = 0; i &lt; password.length; i++)</span>
<span class="nc" id="L731">                System.out.print(password[i]);</span>
<span class="nc" id="L732">            System.out.println();</span>
        }
<span class="nc" id="L734">    }</span>

    /**
     * Verify a password against the encrypted passwd from /etc/shadow
     */
    private boolean verifyPassword(String encryptedPassword, String password) {

<span class="nc bnc" id="L741" title="All 2 branches missed.">        if (encryptedPassword == null)</span>
<span class="nc" id="L742">            return false;</span>

<span class="nc" id="L744">        Crypt c = new Crypt();</span>
        try {
<span class="nc" id="L746">            byte oldCrypt[] = encryptedPassword.getBytes(&quot;UTF8&quot;);</span>
<span class="nc" id="L747">            byte newCrypt[] = c.crypt(password.getBytes(&quot;UTF8&quot;),</span>
                                      oldCrypt);
<span class="nc bnc" id="L749" title="All 2 branches missed.">            if (newCrypt.length != oldCrypt.length)</span>
<span class="nc" id="L750">                return false;</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">            for (int i = 0; i &lt; newCrypt.length; i++) {</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">                if (oldCrypt[i] != newCrypt[i])</span>
<span class="nc" id="L753">                    return false;</span>
            }
<span class="nc" id="L755">        } catch (java.io.UnsupportedEncodingException uee) {</span>
            // cannot happen, but return false just to be safe
<span class="nc" id="L757">            return false;</span>
<span class="nc" id="L758">        }</span>
<span class="nc" id="L759">        return true;</span>
    }

    /**
     * Clean out state because of a failed authentication attempt
     */
    private void cleanState() {
<span class="nc" id="L766">        username = null;</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">        if (password != null) {</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">            for (int i = 0; i &lt; password.length; i++)</span>
<span class="nc" id="L769">                password[i] = ' ';</span>
<span class="nc" id="L770">            password = null;</span>
        }
<span class="nc" id="L772">        ctx = null;</span>

<span class="nc bnc" id="L774" title="All 2 branches missed.">        if (clearPass) {</span>
<span class="nc" id="L775">            sharedState.remove(NAME);</span>
<span class="nc" id="L776">            sharedState.remove(PWD);</span>
        }
<span class="nc" id="L778">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>