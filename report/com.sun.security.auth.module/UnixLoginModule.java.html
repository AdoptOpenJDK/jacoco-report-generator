<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UnixLoginModule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.security.auth.module</a> &gt; <span class="el_source">UnixLoginModule.java</span></div><h1>UnixLoginModule.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.security.auth.module;

import java.util.*;
import java.io.IOException;
import javax.security.auth.*;
import javax.security.auth.callback.*;
import javax.security.auth.login.*;
import javax.security.auth.spi.*;
import com.sun.security.auth.UnixPrincipal;
import com.sun.security.auth.UnixNumericUserPrincipal;
import com.sun.security.auth.UnixNumericGroupPrincipal;

/**
 * &lt;p&gt; This &lt;code&gt;LoginModule&lt;/code&gt; imports a user's Unix
 * &lt;code&gt;Principal&lt;/code&gt; information (&lt;code&gt;UnixPrincipal&lt;/code&gt;,
 * &lt;code&gt;UnixNumericUserPrincipal&lt;/code&gt;,
 * and &lt;code&gt;UnixNumericGroupPrincipal&lt;/code&gt;)
 * and associates them with the current &lt;code&gt;Subject&lt;/code&gt;.
 *
 * &lt;p&gt; This LoginModule recognizes the debug option.
 * If set to true in the login Configuration,
 * debug messages will be output to the output stream, System.out.
 *
 */
@jdk.Exported
<span class="nc" id="L51">public class UnixLoginModule implements LoginModule {</span>

    // initial state
    private Subject subject;
    private CallbackHandler callbackHandler;
    private Map&lt;String, ?&gt; sharedState;
    private Map&lt;String, ?&gt; options;

    // configurable option
<span class="nc" id="L60">    private boolean debug = true;</span>

    // UnixSystem to retrieve underlying system info
    private UnixSystem ss;

    // the authentication status
<span class="nc" id="L66">    private boolean succeeded = false;</span>
<span class="nc" id="L67">    private boolean commitSucceeded = false;</span>

    // Underlying system info
    private UnixPrincipal userPrincipal;
    private UnixNumericUserPrincipal UIDPrincipal;
    private UnixNumericGroupPrincipal GIDPrincipal;
<span class="nc" id="L73">    private LinkedList&lt;UnixNumericGroupPrincipal&gt; supplementaryGroups =</span>
                new LinkedList&lt;&gt;();

    /**
     * Initialize this &lt;code&gt;LoginModule&lt;/code&gt;.
     *
     * &lt;p&gt;
     *
     * @param subject the &lt;code&gt;Subject&lt;/code&gt; to be authenticated. &lt;p&gt;
     *
     * @param callbackHandler a &lt;code&gt;CallbackHandler&lt;/code&gt; for communicating
     *                  with the end user (prompting for usernames and
     *                  passwords, for example). &lt;p&gt;
     *
     * @param sharedState shared &lt;code&gt;LoginModule&lt;/code&gt; state. &lt;p&gt;
     *
     * @param options options specified in the login
     *                  &lt;code&gt;Configuration&lt;/code&gt; for this particular
     *                  &lt;code&gt;LoginModule&lt;/code&gt;.
     */
    public void initialize(Subject subject, CallbackHandler callbackHandler,
                           Map&lt;String,?&gt; sharedState,
                           Map&lt;String,?&gt; options) {

<span class="nc" id="L97">        this.subject = subject;</span>
<span class="nc" id="L98">        this.callbackHandler = callbackHandler;</span>
<span class="nc" id="L99">        this.sharedState = sharedState;</span>
<span class="nc" id="L100">        this.options = options;</span>

        // initialize any configured options
<span class="nc" id="L103">        debug = &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;debug&quot;));</span>
<span class="nc" id="L104">    }</span>

    /**
     * Authenticate the user (first phase).
     *
     * &lt;p&gt; The implementation of this method attempts to retrieve the user's
     * Unix &lt;code&gt;Subject&lt;/code&gt; information by making a native Unix
     * system call.
     *
     * &lt;p&gt;
     *
     * @exception FailedLoginException if attempts to retrieve the underlying
     *          system information fail.
     *
     * @return true in all cases (this &lt;code&gt;LoginModule&lt;/code&gt;
     *          should not be ignored).
     */
    public boolean login() throws LoginException {

<span class="nc" id="L123">        long[] unixGroups = null;</span>

<span class="nc" id="L125">        ss = new UnixSystem();</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (ss == null) {</span>
<span class="nc" id="L128">            succeeded = false;</span>
<span class="nc" id="L129">            throw new FailedLoginException</span>
                                (&quot;Failed in attempt to import &quot; +
                                &quot;the underlying system identity information&quot;);
        } else {
<span class="nc" id="L133">            userPrincipal = new UnixPrincipal(ss.getUsername());</span>
<span class="nc" id="L134">            UIDPrincipal = new UnixNumericUserPrincipal(ss.getUid());</span>
<span class="nc" id="L135">            GIDPrincipal = new UnixNumericGroupPrincipal(ss.getGid(), true);</span>
<span class="nc bnc" id="L136" title="All 4 branches missed.">            if (ss.getGroups() != null &amp;&amp; ss.getGroups().length &gt; 0) {</span>
<span class="nc" id="L137">                unixGroups = ss.getGroups();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                for (int i = 0; i &lt; unixGroups.length; i++) {</span>
<span class="nc" id="L139">                    UnixNumericGroupPrincipal ngp =</span>
                        new UnixNumericGroupPrincipal
                        (unixGroups[i], false);
<span class="nc bnc" id="L142" title="All 2 branches missed.">                    if (!ngp.getName().equals(GIDPrincipal.getName()))</span>
<span class="nc" id="L143">                        supplementaryGroups.add(ngp);</span>
                }
            }
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L147">                System.out.println(&quot;\t\t[UnixLoginModule]: &quot; +</span>
                        &quot;succeeded importing info: &quot;);
<span class="nc" id="L149">                System.out.println(&quot;\t\t\tuid = &quot; + ss.getUid());</span>
<span class="nc" id="L150">                System.out.println(&quot;\t\t\tgid = &quot; + ss.getGid());</span>
<span class="nc" id="L151">                unixGroups = ss.getGroups();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                for (int i = 0; i &lt; unixGroups.length; i++) {</span>
<span class="nc" id="L153">                    System.out.println(&quot;\t\t\tsupp gid = &quot; + unixGroups[i]);</span>
                }
            }
<span class="nc" id="L156">            succeeded = true;</span>
<span class="nc" id="L157">            return true;</span>
        }
    }

    /**
     * Commit the authentication (second phase).
     *
     * &lt;p&gt; This method is called if the LoginContext's
     * overall authentication succeeded
     * (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL LoginModules
     * succeeded).
     *
     * &lt;p&gt; If this LoginModule's own authentication attempt
     * succeeded (the importing of the Unix authentication information
     * succeeded), then this method associates the Unix Principals
     * with the &lt;code&gt;Subject&lt;/code&gt; currently tied to the
     * &lt;code&gt;LoginModule&lt;/code&gt;.  If this LoginModule's
     * authentication attempted failed, then this method removes
     * any state that was originally saved.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the commit fails
     *
     * @return true if this LoginModule's own login and commit attempts
     *          succeeded, or false otherwise.
     */
    public boolean commit() throws LoginException {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (succeeded == false) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L187">                System.out.println(&quot;\t\t[UnixLoginModule]: &quot; +</span>
                    &quot;did not add any Principals to Subject &quot; +
                    &quot;because own authentication failed.&quot;);
            }
<span class="nc" id="L191">            return false;</span>
        } else {
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (subject.isReadOnly()) {</span>
<span class="nc" id="L194">                throw new LoginException</span>
                    (&quot;commit Failed: Subject is Readonly&quot;);
            }
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (!subject.getPrincipals().contains(userPrincipal))</span>
<span class="nc" id="L198">                subject.getPrincipals().add(userPrincipal);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if (!subject.getPrincipals().contains(UIDPrincipal))</span>
<span class="nc" id="L200">                subject.getPrincipals().add(UIDPrincipal);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (!subject.getPrincipals().contains(GIDPrincipal))</span>
<span class="nc" id="L202">                subject.getPrincipals().add(GIDPrincipal);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            for (int i = 0; i &lt; supplementaryGroups.size(); i++) {</span>
<span class="nc" id="L204">                if (!subject.getPrincipals().contains</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                    (supplementaryGroups.get(i)))</span>
<span class="nc" id="L206">                    subject.getPrincipals().add(supplementaryGroups.get(i));</span>
            }

<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L210">                System.out.println(&quot;\t\t[UnixLoginModule]: &quot; +</span>
                    &quot;added UnixPrincipal,&quot;);
<span class="nc" id="L212">                System.out.println(&quot;\t\t\t\tUnixNumericUserPrincipal,&quot;);</span>
<span class="nc" id="L213">                System.out.println(&quot;\t\t\t\tUnixNumericGroupPrincipal(s),&quot;);</span>
<span class="nc" id="L214">                System.out.println(&quot;\t\t\t to Subject&quot;);</span>
            }

<span class="nc" id="L217">            commitSucceeded = true;</span>
<span class="nc" id="L218">            return true;</span>
        }
    }

    /**
     * Abort the authentication (second phase).
     *
     * &lt;p&gt; This method is called if the LoginContext's
     * overall authentication failed.
     * (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL LoginModules
     * did not succeed).
     *
     * &lt;p&gt; This method cleans up any state that was originally saved
     * as part of the authentication attempt from the &lt;code&gt;login&lt;/code&gt;
     * and &lt;code&gt;commit&lt;/code&gt; methods.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the abort fails
     *
     * @return false if this LoginModule's own login and/or commit attempts
     *          failed, and true otherwise.
     */
    public boolean abort() throws LoginException {
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L243">            System.out.println(&quot;\t\t[UnixLoginModule]: &quot; +</span>
                &quot;aborted authentication attempt&quot;);
        }

<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (succeeded == false) {</span>
<span class="nc" id="L248">            return false;</span>
<span class="nc bnc" id="L249" title="All 4 branches missed.">        } else if (succeeded == true &amp;&amp; commitSucceeded == false) {</span>

            // Clean out state
<span class="nc" id="L252">            succeeded = false;</span>
<span class="nc" id="L253">            ss = null;</span>
<span class="nc" id="L254">            userPrincipal = null;</span>
<span class="nc" id="L255">            UIDPrincipal = null;</span>
<span class="nc" id="L256">            GIDPrincipal = null;</span>
<span class="nc" id="L257">            supplementaryGroups = new LinkedList&lt;UnixNumericGroupPrincipal&gt;();</span>
        } else {
            // overall authentication succeeded and commit succeeded,
            // but someone else's commit failed
<span class="nc" id="L261">            logout();</span>
        }
<span class="nc" id="L263">        return true;</span>
    }

    /**
     * Logout the user
     *
     * &lt;p&gt; This method removes the Principals associated
     * with the &lt;code&gt;Subject&lt;/code&gt;.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the logout fails
     *
     * @return true in all cases (this &lt;code&gt;LoginModule&lt;/code&gt;
     *          should not be ignored).
     */
    public boolean logout() throws LoginException {

<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (subject.isReadOnly()) {</span>
<span class="nc" id="L282">                throw new LoginException</span>
                    (&quot;logout Failed: Subject is Readonly&quot;);
            }
        // remove the added Principals from the Subject
<span class="nc" id="L286">        subject.getPrincipals().remove(userPrincipal);</span>
<span class="nc" id="L287">        subject.getPrincipals().remove(UIDPrincipal);</span>
<span class="nc" id="L288">        subject.getPrincipals().remove(GIDPrincipal);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">        for (int i = 0; i &lt; supplementaryGroups.size(); i++) {</span>
<span class="nc" id="L290">            subject.getPrincipals().remove(supplementaryGroups.get(i));</span>
        }

        // clean out state
<span class="nc" id="L294">        ss = null;</span>
<span class="nc" id="L295">        succeeded = false;</span>
<span class="nc" id="L296">        commitSucceeded = false;</span>
<span class="nc" id="L297">        userPrincipal = null;</span>
<span class="nc" id="L298">        UIDPrincipal = null;</span>
<span class="nc" id="L299">        GIDPrincipal = null;</span>
<span class="nc" id="L300">        supplementaryGroups = new LinkedList&lt;UnixNumericGroupPrincipal&gt;();</span>

<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L303">            System.out.println(&quot;\t\t[UnixLoginModule]: &quot; +</span>
                &quot;logged out Subject&quot;);
        }
<span class="nc" id="L306">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>