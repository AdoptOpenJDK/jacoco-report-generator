<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Krb5LoginModule.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.security.auth.module</a> &gt; <span class="el_source">Krb5LoginModule.java</span></div><h1>Krb5LoginModule.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */


package com.sun.security.auth.module;

import java.io.*;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.text.MessageFormat;
import java.util.*;

import javax.security.auth.*;
import javax.security.auth.kerberos.*;
import javax.security.auth.callback.*;
import javax.security.auth.login.*;
import javax.security.auth.spi.*;

import sun.security.krb5.*;
import sun.security.jgss.krb5.Krb5Util;
import sun.security.krb5.Credentials;
import sun.misc.HexDumpEncoder;

/**
 * &lt;p&gt; This &lt;code&gt;LoginModule&lt;/code&gt; authenticates users using
 * Kerberos protocols.
 *
 * &lt;p&gt; The configuration entry for &lt;code&gt;Krb5LoginModule&lt;/code&gt; has
 * several options that control the authentication process and
 * additions to the &lt;code&gt;Subject&lt;/code&gt;'s private credential
 * set. Irrespective of these options, the &lt;code&gt;Subject&lt;/code&gt;'s
 * principal set and private credentials set are updated only when
 * &lt;code&gt;commit&lt;/code&gt; is called.
 * When &lt;code&gt;commit&lt;/code&gt; is called, the &lt;code&gt;KerberosPrincipal&lt;/code&gt;
 * is added to the &lt;code&gt;Subject&lt;/code&gt;'s principal set (unless the
 * &lt;code&gt;principal&lt;/code&gt; is specified as &quot;*&quot;). If &lt;code&gt;isInitiator&lt;/code&gt;
 * is true, the &lt;code&gt;KerberosTicket&lt;/code&gt; is
 * added to the &lt;code&gt;Subject&lt;/code&gt;'s private credentials.
 *
 * &lt;p&gt; If the configuration entry for &lt;code&gt;KerberosLoginModule&lt;/code&gt;
 * has the option &lt;code&gt;storeKey&lt;/code&gt; set to true, then
 * &lt;code&gt;KerberosKey&lt;/code&gt; or &lt;code&gt;KeyTab&lt;/code&gt; will also be added to the
 * subject's private credentials. &lt;code&gt;KerberosKey&lt;/code&gt;, the principal's
 * key(s) will be derived from user's password, and &lt;code&gt;KeyTab&lt;/code&gt; is
 * the keytab used when &lt;code&gt;useKeyTab&lt;/code&gt; is set to true. The
 * &lt;code&gt;KeyTab&lt;/code&gt; object is restricted to be used by the specified
 * principal unless the principal value is &quot;*&quot;.
 *
 * &lt;p&gt; This &lt;code&gt;LoginModule&lt;/code&gt; recognizes the &lt;code&gt;doNotPrompt&lt;/code&gt;
 * option. If set to true the user will not be prompted for the password.
 *
 * &lt;p&gt; The user can  specify the location of the ticket cache by using
 * the option &lt;code&gt;ticketCache&lt;/code&gt; in the configuration entry.
 *
 * &lt;p&gt;The user can specify the keytab location by using
 * the option &lt;code&gt;keyTab&lt;/code&gt;
 * in the configuration entry.
 *
 * &lt;p&gt; The principal name can be specified in the configuration entry
 * by using the option &lt;code&gt;principal&lt;/code&gt;. The principal name
 * can either be a simple user name, a service name such as
 * &lt;code&gt;host/mission.eng.sun.com&lt;/code&gt;, or &quot;*&quot;. The principal can also
 * be set using the system property &lt;code&gt;sun.security.krb5.principal&lt;/code&gt;.
 * This property is checked during login. If this property is not set, then
 * the principal name from the configuration is used. In the
 * case where the principal property is not set and the principal
 * entry also does not exist, the user is prompted for the name.
 * When this property of entry is set, and &lt;code&gt;useTicketCache&lt;/code&gt;
 * is set to true, only TGT belonging to this principal is used.
 *
 * &lt;p&gt; The following is a list of configuration options supported
 * for &lt;code&gt;Krb5LoginModule&lt;/code&gt;:
 * &lt;blockquote&gt;&lt;dl&gt;
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;refreshKrb5Config&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt; Set this to true, if you want the configuration
 * to be refreshed before the &lt;code&gt;login&lt;/code&gt; method is called.&lt;/dd&gt;
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;useTicketCache&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt;Set this to true, if you want the
 * TGT to be obtained
 * from the ticket cache. Set this option
 * to false if you do not want this module to use the ticket cache.
 * (Default is False).
 * This module will
 * search for the ticket
 * cache in the following locations:
 * On Solaris and Linux
 * it will look for the ticket cache in /tmp/krb5cc_&lt;code&gt;uid&lt;/code&gt;
 * where the uid is numeric user
 * identifier. If the ticket cache is
 * not available in the above location, or if we are on a
 * Windows platform, it will look for the cache as
 * {user.home}{file.separator}krb5cc_{user.name}.
 * You can override the ticket cache location by using
 * &lt;code&gt;ticketCache&lt;/code&gt;.
 * For Windows, if a ticket cannot be retrieved from the file ticket cache,
 * it will use Local Security Authority (LSA) API to get the TGT.
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;ticketCache&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt;Set this to the name of the ticket
 * cache that  contains user's TGT.
 * If this is set,  &lt;code&gt;useTicketCache&lt;/code&gt;
 * must also be set to true; Otherwise a configuration error will
 * be returned.&lt;/dd&gt;
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;renewTGT&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt;Set this to true, if you want to renew
 * the TGT. If this is set, &lt;code&gt;useTicketCache&lt;/code&gt; must also be
 * set to true; otherwise a configuration error will be returned.&lt;/dd&gt;
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;doNotPrompt&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt;Set this to true if you do not want to be
 * prompted for the password
 * if credentials can not be obtained from the cache, the keytab,
 * or through shared state.(Default is false)
 * If set to true, credential must be obtained through cache, keytab,
 * or shared state. Otherwise, authentication will fail.&lt;/dd&gt;
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;useKeyTab&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt;Set this to true if you
 * want the module to get the principal's key from the
 * the keytab.(default value is False)
 * If &lt;code&gt;keytab&lt;/code&gt;
 * is not set then
 * the module will locate the keytab from the
 * Kerberos configuration file.
 * If it is not specified in the Kerberos configuration file
 * then it will look for the file
 * &lt;code&gt;{user.home}{file.separator}&lt;/code&gt;krb5.keytab.&lt;/dd&gt;
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;keyTab&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt;Set this to the file name of the
 * keytab to get principal's secret key.&lt;/dd&gt;
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;storeKey&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt;Set this to true to if you want the keytab or the
 * principal's key to be stored in the Subject's private credentials.
 * For &lt;code&gt;isInitiator&lt;/code&gt; being false, if &lt;code&gt;principal&lt;/code&gt;
 * is &quot;*&quot;, the {@link KeyTab} stored can be used by anyone, otherwise,
 * it's restricted to be used by the specified principal only.&lt;/dd&gt;
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;principal&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt;The name of the principal that should
 * be used. The principal can be a simple username such as
 * &quot;&lt;code&gt;testuser&lt;/code&gt;&quot; or a service name such as
 * &quot;&lt;code&gt;host/testhost.eng.sun.com&lt;/code&gt;&quot;. You can use the
 * &lt;code&gt;principal&lt;/code&gt;  option to set the principal when there are
 * credentials for multiple principals in the
 * &lt;code&gt;keyTab&lt;/code&gt; or when you want a specific ticket cache only.
 * The principal can also be set using the system property
 * &lt;code&gt;sun.security.krb5.principal&lt;/code&gt;. In addition, if this
 * system property is defined, then it will be used. If this property
 * is not set, then the principal name from the configuration will be
 * used.
 * The principal name can be set to &quot;*&quot; when &lt;code&gt;isInitiator&lt;/code&gt; is false.
 * In this case, the acceptor is not bound to a single principal. It can
 * act as any principal an initiator requests if keys for that principal
 * can be found. When &lt;code&gt;isInitiator&lt;/code&gt; is true, the principal name
 * cannot be set to &quot;*&quot;.
 * &lt;/dd&gt;
 * &lt;dt&gt;&lt;b&gt;&lt;code&gt;isInitiator&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 * &lt;dd&gt;Set this to true, if initiator. Set this to false, if acceptor only.
 * (Default is true).
 * Note: Do not set this value to false for initiators.&lt;/dd&gt;
 * &lt;/dl&gt;&lt;/blockquote&gt;
 *
 * &lt;p&gt; This &lt;code&gt;LoginModule&lt;/code&gt; also recognizes the following additional
 * &lt;code&gt;Configuration&lt;/code&gt;
 * options that enable you to share username and passwords across different
 * authentication modules:
 * &lt;blockquote&gt;&lt;dl&gt;
 *
 *    &lt;dt&gt;&lt;b&gt;&lt;code&gt;useFirstPass&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 *                   &lt;dd&gt;if, true, this LoginModule retrieves the
 *                   username and password from the module's shared state,
 *                   using &quot;javax.security.auth.login.name&quot; and
 *                   &quot;javax.security.auth.login.password&quot; as the respective
 *                   keys. The retrieved values are used for authentication.
 *                   If authentication fails, no attempt for a retry
 *                   is made, and the failure is reported back to the
 *                   calling application.&lt;/dd&gt;
 *
 *    &lt;dt&gt;&lt;b&gt;&lt;code&gt;tryFirstPass&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 *                   &lt;dd&gt;if, true, this LoginModule retrieves the
 *                   the username and password from the module's shared
 *                   state using &quot;javax.security.auth.login.name&quot; and
 *                   &quot;javax.security.auth.login.password&quot; as the respective
 *                   keys.  The retrieved values are used for
 *                   authentication.
 *                   If authentication fails, the module uses the
 *                   CallbackHandler to retrieve a new username
 *                   and password, and another attempt to authenticate
 *                   is made. If the authentication fails,
 *                   the failure is reported back to the calling application&lt;/dd&gt;
 *
 *    &lt;dt&gt;&lt;b&gt;&lt;code&gt;storePass&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 *                   &lt;dd&gt;if, true, this LoginModule stores the username and
 *                   password obtained from the CallbackHandler in the
 *                   modules shared state, using
 *                   &quot;javax.security.auth.login.name&quot; and
 *                   &quot;javax.security.auth.login.password&quot; as the respective
 *                   keys.  This is not performed if existing values already
 *                   exist for the username and password in the shared
 *                   state, or if authentication fails.&lt;/dd&gt;
 *
 *    &lt;dt&gt;&lt;b&gt;&lt;code&gt;clearPass&lt;/code&gt;&lt;/b&gt;:&lt;/dt&gt;
 *                   &lt;dd&gt;if, true, this LoginModule clears the
 *                   username and password stored in the module's shared
 *                   state  after both phases of authentication
 *                   (login and commit) have completed.&lt;/dd&gt;
 * &lt;/dl&gt;&lt;/blockquote&gt;
 * &lt;p&gt;If the principal system property or key is already provided, the value of
 * &quot;javax.security.auth.login.name&quot; in the shared state is ignored.
 * &lt;p&gt;When multiple mechanisms to retrieve a ticket or key is provided, the
 * preference order is:
 * &lt;ol&gt;
 * &lt;li&gt;ticket cache
 * &lt;li&gt;keytab
 * &lt;li&gt;shared state
 * &lt;li&gt;user prompt
 * &lt;/ol&gt;
 * &lt;p&gt;Note that if any step fails, it will fallback to the next step.
 * There's only one exception, if the shared state step fails and
 * &lt;code&gt;useFirstPass&lt;/code&gt;=true, no user prompt is made.
 * &lt;p&gt;Examples of some configuration values for Krb5LoginModule in
 * JAAS config file and the results are:
 * &lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;doNotPrompt&lt;/code&gt;=true;
 * &lt;/ul&gt;
 * &lt;p&gt; This is an illegal combination since none of &lt;code&gt;useTicketCache&lt;/code&gt;,
 * &lt;code&gt;useKeyTab&lt;/code&gt;, &lt;code&gt;useFirstPass&lt;/code&gt; and &lt;code&gt;tryFirstPass&lt;/code&gt;
 * is set and the user can not be prompted for the password.
 *&lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;ticketCache&lt;/code&gt; = &amp;lt;filename&amp;gt;;
 *&lt;/ul&gt;
 * &lt;p&gt; This is an illegal combination since &lt;code&gt;useTicketCache&lt;/code&gt;
 * is not set to true and the ticketCache is set. A configuration error
 * will occur.
 * &lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;renewTGT&lt;/code&gt;=true;
 *&lt;/ul&gt;
 * &lt;p&gt; This is an illegal combination since &lt;code&gt;useTicketCache&lt;/code&gt; is
 * not set to true and renewTGT is set. A configuration error will occur.
 * &lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;storeKey&lt;/code&gt;=true
 * &lt;code&gt;useTicketCache&lt;/code&gt; = true
 * &lt;code&gt;doNotPrompt&lt;/code&gt;=true;;
 *&lt;/ul&gt;
 * &lt;p&gt; This is an illegal combination since  &lt;code&gt;storeKey&lt;/code&gt; is set to
 * true but the key can not be obtained either by prompting the user or from
 * the keytab, or from the shared state. A configuration error will occur.
 * &lt;ul&gt;
 * &lt;p&gt;  &lt;code&gt;keyTab&lt;/code&gt; = &amp;lt;filename&amp;gt; &lt;code&gt;doNotPrompt&lt;/code&gt;=true ;
 * &lt;/ul&gt;
 * &lt;p&gt;This is an illegal combination since useKeyTab is not set to true and
 * the keyTab is set. A configuration error will occur.
 * &lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;debug=true &lt;/code&gt;
 *&lt;/ul&gt;
 * &lt;p&gt; Prompt the user for the principal name and the password.
 * Use the authentication exchange to get TGT from the KDC and
 * populate the &lt;code&gt;Subject&lt;/code&gt; with the principal and TGT.
 * Output debug messages.
 * &lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;useTicketCache&lt;/code&gt; = true &lt;code&gt;doNotPrompt&lt;/code&gt;=true;
 *&lt;/ul&gt;
 * &lt;p&gt;Check the default cache for TGT and populate the &lt;code&gt;Subject&lt;/code&gt;
 * with the principal and TGT. If the TGT is not available,
 * do not prompt the user, instead fail the authentication.
 * &lt;ul&gt;
 * &lt;p&gt;&lt;code&gt;principal&lt;/code&gt;=&amp;lt;name&amp;gt;&lt;code&gt;useTicketCache&lt;/code&gt; = true
 * &lt;code&gt;doNotPrompt&lt;/code&gt;=true;
 *&lt;/ul&gt;
 * &lt;p&gt; Get the TGT from the default cache for the principal and populate the
 * Subject's principal and private creds set. If ticket cache is
 * not available or does not contain the principal's TGT
 * authentication will fail.
 * &lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;useTicketCache&lt;/code&gt; = true
 * &lt;code&gt;ticketCache&lt;/code&gt;=&amp;lt;file name&amp;gt;&lt;code&gt;useKeyTab&lt;/code&gt; = true
 * &lt;code&gt; keyTab&lt;/code&gt;=&amp;lt;keytab filename&amp;gt;
 * &lt;code&gt;principal&lt;/code&gt; = &amp;lt;principal name&amp;gt;
 * &lt;code&gt;doNotPrompt&lt;/code&gt;=true;
 *&lt;/ul&gt;
 * &lt;p&gt;  Search the cache for the principal's TGT. If it is not available
 * use the key in the keytab to perform authentication exchange with the
 * KDC and acquire the TGT.
 * The Subject will be populated with the principal and the TGT.
 * If the key is not available or valid then authentication will fail.
 * &lt;ul&gt;
 * &lt;p&gt;&lt;code&gt;useTicketCache&lt;/code&gt; = true
 * &lt;code&gt;ticketCache&lt;/code&gt;=&amp;lt;file name&amp;gt;
 *&lt;/ul&gt;
 * &lt;p&gt; The TGT will be obtained from the cache specified.
 * The Kerberos principal name used will be the principal name in
 * the Ticket cache. If the TGT is not available in the
 * ticket cache the user will be prompted for the principal name
 * and the password. The TGT will be obtained using the authentication
 * exchange with the KDC.
 * The Subject will be populated with the TGT.
 *&lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;useKeyTab&lt;/code&gt; = true
 * &lt;code&gt;keyTab&lt;/code&gt;=&amp;lt;keytab filename&amp;gt;
 * &lt;code&gt;principal&lt;/code&gt;= &amp;lt;principal name&amp;gt;
 * &lt;code&gt;storeKey&lt;/code&gt;=true;
 *&lt;/ul&gt;
 * &lt;p&gt;  The key for the principal will be retrieved from the keytab.
 * If the key is not available in the keytab the user will be prompted
 * for the principal's password. The Subject will be populated
 * with the principal's key either from the keytab or derived from the
 * password entered.
 * &lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;useKeyTab&lt;/code&gt; = true
 * &lt;code&gt;keyTab&lt;/code&gt;=&amp;lt;keytabname&amp;gt;
 * &lt;code&gt;storeKey&lt;/code&gt;=true
 * &lt;code&gt;doNotPrompt&lt;/code&gt;=false;
 *&lt;/ul&gt;
 * &lt;p&gt;The user will be prompted for the service principal name.
 * If the principal's
 * longterm key is available in the keytab , it will be added to the
 * Subject's private credentials. An authentication exchange will be
 * attempted with the principal name and the key from the Keytab.
 * If successful the TGT will be added to the
 * Subject's private credentials set. Otherwise the authentication will
 * fail.
 * &lt;ul&gt;
 * &lt;p&gt; &lt;code&gt;isInitiator&lt;/code&gt; = false &lt;code&gt;useKeyTab&lt;/code&gt; = true
 * &lt;code&gt;keyTab&lt;/code&gt;=&amp;lt;keytabname&amp;gt;
 * &lt;code&gt;storeKey&lt;/code&gt;=true
 * &lt;code&gt;principal&lt;/code&gt;=*;
 *&lt;/ul&gt;
 * &lt;p&gt;The acceptor will be an unbound acceptor and it can act as any principal
 * as long that principal has keys in the keytab.
 *&lt;ul&gt;
 * &lt;p&gt;
 * &lt;code&gt;useTicketCache&lt;/code&gt;=true
 * &lt;code&gt;ticketCache&lt;/code&gt;=&amp;lt;file name&amp;gt;;
 * &lt;code&gt;useKeyTab&lt;/code&gt; = true
 * &lt;code&gt;keyTab&lt;/code&gt;=&amp;lt;file name&amp;gt; &lt;code&gt;storeKey&lt;/code&gt;=true
 * &lt;code&gt;principal&lt;/code&gt;= &amp;lt;principal name&amp;gt;
 *&lt;/ul&gt;
 * &lt;p&gt;
 * The client's TGT will be retrieved from the ticket cache and added to the
 * &lt;code&gt;Subject&lt;/code&gt;'s private credentials. If the TGT is not available
 * in the ticket cache, or the TGT's client name does not match the principal
 * name, Java will use a secret key to obtain the TGT using the authentication
 * exchange and added to the Subject's private credentials.
 * This secret key will be first retrieved from the keytab. If the key
 * is not available, the user will be prompted for the password. In either
 * case, the key derived from the password will be added to the
 * Subject's private credentials set.
 * &lt;ul&gt;
 * &lt;p&gt;&lt;code&gt;isInitiator&lt;/code&gt; = false
 *&lt;/ul&gt;
 * &lt;p&gt;Configured to act as acceptor only, credentials are not acquired
 * via AS exchange. For acceptors only, set this value to false.
 * For initiators, do not set this value to false.
 * &lt;ul&gt;
 * &lt;p&gt;&lt;code&gt;isInitiator&lt;/code&gt; = true
 *&lt;/ul&gt;
 * &lt;p&gt;Configured to act as initiator, credentials are acquired
 * via AS exchange. For initiators, set this value to true, or leave this
 * option unset, in which case default value (true) will be used.
 *
 * @author Ram Marti
 */

@jdk.Exported
<span class="fc" id="L383">public class Krb5LoginModule implements LoginModule {</span>

    // initial state
    private Subject subject;
    private CallbackHandler callbackHandler;
    private Map&lt;String, Object&gt; sharedState;
    private Map&lt;String, ?&gt; options;

    // configurable option
<span class="fc" id="L392">    private boolean debug = false;</span>
<span class="fc" id="L393">    private boolean storeKey = false;</span>
<span class="fc" id="L394">    private boolean doNotPrompt = false;</span>
<span class="fc" id="L395">    private boolean useTicketCache = false;</span>
<span class="fc" id="L396">    private boolean useKeyTab = false;</span>
<span class="fc" id="L397">    private String ticketCacheName = null;</span>
<span class="fc" id="L398">    private String keyTabName = null;</span>
<span class="fc" id="L399">    private String princName = null;</span>

<span class="fc" id="L401">    private boolean useFirstPass = false;</span>
<span class="fc" id="L402">    private boolean tryFirstPass = false;</span>
<span class="fc" id="L403">    private boolean storePass = false;</span>
<span class="fc" id="L404">    private boolean clearPass = false;</span>
<span class="fc" id="L405">    private boolean refreshKrb5Config = false;</span>
<span class="fc" id="L406">    private boolean renewTGT = false;</span>

    // specify if initiator.
    // perform authentication exchange if initiator
<span class="fc" id="L410">    private boolean isInitiator = true;</span>

    // the authentication status
<span class="fc" id="L413">    private boolean succeeded = false;</span>
<span class="fc" id="L414">    private boolean commitSucceeded = false;</span>
    private String username;

    // Encryption keys calculated from password. Assigned when storekey == true
    // and useKeyTab == false (or true but not found)
<span class="fc" id="L419">    private EncryptionKey[] encKeys = null;</span>

<span class="fc" id="L421">    KeyTab ktab = null;</span>

<span class="fc" id="L423">    private Credentials cred = null;</span>

<span class="fc" id="L425">    private PrincipalName principal = null;</span>
<span class="fc" id="L426">    private KerberosPrincipal kerbClientPrinc = null;</span>
<span class="fc" id="L427">    private KerberosTicket kerbTicket = null;</span>
<span class="fc" id="L428">    private KerberosKey[] kerbKeys = null;</span>
<span class="fc" id="L429">    private StringBuffer krb5PrincName = null;</span>
<span class="fc" id="L430">    private boolean unboundServer = false;</span>
<span class="fc" id="L431">    private char[] password = null;</span>

    private static final String NAME = &quot;javax.security.auth.login.name&quot;;
    private static final String PWD = &quot;javax.security.auth.login.password&quot;;
<span class="fc" id="L435">    private static final ResourceBundle rb = AccessController.doPrivileged(</span>
<span class="fc" id="L436">            new PrivilegedAction&lt;ResourceBundle&gt;() {</span>
                public ResourceBundle run() {
<span class="fc" id="L438">                    return ResourceBundle.getBundle(</span>
                            &quot;sun.security.util.AuthResources&quot;);
                }
            }
    );

    /**
     * Initialize this &lt;code&gt;LoginModule&lt;/code&gt;.
     *
     * &lt;p&gt;
     * @param subject the &lt;code&gt;Subject&lt;/code&gt; to be authenticated. &lt;p&gt;
     *
     * @param callbackHandler a &lt;code&gt;CallbackHandler&lt;/code&gt; for
     *                  communication with the end user (prompting for
     *                  usernames and passwords, for example). &lt;p&gt;
     *
     * @param sharedState shared &lt;code&gt;LoginModule&lt;/code&gt; state. &lt;p&gt;
     *
     * @param options options specified in the login
     *                  &lt;code&gt;Configuration&lt;/code&gt; for this particular
     *                  &lt;code&gt;LoginModule&lt;/code&gt;.
     */
    // Unchecked warning from (Map&lt;String, Object&gt;)sharedState is safe
    // since javax.security.auth.login.LoginContext passes a raw HashMap.
    // Unchecked warnings from options.get(String) are safe since we are
    // passing known keys.
    @SuppressWarnings(&quot;unchecked&quot;)
    public void initialize(Subject subject,
                           CallbackHandler callbackHandler,
                           Map&lt;String, ?&gt; sharedState,
                           Map&lt;String, ?&gt; options) {

<span class="fc" id="L470">        this.subject = subject;</span>
<span class="fc" id="L471">        this.callbackHandler = callbackHandler;</span>
<span class="fc" id="L472">        this.sharedState = (Map&lt;String, Object&gt;)sharedState;</span>
<span class="fc" id="L473">        this.options = options;</span>

        // initialize any configured options

<span class="fc" id="L477">        debug = &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;debug&quot;));</span>
<span class="fc" id="L478">        storeKey = &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;storeKey&quot;));</span>
<span class="fc" id="L479">        doNotPrompt = &quot;true&quot;.equalsIgnoreCase((String)options.get</span>
<span class="fc" id="L480">                                              (&quot;doNotPrompt&quot;));</span>
<span class="fc" id="L481">        useTicketCache = &quot;true&quot;.equalsIgnoreCase((String)options.get</span>
<span class="fc" id="L482">                                                 (&quot;useTicketCache&quot;));</span>
<span class="fc" id="L483">        useKeyTab = &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;useKeyTab&quot;));</span>
<span class="fc" id="L484">        ticketCacheName = (String)options.get(&quot;ticketCache&quot;);</span>
<span class="fc" id="L485">        keyTabName = (String)options.get(&quot;keyTab&quot;);</span>
<span class="fc bfc" id="L486" title="All 2 branches covered.">        if (keyTabName != null) {</span>
<span class="fc" id="L487">            keyTabName = sun.security.krb5.internal.ktab.KeyTab.normalize(</span>
                         keyTabName);
        }
<span class="fc" id="L490">        princName = (String)options.get(&quot;principal&quot;);</span>
<span class="fc" id="L491">        refreshKrb5Config =</span>
<span class="fc" id="L492">            &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;refreshKrb5Config&quot;));</span>
<span class="fc" id="L493">        renewTGT =</span>
<span class="fc" id="L494">            &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;renewTGT&quot;));</span>

        // check isInitiator value
<span class="fc" id="L497">        String isInitiatorValue = ((String)options.get(&quot;isInitiator&quot;));</span>
<span class="fc bfc" id="L498" title="All 2 branches covered.">        if (isInitiatorValue == null) {</span>
            // use default, if value not set
        } else {
<span class="fc" id="L501">            isInitiator = &quot;true&quot;.equalsIgnoreCase(isInitiatorValue);</span>
        }

<span class="fc" id="L504">        tryFirstPass =</span>
            &quot;true&quot;.equalsIgnoreCase
<span class="fc" id="L506">            ((String)options.get(&quot;tryFirstPass&quot;));</span>
<span class="fc" id="L507">        useFirstPass =</span>
            &quot;true&quot;.equalsIgnoreCase
<span class="fc" id="L509">            ((String)options.get(&quot;useFirstPass&quot;));</span>
<span class="fc" id="L510">        storePass =</span>
<span class="fc" id="L511">            &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;storePass&quot;));</span>
<span class="fc" id="L512">        clearPass =</span>
<span class="fc" id="L513">            &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;clearPass&quot;));</span>
<span class="fc bfc" id="L514" title="All 2 branches covered.">        if (debug) {</span>
<span class="fc" id="L515">            System.out.print(&quot;Debug is  &quot; + debug</span>
                             + &quot; storeKey &quot; + storeKey
                             + &quot; useTicketCache &quot; + useTicketCache
                             + &quot; useKeyTab &quot; + useKeyTab
                             + &quot; doNotPrompt &quot; + doNotPrompt
                             + &quot; ticketCache is &quot; + ticketCacheName
                             + &quot; isInitiator &quot; + isInitiator
                             + &quot; KeyTab is &quot; + keyTabName
                             + &quot; refreshKrb5Config is &quot; + refreshKrb5Config
                             + &quot; principal is &quot; + princName
                             + &quot; tryFirstPass is &quot; + tryFirstPass
                             + &quot; useFirstPass is &quot; + useFirstPass
                             + &quot; storePass is &quot; + storePass
                             + &quot; clearPass is &quot; + clearPass + &quot;\n&quot;);
        }
<span class="fc" id="L530">    }</span>


    /**
     * Authenticate the user
     *
     * &lt;p&gt;
     *
     * @return true in all cases since this &lt;code&gt;LoginModule&lt;/code&gt;
     *          should not be ignored.
     *
     * @exception FailedLoginException if the authentication fails. &lt;p&gt;
     *
     * @exception LoginException if this &lt;code&gt;LoginModule&lt;/code&gt;
     *          is unable to perform the authentication.
     */
    public boolean login() throws LoginException {

<span class="pc bpc" id="L548" title="1 of 2 branches missed.">        if (refreshKrb5Config) {</span>
            try {
<span class="nc bnc" id="L550" title="All 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L551">                    System.out.println(&quot;Refreshing Kerberos configuration&quot;);</span>
                }
<span class="nc" id="L553">                sun.security.krb5.Config.refresh();</span>
<span class="nc" id="L554">            } catch (KrbException ke) {</span>
<span class="nc" id="L555">                LoginException le = new LoginException(ke.getMessage());</span>
<span class="nc" id="L556">                le.initCause(ke);</span>
<span class="nc" id="L557">                throw le;</span>
<span class="nc" id="L558">            }</span>
        }
<span class="fc" id="L560">        String principalProperty = System.getProperty</span>
<span class="fc" id="L561">            (&quot;sun.security.krb5.principal&quot;);</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">        if (principalProperty != null) {</span>
<span class="nc" id="L563">            krb5PrincName = new StringBuffer(principalProperty);</span>
        } else {
<span class="fc bfc" id="L565" title="All 2 branches covered.">            if (princName != null) {</span>
<span class="fc" id="L566">                krb5PrincName = new StringBuffer(princName);</span>
            }
        }

<span class="fc" id="L570">        validateConfiguration();</span>

<span class="fc bfc" id="L572" title="All 4 branches covered.">        if (krb5PrincName != null &amp;&amp; krb5PrincName.toString().equals(&quot;*&quot;)) {</span>
<span class="fc" id="L573">            unboundServer = true;</span>
        }

<span class="fc bfc" id="L576" title="All 2 branches covered.">        if (tryFirstPass) {</span>
            try {
<span class="nc" id="L578">                attemptAuthentication(true);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">                if (debug)</span>
<span class="nc" id="L580">                    System.out.println(&quot;\t\t[Krb5LoginModule] &quot; +</span>
                                       &quot;authentication succeeded&quot;);
<span class="nc" id="L582">                succeeded = true;</span>
<span class="nc" id="L583">                cleanState();</span>
<span class="nc" id="L584">                return true;</span>
<span class="fc" id="L585">            } catch (LoginException le) {</span>
                // authentication failed -- try again below by prompting
<span class="fc" id="L587">                cleanState();</span>
<span class="pc bpc" id="L588" title="1 of 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L589">                    System.out.println(&quot;\t\t[Krb5LoginModule] &quot; +</span>
                                       &quot;tryFirstPass failed with:&quot; +
<span class="nc" id="L591">                                       le.getMessage());</span>
                }
<span class="fc" id="L593">            }</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">        } else if (useFirstPass) {</span>
            try {
<span class="fc" id="L596">                attemptAuthentication(true);</span>
<span class="fc" id="L597">                succeeded = true;</span>
<span class="fc" id="L598">                cleanState();</span>
<span class="fc" id="L599">                return true;</span>
<span class="fc" id="L600">            } catch (LoginException e) {</span>
                // authentication failed -- clean out state
<span class="fc bfc" id="L602" title="All 2 branches covered.">                if (debug) {</span>
<span class="fc" id="L603">                    System.out.println(&quot;\t\t[Krb5LoginModule] &quot; +</span>
                                       &quot;authentication failed \n&quot; +
<span class="fc" id="L605">                                       e.getMessage());</span>
                }
<span class="fc" id="L607">                succeeded = false;</span>
<span class="fc" id="L608">                cleanState();</span>
<span class="fc" id="L609">                throw e;</span>
            }
        }

        // attempt the authentication by getting the username and pwd
        // by prompting or configuration i.e. not from shared state

        try {
<span class="fc" id="L617">            attemptAuthentication(false);</span>
<span class="fc" id="L618">            succeeded = true;</span>
<span class="fc" id="L619">            cleanState();</span>
<span class="fc" id="L620">            return true;</span>
<span class="fc" id="L621">        } catch (LoginException e) {</span>
            // authentication failed -- clean out state
<span class="pc bpc" id="L623" title="1 of 2 branches missed.">            if (debug) {</span>
<span class="nc" id="L624">                System.out.println(&quot;\t\t[Krb5LoginModule] &quot; +</span>
                                   &quot;authentication failed \n&quot; +
<span class="nc" id="L626">                                   e.getMessage());</span>
            }
<span class="fc" id="L628">            succeeded = false;</span>
<span class="fc" id="L629">            cleanState();</span>
<span class="fc" id="L630">            throw e;</span>
        }
    }
    /**
     * process the configuration options
     * Get the TGT either out of
     * cache or from the KDC using the password entered
     * Check the  permission before getting the TGT
     */

    private void attemptAuthentication(boolean getPasswdFromSharedState)
        throws LoginException {

        /*
         * Check the creds cache to see whether
         * we have TGT for this client principal
         */
<span class="fc bfc" id="L647" title="All 2 branches covered.">        if (krb5PrincName != null) {</span>
            try {
<span class="fc" id="L649">                principal = new PrincipalName</span>
<span class="fc" id="L650">                    (krb5PrincName.toString(),</span>
                     PrincipalName.KRB_NT_PRINCIPAL);
<span class="nc" id="L652">            } catch (KrbException e) {</span>
<span class="nc" id="L653">                LoginException le = new LoginException(e.getMessage());</span>
<span class="nc" id="L654">                le.initCause(e);</span>
<span class="nc" id="L655">                throw le;</span>
<span class="fc" id="L656">            }</span>
        }

        try {
<span class="fc bfc" id="L660" title="All 2 branches covered.">            if (useTicketCache) {</span>
                // ticketCacheName == null implies the default cache
<span class="pc bpc" id="L662" title="1 of 2 branches missed.">                if (debug)</span>
<span class="nc" id="L663">                    System.out.println(&quot;Acquire TGT from Cache&quot;);</span>
<span class="fc" id="L664">                cred  = Credentials.acquireTGTFromCache</span>
<span class="fc" id="L665">                    (principal, ticketCacheName);</span>

<span class="pc bpc" id="L667" title="1 of 2 branches missed.">                if (cred != null) {</span>
                    // check to renew credentials
<span class="nc bnc" id="L669" title="All 2 branches missed.">                    if (!isCurrent(cred)) {</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                        if (renewTGT) {</span>
<span class="nc" id="L671">                            cred = renewCredentials(cred);</span>
                        } else {
                            // credentials have expired
<span class="nc" id="L674">                            cred = null;</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">                            if (debug)</span>
<span class="nc" id="L676">                                System.out.println(&quot;Credentials are&quot; +</span>
                                                &quot; no longer valid&quot;);
                        }
                    }
                }

<span class="pc bpc" id="L682" title="1 of 2 branches missed.">                if (cred != null) {</span>
                   // get the principal name from the ticket cache
<span class="nc bnc" id="L684" title="All 2 branches missed.">                   if (principal == null) {</span>
<span class="nc" id="L685">                        principal = cred.getClient();</span>
                   }
                }
<span class="pc bpc" id="L688" title="1 of 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L689">                    System.out.println(&quot;Principal is &quot; + principal);</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                    if (cred == null) {</span>
<span class="nc" id="L691">                        System.out.println</span>
<span class="nc" id="L692">                            (&quot;null credentials from Ticket Cache&quot;);</span>
                    }
                }
            }

            // cred = null indicates that we didn't get the creds
            // from the cache or useTicketCache was false

<span class="pc bpc" id="L700" title="1 of 2 branches missed.">            if (cred == null) {</span>
                // We need the principal name whether we use keytab
                // or AS Exchange
<span class="fc bfc" id="L703" title="All 2 branches covered.">                if (principal == null) {</span>
<span class="fc" id="L704">                    promptForName(getPasswdFromSharedState);</span>
<span class="fc" id="L705">                    principal = new PrincipalName</span>
<span class="fc" id="L706">                        (krb5PrincName.toString(),</span>
                         PrincipalName.KRB_NT_PRINCIPAL);
                }

                /*
                 * Before dynamic KeyTab support (6894072), here we check if
                 * the keytab contains keys for the principal. If no, keytab
                 * will not be used and password is prompted for.
                 *
                 * After 6894072, we normally don't check it, and expect the
                 * keys can be populated until a real connection is made. The
                 * check is still done when isInitiator == true, where the keys
                 * will be used right now.
                 *
                 * Probably tricky relations:
                 *
                 * useKeyTab is config flag, but when it's true but the ktab
                 * does not contains keys for principal, we would use password
                 * and keep the flag unchanged (for reuse?). In this method,
                 * we use (ktab != null) to check whether keytab is used.
                 * After this method (and when storeKey == true), we use
                 * (encKeys == null) to check.
                 */
<span class="fc bfc" id="L729" title="All 2 branches covered.">                if (useKeyTab) {</span>
<span class="fc bfc" id="L730" title="All 2 branches covered.">                    if (!unboundServer) {</span>
<span class="fc" id="L731">                        KerberosPrincipal kp =</span>
<span class="fc" id="L732">                                new KerberosPrincipal(principal.getName());</span>
<span class="fc bfc" id="L733" title="All 2 branches covered.">                        ktab = (keyTabName == null)</span>
<span class="fc" id="L734">                                ? KeyTab.getInstance(kp)</span>
<span class="fc" id="L735">                                : KeyTab.getInstance(kp, new File(keyTabName));</span>
<span class="fc" id="L736">                    } else {</span>
<span class="fc bfc" id="L737" title="All 2 branches covered.">                        ktab = (keyTabName == null)</span>
<span class="fc" id="L738">                                ? KeyTab.getUnboundInstance()</span>
<span class="fc" id="L739">                                : KeyTab.getUnboundInstance(new File(keyTabName));</span>
                    }
<span class="fc bfc" id="L741" title="All 2 branches covered.">                    if (isInitiator) {</span>
<span class="pc bpc" id="L742" title="1 of 2 branches missed.">                        if (Krb5Util.keysFromJavaxKeyTab(ktab, principal).length</span>
                                == 0) {
<span class="nc" id="L744">                            ktab = null;</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">                            if (debug) {</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">                                System.out.println</span>
<span class="nc" id="L747">                                    (&quot;Key for the principal &quot; +</span>
                                     principal  +
                                     &quot; not available in &quot; +
                                     ((keyTabName == null) ?
                                      &quot;default key tab&quot; : keyTabName));
                            }
                        }
                    }
                }

                KrbAsReqBuilder builder;

<span class="fc bfc" id="L759" title="All 2 branches covered.">                if (ktab == null) {</span>
<span class="fc" id="L760">                    promptForPass(getPasswdFromSharedState);</span>
<span class="fc" id="L761">                    builder = new KrbAsReqBuilder(principal, password);</span>
<span class="pc bpc" id="L762" title="1 of 2 branches missed.">                    if (isInitiator) {</span>
                        // XXX Even if isInitiator=false, it might be
                        // better to do an AS-REQ so that keys can be
                        // updated with PA info
<span class="fc" id="L766">                        cred = builder.action().getCreds();</span>
                    }
<span class="pc bpc" id="L768" title="1 of 2 branches missed.">                    if (storeKey) {</span>
<span class="nc" id="L769">                        encKeys = builder.getKeys(isInitiator);</span>
                        // When encKeys is empty, the login actually fails.
                        // For compatibility, exception is thrown in commit().
                    }
                } else {
<span class="fc" id="L774">                    builder = new KrbAsReqBuilder(principal, ktab);</span>
<span class="pc bpc" id="L775" title="1 of 2 branches missed.">                    if (isInitiator) {</span>
<span class="nc" id="L776">                        cred = builder.action().getCreds();</span>
                    }
                }
<span class="fc" id="L779">                builder.destroy();</span>

<span class="pc bpc" id="L781" title="1 of 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L782">                    System.out.println(&quot;principal is &quot; + principal);</span>
<span class="nc" id="L783">                    HexDumpEncoder hd = new HexDumpEncoder();</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">                    if (ktab != null) {</span>
<span class="nc" id="L785">                        System.out.println(&quot;Will use keytab&quot;);</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">                    } else if (storeKey) {</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">                        for (int i = 0; i &lt; encKeys.length; i++) {</span>
<span class="nc" id="L788">                            System.out.println(&quot;EncryptionKey: keyType=&quot; +</span>
<span class="nc" id="L789">                                encKeys[i].getEType() +</span>
                                &quot; keyBytes (hex dump)=&quot; +
<span class="nc" id="L791">                                hd.encodeBuffer(encKeys[i].getBytes()));</span>
                        }
                    }
                }

                // we should hava a non-null cred
<span class="pc bpc" id="L797" title="1 of 4 branches missed.">                if (isInitiator &amp;&amp; (cred == null)) {</span>
<span class="nc" id="L798">                    throw new LoginException</span>
                        (&quot;TGT Can not be obtained from the KDC &quot;);
                }

            }
<span class="fc" id="L803">        } catch (KrbException e) {</span>
<span class="fc" id="L804">            LoginException le = new LoginException(e.getMessage());</span>
<span class="fc" id="L805">            le.initCause(e);</span>
<span class="fc" id="L806">            throw le;</span>
<span class="fc" id="L807">        } catch (IOException ioe) {</span>
<span class="fc" id="L808">            LoginException ie = new LoginException(ioe.getMessage());</span>
<span class="fc" id="L809">            ie.initCause(ioe);</span>
<span class="fc" id="L810">            throw ie;</span>
<span class="fc" id="L811">        }</span>
<span class="fc" id="L812">    }</span>

    private void promptForName(boolean getPasswdFromSharedState)
        throws LoginException {
<span class="fc" id="L816">        krb5PrincName = new StringBuffer(&quot;&quot;);</span>
<span class="fc bfc" id="L817" title="All 2 branches covered.">        if (getPasswdFromSharedState) {</span>
            // use the name saved by the first module in the stack
<span class="fc" id="L819">            username = (String)sharedState.get(NAME);</span>
<span class="fc bfc" id="L820" title="All 2 branches covered.">            if (debug) {</span>
<span class="fc" id="L821">                System.out.println</span>
<span class="fc" id="L822">                    (&quot;username from shared state is &quot; + username + &quot;\n&quot;);</span>
            }
<span class="pc bpc" id="L824" title="1 of 2 branches missed.">            if (username == null) {</span>
<span class="nc" id="L825">                System.out.println</span>
<span class="nc" id="L826">                    (&quot;username from shared state is null\n&quot;);</span>
<span class="nc" id="L827">                throw new LoginException</span>
                    (&quot;Username can not be obtained from sharedstate &quot;);
            }
<span class="fc bfc" id="L830" title="All 2 branches covered.">            if (debug) {</span>
<span class="fc" id="L831">                System.out.println</span>
<span class="fc" id="L832">                    (&quot;username from shared state is &quot; + username + &quot;\n&quot;);</span>
            }
<span class="pc bpc" id="L834" title="2 of 4 branches missed.">            if (username != null &amp;&amp; username.length() &gt; 0) {</span>
<span class="fc" id="L835">                krb5PrincName.insert(0, username);</span>
<span class="fc" id="L836">                return;</span>
            }
        }

<span class="pc bpc" id="L840" title="1 of 2 branches missed.">        if (doNotPrompt) {</span>
<span class="nc" id="L841">            throw new LoginException</span>
                (&quot;Unable to obtain Principal Name for authentication &quot;);
        } else {
<span class="pc bpc" id="L844" title="1 of 2 branches missed.">            if (callbackHandler == null)</span>
<span class="nc" id="L845">                throw new LoginException(&quot;No CallbackHandler &quot;</span>
                                         + &quot;available &quot;
                                         + &quot;to garner authentication &quot;
                                         + &quot;information from the user&quot;);
            try {
<span class="fc" id="L850">                String defUsername = System.getProperty(&quot;user.name&quot;);</span>

<span class="fc" id="L852">                Callback[] callbacks = new Callback[1];</span>
<span class="fc" id="L853">                MessageFormat form = new MessageFormat(</span>
<span class="fc" id="L854">                                       rb.getString(</span>
                                       &quot;Kerberos.username.defUsername.&quot;));
<span class="fc" id="L856">                Object[] source =  {defUsername};</span>
<span class="fc" id="L857">                callbacks[0] = new NameCallback(form.format(source));</span>
<span class="fc" id="L858">                callbackHandler.handle(callbacks);</span>
<span class="fc" id="L859">                username = ((NameCallback)callbacks[0]).getName();</span>
<span class="pc bpc" id="L860" title="2 of 4 branches missed.">                if (username == null || username.length() == 0)</span>
<span class="nc" id="L861">                    username = defUsername;</span>
<span class="fc" id="L862">                krb5PrincName.insert(0, username);</span>

<span class="nc" id="L864">            } catch (java.io.IOException ioe) {</span>
<span class="nc" id="L865">                throw new LoginException(ioe.getMessage());</span>
<span class="nc" id="L866">            } catch (UnsupportedCallbackException uce) {</span>
<span class="nc" id="L867">                throw new LoginException</span>
<span class="nc" id="L868">                    (uce.getMessage()</span>
                     +&quot; not available to garner &quot;
                     +&quot; authentication information &quot;
                     +&quot; from the user&quot;);
<span class="fc" id="L872">            }</span>
        }
<span class="fc" id="L874">    }</span>

    private void promptForPass(boolean getPasswdFromSharedState)
        throws LoginException {

<span class="fc bfc" id="L879" title="All 2 branches covered.">        if (getPasswdFromSharedState) {</span>
            // use the password saved by the first module in the stack
<span class="fc" id="L881">            password = (char[])sharedState.get(PWD);</span>
<span class="pc bpc" id="L882" title="1 of 2 branches missed.">            if (password == null) {</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L884">                    System.out.println</span>
<span class="nc" id="L885">                        (&quot;Password from shared state is null&quot;);</span>
                }
<span class="nc" id="L887">                throw new LoginException</span>
                    (&quot;Password can not be obtained from sharedstate &quot;);
            }
<span class="fc bfc" id="L890" title="All 2 branches covered.">            if (debug) {</span>
<span class="fc" id="L891">                System.out.println</span>
<span class="fc" id="L892">                    (&quot;password is &quot; + new String(password));</span>
            }
<span class="fc" id="L894">            return;</span>
        }
<span class="pc bpc" id="L896" title="1 of 2 branches missed.">        if (doNotPrompt) {</span>
<span class="nc" id="L897">            throw new LoginException</span>
                (&quot;Unable to obtain password from user\n&quot;);
        } else {
<span class="pc bpc" id="L900" title="1 of 2 branches missed.">            if (callbackHandler == null)</span>
<span class="nc" id="L901">                throw new LoginException(&quot;No CallbackHandler &quot;</span>
                                         + &quot;available &quot;
                                         + &quot;to garner authentication &quot;
                                         + &quot;information from the user&quot;);
            try {
<span class="fc" id="L906">                Callback[] callbacks = new Callback[1];</span>
<span class="fc" id="L907">                String userName = krb5PrincName.toString();</span>
<span class="fc" id="L908">                MessageFormat form = new MessageFormat(</span>
<span class="fc" id="L909">                                         rb.getString(</span>
                                         &quot;Kerberos.password.for.username.&quot;));
<span class="fc" id="L911">                Object[] source = {userName};</span>
<span class="fc" id="L912">                callbacks[0] = new PasswordCallback(</span>
<span class="fc" id="L913">                                                    form.format(source),</span>
                                                    false);
<span class="fc" id="L915">                callbackHandler.handle(callbacks);</span>
<span class="fc" id="L916">                char[] tmpPassword = ((PasswordCallback)</span>
<span class="fc" id="L917">                                      callbacks[0]).getPassword();</span>
<span class="pc bpc" id="L918" title="1 of 2 branches missed.">                if (tmpPassword == null) {</span>
                    // treat a NULL password as an empty password
<span class="nc" id="L920">                    tmpPassword = new char[0];</span>
                }
<span class="fc" id="L922">                password = new char[tmpPassword.length];</span>
<span class="fc" id="L923">                System.arraycopy(tmpPassword, 0,</span>
                                 password, 0, tmpPassword.length);
<span class="fc" id="L925">                ((PasswordCallback)callbacks[0]).clearPassword();</span>


                // clear tmpPassword
<span class="fc bfc" id="L929" title="All 2 branches covered.">                for (int i = 0; i &lt; tmpPassword.length; i++)</span>
<span class="fc" id="L930">                    tmpPassword[i] = ' ';</span>
<span class="fc" id="L931">                tmpPassword = null;</span>
<span class="pc bpc" id="L932" title="1 of 2 branches missed.">                if (debug) {</span>
<span class="nc" id="L933">                    System.out.println(&quot;\t\t[Krb5LoginModule] &quot; +</span>
                                       &quot;user entered username: &quot; +
                                       krb5PrincName);
<span class="nc" id="L936">                    System.out.println();</span>
                }
<span class="nc" id="L938">            } catch (java.io.IOException ioe) {</span>
<span class="nc" id="L939">                throw new LoginException(ioe.getMessage());</span>
<span class="nc" id="L940">            } catch (UnsupportedCallbackException uce) {</span>
<span class="nc" id="L941">                throw new LoginException(uce.getMessage()</span>
                                         +&quot; not available to garner &quot;
                                         +&quot; authentication information &quot;
                                         + &quot;from the user&quot;);
<span class="fc" id="L945">            }</span>
        }
<span class="fc" id="L947">    }</span>

    private void validateConfiguration() throws LoginException {
<span class="pc bpc" id="L950" title="3 of 10 branches missed.">        if (doNotPrompt &amp;&amp; !useTicketCache &amp;&amp; !useKeyTab</span>
                &amp;&amp; !tryFirstPass &amp;&amp; !useFirstPass)
<span class="nc" id="L952">            throw new LoginException</span>
                (&quot;Configuration Error&quot;
                 + &quot; - either doNotPrompt should be &quot;
                 + &quot; false or at least one of useTicketCache, &quot;
                 + &quot; useKeyTab, tryFirstPass and useFirstPass&quot;
                 + &quot; should be true&quot;);
<span class="pc bpc" id="L958" title="1 of 4 branches missed.">        if (ticketCacheName != null &amp;&amp; !useTicketCache)</span>
<span class="nc" id="L959">            throw new LoginException</span>
                (&quot;Configuration Error &quot;
                 + &quot; - useTicketCache should be set &quot;
                 + &quot;to true to use the ticket cache&quot;
                 + ticketCacheName);
<span class="pc bpc" id="L964" title="1 of 6 branches missed.">        if (keyTabName != null &amp; !useKeyTab)</span>
<span class="nc" id="L965">            throw new LoginException</span>
                (&quot;Configuration Error - useKeyTab should be set to true &quot;
                 + &quot;to use the keytab&quot; + keyTabName);
<span class="pc bpc" id="L968" title="5 of 10 branches missed.">        if (storeKey &amp;&amp; doNotPrompt &amp;&amp; !useKeyTab</span>
                &amp;&amp; !tryFirstPass &amp;&amp; !useFirstPass)
<span class="nc" id="L970">            throw new LoginException</span>
                (&quot;Configuration Error - either doNotPrompt should be set to &quot;
                 + &quot; false or at least one of tryFirstPass, useFirstPass &quot;
                 + &quot;or useKeyTab must be set to true for storeKey option&quot;);
<span class="pc bpc" id="L974" title="3 of 4 branches missed.">        if (renewTGT &amp;&amp; !useTicketCache)</span>
<span class="nc" id="L975">            throw new LoginException</span>
                (&quot;Configuration Error&quot;
                 + &quot; - either useTicketCache should be &quot;
                 + &quot; true or renewTGT should be false&quot;);
<span class="fc bfc" id="L979" title="All 4 branches covered.">        if (krb5PrincName != null &amp;&amp; krb5PrincName.toString().equals(&quot;*&quot;)) {</span>
<span class="pc bpc" id="L980" title="1 of 2 branches missed.">            if (isInitiator) {</span>
<span class="nc" id="L981">                throw new LoginException</span>
                    (&quot;Configuration Error&quot;
                    + &quot; - principal cannot be * when isInitiator is true&quot;);
            }
        }
<span class="fc" id="L986">    }</span>

    private boolean isCurrent(Credentials creds)
    {
<span class="nc" id="L990">        Date endTime = creds.getEndTime();</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">        if (endTime != null) {</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">            return (System.currentTimeMillis() &lt;= endTime.getTime());</span>
        }
<span class="nc" id="L994">        return true;</span>
    }

    private Credentials renewCredentials(Credentials creds)
    {
        Credentials lcreds;
        try {
<span class="nc bnc" id="L1001" title="All 2 branches missed.">            if (!creds.isRenewable())</span>
<span class="nc" id="L1002">                throw new RefreshFailedException(&quot;This ticket&quot; +</span>
                                &quot; is not renewable&quot;);
<span class="nc bnc" id="L1004" title="All 2 branches missed.">            if (System.currentTimeMillis() &gt; cred.getRenewTill().getTime())</span>
<span class="nc" id="L1005">                throw new RefreshFailedException(&quot;This ticket is past &quot;</span>
                                             + &quot;its last renewal time.&quot;);
<span class="nc" id="L1007">            lcreds = creds.renew();</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">            if (debug)</span>
<span class="nc" id="L1009">                System.out.println(&quot;Renewed Kerberos Ticket&quot;);</span>
<span class="nc" id="L1010">        } catch (Exception e) {</span>
<span class="nc" id="L1011">            lcreds = null;</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">            if (debug)</span>
<span class="nc" id="L1013">                System.out.println(&quot;Ticket could not be renewed : &quot;</span>
<span class="nc" id="L1014">                                + e.getMessage());</span>
<span class="nc" id="L1015">        }</span>
<span class="nc" id="L1016">        return lcreds;</span>
    }

    /**
     * &lt;p&gt; This method is called if the LoginContext's
     * overall authentication succeeded
     * (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL
     * LoginModules succeeded).
     *
     * &lt;p&gt; If this LoginModule's own authentication attempt
     * succeeded (checked by retrieving the private state saved by the
     * &lt;code&gt;login&lt;/code&gt; method), then this method associates a
     * &lt;code&gt;Krb5Principal&lt;/code&gt;
     * with the &lt;code&gt;Subject&lt;/code&gt; located in the
     * &lt;code&gt;LoginModule&lt;/code&gt;. It adds Kerberos Credentials to the
     *  the Subject's private credentials set. If this LoginModule's own
     * authentication attempted failed, then this method removes
     * any state that was originally saved.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the commit fails.
     *
     * @return true if this LoginModule's own login and commit
     *          attempts succeeded, or false otherwise.
     */

    public boolean commit() throws LoginException {

        /*
         * Let us add the Krb5 Creds to the Subject's
         * private credentials. The credentials are of type
         * KerberosKey or KerberosTicket
         */
<span class="pc bpc" id="L1050" title="1 of 2 branches missed.">        if (succeeded == false) {</span>
<span class="nc" id="L1051">            return false;</span>
        } else {

<span class="pc bpc" id="L1054" title="1 of 4 branches missed.">            if (isInitiator &amp;&amp; (cred == null)) {</span>
<span class="nc" id="L1055">                succeeded = false;</span>
<span class="nc" id="L1056">                throw new LoginException(&quot;Null Client Credential&quot;);</span>
            }

<span class="pc bpc" id="L1059" title="1 of 2 branches missed.">            if (subject.isReadOnly()) {</span>
<span class="nc" id="L1060">                cleanKerberosCred();</span>
<span class="nc" id="L1061">                throw new LoginException(&quot;Subject is Readonly&quot;);</span>
            }

            /*
             * Add the Principal (authenticated identity)
             * to the Subject's principal set and
             * add the credentials (TGT or Service key) to the
             * Subject's private credentials
             */

<span class="fc" id="L1071">            Set&lt;Object&gt; privCredSet =  subject.getPrivateCredentials();</span>
<span class="fc" id="L1072">            Set&lt;java.security.Principal&gt; princSet  = subject.getPrincipals();</span>
<span class="fc" id="L1073">            kerbClientPrinc = new KerberosPrincipal(principal.getName());</span>

            // create Kerberos Ticket
<span class="fc bfc" id="L1076" title="All 2 branches covered.">            if (isInitiator) {</span>
<span class="fc" id="L1077">                kerbTicket = Krb5Util.credsToTicket(cred);</span>
            }

<span class="pc bpc" id="L1080" title="1 of 4 branches missed.">            if (storeKey &amp;&amp; encKeys != null) {</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">                if (encKeys.length == 0) {</span>
<span class="nc" id="L1082">                    succeeded = false;</span>
<span class="nc" id="L1083">                    throw new LoginException(&quot;Null Server Key &quot;);</span>
                }

<span class="nc" id="L1086">                kerbKeys = new KerberosKey[encKeys.length];</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">                for (int i = 0; i &lt; encKeys.length; i ++) {</span>
<span class="nc" id="L1088">                    Integer temp = encKeys[i].getKeyVersionNumber();</span>
<span class="nc" id="L1089">                    kerbKeys[i] = new KerberosKey(kerbClientPrinc,</span>
<span class="nc" id="L1090">                                          encKeys[i].getBytes(),</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">                                          encKeys[i].getEType(),</span>
                                          (temp == null?
<span class="nc" id="L1093">                                          0: temp.intValue()));</span>
                }

            }
            // Let us add the kerbClientPrinc,kerbTicket and KeyTab/KerbKey (if
            // storeKey is true)

            // We won't add &quot;*&quot; as a KerberosPrincipal
<span class="fc bfc" id="L1101" title="All 2 branches covered.">            if (!unboundServer &amp;&amp;</span>
<span class="pc bpc" id="L1102" title="1 of 2 branches missed.">                    !princSet.contains(kerbClientPrinc)) {</span>
<span class="fc" id="L1103">                princSet.add(kerbClientPrinc);</span>
            }

            // add the TGT
<span class="fc bfc" id="L1107" title="All 2 branches covered.">            if (kerbTicket != null) {</span>
<span class="pc bpc" id="L1108" title="1 of 2 branches missed.">                if (!privCredSet.contains(kerbTicket))</span>
<span class="fc" id="L1109">                    privCredSet.add(kerbTicket);</span>
            }

<span class="fc bfc" id="L1112" title="All 2 branches covered.">            if (storeKey) {</span>
<span class="pc bpc" id="L1113" title="1 of 2 branches missed.">                if (encKeys == null) {</span>
<span class="pc bpc" id="L1114" title="1 of 2 branches missed.">                    if (ktab != null) {</span>
<span class="pc bpc" id="L1115" title="1 of 2 branches missed.">                        if (!privCredSet.contains(ktab)) {</span>
<span class="fc" id="L1116">                            privCredSet.add(ktab);</span>
                        }
                    } else {
<span class="nc" id="L1119">                        succeeded = false;</span>
<span class="nc" id="L1120">                        throw new LoginException(&quot;No key to store&quot;);</span>
                    }
                } else {
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                    for (int i = 0; i &lt; kerbKeys.length; i ++) {</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">                        if (!privCredSet.contains(kerbKeys[i])) {</span>
<span class="nc" id="L1125">                            privCredSet.add(kerbKeys[i]);</span>
                        }
<span class="nc" id="L1127">                        encKeys[i].destroy();</span>
<span class="nc" id="L1128">                        encKeys[i] = null;</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">                        if (debug) {</span>
<span class="nc" id="L1130">                            System.out.println(&quot;Added server's key&quot;</span>
                                            + kerbKeys[i]);
<span class="nc" id="L1132">                            System.out.println(&quot;\t\t[Krb5LoginModule] &quot; +</span>
                                           &quot;added Krb5Principal  &quot; +
<span class="nc" id="L1134">                                           kerbClientPrinc.toString()</span>
                                           + &quot; to Subject&quot;);
                        }
                    }
                }
            }
        }
<span class="fc" id="L1141">        commitSucceeded = true;</span>
<span class="pc bpc" id="L1142" title="1 of 2 branches missed.">        if (debug)</span>
<span class="nc" id="L1143">            System.out.println(&quot;Commit Succeeded \n&quot;);</span>
<span class="fc" id="L1144">        return true;</span>
    }

    /**
     * &lt;p&gt; This method is called if the LoginContext's
     * overall authentication failed.
     * (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL
     * LoginModules did not succeed).
     *
     * &lt;p&gt; If this LoginModule's own authentication attempt
     * succeeded (checked by retrieving the private state saved by the
     * &lt;code&gt;login&lt;/code&gt; and &lt;code&gt;commit&lt;/code&gt; methods),
     * then this method cleans up any state that was originally saved.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the abort fails.
     *
     * @return false if this LoginModule's own login and/or commit attempts
     *          failed, and true otherwise.
     */

    public boolean abort() throws LoginException {
<span class="pc bpc" id="L1167" title="1 of 2 branches missed.">        if (succeeded == false) {</span>
<span class="fc" id="L1168">            return false;</span>
<span class="nc bnc" id="L1169" title="All 4 branches missed.">        } else if (succeeded == true &amp;&amp; commitSucceeded == false) {</span>
            // login succeeded but overall authentication failed
<span class="nc" id="L1171">            succeeded = false;</span>
<span class="nc" id="L1172">            cleanKerberosCred();</span>
        } else {
            // overall authentication succeeded and commit succeeded,
            // but someone else's commit failed
<span class="nc" id="L1176">            logout();</span>
        }
<span class="nc" id="L1178">        return true;</span>
    }

    /**
     * Logout the user.
     *
     * &lt;p&gt; This method removes the &lt;code&gt;Krb5Principal&lt;/code&gt;
     * that was added by the &lt;code&gt;commit&lt;/code&gt; method.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the logout fails.
     *
     * @return true in all cases since this &lt;code&gt;LoginModule&lt;/code&gt;
     *          should not be ignored.
     */
    public boolean logout() throws LoginException {

<span class="nc bnc" id="L1196" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L1197">            System.out.println(&quot;\t\t[Krb5LoginModule]: &quot; +</span>
                &quot;Entering logout&quot;);
        }

<span class="nc bnc" id="L1201" title="All 2 branches missed.">        if (subject.isReadOnly()) {</span>
<span class="nc" id="L1202">            cleanKerberosCred();</span>
<span class="nc" id="L1203">            throw new LoginException(&quot;Subject is Readonly&quot;);</span>
        }

<span class="nc" id="L1206">        subject.getPrincipals().remove(kerbClientPrinc);</span>
           // Let us remove all Kerberos credentials stored in the Subject
<span class="nc" id="L1208">        Iterator&lt;Object&gt; it = subject.getPrivateCredentials().iterator();</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">        while (it.hasNext()) {</span>
<span class="nc" id="L1210">            Object o = it.next();</span>
<span class="nc bnc" id="L1211" title="All 6 branches missed.">            if (o instanceof KerberosTicket ||</span>
                    o instanceof KerberosKey ||
                    o instanceof KeyTab) {
<span class="nc" id="L1214">                it.remove();</span>
            }
<span class="nc" id="L1216">        }</span>
        // clean the kerberos ticket and keys
<span class="nc" id="L1218">        cleanKerberosCred();</span>

<span class="nc" id="L1220">        succeeded = false;</span>
<span class="nc" id="L1221">        commitSucceeded = false;</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">        if (debug) {</span>
<span class="nc" id="L1223">            System.out.println(&quot;\t\t[Krb5LoginModule]: &quot; +</span>
                               &quot;logged out Subject&quot;);
        }
<span class="nc" id="L1226">        return true;</span>
    }

    /**
     * Clean Kerberos credentials
     */
    private void cleanKerberosCred() throws LoginException {
        // Clean the ticket and server key
        try {
<span class="nc bnc" id="L1235" title="All 2 branches missed.">            if (kerbTicket != null)</span>
<span class="nc" id="L1236">                kerbTicket.destroy();</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">            if (kerbKeys != null) {</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">                for (int i = 0; i &lt; kerbKeys.length; i++) {</span>
<span class="nc" id="L1239">                    kerbKeys[i].destroy();</span>
                }
            }
<span class="nc" id="L1242">        } catch (DestroyFailedException e) {</span>
<span class="nc" id="L1243">            throw new LoginException</span>
                (&quot;Destroy Failed on Kerberos Private Credentials&quot;);
<span class="nc" id="L1245">        }</span>
<span class="nc" id="L1246">        kerbTicket = null;</span>
<span class="nc" id="L1247">        kerbKeys = null;</span>
<span class="nc" id="L1248">        kerbClientPrinc = null;</span>
<span class="nc" id="L1249">    }</span>

    /**
     * Clean out the state
     */
    private void cleanState() {

        // save input as shared state only if
        // authentication succeeded
<span class="fc bfc" id="L1258" title="All 2 branches covered.">        if (succeeded) {</span>
<span class="pc bpc" id="L1259" title="1 of 2 branches missed.">            if (storePass &amp;&amp;</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">                !sharedState.containsKey(NAME) &amp;&amp;</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">                !sharedState.containsKey(PWD)) {</span>
<span class="nc" id="L1262">                sharedState.put(NAME, username);</span>
<span class="nc" id="L1263">                sharedState.put(PWD, password);</span>
            }
        } else {
            // remove temp results for the next try
<span class="fc" id="L1267">            encKeys = null;</span>
<span class="fc" id="L1268">            ktab = null;</span>
<span class="fc" id="L1269">            principal = null;</span>
        }
<span class="fc" id="L1271">        username = null;</span>
<span class="fc" id="L1272">        password = null;</span>
<span class="pc bpc" id="L1273" title="2 of 4 branches missed.">        if (krb5PrincName != null &amp;&amp; krb5PrincName.length() != 0)</span>
<span class="fc" id="L1274">            krb5PrincName.delete(0, krb5PrincName.length());</span>
<span class="fc" id="L1275">        krb5PrincName = null;</span>
<span class="pc bpc" id="L1276" title="1 of 2 branches missed.">        if (clearPass) {</span>
<span class="nc" id="L1277">            sharedState.remove(NAME);</span>
<span class="nc" id="L1278">            sharedState.remove(PWD);</span>
        }
<span class="fc" id="L1280">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>