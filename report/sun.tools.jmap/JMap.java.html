<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>JMap.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.tools.jmap</a> &gt; <span class="el_source">JMap.java</span></div><h1>JMap.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jmap;

import java.lang.reflect.Method;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;

import com.sun.tools.attach.VirtualMachine;
import com.sun.tools.attach.AttachNotSupportedException;
import sun.tools.attach.HotSpotVirtualMachine;

/*
 * This class is the main class for the JMap utility. It parses its arguments
 * and decides if the command should be satisfied using the VM attach mechanism
 * or an SA tool. At this time the only option that uses the VM attach mechanism
 * is the -dump option to get a heap dump of a running application. All other
 * options are mapped to SA tools.
 */
<span class="nc bnc" id="L44" title="All 2 branches missed.">public class JMap {</span>

    // Options handled by the attach mechanism
<span class="nc" id="L47">    private static String HISTO_OPTION = &quot;-histo&quot;;</span>
<span class="nc" id="L48">    private static String LIVE_HISTO_OPTION = &quot;-histo:live&quot;;</span>
<span class="nc" id="L49">    private static String DUMP_OPTION_PREFIX = &quot;-dump:&quot;;</span>

    // These options imply the use of a SA tool
<span class="nc" id="L52">    private static String SA_TOOL_OPTIONS =</span>
      &quot;-heap|-heap:format=b|-clstats|-finalizerinfo&quot;;

    // The -F (force) option is currently not passed through to SA
<span class="nc" id="L56">    private static String FORCE_SA_OPTION = &quot;-F&quot;;</span>

    // Default option (if nothing provided)
<span class="nc" id="L59">    private static String DEFAULT_OPTION = &quot;-pmap&quot;;</span>

    public static void main(String[] args) throws Exception {
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (args.length == 0) {</span>
<span class="nc" id="L63">            usage(1); // no arguments</span>
        }

        // used to indicate if we should use SA
<span class="nc" id="L67">        boolean useSA = false;</span>

        // the chosen option (-heap, -dump:*, ... )
<span class="nc" id="L70">        String option = null;</span>

        // First iterate over the options (arguments starting with -).  There should be
        // one (but maybe two if -F is also used).
<span class="nc" id="L74">        int optionCount = 0;</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        while (optionCount &lt; args.length) {</span>
<span class="nc" id="L76">            String arg = args[optionCount];</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (!arg.startsWith(&quot;-&quot;)) {</span>
<span class="nc" id="L78">                break;</span>
            }
<span class="nc bnc" id="L80" title="All 4 branches missed.">            if (arg.equals(&quot;-help&quot;) || arg.equals(&quot;-h&quot;)) {</span>
<span class="nc" id="L81">                usage(0);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">            } else if (arg.equals(FORCE_SA_OPTION)) {</span>
<span class="nc" id="L83">                useSA = true;</span>
            } else {
<span class="nc bnc" id="L85" title="All 2 branches missed.">                if (option != null) {</span>
<span class="nc" id="L86">                    usage(1);  // option already specified</span>
                }
<span class="nc" id="L88">                option = arg;</span>
            }
<span class="nc" id="L90">            optionCount++;</span>
<span class="nc" id="L91">        }</span>

        // if no option provided then use default.
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (option == null) {</span>
<span class="nc" id="L95">            option = DEFAULT_OPTION;</span>
        }
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (option.matches(SA_TOOL_OPTIONS)) {</span>
<span class="nc" id="L98">            useSA = true;</span>
        }

        // Next we check the parameter count. For the SA tools there are
        // one or two parameters. For the built-in -dump option there is
        // only one parameter (the process-id)
<span class="nc" id="L104">        int paramCount = args.length - optionCount;</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">        if (paramCount == 0 || paramCount &gt; 2) {</span>
<span class="nc" id="L106">            usage(1);</span>
        }

<span class="nc bnc" id="L109" title="All 4 branches missed.">        if (optionCount == 0 || paramCount != 1) {</span>
<span class="nc" id="L110">            useSA = true;</span>
        } else {
            // the parameter for the -dump option is a process-id.
            // If it doesn't parse to a number then it must be SA
            // debug server
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (!args[optionCount].matches(&quot;[0-9]+&quot;)) {</span>
<span class="nc" id="L116">                useSA = true;</span>
            }
        }


        // at this point we know if we are executing an SA tool or a built-in
        // option.

<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (useSA) {</span>
            // parameters (&lt;pid&gt; or &lt;exe&gt; &lt;core&gt;)
<span class="nc" id="L126">            String params[] = new String[paramCount];</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            for (int i=optionCount; i&lt;args.length; i++ ){</span>
<span class="nc" id="L128">                params[i-optionCount] = args[i];</span>
            }
<span class="nc" id="L130">            runTool(option, params);</span>

<span class="nc" id="L132">        } else {</span>
<span class="nc" id="L133">            String pid = args[1];</span>
            // Here we handle the built-in options
            // As more options are added we should create an abstract tool class and
            // have a table to map the options
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (option.equals(HISTO_OPTION)) {</span>
<span class="nc" id="L138">                histo(pid, false);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            } else if (option.equals(LIVE_HISTO_OPTION)) {</span>
<span class="nc" id="L140">                histo(pid, true);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            } else if (option.startsWith(DUMP_OPTION_PREFIX)) {</span>
<span class="nc" id="L142">                dump(pid, option);</span>
            } else {
<span class="nc" id="L144">                usage(1);</span>
            }
        }
<span class="nc" id="L147">    }</span>

    // Invoke SA tool  with the given arguments
    private static void runTool(String option, String args[]) throws Exception {
<span class="nc" id="L151">        String[][] tools = {</span>
            { &quot;-pmap&quot;,          &quot;sun.jvm.hotspot.tools.PMap&quot;             },
            { &quot;-heap&quot;,          &quot;sun.jvm.hotspot.tools.HeapSummary&quot;      },
            { &quot;-heap:format=b&quot;, &quot;sun.jvm.hotspot.tools.HeapDumper&quot;       },
            { &quot;-histo&quot;,         &quot;sun.jvm.hotspot.tools.ObjectHistogram&quot;  },
            { &quot;-clstats&quot;,       &quot;sun.jvm.hotspot.tools.ClassLoaderStats&quot; },
            { &quot;-finalizerinfo&quot;, &quot;sun.jvm.hotspot.tools.FinalizerInfo&quot;    },
        };

<span class="nc" id="L160">        String tool = null;</span>

        // -dump option needs to be handled in a special way
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (option.startsWith(DUMP_OPTION_PREFIX)) {</span>
            // first check that the option can be parsed
<span class="nc" id="L165">            String fn = parseDumpOptions(option);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (fn == null) {</span>
<span class="nc" id="L167">                usage(1);</span>
            }

            // tool for heap dumping
<span class="nc" id="L171">            tool = &quot;sun.jvm.hotspot.tools.HeapDumper&quot;;</span>

            // HeapDumper -f &lt;file&gt;
<span class="nc" id="L174">            args = prepend(fn, args);</span>
<span class="nc" id="L175">            args = prepend(&quot;-f&quot;, args);</span>
<span class="nc" id="L176">        } else {</span>
<span class="nc" id="L177">            int i=0;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            while (i &lt; tools.length) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (option.equals(tools[i][0])) {</span>
<span class="nc" id="L180">                    tool = tools[i][1];</span>
<span class="nc" id="L181">                    break;</span>
                }
<span class="nc" id="L183">                i++;</span>
            }
        }
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (tool == null) {</span>
<span class="nc" id="L187">            usage(1);   // no mapping to tool</span>
        }

        // Tool not available on this  platform.
<span class="nc" id="L191">        Class&lt;?&gt; c = loadClass(tool);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L193">            usage(1);</span>
        }

        // invoke the main method with the arguments
<span class="nc" id="L197">        Class[] argTypes = { String[].class } ;</span>
<span class="nc" id="L198">        Method m = c.getDeclaredMethod(&quot;main&quot;, argTypes);</span>

<span class="nc" id="L200">        Object[] invokeArgs = { args };</span>
<span class="nc" id="L201">        m.invoke(null, invokeArgs);</span>
<span class="nc" id="L202">    }</span>

    // loads the given class using the system class loader
    private static Class&lt;?&gt; loadClass(String name) {
        //
        // We specify the system clas loader so as to cater for development
        // environments where this class is on the boot class path but sa-jdi.jar
        // is on the system class path. Once the JDK is deployed then both
        // tools.jar and sa-jdi.jar are on the system class path.
        //
        try {
<span class="nc" id="L213">            return Class.forName(name, true,</span>
<span class="nc" id="L214">                                 ClassLoader.getSystemClassLoader());</span>
<span class="nc" id="L215">        } catch (Exception x)  { }</span>
<span class="nc" id="L216">        return null;</span>
    }

    private static final String LIVE_OBJECTS_OPTION = &quot;-live&quot;;
    private static final String ALL_OBJECTS_OPTION = &quot;-all&quot;;
    private static void histo(String pid, boolean live) throws IOException {
<span class="nc" id="L222">        VirtualMachine vm = attach(pid);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        InputStream in = ((HotSpotVirtualMachine)vm).</span>
<span class="nc" id="L224">            heapHisto(live ? LIVE_OBJECTS_OPTION : ALL_OBJECTS_OPTION);</span>
<span class="nc" id="L225">        drain(vm, in);</span>
<span class="nc" id="L226">    }</span>

    private static void dump(String pid, String options) throws IOException {
        // parse the options to get the dump filename
<span class="nc" id="L230">        String filename = parseDumpOptions(options);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (filename == null) {</span>
<span class="nc" id="L232">            usage(1);  // invalid options or no filename</span>
        }

        // get the canonical path - important to avoid just passing
        // a &quot;heap.bin&quot; and having the dump created in the target VM
        // working directory rather than the directory where jmap
        // is executed.
<span class="nc" id="L239">        filename = new File(filename).getCanonicalPath();</span>

        // dump live objects only or not
<span class="nc" id="L242">        boolean live = isDumpLiveObjects(options);</span>

<span class="nc" id="L244">        VirtualMachine vm = attach(pid);</span>
<span class="nc" id="L245">        System.out.println(&quot;Dumping heap to &quot; + filename + &quot; ...&quot;);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        InputStream in = ((HotSpotVirtualMachine)vm).</span>
<span class="nc" id="L247">            dumpHeap((Object)filename,</span>
                     (live ? LIVE_OBJECTS_OPTION : ALL_OBJECTS_OPTION));
<span class="nc" id="L249">        drain(vm, in);</span>
<span class="nc" id="L250">    }</span>

    // Parse the options to the -dump option. Valid options are format=b and
    // file=&lt;file&gt;. Returns &lt;file&gt; if provided. Returns null if &lt;file&gt; not
    // provided, or invalid option.
    private static String parseDumpOptions(String arg) {
<span class="nc bnc" id="L256" title="All 4 branches missed.">        assert arg.startsWith(DUMP_OPTION_PREFIX);</span>

<span class="nc" id="L258">        String filename = null;</span>

        // options are separated by comma (,)
<span class="nc" id="L261">        String options[] = arg.substring(DUMP_OPTION_PREFIX.length()).split(&quot;,&quot;);</span>

<span class="nc bnc" id="L263" title="All 2 branches missed.">        for (int i=0; i&lt;options.length; i++) {</span>
<span class="nc" id="L264">            String option = options[i];</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (option.equals(&quot;format=b&quot;)) {</span>
                // ignore format (not needed at this time)
<span class="nc bnc" id="L268" title="All 2 branches missed.">            } else if (option.equals(&quot;live&quot;)) {</span>
                // a valid suboption
            } else {

                // file=&lt;file&gt; - check that &lt;file&gt; is specified
<span class="nc bnc" id="L273" title="All 2 branches missed.">                if (option.startsWith(&quot;file=&quot;)) {</span>
<span class="nc" id="L274">                    filename = option.substring(5);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                    if (filename.length() == 0) {</span>
<span class="nc" id="L276">                        return null;</span>
                    }
                } else {
<span class="nc" id="L279">                    return null;  // option not recognized</span>
                }
            }
        }
<span class="nc" id="L283">        return filename;</span>
    }

    private static boolean isDumpLiveObjects(String arg) {
        // options are separated by comma (,)
<span class="nc" id="L288">        String options[] = arg.substring(DUMP_OPTION_PREFIX.length()).split(&quot;,&quot;);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">        for (String suboption : options) {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">            if (suboption.equals(&quot;live&quot;)) {</span>
<span class="nc" id="L291">                return true;</span>
            }
        }
<span class="nc" id="L294">        return false;</span>
    }

    // Attach to &lt;pid&gt;, existing if we fail to attach
    private static VirtualMachine attach(String pid) {
        try {
<span class="nc" id="L300">            return VirtualMachine.attach(pid);</span>
<span class="nc" id="L301">        } catch (Exception x) {</span>
<span class="nc" id="L302">            String msg = x.getMessage();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (msg != null) {</span>
<span class="nc" id="L304">                System.err.println(pid + &quot;: &quot; + msg);</span>
            } else {
<span class="nc" id="L306">                x.printStackTrace();</span>
            }
<span class="nc bnc" id="L308" title="All 4 branches missed.">            if ((x instanceof AttachNotSupportedException) &amp;&amp; haveSA()) {</span>
<span class="nc" id="L309">                System.err.println(&quot;The -F option can be used when the &quot; +</span>
                  &quot;target process is not responding&quot;);
            }
<span class="nc" id="L312">            System.exit(1);</span>
<span class="nc" id="L313">            return null; // keep compiler happy</span>
        }
    }

    // Read the stream from the target VM until EOF, then detach
    private static void drain(VirtualMachine vm, InputStream in) throws IOException {
        // read to EOF and just print output
<span class="nc" id="L320">        byte b[] = new byte[256];</span>
        int n;
        do {
<span class="nc" id="L323">            n = in.read(b);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (n &gt; 0) {</span>
<span class="nc" id="L325">                String s = new String(b, 0, n, &quot;UTF-8&quot;);</span>
<span class="nc" id="L326">                System.out.print(s);</span>
            }
<span class="nc bnc" id="L328" title="All 2 branches missed.">        } while (n &gt; 0);</span>
<span class="nc" id="L329">        in.close();</span>
<span class="nc" id="L330">        vm.detach();</span>
<span class="nc" id="L331">    }</span>

    // return a new string array with arg as the first element
    private static String[] prepend(String arg, String args[]) {
<span class="nc" id="L335">        String[] newargs = new String[args.length+1];</span>
<span class="nc" id="L336">        newargs[0] = arg;</span>
<span class="nc" id="L337">        System.arraycopy(args, 0, newargs, 1, args.length);</span>
<span class="nc" id="L338">        return newargs;</span>
    }

    // returns true if SA is available
    private static boolean haveSA() {
<span class="nc" id="L343">        Class&lt;?&gt; c = loadClass(&quot;sun.jvm.hotspot.tools.HeapSummary&quot;);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">        return (c != null);</span>
    }

    // print usage message
    private static void usage(int exit) {
<span class="nc" id="L349">        System.err.println(&quot;Usage:&quot;);</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (haveSA()) {</span>
<span class="nc" id="L351">            System.err.println(&quot;    jmap [option] &lt;pid&gt;&quot;);</span>
<span class="nc" id="L352">            System.err.println(&quot;        (to connect to running process)&quot;);</span>
<span class="nc" id="L353">            System.err.println(&quot;    jmap [option] &lt;executable &lt;core&gt;&quot;);</span>
<span class="nc" id="L354">            System.err.println(&quot;        (to connect to a core file)&quot;);</span>
<span class="nc" id="L355">            System.err.println(&quot;    jmap [option] [server_id@]&lt;remote server IP or hostname&gt;&quot;);</span>
<span class="nc" id="L356">            System.err.println(&quot;        (to connect to remote debug server)&quot;);</span>
<span class="nc" id="L357">            System.err.println(&quot;&quot;);</span>
<span class="nc" id="L358">            System.err.println(&quot;where &lt;option&gt; is one of:&quot;);</span>
<span class="nc" id="L359">            System.err.println(&quot;    &lt;none&gt;               to print same info as Solaris pmap&quot;);</span>
<span class="nc" id="L360">            System.err.println(&quot;    -heap                to print java heap summary&quot;);</span>
<span class="nc" id="L361">            System.err.println(&quot;    -histo[:live]        to print histogram of java object heap; if the \&quot;live\&quot;&quot;);</span>
<span class="nc" id="L362">            System.err.println(&quot;                         suboption is specified, only count live objects&quot;);</span>
<span class="nc" id="L363">            System.err.println(&quot;    -clstats             to print class loader statistics&quot;);</span>
<span class="nc" id="L364">            System.err.println(&quot;    -finalizerinfo       to print information on objects awaiting finalization&quot;);</span>
<span class="nc" id="L365">            System.err.println(&quot;    -dump:&lt;dump-options&gt; to dump java heap in hprof binary format&quot;);</span>
<span class="nc" id="L366">            System.err.println(&quot;                         dump-options:&quot;);</span>
<span class="nc" id="L367">            System.err.println(&quot;                           live         dump only live objects; if not specified,&quot;);</span>
<span class="nc" id="L368">            System.err.println(&quot;                                        all objects in the heap are dumped.&quot;);</span>
<span class="nc" id="L369">            System.err.println(&quot;                           format=b     binary format&quot;);</span>
<span class="nc" id="L370">            System.err.println(&quot;                           file=&lt;file&gt;  dump heap to &lt;file&gt;&quot;);</span>
<span class="nc" id="L371">            System.err.println(&quot;                         Example: jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;&quot;);</span>
<span class="nc" id="L372">            System.err.println(&quot;    -F                   force. Use with -dump:&lt;dump-options&gt; &lt;pid&gt; or -histo&quot;);</span>
<span class="nc" id="L373">            System.err.println(&quot;                         to force a heap dump or histogram when &lt;pid&gt; does not&quot;);</span>
<span class="nc" id="L374">            System.err.println(&quot;                         respond. The \&quot;live\&quot; suboption is not supported&quot;);</span>
<span class="nc" id="L375">            System.err.println(&quot;                         in this mode.&quot;);</span>
<span class="nc" id="L376">            System.err.println(&quot;    -h | -help           to print this help message&quot;);</span>
<span class="nc" id="L377">            System.err.println(&quot;    -J&lt;flag&gt;             to pass &lt;flag&gt; directly to the runtime system&quot;);</span>
        } else {
<span class="nc" id="L379">            System.err.println(&quot;    jmap -histo &lt;pid&gt;&quot;);</span>
<span class="nc" id="L380">            System.err.println(&quot;      (to connect to running process and print histogram of java object heap&quot;);</span>
<span class="nc" id="L381">            System.err.println(&quot;    jmap -dump:&lt;dump-options&gt; &lt;pid&gt;&quot;);</span>
<span class="nc" id="L382">            System.err.println(&quot;      (to connect to running process and dump java heap)&quot;);</span>
<span class="nc" id="L383">            System.err.println(&quot;&quot;);</span>
<span class="nc" id="L384">            System.err.println(&quot;    dump-options:&quot;);</span>
<span class="nc" id="L385">            System.err.println(&quot;      format=b     binary default&quot;);</span>
<span class="nc" id="L386">            System.err.println(&quot;      file=&lt;file&gt;  dump heap to &lt;file&gt;&quot;);</span>
<span class="nc" id="L387">            System.err.println(&quot;&quot;);</span>
<span class="nc" id="L388">            System.err.println(&quot;    Example:       jmap -dump:format=b,file=heap.bin &lt;pid&gt;&quot;);</span>
        }

<span class="nc" id="L391">        System.exit(exit);</span>
<span class="nc" id="L392">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>