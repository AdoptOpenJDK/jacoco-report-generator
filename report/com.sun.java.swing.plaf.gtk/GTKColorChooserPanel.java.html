<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>GTKColorChooserPanel.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.java.swing.plaf.gtk</a> &gt; <span class="el_source">GTKColorChooserPanel.java</span></div><h1>GTKColorChooserPanel.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2002, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package com.sun.java.swing.plaf.gtk;

import java.awt.*;
import java.awt.event.*;
import java.awt.image.*;
import javax.swing.*;
import javax.swing.colorchooser.*;
import javax.swing.event.*;
import javax.swing.plaf.*;

/**
 * A color chooser panel mimicking that of GTK's: a color wheel showing
 * hue and a triangle that varies saturation and brightness.
 *
 * @author Scott Violet
 */
<span class="nc" id="L41">class GTKColorChooserPanel extends AbstractColorChooserPanel implements</span>
              ChangeListener {
    private static final float PI_3 = (float)(Math.PI / 3);

    private ColorTriangle triangle;
    private JLabel lastLabel;
    private JLabel label;

    private JSpinner hueSpinner;
    private JSpinner saturationSpinner;
    private JSpinner valueSpinner;

    private JSpinner redSpinner;
    private JSpinner greenSpinner;
    private JSpinner blueSpinner;

    private JTextField colorNameTF;

    private boolean settingColor;

    // The colors are mirrored to avoid creep in adjusting an individual
    // value.
    private float hue;
    private float saturation;
    private float brightness;



    /**
     * Convenience method to transfer focus to the next child of component.
     */
    // PENDING: remove this when a variant of this is added to awt.
    static void compositeRequestFocus(Component component, boolean direction) {
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (component instanceof Container) {</span>
<span class="nc" id="L75">            Container container = (Container)component;</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (container.isFocusCycleRoot()) {</span>
<span class="nc" id="L77">                FocusTraversalPolicy policy = container.</span>
<span class="nc" id="L78">                                              getFocusTraversalPolicy();</span>
<span class="nc" id="L79">                Component comp = policy.getDefaultComponent(container);</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                if (comp!=null) {</span>
<span class="nc" id="L81">                    comp.requestFocus();</span>
<span class="nc" id="L82">                    return;</span>
                }
            }
<span class="nc" id="L85">            Container rootAncestor = container.getFocusCycleRootAncestor();</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (rootAncestor!=null) {</span>
<span class="nc" id="L87">                FocusTraversalPolicy policy = rootAncestor.</span>
<span class="nc" id="L88">                                                  getFocusTraversalPolicy();</span>
                Component comp;

<span class="nc bnc" id="L91" title="All 2 branches missed.">                if (direction) {</span>
<span class="nc" id="L92">                    comp = policy.getComponentAfter(rootAncestor, container);</span>
                }
                else {
<span class="nc" id="L95">                    comp = policy.getComponentBefore(rootAncestor, container);</span>
                }
<span class="nc bnc" id="L97" title="All 2 branches missed.">                if (comp != null) {</span>
<span class="nc" id="L98">                    comp.requestFocus();</span>
<span class="nc" id="L99">                    return;</span>
                }
            }
        }
<span class="nc" id="L103">        component.requestFocus();</span>
<span class="nc" id="L104">    }</span>


    /**
     * Returns a user presentable description of this GTKColorChooserPane.
     */
    public String getDisplayName() {
<span class="nc" id="L111">        return (String)UIManager.get(&quot;GTKColorChooserPanel.nameText&quot;);</span>
    }

    /**
     * Returns the mnemonic to use with &lt;code&gt;getDisplayName&lt;/code&gt;.
     */
    public int getMnemonic() {
<span class="nc" id="L118">        String m = (String)UIManager.get(&quot;GTKColorChooserPanel.mnemonic&quot;);</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (m != null) {</span>
            try {
<span class="nc" id="L122">                int value = Integer.parseInt(m);</span>

<span class="nc" id="L124">                return value;</span>
<span class="nc" id="L125">            } catch (NumberFormatException nfe) {}</span>
        }
<span class="nc" id="L127">        return -1;</span>
    }

    /**
     * Character to underline that represents the mnemonic.
     */
    public int getDisplayedMnemonicIndex() {
<span class="nc" id="L134">        String m = (String)UIManager.get(</span>
                           &quot;GTKColorChooserPanel.displayedMnemonicIndex&quot;);

<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (m != null) {</span>
            try {
<span class="nc" id="L139">                int value = Integer.parseInt(m);</span>

<span class="nc" id="L141">                return value;</span>
<span class="nc" id="L142">            } catch (NumberFormatException nfe) {}</span>
        }
<span class="nc" id="L144">        return -1;</span>
    }

    public Icon getSmallDisplayIcon() {
<span class="nc" id="L148">        return null;</span>
    }

    public Icon getLargeDisplayIcon() {
<span class="nc" id="L152">        return null;</span>
    }

    public void uninstallChooserPanel(JColorChooser enclosingChooser) {
<span class="nc" id="L156">        super.uninstallChooserPanel(enclosingChooser);</span>
<span class="nc" id="L157">        removeAll();</span>
<span class="nc" id="L158">    }</span>

    /**
     * Builds and configures the widgets for the GTKColorChooserPanel.
     */
    protected void buildChooser() {
<span class="nc" id="L164">        triangle = new ColorTriangle();</span>
<span class="nc" id="L165">        triangle.setName(&quot;GTKColorChooserPanel.triangle&quot;);</span>

        // PENDING: when we straighten out user setting opacity, this should
        // be changed.
<span class="nc" id="L169">        label = new OpaqueLabel();</span>
<span class="nc" id="L170">        label.setName(&quot;GTKColorChooserPanel.colorWell&quot;);</span>
<span class="nc" id="L171">        label.setOpaque(true);</span>
<span class="nc" id="L172">        label.setMinimumSize(new Dimension(67, 32));</span>
<span class="nc" id="L173">        label.setPreferredSize(new Dimension(67, 32));</span>
<span class="nc" id="L174">        label.setMaximumSize(new Dimension(67, 32));</span>

        // PENDING: when we straighten out user setting opacity, this should
        // be changed.
<span class="nc" id="L178">        lastLabel = new OpaqueLabel();</span>
<span class="nc" id="L179">        lastLabel.setName(&quot;GTKColorChooserPanel.lastColorWell&quot;);</span>
<span class="nc" id="L180">        lastLabel.setOpaque(true);</span>
<span class="nc" id="L181">        lastLabel.setMinimumSize(new Dimension(67, 32));</span>
<span class="nc" id="L182">        lastLabel.setPreferredSize(new Dimension(67, 32));</span>
<span class="nc" id="L183">        lastLabel.setMaximumSize(new Dimension(67, 32));</span>

<span class="nc" id="L185">        hueSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 360, 1));</span>
<span class="nc" id="L186">        configureSpinner(hueSpinner, &quot;GTKColorChooserPanel.hueSpinner&quot;);</span>
<span class="nc" id="L187">        saturationSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 255, 1));</span>
<span class="nc" id="L188">        configureSpinner(saturationSpinner,</span>
                         &quot;GTKColorChooserPanel.saturationSpinner&quot;);
<span class="nc" id="L190">        valueSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 255, 1));</span>
<span class="nc" id="L191">        configureSpinner(valueSpinner, &quot;GTKColorChooserPanel.valueSpinner&quot;);</span>
<span class="nc" id="L192">        redSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 255, 1));</span>
<span class="nc" id="L193">        configureSpinner(redSpinner, &quot;GTKColorChooserPanel.redSpinner&quot;);</span>
<span class="nc" id="L194">        greenSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 255, 1));</span>
<span class="nc" id="L195">        configureSpinner(greenSpinner, &quot;GTKColorChooserPanel.greenSpinner&quot;);</span>
<span class="nc" id="L196">        blueSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 255, 1));</span>
<span class="nc" id="L197">        configureSpinner(blueSpinner, &quot;GTKColorChooserPanel.blueSpinner&quot;);</span>

<span class="nc" id="L199">        colorNameTF = new JTextField(8);</span>

<span class="nc" id="L201">        setLayout(new GridBagLayout());</span>

<span class="nc" id="L203">        add(this, &quot;GTKColorChooserPanel.hue&quot;, hueSpinner, -1, -1);</span>
<span class="nc" id="L204">        add(this, &quot;GTKColorChooserPanel.red&quot;, redSpinner, -1, -1);</span>
<span class="nc" id="L205">        add(this, &quot;GTKColorChooserPanel.saturation&quot;, saturationSpinner, -1,-1);</span>
<span class="nc" id="L206">        add(this, &quot;GTKColorChooserPanel.green&quot;, greenSpinner, -1, -1);</span>
<span class="nc" id="L207">        add(this, &quot;GTKColorChooserPanel.value&quot;, valueSpinner, -1, -1);</span>
<span class="nc" id="L208">        add(this, &quot;GTKColorChooserPanel.blue&quot;, blueSpinner, -1, -1);</span>

<span class="nc" id="L210">        add(new JSeparator(SwingConstants.HORIZONTAL), new</span>
                  GridBagConstraints(1, 3, 4, 1, 1, 0,
                  GridBagConstraints.LINE_START, GridBagConstraints.HORIZONTAL,
                  new Insets(14, 0, 0, 0), 0, 0));

<span class="nc" id="L215">        add(this, &quot;GTKColorChooserPanel.colorName&quot;, colorNameTF, 0, 4);</span>

<span class="nc" id="L217">        add(triangle, new GridBagConstraints(0, 0, 1, 5, 0, 0,</span>
                      GridBagConstraints.LINE_START, GridBagConstraints.NONE,
                      new Insets(14, 20, 2, 9), 0, 0));

<span class="nc" id="L221">        Box hBox = Box.createHorizontalBox();</span>
<span class="nc" id="L222">        hBox.add(lastLabel);</span>
<span class="nc" id="L223">        hBox.add(label);</span>
<span class="nc" id="L224">        add(hBox, new GridBagConstraints(0, 5, 1, 1, 0, 0,</span>
                      GridBagConstraints.CENTER, GridBagConstraints.NONE,
                      new Insets(0, 0, 0, 0), 0, 0));

<span class="nc" id="L228">        add(new JSeparator(SwingConstants.HORIZONTAL), new</span>
                  GridBagConstraints(0, 6, 5, 1, 1, 0,
                  GridBagConstraints.LINE_START, GridBagConstraints.HORIZONTAL,
                  new Insets(12, 0, 0, 0), 0, 0));
<span class="nc" id="L232">    }</span>

    /**
     * Configures the spinner.
     */
    private void configureSpinner(JSpinner spinner, String name) {
<span class="nc" id="L238">        spinner.addChangeListener(this);</span>
<span class="nc" id="L239">        spinner.setName(name);</span>
<span class="nc" id="L240">        JComponent editor = spinner.getEditor();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (editor instanceof JSpinner.DefaultEditor) {</span>
<span class="nc" id="L242">            JFormattedTextField ftf = ((JSpinner.DefaultEditor)editor).</span>
<span class="nc" id="L243">                                                 getTextField();</span>

<span class="nc" id="L245">            ftf.setFocusLostBehavior(JFormattedTextField.COMMIT_OR_REVERT);</span>
        }
<span class="nc" id="L247">    }</span>

    /**
     * Adds the widget creating a JLabel with the specified name.
     */
    private void add(Container parent, String key, JComponent widget,
                     int x, int y) {
<span class="nc" id="L254">        JLabel label = new JLabel(UIManager.getString(key + &quot;Text&quot;,</span>
<span class="nc" id="L255">                                                      getLocale()));</span>
<span class="nc" id="L256">        String mnemonic = (String)UIManager.get(key + &quot;Mnemonic&quot;, getLocale());</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (mnemonic != null) {</span>
            try {
<span class="nc" id="L260">                label.setDisplayedMnemonic(Integer.parseInt(mnemonic));</span>
<span class="nc" id="L261">            } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L262">            }</span>
<span class="nc" id="L263">            String mnemonicIndex = (String)UIManager.get(key + &quot;MnemonicIndex&quot;,</span>
<span class="nc" id="L264">                                                    getLocale());</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (mnemonicIndex != null) {</span>
                try {
<span class="nc" id="L268">                    label.setDisplayedMnemonicIndex(Integer.parseInt(</span>
                                                        mnemonicIndex));
<span class="nc" id="L270">                } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L271">                }</span>
            }
        }
<span class="nc" id="L274">        label.setLabelFor(widget);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (x &lt; 0) {</span>
<span class="nc" id="L276">            x = parent.getComponentCount() % 4;</span>
        }
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (y &lt; 0) {</span>
<span class="nc" id="L279">            y = parent.getComponentCount() / 4;</span>
        }
<span class="nc" id="L281">        GridBagConstraints con = new GridBagConstraints(x + 1, y, 1, 1, 0, 0,</span>
                   GridBagConstraints.FIRST_LINE_END, GridBagConstraints.NONE,
                   new Insets(4, 0, 0, 4), 0, 0);
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (y == 0) {</span>
<span class="nc" id="L285">            con.insets.top = 14;</span>
        }
<span class="nc" id="L287">        parent.add(label, con);</span>
<span class="nc" id="L288">        con.gridx++;</span>
<span class="nc" id="L289">        parent.add(widget, con);</span>
<span class="nc" id="L290">    }</span>

    /**
     * Refreshes the display from the model.
     */
    public void updateChooser() {
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (!settingColor) {</span>
<span class="nc" id="L297">            lastLabel.setBackground(getColorFromModel());</span>
<span class="nc" id="L298">            setColor(getColorFromModel(), true, true, false);</span>
        }
<span class="nc" id="L300">    }</span>

    /**
     * Resets the red component of the selected color.
     */
    private void setRed(int red) {
<span class="nc" id="L306">        setRGB(red &lt;&lt; 16 | getColor().getGreen() &lt;&lt; 8 | getColor().getBlue());</span>
<span class="nc" id="L307">    }</span>

    /**
     * Resets the green component of the selected color.
     */
    private void setGreen(int green) {
<span class="nc" id="L313">        setRGB(getColor().getRed() &lt;&lt; 16 | green &lt;&lt; 8 | getColor().getBlue());</span>
<span class="nc" id="L314">    }</span>

    /**
     * Resets the blue component of the selected color.
     */
    private void setBlue(int blue) {
<span class="nc" id="L320">        setRGB(getColor().getRed() &lt;&lt; 16 | getColor().getGreen() &lt;&lt; 8 | blue);</span>
<span class="nc" id="L321">    }</span>

    /**
     * Sets the hue of the selected color and updates the display if
     * necessary.
     */
    private void setHue(float hue, boolean update) {
<span class="nc" id="L328">        setHSB(hue, saturation, brightness);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">        if (update) {</span>
<span class="nc" id="L330">            settingColor = true;</span>
<span class="nc" id="L331">            hueSpinner.setValue(Integer.valueOf((int)(hue * 360)));</span>
<span class="nc" id="L332">            settingColor = false;</span>
        }
<span class="nc" id="L334">    }</span>

    /**
     * Returns the current amount of hue.
     */
    private float getHue() {
<span class="nc" id="L340">        return hue;</span>
    }

    /**
     * Resets the saturation.
     */
    private void setSaturation(float saturation) {
<span class="nc" id="L347">        setHSB(hue, saturation, brightness);</span>
<span class="nc" id="L348">    }</span>

    /**
     * Returns the saturation.
     */
    private float getSaturation() {
<span class="nc" id="L354">        return saturation;</span>
    }

    /**
     * Sets the brightness.
     */
    private void setBrightness(float brightness) {
<span class="nc" id="L361">        setHSB(hue, saturation, brightness);</span>
<span class="nc" id="L362">    }</span>

    /**
     * Returns the brightness.
     */
    private float getBrightness() {
<span class="nc" id="L368">        return brightness;</span>
    }

    /**
     * Sets the saturation and brightness and updates the display if
     * necessary.
     */
    private void setSaturationAndBrightness(float s, float b, boolean update) {
<span class="nc" id="L376">        setHSB(hue, s, b);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (update) {</span>
<span class="nc" id="L378">            settingColor = true;</span>
<span class="nc" id="L379">            saturationSpinner.setValue(Integer.valueOf((int)(s * 255)));</span>
<span class="nc" id="L380">            valueSpinner.setValue(Integer.valueOf((int)(b * 255)));</span>
<span class="nc" id="L381">            settingColor = false;</span>
        }
<span class="nc" id="L383">    }</span>

    /**
     * Resets the rgb values.
     */
    private void setRGB(int rgb) {
<span class="nc" id="L389">        Color color = new Color(rgb);</span>

<span class="nc" id="L391">        setColor(color, false, true, true);</span>

<span class="nc" id="L393">        settingColor = true;</span>
<span class="nc" id="L394">        hueSpinner.setValue(Integer.valueOf((int)(hue * 360)));</span>
<span class="nc" id="L395">        saturationSpinner.setValue(Integer.valueOf((int)(saturation * 255)));</span>
<span class="nc" id="L396">        valueSpinner.setValue(Integer.valueOf((int)(brightness * 255)));</span>
<span class="nc" id="L397">        settingColor = false;</span>
<span class="nc" id="L398">    }</span>

    /**
     * Resets the hsb values.
     */
    private void setHSB(float h, float s, float b) {
<span class="nc" id="L404">        Color color = Color.getHSBColor(h, s, b);</span>

<span class="nc" id="L406">        this.hue = h;</span>
<span class="nc" id="L407">        this.saturation = s;</span>
<span class="nc" id="L408">        this.brightness = b;</span>
<span class="nc" id="L409">        setColor(color, false, false, true);</span>

<span class="nc" id="L411">        settingColor = true;</span>
<span class="nc" id="L412">        redSpinner.setValue(Integer.valueOf(color.getRed()));</span>
<span class="nc" id="L413">        greenSpinner.setValue(Integer.valueOf(color.getGreen()));</span>
<span class="nc" id="L414">        blueSpinner.setValue(Integer.valueOf(color.getBlue()));</span>
<span class="nc" id="L415">        settingColor = false;</span>
<span class="nc" id="L416">    }</span>


    /**
     * Rests the color.
     *
     * @param color new Color
     * @param updateSpinners whether or not to update the spinners.
     * @param updateHSB if true, the hsb fields are updated based on the
     *                  new color
     * @param updateModel if true, the model is set.
     */
    private void setColor(Color color, boolean updateSpinners,
                          boolean updateHSB, boolean updateModel) {
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (color == null) {</span>
<span class="nc" id="L431">            color = Color.BLACK;</span>
        }

<span class="nc" id="L434">        settingColor = true;</span>

<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (updateHSB) {</span>
<span class="nc" id="L437">            float[] hsb = Color.RGBtoHSB(color.getRed(), color.getGreen(),</span>
<span class="nc" id="L438">                                         color.getBlue(), null);</span>
<span class="nc" id="L439">            hue = hsb[0];</span>
<span class="nc" id="L440">            saturation = hsb[1];</span>
<span class="nc" id="L441">            brightness = hsb[2];</span>
        }

<span class="nc bnc" id="L444" title="All 2 branches missed.">        if (updateModel) {</span>
<span class="nc" id="L445">            ColorSelectionModel model = getColorSelectionModel();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (model != null) {</span>
<span class="nc" id="L447">                model.setSelectedColor(color);</span>
            }
        }

<span class="nc" id="L451">        triangle.setColor(hue, saturation, brightness);</span>
<span class="nc" id="L452">        label.setBackground(color);</span>
        // Force Integer to pad the string with 0's by adding 0x1000000 and
        // then removing the first character.
<span class="nc" id="L455">        String hexString = Integer.toHexString(</span>
<span class="nc" id="L456">                  (color.getRGB() &amp; 0xFFFFFF) | 0x1000000);</span>
<span class="nc" id="L457">        colorNameTF.setText(&quot;#&quot; + hexString.substring(1));</span>

<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (updateSpinners) {</span>
<span class="nc" id="L460">            redSpinner.setValue(Integer.valueOf(color.getRed()));</span>
<span class="nc" id="L461">            greenSpinner.setValue(Integer.valueOf(color.getGreen()));</span>
<span class="nc" id="L462">            blueSpinner.setValue(Integer.valueOf(color.getBlue()));</span>

<span class="nc" id="L464">            hueSpinner.setValue(Integer.valueOf((int)(hue * 360)));</span>
<span class="nc" id="L465">            saturationSpinner.setValue(Integer.valueOf((int)(saturation * 255)));</span>
<span class="nc" id="L466">            valueSpinner.setValue(Integer.valueOf((int)(brightness * 255)));</span>
        }
<span class="nc" id="L468">        settingColor = false;</span>
<span class="nc" id="L469">    }</span>

    public Color getColor() {
<span class="nc" id="L472">        return label.getBackground();</span>
    }

    /**
     * ChangeListener method, updates the necessary display widgets.
     */
    public void stateChanged(ChangeEvent e) {
<span class="nc bnc" id="L479" title="All 2 branches missed.">        if (settingColor) {</span>
<span class="nc" id="L480">            return;</span>
        }
<span class="nc" id="L482">        Color color = getColor();</span>

<span class="nc bnc" id="L484" title="All 2 branches missed.">        if (e.getSource() == hueSpinner) {</span>
<span class="nc" id="L485">            setHue(((Number)hueSpinner.getValue()).floatValue() / 360, false);</span>
        }
<span class="nc bnc" id="L487" title="All 2 branches missed.">        else if (e.getSource() == saturationSpinner) {</span>
<span class="nc" id="L488">            setSaturation(((Number)saturationSpinner.getValue()).</span>
<span class="nc" id="L489">                          floatValue() / 255);</span>
        }
<span class="nc bnc" id="L491" title="All 2 branches missed.">        else if (e.getSource() == valueSpinner) {</span>
<span class="nc" id="L492">            setBrightness(((Number)valueSpinner.getValue()).</span>
<span class="nc" id="L493">                          floatValue() / 255);</span>
        }
<span class="nc bnc" id="L495" title="All 2 branches missed.">        else if (e.getSource() == redSpinner) {</span>
<span class="nc" id="L496">            setRed(((Number)redSpinner.getValue()).intValue());</span>
        }
<span class="nc bnc" id="L498" title="All 2 branches missed.">        else if (e.getSource() == greenSpinner) {</span>
<span class="nc" id="L499">            setGreen(((Number)greenSpinner.getValue()).intValue());</span>
        }
<span class="nc bnc" id="L501" title="All 2 branches missed.">        else if (e.getSource() == blueSpinner) {</span>
<span class="nc" id="L502">            setBlue(((Number)blueSpinner.getValue()).intValue());</span>
        }
<span class="nc" id="L504">    }</span>



    /**
     * Flag indicating the angle, or hue, has changed and the triangle
     * needs to be recreated.
     */
    private static final int FLAGS_CHANGED_ANGLE = 1 &lt;&lt; 0;
    /**
     * Indicates the wheel is being dragged.
     */
    private static final int FLAGS_DRAGGING = 1 &lt;&lt; 1;
    /**
     * Indicates the triangle is being dragged.
     */
    private static final int FLAGS_DRAGGING_TRIANGLE = 1 &lt;&lt; 2;
    /**
     * Indicates a color is being set and we should ignore setColor
     */
    private static final int FLAGS_SETTING_COLOR = 1 &lt;&lt; 3;
    /**
     * Indicates the wheel has focus.
     */
    private static final int FLAGS_FOCUSED_WHEEL = 1 &lt;&lt; 4;
    /**
     * Indicates the triangle has focus.
     */
    private static final int FLAGS_FOCUSED_TRIANGLE = 1 &lt;&lt; 5;


    /**
     * Class responsible for rendering a color wheel and color triangle.
     */
    private class ColorTriangle extends JPanel {
        /**
         * Cached image of the wheel.
         */
        private Image wheelImage;

        /**
         * Cached image of the triangle.
         */
        private Image triangleImage;

        /**
         * Angle triangle is rotated by.
         */
        private double angle;

        /**
         * Boolean bitmask.
         */
        private int flags;

        /**
         * X location of selected color indicator.
         */
        private int circleX;
        /**
         * Y location of selected color indicator.
         */
        private int circleY;


<span class="nc" id="L569">        public ColorTriangle() {</span>
<span class="nc" id="L570">            enableEvents(AWTEvent.FOCUS_EVENT_MASK);</span>
<span class="nc" id="L571">            enableEvents(AWTEvent.MOUSE_EVENT_MASK);</span>
<span class="nc" id="L572">            enableEvents(AWTEvent.MOUSE_MOTION_EVENT_MASK);</span>

<span class="nc" id="L574">            setMinimumSize(new Dimension(getWheelRadius() * 2 + 2,</span>
<span class="nc" id="L575">                                         getWheelRadius() * 2 + 2));</span>
<span class="nc" id="L576">            setPreferredSize(new Dimension(getWheelRadius() * 2 + 2,</span>
<span class="nc" id="L577">                                           getWheelRadius() * 2 + 2));</span>

            // We want to handle tab ourself.
<span class="nc" id="L580">            setFocusTraversalKeysEnabled(false);</span>

            // PENDING: this should come from the style.
<span class="nc" id="L583">            getInputMap().put(KeyStroke.getKeyStroke(&quot;UP&quot;), &quot;up&quot;);</span>
<span class="nc" id="L584">            getInputMap().put(KeyStroke.getKeyStroke(&quot;DOWN&quot;), &quot;down&quot;);</span>
<span class="nc" id="L585">            getInputMap().put(KeyStroke.getKeyStroke(&quot;LEFT&quot;), &quot;left&quot;);</span>
<span class="nc" id="L586">            getInputMap().put(KeyStroke.getKeyStroke(&quot;RIGHT&quot;), &quot;right&quot;);</span>

<span class="nc" id="L588">            getInputMap().put(KeyStroke.getKeyStroke(&quot;KP_UP&quot;), &quot;up&quot;);</span>
<span class="nc" id="L589">            getInputMap().put(KeyStroke.getKeyStroke(&quot;KP_DOWN&quot;), &quot;down&quot;);</span>
<span class="nc" id="L590">            getInputMap().put(KeyStroke.getKeyStroke(&quot;KP_LEFT&quot;), &quot;left&quot;);</span>
<span class="nc" id="L591">            getInputMap().put(KeyStroke.getKeyStroke(&quot;KP_RIGHT&quot;), &quot;right&quot;);</span>

<span class="nc" id="L593">            getInputMap().put(KeyStroke.getKeyStroke(&quot;TAB&quot;), &quot;focusNext&quot;);</span>
<span class="nc" id="L594">            getInputMap().put(KeyStroke.getKeyStroke(&quot;shift TAB&quot;),&quot;focusLast&quot;);</span>

<span class="nc" id="L596">            ActionMap map = (ActionMap)UIManager.get(</span>
                                       &quot;GTKColorChooserPanel.actionMap&quot;);

<span class="nc bnc" id="L599" title="All 2 branches missed.">            if (map == null) {</span>
<span class="nc" id="L600">                map = new ActionMapUIResource();</span>
<span class="nc" id="L601">                map.put(&quot;left&quot;, new ColorAction(&quot;left&quot;, 2));</span>
<span class="nc" id="L602">                map.put(&quot;right&quot;, new ColorAction(&quot;right&quot;, 3));</span>
<span class="nc" id="L603">                map.put(&quot;up&quot;, new ColorAction(&quot;up&quot;, 0));</span>
<span class="nc" id="L604">                map.put(&quot;down&quot;, new ColorAction(&quot;down&quot;, 1));</span>
<span class="nc" id="L605">                map.put(&quot;focusNext&quot;, new ColorAction(&quot;focusNext&quot;, 4));</span>
<span class="nc" id="L606">                map.put(&quot;focusLast&quot;, new ColorAction(&quot;focusLast&quot;, 5));</span>
<span class="nc" id="L607">                UIManager.getLookAndFeelDefaults().put(</span>
                             &quot;GTKColorChooserPanel.actionMap&quot;, map);
            }
<span class="nc" id="L610">            SwingUtilities.replaceUIActionMap(this, map);</span>
<span class="nc" id="L611">        }</span>

        /**
         * Returns the GTKColorChooserPanel.
         */
        GTKColorChooserPanel getGTKColorChooserPanel() {
<span class="nc" id="L617">            return GTKColorChooserPanel.this;</span>
        }

        /**
         * Gives focus to the wheel.
         */
        void focusWheel() {
<span class="nc" id="L624">            setFocusType(1);</span>
<span class="nc" id="L625">        }</span>

        /**
         * Gives focus to the triangle.
         */
        void focusTriangle() {
<span class="nc" id="L631">            setFocusType(2);</span>
<span class="nc" id="L632">        }</span>

        /**
         * Returns true if the wheel currently has focus.
         */
        boolean isWheelFocused() {
<span class="nc" id="L638">            return isSet(FLAGS_FOCUSED_WHEEL);</span>
        }

        /**
         * Resets the selected color.
         */
        public void setColor(float h, float s, float b) {
<span class="nc bnc" id="L645" title="All 2 branches missed.">            if (isSet(FLAGS_SETTING_COLOR)) {</span>
<span class="nc" id="L646">                return;</span>
            }

<span class="nc" id="L649">            setAngleFromHue(h);</span>
<span class="nc" id="L650">            setSaturationAndBrightness(s, b);</span>
<span class="nc" id="L651">        }</span>

        /**
         * Returns the selected color.
         */
        public Color getColor() {
<span class="nc" id="L657">            return GTKColorChooserPanel.this.getColor();</span>
        }

        /**
         * Returns the x location of the selected color indicator.
         */
        int getColorX() {
<span class="nc" id="L664">            return circleX + getIndicatorSize() / 2 - getWheelXOrigin();</span>
        }

        /**
         * Returns the y location of the selected color indicator.
         */
        int getColorY() {
<span class="nc" id="L671">            return circleY + getIndicatorSize() / 2 - getWheelYOrigin();</span>
        }

        protected void processEvent(AWTEvent e) {
<span class="nc bnc" id="L675" title="All 2 branches missed.">            if (e.getID() == MouseEvent.MOUSE_PRESSED ||</span>
<span class="nc bnc" id="L676" title="All 4 branches missed.">                   ((isSet(FLAGS_DRAGGING) ||isSet(FLAGS_DRAGGING_TRIANGLE)) &amp;&amp;</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">                   e.getID() == MouseEvent.MOUSE_DRAGGED)) {</span>
                // Assign focus to either the wheel or triangle and attempt
                // to drag either the wheel or triangle.
<span class="nc" id="L680">                int size = getWheelRadius();</span>
<span class="nc" id="L681">                int x = ((MouseEvent)e).getX() - size;</span>
<span class="nc" id="L682">                int y = ((MouseEvent)e).getY() - size;</span>

<span class="nc bnc" id="L684" title="All 2 branches missed.">                if (!hasFocus()) {</span>
<span class="nc" id="L685">                    requestFocus();</span>
                }
<span class="nc bnc" id="L687" title="All 2 branches missed.">                if (!isSet(FLAGS_DRAGGING_TRIANGLE) &amp;&amp;</span>
<span class="nc bnc" id="L688" title="All 4 branches missed.">                      adjustHue(x, y, e.getID() == MouseEvent.MOUSE_PRESSED)) {</span>
<span class="nc" id="L689">                    setFlag(FLAGS_DRAGGING, true);</span>
<span class="nc" id="L690">                    setFocusType(1);</span>
                }
<span class="nc bnc" id="L692" title="All 4 branches missed.">                else if (adjustSB(x, y, e.getID() ==</span>
                                        MouseEvent.MOUSE_PRESSED)) {
<span class="nc" id="L694">                    setFlag(FLAGS_DRAGGING_TRIANGLE, true);</span>
<span class="nc" id="L695">                    setFocusType(2);</span>
                }
                else {
<span class="nc" id="L698">                    setFocusType(2);</span>
                }
<span class="nc" id="L700">            }</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">            else if (e.getID() == MouseEvent.MOUSE_RELEASED) {</span>
                // Stopped dragging
<span class="nc" id="L703">                setFlag(FLAGS_DRAGGING_TRIANGLE, false);</span>
<span class="nc" id="L704">                setFlag(FLAGS_DRAGGING, false);</span>
            }
<span class="nc bnc" id="L706" title="All 2 branches missed.">            else if (e.getID() == FocusEvent.FOCUS_LOST) {</span>
                // Reset the flags to indicate no one has focus
<span class="nc" id="L708">                setFocusType(0);</span>
            }
<span class="nc bnc" id="L710" title="All 2 branches missed.">            else if (e.getID() == FocusEvent.FOCUS_GAINED) {</span>
                // Gained focus, reassign focus to the wheel if no one
                // currently has focus.
<span class="nc bnc" id="L713" title="All 2 branches missed.">                if (!isSet(FLAGS_FOCUSED_TRIANGLE) &amp;&amp;</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">                          !isSet(FLAGS_FOCUSED_WHEEL)) {</span>
<span class="nc" id="L715">                    setFlag(FLAGS_FOCUSED_WHEEL, true);</span>
<span class="nc" id="L716">                    setFocusType(1);</span>
                }
<span class="nc" id="L718">                repaint();</span>
            }
<span class="nc" id="L720">            super.processEvent(e);</span>
<span class="nc" id="L721">        }</span>

        public void paintComponent(Graphics g) {
<span class="nc" id="L724">            super.paintComponent(g);</span>

            // Draw the wheel and triangle
<span class="nc" id="L727">            int size = getWheelRadius();</span>
<span class="nc" id="L728">            int width = getWheelWidth();</span>
<span class="nc" id="L729">            Image image = getImage(size);</span>
<span class="nc" id="L730">            g.drawImage(image, getWheelXOrigin() - size,</span>
<span class="nc" id="L731">                        getWheelYOrigin() - size, null);</span>

            // Draw the focus indicator for the wheel
<span class="nc bnc" id="L734" title="All 4 branches missed.">            if (hasFocus() &amp;&amp; isSet(FLAGS_FOCUSED_WHEEL)) {</span>
<span class="nc" id="L735">                g.setColor(Color.BLACK);</span>
<span class="nc" id="L736">                g.drawOval(getWheelXOrigin() - size, getWheelYOrigin() - size,</span>
                           2 * size, 2 * size);
<span class="nc" id="L738">                g.drawOval(getWheelXOrigin() - size + width, getWheelYOrigin()-</span>
                           size + width, 2 * (size - width), 2 *
                           (size - width));
            }

            // Draw a line on the wheel indicating the selected hue.
<span class="nc bnc" id="L744" title="All 2 branches missed.">            if (Math.toDegrees(Math.PI * 2 - angle) &lt;= 20 ||</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">                     Math.toDegrees(Math.PI * 2 - angle) &gt;= 201) {</span>
<span class="nc" id="L746">                g.setColor(Color.WHITE);</span>
            }
            else {
<span class="nc" id="L749">                g.setColor(Color.BLACK);</span>
            }
<span class="nc" id="L751">            int lineX0 = (int)(Math.cos(angle) * size);</span>
<span class="nc" id="L752">            int lineY0 = (int)(Math.sin(angle) * size);</span>
<span class="nc" id="L753">            int lineX1 = (int)(Math.cos(angle) * (size - width));</span>
<span class="nc" id="L754">            int lineY1 = (int)(Math.sin(angle) * (size - width));</span>
<span class="nc" id="L755">            g.drawLine(lineX0 + size, lineY0 + size, lineX1 + size,</span>
                       lineY1 + size);

            // Draw the focus indicator on the triangle
<span class="nc bnc" id="L759" title="All 4 branches missed.">            if (hasFocus() &amp;&amp; isSet(FLAGS_FOCUSED_TRIANGLE)) {</span>
<span class="nc" id="L760">                Graphics g2 = g.create();</span>
<span class="nc" id="L761">                int innerR = getTriangleCircumscribedRadius();</span>
<span class="nc" id="L762">                int a = (int)(3 * innerR / Math.sqrt(3));</span>
<span class="nc" id="L763">                g2.translate(getWheelXOrigin(), getWheelYOrigin());</span>
<span class="nc" id="L764">                ((Graphics2D)g2).rotate(angle + Math.PI / 2);</span>
<span class="nc" id="L765">                g2.setColor(Color.BLACK);</span>
<span class="nc" id="L766">                g2.drawLine(0, -innerR, a / 2, innerR / 2);</span>
<span class="nc" id="L767">                g2.drawLine(a / 2, innerR / 2, -a / 2, innerR / 2);</span>
<span class="nc" id="L768">                g2.drawLine(-a / 2, innerR / 2, 0, -innerR);</span>
<span class="nc" id="L769">                g2.dispose();</span>
            }

            // Draw the selected color indicator.
<span class="nc" id="L773">            g.setColor(Color.BLACK);</span>
<span class="nc" id="L774">            g.drawOval(circleX, circleY, getIndicatorSize() - 1,</span>
<span class="nc" id="L775">                       getIndicatorSize() - 1);</span>
<span class="nc" id="L776">            g.setColor(Color.WHITE);</span>
<span class="nc" id="L777">            g.drawOval(circleX + 1, circleY + 1, getIndicatorSize() - 3,</span>
<span class="nc" id="L778">                       getIndicatorSize() - 3);</span>
<span class="nc" id="L779">        }</span>

        /**
         * Returns an image representing the triangle and wheel.
         */
        private Image getImage(int size) {
<span class="nc bnc" id="L785" title="All 4 branches missed.">            if (!isSet(FLAGS_CHANGED_ANGLE) &amp;&amp; wheelImage != null &amp;&amp;</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">                        wheelImage.getWidth(null) == size * 2) {</span>
<span class="nc" id="L787">                return wheelImage;</span>
            }
<span class="nc bnc" id="L789" title="All 4 branches missed.">            if (wheelImage == null || wheelImage.getWidth(null) != size) {</span>
<span class="nc" id="L790">                wheelImage = getWheelImage(size);</span>
            }
<span class="nc" id="L792">            int innerR = getTriangleCircumscribedRadius();</span>
<span class="nc" id="L793">            int triangleSize = (int)(innerR * 3.0 / 2.0);</span>
<span class="nc" id="L794">            int a = (int)(2 * triangleSize / Math.sqrt(3));</span>
<span class="nc bnc" id="L795" title="All 4 branches missed.">            if (triangleImage == null || triangleImage.getWidth(null) != a) {</span>
<span class="nc" id="L796">                triangleImage = new BufferedImage(a, a,</span>
                                                  BufferedImage.TYPE_INT_ARGB);
            }
<span class="nc" id="L799">            Graphics g = triangleImage.getGraphics();</span>
<span class="nc" id="L800">            g.setColor(new Color(0, 0, 0, 0));</span>
<span class="nc" id="L801">            g.fillRect(0, 0, a, a);</span>
<span class="nc" id="L802">            g.translate(a / 2, 0);</span>
<span class="nc" id="L803">            paintTriangle(g, triangleSize, getColor());</span>
<span class="nc" id="L804">            g.translate(-a / 2, 0);</span>
<span class="nc" id="L805">            g.dispose();</span>

<span class="nc" id="L807">            g = wheelImage.getGraphics();</span>
<span class="nc" id="L808">            g.setColor(new Color(0, 0, 0, 0));</span>
<span class="nc" id="L809">            g.fillOval(getWheelWidth(), getWheelWidth(),</span>
<span class="nc" id="L810">                       2 * (size - getWheelWidth()),</span>
<span class="nc" id="L811">                       2 * (size - getWheelWidth()));</span>

<span class="nc" id="L813">            double rotate = Math.toRadians(-30.0) + angle;</span>
<span class="nc" id="L814">            g.translate(size, size);</span>
<span class="nc" id="L815">            ((Graphics2D)g).rotate(rotate);</span>
<span class="nc" id="L816">            g.drawImage(triangleImage, -a / 2,</span>
<span class="nc" id="L817">                        getWheelWidth() - size, null);</span>
<span class="nc" id="L818">            ((Graphics2D)g).rotate(-rotate);</span>
<span class="nc" id="L819">            g.translate(a / 2, size - getWheelWidth());</span>

<span class="nc" id="L821">            setFlag(FLAGS_CHANGED_ANGLE, false);</span>

<span class="nc" id="L823">            return wheelImage;</span>
        }

        private void paintTriangle(Graphics g, int size, Color color) {
<span class="nc" id="L827">            float[] colors = Color.RGBtoHSB(color.getRed(),</span>
<span class="nc" id="L828">                                            color.getGreen(),</span>
<span class="nc" id="L829">                                            color.getBlue(), null);</span>
<span class="nc" id="L830">            float hue = colors[0];</span>
<span class="nc" id="L831">            double dSize = (double)size;</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">            for (int y = 0; y &lt; size; y++) {</span>
<span class="nc" id="L833">                int maxX = (int)(y * Math.tan(Math.toRadians(30.0)));</span>
<span class="nc" id="L834">                float factor = maxX * 2;</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">                if (maxX &gt; 0) {</span>
<span class="nc" id="L836">                    float value = (float)(y / dSize);</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">                    for (int x = -maxX; x &lt;= maxX; x++) {</span>
<span class="nc" id="L838">                        float saturation = (float)x / factor + .5f;</span>
<span class="nc" id="L839">                        g.setColor(Color.getHSBColor(hue, saturation, value));</span>
<span class="nc" id="L840">                        g.fillRect(x, y, 1, 1);</span>
                    }
<span class="nc" id="L842">                }</span>
                else {
<span class="nc" id="L844">                    g.setColor(color);</span>
<span class="nc" id="L845">                    g.fillRect(0, y, 1, 1);</span>
                }
            }
<span class="nc" id="L848">        }</span>

        /**
         * Returns a color wheel image for the specified size.
         *
         * @param size Integer giving size of color wheel.
         * @return Color wheel image
         */
        private Image getWheelImage(int size) {
<span class="nc" id="L857">            int minSize = size - getWheelWidth();</span>
<span class="nc" id="L858">            int doubleSize = size * 2;</span>
<span class="nc" id="L859">            BufferedImage image = new BufferedImage(doubleSize, doubleSize,</span>
                                              BufferedImage.TYPE_INT_ARGB);

<span class="nc bnc" id="L862" title="All 2 branches missed.">            for (int y = -size; y &lt; size; y++) {</span>
<span class="nc" id="L863">                int ySquared = y * y;</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">                for (int x = -size; x &lt; size; x++) {</span>
<span class="nc" id="L865">                    double rad = Math.sqrt(ySquared + x * x);</span>

<span class="nc bnc" id="L867" title="All 4 branches missed.">                    if (rad &lt; size &amp;&amp; rad &gt; minSize) {</span>
<span class="nc" id="L868">                        int rgb = colorWheelLocationToRGB(x, y, rad) |</span>
                              0xFF000000;
<span class="nc" id="L870">                        image.setRGB(x + size, y + size, rgb);</span>
                    }
                }
            }
<span class="nc" id="L874">            wheelImage = image;</span>
<span class="nc" id="L875">            return wheelImage;</span>
        }

        /**
         * Adjusts the saturation and brightness. &lt;code&gt;x&lt;/code&gt; and
         * &lt;code&gt;y&lt;/code&gt; give the location to adjust to and are relative
         * to the origin of the wheel/triangle.
         *
         * @param x X coordinate on the triangle to adjust to
         * @param y Y coordinate on the triangle to adjust to
         * @param checkLoc if true the location is checked to make sure
         *        it is contained in the triangle, if false the location is
         *        constrained to fit in the triangle.
         * @return true if the location is valid
         */
        boolean adjustSB(int x, int y, boolean checkLoc) {
<span class="nc" id="L891">            int innerR = getWheelRadius() - getWheelWidth();</span>
<span class="nc" id="L892">            boolean resetXY = false;</span>
            // Invert the axis.
<span class="nc" id="L894">            y = -y;</span>
<span class="nc bnc" id="L895" title="All 10 branches missed.">            if (checkLoc &amp;&amp; (x &lt; -innerR || x &gt; innerR || y &lt; -innerR ||</span>
                             y &gt; innerR)) {
<span class="nc" id="L897">                return false;</span>
            }
            // Rotate to origin and and verify x is valid.
<span class="nc" id="L900">            int triangleSize = innerR * 3 / 2;</span>
<span class="nc" id="L901">            double x1 = Math.cos(angle) * x - Math.sin(angle) * y;</span>
<span class="nc" id="L902">            double y1 = Math.sin(angle) * x + Math.cos(angle) * y;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">            if (x1 &lt; -(innerR / 2)) {</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">                if (checkLoc) {</span>
<span class="nc" id="L905">                    return false;</span>
                }
<span class="nc" id="L907">                x1 = -innerR / 2;</span>
<span class="nc" id="L908">                resetXY = true;</span>
            }
<span class="nc bnc" id="L910" title="All 2 branches missed.">            else if ((int)x1 &gt; innerR) {</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">                if (checkLoc) {</span>
<span class="nc" id="L912">                    return false;</span>
                }
<span class="nc" id="L914">                x1 = innerR;</span>
<span class="nc" id="L915">                resetXY = true;</span>
            }
            // Verify y location is valid.
<span class="nc" id="L918">            int maxY = (int)((triangleSize - x1 - innerR / 2.0) *</span>
<span class="nc" id="L919">                             Math.tan(Math.toRadians(30.0)));</span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">            if (y1 &lt;= -maxY) {</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">                if (checkLoc) {</span>
<span class="nc" id="L922">                    return false;</span>
                }
<span class="nc" id="L924">                y1 = -maxY;</span>
<span class="nc" id="L925">                resetXY = true;</span>
            }
<span class="nc bnc" id="L927" title="All 2 branches missed.">            else if (y1 &gt; maxY) {</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">                if (checkLoc) {</span>
<span class="nc" id="L929">                    return false;</span>
                }
<span class="nc" id="L931">                y1 = maxY;</span>
<span class="nc" id="L932">                resetXY = true;</span>
            }
            // Rotate again to determine value and scale
<span class="nc" id="L935">            double x2 = Math.cos(Math.toRadians(-30.0)) * x1 -</span>
<span class="nc" id="L936">                 Math.sin(Math.toRadians(-30.0)) * y1;</span>
<span class="nc" id="L937">            double y2 = Math.sin(Math.toRadians(-30.0)) * x1 +</span>
<span class="nc" id="L938">                 Math.cos(Math.toRadians(-30.0)) * y1;</span>
<span class="nc" id="L939">            float value = Math.min(1.0f, (float)((innerR - y2) /</span>
                                                (double)triangleSize));
<span class="nc" id="L941">            float maxX = (float)(Math.tan(Math.toRadians(30)) * (innerR - y2));</span>
<span class="nc" id="L942">            float saturation = Math.min(1.0f, (float)(x2 / maxX / 2 + .5));</span>

<span class="nc" id="L944">            setFlag(FLAGS_SETTING_COLOR, true);</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">            if (resetXY) {</span>
<span class="nc" id="L946">                setSaturationAndBrightness(saturation, value);</span>
            }
            else {
<span class="nc" id="L949">                setSaturationAndBrightness(saturation, value, x +</span>
<span class="nc" id="L950">                                      getWheelXOrigin(),getWheelYOrigin() - y);</span>
            }
<span class="nc" id="L952">            GTKColorChooserPanel.this.setSaturationAndBrightness(saturation,</span>
                                                                 value, true);
<span class="nc" id="L954">            setFlag(FLAGS_SETTING_COLOR, false);</span>
<span class="nc" id="L955">            return true;</span>
        }

        /**
         * Sets the saturation and brightness.
         */
        private void setSaturationAndBrightness(float s, float b) {
<span class="nc" id="L962">            int innerR = getTriangleCircumscribedRadius();</span>
<span class="nc" id="L963">            int triangleSize = innerR * 3 / 2;</span>
<span class="nc" id="L964">            double x = b * triangleSize;</span>
<span class="nc" id="L965">            double maxY = x * Math.tan(Math.toRadians(30.0));</span>
<span class="nc" id="L966">            double y = 2 * maxY * s - maxY;</span>
<span class="nc" id="L967">            x = x - innerR;</span>
<span class="nc" id="L968">            double x1 = Math.cos(Math.toRadians(-60.0) - angle) *</span>
<span class="nc" id="L969">                        x - Math.sin(Math.toRadians(-60.0) - angle) * y;</span>
<span class="nc" id="L970">            double y1 = Math.sin(Math.toRadians(-60.0) - angle) * x +</span>
<span class="nc" id="L971">                        Math.cos(Math.toRadians(-60.0) - angle) * y;</span>
<span class="nc" id="L972">            int newCircleX = (int)x1 + getWheelXOrigin();</span>
<span class="nc" id="L973">            int newCircleY = getWheelYOrigin() - (int)y1;</span>

<span class="nc" id="L975">            setSaturationAndBrightness(s, b, newCircleX, newCircleY);</span>
<span class="nc" id="L976">        }</span>


        /**
         * Sets the saturation and brightness.
         */
        private void setSaturationAndBrightness(float s, float b,
                                             int newCircleX, int newCircleY) {
<span class="nc" id="L984">            newCircleX -= getIndicatorSize() / 2;</span>
<span class="nc" id="L985">            newCircleY -= getIndicatorSize() / 2;</span>

<span class="nc" id="L987">            int minX = Math.min(newCircleX, circleX);</span>
<span class="nc" id="L988">            int minY = Math.min(newCircleY, circleY);</span>

<span class="nc" id="L990">            repaint(minX, minY, Math.max(circleX, newCircleX) - minX +</span>
<span class="nc" id="L991">                    getIndicatorSize() + 1, Math.max(circleY, newCircleY) -</span>
<span class="nc" id="L992">                    minY + getIndicatorSize() + 1);</span>
<span class="nc" id="L993">            circleX = newCircleX;</span>
<span class="nc" id="L994">            circleY = newCircleY;</span>
<span class="nc" id="L995">        }</span>

        /**
         * Adjusts the hue based on the passed in location.
         *
         * @param x X location to adjust to, relative to the origin of the
         *        wheel
         * @param y Y location to adjust to, relative to the origin of the
         *        wheel
         * @param check if true the location is checked to make sure
         *        it is contained in the wheel, if false the location is
         *        constrained to fit in the wheel
         * @return true if the location is valid.
         */
        private boolean adjustHue(int x, int y, boolean check) {
<span class="nc" id="L1010">            double rad = Math.sqrt(x * x + y * y);</span>
<span class="nc" id="L1011">            int size = getWheelRadius();</span>

<span class="nc bnc" id="L1013" title="All 6 branches missed.">            if (!check || (rad &gt;= size - getWheelWidth() &amp;&amp; rad &lt; size)) {</span>
                // Map the location to an angle and reset hue
                double angle;
<span class="nc bnc" id="L1016" title="All 2 branches missed.">                if (x == 0) {</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">                    if (y &gt; 0) {</span>
<span class="nc" id="L1018">                        angle = Math.PI / 2.0;</span>
                    }
                    else {
<span class="nc" id="L1021">                        angle = Math.PI + Math.PI / 2.0;</span>
                    }
                }
                else {
<span class="nc" id="L1025">                    angle = Math.atan((double)y / (double)x);</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">                    if (x &lt; 0) {</span>
<span class="nc" id="L1027">                        angle += Math.PI;</span>
                    }
<span class="nc bnc" id="L1029" title="All 2 branches missed.">                    else if (angle &lt; 0) {</span>
<span class="nc" id="L1030">                        angle += 2 * Math.PI;</span>
                    }
                }
<span class="nc" id="L1033">                setFlag(FLAGS_SETTING_COLOR, true);</span>
<span class="nc" id="L1034">                setHue((float)(1.0 - angle / Math.PI / 2), true);</span>
<span class="nc" id="L1035">                setFlag(FLAGS_SETTING_COLOR, false);</span>
<span class="nc" id="L1036">                setHueAngle(angle);</span>
<span class="nc" id="L1037">                setSaturationAndBrightness(getSaturation(), getBrightness());</span>
<span class="nc" id="L1038">                return true;</span>
            }
<span class="nc" id="L1040">            return false;</span>
        }

        /**
         * Rotates the triangle to accommodate the passed in hue.
         */
        private void setAngleFromHue(float hue) {
<span class="nc" id="L1047">            setHueAngle((1.0 - hue) * Math.PI * 2);</span>
<span class="nc" id="L1048">        }</span>

        /**
         * Sets the angle representing the hue.
         */
        private void setHueAngle(double angle) {
<span class="nc" id="L1054">            double oldAngle = this.angle;</span>

<span class="nc" id="L1056">            this.angle = angle;</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">            if (angle != oldAngle) {</span>
<span class="nc" id="L1058">                setFlag(FLAGS_CHANGED_ANGLE, true);</span>
<span class="nc" id="L1059">                repaint();</span>
            }
<span class="nc" id="L1061">        }</span>

        /**
         * Returns the size of the color indicator.
         */
        private int getIndicatorSize() {
<span class="nc" id="L1067">            return 8;</span>
        }

        /**
         * Returns the circumscribed radius of the triangle.
         */
        private int getTriangleCircumscribedRadius() {
<span class="nc" id="L1074">            return 72;</span>
        }

        /**
         * Returns the x origin of the wheel and triangle.
         */
        private int getWheelXOrigin() {
<span class="nc" id="L1081">            return 85;</span>
        }

        /**
         * Returns y origin of the wheel and triangle.
         */
        private int getWheelYOrigin() {
<span class="nc" id="L1088">            return 85;</span>
        }

        /**
         * Returns the width of the wheel.
         */
        private int getWheelWidth() {
<span class="nc" id="L1095">            return 13;</span>
        }

        /**
         * Sets the focus to one of: 0 no one, 1 the wheel or 2 the triangle.
         */
        private void setFocusType(int type) {
<span class="nc bnc" id="L1102" title="All 2 branches missed.">            if (type == 0) {</span>
<span class="nc" id="L1103">                setFlag(FLAGS_FOCUSED_WHEEL, false);</span>
<span class="nc" id="L1104">                setFlag(FLAGS_FOCUSED_TRIANGLE, false);</span>
<span class="nc" id="L1105">                repaint();</span>
            }
            else {
<span class="nc" id="L1108">                int toSet = FLAGS_FOCUSED_WHEEL;</span>
<span class="nc" id="L1109">                int toUnset = FLAGS_FOCUSED_TRIANGLE;</span>

<span class="nc bnc" id="L1111" title="All 2 branches missed.">                if (type == 2) {</span>
<span class="nc" id="L1112">                    toSet = FLAGS_FOCUSED_TRIANGLE;</span>
<span class="nc" id="L1113">                    toUnset = FLAGS_FOCUSED_WHEEL;</span>
                }
<span class="nc bnc" id="L1115" title="All 2 branches missed.">                if (!isSet(toSet)) {</span>
<span class="nc" id="L1116">                    setFlag(toSet, true);</span>
<span class="nc" id="L1117">                    repaint();</span>
<span class="nc" id="L1118">                    setFlag(toUnset, false);</span>
                }
            }
<span class="nc" id="L1121">        }</span>

        /**
         * Returns the radius of the wheel.
         */
        private int getWheelRadius() {
            // As far as I can tell, GTK doesn't allow stretching this
            // widget
<span class="nc" id="L1129">            return 85;</span>
        }

        /**
         * Updates the flags bitmask.
         */
        private void setFlag(int flag, boolean value) {
<span class="nc bnc" id="L1136" title="All 2 branches missed.">            if (value) {</span>
<span class="nc" id="L1137">                flags |= flag;</span>
            }
            else {
<span class="nc" id="L1140">                flags &amp;= ~flag;</span>
            }
<span class="nc" id="L1142">        }</span>

        /**
         * Returns true if a particular flag has been set.
         */
        private boolean isSet(int flag) {
<span class="nc bnc" id="L1148" title="All 2 branches missed.">            return ((flags &amp; flag) == flag);</span>
        }

        /**
         * Returns the RGB color to use for the specified location. The
         * passed in point must be on the color wheel and be relative to the
         * origin of the color wheel.
         *
         * @param x X location to get color for
         * @param y Y location to get color for
         * @param rad Radius from center of color wheel
         * @return integer with red, green and blue components
         */
        private int colorWheelLocationToRGB(int x, int y, double rad) {
<span class="nc" id="L1162">            double angle = Math.acos((double)x / rad);</span>
            int rgb;

<span class="nc bnc" id="L1165" title="All 2 branches missed.">            if (angle &lt; PI_3) {</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">                if (y &lt; 0) {</span>
                    // FFFF00 - FF0000
<span class="nc" id="L1168">                    rgb = 0xFF0000 | Math.min(255,</span>
                                           (int)(255 * angle / PI_3)) &lt;&lt; 8;
                }
                else {
                    // FF0000 - FF00FF
<span class="nc" id="L1173">                    rgb = 0xFF0000 | Math.min(255,</span>
                                           (int)(255 * angle / PI_3));
                }
            }
<span class="nc bnc" id="L1177" title="All 2 branches missed.">            else if (angle &lt; 2 * PI_3) {</span>
<span class="nc" id="L1178">                angle -= PI_3;</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">                if (y &lt; 0) {</span>
                    // 00FF00 - FFFF00
<span class="nc" id="L1181">                    rgb = 0x00FF00 | Math.max(0, 255 -</span>
                                           (int)(255 * angle / PI_3)) &lt;&lt; 16;
                }
                else {
                    // FF00FF - 0000FF
<span class="nc" id="L1186">                    rgb = 0x0000FF | Math.max(0, 255 -</span>
                                           (int)(255 * angle / PI_3)) &lt;&lt; 16;
                }
            }
            else {
<span class="nc" id="L1191">                angle -= 2 * PI_3;</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">                if (y &lt; 0) {</span>
                    // 00FFFF - 00FF00
<span class="nc" id="L1194">                    rgb = 0x00FF00 | Math.min(255,</span>
                                           (int)(255 * angle / PI_3));
                }
                else {
                    // 0000FF - 00FFFF
<span class="nc" id="L1199">                    rgb = 0x0000FF | Math.min(255,</span>
                                           (int)(255 * angle / PI_3)) &lt;&lt; 8;
                }
            }
<span class="nc" id="L1203">            return rgb;</span>
        }

        /**
         * Increments the hue.
         */
        void incrementHue(boolean positive) {
<span class="nc" id="L1210">            float hue = triangle.getGTKColorChooserPanel().getHue();</span>

<span class="nc bnc" id="L1212" title="All 2 branches missed.">            if (positive) {</span>
<span class="nc" id="L1213">                hue += 1.0f / 360.0f;</span>
            }
            else {
<span class="nc" id="L1216">                hue -= 1.0f / 360.0f;</span>
            }
<span class="nc bnc" id="L1218" title="All 2 branches missed.">            if (hue &gt; 1) {</span>
<span class="nc" id="L1219">                hue -= 1;</span>
            }
<span class="nc bnc" id="L1221" title="All 2 branches missed.">            else if (hue &lt; 0) {</span>
<span class="nc" id="L1222">                hue += 1;</span>
            }
<span class="nc" id="L1224">            getGTKColorChooserPanel().setHue(hue, true);</span>
<span class="nc" id="L1225">        }</span>
    }


    /**
     * Action class used for colors.
     */
    private static class ColorAction extends AbstractAction {
        private int type;

        ColorAction(String name, int type) {
<span class="nc" id="L1236">            super(name);</span>
<span class="nc" id="L1237">            this.type = type;</span>
<span class="nc" id="L1238">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1241">            ColorTriangle triangle = (ColorTriangle)e.getSource();</span>

<span class="nc bnc" id="L1243" title="All 2 branches missed.">            if (triangle.isWheelFocused()) {</span>
<span class="nc" id="L1244">                float hue = triangle.getGTKColorChooserPanel().getHue();</span>

<span class="nc bnc" id="L1246" title="All 5 branches missed.">                switch (type) {</span>
                case 0:
                case 2:
<span class="nc" id="L1249">                    triangle.incrementHue(true);</span>
<span class="nc" id="L1250">                    break;</span>
                case 1:
                case 3:
<span class="nc" id="L1253">                    triangle.incrementHue(false);</span>
<span class="nc" id="L1254">                    break;</span>
                case 4:
<span class="nc" id="L1256">                    triangle.focusTriangle();</span>
<span class="nc" id="L1257">                    break;</span>
                case 5:
<span class="nc" id="L1259">                    compositeRequestFocus(triangle, false);</span>
                    break;
                }
<span class="nc" id="L1262">            }</span>
            else {
<span class="nc" id="L1264">                int xDelta = 0;</span>
<span class="nc" id="L1265">                int yDelta = 0;</span>

<span class="nc bnc" id="L1267" title="All 7 branches missed.">                switch (type) {</span>
                case 0:
                    // up
<span class="nc" id="L1270">                    yDelta--;</span>
<span class="nc" id="L1271">                    break;</span>
                case 1:
                    // down
<span class="nc" id="L1274">                    yDelta++;</span>
<span class="nc" id="L1275">                    break;</span>
                case 2:
                    // left
<span class="nc" id="L1278">                    xDelta--;</span>
<span class="nc" id="L1279">                    break;</span>
                case 3:
                    // right
<span class="nc" id="L1282">                    xDelta++;</span>
<span class="nc" id="L1283">                    break;</span>
                case 4:
<span class="nc" id="L1285">                    compositeRequestFocus(triangle, true);</span>
<span class="nc" id="L1286">                    return;</span>
                case 5:
<span class="nc" id="L1288">                    triangle.focusWheel();</span>
<span class="nc" id="L1289">                    return;</span>
                }
<span class="nc" id="L1291">                triangle.adjustSB(triangle.getColorX() + xDelta,</span>
<span class="nc" id="L1292">                                  triangle.getColorY() + yDelta, true);</span>
            }
<span class="nc" id="L1294">        }</span>
    }


<span class="nc" id="L1298">    private class OpaqueLabel extends JLabel {</span>
        public boolean isOpaque() {
<span class="nc" id="L1300">            return true;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>