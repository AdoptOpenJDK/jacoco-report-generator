<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>CalendarNameProviderImpl.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.util.locale.provider</a> &gt; <span class="el_source">CalendarNameProviderImpl.java</span></div><h1>CalendarNameProviderImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2012, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package sun.util.locale.provider;

import static java.util.Calendar.*;
import java.util.Comparator;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;
import java.util.spi.CalendarNameProvider;

/**
 * Concrete implementation of the  {@link java.util.spi.CalendarDataProvider
 * CalendarDataProvider} class for the JRE LocaleProviderAdapter.
 *
 * @author Masayoshi Okutsu
 * @author Naoto Sato
 */
public class CalendarNameProviderImpl extends CalendarNameProvider implements AvailableLanguageTags {
    private final LocaleProviderAdapter.Type type;
    private final Set&lt;String&gt; langtags;

<span class="fc" id="L46">    public CalendarNameProviderImpl(LocaleProviderAdapter.Type type, Set&lt;String&gt; langtags) {</span>
<span class="fc" id="L47">        this.type = type;</span>
<span class="fc" id="L48">        this.langtags = langtags;</span>
<span class="fc" id="L49">    }</span>

    @Override
    public String getDisplayName(String calendarType, int field, int value, int style, Locale locale) {
<span class="fc" id="L53">        return getDisplayNameImpl(calendarType, field, value, style, locale, false);</span>
    }

    public String getJavaTimeDisplayName(String calendarType, int field, int value, int style, Locale locale) {
<span class="fc" id="L57">        return getDisplayNameImpl(calendarType, field, value, style, locale, true);</span>
    }

    public String getDisplayNameImpl(String calendarType, int field, int value, int style, Locale locale, boolean javatime) {
<span class="fc" id="L61">        String name = null;</span>
<span class="fc" id="L62">        String key = getResourceKey(calendarType, field, style, javatime);</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        if (key != null) {</span>
<span class="fc" id="L64">            LocaleResources lr = LocaleProviderAdapter.forType(type).getLocaleResources(locale);</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">            String[] strings = javatime ? lr.getJavaTimeNames(key) : lr.getCalendarNames(key);</span>
<span class="pc bpc" id="L66" title="1 of 4 branches missed.">            if (strings != null &amp;&amp; strings.length &gt; 0) {</span>
<span class="pc bpc" id="L67" title="1 of 4 branches missed.">                if (field == DAY_OF_WEEK || field == YEAR) {</span>
<span class="fc" id="L68">                    --value;</span>
                }
<span class="pc bpc" id="L70" title="2 of 4 branches missed.">                if (value &lt; 0 || value &gt;= strings.length) {</span>
<span class="nc" id="L71">                    return null;</span>
                }
<span class="fc" id="L73">                name = strings[value];</span>
                // If name is empty in standalone, try its `format' style.
<span class="pc bpc" id="L75" title="3 of 8 branches missed.">                if (name.length() == 0</span>
                        &amp;&amp; (style == SHORT_STANDALONE || style == LONG_STANDALONE
                            || style == NARROW_STANDALONE)) {
<span class="nc" id="L78">                    name = getDisplayName(calendarType, field, value,</span>
<span class="nc" id="L79">                                          getBaseStyle(style),</span>
                                          locale);
                }
            }
        }
<span class="fc" id="L84">        return name;</span>
    }

<span class="fc" id="L87">    private static int[] REST_OF_STYLES = {</span>
        SHORT_STANDALONE, LONG_FORMAT, LONG_STANDALONE,
        NARROW_FORMAT, NARROW_STANDALONE
    };

    @Override
    public Map&lt;String, Integer&gt; getDisplayNames(String calendarType, int field, int style, Locale locale) {
        Map&lt;String, Integer&gt; names;
<span class="fc bfc" id="L95" title="All 2 branches covered.">        if (style == ALL_STYLES) {</span>
<span class="fc" id="L96">            names = getDisplayNamesImpl(calendarType, field, SHORT_FORMAT, locale, false);</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">            for (int st : REST_OF_STYLES) {</span>
<span class="fc" id="L98">                names.putAll(getDisplayNamesImpl(calendarType, field, st, locale, false));</span>
            }
        } else {
            // specific style
<span class="fc" id="L102">            names = getDisplayNamesImpl(calendarType, field, style, locale, false);</span>
        }
<span class="fc bfc" id="L104" title="All 2 branches covered.">        return names.isEmpty() ? null : names;</span>
    }

    // NOTE: This method should be used ONLY BY JSR 310 classes.
    public Map&lt;String, Integer&gt; getJavaTimeDisplayNames(String calendarType, int field, int style, Locale locale) {
        Map&lt;String, Integer&gt; names;
<span class="nc" id="L110">        names = getDisplayNamesImpl(calendarType, field, style, locale, true);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        return names.isEmpty() ? null : names;</span>
    }

    private Map&lt;String, Integer&gt; getDisplayNamesImpl(String calendarType, int field,
                                                     int style, Locale locale, boolean javatime) {
<span class="fc" id="L116">        String key = getResourceKey(calendarType, field, style, javatime);</span>
<span class="fc" id="L117">        Map&lt;String, Integer&gt; map = new TreeMap&lt;&gt;(LengthBasedComparator.INSTANCE);</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">        if (key != null) {</span>
<span class="fc" id="L119">            LocaleResources lr = LocaleProviderAdapter.forType(type).getLocaleResources(locale);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            String[] strings = javatime ? lr.getJavaTimeNames(key) : lr.getCalendarNames(key);</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">            if (strings != null) {</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">                if (!hasDuplicates(strings)) {</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">                    if (field == YEAR) {</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">                        if (strings.length &gt; 0) {</span>
<span class="nc" id="L125">                            map.put(strings[0], 1);</span>
                        }
                    } else {
<span class="fc bfc" id="L128" title="All 2 branches covered.">                        int base = (field == DAY_OF_WEEK) ? 1 : 0;</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">                        for (int i = 0; i &lt; strings.length; i++) {</span>
<span class="fc" id="L130">                            String name = strings[i];</span>
                            // Ignore any empty string (some standalone month names
                            // are not defined)
<span class="fc bfc" id="L133" title="All 2 branches covered.">                            if (name.length() == 0) {</span>
<span class="fc" id="L134">                                continue;</span>
                            }
<span class="fc" id="L136">                            map.put(name, base + i);</span>
                        }
                    }
                }
            }
        }
<span class="fc" id="L142">        return map;</span>
    }

    private int getBaseStyle(int style) {
<span class="fc" id="L146">        return style &amp; ~(SHORT_STANDALONE - SHORT_FORMAT);</span>
    }

    /**
     * Comparator implementation for TreeMap which iterates keys from longest
     * to shortest.
     */
    private static class LengthBasedComparator implements Comparator&lt;String&gt; {
<span class="fc" id="L154">        private static final LengthBasedComparator INSTANCE = new LengthBasedComparator();</span>

<span class="fc" id="L156">        private LengthBasedComparator() {</span>
<span class="fc" id="L157">        }</span>

        @Override
        public int compare(String o1, String o2) {
<span class="fc" id="L161">            int n = o2.length() - o1.length();</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">            return (n == 0) ? o1.compareTo(o2) : n;</span>
        }
    }

    @Override
    public Locale[] getAvailableLocales() {
<span class="fc" id="L168">        return LocaleProviderAdapter.toLocaleArray(langtags);</span>
    }

    @Override
    public boolean isSupportedLocale(Locale locale) {
<span class="fc bfc" id="L173" title="All 2 branches covered.">        if (Locale.ROOT.equals(locale)) {</span>
<span class="fc" id="L174">            return true;</span>
        }
<span class="fc" id="L176">        String calendarType = null;</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        if (locale.hasExtensions()) {</span>
<span class="nc" id="L178">            calendarType = locale.getUnicodeLocaleType(&quot;ca&quot;);</span>
<span class="nc" id="L179">            locale = locale.stripExtensions();</span>
        }

<span class="pc bpc" id="L182" title="1 of 2 branches missed.">        if (calendarType != null) {</span>
<span class="nc bnc" id="L183" title="All 18 branches missed.">            switch (calendarType) {</span>
            case &quot;buddhist&quot;:
            case &quot;japanese&quot;:
            case &quot;gregory&quot;:
            case &quot;islamic&quot;:
            case &quot;roc&quot;:
<span class="nc" id="L189">                break;</span>
            default:
                // Unknown calendar type
<span class="nc" id="L192">                return false;</span>
            }
        }
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if (langtags.contains(locale.toLanguageTag())) {</span>
<span class="fc" id="L196">            return true;</span>
        }
<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (type == LocaleProviderAdapter.Type.JRE) {</span>
<span class="fc" id="L199">            String oldname = locale.toString().replace('_', '-');</span>
<span class="fc" id="L200">            return langtags.contains(oldname);</span>
        }
<span class="fc" id="L202">        return false;</span>
    }

    @Override
    public Set&lt;String&gt; getAvailableLanguageTags() {
<span class="nc" id="L207">        return langtags;</span>
    }

    private boolean hasDuplicates(String[] strings) {
<span class="fc" id="L211">        int len = strings.length;</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">        for (int i = 0; i &lt; len - 1; i++) {</span>
<span class="fc" id="L213">            String a = strings[i];</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">            if (a != null) {</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">                for (int j = i + 1; j &lt; len; j++) {</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">                    if (a.equals(strings[j]))  {</span>
<span class="fc" id="L217">                        return true;</span>
                    }
                }
            }
        }
<span class="fc" id="L222">        return false;</span>
    }

    private String getResourceKey(String type, int field, int style, boolean javatime) {
<span class="fc" id="L226">        int baseStyle = getBaseStyle(style);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">        boolean isStandalone = (style != baseStyle);</span>

<span class="fc bfc" id="L229" title="All 2 branches covered.">        if (&quot;gregory&quot;.equals(type)) {</span>
<span class="fc" id="L230">            type = null;</span>
        }
<span class="fc bfc" id="L232" title="All 2 branches covered.">        boolean isNarrow = (baseStyle == NARROW_FORMAT);</span>
<span class="fc" id="L233">        StringBuilder key = new StringBuilder();</span>
        // If javatime is true, use prefix &quot;java.time.&quot;.
<span class="fc bfc" id="L235" title="All 2 branches covered.">        if (javatime) {</span>
<span class="fc" id="L236">            key.append(&quot;java.time.&quot;);</span>
        }
<span class="pc bpc" id="L238" title="1 of 6 branches missed.">        switch (field) {</span>
        case ERA:
<span class="fc bfc" id="L240" title="All 2 branches covered.">            if (type != null) {</span>
<span class="fc" id="L241">                key.append(type).append('.');</span>
            }
<span class="fc bfc" id="L243" title="All 2 branches covered.">            if (isNarrow) {</span>
<span class="fc" id="L244">                key.append(&quot;narrow.&quot;);</span>
            } else {
                // JRE and CLDR use different resource key conventions
                // due to historical reasons. (JRE DateFormatSymbols.getEras returns
                // abbreviations while other getShort*() return abbreviations.)
<span class="fc bfc" id="L249" title="All 2 branches covered.">                if (this.type == LocaleProviderAdapter.Type.JRE) {</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">                    if (javatime) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                        if (baseStyle == LONG) {</span>
<span class="nc" id="L252">                            key.append(&quot;long.&quot;);</span>
                        }
                    }
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">                    if (baseStyle == SHORT) {</span>
<span class="fc" id="L256">                        key.append(&quot;short.&quot;);</span>
                    }
                } else { // this.type == LocaleProviderAdapter.Type.CLDR
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">                    if (baseStyle == LONG) {</span>
<span class="nc" id="L260">                        key.append(&quot;long.&quot;);</span>
                    }
                }
            }
<span class="fc" id="L264">            key.append(&quot;Eras&quot;);</span>
<span class="fc" id="L265">            break;</span>

        case YEAR:
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">            if (!isNarrow) {</span>
<span class="fc" id="L269">                key.append(type).append(&quot;.FirstYear&quot;);</span>
            }
            break;

        case MONTH:
<span class="fc bfc" id="L274" title="All 2 branches covered.">            if (&quot;islamic&quot;.equals(type)) {</span>
<span class="fc" id="L275">                key.append(type).append('.');</span>
            }
<span class="fc bfc" id="L277" title="All 2 branches covered.">            if (isStandalone) {</span>
<span class="fc" id="L278">                key.append(&quot;standalone.&quot;);</span>
            }
<span class="fc" id="L280">            key.append(&quot;Month&quot;).append(toStyleName(baseStyle));</span>
<span class="fc" id="L281">            break;</span>

        case DAY_OF_WEEK:
            // support standalone narrow day names
<span class="fc bfc" id="L285" title="All 4 branches covered.">            if (isStandalone &amp;&amp; isNarrow) {</span>
<span class="fc" id="L286">                key.append(&quot;standalone.&quot;);</span>
            }
<span class="fc" id="L288">            key.append(&quot;Day&quot;).append(toStyleName(baseStyle));</span>
<span class="fc" id="L289">            break;</span>

        case AM_PM:
<span class="fc bfc" id="L292" title="All 2 branches covered.">            if (isNarrow) {</span>
<span class="fc" id="L293">                key.append(&quot;narrow.&quot;);</span>
            }
<span class="fc" id="L295">            key.append(&quot;AmPmMarkers&quot;);</span>
            break;
        }
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">        return key.length() &gt; 0 ? key.toString() : null;</span>
    }

    private String toStyleName(int baseStyle) {
<span class="fc bfc" id="L302" title="All 3 branches covered.">        switch (baseStyle) {</span>
        case SHORT:
<span class="fc" id="L304">            return &quot;Abbreviations&quot;;</span>
        case NARROW_FORMAT:
<span class="fc" id="L306">            return &quot;Narrows&quot;;</span>
        }
<span class="fc" id="L308">        return &quot;Names&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>