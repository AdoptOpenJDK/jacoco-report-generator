<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>IntegrityHmac.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.org.apache.xml.internal.security.algorithms.implementations</a> &gt; <span class="el_source">IntegrityHmac.java</span></div><h1>IntegrityHmac.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package com.sun.org.apache.xml.internal.security.algorithms.implementations;

import java.security.InvalidAlgorithmParameterException;
import java.security.InvalidKeyException;
import java.security.Key;
import java.security.SecureRandom;
import java.security.spec.AlgorithmParameterSpec;

import javax.crypto.Mac;
import javax.crypto.SecretKey;

import com.sun.org.apache.xml.internal.security.algorithms.JCEMapper;
import com.sun.org.apache.xml.internal.security.algorithms.MessageDigestAlgorithm;
import com.sun.org.apache.xml.internal.security.algorithms.SignatureAlgorithmSpi;
import com.sun.org.apache.xml.internal.security.signature.XMLSignature;
import com.sun.org.apache.xml.internal.security.signature.XMLSignatureException;
import com.sun.org.apache.xml.internal.security.utils.Constants;
import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Text;

public abstract class IntegrityHmac extends SignatureAlgorithmSpi {

    /** {@link org.apache.commons.logging} logging facility */
<span class="nc" id="L48">    private static java.util.logging.Logger log =</span>
<span class="nc" id="L49">        java.util.logging.Logger.getLogger(IntegrityHmac.class.getName());</span>

    /** Field macAlgorithm */
<span class="nc" id="L52">    private Mac macAlgorithm = null;</span>

    /** Field HMACOutputLength */
<span class="nc" id="L55">    private int HMACOutputLength = 0;</span>
<span class="nc" id="L56">    private boolean HMACOutputLengthSet = false;</span>

    /**
     * Method engineGetURI
     *
     *@inheritDoc
     */
    public abstract String engineGetURI();

    /**
     * Returns the output length of the hash/digest.
     */
    abstract int getDigestLength();

    /**
     * Method IntegrityHmac
     *
     * @throws XMLSignatureException
     */
<span class="nc" id="L75">    public IntegrityHmac() throws XMLSignatureException {</span>
<span class="nc" id="L76">        String algorithmID = JCEMapper.translateURItoJCEID(this.engineGetURI());</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L78">            log.log(java.util.logging.Level.FINE, &quot;Created IntegrityHmacSHA1 using &quot; + algorithmID);</span>
        }

        try {
<span class="nc" id="L82">            this.macAlgorithm = Mac.getInstance(algorithmID);</span>
<span class="nc" id="L83">        } catch (java.security.NoSuchAlgorithmException ex) {</span>
<span class="nc" id="L84">            Object[] exArgs = { algorithmID, ex.getLocalizedMessage() };</span>

<span class="nc" id="L86">            throw new XMLSignatureException(&quot;algorithms.NoSuchAlgorithm&quot;, exArgs);</span>
<span class="nc" id="L87">        }</span>
<span class="nc" id="L88">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#setParameter(
     * java.security.spec.AlgorithmParameterSpec)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param params
     * @throws XMLSignatureException
     */
    protected void engineSetParameter(AlgorithmParameterSpec params) throws XMLSignatureException {
<span class="nc" id="L99">        throw new XMLSignatureException(&quot;empty&quot;);</span>
    }

    public void reset() {
<span class="nc" id="L103">        HMACOutputLength = 0;</span>
<span class="nc" id="L104">        HMACOutputLengthSet = false;</span>
<span class="nc" id="L105">        this.macAlgorithm.reset();</span>
<span class="nc" id="L106">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#verify(byte[])}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param signature
     * @return true if the signature is correct
     * @throws XMLSignatureException
     */
    protected boolean engineVerify(byte[] signature) throws XMLSignatureException {
        try {
<span class="nc bnc" id="L118" title="All 4 branches missed.">            if (this.HMACOutputLengthSet &amp;&amp; this.HMACOutputLength &lt; getDigestLength()) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L120">                    log.log(java.util.logging.Level.FINE, &quot;HMACOutputLength must not be less than &quot; + getDigestLength());</span>
                }
<span class="nc" id="L122">                Object[] exArgs = { String.valueOf(getDigestLength()) };</span>
<span class="nc" id="L123">                throw new XMLSignatureException(&quot;algorithms.HMACOutputLengthMin&quot;, exArgs);</span>
            } else {
<span class="nc" id="L125">                byte[] completeResult = this.macAlgorithm.doFinal();</span>
<span class="nc" id="L126">                return MessageDigestAlgorithm.isEqual(completeResult, signature);</span>
            }
<span class="nc" id="L128">        } catch (IllegalStateException ex) {</span>
<span class="nc" id="L129">            throw new XMLSignatureException(&quot;empty&quot;, ex);</span>
        }
    }

    /**
     * Proxy method for {@link java.security.Signature#initVerify(java.security.PublicKey)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param secretKey
     * @throws XMLSignatureException
     */
    protected void engineInitVerify(Key secretKey) throws XMLSignatureException {
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (!(secretKey instanceof SecretKey)) {</span>
<span class="nc" id="L142">            String supplied = secretKey.getClass().getName();</span>
<span class="nc" id="L143">            String needed = SecretKey.class.getName();</span>
<span class="nc" id="L144">            Object exArgs[] = { supplied, needed };</span>

<span class="nc" id="L146">            throw new XMLSignatureException(&quot;algorithms.WrongKeyForThisOperation&quot;, exArgs);</span>
        }

        try {
<span class="nc" id="L150">            this.macAlgorithm.init(secretKey);</span>
<span class="nc" id="L151">        } catch (InvalidKeyException ex) {</span>
            // reinstantiate Mac object to work around bug in JDK
            // see: http://bugs.sun.com/view_bug.do?bug_id=4953555
<span class="nc" id="L154">            Mac mac = this.macAlgorithm;</span>
            try {
<span class="nc" id="L156">                this.macAlgorithm = Mac.getInstance(macAlgorithm.getAlgorithm());</span>
<span class="nc" id="L157">            } catch (Exception e) {</span>
                // this shouldn't occur, but if it does, restore previous Mac
<span class="nc bnc" id="L159" title="All 2 branches missed.">                if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L160">                    log.log(java.util.logging.Level.FINE, &quot;Exception when reinstantiating Mac:&quot; + e);</span>
                }
<span class="nc" id="L162">                this.macAlgorithm = mac;</span>
<span class="nc" id="L163">            }</span>
<span class="nc" id="L164">            throw new XMLSignatureException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L165">        }</span>
<span class="nc" id="L166">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#sign()}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @return the result of the {@link java.security.Signature#sign()} method
     * @throws XMLSignatureException
     */
    protected byte[] engineSign() throws XMLSignatureException {
        try {
<span class="nc bnc" id="L177" title="All 4 branches missed.">            if (this.HMACOutputLengthSet &amp;&amp; this.HMACOutputLength &lt; getDigestLength()) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L179">                    log.log(java.util.logging.Level.FINE, &quot;HMACOutputLength must not be less than &quot; + getDigestLength());</span>
                }
<span class="nc" id="L181">                Object[] exArgs = { String.valueOf(getDigestLength()) };</span>
<span class="nc" id="L182">                throw new XMLSignatureException(&quot;algorithms.HMACOutputLengthMin&quot;, exArgs);</span>
            } else {
<span class="nc" id="L184">                return this.macAlgorithm.doFinal();</span>
            }
<span class="nc" id="L186">        } catch (IllegalStateException ex) {</span>
<span class="nc" id="L187">            throw new XMLSignatureException(&quot;empty&quot;, ex);</span>
        }
    }

    /**
     * Method engineInitSign
     *
     * @param secretKey
     * @throws XMLSignatureException
     */
    protected void engineInitSign(Key secretKey) throws XMLSignatureException {
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (!(secretKey instanceof SecretKey)) {</span>
<span class="nc" id="L199">            String supplied = secretKey.getClass().getName();</span>
<span class="nc" id="L200">            String needed = SecretKey.class.getName();</span>
<span class="nc" id="L201">            Object exArgs[] = { supplied, needed };</span>

<span class="nc" id="L203">            throw new XMLSignatureException(&quot;algorithms.WrongKeyForThisOperation&quot;, exArgs);</span>
        }

        try {
<span class="nc" id="L207">            this.macAlgorithm.init(secretKey);</span>
<span class="nc" id="L208">        } catch (InvalidKeyException ex) {</span>
<span class="nc" id="L209">            throw new XMLSignatureException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L210">        }</span>
<span class="nc" id="L211">    }</span>

    /**
     * Method engineInitSign
     *
     * @param secretKey
     * @param algorithmParameterSpec
     * @throws XMLSignatureException
     */
    protected void engineInitSign(
        Key secretKey, AlgorithmParameterSpec algorithmParameterSpec
    ) throws XMLSignatureException {
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (!(secretKey instanceof SecretKey)) {</span>
<span class="nc" id="L224">            String supplied = secretKey.getClass().getName();</span>
<span class="nc" id="L225">            String needed = SecretKey.class.getName();</span>
<span class="nc" id="L226">            Object exArgs[] = { supplied, needed };</span>

<span class="nc" id="L228">            throw new XMLSignatureException(&quot;algorithms.WrongKeyForThisOperation&quot;, exArgs);</span>
        }

        try {
<span class="nc" id="L232">            this.macAlgorithm.init(secretKey, algorithmParameterSpec);</span>
<span class="nc" id="L233">        } catch (InvalidKeyException ex) {</span>
<span class="nc" id="L234">            throw new XMLSignatureException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L235">        } catch (InvalidAlgorithmParameterException ex) {</span>
<span class="nc" id="L236">            throw new XMLSignatureException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L237">        }</span>
<span class="nc" id="L238">    }</span>

    /**
     * Method engineInitSign
     *
     * @param secretKey
     * @param secureRandom
     * @throws XMLSignatureException
     */
    protected void engineInitSign(Key secretKey, SecureRandom secureRandom)
        throws XMLSignatureException {
<span class="nc" id="L249">        throw new XMLSignatureException(&quot;algorithms.CannotUseSecureRandomOnMAC&quot;);</span>
    }

    /**
     * Proxy method for {@link java.security.Signature#update(byte[])}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param input
     * @throws XMLSignatureException
     */
    protected void engineUpdate(byte[] input) throws XMLSignatureException {
        try {
<span class="nc" id="L261">            this.macAlgorithm.update(input);</span>
<span class="nc" id="L262">        } catch (IllegalStateException ex) {</span>
<span class="nc" id="L263">            throw new XMLSignatureException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L264">        }</span>
<span class="nc" id="L265">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#update(byte)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param input
     * @throws XMLSignatureException
     */
    protected void engineUpdate(byte input) throws XMLSignatureException {
        try {
<span class="nc" id="L276">            this.macAlgorithm.update(input);</span>
<span class="nc" id="L277">        } catch (IllegalStateException ex) {</span>
<span class="nc" id="L278">            throw new XMLSignatureException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L279">        }</span>
<span class="nc" id="L280">    }</span>

    /**
     * Proxy method for {@link java.security.Signature#update(byte[], int, int)}
     * which is executed on the internal {@link java.security.Signature} object.
     *
     * @param buf
     * @param offset
     * @param len
     * @throws XMLSignatureException
     */
    protected void engineUpdate(byte buf[], int offset, int len) throws XMLSignatureException {
        try {
<span class="nc" id="L293">            this.macAlgorithm.update(buf, offset, len);</span>
<span class="nc" id="L294">        } catch (IllegalStateException ex) {</span>
<span class="nc" id="L295">            throw new XMLSignatureException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L296">        }</span>
<span class="nc" id="L297">    }</span>

    /**
     * Method engineGetJCEAlgorithmString
     * @inheritDoc
     *
     */
    protected String engineGetJCEAlgorithmString() {
<span class="nc" id="L305">        return this.macAlgorithm.getAlgorithm();</span>
    }

    /**
     * Method engineGetJCEAlgorithmString
     *
     * @inheritDoc
     */
    protected String engineGetJCEProviderName() {
<span class="nc" id="L314">        return this.macAlgorithm.getProvider().getName();</span>
    }

    /**
     * Method engineSetHMACOutputLength
     *
     * @param HMACOutputLength
     */
    protected void engineSetHMACOutputLength(int HMACOutputLength) {
<span class="nc" id="L323">        this.HMACOutputLength = HMACOutputLength;</span>
<span class="nc" id="L324">        this.HMACOutputLengthSet = true;</span>
<span class="nc" id="L325">    }</span>

    /**
     * Method engineGetContextFromElement
     *
     * @param element
     */
    protected void engineGetContextFromElement(Element element) {
<span class="nc" id="L333">        super.engineGetContextFromElement(element);</span>

<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (element == null) {</span>
<span class="nc" id="L336">            throw new IllegalArgumentException(&quot;element null&quot;);</span>
        }

<span class="nc" id="L339">        Text hmaclength =</span>
<span class="nc" id="L340">            XMLUtils.selectDsNodeText(element.getFirstChild(), Constants._TAG_HMACOUTPUTLENGTH, 0);</span>

<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (hmaclength != null) {</span>
<span class="nc" id="L343">            this.HMACOutputLength = Integer.parseInt(hmaclength.getData());</span>
<span class="nc" id="L344">            this.HMACOutputLengthSet = true;</span>
        }
<span class="nc" id="L346">    }</span>

    /**
     * Method engineAddContextToElement
     *
     * @param element
     */
    public void engineAddContextToElement(Element element) {
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (element == null) {</span>
<span class="nc" id="L355">            throw new IllegalArgumentException(&quot;null element&quot;);</span>
        }

<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (this.HMACOutputLengthSet) {</span>
<span class="nc" id="L359">            Document doc = element.getOwnerDocument();</span>
<span class="nc" id="L360">            Element HMElem =</span>
<span class="nc" id="L361">                XMLUtils.createElementInSignatureSpace(doc, Constants._TAG_HMACOUTPUTLENGTH);</span>
<span class="nc" id="L362">            Text HMText =</span>
<span class="nc" id="L363">                doc.createTextNode(Integer.valueOf(this.HMACOutputLength).toString());</span>

<span class="nc" id="L365">            HMElem.appendChild(HMText);</span>
<span class="nc" id="L366">            XMLUtils.addReturnToElement(element);</span>
<span class="nc" id="L367">            element.appendChild(HMElem);</span>
<span class="nc" id="L368">            XMLUtils.addReturnToElement(element);</span>
        }
<span class="nc" id="L370">    }</span>

    /**
     * Class IntegrityHmacSHA1
     */
    public static class IntegrityHmacSHA1 extends IntegrityHmac {

        /**
         * Constructor IntegrityHmacSHA1
         *
         * @throws XMLSignatureException
         */
        public IntegrityHmacSHA1() throws XMLSignatureException {
<span class="nc" id="L383">            super();</span>
<span class="nc" id="L384">        }</span>

        /**
         * Method engineGetURI
         * @inheritDoc
         *
         */
        public String engineGetURI() {
<span class="nc" id="L392">            return XMLSignature.ALGO_ID_MAC_HMAC_SHA1;</span>
        }

        int getDigestLength() {
<span class="nc" id="L396">            return 160;</span>
        }
    }

    /**
     * Class IntegrityHmacSHA256
     */
    public static class IntegrityHmacSHA256 extends IntegrityHmac {

        /**
         * Constructor IntegrityHmacSHA256
         *
         * @throws XMLSignatureException
         */
        public IntegrityHmacSHA256() throws XMLSignatureException {
<span class="nc" id="L411">            super();</span>
<span class="nc" id="L412">        }</span>

        /**
         * Method engineGetURI
         *
         * @inheritDoc
         */
        public String engineGetURI() {
<span class="nc" id="L420">            return XMLSignature.ALGO_ID_MAC_HMAC_SHA256;</span>
        }

        int getDigestLength() {
<span class="nc" id="L424">            return 256;</span>
        }
    }

    /**
     * Class IntegrityHmacSHA384
     */
    public static class IntegrityHmacSHA384 extends IntegrityHmac {

        /**
         * Constructor IntegrityHmacSHA384
         *
         * @throws XMLSignatureException
         */
        public IntegrityHmacSHA384() throws XMLSignatureException {
<span class="nc" id="L439">            super();</span>
<span class="nc" id="L440">        }</span>

        /**
         * Method engineGetURI
         * @inheritDoc
         *
         */
        public String engineGetURI() {
<span class="nc" id="L448">            return XMLSignature.ALGO_ID_MAC_HMAC_SHA384;</span>
        }

        int getDigestLength() {
<span class="nc" id="L452">            return 384;</span>
        }
    }

    /**
     * Class IntegrityHmacSHA512
     */
    public static class IntegrityHmacSHA512 extends IntegrityHmac {

        /**
         * Constructor IntegrityHmacSHA512
         *
         * @throws XMLSignatureException
         */
        public IntegrityHmacSHA512() throws XMLSignatureException {
<span class="nc" id="L467">            super();</span>
<span class="nc" id="L468">        }</span>

        /**
         * Method engineGetURI
         * @inheritDoc
         *
         */
        public String engineGetURI() {
<span class="nc" id="L476">            return XMLSignature.ALGO_ID_MAC_HMAC_SHA512;</span>
        }

        int getDigestLength() {
<span class="nc" id="L480">            return 512;</span>
        }
    }

    /**
     * Class IntegrityHmacRIPEMD160
     */
    public static class IntegrityHmacRIPEMD160 extends IntegrityHmac {

        /**
         * Constructor IntegrityHmacRIPEMD160
         *
         * @throws XMLSignatureException
         */
        public IntegrityHmacRIPEMD160() throws XMLSignatureException {
<span class="nc" id="L495">            super();</span>
<span class="nc" id="L496">        }</span>

        /**
         * Method engineGetURI
         *
         * @inheritDoc
         */
        public String engineGetURI() {
<span class="nc" id="L504">            return XMLSignature.ALGO_ID_MAC_HMAC_RIPEMD160;</span>
        }

        int getDigestLength() {
<span class="nc" id="L508">            return 160;</span>
        }
    }

    /**
     * Class IntegrityHmacMD5
     */
    public static class IntegrityHmacMD5 extends IntegrityHmac {

        /**
         * Constructor IntegrityHmacMD5
         *
         * @throws XMLSignatureException
         */
        public IntegrityHmacMD5() throws XMLSignatureException {
<span class="nc" id="L523">            super();</span>
<span class="nc" id="L524">        }</span>

        /**
         * Method engineGetURI
         *
         * @inheritDoc
         */
        public String engineGetURI() {
<span class="nc" id="L532">            return XMLSignature.ALGO_ID_MAC_HMAC_NOT_RECOMMENDED_MD5;</span>
        }

        int getDigestLength() {
<span class="nc" id="L536">            return 128;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>