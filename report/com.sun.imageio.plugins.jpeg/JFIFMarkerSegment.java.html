<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JFIFMarkerSegment.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.imageio.plugins.jpeg</a> &gt; <span class="el_source">JFIFMarkerSegment.java</span></div><h1>JFIFMarkerSegment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2001, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.imageio.plugins.jpeg;

import javax.imageio.IIOException;
import javax.imageio.IIOImage;
import javax.imageio.ImageTypeSpecifier;
import javax.imageio.ImageReader;
import javax.imageio.metadata.IIOInvalidTreeException;
import javax.imageio.metadata.IIOMetadataNode;
import javax.imageio.metadata.IIOMetadata;
import javax.imageio.stream.ImageInputStream;
import javax.imageio.stream.ImageOutputStream;
import javax.imageio.stream.MemoryCacheImageOutputStream;
import javax.imageio.event.IIOReadProgressListener;

import java.awt.Graphics;
import java.awt.color.ICC_Profile;
import java.awt.color.ICC_ColorSpace;
import java.awt.color.ColorSpace;
import java.awt.image.ColorModel;
import java.awt.image.SampleModel;
import java.awt.image.IndexColorModel;
import java.awt.image.ComponentColorModel;
import java.awt.image.BufferedImage;
import java.awt.image.DataBuffer;
import java.awt.image.DataBufferByte;
import java.awt.image.Raster;
import java.awt.image.WritableRaster;
import java.io.IOException;
import java.io.ByteArrayOutputStream;
import java.util.List;
import java.util.ArrayList;
import java.util.Iterator;

import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.w3c.dom.NamedNodeMap;

/**
 * A JFIF (JPEG File Interchange Format) APP0 (Application-Specific)
 * marker segment.  Inner classes are included for JFXX extension
 * marker segments, for different varieties of thumbnails, and for
 * ICC Profile APP2 marker segments.  Any of these secondary types
 * that occur are kept as members of a single JFIFMarkerSegment object.
 */
class JFIFMarkerSegment extends MarkerSegment {
    int majorVersion;
    int minorVersion;
    int resUnits;
    int Xdensity;
    int Ydensity;
    int thumbWidth;
    int thumbHeight;
<span class="nc" id="L78">    JFIFThumbRGB thumb = null;  // If present</span>
<span class="nc" id="L79">    ArrayList extSegments = new ArrayList();</span>
<span class="nc" id="L80">    ICCMarkerSegment iccSegment = null; // optional ICC</span>
    private static final int THUMB_JPEG = 0x10;
    private static final int THUMB_PALETTE = 0x11;
    private static final int THUMB_UNASSIGNED = 0x12;
    private static final int THUMB_RGB = 0x13;
    private static final int DATA_SIZE = 14;
    private static final int ID_SIZE = 5;
<span class="nc" id="L87">    private final int MAX_THUMB_WIDTH = 255;</span>
<span class="nc" id="L88">    private final int MAX_THUMB_HEIGHT = 255;</span>

<span class="nc" id="L90">    private final boolean debug = false;</span>

    /**
     * Set to &lt;code&gt;true&lt;/code&gt; when reading the chunks of an
     * ICC profile.  All chunks are consolidated to create a single
     * &quot;segment&quot; containing all the chunks.  This flag is a state
     * variable identifying whether to construct a new segment or
     * append to an old one.
     */
<span class="nc" id="L99">    private boolean inICC = false;</span>

    /**
     * A placeholder for an ICC profile marker segment under
     * construction.  The segment is not added to the list
     * until all chunks have been read.
     */
<span class="nc" id="L106">    private ICCMarkerSegment tempICCSegment = null;</span>


    /**
     * Default constructor.  Used to create a default JFIF header
     */
    JFIFMarkerSegment() {
<span class="nc" id="L113">        super(JPEG.APP0);</span>
<span class="nc" id="L114">        majorVersion = 1;</span>
<span class="nc" id="L115">        minorVersion = 2;</span>
<span class="nc" id="L116">        resUnits = JPEG.DENSITY_UNIT_ASPECT_RATIO;</span>
<span class="nc" id="L117">        Xdensity = 1;</span>
<span class="nc" id="L118">        Ydensity = 1;</span>
<span class="nc" id="L119">        thumbWidth = 0;</span>
<span class="nc" id="L120">        thumbHeight = 0;</span>
<span class="nc" id="L121">    }</span>

    /**
     * Constructs a JFIF header by reading from a stream wrapped
     * in a JPEGBuffer.
     */
    JFIFMarkerSegment(JPEGBuffer buffer) throws IOException {
<span class="nc" id="L128">        super(buffer);</span>
<span class="nc" id="L129">        buffer.bufPtr += ID_SIZE;  // skip the id, we already checked it</span>

<span class="nc" id="L131">        majorVersion = buffer.buf[buffer.bufPtr++];</span>
<span class="nc" id="L132">        minorVersion = buffer.buf[buffer.bufPtr++];</span>
<span class="nc" id="L133">        resUnits = buffer.buf[buffer.bufPtr++];</span>
<span class="nc" id="L134">        Xdensity = (buffer.buf[buffer.bufPtr++] &amp; 0xff) &lt;&lt; 8;</span>
<span class="nc" id="L135">        Xdensity |= buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L136">        Ydensity = (buffer.buf[buffer.bufPtr++] &amp; 0xff) &lt;&lt; 8;</span>
<span class="nc" id="L137">        Ydensity |= buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L138">        thumbWidth = buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L139">        thumbHeight = buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L140">        buffer.bufAvail -= DATA_SIZE;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (thumbWidth &gt; 0) {</span>
<span class="nc" id="L142">            thumb = new JFIFThumbRGB(buffer, thumbWidth, thumbHeight);</span>
        }
<span class="nc" id="L144">    }</span>

    /**
     * Constructs a JFIF header from a DOM Node.
     */
    JFIFMarkerSegment(Node node) throws IIOInvalidTreeException {
<span class="nc" id="L150">        this();</span>
<span class="nc" id="L151">        updateFromNativeNode(node, true);</span>
<span class="nc" id="L152">    }</span>

    /**
     * Returns a deep-copy clone of this object.
     */
    protected Object clone() {
<span class="nc" id="L158">        JFIFMarkerSegment newGuy = (JFIFMarkerSegment) super.clone();</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (!extSegments.isEmpty()) { // Clone the list with a deep copy</span>
<span class="nc" id="L160">            newGuy.extSegments = new ArrayList();</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            for (Iterator iter = extSegments.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L162">                JFIFExtensionMarkerSegment jfxx =</span>
<span class="nc" id="L163">                    (JFIFExtensionMarkerSegment) iter.next();</span>
<span class="nc" id="L164">                newGuy.extSegments.add(jfxx.clone());</span>
<span class="nc" id="L165">            }</span>
        }
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (iccSegment != null) {</span>
<span class="nc" id="L168">            newGuy.iccSegment = (ICCMarkerSegment) iccSegment.clone();</span>
        }
<span class="nc" id="L170">        return newGuy;</span>
    }

    /**
     * Add an JFXX extension marker segment from the stream wrapped
     * in the JPEGBuffer to the list of extension segments.
     */
    void addJFXX(JPEGBuffer buffer, JPEGImageReader reader)
        throws IOException {
<span class="nc" id="L179">        extSegments.add(new JFIFExtensionMarkerSegment(buffer, reader));</span>
<span class="nc" id="L180">    }</span>

    /**
     * Adds an ICC Profile APP2 segment from the stream wrapped
     * in the JPEGBuffer.
     */
    void addICC(JPEGBuffer buffer) throws IOException {
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (inICC == false) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (iccSegment != null) {</span>
<span class="nc" id="L189">                throw new IIOException</span>
                    (&quot;&gt; 1 ICC APP2 Marker Segment not supported&quot;);
            }
<span class="nc" id="L192">            tempICCSegment = new ICCMarkerSegment(buffer);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (inICC == false) { // Just one chunk</span>
<span class="nc" id="L194">                iccSegment = tempICCSegment;</span>
<span class="nc" id="L195">                tempICCSegment = null;</span>
            }
        } else {
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (tempICCSegment.addData(buffer) == true) {</span>
<span class="nc" id="L199">                iccSegment = tempICCSegment;</span>
<span class="nc" id="L200">                tempICCSegment = null;</span>
            }
        }
<span class="nc" id="L203">    }</span>

    /**
     * Add an ICC Profile APP2 segment by constructing it from
     * the given ICC_ColorSpace object.
     */
    void addICC(ICC_ColorSpace cs) throws IOException {
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (iccSegment != null) {</span>
<span class="nc" id="L211">            throw new IIOException</span>
                (&quot;&gt; 1 ICC APP2 Marker Segment not supported&quot;);
        }
<span class="nc" id="L214">        iccSegment = new ICCMarkerSegment(cs);</span>
<span class="nc" id="L215">    }</span>

    /**
     * Returns a tree of DOM nodes representing this object and any
     * subordinate JFXX extension or ICC Profile segments.
     */
    IIOMetadataNode getNativeNode() {
<span class="nc" id="L222">        IIOMetadataNode node = new IIOMetadataNode(&quot;app0JFIF&quot;);</span>
<span class="nc" id="L223">        node.setAttribute(&quot;majorVersion&quot;, Integer.toString(majorVersion));</span>
<span class="nc" id="L224">        node.setAttribute(&quot;minorVersion&quot;, Integer.toString(minorVersion));</span>
<span class="nc" id="L225">        node.setAttribute(&quot;resUnits&quot;, Integer.toString(resUnits));</span>
<span class="nc" id="L226">        node.setAttribute(&quot;Xdensity&quot;, Integer.toString(Xdensity));</span>
<span class="nc" id="L227">        node.setAttribute(&quot;Ydensity&quot;, Integer.toString(Ydensity));</span>
<span class="nc" id="L228">        node.setAttribute(&quot;thumbWidth&quot;, Integer.toString(thumbWidth));</span>
<span class="nc" id="L229">        node.setAttribute(&quot;thumbHeight&quot;, Integer.toString(thumbHeight));</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (!extSegments.isEmpty()) {</span>
<span class="nc" id="L231">            IIOMetadataNode JFXXnode = new IIOMetadataNode(&quot;JFXX&quot;);</span>
<span class="nc" id="L232">            node.appendChild(JFXXnode);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">            for (Iterator iter = extSegments.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L234">                JFIFExtensionMarkerSegment seg =</span>
<span class="nc" id="L235">                    (JFIFExtensionMarkerSegment) iter.next();</span>
<span class="nc" id="L236">                JFXXnode.appendChild(seg.getNativeNode());</span>
<span class="nc" id="L237">            }</span>
        }
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (iccSegment != null) {</span>
<span class="nc" id="L240">            node.appendChild(iccSegment.getNativeNode());</span>
        }

<span class="nc" id="L243">        return node;</span>
    }

    /**
     * Updates the data in this object from the given DOM Node tree.
     * If fromScratch is true, this object is being constructed.
     * Otherwise an existing object is being modified.
     * Throws an IIOInvalidTreeException if the tree is invalid in
     * any way.
     */
    void updateFromNativeNode(Node node, boolean fromScratch)
        throws IIOInvalidTreeException {
        // none of the attributes are required
<span class="nc" id="L256">        NamedNodeMap attrs = node.getAttributes();</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (attrs.getLength() &gt; 0) {</span>
<span class="nc" id="L258">            int value = getAttributeValue(node, attrs, &quot;majorVersion&quot;,</span>
                                          0, 255, false);
<span class="nc bnc" id="L260" title="All 2 branches missed.">            majorVersion = (value != -1) ? value : majorVersion;</span>
<span class="nc" id="L261">            value = getAttributeValue(node, attrs, &quot;minorVersion&quot;,</span>
                                      0, 255, false);
<span class="nc bnc" id="L263" title="All 2 branches missed.">            minorVersion = (value != -1) ? value : minorVersion;</span>
<span class="nc" id="L264">            value = getAttributeValue(node, attrs, &quot;resUnits&quot;, 0, 2, false);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">            resUnits = (value != -1) ? value : resUnits;</span>
<span class="nc" id="L266">            value = getAttributeValue(node, attrs, &quot;Xdensity&quot;, 1, 65535, false);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">            Xdensity = (value != -1) ? value : Xdensity;</span>
<span class="nc" id="L268">            value = getAttributeValue(node, attrs, &quot;Ydensity&quot;, 1, 65535, false);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            Ydensity = (value != -1) ? value : Ydensity;</span>
<span class="nc" id="L270">            value = getAttributeValue(node, attrs, &quot;thumbWidth&quot;, 0, 255, false);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">            thumbWidth = (value != -1) ? value : thumbWidth;</span>
<span class="nc" id="L272">            value = getAttributeValue(node, attrs, &quot;thumbHeight&quot;, 0, 255, false);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            thumbHeight = (value != -1) ? value : thumbHeight;</span>
        }
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (node.hasChildNodes()) {</span>
<span class="nc" id="L276">            NodeList children = node.getChildNodes();</span>
<span class="nc" id="L277">            int count = children.getLength();</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">            if (count &gt; 2) {</span>
<span class="nc" id="L279">                throw new IIOInvalidTreeException</span>
                    (&quot;app0JFIF node cannot have &gt; 2 children&quot;, node);
            }
<span class="nc bnc" id="L282" title="All 2 branches missed.">            for (int i = 0; i &lt; count; i++) {</span>
<span class="nc" id="L283">                Node child = children.item(i);</span>
<span class="nc" id="L284">                String name = child.getNodeName();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                if (name.equals(&quot;JFXX&quot;)) {</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">                    if ((!extSegments.isEmpty()) &amp;&amp; fromScratch) {</span>
<span class="nc" id="L287">                        throw new IIOInvalidTreeException</span>
                            (&quot;app0JFIF node cannot have &gt; 1 JFXX node&quot;, node);
                    }
<span class="nc" id="L290">                    NodeList exts = child.getChildNodes();</span>
<span class="nc" id="L291">                    int extCount = exts.getLength();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                    for (int j = 0; j &lt; extCount; j++) {</span>
<span class="nc" id="L293">                        Node ext = exts.item(j);</span>
<span class="nc" id="L294">                        extSegments.add(new JFIFExtensionMarkerSegment(ext));</span>
                    }
                }
<span class="nc bnc" id="L297" title="All 2 branches missed.">                if (name.equals(&quot;app2ICC&quot;)) {</span>
<span class="nc bnc" id="L298" title="All 4 branches missed.">                    if ((iccSegment != null) &amp;&amp; fromScratch) {</span>
<span class="nc" id="L299">                        throw new IIOInvalidTreeException</span>
                            (&quot;&gt; 1 ICC APP2 Marker Segment not supported&quot;, node);
                    }
<span class="nc" id="L302">                    iccSegment = new ICCMarkerSegment(child);</span>
                }
            }
        }
<span class="nc" id="L306">    }</span>

    int getThumbnailWidth(int index) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (thumb != null) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">            if (index == 0) {</span>
<span class="nc" id="L311">                return thumb.getWidth();</span>
            }
<span class="nc" id="L313">            index--;</span>
        }
<span class="nc" id="L315">        JFIFExtensionMarkerSegment jfxx =</span>
<span class="nc" id="L316">            (JFIFExtensionMarkerSegment) extSegments.get(index);</span>
<span class="nc" id="L317">        return jfxx.thumb.getWidth();</span>
    }

    int getThumbnailHeight(int index) {
<span class="nc bnc" id="L321" title="All 2 branches missed.">        if (thumb != null) {</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            if (index == 0) {</span>
<span class="nc" id="L323">                return thumb.getHeight();</span>
            }
<span class="nc" id="L325">            index--;</span>
        }
<span class="nc" id="L327">        JFIFExtensionMarkerSegment jfxx =</span>
<span class="nc" id="L328">            (JFIFExtensionMarkerSegment) extSegments.get(index);</span>
<span class="nc" id="L329">        return jfxx.thumb.getHeight();</span>
    }

    BufferedImage getThumbnail(ImageInputStream iis,
                               int index,
                               JPEGImageReader reader) throws IOException {
<span class="nc" id="L335">        reader.thumbnailStarted(index);</span>
<span class="nc" id="L336">        BufferedImage ret = null;</span>
<span class="nc bnc" id="L337" title="All 4 branches missed.">        if ((thumb != null) &amp;&amp; (index == 0)) {</span>
<span class="nc" id="L338">                ret = thumb.getThumbnail(iis, reader);</span>
        } else {
<span class="nc bnc" id="L340" title="All 2 branches missed.">            if (thumb != null) {</span>
<span class="nc" id="L341">                index--;</span>
            }
<span class="nc" id="L343">            JFIFExtensionMarkerSegment jfxx =</span>
<span class="nc" id="L344">                (JFIFExtensionMarkerSegment) extSegments.get(index);</span>
<span class="nc" id="L345">            ret = jfxx.thumb.getThumbnail(iis, reader);</span>
        }
<span class="nc" id="L347">        reader.thumbnailComplete();</span>
<span class="nc" id="L348">        return ret;</span>
    }


    /**
     * Writes the data for this segment to the stream in
     * valid JPEG format.  Assumes that there will be no thumbnail.
     */
    void write(ImageOutputStream ios,
               JPEGImageWriter writer) throws IOException {
        // No thumbnail
<span class="nc" id="L359">        write(ios, null, writer);</span>
<span class="nc" id="L360">    }</span>

    /**
     * Writes the data for this segment to the stream in
     * valid JPEG format.  The length written takes the thumbnail
     * width and height into account.  If necessary, the thumbnail
     * is clipped to 255 x 255 and a warning is sent to the writer
     * argument.  Progress updates are sent to the writer argument.
     */
    void write(ImageOutputStream ios,
               BufferedImage thumb,
               JPEGImageWriter writer) throws IOException {
<span class="nc" id="L372">        int thumbWidth = 0;</span>
<span class="nc" id="L373">        int thumbHeight = 0;</span>
<span class="nc" id="L374">        int thumbLength = 0;</span>
<span class="nc" id="L375">        int [] thumbData = null;</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (thumb != null) {</span>
            // Clip if necessary and get the data in thumbData
<span class="nc" id="L378">            thumbWidth = thumb.getWidth();</span>
<span class="nc" id="L379">            thumbHeight = thumb.getHeight();</span>
<span class="nc bnc" id="L380" title="All 4 branches missed.">            if ((thumbWidth &gt; MAX_THUMB_WIDTH)</span>
                || (thumbHeight &gt; MAX_THUMB_HEIGHT)) {
<span class="nc" id="L382">                writer.warningOccurred(JPEGImageWriter.WARNING_THUMB_CLIPPED);</span>
            }
<span class="nc" id="L384">            thumbWidth = Math.min(thumbWidth, MAX_THUMB_WIDTH);</span>
<span class="nc" id="L385">            thumbHeight = Math.min(thumbHeight, MAX_THUMB_HEIGHT);</span>
<span class="nc" id="L386">            thumbData = thumb.getRaster().getPixels(0, 0,</span>
                                                    thumbWidth, thumbHeight,
                                                    (int []) null);
<span class="nc" id="L389">            thumbLength = thumbData.length;</span>
        }
<span class="nc" id="L391">        length = DATA_SIZE + LENGTH_SIZE + thumbLength;</span>
<span class="nc" id="L392">        writeTag(ios);</span>
<span class="nc" id="L393">        byte [] id = {0x4A, 0x46, 0x49, 0x46, 0x00};</span>
<span class="nc" id="L394">        ios.write(id);</span>
<span class="nc" id="L395">        ios.write(majorVersion);</span>
<span class="nc" id="L396">        ios.write(minorVersion);</span>
<span class="nc" id="L397">        ios.write(resUnits);</span>
<span class="nc" id="L398">        write2bytes(ios, Xdensity);</span>
<span class="nc" id="L399">        write2bytes(ios, Ydensity);</span>
<span class="nc" id="L400">        ios.write(thumbWidth);</span>
<span class="nc" id="L401">        ios.write(thumbHeight);</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">        if (thumbData != null) {</span>
<span class="nc" id="L403">            writer.thumbnailStarted(0);</span>
<span class="nc" id="L404">            writeThumbnailData(ios, thumbData, writer);</span>
<span class="nc" id="L405">            writer.thumbnailComplete();</span>
        }
<span class="nc" id="L407">    }</span>

    /*
     * Write out the values in the integer array as a sequence of bytes,
     * reporting progress to the writer argument.
     */
    void writeThumbnailData(ImageOutputStream ios,
                            int [] thumbData,
                            JPEGImageWriter writer) throws IOException {
<span class="nc" id="L416">        int progInterval = thumbData.length / 20;  // approx. every 5%</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (progInterval == 0) {</span>
<span class="nc" id="L418">            progInterval = 1;</span>
        }
<span class="nc bnc" id="L420" title="All 2 branches missed.">        for (int i = 0; i &lt; thumbData.length; i++) {</span>
<span class="nc" id="L421">            ios.write(thumbData[i]);</span>
<span class="nc bnc" id="L422" title="All 4 branches missed.">            if ((i &gt; progInterval) &amp;&amp; (i % progInterval == 0)) {</span>
<span class="nc" id="L423">                writer.thumbnailProgress</span>
<span class="nc" id="L424">                    (((float) i * 100) / ((float) thumbData.length));</span>
            }
        }
<span class="nc" id="L427">    }</span>

    /**
     * Write out this JFIF Marker Segment, including a thumbnail or
     * appending a series of JFXX Marker Segments, as appropriate.
     * Warnings and progress reports are sent to the writer argument.
     * The list of thumbnails is matched to the list of JFXX extension
     * segments, if any, in order to determine how to encode the
     * thumbnails.  If there are more thumbnails than metadata segments,
     * default encoding is used for the extra thumbnails.
     */
    void writeWithThumbs(ImageOutputStream ios,
                         List thumbnails,
                         JPEGImageWriter writer) throws IOException {
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (thumbnails != null) {</span>
<span class="nc" id="L442">            JFIFExtensionMarkerSegment jfxx = null;</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">            if (thumbnails.size() == 1) {</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">                if (!extSegments.isEmpty()) {</span>
<span class="nc" id="L445">                    jfxx = (JFIFExtensionMarkerSegment) extSegments.get(0);</span>
                }
<span class="nc" id="L447">                writeThumb(ios,</span>
<span class="nc" id="L448">                           (BufferedImage) thumbnails.get(0),</span>
                           jfxx,
                           0,
                           true,
                           writer);
            } else {
                // All others write as separate JFXX segments
<span class="nc" id="L455">                write(ios, writer);  // Just the header without any thumbnail</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                for (int i = 0; i &lt; thumbnails.size(); i++) {</span>
<span class="nc" id="L457">                    jfxx = null;</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">                    if (i &lt; extSegments.size()) {</span>
<span class="nc" id="L459">                        jfxx = (JFIFExtensionMarkerSegment) extSegments.get(i);</span>
                    }
<span class="nc" id="L461">                    writeThumb(ios,</span>
<span class="nc" id="L462">                               (BufferedImage) thumbnails.get(i),</span>
                               jfxx,
                               i,
                               false,
                               writer);
                }
            }
<span class="nc" id="L469">        } else {  // No thumbnails</span>
<span class="nc" id="L470">            write(ios, writer);</span>
        }

<span class="nc" id="L473">    }</span>

    private void writeThumb(ImageOutputStream ios,
                            BufferedImage thumb,
                            JFIFExtensionMarkerSegment jfxx,
                            int index,
                            boolean onlyOne,
                            JPEGImageWriter writer) throws IOException {
<span class="nc" id="L481">        ColorModel cm = thumb.getColorModel();</span>
<span class="nc" id="L482">        ColorSpace cs = cm.getColorSpace();</span>

<span class="nc bnc" id="L484" title="All 2 branches missed.">        if (cm instanceof IndexColorModel) {</span>
            // We never write a palette image into the header
            // So if it's the only one, we need to write the header first
<span class="nc bnc" id="L487" title="All 2 branches missed.">            if (onlyOne) {</span>
<span class="nc" id="L488">                write(ios, writer);</span>
            }
<span class="nc bnc" id="L490" title="All 4 branches missed.">            if ((jfxx == null)</span>
                || (jfxx.code == THUMB_PALETTE)) {
<span class="nc" id="L492">                writeJFXXSegment(index, thumb, ios, writer); // default</span>
            } else {
                // Expand to RGB
<span class="nc" id="L495">                BufferedImage thumbRGB =</span>
                    ((IndexColorModel) cm).convertToIntDiscrete
<span class="nc" id="L497">                    (thumb.getRaster(), false);</span>
<span class="nc" id="L498">                jfxx.setThumbnail(thumbRGB);</span>
<span class="nc" id="L499">                writer.thumbnailStarted(index);</span>
<span class="nc" id="L500">                jfxx.write(ios, writer);  // Handles clipping if needed</span>
<span class="nc" id="L501">                writer.thumbnailComplete();</span>
<span class="nc" id="L502">            }</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">        } else if (cs.getType() == ColorSpace.TYPE_RGB) {</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">            if (jfxx == null) {</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                if (onlyOne) {</span>
<span class="nc" id="L506">                    write(ios, thumb, writer); // As part of the header</span>
                } else {
<span class="nc" id="L508">                    writeJFXXSegment(index, thumb, ios, writer); // default</span>
                }
            } else {
                // If this is the only one, write the header first
<span class="nc bnc" id="L512" title="All 2 branches missed.">                if (onlyOne) {</span>
<span class="nc" id="L513">                    write(ios, writer);</span>
                }
<span class="nc bnc" id="L515" title="All 2 branches missed.">                if (jfxx.code == THUMB_PALETTE) {</span>
<span class="nc" id="L516">                    writeJFXXSegment(index, thumb, ios, writer); // default</span>
<span class="nc" id="L517">                    writer.warningOccurred</span>
<span class="nc" id="L518">                        (JPEGImageWriter.WARNING_NO_RGB_THUMB_AS_INDEXED);</span>
                } else {
<span class="nc" id="L520">                    jfxx.setThumbnail(thumb);</span>
<span class="nc" id="L521">                    writer.thumbnailStarted(index);</span>
<span class="nc" id="L522">                    jfxx.write(ios, writer);  // Handles clipping if needed</span>
<span class="nc" id="L523">                    writer.thumbnailComplete();</span>
                }
            }
<span class="nc bnc" id="L526" title="All 2 branches missed.">        } else if (cs.getType() == ColorSpace.TYPE_GRAY) {</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">            if (jfxx == null) {</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">                if (onlyOne) {</span>
<span class="nc" id="L529">                    BufferedImage thumbRGB = expandGrayThumb(thumb);</span>
<span class="nc" id="L530">                    write(ios, thumbRGB, writer); // As part of the header</span>
<span class="nc" id="L531">                } else {</span>
<span class="nc" id="L532">                    writeJFXXSegment(index, thumb, ios, writer); // default</span>
                }
            } else {
                // If this is the only one, write the header first
<span class="nc bnc" id="L536" title="All 2 branches missed.">                if (onlyOne) {</span>
<span class="nc" id="L537">                    write(ios, writer);</span>
                }
<span class="nc bnc" id="L539" title="All 2 branches missed.">                if (jfxx.code == THUMB_RGB) {</span>
<span class="nc" id="L540">                    BufferedImage thumbRGB = expandGrayThumb(thumb);</span>
<span class="nc" id="L541">                    writeJFXXSegment(index, thumbRGB, ios, writer);</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                } else if (jfxx.code == THUMB_JPEG) {</span>
<span class="nc" id="L543">                    jfxx.setThumbnail(thumb);</span>
<span class="nc" id="L544">                    writer.thumbnailStarted(index);</span>
<span class="nc" id="L545">                    jfxx.write(ios, writer);  // Handles clipping if needed</span>
<span class="nc" id="L546">                    writer.thumbnailComplete();</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                } else if (jfxx.code == THUMB_PALETTE) {</span>
<span class="nc" id="L548">                    writeJFXXSegment(index, thumb, ios, writer); // default</span>
<span class="nc" id="L549">                    writer.warningOccurred</span>
<span class="nc" id="L550">                        (JPEGImageWriter.WARNING_NO_GRAY_THUMB_AS_INDEXED);</span>
                }
            }
        } else {
<span class="nc" id="L554">            writer.warningOccurred</span>
<span class="nc" id="L555">                (JPEGImageWriter.WARNING_ILLEGAL_THUMBNAIL);</span>
        }
<span class="nc" id="L557">    }</span>

    // Could put reason codes in here to be parsed in writeJFXXSegment
    // in order to provide more meaningful warnings.
<span class="nc" id="L561">    private class IllegalThumbException extends Exception {}</span>

    /**
     * Writes out a new JFXX extension segment, without saving it.
     */
    private void writeJFXXSegment(int index,
                                  BufferedImage thumbnail,
                                  ImageOutputStream ios,
                                  JPEGImageWriter writer) throws IOException {
<span class="nc" id="L570">        JFIFExtensionMarkerSegment jfxx = null;</span>
        try {
<span class="nc" id="L572">             jfxx = new JFIFExtensionMarkerSegment(thumbnail);</span>
<span class="nc" id="L573">        } catch (IllegalThumbException e) {</span>
<span class="nc" id="L574">            writer.warningOccurred</span>
<span class="nc" id="L575">                (JPEGImageWriter.WARNING_ILLEGAL_THUMBNAIL);</span>
<span class="nc" id="L576">            return;</span>
<span class="nc" id="L577">        }</span>
<span class="nc" id="L578">        writer.thumbnailStarted(index);</span>
<span class="nc" id="L579">        jfxx.write(ios, writer);</span>
<span class="nc" id="L580">        writer.thumbnailComplete();</span>
<span class="nc" id="L581">    }</span>


    /**
     * Return an RGB image that is the expansion of the given grayscale
     * image.
     */
    private static BufferedImage expandGrayThumb(BufferedImage thumb) {
<span class="nc" id="L589">        BufferedImage ret = new BufferedImage(thumb.getWidth(),</span>
<span class="nc" id="L590">                                              thumb.getHeight(),</span>
                                              BufferedImage.TYPE_INT_RGB);
<span class="nc" id="L592">        Graphics g = ret.getGraphics();</span>
<span class="nc" id="L593">        g.drawImage(thumb, 0, 0, null);</span>
<span class="nc" id="L594">        return ret;</span>
    }

    /**
     * Writes out a default JFIF marker segment to the given
     * output stream.  If &lt;code&gt;thumbnails&lt;/code&gt; is not &lt;code&gt;null&lt;/code&gt;,
     * writes out the set of thumbnail images as JFXX marker segments, or
     * incorporated into the JFIF segment if appropriate.
     * If &lt;code&gt;iccProfile&lt;/code&gt; is not &lt;code&gt;null&lt;/code&gt;,
     * writes out the profile after the JFIF segment using as many APP2
     * marker segments as necessary.
     */
    static void writeDefaultJFIF(ImageOutputStream ios,
                                 List thumbnails,
                                 ICC_Profile iccProfile,
                                 JPEGImageWriter writer)
        throws IOException {

<span class="nc" id="L612">        JFIFMarkerSegment jfif = new JFIFMarkerSegment();</span>
<span class="nc" id="L613">        jfif.writeWithThumbs(ios, thumbnails, writer);</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (iccProfile != null) {</span>
<span class="nc" id="L615">            writeICC(iccProfile, ios);</span>
        }
<span class="nc" id="L617">    }</span>

    /**
     * Prints out the contents of this object to System.out for debugging.
     */
    void print() {
<span class="nc" id="L623">        printTag(&quot;JFIF&quot;);</span>
<span class="nc" id="L624">        System.out.print(&quot;Version &quot;);</span>
<span class="nc" id="L625">        System.out.print(majorVersion);</span>
<span class="nc" id="L626">        System.out.println(&quot;.0&quot;</span>
<span class="nc" id="L627">                           + Integer.toString(minorVersion));</span>
<span class="nc" id="L628">        System.out.print(&quot;Resolution units: &quot;);</span>
<span class="nc" id="L629">        System.out.println(resUnits);</span>
<span class="nc" id="L630">        System.out.print(&quot;X density: &quot;);</span>
<span class="nc" id="L631">        System.out.println(Xdensity);</span>
<span class="nc" id="L632">        System.out.print(&quot;Y density: &quot;);</span>
<span class="nc" id="L633">        System.out.println(Ydensity);</span>
<span class="nc" id="L634">        System.out.print(&quot;Thumbnail Width: &quot;);</span>
<span class="nc" id="L635">        System.out.println(thumbWidth);</span>
<span class="nc" id="L636">        System.out.print(&quot;Thumbnail Height: &quot;);</span>
<span class="nc" id="L637">        System.out.println(thumbHeight);</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">        if (!extSegments.isEmpty()) {</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">            for (Iterator iter = extSegments.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L640">                JFIFExtensionMarkerSegment extSegment =</span>
<span class="nc" id="L641">                    (JFIFExtensionMarkerSegment) iter.next();</span>
<span class="nc" id="L642">                extSegment.print();</span>
<span class="nc" id="L643">            }</span>
        }
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if (iccSegment != null) {</span>
<span class="nc" id="L646">            iccSegment.print();</span>
        }
<span class="nc" id="L648">    }</span>

    /**
     * A JFIF extension APP0 marker segment.
     */
    class JFIFExtensionMarkerSegment extends MarkerSegment {
        int code;
        JFIFThumb thumb;
        private static final int DATA_SIZE = 6;
        private static final int ID_SIZE = 5;

        JFIFExtensionMarkerSegment(JPEGBuffer buffer, JPEGImageReader reader)
<span class="nc" id="L660">            throws IOException {</span>

<span class="nc" id="L662">            super(buffer);</span>
<span class="nc" id="L663">            buffer.bufPtr += ID_SIZE;  // skip the id, we already checked it</span>

<span class="nc" id="L665">            code = buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L666">            buffer.bufAvail -= DATA_SIZE;</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">            if (code == THUMB_JPEG) {</span>
<span class="nc" id="L668">                thumb = new JFIFThumbJPEG(buffer, length, reader);</span>
            } else {
<span class="nc" id="L670">                buffer.loadBuf(2);</span>
<span class="nc" id="L671">                int thumbX = buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L672">                int thumbY = buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L673">                buffer.bufAvail -= 2;</span>
                // following constructors handle bufAvail
<span class="nc bnc" id="L675" title="All 2 branches missed.">                if (code == THUMB_PALETTE) {</span>
<span class="nc" id="L676">                    thumb = new JFIFThumbPalette(buffer, thumbX, thumbY);</span>
                } else {
<span class="nc" id="L678">                    thumb = new JFIFThumbRGB(buffer, thumbX, thumbY);</span>
                }
            }
<span class="nc" id="L681">        }</span>

<span class="nc" id="L683">        JFIFExtensionMarkerSegment(Node node) throws IIOInvalidTreeException {</span>
<span class="nc" id="L684">            super(JPEG.APP0);</span>
<span class="nc" id="L685">            NamedNodeMap attrs = node.getAttributes();</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">            if (attrs.getLength() &gt; 0) {</span>
<span class="nc" id="L687">                code = getAttributeValue(node,</span>
                                         attrs,
                                         &quot;extensionCode&quot;,
                                         THUMB_JPEG,
                                         THUMB_RGB,
                                         false);
<span class="nc bnc" id="L693" title="All 2 branches missed.">                if (code == THUMB_UNASSIGNED) {</span>
<span class="nc" id="L694">                throw new IIOInvalidTreeException</span>
                    (&quot;invalid extensionCode attribute value&quot;, node);
                }
            } else {
<span class="nc" id="L698">                code = THUMB_UNASSIGNED;</span>
            }
            // Now the child
<span class="nc bnc" id="L701" title="All 2 branches missed.">            if (node.getChildNodes().getLength() != 1) {</span>
<span class="nc" id="L702">                throw new IIOInvalidTreeException</span>
                    (&quot;app0JFXX node must have exactly 1 child&quot;, node);
            }
<span class="nc" id="L705">            Node child = node.getFirstChild();</span>
<span class="nc" id="L706">            String name = child.getNodeName();</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">            if (name.equals(&quot;JFIFthumbJPEG&quot;)) {</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                if (code == THUMB_UNASSIGNED) {</span>
<span class="nc" id="L709">                    code = THUMB_JPEG;</span>
                }
<span class="nc" id="L711">                thumb = new JFIFThumbJPEG(child);</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">            } else if (name.equals(&quot;JFIFthumbPalette&quot;)) {</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                if (code == THUMB_UNASSIGNED) {</span>
<span class="nc" id="L714">                    code = THUMB_PALETTE;</span>
                }
<span class="nc" id="L716">                thumb = new JFIFThumbPalette(child);</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">            } else if (name.equals(&quot;JFIFthumbRGB&quot;)) {</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                if (code == THUMB_UNASSIGNED) {</span>
<span class="nc" id="L719">                    code = THUMB_RGB;</span>
                }
<span class="nc" id="L721">                thumb = new JFIFThumbRGB(child);</span>
            } else {
<span class="nc" id="L723">                throw new IIOInvalidTreeException</span>
                    (&quot;unrecognized app0JFXX child node&quot;, node);
            }
<span class="nc" id="L726">        }</span>

        JFIFExtensionMarkerSegment(BufferedImage thumbnail)
<span class="nc" id="L729">            throws IllegalThumbException {</span>

<span class="nc" id="L731">            super(JPEG.APP0);</span>
<span class="nc" id="L732">            ColorModel cm = thumbnail.getColorModel();</span>
<span class="nc" id="L733">            int csType = cm.getColorSpace().getType();</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">            if (cm.hasAlpha()) {</span>
<span class="nc" id="L735">                throw new IllegalThumbException();</span>
            }
<span class="nc bnc" id="L737" title="All 2 branches missed.">            if (cm instanceof IndexColorModel) {</span>
<span class="nc" id="L738">                code = THUMB_PALETTE;</span>
<span class="nc" id="L739">                thumb = new JFIFThumbPalette(thumbnail);</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">            } else if (csType == ColorSpace.TYPE_RGB) {</span>
<span class="nc" id="L741">                code = THUMB_RGB;</span>
<span class="nc" id="L742">                thumb = new JFIFThumbRGB(thumbnail);</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">            } else if (csType == ColorSpace.TYPE_GRAY) {</span>
<span class="nc" id="L744">                code = THUMB_JPEG;</span>
<span class="nc" id="L745">                thumb = new JFIFThumbJPEG(thumbnail);</span>
            } else {
<span class="nc" id="L747">                throw new IllegalThumbException();</span>
            }
<span class="nc" id="L749">        }</span>

        void setThumbnail(BufferedImage thumbnail) {
            try {
<span class="nc bnc" id="L753" title="All 4 branches missed.">                switch (code) {</span>
                case THUMB_PALETTE:
<span class="nc" id="L755">                    thumb = new JFIFThumbPalette(thumbnail);</span>
<span class="nc" id="L756">                    break;</span>
                case THUMB_RGB:
<span class="nc" id="L758">                    thumb = new JFIFThumbRGB(thumbnail);</span>
<span class="nc" id="L759">                    break;</span>
                case THUMB_JPEG:
<span class="nc" id="L761">                    thumb = new JFIFThumbJPEG(thumbnail);</span>
                    break;
                }
<span class="nc" id="L764">            } catch (IllegalThumbException e) {</span>
                // Should never happen
<span class="nc" id="L766">                throw new InternalError(&quot;Illegal thumb in setThumbnail!&quot;, e);</span>
<span class="nc" id="L767">            }</span>
<span class="nc" id="L768">        }</span>

        protected Object clone() {
<span class="nc" id="L771">            JFIFExtensionMarkerSegment newGuy =</span>
<span class="nc" id="L772">                (JFIFExtensionMarkerSegment) super.clone();</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">            if (thumb != null) {</span>
<span class="nc" id="L774">                newGuy.thumb = (JFIFThumb) thumb.clone();</span>
            }
<span class="nc" id="L776">            return newGuy;</span>
        }

        IIOMetadataNode getNativeNode() {
<span class="nc" id="L780">            IIOMetadataNode node = new IIOMetadataNode(&quot;app0JFXX&quot;);</span>
<span class="nc" id="L781">            node.setAttribute(&quot;extensionCode&quot;, Integer.toString(code));</span>
<span class="nc" id="L782">            node.appendChild(thumb.getNativeNode());</span>
<span class="nc" id="L783">            return node;</span>
        }

        void write(ImageOutputStream ios,
                   JPEGImageWriter writer) throws IOException {
<span class="nc" id="L788">            length = LENGTH_SIZE + DATA_SIZE + thumb.getLength();</span>
<span class="nc" id="L789">            writeTag(ios);</span>
<span class="nc" id="L790">            byte [] id = {0x4A, 0x46, 0x58, 0x58, 0x00};</span>
<span class="nc" id="L791">            ios.write(id);</span>
<span class="nc" id="L792">            ios.write(code);</span>
<span class="nc" id="L793">            thumb.write(ios, writer);</span>
<span class="nc" id="L794">        }</span>

        void print() {
<span class="nc" id="L797">            printTag(&quot;JFXX&quot;);</span>
<span class="nc" id="L798">            thumb.print();</span>
<span class="nc" id="L799">        }</span>
    }

    /**
     * A superclass for the varieties of thumbnails that can
     * be stored in a JFIF extension marker segment.
     */
    abstract class JFIFThumb implements Cloneable {
<span class="nc" id="L807">        long streamPos = -1L;  // Save the thumbnail pos when reading</span>
        abstract int getLength(); // When writing
        abstract int getWidth();
        abstract int getHeight();
        abstract BufferedImage getThumbnail(ImageInputStream iis,
                                            JPEGImageReader reader)
            throws IOException;

<span class="nc" id="L815">        protected JFIFThumb() {}</span>

<span class="nc" id="L817">        protected JFIFThumb(JPEGBuffer buffer) throws IOException{</span>
            // Save the stream position for reading the thumbnail later
<span class="nc" id="L819">            streamPos = buffer.getStreamPosition();</span>
<span class="nc" id="L820">        }</span>

        abstract void print();

        abstract IIOMetadataNode getNativeNode();

        abstract void write(ImageOutputStream ios,
                            JPEGImageWriter writer) throws IOException;

        protected Object clone() {
            try {
<span class="nc" id="L831">                return super.clone();</span>
<span class="nc" id="L832">            } catch (CloneNotSupportedException e) {} // won't happen</span>
<span class="nc" id="L833">            return null;</span>
        }

    }

    abstract class JFIFThumbUncompressed extends JFIFThumb {
<span class="nc" id="L839">        BufferedImage thumbnail = null;</span>
        int thumbWidth;
        int thumbHeight;
        String name;

        JFIFThumbUncompressed(JPEGBuffer buffer,
                              int width,
                              int height,
                              int skip,
                              String name)
<span class="nc" id="L849">            throws IOException {</span>
<span class="nc" id="L850">            super(buffer);</span>
<span class="nc" id="L851">            thumbWidth = width;</span>
<span class="nc" id="L852">            thumbHeight = height;</span>
            // Now skip the thumbnail data
<span class="nc" id="L854">            buffer.skipData(skip);</span>
<span class="nc" id="L855">            this.name = name;</span>
<span class="nc" id="L856">        }</span>

        JFIFThumbUncompressed(Node node, String name)
<span class="nc" id="L859">            throws IIOInvalidTreeException {</span>

<span class="nc" id="L861">            thumbWidth = 0;</span>
<span class="nc" id="L862">            thumbHeight = 0;</span>
<span class="nc" id="L863">            this.name = name;</span>
<span class="nc" id="L864">            NamedNodeMap attrs = node.getAttributes();</span>
<span class="nc" id="L865">            int count = attrs.getLength();</span>
<span class="nc bnc" id="L866" title="All 2 branches missed.">            if (count &gt; 2) {</span>
<span class="nc" id="L867">                throw new IIOInvalidTreeException</span>
                    (name +&quot; node cannot have &gt; 2 attributes&quot;, node);
            }
<span class="nc bnc" id="L870" title="All 2 branches missed.">            if (count != 0) {</span>
<span class="nc" id="L871">                int value = getAttributeValue(node, attrs, &quot;thumbWidth&quot;,</span>
                                              0, 255, false);
<span class="nc bnc" id="L873" title="All 2 branches missed.">                thumbWidth = (value != -1) ? value : thumbWidth;</span>
<span class="nc" id="L874">                value = getAttributeValue(node, attrs, &quot;thumbHeight&quot;,</span>
                                          0, 255, false);
<span class="nc bnc" id="L876" title="All 2 branches missed.">                thumbHeight = (value != -1) ? value : thumbHeight;</span>
            }
<span class="nc" id="L878">        }</span>

<span class="nc" id="L880">        JFIFThumbUncompressed(BufferedImage thumb) {</span>
<span class="nc" id="L881">            thumbnail = thumb;</span>
<span class="nc" id="L882">            thumbWidth = thumb.getWidth();</span>
<span class="nc" id="L883">            thumbHeight = thumb.getHeight();</span>
<span class="nc" id="L884">            name = null;  // not used when writing</span>
<span class="nc" id="L885">        }</span>

        void readByteBuffer(ImageInputStream iis,
                            byte [] data,
                            JPEGImageReader reader,
                            float workPortion,
                            float workOffset) throws IOException {
<span class="nc" id="L892">            int progInterval = Math.max((int)(data.length/20/workPortion),</span>
                                        1);
<span class="nc" id="L894">            for (int offset = 0;</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">                 offset &lt; data.length;) {</span>
<span class="nc" id="L896">                int len = Math.min(progInterval, data.length-offset);</span>
<span class="nc" id="L897">                iis.read(data, offset, len);</span>
<span class="nc" id="L898">                offset += progInterval;</span>
<span class="nc" id="L899">                float percentDone = ((float) offset* 100)</span>
                    / data.length
                    * workPortion + workOffset;
<span class="nc bnc" id="L902" title="All 2 branches missed.">                if (percentDone &gt; 100.0F) {</span>
<span class="nc" id="L903">                    percentDone = 100.0F;</span>
                }
<span class="nc" id="L905">                reader.thumbnailProgress (percentDone);</span>
<span class="nc" id="L906">            }</span>
<span class="nc" id="L907">        }</span>


        int getWidth() {
<span class="nc" id="L911">            return thumbWidth;</span>
        }

        int getHeight() {
<span class="nc" id="L915">            return thumbHeight;</span>
        }

        IIOMetadataNode getNativeNode() {
<span class="nc" id="L919">            IIOMetadataNode node = new IIOMetadataNode(name);</span>
<span class="nc" id="L920">            node.setAttribute(&quot;thumbWidth&quot;, Integer.toString(thumbWidth));</span>
<span class="nc" id="L921">            node.setAttribute(&quot;thumbHeight&quot;, Integer.toString(thumbHeight));</span>
<span class="nc" id="L922">            return node;</span>
        }

        void write(ImageOutputStream ios,
                   JPEGImageWriter writer) throws IOException {
<span class="nc bnc" id="L927" title="All 4 branches missed.">            if ((thumbWidth &gt; MAX_THUMB_WIDTH)</span>
                || (thumbHeight &gt; MAX_THUMB_HEIGHT)) {
<span class="nc" id="L929">                writer.warningOccurred(JPEGImageWriter.WARNING_THUMB_CLIPPED);</span>
            }
<span class="nc" id="L931">            thumbWidth = Math.min(thumbWidth, MAX_THUMB_WIDTH);</span>
<span class="nc" id="L932">            thumbHeight = Math.min(thumbHeight, MAX_THUMB_HEIGHT);</span>
<span class="nc" id="L933">            ios.write(thumbWidth);</span>
<span class="nc" id="L934">            ios.write(thumbHeight);</span>
<span class="nc" id="L935">        }</span>

        void writePixels(ImageOutputStream ios,
                         JPEGImageWriter writer) throws IOException {
<span class="nc bnc" id="L939" title="All 4 branches missed.">            if ((thumbWidth &gt; MAX_THUMB_WIDTH)</span>
                || (thumbHeight &gt; MAX_THUMB_HEIGHT)) {
<span class="nc" id="L941">                writer.warningOccurred(JPEGImageWriter.WARNING_THUMB_CLIPPED);</span>
            }
<span class="nc" id="L943">            thumbWidth = Math.min(thumbWidth, MAX_THUMB_WIDTH);</span>
<span class="nc" id="L944">            thumbHeight = Math.min(thumbHeight, MAX_THUMB_HEIGHT);</span>
<span class="nc" id="L945">            int [] data = thumbnail.getRaster().getPixels(0, 0,</span>
                                                          thumbWidth,
                                                          thumbHeight,
                                                          (int []) null);
<span class="nc" id="L949">            writeThumbnailData(ios, data, writer);</span>
<span class="nc" id="L950">        }</span>

        void print() {
<span class="nc" id="L953">            System.out.print(name + &quot; width: &quot;);</span>
<span class="nc" id="L954">            System.out.println(thumbWidth);</span>
<span class="nc" id="L955">            System.out.print(name + &quot; height: &quot;);</span>
<span class="nc" id="L956">            System.out.println(thumbHeight);</span>
<span class="nc" id="L957">        }</span>

    }

    /**
     * A JFIF thumbnail stored as RGB, one byte per channel,
     * interleaved.
     */
    class JFIFThumbRGB extends JFIFThumbUncompressed {

        JFIFThumbRGB(JPEGBuffer buffer, int width, int height)
<span class="nc" id="L968">            throws IOException {</span>

<span class="nc" id="L970">            super(buffer, width, height, width*height*3, &quot;JFIFthumbRGB&quot;);</span>
<span class="nc" id="L971">        }</span>

<span class="nc" id="L973">        JFIFThumbRGB(Node node) throws IIOInvalidTreeException {</span>
<span class="nc" id="L974">            super(node, &quot;JFIFthumbRGB&quot;);</span>
<span class="nc" id="L975">        }</span>

<span class="nc" id="L977">        JFIFThumbRGB(BufferedImage thumb) throws IllegalThumbException {</span>
<span class="nc" id="L978">            super(thumb);</span>
<span class="nc" id="L979">        }</span>

        int getLength() {
<span class="nc" id="L982">            return (thumbWidth*thumbHeight*3);</span>
        }

        BufferedImage getThumbnail(ImageInputStream iis,
                                   JPEGImageReader reader)
            throws IOException {
<span class="nc" id="L988">            iis.mark();</span>
<span class="nc" id="L989">            iis.seek(streamPos);</span>
<span class="nc" id="L990">            DataBufferByte buffer = new DataBufferByte(getLength());</span>
<span class="nc" id="L991">            readByteBuffer(iis,</span>
<span class="nc" id="L992">                           buffer.getData(),</span>
                           reader,
                           1.0F,
                           0.0F);
<span class="nc" id="L996">            iis.reset();</span>

<span class="nc" id="L998">            WritableRaster raster =</span>
<span class="nc" id="L999">                Raster.createInterleavedRaster(buffer,</span>
                                               thumbWidth,
                                               thumbHeight,
                                               thumbWidth*3,
                                               3,
                                               new int [] {0, 1, 2},
                                               null);
<span class="nc" id="L1006">            ColorModel cm = new ComponentColorModel(JPEG.JCS.sRGB,</span>
                                                    false,
                                                    false,
                                                    ColorModel.OPAQUE,
                                                    DataBuffer.TYPE_BYTE);
<span class="nc" id="L1011">            return new BufferedImage(cm,</span>
                                     raster,
                                     false,
                                     null);
        }

        void write(ImageOutputStream ios,
                   JPEGImageWriter writer) throws IOException {
<span class="nc" id="L1019">            super.write(ios, writer); // width and height</span>
<span class="nc" id="L1020">            writePixels(ios, writer);</span>
<span class="nc" id="L1021">        }</span>

    }

    /**
     * A JFIF thumbnail stored as an indexed palette image
     * using an RGB palette.
     */
    class JFIFThumbPalette extends JFIFThumbUncompressed {
        private static final int PALETTE_SIZE = 768;

        JFIFThumbPalette(JPEGBuffer buffer, int width, int height)
<span class="nc" id="L1033">            throws IOException {</span>
<span class="nc" id="L1034">            super(buffer,</span>
                  width,
                  height,
                  PALETTE_SIZE + width * height,
                  &quot;JFIFThumbPalette&quot;);
<span class="nc" id="L1039">        }</span>

<span class="nc" id="L1041">        JFIFThumbPalette(Node node) throws IIOInvalidTreeException {</span>
<span class="nc" id="L1042">            super(node, &quot;JFIFThumbPalette&quot;);</span>
<span class="nc" id="L1043">        }</span>

<span class="nc" id="L1045">        JFIFThumbPalette(BufferedImage thumb) throws IllegalThumbException {</span>
<span class="nc" id="L1046">            super(thumb);</span>
<span class="nc" id="L1047">            IndexColorModel icm = (IndexColorModel) thumbnail.getColorModel();</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">            if (icm.getMapSize() &gt; 256) {</span>
<span class="nc" id="L1049">                throw new IllegalThumbException();</span>
            }
<span class="nc" id="L1051">        }</span>

        int getLength() {
<span class="nc" id="L1054">            return (thumbWidth*thumbHeight + PALETTE_SIZE);</span>
        }

        BufferedImage getThumbnail(ImageInputStream iis,
                                   JPEGImageReader reader)
            throws IOException {
<span class="nc" id="L1060">            iis.mark();</span>
<span class="nc" id="L1061">            iis.seek(streamPos);</span>
            // read the palette
<span class="nc" id="L1063">            byte [] palette = new byte [PALETTE_SIZE];</span>
<span class="nc" id="L1064">            float palettePart = ((float) PALETTE_SIZE) / getLength();</span>
<span class="nc" id="L1065">            readByteBuffer(iis,</span>
                           palette,
                           reader,
                           palettePart,
                           0.0F);
<span class="nc" id="L1070">            DataBufferByte buffer = new DataBufferByte(thumbWidth*thumbHeight);</span>
<span class="nc" id="L1071">            readByteBuffer(iis,</span>
<span class="nc" id="L1072">                           buffer.getData(),</span>
                           reader,
                           1.0F-palettePart,
                           palettePart);
<span class="nc" id="L1076">            iis.read();</span>
<span class="nc" id="L1077">            iis.reset();</span>

<span class="nc" id="L1079">            IndexColorModel cm = new IndexColorModel(8,</span>
                                                     256,
                                                     palette,
                                                     0,
                                                     false);
<span class="nc" id="L1084">            SampleModel sm = cm.createCompatibleSampleModel(thumbWidth,</span>
                                                            thumbHeight);
<span class="nc" id="L1086">            WritableRaster raster =</span>
<span class="nc" id="L1087">                Raster.createWritableRaster(sm, buffer, null);</span>
<span class="nc" id="L1088">            return new BufferedImage(cm,</span>
                                     raster,
                                     false,
                                     null);
        }

        void write(ImageOutputStream ios,
                   JPEGImageWriter writer) throws IOException {
<span class="nc" id="L1096">            super.write(ios, writer); // width and height</span>
            // Write the palette (must be 768 bytes)
<span class="nc" id="L1098">            byte [] palette = new byte[768];</span>
<span class="nc" id="L1099">            IndexColorModel icm = (IndexColorModel) thumbnail.getColorModel();</span>
<span class="nc" id="L1100">            byte [] reds = new byte [256];</span>
<span class="nc" id="L1101">            byte [] greens = new byte [256];</span>
<span class="nc" id="L1102">            byte [] blues = new byte [256];</span>
<span class="nc" id="L1103">            icm.getReds(reds);</span>
<span class="nc" id="L1104">            icm.getGreens(greens);</span>
<span class="nc" id="L1105">            icm.getBlues(blues);</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">            for (int i = 0; i &lt; 256; i++) {</span>
<span class="nc" id="L1107">                palette[i*3] = reds[i];</span>
<span class="nc" id="L1108">                palette[i*3+1] = greens[i];</span>
<span class="nc" id="L1109">                palette[i*3+2] = blues[i];</span>
            }
<span class="nc" id="L1111">            ios.write(palette);</span>
<span class="nc" id="L1112">            writePixels(ios, writer);</span>
<span class="nc" id="L1113">        }</span>
    }


    /**
     * A JFIF thumbnail stored as a JPEG stream.  No JFIF or
     * JFIF extension markers are permitted.  There is no need
     * to clip these, but the entire image must fit into a
     * single JFXX marker segment.
     */
    class JFIFThumbJPEG extends JFIFThumb {
<span class="nc" id="L1124">        JPEGMetadata thumbMetadata = null;</span>
<span class="nc" id="L1125">        byte [] data = null;  // Compressed image data, for writing</span>
        private static final int PREAMBLE_SIZE = 6;

        JFIFThumbJPEG(JPEGBuffer buffer,
                      int length,
<span class="nc" id="L1130">                      JPEGImageReader reader) throws IOException {</span>
<span class="nc" id="L1131">            super(buffer);</span>
            // Compute the final stream position
<span class="nc" id="L1133">            long finalPos = streamPos + (length - PREAMBLE_SIZE);</span>
            // Set the stream back to the start of the thumbnail
            // and read its metadata (but don't decode the image)
<span class="nc" id="L1136">            buffer.iis.seek(streamPos);</span>
<span class="nc" id="L1137">            thumbMetadata = new JPEGMetadata(false, true, buffer.iis, reader);</span>
            // Set the stream to the computed final position
<span class="nc" id="L1139">            buffer.iis.seek(finalPos);</span>
            // Clear the now invalid buffer
<span class="nc" id="L1141">            buffer.bufAvail = 0;</span>
<span class="nc" id="L1142">            buffer.bufPtr = 0;</span>
<span class="nc" id="L1143">        }</span>

<span class="nc" id="L1145">        JFIFThumbJPEG(Node node) throws IIOInvalidTreeException {</span>
<span class="nc bnc" id="L1146" title="All 2 branches missed.">            if (node.getChildNodes().getLength() &gt; 1) {</span>
<span class="nc" id="L1147">                throw new IIOInvalidTreeException</span>
                    (&quot;JFIFThumbJPEG node must have 0 or 1 child&quot;, node);
            }
<span class="nc" id="L1150">            Node child = node.getFirstChild();</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">            if (child != null) {</span>
<span class="nc" id="L1152">                String name = child.getNodeName();</span>
<span class="nc bnc" id="L1153" title="All 2 branches missed.">                if (!name.equals(&quot;markerSequence&quot;)) {</span>
<span class="nc" id="L1154">                    throw new IIOInvalidTreeException</span>
                        (&quot;JFIFThumbJPEG child must be a markerSequence node&quot;,
                         node);
                }
<span class="nc" id="L1158">                thumbMetadata = new JPEGMetadata(false, true);</span>
<span class="nc" id="L1159">                thumbMetadata.setFromMarkerSequenceNode(child);</span>
            }
<span class="nc" id="L1161">        }</span>

<span class="nc" id="L1163">        JFIFThumbJPEG(BufferedImage thumb) throws IllegalThumbException {</span>
<span class="nc" id="L1164">            int INITIAL_BUFSIZE = 4096;</span>
<span class="nc" id="L1165">            int MAZ_BUFSIZE = 65535 - 2 - PREAMBLE_SIZE;</span>
            try {
<span class="nc" id="L1167">                ByteArrayOutputStream baos =</span>
                    new ByteArrayOutputStream(INITIAL_BUFSIZE);
<span class="nc" id="L1169">                MemoryCacheImageOutputStream mos =</span>
                    new MemoryCacheImageOutputStream(baos);

<span class="nc" id="L1172">                JPEGImageWriter thumbWriter = new JPEGImageWriter(null);</span>

<span class="nc" id="L1174">                thumbWriter.setOutput(mos);</span>

                // get default metadata for the thumb
<span class="nc" id="L1177">                JPEGMetadata metadata =</span>
                    (JPEGMetadata) thumbWriter.getDefaultImageMetadata
<span class="nc" id="L1179">                    (new ImageTypeSpecifier(thumb), null);</span>

                // Remove the jfif segment, which should be there.
<span class="nc" id="L1182">                MarkerSegment jfif = metadata.findMarkerSegment</span>
<span class="nc" id="L1183">                    (JFIFMarkerSegment.class, true);</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">                if (jfif == null) {</span>
<span class="nc" id="L1185">                    throw new IllegalThumbException();</span>
                }

<span class="nc" id="L1188">                metadata.markerSequence.remove(jfif);</span>

                /*  Use this if removing leaves a hole and causes trouble

                // Get the tree
                String format = metadata.getNativeMetadataFormatName();
                IIOMetadataNode tree =
                (IIOMetadataNode) metadata.getAsTree(format);

                // If there is no app0jfif node, the image is bad
                NodeList jfifs = tree.getElementsByTagName(&quot;app0JFIF&quot;);
                if (jfifs.getLength() == 0) {
                throw new IllegalThumbException();
                }

                // remove the app0jfif node
                Node jfif = jfifs.item(0);
                Node parent = jfif.getParentNode();
                parent.removeChild(jfif);

                metadata.setFromTree(format, tree);
                */

<span class="nc" id="L1211">                thumbWriter.write(new IIOImage(thumb, null, metadata));</span>

<span class="nc" id="L1213">                thumbWriter.dispose();</span>
                // Now check that the size is OK
<span class="nc bnc" id="L1215" title="All 2 branches missed.">                if (baos.size() &gt; MAZ_BUFSIZE) {</span>
<span class="nc" id="L1216">                    throw new IllegalThumbException();</span>
                }
<span class="nc" id="L1218">                data = baos.toByteArray();</span>
<span class="nc" id="L1219">            } catch (IOException e) {</span>
<span class="nc" id="L1220">                throw new IllegalThumbException();</span>
<span class="nc" id="L1221">            }</span>
<span class="nc" id="L1222">        }</span>

        int getWidth() {
<span class="nc" id="L1225">            int retval = 0;</span>
<span class="nc" id="L1226">            SOFMarkerSegment sof =</span>
                (SOFMarkerSegment) thumbMetadata.findMarkerSegment
<span class="nc" id="L1228">                (SOFMarkerSegment.class, true);</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">            if (sof != null) {</span>
<span class="nc" id="L1230">                retval = sof.samplesPerLine;</span>
            }
<span class="nc" id="L1232">            return retval;</span>
        }

        int getHeight() {
<span class="nc" id="L1236">            int retval = 0;</span>
<span class="nc" id="L1237">            SOFMarkerSegment sof =</span>
                (SOFMarkerSegment) thumbMetadata.findMarkerSegment
<span class="nc" id="L1239">                (SOFMarkerSegment.class, true);</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">            if (sof != null) {</span>
<span class="nc" id="L1241">                retval = sof.numLines;</span>
            }
<span class="nc" id="L1243">            return retval;</span>
        }

        private class ThumbnailReadListener
            implements IIOReadProgressListener {
<span class="nc" id="L1248">            JPEGImageReader reader = null;</span>
<span class="nc" id="L1249">            ThumbnailReadListener (JPEGImageReader reader) {</span>
<span class="nc" id="L1250">                this.reader = reader;</span>
<span class="nc" id="L1251">            }</span>
<span class="nc" id="L1252">            public void sequenceStarted(ImageReader source, int minIndex) {}</span>
<span class="nc" id="L1253">            public void sequenceComplete(ImageReader source) {}</span>
<span class="nc" id="L1254">            public void imageStarted(ImageReader source, int imageIndex) {}</span>
            public void imageProgress(ImageReader source,
                                      float percentageDone) {
<span class="nc" id="L1257">                reader.thumbnailProgress(percentageDone);</span>
<span class="nc" id="L1258">            }</span>
<span class="nc" id="L1259">            public void imageComplete(ImageReader source) {}</span>
            public void thumbnailStarted(ImageReader source,
<span class="nc" id="L1261">                int imageIndex, int thumbnailIndex) {}</span>
<span class="nc" id="L1262">            public void thumbnailProgress(ImageReader source, float percentageDone) {}</span>
<span class="nc" id="L1263">            public void thumbnailComplete(ImageReader source) {}</span>
<span class="nc" id="L1264">            public void readAborted(ImageReader source) {}</span>
        }

        BufferedImage getThumbnail(ImageInputStream iis,
                                   JPEGImageReader reader)
            throws IOException {
<span class="nc" id="L1270">            iis.mark();</span>
<span class="nc" id="L1271">            iis.seek(streamPos);</span>
<span class="nc" id="L1272">            JPEGImageReader thumbReader = new JPEGImageReader(null);</span>
<span class="nc" id="L1273">            thumbReader.setInput(iis);</span>
<span class="nc" id="L1274">            thumbReader.addIIOReadProgressListener</span>
<span class="nc" id="L1275">                (new ThumbnailReadListener(reader));</span>
<span class="nc" id="L1276">            BufferedImage ret = thumbReader.read(0, null);</span>
<span class="nc" id="L1277">            thumbReader.dispose();</span>
<span class="nc" id="L1278">            iis.reset();</span>
<span class="nc" id="L1279">            return ret;</span>
        }

        protected Object clone() {
<span class="nc" id="L1283">            JFIFThumbJPEG newGuy = (JFIFThumbJPEG) super.clone();</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">            if (thumbMetadata != null) {</span>
<span class="nc" id="L1285">                newGuy.thumbMetadata = (JPEGMetadata) thumbMetadata.clone();</span>
            }
<span class="nc" id="L1287">            return newGuy;</span>
        }

        IIOMetadataNode getNativeNode() {
<span class="nc" id="L1291">            IIOMetadataNode node = new IIOMetadataNode(&quot;JFIFthumbJPEG&quot;);</span>
<span class="nc bnc" id="L1292" title="All 2 branches missed.">            if (thumbMetadata != null) {</span>
<span class="nc" id="L1293">                node.appendChild(thumbMetadata.getNativeTree());</span>
            }
<span class="nc" id="L1295">            return node;</span>
        }

        int getLength() {
<span class="nc bnc" id="L1299" title="All 2 branches missed.">            if (data == null) {</span>
<span class="nc" id="L1300">                return 0;</span>
            } else {
<span class="nc" id="L1302">                return data.length;</span>
            }
        }

        void write(ImageOutputStream ios,
                   JPEGImageWriter writer) throws IOException {
<span class="nc" id="L1308">            int progInterval = data.length / 20;  // approx. every 5%</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">            if (progInterval == 0) {</span>
<span class="nc" id="L1310">                progInterval = 1;</span>
            }
<span class="nc" id="L1312">            for (int offset = 0;</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">                 offset &lt; data.length;) {</span>
<span class="nc" id="L1314">                int len = Math.min(progInterval, data.length-offset);</span>
<span class="nc" id="L1315">                ios.write(data, offset, len);</span>
<span class="nc" id="L1316">                offset += progInterval;</span>
<span class="nc" id="L1317">                float percentDone = ((float) offset * 100) / data.length;</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">                if (percentDone &gt; 100.0F) {</span>
<span class="nc" id="L1319">                    percentDone = 100.0F;</span>
                }
<span class="nc" id="L1321">                writer.thumbnailProgress (percentDone);</span>
<span class="nc" id="L1322">            }</span>
<span class="nc" id="L1323">        }</span>

        void print () {
<span class="nc" id="L1326">            System.out.println(&quot;JFIF thumbnail stored as JPEG&quot;);</span>
<span class="nc" id="L1327">        }</span>
    }

    /**
     * Write out the given profile to the stream, embedded in
     * the necessary number of APP2 segments, per the ICC spec.
     * This is the only mechanism for writing an ICC profile
     * to a stream.
     */
    static void writeICC(ICC_Profile profile, ImageOutputStream ios)
        throws IOException {
<span class="nc" id="L1338">        int LENGTH_LENGTH = 2;</span>
        final String ID = &quot;ICC_PROFILE&quot;;
<span class="nc" id="L1340">        int ID_LENGTH = ID.length()+1; // spec says it's null-terminated</span>
<span class="nc" id="L1341">        int COUNTS_LENGTH = 2;</span>
<span class="nc" id="L1342">        int MAX_ICC_CHUNK_SIZE =</span>
            65535 - LENGTH_LENGTH - ID_LENGTH - COUNTS_LENGTH;

<span class="nc" id="L1345">        byte [] data = profile.getData();</span>
<span class="nc" id="L1346">        int numChunks = data.length / MAX_ICC_CHUNK_SIZE;</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">        if ((data.length % MAX_ICC_CHUNK_SIZE) != 0) {</span>
<span class="nc" id="L1348">            numChunks++;</span>
        }
<span class="nc" id="L1350">        int chunkNum = 1;</span>
<span class="nc" id="L1351">        int offset = 0;</span>
<span class="nc bnc" id="L1352" title="All 2 branches missed.">        for (int i = 0; i &lt; numChunks; i++) {</span>
<span class="nc" id="L1353">            int dataLength = Math.min(data.length-offset, MAX_ICC_CHUNK_SIZE);</span>
<span class="nc" id="L1354">            int segLength = dataLength+COUNTS_LENGTH+ID_LENGTH+LENGTH_LENGTH;</span>
<span class="nc" id="L1355">            ios.write(0xff);</span>
<span class="nc" id="L1356">            ios.write(JPEG.APP2);</span>
<span class="nc" id="L1357">            MarkerSegment.write2bytes(ios, segLength);</span>
<span class="nc" id="L1358">            byte [] id = ID.getBytes(&quot;US-ASCII&quot;);</span>
<span class="nc" id="L1359">            ios.write(id);</span>
<span class="nc" id="L1360">            ios.write(0); // Null-terminate the string</span>
<span class="nc" id="L1361">            ios.write(chunkNum++);</span>
<span class="nc" id="L1362">            ios.write(numChunks);</span>
<span class="nc" id="L1363">            ios.write(data, offset, dataLength);</span>
<span class="nc" id="L1364">            offset += dataLength;</span>
        }
<span class="nc" id="L1366">    }</span>

    /**
     * An APP2 marker segment containing an ICC profile.  In the stream
     * a profile larger than 64K is broken up into a series of chunks.
     * This inner class represents the complete profile as a single object,
     * combining chunks as necessary.
     */
    class ICCMarkerSegment extends MarkerSegment {
<span class="nc" id="L1375">        ArrayList chunks = null;</span>
<span class="nc" id="L1376">        byte [] profile = null; // The complete profile when it's fully read</span>
                         // May remain null when writing
        private static final int ID_SIZE = 12;
        int chunksRead;
        int numChunks;

<span class="nc" id="L1382">        ICCMarkerSegment(ICC_ColorSpace cs) {</span>
<span class="nc" id="L1383">            super(JPEG.APP2);</span>
<span class="nc" id="L1384">            chunks = null;</span>
<span class="nc" id="L1385">            chunksRead = 0;</span>
<span class="nc" id="L1386">            numChunks = 0;</span>
<span class="nc" id="L1387">            profile = cs.getProfile().getData();</span>
<span class="nc" id="L1388">        }</span>

<span class="nc" id="L1390">        ICCMarkerSegment(JPEGBuffer buffer) throws IOException {</span>
<span class="nc" id="L1391">            super(buffer);  // gets whole segment or fills the buffer</span>
            if (debug) {
                System.out.println(&quot;Creating new ICC segment&quot;);
            }
<span class="nc" id="L1395">            buffer.bufPtr += ID_SIZE; // Skip the id</span>
<span class="nc" id="L1396">            buffer.bufAvail -= ID_SIZE;</span>
            /*
             * Reduce the stored length by the id size.  The stored
             * length is used to store the length of the profile
             * data only.
             */
<span class="nc" id="L1402">            length -= ID_SIZE;</span>

            // get the chunk number
<span class="nc" id="L1405">            int chunkNum = buffer.buf[buffer.bufPtr] &amp; 0xff;</span>
            // get the total number of chunks
<span class="nc" id="L1407">            numChunks = buffer.buf[buffer.bufPtr+1] &amp; 0xff;</span>

<span class="nc bnc" id="L1409" title="All 2 branches missed.">            if (chunkNum &gt; numChunks) {</span>
<span class="nc" id="L1410">                throw new IIOException</span>
                    (&quot;Image format Error; chunk num &gt; num chunks&quot;);
            }

            // if there are no more chunks, set up the data
<span class="nc bnc" id="L1415" title="All 2 branches missed.">            if (numChunks == 1) {</span>
                // reduce the stored length by the two chunk numbering bytes
<span class="nc" id="L1417">                length -= 2;</span>
<span class="nc" id="L1418">                profile = new byte[length];</span>
<span class="nc" id="L1419">                buffer.bufPtr += 2;</span>
<span class="nc" id="L1420">                buffer.bufAvail-=2;</span>
<span class="nc" id="L1421">                buffer.readData(profile);</span>
<span class="nc" id="L1422">                inICC = false;</span>
            } else {
                // If we store them away, include the chunk numbering bytes
<span class="nc" id="L1425">                byte [] profileData = new byte[length];</span>
                // Now reduce the stored length by the
                // two chunk numbering bytes
<span class="nc" id="L1428">                length -= 2;</span>
<span class="nc" id="L1429">                buffer.readData(profileData);</span>
<span class="nc" id="L1430">                chunks = new ArrayList();</span>
<span class="nc" id="L1431">                chunks.add(profileData);</span>
<span class="nc" id="L1432">                chunksRead = 1;</span>
<span class="nc" id="L1433">                inICC = true;</span>
            }
<span class="nc" id="L1435">        }</span>

<span class="nc" id="L1437">        ICCMarkerSegment(Node node) throws IIOInvalidTreeException {</span>
<span class="nc" id="L1438">            super(JPEG.APP2);</span>
<span class="nc bnc" id="L1439" title="All 2 branches missed.">            if (node instanceof IIOMetadataNode) {</span>
<span class="nc" id="L1440">                IIOMetadataNode ourNode = (IIOMetadataNode) node;</span>
<span class="nc" id="L1441">                ICC_Profile prof = (ICC_Profile) ourNode.getUserObject();</span>
<span class="nc bnc" id="L1442" title="All 2 branches missed.">                if (prof != null) {  // May be null</span>
<span class="nc" id="L1443">                    profile = prof.getData();</span>
                }
            }
<span class="nc" id="L1446">        }</span>

        protected Object clone () {
<span class="nc" id="L1449">            ICCMarkerSegment newGuy = (ICCMarkerSegment) super.clone();</span>
<span class="nc bnc" id="L1450" title="All 2 branches missed.">            if (profile != null) {</span>
<span class="nc" id="L1451">                newGuy.profile = (byte[]) profile.clone();</span>
            }
<span class="nc" id="L1453">            return newGuy;</span>
        }

        boolean addData(JPEGBuffer buffer) throws IOException {
            if (debug) {
                System.out.println(&quot;Adding to ICC segment&quot;);
            }
            // skip the tag
<span class="nc" id="L1461">            buffer.bufPtr++;</span>
<span class="nc" id="L1462">            buffer.bufAvail--;</span>
            // Get the length, but not in length
<span class="nc" id="L1464">            int dataLen = (buffer.buf[buffer.bufPtr++] &amp; 0xff) &lt;&lt; 8;</span>
<span class="nc" id="L1465">            dataLen |= buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L1466">            buffer.bufAvail -= 2;</span>
            // Don't include length itself
<span class="nc" id="L1468">            dataLen -= 2;</span>
            // skip the id
<span class="nc" id="L1470">            buffer.bufPtr += ID_SIZE; // Skip the id</span>
<span class="nc" id="L1471">            buffer.bufAvail -= ID_SIZE;</span>
            /*
             * Reduce the stored length by the id size.  The stored
             * length is used to store the length of the profile
             * data only.
             */
<span class="nc" id="L1477">            dataLen -= ID_SIZE;</span>

            // get the chunk number
<span class="nc" id="L1480">            int chunkNum = buffer.buf[buffer.bufPtr] &amp; 0xff;</span>
<span class="nc bnc" id="L1481" title="All 2 branches missed.">            if (chunkNum &gt; numChunks) {</span>
<span class="nc" id="L1482">                throw new IIOException</span>
                    (&quot;Image format Error; chunk num &gt; num chunks&quot;);
            }

            // get the number of chunks, which should match
<span class="nc" id="L1487">            int newNumChunks = buffer.buf[buffer.bufPtr+1] &amp; 0xff;</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">            if (numChunks != newNumChunks) {</span>
<span class="nc" id="L1489">                throw new IIOException</span>
                    (&quot;Image format Error; icc num chunks mismatch&quot;);
            }
<span class="nc" id="L1492">            dataLen -= 2;</span>
            if (debug) {
                System.out.println(&quot;chunkNum: &quot; + chunkNum
                                   + &quot;, numChunks: &quot; + numChunks
                                   + &quot;, dataLen: &quot; + dataLen);
            }
<span class="nc" id="L1498">            boolean retval = false;</span>
<span class="nc" id="L1499">            byte [] profileData = new byte[dataLen];</span>
<span class="nc" id="L1500">            buffer.readData(profileData);</span>
<span class="nc" id="L1501">            chunks.add(profileData);</span>
<span class="nc" id="L1502">            length += dataLen;</span>
<span class="nc" id="L1503">            chunksRead++;</span>
<span class="nc bnc" id="L1504" title="All 2 branches missed.">            if (chunksRead &lt; numChunks) {</span>
<span class="nc" id="L1505">                inICC = true;</span>
            } else {
                if (debug) {
                    System.out.println(&quot;Completing profile; total length is &quot;
                                       + length);
                }
                // create an array for the whole thing
<span class="nc" id="L1512">                profile = new byte[length];</span>
                // copy the existing chunks, releasing them
                // Note that they may be out of order

<span class="nc" id="L1516">                int index = 0;</span>
<span class="nc bnc" id="L1517" title="All 2 branches missed.">                for (int i = 1; i &lt;= numChunks; i++) {</span>
<span class="nc" id="L1518">                    boolean foundIt = false;</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">                    for (int chunk = 0; chunk &lt; chunks.size(); chunk++) {</span>
<span class="nc" id="L1520">                        byte [] chunkData = (byte []) chunks.get(chunk);</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">                        if (chunkData[0] == i) { // Right one</span>
<span class="nc" id="L1522">                            System.arraycopy(chunkData, 2,</span>
                                             profile, index,
                                             chunkData.length-2);
<span class="nc" id="L1525">                            index += chunkData.length-2;</span>
<span class="nc" id="L1526">                            foundIt = true;</span>
                        }
                    }
<span class="nc bnc" id="L1529" title="All 2 branches missed.">                    if (foundIt == false) {</span>
<span class="nc" id="L1530">                        throw new IIOException</span>
                            (&quot;Image Format Error: Missing ICC chunk num &quot; + i);
                    }
                }

<span class="nc" id="L1535">                chunks = null;</span>
<span class="nc" id="L1536">                chunksRead = 0;</span>
<span class="nc" id="L1537">                numChunks = 0;</span>
<span class="nc" id="L1538">                inICC = false;</span>
<span class="nc" id="L1539">                retval = true;</span>
            }
<span class="nc" id="L1541">            return retval;</span>
        }

        IIOMetadataNode getNativeNode() {
<span class="nc" id="L1545">            IIOMetadataNode node = new IIOMetadataNode(&quot;app2ICC&quot;);</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">            if (profile != null) {</span>
<span class="nc" id="L1547">                node.setUserObject(ICC_Profile.getInstance(profile));</span>
            }
<span class="nc" id="L1549">            return node;</span>
        }

        /**
         * No-op.  Profiles are never written from metadata.
         * They are written from the ColorSpace of the image.
         */
        void write(ImageOutputStream ios) throws IOException {
            // No-op
<span class="nc" id="L1558">        }</span>

        void print () {
<span class="nc" id="L1561">            printTag(&quot;ICC Profile APP2&quot;);</span>
<span class="nc" id="L1562">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>