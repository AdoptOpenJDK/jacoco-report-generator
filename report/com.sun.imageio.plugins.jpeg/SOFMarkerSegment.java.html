<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>SOFMarkerSegment.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.imageio.plugins.jpeg</a> &gt; <span class="el_source">SOFMarkerSegment.java</span></div><h1>SOFMarkerSegment.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2001, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.imageio.plugins.jpeg;

//import javax.imageio.IIOException;
import javax.imageio.metadata.IIOInvalidTreeException;
import javax.imageio.metadata.IIOMetadataNode;
import javax.imageio.stream.ImageOutputStream;

import java.io.IOException;

import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.w3c.dom.NamedNodeMap;

/**
 * An SOF (Start Of Frame)  marker segment.
 */
class SOFMarkerSegment extends MarkerSegment {
    int samplePrecision;
    int numLines;
    int samplesPerLine;
    ComponentSpec [] componentSpecs;  // Array size is num components

    SOFMarkerSegment(boolean wantProg,
                     boolean wantExtended,
                     boolean willSubsample,
                     byte[] componentIDs,
                     int numComponents) {
<span class="nc bnc" id="L53" title="All 4 branches missed.">        super(wantProg ? JPEG.SOF2</span>
              : wantExtended ? JPEG.SOF1
              : JPEG.SOF0);
<span class="nc" id="L56">        samplePrecision = 8;</span>
<span class="nc" id="L57">        numLines = 0;</span>
<span class="nc" id="L58">        samplesPerLine = 0;</span>
<span class="nc" id="L59">        componentSpecs = new ComponentSpec[numComponents];</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        for(int i = 0; i &lt; numComponents; i++) {</span>
<span class="nc" id="L61">            int factor = 1;</span>
<span class="nc" id="L62">            int qsel = 0;</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (willSubsample) {</span>
<span class="nc" id="L64">                factor = 2;</span>
<span class="nc bnc" id="L65" title="All 4 branches missed.">                if ((i == 1) || (i == 2)) {</span>
<span class="nc" id="L66">                    factor = 1;</span>
<span class="nc" id="L67">                    qsel = 1;</span>
                }
            }
<span class="nc" id="L70">            componentSpecs[i] = new ComponentSpec(componentIDs[i], factor, qsel);</span>
        }
<span class="nc" id="L72">    }</span>

    SOFMarkerSegment(JPEGBuffer buffer) throws IOException{
<span class="nc" id="L75">        super(buffer);</span>
<span class="nc" id="L76">        samplePrecision = buffer.buf[buffer.bufPtr++];</span>
<span class="nc" id="L77">        numLines = (buffer.buf[buffer.bufPtr++] &amp; 0xff) &lt;&lt; 8;</span>
<span class="nc" id="L78">        numLines |= buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L79">        samplesPerLine = (buffer.buf[buffer.bufPtr++] &amp; 0xff) &lt;&lt; 8;</span>
<span class="nc" id="L80">        samplesPerLine |= buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L81">        int numComponents = buffer.buf[buffer.bufPtr++] &amp; 0xff;</span>
<span class="nc" id="L82">        componentSpecs = new ComponentSpec [numComponents];</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (int i = 0; i &lt; numComponents; i++) {</span>
<span class="nc" id="L84">            componentSpecs[i] = new ComponentSpec(buffer);</span>
        }
<span class="nc" id="L86">        buffer.bufAvail -= length;</span>
<span class="nc" id="L87">    }</span>

    SOFMarkerSegment(Node node) throws IIOInvalidTreeException {
        // All attributes are optional, so setup defaults first
<span class="nc" id="L91">        super(JPEG.SOF0);</span>
<span class="nc" id="L92">        samplePrecision = 8;</span>
<span class="nc" id="L93">        numLines = 0;</span>
<span class="nc" id="L94">        samplesPerLine = 0;</span>
<span class="nc" id="L95">        updateFromNativeNode(node, true);</span>
<span class="nc" id="L96">    }</span>

    protected Object clone() {
<span class="nc" id="L99">        SOFMarkerSegment newGuy = (SOFMarkerSegment) super.clone();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (componentSpecs != null) {</span>
<span class="nc" id="L101">            newGuy.componentSpecs = (ComponentSpec []) componentSpecs.clone();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            for (int i = 0; i &lt; componentSpecs.length; i++) {</span>
<span class="nc" id="L103">                newGuy.componentSpecs[i] =</span>
<span class="nc" id="L104">                    (ComponentSpec) componentSpecs[i].clone();</span>
            }
        }
<span class="nc" id="L107">        return newGuy;</span>
    }

    IIOMetadataNode getNativeNode() {
<span class="nc" id="L111">        IIOMetadataNode node = new IIOMetadataNode(&quot;sof&quot;);</span>
<span class="nc" id="L112">        node.setAttribute(&quot;process&quot;, Integer.toString(tag-JPEG.SOF0));</span>
<span class="nc" id="L113">        node.setAttribute(&quot;samplePrecision&quot;,</span>
<span class="nc" id="L114">                          Integer.toString(samplePrecision));</span>
<span class="nc" id="L115">        node.setAttribute(&quot;numLines&quot;,</span>
<span class="nc" id="L116">                          Integer.toString(numLines));</span>
<span class="nc" id="L117">        node.setAttribute(&quot;samplesPerLine&quot;,</span>
<span class="nc" id="L118">                          Integer.toString(samplesPerLine));</span>
<span class="nc" id="L119">        node.setAttribute(&quot;numFrameComponents&quot;,</span>
<span class="nc" id="L120">                          Integer.toString(componentSpecs.length));</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        for (int i = 0; i &lt; componentSpecs.length; i++) {</span>
<span class="nc" id="L122">            node.appendChild(componentSpecs[i].getNativeNode());</span>
        }

<span class="nc" id="L125">        return node;</span>
    }

    void updateFromNativeNode(Node node, boolean fromScratch)
        throws IIOInvalidTreeException {
<span class="nc" id="L130">        NamedNodeMap attrs = node.getAttributes();</span>
<span class="nc" id="L131">        int value = getAttributeValue(node, attrs, &quot;process&quot;, 0, 2, false);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        tag = (value != -1) ? value+JPEG.SOF0 : tag;</span>
        // If samplePrecision is present, it must be 8.
        // This just checks.  We don't bother to assign the value.
<span class="nc" id="L135">        value = getAttributeValue(node, attrs, &quot;samplePrecision&quot;, 8, 8, false);</span>
<span class="nc" id="L136">        value = getAttributeValue(node, attrs, &quot;numLines&quot;, 0, 65535, false);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        numLines = (value != -1) ? value : numLines;</span>
<span class="nc" id="L138">        value = getAttributeValue(node, attrs, &quot;samplesPerLine&quot;, 0, 65535, false);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        samplesPerLine = (value != -1) ? value : samplesPerLine;</span>
<span class="nc" id="L140">        int numComponents = getAttributeValue(node, attrs, &quot;numFrameComponents&quot;,</span>
                                              1, 4, false);
<span class="nc" id="L142">        NodeList children = node.getChildNodes();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (children.getLength() != numComponents) {</span>
<span class="nc" id="L144">            throw new IIOInvalidTreeException</span>
                (&quot;numFrameComponents must match number of children&quot;, node);
        }
<span class="nc" id="L147">        componentSpecs = new ComponentSpec [numComponents];</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        for (int i = 0; i &lt; numComponents; i++) {</span>
<span class="nc" id="L149">            componentSpecs[i] = new ComponentSpec(children.item(i));</span>
        }
<span class="nc" id="L151">    }</span>

    /**
     * Writes the data for this segment to the stream in
     * valid JPEG format.
     */
    void write(ImageOutputStream ios) throws IOException {
        // We don't write SOF segments; the IJG library does.
<span class="nc" id="L159">    }</span>

    void print () {
<span class="nc" id="L162">        printTag(&quot;SOF&quot;);</span>
<span class="nc" id="L163">        System.out.print(&quot;Sample precision: &quot;);</span>
<span class="nc" id="L164">        System.out.println(samplePrecision);</span>
<span class="nc" id="L165">        System.out.print(&quot;Number of lines: &quot;);</span>
<span class="nc" id="L166">        System.out.println(numLines);</span>
<span class="nc" id="L167">        System.out.print(&quot;Samples per line: &quot;);</span>
<span class="nc" id="L168">        System.out.println(samplesPerLine);</span>
<span class="nc" id="L169">        System.out.print(&quot;Number of components: &quot;);</span>
<span class="nc" id="L170">        System.out.println(componentSpecs.length);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        for(int i = 0; i&lt;componentSpecs.length; i++) {</span>
<span class="nc" id="L172">            componentSpecs[i].print();</span>
        }
<span class="nc" id="L174">    }</span>

    int getIDencodedCSType () {
<span class="nc bnc" id="L177" title="All 2 branches missed.">        for (int i = 0; i &lt; componentSpecs.length; i++) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (componentSpecs[i].componentId &lt; 'A') {</span>
<span class="nc" id="L179">                return JPEG.JCS_UNKNOWN;</span>
            }
        }
<span class="nc bnc" id="L182" title="All 3 branches missed.">        switch(componentSpecs.length) {</span>
        case 3:
<span class="nc bnc" id="L184" title="All 6 branches missed.">            if ((componentSpecs[0].componentId == 'R')</span>
                &amp;&amp;(componentSpecs[0].componentId == 'G')
                &amp;&amp;(componentSpecs[0].componentId == 'B')) {
<span class="nc" id="L187">                return JPEG.JCS_RGB;</span>
            }
<span class="nc bnc" id="L189" title="All 6 branches missed.">            if ((componentSpecs[0].componentId == 'Y')</span>
                &amp;&amp;(componentSpecs[0].componentId == 'C')
                &amp;&amp;(componentSpecs[0].componentId == 'c')) {
<span class="nc" id="L192">                return JPEG.JCS_YCC;</span>
            }
            break;
        case 4:
<span class="nc bnc" id="L196" title="All 8 branches missed.">            if ((componentSpecs[0].componentId == 'R')</span>
                &amp;&amp;(componentSpecs[0].componentId == 'G')
                &amp;&amp;(componentSpecs[0].componentId == 'B')
                &amp;&amp;(componentSpecs[0].componentId == 'A')) {
<span class="nc" id="L200">                return JPEG.JCS_RGBA;</span>
            }
<span class="nc bnc" id="L202" title="All 8 branches missed.">            if ((componentSpecs[0].componentId == 'Y')</span>
                &amp;&amp;(componentSpecs[0].componentId == 'C')
                &amp;&amp;(componentSpecs[0].componentId == 'c')
                &amp;&amp;(componentSpecs[0].componentId == 'A')) {
<span class="nc" id="L206">                return JPEG.JCS_YCCA;</span>
            }
        }

<span class="nc" id="L210">        return JPEG.JCS_UNKNOWN;</span>
    }

    ComponentSpec getComponentSpec(byte id, int factor, int qSelector) {
<span class="nc" id="L214">        return new ComponentSpec(id, factor, qSelector);</span>
    }

    /**
     * A component spec within an SOF marker segment.
     */
    class ComponentSpec implements Cloneable {
        int componentId;
        int HsamplingFactor;
        int VsamplingFactor;
        int QtableSelector;

<span class="nc" id="L226">        ComponentSpec(byte id, int factor, int qSelector) {</span>
<span class="nc" id="L227">            componentId = id;</span>
<span class="nc" id="L228">            HsamplingFactor = factor;</span>
<span class="nc" id="L229">            VsamplingFactor = factor;</span>
<span class="nc" id="L230">            QtableSelector = qSelector;</span>
<span class="nc" id="L231">        }</span>

<span class="nc" id="L233">        ComponentSpec(JPEGBuffer buffer) {</span>
            // Parent already did a loadBuf
<span class="nc" id="L235">            componentId = buffer.buf[buffer.bufPtr++];</span>
<span class="nc" id="L236">            HsamplingFactor = buffer.buf[buffer.bufPtr] &gt;&gt;&gt; 4;</span>
<span class="nc" id="L237">            VsamplingFactor = buffer.buf[buffer.bufPtr++] &amp; 0xf;</span>
<span class="nc" id="L238">            QtableSelector = buffer.buf[buffer.bufPtr++];</span>
<span class="nc" id="L239">        }</span>

<span class="nc" id="L241">        ComponentSpec(Node node) throws IIOInvalidTreeException {</span>
<span class="nc" id="L242">            NamedNodeMap attrs = node.getAttributes();</span>
<span class="nc" id="L243">            componentId = getAttributeValue(node, attrs, &quot;componentId&quot;, 0, 255, true);</span>
<span class="nc" id="L244">            HsamplingFactor = getAttributeValue(node, attrs, &quot;HsamplingFactor&quot;,</span>
                                                1, 255, true);
<span class="nc" id="L246">            VsamplingFactor = getAttributeValue(node, attrs, &quot;VsamplingFactor&quot;,</span>
                                                1, 255, true);
<span class="nc" id="L248">            QtableSelector = getAttributeValue(node, attrs, &quot;QtableSelector&quot;,</span>
                                               0, 3, true);
<span class="nc" id="L250">        }</span>

        protected Object clone() {
            try {
<span class="nc" id="L254">                return super.clone();</span>
<span class="nc" id="L255">            } catch (CloneNotSupportedException e) {} // won't happen</span>
<span class="nc" id="L256">            return null;</span>
        }

        IIOMetadataNode getNativeNode() {
<span class="nc" id="L260">            IIOMetadataNode node = new IIOMetadataNode(&quot;componentSpec&quot;);</span>
<span class="nc" id="L261">            node.setAttribute(&quot;componentId&quot;,</span>
<span class="nc" id="L262">                              Integer.toString(componentId));</span>
<span class="nc" id="L263">            node.setAttribute(&quot;HsamplingFactor&quot;,</span>
<span class="nc" id="L264">                              Integer.toString(HsamplingFactor));</span>
<span class="nc" id="L265">            node.setAttribute(&quot;VsamplingFactor&quot;,</span>
<span class="nc" id="L266">                              Integer.toString(VsamplingFactor));</span>
<span class="nc" id="L267">            node.setAttribute(&quot;QtableSelector&quot;,</span>
<span class="nc" id="L268">                              Integer.toString(QtableSelector));</span>
<span class="nc" id="L269">            return node;</span>
        }

        void print () {
<span class="nc" id="L273">            System.out.print(&quot;Component ID: &quot;);</span>
<span class="nc" id="L274">            System.out.println(componentId);</span>
<span class="nc" id="L275">            System.out.print(&quot;H sampling factor: &quot;);</span>
<span class="nc" id="L276">            System.out.println(HsamplingFactor);</span>
<span class="nc" id="L277">            System.out.print(&quot;V sampling factor: &quot;);</span>
<span class="nc" id="L278">            System.out.println(VsamplingFactor);</span>
<span class="nc" id="L279">            System.out.print(&quot;Q table selector: &quot;);</span>
<span class="nc" id="L280">            System.out.println(QtableSelector);</span>
<span class="nc" id="L281">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>