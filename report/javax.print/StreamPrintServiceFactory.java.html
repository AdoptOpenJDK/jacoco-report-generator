<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StreamPrintServiceFactory.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.print</a> &gt; <span class="el_source">StreamPrintServiceFactory.java</span></div><h1>StreamPrintServiceFactory.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2007, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.print;

import java.io.OutputStream;

import java.util.ArrayList;
import java.util.Iterator;

import javax.print.DocFlavor;

import sun.awt.AppContext;
import java.util.ServiceLoader;
import java.util.ServiceConfigurationError;

/**
 * A &lt;code&gt;StreamPrintServiceFactory&lt;/code&gt; is the factory for
 * {@link StreamPrintService} instances,
 * which can print to an output stream in a particular
 * document format described as a mime type.
 * A typical output document format may be Postscript(TM).
 * &lt;p&gt;
 * This class is implemented by a service and located by the
 * implementation using the
 * &lt;a href=&quot;../../../technotes/guides/jar/jar.html#Service Provider&quot;&gt;
 * SPI JAR File specification&lt;/a&gt;.
 * &lt;p&gt;
 * Applications locate instances of this class by calling the
 * {@link #lookupStreamPrintServiceFactories(DocFlavor, String)} method.
 * &lt;p&gt;
 * Applications can use a &lt;code&gt;StreamPrintService&lt;/code&gt; obtained from a
 * factory in place of a &lt;code&gt;PrintService&lt;/code&gt; which represents a
 * physical printer device.
 */

<span class="nc" id="L59">public abstract class StreamPrintServiceFactory {</span>

<span class="nc" id="L61">    static class Services {</span>
<span class="nc" id="L62">        private ArrayList listOfFactories = null;</span>
    }

    private static Services getServices() {
        Services services =
<span class="nc" id="L67">            (Services)AppContext.getAppContext().get(Services.class);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (services == null) {</span>
<span class="nc" id="L69">            services = new Services();</span>
<span class="nc" id="L70">            AppContext.getAppContext().put(Services.class, services);</span>
        }
<span class="nc" id="L72">        return services;</span>
    }

    private static ArrayList getListOfFactories() {
<span class="nc" id="L76">        return getServices().listOfFactories;</span>
    }

    private static ArrayList initListOfFactories() {
<span class="nc" id="L80">        ArrayList listOfFactories = new ArrayList();</span>
<span class="nc" id="L81">        getServices().listOfFactories = listOfFactories;</span>
<span class="nc" id="L82">        return listOfFactories;</span>
    }

    /**
     * Locates factories for print services that can be used with
     * a print job to output a stream of data in the
     * format specified by {@code outputMimeType}.
     * &lt;p&gt;
     * The {@code outputMimeType} parameter describes the document type that
     * you want to create, whereas the {@code flavor} parameter describes the
     * format in which the input data will be provided by the application
     * to the {@code StreamPrintService}.
     * &lt;p&gt;
     * Although null is an acceptable value to use in the lookup of stream
     * printing services, it's typical to search for a particular
     * desired format, such as Postscript(TM).
     * &lt;p&gt;
     * @param flavor of the input document type - null means match all
     * types.
     * @param outputMimeType representing the required output format, used to
     * identify suitable stream printer factories. A value of null means
     * match all formats.
     * @return - matching factories for stream print service instance,
     *           empty if no suitable factories could be located.
     */
     public static StreamPrintServiceFactory[]
         lookupStreamPrintServiceFactories(DocFlavor flavor,
                                           String outputMimeType) {

<span class="nc" id="L111">         ArrayList list = getFactories(flavor, outputMimeType);</span>
<span class="nc" id="L112">         return (StreamPrintServiceFactory[])</span>
<span class="nc" id="L113">               (list.toArray(new StreamPrintServiceFactory[list.size()]));</span>
     }

    /** Queries the factory for the document format that is emitted
     * by printers obtained from this factory.
     *
     * @return the output format described as a mime type.
     */
    public abstract String getOutputFormat();

    /**
     * Queries the factory for the document flavors that can be accepted
     * by printers obtained from this factory.
     * @return array of supported doc flavors.
     */
    public abstract DocFlavor[] getSupportedDocFlavors();

    /**
     * Returns a &lt;code&gt;StreamPrintService&lt;/code&gt; that can print to
     * the specified output stream.
     * The output stream is created and managed by the application.
     * It is the application's responsibility to close the stream and
     * to ensure that this Printer is not reused.
     * The application should not close this stream until any print job
     * created from the printer is complete. Doing so earlier may generate
     * a &lt;code&gt;PrinterException&lt;/code&gt; and an event indicating that the
     * job failed.
     * &lt;p&gt;
     * Whereas a &lt;code&gt;PrintService&lt;/code&gt; connected to a physical printer
     * can be reused,
     * a &lt;code&gt;StreamPrintService&lt;/code&gt; connected to a stream cannot.
     * The underlying &lt;code&gt;StreamPrintService&lt;/code&gt; may be disposed by
     * the print system with
     * the {@link StreamPrintService#dispose() dispose} method
     * before returning from the
     * {@link DocPrintJob#print(Doc, javax.print.attribute.PrintRequestAttributeSet) print}
     * method of &lt;code&gt;DocPrintJob&lt;/code&gt; so that the print system knows
     * this printer is no longer usable.
     * This is equivalent to a physical printer going offline - permanently.
     * Applications may supply a null print stream to create a queryable
     * service. It is not valid to create a PrintJob for such a stream.
     * Implementations which allocate resources on construction should examine
     * the stream and may wish to only allocate resources if the stream is
     * non-null.
     * &lt;p&gt;
     * @param out destination stream for generated output.
     * @return a PrintService which will generate the format specified by the
     * DocFlavor supported by this Factory.
     */
    public abstract StreamPrintService getPrintService(OutputStream out);


    private static ArrayList getAllFactories() {
<span class="nc" id="L166">        synchronized (StreamPrintServiceFactory.class) {</span>

<span class="nc" id="L168">          ArrayList listOfFactories = getListOfFactories();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (listOfFactories != null) {</span>
<span class="nc" id="L170">                return listOfFactories;</span>
            } else {
<span class="nc" id="L172">                listOfFactories = initListOfFactories();</span>
            }

            try {
<span class="nc" id="L176">                java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L177">                     new java.security.PrivilegedExceptionAction() {</span>
                        public Object run() {
<span class="nc" id="L179">                            Iterator&lt;StreamPrintServiceFactory&gt; iterator =</span>
                                ServiceLoader.load
<span class="nc" id="L181">                                (StreamPrintServiceFactory.class).iterator();</span>
<span class="nc" id="L182">                            ArrayList lof = getListOfFactories();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                            while (iterator.hasNext()) {</span>
                                try {
<span class="nc" id="L185">                                    lof.add(iterator.next());</span>
<span class="nc" id="L186">                                }  catch (ServiceConfigurationError err) {</span>
                                     /* In the applet case, we continue */
<span class="nc bnc" id="L188" title="All 2 branches missed.">                                    if (System.getSecurityManager() != null) {</span>
<span class="nc" id="L189">                                        err.printStackTrace();</span>
                                    } else {
<span class="nc" id="L191">                                        throw err;</span>
                                    }
<span class="nc" id="L193">                                }</span>
                            }
<span class="nc" id="L195">                            return null;</span>
                        }
                });
<span class="nc" id="L198">            } catch (java.security.PrivilegedActionException e) {</span>
<span class="nc" id="L199">            }</span>
<span class="nc" id="L200">            return listOfFactories;</span>
<span class="nc" id="L201">        }</span>
    }

    private static boolean isMember(DocFlavor flavor, DocFlavor[] flavors) {
<span class="nc bnc" id="L205" title="All 2 branches missed.">        for (int f=0; f&lt;flavors.length; f++ ) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (flavor.equals(flavors[f])) {</span>
<span class="nc" id="L207">                return true;</span>
            }
        }
<span class="nc" id="L210">        return false;</span>
    }

    private static ArrayList getFactories(DocFlavor flavor, String outType) {

<span class="nc bnc" id="L215" title="All 4 branches missed.">        if (flavor == null &amp;&amp; outType == null) {</span>
<span class="nc" id="L216">            return getAllFactories();</span>
        }

<span class="nc" id="L219">        ArrayList list = new ArrayList();</span>
<span class="nc" id="L220">        Iterator iterator = getAllFactories().iterator();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L222">            StreamPrintServiceFactory factory =</span>
<span class="nc" id="L223">                (StreamPrintServiceFactory)iterator.next();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if ((outType == null ||</span>
<span class="nc bnc" id="L225" title="All 4 branches missed.">                 outType.equalsIgnoreCase(factory.getOutputFormat())) &amp;&amp;</span>
                (flavor == null ||
<span class="nc bnc" id="L227" title="All 2 branches missed.">                 isMember(flavor, factory.getSupportedDocFlavors()))) {</span>
<span class="nc" id="L228">                list.add(factory);</span>
            }
<span class="nc" id="L230">        }</span>

<span class="nc" id="L232">        return list;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>