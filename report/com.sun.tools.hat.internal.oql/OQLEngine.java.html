<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OQLEngine.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.tools.hat.internal.oql</a> &gt; <span class="el_source">OQLEngine.java</span></div><h1>OQLEngine.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */


/*
 * The Original Code is HAT. The Initial Developer of the
 * Original Code is Bill Foote, with contributions from others
 * at JavaSoft/Sun.
 */

package com.sun.tools.hat.internal.oql;

import com.sun.tools.hat.internal.model.*;
import java.io.*;
import java.lang.reflect.*;
import java.util.*;

/**
 * This is Object Query Language Interpreter
 *
 */
public class OQLEngine {
    static {
        try {
            // Do we have javax.script support?
            // create ScriptEngineManager
<span class="nc" id="L49">            Class&lt;?&gt; managerClass = Class.forName(&quot;javax.script.ScriptEngineManager&quot;);</span>
<span class="nc" id="L50">            Object manager = managerClass.newInstance();</span>

            // create JavaScript engine
<span class="nc" id="L53">            Method getEngineMethod = managerClass.getMethod(&quot;getEngineByName&quot;,</span>
                                new Class[] { String.class });
<span class="nc" id="L55">            Object jse = getEngineMethod.invoke(manager, new Object[] {&quot;js&quot;});</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">            oqlSupported = (jse != null);</span>
<span class="nc" id="L57">        } catch (Exception exp) {</span>
<span class="nc" id="L58">            oqlSupported = false;</span>
<span class="nc" id="L59">        }</span>
    }

    // check OQL is supported or not before creating OQLEngine
    public static boolean isOQLSupported() {
<span class="nc" id="L64">        return oqlSupported;</span>
    }

<span class="nc" id="L67">    public OQLEngine(Snapshot snapshot) {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (!isOQLSupported()) {</span>
<span class="nc" id="L69">            throw new UnsupportedOperationException(&quot;OQL not supported&quot;);</span>
        }
<span class="nc" id="L71">        init(snapshot);</span>
<span class="nc" id="L72">    }</span>

    /**
       Query is of the form

          select &amp;lt;java script code to select&amp;gt;
          [ from [instanceof] &amp;lt;class name&amp;gt; [&amp;lt;identifier&amp;gt;]
            [ where &amp;lt;java script boolean expression&amp;gt; ]
          ]
    */
    public synchronized void executeQuery(String query, ObjectVisitor visitor)
                                          throws OQLException {
<span class="nc" id="L84">        debugPrint(&quot;query : &quot; + query);</span>
<span class="nc" id="L85">        StringTokenizer st = new StringTokenizer(query);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (st.hasMoreTokens()) {</span>
<span class="nc" id="L87">            String first = st.nextToken();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">            if (! first.equals(&quot;select&quot;) ) {</span>
                // Query does not start with 'select' keyword.
                // Just treat it as plain JavaScript and eval it.
                try {
<span class="nc" id="L92">                    Object res = evalScript(query);</span>
<span class="nc" id="L93">                    visitor.visit(res);</span>
<span class="nc" id="L94">                } catch (Exception e) {</span>
<span class="nc" id="L95">                    throw new OQLException(e);</span>
<span class="nc" id="L96">                }</span>
<span class="nc" id="L97">                return;</span>
            }
<span class="nc" id="L99">        } else {</span>
<span class="nc" id="L100">            throw new OQLException(&quot;query syntax error: no 'select' clause&quot;);</span>
        }

<span class="nc" id="L103">        String selectExpr = &quot;&quot;;</span>
<span class="nc" id="L104">        boolean seenFrom = false;</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        while (st.hasMoreTokens()) {</span>
<span class="nc" id="L106">            String tok = st.nextToken();</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (tok.equals(&quot;from&quot;)) {</span>
<span class="nc" id="L108">                seenFrom = true;</span>
<span class="nc" id="L109">                break;</span>
            }
<span class="nc" id="L111">            selectExpr += &quot; &quot; + tok;</span>
<span class="nc" id="L112">        }</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (selectExpr.equals(&quot;&quot;)) {</span>
<span class="nc" id="L115">            throw new OQLException(&quot;query syntax error: 'select' expression can not be empty&quot;);</span>
        }

<span class="nc" id="L118">        String className = null;</span>
<span class="nc" id="L119">        boolean isInstanceOf = false;</span>
<span class="nc" id="L120">        String whereExpr =  null;</span>
<span class="nc" id="L121">        String identifier = null;</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (seenFrom) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (st.hasMoreTokens()) {</span>
<span class="nc" id="L125">                String tmp = st.nextToken();</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                if (tmp.equals(&quot;instanceof&quot;)) {</span>
<span class="nc" id="L127">                    isInstanceOf = true;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                    if (! st.hasMoreTokens()) {</span>
<span class="nc" id="L129">                        throw new OQLException(&quot;no class name after 'instanceof'&quot;);</span>
                    }
<span class="nc" id="L131">                    className = st.nextToken();</span>
                } else {
<span class="nc" id="L133">                    className = tmp;</span>
                }
<span class="nc" id="L135">            } else {</span>
<span class="nc" id="L136">                throw new OQLException(&quot;query syntax error: class name must follow 'from'&quot;);</span>
            }

<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (st.hasMoreTokens()) {</span>
<span class="nc" id="L140">                identifier = st.nextToken();</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (identifier.equals(&quot;where&quot;)) {</span>
<span class="nc" id="L142">                    throw new OQLException(&quot;query syntax error: identifier should follow class name&quot;);</span>
                }
<span class="nc bnc" id="L144" title="All 2 branches missed.">                if (st.hasMoreTokens()) {</span>
<span class="nc" id="L145">                    String tmp = st.nextToken();</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                    if (! tmp.equals(&quot;where&quot;)) {</span>
<span class="nc" id="L147">                        throw new OQLException(&quot;query syntax error: 'where' clause expected after 'from' clause&quot;);</span>
                    }

<span class="nc" id="L150">                    whereExpr = &quot;&quot;;</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                    while (st.hasMoreTokens()) {</span>
<span class="nc" id="L152">                        whereExpr += &quot; &quot; + st.nextToken();</span>
                    }
<span class="nc bnc" id="L154" title="All 2 branches missed.">                    if (whereExpr.equals(&quot;&quot;)) {</span>
<span class="nc" id="L155">                        throw new OQLException(&quot;query syntax error: 'where' clause cannot have empty expression&quot;);</span>
                    }
<span class="nc" id="L157">                }</span>
            } else {
<span class="nc" id="L159">                throw new OQLException(&quot;query syntax error: identifier should follow class name&quot;);</span>
            }
        }

<span class="nc" id="L163">        executeQuery(new OQLQuery(selectExpr, isInstanceOf, className,</span>
                                  identifier, whereExpr), visitor);
<span class="nc" id="L165">    }</span>

    private void executeQuery(OQLQuery q, ObjectVisitor visitor)
                              throws OQLException {
<span class="nc" id="L169">        JavaClass clazz = null;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (q.className != null) {</span>
<span class="nc" id="L171">            clazz = snapshot.findClass(q.className);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (clazz == null) {</span>
<span class="nc" id="L173">                throw new OQLException(q.className + &quot; is not found!&quot;);</span>
            }
        }

<span class="nc" id="L177">        StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L178">        buf.append(&quot;function __select__(&quot;);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (q.identifier != null) {</span>
<span class="nc" id="L180">            buf.append(q.identifier);</span>
        }
<span class="nc" id="L182">        buf.append(&quot;) { return &quot;);</span>
<span class="nc" id="L183">        buf.append(q.selectExpr.replace('\n', ' '));</span>
<span class="nc" id="L184">        buf.append(&quot;; }&quot;);</span>

<span class="nc" id="L186">        String selectCode = buf.toString();</span>
<span class="nc" id="L187">        debugPrint(selectCode);</span>
<span class="nc" id="L188">        String whereCode = null;</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (q.whereExpr != null) {</span>
<span class="nc" id="L190">            buf = new StringBuffer();</span>
<span class="nc" id="L191">            buf.append(&quot;function __where__(&quot;);</span>
<span class="nc" id="L192">            buf.append(q.identifier);</span>
<span class="nc" id="L193">            buf.append(&quot;) { return &quot;);</span>
<span class="nc" id="L194">            buf.append(q.whereExpr.replace('\n', ' '));</span>
<span class="nc" id="L195">            buf.append(&quot;; }&quot;);</span>
<span class="nc" id="L196">            whereCode = buf.toString();</span>
        }
<span class="nc" id="L198">        debugPrint(whereCode);</span>

        // compile select expression and where condition
        try {
<span class="nc" id="L202">            evalMethod.invoke(engine, new Object[] { selectCode });</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (whereCode != null) {</span>
<span class="nc" id="L204">                evalMethod.invoke(engine, new Object[] { whereCode });</span>
            }

<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (q.className != null) {</span>
<span class="nc" id="L208">                Enumeration objects = clazz.getInstances(q.isInstanceOf);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                while (objects.hasMoreElements()) {</span>
<span class="nc" id="L210">                    JavaHeapObject obj = (JavaHeapObject) objects.nextElement();</span>
<span class="nc" id="L211">                    Object[] args = new Object[] { wrapJavaObject(obj) };</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                    boolean b = (whereCode == null);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    if (!b) {</span>
<span class="nc" id="L214">                        Object res = call(&quot;__where__&quot;, args);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                        if (res instanceof Boolean) {</span>
<span class="nc" id="L216">                            b = ((Boolean)res).booleanValue();</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                        } else if (res instanceof Number) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                            b = ((Number)res).intValue() != 0;</span>
                        } else {
<span class="nc bnc" id="L220" title="All 2 branches missed.">                            b = (res != null);</span>
                        }
                    }

<span class="nc bnc" id="L224" title="All 2 branches missed.">                    if (b) {</span>
<span class="nc" id="L225">                        Object select = call(&quot;__select__&quot;, args);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                        if (visitor.visit(select)) return;</span>
                    }
<span class="nc" id="L228">                }</span>
<span class="nc" id="L229">            } else {</span>
                // simple &quot;select &lt;expr&gt;&quot; query
<span class="nc" id="L231">                Object select = call(&quot;__select__&quot;, new Object[] {});</span>
<span class="nc" id="L232">                visitor.visit(select);</span>
            }
<span class="nc" id="L234">        } catch (Exception e) {</span>
<span class="nc" id="L235">            throw new OQLException(e);</span>
<span class="nc" id="L236">        }</span>
<span class="nc" id="L237">    }</span>

    public Object evalScript(String script) throws Exception {
<span class="nc" id="L240">        return evalMethod.invoke(engine, new Object[] { script });</span>
    }

    public Object wrapJavaObject(JavaHeapObject obj) throws Exception {
<span class="nc" id="L244">        return call(&quot;wrapJavaObject&quot;, new Object[] { obj });</span>
    }

    public Object toHtml(Object obj) throws Exception {
<span class="nc" id="L248">        return call(&quot;toHtml&quot;, new Object[] { obj });</span>
    }

    public Object call(String func, Object[] args) throws Exception {
<span class="nc" id="L252">        return invokeMethod.invoke(engine, new Object[] { func, args });</span>
    }

    private static void debugPrint(String msg) {
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (debug) System.out.println(msg);</span>
<span class="nc" id="L257">    }</span>

    private void init(Snapshot snapshot) throws RuntimeException {
<span class="nc" id="L260">        this.snapshot = snapshot;</span>
        try {
            // create ScriptEngineManager
<span class="nc" id="L263">            Class&lt;?&gt; managerClass = Class.forName(&quot;javax.script.ScriptEngineManager&quot;);</span>
<span class="nc" id="L264">            Object manager = managerClass.newInstance();</span>

            // create JavaScript engine
<span class="nc" id="L267">            Method getEngineMethod = managerClass.getMethod(&quot;getEngineByName&quot;,</span>
                                new Class[] { String.class });
<span class="nc" id="L269">            engine = getEngineMethod.invoke(manager, new Object[] {&quot;js&quot;});</span>

            // initialize engine with init file (hat.js)
<span class="nc" id="L272">            InputStream strm = getInitStream();</span>
<span class="nc" id="L273">            Class&lt;?&gt; engineClass = Class.forName(&quot;javax.script.ScriptEngine&quot;);</span>
<span class="nc" id="L274">            evalMethod = engineClass.getMethod(&quot;eval&quot;,</span>
                                new Class[] { Reader.class });
<span class="nc" id="L276">            evalMethod.invoke(engine, new Object[] {new InputStreamReader(strm)});</span>

            // initialize ScriptEngine.eval(String) and
            // Invocable.invokeFunction(String, Object[]) methods.
<span class="nc" id="L280">            Class&lt;?&gt; invocableClass = Class.forName(&quot;javax.script.Invocable&quot;);</span>

<span class="nc" id="L282">            evalMethod = engineClass.getMethod(&quot;eval&quot;,</span>
                                  new Class[] { String.class });
<span class="nc" id="L284">            invokeMethod = invocableClass.getMethod(&quot;invokeFunction&quot;,</span>
                                  new Class[] { String.class, Object[].class });

            // initialize ScriptEngine.put(String, Object) method
<span class="nc" id="L288">            Method putMethod = engineClass.getMethod(&quot;put&quot;,</span>
                                  new Class[] { String.class, Object.class });

            // call ScriptEngine.put to initialize built-in heap object
<span class="nc" id="L292">            putMethod.invoke(engine, new Object[] {</span>
<span class="nc" id="L293">                        &quot;heap&quot;, call(&quot;wrapHeapSnapshot&quot;, new Object[] { snapshot })</span>
                    });
<span class="nc" id="L295">        } catch (Exception e) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">            if (debug) e.printStackTrace();</span>
<span class="nc" id="L297">            throw new RuntimeException(e);</span>
<span class="nc" id="L298">        }</span>
<span class="nc" id="L299">    }</span>

    private InputStream getInitStream() {
<span class="nc" id="L302">        return getClass().getResourceAsStream(&quot;/com/sun/tools/hat/resources/hat.js&quot;);</span>
    }

    private Object engine;
    private Method evalMethod;
    private Method invokeMethod;
    private Snapshot snapshot;
<span class="nc" id="L309">    private static boolean debug = false;</span>
    private static boolean oqlSupported;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>