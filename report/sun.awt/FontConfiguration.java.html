<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>FontConfiguration.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.awt</a> &gt; <span class="el_source">FontConfiguration.java</span></div><h1>FontConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1996, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.awt;

import java.awt.Font;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.nio.charset.Charset;
import java.nio.charset.CharsetEncoder;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Locale;
import java.util.Map.Entry;
import java.util.Properties;
import java.util.Set;
import java.util.Vector;
import sun.font.CompositeFontDescriptor;
import sun.font.SunFontManager;
import sun.font.FontManagerFactory;
import sun.font.FontUtilities;
import sun.util.logging.PlatformLogger;

/**
 * Provides the definitions of the five logical fonts: Serif, SansSerif,
 * Monospaced, Dialog, and DialogInput. The necessary information
 * is obtained from fontconfig files.
 */
<span class="nc bnc" id="L60" title="All 2 branches missed.">public abstract class FontConfiguration {</span>

    //static global runtime env
    protected static String osVersion;
    protected static String osName;
    protected static String encoding; // canonical name of default nio charset
<span class="nc" id="L66">    protected static Locale startupLocale = null;</span>
<span class="nc" id="L67">    protected static Hashtable localeMap = null;</span>
    private static FontConfiguration fontConfig;
    private static PlatformLogger logger;
<span class="nc" id="L70">    protected static boolean isProperties = true;</span>

    protected SunFontManager fontManager;
    protected boolean preferLocaleFonts;
    protected boolean preferPropFonts;

    private File fontConfigFile;
    private boolean foundOsSpecificFile;
    private boolean inited;
    private String javaLib;

    /* A default FontConfiguration must be created before an alternate
     * one to ensure proper static initialisation takes place.
     */
<span class="nc" id="L84">    public FontConfiguration(SunFontManager fm) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (FontUtilities.debugFonts()) {</span>
<span class="nc" id="L86">            FontUtilities.getLogger()</span>
<span class="nc" id="L87">                .info(&quot;Creating standard Font Configuration&quot;);</span>
        }
<span class="nc bnc" id="L89" title="All 4 branches missed.">        if (FontUtilities.debugFonts() &amp;&amp; logger == null) {</span>
<span class="nc" id="L90">            logger = PlatformLogger.getLogger(&quot;sun.awt.FontConfiguration&quot;);</span>
        }
<span class="nc" id="L92">        fontManager = fm;</span>
<span class="nc" id="L93">        setOsNameAndVersion();  /* static initialization */</span>
<span class="nc" id="L94">        setEncoding();          /* static initialization */</span>
        /* Separating out the file location from the rest of the
         * initialisation, so the caller has the option of doing
         * something else if a suitable file isn't found.
         */
<span class="nc" id="L99">        findFontConfigFile();</span>
<span class="nc" id="L100">    }</span>

    public synchronized boolean init() {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (!inited) {</span>
<span class="nc" id="L104">            this.preferLocaleFonts = false;</span>
<span class="nc" id="L105">            this.preferPropFonts = false;</span>
<span class="nc" id="L106">            setFontConfiguration();</span>
<span class="nc" id="L107">            readFontConfigFile(fontConfigFile);</span>
<span class="nc" id="L108">            initFontConfig();</span>
<span class="nc" id="L109">            inited = true;</span>
        }
<span class="nc" id="L111">        return true;</span>
    }

    public FontConfiguration(SunFontManager fm,
                             boolean preferLocaleFonts,
<span class="nc" id="L116">                             boolean preferPropFonts) {</span>
<span class="nc" id="L117">        fontManager = fm;</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (FontUtilities.debugFonts()) {</span>
<span class="nc" id="L119">            FontUtilities.getLogger()</span>
<span class="nc" id="L120">                .info(&quot;Creating alternate Font Configuration&quot;);</span>
        }
<span class="nc" id="L122">        this.preferLocaleFonts = preferLocaleFonts;</span>
<span class="nc" id="L123">        this.preferPropFonts = preferPropFonts;</span>
        /* fontConfig should be initialised by default constructor, and
         * its data tables can be shared, since readFontConfigFile doesn't
         * update any other state. Also avoid a doPrivileged block.
         */
<span class="nc" id="L128">        initFontConfig();</span>
<span class="nc" id="L129">    }</span>

    /**
     * Fills in this instance's osVersion and osName members. By
     * default uses the system properties os.name and os.version;
     * subclasses may override.
     */
    protected void setOsNameAndVersion() {
<span class="nc" id="L137">        osName = System.getProperty(&quot;os.name&quot;);</span>
<span class="nc" id="L138">        osVersion = System.getProperty(&quot;os.version&quot;);</span>
<span class="nc" id="L139">    }</span>

    private void setEncoding() {
<span class="nc" id="L142">        encoding = Charset.defaultCharset().name();</span>
<span class="nc" id="L143">        startupLocale = SunToolkit.getStartupLocale();</span>
<span class="nc" id="L144">    }</span>

    /////////////////////////////////////////////////////////////////////
    // methods for loading the FontConfig file                         //
    /////////////////////////////////////////////////////////////////////

    public boolean foundOsSpecificFile() {
<span class="nc" id="L151">        return foundOsSpecificFile;</span>
    }

    /* Smoke test to see if we can trust this configuration by testing if
     * the first slot of a composite font maps to an installed file.
     */
    public boolean fontFilesArePresent() {
<span class="nc" id="L158">        init();</span>
<span class="nc" id="L159">        short fontNameID = compFontNameIDs[0][0][0];</span>
<span class="nc" id="L160">        short fileNameID = getComponentFileID(fontNameID);</span>
<span class="nc" id="L161">        final String fileName = mapFileName(getComponentFileName(fileNameID));</span>
<span class="nc" id="L162">        Boolean exists = (Boolean)java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L163">            new java.security.PrivilegedAction() {</span>
                 public Object run() {
                     try {
<span class="nc" id="L166">                         File f = new File(fileName);</span>
<span class="nc" id="L167">                         return Boolean.valueOf(f.exists());</span>
                     }
<span class="nc" id="L169">                     catch (Exception e) {</span>
<span class="nc" id="L170">                         return false;</span>
                     }
                 }
                });
<span class="nc" id="L174">        return exists.booleanValue();</span>
    }

    private void findFontConfigFile() {

<span class="nc" id="L179">        foundOsSpecificFile = true; // default assumption.</span>
<span class="nc" id="L180">        String javaHome = System.getProperty(&quot;java.home&quot;);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (javaHome == null) {</span>
<span class="nc" id="L182">            throw new Error(&quot;java.home property not set&quot;);</span>
        }
<span class="nc" id="L184">        javaLib = javaHome + File.separator + &quot;lib&quot;;</span>
<span class="nc" id="L185">        String userConfigFile = System.getProperty(&quot;sun.awt.fontconfig&quot;);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (userConfigFile != null) {</span>
<span class="nc" id="L187">            fontConfigFile = new File(userConfigFile);</span>
        } else {
<span class="nc" id="L189">            fontConfigFile = findFontConfigFile(javaLib);</span>
        }
<span class="nc" id="L191">    }</span>

    private void readFontConfigFile(File f) {
        /* This is invoked here as readFontConfigFile is only invoked
         * once per VM, and always in a privileged context, thus the
         * directory containing installed fall back fonts is accessed
         * from this context
         */
<span class="nc" id="L199">        getInstalledFallbackFonts(javaLib);</span>

<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (f != null) {</span>
            try {
<span class="nc" id="L203">                FileInputStream in = new FileInputStream(f.getPath());</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                if (isProperties) {</span>
<span class="nc" id="L205">                    loadProperties(in);</span>
                } else {
<span class="nc" id="L207">                    loadBinary(in);</span>
                }
<span class="nc" id="L209">                in.close();</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                if (FontUtilities.debugFonts()) {</span>
<span class="nc" id="L211">                    logger.config(&quot;Read logical font configuration from &quot; + f);</span>
                }
<span class="nc" id="L213">            } catch (IOException e) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (FontUtilities.debugFonts()) {</span>
<span class="nc" id="L215">                    logger.config(&quot;Failed to read logical font configuration from &quot; + f);</span>
                }
<span class="nc" id="L217">            }</span>
        }
<span class="nc" id="L219">        String version = getVersion();</span>
<span class="nc bnc" id="L220" title="All 4 branches missed.">        if (!&quot;1&quot;.equals(version) &amp;&amp; FontUtilities.debugFonts()) {</span>
<span class="nc" id="L221">            logger.config(&quot;Unsupported fontconfig version: &quot; + version);</span>
        }
<span class="nc" id="L223">    }</span>

    protected void getInstalledFallbackFonts(String javaLib) {
<span class="nc" id="L226">        String fallbackDirName = javaLib + File.separator +</span>
            &quot;fonts&quot; + File.separator + &quot;fallback&quot;;

<span class="nc" id="L229">        File fallbackDir = new File(fallbackDirName);</span>
<span class="nc bnc" id="L230" title="All 4 branches missed.">        if (fallbackDir.exists() &amp;&amp; fallbackDir.isDirectory()) {</span>
<span class="nc" id="L231">            String[] ttfs = fallbackDir.list(fontManager.getTrueTypeFilter());</span>
<span class="nc" id="L232">            String[] t1s = fallbackDir.list(fontManager.getType1Filter());</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">            int numTTFs = (ttfs == null) ? 0 : ttfs.length;</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            int numT1s = (t1s == null) ? 0 : t1s.length;</span>
<span class="nc" id="L235">            int len = numTTFs + numT1s;</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (numTTFs + numT1s == 0) {</span>
<span class="nc" id="L237">                return;</span>
            }
<span class="nc" id="L239">            installedFallbackFontFiles = new String[len];</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">            for (int i=0; i&lt;numTTFs; i++) {</span>
<span class="nc" id="L241">                installedFallbackFontFiles[i] =</span>
                    fallbackDir + File.separator + ttfs[i];
            }
<span class="nc bnc" id="L244" title="All 2 branches missed.">            for (int i=0; i&lt;numT1s; i++) {</span>
<span class="nc" id="L245">                installedFallbackFontFiles[i+numTTFs] =</span>
                    fallbackDir + File.separator + t1s[i];
            }
<span class="nc" id="L248">            fontManager.registerFontsInDir(fallbackDirName);</span>
        }
<span class="nc" id="L250">    }</span>

    private File findImpl(String fname) {
<span class="nc" id="L253">        File f = new File(fname + &quot;.properties&quot;);</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (f.canRead()) {</span>
<span class="nc" id="L255">            isProperties = true;</span>
<span class="nc" id="L256">            return f;</span>
        }
<span class="nc" id="L258">        f = new File(fname + &quot;.bfc&quot;);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (f.canRead()) {</span>
<span class="nc" id="L260">            isProperties = false;</span>
<span class="nc" id="L261">            return f;</span>
        }
<span class="nc" id="L263">        return null;</span>
    }

    private File findFontConfigFile(String javaLib) {
<span class="nc" id="L267">        String baseName = javaLib + File.separator + &quot;fontconfig&quot;;</span>
        File configFile;
<span class="nc" id="L269">        String osMajorVersion = null;</span>
<span class="nc bnc" id="L270" title="All 4 branches missed.">        if (osVersion != null &amp;&amp; osName != null) {</span>
<span class="nc" id="L271">            configFile = findImpl(baseName + &quot;.&quot; + osName + &quot;.&quot; + osVersion);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (configFile != null) {</span>
<span class="nc" id="L273">                return configFile;</span>
            }
<span class="nc" id="L275">            int decimalPointIndex = osVersion.indexOf(&quot;.&quot;);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if (decimalPointIndex != -1) {</span>
<span class="nc" id="L277">                osMajorVersion = osVersion.substring(0, osVersion.indexOf(&quot;.&quot;));</span>
<span class="nc" id="L278">                configFile = findImpl(baseName + &quot;.&quot; + osName + &quot;.&quot; + osMajorVersion);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                if (configFile != null) {</span>
<span class="nc" id="L280">                    return configFile;</span>
                }
            }
        }
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (osName != null) {</span>
<span class="nc" id="L285">            configFile = findImpl(baseName + &quot;.&quot; + osName);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (configFile != null) {</span>
<span class="nc" id="L287">                return configFile;</span>
            }
        }
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (osVersion != null) {</span>
<span class="nc" id="L291">            configFile = findImpl(baseName + &quot;.&quot; + osVersion);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if (configFile != null) {</span>
<span class="nc" id="L293">                return configFile;</span>
            }
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (osMajorVersion != null) {</span>
<span class="nc" id="L296">                configFile = findImpl(baseName + &quot;.&quot; + osMajorVersion);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">                if (configFile != null) {</span>
<span class="nc" id="L298">                    return configFile;</span>
                }
            }
        }
<span class="nc" id="L302">        foundOsSpecificFile = false;</span>

<span class="nc" id="L304">        configFile = findImpl(baseName);</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (configFile != null) {</span>
<span class="nc" id="L306">            return configFile;</span>
        }
<span class="nc" id="L308">        return null;</span>
    }

    /* Initialize the internal data tables from binary format font
     * configuration file.
     */
    public static void loadBinary(InputStream inStream) throws IOException {
<span class="nc" id="L315">        DataInputStream in = new DataInputStream(inStream);</span>
<span class="nc" id="L316">        head = readShortTable(in, HEAD_LENGTH);</span>
<span class="nc" id="L317">        int[] tableSizes = new int[INDEX_TABLEEND];</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        for (int i = 0; i &lt; INDEX_TABLEEND; i++) {</span>
<span class="nc" id="L319">            tableSizes[i] = head[i + 1] - head[i];</span>
        }
<span class="nc" id="L321">        table_scriptIDs       = readShortTable(in, tableSizes[INDEX_scriptIDs]);</span>
<span class="nc" id="L322">        table_scriptFonts     = readShortTable(in, tableSizes[INDEX_scriptFonts]);</span>
<span class="nc" id="L323">        table_elcIDs          = readShortTable(in, tableSizes[INDEX_elcIDs]);</span>
<span class="nc" id="L324">        table_sequences        = readShortTable(in, tableSizes[INDEX_sequences]);</span>
<span class="nc" id="L325">        table_fontfileNameIDs = readShortTable(in, tableSizes[INDEX_fontfileNameIDs]);</span>
<span class="nc" id="L326">        table_componentFontNameIDs = readShortTable(in, tableSizes[INDEX_componentFontNameIDs]);</span>
<span class="nc" id="L327">        table_filenames       = readShortTable(in, tableSizes[INDEX_filenames]);</span>
<span class="nc" id="L328">        table_awtfontpaths    = readShortTable(in, tableSizes[INDEX_awtfontpaths]);</span>
<span class="nc" id="L329">        table_exclusions      = readShortTable(in, tableSizes[INDEX_exclusions]);</span>
<span class="nc" id="L330">        table_proportionals   = readShortTable(in, tableSizes[INDEX_proportionals]);</span>
<span class="nc" id="L331">        table_scriptFontsMotif   = readShortTable(in, tableSizes[INDEX_scriptFontsMotif]);</span>
<span class="nc" id="L332">        table_alphabeticSuffix   = readShortTable(in, tableSizes[INDEX_alphabeticSuffix]);</span>
<span class="nc" id="L333">        table_stringIDs       = readShortTable(in, tableSizes[INDEX_stringIDs]);</span>

        //StringTable cache
<span class="nc" id="L336">        stringCache = new String[table_stringIDs.length + 1];</span>

<span class="nc" id="L338">        int len = tableSizes[INDEX_stringTable];</span>
<span class="nc" id="L339">        byte[] bb = new byte[len * 2];</span>
<span class="nc" id="L340">        table_stringTable = new char[len];</span>
<span class="nc" id="L341">        in.read(bb);</span>
<span class="nc" id="L342">        int i = 0, j = 0;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        while (i &lt; len) {</span>
<span class="nc" id="L344">           table_stringTable[i++] = (char)(bb[j++] &lt;&lt; 8 | (bb[j++] &amp; 0xff));</span>
        }
<span class="nc bnc" id="L346" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L347">            dump();</span>
        }
<span class="nc" id="L349">    }</span>

    /* Generate a binary format font configuration from internal data
     * tables.
     */
    public static void saveBinary(OutputStream out) throws IOException {
<span class="nc" id="L355">        sanityCheck();</span>

<span class="nc" id="L357">        DataOutputStream dataOut = new DataOutputStream(out);</span>
<span class="nc" id="L358">        writeShortTable(dataOut, head);</span>
<span class="nc" id="L359">        writeShortTable(dataOut, table_scriptIDs);</span>
<span class="nc" id="L360">        writeShortTable(dataOut, table_scriptFonts);</span>
<span class="nc" id="L361">        writeShortTable(dataOut, table_elcIDs);</span>
<span class="nc" id="L362">        writeShortTable(dataOut, table_sequences);</span>
<span class="nc" id="L363">        writeShortTable(dataOut, table_fontfileNameIDs);</span>
<span class="nc" id="L364">        writeShortTable(dataOut, table_componentFontNameIDs);</span>
<span class="nc" id="L365">        writeShortTable(dataOut, table_filenames);</span>
<span class="nc" id="L366">        writeShortTable(dataOut, table_awtfontpaths);</span>
<span class="nc" id="L367">        writeShortTable(dataOut, table_exclusions);</span>
<span class="nc" id="L368">        writeShortTable(dataOut, table_proportionals);</span>
<span class="nc" id="L369">        writeShortTable(dataOut, table_scriptFontsMotif);</span>
<span class="nc" id="L370">        writeShortTable(dataOut, table_alphabeticSuffix);</span>
<span class="nc" id="L371">        writeShortTable(dataOut, table_stringIDs);</span>
        //stringTable
<span class="nc" id="L373">        dataOut.writeChars(new String(table_stringTable));</span>
<span class="nc" id="L374">        out.close();</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L376">            dump();</span>
        }
<span class="nc" id="L378">    }</span>

    //private static boolean loadingProperties;
    private static short stringIDNum;
    private static short[] stringIDs;
    private static StringBuilder stringTable;

    public static void loadProperties(InputStream in) throws IOException {
        //loadingProperties = true;
        //StringID starts from &quot;1&quot;, &quot;0&quot; is reserved for &quot;not defined&quot;
<span class="nc" id="L388">        stringIDNum = 1;</span>
<span class="nc" id="L389">        stringIDs = new short[1000];</span>
<span class="nc" id="L390">        stringTable = new StringBuilder(4096);</span>

<span class="nc bnc" id="L392" title="All 4 branches missed.">        if (verbose &amp;&amp; logger == null) {</span>
<span class="nc" id="L393">            logger = PlatformLogger.getLogger(&quot;sun.awt.FontConfiguration&quot;);</span>
        }
<span class="nc" id="L395">        new PropertiesHandler().load(in);</span>

        //loadingProperties = false;
<span class="nc" id="L398">        stringIDs = null;</span>
<span class="nc" id="L399">        stringTable = null;</span>
<span class="nc" id="L400">    }</span>


    /////////////////////////////////////////////////////////////////////
    // methods for initializing the FontConfig                         //
    /////////////////////////////////////////////////////////////////////

    /**
     *  set initLocale, initEncoding and initELC for this FontConfig object
     *  currently we just simply use the startup locale and encoding
     */
    private void initFontConfig() {
<span class="nc" id="L412">        initLocale = startupLocale;</span>
<span class="nc" id="L413">        initEncoding = encoding;</span>
<span class="nc bnc" id="L414" title="All 4 branches missed.">        if (preferLocaleFonts &amp;&amp; !willReorderForStartupLocale()) {</span>
<span class="nc" id="L415">            preferLocaleFonts = false;</span>
        }
<span class="nc" id="L417">        initELC = getInitELC();</span>
<span class="nc" id="L418">        initAllComponentFonts();</span>
<span class="nc" id="L419">    }</span>

    //&quot;ELC&quot; stands for &quot;Encoding.Language.Country&quot;. This method returns
    //the ID of the matched elc setting of &quot;initLocale&quot; in elcIDs table.
    //If no match is found, it returns the default ID, which is
    //&quot;NULL.NULL.NULL&quot; in elcIDs table.
    private short getInitELC() {
<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (initELC != -1) {</span>
<span class="nc" id="L427">            return initELC;</span>
        }
<span class="nc" id="L429">        HashMap &lt;String, Integer&gt; elcIDs = new HashMap&lt;String, Integer&gt;();</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        for (int i = 0; i &lt; table_elcIDs.length; i++) {</span>
<span class="nc" id="L431">            elcIDs.put(getString(table_elcIDs[i]), i);</span>
        }
<span class="nc" id="L433">        String language = initLocale.getLanguage();</span>
<span class="nc" id="L434">        String country = initLocale.getCountry();</span>
        String elc;
<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (elcIDs.containsKey(elc=initEncoding + &quot;.&quot; + language + &quot;.&quot; + country)</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">            || elcIDs.containsKey(elc=initEncoding + &quot;.&quot; + language)</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">            || elcIDs.containsKey(elc=initEncoding)) {</span>
<span class="nc" id="L439">            initELC = elcIDs.get(elc).shortValue();</span>
        } else {
<span class="nc" id="L441">            initELC = elcIDs.get(&quot;NULL.NULL.NULL&quot;).shortValue();</span>
        }
<span class="nc" id="L443">        int i = 0;</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">        while (i &lt; table_alphabeticSuffix.length) {</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">            if (initELC == table_alphabeticSuffix[i]) {</span>
<span class="nc" id="L446">                alphabeticSuffix = getString(table_alphabeticSuffix[i + 1]);</span>
<span class="nc" id="L447">                return initELC;</span>
            }
<span class="nc" id="L449">            i += 2;</span>
        }
<span class="nc" id="L451">        return initELC;</span>
    }

    public static boolean verbose;
<span class="nc" id="L455">    private short    initELC = -1;</span>
    private Locale   initLocale;
    private String   initEncoding;
    private String   alphabeticSuffix;

<span class="nc" id="L460">    private short[][][] compFontNameIDs = new short[NUM_FONTS][NUM_STYLES][];</span>
<span class="nc" id="L461">    private int[][][] compExclusions = new int[NUM_FONTS][][];</span>
<span class="nc" id="L462">    private int[] compCoreNum = new int[NUM_FONTS];</span>

<span class="nc" id="L464">    private Set&lt;Short&gt; coreFontNameIDs = new HashSet&lt;Short&gt;();</span>
<span class="nc" id="L465">    private Set&lt;Short&gt; fallbackFontNameIDs = new HashSet&lt;Short&gt;();</span>

    private void initAllComponentFonts() {
<span class="nc" id="L468">        short[] fallbackScripts = getFallbackScripts();</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">        for (int fontIndex = 0; fontIndex &lt; NUM_FONTS; fontIndex++) {</span>
<span class="nc" id="L470">            short[] coreScripts = getCoreScripts(fontIndex);</span>
<span class="nc" id="L471">            compCoreNum[fontIndex] = coreScripts.length;</span>
            /*
            System.out.println(&quot;coreScriptID=&quot; + table_sequences[initELC * 5 + fontIndex]);
            for (int i = 0; i &lt; coreScripts.length; i++) {
            System.out.println(&quot;  &quot; + i + &quot; :&quot; + getString(table_scriptIDs[coreScripts[i]]));
            }
            */
            //init exclusionRanges
<span class="nc" id="L479">            int[][] exclusions = new int[coreScripts.length][];</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">            for (int i = 0; i &lt; coreScripts.length; i++) {</span>
<span class="nc" id="L481">                exclusions[i] = getExclusionRanges(coreScripts[i]);</span>
            }
<span class="nc" id="L483">            compExclusions[fontIndex] = exclusions;</span>
            //init componentFontNames
<span class="nc bnc" id="L485" title="All 2 branches missed.">            for (int styleIndex = 0; styleIndex &lt; NUM_STYLES; styleIndex++) {</span>
                int index;
<span class="nc" id="L487">                short[] nameIDs = new short[coreScripts.length + fallbackScripts.length];</span>
                //core
<span class="nc bnc" id="L489" title="All 2 branches missed.">                for (index = 0; index &lt; coreScripts.length; index++) {</span>
<span class="nc" id="L490">                    nameIDs[index] = getComponentFontID(coreScripts[index],</span>
                                               fontIndex, styleIndex);
<span class="nc bnc" id="L492" title="All 4 branches missed.">                    if (preferLocaleFonts &amp;&amp; localeMap != null &amp;&amp;</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                            fontManager.usingAlternateFontforJALocales()) {</span>
<span class="nc" id="L494">                        nameIDs[index] = remapLocaleMap(fontIndex, styleIndex,</span>
                                                        coreScripts[index], nameIDs[index]);
                    }
<span class="nc bnc" id="L497" title="All 2 branches missed.">                    if (preferPropFonts) {</span>
<span class="nc" id="L498">                        nameIDs[index] = remapProportional(fontIndex, nameIDs[index]);</span>
                    }
                    //System.out.println(&quot;nameid=&quot; + nameIDs[index]);
<span class="nc" id="L501">                    coreFontNameIDs.add(nameIDs[index]);</span>
                }
                //fallback
<span class="nc bnc" id="L504" title="All 2 branches missed.">                for (int i = 0; i &lt; fallbackScripts.length; i++) {</span>
<span class="nc" id="L505">                    short id = getComponentFontID(fallbackScripts[i],</span>
                                               fontIndex, styleIndex);
<span class="nc bnc" id="L507" title="All 4 branches missed.">                    if (preferLocaleFonts &amp;&amp; localeMap != null &amp;&amp;</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                            fontManager.usingAlternateFontforJALocales()) {</span>
<span class="nc" id="L509">                        id = remapLocaleMap(fontIndex, styleIndex, fallbackScripts[i], id);</span>
                    }
<span class="nc bnc" id="L511" title="All 2 branches missed.">                    if (preferPropFonts) {</span>
<span class="nc" id="L512">                        id = remapProportional(fontIndex, id);</span>
                    }
<span class="nc bnc" id="L514" title="All 2 branches missed.">                    if (contains(nameIDs, id, index)) {</span>
<span class="nc" id="L515">                        continue;</span>
                    }
                    /*
                      System.out.println(&quot;fontIndex=&quot; + fontIndex + &quot;, styleIndex=&quot; + styleIndex
                           + &quot;, fbIndex=&quot; + i + &quot;,fbS=&quot; + fallbackScripts[i] + &quot;, id=&quot; + id);
                    */
<span class="nc" id="L521">                    fallbackFontNameIDs.add(id);</span>
<span class="nc" id="L522">                    nameIDs[index++] = id;</span>
                }
<span class="nc bnc" id="L524" title="All 2 branches missed.">                if (index &lt; nameIDs.length) {</span>
<span class="nc" id="L525">                    short[] newNameIDs = new short[index];</span>
<span class="nc" id="L526">                    System.arraycopy(nameIDs, 0, newNameIDs, 0, index);</span>
<span class="nc" id="L527">                    nameIDs = newNameIDs;</span>
                }
<span class="nc" id="L529">                compFontNameIDs[fontIndex][styleIndex] = nameIDs;</span>
            }
        }
<span class="nc" id="L532">   }</span>

   private short remapLocaleMap(int fontIndex, int styleIndex, short scriptID, short fontID) {
<span class="nc" id="L535">        String scriptName = getString(table_scriptIDs[scriptID]);</span>

<span class="nc" id="L537">        String value = (String)localeMap.get(scriptName);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L539">            String fontName = fontNames[fontIndex];</span>
<span class="nc" id="L540">            String styleName = styleNames[styleIndex];</span>
<span class="nc" id="L541">            value = (String)localeMap.get(fontName + &quot;.&quot; + styleName + &quot;.&quot; + scriptName);</span>
        }
<span class="nc bnc" id="L543" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L544">            return fontID;</span>
        }

<span class="nc bnc" id="L547" title="All 2 branches missed.">        for (int i = 0; i &lt; table_componentFontNameIDs.length; i++) {</span>
<span class="nc" id="L548">            String name = getString(table_componentFontNameIDs[i]);</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">            if (value.equalsIgnoreCase(name)) {</span>
<span class="nc" id="L550">                fontID = (short)i;</span>
<span class="nc" id="L551">                break;</span>
            }
        }
<span class="nc" id="L554">        return fontID;</span>
    }

    public static boolean hasMonoToPropMap() {
<span class="nc bnc" id="L558" title="All 4 branches missed.">        return table_proportionals != null &amp;&amp; table_proportionals.length != 0;</span>
    }

    private short remapProportional(int fontIndex, short id) {
<span class="nc bnc" id="L562" title="All 8 branches missed.">    if (preferPropFonts &amp;&amp;</span>
        table_proportionals.length != 0 &amp;&amp;
        fontIndex != 2 &amp;&amp;         //&quot;monospaced&quot;
        fontIndex != 4) {         //&quot;dialoginput&quot;
<span class="nc" id="L566">            int i = 0;</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">            while (i &lt; table_proportionals.length) {</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">                if (table_proportionals[i] == id) {</span>
<span class="nc" id="L569">                    return table_proportionals[i + 1];</span>
                }
<span class="nc" id="L571">                i += 2;</span>
            }
        }
<span class="nc" id="L574">        return id;</span>
    }

    /////////////////////////////////////////////////////////////////////
    // Methods for handling font and style names                       //
    /////////////////////////////////////////////////////////////////////
    protected static final int NUM_FONTS = 5;
    protected static final int NUM_STYLES = 4;
<span class="nc" id="L582">    protected static final String[] fontNames</span>
            = {&quot;serif&quot;, &quot;sansserif&quot;, &quot;monospaced&quot;, &quot;dialog&quot;, &quot;dialoginput&quot;};
<span class="nc" id="L584">    protected static final String[] publicFontNames</span>
            = {Font.SERIF, Font.SANS_SERIF, Font.MONOSPACED, Font.DIALOG,
               Font.DIALOG_INPUT};
<span class="nc" id="L587">    protected static final String[] styleNames</span>
            = {&quot;plain&quot;, &quot;bold&quot;, &quot;italic&quot;, &quot;bolditalic&quot;};

    /**
     * Checks whether the given font family name is a valid logical font name.
     * The check is case insensitive.
     */
    public static boolean isLogicalFontFamilyName(String fontName) {
<span class="nc" id="L595">        return isLogicalFontFamilyNameLC(fontName.toLowerCase(Locale.ENGLISH));</span>
    }

    /**
     * Checks whether the given font family name is a valid logical font name.
     * The check is case sensitive.
     */
    public static boolean isLogicalFontFamilyNameLC(String fontName) {
<span class="nc bnc" id="L603" title="All 2 branches missed.">        for (int i = 0; i &lt; fontNames.length; i++) {</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">            if (fontName.equals(fontNames[i])) {</span>
<span class="nc" id="L605">                return true;</span>
            }
        }
<span class="nc" id="L608">        return false;</span>
    }

    /**
     * Checks whether the given style name is a valid logical font style name.
     */
    private static boolean isLogicalFontStyleName(String styleName) {
<span class="nc bnc" id="L615" title="All 2 branches missed.">        for (int i = 0; i &lt; styleNames.length; i++) {</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">            if (styleName.equals(styleNames[i])) {</span>
<span class="nc" id="L617">                return true;</span>
            }
        }
<span class="nc" id="L620">        return false;</span>
    }

    /**
     * Checks whether the given font face name is a valid logical font name.
     * The check is case insensitive.
     */
    public static boolean isLogicalFontFaceName(String fontName) {
<span class="nc" id="L628">        return isLogicalFontFaceNameLC(fontName.toLowerCase(Locale.ENGLISH));</span>
    }

   /**
    * Checks whether the given font face name is a valid logical font name.
    * The check is case sensitive.
    */
    public static boolean isLogicalFontFaceNameLC(String fontName) {
<span class="nc" id="L636">        int period = fontName.indexOf('.');</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">        if (period &gt;= 0) {</span>
<span class="nc" id="L638">            String familyName = fontName.substring(0, period);</span>
<span class="nc" id="L639">            String styleName = fontName.substring(period + 1);</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">            return isLogicalFontFamilyName(familyName) &amp;&amp;</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">                    isLogicalFontStyleName(styleName);</span>
        } else {
<span class="nc" id="L643">            return isLogicalFontFamilyName(fontName);</span>
        }
    }

    protected static int getFontIndex(String fontName) {
<span class="nc" id="L648">        return getArrayIndex(fontNames, fontName);</span>
    }

    protected static int getStyleIndex(String styleName) {
<span class="nc" id="L652">        return getArrayIndex(styleNames, styleName);</span>
    }

    private static int getArrayIndex(String[] names, String name) {
<span class="nc bnc" id="L656" title="All 2 branches missed.">        for (int i = 0; i &lt; names.length; i++) {</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">            if (name.equals(names[i])) {</span>
<span class="nc" id="L658">                return i;</span>
            }
        }
<span class="nc bnc" id="L661" title="All 2 branches missed.">        assert false;</span>
<span class="nc" id="L662">        return 0;</span>
    }

    protected static int getStyleIndex(int style) {
<span class="nc bnc" id="L666" title="All 5 branches missed.">        switch (style) {</span>
            case Font.PLAIN:
<span class="nc" id="L668">                return 0;</span>
            case Font.BOLD:
<span class="nc" id="L670">                return 1;</span>
            case Font.ITALIC:
<span class="nc" id="L672">                return 2;</span>
            case Font.BOLD | Font.ITALIC:
<span class="nc" id="L674">                return 3;</span>
            default:
<span class="nc" id="L676">                return 0;</span>
        }
    }

    protected static String getFontName(int fontIndex) {
<span class="nc" id="L681">        return fontNames[fontIndex];</span>
    }

    protected static String getStyleName(int styleIndex) {
<span class="nc" id="L685">        return styleNames[styleIndex];</span>
    }

    /**
     * Returns the font face name for the given logical font
     * family name and style.
     * The style argument is interpreted as in java.awt.Font.Font.
     */
    public static String getLogicalFontFaceName(String familyName, int style) {
<span class="nc bnc" id="L694" title="All 4 branches missed.">        assert isLogicalFontFamilyName(familyName);</span>
<span class="nc" id="L695">        return familyName.toLowerCase(Locale.ENGLISH) + &quot;.&quot; + getStyleString(style);</span>
    }

    /**
     * Returns the string typically used in properties files
     * for the given style.
     * The style argument is interpreted as in java.awt.Font.Font.
     */
    public static String getStyleString(int style) {
<span class="nc" id="L704">        return getStyleName(getStyleIndex(style));</span>
    }

    /**
     * Returns a fallback name for the given font name. For a few known
     * font names, matching logical font names are returned. For all
     * other font names, defaultFallback is returned.
     * defaultFallback differs between AWT and 2D.
     */
    public abstract String getFallbackFamilyName(String fontName, String defaultFallback);

    /**
     * Returns the 1.1 equivalent for some old 1.0 font family names for
     * which we need to maintain compatibility in some configurations.
     * Returns null for other font names.
     */
    protected String getCompatibilityFamilyName(String fontName) {
<span class="nc" id="L721">        fontName = fontName.toLowerCase(Locale.ENGLISH);</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">        if (fontName.equals(&quot;timesroman&quot;)) {</span>
<span class="nc" id="L723">            return &quot;serif&quot;;</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">        } else if (fontName.equals(&quot;helvetica&quot;)) {</span>
<span class="nc" id="L725">            return &quot;sansserif&quot;;</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">        } else if (fontName.equals(&quot;courier&quot;)) {</span>
<span class="nc" id="L727">            return &quot;monospaced&quot;;</span>
        }
<span class="nc" id="L729">        return null;</span>
    }

<span class="nc" id="L732">    protected static String[] installedFallbackFontFiles = null;</span>

    /**
     * Maps a file name given in the font configuration file
     * to a format appropriate for the platform.
     */
    protected String mapFileName(String fileName) {
<span class="nc" id="L739">        return fileName;</span>
    }

    //////////////////////////////////////////////////////////////////////
    //  reordering                                                      //
    //////////////////////////////////////////////////////////////////////

    /* Mappings from file encoding to font config name for font supporting
     * the corresponding language. This is filled in by initReorderMap()
     */
<span class="nc" id="L749">    protected HashMap reorderMap = null;</span>

    /* Platform-specific mappings */
    protected abstract void initReorderMap();

    /* Move item at index &quot;src&quot; to &quot;dst&quot;, shuffling all values in
     * between down
     */
    private void shuffle(String[] seq, int src, int dst) {
<span class="nc bnc" id="L758" title="All 2 branches missed.">        if (dst &gt;= src) {</span>
<span class="nc" id="L759">            return;</span>
        }
<span class="nc" id="L761">        String tmp = seq[src];</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">        for (int i=src; i&gt;dst; i--) {</span>
<span class="nc" id="L763">            seq[i] = seq[i-1];</span>
        }
<span class="nc" id="L765">        seq[dst] = tmp;</span>
<span class="nc" id="L766">    }</span>

    /* Called to determine if there's a re-order sequence for this locale/
     * encoding. If there's none then the caller can &quot;bail&quot; and avoid
     * unnecessary work
     */
    public static boolean willReorderForStartupLocale() {
<span class="nc bnc" id="L773" title="All 2 branches missed.">        return getReorderSequence() != null;</span>
    }

    private static Object getReorderSequence() {
<span class="nc bnc" id="L777" title="All 2 branches missed.">        if (fontConfig.reorderMap == null) {</span>
<span class="nc" id="L778">             fontConfig.initReorderMap();</span>
        }
<span class="nc" id="L780">        HashMap reorderMap = fontConfig.reorderMap;</span>

        /* Find the most specific mapping */
<span class="nc" id="L783">        String language = startupLocale.getLanguage();</span>
<span class="nc" id="L784">        String country = startupLocale.getCountry();</span>
<span class="nc" id="L785">        Object val = reorderMap.get(encoding + &quot;.&quot; + language + &quot;.&quot; + country);</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">        if (val == null) {</span>
<span class="nc" id="L787">            val = reorderMap.get(encoding + &quot;.&quot; + language);</span>
        }
<span class="nc bnc" id="L789" title="All 2 branches missed.">        if (val == null) {</span>
<span class="nc" id="L790">            val = reorderMap.get(encoding);</span>
        }
<span class="nc" id="L792">        return val;</span>
    }

    /* This method reorders the sequence such that the matches for the
     * file encoding are moved ahead of other elements.
     * If an encoding uses more than one font, they are all moved up.
     */
     private void reorderSequenceForLocale(String[] seq) {
<span class="nc" id="L800">        Object val =  getReorderSequence();</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (val instanceof String) {</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">            for (int i=0; i&lt; seq.length; i++) {</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">                if (seq[i].equals(val)) {</span>
<span class="nc" id="L804">                    shuffle(seq, i, 0);</span>
<span class="nc" id="L805">                    return;</span>
                }
            }
<span class="nc bnc" id="L808" title="All 2 branches missed.">        } else if (val instanceof String[]) {</span>
<span class="nc" id="L809">            String[] fontLangs = (String[])val;</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">            for (int l=0; l&lt;fontLangs.length;l++) {</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">                for (int i=0; i&lt;seq.length;i++) {</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">                    if (seq[i].equals(fontLangs[l])) {</span>
<span class="nc" id="L813">                        shuffle(seq, i, l);</span>
                    }
                }
            }
        }
<span class="nc" id="L818">    }</span>

    private static Vector splitSequence(String sequence) {
        //String.split would be more convenient, but incurs big performance penalty
<span class="nc" id="L822">        Vector parts = new Vector();</span>
<span class="nc" id="L823">        int start = 0;</span>
        int end;
<span class="nc bnc" id="L825" title="All 2 branches missed.">        while ((end = sequence.indexOf(',', start)) &gt;= 0) {</span>
<span class="nc" id="L826">            parts.add(sequence.substring(start, end));</span>
<span class="nc" id="L827">            start = end + 1;</span>
        }
<span class="nc bnc" id="L829" title="All 2 branches missed.">        if (sequence.length() &gt; start) {</span>
<span class="nc" id="L830">            parts.add(sequence.substring(start, sequence.length()));</span>
        }
<span class="nc" id="L832">        return parts;</span>
    }

    protected String[] split(String sequence) {
<span class="nc" id="L836">        Vector v = splitSequence(sequence);</span>
<span class="nc" id="L837">        return (String[])v.toArray(new String[0]);</span>
    }

    ////////////////////////////////////////////////////////////////////////
    // Methods for extracting information from the fontconfig data for AWT//
    ////////////////////////////////////////////////////////////////////////
<span class="nc" id="L843">    private Hashtable charsetRegistry = new Hashtable(5);</span>

    /**
     * Returns FontDescriptors describing the physical fonts used for the
     * given logical font name and style. The font name is interpreted
     * in a case insensitive way.
     * The style argument is interpreted as in java.awt.Font.Font.
     */
    public FontDescriptor[] getFontDescriptors(String fontName, int style) {
<span class="nc bnc" id="L852" title="All 4 branches missed.">        assert isLogicalFontFamilyName(fontName);</span>
<span class="nc" id="L853">        fontName = fontName.toLowerCase(Locale.ENGLISH);</span>
<span class="nc" id="L854">        int fontIndex = getFontIndex(fontName);</span>
<span class="nc" id="L855">        int styleIndex = getStyleIndex(style);</span>
<span class="nc" id="L856">        return getFontDescriptors(fontIndex, styleIndex);</span>
    }
<span class="nc" id="L858">    private FontDescriptor[][][] fontDescriptors =</span>
        new FontDescriptor[NUM_FONTS][NUM_STYLES][];

    private FontDescriptor[] getFontDescriptors(int fontIndex, int styleIndex) {
<span class="nc" id="L862">        FontDescriptor[] descriptors = fontDescriptors[fontIndex][styleIndex];</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">        if (descriptors == null) {</span>
<span class="nc" id="L864">            descriptors = buildFontDescriptors(fontIndex, styleIndex);</span>
<span class="nc" id="L865">            fontDescriptors[fontIndex][styleIndex] = descriptors;</span>
        }
<span class="nc" id="L867">        return descriptors;</span>
    }

    private FontDescriptor[] buildFontDescriptors(int fontIndex, int styleIndex) {
<span class="nc" id="L871">        String fontName = fontNames[fontIndex];</span>
<span class="nc" id="L872">        String styleName = styleNames[styleIndex];</span>

<span class="nc" id="L874">        short[] scriptIDs = getCoreScripts(fontIndex);</span>
<span class="nc" id="L875">        short[] nameIDs = compFontNameIDs[fontIndex][styleIndex];</span>
<span class="nc" id="L876">        String[] sequence = new String[scriptIDs.length];</span>
<span class="nc" id="L877">        String[] names = new String[scriptIDs.length];</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">        for (int i = 0; i &lt; sequence.length; i++) {</span>
<span class="nc" id="L879">            names[i] = getComponentFontName(nameIDs[i]);</span>
<span class="nc" id="L880">            sequence[i] = getScriptName(scriptIDs[i]);</span>
<span class="nc bnc" id="L881" title="All 4 branches missed.">            if (alphabeticSuffix != null &amp;&amp; &quot;alphabetic&quot;.equals(sequence[i])) {</span>
<span class="nc" id="L882">                sequence[i] = sequence[i] + &quot;/&quot; + alphabeticSuffix;</span>
            }
        }
<span class="nc" id="L885">        int[][] fontExclusionRanges = compExclusions[fontIndex];</span>

<span class="nc" id="L887">        FontDescriptor[] descriptors = new FontDescriptor[names.length];</span>

<span class="nc bnc" id="L889" title="All 2 branches missed.">        for (int i = 0; i &lt; names.length; i++) {</span>
            String awtFontName;
            String encoding;

<span class="nc" id="L893">            awtFontName = makeAWTFontName(names[i], sequence[i]);</span>

            // look up character encoding
<span class="nc" id="L896">            encoding = getEncoding(names[i], sequence[i]);</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">            if (encoding == null) {</span>
<span class="nc" id="L898">                encoding = &quot;default&quot;;</span>
            }
<span class="nc" id="L900">            CharsetEncoder enc</span>
<span class="nc" id="L901">                    = getFontCharsetEncoder(encoding.trim(), awtFontName);</span>

            // we already have the exclusion ranges
<span class="nc" id="L904">            int[] exclusionRanges = fontExclusionRanges[i];</span>

            // create descriptor
<span class="nc" id="L907">            descriptors[i] = new FontDescriptor(awtFontName, enc, exclusionRanges);</span>
        }
<span class="nc" id="L909">        return descriptors;</span>
    }

    /**
     * Returns the AWT font name for the given platform font name and
     * character subset.
     */
    protected String makeAWTFontName(String platformFontName,
            String characterSubsetName) {
<span class="nc" id="L918">        return platformFontName;</span>
    }

    /**
     * Returns the java.io name of the platform character encoding for the
     * given AWT font name and character subset. May return &quot;default&quot;
     * to indicate that getDefaultFontCharset should be called to obtain
     * a charset encoder.
     */
    protected abstract String getEncoding(String awtFontName,
            String characterSubsetName);

    private CharsetEncoder getFontCharsetEncoder(final String charsetName,
            String fontName) {

<span class="nc" id="L933">        Charset fc = null;</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">        if (charsetName.equals(&quot;default&quot;)) {</span>
<span class="nc" id="L935">            fc = (Charset) charsetRegistry.get(fontName);</span>
        } else {
<span class="nc" id="L937">            fc = (Charset) charsetRegistry.get(charsetName);</span>
        }
<span class="nc bnc" id="L939" title="All 2 branches missed.">        if (fc != null) {</span>
<span class="nc" id="L940">            return fc.newEncoder();</span>
        }

<span class="nc bnc" id="L943" title="All 4 branches missed.">        if (!charsetName.startsWith(&quot;sun.awt.&quot;) &amp;&amp; !charsetName.equals(&quot;default&quot;)) {</span>
<span class="nc" id="L944">            fc = Charset.forName(charsetName);</span>
        } else {
<span class="nc" id="L946">            Class fcc = (Class) AccessController.doPrivileged(new PrivilegedAction() {</span>
                    public Object run() {
                        try {
<span class="nc" id="L949">                            return Class.forName(charsetName, true,</span>
<span class="nc" id="L950">                                                 ClassLoader.getSystemClassLoader());</span>
<span class="nc" id="L951">                        } catch (ClassNotFoundException e) {</span>
                        }
<span class="nc" id="L953">                        return null;</span>
                    }
                });

<span class="nc bnc" id="L957" title="All 2 branches missed.">            if (fcc != null) {</span>
                try {
<span class="nc" id="L959">                    fc = (Charset) fcc.newInstance();</span>
<span class="nc" id="L960">                } catch (Exception e) {</span>
<span class="nc" id="L961">                }</span>
            }
        }
<span class="nc bnc" id="L964" title="All 2 branches missed.">        if (fc == null) {</span>
<span class="nc" id="L965">            fc = getDefaultFontCharset(fontName);</span>
        }

<span class="nc bnc" id="L968" title="All 2 branches missed.">        if (charsetName.equals(&quot;default&quot;)){</span>
<span class="nc" id="L969">            charsetRegistry.put(fontName, fc);</span>
        } else {
<span class="nc" id="L971">            charsetRegistry.put(charsetName, fc);</span>
        }
<span class="nc" id="L973">        return fc.newEncoder();</span>
    }

    protected abstract Charset getDefaultFontCharset(
            String fontName);

    /* This retrieves the platform font directories (path) calculated
     * by setAWTFontPathSequence(String[]). The default implementation
     * returns null, its expected that X11 platforms may return
     * non-null.
     */
    public HashSet&lt;String&gt; getAWTFontPathSet() {
<span class="nc" id="L985">        return null;</span>
    }

    ////////////////////////////////////////////////////////////////////////
    // methods for extracting information from the fontconfig data for 2D //
    ////////////////////////////////////////////////////////////////////////

    /**
     * Returns an array of composite font descriptors for all logical font
     * faces.
     * If the font configuration file doesn't specify Lucida Sans Regular
     * or the given fallback font as component fonts, they are added here.
     */
    public CompositeFontDescriptor[] get2DCompositeFontInfo() {
<span class="nc" id="L999">        CompositeFontDescriptor[] result =</span>
                new CompositeFontDescriptor[NUM_FONTS * NUM_STYLES];
<span class="nc" id="L1001">        String defaultFontFile = fontManager.getDefaultFontFile();</span>
<span class="nc" id="L1002">        String defaultFontFaceName = fontManager.getDefaultFontFaceName();</span>

<span class="nc bnc" id="L1004" title="All 2 branches missed.">        for (int fontIndex = 0; fontIndex &lt; NUM_FONTS; fontIndex++) {</span>
<span class="nc" id="L1005">            String fontName = publicFontNames[fontIndex];</span>

            // determine exclusion ranges for font
            // AWT uses separate exclusion range array per component font.
            // 2D packs all range boundaries into one array.
            // Both use separate entries for lower and upper boundary.
<span class="nc" id="L1011">            int[][] exclusions = compExclusions[fontIndex];</span>
<span class="nc" id="L1012">            int numExclusionRanges = 0;</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">            for (int i = 0; i &lt; exclusions.length; i++) {</span>
<span class="nc" id="L1014">                numExclusionRanges += exclusions[i].length;</span>
            }
<span class="nc" id="L1016">            int[] exclusionRanges = new int[numExclusionRanges];</span>
<span class="nc" id="L1017">            int[] exclusionRangeLimits = new int[exclusions.length];</span>
<span class="nc" id="L1018">            int exclusionRangeIndex = 0;</span>
<span class="nc" id="L1019">            int exclusionRangeLimitIndex = 0;</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">            for (int i = 0; i &lt; exclusions.length; i++) {</span>
<span class="nc" id="L1021">                int[] componentRanges = exclusions[i];</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">                for (int j = 0; j &lt; componentRanges.length; ) {</span>
<span class="nc" id="L1023">                    int value = componentRanges[j];</span>
<span class="nc" id="L1024">                    exclusionRanges[exclusionRangeIndex++] = componentRanges[j++];</span>
<span class="nc" id="L1025">                    exclusionRanges[exclusionRangeIndex++] = componentRanges[j++];</span>
<span class="nc" id="L1026">                }</span>
<span class="nc" id="L1027">                exclusionRangeLimits[i] = exclusionRangeIndex;</span>
            }
            // other info is per style
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            for (int styleIndex = 0; styleIndex &lt; NUM_STYLES; styleIndex++) {</span>
<span class="nc" id="L1031">                int maxComponentFontCount = compFontNameIDs[fontIndex][styleIndex].length;</span>
<span class="nc" id="L1032">                boolean sawDefaultFontFile = false;</span>
                // fall back fonts listed in the lib/fonts/fallback directory
<span class="nc bnc" id="L1034" title="All 2 branches missed.">                if (installedFallbackFontFiles != null) {</span>
<span class="nc" id="L1035">                    maxComponentFontCount += installedFallbackFontFiles.length;</span>
                }
<span class="nc" id="L1037">                String faceName = fontName + &quot;.&quot; + styleNames[styleIndex];</span>

                // determine face names and file names of component fonts
<span class="nc" id="L1040">                String[] componentFaceNames = new String[maxComponentFontCount];</span>
<span class="nc" id="L1041">                String[] componentFileNames = new String[maxComponentFontCount];</span>

                int index;
<span class="nc bnc" id="L1044" title="All 2 branches missed.">                for (index = 0; index &lt; compFontNameIDs[fontIndex][styleIndex].length; index++) {</span>
<span class="nc" id="L1045">                    short fontNameID = compFontNameIDs[fontIndex][styleIndex][index];</span>
<span class="nc" id="L1046">                    short fileNameID = getComponentFileID(fontNameID);</span>
<span class="nc" id="L1047">                    componentFaceNames[index] = getFaceNameFromComponentFontName(getComponentFontName(fontNameID));</span>
<span class="nc" id="L1048">                    componentFileNames[index] = mapFileName(getComponentFileName(fileNameID));</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">                    if (componentFileNames[index] == null ||</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">                        needToSearchForFile(componentFileNames[index])) {</span>
<span class="nc" id="L1051">                        componentFileNames[index] = getFileNameFromComponentFontName(getComponentFontName(fontNameID));</span>
                    }
<span class="nc bnc" id="L1053" title="All 2 branches missed.">                    if (!sawDefaultFontFile &amp;&amp;</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">                        defaultFontFile.equals(componentFileNames[index])) {</span>
<span class="nc" id="L1055">                        sawDefaultFontFile = true;</span>
                    }
                    /*
                    System.out.println(publicFontNames[fontIndex] + &quot;.&quot; + styleNames[styleIndex] + &quot;.&quot;
                        + getString(table_scriptIDs[coreScripts[index]]) + &quot;=&quot; + componentFileNames[index]);
                    */
                }

                //&quot;Lucida Sans Regular&quot; is not in the list, we add it here
<span class="nc bnc" id="L1064" title="All 2 branches missed.">                if (!sawDefaultFontFile) {</span>
<span class="nc" id="L1065">                    int len = 0;</span>
<span class="nc bnc" id="L1066" title="All 2 branches missed.">                    if (installedFallbackFontFiles != null) {</span>
<span class="nc" id="L1067">                        len = installedFallbackFontFiles.length;</span>
                    }
<span class="nc bnc" id="L1069" title="All 2 branches missed.">                    if (index + len == maxComponentFontCount) {</span>
<span class="nc" id="L1070">                        String[] newComponentFaceNames = new String[maxComponentFontCount + 1];</span>
<span class="nc" id="L1071">                        System.arraycopy(componentFaceNames, 0, newComponentFaceNames, 0, index);</span>
<span class="nc" id="L1072">                        componentFaceNames = newComponentFaceNames;</span>
<span class="nc" id="L1073">                        String[] newComponentFileNames = new String[maxComponentFontCount + 1];</span>
<span class="nc" id="L1074">                        System.arraycopy(componentFileNames, 0, newComponentFileNames, 0, index);</span>
<span class="nc" id="L1075">                        componentFileNames = newComponentFileNames;</span>
                    }
<span class="nc" id="L1077">                    componentFaceNames[index] = defaultFontFaceName;</span>
<span class="nc" id="L1078">                    componentFileNames[index] = defaultFontFile;</span>
<span class="nc" id="L1079">                    index++;</span>
                }

<span class="nc bnc" id="L1082" title="All 2 branches missed.">                if (installedFallbackFontFiles != null) {</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">                    for (int ifb=0; ifb&lt;installedFallbackFontFiles.length; ifb++) {</span>
<span class="nc" id="L1084">                        componentFaceNames[index] = null;</span>
<span class="nc" id="L1085">                        componentFileNames[index] = installedFallbackFontFiles[ifb];</span>
<span class="nc" id="L1086">                        index++;</span>
                    }
                }

<span class="nc bnc" id="L1090" title="All 2 branches missed.">                if (index &lt; maxComponentFontCount) {</span>
<span class="nc" id="L1091">                    String[] newComponentFaceNames = new String[index];</span>
<span class="nc" id="L1092">                    System.arraycopy(componentFaceNames, 0, newComponentFaceNames, 0, index);</span>
<span class="nc" id="L1093">                    componentFaceNames = newComponentFaceNames;</span>
<span class="nc" id="L1094">                    String[] newComponentFileNames = new String[index];</span>
<span class="nc" id="L1095">                    System.arraycopy(componentFileNames, 0, newComponentFileNames, 0, index);</span>
<span class="nc" id="L1096">                    componentFileNames = newComponentFileNames;</span>
                }
                // exclusion range limit array length must match component face name
                // array length - native code relies on this

<span class="nc" id="L1101">                int[] clippedExclusionRangeLimits = exclusionRangeLimits;</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">                if (index != clippedExclusionRangeLimits.length) {</span>
<span class="nc" id="L1103">                    int len = exclusionRangeLimits.length;</span>
<span class="nc" id="L1104">                    clippedExclusionRangeLimits = new int[index];</span>
<span class="nc" id="L1105">                    System.arraycopy(exclusionRangeLimits, 0, clippedExclusionRangeLimits, 0, len);</span>
                    //padding for various fallback fonts
<span class="nc bnc" id="L1107" title="All 2 branches missed.">                    for (int i = len; i &lt; index; i++) {</span>
<span class="nc" id="L1108">                        clippedExclusionRangeLimits[i] = exclusionRanges.length;</span>
                    }
                }
                /*
                System.out.println(faceName + &quot;:&quot;);
                for (int i = 0; i &lt; componentFileNames.length; i++) {
                    System.out.println(&quot;    &quot; + componentFaceNames[i]
                         + &quot;  -&gt; &quot; + componentFileNames[i]);
                }
                */
<span class="nc" id="L1118">                result[fontIndex * NUM_STYLES + styleIndex]</span>
                        = new CompositeFontDescriptor(
                            faceName,
                            compCoreNum[fontIndex],
                            componentFaceNames,
                            componentFileNames,
                            exclusionRanges,
                            clippedExclusionRangeLimits);
            }
        }
<span class="nc" id="L1128">        return result;</span>
    }

    protected abstract String getFaceNameFromComponentFontName(String componentFontName);
    protected abstract String getFileNameFromComponentFontName(String componentFontName);

    /*
    public class 2dFont {
        public String platformName;
        public String fontfileName;
    }
    private 2dFont [] componentFonts = null;
    */

    /* Used on Linux to test if a file referenced in a font configuration
     * file exists in the location that is expected. If it does, no need
     * to search for it. If it doesn't then unless its a fallback font,
     * return that expensive code should be invoked to search for the font.
     */
    HashMap&lt;String, Boolean&gt; existsMap;
    public boolean needToSearchForFile(String fileName) {
<span class="nc bnc" id="L1149" title="All 2 branches missed.">        if (!FontUtilities.isLinux) {</span>
<span class="nc" id="L1150">            return false;</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">        } else if (existsMap == null) {</span>
<span class="nc" id="L1152">           existsMap = new HashMap&lt;String, Boolean&gt;();</span>
        }
<span class="nc" id="L1154">        Boolean exists = existsMap.get(fileName);</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">        if (exists == null) {</span>
            /* call getNumberCoreFonts() to ensure these are initialised, and
             * if this file isn't for a core component, ie, is a for a fallback
             * font which very typically isn't available, then can't afford
             * to take the start-up penalty to search for it.
             */
<span class="nc" id="L1161">            getNumberCoreFonts();</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">            if (!coreFontFileNames.contains(fileName)) {</span>
<span class="nc" id="L1163">                exists = Boolean.TRUE;</span>
            } else {
<span class="nc" id="L1165">                exists = Boolean.valueOf((new File(fileName)).exists());</span>
<span class="nc" id="L1166">                existsMap.put(fileName, exists);</span>
<span class="nc bnc" id="L1167" title="All 4 branches missed.">                if (FontUtilities.debugFonts() &amp;&amp;</span>
                    exists == Boolean.FALSE) {
<span class="nc" id="L1169">                    logger.warning(&quot;Couldn't locate font file &quot; + fileName);</span>
                }
            }
        }
<span class="nc bnc" id="L1173" title="All 2 branches missed.">        return exists == Boolean.FALSE;</span>
    }

<span class="nc" id="L1176">    private int numCoreFonts = -1;</span>
<span class="nc" id="L1177">    private String[] componentFonts = null;</span>
<span class="nc" id="L1178">    HashMap &lt;String, String&gt; filenamesMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1179">    HashSet &lt;String&gt; coreFontFileNames = new HashSet&lt;String&gt;();</span>

    /* Return the number of core fonts. Note this isn't thread safe but
     * a calling thread can call this and getPlatformFontNames() in either
     * order.
     */
    public int getNumberCoreFonts() {
<span class="nc bnc" id="L1186" title="All 2 branches missed.">        if (numCoreFonts == -1) {</span>
<span class="nc" id="L1187">            numCoreFonts = coreFontNameIDs.size();</span>
<span class="nc" id="L1188">            Short[] emptyShortArray = new Short[0];</span>
<span class="nc" id="L1189">            Short[] core = coreFontNameIDs.toArray(emptyShortArray);</span>
<span class="nc" id="L1190">            Short[] fallback = fallbackFontNameIDs.toArray(emptyShortArray);</span>

<span class="nc" id="L1192">            int numFallbackFonts = 0;</span>
            int i;
<span class="nc bnc" id="L1194" title="All 2 branches missed.">            for (i = 0; i &lt; fallback.length; i++) {</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">                if (coreFontNameIDs.contains(fallback[i])) {</span>
<span class="nc" id="L1196">                    fallback[i] = null;</span>
<span class="nc" id="L1197">                    continue;</span>
                }
<span class="nc" id="L1199">                numFallbackFonts++;</span>
            }
<span class="nc" id="L1201">            componentFonts = new String[numCoreFonts + numFallbackFonts];</span>
<span class="nc" id="L1202">            String filename = null;</span>
<span class="nc bnc" id="L1203" title="All 2 branches missed.">            for (i = 0; i &lt; core.length; i++) {</span>
<span class="nc" id="L1204">                short fontid = core[i];</span>
<span class="nc" id="L1205">                short fileid = getComponentFileID(fontid);</span>
<span class="nc" id="L1206">                componentFonts[i] = getComponentFontName(fontid);</span>
<span class="nc" id="L1207">                String compFileName = getComponentFileName(fileid);</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">                if (compFileName != null) {</span>
<span class="nc" id="L1209">                    coreFontFileNames.add(compFileName);</span>
                }
<span class="nc" id="L1211">                filenamesMap.put(componentFonts[i], mapFileName(compFileName));</span>
            }
<span class="nc bnc" id="L1213" title="All 2 branches missed.">            for (int j = 0; j &lt; fallback.length; j++) {</span>
<span class="nc bnc" id="L1214" title="All 2 branches missed.">                if (fallback[j] != null) {</span>
<span class="nc" id="L1215">                    short fontid = fallback[j];</span>
<span class="nc" id="L1216">                    short fileid = getComponentFileID(fontid);</span>
<span class="nc" id="L1217">                    componentFonts[i] = getComponentFontName(fontid);</span>
<span class="nc" id="L1218">                    filenamesMap.put(componentFonts[i],</span>
<span class="nc" id="L1219">                                     mapFileName(getComponentFileName(fileid)));</span>
<span class="nc" id="L1220">                    i++;</span>
                }
            }
        }
<span class="nc" id="L1224">        return numCoreFonts;</span>
    }

    /* Return all platform font names used by this font configuration.
     * The first getNumberCoreFonts() entries are guaranteed to be the
     * core fonts - ie no fall back only fonts.
     */
    public String[] getPlatformFontNames() {
<span class="nc bnc" id="L1232" title="All 2 branches missed.">        if (numCoreFonts == -1) {</span>
<span class="nc" id="L1233">            getNumberCoreFonts();</span>
        }
<span class="nc" id="L1235">        return componentFonts;</span>
    }

    /**
     * Returns a file name for the physical font represented by this platform font name,
     * if the font configuration has such information available, or null if the
     * information is unavailable. The file name returned is just a hint; a null return
     * value doesn't necessarily mean that the font is unavailable, nor does a non-null
     * return value guarantee that the file exists and contains the physical font.
     * The file name can be an absolute or a relative path name.
     */
    public String getFileNameFromPlatformName(String platformName) {
        // get2DCompositeFontInfo
        //     -&gt;  getFileNameFromComponentfontName()  (W/M)
        //       -&gt;   getFileNameFromPlatformName()
        // it's a waste of time on Win32, but I have to give X11 a chance to
        // call getFileNameFromXLFD()
<span class="nc" id="L1252">        return filenamesMap.get(platformName);</span>
    }

    /**
     * Returns a configuration specific path to be appended to the font
     * search path.
     */
    public String getExtraFontPath() {
<span class="nc" id="L1260">        return getString(head[INDEX_appendedfontpath]);</span>
    }

    public String getVersion() {
<span class="nc" id="L1264">        return getString(head[INDEX_version]);</span>
    }

    /* subclass support */
    protected static FontConfiguration getFontConfiguration() {
<span class="nc" id="L1269">        return fontConfig;</span>
    }

    protected void setFontConfiguration() {
<span class="nc" id="L1273">        fontConfig = this;      /* static initialization */</span>
<span class="nc" id="L1274">    }</span>

    //////////////////////////////////////////////////////////////////////
    // FontConfig data tables and the index constants in binary file    //
    //////////////////////////////////////////////////////////////////////
    /* The binary font configuration file begins with a short[] &quot;head&quot;, which
     * contains the offsets to the starts of the individual data table which
     * immediately follow. The current implementation includes the tables shown
     * below.
     *
     * (00) table_scriptIDs    :stringIDs of all defined CharacterSubsetNames
     * (01) table_scriptFonts  :scriptID x fontIndex x styleIndex-&gt;
     *                          PlatformFontNameID mapping. Each scriptID might
     *                          have 1 or 20 entries depends on if it is defined
     *                          via a &quot;allfonts.CharacterSubsetname&quot; or a list of
     *                          &quot;LogicalFontName.StyleName.CharacterSubsetName&quot;
     *                          entries, positive entry means it's a &quot;allfonts&quot;
     *                          entry, a negative value means this is a offset to
     *                          a NUM_FONTS x NUM_STYLES subtable.
     * (02) table_elcIDs       :stringIDs of all defined ELC names, string
     *                          &quot;NULL.NULL.NULL&quot; is used for &quot;default&quot;
     * (03) table_sequences    :elcID x logicalFont -&gt; scriptIDs table defined
     *                          by &quot;sequence.allfonts/LogicalFontName.ELC&quot; in
     *                          font configuration file, each &quot;elcID&quot; has
     *                          NUM_FONTS (5) entries in this table.
     * (04) table_fontfileNameIDs
     *                         :stringIDs of all defined font file names
     * (05) table_componentFontNameIDs
     *                         :stringIDs of all defined PlatformFontNames
     * (06) table_filenames    :platformFontNamesID-&gt;fontfileNameID mapping
     *                          table, the index is the platformFontNamesID.
     * (07) table_awtfontpaths :CharacterSubsetNames-&gt;awtfontpaths mapping table,
     *                          the index is the CharacterSubsetName's stringID
     *                          and content is the stringID of awtfontpath.
     * (08) table_exclusions   :scriptID -&gt; exclusionRanges mapping table,
     *                          the index is the scriptID and the content is
                                a id of an exclusionRanges int[].
     * (09) table_proportionals:list of pairs of PlatformFontNameIDs, stores
     *                          the replacement info defined by &quot;proportional&quot;
     *                          keyword.
     * (10) table_scriptFontsMotif
     *                         :same as (01) except this table stores the
     *                          info defined with &quot;.motif&quot; keyword
     * (11) table_alphabeticSuffix
     *                         :elcID -&gt; stringID of alphabetic/XXXX entries
     * (12) table_stringIDs    :The index of this table is the string ID, the
     *                          content is the &quot;start index&quot; of this string in
     *                          stringTable, use the start index of next entry
     *                          as the &quot;end index&quot;.
     * (13) table_stringTable  :The real storage of all character strings defined
     *                          /used this font configuration, need a pair of
     *                          &quot;start&quot; and &quot;end&quot; indices to access.
     * (14) reserved
     * (15) table_fallbackScripts
     *                         :stringIDs of fallback CharacterSubsetnames, stored
     *                          in the order of they are defined in sequence.fallback.
     * (16) table_appendedfontpath
     *                         :stringtID of the &quot;appendedfontpath&quot; defined.
     * (17) table_version   :stringID of the version number of this fontconfig file.
     */
    private static final int HEAD_LENGTH = 20;
    private static final int INDEX_scriptIDs = 0;
    private static final int INDEX_scriptFonts = 1;
    private static final int INDEX_elcIDs = 2;
    private static final int INDEX_sequences = 3;
    private static final int INDEX_fontfileNameIDs = 4;
    private static final int INDEX_componentFontNameIDs = 5;
    private static final int INDEX_filenames = 6;
    private static final int INDEX_awtfontpaths = 7;
    private static final int INDEX_exclusions = 8;
    private static final int INDEX_proportionals = 9;
    private static final int INDEX_scriptFontsMotif = 10;
    private static final int INDEX_alphabeticSuffix = 11;
    private static final int INDEX_stringIDs = 12;
    private static final int INDEX_stringTable = 13;
    private static final int INDEX_TABLEEND = 14;
    private static final int INDEX_fallbackScripts = 15;
    private static final int INDEX_appendedfontpath = 16;
    private static final int INDEX_version = 17;

    private static short[] head;
    private static short[] table_scriptIDs;
    private static short[] table_scriptFonts;
    private static short[] table_elcIDs;
    private static short[] table_sequences;
    private static short[] table_fontfileNameIDs;
    private static short[] table_componentFontNameIDs;
    private static short[] table_filenames;
    protected static short[] table_awtfontpaths;
    private static short[] table_exclusions;
    private static short[] table_proportionals;
    private static short[] table_scriptFontsMotif;
    private static short[] table_alphabeticSuffix;
    private static short[] table_stringIDs;
    private static char[]  table_stringTable;

    /**
     * Checks consistencies of complied fontconfig data. This method
     * is called only at the build-time from
     * build.tools.compilefontconfig.CompileFontConfig.
     */
    private static void sanityCheck() {
<span class="nc" id="L1376">        int errors = 0;</span>

        //This method will only be called during build time, do we
        //need do PrivilegedAction?
<span class="nc" id="L1380">        String osName = (String)java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L1381">                            new java.security.PrivilegedAction() {</span>
            public Object run() {
<span class="nc" id="L1383">                return System.getProperty(&quot;os.name&quot;);</span>
            }
        });

        //componentFontNameID starts from &quot;1&quot;
<span class="nc bnc" id="L1388" title="All 2 branches missed.">        for (int ii = 1; ii &lt; table_filenames.length; ii++) {</span>
<span class="nc bnc" id="L1389" title="All 2 branches missed.">            if (table_filenames[ii] == -1) {</span>
                // The corresponding finename entry for a component
                // font name is mandatory on Windows, but it's
                // optional on Solaris and Linux.
<span class="nc bnc" id="L1393" title="All 2 branches missed.">                if (osName.contains(&quot;Windows&quot;)) {</span>
<span class="nc" id="L1394">                    System.err.println(&quot;\n Error: &lt;filename.&quot;</span>
<span class="nc" id="L1395">                                       + getString(table_componentFontNameIDs[ii])</span>
                                       + &quot;&gt; entry is missing!!!&quot;);
<span class="nc" id="L1397">                    errors++;</span>
                } else {
<span class="nc bnc" id="L1399" title="All 4 branches missed.">                    if (verbose &amp;&amp; !isEmpty(table_filenames)) {</span>
<span class="nc" id="L1400">                        System.err.println(&quot;\n Note: 'filename' entry is undefined for \&quot;&quot;</span>
<span class="nc" id="L1401">                                           + getString(table_componentFontNameIDs[ii])</span>
                                           + &quot;\&quot;&quot;);
                    }
                }
            }
        }
<span class="nc bnc" id="L1407" title="All 2 branches missed.">        for (int ii = 0; ii &lt; table_scriptIDs.length; ii++) {</span>
<span class="nc" id="L1408">            short fid = table_scriptFonts[ii];</span>
<span class="nc bnc" id="L1409" title="All 2 branches missed.">            if (fid == 0) {</span>
<span class="nc" id="L1410">                System.out.println(&quot;\n Error: &lt;allfonts.&quot;</span>
<span class="nc" id="L1411">                                   + getString(table_scriptIDs[ii])</span>
                                   + &quot;&gt; entry is missing!!!&quot;);
<span class="nc" id="L1413">                errors++;</span>
<span class="nc" id="L1414">                continue;</span>
<span class="nc bnc" id="L1415" title="All 2 branches missed.">            } else if (fid &lt; 0) {</span>
<span class="nc" id="L1416">                fid = (short)-fid;</span>
<span class="nc bnc" id="L1417" title="All 2 branches missed.">                for (int iii = 0; iii &lt; NUM_FONTS; iii++) {</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">                    for (int iij = 0; iij &lt; NUM_STYLES; iij++) {</span>
<span class="nc" id="L1419">                        int jj = iii * NUM_STYLES + iij;</span>
<span class="nc" id="L1420">                        short ffid = table_scriptFonts[fid + jj];</span>
<span class="nc bnc" id="L1421" title="All 2 branches missed.">                        if (ffid == 0) {</span>
<span class="nc" id="L1422">                            System.err.println(&quot;\n Error: &lt;&quot;</span>
<span class="nc" id="L1423">                                           + getFontName(iii) + &quot;.&quot;</span>
<span class="nc" id="L1424">                                           + getStyleName(iij) + &quot;.&quot;</span>
<span class="nc" id="L1425">                                           + getString(table_scriptIDs[ii])</span>
                                           + &quot;&gt; entry is missing!!!&quot;);
<span class="nc" id="L1427">                            errors++;</span>
                        }
                    }
                }
            }
        }
<span class="nc bnc" id="L1433" title="All 2 branches missed.">        if (&quot;SunOS&quot;.equals(osName)) {</span>
<span class="nc bnc" id="L1434" title="All 2 branches missed.">            for (int ii = 0; ii &lt; table_awtfontpaths.length; ii++) {</span>
<span class="nc bnc" id="L1435" title="All 2 branches missed.">                if (table_awtfontpaths[ii] == 0) {</span>
<span class="nc" id="L1436">                    String script = getString(table_scriptIDs[ii]);</span>
<span class="nc bnc" id="L1437" title="All 2 branches missed.">                    if (script.contains(&quot;lucida&quot;) ||</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">                        script.contains(&quot;dingbats&quot;) ||</span>
<span class="nc bnc" id="L1439" title="All 2 branches missed.">                        script.contains(&quot;symbol&quot;)) {</span>
<span class="nc" id="L1440">                        continue;</span>
                    }
<span class="nc" id="L1442">                    System.err.println(&quot;\nError: &quot;</span>
                                       + &quot;&lt;awtfontpath.&quot;
                                       + script
                                       + &quot;&gt; entry is missing!!!&quot;);
<span class="nc" id="L1446">                    errors++;</span>
                }
            }
        }
<span class="nc bnc" id="L1450" title="All 2 branches missed.">        if (errors != 0) {</span>
<span class="nc" id="L1451">            System.err.println(&quot;!!THERE ARE &quot; + errors + &quot; ERROR(S) IN &quot;</span>
                               + &quot;THE FONTCONFIG FILE, PLEASE CHECK ITS CONTENT!!\n&quot;);
<span class="nc" id="L1453">            System.exit(1);</span>
        }
<span class="nc" id="L1455">    }</span>

    private static boolean isEmpty(short[] a) {
<span class="nc bnc" id="L1458" title="All 2 branches missed.">        for (short s : a) {</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">            if (s != -1) {</span>
<span class="nc" id="L1460">                return false;</span>
            }
        }
<span class="nc" id="L1463">        return true;</span>
    }

    //dump the fontconfig data tables
    private static void dump() {
<span class="nc" id="L1468">        System.out.println(&quot;\n----Head Table------------&quot;);</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">        for (int ii = 0; ii &lt; HEAD_LENGTH; ii++) {</span>
<span class="nc" id="L1470">            System.out.println(&quot;  &quot; + ii + &quot; : &quot; + head[ii]);</span>
        }
<span class="nc" id="L1472">        System.out.println(&quot;\n----scriptIDs-------------&quot;);</span>
<span class="nc" id="L1473">        printTable(table_scriptIDs, 0);</span>
<span class="nc" id="L1474">        System.out.println(&quot;\n----scriptFonts----------------&quot;);</span>
<span class="nc bnc" id="L1475" title="All 2 branches missed.">        for (int ii = 0; ii &lt; table_scriptIDs.length; ii++) {</span>
<span class="nc" id="L1476">            short fid = table_scriptFonts[ii];</span>
<span class="nc bnc" id="L1477" title="All 2 branches missed.">            if (fid &gt;= 0) {</span>
<span class="nc" id="L1478">                System.out.println(&quot;  allfonts.&quot;</span>
<span class="nc" id="L1479">                                   + getString(table_scriptIDs[ii])</span>
                                   + &quot;=&quot;
<span class="nc" id="L1481">                                   + getString(table_componentFontNameIDs[fid]));</span>
            }
        }
<span class="nc bnc" id="L1484" title="All 2 branches missed.">        for (int ii = 0; ii &lt; table_scriptIDs.length; ii++) {</span>
<span class="nc" id="L1485">            short fid = table_scriptFonts[ii];</span>
<span class="nc bnc" id="L1486" title="All 2 branches missed.">            if (fid &lt; 0) {</span>
<span class="nc" id="L1487">                fid = (short)-fid;</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">                for (int iii = 0; iii &lt; NUM_FONTS; iii++) {</span>
<span class="nc bnc" id="L1489" title="All 2 branches missed.">                    for (int iij = 0; iij &lt; NUM_STYLES; iij++) {</span>
<span class="nc" id="L1490">                        int jj = iii * NUM_STYLES + iij;</span>
<span class="nc" id="L1491">                        short ffid = table_scriptFonts[fid + jj];</span>
<span class="nc" id="L1492">                        System.out.println(&quot;  &quot;</span>
<span class="nc" id="L1493">                                           + getFontName(iii) + &quot;.&quot;</span>
<span class="nc" id="L1494">                                           + getStyleName(iij) + &quot;.&quot;</span>
<span class="nc" id="L1495">                                           + getString(table_scriptIDs[ii])</span>
                                           + &quot;=&quot;
<span class="nc" id="L1497">                                           + getString(table_componentFontNameIDs[ffid]));</span>
                    }
                }

            }
        }
<span class="nc" id="L1503">        System.out.println(&quot;\n----elcIDs----------------&quot;);</span>
<span class="nc" id="L1504">        printTable(table_elcIDs, 0);</span>
<span class="nc" id="L1505">        System.out.println(&quot;\n----sequences-------------&quot;);</span>
<span class="nc bnc" id="L1506" title="All 2 branches missed.">        for (int ii = 0; ii&lt; table_elcIDs.length; ii++) {</span>
<span class="nc" id="L1507">            System.out.println(&quot;  &quot; + ii + &quot;/&quot; + getString((short)table_elcIDs[ii]));</span>
<span class="nc" id="L1508">            short[] ss = getShortArray(table_sequences[ii * NUM_FONTS + 0]);</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">            for (int jj = 0; jj &lt; ss.length; jj++) {</span>
<span class="nc" id="L1510">                System.out.println(&quot;     &quot; + getString((short)table_scriptIDs[ss[jj]]));</span>
            }
        }
<span class="nc" id="L1513">        System.out.println(&quot;\n----fontfileNameIDs-------&quot;);</span>
<span class="nc" id="L1514">        printTable(table_fontfileNameIDs, 0);</span>

<span class="nc" id="L1516">        System.out.println(&quot;\n----componentFontNameIDs--&quot;);</span>
<span class="nc" id="L1517">        printTable(table_componentFontNameIDs, 1);</span>
<span class="nc" id="L1518">        System.out.println(&quot;\n----filenames-------------&quot;);</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">        for (int ii = 0; ii &lt; table_filenames.length; ii++) {</span>
<span class="nc bnc" id="L1520" title="All 2 branches missed.">            if (table_filenames[ii] == -1) {</span>
<span class="nc" id="L1521">                System.out.println(&quot;  &quot; + ii + &quot; : null&quot;);</span>
            } else {
<span class="nc" id="L1523">                System.out.println(&quot;  &quot; + ii + &quot; : &quot;</span>
<span class="nc" id="L1524">                   + getString(table_fontfileNameIDs[table_filenames[ii]]));</span>
            }
        }
<span class="nc" id="L1527">        System.out.println(&quot;\n----awtfontpaths---------&quot;);</span>
<span class="nc bnc" id="L1528" title="All 2 branches missed.">        for (int ii = 0; ii &lt; table_awtfontpaths.length; ii++) {</span>
<span class="nc" id="L1529">            System.out.println(&quot;  &quot; + getString(table_scriptIDs[ii])</span>
                               + &quot; : &quot;
<span class="nc" id="L1531">                               + getString(table_awtfontpaths[ii]));</span>
        }
<span class="nc" id="L1533">        System.out.println(&quot;\n----proportionals--------&quot;);</span>
<span class="nc bnc" id="L1534" title="All 2 branches missed.">        for (int ii = 0; ii &lt; table_proportionals.length; ii++) {</span>
<span class="nc" id="L1535">            System.out.println(&quot;  &quot;</span>
<span class="nc" id="L1536">                   + getString((short)table_componentFontNameIDs[table_proportionals[ii++]])</span>
                   + &quot; -&gt; &quot;
<span class="nc" id="L1538">                   + getString((short)table_componentFontNameIDs[table_proportionals[ii]]));</span>
        }
<span class="nc" id="L1540">        int i = 0;</span>
<span class="nc" id="L1541">        System.out.println(&quot;\n----alphabeticSuffix----&quot;);</span>
<span class="nc bnc" id="L1542" title="All 2 branches missed.">        while (i &lt; table_alphabeticSuffix.length) {</span>
<span class="nc" id="L1543">          System.out.println(&quot;    &quot; + getString(table_elcIDs[table_alphabeticSuffix[i++]])</span>
<span class="nc" id="L1544">                             + &quot; -&gt; &quot; + getString(table_alphabeticSuffix[i++]));</span>
        }
<span class="nc" id="L1546">        System.out.println(&quot;\n----String Table---------&quot;);</span>
<span class="nc" id="L1547">        System.out.println(&quot;    stringID:    Num =&quot; + table_stringIDs.length);</span>
<span class="nc" id="L1548">        System.out.println(&quot;    stringTable: Size=&quot; + table_stringTable.length * 2);</span>

<span class="nc" id="L1550">        System.out.println(&quot;\n----fallbackScriptIDs---&quot;);</span>
<span class="nc" id="L1551">        short[] fbsIDs = getShortArray(head[INDEX_fallbackScripts]);</span>
<span class="nc bnc" id="L1552" title="All 2 branches missed.">        for (int ii = 0; ii &lt; fbsIDs.length; ii++) {</span>
<span class="nc" id="L1553">          System.out.println(&quot;  &quot; + getString(table_scriptIDs[fbsIDs[ii]]));</span>
        }
<span class="nc" id="L1555">        System.out.println(&quot;\n----appendedfontpath-----&quot;);</span>
<span class="nc" id="L1556">        System.out.println(&quot;  &quot; + getString(head[INDEX_appendedfontpath]));</span>
<span class="nc" id="L1557">        System.out.println(&quot;\n----Version--------------&quot;);</span>
<span class="nc" id="L1558">        System.out.println(&quot;  &quot; + getString(head[INDEX_version]));</span>
<span class="nc" id="L1559">    }</span>


    //////////////////////////////////////////////////////////////////////
    // Data table access methods                                        //
    //////////////////////////////////////////////////////////////////////

    /* Return the fontID of the platformFontName defined in this font config
     * by &quot;LogicalFontName.StyleName.CharacterSubsetName&quot; entry or
     * &quot;allfonts.CharacterSubsetName&quot; entry in properties format fc file.
     */
    protected static short getComponentFontID(short scriptID, int fontIndex, int styleIndex) {
<span class="nc" id="L1571">        short fid = table_scriptFonts[scriptID];</span>
        //System.out.println(&quot;fid=&quot; + fid + &quot;/ scriptID=&quot; + scriptID + &quot;, fi=&quot; + fontIndex + &quot;, si=&quot; + styleIndex);
<span class="nc bnc" id="L1573" title="All 2 branches missed.">        if (fid &gt;= 0) {</span>
            //&quot;allfonts&quot;
<span class="nc" id="L1575">            return fid;</span>
        } else {
<span class="nc" id="L1577">            return table_scriptFonts[-fid + fontIndex * NUM_STYLES + styleIndex];</span>
        }
    }

    /* Same as getCompoentFontID() except this method returns the fontID define by
     * &quot;xxxx.motif&quot; entry.
     */
    protected static short getComponentFontIDMotif(short scriptID, int fontIndex, int styleIndex) {
<span class="nc bnc" id="L1585" title="All 2 branches missed.">        if (table_scriptFontsMotif.length == 0) {</span>
<span class="nc" id="L1586">            return 0;</span>
        }
<span class="nc" id="L1588">        short fid = table_scriptFontsMotif[scriptID];</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">        if (fid &gt;= 0) {</span>
            //&quot;allfonts&quot; &gt; 0 or &quot;not defined&quot; == 0
<span class="nc" id="L1591">            return fid;</span>
        } else {
<span class="nc" id="L1593">            return table_scriptFontsMotif[-fid + fontIndex * NUM_STYLES + styleIndex];</span>
        }
    }

    private static int[] getExclusionRanges(short scriptID) {
<span class="nc" id="L1598">        short exID = table_exclusions[scriptID];</span>
<span class="nc bnc" id="L1599" title="All 2 branches missed.">        if (exID == 0) {</span>
<span class="nc" id="L1600">            return EMPTY_INT_ARRAY;</span>
        } else {
<span class="nc" id="L1602">            char[] exChar = getString(exID).toCharArray();</span>
<span class="nc" id="L1603">            int[] exInt = new int[exChar.length / 2];</span>
<span class="nc" id="L1604">            int i = 0;</span>
<span class="nc bnc" id="L1605" title="All 2 branches missed.">            for (int j = 0; j &lt; exInt.length; j++) {</span>
<span class="nc" id="L1606">                exInt[j] = (exChar[i++] &lt;&lt; 16) + (exChar[i++] &amp; 0xffff);</span>
            }
<span class="nc" id="L1608">            return exInt;</span>
        }
    }

    private static boolean contains(short IDs[], short id, int limit) {
<span class="nc bnc" id="L1613" title="All 2 branches missed.">        for (int i = 0; i &lt; limit; i++) {</span>
<span class="nc bnc" id="L1614" title="All 2 branches missed.">            if (IDs[i] == id) {</span>
<span class="nc" id="L1615">                return true;</span>
            }
        }
<span class="nc" id="L1618">        return false;</span>
    }

    /* Return the PlatformFontName from its fontID*/
    protected static String getComponentFontName(short id) {
<span class="nc bnc" id="L1623" title="All 2 branches missed.">        if (id &lt; 0) {</span>
<span class="nc" id="L1624">            return null;</span>
        }
<span class="nc" id="L1626">        return getString(table_componentFontNameIDs[id]);</span>
    }

    private static String getComponentFileName(short id) {
<span class="nc bnc" id="L1630" title="All 2 branches missed.">        if (id &lt; 0) {</span>
<span class="nc" id="L1631">            return null;</span>
        }
<span class="nc" id="L1633">        return getString(table_fontfileNameIDs[id]);</span>
    }

    //componentFontID -&gt; componentFileID
    private static short getComponentFileID(short nameID) {
<span class="nc" id="L1638">        return table_filenames[nameID];</span>
    }

    private static String getScriptName(short scriptID) {
<span class="nc" id="L1642">        return getString(table_scriptIDs[scriptID]);</span>
    }

   private HashMap&lt;String, Short&gt; reorderScripts;
   protected short[] getCoreScripts(int fontIndex) {
<span class="nc" id="L1647">        short elc = getInitELC();</span>
        /*
          System.out.println(&quot;getCoreScripts: elc=&quot; + elc + &quot;, fontIndex=&quot; + fontIndex);
          short[] ss = getShortArray(table_sequences[elc * NUM_FONTS + fontIndex]);
          for (int i = 0; i &lt; ss.length; i++) {
              System.out.println(&quot;     &quot; + getString((short)table_scriptIDs[ss[i]]));
          }
          */
<span class="nc" id="L1655">        short[] scripts = getShortArray(table_sequences[elc * NUM_FONTS + fontIndex]);</span>
<span class="nc bnc" id="L1656" title="All 2 branches missed.">        if (preferLocaleFonts) {</span>
<span class="nc bnc" id="L1657" title="All 2 branches missed.">            if (reorderScripts == null) {</span>
<span class="nc" id="L1658">                reorderScripts = new HashMap&lt;String, Short&gt;();</span>
            }
<span class="nc" id="L1660">            String[] ss = new String[scripts.length];</span>
<span class="nc bnc" id="L1661" title="All 2 branches missed.">            for (int i = 0; i &lt; ss.length; i++) {</span>
<span class="nc" id="L1662">                ss[i] = getScriptName(scripts[i]);</span>
<span class="nc" id="L1663">                reorderScripts.put(ss[i], scripts[i]);</span>
            }
<span class="nc" id="L1665">            reorderSequenceForLocale(ss);</span>
<span class="nc bnc" id="L1666" title="All 2 branches missed.">            for (int i = 0; i &lt; ss.length; i++) {</span>
<span class="nc" id="L1667">                scripts[i] = reorderScripts.get(ss[i]);</span>
            }
        }
<span class="nc" id="L1670">         return scripts;</span>
    }

    private static short[] getFallbackScripts() {
<span class="nc" id="L1674">        return getShortArray(head[INDEX_fallbackScripts]);</span>
    }

    private static void printTable(short[] list, int start) {
<span class="nc bnc" id="L1678" title="All 2 branches missed.">        for (int i = start; i &lt; list.length; i++) {</span>
<span class="nc" id="L1679">            System.out.println(&quot;  &quot; + i + &quot; : &quot; + getString(list[i]));</span>
        }
<span class="nc" id="L1681">    }</span>

    private static short[] readShortTable(DataInputStream in, int len )
        throws IOException {
<span class="nc bnc" id="L1685" title="All 2 branches missed.">        if (len == 0) {</span>
<span class="nc" id="L1686">            return EMPTY_SHORT_ARRAY;</span>
        }
<span class="nc" id="L1688">        short[] data = new short[len];</span>
<span class="nc" id="L1689">        byte[] bb = new byte[len * 2];</span>
<span class="nc" id="L1690">        in.read(bb);</span>
<span class="nc" id="L1691">        int i = 0,j = 0;</span>
<span class="nc bnc" id="L1692" title="All 2 branches missed.">        while (i &lt; len) {</span>
<span class="nc" id="L1693">            data[i++] = (short)(bb[j++] &lt;&lt; 8 | (bb[j++] &amp; 0xff));</span>
        }
<span class="nc" id="L1695">        return data;</span>
    }

    private static void writeShortTable(DataOutputStream out, short[] data)
        throws IOException {
<span class="nc bnc" id="L1700" title="All 2 branches missed.">        for (short val : data) {</span>
<span class="nc" id="L1701">            out.writeShort(val);</span>
        }
<span class="nc" id="L1703">    }</span>

    private static short[] toList(HashMap&lt;String, Short&gt; map) {
<span class="nc" id="L1706">        short[] list = new short[map.size()];</span>
<span class="nc" id="L1707">        Arrays.fill(list, (short) -1);</span>
<span class="nc bnc" id="L1708" title="All 2 branches missed.">        for (Entry&lt;String, Short&gt; entry : map.entrySet()) {</span>
<span class="nc" id="L1709">            list[entry.getValue()] = getStringID(entry.getKey());</span>
<span class="nc" id="L1710">        }</span>
<span class="nc" id="L1711">        return list;</span>
    }

    //runtime cache
    private static String[] stringCache;
    protected static String getString(short stringID) {
<span class="nc bnc" id="L1717" title="All 2 branches missed.">        if (stringID == 0)</span>
<span class="nc" id="L1718">            return null;</span>
        /*
        if (loadingProperties) {
            return stringTable.substring(stringIDs[stringID],
                                         stringIDs[stringID+1]);
        }
        */
        //sync if we want it to be MT-enabled
<span class="nc bnc" id="L1726" title="All 2 branches missed.">        if (stringCache[stringID] == null){</span>
<span class="nc" id="L1727">            stringCache[stringID] =</span>
              new String (table_stringTable,
                          table_stringIDs[stringID],
                          table_stringIDs[stringID+1] - table_stringIDs[stringID]);
        }
<span class="nc" id="L1732">        return stringCache[stringID];</span>
    }

    private static short[] getShortArray(short shortArrayID) {
<span class="nc" id="L1736">        String s = getString(shortArrayID);</span>
<span class="nc" id="L1737">        char[] cc = s.toCharArray();</span>
<span class="nc" id="L1738">        short[] ss = new short[cc.length];</span>
<span class="nc bnc" id="L1739" title="All 2 branches missed.">        for (int i = 0; i &lt; cc.length; i++) {</span>
<span class="nc" id="L1740">            ss[i] = (short)(cc[i] &amp; 0xffff);</span>
        }
<span class="nc" id="L1742">        return ss;</span>
    }

    private static short getStringID(String s) {
<span class="nc bnc" id="L1746" title="All 2 branches missed.">        if (s == null) {</span>
<span class="nc" id="L1747">            return (short)0;</span>
        }
<span class="nc" id="L1749">        short pos0 = (short)stringTable.length();</span>
<span class="nc" id="L1750">        stringTable.append(s);</span>
<span class="nc" id="L1751">        short pos1 = (short)stringTable.length();</span>

<span class="nc" id="L1753">        stringIDs[stringIDNum] = pos0;</span>
<span class="nc" id="L1754">        stringIDs[stringIDNum + 1] = pos1;</span>
<span class="nc" id="L1755">        stringIDNum++;</span>
<span class="nc bnc" id="L1756" title="All 2 branches missed.">        if (stringIDNum + 1 &gt;= stringIDs.length) {</span>
<span class="nc" id="L1757">            short[] tmp = new short[stringIDNum + 1000];</span>
<span class="nc" id="L1758">            System.arraycopy(stringIDs, 0, tmp, 0, stringIDNum);</span>
<span class="nc" id="L1759">            stringIDs = tmp;</span>
        }
<span class="nc" id="L1761">        return (short)(stringIDNum - 1);</span>
    }

    private static short getShortArrayID(short sa[]) {
<span class="nc" id="L1765">        char[] cc = new char[sa.length];</span>
<span class="nc bnc" id="L1766" title="All 2 branches missed.">        for (int i = 0; i &lt; sa.length; i ++) {</span>
<span class="nc" id="L1767">            cc[i] = (char)sa[i];</span>
        }
<span class="nc" id="L1769">        String s = new String(cc);</span>
<span class="nc" id="L1770">        return getStringID(s);</span>
    }

    //utility &quot;empty&quot; objects
<span class="nc" id="L1774">    private static final int[] EMPTY_INT_ARRAY = new int[0];</span>
<span class="nc" id="L1775">    private static final String[] EMPTY_STRING_ARRAY = new String[0];</span>
<span class="nc" id="L1776">    private static final short[] EMPTY_SHORT_ARRAY = new short[0];</span>
    private static final String UNDEFINED_COMPONENT_FONT = &quot;unknown&quot;;

    //////////////////////////////////////////////////////////////////////////
    //Convert the FontConfig data in Properties file to binary data tables  //
    //////////////////////////////////////////////////////////////////////////
<span class="nc" id="L1782">    static class PropertiesHandler {</span>
        public void load(InputStream in) throws IOException {
<span class="nc" id="L1784">            initLogicalNameStyle();</span>
<span class="nc" id="L1785">            initHashMaps();</span>
<span class="nc" id="L1786">            FontProperties fp = new FontProperties();</span>
<span class="nc" id="L1787">            fp.load(in);</span>
<span class="nc" id="L1788">            initBinaryTable();</span>
<span class="nc" id="L1789">        }</span>

        private void initBinaryTable() {
            //(0)
<span class="nc" id="L1793">            head = new short[HEAD_LENGTH];</span>
<span class="nc" id="L1794">            head[INDEX_scriptIDs] = (short)HEAD_LENGTH;</span>

<span class="nc" id="L1796">            table_scriptIDs = toList(scriptIDs);</span>
            //(1)a: scriptAllfonts scriptID/allfonts -&gt; componentFontNameID
            //   b: scriptFonts    scriptID -&gt; componentFontNameID[20]
            //if we have a &quot;allfonts.script&quot; def, then we just put
            //the &quot;-platformFontID&quot; value in the slot, otherwise the slot
            //value is &quot;offset&quot; which &quot;offset&quot; is where 20 entries located
            //in the table attached.
<span class="nc" id="L1803">            head[INDEX_scriptFonts] = (short)(head[INDEX_scriptIDs]  + table_scriptIDs.length);</span>
<span class="nc" id="L1804">            int len = table_scriptIDs.length + scriptFonts.size() * 20;</span>
<span class="nc" id="L1805">            table_scriptFonts = new short[len];</span>

<span class="nc bnc" id="L1807" title="All 2 branches missed.">            for (Entry&lt;Short, Short&gt; entry : scriptAllfonts.entrySet()) {</span>
<span class="nc" id="L1808">                table_scriptFonts[entry.getKey().intValue()] = entry.getValue();</span>
<span class="nc" id="L1809">            }</span>
<span class="nc" id="L1810">            int off = table_scriptIDs.length;</span>
<span class="nc bnc" id="L1811" title="All 2 branches missed.">            for (Entry&lt;Short, Short[]&gt; entry : scriptFonts.entrySet()) {</span>
<span class="nc" id="L1812">                table_scriptFonts[entry.getKey().intValue()] = (short)-off;</span>
<span class="nc" id="L1813">                Short[] v = entry.getValue();</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">                for (int i = 0; i &lt; 20; i++) {</span>
<span class="nc bnc" id="L1815" title="All 2 branches missed.">                    if (v[i] != null) {</span>
<span class="nc" id="L1816">                        table_scriptFonts[off++] = v[i];</span>
                    } else {
<span class="nc" id="L1818">                        table_scriptFonts[off++] = 0;</span>
                    }
                }
<span class="nc" id="L1821">            }</span>

            //(2)
<span class="nc" id="L1824">            head[INDEX_elcIDs] = (short)(head[INDEX_scriptFonts]  + table_scriptFonts.length);</span>
<span class="nc" id="L1825">            table_elcIDs = toList(elcIDs);</span>

            //(3) sequences  elcID -&gt; XXXX[1|5] -&gt; scriptID[]
<span class="nc" id="L1828">            head[INDEX_sequences] = (short)(head[INDEX_elcIDs]  + table_elcIDs.length);</span>
<span class="nc" id="L1829">            table_sequences = new short[elcIDs.size() * NUM_FONTS];</span>
<span class="nc bnc" id="L1830" title="All 2 branches missed.">            for (Entry&lt;Short, short[]&gt; entry : sequences.entrySet()) {</span>
                //table_sequences[entry.getKey().intValue()] = (short)-off;
<span class="nc" id="L1832">                int k = entry.getKey().intValue();</span>
<span class="nc" id="L1833">                short[] v = entry.getValue();</span>
                /*
                  System.out.println(&quot;elc=&quot; + k + &quot;/&quot; + getString((short)table_elcIDs[k]));
                  short[] ss = getShortArray(v[0]);
                  for (int i = 0; i &lt; ss.length; i++) {
                  System.out.println(&quot;     &quot; + getString((short)table_scriptIDs[ss[i]]));
                  }
                  */
<span class="nc bnc" id="L1841" title="All 2 branches missed.">                if (v.length == 1) {</span>
                    //the &quot;allfonts&quot; entries
<span class="nc bnc" id="L1843" title="All 2 branches missed.">                    for (int i = 0; i &lt; NUM_FONTS; i++) {</span>
<span class="nc" id="L1844">                        table_sequences[k * NUM_FONTS + i] = v[0];</span>
                    }
                } else {
<span class="nc bnc" id="L1847" title="All 2 branches missed.">                    for (int i = 0; i &lt; NUM_FONTS; i++) {</span>
<span class="nc" id="L1848">                        table_sequences[k * NUM_FONTS + i] = v[i];</span>
                    }
                }
<span class="nc" id="L1851">            }</span>
            //(4)
<span class="nc" id="L1853">            head[INDEX_fontfileNameIDs] = (short)(head[INDEX_sequences]  + table_sequences.length);</span>
<span class="nc" id="L1854">            table_fontfileNameIDs = toList(fontfileNameIDs);</span>

            //(5)
<span class="nc" id="L1857">            head[INDEX_componentFontNameIDs] = (short)(head[INDEX_fontfileNameIDs]  + table_fontfileNameIDs.length);</span>
<span class="nc" id="L1858">            table_componentFontNameIDs = toList(componentFontNameIDs);</span>

            //(6)componentFontNameID -&gt; filenameID
<span class="nc" id="L1861">            head[INDEX_filenames] = (short)(head[INDEX_componentFontNameIDs]  + table_componentFontNameIDs.length);</span>
<span class="nc" id="L1862">            table_filenames = new short[table_componentFontNameIDs.length];</span>
<span class="nc" id="L1863">            Arrays.fill(table_filenames, (short) -1);</span>

<span class="nc bnc" id="L1865" title="All 2 branches missed.">            for (Entry&lt;Short, Short&gt; entry : filenames.entrySet()) {</span>
<span class="nc" id="L1866">                table_filenames[entry.getKey()] = entry.getValue();</span>
<span class="nc" id="L1867">            }</span>

            //(7)scriptID-&gt; awtfontpath
            //the paths are stored as scriptID -&gt; stringID in awtfontpahts
<span class="nc" id="L1871">            head[INDEX_awtfontpaths] = (short)(head[INDEX_filenames]  + table_filenames.length);</span>
<span class="nc" id="L1872">            table_awtfontpaths = new short[table_scriptIDs.length];</span>
<span class="nc bnc" id="L1873" title="All 2 branches missed.">            for (Entry&lt;Short, Short&gt; entry : awtfontpaths.entrySet()) {</span>
<span class="nc" id="L1874">                table_awtfontpaths[entry.getKey()] = entry.getValue();</span>
<span class="nc" id="L1875">            }</span>

            //(8)exclusions
<span class="nc" id="L1878">            head[INDEX_exclusions] = (short)(head[INDEX_awtfontpaths]  + table_awtfontpaths.length);</span>
<span class="nc" id="L1879">            table_exclusions = new short[scriptIDs.size()];</span>
<span class="nc bnc" id="L1880" title="All 2 branches missed.">            for (Entry&lt;Short, int[]&gt; entry : exclusions.entrySet()) {</span>
<span class="nc" id="L1881">                int[] exI = entry.getValue();</span>
<span class="nc" id="L1882">                char[] exC = new char[exI.length * 2];</span>
<span class="nc" id="L1883">                int j = 0;</span>
<span class="nc bnc" id="L1884" title="All 2 branches missed.">                for (int i = 0; i &lt; exI.length; i++) {</span>
<span class="nc" id="L1885">                    exC[j++] = (char) (exI[i] &gt;&gt; 16);</span>
<span class="nc" id="L1886">                    exC[j++] = (char) (exI[i] &amp; 0xffff);</span>
                }
<span class="nc" id="L1888">                table_exclusions[entry.getKey()] = getStringID(new String (exC));</span>
<span class="nc" id="L1889">            }</span>
            //(9)proportionals
<span class="nc" id="L1891">            head[INDEX_proportionals] = (short)(head[INDEX_exclusions]  + table_exclusions.length);</span>
<span class="nc" id="L1892">            table_proportionals = new short[proportionals.size() * 2];</span>
<span class="nc" id="L1893">            int j = 0;</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">            for (Entry&lt;Short, Short&gt; entry : proportionals.entrySet()) {</span>
<span class="nc" id="L1895">                table_proportionals[j++] = entry.getKey();</span>
<span class="nc" id="L1896">                table_proportionals[j++] = entry.getValue();</span>
<span class="nc" id="L1897">            }</span>

            //(10) see (1) for info, the only difference is &quot;xxx.motif&quot;
<span class="nc" id="L1900">            head[INDEX_scriptFontsMotif] = (short)(head[INDEX_proportionals] + table_proportionals.length);</span>
<span class="nc bnc" id="L1901" title="All 4 branches missed.">            if (scriptAllfontsMotif.size() != 0 || scriptFontsMotif.size() != 0) {</span>
<span class="nc" id="L1902">                len = table_scriptIDs.length + scriptFontsMotif.size() * 20;</span>
<span class="nc" id="L1903">                table_scriptFontsMotif = new short[len];</span>

<span class="nc bnc" id="L1905" title="All 2 branches missed.">                for (Entry&lt;Short, Short&gt; entry : scriptAllfontsMotif.entrySet()) {</span>
<span class="nc" id="L1906">                    table_scriptFontsMotif[entry.getKey().intValue()] =</span>
<span class="nc" id="L1907">                      (short)entry.getValue();</span>
<span class="nc" id="L1908">                }</span>
<span class="nc" id="L1909">                off = table_scriptIDs.length;</span>
<span class="nc bnc" id="L1910" title="All 2 branches missed.">                for (Entry&lt;Short, Short[]&gt; entry : scriptFontsMotif.entrySet()) {</span>
<span class="nc" id="L1911">                    table_scriptFontsMotif[entry.getKey().intValue()] = (short)-off;</span>
<span class="nc" id="L1912">                    Short[] v = entry.getValue();</span>
<span class="nc" id="L1913">                    int i = 0;</span>
<span class="nc bnc" id="L1914" title="All 2 branches missed.">                    while (i &lt; 20) {</span>
<span class="nc bnc" id="L1915" title="All 2 branches missed.">                        if (v[i] != null) {</span>
<span class="nc" id="L1916">                            table_scriptFontsMotif[off++] = v[i];</span>
                        } else {
<span class="nc" id="L1918">                            table_scriptFontsMotif[off++] = 0;</span>
                        }
<span class="nc" id="L1920">                        i++;</span>
                    }
<span class="nc" id="L1922">                }</span>
            } else {
<span class="nc" id="L1924">                table_scriptFontsMotif = EMPTY_SHORT_ARRAY;</span>
            }

            //(11)short[] alphabeticSuffix
<span class="nc" id="L1928">            head[INDEX_alphabeticSuffix] = (short)(head[INDEX_scriptFontsMotif] + table_scriptFontsMotif.length);</span>
<span class="nc" id="L1929">            table_alphabeticSuffix = new short[alphabeticSuffix.size() * 2];</span>
<span class="nc" id="L1930">            j = 0;</span>
<span class="nc bnc" id="L1931" title="All 2 branches missed.">            for (Entry&lt;Short, Short&gt; entry : alphabeticSuffix.entrySet()) {</span>
<span class="nc" id="L1932">                table_alphabeticSuffix[j++] = entry.getKey();</span>
<span class="nc" id="L1933">                table_alphabeticSuffix[j++] = entry.getValue();</span>
<span class="nc" id="L1934">            }</span>

            //(15)short[] fallbackScriptIDs; just put the ID in head
<span class="nc" id="L1937">            head[INDEX_fallbackScripts] = getShortArrayID(fallbackScriptIDs);</span>

            //(16)appendedfontpath
<span class="nc" id="L1940">            head[INDEX_appendedfontpath] = getStringID(appendedfontpath);</span>

            //(17)version
<span class="nc" id="L1943">            head[INDEX_version] = getStringID(version);</span>

            //(12)short[] StringIDs
<span class="nc" id="L1946">            head[INDEX_stringIDs] = (short)(head[INDEX_alphabeticSuffix] + table_alphabeticSuffix.length);</span>
<span class="nc" id="L1947">            table_stringIDs = new short[stringIDNum + 1];</span>
<span class="nc" id="L1948">            System.arraycopy(stringIDs, 0, table_stringIDs, 0, stringIDNum + 1);</span>

            //(13)StringTable
<span class="nc" id="L1951">            head[INDEX_stringTable] = (short)(head[INDEX_stringIDs] + stringIDNum + 1);</span>
<span class="nc" id="L1952">            table_stringTable = stringTable.toString().toCharArray();</span>
            //(14)
<span class="nc" id="L1954">            head[INDEX_TABLEEND] = (short)(head[INDEX_stringTable] + stringTable.length());</span>

            //StringTable cache
<span class="nc" id="L1957">            stringCache = new String[table_stringIDs.length];</span>
<span class="nc" id="L1958">        }</span>

        //////////////////////////////////////////////
        private HashMap&lt;String, Short&gt; scriptIDs;
        //elc -&gt; Encoding.Language.Country
        private HashMap&lt;String, Short&gt; elcIDs;
        //componentFontNameID starts from &quot;1&quot;, &quot;0&quot; reserves for &quot;undefined&quot;
        private HashMap&lt;String, Short&gt; componentFontNameIDs;
        private HashMap&lt;String, Short&gt; fontfileNameIDs;
        private HashMap&lt;String, Integer&gt; logicalFontIDs;
        private HashMap&lt;String, Integer&gt; fontStyleIDs;

        //componentFontNameID -&gt; fontfileNameID
        private HashMap&lt;Short, Short&gt;  filenames;

        //elcID -&gt; allfonts/logicalFont -&gt; scriptID list
        //(1)if we have a &quot;allfonts&quot;, then the length of the
        //   value array is &quot;1&quot;, otherwise it's 5, each font
        //   must have their own individual entry.
        //scriptID list &quot;short[]&quot; is stored as an ID
        private HashMap&lt;Short, short[]&gt; sequences;

        //scriptID -&gt;logicFontID/fontStyleID-&gt;componentFontNameID,
        //a 20-entry array (5-name x 4-style) for each script
        private HashMap&lt;Short, Short[]&gt; scriptFonts;

        //scriptID -&gt; componentFontNameID
        private HashMap&lt;Short, Short&gt; scriptAllfonts;

        //scriptID -&gt; exclusionRanges[]
        private HashMap&lt;Short, int[]&gt; exclusions;

        //scriptID -&gt; fontpath
        private HashMap&lt;Short, Short&gt; awtfontpaths;

        //fontID -&gt; fontID
        private HashMap&lt;Short, Short&gt; proportionals;

        //scriptID -&gt; componentFontNameID
        private HashMap&lt;Short, Short&gt; scriptAllfontsMotif;

        //scriptID -&gt;logicFontID/fontStyleID-&gt;componentFontNameID,
        private HashMap&lt;Short, Short[]&gt; scriptFontsMotif;

        //elcID -&gt; stringID of alphabetic/XXXX
        private HashMap&lt;Short, Short&gt; alphabeticSuffix;

        private short[] fallbackScriptIDs;
        private String version;
        private String appendedfontpath;

        private void initLogicalNameStyle() {
<span class="nc" id="L2010">            logicalFontIDs = new HashMap&lt;String, Integer&gt;();</span>
<span class="nc" id="L2011">            fontStyleIDs = new HashMap&lt;String, Integer&gt;();</span>
<span class="nc" id="L2012">            logicalFontIDs.put(&quot;serif&quot;,      0);</span>
<span class="nc" id="L2013">            logicalFontIDs.put(&quot;sansserif&quot;,  1);</span>
<span class="nc" id="L2014">            logicalFontIDs.put(&quot;monospaced&quot;, 2);</span>
<span class="nc" id="L2015">            logicalFontIDs.put(&quot;dialog&quot;,     3);</span>
<span class="nc" id="L2016">            logicalFontIDs.put(&quot;dialoginput&quot;,4);</span>
<span class="nc" id="L2017">            fontStyleIDs.put(&quot;plain&quot;,      0);</span>
<span class="nc" id="L2018">            fontStyleIDs.put(&quot;bold&quot;,       1);</span>
<span class="nc" id="L2019">            fontStyleIDs.put(&quot;italic&quot;,     2);</span>
<span class="nc" id="L2020">            fontStyleIDs.put(&quot;bolditalic&quot;, 3);</span>
<span class="nc" id="L2021">        }</span>

        private void initHashMaps() {
<span class="nc" id="L2024">            scriptIDs = new HashMap&lt;String, Short&gt;();</span>
<span class="nc" id="L2025">            elcIDs = new HashMap&lt;String, Short&gt;();</span>
<span class="nc" id="L2026">            componentFontNameIDs = new HashMap&lt;String, Short&gt;();</span>
            /*Init these tables to allow componentFontNameID, fontfileNameIDs
              to start from &quot;1&quot;.
            */
<span class="nc" id="L2030">            componentFontNameIDs.put(&quot;&quot;, Short.valueOf((short)0));</span>

<span class="nc" id="L2032">            fontfileNameIDs = new HashMap&lt;String, Short&gt;();</span>
<span class="nc" id="L2033">            filenames = new HashMap&lt;Short, Short&gt;();</span>
<span class="nc" id="L2034">            sequences = new HashMap&lt;Short, short[]&gt;();</span>
<span class="nc" id="L2035">            scriptFonts = new HashMap&lt;Short, Short[]&gt;();</span>
<span class="nc" id="L2036">            scriptAllfonts = new HashMap&lt;Short, Short&gt;();</span>
<span class="nc" id="L2037">            exclusions = new HashMap&lt;Short, int[]&gt;();</span>
<span class="nc" id="L2038">            awtfontpaths = new HashMap&lt;Short, Short&gt;();</span>
<span class="nc" id="L2039">            proportionals = new HashMap&lt;Short, Short&gt;();</span>
<span class="nc" id="L2040">            scriptFontsMotif = new HashMap&lt;Short, Short[]&gt;();</span>
<span class="nc" id="L2041">            scriptAllfontsMotif = new HashMap&lt;Short, Short&gt;();</span>
<span class="nc" id="L2042">            alphabeticSuffix = new HashMap&lt;Short, Short&gt;();</span>
<span class="nc" id="L2043">            fallbackScriptIDs = EMPTY_SHORT_ARRAY;</span>
            /*
              version
              appendedfontpath
            */
<span class="nc" id="L2048">        }</span>

        private int[] parseExclusions(String key, String exclusions) {
<span class="nc bnc" id="L2051" title="All 2 branches missed.">            if (exclusions == null) {</span>
<span class="nc" id="L2052">                return EMPTY_INT_ARRAY;</span>
            }
            // range format is xxxx-XXXX,yyyyyy-YYYYYY,.....
<span class="nc" id="L2055">            int numExclusions = 1;</span>
<span class="nc" id="L2056">            int pos = 0;</span>
<span class="nc bnc" id="L2057" title="All 2 branches missed.">            while ((pos = exclusions.indexOf(',', pos)) != -1) {</span>
<span class="nc" id="L2058">                numExclusions++;</span>
<span class="nc" id="L2059">                pos++;</span>
            }
<span class="nc" id="L2061">            int[] exclusionRanges = new int[numExclusions * 2];</span>
<span class="nc" id="L2062">            pos = 0;</span>
<span class="nc" id="L2063">            int newPos = 0;</span>
<span class="nc bnc" id="L2064" title="All 2 branches missed.">            for (int j = 0; j &lt; numExclusions * 2; ) {</span>
                String lower, upper;
<span class="nc" id="L2066">                int lo = 0, up = 0;</span>
                try {
<span class="nc" id="L2068">                    newPos = exclusions.indexOf('-', pos);</span>
<span class="nc" id="L2069">                    lower = exclusions.substring(pos, newPos);</span>
<span class="nc" id="L2070">                    pos = newPos + 1;</span>
<span class="nc" id="L2071">                    newPos = exclusions.indexOf(',', pos);</span>
<span class="nc bnc" id="L2072" title="All 2 branches missed.">                    if (newPos == -1) {</span>
<span class="nc" id="L2073">                        newPos = exclusions.length();</span>
                    }
<span class="nc" id="L2075">                    upper = exclusions.substring(pos, newPos);</span>
<span class="nc" id="L2076">                    pos = newPos + 1;</span>
<span class="nc" id="L2077">                    int lowerLength = lower.length();</span>
<span class="nc" id="L2078">                    int upperLength = upper.length();</span>
<span class="nc bnc" id="L2079" title="All 8 branches missed.">                    if (lowerLength != 4 &amp;&amp; lowerLength != 6</span>
                        || upperLength != 4 &amp;&amp; upperLength != 6) {
<span class="nc" id="L2081">                        throw new Exception();</span>
                    }
<span class="nc" id="L2083">                    lo = Integer.parseInt(lower, 16);</span>
<span class="nc" id="L2084">                    up = Integer.parseInt(upper, 16);</span>
<span class="nc bnc" id="L2085" title="All 2 branches missed.">                    if (lo &gt; up) {</span>
<span class="nc" id="L2086">                        throw new Exception();</span>
                    }
<span class="nc" id="L2088">                } catch (Exception e) {</span>
<span class="nc bnc" id="L2089" title="All 2 branches missed.">                    if (FontUtilities.debugFonts() &amp;&amp;</span>
<span class="nc bnc" id="L2090" title="All 2 branches missed.">                        logger != null) {</span>
<span class="nc" id="L2091">                        logger.config(&quot;Failed parsing &quot; + key +</span>
                                  &quot; property of font configuration.&quot;);

                    }
<span class="nc" id="L2095">                    return EMPTY_INT_ARRAY;</span>
<span class="nc" id="L2096">                }</span>
<span class="nc" id="L2097">                exclusionRanges[j++] = lo;</span>
<span class="nc" id="L2098">                exclusionRanges[j++] = up;</span>
<span class="nc" id="L2099">            }</span>
<span class="nc" id="L2100">            return exclusionRanges;</span>
        }

        private Short getID(HashMap&lt;String, Short&gt; map, String key) {
<span class="nc" id="L2104">            Short ret = map.get(key);</span>
<span class="nc bnc" id="L2105" title="All 2 branches missed.">            if ( ret == null) {</span>
<span class="nc" id="L2106">                map.put(key, (short)map.size());</span>
<span class="nc" id="L2107">                return map.get(key);</span>
            }
<span class="nc" id="L2109">            return ret;</span>
        }

<span class="nc" id="L2112">        class FontProperties extends Properties {</span>
            public synchronized Object put(Object k, Object v) {
<span class="nc" id="L2114">                parseProperty((String)k, (String)v);</span>
<span class="nc" id="L2115">                return null;</span>
            }
        }

        private void parseProperty(String key, String value) {
<span class="nc bnc" id="L2120" title="All 2 branches missed.">            if (key.startsWith(&quot;filename.&quot;)) {</span>
                //the only special case is &quot;MingLiu_HKSCS&quot; which has &quot;_&quot; in its
                //facename, we don't want to replace the &quot;_&quot; with &quot; &quot;
<span class="nc" id="L2123">                key = key.substring(9);</span>
<span class="nc bnc" id="L2124" title="All 2 branches missed.">                if (!&quot;MingLiU_HKSCS&quot;.equals(key)) {</span>
<span class="nc" id="L2125">                    key = key.replace('_', ' ');</span>
                }
<span class="nc" id="L2127">                Short faceID = getID(componentFontNameIDs, key);</span>
<span class="nc" id="L2128">                Short fileID = getID(fontfileNameIDs, value);</span>
                //System.out.println(&quot;faceID=&quot; + faceID + &quot;/&quot; + key + &quot; -&gt; &quot;
                //    + &quot;fileID=&quot; + fileID + &quot;/&quot; + value);
<span class="nc" id="L2131">                filenames.put(faceID, fileID);</span>
<span class="nc bnc" id="L2132" title="All 2 branches missed.">            } else if (key.startsWith(&quot;exclusion.&quot;)) {</span>
<span class="nc" id="L2133">                key = key.substring(10);</span>
<span class="nc" id="L2134">                exclusions.put(getID(scriptIDs,key), parseExclusions(key,value));</span>
<span class="nc bnc" id="L2135" title="All 2 branches missed.">            } else if (key.startsWith(&quot;sequence.&quot;)) {</span>
<span class="nc" id="L2136">                key = key.substring(9);</span>
<span class="nc" id="L2137">                boolean hasDefault = false;</span>
<span class="nc" id="L2138">                boolean has1252 = false;</span>

                //get the scriptID list
<span class="nc" id="L2141">                String[] ss = (String[])splitSequence(value).toArray(EMPTY_STRING_ARRAY);</span>
<span class="nc" id="L2142">                short [] sa = new short[ss.length];</span>
<span class="nc bnc" id="L2143" title="All 2 branches missed.">                for (int i = 0; i &lt; ss.length; i++) {</span>
<span class="nc bnc" id="L2144" title="All 2 branches missed.">                    if (&quot;alphabetic/default&quot;.equals(ss[i])) {</span>
                        //System.out.println(key + &quot; -&gt; &quot; + ss[i]);
<span class="nc" id="L2146">                        ss[i] = &quot;alphabetic&quot;;</span>
<span class="nc" id="L2147">                        hasDefault = true;</span>
<span class="nc bnc" id="L2148" title="All 2 branches missed.">                    } else if (&quot;alphabetic/1252&quot;.equals(ss[i])) {</span>
                        //System.out.println(key + &quot; -&gt; &quot; + ss[i]);
<span class="nc" id="L2150">                        ss[i] = &quot;alphabetic&quot;;</span>
<span class="nc" id="L2151">                        has1252 = true;</span>
                    }
<span class="nc" id="L2153">                    sa[i] = getID(scriptIDs, ss[i]).shortValue();</span>
                    //System.out.println(&quot;scriptID=&quot; + si[i] + &quot;/&quot; + ss[i]);
                }
                //convert the &quot;short[] -&gt; string -&gt; stringID&quot;
<span class="nc" id="L2157">                short scriptArrayID = getShortArrayID(sa);</span>
<span class="nc" id="L2158">                Short elcID = null;</span>
<span class="nc" id="L2159">                int dot = key.indexOf('.');</span>
<span class="nc bnc" id="L2160" title="All 2 branches missed.">                if (dot == -1) {</span>
<span class="nc bnc" id="L2161" title="All 2 branches missed.">                    if (&quot;fallback&quot;.equals(key)) {</span>
<span class="nc" id="L2162">                        fallbackScriptIDs = sa;</span>
<span class="nc" id="L2163">                        return;</span>
                    }
<span class="nc bnc" id="L2165" title="All 2 branches missed.">                    if (&quot;allfonts&quot;.equals(key)) {</span>
<span class="nc" id="L2166">                        elcID = getID(elcIDs, &quot;NULL.NULL.NULL&quot;);</span>
                    } else {
<span class="nc bnc" id="L2168" title="All 2 branches missed.">                        if (logger != null) {</span>
<span class="nc" id="L2169">                            logger.config(&quot;Error sequence def: &lt;sequence.&quot; + key + &quot;&gt;&quot;);</span>
                        }
<span class="nc" id="L2171">                        return;</span>
                    }
                } else {
<span class="nc" id="L2174">                    elcID = getID(elcIDs, key.substring(dot + 1));</span>
                    //System.out.println(&quot;elcID=&quot; + elcID + &quot;/&quot; + key.substring(dot + 1));
<span class="nc" id="L2176">                    key = key.substring(0, dot);</span>
                }
<span class="nc" id="L2178">                short[] scriptArrayIDs = null;</span>
<span class="nc bnc" id="L2179" title="All 2 branches missed.">                if (&quot;allfonts&quot;.equals(key)) {</span>
<span class="nc" id="L2180">                    scriptArrayIDs = new short[1];</span>
<span class="nc" id="L2181">                    scriptArrayIDs[0] = scriptArrayID;</span>
                } else {
<span class="nc" id="L2183">                    scriptArrayIDs = sequences.get(elcID);</span>
<span class="nc bnc" id="L2184" title="All 2 branches missed.">                    if (scriptArrayIDs == null) {</span>
<span class="nc" id="L2185">                       scriptArrayIDs = new short[5];</span>
                    }
<span class="nc" id="L2187">                    Integer fid = logicalFontIDs.get(key);</span>
<span class="nc bnc" id="L2188" title="All 2 branches missed.">                    if (fid == null) {</span>
<span class="nc bnc" id="L2189" title="All 2 branches missed.">                        if (logger != null) {</span>
<span class="nc" id="L2190">                            logger.config(&quot;Unrecognizable logicfont name &quot; + key);</span>
                        }
<span class="nc" id="L2192">                        return;</span>
                    }
                    //System.out.println(&quot;sequence.&quot; + key + &quot;/&quot; + id);
<span class="nc" id="L2195">                    scriptArrayIDs[fid.intValue()] = scriptArrayID;</span>
                }
<span class="nc" id="L2197">                sequences.put(elcID, scriptArrayIDs);</span>
<span class="nc bnc" id="L2198" title="All 2 branches missed.">                if (hasDefault) {</span>
<span class="nc" id="L2199">                    alphabeticSuffix.put(elcID, getStringID(&quot;default&quot;));</span>
                } else
<span class="nc bnc" id="L2201" title="All 2 branches missed.">                if (has1252) {</span>
<span class="nc" id="L2202">                    alphabeticSuffix.put(elcID, getStringID(&quot;1252&quot;));</span>
                }
<span class="nc bnc" id="L2204" title="All 2 branches missed.">            } else if (key.startsWith(&quot;allfonts.&quot;)) {</span>
<span class="nc" id="L2205">                key = key.substring(9);</span>
<span class="nc bnc" id="L2206" title="All 2 branches missed.">                if (key.endsWith(&quot;.motif&quot;)) {</span>
<span class="nc" id="L2207">                    key = key.substring(0, key.length() - 6);</span>
                    //System.out.println(&quot;motif: all.&quot; + key + &quot;=&quot; + value);
<span class="nc" id="L2209">                    scriptAllfontsMotif.put(getID(scriptIDs,key), getID(componentFontNameIDs,value));</span>
                } else {
<span class="nc" id="L2211">                    scriptAllfonts.put(getID(scriptIDs,key), getID(componentFontNameIDs,value));</span>
                }
<span class="nc bnc" id="L2213" title="All 2 branches missed.">            } else if (key.startsWith(&quot;awtfontpath.&quot;)) {</span>
<span class="nc" id="L2214">                key = key.substring(12);</span>
                //System.out.println(&quot;scriptID=&quot; + getID(scriptIDs, key) + &quot;/&quot; + key);
<span class="nc" id="L2216">                awtfontpaths.put(getID(scriptIDs, key), getStringID(value));</span>
<span class="nc bnc" id="L2217" title="All 2 branches missed.">            } else if (&quot;version&quot;.equals(key)) {</span>
<span class="nc" id="L2218">                version = value;</span>
<span class="nc bnc" id="L2219" title="All 2 branches missed.">            } else if (&quot;appendedfontpath&quot;.equals(key)) {</span>
<span class="nc" id="L2220">                appendedfontpath = value;</span>
<span class="nc bnc" id="L2221" title="All 2 branches missed.">            } else if (key.startsWith(&quot;proportional.&quot;)) {</span>
<span class="nc" id="L2222">                key = key.substring(13).replace('_', ' ');</span>
                //System.out.println(key + &quot;=&quot; + value);
<span class="nc" id="L2224">                proportionals.put(getID(componentFontNameIDs, key),</span>
<span class="nc" id="L2225">                                  getID(componentFontNameIDs, value));</span>
            } else {
                //&quot;name.style.script(.motif)&quot;, we don't care anything else
                int dot1, dot2;
<span class="nc" id="L2229">                boolean isMotif = false;</span>

<span class="nc" id="L2231">                dot1 = key.indexOf('.');</span>
<span class="nc bnc" id="L2232" title="All 2 branches missed.">                if (dot1 == -1) {</span>
<span class="nc bnc" id="L2233" title="All 2 branches missed.">                    if (logger != null) {</span>
<span class="nc" id="L2234">                        logger.config(&quot;Failed parsing &quot; + key +</span>
                                  &quot; property of font configuration.&quot;);

                    }
<span class="nc" id="L2238">                    return;</span>
                }
<span class="nc" id="L2240">                dot2 = key.indexOf('.', dot1 + 1);</span>
<span class="nc bnc" id="L2241" title="All 2 branches missed.">                if (dot2 == -1) {</span>
<span class="nc bnc" id="L2242" title="All 2 branches missed.">                    if (logger != null) {</span>
<span class="nc" id="L2243">                        logger.config(&quot;Failed parsing &quot; + key +</span>
                                  &quot; property of font configuration.&quot;);

                    }
<span class="nc" id="L2247">                    return;</span>
                }
<span class="nc bnc" id="L2249" title="All 2 branches missed.">                if (key.endsWith(&quot;.motif&quot;)) {</span>
<span class="nc" id="L2250">                    key = key.substring(0, key.length() - 6);</span>
<span class="nc" id="L2251">                    isMotif = true;</span>
                    //System.out.println(&quot;motif: &quot; + key + &quot;=&quot; + value);
                }
<span class="nc" id="L2254">                Integer nameID = logicalFontIDs.get(key.substring(0, dot1));</span>
<span class="nc" id="L2255">                Integer styleID = fontStyleIDs.get(key.substring(dot1+1, dot2));</span>
<span class="nc" id="L2256">                Short scriptID = getID(scriptIDs, key.substring(dot2 + 1));</span>
<span class="nc bnc" id="L2257" title="All 4 branches missed.">                if (nameID == null || styleID == null) {</span>
<span class="nc bnc" id="L2258" title="All 2 branches missed.">                    if (logger != null) {</span>
<span class="nc" id="L2259">                        logger.config(&quot;unrecognizable logicfont name/style at &quot; + key);</span>
                    }
<span class="nc" id="L2261">                    return;</span>
                }
                Short[] pnids;
<span class="nc bnc" id="L2264" title="All 2 branches missed.">                if (isMotif) {</span>
<span class="nc" id="L2265">                    pnids = scriptFontsMotif.get(scriptID);</span>
                } else {
<span class="nc" id="L2267">                    pnids = scriptFonts.get(scriptID);</span>
                }
<span class="nc bnc" id="L2269" title="All 2 branches missed.">                if (pnids == null) {</span>
<span class="nc" id="L2270">                    pnids =  new Short[20];</span>
                }
<span class="nc" id="L2272">                pnids[nameID.intValue() * NUM_STYLES + styleID.intValue()]</span>
<span class="nc" id="L2273">                  = getID(componentFontNameIDs, value);</span>
                /*
                System.out.println(&quot;key=&quot; + key + &quot;/&lt;&quot; + nameID + &quot;&gt;&lt;&quot; + styleID
                                     + &quot;&gt;&lt;&quot; + scriptID + &quot;&gt;=&quot; + value
                                     + &quot;/&quot; + getID(componentFontNameIDs, value));
                */
<span class="nc bnc" id="L2279" title="All 2 branches missed.">                if (isMotif) {</span>
<span class="nc" id="L2280">                    scriptFontsMotif.put(scriptID, pnids);</span>
                } else {
<span class="nc" id="L2282">                    scriptFonts.put(scriptID, pnids);</span>
                }
            }
<span class="nc" id="L2285">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>