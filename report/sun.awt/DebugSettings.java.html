<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>DebugSettings.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.awt</a> &gt; <span class="el_source">DebugSettings.java</span></div><h1>DebugSettings.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2003, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.awt;

import java.io.*;

import java.util.*;
import sun.util.logging.PlatformLogger;

/*
 * Internal class that manages sun.awt.Debug settings.
 * Settings can be specified on a global, per-package,
 * or per-class level.
 *
 * Properties affecting the behaviour of the Debug class are
 * loaded from the awtdebug.properties file at class load
 * time. The properties file is assumed to be in the
 * user.home directory. A different file can be used
 * by setting the awtdebug.properties system property.
 *      e.g. java -Dawtdebug.properties=foo.properties
 *
 * Only properties beginning with 'awtdebug' have any
 * meaning-- all other properties are ignored.
 *
 * You can override the properties file by specifying
 * 'awtdebug' props as system properties on the command line.
 *      e.g. java -Dawtdebug.trace=true
 * Properties specific to a package or a class can be set
 * by qualifying the property names as follows:
 *      awtdebug.&lt;property name&gt;.&lt;class or package name&gt;
 * So for example, turning on tracing in the com.acme.Fubar
 * class would be done as follows:
 *      awtdebug.trace.com.acme.Fubar=true
 *
 * Class settings always override package settings, which in
 * turn override global settings.
 *
 * Addition from July, 2007.
 *
 * After the fix for 4638447 all the usage of DebugHelper
 * classes in Java code are replaced with the corresponding
 * Java Logging API calls. This file is now used only to
 * control native logging.
 *
 * To enable native logging you should set the following
 * system property to 'true': sun.awt.nativedebug. After
 * the native logging is enabled, the actual debug settings
 * are read the same way as described above (as before
 * the fix for 4638447).
 */
final class DebugSettings {
<span class="nc" id="L75">    private static final PlatformLogger log = PlatformLogger.getLogger(&quot;sun.awt.debug.DebugSettings&quot;);</span>

    /* standard debug property key names */
    static final String PREFIX = &quot;awtdebug&quot;;
    static final String PROP_FILE = &quot;properties&quot;;

    /* default property settings */
<span class="nc" id="L82">    private static final String DEFAULT_PROPS[] = {</span>
        &quot;awtdebug.assert=true&quot;,
        &quot;awtdebug.trace=false&quot;,
        &quot;awtdebug.on=true&quot;,
        &quot;awtdebug.ctrace=false&quot;
    };

    /* global instance of the settings object */
<span class="nc" id="L90">    private static DebugSettings instance = null;</span>

<span class="nc" id="L92">    private Properties props = new Properties();</span>

    static void init() {
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (instance != null) {</span>
<span class="nc" id="L96">            return;</span>
        }

<span class="nc" id="L99">        NativeLibLoader.loadLibraries();</span>
<span class="nc" id="L100">        instance = new DebugSettings();</span>
<span class="nc" id="L101">        instance.loadNativeSettings();</span>
<span class="nc" id="L102">    }</span>

<span class="nc" id="L104">    private DebugSettings() {</span>
<span class="nc" id="L105">        java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L106">            new java.security.PrivilegedAction&lt;Void&gt;() {</span>
                public Void run() {
<span class="nc" id="L108">                    loadProperties();</span>
<span class="nc" id="L109">                    return null;</span>
                }
            });
<span class="nc" id="L112">    }</span>

    /*
     * Load debug properties from file, then override
     * with any command line specified properties
     */
    private synchronized void loadProperties() {
        // setup initial properties
<span class="nc" id="L120">        java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L121">            new java.security.PrivilegedAction&lt;Void&gt;() {</span>
                public Void run() {
<span class="nc" id="L123">                    loadDefaultProperties();</span>
<span class="nc" id="L124">                    loadFileProperties();</span>
<span class="nc" id="L125">                    loadSystemProperties();</span>
<span class="nc" id="L126">                    return null;</span>
                }
            });

        // echo the initial property settings to stdout
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (log.isLoggable(PlatformLogger.Level.FINE)) {</span>
<span class="nc" id="L132">            log.fine(&quot;DebugSettings:\n{0}&quot;, this);</span>
        }
<span class="nc" id="L134">    }</span>

    public String toString() {
<span class="nc" id="L137">        ByteArrayOutputStream bout = new ByteArrayOutputStream();</span>
<span class="nc" id="L138">        PrintStream pout = new PrintStream(bout);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        for (String key : props.stringPropertyNames()) {</span>
<span class="nc" id="L140">            String value = props.getProperty(key, &quot;&quot;);</span>
<span class="nc" id="L141">            pout.println(key + &quot; = &quot; + value);</span>
<span class="nc" id="L142">        }</span>
<span class="nc" id="L143">        return new String(bout.toByteArray());</span>
    }

    /*
     * Sets up default property values
     */
    private void loadDefaultProperties() {
        // is there a more inefficient way to setup default properties?
        // maybe, but this has got to be close to 100% non-optimal
        try {
<span class="nc bnc" id="L153" title="All 2 branches missed.">            for ( int nprop = 0; nprop &lt; DEFAULT_PROPS.length; nprop++ ) {</span>
<span class="nc" id="L154">                StringBufferInputStream in = new StringBufferInputStream(DEFAULT_PROPS[nprop]);</span>
<span class="nc" id="L155">                props.load(in);</span>
<span class="nc" id="L156">                in.close();</span>
            }
<span class="nc" id="L158">        } catch(IOException ioe) {</span>
<span class="nc" id="L159">        }</span>
<span class="nc" id="L160">    }</span>

    /*
     * load properties from file, overriding defaults
     */
    private void loadFileProperties() {
        String          propPath;
        Properties      fileProps;

        // check if the user specified a particular settings file
<span class="nc" id="L170">        propPath = System.getProperty(PREFIX + &quot;.&quot; + PROP_FILE, &quot;&quot;);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (propPath.equals(&quot;&quot;)) {</span>
        // otherwise get it from the user's home directory
<span class="nc" id="L173">            propPath = System.getProperty(&quot;user.home&quot;, &quot;&quot;) +</span>
                        File.separator +
                        PREFIX + &quot;.&quot; + PROP_FILE;
        }

<span class="nc" id="L178">        File    propFile = new File(propPath);</span>
        try {
<span class="nc" id="L180">            println(&quot;Reading debug settings from '&quot; + propFile.getCanonicalPath() + &quot;'...&quot;);</span>
<span class="nc" id="L181">            FileInputStream     fin = new FileInputStream(propFile);</span>
<span class="nc" id="L182">            props.load(fin);</span>
<span class="nc" id="L183">            fin.close();</span>
<span class="nc" id="L184">        } catch ( FileNotFoundException fne ) {</span>
<span class="nc" id="L185">            println(&quot;Did not find settings file.&quot;);</span>
<span class="nc" id="L186">        } catch ( IOException ioe ) {</span>
<span class="nc" id="L187">            println(&quot;Problem reading settings, IOException: &quot; + ioe.getMessage());</span>
<span class="nc" id="L188">        }</span>
<span class="nc" id="L189">    }</span>

    /*
     * load properties from system props (command line spec'd usually),
     * overriding default or file properties
     */
    private void loadSystemProperties() {
        // override file properties with system properties
<span class="nc" id="L197">        Properties sysProps = System.getProperties();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        for (String key : sysProps.stringPropertyNames()) {</span>
<span class="nc" id="L199">            String value = sysProps.getProperty(key,&quot;&quot;);</span>
            // copy any &quot;awtdebug&quot; properties over
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if ( key.startsWith(PREFIX) ) {</span>
<span class="nc" id="L202">                props.setProperty(key, value);</span>
            }
<span class="nc" id="L204">        }</span>
<span class="nc" id="L205">    }</span>

    /**
     * Gets named boolean property
     * @param key       Name of property
     * @param defval    Default value if property does not exist
     * @return boolean value of the named property
     */
    public synchronized boolean getBoolean(String key, boolean defval) {
<span class="nc" id="L214">        String  value = getString(key, String.valueOf(defval));</span>
<span class="nc" id="L215">        return value.equalsIgnoreCase(&quot;true&quot;);</span>
    }

    /**
     * Gets named integer property
     * @param key       Name of property
     * @param defval    Default value if property does not exist
     * @return integer value of the named property
     */
    public synchronized int getInt(String key, int defval) {
<span class="nc" id="L225">        String  value = getString(key, String.valueOf(defval));</span>
<span class="nc" id="L226">        return Integer.parseInt(value);</span>
    }

    /**
     * Gets named String property
     * @param key       Name of property
     * @param defval    Default value if property does not exist
     * @return string value of the named property
     */
    public synchronized String getString(String key, String defval) {
<span class="nc" id="L236">        String  actualKeyName = PREFIX + &quot;.&quot; + key;</span>
<span class="nc" id="L237">        String  value = props.getProperty(actualKeyName, defval);</span>
        //println(actualKeyName+&quot;=&quot;+value);
<span class="nc" id="L239">        return value;</span>
    }

    private synchronized List&lt;String&gt; getPropertyNames() {
<span class="nc" id="L243">        List&lt;String&gt; propNames = new LinkedList&lt;&gt;();</span>
        // remove global prefix from property names
<span class="nc bnc" id="L245" title="All 2 branches missed.">        for (String propName : props.stringPropertyNames()) {</span>
<span class="nc" id="L246">            propName = propName.substring(PREFIX.length()+1);</span>
<span class="nc" id="L247">            propNames.add(propName);</span>
<span class="nc" id="L248">        }</span>
<span class="nc" id="L249">        return propNames;</span>
    }

    private void println(Object object) {
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (log.isLoggable(PlatformLogger.Level.FINER)) {</span>
<span class="nc" id="L254">            log.finer(object.toString());</span>
        }
<span class="nc" id="L256">    }</span>

    private static final String PROP_CTRACE = &quot;ctrace&quot;;
<span class="nc" id="L259">    private static final int PROP_CTRACE_LEN = PROP_CTRACE.length();</span>

    private native synchronized void setCTracingOn(boolean enabled);
    private native synchronized void setCTracingOn(boolean enabled, String file);
    private native synchronized void setCTracingOn(boolean enabled, String file, int line);

    private void loadNativeSettings() {
        boolean        ctracingOn;

<span class="nc" id="L268">        ctracingOn = getBoolean(PROP_CTRACE, false);</span>
<span class="nc" id="L269">        setCTracingOn(ctracingOn);</span>

        //
        // Filter out file/line ctrace properties from debug settings
        //
<span class="nc" id="L274">        List&lt;String&gt; traces = new LinkedList&lt;&gt;();</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">        for (String key : getPropertyNames()) {</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">            if (key.startsWith(PROP_CTRACE) &amp;&amp; key.length() &gt; PROP_CTRACE_LEN) {</span>
<span class="nc" id="L278">                traces.add(key);</span>
            }
<span class="nc" id="L280">        }</span>

        // sort traces list so file-level traces will be before line-level ones
<span class="nc" id="L283">        Collections.sort(traces);</span>

        //
        // Setup the trace points
        //
<span class="nc bnc" id="L288" title="All 2 branches missed.">        for (String key : traces) {</span>
<span class="nc" id="L289">            String        trace = key.substring(PROP_CTRACE_LEN+1);</span>
            String        filespec;
            String        linespec;
<span class="nc" id="L292">            int           delim= trace.indexOf('@');</span>
            boolean       enabled;

            // parse out the filename and linenumber from the property name
<span class="nc bnc" id="L296" title="All 2 branches missed.">            filespec = delim != -1 ? trace.substring(0, delim) : trace;</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            linespec = delim != -1 ? trace.substring(delim+1) : &quot;&quot;;</span>
<span class="nc" id="L298">            enabled = getBoolean(key, false);</span>
            //System.out.println(&quot;Key=&quot;+key+&quot;, File=&quot;+filespec+&quot;, Line=&quot;+linespec+&quot;, Enabled=&quot;+enabled);

<span class="nc bnc" id="L301" title="All 2 branches missed.">            if ( linespec.length() == 0 ) {</span>
            // set file specific trace setting
<span class="nc" id="L303">                    setCTracingOn(enabled, filespec);</span>
            } else {
            // set line specific trace setting
<span class="nc" id="L306">                int        linenum = Integer.parseInt(linespec, 10);</span>
<span class="nc" id="L307">                setCTracingOn(enabled, filespec, linenum);</span>
            }
<span class="nc" id="L309">        }</span>
<span class="nc" id="L310">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>