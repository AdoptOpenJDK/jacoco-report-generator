<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FuncHere.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.org.apache.xml.internal.security.transforms.implementations</a> &gt; <span class="el_source">FuncHere.java</span></div><h1>FuncHere.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package com.sun.org.apache.xml.internal.security.transforms.implementations;

import javax.xml.transform.TransformerException;

import com.sun.org.apache.xml.internal.dtm.DTM;
import com.sun.org.apache.xml.internal.security.utils.I18n;
import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
import com.sun.org.apache.xpath.internal.NodeSetDTM;
import com.sun.org.apache.xpath.internal.XPathContext;
import com.sun.org.apache.xpath.internal.functions.Function;
import com.sun.org.apache.xpath.internal.objects.XNodeSet;
import com.sun.org.apache.xpath.internal.objects.XObject;
import com.sun.org.apache.xpath.internal.res.XPATHErrorResources;
import org.w3c.dom.Document;
import org.w3c.dom.Node;

/**
 * The 'here()' function returns a node-set containing the attribute or
 * processing instruction node or the parent element of the text node
 * that directly bears the XPath expression.  This expression results
 * in an error if the containing XPath expression does not appear in the
 * same XML document against which the XPath expression is being evaluated.
 *
 * Mainpart is stolen from FuncId.java
 *
 * This does crash under Xalan2.2.D7 and works under Xalan2.2.D9
 *
 * To get this baby to work, a special trick has to be used. The function needs
 * access to the Node where the XPath expression has been defined. This is done
 * by constructing a {@link FuncHere} which has this Node as 'owner'.
 *
 * @see &quot;http://www.w3.org/Signature/Drafts/xmldsig-core/Overview.html#function-here&quot;
 */
<span class="nc" id="L56">public class FuncHere extends Function {</span>

    /**
     *
     */
    private static final long serialVersionUID = 1L;

    /**
     * The here function returns a node-set containing the attribute or
     * processing instruction node or the parent element of the text node
     * that directly bears the XPath expression.  This expression results
     * in an error if the containing XPath expression does not appear in the
     * same XML document against which the XPath expression is being evaluated.
     *
     * @param xctxt
     * @return the xobject
     * @throws javax.xml.transform.TransformerException
     */
    @Override
    public XObject execute(XPathContext xctxt)
        throws javax.xml.transform.TransformerException {

<span class="nc" id="L78">        Node xpathOwnerNode = (Node) xctxt.getOwnerObject();</span>

<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (xpathOwnerNode == null) {</span>
<span class="nc" id="L81">            return null;</span>
        }

<span class="nc" id="L84">        int xpathOwnerNodeDTM = xctxt.getDTMHandleFromNode(xpathOwnerNode);</span>

<span class="nc" id="L86">        int currentNode = xctxt.getCurrentNode();</span>
<span class="nc" id="L87">        DTM dtm = xctxt.getDTM(currentNode);</span>
<span class="nc" id="L88">        int docContext = dtm.getDocument();</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (DTM.NULL == docContext) {</span>
<span class="nc" id="L91">            error(xctxt, XPATHErrorResources.ER_CONTEXT_HAS_NO_OWNERDOC, null);</span>
        }

        {
            // check whether currentNode and the node containing the XPath expression
            // are in the same document
<span class="nc" id="L97">            Document currentDoc =</span>
<span class="nc" id="L98">                XMLUtils.getOwnerDocument(dtm.getNode(currentNode));</span>
<span class="nc" id="L99">            Document xpathOwnerDoc = XMLUtils.getOwnerDocument(xpathOwnerNode);</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (currentDoc != xpathOwnerDoc) {</span>
<span class="nc" id="L102">                throw new TransformerException(I18n.translate(&quot;xpath.funcHere.documentsDiffer&quot;));</span>
            }
        }

<span class="nc" id="L106">        XNodeSet nodes = new XNodeSet(xctxt.getDTMManager());</span>
<span class="nc" id="L107">        NodeSetDTM nodeSet = nodes.mutableNodeset();</span>

        {
<span class="nc" id="L110">            int hereNode = DTM.NULL;</span>

<span class="nc bnc" id="L112" title="All 3 branches missed.">            switch (dtm.getNodeType(xpathOwnerNodeDTM)) {</span>

            case Node.ATTRIBUTE_NODE :
            case Node.PROCESSING_INSTRUCTION_NODE : {
                // returns a node-set containing the attribute /  processing instruction node
<span class="nc" id="L117">                hereNode = xpathOwnerNodeDTM;</span>

<span class="nc" id="L119">                nodeSet.addNode(hereNode);</span>

<span class="nc" id="L121">                break;</span>
            }
            case Node.TEXT_NODE : {
                // returns a node-set containing the parent element of the
                // text node that directly bears the XPath expression
<span class="nc" id="L126">                hereNode = dtm.getParent(xpathOwnerNodeDTM);</span>

<span class="nc" id="L128">                nodeSet.addNode(hereNode);</span>

<span class="nc" id="L130">                break;</span>
            }
            default :
                break;
            }
        }

        /** $todo$ Do I have to do this detach() call? */
<span class="nc" id="L138">        nodeSet.detach();</span>

<span class="nc" id="L140">        return nodes;</span>
    }

    /**
     * No arguments to process, so this does nothing.
     * @param vars
     * @param globalsSize
     */
    @SuppressWarnings(&quot;rawtypes&quot;)
    public void fixupVariables(java.util.Vector vars, int globalsSize) {
        // do nothing
<span class="nc" id="L151">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>