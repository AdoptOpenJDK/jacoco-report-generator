<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>TransformXSLT.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.org.apache.xml.internal.security.transforms.implementations</a> &gt; <span class="el_source">TransformXSLT.java</span></div><h1>TransformXSLT.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package com.sun.org.apache.xml.internal.security.transforms.implementations;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStream;

import javax.xml.XMLConstants;
import javax.xml.transform.Source;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import javax.xml.transform.stream.StreamSource;

import com.sun.org.apache.xml.internal.security.exceptions.XMLSecurityException;
import com.sun.org.apache.xml.internal.security.signature.XMLSignatureInput;
import com.sun.org.apache.xml.internal.security.transforms.Transform;
import com.sun.org.apache.xml.internal.security.transforms.TransformSpi;
import com.sun.org.apache.xml.internal.security.transforms.TransformationException;
import com.sun.org.apache.xml.internal.security.transforms.Transforms;
import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
import org.w3c.dom.Element;

/**
 * Class TransformXSLT
 *
 * Implements the &lt;CODE&gt;http://www.w3.org/TR/1999/REC-xslt-19991116&lt;/CODE&gt;
 * transform.
 *
 * @author Christian Geuer-Pollmann
 */
<span class="nc" id="L57">public class TransformXSLT extends TransformSpi {</span>

    /** Field implementedTransformURI */
    public static final String implementedTransformURI =
        Transforms.TRANSFORM_XSLT;

    static final String XSLTSpecNS              = &quot;http://www.w3.org/1999/XSL/Transform&quot;;
    static final String defaultXSLTSpecNSprefix = &quot;xslt&quot;;
    static final String XSLTSTYLESHEET          = &quot;stylesheet&quot;;

<span class="nc" id="L67">    private static java.util.logging.Logger log =</span>
<span class="nc" id="L68">        java.util.logging.Logger.getLogger(TransformXSLT.class.getName());</span>

    /**
     * Method engineGetURI
     *
     * @inheritDoc
     */
    protected String engineGetURI() {
<span class="nc" id="L76">        return implementedTransformURI;</span>
    }

    protected XMLSignatureInput enginePerformTransform(
        XMLSignatureInput input, OutputStream baos, Transform transformObject
    ) throws IOException, TransformationException {
        try {
<span class="nc" id="L83">            Element transformElement = transformObject.getElement();</span>

<span class="nc" id="L85">            Element xsltElement =</span>
<span class="nc" id="L86">                XMLUtils.selectNode(transformElement.getFirstChild(), XSLTSpecNS, &quot;stylesheet&quot;, 0);</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">            if (xsltElement == null) {</span>
<span class="nc" id="L89">                Object exArgs[] = { &quot;xslt:stylesheet&quot;, &quot;Transform&quot; };</span>

<span class="nc" id="L91">                throw new TransformationException(&quot;xml.WrongContent&quot;, exArgs);</span>
            }

<span class="nc" id="L94">            TransformerFactory tFactory = TransformerFactory.newInstance();</span>
            // Process XSLT stylesheets in a secure manner
<span class="nc" id="L96">            tFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, Boolean.TRUE);</span>

            /*
             * This transform requires an octet stream as input. If the actual
             * input is an XPath node-set, then the signature application should
             * attempt to convert it to octets (apply Canonical XML]) as described
             * in the Reference Processing Model (section 4.3.3.2).
             */
<span class="nc" id="L104">            Source xmlSource =</span>
<span class="nc" id="L105">                new StreamSource(new ByteArrayInputStream(input.getBytes()));</span>
            Source stylesheet;

            /*
             * This complicated transformation of the stylesheet itself is necessary
             * because of the need to get the pure style sheet. If we simply say
             * Source stylesheet = new DOMSource(this.xsltElement);
             * whereby this.xsltElement is not the rootElement of the Document,
             * this causes problems;
             * so we convert the stylesheet to byte[] and use this as input stream
             */
            {
<span class="nc" id="L117">                ByteArrayOutputStream os = new ByteArrayOutputStream();</span>
<span class="nc" id="L118">                Transformer transformer = tFactory.newTransformer();</span>
<span class="nc" id="L119">                DOMSource source = new DOMSource(xsltElement);</span>
<span class="nc" id="L120">                StreamResult result = new StreamResult(os);</span>

<span class="nc" id="L122">                transformer.transform(source, result);</span>

<span class="nc" id="L124">                stylesheet =</span>
<span class="nc" id="L125">                    new StreamSource(new ByteArrayInputStream(os.toByteArray()));</span>
            }

<span class="nc" id="L128">            Transformer transformer = tFactory.newTransformer(stylesheet);</span>

            // Force Xalan to use \n as line separator on all OSes. This
            // avoids OS specific signature validation failures due to line
            // separator differences in the transformed output. Unfortunately,
            // this is not a standard JAXP property so will not work with non-Xalan
            // implementations.
            try {
<span class="nc" id="L136">                transformer.setOutputProperty(&quot;{http://xml.apache.org/xalan}line-separator&quot;, &quot;\n&quot;);</span>
<span class="nc" id="L137">            } catch (Exception e) {</span>
<span class="nc" id="L138">                log.log(java.util.logging.Level.WARNING, &quot;Unable to set Xalan line-separator property: &quot; + e.getMessage());</span>
<span class="nc" id="L139">            }</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (baos == null) {</span>
<span class="nc" id="L142">                ByteArrayOutputStream baos1 = new ByteArrayOutputStream();</span>
<span class="nc" id="L143">                StreamResult outputTarget = new StreamResult(baos1);</span>
<span class="nc" id="L144">                transformer.transform(xmlSource, outputTarget);</span>
<span class="nc" id="L145">                return new XMLSignatureInput(baos1.toByteArray());</span>
            }
<span class="nc" id="L147">            StreamResult outputTarget = new StreamResult(baos);</span>

<span class="nc" id="L149">            transformer.transform(xmlSource, outputTarget);</span>
<span class="nc" id="L150">            XMLSignatureInput output = new XMLSignatureInput((byte[])null);</span>
<span class="nc" id="L151">            output.setOutputStream(baos);</span>
<span class="nc" id="L152">            return output;</span>
<span class="nc" id="L153">        } catch (XMLSecurityException ex) {</span>
<span class="nc" id="L154">            Object exArgs[] = { ex.getMessage() };</span>

<span class="nc" id="L156">            throw new TransformationException(&quot;generic.EmptyMessage&quot;, exArgs, ex);</span>
<span class="nc" id="L157">        } catch (TransformerConfigurationException ex) {</span>
<span class="nc" id="L158">            Object exArgs[] = { ex.getMessage() };</span>

<span class="nc" id="L160">            throw new TransformationException(&quot;generic.EmptyMessage&quot;, exArgs, ex);</span>
<span class="nc" id="L161">        } catch (TransformerException ex) {</span>
<span class="nc" id="L162">            Object exArgs[] = { ex.getMessage() };</span>

<span class="nc" id="L164">            throw new TransformationException(&quot;generic.EmptyMessage&quot;, exArgs, ex);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>