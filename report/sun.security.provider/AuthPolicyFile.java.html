<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>AuthPolicyFile.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.security.provider</a> &gt; <span class="el_source">AuthPolicyFile.java</span></div><h1>AuthPolicyFile.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1999, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.provider;

import java.io.*;
import java.lang.reflect.*;
import java.net.URL;
import java.util.*;

import java.security.AccessController;
import java.security.CodeSource;
import java.security.KeyStore;
import java.security.KeyStoreException;
import java.security.Permission;
import java.security.Permissions;
import java.security.PermissionCollection;
import java.security.Principal;
import java.security.PrivilegedAction;
import java.security.UnresolvedPermission;
import java.security.Security;
import java.security.cert.Certificate;
import java.security.cert.X509Certificate;

import javax.security.auth.Subject;
import javax.security.auth.PrivateCredentialPermission;

import sun.security.provider.PolicyParser.GrantEntry;
import sun.security.provider.PolicyParser.PermissionEntry;
import sun.security.provider.PolicyParser.PrincipalEntry;
import sun.security.util.Debug;
import sun.security.util.PolicyUtil;
import sun.security.util.PropertyExpander;

/**
 * See {@code com.sun.security.auth.PolicyFile} for the class description.
 * This class is necessary in order to support a default
 * {@code javax.security.auth.Policy} implementation on the compact1 and
 * compact2 profiles.
 *
 * @deprecated As of JDK&amp;nbsp;1.4, replaced by
 *             {@code sun.security.provider.PolicyFile}.
 *             This class is entirely deprecated.
 */
@Deprecated
public class AuthPolicyFile extends javax.security.auth.Policy {

<span class="nc" id="L70">    static final ResourceBundle rb =</span>
<span class="nc" id="L71">        AccessController.doPrivileged(new PrivilegedAction&lt;ResourceBundle&gt;() {</span>
            @Override public ResourceBundle run() {
<span class="nc" id="L73">                return (ResourceBundle.getBundle</span>
<span class="nc" id="L74">                        (&quot;sun.security.util.AuthResources&quot;));</span>
            }
        });

<span class="nc" id="L78">    private static final Debug debug = Debug.getInstance(&quot;policy&quot;,</span>
                                                         &quot;\t[Auth Policy]&quot;);

    private static final String AUTH_POLICY = &quot;java.security.auth.policy&quot;;
    private static final String SECURITY_MANAGER = &quot;java.security.manager&quot;;
    private static final String AUTH_POLICY_URL = &quot;auth.policy.url.&quot;;

    private Vector&lt;PolicyEntry&gt; policyEntries;
    private Hashtable&lt;Object, Object&gt; aliasMapping;

<span class="nc" id="L88">    private boolean initialized = false;</span>

<span class="nc" id="L90">    private boolean expandProperties = true;</span>
<span class="nc" id="L91">    private boolean ignoreIdentityScope = true;</span>

    // for use with the reflection API
<span class="nc" id="L94">    private static final Class&lt;?&gt;[] PARAMS = { String.class, String.class};</span>

    /**
     * Initializes the Policy object and reads the default policy
     * configuration file(s) into the Policy object.
     */
<span class="nc" id="L100">    public AuthPolicyFile() {</span>
        // initialize Policy if either the AUTH_POLICY or
        // SECURITY_MANAGER properties are set
<span class="nc" id="L103">        String prop = System.getProperty(AUTH_POLICY);</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (prop == null) {</span>
<span class="nc" id="L106">            prop = System.getProperty(SECURITY_MANAGER);</span>
        }
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (prop != null) {</span>
<span class="nc" id="L109">            init();</span>
        }
<span class="nc" id="L111">    }</span>

    private synchronized void init() {
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (initialized) {</span>
<span class="nc" id="L115">            return;</span>
        }

<span class="nc" id="L118">        policyEntries = new Vector&lt;PolicyEntry&gt;();</span>
<span class="nc" id="L119">        aliasMapping = new Hashtable&lt;Object, Object&gt;(11);</span>

<span class="nc" id="L121">        initPolicyFile();</span>
<span class="nc" id="L122">        initialized = true;</span>
<span class="nc" id="L123">    }</span>

    @Override
    public synchronized void refresh() {

<span class="nc" id="L128">        java.lang.SecurityManager sm = System.getSecurityManager();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (sm != null) {</span>
<span class="nc" id="L130">            sm.checkPermission(new javax.security.auth.AuthPermission</span>
                                (&quot;refreshPolicy&quot;));
        }

        // XXX
        //
        // 1)   if code instantiates PolicyFile directly, then it will need
        //      all the permissions required for the PolicyFile initialization
        // 2)   if code calls Policy.getPolicy, then it simply needs
        //      AuthPermission(getPolicy), and the javax.security.auth.Policy
        //      implementation instantiates PolicyFile in a doPrivileged block
        // 3)   if after instantiating a Policy (either via #1 or #2),
        //      code calls refresh, it simply needs
        //      AuthPermission(refreshPolicy).  then PolicyFile wraps
        //      the refresh in a doPrivileged block.
<span class="nc" id="L145">        initialized = false;</span>
<span class="nc" id="L146">        AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span>
            @Override public Void run() {
<span class="nc" id="L148">                init();</span>
<span class="nc" id="L149">                return null;</span>
            }
        });
<span class="nc" id="L152">    }</span>

    private KeyStore initKeyStore(URL policyUrl, String keyStoreName,
                                  String keyStoreType) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (keyStoreName != null) {</span>
            try {
                /*
                 * location of keystore is specified as absolute URL in policy
                 * file, or is relative to URL of policy file
                 */
<span class="nc" id="L162">                URL keyStoreUrl = null;</span>
                try {
<span class="nc" id="L164">                    keyStoreUrl = new URL(keyStoreName);</span>
                    // absolute URL
<span class="nc" id="L166">                } catch (java.net.MalformedURLException e) {</span>
                    // relative URL
<span class="nc" id="L168">                    keyStoreUrl = new URL(policyUrl, keyStoreName);</span>
<span class="nc" id="L169">                }</span>

<span class="nc bnc" id="L171" title="All 2 branches missed.">                if (debug != null) {</span>
<span class="nc" id="L172">                    debug.println(&quot;reading keystore&quot;+keyStoreUrl);</span>
                }

<span class="nc" id="L175">                InputStream inStream = new BufferedInputStream(</span>
<span class="nc" id="L176">                    PolicyUtil.getInputStream(keyStoreUrl));</span>

                KeyStore ks;
<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (keyStoreType != null)</span>
<span class="nc" id="L180">                    ks = KeyStore.getInstance(keyStoreType);</span>
                else
<span class="nc" id="L182">                    ks = KeyStore.getInstance(KeyStore.getDefaultType());</span>
<span class="nc" id="L183">                ks.load(inStream, null);</span>
<span class="nc" id="L184">                inStream.close();</span>
<span class="nc" id="L185">                return ks;</span>
<span class="nc" id="L186">            } catch (Exception e) {</span>
                // ignore, treat it like we have no keystore
<span class="nc bnc" id="L188" title="All 2 branches missed.">                if (debug != null) {</span>
<span class="nc" id="L189">                    e.printStackTrace();</span>
                }
<span class="nc" id="L191">                return null;</span>
            }
        }
<span class="nc" id="L194">        return null;</span>
    }

    private void initPolicyFile() {

<span class="nc" id="L199">        String prop = Security.getProperty(&quot;policy.expandProperties&quot;);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (prop != null) {</span>
<span class="nc" id="L201">            expandProperties = prop.equalsIgnoreCase(&quot;true&quot;);</span>
        }

<span class="nc" id="L204">        String iscp = Security.getProperty(&quot;policy.ignoreIdentityScope&quot;);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (iscp != null) {</span>
<span class="nc" id="L206">            ignoreIdentityScope = iscp.equalsIgnoreCase(&quot;true&quot;);</span>
        }

<span class="nc" id="L209">        String allowSys = Security.getProperty(&quot;policy.allowSystemProperty&quot;);</span>
<span class="nc bnc" id="L210" title="All 4 branches missed.">        if (allowSys != null &amp;&amp; allowSys.equalsIgnoreCase(&quot;true&quot;)) {</span>
<span class="nc" id="L211">            String extra_policy = System.getProperty(AUTH_POLICY);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (extra_policy != null) {</span>
<span class="nc" id="L213">                boolean overrideAll = false;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                if (extra_policy.startsWith(&quot;=&quot;)) {</span>
<span class="nc" id="L215">                    overrideAll = true;</span>
<span class="nc" id="L216">                    extra_policy = extra_policy.substring(1);</span>
                }
                try {
<span class="nc" id="L219">                    extra_policy = PropertyExpander.expand(extra_policy);</span>
                    URL policyURL;
<span class="nc" id="L221">                    File policyFile = new File(extra_policy);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if (policyFile.exists()) {</span>
<span class="nc" id="L223">                        policyURL =</span>
<span class="nc" id="L224">                            new URL(&quot;file:&quot; + policyFile.getCanonicalPath());</span>
                    } else {
<span class="nc" id="L226">                        policyURL = new URL(extra_policy);</span>
                    }
<span class="nc bnc" id="L228" title="All 2 branches missed.">                    if (debug != null) {</span>
<span class="nc" id="L229">                        debug.println(&quot;reading &quot; + policyURL);</span>
                    }
<span class="nc" id="L231">                    init(policyURL);</span>
<span class="nc" id="L232">                } catch (Exception e) {</span>
                    // ignore.
<span class="nc bnc" id="L234" title="All 2 branches missed.">                    if (debug != null) {</span>
<span class="nc" id="L235">                        debug.println(&quot;caught exception: &quot; + e);</span>
                    }

<span class="nc" id="L238">                }</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                if (overrideAll) {</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">                    if (debug != null) {</span>
<span class="nc" id="L241">                        debug.println(&quot;overriding other policies!&quot;);</span>
                    }
<span class="nc" id="L243">                    return;</span>
                }
            }
        }

<span class="nc" id="L248">        int n = 1;</span>
<span class="nc" id="L249">        boolean loaded_one = false;</span>
        String policy_url;

<span class="nc bnc" id="L252" title="All 2 branches missed.">        while ((policy_url = Security.getProperty(AUTH_POLICY_URL+n)) != null) {</span>
            try {
<span class="nc" id="L254">                policy_url = PropertyExpander.expand(policy_url).replace</span>
<span class="nc" id="L255">                                                (File.separatorChar, '/');</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                if (debug != null) {</span>
<span class="nc" id="L257">                    debug.println(&quot;reading &quot; + policy_url);</span>
                }
<span class="nc" id="L259">                init(new URL(policy_url));</span>
<span class="nc" id="L260">                loaded_one = true;</span>
<span class="nc" id="L261">            } catch (Exception e) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                if (debug != null) {</span>
<span class="nc" id="L263">                    debug.println(&quot;error reading policy &quot; + e);</span>
<span class="nc" id="L264">                    e.printStackTrace();</span>
                }
                // ignore that policy
<span class="nc" id="L267">            }</span>
<span class="nc" id="L268">            n++;</span>
        }

<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (loaded_one == false) {</span>
            // do not load a static policy
        }
<span class="nc" id="L274">    }</span>

    /**
     * Checks public key. If it is marked as trusted in
     * the identity database, add it to the policy
     * with the AllPermission.
     */
    private boolean checkForTrustedIdentity(final Certificate cert) {
<span class="nc" id="L282">        return false;</span>
    }

    /**
     * Reads a policy configuration into the Policy object using a
     * Reader object.
     *
     * @param policyFile the policy Reader object.
     */
    private void init(URL policy) {
<span class="nc" id="L292">        PolicyParser pp = new PolicyParser(expandProperties);</span>
<span class="nc" id="L293">        try (InputStreamReader isr</span>
<span class="nc" id="L294">                = new InputStreamReader(PolicyUtil.getInputStream(policy))) {</span>
<span class="nc" id="L295">            pp.read(isr);</span>
<span class="nc" id="L296">            KeyStore keyStore = initKeyStore(policy, pp.getKeyStoreUrl(),</span>
<span class="nc" id="L297">                                             pp.getKeyStoreType());</span>
<span class="nc" id="L298">            Enumeration&lt;GrantEntry&gt; enum_ = pp.grantElements();</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            while (enum_.hasMoreElements()) {</span>
<span class="nc" id="L300">                GrantEntry ge = enum_.nextElement();</span>
<span class="nc" id="L301">                addGrantEntry(ge, keyStore);</span>
<span class="nc" id="L302">            }</span>
<span class="nc bnc" id="L303" title="All 8 branches missed.">        } catch (PolicyParser.ParsingException pe) {</span>
<span class="nc" id="L304">            System.err.println(AUTH_POLICY +</span>
<span class="nc" id="L305">                               rb.getString(&quot;.error.parsing.&quot;) + policy);</span>
<span class="nc" id="L306">            System.err.println(AUTH_POLICY + rb.getString(&quot;COLON&quot;) +</span>
<span class="nc" id="L307">                               pe.getMessage());</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">            if (debug != null) {</span>
<span class="nc" id="L309">                pe.printStackTrace();</span>
            }
<span class="nc" id="L311">        } catch (Exception e) {</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (debug != null) {</span>
<span class="nc" id="L313">                debug.println(&quot;error parsing &quot; + policy);</span>
<span class="nc" id="L314">                debug.println(e.toString());</span>
<span class="nc" id="L315">                e.printStackTrace();</span>
            }
<span class="nc" id="L317">        }</span>
<span class="nc" id="L318">    }</span>

    /**
     * Given a PermissionEntry, create a codeSource.
     *
     * @return null if signedBy alias is not recognized
     */
    CodeSource getCodeSource(GrantEntry ge, KeyStore keyStore)
            throws java.net.MalformedURLException
    {
<span class="nc" id="L328">        Certificate[] certs = null;</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">        if (ge.signedBy != null) {</span>
<span class="nc" id="L330">            certs = getCertificates(keyStore, ge.signedBy);</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">            if (certs == null) {</span>
                // we don't have a key for this alias,
                // just return
<span class="nc bnc" id="L334" title="All 2 branches missed.">                if (debug != null) {</span>
<span class="nc" id="L335">                    debug.println(&quot; no certs for alias &quot; +</span>
                                       ge.signedBy + &quot;, ignoring.&quot;);
                }
<span class="nc" id="L338">                return null;</span>
            }
        }

        URL location;
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (ge.codeBase != null) {</span>
<span class="nc" id="L344">            location = new URL(ge.codeBase);</span>
        } else {
<span class="nc" id="L346">            location = null;</span>
        }

<span class="nc bnc" id="L349" title="All 4 branches missed.">        if (ge.principals == null || ge.principals.size() == 0) {</span>
<span class="nc" id="L350">            return (canonicalizeCodebase</span>
<span class="nc" id="L351">                        (new CodeSource(location, certs),</span>
                        false));
        } else {
<span class="nc" id="L354">            return (canonicalizeCodebase</span>
<span class="nc" id="L355">                (new SubjectCodeSource(null, ge.principals, location, certs),</span>
                false));
        }
    }

    /**
     * Add one policy entry to the vector.
     */
    private void addGrantEntry(GrantEntry ge, KeyStore keyStore) {

<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (debug != null) {</span>
<span class="nc" id="L366">            debug.println(&quot;Adding policy entry: &quot;);</span>
<span class="nc" id="L367">            debug.println(&quot;  signedBy &quot; + ge.signedBy);</span>
<span class="nc" id="L368">            debug.println(&quot;  codeBase &quot; + ge.codeBase);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">            if (ge.principals != null) {</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">                for (PrincipalEntry pppe : ge.principals) {</span>
<span class="nc" id="L371">                    debug.println(&quot;  &quot; + pppe.getPrincipalClass() +</span>
<span class="nc" id="L372">                                        &quot; &quot; + pppe.getPrincipalName());</span>
<span class="nc" id="L373">                }</span>
            }
<span class="nc" id="L375">            debug.println();</span>
        }

        try {
<span class="nc" id="L379">            CodeSource codesource = getCodeSource(ge, keyStore);</span>
            // skip if signedBy alias was unknown...
<span class="nc bnc" id="L381" title="All 2 branches missed.">            if (codesource == null) return;</span>

<span class="nc" id="L383">            PolicyEntry entry = new PolicyEntry(codesource);</span>
<span class="nc" id="L384">            Enumeration&lt;PermissionEntry&gt; enum_ = ge.permissionElements();</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">            while (enum_.hasMoreElements()) {</span>
<span class="nc" id="L386">                PermissionEntry pe = enum_.nextElement();</span>
                try {
                    // XXX special case PrivateCredentialPermission-SELF
                    Permission perm;
<span class="nc" id="L390">                    if (pe.permission.equals</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">                        (&quot;javax.security.auth.PrivateCredentialPermission&quot;) &amp;&amp;</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">                        pe.name.endsWith(&quot; self&quot;)) {</span>
<span class="nc" id="L393">                        perm = getInstance(pe.permission,</span>
                                         pe.name + &quot; \&quot;self\&quot;&quot;,
                                         pe.action);
                    } else {
<span class="nc" id="L397">                        perm = getInstance(pe.permission,</span>
                                         pe.name,
                                         pe.action);
                    }
<span class="nc" id="L401">                    entry.add(perm);</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">                    if (debug != null) {</span>
<span class="nc" id="L403">                        debug.println(&quot;  &quot;+perm);</span>
                    }
<span class="nc" id="L405">                } catch (ClassNotFoundException cnfe) {</span>
                    Certificate certs[];
<span class="nc bnc" id="L407" title="All 2 branches missed.">                    if (pe.signedBy != null) {</span>
<span class="nc" id="L408">                        certs = getCertificates(keyStore, pe.signedBy);</span>
                    } else {
<span class="nc" id="L410">                        certs = null;</span>
                    }

                    // only add if we had no signer or we had a
                    // a signer and found the keys for it.
<span class="nc bnc" id="L415" title="All 4 branches missed.">                    if (certs != null || pe.signedBy == null) {</span>
<span class="nc" id="L416">                            Permission perm = new UnresolvedPermission(</span>
                                             pe.permission,
                                             pe.name,
                                             pe.action,
                                             certs);
<span class="nc" id="L421">                            entry.add(perm);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">                            if (debug != null) {</span>
<span class="nc" id="L423">                                debug.println(&quot;  &quot;+perm);</span>
                            }
                    }
<span class="nc" id="L426">                } catch (java.lang.reflect.InvocationTargetException ite) {</span>
<span class="nc" id="L427">                    System.err.println</span>
<span class="nc" id="L428">                        (AUTH_POLICY +</span>
<span class="nc" id="L429">                        rb.getString(&quot;.error.adding.Permission.&quot;) +</span>
                        pe.permission +
<span class="nc" id="L431">                        rb.getString(&quot;SPACE&quot;) +</span>
<span class="nc" id="L432">                        ite.getTargetException());</span>
<span class="nc" id="L433">                } catch (Exception e) {</span>
<span class="nc" id="L434">                    System.err.println</span>
<span class="nc" id="L435">                        (AUTH_POLICY +</span>
<span class="nc" id="L436">                        rb.getString(&quot;.error.adding.Permission.&quot;) +</span>
                        pe.permission +
<span class="nc" id="L438">                        rb.getString(&quot;SPACE&quot;) +</span>
                        e);
<span class="nc" id="L440">                }</span>
<span class="nc" id="L441">            }</span>
<span class="nc" id="L442">            policyEntries.addElement(entry);</span>
<span class="nc" id="L443">        } catch (Exception e) {</span>
<span class="nc" id="L444">            System.err.println</span>
<span class="nc" id="L445">                (AUTH_POLICY +</span>
<span class="nc" id="L446">                rb.getString(&quot;.error.adding.Entry.&quot;) +</span>
                ge +
<span class="nc" id="L448">                rb.getString(&quot;SPACE&quot;) +</span>
                e);
<span class="nc" id="L450">        }</span>

<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (debug != null) {</span>
<span class="nc" id="L453">            debug.println();</span>
        }
<span class="nc" id="L455">    }</span>

    /**
     * Returns a new Permission object of the given Type. The Permission is
     * created by getting the
     * Class object using the &lt;code&gt;Class.forName&lt;/code&gt; method, and using
     * the reflection API to invoke the (String name, String actions)
     * constructor on the
     * object.
     *
     * @param type the type of Permission being created.
     * @param name the name of the Permission being created.
     * @param actions the actions of the Permission being created.
     *
     * @exception  ClassNotFoundException  if the particular Permission
     *             class could not be found.
     *
     * @exception  IllegalAccessException  if the class or initializer is
     *               not accessible.
     *
     * @exception  InstantiationException  if getInstance tries to
     *               instantiate an abstract class or an interface, or if the
     *               instantiation fails for some other reason.
     *
     * @exception  NoSuchMethodException if the (String, String) constructor
     *               is not found.
     *
     * @exception  InvocationTargetException if the underlying Permission
     *               constructor throws an exception.
     *
     */
    private static final Permission getInstance(String type,
                                    String name,
                                    String actions)
        throws ClassNotFoundException,
               InstantiationException,
               IllegalAccessException,
               NoSuchMethodException,
               InvocationTargetException
    {
        //XXX we might want to keep a hash of created factories...
<span class="nc" id="L496">        Class&lt;?&gt; pc = Class.forName(type);</span>
<span class="nc" id="L497">        Constructor&lt;?&gt; c = pc.getConstructor(PARAMS);</span>
<span class="nc" id="L498">        return (Permission) c.newInstance(new Object[] { name, actions });</span>
    }

    /**
     * Fetch all certs associated with this alias.
     */
    Certificate[] getCertificates(KeyStore keyStore, String aliases) {

<span class="nc" id="L506">        Vector&lt;Certificate&gt; vcerts = null;</span>

<span class="nc" id="L508">        StringTokenizer st = new StringTokenizer(aliases, &quot;,&quot;);</span>
<span class="nc" id="L509">        int n = 0;</span>

<span class="nc bnc" id="L511" title="All 2 branches missed.">        while (st.hasMoreTokens()) {</span>
<span class="nc" id="L512">            String alias = st.nextToken().trim();</span>
<span class="nc" id="L513">            n++;</span>
<span class="nc" id="L514">            Certificate cert = null;</span>
            // See if this alias's cert has already been cached
<span class="nc" id="L516">            cert = (Certificate) aliasMapping.get(alias);</span>
<span class="nc bnc" id="L517" title="All 4 branches missed.">            if (cert == null &amp;&amp; keyStore != null) {</span>

                try {
<span class="nc" id="L520">                    cert = keyStore.getCertificate(alias);</span>
<span class="nc" id="L521">                } catch (KeyStoreException kse) {</span>
                    // never happens, because keystore has already been loaded
                    // when we call this
<span class="nc" id="L524">                }</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">                if (cert != null) {</span>
<span class="nc" id="L526">                    aliasMapping.put(alias, cert);</span>
<span class="nc" id="L527">                    aliasMapping.put(cert, alias);</span>
                }
            }

<span class="nc bnc" id="L531" title="All 2 branches missed.">            if (cert != null) {</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">                if (vcerts == null) {</span>
<span class="nc" id="L533">                    vcerts = new Vector&lt;Certificate&gt;();</span>
                }
<span class="nc" id="L535">                vcerts.addElement(cert);</span>
            }
<span class="nc" id="L537">        }</span>

        // make sure n == vcerts.size, since we are doing a logical *and*
<span class="nc bnc" id="L540" title="All 4 branches missed.">        if (vcerts != null &amp;&amp; n == vcerts.size()) {</span>
<span class="nc" id="L541">            Certificate[] certs = new Certificate[vcerts.size()];</span>
<span class="nc" id="L542">            vcerts.copyInto(certs);</span>
<span class="nc" id="L543">            return certs;</span>
        } else {
<span class="nc" id="L545">            return null;</span>
        }
    }

    /**
     * Enumerate all the entries in the global policy object.
     * This method is used by policy admin tools.   The tools
     * should use the Enumeration methods on the returned object
     * to fetch the elements sequentially.
     */
    private final synchronized Enumeration&lt;PolicyEntry&gt; elements() {
<span class="nc" id="L556">        return policyEntries.elements();</span>
    }

    @Override
    public PermissionCollection getPermissions(final Subject subject,
                                               final CodeSource codesource) {

        // 1)   if code instantiates PolicyFile directly, then it will need
        //      all the permissions required for the PolicyFile initialization
        // 2)   if code calls Policy.getPolicy, then it simply needs
        //      AuthPermission(getPolicy), and the javax.security.auth.Policy
        //      implementation instantiates PolicyFile in a doPrivileged block
        // 3)   if after instantiating a Policy (either via #1 or #2),
        //      code calls getPermissions, PolicyFile wraps the call
        //      in a doPrivileged block.
<span class="nc" id="L571">        return AccessController.doPrivileged</span>
<span class="nc" id="L572">            (new PrivilegedAction&lt;PermissionCollection&gt;() {</span>
            @Override public PermissionCollection run() {
<span class="nc bnc" id="L574" title="All 2 branches missed.">                SubjectCodeSource scs = new SubjectCodeSource(</span>
                    subject, null,
<span class="nc bnc" id="L576" title="All 2 branches missed.">                    codesource == null ? null : codesource.getLocation(),</span>
<span class="nc" id="L577">                    codesource == null ? null : codesource.getCertificates());</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">                if (initialized) {</span>
<span class="nc" id="L579">                    return getPermissions(new Permissions(), scs);</span>
                } else {
<span class="nc" id="L581">                    return new PolicyPermissions(AuthPolicyFile.this, scs);</span>
                }
            }
        });
    }

    /**
     * Examines the global policy for the specified CodeSource, and
     * creates a PermissionCollection object with
     * the set of permissions for that principal's protection domain.
     *
     * @param CodeSource the codesource associated with the caller.
     * This encapsulates the original location of the code (where the code
     * came from) and the public key(s) of its signer.
     *
     * @return the set of permissions according to the policy.
     */
    PermissionCollection getPermissions(CodeSource codesource) {

<span class="nc bnc" id="L600" title="All 2 branches missed.">        if (initialized) {</span>
<span class="nc" id="L601">            return getPermissions(new Permissions(), codesource);</span>
        } else {
<span class="nc" id="L603">            return new PolicyPermissions(this, codesource);</span>
        }
    }

    /**
     * Examines the global policy for the specified CodeSource, and
     * creates a PermissionCollection object with
     * the set of permissions for that principal's protection domain.
     *
     * @param permissions the permissions to populate
     * @param codesource the codesource associated with the caller.
     * This encapsulates the original location of the code (where the code
     * came from) and the public key(s) of its signer.
     *
     * @return the set of permissions according to the policy.
     */
    Permissions getPermissions(final Permissions perms,
                               final CodeSource cs)
    {
<span class="nc bnc" id="L622" title="All 2 branches missed.">        if (!initialized) {</span>
<span class="nc" id="L623">            init();</span>
        }

<span class="nc" id="L626">        final CodeSource codesource[] = {null};</span>

<span class="nc" id="L628">        codesource[0] = canonicalizeCodebase(cs, true);</span>

<span class="nc bnc" id="L630" title="All 2 branches missed.">        if (debug != null) {</span>
<span class="nc" id="L631">            debug.println(&quot;evaluate(&quot; + codesource[0] + &quot;)\n&quot;);</span>
        }

        // needs to be in a begin/endPrivileged block because
        // codesource.implies calls URL.equals which does an
        // InetAddress lookup

<span class="nc bnc" id="L638" title="All 2 branches missed.">        for (int i = 0; i &lt; policyEntries.size(); i++) {</span>

<span class="nc" id="L640">           PolicyEntry entry = policyEntries.elementAt(i);</span>

<span class="nc bnc" id="L642" title="All 2 branches missed.">           if (debug != null) {</span>
<span class="nc" id="L643">                debug.println(&quot;PolicyFile CodeSource implies: &quot; +</span>
<span class="nc" id="L644">                              entry.codesource.toString() + &quot;\n\n&quot; +</span>
<span class="nc" id="L645">                              &quot;\t&quot; + codesource[0].toString() + &quot;\n\n&quot;);</span>
           }

<span class="nc bnc" id="L648" title="All 2 branches missed.">           if (entry.codesource.implies(codesource[0])) {</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">               for (int j = 0; j &lt; entry.permissions.size(); j++) {</span>
<span class="nc" id="L650">                    Permission p = entry.permissions.elementAt(j);</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">                    if (debug != null) {</span>
<span class="nc" id="L652">                        debug.println(&quot;  granting &quot; + p);</span>
                    }
<span class="nc bnc" id="L654" title="All 2 branches missed.">                    if (!addSelfPermissions(p, entry.codesource,</span>
                                            codesource[0], perms)) {
                        // we could check for duplicates
                        // before adding new permissions,
                        // but the SubjectDomainCombiner
                        // already checks for duplicates later
<span class="nc" id="L660">                        perms.add(p);</span>
                    }
                }
            }
        }

        // now see if any of the keys are trusted ids.

<span class="nc bnc" id="L668" title="All 2 branches missed.">        if (!ignoreIdentityScope) {</span>
<span class="nc" id="L669">            Certificate certs[] = codesource[0].getCertificates();</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">            if (certs != null) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">                for (int k=0; k &lt; certs.length; k++) {</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">                    if (aliasMapping.get(certs[k]) == null &amp;&amp;</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">                        checkForTrustedIdentity(certs[k])) {</span>
                        // checkForTrustedIdentity added it
                        // to the policy for us. next time
                        // around we'll find it. This time
                        // around we need to add it.
<span class="nc" id="L678">                        perms.add(new java.security.AllPermission());</span>
                    }
                }
            }
        }
<span class="nc" id="L683">        return perms;</span>
    }

    /**
     * Returns true if 'Self' permissions were added to the provided
     * 'perms', and false otherwise.
     *
     * &lt;p&gt;
     *
     * @param p check to see if this Permission is a &quot;SELF&quot;
     *                  PrivateCredentialPermission. &lt;p&gt;
     *
     * @param entryCs the codesource for the Policy entry.
     *
     * @param accCs the codesource for from the current AccessControlContext.
     *
     * @param perms the PermissionCollection where the individual
     *                  PrivateCredentialPermissions will be added.
     */
    private boolean addSelfPermissions(final Permission p,
                                       CodeSource entryCs,
                                       CodeSource accCs,
                                       Permissions perms) {

<span class="nc bnc" id="L707" title="All 2 branches missed.">        if (!(p instanceof PrivateCredentialPermission)) {</span>
<span class="nc" id="L708">            return false;</span>
        }

<span class="nc bnc" id="L711" title="All 2 branches missed.">        if (!(entryCs instanceof SubjectCodeSource)) {</span>
<span class="nc" id="L712">            return false;</span>
        }

<span class="nc" id="L715">        PrivateCredentialPermission pcp = (PrivateCredentialPermission)p;</span>
<span class="nc" id="L716">        SubjectCodeSource scs = (SubjectCodeSource)entryCs;</span>

        // see if it is a SELF permission
<span class="nc" id="L719">        String[][] pPrincipals = pcp.getPrincipals();</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">        if (pPrincipals.length &lt;= 0 ||</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">            !pPrincipals[0][0].equalsIgnoreCase(&quot;self&quot;) ||</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">            !pPrincipals[0][1].equalsIgnoreCase(&quot;self&quot;)) {</span>

            // regular PrivateCredentialPermission
<span class="nc" id="L725">            return false;</span>
        } else {

            // granted a SELF permission - create a
            // PrivateCredentialPermission for each
            // of the Policy entry's CodeSource Principals

<span class="nc bnc" id="L732" title="All 2 branches missed.">            if (scs.getPrincipals() == null) {</span>
                // XXX SubjectCodeSource has no Subject???
<span class="nc" id="L734">                return true;</span>
            }

<span class="nc bnc" id="L737" title="All 2 branches missed.">            for (PrincipalEntry principal : scs.getPrincipals()) {</span>

                //      if the Policy entry's Principal does not contain a
                //              WILDCARD for the Principal name, then a
                //              new PrivateCredentialPermission is created
                //              for the Principal listed in the Policy entry.
                //      if the Policy entry's Principal contains a WILDCARD
                //              for the Principal name, then a new
                //              PrivateCredentialPermission is created
                //              for each Principal associated with the Subject
                //              in the current ACC.

<span class="nc" id="L749">                String[][] principalInfo = getPrincipalInfo(principal, accCs);</span>

<span class="nc bnc" id="L751" title="All 2 branches missed.">                for (int i = 0; i &lt; principalInfo.length; i++) {</span>

                    // here's the new PrivateCredentialPermission

<span class="nc" id="L755">                    PrivateCredentialPermission newPcp =</span>
                        new PrivateCredentialPermission
<span class="nc" id="L757">                                (pcp.getCredentialClass() +</span>
                                        &quot; &quot; +
                                        principalInfo[i][0] +
                                        &quot; &quot; +
                                        &quot;\&quot;&quot; + principalInfo[i][1] + &quot;\&quot;&quot;,
                                &quot;read&quot;);

<span class="nc bnc" id="L764" title="All 2 branches missed.">                    if (debug != null) {</span>
<span class="nc" id="L765">                        debug.println(&quot;adding SELF permission: &quot; +</span>
<span class="nc" id="L766">                                        newPcp.toString());</span>
                    }

<span class="nc" id="L769">                    perms.add(newPcp);</span>
                }
<span class="nc" id="L771">            }</span>
        }
<span class="nc" id="L773">        return true;</span>
    }

    /**
     * return the principal class/name pair in the 2D array.
     * array[x][y]:     x corresponds to the array length.
     *                  if (y == 0), it's the principal class.
     *                  if (y == 1), it's the principal name.
     */
    private String[][] getPrincipalInfo(PrincipalEntry principal,
                                        final CodeSource accCs) {

        // there are 3 possibilities:
        // 1) the entry's Principal class and name are not wildcarded
        // 2) the entry's Principal name is wildcarded only
        // 3) the entry's Principal class and name are wildcarded

<span class="nc" id="L790">        if (!principal.getPrincipalClass().equals</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">                (PrincipalEntry.WILDCARD_CLASS) &amp;&amp;</span>
<span class="nc" id="L792">            !principal.getPrincipalName().equals</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">                (PrincipalEntry.WILDCARD_NAME)) {</span>

            // build a PrivateCredentialPermission for the principal
            // from the Policy entry
<span class="nc" id="L797">            String[][] info = new String[1][2];</span>
<span class="nc" id="L798">            info[0][0] = principal.getPrincipalClass();</span>
<span class="nc" id="L799">            info[0][1] = principal.getPrincipalName();</span>
<span class="nc" id="L800">            return info;</span>

<span class="nc" id="L802">        } else if (!principal.getPrincipalClass().equals</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">                (PrincipalEntry.WILDCARD_CLASS) &amp;&amp;</span>
<span class="nc" id="L804">            principal.getPrincipalName().equals</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">                (PrincipalEntry.WILDCARD_NAME)) {</span>

            // build a PrivateCredentialPermission for all
            // the Subject's principals that are instances of principalClass

            // the accCs is guaranteed to be a SubjectCodeSource
            // because the earlier CodeSource.implies succeeded
<span class="nc" id="L812">            SubjectCodeSource scs = (SubjectCodeSource)accCs;</span>

<span class="nc" id="L814">            Set&lt;? extends Principal&gt; principalSet = null;</span>
            try {
                // principal.principalClass should extend Principal
                // If it doesn't, we should stop here with a ClassCastException.
                @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L819">                Class&lt;? extends Principal&gt; pClass = (Class&lt;? extends Principal&gt;)</span>
<span class="nc" id="L820">                        Class.forName(principal.getPrincipalClass(), false,</span>
<span class="nc" id="L821">                                      ClassLoader.getSystemClassLoader());</span>
<span class="nc" id="L822">                principalSet = scs.getSubject().getPrincipals(pClass);</span>
<span class="nc" id="L823">            } catch (Exception e) {</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">                if (debug != null) {</span>
<span class="nc" id="L825">                    debug.println(&quot;problem finding Principal Class &quot; +</span>
                                  &quot;when expanding SELF permission: &quot; +
<span class="nc" id="L827">                                  e.toString());</span>
                }
<span class="nc" id="L829">            }</span>

<span class="nc bnc" id="L831" title="All 2 branches missed.">            if (principalSet == null) {</span>
                // error
<span class="nc" id="L833">                return new String[0][0];</span>
            }

<span class="nc" id="L836">            String[][] info = new String[principalSet.size()][2];</span>

<span class="nc" id="L838">            int i = 0;</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">            for (Principal p : principalSet) {</span>
<span class="nc" id="L840">                info[i][0] = p.getClass().getName();</span>
<span class="nc" id="L841">                info[i][1] = p.getName();</span>
<span class="nc" id="L842">                i++;</span>
<span class="nc" id="L843">            }</span>
<span class="nc" id="L844">            return info;</span>

        } else {

            // build a PrivateCredentialPermission for every
            // one of the current Subject's principals

            // the accCs is guaranteed to be a SubjectCodeSource
            // because the earlier CodeSource.implies succeeded
<span class="nc" id="L853">            SubjectCodeSource scs = (SubjectCodeSource)accCs;</span>
<span class="nc" id="L854">            Set&lt;Principal&gt; principalSet = scs.getSubject().getPrincipals();</span>

<span class="nc" id="L856">            String[][] info = new String[principalSet.size()][2];</span>

<span class="nc" id="L858">            int i = 0;</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">            for (Principal p : principalSet) {</span>
<span class="nc" id="L860">                info[i][0] = p.getClass().getName();</span>
<span class="nc" id="L861">                info[i][1] = p.getName();</span>
<span class="nc" id="L862">                i++;</span>
<span class="nc" id="L863">            }</span>
<span class="nc" id="L864">            return info;</span>
        }
    }

    /*
     * Returns the signer certificates from the list of certificates associated
     * with the given code source.
     *
     * The signer certificates are those certificates that were used to verify
     * signed code originating from the codesource location.
     *
     * This method assumes that in the given code source, each signer
     * certificate is followed by its supporting certificate chain
     * (which may be empty), and that the signer certificate and its
     * supporting certificate chain are ordered bottom-to-top (i.e., with the
     * signer certificate first and the (root) certificate authority last).
     */
    Certificate[] getSignerCertificates(CodeSource cs) {
<span class="nc" id="L882">        Certificate[] certs = null;</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">        if ((certs = cs.getCertificates()) == null) {</span>
<span class="nc" id="L884">            return null;</span>
        }
<span class="nc bnc" id="L886" title="All 2 branches missed.">        for (int i = 0; i &lt; certs.length; i++) {</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">            if (!(certs[i] instanceof X509Certificate))</span>
<span class="nc" id="L888">                return cs.getCertificates();</span>
        }

        // Do we have to do anything?
<span class="nc" id="L892">        int i = 0;</span>
<span class="nc" id="L893">        int count = 0;</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">        while (i &lt; certs.length) {</span>
<span class="nc" id="L895">            count++;</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">            while (((i+1) &lt; certs.length)</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">                   &amp;&amp; ((X509Certificate)certs[i]).getIssuerDN().equals(</span>
<span class="nc" id="L898">                           ((X509Certificate)certs[i+1]).getSubjectDN())) {</span>
<span class="nc" id="L899">                i++;</span>
            }
<span class="nc" id="L901">            i++;</span>
        }
<span class="nc bnc" id="L903" title="All 2 branches missed.">        if (count == certs.length) {</span>
            // Done
<span class="nc" id="L905">            return certs;</span>
        }

<span class="nc" id="L908">        ArrayList&lt;Certificate&gt; userCertList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L909">        i = 0;</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">        while (i &lt; certs.length) {</span>
<span class="nc" id="L911">            userCertList.add(certs[i]);</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">            while (((i+1) &lt; certs.length)</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">                   &amp;&amp; ((X509Certificate)certs[i]).getIssuerDN().equals(</span>
<span class="nc" id="L914">                           ((X509Certificate)certs[i+1]).getSubjectDN())) {</span>
<span class="nc" id="L915">                i++;</span>
            }
<span class="nc" id="L917">            i++;</span>
        }
<span class="nc" id="L919">        Certificate[] userCerts = new Certificate[userCertList.size()];</span>
<span class="nc" id="L920">        userCertList.toArray(userCerts);</span>
<span class="nc" id="L921">        return userCerts;</span>
    }

    private CodeSource canonicalizeCodebase(CodeSource cs,
                                            boolean extractSignerCerts) {
<span class="nc" id="L926">        CodeSource canonCs = cs;</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">        if (cs.getLocation() != null &amp;&amp;</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">            cs.getLocation().getProtocol().equalsIgnoreCase(&quot;file&quot;)) {</span>
            try {
<span class="nc" id="L930">                String path = cs.getLocation().getFile().replace</span>
<span class="nc" id="L931">                                                        ('/',</span>
                                                        File.separatorChar);
<span class="nc" id="L933">                URL csUrl = null;</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">                if (path.endsWith(&quot;*&quot;)) {</span>
                    // remove trailing '*' because it causes canonicalization
                    // to fail on win32
<span class="nc" id="L937">                    path = path.substring(0, path.length()-1);</span>
<span class="nc" id="L938">                    boolean appendFileSep = false;</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">                    if (path.endsWith(File.separator)) {</span>
<span class="nc" id="L940">                        appendFileSep = true;</span>
                    }
<span class="nc bnc" id="L942" title="All 2 branches missed.">                    if (path.equals(&quot;&quot;)) {</span>
<span class="nc" id="L943">                        path = System.getProperty(&quot;user.dir&quot;);</span>
                    }
<span class="nc" id="L945">                    File f = new File(path);</span>
<span class="nc" id="L946">                    path = f.getCanonicalPath();</span>
<span class="nc" id="L947">                    StringBuffer sb = new StringBuffer(path);</span>
                    // reappend '*' to canonicalized filename (note that
                    // canonicalization may have removed trailing file
                    // separator, so we have to check for that, too)
<span class="nc bnc" id="L951" title="All 4 branches missed.">                    if (!path.endsWith(File.separator) &amp;&amp;</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">                        (appendFileSep || f.isDirectory())) {</span>
<span class="nc" id="L953">                        sb.append(File.separatorChar);</span>
                    }
<span class="nc" id="L955">                    sb.append('*');</span>
<span class="nc" id="L956">                    path = sb.toString();</span>
<span class="nc" id="L957">                } else {</span>
<span class="nc" id="L958">                    path = new File(path).getCanonicalPath();</span>
                }
<span class="nc" id="L960">                csUrl = new File(path).toURL();</span>

<span class="nc bnc" id="L962" title="All 2 branches missed.">                if (cs instanceof SubjectCodeSource) {</span>
<span class="nc" id="L963">                    SubjectCodeSource scs = (SubjectCodeSource)cs;</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">                    if (extractSignerCerts) {</span>
<span class="nc" id="L965">                        canonCs = new SubjectCodeSource(scs.getSubject(),</span>
<span class="nc" id="L966">                                                        scs.getPrincipals(),</span>
                                                        csUrl,
<span class="nc" id="L968">                                                        getSignerCertificates(scs));</span>
                    } else {
<span class="nc" id="L970">                        canonCs = new SubjectCodeSource(scs.getSubject(),</span>
<span class="nc" id="L971">                                                        scs.getPrincipals(),</span>
                                                        csUrl,
<span class="nc" id="L973">                                                        scs.getCertificates());</span>
                    }
<span class="nc" id="L975">                } else {</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">                    if (extractSignerCerts) {</span>
<span class="nc" id="L977">                        canonCs = new CodeSource(csUrl,</span>
<span class="nc" id="L978">                                                 getSignerCertificates(cs));</span>
                    } else {
<span class="nc" id="L980">                        canonCs = new CodeSource(csUrl,</span>
<span class="nc" id="L981">                                                 cs.getCertificates());</span>
                    }
                }
<span class="nc" id="L984">            } catch (IOException ioe) {</span>
                // leave codesource as it is, unless we have to extract its
                // signer certificates
<span class="nc bnc" id="L987" title="All 2 branches missed.">                if (extractSignerCerts) {</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">                    if (!(cs instanceof SubjectCodeSource)) {</span>
<span class="nc" id="L989">                        canonCs = new CodeSource(cs.getLocation(),</span>
<span class="nc" id="L990">                                                getSignerCertificates(cs));</span>
                    } else {
<span class="nc" id="L992">                        SubjectCodeSource scs = (SubjectCodeSource)cs;</span>
<span class="nc" id="L993">                        canonCs = new SubjectCodeSource(scs.getSubject(),</span>
<span class="nc" id="L994">                                                scs.getPrincipals(),</span>
<span class="nc" id="L995">                                                scs.getLocation(),</span>
<span class="nc" id="L996">                                                getSignerCertificates(scs));</span>
                    }
                }
<span class="nc" id="L999">            }</span>
        } else {
<span class="nc bnc" id="L1001" title="All 2 branches missed.">            if (extractSignerCerts) {</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">                if (!(cs instanceof SubjectCodeSource)) {</span>
<span class="nc" id="L1003">                    canonCs = new CodeSource(cs.getLocation(),</span>
<span class="nc" id="L1004">                                        getSignerCertificates(cs));</span>
                } else {
<span class="nc" id="L1006">                    SubjectCodeSource scs = (SubjectCodeSource)cs;</span>
<span class="nc" id="L1007">                    canonCs = new SubjectCodeSource(scs.getSubject(),</span>
<span class="nc" id="L1008">                                        scs.getPrincipals(),</span>
<span class="nc" id="L1009">                                        scs.getLocation(),</span>
<span class="nc" id="L1010">                                        getSignerCertificates(scs));</span>
                }
            }
        }
<span class="nc" id="L1014">        return canonCs;</span>
    }

    /**
     * Each entry in the policy configuration file is represented by a
     * PolicyEntry object.  &lt;p&gt;
     *
     * A PolicyEntry is a (CodeSource,Permission) pair.  The
     * CodeSource contains the (URL, PublicKey) that together identify
     * where the Java bytecodes come from and who (if anyone) signed
     * them.  The URL could refer to localhost.  The URL could also be
     * null, meaning that this policy entry is given to all comers, as
     * long as they match the signer field.  The signer could be null,
     * meaning the code is not signed. &lt;p&gt;
     *
     * The Permission contains the (Type, Name, Action) triplet. &lt;p&gt;
     *
     * For now, the Policy object retrieves the public key from the
     * X.509 certificate on disk that corresponds to the signedBy
     * alias specified in the Policy config file.  For reasons of
     * efficiency, the Policy object keeps a hashtable of certs already
     * read in.  This could be replaced by a secure internal key
     * store.
     *
     * &lt;p&gt;
     * For example, the entry
     * &lt;pre&gt;
     *          permission java.io.File &quot;/tmp&quot;, &quot;read,write&quot;,
     *          signedBy &quot;Duke&quot;;
     * &lt;/pre&gt;
     * is represented internally
     * &lt;pre&gt;
     *
     * FilePermission f = new FilePermission(&quot;/tmp&quot;, &quot;read,write&quot;);
     * PublicKey p = publickeys.get(&quot;Duke&quot;);
     * URL u = InetAddress.getLocalHost();
     * CodeBase c = new CodeBase( p, u );
     * pe = new PolicyEntry(f, c);
     * &lt;/pre&gt;
     *
     * @author Marianne Mueller
     * @author Roland Schemers
     * @see java.security.CodeSource
     * @see java.security.Policy
     * @see java.security.Permissions
     * @see java.security.ProtectionDomain
     */
    private static class PolicyEntry {

        CodeSource codesource;
        Vector&lt;Permission&gt; permissions;

        /**
         * Given a Permission and a CodeSource, create a policy entry.
         *
         * XXX Decide if/how to add validity fields and &quot;purpose&quot; fields to
         * XXX policy entries
         *
         * @param cs the CodeSource, which encapsulates the URL and the public
         *        key attributes from the policy config file. Validity checks
         *        are performed on the public key before PolicyEntry is called.
         *
         */
<span class="nc" id="L1077">        PolicyEntry(CodeSource cs) {</span>
<span class="nc" id="L1078">            this.codesource = cs;</span>
<span class="nc" id="L1079">            this.permissions = new Vector&lt;Permission&gt;();</span>
<span class="nc" id="L1080">        }</span>

        /**
         * add a Permission object to this entry.
         */
        void add(Permission p) {
<span class="nc" id="L1086">            permissions.addElement(p);</span>
<span class="nc" id="L1087">        }</span>

        /**
         * Return the CodeSource for this policy entry
         */
        CodeSource getCodeSource() {
<span class="nc" id="L1093">            return this.codesource;</span>
        }

        @Override
        public String toString(){
<span class="nc" id="L1098">            StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L1099">            sb.append(rb.getString(&quot;LPARAM&quot;));</span>
<span class="nc" id="L1100">            sb.append(getCodeSource());</span>
<span class="nc" id="L1101">            sb.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">            for (int j = 0; j &lt; permissions.size(); j++) {</span>
<span class="nc" id="L1103">                Permission p = permissions.elementAt(j);</span>
<span class="nc" id="L1104">                sb.append(rb.getString(&quot;SPACE&quot;));</span>
<span class="nc" id="L1105">                sb.append(rb.getString(&quot;SPACE&quot;));</span>
<span class="nc" id="L1106">                sb.append(p);</span>
<span class="nc" id="L1107">                sb.append(rb.getString(&quot;NEWLINE&quot;));</span>
            }
<span class="nc" id="L1109">            sb.append(rb.getString(&quot;RPARAM&quot;));</span>
<span class="nc" id="L1110">            sb.append(rb.getString(&quot;NEWLINE&quot;));</span>
<span class="nc" id="L1111">            return sb.toString();</span>
        }

    }
}

@SuppressWarnings(&quot;deprecation&quot;)
class PolicyPermissions extends PermissionCollection {

    private static final long serialVersionUID = -1954188373270545523L;

    private CodeSource codesource;
    private Permissions perms;
    private AuthPolicyFile policy;
    private boolean notInit; // have we pulled in the policy permissions yet?
    private Vector&lt;Permission&gt; additionalPerms;

    PolicyPermissions(AuthPolicyFile policy,
                      CodeSource codesource)
<span class="nc" id="L1130">    {</span>
<span class="nc" id="L1131">        this.codesource = codesource;</span>
<span class="nc" id="L1132">        this.policy = policy;</span>
<span class="nc" id="L1133">        this.perms = null;</span>
<span class="nc" id="L1134">        this.notInit = true;</span>
<span class="nc" id="L1135">        this.additionalPerms = null;</span>
<span class="nc" id="L1136">    }</span>

    @Override
    public void add(Permission permission) {
<span class="nc bnc" id="L1140" title="All 2 branches missed.">        if (isReadOnly())</span>
<span class="nc" id="L1141">            throw new SecurityException</span>
            (AuthPolicyFile.rb.getString
<span class="nc" id="L1143">            (&quot;attempt.to.add.a.Permission.to.a.readonly.PermissionCollection&quot;));</span>

<span class="nc bnc" id="L1145" title="All 2 branches missed.">        if (perms == null) {</span>
<span class="nc bnc" id="L1146" title="All 2 branches missed.">            if (additionalPerms == null) {</span>
<span class="nc" id="L1147">                additionalPerms = new Vector&lt;Permission&gt;();</span>
            }
<span class="nc" id="L1149">            additionalPerms.add(permission);</span>
        } else {
<span class="nc" id="L1151">            perms.add(permission);</span>
        }
<span class="nc" id="L1153">    }</span>

    private synchronized void init() {
<span class="nc bnc" id="L1156" title="All 2 branches missed.">        if (notInit) {</span>
<span class="nc bnc" id="L1157" title="All 2 branches missed.">            if (perms == null) {</span>
<span class="nc" id="L1158">                perms = new Permissions();</span>
            }
<span class="nc bnc" id="L1160" title="All 2 branches missed.">            if (additionalPerms != null) {</span>
<span class="nc" id="L1161">                Enumeration&lt;Permission&gt; e = additionalPerms.elements();</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">                while (e.hasMoreElements()) {</span>
<span class="nc" id="L1163">                    perms.add(e.nextElement());</span>
                }
<span class="nc" id="L1165">                additionalPerms = null;</span>
            }
<span class="nc" id="L1167">            policy.getPermissions(perms, codesource);</span>
<span class="nc" id="L1168">            notInit = false;</span>
        }
<span class="nc" id="L1170">    }</span>

    @Override
    public boolean implies(Permission permission) {
<span class="nc bnc" id="L1174" title="All 2 branches missed.">        if (notInit) {</span>
<span class="nc" id="L1175">            init();</span>
        }
<span class="nc" id="L1177">        return perms.implies(permission);</span>
    }

    @Override
    public Enumeration&lt;Permission&gt; elements() {
<span class="nc bnc" id="L1182" title="All 2 branches missed.">        if (notInit) {</span>
<span class="nc" id="L1183">            init();</span>
        }
<span class="nc" id="L1185">        return perms.elements();</span>
    }

    @Override
    public String toString() {
<span class="nc bnc" id="L1190" title="All 2 branches missed.">        if (notInit) {</span>
<span class="nc" id="L1191">            init();</span>
        }
<span class="nc" id="L1193">        return perms.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>