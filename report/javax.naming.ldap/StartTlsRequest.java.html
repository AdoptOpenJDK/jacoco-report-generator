<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StartTlsRequest.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.naming.ldap</a> &gt; <span class="el_source">StartTlsRequest.java</span></div><h1>StartTlsRequest.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.naming.ldap;

import java.util.Iterator;
import java.security.AccessController;
import java.security.PrivilegedAction;
import javax.naming.ConfigurationException;
import javax.naming.NamingException;
import com.sun.naming.internal.VersionHelper;
import java.util.ServiceLoader;
import java.util.ServiceConfigurationError;

/**
 * This class implements the LDAPv3 Extended Request for StartTLS as
 * defined in
 * &lt;a href=&quot;http://www.ietf.org/rfc/rfc2830.txt&quot;&gt;Lightweight Directory
 * Access Protocol (v3): Extension for Transport Layer Security&lt;/a&gt;
 *
 * The object identifier for StartTLS is 1.3.6.1.4.1.1466.20037
 * and no extended request value is defined.
 *&lt;p&gt;
 * &lt;tt&gt;StartTlsRequest&lt;/tt&gt;/&lt;tt&gt;StartTlsResponse&lt;/tt&gt; are used to establish
 * a TLS connection over the existing LDAP connection associated with
 * the JNDI context on which &lt;tt&gt;extendedOperation()&lt;/tt&gt; is invoked.
 * Typically, a JNDI program uses these classes as follows.
 * &lt;blockquote&gt;&lt;pre&gt;
 * import javax.naming.ldap.*;
 *
 * // Open an LDAP association
 * LdapContext ctx = new InitialLdapContext();
 *
 * // Perform a StartTLS extended operation
 * StartTlsResponse tls =
 *     (StartTlsResponse) ctx.extendedOperation(new StartTlsRequest());
 *
 * // Open a TLS connection (over the existing LDAP association) and get details
 * // of the negotiated TLS session: cipher suite, peer certificate, etc.
 * SSLSession session = tls.negotiate();
 *
 * // ... use ctx to perform protected LDAP operations
 *
 * // Close the TLS connection (revert back to the underlying LDAP association)
 * tls.close();
 *
 * // ... use ctx to perform unprotected LDAP operations
 *
 * // Close the LDAP association
 * ctx.close;
 * &lt;/pre&gt;&lt;/blockquote&gt;
 *
 * @since 1.4
 * @see StartTlsResponse
 * @author Vincent Ryan
 */
public class StartTlsRequest implements ExtendedRequest {

    // Constant

    /**
     * The StartTLS extended request's assigned object identifier
     * is 1.3.6.1.4.1.1466.20037.
     */
    public static final String OID = &quot;1.3.6.1.4.1.1466.20037&quot;;


    // Constructors

    /**
     * Constructs a StartTLS extended request.
     */
<span class="nc" id="L95">    public StartTlsRequest() {</span>
<span class="nc" id="L96">    }</span>


    // ExtendedRequest methods

    /**
     * Retrieves the StartTLS request's object identifier string.
     *
     * @return The object identifier string, &quot;1.3.6.1.4.1.1466.20037&quot;.
     */
    public String getID() {
<span class="nc" id="L107">        return OID;</span>
    }

    /**
     * Retrieves the StartTLS request's ASN.1 BER encoded value.
     * Since the request has no defined value, null is always
     * returned.
     *
     * @return The null value.
     */
    public byte[] getEncodedValue() {
<span class="nc" id="L118">        return null;</span>
    }

    /**
     * Creates an extended response object that corresponds to the
     * LDAP StartTLS extended request.
     * &lt;p&gt;
     * The result must be a concrete subclass of StartTlsResponse
     * and must have a public zero-argument constructor.
     * &lt;p&gt;
     * This method locates the implementation class by locating
     * configuration files that have the name:
     * &lt;blockquote&gt;&lt;tt&gt;
     *     META-INF/services/javax.naming.ldap.StartTlsResponse
     * &lt;/tt&gt;&lt;/blockquote&gt;
     * The configuration files and their corresponding implementation classes must
     * be accessible to the calling thread's context class loader.
     * &lt;p&gt;
     * Each configuration file should contain a list of fully-qualified class
     * names, one per line.  Space and tab characters surrounding each name, as
     * well as blank lines, are ignored.  The comment character is &lt;tt&gt;'#'&lt;/tt&gt;
     * (&lt;tt&gt;0x23&lt;/tt&gt;); on each line all characters following the first comment
     * character are ignored.  The file must be encoded in UTF-8.
     * &lt;p&gt;
     * This method will return an instance of the first implementation
     * class that it is able to load and instantiate successfully from
     * the list of class names collected from the configuration files.
     * This method uses the calling thread's context classloader to find the
     * configuration files and to load the implementation class.
     * &lt;p&gt;
     * If no class can be found in this way, this method will use
     * an implementation-specific way to locate an implementation.
     * If none is found, a NamingException is thrown.
     *
     * @param id         The object identifier of the extended response.
     *                   Its value must be &quot;1.3.6.1.4.1.1466.20037&quot; or null.
     *                   Both values are equivalent.
     * @param berValue   The possibly null ASN.1 BER encoded value of the
     *                   extended response. This is the raw BER bytes
     *                   including the tag and length of the response value.
     *                   It does not include the response OID.
     *                   Its value is ignored because a Start TLS response
     *                   is not expected to contain any response value.
     * @param offset     The starting position in berValue of the bytes to use.
     *                   Its value is ignored because a Start TLS response
     *                   is not expected to contain any response value.
     * @param length     The number of bytes in berValue to use.
     *                   Its value is ignored because a Start TLS response
     *                   is not expected to contain any response value.
     * @return           The StartTLS extended response object.
     * @exception        NamingException If a naming exception was encountered
     *                   while creating the StartTLS extended response object.
     */
    public ExtendedResponse createExtendedResponse(String id, byte[] berValue,
        int offset, int length) throws NamingException {

        // Confirm that the object identifier is correct
<span class="nc bnc" id="L175" title="All 4 branches missed.">        if ((id != null) &amp;&amp; (!id.equals(OID))) {</span>
<span class="nc" id="L176">            throw new ConfigurationException(</span>
                &quot;Start TLS received the following response instead of &quot; +
                OID + &quot;: &quot; + id);
        }

<span class="nc" id="L181">        StartTlsResponse resp = null;</span>

<span class="nc" id="L183">        ServiceLoader&lt;StartTlsResponse&gt; sl = ServiceLoader.load(</span>
<span class="nc" id="L184">                StartTlsResponse.class, getContextClassLoader());</span>
<span class="nc" id="L185">        Iterator&lt;StartTlsResponse&gt; iter = sl.iterator();</span>

<span class="nc bnc" id="L187" title="All 4 branches missed.">        while (resp == null &amp;&amp; privilegedHasNext(iter)) {</span>
<span class="nc" id="L188">            resp = iter.next();</span>
        }
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (resp != null) {</span>
<span class="nc" id="L191">            return resp;</span>
        }
        try {
<span class="nc" id="L194">            VersionHelper helper = VersionHelper.getVersionHelper();</span>
<span class="nc" id="L195">            Class&lt;?&gt; clas = helper.loadClass(</span>
                &quot;com.sun.jndi.ldap.ext.StartTlsResponseImpl&quot;);

<span class="nc" id="L198">            resp = (StartTlsResponse) clas.newInstance();</span>

<span class="nc" id="L200">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L201">            throw wrapException(e);</span>

<span class="nc" id="L203">        } catch (InstantiationException e) {</span>
<span class="nc" id="L204">            throw wrapException(e);</span>

<span class="nc" id="L206">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L207">            throw wrapException(e);</span>
<span class="nc" id="L208">        }</span>

<span class="nc" id="L210">        return resp;</span>
    }

    /*
     * Wrap an exception, thrown while attempting to load the StartTlsResponse
     * class, in a configuration exception.
     */
    private ConfigurationException wrapException(Exception e) {
<span class="nc" id="L218">        ConfigurationException ce = new ConfigurationException(</span>
            &quot;Cannot load implementation of javax.naming.ldap.StartTlsResponse&quot;);

<span class="nc" id="L221">        ce.setRootCause(e);</span>
<span class="nc" id="L222">        return ce;</span>
    }

    /*
     * Acquire the class loader associated with this thread.
     */
    private final ClassLoader getContextClassLoader() {
<span class="nc" id="L229">        return AccessController.doPrivileged(</span>
<span class="nc" id="L230">            new PrivilegedAction&lt;ClassLoader&gt;() {</span>
                public ClassLoader run() {
<span class="nc" id="L232">                    return Thread.currentThread().getContextClassLoader();</span>
                }
            }
        );
    }

    private final static boolean privilegedHasNext(final Iterator&lt;StartTlsResponse&gt; iter) {
<span class="nc" id="L239">        Boolean answer = AccessController.doPrivileged(</span>
<span class="nc" id="L240">            new PrivilegedAction&lt;Boolean&gt;() {</span>
            public Boolean run() {
<span class="nc" id="L242">                return Boolean.valueOf(iter.hasNext());</span>
            }
        });
<span class="nc" id="L245">        return answer.booleanValue();</span>
    }

    private static final long serialVersionUID = 4441679576360753397L;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>