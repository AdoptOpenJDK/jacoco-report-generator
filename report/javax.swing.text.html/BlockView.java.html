<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>BlockView.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.text.html</a> &gt; <span class="el_source">BlockView.java</span></div><h1>BlockView.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2006, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package javax.swing.text.html;

import java.util.Enumeration;
import java.awt.*;
import javax.swing.SizeRequirements;
import javax.swing.border.*;
import javax.swing.event.DocumentEvent;
import javax.swing.text.*;

/**
 * A view implementation to display a block (as a box)
 * with CSS specifications.
 *
 * @author  Timothy Prinzing
 */
public class BlockView extends BoxView  {

    /**
     * Creates a new view that represents an
     * html box.  This can be used for a number
     * of elements.
     *
     * @param elem the element to create a view for
     * @param axis either View.X_AXIS or View.Y_AXIS
     */
    public BlockView(Element elem, int axis) {
<span class="nc" id="L51">        super(elem, axis);</span>
<span class="nc" id="L52">    }</span>

    /**
     * Establishes the parent view for this view.  This is
     * guaranteed to be called before any other methods if the
     * parent view is functioning properly.
     * &lt;p&gt;
     * This is implemented
     * to forward to the superclass as well as call the
     * {@link #setPropertiesFromAttributes()}
     * method to set the paragraph properties from the css
     * attributes.  The call is made at this time to ensure
     * the ability to resolve upward through the parents
     * view attributes.
     *
     * @param parent the new parent, or null if the view is
     *  being removed from a parent it was previously added
     *  to
     */
    public void setParent(View parent) {
<span class="nc" id="L72">        super.setParent(parent);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (parent != null) {</span>
<span class="nc" id="L74">            setPropertiesFromAttributes();</span>
        }
<span class="nc" id="L76">    }</span>

    /**
     * Calculate the requirements of the block along the major
     * axis (i.e. the axis along with it tiles).  This is implemented
     * to provide the superclass behavior and then adjust it if the
     * CSS width or height attribute is specified and applicable to
     * the axis.
     */
    protected SizeRequirements calculateMajorAxisRequirements(int axis, SizeRequirements r) {
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (r == null) {</span>
<span class="nc" id="L87">            r = new SizeRequirements();</span>
        }
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (! spanSetFromAttributes(axis, r, cssWidth, cssHeight)) {</span>
<span class="nc" id="L90">            r = super.calculateMajorAxisRequirements(axis, r);</span>
        }
        else {
            // Offset by the margins so that pref/min/max return the
            // right value.
<span class="nc" id="L95">            SizeRequirements parentR = super.calculateMajorAxisRequirements(</span>
                                      axis, null);
<span class="nc bnc" id="L97" title="All 2 branches missed.">            int margin = (axis == X_AXIS) ? getLeftInset() + getRightInset() :</span>
<span class="nc" id="L98">                                            getTopInset() + getBottomInset();</span>
<span class="nc" id="L99">            r.minimum -= margin;</span>
<span class="nc" id="L100">            r.preferred -= margin;</span>
<span class="nc" id="L101">            r.maximum -= margin;</span>
<span class="nc" id="L102">            constrainSize(axis, r, parentR);</span>
        }
<span class="nc" id="L104">        return r;</span>
    }

    /**
     * Calculate the requirements of the block along the minor
     * axis (i.e. the axis orthogonal to the axis along with it tiles).
     * This is implemented
     * to provide the superclass behavior and then adjust it if the
     * CSS width or height attribute is specified and applicable to
     * the axis.
     */
    protected SizeRequirements calculateMinorAxisRequirements(int axis, SizeRequirements r) {
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (r == null) {</span>
<span class="nc" id="L117">            r = new SizeRequirements();</span>
        }

<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (! spanSetFromAttributes(axis, r, cssWidth, cssHeight)) {</span>

            /*
             * The requirements were not directly specified by attributes, so
             * compute the aggregate of the requirements of the children.  The
             * children that have a percentage value specified will be treated
             * as completely stretchable since that child is not limited in any
             * way.
             */
/*
            int min = 0;
            long pref = 0;
            int max = 0;
            int n = getViewCount();
            for (int i = 0; i &lt; n; i++) {
                View v = getView(i);
                min = Math.max((int) v.getMinimumSpan(axis), min);
                pref = Math.max((int) v.getPreferredSpan(axis), pref);
                if (
                max = Math.max((int) v.getMaximumSpan(axis), max);

            }
            r.preferred = (int) pref;
            r.minimum = min;
            r.maximum = max;
            */
<span class="nc" id="L146">            r = super.calculateMinorAxisRequirements(axis, r);</span>
        }
        else {
            // Offset by the margins so that pref/min/max return the
            // right value.
<span class="nc" id="L151">            SizeRequirements parentR = super.calculateMinorAxisRequirements(</span>
                                      axis, null);
<span class="nc bnc" id="L153" title="All 2 branches missed.">            int margin = (axis == X_AXIS) ? getLeftInset() + getRightInset() :</span>
<span class="nc" id="L154">                                            getTopInset() + getBottomInset();</span>
<span class="nc" id="L155">            r.minimum -= margin;</span>
<span class="nc" id="L156">            r.preferred -= margin;</span>
<span class="nc" id="L157">            r.maximum -= margin;</span>
<span class="nc" id="L158">            constrainSize(axis, r, parentR);</span>
        }

        /*
         * Set the alignment based upon the CSS properties if it is
         * specified.  For X_AXIS this would be text-align, for
         * Y_AXIS this would be vertical-align.
         */
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (axis == X_AXIS) {</span>
<span class="nc" id="L167">            Object o = getAttributes().getAttribute(CSS.Attribute.TEXT_ALIGN);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (o != null) {</span>
<span class="nc" id="L169">                String align = o.toString();</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">                if (align.equals(&quot;center&quot;)) {</span>
<span class="nc" id="L171">                    r.alignment = 0.5f;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                } else if (align.equals(&quot;right&quot;)) {</span>
<span class="nc" id="L173">                    r.alignment = 1.0f;</span>
                } else {
<span class="nc" id="L175">                    r.alignment = 0.0f;</span>
                }
            }
        }
        // Y_AXIS TBD
<span class="nc" id="L180">        return r;</span>
    }

    boolean isPercentage(int axis, AttributeSet a) {
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (axis == X_AXIS) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (cssWidth != null) {</span>
<span class="nc" id="L186">                return cssWidth.isPercentage();</span>
            }
        } else {
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (cssHeight != null) {</span>
<span class="nc" id="L190">                return cssHeight.isPercentage();</span>
            }
        }
<span class="nc" id="L193">        return false;</span>
    }

    /**
     * Adjust the given requirements to the CSS width or height if
     * it is specified along the applicable axis.  Return true if the
     * size is exactly specified, false if the span is not specified
     * in an attribute or the size specified is a percentage.
     */
    static boolean spanSetFromAttributes(int axis, SizeRequirements r,
                                         CSS.LengthValue cssWidth,
                                         CSS.LengthValue cssHeight) {
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (axis == X_AXIS) {</span>
<span class="nc bnc" id="L206" title="All 4 branches missed.">            if ((cssWidth != null) &amp;&amp; (! cssWidth.isPercentage())) {</span>
<span class="nc" id="L207">                r.minimum = r.preferred = r.maximum = (int) cssWidth.getValue();</span>
<span class="nc" id="L208">                return true;</span>
            }
        } else {
<span class="nc bnc" id="L211" title="All 4 branches missed.">            if ((cssHeight != null) &amp;&amp; (! cssHeight.isPercentage())) {</span>
<span class="nc" id="L212">                r.minimum = r.preferred = r.maximum = (int) cssHeight.getValue();</span>
<span class="nc" id="L213">                return true;</span>
            }
        }
<span class="nc" id="L216">        return false;</span>
    }

    /**
     * Performs layout for the minor axis of the box (i.e. the
     * axis orthogonal to the axis that it represents). The results
     * of the layout (the offset and span for each children) are
     * placed in the given arrays which represent the allocations to
     * the children along the minor axis.
     *
     * @param targetSpan the total span given to the view, which
     *  would be used to layout the children.
     * @param axis the axis being layed out
     * @param offsets the offsets from the origin of the view for
     *  each of the child views; this is a return value and is
     *  filled in by the implementation of this method
     * @param spans the span of each child view; this is a return
     *  value and is filled in by the implementation of this method
     */
    protected void layoutMinorAxis(int targetSpan, int axis, int[] offsets, int[] spans) {
<span class="nc" id="L236">        int n = getViewCount();</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        Object key = (axis == X_AXIS) ? CSS.Attribute.WIDTH : CSS.Attribute.HEIGHT;</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L239">            View v = getView(i);</span>
<span class="nc" id="L240">            int min = (int) v.getMinimumSpan(axis);</span>
            int max;

            // check for percentage span
<span class="nc" id="L244">            AttributeSet a = v.getAttributes();</span>
<span class="nc" id="L245">            CSS.LengthValue lv = (CSS.LengthValue) a.getAttribute(key);</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">            if ((lv != null) &amp;&amp; lv.isPercentage()) {</span>
                // bound the span to the percentage specified
<span class="nc" id="L248">                min = Math.max((int) lv.getValue(targetSpan), min);</span>
<span class="nc" id="L249">                max = min;</span>
            } else {
<span class="nc" id="L251">                max = (int)v.getMaximumSpan(axis);</span>
            }

            // assign the offset and span for the child
<span class="nc bnc" id="L255" title="All 2 branches missed.">            if (max &lt; targetSpan) {</span>
                // can't make the child this wide, align it
<span class="nc" id="L257">                float align = v.getAlignment(axis);</span>
<span class="nc" id="L258">                offsets[i] = (int) ((targetSpan - max) * align);</span>
<span class="nc" id="L259">                spans[i] = max;</span>
<span class="nc" id="L260">            } else {</span>
                // make it the target width, or as small as it can get.
<span class="nc" id="L262">                offsets[i] = 0;</span>
<span class="nc" id="L263">                spans[i] = Math.max(min, targetSpan);</span>
            }
        }
<span class="nc" id="L266">    }</span>


    /**
     * Renders using the given rendering surface and area on that
     * surface.  This is implemented to delegate to the css box
     * painter to paint the border and background prior to the
     * interior.
     *
     * @param g the rendering surface to use
     * @param allocation the allocated region to render into
     * @see View#paint
     */
    public void paint(Graphics g, Shape allocation) {
<span class="nc" id="L280">        Rectangle a = (Rectangle) allocation;</span>
<span class="nc" id="L281">        painter.paint(g, a.x, a.y, a.width, a.height, this);</span>
<span class="nc" id="L282">        super.paint(g, a);</span>
<span class="nc" id="L283">    }</span>

    /**
     * Fetches the attributes to use when rendering.  This is
     * implemented to multiplex the attributes specified in the
     * model with a StyleSheet.
     */
    public AttributeSet getAttributes() {
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (attr == null) {</span>
<span class="nc" id="L292">            StyleSheet sheet = getStyleSheet();</span>
<span class="nc" id="L293">            attr = sheet.getViewAttributes(this);</span>
        }
<span class="nc" id="L295">        return attr;</span>
    }

    /**
     * Gets the resize weight.
     *
     * @param axis may be either X_AXIS or Y_AXIS
     * @return the weight
     * @exception IllegalArgumentException for an invalid axis
     */
    public int getResizeWeight(int axis) {
<span class="nc bnc" id="L306" title="All 3 branches missed.">        switch (axis) {</span>
        case View.X_AXIS:
<span class="nc" id="L308">            return 1;</span>
        case View.Y_AXIS:
<span class="nc" id="L310">            return 0;</span>
        default:
<span class="nc" id="L312">            throw new IllegalArgumentException(&quot;Invalid axis: &quot; + axis);</span>
        }
    }

    /**
     * Gets the alignment.
     *
     * @param axis may be either X_AXIS or Y_AXIS
     * @return the alignment
     */
    public float getAlignment(int axis) {
<span class="nc bnc" id="L323" title="All 3 branches missed.">        switch (axis) {</span>
        case View.X_AXIS:
<span class="nc" id="L325">            return 0;</span>
        case View.Y_AXIS:
<span class="nc bnc" id="L327" title="All 2 branches missed.">            if (getViewCount() == 0) {</span>
<span class="nc" id="L328">                return 0;</span>
            }
<span class="nc" id="L330">            float span = getPreferredSpan(View.Y_AXIS);</span>
<span class="nc" id="L331">            View v = getView(0);</span>
<span class="nc" id="L332">            float above = v.getPreferredSpan(View.Y_AXIS);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">            float a = (((int)span) != 0) ? (above * v.getAlignment(View.Y_AXIS)) / span: 0;</span>
<span class="nc" id="L334">            return a;</span>
        default:
<span class="nc" id="L336">            throw new IllegalArgumentException(&quot;Invalid axis: &quot; + axis);</span>
        }
    }

    public void changedUpdate(DocumentEvent changes, Shape a, ViewFactory f) {
<span class="nc" id="L341">        super.changedUpdate(changes, a, f);</span>
<span class="nc" id="L342">        int pos = changes.getOffset();</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (pos &lt;= getStartOffset() &amp;&amp; (pos + changes.getLength()) &gt;=</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            getEndOffset()) {</span>
<span class="nc" id="L345">            setPropertiesFromAttributes();</span>
        }
<span class="nc" id="L347">    }</span>

    /**
     * Determines the preferred span for this view along an
     * axis.
     *
     * @param axis may be either &lt;code&gt;View.X_AXIS&lt;/code&gt;
     *           or &lt;code&gt;View.Y_AXIS&lt;/code&gt;
     * @return   the span the view would like to be rendered into &amp;gt;= 0;
     *           typically the view is told to render into the span
     *           that is returned, although there is no guarantee;
     *           the parent may choose to resize or break the view
     * @exception IllegalArgumentException for an invalid axis type
     */
    public float getPreferredSpan(int axis) {
<span class="nc" id="L362">        return super.getPreferredSpan(axis);</span>
    }

    /**
     * Determines the minimum span for this view along an
     * axis.
     *
     * @param axis may be either &lt;code&gt;View.X_AXIS&lt;/code&gt;
     *           or &lt;code&gt;View.Y_AXIS&lt;/code&gt;
     * @return  the span the view would like to be rendered into &amp;gt;= 0;
     *           typically the view is told to render into the span
     *           that is returned, although there is no guarantee;
     *           the parent may choose to resize or break the view
     * @exception IllegalArgumentException for an invalid axis type
     */
    public float getMinimumSpan(int axis) {
<span class="nc" id="L378">        return super.getMinimumSpan(axis);</span>
    }

    /**
     * Determines the maximum span for this view along an
     * axis.
     *
     * @param axis may be either &lt;code&gt;View.X_AXIS&lt;/code&gt;
     *           or &lt;code&gt;View.Y_AXIS&lt;/code&gt;
     * @return   the span the view would like to be rendered into &amp;gt;= 0;
     *           typically the view is told to render into the span
     *           that is returned, although there is no guarantee;
     *           the parent may choose to resize or break the view
     * @exception IllegalArgumentException for an invalid axis type
     */
    public float getMaximumSpan(int axis) {
<span class="nc" id="L394">        return super.getMaximumSpan(axis);</span>
    }

    /**
     * Update any cached values that come from attributes.
     */
    protected void setPropertiesFromAttributes() {

        // update attributes
<span class="nc" id="L403">        StyleSheet sheet = getStyleSheet();</span>
<span class="nc" id="L404">        attr = sheet.getViewAttributes(this);</span>

        // Reset the painter
<span class="nc" id="L407">        painter = sheet.getBoxPainter(attr);</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (attr != null) {</span>
<span class="nc" id="L409">            setInsets((short) painter.getInset(TOP, this),</span>
<span class="nc" id="L410">                      (short) painter.getInset(LEFT, this),</span>
<span class="nc" id="L411">                      (short) painter.getInset(BOTTOM, this),</span>
<span class="nc" id="L412">                      (short) painter.getInset(RIGHT, this));</span>
        }

        // Get the width/height
<span class="nc" id="L416">        cssWidth = (CSS.LengthValue) attr.getAttribute(CSS.Attribute.WIDTH);</span>
<span class="nc" id="L417">        cssHeight = (CSS.LengthValue) attr.getAttribute(CSS.Attribute.HEIGHT);</span>
<span class="nc" id="L418">    }</span>

    protected StyleSheet getStyleSheet() {
<span class="nc" id="L421">        HTMLDocument doc = (HTMLDocument) getDocument();</span>
<span class="nc" id="L422">        return doc.getStyleSheet();</span>
    }

    /**
     * Constrains &lt;code&gt;want&lt;/code&gt; to fit in the minimum size specified
     * by &lt;code&gt;min&lt;/code&gt;.
     */
    private void constrainSize(int axis, SizeRequirements want,
                               SizeRequirements min) {
<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (min.minimum &gt; want.minimum) {</span>
<span class="nc" id="L432">            want.minimum = want.preferred = min.minimum;</span>
<span class="nc" id="L433">            want.maximum = Math.max(want.maximum, min.maximum);</span>
        }
<span class="nc" id="L435">    }</span>

    private AttributeSet attr;
    private StyleSheet.BoxPainter painter;

    private CSS.LengthValue cssWidth;
    private CSS.LengthValue cssHeight;

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>