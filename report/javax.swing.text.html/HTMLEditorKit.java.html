<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>HTMLEditorKit.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.text.html</a> &gt; <span class="el_source">HTMLEditorKit.java</span></div><h1>HTMLEditorKit.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package javax.swing.text.html;

import sun.awt.AppContext;

import java.lang.reflect.Method;
import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.net.MalformedURLException;
import java.net.URL;
import javax.swing.text.*;
import javax.swing.*;
import javax.swing.border.*;
import javax.swing.event.*;
import javax.swing.plaf.TextUI;
import java.util.*;
import javax.accessibility.*;
import java.lang.ref.*;

/**
 * The Swing JEditorPane text component supports different kinds
 * of content via a plug-in mechanism called an EditorKit.  Because
 * HTML is a very popular format of content, some support is provided
 * by default.  The default support is provided by this class, which
 * supports HTML version 3.2 (with some extensions), and is migrating
 * toward version 4.0.
 * The &amp;lt;applet&amp;gt; tag is not supported, but some support is provided
 * for the &amp;lt;object&amp;gt; tag.
 * &lt;p&gt;
 * There are several goals of the HTML EditorKit provided, that have
 * an effect upon the way that HTML is modeled.  These
 * have influenced its design in a substantial way.
 * &lt;dl&gt;
 * &lt;dt&gt;
 * Support editing
 * &lt;dd&gt;
 * It might seem fairly obvious that a plug-in for JEditorPane
 * should provide editing support, but that fact has several
 * design considerations.  There are a substantial number of HTML
 * documents that don't properly conform to an HTML specification.
 * These must be normalized somewhat into a correct form if one
 * is to edit them.  Additionally, users don't like to be presented
 * with an excessive amount of structure editing, so using traditional
 * text editing gestures is preferred over using the HTML structure
 * exactly as defined in the HTML document.
 * &lt;p&gt;
 * The modeling of HTML is provided by the class &lt;code&gt;HTMLDocument&lt;/code&gt;.
 * Its documentation describes the details of how the HTML is modeled.
 * The editing support leverages heavily off of the text package.
 * &lt;p&gt;
 * &lt;dt&gt;
 * Extendable/Scalable
 * &lt;dd&gt;
 * To maximize the usefulness of this kit, a great deal of effort
 * has gone into making it extendable.  These are some of the
 * features.
 * &lt;ol&gt;
 *   &lt;li&gt;
 *   The parser is replaceable.  The default parser is the Hot Java
 *   parser which is DTD based.  A different DTD can be used, or an
 *   entirely different parser can be used.  To change the parser,
 *   reimplement the getParser method.  The default parser is
 *   dynamically loaded when first asked for, so the class files
 *   will never be loaded if an alternative parser is used.  The
 *   default parser is in a separate package called parser below
 *   this package.
 *   &lt;li&gt;
 *   The parser drives the ParserCallback, which is provided by
 *   HTMLDocument.  To change the callback, subclass HTMLDocument
 *   and reimplement the createDefaultDocument method to return
 *   document that produces a different reader.  The reader controls
 *   how the document is structured.  Although the Document provides
 *   HTML support by default, there is nothing preventing support of
 *   non-HTML tags that result in alternative element structures.
 *   &lt;li&gt;
 *   The default view of the models are provided as a hierarchy of
 *   View implementations, so one can easily customize how a particular
 *   element is displayed or add capabilities for new kinds of elements
 *   by providing new View implementations.  The default set of views
 *   are provided by the &lt;code&gt;HTMLFactory&lt;/code&gt; class.  This can
 *   be easily changed by subclassing or replacing the HTMLFactory
 *   and reimplementing the getViewFactory method to return the alternative
 *   factory.
 *   &lt;li&gt;
 *   The View implementations work primarily off of CSS attributes,
 *   which are kept in the views.  This makes it possible to have
 *   multiple views mapped over the same model that appear substantially
 *   different.  This can be especially useful for printing.  For
 *   most HTML attributes, the HTML attributes are converted to CSS
 *   attributes for display.  This helps make the View implementations
 *   more general purpose
 * &lt;/ol&gt;
 * &lt;p&gt;
 * &lt;dt&gt;
 * Asynchronous Loading
 * &lt;dd&gt;
 * Larger documents involve a lot of parsing and take some time
 * to load.  By default, this kit produces documents that will be
 * loaded asynchronously if loaded using &lt;code&gt;JEditorPane.setPage&lt;/code&gt;.
 * This is controlled by a property on the document.  The method
 * {@link #createDefaultDocument createDefaultDocument} can
 * be overriden to change this.  The batching of work is done
 * by the &lt;code&gt;HTMLDocument.HTMLReader&lt;/code&gt; class.  The actual
 * work is done by the &lt;code&gt;DefaultStyledDocument&lt;/code&gt; and
 * &lt;code&gt;AbstractDocument&lt;/code&gt; classes in the text package.
 * &lt;p&gt;
 * &lt;dt&gt;
 * Customization from current LAF
 * &lt;dd&gt;
 * HTML provides a well known set of features without exactly
 * specifying the display characteristics.  Swing has a theme
 * mechanism for its look-and-feel implementations.  It is desirable
 * for the look-and-feel to feed display characteristics into the
 * HTML views.  An user with poor vision for example would want
 * high contrast and larger than typical fonts.
 * &lt;p&gt;
 * The support for this is provided by the &lt;code&gt;StyleSheet&lt;/code&gt;
 * class.  The presentation of the HTML can be heavily influenced
 * by the setting of the StyleSheet property on the EditorKit.
 * &lt;p&gt;
 * &lt;dt&gt;
 * Not lossy
 * &lt;dd&gt;
 * An EditorKit has the ability to be read and save documents.
 * It is generally the most pleasing to users if there is no loss
 * of data between the two operation.  The policy of the HTMLEditorKit
 * will be to store things not recognized or not necessarily visible
 * so they can be subsequently written out.  The model of the HTML document
 * should therefore contain all information discovered while reading the
 * document.  This is constrained in some ways by the need to support
 * editing (i.e. incorrect documents sometimes must be normalized).
 * The guiding principle is that information shouldn't be lost, but
 * some might be synthesized to produce a more correct model or it might
 * be rearranged.
 * &lt;/dl&gt;
 *
 * @author  Timothy Prinzing
 */
public class HTMLEditorKit extends StyledEditorKit implements Accessible {

    private JEditorPane theEditor;

    /**
     * Constructs an HTMLEditorKit, creates a StyleContext,
     * and loads the style sheet.
     */
<span class="nc" id="L171">    public HTMLEditorKit() {</span>

<span class="nc" id="L173">    }</span>

    /**
     * Get the MIME type of the data that this
     * kit represents support for.  This kit supports
     * the type &lt;code&gt;text/html&lt;/code&gt;.
     *
     * @return the type
     */
    public String getContentType() {
<span class="nc" id="L183">        return &quot;text/html&quot;;</span>
    }

    /**
     * Fetch a factory that is suitable for producing
     * views of any models that are produced by this
     * kit.
     *
     * @return the factory
     */
    public ViewFactory getViewFactory() {
<span class="nc" id="L194">        return defaultFactory;</span>
    }

    /**
     * Create an uninitialized text storage model
     * that is appropriate for this type of editor.
     *
     * @return the model
     */
    public Document createDefaultDocument() {
<span class="nc" id="L204">        StyleSheet styles = getStyleSheet();</span>
<span class="nc" id="L205">        StyleSheet ss = new StyleSheet();</span>

<span class="nc" id="L207">        ss.addStyleSheet(styles);</span>

<span class="nc" id="L209">        HTMLDocument doc = new HTMLDocument(ss);</span>
<span class="nc" id="L210">        doc.setParser(getParser());</span>
<span class="nc" id="L211">        doc.setAsynchronousLoadPriority(4);</span>
<span class="nc" id="L212">        doc.setTokenThreshold(100);</span>
<span class="nc" id="L213">        return doc;</span>
    }

    /**
     * Try to get an HTML parser from the document.  If no parser is set for
     * the document, return the editor kit's default parser.  It is an error
     * if no parser could be obtained from the editor kit.
     */
    private Parser ensureParser(HTMLDocument doc) throws IOException {
<span class="nc" id="L222">        Parser p = doc.getParser();</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (p == null) {</span>
<span class="nc" id="L224">            p = getParser();</span>
        }
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (p == null) {</span>
<span class="nc" id="L227">            throw new IOException(&quot;Can't load parser&quot;);</span>
        }
<span class="nc" id="L229">        return p;</span>
    }

    /**
     * Inserts content from the given stream. If &lt;code&gt;doc&lt;/code&gt; is
     * an instance of HTMLDocument, this will read
     * HTML 3.2 text. Inserting HTML into a non-empty document must be inside
     * the body Element, if you do not insert into the body an exception will
     * be thrown. When inserting into a non-empty document all tags outside
     * of the body (head, title) will be dropped.
     *
     * @param in  the stream to read from
     * @param doc the destination for the insertion
     * @param pos the location in the document to place the
     *   content
     * @exception IOException on any I/O error
     * @exception BadLocationException if pos represents an invalid
     *   location within the document
     * @exception RuntimeException (will eventually be a BadLocationException)
     *            if pos is invalid
     */
    public void read(Reader in, Document doc, int pos) throws IOException, BadLocationException {

<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (doc instanceof HTMLDocument) {</span>
<span class="nc" id="L253">            HTMLDocument hdoc = (HTMLDocument) doc;</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (pos &gt; doc.getLength()) {</span>
<span class="nc" id="L255">                throw new BadLocationException(&quot;Invalid location&quot;, pos);</span>
            }

<span class="nc" id="L258">            Parser p = ensureParser(hdoc);</span>
<span class="nc" id="L259">            ParserCallback receiver = hdoc.getReader(pos);</span>
<span class="nc" id="L260">            Boolean ignoreCharset = (Boolean)doc.getProperty(&quot;IgnoreCharsetDirective&quot;);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            p.parse(in, receiver, (ignoreCharset == null) ? false : ignoreCharset.booleanValue());</span>
<span class="nc" id="L262">            receiver.flush();</span>
<span class="nc" id="L263">        } else {</span>
<span class="nc" id="L264">            super.read(in, doc, pos);</span>
        }
<span class="nc" id="L266">    }</span>

    /**
     * Inserts HTML into an existing document.
     *
     * @param doc       the document to insert into
     * @param offset    the offset to insert HTML at
     * @param popDepth  the number of ElementSpec.EndTagTypes to generate before
     *        inserting
     * @param pushDepth the number of ElementSpec.StartTagTypes with a direction
     *        of ElementSpec.JoinNextDirection that should be generated
     *        before inserting, but after the end tags have been generated
     * @param insertTag the first tag to start inserting into document
     * @exception RuntimeException (will eventually be a BadLocationException)
     *            if pos is invalid
     */
    public void insertHTML(HTMLDocument doc, int offset, String html,
                           int popDepth, int pushDepth,
                           HTML.Tag insertTag) throws
                       BadLocationException, IOException {
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (offset &gt; doc.getLength()) {</span>
<span class="nc" id="L287">            throw new BadLocationException(&quot;Invalid location&quot;, offset);</span>
        }

<span class="nc" id="L290">        Parser p = ensureParser(doc);</span>
<span class="nc" id="L291">        ParserCallback receiver = doc.getReader(offset, popDepth, pushDepth,</span>
                                                insertTag);
<span class="nc" id="L293">        Boolean ignoreCharset = (Boolean)doc.getProperty</span>
<span class="nc" id="L294">                                (&quot;IgnoreCharsetDirective&quot;);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        p.parse(new StringReader(html), receiver, (ignoreCharset == null) ?</span>
<span class="nc" id="L296">                false : ignoreCharset.booleanValue());</span>
<span class="nc" id="L297">        receiver.flush();</span>
<span class="nc" id="L298">    }</span>

    /**
     * Write content from a document to the given stream
     * in a format appropriate for this kind of content handler.
     *
     * @param out  the stream to write to
     * @param doc  the source for the write
     * @param pos  the location in the document to fetch the
     *   content
     * @param len  the amount to write out
     * @exception IOException on any I/O error
     * @exception BadLocationException if pos represents an invalid
     *   location within the document
     */
    public void write(Writer out, Document doc, int pos, int len)
        throws IOException, BadLocationException {

<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (doc instanceof HTMLDocument) {</span>
<span class="nc" id="L317">            HTMLWriter w = new HTMLWriter(out, (HTMLDocument)doc, pos, len);</span>
<span class="nc" id="L318">            w.write();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">        } else if (doc instanceof StyledDocument) {</span>
<span class="nc" id="L320">            MinimalHTMLWriter w = new MinimalHTMLWriter(out, (StyledDocument)doc, pos, len);</span>
<span class="nc" id="L321">            w.write();</span>
<span class="nc" id="L322">        } else {</span>
<span class="nc" id="L323">            super.write(out, doc, pos, len);</span>
        }
<span class="nc" id="L325">    }</span>

    /**
     * Called when the kit is being installed into the
     * a JEditorPane.
     *
     * @param c the JEditorPane
     */
    public void install(JEditorPane c) {
<span class="nc" id="L334">        c.addMouseListener(linkHandler);</span>
<span class="nc" id="L335">        c.addMouseMotionListener(linkHandler);</span>
<span class="nc" id="L336">        c.addCaretListener(nextLinkAction);</span>
<span class="nc" id="L337">        super.install(c);</span>
<span class="nc" id="L338">        theEditor = c;</span>
<span class="nc" id="L339">    }</span>

    /**
     * Called when the kit is being removed from the
     * JEditorPane.  This is used to unregister any
     * listeners that were attached.
     *
     * @param c the JEditorPane
     */
    public void deinstall(JEditorPane c) {
<span class="nc" id="L349">        c.removeMouseListener(linkHandler);</span>
<span class="nc" id="L350">        c.removeMouseMotionListener(linkHandler);</span>
<span class="nc" id="L351">        c.removeCaretListener(nextLinkAction);</span>
<span class="nc" id="L352">        super.deinstall(c);</span>
<span class="nc" id="L353">        theEditor = null;</span>
<span class="nc" id="L354">    }</span>

    /**
     * Default Cascading Style Sheet file that sets
     * up the tag views.
     */
    public static final String DEFAULT_CSS = &quot;default.css&quot;;

    /**
     * Set the set of styles to be used to render the various
     * HTML elements.  These styles are specified in terms of
     * CSS specifications.  Each document produced by the kit
     * will have a copy of the sheet which it can add the
     * document specific styles to.  By default, the StyleSheet
     * specified is shared by all HTMLEditorKit instances.
     * This should be reimplemented to provide a finer granularity
     * if desired.
     */
    public void setStyleSheet(StyleSheet s) {
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (s == null) {</span>
<span class="nc" id="L374">            AppContext.getAppContext().remove(DEFAULT_STYLES_KEY);</span>
        } else {
<span class="nc" id="L376">            AppContext.getAppContext().put(DEFAULT_STYLES_KEY, s);</span>
        }
<span class="nc" id="L378">    }</span>

    /**
     * Get the set of styles currently being used to render the
     * HTML elements.  By default the resource specified by
     * DEFAULT_CSS gets loaded, and is shared by all HTMLEditorKit
     * instances.
     */
    public StyleSheet getStyleSheet() {
<span class="nc" id="L387">        AppContext appContext = AppContext.getAppContext();</span>
<span class="nc" id="L388">        StyleSheet defaultStyles = (StyleSheet) appContext.get(DEFAULT_STYLES_KEY);</span>

<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (defaultStyles == null) {</span>
<span class="nc" id="L391">            defaultStyles = new StyleSheet();</span>
<span class="nc" id="L392">            appContext.put(DEFAULT_STYLES_KEY, defaultStyles);</span>
            try {
<span class="nc" id="L394">                InputStream is = HTMLEditorKit.getResourceAsStream(DEFAULT_CSS);</span>
<span class="nc" id="L395">                Reader r = new BufferedReader(</span>
                        new InputStreamReader(is, &quot;ISO-8859-1&quot;));
<span class="nc" id="L397">                defaultStyles.loadRules(r, null);</span>
<span class="nc" id="L398">                r.close();</span>
<span class="nc" id="L399">            } catch (Throwable e) {</span>
                // on error we simply have no styles... the html
                // will look mighty wrong but still function.
<span class="nc" id="L402">            }</span>
        }
<span class="nc" id="L404">        return defaultStyles;</span>
    }

    /**
     * Fetch a resource relative to the HTMLEditorKit classfile.
     * If this is called on 1.2 the loading will occur under the
     * protection of a doPrivileged call to allow the HTMLEditorKit
     * to function when used in an applet.
     *
     * @param name the name of the resource, relative to the
     *  HTMLEditorKit class
     * @return a stream representing the resource
     */
    static InputStream getResourceAsStream(String name) {
        try {
<span class="nc" id="L419">            return ResourceLoader.getResourceAsStream(name);</span>
<span class="nc" id="L420">        } catch (Throwable e) {</span>
            // If the class doesn't exist or we have some other
            // problem we just try to call getResourceAsStream directly.
<span class="nc" id="L423">            return HTMLEditorKit.class.getResourceAsStream(name);</span>
        }
    }

    /**
     * Fetches the command list for the editor.  This is
     * the list of commands supported by the superclass
     * augmented by the collection of commands defined
     * locally for style operations.
     *
     * @return the command list
     */
    public Action[] getActions() {
<span class="nc" id="L436">        return TextAction.augmentList(super.getActions(), this.defaultActions);</span>
    }

    /**
     * Copies the key/values in &lt;code&gt;element&lt;/code&gt;s AttributeSet into
     * &lt;code&gt;set&lt;/code&gt;. This does not copy component, icon, or element
     * names attributes. Subclasses may wish to refine what is and what
     * isn't copied here. But be sure to first remove all the attributes that
     * are in &lt;code&gt;set&lt;/code&gt;.&lt;p&gt;
     * This is called anytime the caret moves over a different location.
     *
     */
    protected void createInputAttributes(Element element,
                                         MutableAttributeSet set) {
<span class="nc" id="L450">        set.removeAttributes(set);</span>
<span class="nc" id="L451">        set.addAttributes(element.getAttributes());</span>
<span class="nc" id="L452">        set.removeAttribute(StyleConstants.ComposedTextAttribute);</span>

<span class="nc" id="L454">        Object o = set.getAttribute(StyleConstants.NameAttribute);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        if (o instanceof HTML.Tag) {</span>
<span class="nc" id="L456">            HTML.Tag tag = (HTML.Tag)o;</span>
            // PENDING: we need a better way to express what shouldn't be
            // copied when editing...
<span class="nc bnc" id="L459" title="All 2 branches missed.">            if(tag == HTML.Tag.IMG) {</span>
                // Remove the related image attributes, src, width, height
<span class="nc" id="L461">                set.removeAttribute(HTML.Attribute.SRC);</span>
<span class="nc" id="L462">                set.removeAttribute(HTML.Attribute.HEIGHT);</span>
<span class="nc" id="L463">                set.removeAttribute(HTML.Attribute.WIDTH);</span>
<span class="nc" id="L464">                set.addAttribute(StyleConstants.NameAttribute,</span>
                                 HTML.Tag.CONTENT);
            }
<span class="nc bnc" id="L467" title="All 4 branches missed.">            else if (tag == HTML.Tag.HR || tag == HTML.Tag.BR) {</span>
                // Don't copy HRs or BRs either.
<span class="nc" id="L469">                set.addAttribute(StyleConstants.NameAttribute,</span>
                                 HTML.Tag.CONTENT);
            }
<span class="nc bnc" id="L472" title="All 2 branches missed.">            else if (tag == HTML.Tag.COMMENT) {</span>
                // Don't copy COMMENTs either
<span class="nc" id="L474">                set.addAttribute(StyleConstants.NameAttribute,</span>
                                 HTML.Tag.CONTENT);
<span class="nc" id="L476">                set.removeAttribute(HTML.Attribute.COMMENT);</span>
            }
<span class="nc bnc" id="L478" title="All 2 branches missed.">            else if (tag == HTML.Tag.INPUT) {</span>
                // or INPUT either
<span class="nc" id="L480">                set.addAttribute(StyleConstants.NameAttribute,</span>
                                 HTML.Tag.CONTENT);
<span class="nc" id="L482">                set.removeAttribute(HTML.Tag.INPUT);</span>
            }
<span class="nc bnc" id="L484" title="All 2 branches missed.">            else if (tag instanceof HTML.UnknownTag) {</span>
                // Don't copy unknowns either:(
<span class="nc" id="L486">                set.addAttribute(StyleConstants.NameAttribute,</span>
                                 HTML.Tag.CONTENT);
<span class="nc" id="L488">                set.removeAttribute(HTML.Attribute.ENDTAG);</span>
            }
        }
<span class="nc" id="L491">    }</span>

    /**
     * Gets the input attributes used for the styled
     * editing actions.
     *
     * @return the attribute set
     */
    public MutableAttributeSet getInputAttributes() {
<span class="nc bnc" id="L500" title="All 2 branches missed.">        if (input == null) {</span>
<span class="nc" id="L501">            input = getStyleSheet().addStyle(null, null);</span>
        }
<span class="nc" id="L503">        return input;</span>
    }

    /**
     * Sets the default cursor.
     *
     * @since 1.3
     */
    public void setDefaultCursor(Cursor cursor) {
<span class="nc" id="L512">        defaultCursor = cursor;</span>
<span class="nc" id="L513">    }</span>

    /**
     * Returns the default cursor.
     *
     * @since 1.3
     */
    public Cursor getDefaultCursor() {
<span class="nc" id="L521">        return defaultCursor;</span>
    }

    /**
     * Sets the cursor to use over links.
     *
     * @since 1.3
     */
    public void setLinkCursor(Cursor cursor) {
<span class="nc" id="L530">        linkCursor = cursor;</span>
<span class="nc" id="L531">    }</span>

    /**
     * Returns the cursor to use over hyper links.
     * @since 1.3
     */
    public Cursor getLinkCursor() {
<span class="nc" id="L538">        return linkCursor;</span>
    }

    /**
     * Indicates whether an html form submission is processed automatically
     * or only &lt;code&gt;FormSubmitEvent&lt;/code&gt; is fired.
     *
     * @return true  if html form submission is processed automatically,
     *         false otherwise.
     *
     * @see #setAutoFormSubmission
     * @since 1.5
     */
    public boolean isAutoFormSubmission() {
<span class="nc" id="L552">        return isAutoFormSubmission;</span>
    }

    /**
     * Specifies if an html form submission is processed
     * automatically or only &lt;code&gt;FormSubmitEvent&lt;/code&gt; is fired.
     * By default it is set to true.
     *
     * @see #isAutoFormSubmission()
     * @see FormSubmitEvent
     * @since 1.5
     */
    public void setAutoFormSubmission(boolean isAuto) {
<span class="nc" id="L565">        isAutoFormSubmission = isAuto;</span>
<span class="nc" id="L566">    }</span>

    /**
     * Creates a copy of the editor kit.
     *
     * @return the copy
     */
    public Object clone() {
<span class="nc" id="L574">        HTMLEditorKit o = (HTMLEditorKit)super.clone();</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">        if (o != null) {</span>
<span class="nc" id="L576">            o.input = null;</span>
<span class="nc" id="L577">            o.linkHandler = new LinkController();</span>
        }
<span class="nc" id="L579">        return o;</span>
    }

    /**
     * Fetch the parser to use for reading HTML streams.
     * This can be reimplemented to provide a different
     * parser.  The default implementation is loaded dynamically
     * to avoid the overhead of loading the default parser if
     * it's not used.  The default parser is the HotJava parser
     * using an HTML 3.2 DTD.
     */
    protected Parser getParser() {
<span class="nc bnc" id="L591" title="All 2 branches missed.">        if (defaultParser == null) {</span>
            try {
<span class="nc" id="L593">                Class c = Class.forName(&quot;javax.swing.text.html.parser.ParserDelegator&quot;);</span>
<span class="nc" id="L594">                defaultParser = (Parser) c.newInstance();</span>
<span class="nc" id="L595">            } catch (Throwable e) {</span>
<span class="nc" id="L596">            }</span>
        }
<span class="nc" id="L598">        return defaultParser;</span>
    }

    // ----- Accessibility support -----
    private AccessibleContext accessibleContext;

    /**
     * returns the AccessibleContext associated with this editor kit
     *
     * @return the AccessibleContext associated with this editor kit
     * @since 1.4
     */
    public AccessibleContext getAccessibleContext() {
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (theEditor == null) {</span>
<span class="nc" id="L612">            return null;</span>
        }
<span class="nc bnc" id="L614" title="All 2 branches missed.">        if (accessibleContext == null) {</span>
<span class="nc" id="L615">            AccessibleHTML a = new AccessibleHTML(theEditor);</span>
<span class="nc" id="L616">            accessibleContext = a.getAccessibleContext();</span>
        }
<span class="nc" id="L618">        return accessibleContext;</span>
    }

    // --- variables ------------------------------------------

<span class="nc" id="L623">    private static final Cursor MoveCursor = Cursor.getPredefinedCursor</span>
<span class="nc" id="L624">                                    (Cursor.HAND_CURSOR);</span>
<span class="nc" id="L625">    private static final Cursor DefaultCursor = Cursor.getPredefinedCursor</span>
<span class="nc" id="L626">                                    (Cursor.DEFAULT_CURSOR);</span>

    /** Shared factory for creating HTML Views. */
<span class="nc" id="L629">    private static final ViewFactory defaultFactory = new HTMLFactory();</span>

    MutableAttributeSet input;
<span class="nc" id="L632">    private static final Object DEFAULT_STYLES_KEY = new Object();</span>
<span class="nc" id="L633">    private LinkController linkHandler = new LinkController();</span>
<span class="nc" id="L634">    private static Parser defaultParser = null;</span>
<span class="nc" id="L635">    private Cursor defaultCursor = DefaultCursor;</span>
<span class="nc" id="L636">    private Cursor linkCursor = MoveCursor;</span>
<span class="nc" id="L637">    private boolean isAutoFormSubmission = true;</span>

    /**
     * Class to watch the associated component and fire
     * hyperlink events on it when appropriate.
     */
<span class="nc" id="L643">    public static class LinkController extends MouseAdapter implements MouseMotionListener, Serializable {</span>
<span class="nc" id="L644">        private Element curElem = null;</span>
        /**
         * If true, the current element (curElem) represents an image.
         */
<span class="nc" id="L648">        private boolean curElemImage = false;</span>
<span class="nc" id="L649">        private String href = null;</span>
        /** This is used by viewToModel to avoid allocing a new array each
         * time. */
<span class="nc" id="L652">        private transient Position.Bias[] bias = new Position.Bias[1];</span>
        /**
         * Current offset.
         */
        private int curOffset;

        /**
         * Called for a mouse click event.
         * If the component is read-only (ie a browser) then
         * the clicked event is used to drive an attempt to
         * follow the reference specified by a link.
         *
         * @param e the mouse event
         * @see MouseListener#mouseClicked
         */
        public void mouseClicked(MouseEvent e) {
<span class="nc" id="L668">            JEditorPane editor = (JEditorPane) e.getSource();</span>

<span class="nc bnc" id="L670" title="All 4 branches missed.">            if (! editor.isEditable() &amp;&amp; editor.isEnabled() &amp;&amp;</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">                    SwingUtilities.isLeftMouseButton(e)) {</span>
<span class="nc" id="L672">                Point pt = new Point(e.getX(), e.getY());</span>
<span class="nc" id="L673">                int pos = editor.viewToModel(pt);</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">                if (pos &gt;= 0) {</span>
<span class="nc" id="L675">                    activateLink(pos, editor, e);</span>
                }
            }
<span class="nc" id="L678">        }</span>

        // ignore the drags
        public void mouseDragged(MouseEvent e) {
<span class="nc" id="L682">        }</span>

        // track the moving of the mouse.
        public void mouseMoved(MouseEvent e) {
<span class="nc" id="L686">            JEditorPane editor = (JEditorPane) e.getSource();</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">            if (!editor.isEnabled()) {</span>
<span class="nc" id="L688">                return;</span>
            }

<span class="nc" id="L691">            HTMLEditorKit kit = (HTMLEditorKit)editor.getEditorKit();</span>
<span class="nc" id="L692">            boolean adjustCursor = true;</span>
<span class="nc" id="L693">            Cursor newCursor = kit.getDefaultCursor();</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">            if (!editor.isEditable()) {</span>
<span class="nc" id="L695">                Point pt = new Point(e.getX(), e.getY());</span>
<span class="nc" id="L696">                int pos = editor.getUI().viewToModel(editor, pt, bias);</span>
<span class="nc bnc" id="L697" title="All 4 branches missed.">                if (bias[0] == Position.Bias.Backward &amp;&amp; pos &gt; 0) {</span>
<span class="nc" id="L698">                    pos--;</span>
                }
<span class="nc bnc" id="L700" title="All 4 branches missed.">                if (pos &gt;= 0 &amp;&amp;(editor.getDocument() instanceof HTMLDocument)){</span>
<span class="nc" id="L701">                    HTMLDocument hdoc = (HTMLDocument)editor.getDocument();</span>
<span class="nc" id="L702">                    Element elem = hdoc.getCharacterElement(pos);</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">                    if (!doesElementContainLocation(editor, elem, pos,</span>
<span class="nc" id="L704">                                                    e.getX(), e.getY())) {</span>
<span class="nc" id="L705">                        elem = null;</span>
                    }
<span class="nc bnc" id="L707" title="All 4 branches missed.">                    if (curElem != elem || curElemImage) {</span>
<span class="nc" id="L708">                        Element lastElem = curElem;</span>
<span class="nc" id="L709">                        curElem = elem;</span>
<span class="nc" id="L710">                        String href = null;</span>
<span class="nc" id="L711">                        curElemImage = false;</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                        if (elem != null) {</span>
<span class="nc" id="L713">                            AttributeSet a = elem.getAttributes();</span>
<span class="nc" id="L714">                            AttributeSet anchor = (AttributeSet)a.</span>
<span class="nc" id="L715">                                                   getAttribute(HTML.Tag.A);</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">                            if (anchor == null) {</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">                                curElemImage = (a.getAttribute(StyleConstants.</span>
                                            NameAttribute) == HTML.Tag.IMG);
<span class="nc bnc" id="L719" title="All 2 branches missed.">                                if (curElemImage) {</span>
<span class="nc" id="L720">                                    href = getMapHREF(editor, hdoc, elem, a,</span>
<span class="nc" id="L721">                                                      pos, e.getX(), e.getY());</span>
                                }
                            }
                            else {
<span class="nc" id="L725">                                href = (String)anchor.getAttribute</span>
<span class="nc" id="L726">                                    (HTML.Attribute.HREF);</span>
                            }
                        }

<span class="nc bnc" id="L730" title="All 2 branches missed.">                        if (href != this.href) {</span>
                            // reference changed, fire event(s)
<span class="nc" id="L732">                            fireEvents(editor, hdoc, href, lastElem, e);</span>
<span class="nc" id="L733">                            this.href = href;</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">                            if (href != null) {</span>
<span class="nc" id="L735">                                newCursor = kit.getLinkCursor();</span>
                            }
                        }
                        else {
<span class="nc" id="L739">                            adjustCursor = false;</span>
                        }
<span class="nc" id="L741">                    }</span>
                    else {
<span class="nc" id="L743">                        adjustCursor = false;</span>
                    }
<span class="nc" id="L745">                    curOffset = pos;</span>
                }
            }
<span class="nc bnc" id="L748" title="All 4 branches missed.">            if (adjustCursor &amp;&amp; editor.getCursor() != newCursor) {</span>
<span class="nc" id="L749">                editor.setCursor(newCursor);</span>
            }
<span class="nc" id="L751">        }</span>

        /**
         * Returns a string anchor if the passed in element has a
         * USEMAP that contains the passed in location.
         */
        private String getMapHREF(JEditorPane html, HTMLDocument hdoc,
                                  Element elem, AttributeSet attr, int offset,
                                  int x, int y) {
<span class="nc" id="L760">            Object useMap = attr.getAttribute(HTML.Attribute.USEMAP);</span>
<span class="nc bnc" id="L761" title="All 4 branches missed.">            if (useMap != null &amp;&amp; (useMap instanceof String)) {</span>
<span class="nc" id="L762">                Map m = hdoc.getMap((String)useMap);</span>
<span class="nc bnc" id="L763" title="All 4 branches missed.">                if (m != null &amp;&amp; offset &lt; hdoc.getLength()) {</span>
                    Rectangle bounds;
<span class="nc" id="L765">                    TextUI ui = html.getUI();</span>
                    try {
<span class="nc" id="L767">                        Shape lBounds = ui.modelToView(html, offset,</span>
                                                   Position.Bias.Forward);
<span class="nc" id="L769">                        Shape rBounds = ui.modelToView(html, offset + 1,</span>
                                                   Position.Bias.Backward);
<span class="nc" id="L771">                        bounds = lBounds.getBounds();</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">                        bounds.add((rBounds instanceof Rectangle) ?</span>
<span class="nc" id="L773">                                    (Rectangle)rBounds : rBounds.getBounds());</span>
<span class="nc" id="L774">                    } catch (BadLocationException ble) {</span>
<span class="nc" id="L775">                        bounds = null;</span>
<span class="nc" id="L776">                    }</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                    if (bounds != null) {</span>
<span class="nc" id="L778">                        AttributeSet area = m.getArea(x - bounds.x,</span>
                                                      y - bounds.y,
                                                      bounds.width,
                                                      bounds.height);
<span class="nc bnc" id="L782" title="All 2 branches missed.">                        if (area != null) {</span>
<span class="nc" id="L783">                            return (String)area.getAttribute(HTML.Attribute.</span>
                                                             HREF);
                        }
                    }
                }
            }
<span class="nc" id="L789">            return null;</span>
        }

        /**
         * Returns true if the View representing &lt;code&gt;e&lt;/code&gt; contains
         * the location &lt;code&gt;x&lt;/code&gt;, &lt;code&gt;y&lt;/code&gt;. &lt;code&gt;offset&lt;/code&gt;
         * gives the offset into the Document to check for.
         */
        private boolean doesElementContainLocation(JEditorPane editor,
                                                   Element e, int offset,
                                                   int x, int y) {
<span class="nc bnc" id="L800" title="All 6 branches missed.">            if (e != null &amp;&amp; offset &gt; 0 &amp;&amp; e.getStartOffset() == offset) {</span>
                try {
<span class="nc" id="L802">                    TextUI ui = editor.getUI();</span>
<span class="nc" id="L803">                    Shape s1 = ui.modelToView(editor, offset,</span>
                                              Position.Bias.Forward);
<span class="nc bnc" id="L805" title="All 2 branches missed.">                    if (s1 == null) {</span>
<span class="nc" id="L806">                        return false;</span>
                    }
<span class="nc bnc" id="L808" title="All 2 branches missed.">                    Rectangle r1 = (s1 instanceof Rectangle) ? (Rectangle)s1 :</span>
<span class="nc" id="L809">                                    s1.getBounds();</span>
<span class="nc" id="L810">                    Shape s2 = ui.modelToView(editor, e.getEndOffset(),</span>
                                              Position.Bias.Backward);
<span class="nc bnc" id="L812" title="All 2 branches missed.">                    if (s2 != null) {</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">                        Rectangle r2 = (s2 instanceof Rectangle) ? (Rectangle)s2 :</span>
<span class="nc" id="L814">                                    s2.getBounds();</span>
<span class="nc" id="L815">                        r1.add(r2);</span>
                    }
<span class="nc" id="L817">                    return r1.contains(x, y);</span>
<span class="nc" id="L818">                } catch (BadLocationException ble) {</span>
                }
            }
<span class="nc" id="L821">            return true;</span>
        }

        /**
         * Calls linkActivated on the associated JEditorPane
         * if the given position represents a link.&lt;p&gt;This is implemented
         * to forward to the method with the same name, but with the following
         * args both == -1.
         *
         * @param pos the position
         * @param editor the editor pane
         */
        protected void activateLink(int pos, JEditorPane editor) {
<span class="nc" id="L834">            activateLink(pos, editor, null);</span>
<span class="nc" id="L835">        }</span>

        /**
         * Calls linkActivated on the associated JEditorPane
         * if the given position represents a link. If this was the result
         * of a mouse click, &lt;code&gt;x&lt;/code&gt; and
         * &lt;code&gt;y&lt;/code&gt; will give the location of the mouse, otherwise
         * they will be &lt; 0.
         *
         * @param pos the position
         * @param html the editor pane
         */
        void activateLink(int pos, JEditorPane html, MouseEvent mouseEvent) {
<span class="nc" id="L848">            Document doc = html.getDocument();</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">            if (doc instanceof HTMLDocument) {</span>
<span class="nc" id="L850">                HTMLDocument hdoc = (HTMLDocument) doc;</span>
<span class="nc" id="L851">                Element e = hdoc.getCharacterElement(pos);</span>
<span class="nc" id="L852">                AttributeSet a = e.getAttributes();</span>
<span class="nc" id="L853">                AttributeSet anchor = (AttributeSet)a.getAttribute(HTML.Tag.A);</span>
<span class="nc" id="L854">                HyperlinkEvent linkEvent = null;</span>
                String description;
<span class="nc" id="L856">                int x = -1;</span>
<span class="nc" id="L857">                int y = -1;</span>

<span class="nc bnc" id="L859" title="All 2 branches missed.">                if (mouseEvent != null) {</span>
<span class="nc" id="L860">                    x = mouseEvent.getX();</span>
<span class="nc" id="L861">                    y = mouseEvent.getY();</span>
                }

<span class="nc bnc" id="L864" title="All 2 branches missed.">                if (anchor == null) {</span>
<span class="nc" id="L865">                    href = getMapHREF(html, hdoc, e, a, pos, x, y);</span>
                }
                else {
<span class="nc" id="L868">                    href = (String)anchor.getAttribute(HTML.Attribute.HREF);</span>
                }

<span class="nc bnc" id="L871" title="All 2 branches missed.">                if (href != null) {</span>
<span class="nc" id="L872">                    linkEvent = createHyperlinkEvent(html, hdoc, href, anchor,</span>
                                                     e, mouseEvent);
                }
<span class="nc bnc" id="L875" title="All 2 branches missed.">                if (linkEvent != null) {</span>
<span class="nc" id="L876">                    html.fireHyperlinkUpdate(linkEvent);</span>
                }
            }
<span class="nc" id="L879">        }</span>

        /**
         * Creates and returns a new instance of HyperlinkEvent. If
         * &lt;code&gt;hdoc&lt;/code&gt; is a frame document a HTMLFrameHyperlinkEvent
         * will be created.
         */
        HyperlinkEvent createHyperlinkEvent(JEditorPane html,
                                            HTMLDocument hdoc, String href,
                                            AttributeSet anchor,
                                            Element element,
                                            MouseEvent mouseEvent) {
            URL u;
            try {
<span class="nc" id="L893">                URL base = hdoc.getBase();</span>
<span class="nc" id="L894">                u = new URL(base, href);</span>
                // Following is a workaround for 1.2, in which
                // new URL(&quot;file://...&quot;, &quot;#...&quot;) causes the filename to
                // be lost.
<span class="nc bnc" id="L898" title="All 4 branches missed.">                if (href != null &amp;&amp; &quot;file&quot;.equals(u.getProtocol()) &amp;&amp;</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">                    href.startsWith(&quot;#&quot;)) {</span>
<span class="nc" id="L900">                    String baseFile = base.getFile();</span>
<span class="nc" id="L901">                    String newFile = u.getFile();</span>
<span class="nc bnc" id="L902" title="All 4 branches missed.">                    if (baseFile != null &amp;&amp; newFile != null &amp;&amp;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">                        !newFile.startsWith(baseFile)) {</span>
<span class="nc" id="L904">                        u = new URL(base, baseFile + href);</span>
                    }
                }
<span class="nc" id="L907">            } catch (MalformedURLException m) {</span>
<span class="nc" id="L908">                u = null;</span>
<span class="nc" id="L909">            }</span>
            HyperlinkEvent linkEvent;

<span class="nc bnc" id="L912" title="All 2 branches missed.">            if (!hdoc.isFrameDocument()) {</span>
<span class="nc" id="L913">                linkEvent = new HyperlinkEvent(</span>
                        html, HyperlinkEvent.EventType.ACTIVATED, u, href,
                        element, mouseEvent);
            } else {
<span class="nc bnc" id="L917" title="All 2 branches missed.">                String target = (anchor != null) ?</span>
<span class="nc" id="L918">                    (String)anchor.getAttribute(HTML.Attribute.TARGET) : null;</span>
<span class="nc bnc" id="L919" title="All 4 branches missed.">                if ((target == null) || (target.equals(&quot;&quot;))) {</span>
<span class="nc" id="L920">                    target = hdoc.getBaseTarget();</span>
                }
<span class="nc bnc" id="L922" title="All 4 branches missed.">                if ((target == null) || (target.equals(&quot;&quot;))) {</span>
<span class="nc" id="L923">                    target = &quot;_self&quot;;</span>
                }
<span class="nc" id="L925">                    linkEvent = new HTMLFrameHyperlinkEvent(</span>
                        html, HyperlinkEvent.EventType.ACTIVATED, u, href,
                        element, mouseEvent, target);
            }
<span class="nc" id="L929">            return linkEvent;</span>
        }

        void fireEvents(JEditorPane editor, HTMLDocument doc, String href,
                        Element lastElem, MouseEvent mouseEvent) {
<span class="nc bnc" id="L934" title="All 2 branches missed.">            if (this.href != null) {</span>
                // fire an exited event on the old link
                URL u;
                try {
<span class="nc" id="L938">                    u = new URL(doc.getBase(), this.href);</span>
<span class="nc" id="L939">                } catch (MalformedURLException m) {</span>
<span class="nc" id="L940">                    u = null;</span>
<span class="nc" id="L941">                }</span>
<span class="nc" id="L942">                HyperlinkEvent exit = new HyperlinkEvent(editor,</span>
                                 HyperlinkEvent.EventType.EXITED, u, this.href,
                                 lastElem, mouseEvent);
<span class="nc" id="L945">                editor.fireHyperlinkUpdate(exit);</span>
            }
<span class="nc bnc" id="L947" title="All 2 branches missed.">            if (href != null) {</span>
                // fire an entered event on the new link
                URL u;
                try {
<span class="nc" id="L951">                    u = new URL(doc.getBase(), href);</span>
<span class="nc" id="L952">                } catch (MalformedURLException m) {</span>
<span class="nc" id="L953">                    u = null;</span>
<span class="nc" id="L954">                }</span>
<span class="nc" id="L955">                HyperlinkEvent entered = new HyperlinkEvent(editor,</span>
                                            HyperlinkEvent.EventType.ENTERED,
                                            u, href, curElem, mouseEvent);
<span class="nc" id="L958">                editor.fireHyperlinkUpdate(entered);</span>
            }
<span class="nc" id="L960">        }</span>
    }

    /**
     * Interface to be supported by the parser.  This enables
     * providing a different parser while reusing some of the
     * implementation provided by this editor kit.
     */
<span class="nc" id="L968">    public static abstract class Parser {</span>
        /**
         * Parse the given stream and drive the given callback
         * with the results of the parse.  This method should
         * be implemented to be thread-safe.
         */
        public abstract void parse(Reader r, ParserCallback cb, boolean ignoreCharSet) throws IOException;

    }

    /**
     * The result of parsing drives these callback methods.
     * The open and close actions should be balanced.  The
     * &lt;code&gt;flush&lt;/code&gt; method will be the last method
     * called, to give the receiver a chance to flush any
     * pending data into the document.
     * &lt;p&gt;Refer to DocumentParser, the default parser used, for further
     * information on the contents of the AttributeSets, the positions, and
     * other info.
     *
     * @see javax.swing.text.html.parser.DocumentParser
     */
<span class="nc" id="L990">    public static class ParserCallback {</span>
        /**
         * This is passed as an attribute in the attributeset to indicate
         * the element is implied eg, the string '&amp;lt;&amp;gt;foo&amp;lt;\t&amp;gt;'
         * contains an implied html element and an implied body element.
         *
         * @since 1.3
         */
<span class="nc" id="L998">        public static final Object IMPLIED = &quot;_implied_&quot;;</span>


        public void flush() throws BadLocationException {
<span class="nc" id="L1002">        }</span>

        public void handleText(char[] data, int pos) {
<span class="nc" id="L1005">        }</span>

        public void handleComment(char[] data, int pos) {
<span class="nc" id="L1008">        }</span>

        public void handleStartTag(HTML.Tag t, MutableAttributeSet a, int pos) {
<span class="nc" id="L1011">        }</span>

        public void handleEndTag(HTML.Tag t, int pos) {
<span class="nc" id="L1014">        }</span>

        public void handleSimpleTag(HTML.Tag t, MutableAttributeSet a, int pos) {
<span class="nc" id="L1017">        }</span>

        public void handleError(String errorMsg, int pos){
<span class="nc" id="L1020">        }</span>

        /**
         * This is invoked after the stream has been parsed, but before
         * &lt;code&gt;flush&lt;/code&gt;. &lt;code&gt;eol&lt;/code&gt; will be one of \n, \r
         * or \r\n, which ever is encountered the most in parsing the
         * stream.
         *
         * @since 1.3
         */
        public void handleEndOfLineString(String eol) {
<span class="nc" id="L1031">        }</span>
    }

    /**
     * A factory to build views for HTML.  The following
     * table describes what this factory will build by
     * default.
     *
     * &lt;table summary=&quot;Describes the tag and view created by this factory by default&quot;&gt;
     * &lt;tr&gt;
     * &lt;th align=left&gt;Tag&lt;th align=left&gt;View created
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.CONTENT&lt;td&gt;InlineView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.IMPLIED&lt;td&gt;javax.swing.text.html.ParagraphView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.P&lt;td&gt;javax.swing.text.html.ParagraphView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.H1&lt;td&gt;javax.swing.text.html.ParagraphView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.H2&lt;td&gt;javax.swing.text.html.ParagraphView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.H3&lt;td&gt;javax.swing.text.html.ParagraphView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.H4&lt;td&gt;javax.swing.text.html.ParagraphView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.H5&lt;td&gt;javax.swing.text.html.ParagraphView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.H6&lt;td&gt;javax.swing.text.html.ParagraphView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.DT&lt;td&gt;javax.swing.text.html.ParagraphView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.MENU&lt;td&gt;ListView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.DIR&lt;td&gt;ListView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.UL&lt;td&gt;ListView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.OL&lt;td&gt;ListView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.LI&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.DL&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.DD&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.BODY&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.HTML&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.CENTER&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.DIV&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.BLOCKQUOTE&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.PRE&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.BLOCKQUOTE&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.PRE&lt;td&gt;BlockView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.IMG&lt;td&gt;ImageView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.HR&lt;td&gt;HRuleView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.BR&lt;td&gt;BRView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.TABLE&lt;td&gt;javax.swing.text.html.TableView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.INPUT&lt;td&gt;FormView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.SELECT&lt;td&gt;FormView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.TEXTAREA&lt;td&gt;FormView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.OBJECT&lt;td&gt;ObjectView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.FRAMESET&lt;td&gt;FrameSetView
     * &lt;/tr&gt;&lt;tr&gt;
     * &lt;td&gt;HTML.Tag.FRAME&lt;td&gt;FrameView
     * &lt;/tr&gt;
     * &lt;/table&gt;
     */
<span class="nc" id="L1115">    public static class HTMLFactory implements ViewFactory {</span>

        /**
         * Creates a view from an element.
         *
         * @param elem the element
         * @return the view
         */
        public View create(Element elem) {
<span class="nc" id="L1124">            AttributeSet attrs = elem.getAttributes();</span>
<span class="nc" id="L1125">            Object elementName =</span>
<span class="nc" id="L1126">                attrs.getAttribute(AbstractDocument.ElementNameAttribute);</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">            Object o = (elementName != null) ?</span>
<span class="nc" id="L1128">                null : attrs.getAttribute(StyleConstants.NameAttribute);</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">            if (o instanceof HTML.Tag) {</span>
<span class="nc" id="L1130">                HTML.Tag kind = (HTML.Tag) o;</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">                if (kind == HTML.Tag.CONTENT) {</span>
<span class="nc" id="L1132">                    return new InlineView(elem);</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">                } else if (kind == HTML.Tag.IMPLIED) {</span>
<span class="nc" id="L1134">                    String ws = (String) elem.getAttributes().getAttribute(</span>
                        CSS.Attribute.WHITE_SPACE);
<span class="nc bnc" id="L1136" title="All 4 branches missed.">                    if ((ws != null) &amp;&amp; ws.equals(&quot;pre&quot;)) {</span>
<span class="nc" id="L1137">                        return new LineView(elem);</span>
                    }
<span class="nc" id="L1139">                    return new javax.swing.text.html.ParagraphView(elem);</span>
<span class="nc bnc" id="L1140" title="All 16 branches missed.">                } else if ((kind == HTML.Tag.P) ||</span>
                           (kind == HTML.Tag.H1) ||
                           (kind == HTML.Tag.H2) ||
                           (kind == HTML.Tag.H3) ||
                           (kind == HTML.Tag.H4) ||
                           (kind == HTML.Tag.H5) ||
                           (kind == HTML.Tag.H6) ||
                           (kind == HTML.Tag.DT)) {
                    // paragraph
<span class="nc" id="L1149">                    return new javax.swing.text.html.ParagraphView(elem);</span>
<span class="nc bnc" id="L1150" title="All 8 branches missed.">                } else if ((kind == HTML.Tag.MENU) ||</span>
                           (kind == HTML.Tag.DIR) ||
                           (kind == HTML.Tag.UL)   ||
                           (kind == HTML.Tag.OL)) {
<span class="nc" id="L1154">                    return new ListView(elem);</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">                } else if (kind == HTML.Tag.BODY) {</span>
<span class="nc" id="L1156">                    return new BodyBlockView(elem);</span>
<span class="nc bnc" id="L1157" title="All 2 branches missed.">                } else if (kind == HTML.Tag.HTML) {</span>
<span class="nc" id="L1158">                    return new BlockView(elem, View.Y_AXIS);</span>
<span class="nc bnc" id="L1159" title="All 16 branches missed.">                } else if ((kind == HTML.Tag.LI) ||</span>
                           (kind == HTML.Tag.CENTER) ||
                           (kind == HTML.Tag.DL) ||
                           (kind == HTML.Tag.DD) ||
                           (kind == HTML.Tag.DIV) ||
                           (kind == HTML.Tag.BLOCKQUOTE) ||
                           (kind == HTML.Tag.PRE) ||
                           (kind == HTML.Tag.FORM)) {
                    // vertical box
<span class="nc" id="L1168">                    return new BlockView(elem, View.Y_AXIS);</span>
<span class="nc bnc" id="L1169" title="All 2 branches missed.">                } else if (kind == HTML.Tag.NOFRAMES) {</span>
<span class="nc" id="L1170">                    return new NoFramesView(elem, View.Y_AXIS);</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">                } else if (kind==HTML.Tag.IMG) {</span>
<span class="nc" id="L1172">                    return new ImageView(elem);</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">                } else if (kind == HTML.Tag.ISINDEX) {</span>
<span class="nc" id="L1174">                    return new IsindexView(elem);</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">                } else if (kind == HTML.Tag.HR) {</span>
<span class="nc" id="L1176">                    return new HRuleView(elem);</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">                } else if (kind == HTML.Tag.BR) {</span>
<span class="nc" id="L1178">                    return new BRView(elem);</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">                } else if (kind == HTML.Tag.TABLE) {</span>
<span class="nc" id="L1180">                    return new javax.swing.text.html.TableView(elem);</span>
<span class="nc bnc" id="L1181" title="All 6 branches missed.">                } else if ((kind == HTML.Tag.INPUT) ||</span>
                           (kind == HTML.Tag.SELECT) ||
                           (kind == HTML.Tag.TEXTAREA)) {
<span class="nc" id="L1184">                    return new FormView(elem);</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">                } else if (kind == HTML.Tag.OBJECT) {</span>
<span class="nc" id="L1186">                    return new ObjectView(elem);</span>
<span class="nc bnc" id="L1187" title="All 2 branches missed.">                } else if (kind == HTML.Tag.FRAMESET) {</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">                     if (elem.getAttributes().isDefined(HTML.Attribute.ROWS)) {</span>
<span class="nc" id="L1189">                         return new FrameSetView(elem, View.Y_AXIS);</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">                     } else if (elem.getAttributes().isDefined(HTML.Attribute.COLS)) {</span>
<span class="nc" id="L1191">                         return new FrameSetView(elem, View.X_AXIS);</span>
                     }
<span class="nc" id="L1193">                     throw new RuntimeException(&quot;Can't build a&quot;  + kind + &quot;, &quot; + elem + &quot;:&quot; +</span>
                                     &quot;no ROWS or COLS defined.&quot;);
<span class="nc bnc" id="L1195" title="All 2 branches missed.">                } else if (kind == HTML.Tag.FRAME) {</span>
<span class="nc" id="L1196">                    return new FrameView(elem);</span>
<span class="nc bnc" id="L1197" title="All 2 branches missed.">                } else if (kind instanceof HTML.UnknownTag) {</span>
<span class="nc" id="L1198">                    return new HiddenTagView(elem);</span>
<span class="nc bnc" id="L1199" title="All 2 branches missed.">                } else if (kind == HTML.Tag.COMMENT) {</span>
<span class="nc" id="L1200">                    return new CommentView(elem);</span>
<span class="nc bnc" id="L1201" title="All 2 branches missed.">                } else if (kind == HTML.Tag.HEAD) {</span>
                    // Make the head never visible, and never load its
                    // children. For Cursor positioning,
                    // getNextVisualPositionFrom is overriden to always return
                    // the end offset of the element.
<span class="nc" id="L1206">                    return new BlockView(elem, View.X_AXIS) {</span>
                        public float getPreferredSpan(int axis) {
<span class="nc" id="L1208">                            return 0;</span>
                        }
                        public float getMinimumSpan(int axis) {
<span class="nc" id="L1211">                            return 0;</span>
                        }
                        public float getMaximumSpan(int axis) {
<span class="nc" id="L1214">                            return 0;</span>
                        }
                        protected void loadChildren(ViewFactory f) {
<span class="nc" id="L1217">                        }</span>
                        public Shape modelToView(int pos, Shape a,
                               Position.Bias b) throws BadLocationException {
<span class="nc" id="L1220">                            return a;</span>
                        }
                        public int getNextVisualPositionFrom(int pos,
                                     Position.Bias b, Shape a,
                                     int direction, Position.Bias[] biasRet) {
<span class="nc" id="L1225">                            return getElement().getEndOffset();</span>
                        }
                    };
<span class="nc bnc" id="L1228" title="All 18 branches missed.">                } else if ((kind == HTML.Tag.TITLE) ||</span>
                           (kind == HTML.Tag.META) ||
                           (kind == HTML.Tag.LINK) ||
                           (kind == HTML.Tag.STYLE) ||
                           (kind == HTML.Tag.SCRIPT) ||
                           (kind == HTML.Tag.AREA) ||
                           (kind == HTML.Tag.MAP) ||
                           (kind == HTML.Tag.PARAM) ||
                           (kind == HTML.Tag.APPLET)) {
<span class="nc" id="L1237">                    return new HiddenTagView(elem);</span>
                }
            }
            // If we get here, it's either an element we don't know about
            // or something from StyledDocument that doesn't have a mapping to HTML.
<span class="nc bnc" id="L1242" title="All 2 branches missed.">            String nm = (elementName != null) ? (String)elementName :</span>
<span class="nc" id="L1243">                                                elem.getName();</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">            if (nm != null) {</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">                if (nm.equals(AbstractDocument.ContentElementName)) {</span>
<span class="nc" id="L1246">                    return new LabelView(elem);</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">                } else if (nm.equals(AbstractDocument.ParagraphElementName)) {</span>
<span class="nc" id="L1248">                    return new ParagraphView(elem);</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">                } else if (nm.equals(AbstractDocument.SectionElementName)) {</span>
<span class="nc" id="L1250">                    return new BoxView(elem, View.Y_AXIS);</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">                } else if (nm.equals(StyleConstants.ComponentElementName)) {</span>
<span class="nc" id="L1252">                    return new ComponentView(elem);</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">                } else if (nm.equals(StyleConstants.IconElementName)) {</span>
<span class="nc" id="L1254">                    return new IconView(elem);</span>
                }
            }

            // default to text display
<span class="nc" id="L1259">            return new LabelView(elem);</span>
        }

<span class="nc" id="L1262">        static class BodyBlockView extends BlockView implements ComponentListener {</span>
            public BodyBlockView(Element elem) {
<span class="nc" id="L1264">                super(elem,View.Y_AXIS);</span>
<span class="nc" id="L1265">            }</span>
            // reimplement major axis requirements to indicate that the
            // block is flexible for the body element... so that it can
            // be stretched to fill the background properly.
            protected SizeRequirements calculateMajorAxisRequirements(int axis, SizeRequirements r) {
<span class="nc" id="L1270">                r = super.calculateMajorAxisRequirements(axis, r);</span>
<span class="nc" id="L1271">                r.maximum = Integer.MAX_VALUE;</span>
<span class="nc" id="L1272">                return r;</span>
            }

            protected void layoutMinorAxis(int targetSpan, int axis, int[] offsets, int[] spans) {
<span class="nc" id="L1276">                Container container = getContainer();</span>
                Container parentContainer;
<span class="nc bnc" id="L1278" title="All 4 branches missed.">                if (container != null</span>
                    &amp;&amp; (container instanceof javax.swing.JEditorPane)
<span class="nc bnc" id="L1280" title="All 4 branches missed.">                    &amp;&amp; (parentContainer = container.getParent()) != null</span>
                    &amp;&amp; (parentContainer instanceof javax.swing.JViewport)) {
<span class="nc" id="L1282">                    JViewport viewPort = (JViewport)parentContainer;</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">                    if (cachedViewPort != null) {</span>
<span class="nc" id="L1284">                        JViewport cachedObject = cachedViewPort.get();</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">                        if (cachedObject != null) {</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">                            if (cachedObject != viewPort) {</span>
<span class="nc" id="L1287">                                cachedObject.removeComponentListener(this);</span>
                            }
                        } else {
<span class="nc" id="L1290">                            cachedViewPort = null;</span>
                        }
                    }
<span class="nc bnc" id="L1293" title="All 2 branches missed.">                    if (cachedViewPort == null) {</span>
<span class="nc" id="L1294">                        viewPort.addComponentListener(this);</span>
<span class="nc" id="L1295">                        cachedViewPort = new WeakReference&lt;JViewport&gt;(viewPort);</span>
                    }

<span class="nc" id="L1298">                    componentVisibleWidth = viewPort.getExtentSize().width;</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">                    if (componentVisibleWidth &gt; 0) {</span>
<span class="nc" id="L1300">                    Insets insets = container.getInsets();</span>
<span class="nc" id="L1301">                    viewVisibleWidth = componentVisibleWidth - insets.left - getLeftInset();</span>
                    //try to use viewVisibleWidth if it is smaller than targetSpan
<span class="nc" id="L1303">                    targetSpan = Math.min(targetSpan, viewVisibleWidth);</span>
                    }
<span class="nc" id="L1305">                } else {</span>
<span class="nc bnc" id="L1306" title="All 2 branches missed.">                    if (cachedViewPort != null) {</span>
<span class="nc" id="L1307">                        JViewport cachedObject = cachedViewPort.get();</span>
<span class="nc bnc" id="L1308" title="All 2 branches missed.">                        if (cachedObject != null) {</span>
<span class="nc" id="L1309">                            cachedObject.removeComponentListener(this);</span>
                        }
<span class="nc" id="L1311">                        cachedViewPort = null;</span>
                    }
                }
<span class="nc" id="L1314">                super.layoutMinorAxis(targetSpan, axis, offsets, spans);</span>
<span class="nc" id="L1315">            }</span>

            public void setParent(View parent) {
                //if parent == null unregister component listener
<span class="nc bnc" id="L1319" title="All 2 branches missed.">                if (parent == null) {</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">                    if (cachedViewPort != null) {</span>
                        Object cachedObject;
<span class="nc bnc" id="L1322" title="All 2 branches missed.">                        if ((cachedObject = cachedViewPort.get()) != null) {</span>
<span class="nc" id="L1323">                            ((JComponent)cachedObject).removeComponentListener(this);</span>
                        }
<span class="nc" id="L1325">                        cachedViewPort = null;</span>
                    }
                }
<span class="nc" id="L1328">                super.setParent(parent);</span>
<span class="nc" id="L1329">            }</span>

            public void componentResized(ComponentEvent e) {
<span class="nc bnc" id="L1332" title="All 2 branches missed.">                if ( !(e.getSource() instanceof JViewport) ) {</span>
<span class="nc" id="L1333">                    return;</span>
                }
<span class="nc" id="L1335">                JViewport viewPort = (JViewport)e.getSource();</span>
<span class="nc bnc" id="L1336" title="All 2 branches missed.">                if (componentVisibleWidth != viewPort.getExtentSize().width) {</span>
<span class="nc" id="L1337">                    Document doc = getDocument();</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">                    if (doc instanceof AbstractDocument) {</span>
<span class="nc" id="L1339">                        AbstractDocument document = (AbstractDocument)getDocument();</span>
<span class="nc" id="L1340">                        document.readLock();</span>
                        try {
<span class="nc" id="L1342">                            layoutChanged(X_AXIS);</span>
<span class="nc" id="L1343">                            preferenceChanged(null, true, true);</span>
                        } finally {
<span class="nc" id="L1345">                            document.readUnlock();</span>
<span class="nc" id="L1346">                        }</span>

                    }
                }
<span class="nc" id="L1350">            }</span>
            public void componentHidden(ComponentEvent e) {
<span class="nc" id="L1352">            }</span>
            public void componentMoved(ComponentEvent e) {
<span class="nc" id="L1354">            }</span>
            public void componentShown(ComponentEvent e) {
<span class="nc" id="L1356">            }</span>
            /*
             * we keep weak reference to viewPort if and only if BodyBoxView is listening for ComponentEvents
             * only in that case cachedViewPort is not equal to null.
             * we need to keep this reference in order to remove BodyBoxView from viewPort listeners.
             *
             */
<span class="nc" id="L1363">            private Reference&lt;JViewport&gt; cachedViewPort = null;</span>
<span class="nc" id="L1364">            private boolean isListening = false;</span>
<span class="nc" id="L1365">            private int viewVisibleWidth = Integer.MAX_VALUE;</span>
<span class="nc" id="L1366">            private int componentVisibleWidth = Integer.MAX_VALUE;</span>
        }

    }

    // --- Action implementations ------------------------------

/** The bold action identifier
*/
    public static final String  BOLD_ACTION = &quot;html-bold-action&quot;;
/** The italic action identifier
*/
    public static final String  ITALIC_ACTION = &quot;html-italic-action&quot;;
/** The paragraph left indent action identifier
*/
    public static final String  PARA_INDENT_LEFT = &quot;html-para-indent-left&quot;;
/** The paragraph right indent action identifier
*/
    public static final String  PARA_INDENT_RIGHT = &quot;html-para-indent-right&quot;;
/** The  font size increase to next value action identifier
*/
    public static final String  FONT_CHANGE_BIGGER = &quot;html-font-bigger&quot;;
/** The font size decrease to next value action identifier
*/
    public static final String  FONT_CHANGE_SMALLER = &quot;html-font-smaller&quot;;
/** The Color choice action identifier
     The color is passed as an argument
*/
    public static final String  COLOR_ACTION = &quot;html-color-action&quot;;
/** The logical style choice action identifier
     The logical style is passed in as an argument
*/
    public static final String  LOGICAL_STYLE_ACTION = &quot;html-logical-style-action&quot;;
    /**
     * Align images at the top.
     */
    public static final String  IMG_ALIGN_TOP = &quot;html-image-align-top&quot;;

    /**
     * Align images in the middle.
     */
    public static final String  IMG_ALIGN_MIDDLE = &quot;html-image-align-middle&quot;;

    /**
     * Align images at the bottom.
     */
    public static final String  IMG_ALIGN_BOTTOM = &quot;html-image-align-bottom&quot;;

    /**
     * Align images at the border.
     */
    public static final String  IMG_BORDER = &quot;html-image-border&quot;;


    /** HTML used when inserting tables. */
    private static final String INSERT_TABLE_HTML = &quot;&lt;table border=1&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;

    /** HTML used when inserting unordered lists. */
    private static final String INSERT_UL_HTML = &quot;&lt;ul&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&quot;;

    /** HTML used when inserting ordered lists. */
    private static final String INSERT_OL_HTML = &quot;&lt;ol&gt;&lt;li&gt;&lt;/li&gt;&lt;/ol&gt;&quot;;

    /** HTML used when inserting hr. */
    private static final String INSERT_HR_HTML = &quot;&lt;hr&gt;&quot;;

    /** HTML used when inserting pre. */
    private static final String INSERT_PRE_HTML = &quot;&lt;pre&gt;&lt;/pre&gt;&quot;;

<span class="nc" id="L1435">    private static final NavigateLinkAction nextLinkAction =</span>
        new NavigateLinkAction(&quot;next-link-action&quot;);

<span class="nc" id="L1438">    private static final NavigateLinkAction previousLinkAction =</span>
        new NavigateLinkAction(&quot;previous-link-action&quot;);

<span class="nc" id="L1441">    private static final ActivateLinkAction activateLinkAction =</span>
        new ActivateLinkAction(&quot;activate-link-action&quot;);

<span class="nc" id="L1444">    private static final Action[] defaultActions = {</span>
        new InsertHTMLTextAction(&quot;InsertTable&quot;, INSERT_TABLE_HTML,
                                 HTML.Tag.BODY, HTML.Tag.TABLE),
        new InsertHTMLTextAction(&quot;InsertTableRow&quot;, INSERT_TABLE_HTML,
                                 HTML.Tag.TABLE, HTML.Tag.TR,
                                 HTML.Tag.BODY, HTML.Tag.TABLE),
        new InsertHTMLTextAction(&quot;InsertTableDataCell&quot;, INSERT_TABLE_HTML,
                                 HTML.Tag.TR, HTML.Tag.TD,
                                 HTML.Tag.BODY, HTML.Tag.TABLE),
        new InsertHTMLTextAction(&quot;InsertUnorderedList&quot;, INSERT_UL_HTML,
                                 HTML.Tag.BODY, HTML.Tag.UL),
        new InsertHTMLTextAction(&quot;InsertUnorderedListItem&quot;, INSERT_UL_HTML,
                                 HTML.Tag.UL, HTML.Tag.LI,
                                 HTML.Tag.BODY, HTML.Tag.UL),
        new InsertHTMLTextAction(&quot;InsertOrderedList&quot;, INSERT_OL_HTML,
                                 HTML.Tag.BODY, HTML.Tag.OL),
        new InsertHTMLTextAction(&quot;InsertOrderedListItem&quot;, INSERT_OL_HTML,
                                 HTML.Tag.OL, HTML.Tag.LI,
                                 HTML.Tag.BODY, HTML.Tag.OL),
        new InsertHRAction(),
        new InsertHTMLTextAction(&quot;InsertPre&quot;, INSERT_PRE_HTML,
                                 HTML.Tag.BODY, HTML.Tag.PRE),
        nextLinkAction, previousLinkAction, activateLinkAction,

        new BeginAction(beginAction, false),
        new BeginAction(selectionBeginAction, true)
    };

    // link navigation support
<span class="nc" id="L1473">    private boolean foundLink = false;</span>
<span class="nc" id="L1474">    private int prevHypertextOffset = -1;</span>
    private Object linkNavigationTag;


    /**
     * An abstract Action providing some convenience methods that may
     * be useful in inserting HTML into an existing document.
     * &lt;p&gt;NOTE: None of the convenience methods obtain a lock on the
     * document. If you have another thread modifying the text these
     * methods may have inconsistent behavior, or return the wrong thing.
     */
    public static abstract class HTMLTextAction extends StyledTextAction {
        public HTMLTextAction(String name) {
<span class="nc" id="L1487">            super(name);</span>
<span class="nc" id="L1488">        }</span>

        /**
         * @return HTMLDocument of &lt;code&gt;e&lt;/code&gt;.
         */
        protected HTMLDocument getHTMLDocument(JEditorPane e) {
<span class="nc" id="L1494">            Document d = e.getDocument();</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">            if (d instanceof HTMLDocument) {</span>
<span class="nc" id="L1496">                return (HTMLDocument) d;</span>
            }
<span class="nc" id="L1498">            throw new IllegalArgumentException(&quot;document must be HTMLDocument&quot;);</span>
        }

        /**
         * @return HTMLEditorKit for &lt;code&gt;e&lt;/code&gt;.
         */
        protected HTMLEditorKit getHTMLEditorKit(JEditorPane e) {
<span class="nc" id="L1505">            EditorKit k = e.getEditorKit();</span>
<span class="nc bnc" id="L1506" title="All 2 branches missed.">            if (k instanceof HTMLEditorKit) {</span>
<span class="nc" id="L1507">                return (HTMLEditorKit) k;</span>
            }
<span class="nc" id="L1509">            throw new IllegalArgumentException(&quot;EditorKit must be HTMLEditorKit&quot;);</span>
        }

        /**
         * Returns an array of the Elements that contain &lt;code&gt;offset&lt;/code&gt;.
         * The first elements corresponds to the root.
         */
        protected Element[] getElementsAt(HTMLDocument doc, int offset) {
<span class="nc" id="L1517">            return getElementsAt(doc.getDefaultRootElement(), offset, 0);</span>
        }

        /**
         * Recursive method used by getElementsAt.
         */
        private Element[] getElementsAt(Element parent, int offset,
                                        int depth) {
<span class="nc bnc" id="L1525" title="All 2 branches missed.">            if (parent.isLeaf()) {</span>
<span class="nc" id="L1526">                Element[] retValue = new Element[depth + 1];</span>
<span class="nc" id="L1527">                retValue[depth] = parent;</span>
<span class="nc" id="L1528">                return retValue;</span>
            }
<span class="nc" id="L1530">            Element[] retValue = getElementsAt(parent.getElement</span>
<span class="nc" id="L1531">                          (parent.getElementIndex(offset)), offset, depth + 1);</span>
<span class="nc" id="L1532">            retValue[depth] = parent;</span>
<span class="nc" id="L1533">            return retValue;</span>
        }

        /**
         * Returns number of elements, starting at the deepest leaf, needed
         * to get to an element representing &lt;code&gt;tag&lt;/code&gt;. This will
         * return -1 if no elements is found representing &lt;code&gt;tag&lt;/code&gt;,
         * or 0 if the parent of the leaf at &lt;code&gt;offset&lt;/code&gt; represents
         * &lt;code&gt;tag&lt;/code&gt;.
         */
        protected int elementCountToTag(HTMLDocument doc, int offset,
                                        HTML.Tag tag) {
<span class="nc" id="L1545">            int depth = -1;</span>
<span class="nc" id="L1546">            Element e = doc.getCharacterElement(offset);</span>
<span class="nc bnc" id="L1547" title="All 2 branches missed.">            while (e != null &amp;&amp; e.getAttributes().getAttribute</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">                   (StyleConstants.NameAttribute) != tag) {</span>
<span class="nc" id="L1549">                e = e.getParentElement();</span>
<span class="nc" id="L1550">                depth++;</span>
            }
<span class="nc bnc" id="L1552" title="All 2 branches missed.">            if (e == null) {</span>
<span class="nc" id="L1553">                return -1;</span>
            }
<span class="nc" id="L1555">            return depth;</span>
        }

        /**
         * Returns the deepest element at &lt;code&gt;offset&lt;/code&gt; matching
         * &lt;code&gt;tag&lt;/code&gt;.
         */
        protected Element findElementMatchingTag(HTMLDocument doc, int offset,
                                                 HTML.Tag tag) {
<span class="nc" id="L1564">            Element e = doc.getDefaultRootElement();</span>
<span class="nc" id="L1565">            Element lastMatch = null;</span>
<span class="nc bnc" id="L1566" title="All 2 branches missed.">            while (e != null) {</span>
<span class="nc" id="L1567">                if (e.getAttributes().getAttribute</span>
<span class="nc bnc" id="L1568" title="All 2 branches missed.">                   (StyleConstants.NameAttribute) == tag) {</span>
<span class="nc" id="L1569">                    lastMatch = e;</span>
                }
<span class="nc" id="L1571">                e = e.getElement(e.getElementIndex(offset));</span>
            }
<span class="nc" id="L1573">            return lastMatch;</span>
        }
    }


    /**
     * InsertHTMLTextAction can be used to insert an arbitrary string of HTML
     * into an existing HTML document. At least two HTML.Tags need to be
     * supplied. The first Tag, parentTag, identifies the parent in
     * the document to add the elements to. The second tag, addTag,
     * identifies the first tag that should be added to the document as
     * seen in the HTML string. One important thing to remember, is that
     * the parser is going to generate all the appropriate tags, even if
     * they aren't in the HTML string passed in.&lt;p&gt;
     * For example, lets say you wanted to create an action to insert
     * a table into the body. The parentTag would be HTML.Tag.BODY,
     * addTag would be HTML.Tag.TABLE, and the string could be something
     * like &amp;lt;table&amp;gt;&amp;lt;tr&amp;gt;&amp;lt;td&amp;gt;&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;&amp;lt;/table&amp;gt;.
     * &lt;p&gt;There is also an option to supply an alternate parentTag and
     * addTag. These will be checked for if there is no parentTag at
     * offset.
     */
    public static class InsertHTMLTextAction extends HTMLTextAction {
        public InsertHTMLTextAction(String name, String html,
                                    HTML.Tag parentTag, HTML.Tag addTag) {
<span class="nc" id="L1598">            this(name, html, parentTag, addTag, null, null);</span>
<span class="nc" id="L1599">        }</span>

        public InsertHTMLTextAction(String name, String html,
                                    HTML.Tag parentTag,
                                    HTML.Tag addTag,
                                    HTML.Tag alternateParentTag,
                                    HTML.Tag alternateAddTag) {
<span class="nc" id="L1606">            this(name, html, parentTag, addTag, alternateParentTag,</span>
                 alternateAddTag, true);
<span class="nc" id="L1608">        }</span>

        /* public */
        InsertHTMLTextAction(String name, String html,
                                    HTML.Tag parentTag,
                                    HTML.Tag addTag,
                                    HTML.Tag alternateParentTag,
                                    HTML.Tag alternateAddTag,
                                    boolean adjustSelection) {
<span class="nc" id="L1617">            super(name);</span>
<span class="nc" id="L1618">            this.html = html;</span>
<span class="nc" id="L1619">            this.parentTag = parentTag;</span>
<span class="nc" id="L1620">            this.addTag = addTag;</span>
<span class="nc" id="L1621">            this.alternateParentTag = alternateParentTag;</span>
<span class="nc" id="L1622">            this.alternateAddTag = alternateAddTag;</span>
<span class="nc" id="L1623">            this.adjustSelection = adjustSelection;</span>
<span class="nc" id="L1624">        }</span>

        /**
         * A cover for HTMLEditorKit.insertHTML. If an exception it
         * thrown it is wrapped in a RuntimeException and thrown.
         */
        protected void insertHTML(JEditorPane editor, HTMLDocument doc,
                                  int offset, String html, int popDepth,
                                  int pushDepth, HTML.Tag addTag) {
            try {
<span class="nc" id="L1634">                getHTMLEditorKit(editor).insertHTML(doc, offset, html,</span>
                                                    popDepth, pushDepth,
                                                    addTag);
<span class="nc" id="L1637">            } catch (IOException ioe) {</span>
<span class="nc" id="L1638">                throw new RuntimeException(&quot;Unable to insert: &quot; + ioe);</span>
<span class="nc" id="L1639">            } catch (BadLocationException ble) {</span>
<span class="nc" id="L1640">                throw new RuntimeException(&quot;Unable to insert: &quot; + ble);</span>
<span class="nc" id="L1641">            }</span>
<span class="nc" id="L1642">        }</span>

        /**
         * This is invoked when inserting at a boundary. It determines
         * the number of pops, and then the number of pushes that need
         * to be performed, and then invokes insertHTML.
         * @since 1.3
         */
        protected void insertAtBoundary(JEditorPane editor, HTMLDocument doc,
                                        int offset, Element insertElement,
                                        String html, HTML.Tag parentTag,
                                        HTML.Tag addTag) {
<span class="nc" id="L1654">            insertAtBoundry(editor, doc, offset, insertElement, html,</span>
                            parentTag, addTag);
<span class="nc" id="L1656">        }</span>

        /**
         * This is invoked when inserting at a boundary. It determines
         * the number of pops, and then the number of pushes that need
         * to be performed, and then invokes insertHTML.
         * @deprecated As of Java 2 platform v1.3, use insertAtBoundary
         */
        @Deprecated
        protected void insertAtBoundry(JEditorPane editor, HTMLDocument doc,
                                       int offset, Element insertElement,
                                       String html, HTML.Tag parentTag,
                                       HTML.Tag addTag) {
            // Find the common parent.
            Element e;
            Element commonParent;
<span class="nc bnc" id="L1672" title="All 2 branches missed.">            boolean isFirst = (offset == 0);</span>

<span class="nc bnc" id="L1674" title="All 4 branches missed.">            if (offset &gt; 0 || insertElement == null) {</span>
<span class="nc" id="L1675">                e = doc.getDefaultRootElement();</span>
<span class="nc bnc" id="L1676" title="All 4 branches missed.">                while (e != null &amp;&amp; e.getStartOffset() != offset &amp;&amp;</span>
<span class="nc bnc" id="L1677" title="All 2 branches missed.">                       !e.isLeaf()) {</span>
<span class="nc" id="L1678">                    e = e.getElement(e.getElementIndex(offset));</span>
                }
<span class="nc bnc" id="L1680" title="All 2 branches missed.">                commonParent = (e != null) ? e.getParentElement() : null;</span>
            }
            else {
                // If inserting at the origin, the common parent is the
                // insertElement.
<span class="nc" id="L1685">                commonParent = insertElement;</span>
            }
<span class="nc bnc" id="L1687" title="All 2 branches missed.">            if (commonParent != null) {</span>
                // Determine how many pops to do.
<span class="nc" id="L1689">                int pops = 0;</span>
<span class="nc" id="L1690">                int pushes = 0;</span>
<span class="nc bnc" id="L1691" title="All 4 branches missed.">                if (isFirst &amp;&amp; insertElement != null) {</span>
<span class="nc" id="L1692">                    e = commonParent;</span>
<span class="nc bnc" id="L1693" title="All 4 branches missed.">                    while (e != null &amp;&amp; !e.isLeaf()) {</span>
<span class="nc" id="L1694">                        e = e.getElement(e.getElementIndex(offset));</span>
<span class="nc" id="L1695">                        pops++;</span>
                    }
                }
                else {
<span class="nc" id="L1699">                    e = commonParent;</span>
<span class="nc" id="L1700">                    offset--;</span>
<span class="nc bnc" id="L1701" title="All 4 branches missed.">                    while (e != null &amp;&amp; !e.isLeaf()) {</span>
<span class="nc" id="L1702">                        e = e.getElement(e.getElementIndex(offset));</span>
<span class="nc" id="L1703">                        pops++;</span>
                    }

                    // And how many pushes
<span class="nc" id="L1707">                    e = commonParent;</span>
<span class="nc" id="L1708">                    offset++;</span>
<span class="nc bnc" id="L1709" title="All 4 branches missed.">                    while (e != null &amp;&amp; e != insertElement) {</span>
<span class="nc" id="L1710">                        e = e.getElement(e.getElementIndex(offset));</span>
<span class="nc" id="L1711">                        pushes++;</span>
                    }
                }
<span class="nc" id="L1714">                pops = Math.max(0, pops - 1);</span>

                // And insert!
<span class="nc" id="L1717">                insertHTML(editor, doc, offset, html, pops, pushes, addTag);</span>
            }
<span class="nc" id="L1719">        }</span>

        /**
         * If there is an Element with name &lt;code&gt;tag&lt;/code&gt; at
         * &lt;code&gt;offset&lt;/code&gt;, this will invoke either insertAtBoundary
         * or &lt;code&gt;insertHTML&lt;/code&gt;. This returns true if there is
         * a match, and one of the inserts is invoked.
         */
        /*protected*/
        boolean insertIntoTag(JEditorPane editor, HTMLDocument doc,
                              int offset, HTML.Tag tag, HTML.Tag addTag) {
<span class="nc" id="L1730">            Element e = findElementMatchingTag(doc, offset, tag);</span>
<span class="nc bnc" id="L1731" title="All 4 branches missed.">            if (e != null &amp;&amp; e.getStartOffset() == offset) {</span>
<span class="nc" id="L1732">                insertAtBoundary(editor, doc, offset, e, html,</span>
                                 tag, addTag);
<span class="nc" id="L1734">                return true;</span>
            }
<span class="nc bnc" id="L1736" title="All 2 branches missed.">            else if (offset &gt; 0) {</span>
<span class="nc" id="L1737">                int depth = elementCountToTag(doc, offset - 1, tag);</span>
<span class="nc bnc" id="L1738" title="All 2 branches missed.">                if (depth != -1) {</span>
<span class="nc" id="L1739">                    insertHTML(editor, doc, offset, html, depth, 0, addTag);</span>
<span class="nc" id="L1740">                    return true;</span>
                }
            }
<span class="nc" id="L1743">            return false;</span>
        }

        /**
         * Called after an insertion to adjust the selection.
         */
        /* protected */
        void adjustSelection(JEditorPane pane, HTMLDocument doc,
                             int startOffset, int oldLength) {
<span class="nc" id="L1752">            int newLength = doc.getLength();</span>
<span class="nc bnc" id="L1753" title="All 4 branches missed.">            if (newLength != oldLength &amp;&amp; startOffset &lt; newLength) {</span>
<span class="nc bnc" id="L1754" title="All 2 branches missed.">                if (startOffset &gt; 0) {</span>
                    String text;
                    try {
<span class="nc" id="L1757">                        text = doc.getText(startOffset - 1, 1);</span>
<span class="nc" id="L1758">                    } catch (BadLocationException ble) {</span>
<span class="nc" id="L1759">                        text = null;</span>
<span class="nc" id="L1760">                    }</span>
<span class="nc bnc" id="L1761" title="All 4 branches missed.">                    if (text != null &amp;&amp; text.length() &gt; 0 &amp;&amp;</span>
<span class="nc bnc" id="L1762" title="All 2 branches missed.">                        text.charAt(0) == '\n') {</span>
<span class="nc" id="L1763">                        pane.select(startOffset, startOffset);</span>
                    }
                    else {
<span class="nc" id="L1766">                        pane.select(startOffset + 1, startOffset + 1);</span>
                    }
<span class="nc" id="L1768">                }</span>
                else {
<span class="nc" id="L1770">                    pane.select(1, 1);</span>
                }
            }
<span class="nc" id="L1773">        }</span>

        /**
         * Inserts the HTML into the document.
         *
         * @param ae the event
         */
        public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L1781">            JEditorPane editor = getEditor(ae);</span>
<span class="nc bnc" id="L1782" title="All 2 branches missed.">            if (editor != null) {</span>
<span class="nc" id="L1783">                HTMLDocument doc = getHTMLDocument(editor);</span>
<span class="nc" id="L1784">                int offset = editor.getSelectionStart();</span>
<span class="nc" id="L1785">                int length = doc.getLength();</span>
                boolean inserted;
                // Try first choice
<span class="nc bnc" id="L1788" title="All 4 branches missed.">                if (!insertIntoTag(editor, doc, offset, parentTag, addTag) &amp;&amp;</span>
                    alternateParentTag != null) {
                    // Then alternate.
<span class="nc" id="L1791">                    inserted = insertIntoTag(editor, doc, offset,</span>
                                             alternateParentTag,
                                             alternateAddTag);
                }
                else {
<span class="nc" id="L1796">                    inserted = true;</span>
                }
<span class="nc bnc" id="L1798" title="All 4 branches missed.">                if (adjustSelection &amp;&amp; inserted) {</span>
<span class="nc" id="L1799">                    adjustSelection(editor, doc, offset, length);</span>
                }
            }
<span class="nc" id="L1802">        }</span>

        /** HTML to insert. */
        protected String html;
        /** Tag to check for in the document. */
        protected HTML.Tag parentTag;
        /** Tag in HTML to start adding tags from. */
        protected HTML.Tag addTag;
        /** Alternate Tag to check for in the document if parentTag is
         * not found. */
        protected HTML.Tag alternateParentTag;
        /** Alternate tag in HTML to start adding tags from if parentTag
         * is not found and alternateParentTag is found. */
        protected HTML.Tag alternateAddTag;
        /** True indicates the selection should be adjusted after an insert. */
        boolean adjustSelection;
    }


    /**
     * InsertHRAction is special, at actionPerformed time it will determine
     * the parent HTML.Tag based on the paragraph element at the selection
     * start.
     */
    static class InsertHRAction extends InsertHTMLTextAction {
        InsertHRAction() {
<span class="nc" id="L1828">            super(&quot;InsertHR&quot;, &quot;&lt;hr&gt;&quot;, null, HTML.Tag.IMPLIED, null, null,</span>
                  false);
<span class="nc" id="L1830">        }</span>

        /**
         * Inserts the HTML into the document.
         *
         * @param ae the event
         */
        public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L1838">            JEditorPane editor = getEditor(ae);</span>
<span class="nc bnc" id="L1839" title="All 2 branches missed.">            if (editor != null) {</span>
<span class="nc" id="L1840">                HTMLDocument doc = getHTMLDocument(editor);</span>
<span class="nc" id="L1841">                int offset = editor.getSelectionStart();</span>
<span class="nc" id="L1842">                Element paragraph = doc.getParagraphElement(offset);</span>
<span class="nc bnc" id="L1843" title="All 2 branches missed.">                if (paragraph.getParentElement() != null) {</span>
<span class="nc" id="L1844">                    parentTag = (HTML.Tag)paragraph.getParentElement().</span>
<span class="nc" id="L1845">                                  getAttributes().getAttribute</span>
<span class="nc" id="L1846">                                  (StyleConstants.NameAttribute);</span>
<span class="nc" id="L1847">                    super.actionPerformed(ae);</span>
                }
            }
<span class="nc" id="L1850">        }</span>

    }

    /*
     * Returns the object in an AttributeSet matching a key
     */
    static private Object getAttrValue(AttributeSet attr, HTML.Attribute key) {
<span class="nc" id="L1858">        Enumeration names = attr.getAttributeNames();</span>
<span class="nc bnc" id="L1859" title="All 2 branches missed.">        while (names.hasMoreElements()) {</span>
<span class="nc" id="L1860">            Object nextKey = names.nextElement();</span>
<span class="nc" id="L1861">            Object nextVal = attr.getAttribute(nextKey);</span>
<span class="nc bnc" id="L1862" title="All 2 branches missed.">            if (nextVal instanceof AttributeSet) {</span>
<span class="nc" id="L1863">                Object value = getAttrValue((AttributeSet)nextVal, key);</span>
<span class="nc bnc" id="L1864" title="All 2 branches missed.">                if (value != null) {</span>
<span class="nc" id="L1865">                    return value;</span>
                }
<span class="nc bnc" id="L1867" title="All 2 branches missed.">            } else if (nextKey == key) {</span>
<span class="nc" id="L1868">                return nextVal;</span>
            }
<span class="nc" id="L1870">        }</span>
<span class="nc" id="L1871">        return null;</span>
    }

    /*
     * Action to move the focus on the next or previous hypertext link
     * or object. TODO: This method relies on support from the
     * javax.accessibility package.  The text package should support
     * keyboard navigation of text elements directly.
     */
    static class NavigateLinkAction extends TextAction implements CaretListener {

<span class="nc" id="L1882">        private static final FocusHighlightPainter focusPainter =</span>
            new FocusHighlightPainter(null);
        private final boolean focusBack;

        /*
         * Create this action with the appropriate identifier.
         */
        public NavigateLinkAction(String actionName) {
<span class="nc" id="L1890">            super(actionName);</span>
<span class="nc" id="L1891">            focusBack = &quot;previous-link-action&quot;.equals(actionName);</span>
<span class="nc" id="L1892">        }</span>

        /**
         * Called when the caret position is updated.
         *
         * @param e the caret event
         */
        public void caretUpdate(CaretEvent e) {
<span class="nc" id="L1900">            Object src = e.getSource();</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">            if (src instanceof JTextComponent) {</span>
<span class="nc" id="L1902">                JTextComponent comp = (JTextComponent) src;</span>
<span class="nc" id="L1903">                HTMLEditorKit kit = getHTMLEditorKit(comp);</span>
<span class="nc bnc" id="L1904" title="All 4 branches missed.">                if (kit != null &amp;&amp; kit.foundLink) {</span>
<span class="nc" id="L1905">                    kit.foundLink = false;</span>
                    // TODO: The AccessibleContext for the editor should register
                    // as a listener for CaretEvents and forward the events to
                    // assistive technologies listening for such events.
<span class="nc" id="L1909">                    comp.getAccessibleContext().firePropertyChange(</span>
                        AccessibleContext.ACCESSIBLE_HYPERTEXT_OFFSET,
<span class="nc" id="L1911">                        Integer.valueOf(kit.prevHypertextOffset),</span>
<span class="nc" id="L1912">                        Integer.valueOf(e.getDot()));</span>
                }
            }
<span class="nc" id="L1915">        }</span>

        /*
         * The operation to perform when this action is triggered.
         */
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1921">            JTextComponent comp = getTextComponent(e);</span>
<span class="nc bnc" id="L1922" title="All 4 branches missed.">            if (comp == null || comp.isEditable()) {</span>
<span class="nc" id="L1923">                return;</span>
            }

<span class="nc" id="L1926">            Document doc = comp.getDocument();</span>
<span class="nc" id="L1927">            HTMLEditorKit kit = getHTMLEditorKit(comp);</span>
<span class="nc bnc" id="L1928" title="All 4 branches missed.">            if (doc == null || kit == null) {</span>
<span class="nc" id="L1929">                return;</span>
            }

            // TODO: Should start successive iterations from the
            // current caret position.
<span class="nc" id="L1934">            ElementIterator ei = new ElementIterator(doc);</span>
<span class="nc" id="L1935">            int currentOffset = comp.getCaretPosition();</span>
<span class="nc" id="L1936">            int prevStartOffset = -1;</span>
<span class="nc" id="L1937">            int prevEndOffset = -1;</span>

            // highlight the next link or object after the current caret position
            Element nextElement;
<span class="nc bnc" id="L1941" title="All 2 branches missed.">            while ((nextElement = ei.next()) != null) {</span>
<span class="nc" id="L1942">                String name = nextElement.getName();</span>
<span class="nc" id="L1943">                AttributeSet attr = nextElement.getAttributes();</span>

<span class="nc" id="L1945">                Object href = getAttrValue(attr, HTML.Attribute.HREF);</span>
<span class="nc bnc" id="L1946" title="All 4 branches missed.">                if (!(name.equals(HTML.Tag.OBJECT.toString())) &amp;&amp; href == null) {</span>
<span class="nc" id="L1947">                    continue;</span>
                }

<span class="nc" id="L1950">                int elementOffset = nextElement.getStartOffset();</span>
<span class="nc bnc" id="L1951" title="All 2 branches missed.">                if (focusBack) {</span>
<span class="nc bnc" id="L1952" title="All 4 branches missed.">                    if (elementOffset &gt;= currentOffset &amp;&amp;</span>
                        prevStartOffset &gt;= 0) {

<span class="nc" id="L1955">                        kit.foundLink = true;</span>
<span class="nc" id="L1956">                        comp.setCaretPosition(prevStartOffset);</span>
<span class="nc" id="L1957">                        moveCaretPosition(comp, kit, prevStartOffset,</span>
                                          prevEndOffset);
<span class="nc" id="L1959">                        kit.prevHypertextOffset = prevStartOffset;</span>
<span class="nc" id="L1960">                        return;</span>
                    }
                } else { // focus forward
<span class="nc bnc" id="L1963" title="All 2 branches missed.">                    if (elementOffset &gt; currentOffset) {</span>

<span class="nc" id="L1965">                        kit.foundLink = true;</span>
<span class="nc" id="L1966">                        comp.setCaretPosition(elementOffset);</span>
<span class="nc" id="L1967">                        moveCaretPosition(comp, kit, elementOffset,</span>
<span class="nc" id="L1968">                                          nextElement.getEndOffset());</span>
<span class="nc" id="L1969">                        kit.prevHypertextOffset = elementOffset;</span>
<span class="nc" id="L1970">                        return;</span>
                    }
                }
<span class="nc" id="L1973">                prevStartOffset = nextElement.getStartOffset();</span>
<span class="nc" id="L1974">                prevEndOffset = nextElement.getEndOffset();</span>
<span class="nc" id="L1975">            }</span>
<span class="nc bnc" id="L1976" title="All 4 branches missed.">            if (focusBack &amp;&amp; prevStartOffset &gt;= 0) {</span>
<span class="nc" id="L1977">                kit.foundLink = true;</span>
<span class="nc" id="L1978">                comp.setCaretPosition(prevStartOffset);</span>
<span class="nc" id="L1979">                moveCaretPosition(comp, kit, prevStartOffset, prevEndOffset);</span>
<span class="nc" id="L1980">                kit.prevHypertextOffset = prevStartOffset;</span>
            }
<span class="nc" id="L1982">        }</span>

        /*
         * Moves the caret from mark to dot
         */
        private void moveCaretPosition(JTextComponent comp, HTMLEditorKit kit,
                                       int mark, int dot) {
<span class="nc" id="L1989">            Highlighter h = comp.getHighlighter();</span>
<span class="nc bnc" id="L1990" title="All 2 branches missed.">            if (h != null) {</span>
<span class="nc" id="L1991">                int p0 = Math.min(dot, mark);</span>
<span class="nc" id="L1992">                int p1 = Math.max(dot, mark);</span>
                try {
<span class="nc bnc" id="L1994" title="All 2 branches missed.">                    if (kit.linkNavigationTag != null) {</span>
<span class="nc" id="L1995">                        h.changeHighlight(kit.linkNavigationTag, p0, p1);</span>
                    } else {
<span class="nc" id="L1997">                        kit.linkNavigationTag =</span>
<span class="nc" id="L1998">                                h.addHighlight(p0, p1, focusPainter);</span>
                    }
<span class="nc" id="L2000">                } catch (BadLocationException e) {</span>
<span class="nc" id="L2001">                }</span>
            }
<span class="nc" id="L2003">        }</span>

        private HTMLEditorKit getHTMLEditorKit(JTextComponent comp) {
<span class="nc bnc" id="L2006" title="All 2 branches missed.">            if (comp instanceof JEditorPane) {</span>
<span class="nc" id="L2007">                EditorKit kit = ((JEditorPane) comp).getEditorKit();</span>
<span class="nc bnc" id="L2008" title="All 2 branches missed.">                if (kit instanceof HTMLEditorKit) {</span>
<span class="nc" id="L2009">                    return (HTMLEditorKit) kit;</span>
                }
            }
<span class="nc" id="L2012">            return null;</span>
        }

        /**
         * A highlight painter that draws a one-pixel border around
         * the highlighted area.
         */
        static class FocusHighlightPainter extends
            DefaultHighlighter.DefaultHighlightPainter {

            FocusHighlightPainter(Color color) {
<span class="nc" id="L2023">                super(color);</span>
<span class="nc" id="L2024">            }</span>

            /**
             * Paints a portion of a highlight.
             *
             * @param g the graphics context
             * @param offs0 the starting model offset &gt;= 0
             * @param offs1 the ending model offset &gt;= offs1
             * @param bounds the bounding box of the view, which is not
             *        necessarily the region to paint.
             * @param c the editor
             * @param view View painting for
             * @return region in which drawing occurred
             */
            public Shape paintLayer(Graphics g, int offs0, int offs1,
                                    Shape bounds, JTextComponent c, View view) {

<span class="nc" id="L2041">                Color color = getColor();</span>

<span class="nc bnc" id="L2043" title="All 2 branches missed.">                if (color == null) {</span>
<span class="nc" id="L2044">                    g.setColor(c.getSelectionColor());</span>
                }
                else {
<span class="nc" id="L2047">                    g.setColor(color);</span>
                }
<span class="nc bnc" id="L2049" title="All 2 branches missed.">                if (offs0 == view.getStartOffset() &amp;&amp;</span>
<span class="nc bnc" id="L2050" title="All 2 branches missed.">                    offs1 == view.getEndOffset()) {</span>
                    // Contained in view, can just use bounds.
                    Rectangle alloc;
<span class="nc bnc" id="L2053" title="All 2 branches missed.">                    if (bounds instanceof Rectangle) {</span>
<span class="nc" id="L2054">                        alloc = (Rectangle)bounds;</span>
                    }
                    else {
<span class="nc" id="L2057">                        alloc = bounds.getBounds();</span>
                    }
<span class="nc" id="L2059">                    g.drawRect(alloc.x, alloc.y, alloc.width - 1, alloc.height);</span>
<span class="nc" id="L2060">                    return alloc;</span>
                }
                else {
                    // Should only render part of View.
                    try {
                        // --- determine locations ---
<span class="nc" id="L2066">                        Shape shape = view.modelToView(offs0, Position.Bias.Forward,</span>
                                                       offs1,Position.Bias.Backward,
                                                       bounds);
<span class="nc bnc" id="L2069" title="All 2 branches missed.">                        Rectangle r = (shape instanceof Rectangle) ?</span>
<span class="nc" id="L2070">                            (Rectangle)shape : shape.getBounds();</span>
<span class="nc" id="L2071">                        g.drawRect(r.x, r.y, r.width - 1, r.height);</span>
<span class="nc" id="L2072">                        return r;</span>
<span class="nc" id="L2073">                    } catch (BadLocationException e) {</span>
                        // can't render
                    }
                }
                // Only if exception
<span class="nc" id="L2078">                return null;</span>
            }
        }
    }

    /*
     * Action to activate the hypertext link that has focus.
     * TODO: This method relies on support from the
     * javax.accessibility package.  The text package should support
     * keyboard navigation of text elements directly.
     */
    static class ActivateLinkAction extends TextAction {

        /**
         * Create this action with the appropriate identifier.
         */
        public ActivateLinkAction(String actionName) {
<span class="nc" id="L2095">            super(actionName);</span>
<span class="nc" id="L2096">        }</span>

        /*
         * activates the hyperlink at offset
         */
        private void activateLink(String href, HTMLDocument doc,
                                  JEditorPane editor, int offset) {
            try {
<span class="nc" id="L2104">                URL page =</span>
<span class="nc" id="L2105">                    (URL)doc.getProperty(Document.StreamDescriptionProperty);</span>
<span class="nc" id="L2106">                URL url = new URL(page, href);</span>
<span class="nc" id="L2107">                HyperlinkEvent linkEvent = new HyperlinkEvent</span>
                    (editor, HyperlinkEvent.EventType.
<span class="nc" id="L2109">                     ACTIVATED, url, url.toExternalForm(),</span>
<span class="nc" id="L2110">                     doc.getCharacterElement(offset));</span>
<span class="nc" id="L2111">                editor.fireHyperlinkUpdate(linkEvent);</span>
<span class="nc" id="L2112">            } catch (MalformedURLException m) {</span>
<span class="nc" id="L2113">            }</span>
<span class="nc" id="L2114">        }</span>

        /*
         * Invokes default action on the object in an element
         */
        private void doObjectAction(JEditorPane editor, Element elem) {
<span class="nc" id="L2120">            View view = getView(editor, elem);</span>
<span class="nc bnc" id="L2121" title="All 4 branches missed.">            if (view != null &amp;&amp; view instanceof ObjectView) {</span>
<span class="nc" id="L2122">                Component comp = ((ObjectView)view).getComponent();</span>
<span class="nc bnc" id="L2123" title="All 4 branches missed.">                if (comp != null &amp;&amp; comp instanceof Accessible) {</span>
<span class="nc" id="L2124">                    AccessibleContext ac = comp.getAccessibleContext();</span>
<span class="nc bnc" id="L2125" title="All 2 branches missed.">                    if (ac != null) {</span>
<span class="nc" id="L2126">                        AccessibleAction aa = ac.getAccessibleAction();</span>
<span class="nc bnc" id="L2127" title="All 2 branches missed.">                        if (aa != null) {</span>
<span class="nc" id="L2128">                            aa.doAccessibleAction(0);</span>
                        }
                    }
                }
            }
<span class="nc" id="L2133">        }</span>

        /*
         * Returns the root view for a document
         */
        private View getRootView(JEditorPane editor) {
<span class="nc" id="L2139">            return editor.getUI().getRootView(editor);</span>
        }

        /*
         * Returns a view associated with an element
         */
        private View getView(JEditorPane editor, Element elem) {
<span class="nc" id="L2146">            Object lock = lock(editor);</span>
            try {
<span class="nc" id="L2148">                View rootView = getRootView(editor);</span>
<span class="nc" id="L2149">                int start = elem.getStartOffset();</span>
<span class="nc bnc" id="L2150" title="All 2 branches missed.">                if (rootView != null) {</span>
<span class="nc" id="L2151">                    return getView(rootView, elem, start);</span>
                }
<span class="nc" id="L2153">                return null;</span>
            } finally {
<span class="nc" id="L2155">                unlock(lock);</span>
            }
        }

        private View getView(View parent, Element elem, int start) {
<span class="nc bnc" id="L2160" title="All 2 branches missed.">            if (parent.getElement() == elem) {</span>
<span class="nc" id="L2161">                return parent;</span>
            }
<span class="nc" id="L2163">            int index = parent.getViewIndex(start, Position.Bias.Forward);</span>

<span class="nc bnc" id="L2165" title="All 4 branches missed.">            if (index != -1 &amp;&amp; index &lt; parent.getViewCount()) {</span>
<span class="nc" id="L2166">                return getView(parent.getView(index), elem, start);</span>
            }
<span class="nc" id="L2168">            return null;</span>
        }

        /*
         * If possible acquires a lock on the Document.  If a lock has been
         * obtained a key will be retured that should be passed to
         * &lt;code&gt;unlock&lt;/code&gt;.
         */
        private Object lock(JEditorPane editor) {
<span class="nc" id="L2177">            Document document = editor.getDocument();</span>

<span class="nc bnc" id="L2179" title="All 2 branches missed.">            if (document instanceof AbstractDocument) {</span>
<span class="nc" id="L2180">                ((AbstractDocument)document).readLock();</span>
<span class="nc" id="L2181">                return document;</span>
            }
<span class="nc" id="L2183">            return null;</span>
        }

        /*
         * Releases a lock previously obtained via &lt;code&gt;lock&lt;/code&gt;.
         */
        private void unlock(Object key) {
<span class="nc bnc" id="L2190" title="All 2 branches missed.">            if (key != null) {</span>
<span class="nc" id="L2191">                ((AbstractDocument)key).readUnlock();</span>
            }
<span class="nc" id="L2193">        }</span>

        /*
         * The operation to perform when this action is triggered.
         */
        public void actionPerformed(ActionEvent e) {

<span class="nc" id="L2200">            JTextComponent c = getTextComponent(e);</span>
<span class="nc bnc" id="L2201" title="All 4 branches missed.">            if (c.isEditable() || !(c instanceof JEditorPane)) {</span>
<span class="nc" id="L2202">                return;</span>
            }
<span class="nc" id="L2204">            JEditorPane editor = (JEditorPane)c;</span>

<span class="nc" id="L2206">            Document d = editor.getDocument();</span>
<span class="nc bnc" id="L2207" title="All 4 branches missed.">            if (d == null || !(d instanceof HTMLDocument)) {</span>
<span class="nc" id="L2208">                return;</span>
            }
<span class="nc" id="L2210">            HTMLDocument doc = (HTMLDocument)d;</span>

<span class="nc" id="L2212">            ElementIterator ei = new ElementIterator(doc);</span>
<span class="nc" id="L2213">            int currentOffset = editor.getCaretPosition();</span>

            // invoke the next link or object action
<span class="nc" id="L2216">            String urlString = null;</span>
<span class="nc" id="L2217">            String objString = null;</span>
            Element currentElement;
<span class="nc bnc" id="L2219" title="All 2 branches missed.">            while ((currentElement = ei.next()) != null) {</span>
<span class="nc" id="L2220">                String name = currentElement.getName();</span>
<span class="nc" id="L2221">                AttributeSet attr = currentElement.getAttributes();</span>

<span class="nc" id="L2223">                Object href = getAttrValue(attr, HTML.Attribute.HREF);</span>
<span class="nc bnc" id="L2224" title="All 2 branches missed.">                if (href != null) {</span>
<span class="nc bnc" id="L2225" title="All 2 branches missed.">                    if (currentOffset &gt;= currentElement.getStartOffset() &amp;&amp;</span>
<span class="nc bnc" id="L2226" title="All 2 branches missed.">                        currentOffset &lt;= currentElement.getEndOffset()) {</span>

<span class="nc" id="L2228">                        activateLink((String)href, doc, editor, currentOffset);</span>
<span class="nc" id="L2229">                        return;</span>
                    }
<span class="nc bnc" id="L2231" title="All 2 branches missed.">                } else if (name.equals(HTML.Tag.OBJECT.toString())) {</span>
<span class="nc" id="L2232">                    Object obj = getAttrValue(attr, HTML.Attribute.CLASSID);</span>
<span class="nc bnc" id="L2233" title="All 2 branches missed.">                    if (obj != null) {</span>
<span class="nc bnc" id="L2234" title="All 2 branches missed.">                        if (currentOffset &gt;= currentElement.getStartOffset() &amp;&amp;</span>
<span class="nc bnc" id="L2235" title="All 2 branches missed.">                            currentOffset &lt;= currentElement.getEndOffset()) {</span>

<span class="nc" id="L2237">                            doObjectAction(editor, currentElement);</span>
<span class="nc" id="L2238">                            return;</span>
                        }
                    }
                }
<span class="nc" id="L2242">            }</span>
<span class="nc" id="L2243">        }</span>
    }

    private static int getBodyElementStart(JTextComponent comp) {
<span class="nc" id="L2247">        Element rootElement = comp.getDocument().getRootElements()[0];</span>
<span class="nc bnc" id="L2248" title="All 2 branches missed.">        for (int i = 0; i &lt; rootElement.getElementCount(); i++) {</span>
<span class="nc" id="L2249">            Element currElement = rootElement.getElement(i);</span>
<span class="nc bnc" id="L2250" title="All 2 branches missed.">            if(&quot;body&quot;.equals(currElement.getName())) {</span>
<span class="nc" id="L2251">                return currElement.getStartOffset();</span>
            }
        }
<span class="nc" id="L2254">        return 0;</span>
    }

    /*
     * Move the caret to the beginning of the document.
     * @see DefaultEditorKit#beginAction
     * @see HTMLEditorKit#getActions
     */

    static class BeginAction extends TextAction {

        /* Create this object with the appropriate identifier. */
        BeginAction(String nm, boolean select) {
<span class="nc" id="L2267">            super(nm);</span>
<span class="nc" id="L2268">            this.select = select;</span>
<span class="nc" id="L2269">        }</span>

        /** The operation to perform when this action is triggered. */
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L2273">            JTextComponent target = getTextComponent(e);</span>
<span class="nc" id="L2274">            int bodyStart = getBodyElementStart(target);</span>

<span class="nc bnc" id="L2276" title="All 2 branches missed.">            if (target != null) {</span>
<span class="nc bnc" id="L2277" title="All 2 branches missed.">                if (select) {</span>
<span class="nc" id="L2278">                    target.moveCaretPosition(bodyStart);</span>
                } else {
<span class="nc" id="L2280">                    target.setCaretPosition(bodyStart);</span>
                }
            }
<span class="nc" id="L2283">        }</span>

        private boolean select;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>