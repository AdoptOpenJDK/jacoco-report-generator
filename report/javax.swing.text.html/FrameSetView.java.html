<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FrameSetView.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.text.html</a> &gt; <span class="el_source">FrameSetView.java</span></div><h1>FrameSetView.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1998, 2003, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package javax.swing.text.html;

import java.awt.*;
import java.util.*;
import javax.swing.*;
import javax.swing.text.*;
import javax.swing.event.*;

/**
 * Implements a FrameSetView, intended to support the HTML
 * &amp;lt;FRAMESET&amp;gt; tag.  Supports the ROWS and COLS attributes.
 *
 * @author  Sunita Mani
 *
 *          Credit also to the hotjava browser engineers that
 *          worked on making the allocation of space algorithms
 *          conform to the HTML 4.0 standard and also be netscape
 *          compatible.
 *
 */

class FrameSetView extends javax.swing.text.BoxView {

    String[] children;
    int[] percentChildren;
    int[] absoluteChildren;
    int[] relativeChildren;
    int percentTotals;
    int absoluteTotals;
    int relativeTotals;

    /**
     * Constructs a FrameSetView for the given element.
     *
     * @param elem the element that this view is responsible for
     */
    public FrameSetView(Element elem, int axis) {
<span class="nc" id="L62">        super(elem, axis);</span>
<span class="nc" id="L63">        children = null;</span>
<span class="nc" id="L64">    }</span>

    /**
     * Parses the ROW or COL attributes and returns
     * an array of strings that represent the space
     * distribution.
     *
     */
    private String[] parseRowColSpec(HTML.Attribute key) {

<span class="nc" id="L74">        AttributeSet attributes = getElement().getAttributes();</span>
<span class="nc" id="L75">        String spec = &quot;*&quot;;</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (attributes != null) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (attributes.getAttribute(key) != null) {</span>
<span class="nc" id="L78">                spec = (String)attributes.getAttribute(key);</span>
            }
        }

<span class="nc" id="L82">        StringTokenizer tokenizer = new StringTokenizer(spec, &quot;,&quot;);</span>
<span class="nc" id="L83">        int nTokens = tokenizer.countTokens();</span>
<span class="nc" id="L84">        int n = getViewCount();</span>
<span class="nc" id="L85">        String[] items = new String[Math.max(nTokens, n)];</span>
<span class="nc" id="L86">        int i = 0;</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        for (; i &lt; nTokens; i++) {</span>
<span class="nc" id="L88">            items[i] = tokenizer.nextToken().trim();</span>
            // As per the spec, 100% is the same as *
            // hence the mapping.
            //
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if (items[i].equals(&quot;100%&quot;)) {</span>
<span class="nc" id="L93">                items[i] = &quot;*&quot;;</span>
            }
        }
        // extend spec if we have more children than specified
        // in ROWS or COLS attribute
<span class="nc bnc" id="L98" title="All 2 branches missed.">        for (; i &lt; items.length; i++) {</span>
<span class="nc" id="L99">            items[i] = &quot;*&quot;;</span>
        }
<span class="nc" id="L101">        return items;</span>
    }


    /**
     * Initializes a number of internal state variables
     * that store information about space allocation
     * for the frames contained within the frameset.
     */
    private void init() {
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (getAxis() == View.Y_AXIS) {</span>
<span class="nc" id="L112">            children = parseRowColSpec(HTML.Attribute.ROWS);</span>
        } else {
<span class="nc" id="L114">            children = parseRowColSpec(HTML.Attribute.COLS);</span>
        }
<span class="nc" id="L116">        percentChildren = new int[children.length];</span>
<span class="nc" id="L117">        relativeChildren = new int[children.length];</span>
<span class="nc" id="L118">        absoluteChildren = new int[children.length];</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        for (int i = 0; i &lt; children.length; i++) {</span>
<span class="nc" id="L121">            percentChildren[i] = -1;</span>
<span class="nc" id="L122">            relativeChildren[i] = -1;</span>
<span class="nc" id="L123">            absoluteChildren[i] = -1;</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (children[i].endsWith(&quot;*&quot;)) {</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                if (children[i].length() &gt; 1) {</span>
<span class="nc" id="L127">                    relativeChildren[i] =</span>
<span class="nc" id="L128">                        Integer.parseInt(children[i].substring(</span>
<span class="nc" id="L129">                            0, children[i].length()-1));</span>
<span class="nc" id="L130">                    relativeTotals += relativeChildren[i];</span>
                } else {
<span class="nc" id="L132">                    relativeChildren[i] = 1;</span>
<span class="nc" id="L133">                    relativeTotals += 1;</span>
                }
<span class="nc bnc" id="L135" title="All 2 branches missed.">            } else if (children[i].indexOf('%') != -1) {</span>
<span class="nc" id="L136">                percentChildren[i] = parseDigits(children[i]);</span>
<span class="nc" id="L137">                percentTotals += percentChildren[i];</span>
            } else {
<span class="nc" id="L139">                absoluteChildren[i] = Integer.parseInt(children[i]);</span>
            }
        }
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (percentTotals &gt; 100) {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            for (int i = 0; i &lt; percentChildren.length; i++) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                if (percentChildren[i] &gt; 0) {</span>
<span class="nc" id="L145">                    percentChildren[i] =</span>
                        (percentChildren[i] * 100) / percentTotals;
                }
            }
<span class="nc" id="L149">            percentTotals = 100;</span>
        }
<span class="nc" id="L151">    }</span>

    /**
     * Perform layout for the major axis of the box (i.e. the
     * axis that it represents).  The results of the layout should
     * be placed in the given arrays which represent the allocations
     * to the children along the major axis.
     *
     * @param targetSpan the total span given to the view, which
     *  would be used to layout the children
     * @param axis the axis being layed out
     * @param offsets the offsets from the origin of the view for
     *  each of the child views; this is a return value and is
     *  filled in by the implementation of this method
     * @param spans the span of each child view; this is a return
     *  value and is filled in by the implementation of this method
     * @return the offset and span for each child view in the
     *  offsets and spans parameters
     */
    protected void layoutMajorAxis(int targetSpan, int axis, int[] offsets,
                                   int[] spans) {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (children == null) {</span>
<span class="nc" id="L173">            init();</span>
        }
<span class="nc" id="L175">        SizeRequirements.calculateTiledPositions(targetSpan, null,</span>
<span class="nc" id="L176">                                                 getChildRequests(targetSpan,</span>
                                                                  axis),
                                                 offsets, spans);
<span class="nc" id="L179">    }</span>

    protected SizeRequirements[] getChildRequests(int targetSpan, int axis) {

<span class="nc" id="L183">        int span[] = new int[children.length];</span>

<span class="nc" id="L185">        spread(targetSpan, span);</span>
<span class="nc" id="L186">        int n = getViewCount();</span>
<span class="nc" id="L187">        SizeRequirements[] reqs = new SizeRequirements[n];</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">        for (int i = 0, sIndex = 0; i &lt; n; i++) {</span>
<span class="nc" id="L189">            View v = getView(i);</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">            if ((v instanceof FrameView) || (v instanceof FrameSetView)) {</span>
<span class="nc" id="L191">                reqs[i] = new SizeRequirements((int) v.getMinimumSpan(axis),</span>
                                               span[sIndex],
<span class="nc" id="L193">                                               (int) v.getMaximumSpan(axis),</span>
                                               0.5f);
<span class="nc" id="L195">                sIndex++;</span>
            } else {
<span class="nc" id="L197">                int min = (int) v.getMinimumSpan(axis);</span>
<span class="nc" id="L198">                int pref = (int) v.getPreferredSpan(axis);</span>
<span class="nc" id="L199">                int max = (int) v.getMaximumSpan(axis);</span>
<span class="nc" id="L200">                float a = v.getAlignment(axis);</span>
<span class="nc" id="L201">                reqs[i] = new SizeRequirements(min, pref, max, a);</span>
            }
        }
<span class="nc" id="L204">        return reqs;</span>
    }


    /**
     * This method is responsible for returning in span[] the
     * span for each child view along the major axis.  it
     * computes this based on the information that extracted
     * from the value of the ROW/COL attribute.
     */
    private void spread(int targetSpan, int span[]) {

<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (targetSpan == 0) {</span>
<span class="nc" id="L217">            return;</span>
        }

<span class="nc" id="L220">        int tempSpace = 0;</span>
<span class="nc" id="L221">        int remainingSpace = targetSpan;</span>

        // allocate the absolute's first, they have
        // precedence
        //
<span class="nc bnc" id="L226" title="All 2 branches missed.">        for (int i = 0; i &lt; span.length; i++) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (absoluteChildren[i] &gt; 0) {</span>
<span class="nc" id="L228">                span[i] = absoluteChildren[i];</span>
<span class="nc" id="L229">                remainingSpace -= span[i];</span>
            }
        }

        // then deal with percents.
        //
<span class="nc" id="L235">        tempSpace = remainingSpace;</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">        for (int i = 0; i &lt; span.length; i++) {</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">            if (percentChildren[i] &gt; 0 &amp;&amp; tempSpace &gt; 0) {</span>
<span class="nc" id="L238">                span[i] = (percentChildren[i] * tempSpace) / 100;</span>
<span class="nc" id="L239">                remainingSpace -= span[i];</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">            } else if (percentChildren[i] &gt; 0 &amp;&amp; tempSpace &lt;= 0) {</span>
<span class="nc" id="L241">                span[i] = targetSpan / span.length;</span>
<span class="nc" id="L242">                remainingSpace -= span[i];</span>
            }
        }

        // allocate remainingSpace to relative
<span class="nc bnc" id="L247" title="All 4 branches missed.">        if (remainingSpace &gt; 0 &amp;&amp; relativeTotals &gt; 0) {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            for (int i = 0; i &lt; span.length; i++) {</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (relativeChildren[i] &gt; 0) {</span>
<span class="nc" id="L250">                    span[i] = (remainingSpace *</span>
                                relativeChildren[i]) / relativeTotals;
                }
            }
<span class="nc bnc" id="L254" title="All 2 branches missed.">        } else if (remainingSpace &gt; 0) {</span>
            // There are no relative columns and the space has been
            // under- or overallocated.  In this case, turn all the
            // percentage and pixel specified columns to percentage
            // columns based on the ratio of their pixel count to the
            // total &quot;virtual&quot; size. (In the case of percentage columns,
            // the pixel count would equal the specified percentage
            // of the screen size.

            // This action is in accordance with the HTML
            // 4.0 spec (see section 8.3, the end of the discussion of
            // the FRAMESET tag).  The precedence of percentage and pixel
            // specified columns is unclear (spec seems to indicate that
            // they share priority, however, unspecified what happens when
            // overallocation occurs.)

            // addendum is that we behave similar to netscape in that specified
            // widths have precedance over percentage widths...

<span class="nc" id="L273">            float vTotal = (float)(targetSpan - remainingSpace);</span>
<span class="nc" id="L274">            float[] tempPercents = new float[span.length];</span>
<span class="nc" id="L275">            remainingSpace = targetSpan;</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            for (int i = 0; i &lt; span.length; i++) {</span>
                // ok we know what our total space is, and we know how large each
                // column should be relative to each other... therefore we can use
                // that relative information to deduce their percentages of a whole
                // and then scale them appropriately for the correct size
<span class="nc" id="L281">                tempPercents[i] = ((float)span[i] / vTotal) * 100.00f;</span>
<span class="nc" id="L282">                span[i] = (int) ( ((float)targetSpan * tempPercents[i]) / 100.00f);</span>
<span class="nc" id="L283">                remainingSpace -= span[i];</span>
            }


            // this is for just in case there is something left over.. if there is we just
            // add it one pixel at a time to the frames in order.. We shouldn't really ever get
            // here and if we do it shouldn't be with more than 1 pixel, maybe two.
<span class="nc" id="L290">            int i = 0;</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            while (remainingSpace != 0) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                if (remainingSpace &lt; 0) {</span>
<span class="nc" id="L293">                    span[i++]--;</span>
<span class="nc" id="L294">                    remainingSpace++;</span>
                }
                else {
<span class="nc" id="L297">                    span[i++]++;</span>
<span class="nc" id="L298">                    remainingSpace--;</span>
                }

                // just in case there are more pixels than frames...should never happen..
<span class="nc bnc" id="L302" title="All 2 branches missed.">                if (i == span.length)i = 0;</span>
            }
        }
<span class="nc" id="L305">    }</span>

    /*
     * Users have been known to type things like &quot;%25&quot; and &quot;25 %&quot;.  Deal
     * with it.
     */
    private int parseDigits(String mixedStr) {
<span class="nc" id="L312">        int result = 0;</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        for (int i = 0; i &lt; mixedStr.length(); i++) {</span>
<span class="nc" id="L314">            char ch = mixedStr.charAt(i);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            if (Character.isDigit(ch)) {</span>
<span class="nc" id="L316">                result = (result * 10) + Character.digit(ch, 10);</span>
            }
        }
<span class="nc" id="L319">        return result;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>