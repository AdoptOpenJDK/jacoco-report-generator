<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ImageView.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.text.html</a> &gt; <span class="el_source">ImageView.java</span></div><h1>ImageView.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2005, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package javax.swing.text.html;

import java.awt.*;
import java.awt.image.ImageObserver;
import java.net.*;
import java.util.Dictionary;
import javax.swing.*;
import javax.swing.text.*;
import javax.swing.event.*;

/**
 * View of an Image, intended to support the HTML &amp;lt;IMG&amp;gt; tag.
 * Supports scaling via the HEIGHT and WIDTH attributes of the tag.
 * If the image is unable to be loaded any text specified via the
 * &lt;code&gt;ALT&lt;/code&gt; attribute will be rendered.
 * &lt;p&gt;
 * While this class has been part of swing for a while now, it is public
 * as of 1.4.
 *
 * @author  Scott Violet
 * @see IconView
 * @since 1.4
 */
public class ImageView extends View {
    /**
     * If true, when some of the bits are available a repaint is done.
     * &lt;p&gt;
     * This is set to false as swing does not offer a repaint that takes a
     * delay. If this were true, a bunch of immediate repaints would get
     * generated that end up significantly delaying the loading of the image
     * (or anything else going on for that matter).
     */
<span class="nc" id="L57">    private static boolean sIsInc = false;</span>
    /**
     * Repaint delay when some of the bits are available.
     */
<span class="nc" id="L61">    private static int sIncRate = 100;</span>
    /**
     * Property name for pending image icon
     */
    private static final String PENDING_IMAGE = &quot;html.pendingImage&quot;;
    /**
     * Property name for missing image icon
     */
    private static final String MISSING_IMAGE = &quot;html.missingImage&quot;;

    /**
     * Document property for image cache.
     */
    private static final String IMAGE_CACHE_PROPERTY = &quot;imageCache&quot;;

    // Height/width to use before we know the real size, these should at least
    // the size of &lt;code&gt;sMissingImageIcon&lt;/code&gt; and
    // &lt;code&gt;sPendingImageIcon&lt;/code&gt;
    private static final int DEFAULT_WIDTH = 38;
    private static final int DEFAULT_HEIGHT= 38;

    /**
     * Default border to use if one is not specified.
     */
    private static final int DEFAULT_BORDER = 2;

    // Bitmask values
    private static final int LOADING_FLAG = 1;
    private static final int LINK_FLAG = 2;
    private static final int WIDTH_FLAG = 4;
    private static final int HEIGHT_FLAG = 8;
    private static final int RELOAD_FLAG = 16;
    private static final int RELOAD_IMAGE_FLAG = 32;
    private static final int SYNC_LOAD_FLAG = 64;

    private AttributeSet attr;
    private Image image;
    private Image disabledImage;
    private int width;
    private int height;
    /** Bitmask containing some of the above bitmask values. Because the
     * image loading notification can happen on another thread access to
     * this is synchronized (at least for modifying it). */
    private int state;
    private Container container;
    private Rectangle fBounds;
    private Color borderColor;
    // Size of the border, the insets contains this valid. For example, if
    // the HSPACE attribute was 4 and BORDER 2, leftInset would be 6.
    private short borderSize;
    // Insets, obtained from the painter.
    private short leftInset;
    private short rightInset;
    private short topInset;
    private short bottomInset;
    /**
     * We don't directly implement ImageObserver, instead we use an instance
     * that calls back to us.
     */
    private ImageObserver imageObserver;
    /**
     * Used for alt text. Will be non-null if the image couldn't be found,
     * and there is valid alt text.
     */
    private View altView;
    /** Alignment along the vertical (Y) axis. */
    private float vAlign;



    /**
     * Creates a new view that represents an IMG element.
     *
     * @param elem the element to create a view for
     */
    public ImageView(Element elem) {
<span class="nc" id="L137">        super(elem);</span>
<span class="nc" id="L138">        fBounds = new Rectangle();</span>
<span class="nc" id="L139">        imageObserver = new ImageHandler();</span>
<span class="nc" id="L140">        state = RELOAD_FLAG | RELOAD_IMAGE_FLAG;</span>
<span class="nc" id="L141">    }</span>

    /**
     * Returns the text to display if the image can't be loaded. This is
     * obtained from the Elements attribute set with the attribute name
     * &lt;code&gt;HTML.Attribute.ALT&lt;/code&gt;.
     */
    public String getAltText() {
<span class="nc" id="L149">        return (String)getElement().getAttributes().getAttribute</span>
<span class="nc" id="L150">            (HTML.Attribute.ALT);</span>
    }

    /**
     * Return a URL for the image source,
     * or null if it could not be determined.
     */
    public URL getImageURL() {
<span class="nc" id="L158">        String src = (String)getElement().getAttributes().</span>
<span class="nc" id="L159">                             getAttribute(HTML.Attribute.SRC);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (src == null) {</span>
<span class="nc" id="L161">            return null;</span>
        }

<span class="nc" id="L164">        URL reference = ((HTMLDocument)getDocument()).getBase();</span>
        try {
<span class="nc" id="L166">            URL u = new URL(reference,src);</span>
<span class="nc" id="L167">            return u;</span>
<span class="nc" id="L168">        } catch (MalformedURLException e) {</span>
<span class="nc" id="L169">            return null;</span>
        }
    }

    /**
     * Returns the icon to use if the image couldn't be found.
     */
    public Icon getNoImageIcon() {
<span class="nc" id="L177">        return (Icon) UIManager.getLookAndFeelDefaults().get(MISSING_IMAGE);</span>
    }

    /**
     * Returns the icon to use while in the process of loading the image.
     */
    public Icon getLoadingImageIcon() {
<span class="nc" id="L184">        return (Icon) UIManager.getLookAndFeelDefaults().get(PENDING_IMAGE);</span>
    }

    /**
     * Returns the image to render.
     */
    public Image getImage() {
<span class="nc" id="L191">        sync();</span>
<span class="nc" id="L192">        return image;</span>
    }

    private Image getImage(boolean enabled) {
<span class="nc" id="L196">        Image img = getImage();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (! enabled) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (disabledImage == null) {</span>
<span class="nc" id="L199">                disabledImage = GrayFilter.createDisabledImage(img);</span>
            }
<span class="nc" id="L201">            img = disabledImage;</span>
        }
<span class="nc" id="L203">        return img;</span>
    }

    /**
     * Sets how the image is loaded. If &lt;code&gt;newValue&lt;/code&gt; is true,
     * the image we be loaded when first asked for, otherwise it will
     * be loaded asynchronously. The default is to not load synchronously,
     * that is to load the image asynchronously.
     */
    public void setLoadsSynchronously(boolean newValue) {
<span class="nc" id="L213">        synchronized(this) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (newValue) {</span>
<span class="nc" id="L215">                state |= SYNC_LOAD_FLAG;</span>
            }
            else {
<span class="nc" id="L218">                state = (state | SYNC_LOAD_FLAG) ^ SYNC_LOAD_FLAG;</span>
            }
<span class="nc" id="L220">        }</span>
<span class="nc" id="L221">    }</span>

    /**
     * Returns true if the image should be loaded when first asked for.
     */
    public boolean getLoadsSynchronously() {
<span class="nc bnc" id="L227" title="All 2 branches missed.">        return ((state &amp; SYNC_LOAD_FLAG) != 0);</span>
    }

    /**
     * Convenience method to get the StyleSheet.
     */
    protected StyleSheet getStyleSheet() {
<span class="nc" id="L234">        HTMLDocument doc = (HTMLDocument) getDocument();</span>
<span class="nc" id="L235">        return doc.getStyleSheet();</span>
    }

    /**
     * Fetches the attributes to use when rendering.  This is
     * implemented to multiplex the attributes specified in the
     * model with a StyleSheet.
     */
    public AttributeSet getAttributes() {
<span class="nc" id="L244">        sync();</span>
<span class="nc" id="L245">        return attr;</span>
    }

    /**
     * For images the tooltip text comes from text specified with the
     * &lt;code&gt;ALT&lt;/code&gt; attribute. This is overriden to return
     * &lt;code&gt;getAltText&lt;/code&gt;.
     *
     * @see JTextComponent#getToolTipText
     */
    public String getToolTipText(float x, float y, Shape allocation) {
<span class="nc" id="L256">        return getAltText();</span>
    }

    /**
     * Update any cached values that come from attributes.
     */
    protected void setPropertiesFromAttributes() {
<span class="nc" id="L263">        StyleSheet sheet = getStyleSheet();</span>
<span class="nc" id="L264">        this.attr = sheet.getViewAttributes(this);</span>

        // Gutters
<span class="nc bnc" id="L267" title="All 2 branches missed.">        borderSize = (short)getIntAttr(HTML.Attribute.BORDER, isLink() ?</span>
                                       DEFAULT_BORDER : 0);

<span class="nc" id="L270">        leftInset = rightInset = (short)(getIntAttr(HTML.Attribute.HSPACE,</span>
                                                    0) + borderSize);
<span class="nc" id="L272">        topInset = bottomInset = (short)(getIntAttr(HTML.Attribute.VSPACE,</span>
                                                    0) + borderSize);

<span class="nc" id="L275">        borderColor = ((StyledDocument)getDocument()).getForeground</span>
<span class="nc" id="L276">                      (getAttributes());</span>

<span class="nc" id="L278">        AttributeSet attr = getElement().getAttributes();</span>

        // Alignment.
        // PENDING: This needs to be changed to support the CSS versions
        // when conversion from ALIGN to VERTICAL_ALIGN is complete.
<span class="nc" id="L283">        Object alignment = attr.getAttribute(HTML.Attribute.ALIGN);</span>

<span class="nc" id="L285">        vAlign = 1.0f;</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (alignment != null) {</span>
<span class="nc" id="L287">            alignment = alignment.toString();</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">            if (&quot;top&quot;.equals(alignment)) {</span>
<span class="nc" id="L289">                vAlign = 0f;</span>
            }
<span class="nc bnc" id="L291" title="All 2 branches missed.">            else if (&quot;middle&quot;.equals(alignment)) {</span>
<span class="nc" id="L292">                vAlign = .5f;</span>
            }
        }

<span class="nc" id="L296">        AttributeSet anchorAttr = (AttributeSet)attr.getAttribute(HTML.Tag.A);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (anchorAttr != null &amp;&amp; anchorAttr.isDefined</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">            (HTML.Attribute.HREF)) {</span>
<span class="nc" id="L299">            synchronized(this) {</span>
<span class="nc" id="L300">                state |= LINK_FLAG;</span>
<span class="nc" id="L301">            }</span>
        }
        else {
<span class="nc" id="L304">            synchronized(this) {</span>
<span class="nc" id="L305">                state = (state | LINK_FLAG) ^ LINK_FLAG;</span>
<span class="nc" id="L306">            }</span>
        }
<span class="nc" id="L308">    }</span>

    /**
     * Establishes the parent view for this view.
     * Seize this moment to cache the AWT Container I'm in.
     */
    public void setParent(View parent) {
<span class="nc" id="L315">        View oldParent = getParent();</span>
<span class="nc" id="L316">        super.setParent(parent);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">        container = (parent != null) ? getContainer() : null;</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (oldParent != parent) {</span>
<span class="nc" id="L319">            synchronized(this) {</span>
<span class="nc" id="L320">                state |= RELOAD_FLAG;</span>
<span class="nc" id="L321">            }</span>
        }
<span class="nc" id="L323">    }</span>

    /**
     * Invoked when the Elements attributes have changed. Recreates the image.
     */
    public void changedUpdate(DocumentEvent e, Shape a, ViewFactory f) {
<span class="nc" id="L329">        super.changedUpdate(e,a,f);</span>

<span class="nc" id="L331">        synchronized(this) {</span>
<span class="nc" id="L332">            state |= RELOAD_FLAG | RELOAD_IMAGE_FLAG;</span>
<span class="nc" id="L333">        }</span>

        // Assume the worst.
<span class="nc" id="L336">        preferenceChanged(null, true, true);</span>
<span class="nc" id="L337">    }</span>

    /**
     * Paints the View.
     *
     * @param g the rendering surface to use
     * @param a the allocated region to render into
     * @see View#paint
     */
    public void paint(Graphics g, Shape a) {
<span class="nc" id="L347">        sync();</span>

<span class="nc bnc" id="L349" title="All 2 branches missed.">        Rectangle rect = (a instanceof Rectangle) ? (Rectangle)a :</span>
<span class="nc" id="L350">                         a.getBounds();</span>
<span class="nc" id="L351">        Rectangle clip = g.getClipBounds();</span>

<span class="nc" id="L353">        fBounds.setBounds(rect);</span>
<span class="nc" id="L354">        paintHighlights(g, a);</span>
<span class="nc" id="L355">        paintBorder(g, rect);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (clip != null) {</span>
<span class="nc" id="L357">            g.clipRect(rect.x + leftInset, rect.y + topInset,</span>
                       rect.width - leftInset - rightInset,
                       rect.height - topInset - bottomInset);
        }

<span class="nc" id="L362">        Container host = getContainer();</span>
<span class="nc bnc" id="L363" title="All 4 branches missed.">        Image img = getImage(host == null || host.isEnabled());</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (img != null) {</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (! hasPixels(img)) {</span>
                // No pixels yet, use the default
<span class="nc" id="L367">                Icon icon = getLoadingImageIcon();</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">                if (icon != null) {</span>
<span class="nc" id="L369">                    icon.paintIcon(host, g,</span>
                            rect.x + leftInset, rect.y + topInset);
                }
<span class="nc" id="L372">            }</span>
            else {
                // Draw the image
<span class="nc" id="L375">                g.drawImage(img, rect.x + leftInset, rect.y + topInset,</span>
                            width, height, imageObserver);
            }
        }
        else {
<span class="nc" id="L380">            Icon icon = getNoImageIcon();</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            if (icon != null) {</span>
<span class="nc" id="L382">                icon.paintIcon(host, g,</span>
                        rect.x + leftInset, rect.y + topInset);
            }
<span class="nc" id="L385">            View view = getAltView();</span>
            // Paint the view representing the alt text, if its non-null
<span class="nc bnc" id="L387" title="All 6 branches missed.">            if (view != null &amp;&amp; ((state &amp; WIDTH_FLAG) == 0 ||</span>
                                 width &gt; DEFAULT_WIDTH)) {
                // Assume layout along the y direction
<span class="nc" id="L390">                Rectangle altRect = new Rectangle</span>
                    (rect.x + leftInset + DEFAULT_WIDTH, rect.y + topInset,
                     rect.width - leftInset - rightInset - DEFAULT_WIDTH,
                     rect.height - topInset - bottomInset);

<span class="nc" id="L395">                view.paint(g, altRect);</span>
            }
        }
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (clip != null) {</span>
            // Reset clip.
<span class="nc" id="L400">            g.setClip(clip.x, clip.y, clip.width, clip.height);</span>
        }
<span class="nc" id="L402">    }</span>

    private void paintHighlights(Graphics g, Shape shape) {
<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (container instanceof JTextComponent) {</span>
<span class="nc" id="L406">            JTextComponent tc = (JTextComponent)container;</span>
<span class="nc" id="L407">            Highlighter h = tc.getHighlighter();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">            if (h instanceof LayeredHighlighter) {</span>
<span class="nc" id="L409">                ((LayeredHighlighter)h).paintLayeredHighlights</span>
<span class="nc" id="L410">                    (g, getStartOffset(), getEndOffset(), shape, tc, this);</span>
            }
        }
<span class="nc" id="L413">    }</span>

    private void paintBorder(Graphics g, Rectangle rect) {
<span class="nc" id="L416">        Color color = borderColor;</span>

<span class="nc bnc" id="L418" title="All 6 branches missed.">        if ((borderSize &gt; 0 || image == null) &amp;&amp; color != null) {</span>
<span class="nc" id="L419">            int xOffset = leftInset - borderSize;</span>
<span class="nc" id="L420">            int yOffset = topInset - borderSize;</span>
<span class="nc" id="L421">            g.setColor(color);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">            int n = (image == null) ? 1 : borderSize;</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">            for (int counter = 0; counter &lt; n; counter++) {</span>
<span class="nc" id="L424">                g.drawRect(rect.x + xOffset + counter,</span>
                           rect.y + yOffset + counter,
                           rect.width - counter - counter - xOffset -xOffset-1,
                           rect.height - counter - counter -yOffset-yOffset-1);
            }
        }
<span class="nc" id="L430">    }</span>

    /**
     * Determines the preferred span for this view along an
     * axis.
     *
     * @param axis may be either X_AXIS or Y_AXIS
     * @return   the span the view would like to be rendered into;
     *           typically the view is told to render into the span
     *           that is returned, although there is no guarantee;
     *           the parent may choose to resize or break the view
     */
    public float getPreferredSpan(int axis) {
<span class="nc" id="L443">        sync();</span>

        // If the attributes specified a width/height, always use it!
<span class="nc bnc" id="L446" title="All 4 branches missed.">        if (axis == View.X_AXIS &amp;&amp; (state &amp; WIDTH_FLAG) == WIDTH_FLAG) {</span>
<span class="nc" id="L447">            getPreferredSpanFromAltView(axis);</span>
<span class="nc" id="L448">            return width + leftInset + rightInset;</span>
        }
<span class="nc bnc" id="L450" title="All 4 branches missed.">        if (axis == View.Y_AXIS &amp;&amp; (state &amp; HEIGHT_FLAG) == HEIGHT_FLAG) {</span>
<span class="nc" id="L451">            getPreferredSpanFromAltView(axis);</span>
<span class="nc" id="L452">            return height + topInset + bottomInset;</span>
        }

<span class="nc" id="L455">        Image image = getImage();</span>

<span class="nc bnc" id="L457" title="All 2 branches missed.">        if (image != null) {</span>
<span class="nc bnc" id="L458" title="All 3 branches missed.">            switch (axis) {</span>
            case View.X_AXIS:
<span class="nc" id="L460">                return width + leftInset + rightInset;</span>
            case View.Y_AXIS:
<span class="nc" id="L462">                return height + topInset + bottomInset;</span>
            default:
<span class="nc" id="L464">                throw new IllegalArgumentException(&quot;Invalid axis: &quot; + axis);</span>
            }
        }
        else {
<span class="nc" id="L468">            View view = getAltView();</span>
<span class="nc" id="L469">            float retValue = 0f;</span>

<span class="nc bnc" id="L471" title="All 2 branches missed.">            if (view != null) {</span>
<span class="nc" id="L472">                retValue = view.getPreferredSpan(axis);</span>
            }
<span class="nc bnc" id="L474" title="All 3 branches missed.">            switch (axis) {</span>
            case View.X_AXIS:
<span class="nc" id="L476">                return retValue + (float)(width + leftInset + rightInset);</span>
            case View.Y_AXIS:
<span class="nc" id="L478">                return retValue + (float)(height + topInset + bottomInset);</span>
            default:
<span class="nc" id="L480">                throw new IllegalArgumentException(&quot;Invalid axis: &quot; + axis);</span>
            }
        }
    }

    /**
     * Determines the desired alignment for this view along an
     * axis.  This is implemented to give the alignment to the
     * bottom of the icon along the y axis, and the default
     * along the x axis.
     *
     * @param axis may be either X_AXIS or Y_AXIS
     * @return the desired alignment; this should be a value
     *   between 0.0 and 1.0 where 0 indicates alignment at the
     *   origin and 1.0 indicates alignment to the full span
     *   away from the origin; an alignment of 0.5 would be the
     *   center of the view
     */
    public float getAlignment(int axis) {
<span class="nc bnc" id="L499" title="All 2 branches missed.">        switch (axis) {</span>
        case View.Y_AXIS:
<span class="nc" id="L501">            return vAlign;</span>
        default:
<span class="nc" id="L503">            return super.getAlignment(axis);</span>
        }
    }

    /**
     * Provides a mapping from the document model coordinate space
     * to the coordinate space of the view mapped to it.
     *
     * @param pos the position to convert
     * @param a the allocated region to render into
     * @return the bounding box of the given position
     * @exception BadLocationException  if the given position does not represent a
     *   valid location in the associated document
     * @see View#modelToView
     */
    public Shape modelToView(int pos, Shape a, Position.Bias b) throws BadLocationException {
<span class="nc" id="L519">        int p0 = getStartOffset();</span>
<span class="nc" id="L520">        int p1 = getEndOffset();</span>
<span class="nc bnc" id="L521" title="All 4 branches missed.">        if ((pos &gt;= p0) &amp;&amp; (pos &lt;= p1)) {</span>
<span class="nc" id="L522">            Rectangle r = a.getBounds();</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">            if (pos == p1) {</span>
<span class="nc" id="L524">                r.x += r.width;</span>
            }
<span class="nc" id="L526">            r.width = 0;</span>
<span class="nc" id="L527">            return r;</span>
        }
<span class="nc" id="L529">        return null;</span>
    }

    /**
     * Provides a mapping from the view coordinate space to the logical
     * coordinate space of the model.
     *
     * @param x the X coordinate
     * @param y the Y coordinate
     * @param a the allocated region to render into
     * @return the location within the model that best represents the
     *  given point of view
     * @see View#viewToModel
     */
    public int viewToModel(float x, float y, Shape a, Position.Bias[] bias) {
<span class="nc" id="L544">        Rectangle alloc = (Rectangle) a;</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (x &lt; alloc.x + alloc.width) {</span>
<span class="nc" id="L546">            bias[0] = Position.Bias.Forward;</span>
<span class="nc" id="L547">            return getStartOffset();</span>
        }
<span class="nc" id="L549">        bias[0] = Position.Bias.Backward;</span>
<span class="nc" id="L550">        return getEndOffset();</span>
    }

    /**
     * Sets the size of the view.  This should cause
     * layout of the view if it has any layout duties.
     *
     * @param width the width &amp;gt;= 0
     * @param height the height &amp;gt;= 0
     */
    public void setSize(float width, float height) {
<span class="nc" id="L561">        sync();</span>

<span class="nc bnc" id="L563" title="All 2 branches missed.">        if (getImage() == null) {</span>
<span class="nc" id="L564">            View view = getAltView();</span>

<span class="nc bnc" id="L566" title="All 2 branches missed.">            if (view != null) {</span>
<span class="nc" id="L567">                view.setSize(Math.max(0f, width - (float)(DEFAULT_WIDTH + leftInset + rightInset)),</span>
<span class="nc" id="L568">                             Math.max(0f, height - (float)(topInset + bottomInset)));</span>
            }
        }
<span class="nc" id="L571">    }</span>

    /**
     * Returns true if this image within a link?
     */
    private boolean isLink() {
<span class="nc bnc" id="L577" title="All 2 branches missed.">        return ((state &amp; LINK_FLAG) == LINK_FLAG);</span>
    }

    /**
     * Returns true if the passed in image has a non-zero width and height.
     */
    private boolean hasPixels(Image image) {
<span class="nc bnc" id="L584" title="All 2 branches missed.">        return image != null &amp;&amp;</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">            (image.getHeight(imageObserver) &gt; 0) &amp;&amp;</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">            (image.getWidth(imageObserver) &gt; 0);</span>
    }

    /**
     * Returns the preferred span of the View used to display the alt text,
     * or 0 if the view does not exist.
     */
    private float getPreferredSpanFromAltView(int axis) {
<span class="nc bnc" id="L594" title="All 2 branches missed.">        if (getImage() == null) {</span>
<span class="nc" id="L595">            View view = getAltView();</span>

<span class="nc bnc" id="L597" title="All 2 branches missed.">            if (view != null) {</span>
<span class="nc" id="L598">                return view.getPreferredSpan(axis);</span>
            }
        }
<span class="nc" id="L601">        return 0f;</span>
    }

    /**
     * Request that this view be repainted.
     * Assumes the view is still at its last-drawn location.
     */
    private void repaint(long delay) {
<span class="nc bnc" id="L609" title="All 4 branches missed.">        if (container != null &amp;&amp; fBounds != null) {</span>
<span class="nc" id="L610">            container.repaint(delay, fBounds.x, fBounds.y, fBounds.width,</span>
                               fBounds.height);
        }
<span class="nc" id="L613">    }</span>

    /**
     * Convenience method for getting an integer attribute from the elements
     * AttributeSet.
     */
    private int getIntAttr(HTML.Attribute name, int deflt) {
<span class="nc" id="L620">        AttributeSet attr = getElement().getAttributes();</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">        if (attr.isDefined(name)) {             // does not check parents!</span>
            int i;
<span class="nc" id="L623">            String val = (String)attr.getAttribute(name);</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">            if (val == null) {</span>
<span class="nc" id="L625">                i = deflt;</span>
            }
            else {
                try{
<span class="nc" id="L629">                    i = Math.max(0, Integer.parseInt(val));</span>
<span class="nc" id="L630">                }catch( NumberFormatException x ) {</span>
<span class="nc" id="L631">                    i = deflt;</span>
<span class="nc" id="L632">                }</span>
            }
<span class="nc" id="L634">            return i;</span>
        } else
<span class="nc" id="L636">            return deflt;</span>
    }

    /**
     * Makes sure the necessary properties and image is loaded.
     */
    private void sync() {
<span class="nc" id="L643">        int s = state;</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">        if ((s &amp; RELOAD_IMAGE_FLAG) != 0) {</span>
<span class="nc" id="L645">            refreshImage();</span>
        }
<span class="nc" id="L647">        s = state;</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">        if ((s &amp; RELOAD_FLAG) != 0) {</span>
<span class="nc" id="L649">            synchronized(this) {</span>
<span class="nc" id="L650">                state = (state | RELOAD_FLAG) ^ RELOAD_FLAG;</span>
<span class="nc" id="L651">            }</span>
<span class="nc" id="L652">            setPropertiesFromAttributes();</span>
        }
<span class="nc" id="L654">    }</span>

    /**
     * Loads the image and updates the size accordingly. This should be
     * invoked instead of invoking &lt;code&gt;loadImage&lt;/code&gt; or
     * &lt;code&gt;updateImageSize&lt;/code&gt; directly.
     */
    private void refreshImage() {
<span class="nc" id="L662">        synchronized(this) {</span>
            // clear out width/height/realoadimage flag and set loading flag
<span class="nc" id="L664">            state = (state | LOADING_FLAG | RELOAD_IMAGE_FLAG | WIDTH_FLAG |</span>
                     HEIGHT_FLAG) ^ (WIDTH_FLAG | HEIGHT_FLAG |
                                     RELOAD_IMAGE_FLAG);
<span class="nc" id="L667">            image = null;</span>
<span class="nc" id="L668">            width = height = 0;</span>
<span class="nc" id="L669">        }</span>

        try {
            // Load the image
<span class="nc" id="L673">            loadImage();</span>

            // And update the size params
<span class="nc" id="L676">            updateImageSize();</span>
        }
        finally {
<span class="nc" id="L679">            synchronized(this) {</span>
                // Clear out state in case someone threw an exception.
<span class="nc" id="L681">                state = (state | LOADING_FLAG) ^ LOADING_FLAG;</span>
<span class="nc" id="L682">            }</span>
<span class="nc" id="L683">        }</span>
<span class="nc" id="L684">    }</span>

    /**
     * Loads the image from the URL &lt;code&gt;getImageURL&lt;/code&gt;. This should
     * only be invoked from &lt;code&gt;refreshImage&lt;/code&gt;.
     */
    private void loadImage() {
<span class="nc" id="L691">        URL src = getImageURL();</span>
<span class="nc" id="L692">        Image newImage = null;</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">        if (src != null) {</span>
<span class="nc" id="L694">            Dictionary cache = (Dictionary)getDocument().</span>
<span class="nc" id="L695">                                    getProperty(IMAGE_CACHE_PROPERTY);</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">            if (cache != null) {</span>
<span class="nc" id="L697">                newImage = (Image)cache.get(src);</span>
            }
            else {
<span class="nc" id="L700">                newImage = Toolkit.getDefaultToolkit().createImage(src);</span>
<span class="nc bnc" id="L701" title="All 4 branches missed.">                if (newImage != null &amp;&amp; getLoadsSynchronously()) {</span>
                    // Force the image to be loaded by using an ImageIcon.
<span class="nc" id="L703">                    ImageIcon ii = new ImageIcon();</span>
<span class="nc" id="L704">                    ii.setImage(newImage);</span>
                }
            }
        }
<span class="nc" id="L708">        image = newImage;</span>
<span class="nc" id="L709">    }</span>

    /**
     * Recreates and reloads the image.  This should
     * only be invoked from &lt;code&gt;refreshImage&lt;/code&gt;.
     */
    private void updateImageSize() {
<span class="nc" id="L716">        int newWidth = 0;</span>
<span class="nc" id="L717">        int newHeight = 0;</span>
<span class="nc" id="L718">        int newState = 0;</span>
<span class="nc" id="L719">        Image newImage = getImage();</span>

<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (newImage != null) {</span>
<span class="nc" id="L722">            Element elem = getElement();</span>
<span class="nc" id="L723">            AttributeSet attr = elem.getAttributes();</span>

            // Get the width/height and set the state ivar before calling
            // anything that might cause the image to be loaded, and thus the
            // ImageHandler to be called.
<span class="nc" id="L728">            newWidth = getIntAttr(HTML.Attribute.WIDTH, -1);</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">            if (newWidth &gt; 0) {</span>
<span class="nc" id="L730">                newState |= WIDTH_FLAG;</span>
            }
<span class="nc" id="L732">            newHeight = getIntAttr(HTML.Attribute.HEIGHT, -1);</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">            if (newHeight &gt; 0) {</span>
<span class="nc" id="L734">                newState |= HEIGHT_FLAG;</span>
            }

<span class="nc bnc" id="L737" title="All 2 branches missed.">            if (newWidth &lt;= 0) {</span>
<span class="nc" id="L738">                newWidth = newImage.getWidth(imageObserver);</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">                if (newWidth &lt;= 0) {</span>
<span class="nc" id="L740">                    newWidth = DEFAULT_WIDTH;</span>
                }
            }

<span class="nc bnc" id="L744" title="All 2 branches missed.">            if (newHeight &lt;= 0) {</span>
<span class="nc" id="L745">                newHeight = newImage.getHeight(imageObserver);</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">                if (newHeight &lt;= 0) {</span>
<span class="nc" id="L747">                    newHeight = DEFAULT_HEIGHT;</span>
                }
            }

            // Make sure the image starts loading:
<span class="nc bnc" id="L752" title="All 2 branches missed.">            if ((newState &amp; (WIDTH_FLAG | HEIGHT_FLAG)) != 0) {</span>
<span class="nc" id="L753">                Toolkit.getDefaultToolkit().prepareImage(newImage, newWidth,</span>
                                                         newHeight,
                                                         imageObserver);
            }
            else {
<span class="nc" id="L758">                Toolkit.getDefaultToolkit().prepareImage(newImage, -1, -1,</span>
                                                         imageObserver);
            }

<span class="nc" id="L762">            boolean createText = false;</span>
<span class="nc" id="L763">            synchronized(this) {</span>
                // If imageloading failed, other thread may have called
                // ImageLoader which will null out image, hence we check
                // for it.
<span class="nc bnc" id="L767" title="All 2 branches missed.">                if (image != null) {</span>
<span class="nc bnc" id="L768" title="All 4 branches missed.">                    if ((newState &amp; WIDTH_FLAG) == WIDTH_FLAG || width == 0) {</span>
<span class="nc" id="L769">                        width = newWidth;</span>
                    }
<span class="nc bnc" id="L771" title="All 4 branches missed.">                    if ((newState &amp; HEIGHT_FLAG) == HEIGHT_FLAG ||</span>
                        height == 0) {
<span class="nc" id="L773">                        height = newHeight;</span>
                    }
                }
                else {
<span class="nc" id="L777">                    createText = true;</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">                    if ((newState &amp; WIDTH_FLAG) == WIDTH_FLAG) {</span>
<span class="nc" id="L779">                        width = newWidth;</span>
                    }
<span class="nc bnc" id="L781" title="All 2 branches missed.">                    if ((newState &amp; HEIGHT_FLAG) == HEIGHT_FLAG) {</span>
<span class="nc" id="L782">                        height = newHeight;</span>
                    }
                }
<span class="nc" id="L785">                state = state | newState;</span>
<span class="nc" id="L786">                state = (state | LOADING_FLAG) ^ LOADING_FLAG;</span>
<span class="nc" id="L787">            }</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">            if (createText) {</span>
                // Only reset if this thread determined image is null
<span class="nc" id="L790">                updateAltTextView();</span>
            }
<span class="nc" id="L792">        }</span>
        else {
<span class="nc" id="L794">            width = height = DEFAULT_HEIGHT;</span>
<span class="nc" id="L795">            updateAltTextView();</span>
        }
<span class="nc" id="L797">    }</span>

    /**
     * Updates the view representing the alt text.
     */
    private void updateAltTextView() {
<span class="nc" id="L803">        String text = getAltText();</span>

<span class="nc bnc" id="L805" title="All 2 branches missed.">        if (text != null) {</span>
            ImageLabelView newView;

<span class="nc" id="L808">            newView = new ImageLabelView(getElement(), text);</span>
<span class="nc" id="L809">            synchronized(this) {</span>
<span class="nc" id="L810">                altView = newView;</span>
<span class="nc" id="L811">            }</span>
        }
<span class="nc" id="L813">    }</span>

    /**
     * Returns the view to use for alternate text. This may be null.
     */
    private View getAltView() {
        View view;

<span class="nc" id="L821">        synchronized(this) {</span>
<span class="nc" id="L822">            view = altView;</span>
<span class="nc" id="L823">        }</span>
<span class="nc bnc" id="L824" title="All 4 branches missed.">        if (view != null &amp;&amp; view.getParent() == null) {</span>
<span class="nc" id="L825">            view.setParent(getParent());</span>
        }
<span class="nc" id="L827">        return view;</span>
    }

    /**
     * Invokes &lt;code&gt;preferenceChanged&lt;/code&gt; on the event displatching
     * thread.
     */
    private void safePreferenceChanged() {
<span class="nc bnc" id="L835" title="All 2 branches missed.">        if (SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L836">            Document doc = getDocument();</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            if (doc instanceof AbstractDocument) {</span>
<span class="nc" id="L838">                ((AbstractDocument)doc).readLock();</span>
            }
<span class="nc" id="L840">            preferenceChanged(null, true, true);</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">            if (doc instanceof AbstractDocument) {</span>
<span class="nc" id="L842">                ((AbstractDocument)doc).readUnlock();</span>
            }
<span class="nc" id="L844">        }</span>
        else {
<span class="nc" id="L846">            SwingUtilities.invokeLater(new Runnable() {</span>
                    public void run() {
<span class="nc" id="L848">                        safePreferenceChanged();</span>
<span class="nc" id="L849">                    }</span>
                });
        }
<span class="nc" id="L852">    }</span>

    /**
     * ImageHandler implements the ImageObserver to correctly update the
     * display as new parts of the image become available.
     */
<span class="nc" id="L858">    private class ImageHandler implements ImageObserver {</span>
        // This can come on any thread. If we are in the process of reloading
        // the image and determining our state (loading == true) we don't fire
        // preference changed, or repaint, we just reset the fWidth/fHeight as
        // necessary and return. This is ok as we know when loading finishes
        // it will pick up the new height/width, if necessary.
        public boolean imageUpdate(Image img, int flags, int x, int y,
                                   int newWidth, int newHeight ) {
<span class="nc bnc" id="L866" title="All 4 branches missed.">            if (img != image &amp;&amp; img != disabledImage ||</span>
<span class="nc bnc" id="L867" title="All 4 branches missed.">                image == null || getParent() == null) {</span>

<span class="nc" id="L869">                return false;</span>
            }

            // Bail out if there was an error:
<span class="nc bnc" id="L873" title="All 2 branches missed.">            if ((flags &amp; (ABORT|ERROR)) != 0) {</span>
<span class="nc" id="L874">                repaint(0);</span>
<span class="nc" id="L875">                synchronized(ImageView.this) {</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">                    if (image == img) {</span>
                        // Be sure image hasn't changed since we don't
                        // initialy synchronize
<span class="nc" id="L879">                        image = null;</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">                        if ((state &amp; WIDTH_FLAG) != WIDTH_FLAG) {</span>
<span class="nc" id="L881">                            width = DEFAULT_WIDTH;</span>
                        }
<span class="nc bnc" id="L883" title="All 2 branches missed.">                        if ((state &amp; HEIGHT_FLAG) != HEIGHT_FLAG) {</span>
<span class="nc" id="L884">                            height = DEFAULT_HEIGHT;</span>
                        }
                    } else {
<span class="nc" id="L887">                        disabledImage = null;</span>
                    }
<span class="nc bnc" id="L889" title="All 2 branches missed.">                    if ((state &amp; LOADING_FLAG) == LOADING_FLAG) {</span>
                        // No need to resize or repaint, still in the process
                        // of loading.
<span class="nc" id="L892">                        return false;</span>
                    }
<span class="nc" id="L894">                }</span>
<span class="nc" id="L895">                updateAltTextView();</span>
<span class="nc" id="L896">                safePreferenceChanged();</span>
<span class="nc" id="L897">                return false;</span>
            }

<span class="nc bnc" id="L900" title="All 2 branches missed.">            if (image == img) {</span>
                // Resize image if necessary:
<span class="nc" id="L902">                short changed = 0;</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">                if ((flags &amp; ImageObserver.HEIGHT) != 0 &amp;&amp; !getElement().</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">                      getAttributes().isDefined(HTML.Attribute.HEIGHT)) {</span>
<span class="nc" id="L905">                    changed |= 1;</span>
                }
<span class="nc bnc" id="L907" title="All 2 branches missed.">                if ((flags &amp; ImageObserver.WIDTH) != 0 &amp;&amp; !getElement().</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">                      getAttributes().isDefined(HTML.Attribute.WIDTH)) {</span>
<span class="nc" id="L909">                    changed |= 2;</span>
                }

<span class="nc" id="L912">                synchronized(ImageView.this) {</span>
<span class="nc bnc" id="L913" title="All 4 branches missed.">                    if ((changed &amp; 1) == 1 &amp;&amp; (state &amp; WIDTH_FLAG) == 0) {</span>
<span class="nc" id="L914">                        width = newWidth;</span>
                    }
<span class="nc bnc" id="L916" title="All 4 branches missed.">                    if ((changed &amp; 2) == 2 &amp;&amp; (state &amp; HEIGHT_FLAG) == 0) {</span>
<span class="nc" id="L917">                        height = newHeight;</span>
                    }
<span class="nc bnc" id="L919" title="All 2 branches missed.">                    if ((state &amp; LOADING_FLAG) == LOADING_FLAG) {</span>
                        // No need to resize or repaint, still in the process of
                        // loading.
<span class="nc" id="L922">                        return true;</span>
                    }
<span class="nc" id="L924">                }</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">                if (changed != 0) {</span>
                    // May need to resize myself, asynchronously:
<span class="nc" id="L927">                    safePreferenceChanged();</span>
<span class="nc" id="L928">                    return true;</span>
                }
            }

            // Repaint when done or when new pixels arrive:
<span class="nc bnc" id="L933" title="All 2 branches missed.">            if ((flags &amp; (FRAMEBITS|ALLBITS)) != 0) {</span>
<span class="nc" id="L934">                repaint(0);</span>
            }
<span class="nc bnc" id="L936" title="All 4 branches missed.">            else if ((flags &amp; SOMEBITS) != 0 &amp;&amp; sIsInc) {</span>
<span class="nc" id="L937">                repaint(sIncRate);</span>
            }
<span class="nc bnc" id="L939" title="All 2 branches missed.">            return ((flags &amp; ALLBITS) == 0);</span>
        }
    }


    /**
     * ImageLabelView is used if the image can't be loaded, and
     * the attribute specified an alt attribute. It overriden a handle of
     * methods as the text is hardcoded and does not come from the document.
     */
    private class ImageLabelView extends InlineView {
        private Segment segment;
        private Color fg;

<span class="nc" id="L953">        ImageLabelView(Element e, String text) {</span>
<span class="nc" id="L954">            super(e);</span>
<span class="nc" id="L955">            reset(text);</span>
<span class="nc" id="L956">        }</span>

        public void reset(String text) {
<span class="nc" id="L959">            segment = new Segment(text.toCharArray(), 0, text.length());</span>
<span class="nc" id="L960">        }</span>

        public void paint(Graphics g, Shape a) {
            // Don't use supers paint, otherwise selection will be wrong
            // as our start/end offsets are fake.
<span class="nc" id="L965">            GlyphPainter painter = getGlyphPainter();</span>

<span class="nc bnc" id="L967" title="All 2 branches missed.">            if (painter != null) {</span>
<span class="nc" id="L968">                g.setColor(getForeground());</span>
<span class="nc" id="L969">                painter.paint(this, g, a, getStartOffset(), getEndOffset());</span>
            }
<span class="nc" id="L971">        }</span>

        public Segment getText(int p0, int p1) {
<span class="nc bnc" id="L974" title="All 4 branches missed.">            if (p0 &lt; 0 || p1 &gt; segment.array.length) {</span>
<span class="nc" id="L975">                throw new RuntimeException(&quot;ImageLabelView: Stale view&quot;);</span>
            }
<span class="nc" id="L977">            segment.offset = p0;</span>
<span class="nc" id="L978">            segment.count = p1 - p0;</span>
<span class="nc" id="L979">            return segment;</span>
        }

        public int getStartOffset() {
<span class="nc" id="L983">            return 0;</span>
        }

        public int getEndOffset() {
<span class="nc" id="L987">            return segment.array.length;</span>
        }

        public View breakView(int axis, int p0, float pos, float len) {
            // Don't allow a break
<span class="nc" id="L992">            return this;</span>
        }

        public Color getForeground() {
            View parent;
<span class="nc bnc" id="L997" title="All 4 branches missed.">            if (fg == null &amp;&amp; (parent = getParent()) != null) {</span>
<span class="nc" id="L998">                Document doc = getDocument();</span>
<span class="nc" id="L999">                AttributeSet attr = parent.getAttributes();</span>

<span class="nc bnc" id="L1001" title="All 4 branches missed.">                if (attr != null &amp;&amp; (doc instanceof StyledDocument)) {</span>
<span class="nc" id="L1002">                    fg = ((StyledDocument)doc).getForeground(attr);</span>
                }
            }
<span class="nc" id="L1005">            return fg;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>