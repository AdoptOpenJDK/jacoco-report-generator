<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CredentialsUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.security.krb5.internal</a> &gt; <span class="el_source">CredentialsUtil.java</span></div><h1>CredentialsUtil.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2001, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

/*
 *
 *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 */

package sun.security.krb5.internal;

import sun.security.krb5.*;
import java.io.IOException;

/**
 * This class is a utility that contains much of the TGS-Exchange
 * protocol. It is used by ../Credentials.java for service ticket
 * acquisition in both the normal and the x-realm case.
 */
<span class="nc" id="L42">public class CredentialsUtil {</span>

<span class="fc" id="L44">    private static boolean DEBUG = sun.security.krb5.internal.Krb5.DEBUG;</span>

    /**
     * Used by a middle server to acquire credentials on behalf of a
     * client to itself using the S4U2self extension.
     * @param client the client to impersonate
     * @param ccreds the TGT of the middle service
     * @return the new creds (cname=client, sname=middle)
     */
    public static Credentials acquireS4U2selfCreds(PrincipalName client,
            Credentials ccreds) throws KrbException, IOException {
<span class="nc" id="L55">        String uRealm = client.getRealmString();</span>
<span class="nc" id="L56">        String localRealm = ccreds.getClient().getRealmString();</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">        if (!uRealm.equals(localRealm)) {</span>
            // TODO: we do not support kerberos referral now
<span class="nc" id="L59">            throw new KrbException(&quot;Cross realm impersonation not supported&quot;);</span>
        }
<span class="nc" id="L61">        KrbTgsReq req = new KrbTgsReq(</span>
                ccreds,
<span class="nc" id="L63">                ccreds.getClient(),</span>
                new PAData(Krb5.PA_FOR_USER,
                    new PAForUserEnc(client,
<span class="nc" id="L66">                        ccreds.getSessionKey()).asn1Encode()));</span>
<span class="nc" id="L67">        Credentials creds = req.sendAndGetCreds();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (!creds.getClient().equals(client)) {</span>
<span class="nc" id="L69">            throw new KrbException(&quot;S4U2self request not honored by KDC&quot;);</span>
        }
<span class="nc" id="L71">        return creds;</span>
    }

    /**
     * Used by a middle server to acquire a service ticket to a backend
     * server using the S4U2proxy extension.
     * @param backend the name of the backend service
     * @param second the client's service ticket to the middle server
     * @param ccreds the TGT of the middle server
     * @return the creds (cname=client, sname=backend)
     */
    public static Credentials acquireS4U2proxyCreds(
                String backend, Ticket second,
                PrincipalName client, Credentials ccreds)
            throws KrbException, IOException {
<span class="nc" id="L86">        KrbTgsReq req = new KrbTgsReq(</span>
                ccreds,
                second,
                new PrincipalName(backend));
<span class="nc" id="L90">        Credentials creds = req.sendAndGetCreds();</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (!creds.getClient().equals(client)) {</span>
<span class="nc" id="L92">            throw new KrbException(&quot;S4U2proxy request not honored by KDC&quot;);</span>
        }
<span class="nc" id="L94">        return creds;</span>
    }

    /**
     * Acquires credentials for a specified service using initial
     * credential. When the service has a different realm from the initial
     * credential, we do cross-realm authentication - first, we use the
     * current credential to get a cross-realm credential from the local KDC,
     * then use that cross-realm credential to request service credential
     * from the foreign KDC.
     *
     * @param service the name of service principal
     * @param ccreds client's initial credential
     */
    public static Credentials acquireServiceCreds(
                String service, Credentials ccreds)
            throws KrbException, IOException {
<span class="fc" id="L111">        PrincipalName sname = new PrincipalName(service);</span>
<span class="fc" id="L112">        String serviceRealm = sname.getRealmString();</span>
<span class="fc" id="L113">        String localRealm = ccreds.getClient().getRealmString();</span>

<span class="pc bpc" id="L115" title="1 of 2 branches missed.">        if (localRealm.equals(serviceRealm)) {</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">            if (DEBUG) {</span>
<span class="nc" id="L117">                System.out.println(</span>
                        &quot;&gt;&gt;&gt; Credentials acquireServiceCreds: same realm&quot;);
            }
<span class="fc" id="L120">            return serviceCreds(sname, ccreds);</span>
        }
<span class="nc" id="L122">        Credentials theCreds = null;</span>

<span class="nc" id="L124">        boolean[] okAsDelegate = new boolean[1];</span>
<span class="nc" id="L125">        Credentials theTgt = getTGTforRealm(localRealm, serviceRealm,</span>
                ccreds, okAsDelegate);
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (theTgt != null) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            if (DEBUG) {</span>
<span class="nc" id="L129">                System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
                        + &quot;got right tgt&quot;);
<span class="nc" id="L131">                System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
                        + &quot;obtaining service creds for &quot; + sname);
            }

            try {
<span class="nc" id="L136">                theCreds = serviceCreds(sname, theTgt);</span>
<span class="nc" id="L137">            } catch (Exception exc) {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                if (DEBUG) {</span>
<span class="nc" id="L139">                    System.out.println(exc);</span>
                }
<span class="nc" id="L141">                theCreds = null;</span>
<span class="nc" id="L142">            }</span>
        }

<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (theCreds != null) {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (DEBUG) {</span>
<span class="nc" id="L147">                System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
                        + &quot;returning creds:&quot;);
<span class="nc" id="L149">                Credentials.printDebug(theCreds);</span>
            }
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if (!okAsDelegate[0]) {</span>
<span class="nc" id="L152">                theCreds.resetDelegate();</span>
            }
<span class="nc" id="L154">            return theCreds;</span>
        }
<span class="nc" id="L156">        throw new KrbApErrException(Krb5.KRB_AP_ERR_GEN_CRED,</span>
                                    &quot;No service creds&quot;);
    }

    /**
     * Gets a TGT to another realm
     * @param localRealm this realm
     * @param serviceRealm the other realm, cannot equals to localRealm
     * @param ccreds TGT in this realm
     * @param okAsDelegate an [out] argument to receive the okAsDelegate
     * property. True only if all realms allow delegation.
     * @return the TGT for the other realm, null if cannot find a path
     * @throws KrbException if something goes wrong
     */
    private static Credentials getTGTforRealm(String localRealm,
            String serviceRealm, Credentials ccreds, boolean[] okAsDelegate)
            throws KrbException {

        // Get a list of realms to traverse
<span class="nc" id="L175">        String[] realms = Realm.getRealmsList(localRealm, serviceRealm);</span>

<span class="nc" id="L177">        int i = 0, k = 0;</span>
<span class="nc" id="L178">        Credentials cTgt = null, newTgt = null, theTgt = null;</span>
<span class="nc" id="L179">        PrincipalName tempService = null;</span>
<span class="nc" id="L180">        String newTgtRealm = null;</span>

<span class="nc" id="L182">        okAsDelegate[0] = true;</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        for (cTgt = ccreds, i = 0; i &lt; realms.length;) {</span>
<span class="nc" id="L184">            tempService = PrincipalName.tgsService(serviceRealm, realms[i]);</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (DEBUG) {</span>
<span class="nc" id="L187">                System.out.println(</span>
                        &quot;&gt;&gt;&gt; Credentials acquireServiceCreds: main loop: [&quot;
                        + i +&quot;] tempService=&quot; + tempService);
            }

            try {
<span class="nc" id="L193">                newTgt = serviceCreds(tempService, cTgt);</span>
<span class="nc" id="L194">            } catch (Exception exc) {</span>
<span class="nc" id="L195">                newTgt = null;</span>
<span class="nc" id="L196">            }</span>

<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (newTgt == null) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                if (DEBUG) {</span>
<span class="nc" id="L200">                    System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
                            + &quot;no tgt; searching thru capath&quot;);
                }

                /*
                 * No tgt found. Let's go thru the realms list one by one.
                 */
<span class="nc" id="L207">                for (newTgt = null, k = i+1;</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">                        newTgt == null &amp;&amp; k &lt; realms.length; k++) {</span>
<span class="nc" id="L209">                    tempService = PrincipalName.tgsService(realms[k], realms[i]);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                    if (DEBUG) {</span>
<span class="nc" id="L211">                        System.out.println(</span>
                                &quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;
                                + &quot;inner loop: [&quot; + k
                                + &quot;] tempService=&quot; + tempService);
                    }
                    try {
<span class="nc" id="L217">                        newTgt = serviceCreds(tempService, cTgt);</span>
<span class="nc" id="L218">                    } catch (Exception exc) {</span>
<span class="nc" id="L219">                        newTgt = null;</span>
<span class="nc" id="L220">                    }</span>
                }
            } // Ends 'if (newTgt == null)'

<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (newTgt == null) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                if (DEBUG) {</span>
<span class="nc" id="L226">                    System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
                            + &quot;no tgt; cannot get creds&quot;);
                }
                break;
            }

            /*
             * We have a tgt. It may or may not be for the target.
             * If it's for the target realm, we're done looking for a tgt.
             */
<span class="nc" id="L236">            newTgtRealm = newTgt.getServer().getInstanceComponent();</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">            if (okAsDelegate[0] &amp;&amp; !newTgt.checkDelegate()) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (DEBUG) {</span>
<span class="nc" id="L239">                    System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot; +</span>
                            &quot;global OK-AS-DELEGATE turned off at &quot; +
<span class="nc" id="L241">                            newTgt.getServer());</span>
                }
<span class="nc" id="L243">                okAsDelegate[0] = false;</span>
            }

<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (DEBUG) {</span>
<span class="nc" id="L247">                System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
                        + &quot;got tgt&quot;);
            }

<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (newTgtRealm.equals(serviceRealm)) {</span>
                /* We got the right tgt */
<span class="nc" id="L253">                theTgt = newTgt;</span>
<span class="nc" id="L254">                break;</span>
            }

            /*
             * The new tgt is not for the target realm.
             * See if the realm of the new tgt is in the list of realms
             * and continue looking from there.
             */
<span class="nc bnc" id="L262" title="All 2 branches missed.">            for (k = i+1; k &lt; realms.length; k++) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (newTgtRealm.equals(realms[k])) {</span>
<span class="nc" id="L264">                    break;</span>
                }
            }

<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (k &lt; realms.length) {</span>
                /*
                 * (re)set the counter so we start looking
                 * from the realm we just obtained a tgt for.
                 */
<span class="nc" id="L273">                i = k;</span>
<span class="nc" id="L274">                cTgt = newTgt;</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">                if (DEBUG) {</span>
<span class="nc" id="L277">                    System.out.println(&quot;&gt;&gt;&gt; Credentials acquireServiceCreds: &quot;</span>
                            + &quot;continuing with main loop counter reset to &quot; + i);
                }
                continue;
            }
            else {
                /*
                 * The new tgt's realm is not in the hierarchy of realms.
                 * It's probably not safe to get a tgt from
                 * a tgs that is outside the known list of realms.
                 * Give up now.
                 */
                break;
            }
        } // Ends outermost/main 'for' loop

<span class="nc" id="L293">        return theTgt;</span>
    }

   /*
    * This method does the real job to request the service credential.
    */
    private static Credentials serviceCreds(
            PrincipalName service, Credentials ccreds)
            throws KrbException, IOException {
<span class="fc" id="L302">        return new KrbTgsReq(ccreds, service).sendAndGetCreds();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>