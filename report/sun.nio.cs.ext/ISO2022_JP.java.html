<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ISO2022_JP.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.nio.cs.ext</a> &gt; <span class="el_source">ISO2022_JP.java</span></div><h1>ISO2022_JP.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2002, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.nio.cs.ext;

import java.nio.ByteBuffer;
import java.nio.CharBuffer;
import java.nio.charset.Charset;
import java.nio.charset.CharsetDecoder;
import java.nio.charset.CharsetEncoder;
import java.nio.charset.CoderResult;
import java.nio.charset.CodingErrorAction;
import sun.nio.cs.HistoricallyNamedCharset;
import sun.nio.cs.Surrogate;
import sun.nio.cs.US_ASCII;
import static sun.nio.cs.CharsetMapping.*;

/*
 * Implementation notes:
 *
 * (1)&quot;Standard based&quot; (ASCII, JIS_X_0201 and JIS_X_0208) ISO2022-JP charset
 * is provided by the base implementation of this class.
 *
 * Three Microsoft ISO2022-JP variants, MS50220, MS50221 and MSISO2022JP
 * are provided via subclasses.
 *
 * (2)MS50220 and MS50221 are assumed to work the same way as Microsoft
 * CP50220 and CP50221's 7-bit implementation works by using CP5022X
 * specific JIS0208 and JIS0212 mapping tables (generated via Microsoft's
 * MultiByteToWideChar/WideCharToMultiByte APIs). The only difference
 * between these 2 classes is that MS50220 does not support singlebyte
 * halfwidth kana (Uff61-Uff9f) shiftin mechanism when &quot;encoding&quot;, instead
 * these halfwidth kana characters are converted to their fullwidth JIS0208
 * counterparts.
 *
 * The difference between the standard JIS_X_0208 and JIS_X_0212 mappings
 * and the CP50220/50221 specific are
 *
 * 0208 mapping:
 *              1)0x213d &lt;-&gt; U2015 (compared to U2014)
 *              2)One way mappings for 5 characters below
 *                u2225 (ms) -&gt; 0x2142 &lt;-&gt; u2016 (jis)
 *                uff0d (ms) -&gt; 0x215d &lt;-&gt; u2212 (jis)
 *                uffe0 (ms) -&gt; 0x2171 &lt;-&gt; u00a2 (jis)
 *                uffe1 (ms) -&gt; 0x2172 &lt;-&gt; u00a3 (jis)
 *                uffe2 (ms) -&gt; 0x224c &lt;-&gt; u00ac (jis)
 *                //should consider 0xff5e -&gt; 0x2141 &lt;-&gt; U301c?
 *              3)NEC Row13 0x2d21-0x2d79
 *              4)85-94 ku &lt;-&gt; UE000,UE3AB (includes NEC selected
 *                IBM kanji in 89-92ku)
 *              5)UFF61-UFF9f -&gt; Fullwidth 0208 KANA
 *
 * 0212 mapping:
 *              1)0x2237 &lt;-&gt; UFF5E (Fullwidth Tilde)
 *              2)0x2271 &lt;-&gt; U2116 (Numero Sign)
 *              3)85-94 ku &lt;-&gt; UE3AC - UE757
 *
 * (3)MSISO2022JP uses a JIS0208 mapping generated from MS932DB.b2c
 * and MS932DB.c2b by converting the SJIS codepoints back to their
 * JIS0208 counterparts. With the exception of
 *
 * (a)Codepoints with a resulting JIS0208 codepoints beyond 0x7e00 are
 *    dropped (this includs the IBM Extended Kanji/Non-kanji from 0x9321
 *    to 0x972c)
 * (b)The Unicode codepoints that the IBM Extended Kanji/Non-kanji are
 *    mapped to (in MS932) are mapped back to NEC selected IBM Kanji/
 *    Non-kanji area at 0x7921-0x7c7e.
 *
 * Compared to JIS_X_0208 mapping, this MS932 based mapping has

 * (a)different mappings for 7 JIS codepoints
 *        0x213d &lt;-&gt; U2015
 *        0x2141 &lt;-&gt; UFF5E
 *        0x2142 &lt;-&gt; U2225
 *        0x215d &lt;-&gt; Uff0d
 *        0x2171 &lt;-&gt; Uffe0
 *        0x2172 &lt;-&gt; Uffe1
 *        0x224c &lt;-&gt; Uffe2
 * (b)added one-way c2b mappings for
 *        U00b8 -&gt; 0x2124
 *        U00b7 -&gt; 0x2126
 *        U00af -&gt; 0x2131
 *        U00ab -&gt; 0x2263
 *        U00bb -&gt; 0x2264
 *        U3094 -&gt; 0x2574
 *        U00b5 -&gt; 0x264c
 * (c)NEC Row 13
 * (d)NEC selected IBM extended Kanji/Non-kanji
 *    These codepoints are mapped to the same Unicode codepoints as
 *    the MS932 does, while MS50220/50221 maps them to the Unicode
 *    private area.
 *
 * # There is also an interesting difference when compared to MS5022X
 *   0208 mapping for JIS codepoint &quot;0x2D60&quot;, MS932 maps it to U301d
 *   but MS5022X maps it to U301e, obvious MS5022X is wrong, but...
 */

public class ISO2022_JP
    extends Charset
    implements HistoricallyNamedCharset
{
    private static final int ASCII = 0;                 // ESC ( B
    private static final int JISX0201_1976 = 1;         // ESC ( J
    private static final int JISX0208_1978 = 2;         // ESC $ @
    private static final int JISX0208_1983 = 3;         // ESC $ B
    private static final int JISX0212_1990 = 4;         // ESC $ ( D
    private static final int JISX0201_1976_KANA = 5;    // ESC ( I
    private static final int SHIFTOUT = 6;

    private static final int ESC = 0x1b;
    private static final int SO = 0x0e;
    private static final int SI = 0x0f;

    public ISO2022_JP() {
<span class="nc" id="L137">        super(&quot;ISO-2022-JP&quot;,</span>
<span class="nc" id="L138">              ExtendedCharsets.aliasesFor(&quot;ISO-2022-JP&quot;));</span>
<span class="nc" id="L139">    }</span>

    protected ISO2022_JP(String canonicalName,
                         String[] aliases) {
<span class="nc" id="L143">        super(canonicalName, aliases);</span>
<span class="nc" id="L144">    }</span>

    public String historicalName() {
<span class="nc" id="L147">        return &quot;ISO2022JP&quot;;</span>
    }

    public boolean contains(Charset cs) {
<span class="nc bnc" id="L151" title="All 8 branches missed.">        return ((cs instanceof JIS_X_0201)</span>
                || (cs instanceof US_ASCII)
                || (cs instanceof JIS_X_0208)
                || (cs instanceof ISO2022_JP));
    }

    public CharsetDecoder newDecoder() {
<span class="nc" id="L158">        return new Decoder(this);</span>
    }

    public CharsetEncoder newEncoder() {
<span class="nc" id="L162">        return new Encoder(this);</span>
    }

    protected boolean doSBKANA() {
<span class="nc" id="L166">        return true;</span>
    }

<span class="nc bnc" id="L169" title="All 2 branches missed.">    static class Decoder extends CharsetDecoder</span>
        implements DelegatableDecoder {

<span class="nc" id="L172">        final static DoubleByte.Decoder DEC0208 =</span>
<span class="nc" id="L173">            (DoubleByte.Decoder)new JIS_X_0208().newDecoder();</span>

        private int currentState;
        private int previousState;

        private DoubleByte.Decoder dec0208;
        private DoubleByte.Decoder dec0212;

        private Decoder(Charset cs) {
<span class="nc" id="L182">            this(cs, DEC0208, null);</span>
<span class="nc" id="L183">        }</span>

        protected Decoder(Charset cs,
                          DoubleByte.Decoder dec0208,
                          DoubleByte.Decoder dec0212) {
<span class="nc" id="L188">            super(cs, 0.5f, 1.0f);</span>
<span class="nc" id="L189">            this.dec0208 = dec0208;</span>
<span class="nc" id="L190">            this.dec0212 = dec0212;</span>
<span class="nc" id="L191">            currentState = ASCII;</span>
<span class="nc" id="L192">            previousState = ASCII;</span>
<span class="nc" id="L193">        }</span>

        public void implReset() {
<span class="nc" id="L196">            currentState = ASCII;</span>
<span class="nc" id="L197">            previousState = ASCII;</span>
<span class="nc" id="L198">        }</span>

        private CoderResult decodeArrayLoop(ByteBuffer src,
                                            CharBuffer dst)
        {
<span class="nc" id="L203">            int inputSize = 0;</span>
<span class="nc" id="L204">            int b1 = 0, b2 = 0, b3 = 0, b4 = 0;</span>
<span class="nc" id="L205">            char c = UNMAPPABLE_DECODING;</span>
<span class="nc" id="L206">            byte[] sa = src.array();</span>
<span class="nc" id="L207">            int sp = src.arrayOffset() + src.position();</span>
<span class="nc" id="L208">            int sl = src.arrayOffset() + src.limit();</span>
<span class="nc bnc" id="L209" title="All 4 branches missed.">            assert (sp &lt;= sl);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            sp = (sp &lt;= sl ? sp : sl);</span>

<span class="nc" id="L212">            char[] da = dst.array();</span>
<span class="nc" id="L213">            int dp = dst.arrayOffset() + dst.position();</span>
<span class="nc" id="L214">            int dl = dst.arrayOffset() + dst.limit();</span>
<span class="nc bnc" id="L215" title="All 4 branches missed.">            assert (dp &lt;= dl);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">            dp = (dp &lt;= dl ? dp : dl);</span>

            try {
<span class="nc bnc" id="L219" title="All 2 branches missed.">                while (sp &lt; sl) {</span>
<span class="nc" id="L220">                    b1 = sa[sp] &amp; 0xff;</span>
<span class="nc" id="L221">                    inputSize = 1;</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if ((b1 &amp; 0x80) != 0) {</span>
<span class="nc" id="L223">                        return CoderResult.malformedForLength(inputSize);</span>
                    }
<span class="nc bnc" id="L225" title="All 6 branches missed.">                    if (b1 == ESC || b1 == SO || b1 == SI) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                        if (b1 == ESC) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                            if (sp + inputSize + 2 &gt; sl)</span>
<span class="nc" id="L228">                                return CoderResult.UNDERFLOW;</span>
<span class="nc" id="L229">                            b2 = sa[sp + inputSize++] &amp; 0xff;</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                            if (b2 == '(') {</span>
<span class="nc" id="L231">                                b3 = sa[sp + inputSize++] &amp; 0xff;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                                if (b3 == 'B'){</span>
<span class="nc" id="L233">                                    currentState = ASCII;</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                                } else if (b3 == 'J'){</span>
<span class="nc" id="L235">                                    currentState = JISX0201_1976;</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                                } else if (b3 == 'I'){</span>
<span class="nc" id="L237">                                    currentState = JISX0201_1976_KANA;</span>
                                } else {
<span class="nc" id="L239">                                    return CoderResult.malformedForLength(inputSize);</span>
                                }
<span class="nc bnc" id="L241" title="All 2 branches missed.">                            } else if (b2 == '$'){</span>
<span class="nc" id="L242">                                b3 = sa[sp + inputSize++] &amp; 0xff;</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                                if (b3 == '@'){</span>
<span class="nc" id="L244">                                    currentState = JISX0208_1978;</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                                } else if (b3 == 'B'){</span>
<span class="nc" id="L246">                                    currentState = JISX0208_1983;</span>
<span class="nc bnc" id="L247" title="All 4 branches missed.">                                } else if (b3 == '(' &amp;&amp; dec0212 != null) {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                                    if (sp + inputSize + 1 &gt; sl)</span>
<span class="nc" id="L249">                                        return CoderResult.UNDERFLOW;</span>
<span class="nc" id="L250">                                    b4 = sa[sp + inputSize++] &amp; 0xff;</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                                    if (b4 == 'D') {</span>
<span class="nc" id="L252">                                        currentState = JISX0212_1990;</span>
                                    } else {
<span class="nc" id="L254">                                        return CoderResult.malformedForLength(inputSize);</span>
                                    }
                                } else {
<span class="nc" id="L257">                                    return CoderResult.malformedForLength(inputSize);</span>
                                }
                            } else {
<span class="nc" id="L260">                                return CoderResult.malformedForLength(inputSize);</span>
                            }
<span class="nc bnc" id="L262" title="All 2 branches missed.">                        } else if (b1 == SO) {</span>
<span class="nc" id="L263">                            previousState = currentState;</span>
<span class="nc" id="L264">                            currentState = SHIFTOUT;</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                        } else if (b1 == SI) {</span>
<span class="nc" id="L266">                            currentState = previousState;</span>
                        }
<span class="nc" id="L268">                        sp += inputSize;</span>
<span class="nc" id="L269">                        continue;</span>
                    }
<span class="nc bnc" id="L271" title="All 2 branches missed.">                    if (dp + 1 &gt; dl)</span>
<span class="nc" id="L272">                        return CoderResult.OVERFLOW;</span>

<span class="nc bnc" id="L274" title="All 6 branches missed.">                    switch (currentState){</span>
                        case ASCII:
<span class="nc" id="L276">                            da[dp++] = (char)(b1 &amp; 0xff);</span>
<span class="nc" id="L277">                            break;</span>
                        case JISX0201_1976:
<span class="nc bnc" id="L279" title="All 3 branches missed.">                          switch (b1) {</span>
                              case 0x5c:  // Yen/tilde substitution
<span class="nc" id="L281">                                da[dp++] = '\u00a5';</span>
<span class="nc" id="L282">                                break;</span>
                              case 0x7e:
<span class="nc" id="L284">                                da[dp++] = '\u203e';</span>
<span class="nc" id="L285">                                break;</span>
                              default:
<span class="nc" id="L287">                                da[dp++] = (char)b1;</span>
<span class="nc" id="L288">                                break;</span>
                            }
                            break;
                        case JISX0208_1978:
                        case JISX0208_1983:
<span class="nc bnc" id="L293" title="All 2 branches missed.">                            if (sp + inputSize + 1 &gt; sl)</span>
<span class="nc" id="L294">                                return CoderResult.UNDERFLOW;</span>
<span class="nc" id="L295">                            b2 = sa[sp + inputSize++] &amp; 0xff;</span>
<span class="nc" id="L296">                            c = dec0208.decodeDouble(b1,b2);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">                            if (c == UNMAPPABLE_DECODING)</span>
<span class="nc" id="L298">                                return CoderResult.unmappableForLength(inputSize);</span>
<span class="nc" id="L299">                            da[dp++] = c;</span>
<span class="nc" id="L300">                            break;</span>
                        case JISX0212_1990:
<span class="nc bnc" id="L302" title="All 2 branches missed.">                            if (sp + inputSize + 1 &gt; sl)</span>
<span class="nc" id="L303">                                return CoderResult.UNDERFLOW;</span>
<span class="nc" id="L304">                            b2 = sa[sp + inputSize++] &amp; 0xff;</span>
<span class="nc" id="L305">                            c = dec0212.decodeDouble(b1,b2);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                            if (c == UNMAPPABLE_DECODING)</span>
<span class="nc" id="L307">                                return CoderResult.unmappableForLength(inputSize);</span>
<span class="nc" id="L308">                            da[dp++] = c;</span>
<span class="nc" id="L309">                            break;</span>
                        case JISX0201_1976_KANA:
                        case SHIFTOUT:
<span class="nc bnc" id="L312" title="All 2 branches missed.">                            if (b1 &gt; 0x60) {</span>
<span class="nc" id="L313">                                return CoderResult.malformedForLength(inputSize);</span>
                            }
<span class="nc" id="L315">                            da[dp++] = (char)(b1 + 0xff40);</span>
                            break;
                    }
<span class="nc" id="L318">                    sp += inputSize;</span>
                }
<span class="nc" id="L320">                return CoderResult.UNDERFLOW;</span>
            } finally {
<span class="nc" id="L322">                src.position(sp - src.arrayOffset());</span>
<span class="nc" id="L323">                dst.position(dp - dst.arrayOffset());</span>
            }
        }

        private CoderResult decodeBufferLoop(ByteBuffer src,
                                             CharBuffer dst)
        {
<span class="nc" id="L330">            int mark = src.position();</span>
<span class="nc" id="L331">            int b1 = 0, b2 = 0, b3 = 0, b4=0;</span>
<span class="nc" id="L332">            char c = UNMAPPABLE_DECODING;</span>
<span class="nc" id="L333">            int inputSize = 0;</span>
            try {
<span class="nc bnc" id="L335" title="All 2 branches missed.">                while (src.hasRemaining()) {</span>
<span class="nc" id="L336">                    b1 = src.get() &amp; 0xff;</span>
<span class="nc" id="L337">                    inputSize = 1;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                    if ((b1 &amp; 0x80) != 0)</span>
<span class="nc" id="L339">                        return CoderResult.malformedForLength(inputSize);</span>
<span class="nc bnc" id="L340" title="All 6 branches missed.">                    if (b1 == ESC || b1 == SO || b1 == SI) {</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">                        if (b1 == ESC) {  // ESC</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                            if (src.remaining() &lt; 2)</span>
<span class="nc" id="L343">                                return CoderResult.UNDERFLOW;</span>
<span class="nc" id="L344">                            b2 = src.get() &amp; 0xff;</span>
<span class="nc" id="L345">                            inputSize++;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                            if (b2 == '(') {</span>
<span class="nc" id="L347">                                b3 = src.get() &amp; 0xff;</span>
<span class="nc" id="L348">                                inputSize++;</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                                if (b3 == 'B'){</span>
<span class="nc" id="L350">                                    currentState = ASCII;</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                                } else if (b3 == 'J'){</span>
<span class="nc" id="L352">                                    currentState = JISX0201_1976;</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                                } else if (b3 == 'I'){</span>
<span class="nc" id="L354">                                    currentState = JISX0201_1976_KANA;</span>
                                } else {
<span class="nc" id="L356">                                   return CoderResult.malformedForLength(inputSize);</span>
                                }
<span class="nc bnc" id="L358" title="All 2 branches missed.">                            } else if (b2 == '$'){</span>
<span class="nc" id="L359">                                b3 = src.get() &amp; 0xff;</span>
<span class="nc" id="L360">                                inputSize++;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                                if (b3 == '@'){</span>
<span class="nc" id="L362">                                    currentState = JISX0208_1978;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">                                } else if (b3 == 'B'){</span>
<span class="nc" id="L364">                                    currentState = JISX0208_1983;</span>
<span class="nc bnc" id="L365" title="All 4 branches missed.">                                } else if (b3 == '(' &amp;&amp; dec0212 != null) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                                    if (!src.hasRemaining())</span>
<span class="nc" id="L367">                                        return CoderResult.UNDERFLOW;</span>
<span class="nc" id="L368">                                    b4 = src.get() &amp; 0xff;</span>
<span class="nc" id="L369">                                    inputSize++;</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">                                    if (b4 == 'D') {</span>
<span class="nc" id="L371">                                        currentState = JISX0212_1990;</span>
                                    } else {
<span class="nc" id="L373">                                        return CoderResult.malformedForLength(inputSize);</span>
                                    }
                                } else {
<span class="nc" id="L376">                                    return CoderResult.malformedForLength(inputSize);</span>
                                }
                            } else {
<span class="nc" id="L379">                                return CoderResult.malformedForLength(inputSize);</span>
                            }
<span class="nc bnc" id="L381" title="All 2 branches missed.">                        } else if (b1 == SO) {</span>
<span class="nc" id="L382">                            previousState = currentState;</span>
<span class="nc" id="L383">                            currentState = SHIFTOUT;</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">                        } else if (b1 == SI) { // shift back in</span>
<span class="nc" id="L385">                            currentState = previousState;</span>
                        }
<span class="nc" id="L387">                        mark += inputSize;</span>
<span class="nc" id="L388">                        continue;</span>
                    }
<span class="nc bnc" id="L390" title="All 2 branches missed.">                    if (!dst.hasRemaining())</span>
<span class="nc" id="L391">                        return CoderResult.OVERFLOW;</span>

<span class="nc bnc" id="L393" title="All 6 branches missed.">                    switch (currentState){</span>
                        case ASCII:
<span class="nc" id="L395">                            dst.put((char)(b1 &amp; 0xff));</span>
<span class="nc" id="L396">                            break;</span>
                        case JISX0201_1976:
<span class="nc bnc" id="L398" title="All 3 branches missed.">                            switch (b1) {</span>
                              case 0x5c:  // Yen/tilde substitution
<span class="nc" id="L400">                                dst.put('\u00a5');</span>
<span class="nc" id="L401">                                break;</span>
                              case 0x7e:
<span class="nc" id="L403">                                dst.put('\u203e');</span>
<span class="nc" id="L404">                                break;</span>
                              default:
<span class="nc" id="L406">                                dst.put((char)b1);</span>
<span class="nc" id="L407">                                break;</span>
                            }
                            break;
                        case JISX0208_1978:
                        case JISX0208_1983:
<span class="nc bnc" id="L412" title="All 2 branches missed.">                            if (!src.hasRemaining())</span>
<span class="nc" id="L413">                                return CoderResult.UNDERFLOW;</span>
<span class="nc" id="L414">                            b2 = src.get() &amp; 0xff;</span>
<span class="nc" id="L415">                            inputSize++;</span>
<span class="nc" id="L416">                            c = dec0208.decodeDouble(b1,b2);</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                            if (c == UNMAPPABLE_DECODING)</span>
<span class="nc" id="L418">                                return CoderResult.unmappableForLength(inputSize);</span>
<span class="nc" id="L419">                            dst.put(c);</span>
<span class="nc" id="L420">                            break;</span>
                        case JISX0212_1990:
<span class="nc bnc" id="L422" title="All 2 branches missed.">                            if (!src.hasRemaining())</span>
<span class="nc" id="L423">                                return CoderResult.UNDERFLOW;</span>
<span class="nc" id="L424">                            b2 = src.get() &amp; 0xff;</span>
<span class="nc" id="L425">                            inputSize++;</span>
<span class="nc" id="L426">                            c = dec0212.decodeDouble(b1,b2);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">                            if (c == UNMAPPABLE_DECODING)</span>
<span class="nc" id="L428">                                return CoderResult.unmappableForLength(inputSize);</span>
<span class="nc" id="L429">                            dst.put(c);</span>
<span class="nc" id="L430">                            break;</span>
                        case JISX0201_1976_KANA:
                        case SHIFTOUT:
<span class="nc bnc" id="L433" title="All 2 branches missed.">                            if (b1 &gt; 0x60) {</span>
<span class="nc" id="L434">                                return CoderResult.malformedForLength(inputSize);</span>
                            }
<span class="nc" id="L436">                            dst.put((char)(b1 + 0xff40));</span>
                            break;
                    }
<span class="nc" id="L439">                    mark += inputSize;</span>
                }
<span class="nc" id="L441">                return CoderResult.UNDERFLOW;</span>
            } finally {
<span class="nc" id="L443">                src.position(mark);</span>
            }
        }

        // Make some protected methods public for use by JISAutoDetect
        public CoderResult decodeLoop(ByteBuffer src, CharBuffer dst) {
<span class="nc bnc" id="L449" title="All 4 branches missed.">            if (src.hasArray() &amp;&amp; dst.hasArray())</span>
<span class="nc" id="L450">                return decodeArrayLoop(src, dst);</span>
            else
<span class="nc" id="L452">                return decodeBufferLoop(src, dst);</span>
        }

        public CoderResult implFlush(CharBuffer out) {
<span class="nc" id="L456">            return super.implFlush(out);</span>
        }
    }

<span class="nc bnc" id="L460" title="All 2 branches missed.">    static class Encoder extends CharsetEncoder {</span>

<span class="nc" id="L462">        final static DoubleByte.Encoder ENC0208 =</span>
<span class="nc" id="L463">            (DoubleByte.Encoder)new JIS_X_0208().newEncoder();</span>

<span class="nc" id="L465">        private static byte[] repl = { (byte)0x21, (byte)0x29 };</span>
<span class="nc" id="L466">        private int currentMode = ASCII;</span>
<span class="nc" id="L467">        private int replaceMode = JISX0208_1983;</span>
        private DoubleByte.Encoder enc0208;
        private DoubleByte.Encoder enc0212;
        private boolean doSBKANA;

        private Encoder(Charset cs) {
<span class="nc" id="L473">            this(cs, ENC0208, null, true);</span>
<span class="nc" id="L474">        }</span>

        Encoder(Charset cs,
                DoubleByte.Encoder enc0208,
                DoubleByte.Encoder enc0212,
                boolean doSBKANA) {
<span class="nc bnc" id="L480" title="All 2 branches missed.">            super(cs, 4.0f, (enc0212 != null)? 9.0f : 8.0f, repl);</span>
<span class="nc" id="L481">            this.enc0208 = enc0208;</span>
<span class="nc" id="L482">            this.enc0212 = enc0212;</span>
<span class="nc" id="L483">            this.doSBKANA = doSBKANA;</span>
<span class="nc" id="L484">        }</span>

        protected int encodeSingle(char inputChar) {
<span class="nc" id="L487">            return -1;</span>
        }

        protected void implReset() {
<span class="nc" id="L491">            currentMode = ASCII;</span>
<span class="nc" id="L492">        }</span>

        protected void implReplaceWith(byte[] newReplacement) {
            /* It's almost impossible to decide which charset they belong
               to. The best thing we can do here is to &quot;guess&quot; based on
               the length of newReplacement.
             */
<span class="nc bnc" id="L499" title="All 2 branches missed.">            if (newReplacement.length == 1) {</span>
<span class="nc" id="L500">                replaceMode = ASCII;</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">            } else if (newReplacement.length == 2) {</span>
<span class="nc" id="L502">                replaceMode = JISX0208_1983;</span>
            }
<span class="nc" id="L504">        }</span>

        protected CoderResult implFlush(ByteBuffer out) {
<span class="nc bnc" id="L507" title="All 2 branches missed.">            if (currentMode != ASCII) {</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                if (out.remaining() &lt; 3)</span>
<span class="nc" id="L509">                    return CoderResult.OVERFLOW;</span>
<span class="nc" id="L510">                out.put((byte)0x1b);</span>
<span class="nc" id="L511">                out.put((byte)0x28);</span>
<span class="nc" id="L512">                out.put((byte)0x42);</span>
<span class="nc" id="L513">                currentMode = ASCII;</span>
            }
<span class="nc" id="L515">            return CoderResult.UNDERFLOW;</span>
        }

        public boolean canEncode(char c) {
<span class="nc bnc" id="L519" title="All 10 branches missed.">            return ((c &lt;= '\u007F') ||</span>
                    (c &gt;= 0xFF61 &amp;&amp; c &lt;= 0xFF9F) ||
                    (c == '\u00A5') ||
                    (c == '\u203E') ||
<span class="nc bnc" id="L523" title="All 4 branches missed.">                    enc0208.canEncode(c) ||</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">                    (enc0212!=null &amp;&amp; enc0212.canEncode(c)));</span>
        }

<span class="nc" id="L527">        private final Surrogate.Parser sgp = new Surrogate.Parser();</span>

        private CoderResult encodeArrayLoop(CharBuffer src,
                                            ByteBuffer dst)
        {
<span class="nc" id="L532">            char[] sa = src.array();</span>
<span class="nc" id="L533">            int sp = src.arrayOffset() + src.position();</span>
<span class="nc" id="L534">            int sl = src.arrayOffset() + src.limit();</span>
<span class="nc bnc" id="L535" title="All 4 branches missed.">            assert (sp &lt;= sl);</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">            sp = (sp &lt;= sl ? sp : sl);</span>
<span class="nc" id="L537">            byte[] da = dst.array();</span>
<span class="nc" id="L538">            int dp = dst.arrayOffset() + dst.position();</span>
<span class="nc" id="L539">            int dl = dst.arrayOffset() + dst.limit();</span>
<span class="nc bnc" id="L540" title="All 4 branches missed.">            assert (dp &lt;= dl);</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">            dp = (dp &lt;= dl ? dp : dl);</span>

            try {
<span class="nc bnc" id="L544" title="All 2 branches missed.">                while (sp &lt; sl) {</span>
<span class="nc" id="L545">                    char c = sa[sp];</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                    if (c &lt;= '\u007F') {</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                        if (currentMode != ASCII) {</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">                            if (dl - dp &lt; 3)</span>
<span class="nc" id="L549">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L550">                            da[dp++] = (byte)0x1b;</span>
<span class="nc" id="L551">                            da[dp++] = (byte)0x28;</span>
<span class="nc" id="L552">                            da[dp++] = (byte)0x42;</span>
<span class="nc" id="L553">                            currentMode = ASCII;</span>
                        }
<span class="nc bnc" id="L555" title="All 2 branches missed.">                        if (dl - dp &lt; 1)</span>
<span class="nc" id="L556">                            return CoderResult.OVERFLOW;</span>
<span class="nc" id="L557">                        da[dp++] = (byte)c;</span>
<span class="nc bnc" id="L558" title="All 6 branches missed.">                    } else if (c &gt;= 0xff61 &amp;&amp; c &lt;= 0xff9f &amp;&amp; doSBKANA) {</span>
                        //a single byte kana
<span class="nc bnc" id="L560" title="All 2 branches missed.">                        if (currentMode != JISX0201_1976_KANA) {</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">                            if (dl - dp &lt; 3)</span>
<span class="nc" id="L562">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L563">                            da[dp++] = (byte)0x1b;</span>
<span class="nc" id="L564">                            da[dp++] = (byte)0x28;</span>
<span class="nc" id="L565">                            da[dp++] = (byte)0x49;</span>
<span class="nc" id="L566">                            currentMode = JISX0201_1976_KANA;</span>
                        }
<span class="nc bnc" id="L568" title="All 2 branches missed.">                        if (dl - dp &lt; 1)</span>
<span class="nc" id="L569">                            return CoderResult.OVERFLOW;</span>
<span class="nc" id="L570">                        da[dp++] = (byte)(c - 0xff40);</span>
<span class="nc bnc" id="L571" title="All 4 branches missed.">                    } else if (c == '\u00A5' || c == '\u203E') {</span>
                        //backslash or tilde
<span class="nc bnc" id="L573" title="All 2 branches missed.">                        if (currentMode != JISX0201_1976) {</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">                            if (dl - dp &lt; 3)</span>
<span class="nc" id="L575">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L576">                            da[dp++] = (byte)0x1b;</span>
<span class="nc" id="L577">                            da[dp++] = (byte)0x28;</span>
<span class="nc" id="L578">                            da[dp++] = (byte)0x4a;</span>
<span class="nc" id="L579">                            currentMode = JISX0201_1976;</span>
                        }
<span class="nc bnc" id="L581" title="All 2 branches missed.">                        if (dl - dp &lt; 1)</span>
<span class="nc" id="L582">                            return CoderResult.OVERFLOW;</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">                        da[dp++] = (c == '\u00A5')?(byte)0x5C:(byte)0x7e;</span>
                    } else {
<span class="nc" id="L585">                        int index = enc0208.encodeChar(c);</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">                        if (index != UNMAPPABLE_ENCODING) {</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">                            if (currentMode != JISX0208_1983) {</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">                                if (dl - dp &lt; 3)</span>
<span class="nc" id="L589">                                    return CoderResult.OVERFLOW;</span>
<span class="nc" id="L590">                                da[dp++] = (byte)0x1b;</span>
<span class="nc" id="L591">                                da[dp++] = (byte)0x24;</span>
<span class="nc" id="L592">                                da[dp++] = (byte)0x42;</span>
<span class="nc" id="L593">                                currentMode = JISX0208_1983;</span>
                            }
<span class="nc bnc" id="L595" title="All 2 branches missed.">                            if (dl - dp &lt; 2)</span>
<span class="nc" id="L596">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L597">                            da[dp++] = (byte)(index &gt;&gt; 8);</span>
<span class="nc" id="L598">                            da[dp++] = (byte)(index &amp; 0xff);</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                        } else if (enc0212 != null &amp;&amp;</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">                                   (index = enc0212.encodeChar(c)) != UNMAPPABLE_ENCODING) {</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">                            if (currentMode != JISX0212_1990) {</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                                if (dl - dp &lt; 4)</span>
<span class="nc" id="L603">                                    return CoderResult.OVERFLOW;</span>
<span class="nc" id="L604">                                da[dp++] = (byte)0x1b;</span>
<span class="nc" id="L605">                                da[dp++] = (byte)0x24;</span>
<span class="nc" id="L606">                                da[dp++] = (byte)0x28;</span>
<span class="nc" id="L607">                                da[dp++] = (byte)0x44;</span>
<span class="nc" id="L608">                                currentMode = JISX0212_1990;</span>
                            }
<span class="nc bnc" id="L610" title="All 2 branches missed.">                            if (dl - dp &lt; 2)</span>
<span class="nc" id="L611">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L612">                            da[dp++] = (byte)(index &gt;&gt; 8);</span>
<span class="nc" id="L613">                            da[dp++] = (byte)(index &amp; 0xff);</span>
                        } else {
<span class="nc bnc" id="L615" title="All 4 branches missed.">                            if (Character.isSurrogate(c) &amp;&amp; sgp.parse(c, sa, sp, sl) &lt; 0)</span>
<span class="nc" id="L616">                                return sgp.error();</span>
<span class="nc bnc" id="L617" title="All 4 branches missed.">                            if (unmappableCharacterAction()</span>
                                == CodingErrorAction.REPLACE
                                &amp;&amp; currentMode != replaceMode) {
<span class="nc bnc" id="L620" title="All 2 branches missed.">                                if (dl - dp &lt; 3)</span>
<span class="nc" id="L621">                                    return CoderResult.OVERFLOW;</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">                                if (replaceMode == ASCII) {</span>
<span class="nc" id="L623">                                    da[dp++] = (byte)0x1b;</span>
<span class="nc" id="L624">                                    da[dp++] = (byte)0x28;</span>
<span class="nc" id="L625">                                    da[dp++] = (byte)0x42;</span>
                                } else {
<span class="nc" id="L627">                                    da[dp++] = (byte)0x1b;</span>
<span class="nc" id="L628">                                    da[dp++] = (byte)0x24;</span>
<span class="nc" id="L629">                                    da[dp++] = (byte)0x42;</span>
                                }
<span class="nc" id="L631">                                currentMode = replaceMode;</span>
                            }
<span class="nc bnc" id="L633" title="All 2 branches missed.">                            if (Character.isSurrogate(c))</span>
<span class="nc" id="L634">                                return sgp.unmappableResult();</span>
<span class="nc" id="L635">                            return CoderResult.unmappableForLength(1);</span>
                        }
                    }
<span class="nc" id="L638">                    sp++;</span>
<span class="nc" id="L639">                }</span>
<span class="nc" id="L640">                return CoderResult.UNDERFLOW;</span>
            } finally {
<span class="nc" id="L642">                src.position(sp - src.arrayOffset());</span>
<span class="nc" id="L643">                dst.position(dp - dst.arrayOffset());</span>
            }
        }

        private CoderResult encodeBufferLoop(CharBuffer src,
                                             ByteBuffer dst)
        {
<span class="nc" id="L650">            int mark = src.position();</span>
            try {
<span class="nc bnc" id="L652" title="All 2 branches missed.">                while (src.hasRemaining()) {</span>
<span class="nc" id="L653">                    char c = src.get();</span>

<span class="nc bnc" id="L655" title="All 2 branches missed.">                    if (c &lt;= '\u007F') {</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">                        if (currentMode != ASCII) {</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                            if (dst.remaining() &lt; 3)</span>
<span class="nc" id="L658">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L659">                            dst.put((byte)0x1b);</span>
<span class="nc" id="L660">                            dst.put((byte)0x28);</span>
<span class="nc" id="L661">                            dst.put((byte)0x42);</span>
<span class="nc" id="L662">                            currentMode = ASCII;</span>
                        }
<span class="nc bnc" id="L664" title="All 2 branches missed.">                        if (dst.remaining() &lt; 1)</span>
<span class="nc" id="L665">                            return CoderResult.OVERFLOW;</span>
<span class="nc" id="L666">                        dst.put((byte)c);</span>
<span class="nc bnc" id="L667" title="All 6 branches missed.">                    } else if (c &gt;= 0xff61 &amp;&amp; c &lt;= 0xff9f &amp;&amp; doSBKANA) {</span>
                        //Is it a single byte kana?
<span class="nc bnc" id="L669" title="All 2 branches missed.">                        if (currentMode != JISX0201_1976_KANA) {</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">                            if (dst.remaining() &lt; 3)</span>
<span class="nc" id="L671">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L672">                            dst.put((byte)0x1b);</span>
<span class="nc" id="L673">                            dst.put((byte)0x28);</span>
<span class="nc" id="L674">                            dst.put((byte)0x49);</span>
<span class="nc" id="L675">                            currentMode = JISX0201_1976_KANA;</span>
                        }
<span class="nc bnc" id="L677" title="All 2 branches missed.">                        if (dst.remaining() &lt; 1)</span>
<span class="nc" id="L678">                            return CoderResult.OVERFLOW;</span>
<span class="nc" id="L679">                        dst.put((byte)(c - 0xff40));</span>
<span class="nc bnc" id="L680" title="All 4 branches missed.">                    } else if (c == '\u00a5' || c == '\u203E') {</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                        if (currentMode != JISX0201_1976) {</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">                            if (dst.remaining() &lt; 3)</span>
<span class="nc" id="L683">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L684">                            dst.put((byte)0x1b);</span>
<span class="nc" id="L685">                            dst.put((byte)0x28);</span>
<span class="nc" id="L686">                            dst.put((byte)0x4a);</span>
<span class="nc" id="L687">                            currentMode = JISX0201_1976;</span>
                        }
<span class="nc bnc" id="L689" title="All 2 branches missed.">                        if (dst.remaining() &lt; 1)</span>
<span class="nc" id="L690">                            return CoderResult.OVERFLOW;</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">                        dst.put((c == '\u00A5')?(byte)0x5C:(byte)0x7e);</span>
                    } else {
<span class="nc" id="L693">                        int index = enc0208.encodeChar(c);</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">                        if (index != UNMAPPABLE_ENCODING) {</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">                            if (currentMode != JISX0208_1983) {</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                                if (dst.remaining() &lt; 3)</span>
<span class="nc" id="L697">                                    return CoderResult.OVERFLOW;</span>
<span class="nc" id="L698">                                dst.put((byte)0x1b);</span>
<span class="nc" id="L699">                                dst.put((byte)0x24);</span>
<span class="nc" id="L700">                                dst.put((byte)0x42);</span>
<span class="nc" id="L701">                                currentMode = JISX0208_1983;</span>
                            }
<span class="nc bnc" id="L703" title="All 2 branches missed.">                            if (dst.remaining() &lt; 2)</span>
<span class="nc" id="L704">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L705">                            dst.put((byte)(index &gt;&gt; 8));</span>
<span class="nc" id="L706">                            dst.put((byte)(index &amp; 0xff));</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">                        } else if (enc0212 != null &amp;&amp;</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                                   (index = enc0212.encodeChar(c)) != UNMAPPABLE_ENCODING) {</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                            if (currentMode != JISX0212_1990) {</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                                if (dst.remaining() &lt; 4)</span>
<span class="nc" id="L711">                                    return CoderResult.OVERFLOW;</span>
<span class="nc" id="L712">                                dst.put((byte)0x1b);</span>
<span class="nc" id="L713">                                dst.put((byte)0x24);</span>
<span class="nc" id="L714">                                dst.put((byte)0x28);</span>
<span class="nc" id="L715">                                dst.put((byte)0x44);</span>
<span class="nc" id="L716">                                currentMode = JISX0212_1990;</span>
                            }
<span class="nc bnc" id="L718" title="All 2 branches missed.">                            if (dst.remaining() &lt; 2)</span>
<span class="nc" id="L719">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L720">                            dst.put((byte)(index &gt;&gt; 8));</span>
<span class="nc" id="L721">                            dst.put((byte)(index &amp; 0xff));</span>
                        } else {
<span class="nc bnc" id="L723" title="All 4 branches missed.">                            if (Character.isSurrogate(c) &amp;&amp; sgp.parse(c, src) &lt; 0)</span>
<span class="nc" id="L724">                                return sgp.error();</span>
<span class="nc bnc" id="L725" title="All 4 branches missed.">                            if (unmappableCharacterAction() == CodingErrorAction.REPLACE</span>
                                &amp;&amp; currentMode != replaceMode) {
<span class="nc bnc" id="L727" title="All 2 branches missed.">                                if (dst.remaining() &lt; 3)</span>
<span class="nc" id="L728">                                    return CoderResult.OVERFLOW;</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                                if (replaceMode == ASCII) {</span>
<span class="nc" id="L730">                                    dst.put((byte)0x1b);</span>
<span class="nc" id="L731">                                    dst.put((byte)0x28);</span>
<span class="nc" id="L732">                                    dst.put((byte)0x42);</span>
                                } else {
<span class="nc" id="L734">                                    dst.put((byte)0x1b);</span>
<span class="nc" id="L735">                                    dst.put((byte)0x24);</span>
<span class="nc" id="L736">                                    dst.put((byte)0x42);</span>
                                }
<span class="nc" id="L738">                                currentMode = replaceMode;</span>
                            }
<span class="nc bnc" id="L740" title="All 2 branches missed.">                            if (Character.isSurrogate(c))</span>
<span class="nc" id="L741">                                return sgp.unmappableResult();</span>
<span class="nc" id="L742">                            return CoderResult.unmappableForLength(1);</span>
                        }
                    }
<span class="nc" id="L745">                    mark++;</span>
<span class="nc" id="L746">                }</span>
<span class="nc" id="L747">                return CoderResult.UNDERFLOW;</span>
              } finally {
<span class="nc" id="L749">                src.position(mark);</span>
            }
        }

        protected CoderResult encodeLoop(CharBuffer src,
                                         ByteBuffer dst)
        {
<span class="nc bnc" id="L756" title="All 4 branches missed.">            if (src.hasArray() &amp;&amp; dst.hasArray())</span>
<span class="nc" id="L757">                return encodeArrayLoop(src, dst);</span>
            else
<span class="nc" id="L759">                return encodeBufferLoop(src, dst);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>