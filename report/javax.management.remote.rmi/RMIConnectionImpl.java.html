<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RMIConnectionImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.management.remote.rmi</a> &gt; <span class="el_source">RMIConnectionImpl.java</span></div><h1>RMIConnectionImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2002, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.management.remote.rmi;

import java.io.IOException;
import java.rmi.MarshalledObject;
import java.rmi.UnmarshalException;
import java.rmi.server.Unreferenced;
import java.security.AccessControlContext;
import java.security.AccessController;
import java.security.Permission;
import java.security.PermissionCollection;
import java.security.Permissions;
import java.security.PrivilegedAction;
import java.security.PrivilegedActionException;
import java.security.PrivilegedExceptionAction;
import java.security.ProtectionDomain;
import java.util.Arrays;
import java.util.Collections;
import java.util.Map;
import java.util.Set;

import javax.management.*;
import javax.management.remote.JMXServerErrorException;
import javax.management.remote.NotificationResult;
import javax.management.remote.TargetedNotification;
import javax.security.auth.Subject;
import sun.reflect.misc.ReflectUtil;

import static com.sun.jmx.mbeanserver.Util.cast;
import com.sun.jmx.remote.internal.ServerCommunicatorAdmin;
import com.sun.jmx.remote.internal.ServerNotifForwarder;
import com.sun.jmx.remote.security.JMXSubjectDomainCombiner;
import com.sun.jmx.remote.security.SubjectDelegator;
import com.sun.jmx.remote.util.ClassLoaderWithRepository;
import com.sun.jmx.remote.util.ClassLogger;
import com.sun.jmx.remote.util.EnvHelp;
import com.sun.jmx.remote.util.OrderClassLoaders;

/**
 * &lt;p&gt;Implementation of the {@link RMIConnection} interface.  User
 * code will not usually reference this class.&lt;/p&gt;
 *
 * @since 1.5
 */
/*
 * Notice that we omit the type parameter from MarshalledObject everywhere,
 * even though it would add useful information to the documentation.  The
 * reason is that it was only added in Mustang (Java SE 6), whereas versions
 * 1.4 and 2.0 of the JMX API must be implementable on Tiger per our
 * commitments for JSR 255.
 */
public class RMIConnectionImpl implements RMIConnection, Unreferenced {

    /**
     * Constructs a new {@link RMIConnection}. This connection can be
     * used with either the JRMP or IIOP transport. This object does
     * not export itself: it is the responsibility of the caller to
     * export it appropriately (see {@link
     * RMIJRMPServerImpl#makeClient(String,Subject)} and {@link
     * RMIIIOPServerImpl#makeClient(String,Subject)}.
     *
     * @param rmiServer The RMIServerImpl object for which this
     * connection is created.  The behavior is unspecified if this
     * parameter is null.
     * @param connectionId The ID for this connection.  The behavior
     * is unspecified if this parameter is null.
     * @param defaultClassLoader The default ClassLoader to be used
     * when deserializing marshalled objects.  Can be null, to signify
     * the bootstrap class loader.
     * @param subject the authenticated subject to be used for
     * authorization.  Can be null, to signify that no subject has
     * been authenticated.
     * @param env the environment containing attributes for the new
     * &lt;code&gt;RMIServerImpl&lt;/code&gt;.  Can be null, equivalent to an
     * empty map.
     */
    public RMIConnectionImpl(RMIServerImpl rmiServer,
                             String connectionId,
                             ClassLoader defaultClassLoader,
                             Subject subject,
<span class="nc" id="L105">                             Map&lt;String,?&gt; env) {</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">        if (rmiServer == null || connectionId == null)</span>
<span class="nc" id="L107">            throw new NullPointerException(&quot;Illegal null argument&quot;);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (env == null)</span>
<span class="nc" id="L109">            env = Collections.emptyMap();</span>
<span class="nc" id="L110">        this.rmiServer = rmiServer;</span>
<span class="nc" id="L111">        this.connectionId = connectionId;</span>
<span class="nc" id="L112">        this.defaultClassLoader = defaultClassLoader;</span>

<span class="nc" id="L114">        this.subjectDelegator = new SubjectDelegator();</span>
<span class="nc" id="L115">        this.subject = subject;</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (subject == null) {</span>
<span class="nc" id="L117">            this.acc = null;</span>
<span class="nc" id="L118">            this.removeCallerContext = false;</span>
        } else {
<span class="nc" id="L120">            this.removeCallerContext =</span>
<span class="nc" id="L121">                SubjectDelegator.checkRemoveCallerContext(subject);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (this.removeCallerContext) {</span>
<span class="nc" id="L123">                this.acc =</span>
<span class="nc" id="L124">                    JMXSubjectDomainCombiner.getDomainCombinerContext(subject);</span>
            } else {
<span class="nc" id="L126">                this.acc =</span>
<span class="nc" id="L127">                    JMXSubjectDomainCombiner.getContext(subject);</span>
            }
        }
<span class="nc" id="L130">        this.mbeanServer = rmiServer.getMBeanServer();</span>

<span class="nc" id="L132">        final ClassLoader dcl = defaultClassLoader;</span>

<span class="nc" id="L134">        this.classLoaderWithRepository =</span>
<span class="nc" id="L135">            AccessController.doPrivileged(</span>
<span class="nc" id="L136">                new PrivilegedAction&lt;ClassLoaderWithRepository&gt;() {</span>
                    public ClassLoaderWithRepository run() {
<span class="nc" id="L138">                        return new ClassLoaderWithRepository(</span>
<span class="nc" id="L139">                                      mbeanServer.getClassLoaderRepository(),</span>
                                      dcl);
                    }
                },

<span class="nc" id="L144">                withPermissions( new MBeanPermission(&quot;*&quot;, &quot;getClassLoaderRepository&quot;),</span>
                                 new RuntimePermission(&quot;createClassLoader&quot;))
            );


<span class="nc" id="L149">        this.defaultContextClassLoader =</span>
<span class="nc" id="L150">            AccessController.doPrivileged(</span>
<span class="nc" id="L151">                new PrivilegedAction&lt;ClassLoader&gt;() {</span>
            @Override
                    public ClassLoader run() {
<span class="nc" id="L154">                        return new CombinedClassLoader(Thread.currentThread().getContextClassLoader(),</span>
                                dcl);
                    }
                });

<span class="nc" id="L159">        serverCommunicatorAdmin = new</span>
<span class="nc" id="L160">          RMIServerCommunicatorAdmin(EnvHelp.getServerConnectionTimeout(env));</span>

<span class="nc" id="L162">        this.env = env;</span>
<span class="nc" id="L163">    }</span>

    private static AccessControlContext withPermissions(Permission ... perms){
<span class="nc" id="L166">        Permissions col = new Permissions();</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">        for (Permission thePerm : perms ) {</span>
<span class="nc" id="L169">            col.add(thePerm);</span>
        }

<span class="nc" id="L172">        final ProtectionDomain pd = new ProtectionDomain(null, col);</span>
<span class="nc" id="L173">        return new AccessControlContext( new ProtectionDomain[] { pd });</span>
    }

    private synchronized ServerNotifForwarder getServerNotifFwd() {
        // Lazily created when first use. Mainly when
        // addNotificationListener is first called.
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (serverNotifForwarder == null)</span>
<span class="nc" id="L180">            serverNotifForwarder =</span>
                new ServerNotifForwarder(mbeanServer,
                                         env,
<span class="nc" id="L183">                                         rmiServer.getNotifBuffer(),</span>
                                         connectionId);
<span class="nc" id="L185">        return serverNotifForwarder;</span>
    }

    public String getConnectionId() throws IOException {
        // We should call reqIncomming() here... shouldn't we?
<span class="nc" id="L190">        return connectionId;</span>
    }

    public void close() throws IOException {
<span class="nc" id="L194">        final boolean debug = logger.debugOn();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        final String  idstr = (debug?&quot;[&quot;+this.toString()+&quot;]&quot;:null);</span>

<span class="nc" id="L197">        synchronized (this) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (terminated) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                if (debug) logger.debug(&quot;close&quot;,idstr + &quot; already terminated.&quot;);</span>
<span class="nc" id="L200">                return;</span>
            }

<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (debug) logger.debug(&quot;close&quot;,idstr + &quot; closing.&quot;);</span>

<span class="nc" id="L205">            terminated = true;</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (serverCommunicatorAdmin != null) {</span>
<span class="nc" id="L208">                serverCommunicatorAdmin.terminate();</span>
            }

<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (serverNotifForwarder != null) {</span>
<span class="nc" id="L212">                serverNotifForwarder.terminate();</span>
            }
<span class="nc" id="L214">        }</span>

<span class="nc" id="L216">        rmiServer.clientClosed(this);</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (debug) logger.debug(&quot;close&quot;,idstr + &quot; closed.&quot;);</span>
<span class="nc" id="L219">    }</span>

    public void unreferenced() {
<span class="nc" id="L222">        logger.debug(&quot;unreferenced&quot;, &quot;called&quot;);</span>
        try {
<span class="nc" id="L224">            close();</span>
<span class="nc" id="L225">            logger.debug(&quot;unreferenced&quot;, &quot;done&quot;);</span>
<span class="nc" id="L226">        } catch (IOException e) {</span>
<span class="nc" id="L227">            logger.fine(&quot;unreferenced&quot;, e);</span>
<span class="nc" id="L228">        }</span>
<span class="nc" id="L229">    }</span>

    //-------------------------------------------------------------------------
    // MBeanServerConnection Wrapper
    //-------------------------------------------------------------------------

    public ObjectInstance createMBean(String className,
                                      ObjectName name,
                                      Subject delegationSubject)
        throws
        ReflectionException,
        InstanceAlreadyExistsException,
        MBeanRegistrationException,
        MBeanException,
        NotCompliantMBeanException,
        IOException {
        try {
<span class="nc" id="L246">            final Object params[] =</span>
                new Object[] { className, name };

<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (logger.debugOn())</span>
<span class="nc" id="L250">                logger.debug(&quot;createMBean(String,ObjectName)&quot;,</span>
                             &quot;connectionId=&quot; + connectionId +&quot;, className=&quot; +
                             className+&quot;, name=&quot; + name);

<span class="nc" id="L254">            return (ObjectInstance)</span>
<span class="nc" id="L255">                doPrivilegedOperation(</span>
                  CREATE_MBEAN,
                  params,
                  delegationSubject);
<span class="nc" id="L259">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L260">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L262">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (e instanceof InstanceAlreadyExistsException)</span>
<span class="nc" id="L264">                throw (InstanceAlreadyExistsException) e;</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">            if (e instanceof MBeanRegistrationException)</span>
<span class="nc" id="L266">                throw (MBeanRegistrationException) e;</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">            if (e instanceof MBeanException)</span>
<span class="nc" id="L268">                throw (MBeanException) e;</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            if (e instanceof NotCompliantMBeanException)</span>
<span class="nc" id="L270">                throw (NotCompliantMBeanException) e;</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L272">                throw (IOException) e;</span>
<span class="nc" id="L273">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public ObjectInstance createMBean(String className,
                                      ObjectName name,
                                      ObjectName loaderName,
                                      Subject delegationSubject)
        throws
        ReflectionException,
        InstanceAlreadyExistsException,
        MBeanRegistrationException,
        MBeanException,
        NotCompliantMBeanException,
        InstanceNotFoundException,
        IOException {
        try {
<span class="nc" id="L290">            final Object params[] =</span>
                new Object[] { className, name, loaderName };

<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (logger.debugOn())</span>
<span class="nc" id="L294">                logger.debug(&quot;createMBean(String,ObjectName,ObjectName)&quot;,</span>
                      &quot;connectionId=&quot; + connectionId
                      +&quot;, className=&quot; + className
                      +&quot;, name=&quot; + name
                      +&quot;, loaderName=&quot; + loaderName);

<span class="nc" id="L300">            return (ObjectInstance)</span>
<span class="nc" id="L301">                doPrivilegedOperation(</span>
                  CREATE_MBEAN_LOADER,
                  params,
                  delegationSubject);
<span class="nc" id="L305">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L306">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L308">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if (e instanceof InstanceAlreadyExistsException)</span>
<span class="nc" id="L310">                throw (InstanceAlreadyExistsException) e;</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if (e instanceof MBeanRegistrationException)</span>
<span class="nc" id="L312">                throw (MBeanRegistrationException) e;</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">            if (e instanceof MBeanException)</span>
<span class="nc" id="L314">                throw (MBeanException) e;</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            if (e instanceof NotCompliantMBeanException)</span>
<span class="nc" id="L316">                throw (NotCompliantMBeanException) e;</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L318">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L320">                throw (IOException) e;</span>
<span class="nc" id="L321">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public ObjectInstance createMBean(String className,
                                      ObjectName name,
                                      MarshalledObject params,
                                      String signature[],
                                      Subject delegationSubject)
        throws
        ReflectionException,
        InstanceAlreadyExistsException,
        MBeanRegistrationException,
        MBeanException,
        NotCompliantMBeanException,
        IOException {

        final Object[] values;
<span class="nc" id="L340">        final boolean debug = logger.debugOn();</span>

<span class="nc bnc" id="L342" title="All 2 branches missed.">        if (debug) logger.debug(</span>
                  &quot;createMBean(String,ObjectName,Object[],String[])&quot;,
                  &quot;connectionId=&quot; + connectionId
                  +&quot;, unwrapping parameters using classLoaderWithRepository.&quot;);

<span class="nc" id="L347">        values =</span>
<span class="nc" id="L348">            nullIsEmpty(unwrap(params, classLoaderWithRepository, Object[].class));</span>

        try {
<span class="nc" id="L351">            final Object params2[] =</span>
                new Object[] { className, name, values,
<span class="nc" id="L353">                               nullIsEmpty(signature) };</span>

<span class="nc bnc" id="L355" title="All 2 branches missed.">            if (debug)</span>
<span class="nc" id="L356">               logger.debug(&quot;createMBean(String,ObjectName,Object[],String[])&quot;,</span>
                             &quot;connectionId=&quot; + connectionId
                             +&quot;, className=&quot; + className
                             +&quot;, name=&quot; + name
<span class="nc" id="L360">                             +&quot;, params=&quot; + objects(values)</span>
<span class="nc" id="L361">                             +&quot;, signature=&quot; + strings(signature));</span>

<span class="nc" id="L363">            return (ObjectInstance)</span>
<span class="nc" id="L364">                doPrivilegedOperation(</span>
                  CREATE_MBEAN_PARAMS,
                  params2,
                  delegationSubject);
<span class="nc" id="L368">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L369">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L371">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            if (e instanceof InstanceAlreadyExistsException)</span>
<span class="nc" id="L373">                throw (InstanceAlreadyExistsException) e;</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">            if (e instanceof MBeanRegistrationException)</span>
<span class="nc" id="L375">                throw (MBeanRegistrationException) e;</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">            if (e instanceof MBeanException)</span>
<span class="nc" id="L377">                throw (MBeanException) e;</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">            if (e instanceof NotCompliantMBeanException)</span>
<span class="nc" id="L379">                throw (NotCompliantMBeanException) e;</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L381">                throw (IOException) e;</span>
<span class="nc" id="L382">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public ObjectInstance createMBean(String className,
                                 ObjectName name,
                                 ObjectName loaderName,
                                 MarshalledObject params,
                                 String signature[],
                                 Subject delegationSubject)
        throws
        ReflectionException,
        InstanceAlreadyExistsException,
        MBeanRegistrationException,
        MBeanException,
        NotCompliantMBeanException,
        InstanceNotFoundException,
        IOException {

        final Object[] values;
<span class="nc" id="L403">        final boolean debug = logger.debugOn();</span>

<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (debug) logger.debug(</span>
                 &quot;createMBean(String,ObjectName,ObjectName,Object[],String[])&quot;,
                 &quot;connectionId=&quot; + connectionId
                 +&quot;, unwrapping params with MBean extended ClassLoader.&quot;);

<span class="nc" id="L410">        values = nullIsEmpty(unwrap(params,</span>
<span class="nc" id="L411">                                    getClassLoader(loaderName),</span>
                                    defaultClassLoader,
                                    Object[].class));

        try {
<span class="nc" id="L416">            final Object params2[] =</span>
               new Object[] { className, name, loaderName, values,
<span class="nc" id="L418">                              nullIsEmpty(signature) };</span>

<span class="nc bnc" id="L420" title="All 2 branches missed.">           if (debug) logger.debug(</span>
                 &quot;createMBean(String,ObjectName,ObjectName,Object[],String[])&quot;,
                 &quot;connectionId=&quot; + connectionId
                 +&quot;, className=&quot; + className
                 +&quot;, name=&quot; + name
                 +&quot;, loaderName=&quot; + loaderName
<span class="nc" id="L426">                 +&quot;, params=&quot; + objects(values)</span>
<span class="nc" id="L427">                 +&quot;, signature=&quot; + strings(signature));</span>

<span class="nc" id="L429">            return (ObjectInstance)</span>
<span class="nc" id="L430">                doPrivilegedOperation(</span>
                  CREATE_MBEAN_LOADER_PARAMS,
                  params2,
                  delegationSubject);
<span class="nc" id="L434">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L435">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L437">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">            if (e instanceof InstanceAlreadyExistsException)</span>
<span class="nc" id="L439">                throw (InstanceAlreadyExistsException) e;</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">            if (e instanceof MBeanRegistrationException)</span>
<span class="nc" id="L441">                throw (MBeanRegistrationException) e;</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if (e instanceof MBeanException)</span>
<span class="nc" id="L443">                throw (MBeanException) e;</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            if (e instanceof NotCompliantMBeanException)</span>
<span class="nc" id="L445">                throw (NotCompliantMBeanException) e;</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L447">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L449">                throw (IOException) e;</span>
<span class="nc" id="L450">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public void unregisterMBean(ObjectName name, Subject delegationSubject)
        throws
        InstanceNotFoundException,
        MBeanRegistrationException,
        IOException {
        try {
<span class="nc" id="L460">            final Object params[] = new Object[] { name };</span>

<span class="nc bnc" id="L462" title="All 2 branches missed.">            if (logger.debugOn()) logger.debug(&quot;unregisterMBean&quot;,</span>
                 &quot;connectionId=&quot; + connectionId
                 +&quot;, name=&quot;+name);

<span class="nc" id="L466">            doPrivilegedOperation(</span>
              UNREGISTER_MBEAN,
              params,
              delegationSubject);
<span class="nc" id="L470">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L471">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L473">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">            if (e instanceof MBeanRegistrationException)</span>
<span class="nc" id="L475">                throw (MBeanRegistrationException) e;</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L477">                throw (IOException) e;</span>
<span class="nc" id="L478">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
<span class="nc" id="L479">        }</span>
<span class="nc" id="L480">    }</span>

    public ObjectInstance getObjectInstance(ObjectName name,
                                            Subject delegationSubject)
        throws
        InstanceNotFoundException,
        IOException {

<span class="nc" id="L488">        checkNonNull(&quot;ObjectName&quot;, name);</span>

        try {
<span class="nc" id="L491">            final Object params[] = new Object[] { name };</span>

<span class="nc bnc" id="L493" title="All 2 branches missed.">            if (logger.debugOn()) logger.debug(&quot;getObjectInstance&quot;,</span>
                 &quot;connectionId=&quot; + connectionId
                 +&quot;, name=&quot;+name);

<span class="nc" id="L497">            return (ObjectInstance)</span>
<span class="nc" id="L498">                doPrivilegedOperation(</span>
                  GET_OBJECT_INSTANCE,
                  params,
                  delegationSubject);
<span class="nc" id="L502">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L503">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L505">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L507">                throw (IOException) e;</span>
<span class="nc" id="L508">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public Set&lt;ObjectInstance&gt;
        queryMBeans(ObjectName name,
                    MarshalledObject query,
                    Subject delegationSubject)
        throws IOException {
        final QueryExp queryValue;
<span class="nc" id="L519">        final boolean debug=logger.debugOn();</span>

<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (debug) logger.debug(&quot;queryMBeans&quot;,</span>
                 &quot;connectionId=&quot; + connectionId
                 +&quot; unwrapping query with defaultClassLoader.&quot;);

<span class="nc" id="L525">        queryValue = unwrap(query, defaultContextClassLoader, QueryExp.class);</span>

        try {
<span class="nc" id="L528">            final Object params[] = new Object[] { name, queryValue };</span>

<span class="nc bnc" id="L530" title="All 2 branches missed.">            if (debug) logger.debug(&quot;queryMBeans&quot;,</span>
                 &quot;connectionId=&quot; + connectionId
                 +&quot;, name=&quot;+name +&quot;, query=&quot;+query);

<span class="nc" id="L534">            return cast(</span>
<span class="nc" id="L535">                doPrivilegedOperation(</span>
                  QUERY_MBEANS,
                  params,
                  delegationSubject));
<span class="nc" id="L539">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L540">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L542">                throw (IOException) e;</span>
<span class="nc" id="L543">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public Set&lt;ObjectName&gt;
        queryNames(ObjectName name,
                   MarshalledObject query,
                   Subject delegationSubject)
        throws IOException {
        final QueryExp queryValue;
<span class="nc" id="L554">        final boolean debug=logger.debugOn();</span>

<span class="nc bnc" id="L556" title="All 2 branches missed.">        if (debug) logger.debug(&quot;queryNames&quot;,</span>
                 &quot;connectionId=&quot; + connectionId
                 +&quot; unwrapping query with defaultClassLoader.&quot;);

<span class="nc" id="L560">        queryValue = unwrap(query, defaultContextClassLoader, QueryExp.class);</span>

        try {
<span class="nc" id="L563">            final Object params[] = new Object[] { name, queryValue };</span>

<span class="nc bnc" id="L565" title="All 2 branches missed.">            if (debug) logger.debug(&quot;queryNames&quot;,</span>
                 &quot;connectionId=&quot; + connectionId
                 +&quot;, name=&quot;+name +&quot;, query=&quot;+query);

<span class="nc" id="L569">            return cast(</span>
<span class="nc" id="L570">                doPrivilegedOperation(</span>
                  QUERY_NAMES,
                  params,
                  delegationSubject));
<span class="nc" id="L574">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L575">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L577">                throw (IOException) e;</span>
<span class="nc" id="L578">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public boolean isRegistered(ObjectName name,
                                Subject delegationSubject) throws IOException {
        try {
<span class="nc" id="L585">            final Object params[] = new Object[] { name };</span>
<span class="nc" id="L586">            return ((Boolean)</span>
<span class="nc" id="L587">                doPrivilegedOperation(</span>
                  IS_REGISTERED,
                  params,
<span class="nc" id="L590">                  delegationSubject)).booleanValue();</span>
<span class="nc" id="L591">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L592">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L594">                throw (IOException) e;</span>
<span class="nc" id="L595">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public Integer getMBeanCount(Subject delegationSubject)
        throws IOException {
        try {
<span class="nc" id="L602">            final Object params[] = new Object[] { };</span>

<span class="nc bnc" id="L604" title="All 2 branches missed.">            if (logger.debugOn()) logger.debug(&quot;getMBeanCount&quot;,</span>
                 &quot;connectionId=&quot; + connectionId);

<span class="nc" id="L607">            return (Integer)</span>
<span class="nc" id="L608">                doPrivilegedOperation(</span>
                  GET_MBEAN_COUNT,
                  params,
                  delegationSubject);
<span class="nc" id="L612">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L613">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L615">                throw (IOException) e;</span>
<span class="nc" id="L616">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public Object getAttribute(ObjectName name,
                               String attribute,
                               Subject delegationSubject)
        throws
        MBeanException,
        AttributeNotFoundException,
        InstanceNotFoundException,
        ReflectionException,
        IOException {
        try {
<span class="nc" id="L630">            final Object params[] = new Object[] { name, attribute };</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">            if (logger.debugOn()) logger.debug(&quot;getAttribute&quot;,</span>
                                   &quot;connectionId=&quot; + connectionId
                                   +&quot;, name=&quot; + name
                                   +&quot;, attribute=&quot;+ attribute);

<span class="nc" id="L636">            return</span>
<span class="nc" id="L637">                doPrivilegedOperation(</span>
                  GET_ATTRIBUTE,
                  params,
                  delegationSubject);
<span class="nc" id="L641">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L642">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">            if (e instanceof MBeanException)</span>
<span class="nc" id="L644">                throw (MBeanException) e;</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">            if (e instanceof AttributeNotFoundException)</span>
<span class="nc" id="L646">                throw (AttributeNotFoundException) e;</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L648">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L650">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L652">                throw (IOException) e;</span>
<span class="nc" id="L653">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public AttributeList getAttributes(ObjectName name,
                                       String[] attributes,
                                       Subject delegationSubject)
        throws
        InstanceNotFoundException,
        ReflectionException,
        IOException {
        try {
<span class="nc" id="L665">            final Object params[] = new Object[] { name, attributes };</span>

<span class="nc bnc" id="L667" title="All 2 branches missed.">            if (logger.debugOn()) logger.debug(&quot;getAttributes&quot;,</span>
                                   &quot;connectionId=&quot; + connectionId
                                   +&quot;, name=&quot; + name
<span class="nc" id="L670">                                   +&quot;, attributes=&quot;+ strings(attributes));</span>

<span class="nc" id="L672">            return (AttributeList)</span>
<span class="nc" id="L673">                doPrivilegedOperation(</span>
                  GET_ATTRIBUTES,
                  params,
                  delegationSubject);
<span class="nc" id="L677">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L678">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L680">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L682">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L684">                throw (IOException) e;</span>
<span class="nc" id="L685">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public void setAttribute(ObjectName name,
                             MarshalledObject attribute,
                             Subject delegationSubject)
        throws
        InstanceNotFoundException,
        AttributeNotFoundException,
        InvalidAttributeValueException,
        MBeanException,
        ReflectionException,
        IOException {
        final Attribute attr;
<span class="nc" id="L701">        final boolean debug=logger.debugOn();</span>

<span class="nc bnc" id="L703" title="All 2 branches missed.">        if (debug) logger.debug(&quot;setAttribute&quot;,</span>
                 &quot;connectionId=&quot; + connectionId
                 +&quot; unwrapping attribute with MBean extended ClassLoader.&quot;);

<span class="nc" id="L707">        attr = unwrap(attribute,</span>
<span class="nc" id="L708">                      getClassLoaderFor(name),</span>
                      defaultClassLoader,
                      Attribute.class);

        try {
<span class="nc" id="L713">            final Object params[] = new Object[] { name, attr };</span>

<span class="nc bnc" id="L715" title="All 2 branches missed.">            if (debug) logger.debug(&quot;setAttribute&quot;,</span>
                             &quot;connectionId=&quot; + connectionId
                             +&quot;, name=&quot;+name
                             +&quot;, attribute=&quot;+attr);

<span class="nc" id="L720">            doPrivilegedOperation(</span>
              SET_ATTRIBUTE,
              params,
              delegationSubject);
<span class="nc" id="L724">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L725">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L727">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">            if (e instanceof AttributeNotFoundException)</span>
<span class="nc" id="L729">                throw (AttributeNotFoundException) e;</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">            if (e instanceof InvalidAttributeValueException)</span>
<span class="nc" id="L731">                throw (InvalidAttributeValueException) e;</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">            if (e instanceof MBeanException)</span>
<span class="nc" id="L733">                throw (MBeanException) e;</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L735">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L737">                throw (IOException) e;</span>
<span class="nc" id="L738">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
<span class="nc" id="L739">        }</span>
<span class="nc" id="L740">    }</span>

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public AttributeList setAttributes(ObjectName name,
                         MarshalledObject attributes,
                         Subject delegationSubject)
        throws
        InstanceNotFoundException,
        ReflectionException,
        IOException {
        final AttributeList attrlist;
<span class="nc" id="L751">        final boolean debug=logger.debugOn();</span>

<span class="nc bnc" id="L753" title="All 2 branches missed.">        if (debug) logger.debug(&quot;setAttributes&quot;,</span>
                 &quot;connectionId=&quot; + connectionId
                 +&quot; unwrapping attributes with MBean extended ClassLoader.&quot;);

<span class="nc" id="L757">        attrlist =</span>
<span class="nc" id="L758">            unwrap(attributes,</span>
<span class="nc" id="L759">                   getClassLoaderFor(name),</span>
                   defaultClassLoader,
                   AttributeList.class);

        try {
<span class="nc" id="L764">            final Object params[] = new Object[] { name, attrlist };</span>

<span class="nc bnc" id="L766" title="All 2 branches missed.">            if (debug) logger.debug(&quot;setAttributes&quot;,</span>
                             &quot;connectionId=&quot; + connectionId
                             +&quot;, name=&quot;+name
                             +&quot;, attributes=&quot;+attrlist);

<span class="nc" id="L771">            return (AttributeList)</span>
<span class="nc" id="L772">                doPrivilegedOperation(</span>
                  SET_ATTRIBUTES,
                  params,
                  delegationSubject);
<span class="nc" id="L776">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L777">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L779">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L781">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L783">                throw (IOException) e;</span>
<span class="nc" id="L784">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public Object invoke(ObjectName name,
                         String operationName,
                         MarshalledObject params,
                         String signature[],
                         Subject delegationSubject)
        throws
        InstanceNotFoundException,
        MBeanException,
        ReflectionException,
        IOException {

<span class="nc" id="L800">        checkNonNull(&quot;ObjectName&quot;, name);</span>
<span class="nc" id="L801">        checkNonNull(&quot;Operation name&quot;, operationName);</span>

        final Object[] values;
<span class="nc" id="L804">        final boolean debug=logger.debugOn();</span>

<span class="nc bnc" id="L806" title="All 2 branches missed.">        if (debug) logger.debug(&quot;invoke&quot;,</span>
                 &quot;connectionId=&quot; + connectionId
                 +&quot; unwrapping params with MBean extended ClassLoader.&quot;);

<span class="nc" id="L810">        values = nullIsEmpty(unwrap(params,</span>
<span class="nc" id="L811">                                    getClassLoaderFor(name),</span>
                                    defaultClassLoader,
                                    Object[].class));

        try {
<span class="nc" id="L816">            final Object params2[] =</span>
                new Object[] { name, operationName, values,
<span class="nc" id="L818">                               nullIsEmpty(signature) };</span>

<span class="nc bnc" id="L820" title="All 2 branches missed.">            if (debug) logger.debug(&quot;invoke&quot;,</span>
                             &quot;connectionId=&quot; + connectionId
                             +&quot;, name=&quot;+name
                             +&quot;, operationName=&quot;+operationName
<span class="nc" id="L824">                             +&quot;, params=&quot;+objects(values)</span>
<span class="nc" id="L825">                             +&quot;, signature=&quot;+strings(signature));</span>

<span class="nc" id="L827">            return</span>
<span class="nc" id="L828">                doPrivilegedOperation(</span>
                  INVOKE,
                  params2,
                  delegationSubject);
<span class="nc" id="L832">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L833">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L835">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">            if (e instanceof MBeanException)</span>
<span class="nc" id="L837">                throw (MBeanException) e;</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L839">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L841">                throw (IOException) e;</span>
<span class="nc" id="L842">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public String getDefaultDomain(Subject delegationSubject)
        throws IOException {
        try {
<span class="nc" id="L849">            final Object params[] = new Object[] { };</span>

<span class="nc bnc" id="L851" title="All 2 branches missed.">            if (logger.debugOn())  logger.debug(&quot;getDefaultDomain&quot;,</span>
                                    &quot;connectionId=&quot; + connectionId);

<span class="nc" id="L854">            return (String)</span>
<span class="nc" id="L855">                doPrivilegedOperation(</span>
                  GET_DEFAULT_DOMAIN,
                  params,
                  delegationSubject);
<span class="nc" id="L859">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L860">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L862">                throw (IOException) e;</span>
<span class="nc" id="L863">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public String[] getDomains(Subject delegationSubject) throws IOException {
        try {
<span class="nc" id="L869">            final Object params[] = new Object[] { };</span>

<span class="nc bnc" id="L871" title="All 2 branches missed.">            if (logger.debugOn())  logger.debug(&quot;getDomains&quot;,</span>
                                    &quot;connectionId=&quot; + connectionId);

<span class="nc" id="L874">            return (String[])</span>
<span class="nc" id="L875">                doPrivilegedOperation(</span>
                  GET_DOMAINS,
                  params,
                  delegationSubject);
<span class="nc" id="L879">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L880">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L882">                throw (IOException) e;</span>
<span class="nc" id="L883">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public MBeanInfo getMBeanInfo(ObjectName name, Subject delegationSubject)
        throws
        InstanceNotFoundException,
        IntrospectionException,
        ReflectionException,
        IOException {

<span class="nc" id="L894">        checkNonNull(&quot;ObjectName&quot;, name);</span>

        try {
<span class="nc" id="L897">            final Object params[] = new Object[] { name };</span>

<span class="nc bnc" id="L899" title="All 2 branches missed.">            if (logger.debugOn())  logger.debug(&quot;getMBeanInfo&quot;,</span>
                                    &quot;connectionId=&quot; + connectionId
                                    +&quot;, name=&quot;+name);

<span class="nc" id="L903">            return (MBeanInfo)</span>
<span class="nc" id="L904">                doPrivilegedOperation(</span>
                  GET_MBEAN_INFO,
                  params,
                  delegationSubject);
<span class="nc" id="L908">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L909">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L911">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">            if (e instanceof IntrospectionException)</span>
<span class="nc" id="L913">                throw (IntrospectionException) e;</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">            if (e instanceof ReflectionException)</span>
<span class="nc" id="L915">                throw (ReflectionException) e;</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L917">                throw (IOException) e;</span>
<span class="nc" id="L918">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    public boolean isInstanceOf(ObjectName name,
                                String className,
                                Subject delegationSubject)
        throws InstanceNotFoundException, IOException {

<span class="nc" id="L927">        checkNonNull(&quot;ObjectName&quot;, name);</span>

        try {
<span class="nc" id="L930">            final Object params[] = new Object[] { name, className };</span>

<span class="nc bnc" id="L932" title="All 2 branches missed.">            if (logger.debugOn())  logger.debug(&quot;isInstanceOf&quot;,</span>
                                    &quot;connectionId=&quot; + connectionId
                                    +&quot;, name=&quot;+name
                                    +&quot;, className=&quot;+className);

<span class="nc" id="L937">            return ((Boolean)</span>
<span class="nc" id="L938">                doPrivilegedOperation(</span>
                  IS_INSTANCE_OF,
                  params,
<span class="nc" id="L941">                  delegationSubject)).booleanValue();</span>
<span class="nc" id="L942">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L943">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L945">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L947">                throw (IOException) e;</span>
<span class="nc" id="L948">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
        }
    }

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public Integer[] addNotificationListeners(ObjectName[] names,
                      MarshalledObject[] filters,
                      Subject[] delegationSubjects)
            throws InstanceNotFoundException, IOException {

<span class="nc bnc" id="L958" title="All 4 branches missed.">        if (names == null || filters == null) {</span>
<span class="nc" id="L959">            throw new IllegalArgumentException(&quot;Got null arguments.&quot;);</span>
        }

<span class="nc bnc" id="L962" title="All 2 branches missed.">        Subject[] sbjs = (delegationSubjects != null) ? delegationSubjects :</span>
        new Subject[names.length];
<span class="nc bnc" id="L964" title="All 4 branches missed.">        if (names.length != filters.length || filters.length != sbjs.length) {</span>
            final String msg =
                &quot;The value lengths of 3 parameters are not same.&quot;;
<span class="nc" id="L967">            throw new IllegalArgumentException(msg);</span>
        }

<span class="nc bnc" id="L970" title="All 2 branches missed.">        for (int i=0; i&lt;names.length; i++) {</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">            if (names[i] == null) {</span>
<span class="nc" id="L972">                throw new IllegalArgumentException(&quot;Null Object name.&quot;);</span>
            }
        }

<span class="nc" id="L976">        int i=0;</span>
        ClassLoader targetCl;
<span class="nc" id="L978">        NotificationFilter[] filterValues =</span>
            new NotificationFilter[names.length];
<span class="nc" id="L980">        Integer[] ids = new Integer[names.length];</span>
<span class="nc" id="L981">        final boolean debug=logger.debugOn();</span>

        try {
<span class="nc bnc" id="L984" title="All 2 branches missed.">            for (; i&lt;names.length; i++) {</span>
<span class="nc" id="L985">                targetCl = getClassLoaderFor(names[i]);</span>

<span class="nc bnc" id="L987" title="All 2 branches missed.">                if (debug) logger.debug(&quot;addNotificationListener&quot;+</span>
                                        &quot;(ObjectName,NotificationFilter)&quot;,
                                        &quot;connectionId=&quot; + connectionId +
                      &quot; unwrapping filter with target extended ClassLoader.&quot;);

<span class="nc" id="L992">                filterValues[i] =</span>
<span class="nc" id="L993">                    unwrap(filters[i], targetCl, defaultClassLoader,</span>
                           NotificationFilter.class);

<span class="nc bnc" id="L996" title="All 2 branches missed.">                if (debug) logger.debug(&quot;addNotificationListener&quot;+</span>
                                        &quot;(ObjectName,NotificationFilter)&quot;,
                                        &quot;connectionId=&quot; + connectionId
                                        +&quot;, name=&quot; + names[i]
                                        +&quot;, filter=&quot; + filterValues[i]);

<span class="nc" id="L1002">                ids[i] = (Integer)</span>
<span class="nc" id="L1003">                    doPrivilegedOperation(ADD_NOTIFICATION_LISTENERS,</span>
                                          new Object[] { names[i],
                                                         filterValues[i] },
                                          sbjs[i]);
            }

<span class="nc" id="L1009">            return ids;</span>
<span class="nc" id="L1010">        } catch (Exception e) {</span>
            // remove all registered listeners
<span class="nc bnc" id="L1012" title="All 2 branches missed.">            for (int j=0; j&lt;i; j++) {</span>
                try {
<span class="nc" id="L1014">                    getServerNotifFwd().removeNotificationListener(names[j],</span>
                                                                   ids[j]);
<span class="nc" id="L1016">                } catch (Exception eee) {</span>
                    // strange
<span class="nc" id="L1018">                }</span>
            }

<span class="nc bnc" id="L1021" title="All 2 branches missed.">            if (e instanceof PrivilegedActionException) {</span>
<span class="nc" id="L1022">                e = extractException(e);</span>
            }

<span class="nc bnc" id="L1025" title="All 2 branches missed.">            if (e instanceof ClassCastException) {</span>
<span class="nc" id="L1026">                throw (ClassCastException) e;</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">            } else if (e instanceof IOException) {</span>
<span class="nc" id="L1028">                throw (IOException)e;</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">            } else if (e instanceof InstanceNotFoundException) {</span>
<span class="nc" id="L1030">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">            } else if (e instanceof RuntimeException) {</span>
<span class="nc" id="L1032">                throw (RuntimeException) e;</span>
            } else {
<span class="nc" id="L1034">                throw newIOException(&quot;Got unexpected server exception: &quot;+e,e);</span>
            }
        }
    }

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public void addNotificationListener(ObjectName name,
                       ObjectName listener,
                       MarshalledObject filter,
                       MarshalledObject handback,
                       Subject delegationSubject)
        throws InstanceNotFoundException, IOException {

<span class="nc" id="L1047">        checkNonNull(&quot;Target MBean name&quot;, name);</span>
<span class="nc" id="L1048">        checkNonNull(&quot;Listener MBean name&quot;, listener);</span>

        final NotificationFilter filterValue;
        final Object handbackValue;
<span class="nc" id="L1052">        final boolean debug=logger.debugOn();</span>

<span class="nc" id="L1054">        final ClassLoader targetCl = getClassLoaderFor(name);</span>

<span class="nc bnc" id="L1056" title="All 2 branches missed.">        if (debug) logger.debug(&quot;addNotificationListener&quot;+</span>
                 &quot;(ObjectName,ObjectName,NotificationFilter,Object)&quot;,
                 &quot;connectionId=&quot; + connectionId
                 +&quot; unwrapping filter with target extended ClassLoader.&quot;);

<span class="nc" id="L1061">        filterValue =</span>
<span class="nc" id="L1062">            unwrap(filter, targetCl, defaultClassLoader, NotificationFilter.class);</span>

<span class="nc bnc" id="L1064" title="All 2 branches missed.">        if (debug) logger.debug(&quot;addNotificationListener&quot;+</span>
                 &quot;(ObjectName,ObjectName,NotificationFilter,Object)&quot;,
                 &quot;connectionId=&quot; + connectionId
                 +&quot; unwrapping handback with target extended ClassLoader.&quot;);

<span class="nc" id="L1069">        handbackValue =</span>
<span class="nc" id="L1070">            unwrap(handback, targetCl, defaultClassLoader, Object.class);</span>

        try {
<span class="nc" id="L1073">            final Object params[] =</span>
                new Object[] { name, listener, filterValue, handbackValue };

<span class="nc bnc" id="L1076" title="All 2 branches missed.">            if (debug) logger.debug(&quot;addNotificationListener&quot;+</span>
                 &quot;(ObjectName,ObjectName,NotificationFilter,Object)&quot;,
                             &quot;connectionId=&quot; + connectionId
                             +&quot;, name=&quot; + name
                             +&quot;, listenerName=&quot; + listener
                             +&quot;, filter=&quot; + filterValue
                             +&quot;, handback=&quot; + handbackValue);

<span class="nc" id="L1084">            doPrivilegedOperation(</span>
              ADD_NOTIFICATION_LISTENER_OBJECTNAME,
              params,
              delegationSubject);
<span class="nc" id="L1088">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L1089">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L1091">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L1092" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L1093">                throw (IOException) e;</span>
<span class="nc" id="L1094">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
<span class="nc" id="L1095">        }</span>
<span class="nc" id="L1096">    }</span>

    public void removeNotificationListeners(ObjectName name,
                                            Integer[] listenerIDs,
                                            Subject delegationSubject)
        throws
        InstanceNotFoundException,
        ListenerNotFoundException,
        IOException {

<span class="nc bnc" id="L1106" title="All 4 branches missed.">        if (name == null || listenerIDs == null)</span>
<span class="nc" id="L1107">            throw new IllegalArgumentException(&quot;Illegal null parameter&quot;);</span>

<span class="nc bnc" id="L1109" title="All 2 branches missed.">        for (int i = 0; i &lt; listenerIDs.length; i++) {</span>
<span class="nc bnc" id="L1110" title="All 2 branches missed.">            if (listenerIDs[i] == null)</span>
<span class="nc" id="L1111">                throw new IllegalArgumentException(&quot;Null listener ID&quot;);</span>
        }

        try {
<span class="nc" id="L1115">            final Object params[] = new Object[] { name, listenerIDs };</span>

<span class="nc bnc" id="L1117" title="All 2 branches missed.">            if (logger.debugOn()) logger.debug(&quot;removeNotificationListener&quot;+</span>
                                   &quot;(ObjectName,Integer[])&quot;,
                                   &quot;connectionId=&quot; + connectionId
                                   +&quot;, name=&quot; + name
<span class="nc" id="L1121">                                   +&quot;, listenerIDs=&quot; + objects(listenerIDs));</span>

<span class="nc" id="L1123">            doPrivilegedOperation(</span>
              REMOVE_NOTIFICATION_LISTENER,
              params,
              delegationSubject);
<span class="nc" id="L1127">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L1128">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L1130">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">            if (e instanceof ListenerNotFoundException)</span>
<span class="nc" id="L1132">                throw (ListenerNotFoundException) e;</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L1134">                throw (IOException) e;</span>
<span class="nc" id="L1135">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
<span class="nc" id="L1136">        }</span>
<span class="nc" id="L1137">    }</span>

    public void removeNotificationListener(ObjectName name,
                                           ObjectName listener,
                                           Subject delegationSubject)
        throws
        InstanceNotFoundException,
        ListenerNotFoundException,
        IOException {

<span class="nc" id="L1147">        checkNonNull(&quot;Target MBean name&quot;, name);</span>
<span class="nc" id="L1148">        checkNonNull(&quot;Listener MBean name&quot;, listener);</span>

        try {
<span class="nc" id="L1151">            final Object params[] = new Object[] { name, listener };</span>

<span class="nc bnc" id="L1153" title="All 2 branches missed.">            if (logger.debugOn()) logger.debug(&quot;removeNotificationListener&quot;+</span>
                                   &quot;(ObjectName,ObjectName)&quot;,
                                   &quot;connectionId=&quot; + connectionId
                                   +&quot;, name=&quot; + name
                                   +&quot;, listenerName=&quot; + listener);

<span class="nc" id="L1159">            doPrivilegedOperation(</span>
              REMOVE_NOTIFICATION_LISTENER_OBJECTNAME,
              params,
              delegationSubject);
<span class="nc" id="L1163">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L1164">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L1166">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L1167" title="All 2 branches missed.">            if (e instanceof ListenerNotFoundException)</span>
<span class="nc" id="L1168">                throw (ListenerNotFoundException) e;</span>
<span class="nc bnc" id="L1169" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L1170">                throw (IOException) e;</span>
<span class="nc" id="L1171">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
<span class="nc" id="L1172">        }</span>
<span class="nc" id="L1173">    }</span>

    @SuppressWarnings(&quot;rawtypes&quot;)  // MarshalledObject
    public void removeNotificationListener(ObjectName name,
                        ObjectName listener,
                        MarshalledObject filter,
                        MarshalledObject handback,
                        Subject delegationSubject)
        throws
        InstanceNotFoundException,
        ListenerNotFoundException,
        IOException {

<span class="nc" id="L1186">        checkNonNull(&quot;Target MBean name&quot;, name);</span>
<span class="nc" id="L1187">        checkNonNull(&quot;Listener MBean name&quot;, listener);</span>

        final NotificationFilter filterValue;
        final Object handbackValue;
<span class="nc" id="L1191">        final boolean debug=logger.debugOn();</span>

<span class="nc" id="L1193">        final ClassLoader targetCl = getClassLoaderFor(name);</span>

<span class="nc bnc" id="L1195" title="All 2 branches missed.">        if (debug) logger.debug(&quot;removeNotificationListener&quot;+</span>
                 &quot;(ObjectName,ObjectName,NotificationFilter,Object)&quot;,
                 &quot;connectionId=&quot; + connectionId
                 +&quot; unwrapping filter with target extended ClassLoader.&quot;);

<span class="nc" id="L1200">        filterValue =</span>
<span class="nc" id="L1201">            unwrap(filter, targetCl, defaultClassLoader, NotificationFilter.class);</span>

<span class="nc bnc" id="L1203" title="All 2 branches missed.">        if (debug) logger.debug(&quot;removeNotificationListener&quot;+</span>
                 &quot;(ObjectName,ObjectName,NotificationFilter,Object)&quot;,
                 &quot;connectionId=&quot; + connectionId
                 +&quot; unwrapping handback with target extended ClassLoader.&quot;);

<span class="nc" id="L1208">        handbackValue =</span>
<span class="nc" id="L1209">            unwrap(handback, targetCl, defaultClassLoader, Object.class);</span>

        try {
<span class="nc" id="L1212">            final Object params[] =</span>
                new Object[] { name, listener, filterValue, handbackValue };

<span class="nc bnc" id="L1215" title="All 2 branches missed.">            if (debug) logger.debug(&quot;removeNotificationListener&quot;+</span>
                 &quot;(ObjectName,ObjectName,NotificationFilter,Object)&quot;,
                             &quot;connectionId=&quot; + connectionId
                             +&quot;, name=&quot; + name
                             +&quot;, listenerName=&quot; + listener
                             +&quot;, filter=&quot; + filterValue
                             +&quot;, handback=&quot; + handbackValue);

<span class="nc" id="L1223">            doPrivilegedOperation(</span>
              REMOVE_NOTIFICATION_LISTENER_OBJECTNAME_FILTER_HANDBACK,
              params,
              delegationSubject);
<span class="nc" id="L1227">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L1228">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">            if (e instanceof InstanceNotFoundException)</span>
<span class="nc" id="L1230">                throw (InstanceNotFoundException) e;</span>
<span class="nc bnc" id="L1231" title="All 2 branches missed.">            if (e instanceof ListenerNotFoundException)</span>
<span class="nc" id="L1232">                throw (ListenerNotFoundException) e;</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">            if (e instanceof IOException)</span>
<span class="nc" id="L1234">                throw (IOException) e;</span>
<span class="nc" id="L1235">            throw newIOException(&quot;Got unexpected server exception: &quot; + e, e);</span>
<span class="nc" id="L1236">        }</span>
<span class="nc" id="L1237">    }</span>

    public NotificationResult fetchNotifications(long clientSequenceNumber,
                                                 int maxNotifications,
                                                 long timeout)
        throws IOException {

<span class="nc bnc" id="L1244" title="All 2 branches missed.">        if (logger.debugOn()) logger.debug(&quot;fetchNotifications&quot;,</span>
                               &quot;connectionId=&quot; + connectionId
                               +&quot;, timeout=&quot; + timeout);

<span class="nc bnc" id="L1248" title="All 4 branches missed.">        if (maxNotifications &lt; 0 || timeout &lt; 0)</span>
<span class="nc" id="L1249">            throw new IllegalArgumentException(&quot;Illegal negative argument&quot;);</span>

<span class="nc" id="L1251">        final boolean serverTerminated =</span>
<span class="nc" id="L1252">            serverCommunicatorAdmin.reqIncoming();</span>
        try {
<span class="nc bnc" id="L1254" title="All 2 branches missed.">            if (serverTerminated) {</span>
                // we must not call fetchNotifs() if the server is
                // terminated (timeout elapsed).
                //
<span class="nc" id="L1258">                return new NotificationResult(0L, 0L,</span>
                                              new TargetedNotification[0]);

            }
<span class="nc" id="L1262">            final long csn = clientSequenceNumber;</span>
<span class="nc" id="L1263">            final int mn = maxNotifications;</span>
<span class="nc" id="L1264">            final long t = timeout;</span>
<span class="nc" id="L1265">            PrivilegedAction&lt;NotificationResult&gt; action =</span>
<span class="nc" id="L1266">                new PrivilegedAction&lt;NotificationResult&gt;() {</span>
                    public NotificationResult run() {
<span class="nc" id="L1268">                        return getServerNotifFwd().fetchNotifs(csn, t, mn);</span>
                    }
            };
<span class="nc bnc" id="L1271" title="All 2 branches missed.">            if (acc == null)</span>
<span class="nc" id="L1272">                return action.run();</span>
            else
<span class="nc" id="L1274">                return AccessController.doPrivileged(action, acc);</span>
        } finally {
<span class="nc" id="L1276">            serverCommunicatorAdmin.rspOutgoing();</span>
        }
    }

    /**
     * &lt;p&gt;Returns a string representation of this object.  In general,
     * the &lt;code&gt;toString&lt;/code&gt; method returns a string that
     * &quot;textually represents&quot; this object. The result should be a
     * concise but informative representation that is easy for a
     * person to read.&lt;/p&gt;
     *
     * @return a String representation of this object.
     **/
    @Override
    public String toString() {
<span class="nc" id="L1291">        return super.toString() + &quot;: connectionId=&quot; + connectionId;</span>
    }

    //------------------------------------------------------------------------
    // private classes
    //------------------------------------------------------------------------

    private class PrivilegedOperation
            implements PrivilegedExceptionAction&lt;Object&gt; {

<span class="nc" id="L1301">        public PrivilegedOperation(int operation, Object[] params) {</span>
<span class="nc" id="L1302">            this.operation = operation;</span>
<span class="nc" id="L1303">            this.params = params;</span>
<span class="nc" id="L1304">        }</span>

        public Object run() throws Exception {
<span class="nc" id="L1307">            return doOperation(operation, params);</span>
        }

        private int operation;
        private Object[] params;
    }

    //------------------------------------------------------------------------
    // private classes
    //------------------------------------------------------------------------
    private class RMIServerCommunicatorAdmin extends ServerCommunicatorAdmin {
<span class="nc" id="L1318">        public RMIServerCommunicatorAdmin(long timeout) {</span>
<span class="nc" id="L1319">            super(timeout);</span>
<span class="nc" id="L1320">        }</span>

        protected void doStop() {
            try {
<span class="nc" id="L1324">                close();</span>
<span class="nc" id="L1325">            } catch (IOException ie) {</span>
<span class="nc" id="L1326">                logger.warning(&quot;RMIServerCommunicatorAdmin-doStop&quot;,</span>
                               &quot;Failed to close: &quot; + ie);
<span class="nc" id="L1328">                logger.debug(&quot;RMIServerCommunicatorAdmin-doStop&quot;,ie);</span>
<span class="nc" id="L1329">            }</span>
<span class="nc" id="L1330">        }</span>

    }


    //------------------------------------------------------------------------
    // private methods
    //------------------------------------------------------------------------

    private ClassLoader getClassLoader(final ObjectName name)
        throws InstanceNotFoundException {
        try {
<span class="nc" id="L1342">            return</span>
<span class="nc" id="L1343">                AccessController.doPrivileged(</span>
<span class="nc" id="L1344">                    new PrivilegedExceptionAction&lt;ClassLoader&gt;() {</span>
                        public ClassLoader run() throws InstanceNotFoundException {
<span class="nc" id="L1346">                            return mbeanServer.getClassLoader(name);</span>
                        }
                    },
<span class="nc" id="L1349">                    withPermissions(new MBeanPermission(&quot;*&quot;, &quot;getClassLoader&quot;))</span>
            );
<span class="nc" id="L1351">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L1352">            throw (InstanceNotFoundException) extractException(pe);</span>
        }
    }

    private ClassLoader getClassLoaderFor(final ObjectName name)
        throws InstanceNotFoundException {
        try {
<span class="nc" id="L1359">            return (ClassLoader)</span>
<span class="nc" id="L1360">                AccessController.doPrivileged(</span>
<span class="nc" id="L1361">                    new PrivilegedExceptionAction&lt;Object&gt;() {</span>
                        public Object run() throws InstanceNotFoundException {
<span class="nc" id="L1363">                            return mbeanServer.getClassLoaderFor(name);</span>
                        }
                    },
<span class="nc" id="L1366">                    withPermissions(new MBeanPermission(&quot;*&quot;, &quot;getClassLoaderFor&quot;))</span>
            );
<span class="nc" id="L1368">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L1369">            throw (InstanceNotFoundException) extractException(pe);</span>
        }
    }

    private Object doPrivilegedOperation(final int operation,
                                         final Object[] params,
                                         final Subject delegationSubject)
        throws PrivilegedActionException, IOException {

<span class="nc" id="L1378">        serverCommunicatorAdmin.reqIncoming();</span>
        try {

            final AccessControlContext reqACC;
<span class="nc bnc" id="L1382" title="All 2 branches missed.">            if (delegationSubject == null)</span>
<span class="nc" id="L1383">                reqACC = acc;</span>
            else {
<span class="nc bnc" id="L1385" title="All 2 branches missed.">                if (subject == null) {</span>
                    final String msg =
                        &quot;Subject delegation cannot be enabled unless &quot; +
                        &quot;an authenticated subject is put in place&quot;;
<span class="nc" id="L1389">                    throw new SecurityException(msg);</span>
                }
<span class="nc" id="L1391">                reqACC = subjectDelegator.delegatedContext(</span>
                    acc, delegationSubject, removeCallerContext);
            }

<span class="nc" id="L1395">            PrivilegedOperation op =</span>
                new PrivilegedOperation(operation, params);
<span class="nc bnc" id="L1397" title="All 2 branches missed.">            if (reqACC == null) {</span>
                try {
<span class="nc" id="L1399">                    return op.run();</span>
<span class="nc" id="L1400">                } catch (Exception e) {</span>
<span class="nc bnc" id="L1401" title="All 2 branches missed.">                    if (e instanceof RuntimeException)</span>
<span class="nc" id="L1402">                        throw (RuntimeException) e;</span>
<span class="nc" id="L1403">                    throw new PrivilegedActionException(e);</span>
                }
            } else {
<span class="nc" id="L1406">                return AccessController.doPrivileged(op, reqACC);</span>
            }
<span class="nc" id="L1408">        } catch (Error e) {</span>
<span class="nc" id="L1409">            throw new JMXServerErrorException(e.toString(),e);</span>
        } finally {
<span class="nc" id="L1411">            serverCommunicatorAdmin.rspOutgoing();</span>
        }
    }

    private Object doOperation(int operation, Object[] params)
        throws Exception {

<span class="nc bnc" id="L1418" title="All 25 branches missed.">        switch (operation) {</span>

        case CREATE_MBEAN:
<span class="nc" id="L1421">            return mbeanServer.createMBean((String)params[0],</span>
                                           (ObjectName)params[1]);

        case CREATE_MBEAN_LOADER:
<span class="nc" id="L1425">            return mbeanServer.createMBean((String)params[0],</span>
                                           (ObjectName)params[1],
                                           (ObjectName)params[2]);

        case CREATE_MBEAN_PARAMS:
<span class="nc" id="L1430">            return mbeanServer.createMBean((String)params[0],</span>
                                           (ObjectName)params[1],
                                           (Object[])params[2],
                                           (String[])params[3]);

        case CREATE_MBEAN_LOADER_PARAMS:
<span class="nc" id="L1436">            return mbeanServer.createMBean((String)params[0],</span>
                                           (ObjectName)params[1],
                                           (ObjectName)params[2],
                                           (Object[])params[3],
                                           (String[])params[4]);

        case GET_ATTRIBUTE:
<span class="nc" id="L1443">            return mbeanServer.getAttribute((ObjectName)params[0],</span>
                                            (String)params[1]);

        case GET_ATTRIBUTES:
<span class="nc" id="L1447">            return mbeanServer.getAttributes((ObjectName)params[0],</span>
                                             (String[])params[1]);

        case GET_DEFAULT_DOMAIN:
<span class="nc" id="L1451">            return mbeanServer.getDefaultDomain();</span>

        case GET_DOMAINS:
<span class="nc" id="L1454">            return mbeanServer.getDomains();</span>

        case GET_MBEAN_COUNT:
<span class="nc" id="L1457">            return mbeanServer.getMBeanCount();</span>

        case GET_MBEAN_INFO:
<span class="nc" id="L1460">            return mbeanServer.getMBeanInfo((ObjectName)params[0]);</span>

        case GET_OBJECT_INSTANCE:
<span class="nc" id="L1463">            return mbeanServer.getObjectInstance((ObjectName)params[0]);</span>

        case INVOKE:
<span class="nc" id="L1466">            return mbeanServer.invoke((ObjectName)params[0],</span>
                                      (String)params[1],
                                      (Object[])params[2],
                                      (String[])params[3]);

        case IS_INSTANCE_OF:
<span class="nc bnc" id="L1472" title="All 2 branches missed.">            return mbeanServer.isInstanceOf((ObjectName)params[0],</span>
                                            (String)params[1])
                ? Boolean.TRUE : Boolean.FALSE;

        case IS_REGISTERED:
<span class="nc bnc" id="L1477" title="All 2 branches missed.">            return mbeanServer.isRegistered((ObjectName)params[0])</span>
                ? Boolean.TRUE : Boolean.FALSE;

        case QUERY_MBEANS:
<span class="nc" id="L1481">            return mbeanServer.queryMBeans((ObjectName)params[0],</span>
                                           (QueryExp)params[1]);

        case QUERY_NAMES:
<span class="nc" id="L1485">            return mbeanServer.queryNames((ObjectName)params[0],</span>
                                          (QueryExp)params[1]);

        case SET_ATTRIBUTE:
<span class="nc" id="L1489">            mbeanServer.setAttribute((ObjectName)params[0],</span>
                                     (Attribute)params[1]);
<span class="nc" id="L1491">            return null;</span>

        case SET_ATTRIBUTES:
<span class="nc" id="L1494">            return mbeanServer.setAttributes((ObjectName)params[0],</span>
                                             (AttributeList)params[1]);

        case UNREGISTER_MBEAN:
<span class="nc" id="L1498">            mbeanServer.unregisterMBean((ObjectName)params[0]);</span>
<span class="nc" id="L1499">            return null;</span>

        case ADD_NOTIFICATION_LISTENERS:
<span class="nc" id="L1502">            return getServerNotifFwd().addNotificationListener(</span>
                                                (ObjectName)params[0],
                                                (NotificationFilter)params[1]);

        case ADD_NOTIFICATION_LISTENER_OBJECTNAME:
<span class="nc" id="L1507">            mbeanServer.addNotificationListener((ObjectName)params[0],</span>
                                                (ObjectName)params[1],
                                                (NotificationFilter)params[2],
                                                params[3]);
<span class="nc" id="L1511">            return null;</span>

        case REMOVE_NOTIFICATION_LISTENER:
<span class="nc" id="L1514">            getServerNotifFwd().removeNotificationListener(</span>
                                                   (ObjectName)params[0],
                                                   (Integer[])params[1]);
<span class="nc" id="L1517">            return null;</span>

        case REMOVE_NOTIFICATION_LISTENER_OBJECTNAME:
<span class="nc" id="L1520">            mbeanServer.removeNotificationListener((ObjectName)params[0],</span>
                                                   (ObjectName)params[1]);
<span class="nc" id="L1522">            return null;</span>

        case REMOVE_NOTIFICATION_LISTENER_OBJECTNAME_FILTER_HANDBACK:
<span class="nc" id="L1525">            mbeanServer.removeNotificationListener(</span>
                                          (ObjectName)params[0],
                                          (ObjectName)params[1],
                                          (NotificationFilter)params[2],
                                          params[3]);
<span class="nc" id="L1530">            return null;</span>

        default:
<span class="nc" id="L1533">            throw new IllegalArgumentException(&quot;Invalid operation&quot;);</span>
        }
    }

    private static class SetCcl implements PrivilegedExceptionAction&lt;ClassLoader&gt; {
        private final ClassLoader classLoader;

<span class="nc" id="L1540">        SetCcl(ClassLoader classLoader) {</span>
<span class="nc" id="L1541">            this.classLoader = classLoader;</span>
<span class="nc" id="L1542">        }</span>

        public ClassLoader run() {
<span class="nc" id="L1545">            Thread currentThread = Thread.currentThread();</span>
<span class="nc" id="L1546">            ClassLoader old = currentThread.getContextClassLoader();</span>
<span class="nc" id="L1547">            currentThread.setContextClassLoader(classLoader);</span>
<span class="nc" id="L1548">            return old;</span>
        }
    }

    private static &lt;T&gt; T unwrap(final MarshalledObject&lt;?&gt; mo,
                                final ClassLoader cl,
                                final Class&lt;T&gt; wrappedClass)
            throws IOException {
<span class="nc bnc" id="L1556" title="All 2 branches missed.">        if (mo == null) {</span>
<span class="nc" id="L1557">            return null;</span>
        }
        try {
<span class="nc" id="L1560">            final ClassLoader old = AccessController.doPrivileged(new SetCcl(cl));</span>
            try {
<span class="nc" id="L1562">                return wrappedClass.cast(mo.get());</span>
<span class="nc" id="L1563">            } catch (ClassNotFoundException cnfe) {</span>
<span class="nc" id="L1564">                throw new UnmarshalException(cnfe.toString(), cnfe);</span>
            } finally {
<span class="nc" id="L1566">                AccessController.doPrivileged(new SetCcl(old));</span>
            }
<span class="nc" id="L1568">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L1569">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L1570" title="All 2 branches missed.">            if (e instanceof IOException) {</span>
<span class="nc" id="L1571">                throw (IOException) e;</span>
            }
<span class="nc bnc" id="L1573" title="All 2 branches missed.">            if (e instanceof ClassNotFoundException) {</span>
<span class="nc" id="L1574">                throw new UnmarshalException(e.toString(), e);</span>
            }
<span class="nc" id="L1576">            logger.warning(&quot;unwrap&quot;, &quot;Failed to unmarshall object: &quot; + e);</span>
<span class="nc" id="L1577">            logger.debug(&quot;unwrap&quot;, e);</span>
        }
<span class="nc" id="L1579">        return null;</span>
    }

    private static &lt;T&gt; T unwrap(final MarshalledObject&lt;?&gt; mo,
                                final ClassLoader cl1,
                                final ClassLoader cl2,
                                final Class&lt;T&gt; wrappedClass)
        throws IOException {
<span class="nc bnc" id="L1587" title="All 2 branches missed.">        if (mo == null) {</span>
<span class="nc" id="L1588">            return null;</span>
        }
        try {
<span class="nc" id="L1591">            ClassLoader orderCL = AccessController.doPrivileged(</span>
<span class="nc" id="L1592">                new PrivilegedExceptionAction&lt;ClassLoader&gt;() {</span>
                    public ClassLoader run() throws Exception {
<span class="nc" id="L1594">                        return new CombinedClassLoader(Thread.currentThread().getContextClassLoader(),</span>
                                new OrderClassLoaders(cl1, cl2));
                    }
                }
            );
<span class="nc" id="L1599">            return unwrap(mo, orderCL, wrappedClass);</span>
<span class="nc" id="L1600">        } catch (PrivilegedActionException pe) {</span>
<span class="nc" id="L1601">            Exception e = extractException(pe);</span>
<span class="nc bnc" id="L1602" title="All 2 branches missed.">            if (e instanceof IOException) {</span>
<span class="nc" id="L1603">                throw (IOException) e;</span>
            }
<span class="nc bnc" id="L1605" title="All 2 branches missed.">            if (e instanceof ClassNotFoundException) {</span>
<span class="nc" id="L1606">                throw new UnmarshalException(e.toString(), e);</span>
            }
<span class="nc" id="L1608">            logger.warning(&quot;unwrap&quot;, &quot;Failed to unmarshall object: &quot; + e);</span>
<span class="nc" id="L1609">            logger.debug(&quot;unwrap&quot;, e);</span>
        }
<span class="nc" id="L1611">        return null;</span>
    }

    /**
     * Construct a new IOException with a nested exception.
     * The nested exception is set only if JDK {@literal &gt;= 1.4}
     */
    private static IOException newIOException(String message,
                                              Throwable cause) {
<span class="nc" id="L1620">        final IOException x = new IOException(message);</span>
<span class="nc" id="L1621">        return EnvHelp.initCause(x,cause);</span>
    }

    /**
     * Iterate until we extract the real exception
     * from a stack of PrivilegedActionExceptions.
     */
    private static Exception extractException(Exception e) {
<span class="nc bnc" id="L1629" title="All 2 branches missed.">        while (e instanceof PrivilegedActionException) {</span>
<span class="nc" id="L1630">            e = ((PrivilegedActionException)e).getException();</span>
        }
<span class="nc" id="L1632">        return e;</span>
    }

<span class="nc" id="L1635">    private static final Object[] NO_OBJECTS = new Object[0];</span>
<span class="nc" id="L1636">    private static final String[] NO_STRINGS = new String[0];</span>

    /*
     * The JMX spec doesn't explicitly say that a null Object[] or
     * String[] in e.g. MBeanServer.invoke is equivalent to an empty
     * array, but the RI behaves that way.  In the interests of
     * maximal interoperability, we make it so even when we're
     * connected to some other JMX implementation that might not do
     * that.  This should be clarified in the next version of JMX.
     */
    private static Object[] nullIsEmpty(Object[] array) {
<span class="nc bnc" id="L1647" title="All 2 branches missed.">        return (array == null) ? NO_OBJECTS : array;</span>
    }

    private static String[] nullIsEmpty(String[] array) {
<span class="nc bnc" id="L1651" title="All 2 branches missed.">        return (array == null) ? NO_STRINGS : array;</span>
    }

    /*
     * Similarly, the JMX spec says for some but not all methods in
     * MBeanServer that take an ObjectName target, that if it's null
     * you get this exception.  We specify it for all of them, and
     * make it so for the ones where it's not specified in JMX even if
     * the JMX implementation doesn't do so.
     */
    private static void checkNonNull(String what, Object x) {
<span class="nc bnc" id="L1662" title="All 2 branches missed.">        if (x == null) {</span>
<span class="nc" id="L1663">            RuntimeException wrapped =</span>
                new IllegalArgumentException(what + &quot; must not be null&quot;);
<span class="nc" id="L1665">            throw new RuntimeOperationsException(wrapped);</span>
        }
<span class="nc" id="L1667">    }</span>

    //------------------------------------------------------------------------
    // private variables
    //------------------------------------------------------------------------

    private final Subject subject;

    private final SubjectDelegator subjectDelegator;

    private final boolean removeCallerContext;

    private final AccessControlContext acc;

    private final RMIServerImpl rmiServer;

    private final MBeanServer mbeanServer;

    private final ClassLoader defaultClassLoader;

    private final ClassLoader defaultContextClassLoader;

    private final ClassLoaderWithRepository classLoaderWithRepository;

<span class="nc" id="L1691">    private boolean terminated = false;</span>

    private final String connectionId;

    private final ServerCommunicatorAdmin serverCommunicatorAdmin;

    // Method IDs for doOperation
    //---------------------------

    private final static int
        ADD_NOTIFICATION_LISTENERS                              = 1;
    private final static int
        ADD_NOTIFICATION_LISTENER_OBJECTNAME                    = 2;
    private final static int
        CREATE_MBEAN                                            = 3;
    private final static int
        CREATE_MBEAN_PARAMS                                     = 4;
    private final static int
        CREATE_MBEAN_LOADER                                     = 5;
    private final static int
        CREATE_MBEAN_LOADER_PARAMS                              = 6;
    private final static int
        GET_ATTRIBUTE                                           = 7;
    private final static int
        GET_ATTRIBUTES                                          = 8;
    private final static int
        GET_DEFAULT_DOMAIN                                      = 9;
    private final static int
        GET_DOMAINS                                             = 10;
    private final static int
        GET_MBEAN_COUNT                                         = 11;
    private final static int
        GET_MBEAN_INFO                                          = 12;
    private final static int
        GET_OBJECT_INSTANCE                                     = 13;
    private final static int
        INVOKE                                                  = 14;
    private final static int
        IS_INSTANCE_OF                                          = 15;
    private final static int
        IS_REGISTERED                                           = 16;
    private final static int
        QUERY_MBEANS                                            = 17;
    private final static int
        QUERY_NAMES                                             = 18;
    private final static int
        REMOVE_NOTIFICATION_LISTENER                            = 19;
    private final static int
        REMOVE_NOTIFICATION_LISTENER_OBJECTNAME                 = 20;
    private final static int
        REMOVE_NOTIFICATION_LISTENER_OBJECTNAME_FILTER_HANDBACK = 21;
    private final static int
        SET_ATTRIBUTE                                           = 22;
    private final static int
        SET_ATTRIBUTES                                          = 23;
    private final static int
        UNREGISTER_MBEAN                                        = 24;

    // SERVER NOTIFICATION
    //--------------------

    private ServerNotifForwarder serverNotifForwarder;
    private Map&lt;String, ?&gt; env;

    // TRACES &amp; DEBUG
    //---------------

    private static String objects(final Object[] objs) {
<span class="nc bnc" id="L1759" title="All 2 branches missed.">        if (objs == null)</span>
<span class="nc" id="L1760">            return &quot;null&quot;;</span>
        else
<span class="nc" id="L1762">            return Arrays.asList(objs).toString();</span>
    }

    private static String strings(final String[] strs) {
<span class="nc" id="L1766">        return objects(strs);</span>
    }

<span class="nc" id="L1769">    private static final ClassLogger logger =</span>
        new ClassLogger(&quot;javax.management.remote.rmi&quot;, &quot;RMIConnectionImpl&quot;);

    private static final class CombinedClassLoader extends ClassLoader {

        private final static class ClassLoaderWrapper extends ClassLoader {
            ClassLoaderWrapper(ClassLoader cl) {
<span class="nc" id="L1776">                super(cl);</span>
<span class="nc" id="L1777">            }</span>

            @Override
            protected Class&lt;?&gt; loadClass(String name, boolean resolve)
                    throws ClassNotFoundException {
<span class="nc" id="L1782">                return super.loadClass(name, resolve);</span>
            }
        };

        final ClassLoaderWrapper defaultCL;

        private CombinedClassLoader(ClassLoader parent, ClassLoader defaultCL) {
<span class="nc" id="L1789">            super(parent);</span>
<span class="nc" id="L1790">            this.defaultCL = new ClassLoaderWrapper(defaultCL);</span>
<span class="nc" id="L1791">        }</span>

        @Override
        protected Class&lt;?&gt; loadClass(String name, boolean resolve)
        throws ClassNotFoundException {
<span class="nc" id="L1796">            ReflectUtil.checkPackageAccess(name);</span>
            try {
<span class="nc" id="L1798">                super.loadClass(name, resolve);</span>
<span class="nc" id="L1799">            } catch(Exception e) {</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">                for(Throwable t = e; t != null; t = t.getCause()) {</span>
<span class="nc bnc" id="L1801" title="All 2 branches missed.">                    if(t instanceof SecurityException) {</span>
<span class="nc bnc" id="L1802" title="All 2 branches missed.">                        throw t==e?(SecurityException)t:new SecurityException(t.getMessage(), e);</span>
                    }
                }
<span class="nc" id="L1805">            }</span>
<span class="nc" id="L1806">            final Class&lt;?&gt; cl = defaultCL.loadClass(name, resolve);</span>
<span class="nc" id="L1807">            return cl;</span>
        }

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>