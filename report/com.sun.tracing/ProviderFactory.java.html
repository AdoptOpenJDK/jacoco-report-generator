<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ProviderFactory.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.tracing</a> &gt; <span class="el_source">ProviderFactory.java</span></div><h1>ProviderFactory.java</h1><pre class="source lang-java linenums">
package com.sun.tracing;

import java.util.HashSet;
import java.io.PrintStream;
import java.lang.reflect.Field;
import java.security.AccessController;
import java.security.PrivilegedActionException;
import java.security.PrivilegedExceptionAction;
import sun.security.action.GetPropertyAction;

import sun.tracing.NullProviderFactory;
import sun.tracing.PrintStreamProviderFactory;
import sun.tracing.MultiplexProviderFactory;
import sun.tracing.dtrace.DTraceProviderFactory;

/**
 * {@code ProviderFactory} is a factory class used to create instances of
 * providers.
 *
 * To enable tracing in an application, this class must be used to create
 * instances of the provider interfaces defined by users.
 * The system-defined factory is obtained by using the
 * {@code getDefaultFactory()} static method.  The resulting instance can be
 * used to create any number of providers.
 *
 * @since 1.7
 */
public abstract class ProviderFactory {

<span class="nc" id="L31">    protected ProviderFactory() {}</span>

    /**
     * Creates an implementation of a Provider interface.
     *
     * @param cls the provider interface to be defined.
     * @return an implementation of {@code cls}, whose methods, when called,
     * will trigger tracepoints in the application.
     * @throws NullPointerException if cls is null
     * @throws IllegalArgumentException if the class definition contains
     * non-void methods
     */
    public abstract &lt;T extends Provider&gt; T createProvider(Class&lt;T&gt; cls);

    /**
     * Returns an implementation of a {@code ProviderFactory} which
     * creates instances of Providers.
     *
     * The created Provider instances will be linked to all appropriate
     * and enabled system-defined tracing mechanisms in the JDK.
     *
     * @return a {@code ProviderFactory} that is used to create Providers.
     */
    public static ProviderFactory getDefaultFactory() {
<span class="nc" id="L55">        HashSet&lt;ProviderFactory&gt; factories = new HashSet&lt;ProviderFactory&gt;();</span>

        // Try to instantiate a DTraceProviderFactory
<span class="nc" id="L58">        String prop = AccessController.doPrivileged(</span>
            new GetPropertyAction(&quot;com.sun.tracing.dtrace&quot;));

<span class="nc bnc" id="L61" title="All 4 branches missed.">        if ( (prop == null || !prop.equals(&quot;disable&quot;)) &amp;&amp;</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">             DTraceProviderFactory.isSupported() ) {</span>
<span class="nc" id="L63">            factories.add(new DTraceProviderFactory());</span>
        }

        // Try to instantiate an output stream factory
<span class="nc" id="L67">        prop = AccessController.doPrivileged(</span>
            new GetPropertyAction(&quot;sun.tracing.stream&quot;));
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (prop != null) {</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            for (String spec : prop.split(&quot;,&quot;)) {</span>
<span class="nc" id="L71">                PrintStream ps = getPrintStreamFromSpec(spec);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">                if (ps != null) {</span>
<span class="nc" id="L73">                    factories.add(new PrintStreamProviderFactory(ps));</span>
                }
            }
        }

        // See how many factories we instantiated, and return an appropriate
        // factory that encapsulates that.
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (factories.size() == 0) {</span>
<span class="nc" id="L81">            return new NullProviderFactory();</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        } else if (factories.size() == 1) {</span>
<span class="nc" id="L83">            return factories.toArray(new ProviderFactory[1])[0];</span>
        } else {
<span class="nc" id="L85">            return new MultiplexProviderFactory(factories);</span>
        }
    }

    private static PrintStream getPrintStreamFromSpec(final String spec) {
        try {
            // spec is in the form of &lt;class&gt;.&lt;field&gt;, where &lt;class&gt; is
            // a fully specified class name, and &lt;field&gt; is a static member
            // in that class.  The &lt;field&gt; must be a 'PrintStream' or subtype
            // in order to be used.
<span class="nc" id="L95">            final int fieldpos = spec.lastIndexOf('.');</span>
<span class="nc" id="L96">            final Class&lt;?&gt; cls = Class.forName(spec.substring(0, fieldpos));</span>

<span class="nc" id="L98">            Field f = AccessController.doPrivileged(new PrivilegedExceptionAction&lt;Field&gt;() {</span>
                public Field run() throws NoSuchFieldException {
<span class="nc" id="L100">                    return cls.getField(spec.substring(fieldpos + 1));</span>
                }
            });

<span class="nc" id="L104">            return (PrintStream)f.get(null);</span>
<span class="nc" id="L105">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L106">            throw new AssertionError(e);</span>
<span class="nc" id="L107">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L108">            throw new AssertionError(e);</span>
<span class="nc" id="L109">        } catch (PrivilegedActionException e) {</span>
<span class="nc" id="L110">            throw new AssertionError(e);</span>
        }
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>