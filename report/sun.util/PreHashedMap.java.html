<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PreHashedMap.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.util</a> &gt; <span class="el_source">PreHashedMap.java</span></div><h1>PreHashedMap.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.util;

import java.util.Iterator;
import java.util.Map;
import java.util.Set;
import java.util.AbstractMap;
import java.util.AbstractSet;
import java.util.NoSuchElementException;


/**
 * A precomputed hash map.
 *
 * &lt;p&gt; Subclasses of this class are of the following form:
 *
 * &lt;blockquote&gt;&lt;pre&gt;
 * class JDKMap
 *     extends sun.util.PreHashedMap&amp;lt;String&amp;gt;
 * {
 *
 *     private JDKMap() {
 *         super(ROWS, SIZE, SHIFT, MASK);
 *     }
 *
 *     protected void init(Object[] ht) {
 *         ht[0] = new Object[] { &quot;key-1&quot;, value_1 };
 *         ht[1] = new Object[] { &quot;key-2&quot;, value_2,
 *                      new Object { &quot;key-3&quot;, value_3 } };
 *         ...
 *     }
 *
 * }&lt;/pre&gt;&lt;/blockquote&gt;
 *
 * &lt;p&gt; The &lt;tt&gt;init&lt;/tt&gt; method is invoked by the &lt;tt&gt;PreHashedMap&lt;/tt&gt;
 * constructor with an object array long enough for the map's rows.  The method
 * must construct the hash chain for each row and store it in the appropriate
 * element of the array.
 *
 * &lt;p&gt; Each entry in the map is represented by a unique hash-chain node.  The
 * final node of a hash chain is a two-element object array whose first element
 * is the entry's key and whose second element is the entry's value.  A
 * non-final node of a hash chain is a three-element object array whose first
 * two elements are the entry's key and value and whose third element is the
 * next node in the chain.
 *
 * &lt;p&gt; Instances of this class are mutable and are not safe for concurrent
 * access.  They may be made immutable and thread-safe via the appropriate
 * methods in the {@link java.util.Collections} utility class.
 *
 * &lt;p&gt; In the JDK build, subclasses of this class are typically created via the
 * &lt;tt&gt;Hasher&lt;/tt&gt; program in the &lt;tt&gt;make/tools/Hasher&lt;/tt&gt; directory.
 *
 * @author Mark Reinhold
 * @since 1.5
 *
 * @see java.util.AbstractMap
 */

public abstract class PreHashedMap&lt;V&gt;
    extends AbstractMap&lt;String,V&gt;
{

    private final int rows;
    private final int size;
    private final int shift;
    private final int mask;
    private final Object[] ht;

    /**
     * Creates a new map.
     *
     * &lt;p&gt; This constructor invokes the {@link #init init} method, passing it a
     * newly-constructed row array that is &lt;tt&gt;rows&lt;/tt&gt; elements long.
     *
     * @param rows
     *        The number of rows in the map
     * @param size
     *        The number of entries in the map
     * @param shift
     *        The value by which hash codes are right-shifted
     * @param mask
     *        The value with which hash codes are masked after being shifted
     */
<span class="fc" id="L109">    protected PreHashedMap(int rows, int size, int shift, int mask) {</span>
<span class="fc" id="L110">        this.rows = rows;</span>
<span class="fc" id="L111">        this.size = size;</span>
<span class="fc" id="L112">        this.shift = shift;</span>
<span class="fc" id="L113">        this.mask = mask;</span>
<span class="fc" id="L114">        this.ht = new Object[rows];</span>
<span class="fc" id="L115">        init(ht);</span>
<span class="fc" id="L116">    }</span>

    /**
     * Initializes this map.
     *
     * &lt;p&gt; This method must construct the map's hash chains and store them into
     * the appropriate elements of the given hash-table row array.
     *
     * @param rows
     *        The row array to be initialized
     */
    protected abstract void init(Object[] ht);

    @SuppressWarnings(&quot;unchecked&quot;)
    private V toV(Object x) {
<span class="fc" id="L131">        return (V)x;</span>
    }

    public V get(Object k) {
<span class="fc" id="L135">        int h = (k.hashCode() &gt;&gt; shift) &amp; mask;</span>
<span class="fc" id="L136">        Object[] a = (Object[])ht[h];</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">        if (a == null) return null;</span>
        for (;;) {
<span class="fc bfc" id="L139" title="All 2 branches covered.">            if (a[0].equals(k))</span>
<span class="fc" id="L140">                return toV(a[1]);</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">            if (a.length &lt; 3)</span>
<span class="fc" id="L142">                return null;</span>
<span class="fc" id="L143">            a = (Object[])a[2];</span>
        }
    }

    /**
     * @throws UnsupportedOperationException
     *         If the given key is not part of this map's initial key set
     */
    public V put(String k, V v) {
<span class="fc" id="L152">        int h = (k.hashCode() &gt;&gt; shift) &amp; mask;</span>
<span class="fc" id="L153">        Object[] a = (Object[])ht[h];</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (a == null)</span>
<span class="nc" id="L155">            throw new UnsupportedOperationException(k);</span>
        for (;;) {
<span class="fc bfc" id="L157" title="All 2 branches covered.">            if (a[0].equals(k)) {</span>
<span class="fc" id="L158">                V ov = toV(a[1]);</span>
<span class="fc" id="L159">                a[1] = v;</span>
<span class="fc" id="L160">                return ov;</span>
            }
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">            if (a.length &lt; 3)</span>
<span class="nc" id="L163">                throw new UnsupportedOperationException(k);</span>
<span class="fc" id="L164">            a = (Object[])a[2];</span>
        }
    }

    public Set&lt;String&gt; keySet() {
<span class="fc" id="L169">        return new AbstractSet&lt;String&gt; () {</span>

            public int size() {
<span class="nc" id="L172">                return size;</span>
            }

            public Iterator&lt;String&gt; iterator() {
<span class="fc" id="L176">                return new Iterator&lt;String&gt;() {</span>
<span class="fc" id="L177">                    private int i = -1;</span>
<span class="fc" id="L178">                    Object[] a = null;</span>
<span class="fc" id="L179">                    String cur = null;</span>

                    private boolean findNext() {
<span class="fc bfc" id="L182" title="All 2 branches covered.">                        if (a != null) {</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">                            if (a.length == 3) {</span>
<span class="fc" id="L184">                                a = (Object[])a[2];</span>
<span class="fc" id="L185">                                cur = (String)a[0];</span>
<span class="fc" id="L186">                                return true;</span>
                            }
<span class="fc" id="L188">                            i++;</span>
<span class="fc" id="L189">                            a = null;</span>
                        }
<span class="fc" id="L191">                        cur = null;</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">                        if (i &gt;= rows)</span>
<span class="fc" id="L193">                            return false;</span>
<span class="fc bfc" id="L194" title="All 4 branches covered.">                        if (i &lt; 0 || ht[i] == null) {</span>
                            do {
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">                                if (++i &gt;= rows)</span>
<span class="nc" id="L197">                                    return false;</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">                            } while (ht[i] == null);</span>
                        }
<span class="fc" id="L200">                        a = (Object[])ht[i];</span>
<span class="fc" id="L201">                        cur = (String)a[0];</span>
<span class="fc" id="L202">                        return true;</span>
                    }

                    public boolean hasNext() {
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">                        if (cur != null)</span>
<span class="nc" id="L207">                            return true;</span>
<span class="fc" id="L208">                        return findNext();</span>
                    }

                    public String next() {
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">                        if (cur == null) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                            if (!findNext())</span>
<span class="nc" id="L214">                                throw new NoSuchElementException();</span>
                        }
<span class="fc" id="L216">                        String s = cur;</span>
<span class="fc" id="L217">                        cur = null;</span>
<span class="fc" id="L218">                        return s;</span>
                    }

                    public void remove() {
<span class="nc" id="L222">                        throw new UnsupportedOperationException();</span>
                    }

                };
            }
        };
    }

    public Set&lt;Map.Entry&lt;String,V&gt;&gt; entrySet() {
<span class="nc" id="L231">        return new AbstractSet&lt;Map.Entry&lt;String,V&gt;&gt; () {</span>

            public int size() {
<span class="nc" id="L234">                return size;</span>
            }

            public Iterator&lt;Map.Entry&lt;String,V&gt;&gt; iterator() {
<span class="nc" id="L238">                return new Iterator&lt;Map.Entry&lt;String,V&gt;&gt;() {</span>
<span class="nc" id="L239">                    final Iterator&lt;String&gt; i = keySet().iterator();</span>

                    public boolean hasNext() {
<span class="nc" id="L242">                        return i.hasNext();</span>
                    }

                    public Map.Entry&lt;String,V&gt; next() {
<span class="nc" id="L246">                        return new Map.Entry&lt;String,V&gt;() {</span>
<span class="nc" id="L247">                            String k = i.next();</span>
<span class="nc" id="L248">                            public String getKey() { return k; }</span>
<span class="nc" id="L249">                            public V getValue() { return get(k); }</span>
                            public int hashCode() {
<span class="nc" id="L251">                                V v = get(k);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                                return (k.hashCode()</span>
                                        + (v == null
                                           ? 0
<span class="nc" id="L255">                                           : v.hashCode()));</span>
                            }
                            public boolean equals(Object ob) {
<span class="nc bnc" id="L258" title="All 2 branches missed.">                                if (ob == this)</span>
<span class="nc" id="L259">                                    return true;</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                                if (!(ob instanceof Map.Entry))</span>
<span class="nc" id="L261">                                    return false;</span>
<span class="nc" id="L262">                                Map.Entry&lt;?,?&gt; that = (Map.Entry&lt;?,?&gt;)ob;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                                return ((this.getKey() == null</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                                         ? that.getKey() == null</span>
<span class="nc" id="L265">                                         : this.getKey()</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">                                               .equals(that.getKey()))</span>
                                        &amp;&amp;
<span class="nc bnc" id="L268" title="All 2 branches missed.">                                        (this.getValue() == null</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                                         ? that.getValue() == null</span>
<span class="nc" id="L270">                                         : this.getValue()</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                                               .equals(that.getValue())));</span>
                            }
                            public V setValue(V v) {
<span class="nc" id="L274">                                throw new UnsupportedOperationException();</span>
                            }
                        };
                    }

                    public void remove() {
<span class="nc" id="L280">                        throw new UnsupportedOperationException();</span>
                    }

                };
            }
        };
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>