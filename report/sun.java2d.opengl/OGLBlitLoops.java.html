<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>OGLBlitLoops.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.java2d.opengl</a> &gt; <span class="el_source">OGLBlitLoops.java</span></div><h1>OGLBlitLoops.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2003, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.java2d.opengl;

import java.awt.AlphaComposite;
import java.awt.Composite;
import java.awt.Transparency;
import java.awt.geom.AffineTransform;
import java.awt.image.AffineTransformOp;
import java.awt.image.BufferedImage;
import java.awt.image.BufferedImageOp;
import java.lang.ref.WeakReference;
import sun.java2d.SurfaceData;
import sun.java2d.loops.Blit;
import sun.java2d.loops.CompositeType;
import sun.java2d.loops.GraphicsPrimitive;
import sun.java2d.loops.GraphicsPrimitiveMgr;
import sun.java2d.loops.ScaledBlit;
import sun.java2d.loops.SurfaceType;
import sun.java2d.loops.TransformBlit;
import sun.java2d.pipe.Region;
import sun.java2d.pipe.RenderBuffer;
import sun.java2d.pipe.RenderQueue;
import static sun.java2d.pipe.BufferedOpCodes.*;
import java.lang.annotation.Native;

<span class="nc" id="L50">class OGLBlitLoops {</span>

    static void register() {
<span class="nc" id="L53">        Blit blitIntArgbPreToSurface =</span>
            new OGLSwToSurfaceBlit(SurfaceType.IntArgbPre,
                                   OGLSurfaceData.PF_INT_ARGB_PRE);
<span class="nc" id="L56">        Blit blitIntArgbPreToTexture =</span>
            new OGLSwToTextureBlit(SurfaceType.IntArgbPre,
                                   OGLSurfaceData.PF_INT_ARGB_PRE);

<span class="nc" id="L60">        GraphicsPrimitive[] primitives = {</span>
            // surface-&gt;surface ops
            new OGLSurfaceToSurfaceBlit(),
            new OGLSurfaceToSurfaceScale(),
            new OGLSurfaceToSurfaceTransform(),

            // render-to-texture surface-&gt;surface ops
            new OGLRTTSurfaceToSurfaceBlit(),
            new OGLRTTSurfaceToSurfaceScale(),
            new OGLRTTSurfaceToSurfaceTransform(),

            // surface-&gt;sw ops
            new OGLSurfaceToSwBlit(SurfaceType.IntArgb,
                                   OGLSurfaceData.PF_INT_ARGB),

            // sw-&gt;surface ops
            blitIntArgbPreToSurface,
            new OGLSwToSurfaceBlit(SurfaceType.IntRgb,
                                   OGLSurfaceData.PF_INT_RGB),
            new OGLSwToSurfaceBlit(SurfaceType.IntRgbx,
                                   OGLSurfaceData.PF_INT_RGBX),
            new OGLSwToSurfaceBlit(SurfaceType.IntBgr,
                                   OGLSurfaceData.PF_INT_BGR),
            new OGLSwToSurfaceBlit(SurfaceType.IntBgrx,
                                   OGLSurfaceData.PF_INT_BGRX),
            new OGLSwToSurfaceBlit(SurfaceType.ThreeByteBgr,
                                   OGLSurfaceData.PF_3BYTE_BGR),
            new OGLSwToSurfaceBlit(SurfaceType.Ushort565Rgb,
                                   OGLSurfaceData.PF_USHORT_565_RGB),
            new OGLSwToSurfaceBlit(SurfaceType.Ushort555Rgb,
                                   OGLSurfaceData.PF_USHORT_555_RGB),
            new OGLSwToSurfaceBlit(SurfaceType.Ushort555Rgbx,
                                   OGLSurfaceData.PF_USHORT_555_RGBX),
            new OGLSwToSurfaceBlit(SurfaceType.ByteGray,
                                   OGLSurfaceData.PF_BYTE_GRAY),
            new OGLSwToSurfaceBlit(SurfaceType.UshortGray,
                                   OGLSurfaceData.PF_USHORT_GRAY),
            new OGLGeneralBlit(OGLSurfaceData.OpenGLSurface,
                               CompositeType.AnyAlpha,
                               blitIntArgbPreToSurface),

            new OGLAnyCompositeBlit(OGLSurfaceData.OpenGLSurface),

            new OGLSwToSurfaceScale(SurfaceType.IntRgb,
                                    OGLSurfaceData.PF_INT_RGB),
            new OGLSwToSurfaceScale(SurfaceType.IntRgbx,
                                    OGLSurfaceData.PF_INT_RGBX),
            new OGLSwToSurfaceScale(SurfaceType.IntBgr,
                                    OGLSurfaceData.PF_INT_BGR),
            new OGLSwToSurfaceScale(SurfaceType.IntBgrx,
                                    OGLSurfaceData.PF_INT_BGRX),
            new OGLSwToSurfaceScale(SurfaceType.ThreeByteBgr,
                                    OGLSurfaceData.PF_3BYTE_BGR),
            new OGLSwToSurfaceScale(SurfaceType.Ushort565Rgb,
                                    OGLSurfaceData.PF_USHORT_565_RGB),
            new OGLSwToSurfaceScale(SurfaceType.Ushort555Rgb,
                                    OGLSurfaceData.PF_USHORT_555_RGB),
            new OGLSwToSurfaceScale(SurfaceType.Ushort555Rgbx,
                                    OGLSurfaceData.PF_USHORT_555_RGBX),
            new OGLSwToSurfaceScale(SurfaceType.ByteGray,
                                    OGLSurfaceData.PF_BYTE_GRAY),
            new OGLSwToSurfaceScale(SurfaceType.UshortGray,
                                    OGLSurfaceData.PF_USHORT_GRAY),
            new OGLSwToSurfaceScale(SurfaceType.IntArgbPre,
                                    OGLSurfaceData.PF_INT_ARGB_PRE),

            new OGLSwToSurfaceTransform(SurfaceType.IntRgb,
                                        OGLSurfaceData.PF_INT_RGB),
            new OGLSwToSurfaceTransform(SurfaceType.IntRgbx,
                                        OGLSurfaceData.PF_INT_RGBX),
            new OGLSwToSurfaceTransform(SurfaceType.IntBgr,
                                        OGLSurfaceData.PF_INT_BGR),
            new OGLSwToSurfaceTransform(SurfaceType.IntBgrx,
                                        OGLSurfaceData.PF_INT_BGRX),
            new OGLSwToSurfaceTransform(SurfaceType.ThreeByteBgr,
                                        OGLSurfaceData.PF_3BYTE_BGR),
            new OGLSwToSurfaceTransform(SurfaceType.Ushort565Rgb,
                                        OGLSurfaceData.PF_USHORT_565_RGB),
            new OGLSwToSurfaceTransform(SurfaceType.Ushort555Rgb,
                                        OGLSurfaceData.PF_USHORT_555_RGB),
            new OGLSwToSurfaceTransform(SurfaceType.Ushort555Rgbx,
                                        OGLSurfaceData.PF_USHORT_555_RGBX),
            new OGLSwToSurfaceTransform(SurfaceType.ByteGray,
                                        OGLSurfaceData.PF_BYTE_GRAY),
            new OGLSwToSurfaceTransform(SurfaceType.UshortGray,
                                        OGLSurfaceData.PF_USHORT_GRAY),
            new OGLSwToSurfaceTransform(SurfaceType.IntArgbPre,
                                        OGLSurfaceData.PF_INT_ARGB_PRE),

            // texture-&gt;surface ops
            new OGLTextureToSurfaceBlit(),
            new OGLTextureToSurfaceScale(),
            new OGLTextureToSurfaceTransform(),

            // sw-&gt;texture ops
            blitIntArgbPreToTexture,
            new OGLSwToTextureBlit(SurfaceType.IntRgb,
                                   OGLSurfaceData.PF_INT_RGB),
            new OGLSwToTextureBlit(SurfaceType.IntRgbx,
                                   OGLSurfaceData.PF_INT_RGBX),
            new OGLSwToTextureBlit(SurfaceType.IntBgr,
                                   OGLSurfaceData.PF_INT_BGR),
            new OGLSwToTextureBlit(SurfaceType.IntBgrx,
                                   OGLSurfaceData.PF_INT_BGRX),
            new OGLSwToTextureBlit(SurfaceType.ThreeByteBgr,
                                   OGLSurfaceData.PF_3BYTE_BGR),
            new OGLSwToTextureBlit(SurfaceType.Ushort565Rgb,
                                   OGLSurfaceData.PF_USHORT_565_RGB),
            new OGLSwToTextureBlit(SurfaceType.Ushort555Rgb,
                                   OGLSurfaceData.PF_USHORT_555_RGB),
            new OGLSwToTextureBlit(SurfaceType.Ushort555Rgbx,
                                   OGLSurfaceData.PF_USHORT_555_RGBX),
            new OGLSwToTextureBlit(SurfaceType.ByteGray,
                                   OGLSurfaceData.PF_BYTE_GRAY),
            new OGLSwToTextureBlit(SurfaceType.UshortGray,
                                   OGLSurfaceData.PF_USHORT_GRAY),
            new OGLGeneralBlit(OGLSurfaceData.OpenGLTexture,
                               CompositeType.SrcNoEa,
                               blitIntArgbPreToTexture),

            new OGLAnyCompositeBlit(OGLSurfaceData.OpenGLTexture),

        };
<span class="nc" id="L183">        GraphicsPrimitiveMgr.register(primitives);</span>
<span class="nc" id="L184">    }</span>

    /**
     * The following offsets are used to pack the parameters in
     * createPackedParams().  (They are also used at the native level when
     * unpacking the params.)
     */
    @Native private static final int OFFSET_SRCTYPE = 16;
    @Native private static final int OFFSET_HINT    =  8;
    @Native private static final int OFFSET_TEXTURE =  3;
    @Native private static final int OFFSET_RTT     =  2;
    @Native private static final int OFFSET_XFORM   =  1;
    @Native private static final int OFFSET_ISOBLIT =  0;

    /**
     * Packs the given parameters into a single int value in order to save
     * space on the rendering queue.
     */
    private static int createPackedParams(boolean isoblit, boolean texture,
                                          boolean rtt, boolean xform,
                                          int hint, int srctype)
    {
<span class="nc bnc" id="L206" title="All 8 branches missed.">        return</span>
            ((srctype           &lt;&lt; OFFSET_SRCTYPE) |
             (hint              &lt;&lt; OFFSET_HINT   ) |
             ((texture ? 1 : 0) &lt;&lt; OFFSET_TEXTURE) |
             ((rtt     ? 1 : 0) &lt;&lt; OFFSET_RTT    ) |
             ((xform   ? 1 : 0) &lt;&lt; OFFSET_XFORM  ) |
             ((isoblit ? 1 : 0) &lt;&lt; OFFSET_ISOBLIT));
    }

    /**
     * Enqueues a BLIT operation with the given parameters.  Note that the
     * RenderQueue lock must be held before calling this method.
     */
    private static void enqueueBlit(RenderQueue rq,
                                    SurfaceData src, SurfaceData dst,
                                    int packedParams,
                                    int sx1, int sy1,
                                    int sx2, int sy2,
                                    double dx1, double dy1,
                                    double dx2, double dy2)
    {
        // assert rq.lock.isHeldByCurrentThread();
<span class="nc" id="L228">        RenderBuffer buf = rq.getBuffer();</span>
<span class="nc" id="L229">        rq.ensureCapacityAndAlignment(72, 24);</span>
<span class="nc" id="L230">        buf.putInt(BLIT);</span>
<span class="nc" id="L231">        buf.putInt(packedParams);</span>
<span class="nc" id="L232">        buf.putInt(sx1).putInt(sy1);</span>
<span class="nc" id="L233">        buf.putInt(sx2).putInt(sy2);</span>
<span class="nc" id="L234">        buf.putDouble(dx1).putDouble(dy1);</span>
<span class="nc" id="L235">        buf.putDouble(dx2).putDouble(dy2);</span>
<span class="nc" id="L236">        buf.putLong(src.getNativeOps());</span>
<span class="nc" id="L237">        buf.putLong(dst.getNativeOps());</span>
<span class="nc" id="L238">    }</span>

    static void Blit(SurfaceData srcData, SurfaceData dstData,
                     Composite comp, Region clip,
                     AffineTransform xform, int hint,
                     int sx1, int sy1,
                     int sx2, int sy2,
                     double dx1, double dy1,
                     double dx2, double dy2,
                     int srctype, boolean texture)
    {
<span class="nc" id="L249">        int ctxflags = 0;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (srcData.getTransparency() == Transparency.OPAQUE) {</span>
<span class="nc" id="L251">            ctxflags |= OGLContext.SRC_IS_OPAQUE;</span>
        }

<span class="nc" id="L254">        OGLRenderQueue rq = OGLRenderQueue.getInstance();</span>
<span class="nc" id="L255">        rq.lock();</span>
        try {
            // make sure the RenderQueue keeps a hard reference to the
            // source (sysmem) SurfaceData to prevent it from being
            // disposed while the operation is processed on the QFT
<span class="nc" id="L260">            rq.addReference(srcData);</span>

<span class="nc" id="L262">            OGLSurfaceData oglDst = (OGLSurfaceData)dstData;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if (texture) {</span>
                // make sure we have a current context before uploading
                // the sysmem data to the texture object
<span class="nc" id="L266">                OGLGraphicsConfig gc = oglDst.getOGLGraphicsConfig();</span>
<span class="nc" id="L267">                OGLContext.setScratchSurface(gc);</span>
<span class="nc" id="L268">            } else {</span>
<span class="nc" id="L269">                OGLContext.validateContext(oglDst, oglDst,</span>
                                           clip, comp, xform, null, null,
                                           ctxflags);
            }

<span class="nc bnc" id="L274" title="All 2 branches missed.">            int packedParams = createPackedParams(false, texture,</span>
                                                  false, xform != null,
                                                  hint, srctype);
<span class="nc" id="L277">            enqueueBlit(rq, srcData, dstData,</span>
                        packedParams,
                        sx1, sy1, sx2, sy2,
                        dx1, dy1, dx2, dy2);

            // always flush immediately, since we (currently) have no means
            // of tracking changes to the system memory surface
<span class="nc" id="L284">            rq.flushNow();</span>
        } finally {
<span class="nc" id="L286">            rq.unlock();</span>
<span class="nc" id="L287">        }</span>
<span class="nc" id="L288">    }</span>

    /**
     * Note: The srcImg and biop parameters are only used when invoked
     * from the OGLBufImgOps.renderImageWithOp() method; in all other cases,
     * this method can be called with null values for those two parameters,
     * and they will be effectively ignored.
     */
    static void IsoBlit(SurfaceData srcData, SurfaceData dstData,
                        BufferedImage srcImg, BufferedImageOp biop,
                        Composite comp, Region clip,
                        AffineTransform xform, int hint,
                        int sx1, int sy1,
                        int sx2, int sy2,
                        double dx1, double dy1,
                        double dx2, double dy2,
                        boolean texture)
    {
<span class="nc" id="L306">        int ctxflags = 0;</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">        if (srcData.getTransparency() == Transparency.OPAQUE) {</span>
<span class="nc" id="L308">            ctxflags |= OGLContext.SRC_IS_OPAQUE;</span>
        }

<span class="nc" id="L311">        OGLRenderQueue rq = OGLRenderQueue.getInstance();</span>
<span class="nc" id="L312">        rq.lock();</span>
        try {
<span class="nc" id="L314">            OGLSurfaceData oglSrc = (OGLSurfaceData)srcData;</span>
<span class="nc" id="L315">            OGLSurfaceData oglDst = (OGLSurfaceData)dstData;</span>
<span class="nc" id="L316">            int srctype = oglSrc.getType();</span>
            boolean rtt;
            OGLSurfaceData srcCtxData;
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (srctype == OGLSurfaceData.TEXTURE) {</span>
                // the source is a regular texture object; we substitute
                // the destination surface for the purposes of making a
                // context current
<span class="nc" id="L323">                rtt = false;</span>
<span class="nc" id="L324">                srcCtxData = oglDst;</span>
            } else {
                // the source is a pbuffer, backbuffer, or render-to-texture
                // surface; we set rtt to true to differentiate this kind
                // of surface from a regular texture object
<span class="nc" id="L329">                rtt = true;</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">                if (srctype == OGLSurfaceData.FBOBJECT) {</span>
<span class="nc" id="L331">                    srcCtxData = oglDst;</span>
                } else {
<span class="nc" id="L333">                    srcCtxData = oglSrc;</span>
                }
            }

<span class="nc" id="L337">            OGLContext.validateContext(srcCtxData, oglDst,</span>
                                       clip, comp, xform, null, null,
                                       ctxflags);

<span class="nc bnc" id="L341" title="All 2 branches missed.">            if (biop != null) {</span>
<span class="nc" id="L342">                OGLBufImgOps.enableBufImgOp(rq, oglSrc, srcImg, biop);</span>
            }

<span class="nc bnc" id="L345" title="All 2 branches missed.">            int packedParams = createPackedParams(true, texture,</span>
                                                  rtt, xform != null,
                                                  hint, 0 /*unused*/);
<span class="nc" id="L348">            enqueueBlit(rq, srcData, dstData,</span>
                        packedParams,
                        sx1, sy1, sx2, sy2,
                        dx1, dy1, dx2, dy2);

<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (biop != null) {</span>
<span class="nc" id="L354">                OGLBufImgOps.disableBufImgOp(rq, biop);</span>
            }

<span class="nc bnc" id="L357" title="All 4 branches missed.">            if (rtt &amp;&amp; oglDst.isOnScreen()) {</span>
                // we only have to flush immediately when copying from a
                // (non-texture) surface to the screen; otherwise Swing apps
                // might appear unresponsive until the auto-flush completes
<span class="nc" id="L361">                rq.flushNow();</span>
            }
        } finally {
<span class="nc" id="L364">            rq.unlock();</span>
<span class="nc" id="L365">        }</span>
<span class="nc" id="L366">    }</span>
}

class OGLSurfaceToSurfaceBlit extends Blit {

    OGLSurfaceToSurfaceBlit() {
<span class="nc" id="L372">        super(OGLSurfaceData.OpenGLSurface,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L375">    }</span>

    public void Blit(SurfaceData src, SurfaceData dst,
                     Composite comp, Region clip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
<span class="nc" id="L381">        OGLBlitLoops.IsoBlit(src, dst,</span>
                             null, null,
                             comp, clip, null,
                             AffineTransformOp.TYPE_NEAREST_NEIGHBOR,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             false);
<span class="nc" id="L388">    }</span>
}

class OGLSurfaceToSurfaceScale extends ScaledBlit {

    OGLSurfaceToSurfaceScale() {
<span class="nc" id="L394">        super(OGLSurfaceData.OpenGLSurface,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L397">    }</span>

    public void Scale(SurfaceData src, SurfaceData dst,
                      Composite comp, Region clip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      double dx1, double dy1,
                      double dx2, double dy2)
    {
<span class="nc" id="L406">        OGLBlitLoops.IsoBlit(src, dst,</span>
                             null, null,
                             comp, clip, null,
                             AffineTransformOp.TYPE_NEAREST_NEIGHBOR,
                             sx1, sy1, sx2, sy2,
                             dx1, dy1, dx2, dy2,
                             false);
<span class="nc" id="L413">    }</span>
}

class OGLSurfaceToSurfaceTransform extends TransformBlit {

    OGLSurfaceToSurfaceTransform() {
<span class="nc" id="L419">        super(OGLSurfaceData.OpenGLSurface,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L422">    }</span>

    public void Transform(SurfaceData src, SurfaceData dst,
                          Composite comp, Region clip,
                          AffineTransform at, int hint,
                          int sx, int sy, int dx, int dy,
                          int w, int h)
    {
<span class="nc" id="L430">        OGLBlitLoops.IsoBlit(src, dst,</span>
                             null, null,
                             comp, clip, at, hint,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             false);
<span class="nc" id="L436">    }</span>
}

class OGLRTTSurfaceToSurfaceBlit extends Blit {

    OGLRTTSurfaceToSurfaceBlit() {
<span class="nc" id="L442">        super(OGLSurfaceData.OpenGLSurfaceRTT,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L445">    }</span>

    public void Blit(SurfaceData src, SurfaceData dst,
                     Composite comp, Region clip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
<span class="nc" id="L451">        OGLBlitLoops.IsoBlit(src, dst,</span>
                             null, null,
                             comp, clip, null,
                             AffineTransformOp.TYPE_NEAREST_NEIGHBOR,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             true);
<span class="nc" id="L458">    }</span>
}

class OGLRTTSurfaceToSurfaceScale extends ScaledBlit {

    OGLRTTSurfaceToSurfaceScale() {
<span class="nc" id="L464">        super(OGLSurfaceData.OpenGLSurfaceRTT,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L467">    }</span>

    public void Scale(SurfaceData src, SurfaceData dst,
                      Composite comp, Region clip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      double dx1, double dy1,
                      double dx2, double dy2)
    {
<span class="nc" id="L476">        OGLBlitLoops.IsoBlit(src, dst,</span>
                             null, null,
                             comp, clip, null,
                             AffineTransformOp.TYPE_NEAREST_NEIGHBOR,
                             sx1, sy1, sx2, sy2,
                             dx1, dy1, dx2, dy2,
                             true);
<span class="nc" id="L483">    }</span>
}

class OGLRTTSurfaceToSurfaceTransform extends TransformBlit {

    OGLRTTSurfaceToSurfaceTransform() {
<span class="nc" id="L489">        super(OGLSurfaceData.OpenGLSurfaceRTT,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L492">    }</span>

    public void Transform(SurfaceData src, SurfaceData dst,
                          Composite comp, Region clip,
                          AffineTransform at, int hint,
                          int sx, int sy, int dx, int dy, int w, int h)
    {
<span class="nc" id="L499">        OGLBlitLoops.IsoBlit(src, dst,</span>
                             null, null,
                             comp, clip, at, hint,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             true);
<span class="nc" id="L505">    }</span>
}

class OGLSurfaceToSwBlit extends Blit {

    private int typeval;

    // REMIND: destination will actually be opaque/premultiplied...
    OGLSurfaceToSwBlit(SurfaceType dstType, int typeval) {
<span class="nc" id="L514">        super(OGLSurfaceData.OpenGLSurface,</span>
              CompositeType.SrcNoEa,
              dstType);
<span class="nc" id="L517">        this.typeval = typeval;</span>
<span class="nc" id="L518">    }</span>

    public void Blit(SurfaceData src, SurfaceData dst,
                     Composite comp, Region clip,
                     int sx, int sy, int dx, int dy,
                     int w, int h)
    {
<span class="nc" id="L525">        OGLRenderQueue rq = OGLRenderQueue.getInstance();</span>
<span class="nc" id="L526">        rq.lock();</span>
        try {
            // make sure the RenderQueue keeps a hard reference to the
            // destination (sysmem) SurfaceData to prevent it from being
            // disposed while the operation is processed on the QFT
<span class="nc" id="L531">            rq.addReference(dst);</span>

<span class="nc" id="L533">            RenderBuffer buf = rq.getBuffer();</span>
<span class="nc" id="L534">            OGLContext.validateContext((OGLSurfaceData)src);</span>

<span class="nc" id="L536">            rq.ensureCapacityAndAlignment(48, 32);</span>
<span class="nc" id="L537">            buf.putInt(SURFACE_TO_SW_BLIT);</span>
<span class="nc" id="L538">            buf.putInt(sx).putInt(sy);</span>
<span class="nc" id="L539">            buf.putInt(dx).putInt(dy);</span>
<span class="nc" id="L540">            buf.putInt(w).putInt(h);</span>
<span class="nc" id="L541">            buf.putInt(typeval);</span>
<span class="nc" id="L542">            buf.putLong(src.getNativeOps());</span>
<span class="nc" id="L543">            buf.putLong(dst.getNativeOps());</span>

            // always flush immediately
<span class="nc" id="L546">            rq.flushNow();</span>
        } finally {
<span class="nc" id="L548">            rq.unlock();</span>
<span class="nc" id="L549">        }</span>
<span class="nc" id="L550">    }</span>
}

class OGLSwToSurfaceBlit extends Blit {

    private int typeval;

    OGLSwToSurfaceBlit(SurfaceType srcType, int typeval) {
<span class="nc" id="L558">        super(srcType,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L561">        this.typeval = typeval;</span>
<span class="nc" id="L562">    }</span>

    public void Blit(SurfaceData src, SurfaceData dst,
                     Composite comp, Region clip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
<span class="nc" id="L568">        OGLBlitLoops.Blit(src, dst,</span>
                          comp, clip, null,
                          AffineTransformOp.TYPE_NEAREST_NEIGHBOR,
                          sx, sy, sx+w, sy+h,
                          dx, dy, dx+w, dy+h,
                          typeval, false);
<span class="nc" id="L574">    }</span>
}

class OGLSwToSurfaceScale extends ScaledBlit {

    private int typeval;

    OGLSwToSurfaceScale(SurfaceType srcType, int typeval) {
<span class="nc" id="L582">        super(srcType,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L585">        this.typeval = typeval;</span>
<span class="nc" id="L586">    }</span>

    public void Scale(SurfaceData src, SurfaceData dst,
                      Composite comp, Region clip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      double dx1, double dy1,
                      double dx2, double dy2)
    {
<span class="nc" id="L595">        OGLBlitLoops.Blit(src, dst,</span>
                          comp, clip, null,
                          AffineTransformOp.TYPE_NEAREST_NEIGHBOR,
                          sx1, sy1, sx2, sy2,
                          dx1, dy1, dx2, dy2,
                          typeval, false);
<span class="nc" id="L601">    }</span>
}

class OGLSwToSurfaceTransform extends TransformBlit {

    private int typeval;

    OGLSwToSurfaceTransform(SurfaceType srcType, int typeval) {
<span class="nc" id="L609">        super(srcType,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L612">        this.typeval = typeval;</span>
<span class="nc" id="L613">    }</span>

    public void Transform(SurfaceData src, SurfaceData dst,
                          Composite comp, Region clip,
                          AffineTransform at, int hint,
                          int sx, int sy, int dx, int dy, int w, int h)
    {
<span class="nc" id="L620">        OGLBlitLoops.Blit(src, dst,</span>
                          comp, clip, at, hint,
                          sx, sy, sx+w, sy+h,
                          dx, dy, dx+w, dy+h,
                          typeval, false);
<span class="nc" id="L625">    }</span>
}

class OGLSwToTextureBlit extends Blit {

    private int typeval;

    OGLSwToTextureBlit(SurfaceType srcType, int typeval) {
<span class="nc" id="L633">        super(srcType,</span>
              CompositeType.SrcNoEa,
              OGLSurfaceData.OpenGLTexture);
<span class="nc" id="L636">        this.typeval = typeval;</span>
<span class="nc" id="L637">    }</span>

    public void Blit(SurfaceData src, SurfaceData dst,
                     Composite comp, Region clip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
<span class="nc" id="L643">        OGLBlitLoops.Blit(src, dst,</span>
                          comp, clip, null,
                          AffineTransformOp.TYPE_NEAREST_NEIGHBOR,
                          sx, sy, sx+w, sy+h,
                          dx, dy, dx+w, dy+h,
                          typeval, true);
<span class="nc" id="L649">    }</span>
}

class OGLTextureToSurfaceBlit extends Blit {

    OGLTextureToSurfaceBlit() {
<span class="nc" id="L655">        super(OGLSurfaceData.OpenGLTexture,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L658">    }</span>

    public void Blit(SurfaceData src, SurfaceData dst,
                     Composite comp, Region clip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
<span class="nc" id="L664">        OGLBlitLoops.IsoBlit(src, dst,</span>
                             null, null,
                             comp, clip, null,
                             AffineTransformOp.TYPE_NEAREST_NEIGHBOR,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             true);
<span class="nc" id="L671">    }</span>
}

class OGLTextureToSurfaceScale extends ScaledBlit {

    OGLTextureToSurfaceScale() {
<span class="nc" id="L677">        super(OGLSurfaceData.OpenGLTexture,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L680">    }</span>

    public void Scale(SurfaceData src, SurfaceData dst,
                      Composite comp, Region clip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      double dx1, double dy1,
                      double dx2, double dy2)
    {
<span class="nc" id="L689">        OGLBlitLoops.IsoBlit(src, dst,</span>
                             null, null,
                             comp, clip, null,
                             AffineTransformOp.TYPE_NEAREST_NEIGHBOR,
                             sx1, sy1, sx2, sy2,
                             dx1, dy1, dx2, dy2,
                             true);
<span class="nc" id="L696">    }</span>
}

class OGLTextureToSurfaceTransform extends TransformBlit {

    OGLTextureToSurfaceTransform() {
<span class="nc" id="L702">        super(OGLSurfaceData.OpenGLTexture,</span>
              CompositeType.AnyAlpha,
              OGLSurfaceData.OpenGLSurface);
<span class="nc" id="L705">    }</span>

    public void Transform(SurfaceData src, SurfaceData dst,
                          Composite comp, Region clip,
                          AffineTransform at, int hint,
                          int sx, int sy, int dx, int dy,
                          int w, int h)
    {
<span class="nc" id="L713">        OGLBlitLoops.IsoBlit(src, dst,</span>
                             null, null,
                             comp, clip, at, hint,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             true);
<span class="nc" id="L719">    }</span>
}

/**
 * This general Blit implementation converts any source surface to an
 * intermediate IntArgbPre surface, and then uses the more specific
 * IntArgbPre-&gt;OpenGLSurface/Texture loop to get the intermediate
 * (premultiplied) surface down to OpenGL.
 */
class OGLGeneralBlit extends Blit {

    private Blit performop;
    private WeakReference srcTmp;

    OGLGeneralBlit(SurfaceType dstType,
                   CompositeType compType,
                   Blit performop)
    {
<span class="nc" id="L737">        super(SurfaceType.Any, compType, dstType);</span>
<span class="nc" id="L738">        this.performop = performop;</span>
<span class="nc" id="L739">    }</span>

    public synchronized void Blit(SurfaceData src, SurfaceData dst,
                                  Composite comp, Region clip,
                                  int sx, int sy, int dx, int dy,
                                  int w, int h)
    {
<span class="nc" id="L746">        Blit convertsrc = Blit.getFromCache(src.getSurfaceType(),</span>
                                            CompositeType.SrcNoEa,
                                            SurfaceType.IntArgbPre);

<span class="nc" id="L750">        SurfaceData cachedSrc = null;</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">        if (srcTmp != null) {</span>
            // use cached intermediate surface, if available
<span class="nc" id="L753">            cachedSrc = (SurfaceData)srcTmp.get();</span>
        }

        // convert source to IntArgbPre
<span class="nc" id="L757">        src = convertFrom(convertsrc, src, sx, sy, w, h,</span>
                          cachedSrc, BufferedImage.TYPE_INT_ARGB_PRE);

        // copy IntArgbPre intermediate surface to OpenGL surface
<span class="nc" id="L761">        performop.Blit(src, dst, comp, clip,</span>
                       0, 0, dx, dy, w, h);

<span class="nc bnc" id="L764" title="All 2 branches missed.">        if (src != cachedSrc) {</span>
            // cache the intermediate surface
<span class="nc" id="L766">            srcTmp = new WeakReference(src);</span>
        }
<span class="nc" id="L768">    }</span>
}

class OGLAnyCompositeBlit extends Blit {
    private WeakReference&lt;SurfaceData&gt; dstTmp;

    public OGLAnyCompositeBlit(SurfaceType dstType) {
<span class="nc" id="L775">        super(SurfaceType.Any, CompositeType.Any, dstType);</span>
<span class="nc" id="L776">    }</span>
    public synchronized void Blit(SurfaceData src, SurfaceData dst,
                                  Composite comp, Region clip,
                                  int sx, int sy, int dx, int dy,
                                  int w, int h)
    {
<span class="nc" id="L782">        Blit convertdst = Blit.getFromCache(dst.getSurfaceType(),</span>
                                            CompositeType.SrcNoEa,
                                            SurfaceType.IntArgbPre);

<span class="nc" id="L786">        SurfaceData cachedDst = null;</span>

<span class="nc bnc" id="L788" title="All 2 branches missed.">        if (dstTmp != null) {</span>
            // use cached intermediate surface, if available
<span class="nc" id="L790">            cachedDst = dstTmp.get();</span>
        }

        // convert source to IntArgbPre
<span class="nc" id="L794">        SurfaceData dstBuffer = convertFrom(convertdst, dst, dx, dy, w, h,</span>
                          cachedDst, BufferedImage.TYPE_INT_ARGB_PRE);

<span class="nc" id="L797">        Blit performop = Blit.getFromCache(src.getSurfaceType(),</span>
<span class="nc" id="L798">                CompositeType.Any, dstBuffer.getSurfaceType());</span>

<span class="nc" id="L800">        performop.Blit(src, dstBuffer, comp, clip,</span>
                       sx, sy, 0, 0, w, h);

<span class="nc bnc" id="L803" title="All 2 branches missed.">        if (dstBuffer != cachedDst) {</span>
            // cache the intermediate surface
<span class="nc" id="L805">            dstTmp = new WeakReference(dstBuffer);</span>
        }

        // now blit the buffer back to the destination
<span class="nc" id="L809">        convertdst = Blit.getFromCache(dstBuffer.getSurfaceType(),</span>
                                            CompositeType.SrcNoEa,
<span class="nc" id="L811">                                            dst.getSurfaceType());</span>
<span class="nc" id="L812">        convertdst.Blit(dstBuffer, dst, AlphaComposite.Src,</span>
                 clip, 0, 0, dx, dy, w, h);
<span class="nc" id="L814">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>