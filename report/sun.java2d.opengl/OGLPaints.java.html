<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>OGLPaints.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.java2d.opengl</a> &gt; <span class="el_source">OGLPaints.java</span></div><h1>OGLPaints.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.java2d.opengl;

import java.awt.GradientPaint;
import java.awt.LinearGradientPaint;
import java.awt.MultipleGradientPaint;
import java.awt.MultipleGradientPaint.ColorSpaceType;
import java.awt.MultipleGradientPaint.CycleMethod;
import java.awt.RadialGradientPaint;
import java.awt.TexturePaint;
import java.awt.image.BufferedImage;
import java.util.HashMap;
import java.util.Map;
import sun.java2d.SunGraphics2D;
import sun.java2d.SurfaceData;
import sun.java2d.loops.CompositeType;
import static sun.java2d.pipe.BufferedPaints.*;
import static sun.java2d.opengl.OGLContext.OGLContextCaps.*;

<span class="nc" id="L44">abstract class OGLPaints {</span>

    /**
     * Holds all registered implementations, using the corresponding
     * SunGraphics2D.PAINT_* constant as the hash key.
     */
<span class="nc" id="L50">    private static Map&lt;Integer, OGLPaints&gt; impls =</span>
        new HashMap&lt;Integer, OGLPaints&gt;(4, 1.0f);

    static {
<span class="nc" id="L54">        impls.put(SunGraphics2D.PAINT_GRADIENT, new Gradient());</span>
<span class="nc" id="L55">        impls.put(SunGraphics2D.PAINT_LIN_GRADIENT, new LinearGradient());</span>
<span class="nc" id="L56">        impls.put(SunGraphics2D.PAINT_RAD_GRADIENT, new RadialGradient());</span>
<span class="nc" id="L57">        impls.put(SunGraphics2D.PAINT_TEXTURE, new Texture());</span>
<span class="nc" id="L58">    }</span>

    /**
     * Attempts to locate an implementation corresponding to the paint state
     * of the provided SunGraphics2D object.  If no implementation can be
     * found, or if the paint cannot be accelerated under the conditions
     * of the SunGraphics2D, this method returns false; otherwise, returns
     * true.
     */
    static boolean isValid(SunGraphics2D sg2d) {
<span class="nc" id="L68">        OGLPaints impl = impls.get(sg2d.paintState);</span>
<span class="nc bnc" id="L69" title="All 4 branches missed.">        return (impl != null &amp;&amp; impl.isPaintValid(sg2d));</span>
    }

    /**
     * Returns true if this implementation is able to accelerate the
     * Paint object associated with, and under the conditions of, the
     * provided SunGraphics2D instance; otherwise returns false.
     */
    abstract boolean isPaintValid(SunGraphics2D sg2d);

/************************* GradientPaint support ****************************/

    private static class Gradient extends OGLPaints {
<span class="nc" id="L82">        private Gradient() {}</span>

        /**
         * There are no restrictions for accelerating GradientPaint, so
         * this method always returns true.
         */
        @Override
        boolean isPaintValid(SunGraphics2D sg2d) {
<span class="nc" id="L90">            return true;</span>
        }
    }

/************************** TexturePaint support ****************************/

    private static class Texture extends OGLPaints {
<span class="nc" id="L97">        private Texture() {}</span>

        /**
         * Returns true if the given TexturePaint instance can be used by the
         * accelerated OGLPaints.Texture implementation.  A TexturePaint is
         * considered valid if the following conditions are met:
         *   - the texture image dimensions are power-of-two (or the
         *     GL_ARB_texture_non_power_of_two extension is present)
         *   - the texture image can be (or is already) cached in an OpenGL
         *     texture object
         */
        @Override
        boolean isPaintValid(SunGraphics2D sg2d) {
<span class="nc" id="L110">            TexturePaint paint = (TexturePaint)sg2d.paint;</span>
<span class="nc" id="L111">            OGLSurfaceData dstData = (OGLSurfaceData)sg2d.surfaceData;</span>
<span class="nc" id="L112">            BufferedImage bi = paint.getImage();</span>

            // see if texture-non-pow2 extension is available
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (!dstData.isTexNonPow2Available()) {</span>
<span class="nc" id="L116">                int imgw = bi.getWidth();</span>
<span class="nc" id="L117">                int imgh = bi.getHeight();</span>

                // verify that the texture image dimensions are pow2
<span class="nc bnc" id="L120" title="All 4 branches missed.">                if ((imgw &amp; (imgw - 1)) != 0 || (imgh &amp; (imgh - 1)) != 0) {</span>
<span class="nc" id="L121">                    return false;</span>
                }
            }

<span class="nc" id="L125">            SurfaceData srcData =</span>
<span class="nc" id="L126">                dstData.getSourceSurfaceData(bi,</span>
                                             SunGraphics2D.TRANSFORM_ISIDENT,
                                             CompositeType.SrcOver, null);
<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (!(srcData instanceof OGLSurfaceData)) {</span>
                // REMIND: this is a hack that attempts to cache the system
                //         memory image from the TexturePaint instance into an
                //         OpenGL texture...
<span class="nc" id="L133">                srcData =</span>
<span class="nc" id="L134">                    dstData.getSourceSurfaceData(bi,</span>
                                                 SunGraphics2D.TRANSFORM_ISIDENT,
                                                 CompositeType.SrcOver, null);
<span class="nc bnc" id="L137" title="All 2 branches missed.">                if (!(srcData instanceof OGLSurfaceData)) {</span>
<span class="nc" id="L138">                    return false;</span>
                }
            }

            // verify that the source surface is actually a texture
<span class="nc" id="L143">            OGLSurfaceData oglData = (OGLSurfaceData)srcData;</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            if (oglData.getType() != OGLSurfaceData.TEXTURE) {</span>
<span class="nc" id="L145">                return false;</span>
            }

<span class="nc" id="L148">            return true;</span>
        }
    }

/****************** Shared MultipleGradientPaint support ********************/

    private static abstract class MultiGradient extends OGLPaints {
<span class="nc" id="L155">        protected MultiGradient() {}</span>

        /**
         * Returns true if the given MultipleGradientPaint instance can be
         * used by the accelerated OGLPaints.MultiGradient implementation.
         * A MultipleGradientPaint is considered valid if the following
         * conditions are met:
         *   - the number of gradient &quot;stops&quot; is &lt;= MAX_FRACTIONS
         *   - the destination has support for fragment shaders
         */
        @Override
        boolean isPaintValid(SunGraphics2D sg2d) {
<span class="nc" id="L167">            MultipleGradientPaint paint = (MultipleGradientPaint)sg2d.paint;</span>
            // REMIND: ugh, this creates garbage; would be nicer if
            // we had a MultipleGradientPaint.getNumStops() method...
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (paint.getFractions().length &gt; MULTI_MAX_FRACTIONS) {</span>
<span class="nc" id="L171">                return false;</span>
            }

<span class="nc" id="L174">            OGLSurfaceData dstData = (OGLSurfaceData)sg2d.surfaceData;</span>
<span class="nc" id="L175">            OGLGraphicsConfig gc = dstData.getOGLGraphicsConfig();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (!gc.isCapPresent(CAPS_EXT_GRAD_SHADER)) {</span>
<span class="nc" id="L177">                return false;</span>
            }

<span class="nc" id="L180">            return true;</span>
        }
    }

/********************** LinearGradientPaint support *************************/

    private static class LinearGradient extends MultiGradient {
<span class="nc" id="L187">        private LinearGradient() {}</span>

        @Override
        boolean isPaintValid(SunGraphics2D sg2d) {
<span class="nc" id="L191">            LinearGradientPaint paint = (LinearGradientPaint)sg2d.paint;</span>

<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (paint.getFractions().length == 2 &amp;&amp;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                paint.getCycleMethod() != CycleMethod.REPEAT &amp;&amp;</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                paint.getColorSpace() != ColorSpaceType.LINEAR_RGB)</span>
            {
                // we can delegate to the optimized two-color gradient
                // codepath, which does not require fragment shader support
<span class="nc" id="L199">                return true;</span>
            }

<span class="nc" id="L202">            return super.isPaintValid(sg2d);</span>
        }
    }

/********************** RadialGradientPaint support *************************/

<span class="nc" id="L208">    private static class RadialGradient extends MultiGradient {</span>
<span class="nc" id="L209">        private RadialGradient() {}</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>