<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>JarURLConnection.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.net.www.protocol.jar</a> &gt; <span class="el_source">JarURLConnection.java</span></div><h1>JarURLConnection.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2006, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.net.www.protocol.jar;

import java.io.InputStream;
import java.io.IOException;
import java.io.FileNotFoundException;
import java.io.BufferedInputStream;
import java.net.URL;
import java.net.URLConnection;
import java.net.MalformedURLException;
import java.net.UnknownServiceException;
import java.util.Enumeration;
import java.util.Map;
import java.util.List;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;
import java.util.jar.Manifest;
import java.security.Permission;

/**
 * @author Benjamin Renaud
 * @since 1.2
 */
public class JarURLConnection extends java.net.JarURLConnection {

    private static final boolean debug = false;

    /* the Jar file factory. It handles both retrieval and caching.
     */
<span class="fc" id="L54">    private static final JarFileFactory factory = JarFileFactory.getInstance();</span>

    /* the url for the Jar file */
    private URL jarFileURL;

    /* the permission to get this JAR file. This is the actual, ultimate,
     * permission, returned by the jar file factory.
     */
    private Permission permission;

    /* the url connection for the JAR file */
    private URLConnection jarFileURLConnection;

    /* the entry name, if any */
    private String entryName;

    /* the JarEntry */
    private JarEntry jarEntry;

    /* the jar file corresponding to this connection */
    private JarFile jarFile;

    /* the content type for this connection */
    private String contentType;

    public JarURLConnection(URL url, Handler handler)
    throws MalformedURLException, IOException {
<span class="fc" id="L81">        super(url);</span>

<span class="fc" id="L83">        jarFileURL = getJarFileURL();</span>
<span class="fc" id="L84">        jarFileURLConnection = jarFileURL.openConnection();</span>
<span class="fc" id="L85">        entryName = getEntryName();</span>
<span class="fc" id="L86">    }</span>

    public JarFile getJarFile() throws IOException {
<span class="fc" id="L89">        connect();</span>
<span class="fc" id="L90">        return jarFile;</span>
    }

    public JarEntry getJarEntry() throws IOException {
<span class="fc" id="L94">        connect();</span>
<span class="fc" id="L95">        return jarEntry;</span>
    }

    public Permission getPermission() throws IOException {
<span class="fc" id="L99">        return jarFileURLConnection.getPermission();</span>
    }

    class JarURLInputStream extends java.io.FilterInputStream {
<span class="fc" id="L103">        JarURLInputStream (InputStream src) {</span>
<span class="fc" id="L104">            super (src);</span>
<span class="fc" id="L105">        }</span>
        public void close () throws IOException {
            try {
<span class="fc" id="L108">                super.close();</span>
            } finally {
<span class="pc bpc" id="L110" title="2 of 4 branches missed.">                if (!getUseCaches()) {</span>
<span class="pc" id="L111">                    jarFile.close();</span>
                }
            }
<span class="fc" id="L114">        }</span>
    }



    public void connect() throws IOException {
<span class="fc bfc" id="L120" title="All 2 branches covered.">        if (!connected) {</span>
            /* the factory call will do the security checks */
<span class="fc" id="L122">            jarFile = factory.get(getJarFileURL(), getUseCaches());</span>

            /* we also ask the factory the permission that was required
             * to get the jarFile, and set it as our permission.
             */
<span class="fc bfc" id="L127" title="All 2 branches covered.">            if (getUseCaches()) {</span>
<span class="fc" id="L128">                jarFileURLConnection = factory.getConnection(jarFile);</span>
            }

<span class="fc bfc" id="L131" title="All 2 branches covered.">            if ((entryName != null)) {</span>
<span class="fc" id="L132">                jarEntry = (JarEntry)jarFile.getEntry(entryName);</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">                if (jarEntry == null) {</span>
                    try {
<span class="fc bfc" id="L135" title="All 2 branches covered.">                        if (!getUseCaches()) {</span>
<span class="fc" id="L136">                            jarFile.close();</span>
                        }
<span class="nc" id="L138">                    } catch (Exception e) {</span>
<span class="fc" id="L139">                    }</span>
<span class="fc" id="L140">                    throw new FileNotFoundException(&quot;JAR entry &quot; + entryName +</span>
                                                    &quot; not found in &quot; +
<span class="fc" id="L142">                                                    jarFile.getName());</span>
                }
            }
<span class="fc" id="L145">            connected = true;</span>
        }
<span class="fc" id="L147">    }</span>

    public InputStream getInputStream() throws IOException {
<span class="fc" id="L150">        connect();</span>

<span class="fc" id="L152">        InputStream result = null;</span>

<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (entryName == null) {</span>
<span class="nc" id="L155">            throw new IOException(&quot;no entry name specified&quot;);</span>
        } else {
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            if (jarEntry == null) {</span>
<span class="nc" id="L158">                throw new FileNotFoundException(&quot;JAR entry &quot; + entryName +</span>
                                                &quot; not found in &quot; +
<span class="nc" id="L160">                                                jarFile.getName());</span>
            }
<span class="fc" id="L162">            result = new JarURLInputStream (jarFile.getInputStream(jarEntry));</span>
        }
<span class="fc" id="L164">        return result;</span>
    }

    public int getContentLength() {
<span class="fc" id="L168">        long result = getContentLengthLong();</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        if (result &gt; Integer.MAX_VALUE)</span>
<span class="nc" id="L170">            return -1;</span>
<span class="fc" id="L171">        return (int) result;</span>
    }

    public long getContentLengthLong() {
<span class="fc" id="L175">        long result = -1;</span>
        try {
<span class="fc" id="L177">            connect();</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">            if (jarEntry == null) {</span>
                /* if the URL referes to an archive */
<span class="nc" id="L180">                result = jarFileURLConnection.getContentLengthLong();</span>
            } else {
                /* if the URL referes to an archive entry */
<span class="fc" id="L183">                result = getJarEntry().getSize();</span>
            }
<span class="nc" id="L185">        } catch (IOException e) {</span>
<span class="fc" id="L186">        }</span>
<span class="fc" id="L187">        return result;</span>
    }

    public Object getContent() throws IOException {
<span class="fc" id="L191">        Object result = null;</span>

<span class="fc" id="L193">        connect();</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if (entryName == null) {</span>
<span class="nc" id="L195">            result = jarFile;</span>
        } else {
<span class="fc" id="L197">            result = super.getContent();</span>
        }
<span class="fc" id="L199">        return result;</span>
    }

    public String getContentType() {
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        if (contentType == null) {</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">            if (entryName == null) {</span>
<span class="fc" id="L205">                contentType = &quot;x-java/jar&quot;;</span>
            } else {
                try {
<span class="fc" id="L208">                    connect();</span>
<span class="fc" id="L209">                    InputStream in = jarFile.getInputStream(jarEntry);</span>
<span class="fc" id="L210">                    contentType = guessContentTypeFromStream(</span>
                                        new BufferedInputStream(in));
<span class="fc" id="L212">                    in.close();</span>
<span class="fc" id="L213">                } catch (IOException e) {</span>
                    // don't do anything
<span class="fc" id="L215">                }</span>
            }
<span class="fc bfc" id="L217" title="All 2 branches covered.">            if (contentType == null) {</span>
<span class="fc" id="L218">                contentType = guessContentTypeFromName(entryName);</span>
            }
<span class="fc bfc" id="L220" title="All 2 branches covered.">            if (contentType == null) {</span>
<span class="fc" id="L221">                contentType = &quot;content/unknown&quot;;</span>
            }
        }
<span class="fc" id="L224">        return contentType;</span>
    }

    public String getHeaderField(String name) {
<span class="fc" id="L228">        return jarFileURLConnection.getHeaderField(name);</span>
    }

    /**
     * Sets the general request property.
     *
     * @param   key     the keyword by which the request is known
     *                  (e.g., &quot;&lt;code&gt;accept&lt;/code&gt;&quot;).
     * @param   value   the value associated with it.
     */
    public void setRequestProperty(String key, String value) {
<span class="fc" id="L239">        jarFileURLConnection.setRequestProperty(key, value);</span>
<span class="fc" id="L240">    }</span>

    /**
     * Returns the value of the named general request property for this
     * connection.
     *
     * @return  the value of the named general request property for this
     *           connection.
     */
    public String getRequestProperty(String key) {
<span class="fc" id="L250">        return jarFileURLConnection.getRequestProperty(key);</span>
    }

    /**
     * Adds a general request property specified by a
     * key-value pair.  This method will not overwrite
     * existing values associated with the same key.
     *
     * @param   key     the keyword by which the request is known
     *                  (e.g., &quot;&lt;code&gt;accept&lt;/code&gt;&quot;).
     * @param   value   the value associated with it.
     */
    public void addRequestProperty(String key, String value) {
<span class="nc" id="L263">        jarFileURLConnection.addRequestProperty(key, value);</span>
<span class="nc" id="L264">    }</span>

    /**
     * Returns an unmodifiable Map of general request
     * properties for this connection. The Map keys
     * are Strings that represent the request-header
     * field names. Each Map value is a unmodifiable List
     * of Strings that represents the corresponding
     * field values.
     *
     * @return  a Map of the general request properties for this connection.
     */
    public Map&lt;String,List&lt;String&gt;&gt; getRequestProperties() {
<span class="nc" id="L277">        return jarFileURLConnection.getRequestProperties();</span>
    }

    /**
     * Set the value of the &lt;code&gt;allowUserInteraction&lt;/code&gt; field of
     * this &lt;code&gt;URLConnection&lt;/code&gt;.
     *
     * @param   allowuserinteraction   the new value.
     * @see     java.net.URLConnection#allowUserInteraction
     */
    public void setAllowUserInteraction(boolean allowuserinteraction) {
<span class="nc" id="L288">        jarFileURLConnection.setAllowUserInteraction(allowuserinteraction);</span>
<span class="nc" id="L289">    }</span>

    /**
     * Returns the value of the &lt;code&gt;allowUserInteraction&lt;/code&gt; field for
     * this object.
     *
     * @return  the value of the &lt;code&gt;allowUserInteraction&lt;/code&gt; field for
     *          this object.
     * @see     java.net.URLConnection#allowUserInteraction
     */
    public boolean getAllowUserInteraction() {
<span class="nc" id="L300">        return jarFileURLConnection.getAllowUserInteraction();</span>
    }

    /*
     * cache control
     */

    /**
     * Sets the value of the &lt;code&gt;useCaches&lt;/code&gt; field of this
     * &lt;code&gt;URLConnection&lt;/code&gt; to the specified value.
     * &lt;p&gt;
     * Some protocols do caching of documents.  Occasionally, it is important
     * to be able to &quot;tunnel through&quot; and ignore the caches (e.g., the
     * &quot;reload&quot; button in a browser).  If the UseCaches flag on a connection
     * is true, the connection is allowed to use whatever caches it can.
     *  If false, caches are to be ignored.
     *  The default value comes from DefaultUseCaches, which defaults to
     * true.
     *
     * @see     java.net.URLConnection#useCaches
     */
    public void setUseCaches(boolean usecaches) {
<span class="fc" id="L322">        jarFileURLConnection.setUseCaches(usecaches);</span>
<span class="fc" id="L323">    }</span>

    /**
     * Returns the value of this &lt;code&gt;URLConnection&lt;/code&gt;'s
     * &lt;code&gt;useCaches&lt;/code&gt; field.
     *
     * @return  the value of this &lt;code&gt;URLConnection&lt;/code&gt;'s
     *          &lt;code&gt;useCaches&lt;/code&gt; field.
     * @see     java.net.URLConnection#useCaches
     */
    public boolean getUseCaches() {
<span class="fc" id="L334">        return jarFileURLConnection.getUseCaches();</span>
    }

    /**
     * Sets the value of the &lt;code&gt;ifModifiedSince&lt;/code&gt; field of
     * this &lt;code&gt;URLConnection&lt;/code&gt; to the specified value.
     *
     * @param   value   the new value.
     * @see     java.net.URLConnection#ifModifiedSince
     */
    public void setIfModifiedSince(long ifmodifiedsince) {
<span class="nc" id="L345">        jarFileURLConnection.setIfModifiedSince(ifmodifiedsince);</span>
<span class="nc" id="L346">    }</span>

   /**
     * Sets the default value of the &lt;code&gt;useCaches&lt;/code&gt; field to the
     * specified value.
     *
     * @param   defaultusecaches   the new value.
     * @see     java.net.URLConnection#useCaches
     */
    public void setDefaultUseCaches(boolean defaultusecaches) {
<span class="nc" id="L356">        jarFileURLConnection.setDefaultUseCaches(defaultusecaches);</span>
<span class="nc" id="L357">    }</span>

   /**
     * Returns the default value of a &lt;code&gt;URLConnection&lt;/code&gt;'s
     * &lt;code&gt;useCaches&lt;/code&gt; flag.
     * &lt;p&gt;
     * Ths default is &quot;sticky&quot;, being a part of the static state of all
     * URLConnections.  This flag applies to the next, and all following
     * URLConnections that are created.
     *
     * @return  the default value of a &lt;code&gt;URLConnection&lt;/code&gt;'s
     *          &lt;code&gt;useCaches&lt;/code&gt; flag.
     * @see     java.net.URLConnection#useCaches
     */
    public boolean getDefaultUseCaches() {
<span class="nc" id="L372">        return jarFileURLConnection.getDefaultUseCaches();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>