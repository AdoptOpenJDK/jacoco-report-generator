<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>XSheet.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.tools.jconsole.inspector</a> &gt; <span class="el_source">XSheet.java</span></div><h1>XSheet.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2004, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jconsole.inspector;


import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.IOException;

import javax.management.IntrospectionException;
import javax.management.NotificationListener;
import javax.management.MBeanInfo;
import javax.management.InstanceNotFoundException;
import javax.management.ReflectionException;
import javax.management.MBeanAttributeInfo;
import javax.management.MBeanOperationInfo;
import javax.management.MBeanNotificationInfo;
import javax.management.Notification;
import javax.swing.BorderFactory;
import javax.swing.JButton;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.SwingWorker;
import javax.swing.border.LineBorder;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeModel;

import sun.tools.jconsole.*;
import sun.tools.jconsole.inspector.XNodeInfo.Type;

@SuppressWarnings(&quot;serial&quot;)
public class XSheet extends JPanel
        implements ActionListener, NotificationListener {

    private JPanel mainPanel;
    private JPanel southPanel;
    // Node being currently displayed
    private volatile DefaultMutableTreeNode currentNode;
    // MBean being currently displayed
    private volatile XMBean mbean;
    // XMBeanAttributes container
    private XMBeanAttributes mbeanAttributes;
    // XMBeanOperations container
    private XMBeanOperations mbeanOperations;
    // XMBeanNotifications container
    private XMBeanNotifications mbeanNotifications;
    // XMBeanInfo container
    private XMBeanInfo mbeanInfo;
    // Refresh JButton (mbean attributes case)
    private JButton refreshButton;
    // Subscribe/Unsubscribe/Clear JButton (mbean notifications case)
    private JButton clearButton,  subscribeButton,  unsubscribeButton;
    // Reference to MBeans tab
    private MBeansTab mbeansTab;

<span class="nc" id="L85">    public XSheet(MBeansTab mbeansTab) {</span>
<span class="nc" id="L86">        this.mbeansTab = mbeansTab;</span>
<span class="nc" id="L87">        setupScreen();</span>
<span class="nc" id="L88">    }</span>

    public void dispose() {
<span class="nc" id="L91">        clear();</span>
<span class="nc" id="L92">        XDataViewer.dispose(mbeansTab);</span>
<span class="nc" id="L93">        mbeanNotifications.dispose();</span>
<span class="nc" id="L94">    }</span>

    private void setupScreen() {
<span class="nc" id="L97">        setLayout(new BorderLayout());</span>
<span class="nc" id="L98">        setBorder(BorderFactory.createLineBorder(Color.GRAY));</span>
        // add main panel to XSheet
<span class="nc" id="L100">        mainPanel = new JPanel();</span>
<span class="nc" id="L101">        mainPanel.setLayout(new BorderLayout());</span>
<span class="nc" id="L102">        add(mainPanel, BorderLayout.CENTER);</span>
        // add south panel to XSheet
<span class="nc" id="L104">        southPanel = new JPanel();</span>
<span class="nc" id="L105">        add(southPanel, BorderLayout.SOUTH);</span>
        // create the refresh button
<span class="nc" id="L107">        refreshButton = new JButton(Messages.MBEANS_TAB_REFRESH_ATTRIBUTES_BUTTON);</span>
<span class="nc" id="L108">        refreshButton.setMnemonic(Resources.getMnemonicInt(Messages.MBEANS_TAB_REFRESH_ATTRIBUTES_BUTTON));</span>
<span class="nc" id="L109">        refreshButton.setToolTipText(Messages.MBEANS_TAB_REFRESH_ATTRIBUTES_BUTTON_TOOLTIP);</span>
<span class="nc" id="L110">        refreshButton.addActionListener(this);</span>
        // create the clear button
<span class="nc" id="L112">        clearButton = new JButton(Messages.MBEANS_TAB_CLEAR_NOTIFICATIONS_BUTTON);</span>
<span class="nc" id="L113">        clearButton.setMnemonic(Resources.getMnemonicInt(Messages.MBEANS_TAB_CLEAR_NOTIFICATIONS_BUTTON));</span>
<span class="nc" id="L114">        clearButton.setToolTipText(Messages.MBEANS_TAB_CLEAR_NOTIFICATIONS_BUTTON_TOOLTIP);</span>
<span class="nc" id="L115">        clearButton.addActionListener(this);</span>
        // create the subscribe button
<span class="nc" id="L117">        subscribeButton = new JButton(Messages.MBEANS_TAB_SUBSCRIBE_NOTIFICATIONS_BUTTON);</span>
<span class="nc" id="L118">        subscribeButton.setMnemonic(Resources.getMnemonicInt(Messages.MBEANS_TAB_SUBSCRIBE_NOTIFICATIONS_BUTTON));</span>
<span class="nc" id="L119">        subscribeButton.setToolTipText(Messages.MBEANS_TAB_SUBSCRIBE_NOTIFICATIONS_BUTTON_TOOLTIP);</span>
<span class="nc" id="L120">        subscribeButton.addActionListener(this);</span>
        // create the unsubscribe button
<span class="nc" id="L122">        unsubscribeButton = new JButton(Messages.MBEANS_TAB_UNSUBSCRIBE_NOTIFICATIONS_BUTTON);</span>
<span class="nc" id="L123">        unsubscribeButton.setMnemonic(Resources.getMnemonicInt(Messages.MBEANS_TAB_UNSUBSCRIBE_NOTIFICATIONS_BUTTON));</span>
<span class="nc" id="L124">        unsubscribeButton.setToolTipText(Messages.MBEANS_TAB_UNSUBSCRIBE_NOTIFICATIONS_BUTTON_TOOLTIP);</span>
<span class="nc" id="L125">        unsubscribeButton.addActionListener(this);</span>
        // create XMBeanAttributes container
<span class="nc" id="L127">        mbeanAttributes = new XMBeanAttributes(mbeansTab);</span>
        // create XMBeanOperations container
<span class="nc" id="L129">        mbeanOperations = new XMBeanOperations(mbeansTab);</span>
<span class="nc" id="L130">        mbeanOperations.addOperationsListener(this);</span>
        // create XMBeanNotifications container
<span class="nc" id="L132">        mbeanNotifications = new XMBeanNotifications();</span>
<span class="nc" id="L133">        mbeanNotifications.addNotificationsListener(this);</span>
        // create XMBeanInfo container
<span class="nc" id="L135">        mbeanInfo = new XMBeanInfo();</span>
<span class="nc" id="L136">    }</span>

    private boolean isSelectedNode(DefaultMutableTreeNode n, DefaultMutableTreeNode cn) {
<span class="nc bnc" id="L139" title="All 2 branches missed.">        return (cn == n);</span>
    }

    // Call on EDT
    private void showErrorDialog(Object message, String title) {
<span class="nc" id="L144">        new ThreadDialog(this, message, title, JOptionPane.ERROR_MESSAGE).run();</span>
<span class="nc" id="L145">    }</span>

    public boolean isMBeanNode(DefaultMutableTreeNode node) {
<span class="nc" id="L148">        Object userObject = node.getUserObject();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (userObject instanceof XNodeInfo) {</span>
<span class="nc" id="L150">            XNodeInfo uo = (XNodeInfo) userObject;</span>
<span class="nc" id="L151">            return uo.getType().equals(Type.MBEAN);</span>
        }
<span class="nc" id="L153">        return false;</span>
    }

    // Call on EDT
    public synchronized void displayNode(DefaultMutableTreeNode node) {
<span class="nc" id="L158">        clear();</span>
<span class="nc" id="L159">        displayEmptyNode();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (node == null) {</span>
<span class="nc" id="L161">            return;</span>
        }
<span class="nc" id="L163">        currentNode = node;</span>
<span class="nc" id="L164">        Object userObject = node.getUserObject();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (userObject instanceof XNodeInfo) {</span>
<span class="nc" id="L166">            XNodeInfo uo = (XNodeInfo) userObject;</span>
<span class="nc bnc" id="L167" title="All 7 branches missed.">            switch (uo.getType()) {</span>
                case MBEAN:
<span class="nc" id="L169">                    displayMBeanNode(node);</span>
<span class="nc" id="L170">                    break;</span>
                case NONMBEAN:
<span class="nc" id="L172">                    displayEmptyNode();</span>
<span class="nc" id="L173">                    break;</span>
                case ATTRIBUTES:
<span class="nc" id="L175">                    displayMBeanAttributesNode(node);</span>
<span class="nc" id="L176">                    break;</span>
                case OPERATIONS:
<span class="nc" id="L178">                    displayMBeanOperationsNode(node);</span>
<span class="nc" id="L179">                    break;</span>
                case NOTIFICATIONS:
<span class="nc" id="L181">                    displayMBeanNotificationsNode(node);</span>
<span class="nc" id="L182">                    break;</span>
                case ATTRIBUTE:
                case OPERATION:
                case NOTIFICATION:
<span class="nc" id="L186">                    displayMetadataNode(node);</span>
<span class="nc" id="L187">                    break;</span>
                default:
<span class="nc" id="L189">                    displayEmptyNode();</span>
                    break;
            }
<span class="nc" id="L192">        } else {</span>
<span class="nc" id="L193">            displayEmptyNode();</span>
        }
<span class="nc" id="L195">    }</span>

    // Call on EDT
    private void displayMBeanNode(final DefaultMutableTreeNode node) {
<span class="nc" id="L199">        final XNodeInfo uo = (XNodeInfo) node.getUserObject();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (!uo.getType().equals(Type.MBEAN)) {</span>
<span class="nc" id="L201">            return;</span>
        }
<span class="nc" id="L203">        mbean = (XMBean) uo.getData();</span>
<span class="nc" id="L204">        SwingWorker&lt;MBeanInfo, Void&gt; sw = new SwingWorker&lt;MBeanInfo, Void&gt;() {</span>
            @Override
            public MBeanInfo doInBackground() throws InstanceNotFoundException,
                    IntrospectionException, ReflectionException, IOException {
<span class="nc" id="L208">                return mbean.getMBeanInfo();</span>
            }
            @Override
            protected void done() {
                try {
<span class="nc" id="L213">                    MBeanInfo mbi = get();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                    if (mbi != null) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                        if (!isSelectedNode(node, currentNode)) {</span>
<span class="nc" id="L216">                            return;</span>
                        }
<span class="nc" id="L218">                        mbeanInfo.addMBeanInfo(mbean, mbi);</span>
<span class="nc" id="L219">                        invalidate();</span>
<span class="nc" id="L220">                        mainPanel.removeAll();</span>
<span class="nc" id="L221">                        mainPanel.add(mbeanInfo, BorderLayout.CENTER);</span>
<span class="nc" id="L222">                        southPanel.setVisible(false);</span>
<span class="nc" id="L223">                        southPanel.removeAll();</span>
<span class="nc" id="L224">                        validate();</span>
<span class="nc" id="L225">                        repaint();</span>
                    }
<span class="nc" id="L227">                } catch (Exception e) {</span>
<span class="nc" id="L228">                    Throwable t = Utils.getActualException(e);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L230">                        System.err.println(&quot;Couldn't get MBeanInfo for MBean [&quot; +</span>
<span class="nc" id="L231">                                mbean.getObjectName() + &quot;]&quot;);</span>
<span class="nc" id="L232">                        t.printStackTrace();</span>
                    }
<span class="nc" id="L234">                    showErrorDialog(t.toString(),</span>
                            Messages.PROBLEM_DISPLAYING_MBEAN);
<span class="nc" id="L236">                }</span>
<span class="nc" id="L237">            }</span>
        };
<span class="nc" id="L239">        sw.execute();</span>
<span class="nc" id="L240">    }</span>

    // Call on EDT
    private void displayMetadataNode(final DefaultMutableTreeNode node) {
<span class="nc" id="L244">        final XNodeInfo uo = (XNodeInfo) node.getUserObject();</span>
<span class="nc" id="L245">        final XMBeanInfo mbi = mbeanInfo;</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">        switch (uo.getType()) {</span>
            case ATTRIBUTE:
<span class="nc" id="L248">                SwingWorker&lt;MBeanAttributeInfo, Void&gt; sw =</span>
<span class="nc" id="L249">                        new SwingWorker&lt;MBeanAttributeInfo, Void&gt;() {</span>
                            @Override
                            public MBeanAttributeInfo doInBackground() {
<span class="nc" id="L252">                                Object attrData = uo.getData();</span>
<span class="nc" id="L253">                                mbean = (XMBean) ((Object[]) attrData)[0];</span>
<span class="nc" id="L254">                                MBeanAttributeInfo mbai =</span>
                                        (MBeanAttributeInfo) ((Object[]) attrData)[1];
<span class="nc" id="L256">                                mbeanAttributes.loadAttributes(mbean, new MBeanInfo(</span>
                                        null, null, new MBeanAttributeInfo[]{mbai},
                                        null, null, null));
<span class="nc" id="L259">                                return mbai;</span>
                            }
                            @Override
                            protected void done() {
                                try {
<span class="nc" id="L264">                                    MBeanAttributeInfo mbai = get();</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                                    if (!isSelectedNode(node, currentNode)) {</span>
<span class="nc" id="L266">                                        return;</span>
                                    }
<span class="nc" id="L268">                                    invalidate();</span>
<span class="nc" id="L269">                                    mainPanel.removeAll();</span>
<span class="nc" id="L270">                                    JPanel attributePanel =</span>
                                            new JPanel(new BorderLayout());
<span class="nc" id="L272">                                    JPanel attributeBorderPanel =</span>
                                            new JPanel(new BorderLayout());
<span class="nc" id="L274">                                    attributeBorderPanel.setBorder(</span>
<span class="nc" id="L275">                                            BorderFactory.createTitledBorder(</span>
                                            Messages.ATTRIBUTE_VALUE));
<span class="nc" id="L277">                                    JPanel attributeValuePanel =</span>
                                            new JPanel(new BorderLayout());
<span class="nc" id="L279">                                    attributeValuePanel.setBorder(</span>
<span class="nc" id="L280">                                            LineBorder.createGrayLineBorder());</span>
<span class="nc" id="L281">                                    attributeValuePanel.add(mbeanAttributes.getTableHeader(),</span>
                                            BorderLayout.PAGE_START);
<span class="nc" id="L283">                                    attributeValuePanel.add(mbeanAttributes,</span>
                                            BorderLayout.CENTER);
<span class="nc" id="L285">                                    attributeBorderPanel.add(attributeValuePanel,</span>
                                            BorderLayout.CENTER);
<span class="nc" id="L287">                                    JPanel refreshButtonPanel = new JPanel();</span>
<span class="nc" id="L288">                                    refreshButtonPanel.add(refreshButton);</span>
<span class="nc" id="L289">                                    attributeBorderPanel.add(refreshButtonPanel,</span>
                                            BorderLayout.SOUTH);
<span class="nc" id="L291">                                    refreshButton.setEnabled(true);</span>
<span class="nc" id="L292">                                    attributePanel.add(attributeBorderPanel,</span>
                                            BorderLayout.NORTH);
<span class="nc" id="L294">                                    mbi.addMBeanAttributeInfo(mbai);</span>
<span class="nc" id="L295">                                    attributePanel.add(mbi, BorderLayout.CENTER);</span>
<span class="nc" id="L296">                                    mainPanel.add(attributePanel,</span>
                                            BorderLayout.CENTER);
<span class="nc" id="L298">                                    southPanel.setVisible(false);</span>
<span class="nc" id="L299">                                    southPanel.removeAll();</span>
<span class="nc" id="L300">                                    validate();</span>
<span class="nc" id="L301">                                    repaint();</span>
<span class="nc" id="L302">                                } catch (Exception e) {</span>
<span class="nc" id="L303">                                    Throwable t = Utils.getActualException(e);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L305">                                        System.err.println(&quot;Problem displaying MBean &quot; +</span>
                                                &quot;attribute for MBean [&quot; +
<span class="nc" id="L307">                                                mbean.getObjectName() + &quot;]&quot;);</span>
<span class="nc" id="L308">                                        t.printStackTrace();</span>
                                    }
<span class="nc" id="L310">                                    showErrorDialog(t.toString(),</span>
                                            Messages.PROBLEM_DISPLAYING_MBEAN);
<span class="nc" id="L312">                                }</span>
<span class="nc" id="L313">                            }</span>
                        };
<span class="nc" id="L315">                sw.execute();</span>
<span class="nc" id="L316">                break;</span>
            case OPERATION:
<span class="nc" id="L318">                Object operData = uo.getData();</span>
<span class="nc" id="L319">                mbean = (XMBean) ((Object[]) operData)[0];</span>
<span class="nc" id="L320">                MBeanOperationInfo mboi =</span>
                        (MBeanOperationInfo) ((Object[]) operData)[1];
<span class="nc" id="L322">                mbeanOperations.loadOperations(mbean,</span>
                        new MBeanInfo(null, null, null, null,
                        new MBeanOperationInfo[]{mboi}, null));
<span class="nc" id="L325">                invalidate();</span>
<span class="nc" id="L326">                mainPanel.removeAll();</span>
<span class="nc" id="L327">                JPanel operationPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L328">                JPanel operationBorderPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L329">                operationBorderPanel.setBorder(BorderFactory.createTitledBorder(</span>
                        Messages.OPERATION_INVOCATION));
<span class="nc" id="L331">                operationBorderPanel.add(new JScrollPane(mbeanOperations));</span>
<span class="nc" id="L332">                operationPanel.add(operationBorderPanel, BorderLayout.NORTH);</span>
<span class="nc" id="L333">                mbi.addMBeanOperationInfo(mboi);</span>
<span class="nc" id="L334">                operationPanel.add(mbi, BorderLayout.CENTER);</span>
<span class="nc" id="L335">                mainPanel.add(operationPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L336">                southPanel.setVisible(false);</span>
<span class="nc" id="L337">                southPanel.removeAll();</span>
<span class="nc" id="L338">                validate();</span>
<span class="nc" id="L339">                repaint();</span>
<span class="nc" id="L340">                break;</span>
            case NOTIFICATION:
<span class="nc" id="L342">                Object notifData = uo.getData();</span>
<span class="nc" id="L343">                invalidate();</span>
<span class="nc" id="L344">                mainPanel.removeAll();</span>
<span class="nc" id="L345">                mbi.addMBeanNotificationInfo((MBeanNotificationInfo) notifData);</span>
<span class="nc" id="L346">                mainPanel.add(mbi, BorderLayout.CENTER);</span>
<span class="nc" id="L347">                southPanel.setVisible(false);</span>
<span class="nc" id="L348">                southPanel.removeAll();</span>
<span class="nc" id="L349">                validate();</span>
<span class="nc" id="L350">                repaint();</span>
                break;
        }
<span class="nc" id="L353">    }</span>

    // Call on EDT
    private void displayMBeanAttributesNode(final DefaultMutableTreeNode node) {
<span class="nc" id="L357">        final XNodeInfo uo = (XNodeInfo) node.getUserObject();</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (!uo.getType().equals(Type.ATTRIBUTES)) {</span>
<span class="nc" id="L359">            return;</span>
        }
<span class="nc" id="L361">        mbean = (XMBean) uo.getData();</span>
<span class="nc" id="L362">        final XMBean xmb = mbean;</span>
<span class="nc" id="L363">        SwingWorker&lt;MBeanInfo,Void&gt; sw = new SwingWorker&lt;MBeanInfo,Void&gt;() {</span>
            @Override
            public MBeanInfo doInBackground() throws InstanceNotFoundException,
                    IntrospectionException, ReflectionException, IOException {
<span class="nc" id="L367">                MBeanInfo mbi = xmb.getMBeanInfo();</span>
<span class="nc" id="L368">                return mbi;</span>
            }
            @Override
            protected void done() {
                try {
<span class="nc" id="L373">                    MBeanInfo mbi = get();</span>
<span class="nc bnc" id="L374" title="All 4 branches missed.">                    if (mbi != null &amp;&amp; mbi.getAttributes() != null &amp;&amp;</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                            mbi.getAttributes().length &gt; 0) {</span>

<span class="nc" id="L377">                        mbeanAttributes.loadAttributes(xmb, mbi);</span>

<span class="nc bnc" id="L379" title="All 2 branches missed.">                        if (!isSelectedNode(node, currentNode)) {</span>
<span class="nc" id="L380">                            return;</span>
                        }
<span class="nc" id="L382">                        invalidate();</span>
<span class="nc" id="L383">                        mainPanel.removeAll();</span>
<span class="nc" id="L384">                        JPanel borderPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L385">                        borderPanel.setBorder(BorderFactory.createTitledBorder(</span>
                                Messages.ATTRIBUTE_VALUES));
<span class="nc" id="L387">                        borderPanel.add(new JScrollPane(mbeanAttributes));</span>
<span class="nc" id="L388">                        mainPanel.add(borderPanel, BorderLayout.CENTER);</span>
                        // add the refresh button to the south panel
<span class="nc" id="L390">                        southPanel.removeAll();</span>
<span class="nc" id="L391">                        southPanel.add(refreshButton, BorderLayout.SOUTH);</span>
<span class="nc" id="L392">                        southPanel.setVisible(true);</span>
<span class="nc" id="L393">                        refreshButton.setEnabled(true);</span>
<span class="nc" id="L394">                        validate();</span>
<span class="nc" id="L395">                        repaint();</span>
                    }
<span class="nc" id="L397">                } catch (Exception e) {</span>
<span class="nc" id="L398">                    Throwable t = Utils.getActualException(e);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L400">                        System.err.println(&quot;Problem displaying MBean &quot; +</span>
                                &quot;attributes for MBean [&quot; +
<span class="nc" id="L402">                                mbean.getObjectName() + &quot;]&quot;);</span>
<span class="nc" id="L403">                        t.printStackTrace();</span>
                    }
<span class="nc" id="L405">                    showErrorDialog(t.toString(),</span>
                            Messages.PROBLEM_DISPLAYING_MBEAN);
<span class="nc" id="L407">                }</span>
<span class="nc" id="L408">            }</span>
        };
<span class="nc" id="L410">        sw.execute();</span>
<span class="nc" id="L411">    }</span>

    // Call on EDT
    private void displayMBeanOperationsNode(final DefaultMutableTreeNode node) {
<span class="nc" id="L415">        final XNodeInfo uo = (XNodeInfo) node.getUserObject();</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (!uo.getType().equals(Type.OPERATIONS)) {</span>
<span class="nc" id="L417">            return;</span>
        }
<span class="nc" id="L419">        mbean = (XMBean) uo.getData();</span>
<span class="nc" id="L420">        SwingWorker&lt;MBeanInfo, Void&gt; sw = new SwingWorker&lt;MBeanInfo, Void&gt;() {</span>
            @Override
            public MBeanInfo doInBackground() throws InstanceNotFoundException,
                    IntrospectionException, ReflectionException, IOException {
<span class="nc" id="L424">                return mbean.getMBeanInfo();</span>
            }
            @Override
            protected void done() {
                try {
<span class="nc" id="L429">                    MBeanInfo mbi = get();</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">                    if (mbi != null) {</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">                        if (!isSelectedNode(node, currentNode)) {</span>
<span class="nc" id="L432">                            return;</span>
                        }
<span class="nc" id="L434">                        mbeanOperations.loadOperations(mbean, mbi);</span>
<span class="nc" id="L435">                        invalidate();</span>
<span class="nc" id="L436">                        mainPanel.removeAll();</span>
<span class="nc" id="L437">                        JPanel borderPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L438">                        borderPanel.setBorder(BorderFactory.createTitledBorder(</span>
                                Messages.OPERATION_INVOCATION));
<span class="nc" id="L440">                        borderPanel.add(new JScrollPane(mbeanOperations));</span>
<span class="nc" id="L441">                        mainPanel.add(borderPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L442">                        southPanel.setVisible(false);</span>
<span class="nc" id="L443">                        southPanel.removeAll();</span>
<span class="nc" id="L444">                        validate();</span>
<span class="nc" id="L445">                        repaint();</span>
                    }
<span class="nc" id="L447">                } catch (Exception e) {</span>
<span class="nc" id="L448">                    Throwable t = Utils.getActualException(e);</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L450">                        System.err.println(&quot;Problem displaying MBean &quot; +</span>
                                &quot;operations for MBean [&quot; +
<span class="nc" id="L452">                                mbean.getObjectName() + &quot;]&quot;);</span>
<span class="nc" id="L453">                        t.printStackTrace();</span>
                    }
<span class="nc" id="L455">                    showErrorDialog(t.toString(),</span>
                            Messages.PROBLEM_DISPLAYING_MBEAN);
<span class="nc" id="L457">                }</span>
<span class="nc" id="L458">            }</span>
        };
<span class="nc" id="L460">        sw.execute();</span>
<span class="nc" id="L461">    }</span>

    // Call on EDT
    private void displayMBeanNotificationsNode(DefaultMutableTreeNode node) {
<span class="nc" id="L465">        final XNodeInfo uo = (XNodeInfo) node.getUserObject();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (!uo.getType().equals(Type.NOTIFICATIONS)) {</span>
<span class="nc" id="L467">            return;</span>
        }
<span class="nc" id="L469">        mbean = (XMBean) uo.getData();</span>
<span class="nc" id="L470">        mbeanNotifications.loadNotifications(mbean);</span>
<span class="nc" id="L471">        updateNotifications();</span>
<span class="nc" id="L472">        invalidate();</span>
<span class="nc" id="L473">        mainPanel.removeAll();</span>
<span class="nc" id="L474">        JPanel borderPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L475">        borderPanel.setBorder(BorderFactory.createTitledBorder(</span>
                Messages.NOTIFICATION_BUFFER));
<span class="nc" id="L477">        borderPanel.add(new JScrollPane(mbeanNotifications));</span>
<span class="nc" id="L478">        mainPanel.add(borderPanel, BorderLayout.CENTER);</span>
        // add the subscribe/unsubscribe/clear buttons to the south panel
<span class="nc" id="L480">        southPanel.removeAll();</span>
<span class="nc" id="L481">        southPanel.add(subscribeButton, BorderLayout.WEST);</span>
<span class="nc" id="L482">        southPanel.add(unsubscribeButton, BorderLayout.CENTER);</span>
<span class="nc" id="L483">        southPanel.add(clearButton, BorderLayout.EAST);</span>
<span class="nc" id="L484">        southPanel.setVisible(true);</span>
<span class="nc" id="L485">        subscribeButton.setEnabled(true);</span>
<span class="nc" id="L486">        unsubscribeButton.setEnabled(true);</span>
<span class="nc" id="L487">        clearButton.setEnabled(true);</span>
<span class="nc" id="L488">        validate();</span>
<span class="nc" id="L489">        repaint();</span>
<span class="nc" id="L490">    }</span>

    // Call on EDT
    private void displayEmptyNode() {
<span class="nc" id="L494">        invalidate();</span>
<span class="nc" id="L495">        mainPanel.removeAll();</span>
<span class="nc" id="L496">        southPanel.removeAll();</span>
<span class="nc" id="L497">        validate();</span>
<span class="nc" id="L498">        repaint();</span>
<span class="nc" id="L499">    }</span>

    /**
     * Subscribe button action.
     */
    private void registerListener() {
<span class="nc" id="L505">        new SwingWorker&lt;Void, Void&gt;() {</span>
            @Override
            public Void doInBackground()
                    throws InstanceNotFoundException, IOException {
<span class="nc" id="L509">                mbeanNotifications.registerListener(currentNode);</span>
<span class="nc" id="L510">                return null;</span>
            }
            @Override
            protected void done() {
                try {
<span class="nc" id="L515">                    get();</span>
<span class="nc" id="L516">                    updateNotifications();</span>
<span class="nc" id="L517">                    validate();</span>
<span class="nc" id="L518">                } catch (Exception e) {</span>
<span class="nc" id="L519">                    Throwable t = Utils.getActualException(e);</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L521">                        System.err.println(&quot;Problem adding listener&quot;);</span>
<span class="nc" id="L522">                        t.printStackTrace();</span>
                    }
<span class="nc" id="L524">                    showErrorDialog(t.getMessage(),</span>
                            Messages.PROBLEM_ADDING_LISTENER);
<span class="nc" id="L526">                }</span>
<span class="nc" id="L527">            }</span>
<span class="nc" id="L528">        }.execute();</span>
<span class="nc" id="L529">    }</span>

    /**
     * Unsubscribe button action.
     */
    private void unregisterListener() {
<span class="nc" id="L535">        new SwingWorker&lt;Boolean, Void&gt;() {</span>
            @Override
            public Boolean doInBackground() {
<span class="nc" id="L538">                return mbeanNotifications.unregisterListener(currentNode);</span>
            }
            @Override
            protected void done() {
                try {
<span class="nc bnc" id="L543" title="All 2 branches missed.">                    if (get()) {</span>
<span class="nc" id="L544">                        updateNotifications();</span>
<span class="nc" id="L545">                        validate();</span>
                    }
<span class="nc" id="L547">                } catch (Exception e) {</span>
<span class="nc" id="L548">                    Throwable t = Utils.getActualException(e);</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">                    if (JConsole.isDebug()) {</span>
<span class="nc" id="L550">                        System.err.println(&quot;Problem removing listener&quot;);</span>
<span class="nc" id="L551">                        t.printStackTrace();</span>
                    }
<span class="nc" id="L553">                    showErrorDialog(t.getMessage(),</span>
                            Messages.PROBLEM_REMOVING_LISTENER);
<span class="nc" id="L555">                }</span>
<span class="nc" id="L556">            }</span>
<span class="nc" id="L557">        }.execute();</span>
<span class="nc" id="L558">    }</span>

    /**
     * Refresh button action.
     */
    private void refreshAttributes() {
<span class="nc" id="L564">        mbeanAttributes.refreshAttributes();</span>
<span class="nc" id="L565">    }</span>

    // Call on EDT
    private void updateNotifications() {
<span class="nc bnc" id="L569" title="All 2 branches missed.">        if (mbeanNotifications.isListenerRegistered(mbean)) {</span>
<span class="nc" id="L570">            long received = mbeanNotifications.getReceivedNotifications(mbean);</span>
<span class="nc" id="L571">            updateReceivedNotifications(currentNode, received, false);</span>
<span class="nc" id="L572">        } else {</span>
<span class="nc" id="L573">            clearNotifications();</span>
        }
<span class="nc" id="L575">    }</span>

    /**
     * Update notification node label in MBean tree: &quot;Notifications[received]&quot;.
     */
    // Call on EDT
    private void updateReceivedNotifications(
            DefaultMutableTreeNode emitter, long received, boolean bold) {
<span class="nc" id="L583">        String text = Messages.NOTIFICATIONS + &quot;[&quot; + received + &quot;]&quot;;</span>
<span class="nc" id="L584">        DefaultMutableTreeNode selectedNode = (DefaultMutableTreeNode) mbeansTab.getTree().getLastSelectedPathComponent();</span>
<span class="nc bnc" id="L585" title="All 4 branches missed.">        if (bold &amp;&amp; emitter != selectedNode) {</span>
<span class="nc" id="L586">            text = &quot;&lt;html&gt;&lt;b&gt;&quot; + text + &quot;&lt;/b&gt;&lt;/html&gt;&quot;;</span>
        }
<span class="nc" id="L588">        updateNotificationsNodeLabel(emitter, text);</span>
<span class="nc" id="L589">    }</span>

    /**
     * Update notification node label in MBean tree: &quot;Notifications&quot;.
     */
    // Call on EDT
    private void clearNotifications() {
<span class="nc" id="L596">        updateNotificationsNodeLabel(currentNode,</span>
                Messages.NOTIFICATIONS);
<span class="nc" id="L598">    }</span>

    /**
     * Update notification node label in MBean tree: &quot;Notifications[0]&quot;.
     */
    // Call on EDT
    private void clearNotifications0() {
<span class="nc" id="L605">        updateNotificationsNodeLabel(currentNode,</span>
                Messages.NOTIFICATIONS + &quot;[0]&quot;);
<span class="nc" id="L607">    }</span>

    /**
     * Update the label of the supplied MBean tree node.
     */
    // Call on EDT
    private void updateNotificationsNodeLabel(
            DefaultMutableTreeNode node, String label) {
<span class="nc" id="L615">        synchronized (mbeansTab.getTree()) {</span>
<span class="nc" id="L616">            invalidate();</span>
<span class="nc" id="L617">            XNodeInfo oldUserObject = (XNodeInfo) node.getUserObject();</span>
<span class="nc" id="L618">            XNodeInfo newUserObject = new XNodeInfo(</span>
<span class="nc" id="L619">                    oldUserObject.getType(), oldUserObject.getData(),</span>
<span class="nc" id="L620">                    label, oldUserObject.getToolTipText());</span>
<span class="nc" id="L621">            node.setUserObject(newUserObject);</span>
<span class="nc" id="L622">            DefaultTreeModel model =</span>
<span class="nc" id="L623">                    (DefaultTreeModel) mbeansTab.getTree().getModel();</span>
<span class="nc" id="L624">            model.nodeChanged(node);</span>
<span class="nc" id="L625">            validate();</span>
<span class="nc" id="L626">            repaint();</span>
<span class="nc" id="L627">        }</span>
<span class="nc" id="L628">    }</span>

    /**
     * Clear button action.
     */
    // Call on EDT
    private void clearCurrentNotifications() {
<span class="nc" id="L635">        mbeanNotifications.clearCurrentNotifications();</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (mbeanNotifications.isListenerRegistered(mbean)) {</span>
            // Update notifs in MBean tree &quot;Notifications[0]&quot;.
            //
            // Notification buffer has been cleared with a listener been
            // registered so add &quot;[0]&quot; at the end of the node label.
            //
<span class="nc" id="L642">            clearNotifications0();</span>
        } else {
            // Update notifs in MBean tree &quot;Notifications&quot;.
            //
            // Notification buffer has been cleared without a listener been
            // registered so don't add &quot;[0]&quot; at the end of the node label.
            //
<span class="nc" id="L649">            clearNotifications();</span>
        }
<span class="nc" id="L651">    }</span>

    // Call on EDT
    private void clear() {
<span class="nc" id="L655">        mbeanAttributes.stopCellEditing();</span>
<span class="nc" id="L656">        mbeanAttributes.emptyTable();</span>
<span class="nc" id="L657">        mbeanAttributes.removeAttributes();</span>
<span class="nc" id="L658">        mbeanOperations.removeOperations();</span>
<span class="nc" id="L659">        mbeanNotifications.stopCellEditing();</span>
<span class="nc" id="L660">        mbeanNotifications.emptyTable();</span>
<span class="nc" id="L661">        mbeanNotifications.disableNotifications();</span>
<span class="nc" id="L662">        mbean = null;</span>
<span class="nc" id="L663">        currentNode = null;</span>
<span class="nc" id="L664">    }</span>

    /**
     * Notification listener: handles asynchronous reception
     * of MBean operation results and MBean notifications.
     */
    // Call on EDT
    public void handleNotification(Notification e, Object handback) {
        // Operation result
<span class="nc bnc" id="L673" title="All 2 branches missed.">        if (e.getType().equals(XOperations.OPERATION_INVOCATION_EVENT)) {</span>
            final Object message;
<span class="nc bnc" id="L675" title="All 2 branches missed.">            if (handback == null) {</span>
<span class="nc" id="L676">                JTextArea textArea = new JTextArea(&quot;null&quot;);</span>
<span class="nc" id="L677">                textArea.setEditable(false);</span>
<span class="nc" id="L678">                textArea.setEnabled(true);</span>
<span class="nc" id="L679">                textArea.setRows(textArea.getLineCount());</span>
<span class="nc" id="L680">                message = textArea;</span>
<span class="nc" id="L681">            } else {</span>
<span class="nc" id="L682">                Component comp = mbeansTab.getDataViewer().</span>
<span class="nc" id="L683">                        createOperationViewer(handback, mbean);</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">                if (comp == null) {</span>
<span class="nc" id="L685">                    JTextArea textArea = new JTextArea(handback.toString());</span>
<span class="nc" id="L686">                    textArea.setEditable(false);</span>
<span class="nc" id="L687">                    textArea.setEnabled(true);</span>
<span class="nc" id="L688">                    textArea.setRows(textArea.getLineCount());</span>
<span class="nc" id="L689">                    JScrollPane scrollPane = new JScrollPane(textArea);</span>
<span class="nc" id="L690">                    Dimension d = scrollPane.getPreferredSize();</span>
<span class="nc bnc" id="L691" title="All 4 branches missed.">                    if (d.getWidth() &gt; 400 || d.getHeight() &gt; 250) {</span>
<span class="nc" id="L692">                        scrollPane.setPreferredSize(new Dimension(400, 250));</span>
                    }
<span class="nc" id="L694">                    message = scrollPane;</span>
<span class="nc" id="L695">                } else {</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                    if (!(comp instanceof JScrollPane)) {</span>
<span class="nc" id="L697">                        comp = new JScrollPane(comp);</span>
                    }
<span class="nc" id="L699">                    Dimension d = comp.getPreferredSize();</span>
<span class="nc bnc" id="L700" title="All 4 branches missed.">                    if (d.getWidth() &gt; 400 || d.getHeight() &gt; 250) {</span>
<span class="nc" id="L701">                        comp.setPreferredSize(new Dimension(400, 250));</span>
                    }
<span class="nc" id="L703">                    message = comp;</span>
                }
            }
<span class="nc" id="L706">            new ThreadDialog(</span>
<span class="nc" id="L707">                    (Component) e.getSource(),</span>
                    message,
                    Messages.OPERATION_RETURN_VALUE,
<span class="nc" id="L710">                    JOptionPane.INFORMATION_MESSAGE).run();</span>
<span class="nc" id="L711">        } // Got notification</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">        else if (e.getType().equals(</span>
                XMBeanNotifications.NOTIFICATION_RECEIVED_EVENT)) {
<span class="nc" id="L714">            DefaultMutableTreeNode emitter = (DefaultMutableTreeNode) handback;</span>
<span class="nc" id="L715">            Long received = (Long) e.getUserData();</span>
<span class="nc" id="L716">            updateReceivedNotifications(emitter, received.longValue(), true);</span>
        }
<span class="nc" id="L718">    }</span>

    /**
     * Action listener: handles actions in panel buttons
     */
    // Call on EDT
    public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L725" title="All 2 branches missed.">        if (e.getSource() instanceof JButton) {</span>
<span class="nc" id="L726">            JButton button = (JButton) e.getSource();</span>
            // Refresh button
<span class="nc bnc" id="L728" title="All 2 branches missed.">            if (button == refreshButton) {</span>
<span class="nc" id="L729">                refreshAttributes();</span>
<span class="nc" id="L730">                return;</span>
            }
            // Clear button
<span class="nc bnc" id="L733" title="All 2 branches missed.">            if (button == clearButton) {</span>
<span class="nc" id="L734">                clearCurrentNotifications();</span>
<span class="nc" id="L735">                return;</span>
            }
            // Subscribe button
<span class="nc bnc" id="L738" title="All 2 branches missed.">            if (button == subscribeButton) {</span>
<span class="nc" id="L739">                registerListener();</span>
<span class="nc" id="L740">                return;</span>
            }
            // Unsubscribe button
<span class="nc bnc" id="L743" title="All 2 branches missed.">            if (button == unsubscribeButton) {</span>
<span class="nc" id="L744">                unregisterListener();</span>
<span class="nc" id="L745">                return;</span>
            }
        }
<span class="nc" id="L748">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>