<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Init.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.org.apache.xml.internal.security</a> &gt; <span class="el_source">Init.java</span></div><h1>Init.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package com.sun.org.apache.xml.internal.security;

import java.io.InputStream;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.util.ArrayList;
import java.util.List;

import javax.xml.XMLConstants;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import com.sun.org.apache.xml.internal.security.algorithms.JCEMapper;
import com.sun.org.apache.xml.internal.security.algorithms.SignatureAlgorithm;
import com.sun.org.apache.xml.internal.security.c14n.Canonicalizer;
import com.sun.org.apache.xml.internal.security.keys.keyresolver.KeyResolver;
import com.sun.org.apache.xml.internal.security.transforms.Transform;
import com.sun.org.apache.xml.internal.security.utils.ElementProxy;
import com.sun.org.apache.xml.internal.security.utils.I18n;
import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
import com.sun.org.apache.xml.internal.security.utils.resolver.ResourceResolver;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;


/**
 * This class does the configuration of the library. This includes creating
 * the mapping of Canonicalization and Transform algorithms. Initialization is
 * done by calling {@link Init#init} which should be done in any static block
 * of the files of this library. We ensure that this call is only executed once.
 */
<span class="nc" id="L56">public class Init {</span>

    /** The namespace for CONF file **/
    public static final String CONF_NS = &quot;http://www.xmlsecurity.org/NS/#configuration&quot;;

    /** {@link org.apache.commons.logging} logging facility */
<span class="fc" id="L62">    private static java.util.logging.Logger log =</span>
<span class="fc" id="L63">        java.util.logging.Logger.getLogger(Init.class.getName());</span>

    /** Field alreadyInitialized */
<span class="fc" id="L66">    private static boolean alreadyInitialized = false;</span>

    /**
     * Method isInitialized
     * @return true if the library is already initialized.
     */
    public static synchronized final boolean isInitialized() {
<span class="nc" id="L73">        return Init.alreadyInitialized;</span>
    }

    /**
     * Method init
     *
     */
    public static synchronized void init() {
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (alreadyInitialized) {</span>
<span class="nc" id="L82">            return;</span>
        }

<span class="nc" id="L85">        InputStream is =</span>
<span class="nc" id="L86">            AccessController.doPrivileged(</span>
<span class="fc" id="L87">                new PrivilegedAction&lt;InputStream&gt;() {</span>
                    public InputStream run() {
<span class="fc" id="L89">                        String cfile =</span>
<span class="fc" id="L90">                            System.getProperty(&quot;com.sun.org.apache.xml.internal.security.resource.config&quot;);</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">                        if (cfile == null) {</span>
<span class="fc" id="L92">                            return null;</span>
                        }
<span class="nc" id="L94">                        return getClass().getResourceAsStream(cfile);</span>
                    }
                });
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (is == null) {</span>
<span class="nc" id="L98">            dynamicInit();</span>
        } else {
<span class="nc" id="L100">            fileInit(is);</span>
        }

<span class="nc" id="L103">        alreadyInitialized = true;</span>
<span class="nc" id="L104">    }</span>

    /**
     * Dynamically initialise the library by registering the default algorithms/implementations
     */
    private static void dynamicInit() {
        //
        // Load the Resource Bundle - the default is the English resource bundle.
        // To load another resource bundle, call I18n.init(...) before calling this
        // method.
        //
<span class="nc" id="L115">        I18n.init(&quot;en&quot;, &quot;US&quot;);</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L118">            log.log(java.util.logging.Level.FINE, &quot;Registering default algorithms&quot;);</span>
        }
        try {
            //
            // Bind the default prefixes
            //
<span class="nc" id="L124">            ElementProxy.registerDefaultPrefixes();</span>

            //
            // Set the default Transforms
            //
<span class="nc" id="L129">            Transform.registerDefaultAlgorithms();</span>

            //
            // Set the default signature algorithms
            //
<span class="nc" id="L134">            SignatureAlgorithm.registerDefaultAlgorithms();</span>

            //
            // Set the default JCE algorithms
            //
<span class="nc" id="L139">            JCEMapper.registerDefaultAlgorithms();</span>

            //
            // Set the default c14n algorithms
            //
<span class="nc" id="L144">            Canonicalizer.registerDefaultAlgorithms();</span>

            //
            // Register the default resolvers
            //
<span class="nc" id="L149">            ResourceResolver.registerDefaultResolvers();</span>

            //
            // Register the default key resolvers
            //
<span class="nc" id="L154">            KeyResolver.registerDefaultResolvers();</span>
<span class="nc" id="L155">        } catch (Exception ex) {</span>
<span class="nc" id="L156">            log.log(java.util.logging.Level.SEVERE, ex.getMessage(), ex);</span>
<span class="nc" id="L157">            ex.printStackTrace();</span>
<span class="nc" id="L158">        }</span>
<span class="nc" id="L159">    }</span>

    /**
     * Initialise the library from a configuration file
     */
    private static void fileInit(InputStream is) {
        try {
            /* read library configuration file */
<span class="nc" id="L167">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L168">            dbf.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, Boolean.TRUE);</span>

<span class="nc" id="L170">            dbf.setNamespaceAware(true);</span>
<span class="nc" id="L171">            dbf.setValidating(false);</span>

<span class="nc" id="L173">            DocumentBuilder db = dbf.newDocumentBuilder();</span>
<span class="nc" id="L174">            Document doc = db.parse(is);</span>
<span class="nc" id="L175">            Node config = doc.getFirstChild();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            for (; config != null; config = config.getNextSibling()) {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                if (&quot;Configuration&quot;.equals(config.getLocalName())) {</span>
<span class="nc" id="L178">                    break;</span>
                }
            }
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (config == null) {</span>
<span class="nc" id="L182">                log.log(java.util.logging.Level.SEVERE, &quot;Error in reading configuration file - Configuration element not found&quot;);</span>
<span class="nc" id="L183">                return;</span>
            }
<span class="nc bnc" id="L185" title="All 2 branches missed.">            for (Node el = config.getFirstChild(); el != null; el = el.getNextSibling()) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (Node.ELEMENT_NODE != el.getNodeType()) {</span>
<span class="nc" id="L187">                    continue;</span>
                }
<span class="nc" id="L189">                String tag = el.getLocalName();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (tag.equals(&quot;ResourceBundles&quot;)) {</span>
<span class="nc" id="L191">                    Element resource = (Element)el;</span>
                    /* configure internationalization */
<span class="nc" id="L193">                    Attr langAttr = resource.getAttributeNode(&quot;defaultLanguageCode&quot;);</span>
<span class="nc" id="L194">                    Attr countryAttr = resource.getAttributeNode(&quot;defaultCountryCode&quot;);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                    String languageCode =</span>
<span class="nc" id="L196">                        (langAttr == null) ? null : langAttr.getNodeValue();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                    String countryCode =</span>
<span class="nc" id="L198">                        (countryAttr == null) ? null : countryAttr.getNodeValue();</span>
<span class="nc" id="L199">                    I18n.init(languageCode, countryCode);</span>
                }

<span class="nc bnc" id="L202" title="All 2 branches missed.">                if (tag.equals(&quot;CanonicalizationMethods&quot;)) {</span>
<span class="nc" id="L203">                    Element[] list =</span>
<span class="nc" id="L204">                        XMLUtils.selectNodes(el.getFirstChild(), CONF_NS, &quot;CanonicalizationMethod&quot;);</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">                    for (int i = 0; i &lt; list.length; i++) {</span>
<span class="nc" id="L207">                        String uri = list[i].getAttributeNS(null, &quot;URI&quot;);</span>
<span class="nc" id="L208">                        String javaClass =</span>
<span class="nc" id="L209">                            list[i].getAttributeNS(null, &quot;JAVACLASS&quot;);</span>
                        try {
<span class="nc" id="L211">                            Canonicalizer.register(uri, javaClass);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L213">                                log.log(java.util.logging.Level.FINE, &quot;Canonicalizer.register(&quot; + uri + &quot;, &quot; + javaClass + &quot;)&quot;);</span>
                            }
<span class="nc" id="L215">                        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L216">                            Object exArgs[] = { uri, javaClass };</span>
<span class="nc" id="L217">                            log.log(java.util.logging.Level.SEVERE, I18n.translate(&quot;algorithm.classDoesNotExist&quot;, exArgs));</span>
<span class="nc" id="L218">                        }</span>
                    }
                }

<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (tag.equals(&quot;TransformAlgorithms&quot;)) {</span>
<span class="nc" id="L223">                    Element[] tranElem =</span>
<span class="nc" id="L224">                        XMLUtils.selectNodes(el.getFirstChild(), CONF_NS, &quot;TransformAlgorithm&quot;);</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">                    for (int i = 0; i &lt; tranElem.length; i++) {</span>
<span class="nc" id="L227">                        String uri = tranElem[i].getAttributeNS(null, &quot;URI&quot;);</span>
<span class="nc" id="L228">                        String javaClass =</span>
<span class="nc" id="L229">                            tranElem[i].getAttributeNS(null, &quot;JAVACLASS&quot;);</span>
                        try {
<span class="nc" id="L231">                            Transform.register(uri, javaClass);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L233">                                log.log(java.util.logging.Level.FINE, &quot;Transform.register(&quot; + uri + &quot;, &quot; + javaClass + &quot;)&quot;);</span>
                            }
<span class="nc" id="L235">                        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L236">                            Object exArgs[] = { uri, javaClass };</span>

<span class="nc" id="L238">                            log.log(java.util.logging.Level.SEVERE, I18n.translate(&quot;algorithm.classDoesNotExist&quot;, exArgs));</span>
<span class="nc" id="L239">                        } catch (NoClassDefFoundError ex) {</span>
<span class="nc" id="L240">                            log.log(java.util.logging.Level.WARNING, &quot;Not able to found dependencies for algorithm, I'll keep working.&quot;);</span>
<span class="nc" id="L241">                        }</span>
                    }
                }

<span class="nc bnc" id="L245" title="All 2 branches missed.">                if (&quot;JCEAlgorithmMappings&quot;.equals(tag)) {</span>
<span class="nc" id="L246">                    Node algorithmsNode = ((Element)el).getElementsByTagName(&quot;Algorithms&quot;).item(0);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">                    if (algorithmsNode != null) {</span>
<span class="nc" id="L248">                        Element[] algorithms =</span>
<span class="nc" id="L249">                            XMLUtils.selectNodes(algorithmsNode.getFirstChild(), CONF_NS, &quot;Algorithm&quot;);</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">                        for (int i = 0; i &lt; algorithms.length; i++) {</span>
<span class="nc" id="L251">                            Element element = algorithms[i];</span>
<span class="nc" id="L252">                            String id = element.getAttribute(&quot;URI&quot;);</span>
<span class="nc" id="L253">                            JCEMapper.register(id, new JCEMapper.Algorithm(element));</span>
                        }
                    }
                }

<span class="nc bnc" id="L258" title="All 2 branches missed.">                if (tag.equals(&quot;SignatureAlgorithms&quot;)) {</span>
<span class="nc" id="L259">                    Element[] sigElems =</span>
<span class="nc" id="L260">                        XMLUtils.selectNodes(el.getFirstChild(), CONF_NS, &quot;SignatureAlgorithm&quot;);</span>

<span class="nc bnc" id="L262" title="All 2 branches missed.">                    for (int i = 0; i &lt; sigElems.length; i++) {</span>
<span class="nc" id="L263">                        String uri = sigElems[i].getAttributeNS(null, &quot;URI&quot;);</span>
<span class="nc" id="L264">                        String javaClass =</span>
<span class="nc" id="L265">                            sigElems[i].getAttributeNS(null, &quot;JAVACLASS&quot;);</span>

                        /** $todo$ handle registering */

                        try {
<span class="nc" id="L270">                            SignatureAlgorithm.register(uri, javaClass);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L272">                                log.log(java.util.logging.Level.FINE, &quot;SignatureAlgorithm.register(&quot; + uri + &quot;, &quot;</span>
                                          + javaClass + &quot;)&quot;);
                            }
<span class="nc" id="L275">                        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L276">                            Object exArgs[] = { uri, javaClass };</span>

<span class="nc" id="L278">                            log.log(java.util.logging.Level.SEVERE, I18n.translate(&quot;algorithm.classDoesNotExist&quot;, exArgs));</span>
<span class="nc" id="L279">                        }</span>
                    }
                }

<span class="nc bnc" id="L283" title="All 2 branches missed.">                if (tag.equals(&quot;ResourceResolvers&quot;)) {</span>
<span class="nc" id="L284">                    Element[]resolverElem =</span>
<span class="nc" id="L285">                        XMLUtils.selectNodes(el.getFirstChild(), CONF_NS, &quot;Resolver&quot;);</span>

<span class="nc bnc" id="L287" title="All 2 branches missed.">                    for (int i = 0; i &lt; resolverElem.length; i++) {</span>
<span class="nc" id="L288">                        String javaClass =</span>
<span class="nc" id="L289">                            resolverElem[i].getAttributeNS(null, &quot;JAVACLASS&quot;);</span>
<span class="nc" id="L290">                        String description =</span>
<span class="nc" id="L291">                            resolverElem[i].getAttributeNS(null, &quot;DESCRIPTION&quot;);</span>

<span class="nc bnc" id="L293" title="All 4 branches missed.">                        if ((description != null) &amp;&amp; (description.length() &gt; 0)) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">                            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L295">                                log.log(java.util.logging.Level.FINE, &quot;Register Resolver: &quot; + javaClass + &quot;: &quot;</span>
                                          + description);
                            }
                        } else {
<span class="nc bnc" id="L299" title="All 2 branches missed.">                            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L300">                                log.log(java.util.logging.Level.FINE, &quot;Register Resolver: &quot; + javaClass</span>
                                          + &quot;: For unknown purposes&quot;);
                            }
                        }
                        try {
<span class="nc" id="L305">                            ResourceResolver.register(javaClass);</span>
<span class="nc" id="L306">                        } catch (Throwable e) {</span>
<span class="nc" id="L307">                            log.log(java.util.logging.Level.WARNING,</span>
                                 &quot;Cannot register:&quot; + javaClass
                                 + &quot; perhaps some needed jars are not installed&quot;,
                                 e
                             );
<span class="nc" id="L312">                        }</span>
                    }
                }

<span class="nc bnc" id="L316" title="All 2 branches missed.">                if (tag.equals(&quot;KeyResolver&quot;)){</span>
<span class="nc" id="L317">                    Element[] resolverElem =</span>
<span class="nc" id="L318">                        XMLUtils.selectNodes(el.getFirstChild(), CONF_NS, &quot;Resolver&quot;);</span>
<span class="nc" id="L319">                    List&lt;String&gt; classNames = new ArrayList&lt;String&gt;(resolverElem.length);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                    for (int i = 0; i &lt; resolverElem.length; i++) {</span>
<span class="nc" id="L321">                        String javaClass =</span>
<span class="nc" id="L322">                            resolverElem[i].getAttributeNS(null, &quot;JAVACLASS&quot;);</span>
<span class="nc" id="L323">                        String description =</span>
<span class="nc" id="L324">                            resolverElem[i].getAttributeNS(null, &quot;DESCRIPTION&quot;);</span>

<span class="nc bnc" id="L326" title="All 4 branches missed.">                        if ((description != null) &amp;&amp; (description.length() &gt; 0)) {</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L328">                                log.log(java.util.logging.Level.FINE, &quot;Register Resolver: &quot; + javaClass + &quot;: &quot;</span>
                                          + description);
                            }
                        } else {
<span class="nc bnc" id="L332" title="All 2 branches missed.">                            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L333">                                log.log(java.util.logging.Level.FINE, &quot;Register Resolver: &quot; + javaClass</span>
                                          + &quot;: For unknown purposes&quot;);
                            }
                        }
<span class="nc" id="L337">                        classNames.add(javaClass);</span>
                    }
<span class="nc" id="L339">                    KeyResolver.registerClassNames(classNames);</span>
                }


<span class="nc bnc" id="L343" title="All 2 branches missed.">                if (tag.equals(&quot;PrefixMappings&quot;)){</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                    if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L345">                        log.log(java.util.logging.Level.FINE, &quot;Now I try to bind prefixes:&quot;);</span>
                    }

<span class="nc" id="L348">                    Element[] nl =</span>
<span class="nc" id="L349">                        XMLUtils.selectNodes(el.getFirstChild(), CONF_NS, &quot;PrefixMapping&quot;);</span>

<span class="nc bnc" id="L351" title="All 2 branches missed.">                    for (int i = 0; i &lt; nl.length; i++) {</span>
<span class="nc" id="L352">                        String namespace = nl[i].getAttributeNS(null, &quot;namespace&quot;);</span>
<span class="nc" id="L353">                        String prefix = nl[i].getAttributeNS(null, &quot;prefix&quot;);</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L355">                            log.log(java.util.logging.Level.FINE, &quot;Now I try to bind &quot; + prefix + &quot; to &quot; + namespace);</span>
                        }
<span class="nc" id="L357">                        ElementProxy.setDefaultPrefix(namespace, prefix);</span>
                    }
                }
            }
<span class="nc" id="L361">        } catch (Exception e) {</span>
<span class="nc" id="L362">            log.log(java.util.logging.Level.SEVERE, &quot;Bad: &quot;, e);</span>
<span class="nc" id="L363">            e.printStackTrace();</span>
<span class="nc" id="L364">        }</span>
<span class="nc" id="L365">    }</span>

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>