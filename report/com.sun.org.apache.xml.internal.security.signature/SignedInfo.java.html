<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>SignedInfo.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.org.apache.xml.internal.security.signature</a> &gt; <span class="el_source">SignedInfo.java</span></div><h1>SignedInfo.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package com.sun.org.apache.xml.internal.security.signature;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.OutputStream;
import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;
import javax.xml.XMLConstants;
import javax.xml.parsers.ParserConfigurationException;

import com.sun.org.apache.xml.internal.security.algorithms.SignatureAlgorithm;
import com.sun.org.apache.xml.internal.security.c14n.CanonicalizationException;
import com.sun.org.apache.xml.internal.security.c14n.Canonicalizer;
import com.sun.org.apache.xml.internal.security.c14n.InvalidCanonicalizerException;
import com.sun.org.apache.xml.internal.security.exceptions.XMLSecurityException;
import com.sun.org.apache.xml.internal.security.utils.Constants;
import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
import com.sun.org.apache.xml.internal.security.transforms.params.InclusiveNamespaces;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.xml.sax.SAXException;

/**
 * Handles &lt;code&gt;&amp;lt;ds:SignedInfo&amp;gt;&lt;/code&gt; elements
 * This &lt;code&gt;SignedInfo&lt;code&gt; element includes the canonicalization algorithm,
 * a signature algorithm, and one or more references.
 *
 * @author Christian Geuer-Pollmann
 */
public class SignedInfo extends Manifest {

    /** Field signatureAlgorithm */
<span class="nc" id="L56">    private SignatureAlgorithm signatureAlgorithm = null;</span>

    /** Field c14nizedBytes           */
<span class="nc" id="L59">    private byte[] c14nizedBytes = null;</span>

    private Element c14nMethod;
    private Element signatureMethod;

    /**
     * Overwrites {@link Manifest#addDocument} because it creates another
     * Element.
     *
     * @param doc the {@link Document} in which &lt;code&gt;XMLsignature&lt;/code&gt; will
     *    be placed
     * @throws XMLSecurityException
     */
    public SignedInfo(Document doc) throws XMLSecurityException {
<span class="nc" id="L73">        this(doc, XMLSignature.ALGO_ID_SIGNATURE_DSA,</span>
             Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS);
<span class="nc" id="L75">    }</span>

    /**
     * Constructs {@link SignedInfo} using given Canonicalization algorithm and
     * Signature algorithm.
     *
     * @param doc &lt;code&gt;SignedInfo&lt;/code&gt; is placed in this document
     * @param signatureMethodURI URI representation of the Digest and
     *    Signature algorithm
     * @param canonicalizationMethodURI URI representation of the
     *    Canonicalization method
     * @throws XMLSecurityException
     */
    public SignedInfo(
        Document doc, String signatureMethodURI, String canonicalizationMethodURI
    ) throws XMLSecurityException {
<span class="nc" id="L91">        this(doc, signatureMethodURI, 0, canonicalizationMethodURI);</span>
<span class="nc" id="L92">    }</span>

    /**
     * Constructor SignedInfo
     *
     * @param doc &lt;code&gt;SignedInfo&lt;/code&gt; is placed in this document
     * @param signatureMethodURI URI representation of the Digest and
     *    Signature algorithm
     * @param hMACOutputLength
     * @param canonicalizationMethodURI URI representation of the
     *    Canonicalization method
     * @throws XMLSecurityException
     */
    public SignedInfo(
        Document doc, String signatureMethodURI,
        int hMACOutputLength, String canonicalizationMethodURI
    ) throws XMLSecurityException {
<span class="nc" id="L109">        super(doc);</span>

<span class="nc" id="L111">        c14nMethod =</span>
<span class="nc" id="L112">            XMLUtils.createElementInSignatureSpace(this.doc, Constants._TAG_CANONICALIZATIONMETHOD);</span>

<span class="nc" id="L114">        c14nMethod.setAttributeNS(null, Constants._ATT_ALGORITHM, canonicalizationMethodURI);</span>
<span class="nc" id="L115">        this.constructionElement.appendChild(c14nMethod);</span>
<span class="nc" id="L116">        XMLUtils.addReturnToElement(this.constructionElement);</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (hMACOutputLength &gt; 0) {</span>
<span class="nc" id="L119">            this.signatureAlgorithm =</span>
                new SignatureAlgorithm(this.doc, signatureMethodURI, hMACOutputLength);
        } else {
<span class="nc" id="L122">            this.signatureAlgorithm = new SignatureAlgorithm(this.doc, signatureMethodURI);</span>
        }

<span class="nc" id="L125">        signatureMethod = this.signatureAlgorithm.getElement();</span>
<span class="nc" id="L126">        this.constructionElement.appendChild(signatureMethod);</span>
<span class="nc" id="L127">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L128">    }</span>

    /**
     * @param doc
     * @param signatureMethodElem
     * @param canonicalizationMethodElem
     * @throws XMLSecurityException
     */
    public SignedInfo(
        Document doc, Element signatureMethodElem, Element canonicalizationMethodElem
    ) throws XMLSecurityException {
<span class="nc" id="L139">        super(doc);</span>
        // Check this?
<span class="nc" id="L141">        this.c14nMethod = canonicalizationMethodElem;</span>
<span class="nc" id="L142">        this.constructionElement.appendChild(c14nMethod);</span>
<span class="nc" id="L143">        XMLUtils.addReturnToElement(this.constructionElement);</span>

<span class="nc" id="L145">        this.signatureAlgorithm =</span>
            new SignatureAlgorithm(signatureMethodElem, null);

<span class="nc" id="L148">        signatureMethod = this.signatureAlgorithm.getElement();</span>
<span class="nc" id="L149">        this.constructionElement.appendChild(signatureMethod);</span>

<span class="nc" id="L151">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L152">    }</span>

    /**
     * Build a {@link SignedInfo} from an {@link Element}
     *
     * @param element &lt;code&gt;SignedInfo&lt;/code&gt;
     * @param baseURI the URI of the resource where the XML instance was stored
     * @throws XMLSecurityException
     * @see &lt;A HREF=&quot;http://lists.w3.org/Archives/Public/w3c-ietf-xmldsig/2001OctDec/0033.html&quot;&gt;
     * Question&lt;/A&gt;
     * @see &lt;A HREF=&quot;http://lists.w3.org/Archives/Public/w3c-ietf-xmldsig/2001OctDec/0054.html&quot;&gt;
     * Answer&lt;/A&gt;
     */
    public SignedInfo(Element element, String baseURI) throws XMLSecurityException {
<span class="nc" id="L166">        this(element, baseURI, false);</span>
<span class="nc" id="L167">    }</span>

    /**
     * Build a {@link SignedInfo} from an {@link Element}
     *
     * @param element &lt;code&gt;SignedInfo&lt;/code&gt;
     * @param baseURI the URI of the resource where the XML instance was stored
     * @param secureValidation whether secure validation is enabled or not
     * @throws XMLSecurityException
     * @see &lt;A HREF=&quot;http://lists.w3.org/Archives/Public/w3c-ietf-xmldsig/2001OctDec/0033.html&quot;&gt;
     * Question&lt;/A&gt;
     * @see &lt;A HREF=&quot;http://lists.w3.org/Archives/Public/w3c-ietf-xmldsig/2001OctDec/0054.html&quot;&gt;
     * Answer&lt;/A&gt;
     */
    public SignedInfo(
        Element element, String baseURI, boolean secureValidation
    ) throws XMLSecurityException {
        // Parse the Reference children and Id attribute in the Manifest
<span class="nc" id="L185">        super(reparseSignedInfoElem(element), baseURI, secureValidation);</span>

<span class="nc" id="L187">        c14nMethod = XMLUtils.getNextElement(element.getFirstChild());</span>
<span class="nc" id="L188">        signatureMethod = XMLUtils.getNextElement(c14nMethod.getNextSibling());</span>
<span class="nc" id="L189">        this.signatureAlgorithm =</span>
<span class="nc" id="L190">            new SignatureAlgorithm(signatureMethod, this.getBaseURI(), secureValidation);</span>
<span class="nc" id="L191">    }</span>

    private static Element reparseSignedInfoElem(Element element)
        throws XMLSecurityException {
        /*
         * If a custom canonicalizationMethod is used, canonicalize
         * ds:SignedInfo, reparse it into a new document
         * and replace the original not-canonicalized ds:SignedInfo by
         * the re-parsed canonicalized one.
         */
<span class="nc" id="L201">        Element c14nMethod = XMLUtils.getNextElement(element.getFirstChild());</span>
<span class="nc" id="L202">        String c14nMethodURI =</span>
<span class="nc" id="L203">            c14nMethod.getAttributeNS(null, Constants._ATT_ALGORITHM);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (!(c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS) ||</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">            c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS) ||</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N_EXCL_OMIT_COMMENTS) ||</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N_EXCL_WITH_COMMENTS) ||</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N11_OMIT_COMMENTS) ||</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N11_WITH_COMMENTS))) {</span>
            // the c14n is not a secure one and can rewrite the URIs or like
            // so reparse the SignedInfo to be sure
            try {
<span class="nc" id="L213">                Canonicalizer c14nizer =</span>
<span class="nc" id="L214">                    Canonicalizer.getInstance(c14nMethodURI);</span>

<span class="nc" id="L216">                byte[] c14nizedBytes = c14nizer.canonicalizeSubtree(element);</span>
                javax.xml.parsers.DocumentBuilderFactory dbf =
<span class="nc" id="L218">                    javax.xml.parsers.DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L219">                dbf.setNamespaceAware(true);</span>
<span class="nc" id="L220">                dbf.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, Boolean.TRUE);</span>
<span class="nc" id="L221">                javax.xml.parsers.DocumentBuilder db = dbf.newDocumentBuilder();</span>
<span class="nc" id="L222">                Document newdoc =</span>
<span class="nc" id="L223">                    db.parse(new ByteArrayInputStream(c14nizedBytes));</span>
<span class="nc" id="L224">                Node imported =</span>
<span class="nc" id="L225">                    element.getOwnerDocument().importNode(newdoc.getDocumentElement(), true);</span>

<span class="nc" id="L227">                element.getParentNode().replaceChild(imported, element);</span>

<span class="nc" id="L229">                return (Element) imported;</span>
<span class="nc" id="L230">            } catch (ParserConfigurationException ex) {</span>
<span class="nc" id="L231">                throw new XMLSecurityException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L232">            } catch (IOException ex) {</span>
<span class="nc" id="L233">                throw new XMLSecurityException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L234">            } catch (SAXException ex) {</span>
<span class="nc" id="L235">                throw new XMLSecurityException(&quot;empty&quot;, ex);</span>
            }
        }
<span class="nc" id="L238">        return element;</span>
    }

    /**
     * Tests core validation process
     *
     * @return true if verification was successful
     * @throws MissingResourceFailureException
     * @throws XMLSecurityException
     */
    public boolean verify()
        throws MissingResourceFailureException, XMLSecurityException {
<span class="nc" id="L250">        return super.verifyReferences(false);</span>
    }

    /**
     * Tests core validation process
     *
     * @param followManifests defines whether the verification process has to verify referenced &lt;CODE&gt;ds:Manifest&lt;/CODE&gt;s, too
     * @return true if verification was successful
     * @throws MissingResourceFailureException
     * @throws XMLSecurityException
     */
    public boolean verify(boolean followManifests)
        throws MissingResourceFailureException, XMLSecurityException {
<span class="nc" id="L263">        return super.verifyReferences(followManifests);</span>
    }

    /**
     * Returns getCanonicalizedOctetStream
     *
     * @return the canonicalization result octet stream of &lt;code&gt;SignedInfo&lt;/code&gt; element
     * @throws CanonicalizationException
     * @throws InvalidCanonicalizerException
     * @throws XMLSecurityException
     */
    public byte[] getCanonicalizedOctetStream()
        throws CanonicalizationException, InvalidCanonicalizerException, XMLSecurityException {
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (this.c14nizedBytes == null) {</span>
<span class="nc" id="L277">            Canonicalizer c14nizer =</span>
<span class="nc" id="L278">                Canonicalizer.getInstance(this.getCanonicalizationMethodURI());</span>

<span class="nc" id="L280">            this.c14nizedBytes =</span>
<span class="nc" id="L281">                c14nizer.canonicalizeSubtree(this.constructionElement);</span>
        }

        // make defensive copy
<span class="nc" id="L285">        return this.c14nizedBytes.clone();</span>
    }

    /**
     * Output the C14n stream to the given OutputStream.
     * @param os
     * @throws CanonicalizationException
     * @throws InvalidCanonicalizerException
     * @throws XMLSecurityException
     */
    public void signInOctetStream(OutputStream os)
        throws CanonicalizationException, InvalidCanonicalizerException, XMLSecurityException {
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (this.c14nizedBytes == null) {</span>
<span class="nc" id="L298">            Canonicalizer c14nizer =</span>
<span class="nc" id="L299">                Canonicalizer.getInstance(this.getCanonicalizationMethodURI());</span>
<span class="nc" id="L300">            c14nizer.setWriter(os);</span>
<span class="nc" id="L301">            String inclusiveNamespaces = this.getInclusiveNamespaces();</span>

<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (inclusiveNamespaces == null) {</span>
<span class="nc" id="L304">                c14nizer.canonicalizeSubtree(this.constructionElement);</span>
            } else {
<span class="nc" id="L306">                c14nizer.canonicalizeSubtree(this.constructionElement, inclusiveNamespaces);</span>
            }
<span class="nc" id="L308">        } else {</span>
            try {
<span class="nc" id="L310">                os.write(this.c14nizedBytes);</span>
<span class="nc" id="L311">            } catch (IOException e) {</span>
<span class="nc" id="L312">                throw new RuntimeException(e);</span>
<span class="nc" id="L313">            }</span>
        }
<span class="nc" id="L315">    }</span>

    /**
     * Returns the Canonicalization method URI
     *
     * @return the Canonicalization method URI
     */
    public String getCanonicalizationMethodURI() {
<span class="nc" id="L323">        return c14nMethod.getAttributeNS(null, Constants._ATT_ALGORITHM);</span>
    }

    /**
     * Returns the Signature method URI
     *
     * @return the Signature method URI
     */
    public String getSignatureMethodURI() {
<span class="nc" id="L332">        Element signatureElement = this.getSignatureMethodElement();</span>

<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (signatureElement != null) {</span>
<span class="nc" id="L335">            return signatureElement.getAttributeNS(null, Constants._ATT_ALGORITHM);</span>
        }

<span class="nc" id="L338">        return null;</span>
    }

    /**
     * Method getSignatureMethodElement
     * @return returns the SignatureMethod Element
     *
     */
    public Element getSignatureMethodElement() {
<span class="nc" id="L347">        return signatureMethod;</span>
    }

    /**
     * Creates a SecretKey for the appropriate Mac algorithm based on a
     * byte[] array password.
     *
     * @param secretKeyBytes
     * @return the secret key for the SignedInfo element.
     */
    public SecretKey createSecretKey(byte[] secretKeyBytes) {
<span class="nc" id="L358">        return new SecretKeySpec(secretKeyBytes, this.signatureAlgorithm.getJCEAlgorithmString());</span>
    }

    protected SignatureAlgorithm getSignatureAlgorithm() {
<span class="nc" id="L362">        return signatureAlgorithm;</span>
    }

    /**
     * Method getBaseLocalName
     * @inheritDoc
     *
     */
    public String getBaseLocalName() {
<span class="nc" id="L371">        return Constants._TAG_SIGNEDINFO;</span>
    }

    public String getInclusiveNamespaces() {
<span class="nc" id="L375">        String c14nMethodURI = c14nMethod.getAttributeNS(null, Constants._ATT_ALGORITHM);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (!(c14nMethodURI.equals(&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;) ||</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            c14nMethodURI.equals(&quot;http://www.w3.org/2001/10/xml-exc-c14n#WithComments&quot;))) {</span>
<span class="nc" id="L378">            return null;</span>
        }

<span class="nc" id="L381">        Element inclusiveElement = XMLUtils.getNextElement(c14nMethod.getFirstChild());</span>

<span class="nc bnc" id="L383" title="All 2 branches missed.">        if (inclusiveElement != null) {</span>
            try {
<span class="nc" id="L385">                String inclusiveNamespaces =</span>
                    new InclusiveNamespaces(
                        inclusiveElement,
                        InclusiveNamespaces.ExclusiveCanonicalizationNamespace
<span class="nc" id="L389">                    ).getInclusiveNamespaces();</span>
<span class="nc" id="L390">                return inclusiveNamespaces;</span>
<span class="nc" id="L391">            } catch (XMLSecurityException e) {</span>
<span class="nc" id="L392">                return null;</span>
            }
        }
<span class="nc" id="L395">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>