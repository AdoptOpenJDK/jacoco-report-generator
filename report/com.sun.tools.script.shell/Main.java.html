<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Main.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.tools.script.shell</a> &gt; <span class="el_source">Main.java</span></div><h1>Main.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.tools.script.shell;

import java.io.*;
import java.net.*;
import java.text.*;
import java.util.*;
import javax.script.*;

/**
 * This is the main class for Java script shell.
 */
<span class="nc" id="L37">public class Main {</span>
    /**
     * main entry point to the command line tool
     * @param args command line argument array
     */
    public static void main(String[] args) {
        // parse command line options
<span class="nc" id="L44">        String[] scriptArgs = processOptions(args);</span>

        // process each script command
<span class="nc bnc" id="L47" title="All 2 branches missed.">        for (Command cmd : scripts) {</span>
<span class="nc" id="L48">            cmd.run(scriptArgs);</span>
<span class="nc" id="L49">        }</span>

<span class="nc" id="L51">        System.exit(EXIT_SUCCESS);</span>
<span class="nc" id="L52">    }</span>

    // Each -e or -f or interactive mode is represented
    // by an instance of Command.
<span class="nc" id="L56">    private static interface Command {</span>
        public void run(String[] arguments);
    }

    /**
     * Parses and processes command line options.
     * @param args command line argument array
     */
    private static String[] processOptions(String[] args) {
        // current scripting language selected
<span class="nc" id="L66">        String currentLanguage = DEFAULT_LANGUAGE;</span>
        // current script file encoding selected
<span class="nc" id="L68">        String currentEncoding = null;</span>

        // check for -classpath or -cp first
<span class="nc" id="L71">        checkClassPath(args);</span>

        // have we seen -e or -f ?
<span class="nc" id="L74">        boolean seenScript = false;</span>
        // have we seen -f - already?
<span class="nc" id="L76">        boolean seenStdin = false;</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        for (int i=0; i &lt; args.length; i++) {</span>
<span class="nc" id="L78">            String arg = args[i];</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">            if (arg.equals(&quot;-classpath&quot;) ||</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                    arg.equals(&quot;-cp&quot;)) {</span>
                // handled already, just continue
<span class="nc" id="L82">                i++;</span>
<span class="nc" id="L83">                continue;</span>
            }

            // collect non-option arguments and pass these as script arguments
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (!arg.startsWith(&quot;-&quot;)) {</span>
                int numScriptArgs;
                int startScriptArg;
<span class="nc bnc" id="L90" title="All 2 branches missed.">                if (seenScript) {</span>
                    // if we have seen -e or -f already all non-option arguments
                    // are passed as script arguments
<span class="nc" id="L93">                    numScriptArgs = args.length - i;</span>
<span class="nc" id="L94">                    startScriptArg = i;</span>
                } else {
                    // if we have not seen -e or -f, first non-option argument
                    // is treated as script file name and rest of the non-option
                    // arguments are passed to script as script arguments
<span class="nc" id="L99">                    numScriptArgs = args.length - i - 1;</span>
<span class="nc" id="L100">                    startScriptArg = i + 1;</span>
<span class="nc" id="L101">                    ScriptEngine se = getScriptEngine(currentLanguage);</span>
<span class="nc" id="L102">                    addFileSource(se, args[i], currentEncoding);</span>
                }
                // collect script arguments and return to main
<span class="nc" id="L105">                String[] result = new String[numScriptArgs];</span>
<span class="nc" id="L106">                System.arraycopy(args, startScriptArg, result, 0, numScriptArgs);</span>
<span class="nc" id="L107">                return result;</span>
            }

<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (arg.startsWith(&quot;-D&quot;)) {</span>
<span class="nc" id="L111">                String value = arg.substring(2);</span>
<span class="nc" id="L112">                int eq = value.indexOf('=');</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                if (eq != -1) {</span>
<span class="nc" id="L114">                    System.setProperty(value.substring(0, eq),</span>
<span class="nc" id="L115">                            value.substring(eq + 1));</span>
                } else {
<span class="nc bnc" id="L117" title="All 2 branches missed.">                    if (!value.equals(&quot;&quot;)) {</span>
<span class="nc" id="L118">                        System.setProperty(value, &quot;&quot;);</span>
                    } else {
                        // do not allow empty property name
<span class="nc" id="L121">                        usage(EXIT_CMD_NO_PROPNAME);</span>
                    }
                }
<span class="nc" id="L124">                continue;</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">            } else if (arg.equals(&quot;-?&quot;) || arg.equals(&quot;-help&quot;)) {</span>
<span class="nc" id="L126">                usage(EXIT_SUCCESS);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            } else if (arg.equals(&quot;-e&quot;)) {</span>
<span class="nc" id="L128">                seenScript = true;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (++i == args.length)</span>
<span class="nc" id="L130">                    usage(EXIT_CMD_NO_SCRIPT);</span>

<span class="nc" id="L132">                ScriptEngine se = getScriptEngine(currentLanguage);</span>
<span class="nc" id="L133">                addStringSource(se, args[i]);</span>
<span class="nc" id="L134">                continue;</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            } else if (arg.equals(&quot;-encoding&quot;)) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                if (++i == args.length)</span>
<span class="nc" id="L137">                    usage(EXIT_CMD_NO_ENCODING);</span>
<span class="nc" id="L138">                currentEncoding = args[i];</span>
<span class="nc" id="L139">                continue;</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">            } else if (arg.equals(&quot;-f&quot;)) {</span>
<span class="nc" id="L141">                seenScript = true;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                if (++i == args.length)</span>
<span class="nc" id="L143">                    usage(EXIT_CMD_NO_FILE);</span>
<span class="nc" id="L144">                ScriptEngine se = getScriptEngine(currentLanguage);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (args[i].equals(&quot;-&quot;)) {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                    if (seenStdin) {</span>
<span class="nc" id="L147">                        usage(EXIT_MULTIPLE_STDIN);</span>
                    } else {
<span class="nc" id="L149">                        seenStdin = true;</span>
                    }
<span class="nc" id="L151">                    addInteractiveMode(se);</span>
                } else {
<span class="nc" id="L153">                    addFileSource(se, args[i], currentEncoding);</span>
                }
<span class="nc" id="L155">                continue;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            } else if (arg.equals(&quot;-l&quot;)) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                if (++i == args.length)</span>
<span class="nc" id="L158">                    usage(EXIT_CMD_NO_LANG);</span>
<span class="nc" id="L159">                currentLanguage = args[i];</span>
<span class="nc" id="L160">                continue;</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            } else if (arg.equals(&quot;-q&quot;)) {</span>
<span class="nc" id="L162">                listScriptEngines();</span>
            }
            // some unknown option...
<span class="nc" id="L165">            usage(EXIT_UNKNOWN_OPTION);</span>
        }

<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (! seenScript) {</span>
<span class="nc" id="L169">            ScriptEngine se = getScriptEngine(currentLanguage);</span>
<span class="nc" id="L170">            addInteractiveMode(se);</span>
        }
<span class="nc" id="L172">        return new String[0];</span>
    }

    /**
     * Adds interactive mode Command
     * @param se ScriptEngine to use in interactive mode.
     */
    private static void addInteractiveMode(final ScriptEngine se) {
<span class="nc" id="L180">        scripts.add(new Command() {</span>
            public void run(String[] args) {
<span class="nc" id="L182">                setScriptArguments(se, args);</span>
<span class="nc" id="L183">                processSource(se, &quot;-&quot;, null);</span>
<span class="nc" id="L184">            }</span>
        });
<span class="nc" id="L186">    }</span>

    /**
     * Adds script source file Command
     * @param se ScriptEngine used to evaluate the script file
     * @param fileName script file name
     * @param encoding script file encoding
     */
    private static void addFileSource(final ScriptEngine se,
            final String fileName,
            final String encoding) {
<span class="nc" id="L197">        scripts.add(new Command() {</span>
            public void run(String[] args) {
<span class="nc" id="L199">                setScriptArguments(se, args);</span>
<span class="nc" id="L200">                processSource(se, fileName, encoding);</span>
<span class="nc" id="L201">            }</span>
        });
<span class="nc" id="L203">    }</span>

    /**
     * Adds script string source Command
     * @param se ScriptEngine to be used to evaluate the script string
     * @param source Script source string
     */
    private static void addStringSource(final ScriptEngine se,
            final String source) {
<span class="nc" id="L212">        scripts.add(new Command() {</span>
            public void run(String[] args) {
<span class="nc" id="L214">                setScriptArguments(se, args);</span>
<span class="nc" id="L215">                String oldFile = setScriptFilename(se, &quot;&lt;string&gt;&quot;);</span>
                try {
<span class="nc" id="L217">                    evaluateString(se, source);</span>
                } finally {
<span class="nc" id="L219">                    setScriptFilename(se, oldFile);</span>
<span class="nc" id="L220">                }</span>
<span class="nc" id="L221">            }</span>
        });
<span class="nc" id="L223">    }</span>

    /**
     * Prints list of script engines available and exits.
     */
    private static void listScriptEngines() {
<span class="nc" id="L229">        List&lt;ScriptEngineFactory&gt; factories = engineManager.getEngineFactories();</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        for (ScriptEngineFactory factory: factories) {</span>
<span class="nc" id="L231">            getError().println(getMessage(&quot;engine.info&quot;,</span>
<span class="nc" id="L232">                    new Object[] { factory.getLanguageName(),</span>
<span class="nc" id="L233">                            factory.getLanguageVersion(),</span>
<span class="nc" id="L234">                            factory.getEngineName(),</span>
<span class="nc" id="L235">                            factory.getEngineVersion()</span>
            }));
<span class="nc" id="L237">        }</span>
<span class="nc" id="L238">        System.exit(EXIT_SUCCESS);</span>
<span class="nc" id="L239">    }</span>

    /**
     * Processes a given source file or standard input.
     * @param se ScriptEngine to be used to evaluate
     * @param filename file name, can be null
     * @param encoding script file encoding, can be null
     */
    private static void processSource(ScriptEngine se, String filename,
            String encoding) {
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (filename.equals(&quot;-&quot;)) {</span>
<span class="nc" id="L250">            BufferedReader in = new BufferedReader</span>
<span class="nc" id="L251">                    (new InputStreamReader(getIn()));</span>
<span class="nc" id="L252">            boolean hitEOF = false;</span>
<span class="nc" id="L253">            String prompt = getPrompt(se);</span>
<span class="nc" id="L254">            se.put(ScriptEngine.FILENAME, &quot;&lt;STDIN&gt;&quot;);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">            while (!hitEOF) {</span>
<span class="nc" id="L256">                getError().print(prompt);</span>
<span class="nc" id="L257">                String source = &quot;&quot;;</span>
                try {
<span class="nc" id="L259">                    source = in.readLine();</span>
<span class="nc" id="L260">                } catch (IOException ioe) {</span>
<span class="nc" id="L261">                    getError().println(ioe.toString());</span>
<span class="nc" id="L262">                }</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (source == null) {</span>
<span class="nc" id="L264">                    hitEOF = true;</span>
<span class="nc" id="L265">                    break;</span>
                }
<span class="nc" id="L267">                Object res = evaluateString(se, source, false);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">                if (res != null) {</span>
<span class="nc" id="L269">                    res = res.toString();</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                    if (res == null) {</span>
<span class="nc" id="L271">                        res = &quot;null&quot;;</span>
                    }
<span class="nc" id="L273">                    getError().println(res);</span>
                }
<span class="nc" id="L275">            }</span>
<span class="nc" id="L276">        } else {</span>
<span class="nc" id="L277">            FileInputStream fis = null;</span>
            try {
<span class="nc" id="L279">                fis = new FileInputStream(filename);</span>
<span class="nc" id="L280">            } catch (FileNotFoundException fnfe) {</span>
<span class="nc" id="L281">                getError().println(getMessage(&quot;file.not.found&quot;,</span>
                        new Object[] { filename }));
<span class="nc" id="L283">                        System.exit(EXIT_FILE_NOT_FOUND);</span>
<span class="nc" id="L284">            }</span>
<span class="nc" id="L285">            evaluateStream(se, fis, filename, encoding);</span>
        }
<span class="nc" id="L287">    }</span>

    /**
     * Evaluates given script source
     * @param se ScriptEngine to evaluate the string
     * @param script Script source string
     * @param exitOnError whether to exit the process on script error
     */
    private static Object evaluateString(ScriptEngine se,
            String script, boolean exitOnError) {
        try {
<span class="nc" id="L298">            return se.eval(script);</span>
<span class="nc" id="L299">        } catch (ScriptException sexp) {</span>
<span class="nc" id="L300">            getError().println(getMessage(&quot;string.script.error&quot;,</span>
<span class="nc" id="L301">                    new Object[] { sexp.getMessage() }));</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                    if (exitOnError)</span>
<span class="nc" id="L303">                        System.exit(EXIT_SCRIPT_ERROR);</span>
<span class="nc" id="L304">        } catch (Exception exp) {</span>
<span class="nc" id="L305">            exp.printStackTrace(getError());</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if (exitOnError)</span>
<span class="nc" id="L307">                System.exit(EXIT_SCRIPT_ERROR);</span>
<span class="nc" id="L308">        }</span>

<span class="nc" id="L310">        return null;</span>
    }

    /**
     * Evaluate script string source and exit on script error
     * @param se ScriptEngine to evaluate the string
     * @param script Script source string
     */
    private static void evaluateString(ScriptEngine se, String script) {
<span class="nc" id="L319">        evaluateString(se, script, true);</span>
<span class="nc" id="L320">    }</span>

    /**
     * Evaluates script from given reader
     * @param se ScriptEngine to evaluate the string
     * @param reader Reader from which is script is read
     * @param name file name to report in error.
     */
    private static Object evaluateReader(ScriptEngine se,
            Reader reader, String name) {
<span class="nc" id="L330">        String oldFilename = setScriptFilename(se, name);</span>
        try {
<span class="nc" id="L332">            return se.eval(reader);</span>
<span class="nc" id="L333">        } catch (ScriptException sexp) {</span>
<span class="nc" id="L334">            getError().println(getMessage(&quot;file.script.error&quot;,</span>
<span class="nc" id="L335">                    new Object[] { name, sexp.getMessage() }));</span>
<span class="nc" id="L336">                    System.exit(EXIT_SCRIPT_ERROR);</span>
<span class="nc" id="L337">        } catch (Exception exp) {</span>
<span class="nc" id="L338">            exp.printStackTrace(getError());</span>
<span class="nc" id="L339">            System.exit(EXIT_SCRIPT_ERROR);</span>
        } finally {
<span class="nc" id="L341">            setScriptFilename(se, oldFilename);</span>
<span class="nc" id="L342">        }</span>
<span class="nc" id="L343">        return null;</span>
    }

    /**
     * Evaluates given input stream
     * @param se ScriptEngine to evaluate the string
     * @param is InputStream from which script is read
     * @param name file name to report in error
     */
    private static Object evaluateStream(ScriptEngine se,
            InputStream is, String name,
            String encoding) {
<span class="nc" id="L355">        BufferedReader reader = null;</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (encoding != null) {</span>
            try {
<span class="nc" id="L358">                reader = new BufferedReader(new InputStreamReader(is,</span>
                        encoding));
<span class="nc" id="L360">            } catch (UnsupportedEncodingException uee) {</span>
<span class="nc" id="L361">                getError().println(getMessage(&quot;encoding.unsupported&quot;,</span>
                        new Object[] { encoding }));
<span class="nc" id="L363">                        System.exit(EXIT_NO_ENCODING_FOUND);</span>
<span class="nc" id="L364">            }</span>
        } else {
<span class="nc" id="L366">            reader = new BufferedReader(new InputStreamReader(is));</span>
        }
<span class="nc" id="L368">        return evaluateReader(se, reader, name);</span>
    }

    /**
     * Prints usage message and exits
     * @param exitCode process exit code
     */
    private static void usage(int exitCode) {
<span class="nc" id="L376">        getError().println(getMessage(&quot;main.usage&quot;,</span>
                new Object[] { PROGRAM_NAME }));
<span class="nc" id="L378">                System.exit(exitCode);</span>
<span class="nc" id="L379">    }</span>

    /**
     * Gets prompt for interactive mode
     * @return prompt string to use
     */
    private static String getPrompt(ScriptEngine se) {
<span class="nc" id="L386">        List&lt;String&gt; names = se.getFactory().getNames();</span>
<span class="nc" id="L387">        return names.get(0) + &quot;&gt; &quot;;</span>
    }

    /**
     * Get formatted, localized error message
     */
    private static String getMessage(String key, Object[] params) {
<span class="nc" id="L394">        return MessageFormat.format(msgRes.getString(key), params);</span>
    }

    // input stream from where we will read
    private static InputStream getIn() {
<span class="nc" id="L399">        return System.in;</span>
    }

    // stream to print error messages
    private static PrintStream getError() {
<span class="nc" id="L404">        return System.err;</span>
    }

    // get current script engine
    private static ScriptEngine getScriptEngine(String lang) {
<span class="nc" id="L409">        ScriptEngine se = engines.get(lang);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">        if (se == null) {</span>
<span class="nc" id="L411">            se = engineManager.getEngineByName(lang);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">            if (se == null) {</span>
<span class="nc" id="L413">                getError().println(getMessage(&quot;engine.not.found&quot;,</span>
                        new Object[] { lang }));
<span class="nc" id="L415">                        System.exit(EXIT_ENGINE_NOT_FOUND);</span>
            }

            // initialize the engine
<span class="nc" id="L419">            initScriptEngine(se);</span>
            // to avoid re-initialization of engine, store it in a map
<span class="nc" id="L421">            engines.put(lang, se);</span>
        }
<span class="nc" id="L423">        return se;</span>
    }

    // initialize a given script engine
    private static void initScriptEngine(ScriptEngine se) {
        // put engine global variable
<span class="nc" id="L429">        se.put(&quot;engine&quot;, se);</span>

        // load init.&lt;ext&gt; file from resource
<span class="nc" id="L432">        List&lt;String&gt; exts = se.getFactory().getExtensions();</span>
<span class="nc" id="L433">        InputStream sysIn = null;</span>
<span class="nc" id="L434">        ClassLoader cl = Thread.currentThread().getContextClassLoader();</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">        for (String ext : exts) {</span>
<span class="nc" id="L436">            sysIn = cl.getResourceAsStream(&quot;com/sun/tools/script/shell/init.&quot; +</span>
                    ext);
<span class="nc bnc" id="L438" title="All 2 branches missed.">            if (sysIn != null) break;</span>
<span class="nc" id="L439">        }</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">        if (sysIn != null) {</span>
<span class="nc" id="L441">            evaluateStream(se, sysIn, &quot;&lt;system-init&gt;&quot;, null);</span>
        }
<span class="nc" id="L443">    }</span>

    /**
     * Checks for -classpath, -cp in command line args. Creates a ClassLoader
     * and sets it as Thread context loader for current thread.
     *
     * @param args command line argument array
     */
    private static void checkClassPath(String[] args) {
<span class="nc" id="L452">        String classPath = null;</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">        for (int i = 0; i &lt; args.length; i++) {</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            if (args[i].equals(&quot;-classpath&quot;) ||</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">                    args[i].equals(&quot;-cp&quot;)) {</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                if (++i == args.length) {</span>
                    // just -classpath or -cp with no value
<span class="nc" id="L458">                    usage(EXIT_CMD_NO_CLASSPATH);</span>
                } else {
<span class="nc" id="L460">                    classPath = args[i];</span>
                }
            }
        }

<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (classPath != null) {</span>
            /* We create a class loader, configure it with specified
             * classpath values and set the same as context loader.
             * Note that ScriptEngineManager uses context loader to
             * load script engines. So, this ensures that user defined
             * script engines will be loaded. For classes referred
             * from scripts, Rhino engine uses thread context loader
             * but this is script engine dependent. We don't have
             * script engine independent solution anyway. Unless we
             * know the class loader used by a specific engine, we
             * can't configure correct loader.
             */
<span class="nc" id="L477">            ClassLoader parent = Main.class.getClassLoader();</span>
<span class="nc" id="L478">            URL[] urls = pathToURLs(classPath);</span>
<span class="nc" id="L479">            URLClassLoader loader = new URLClassLoader(urls, parent);</span>
<span class="nc" id="L480">            Thread.currentThread().setContextClassLoader(loader);</span>
        }

        // now initialize script engine manager. Note that this has to
        // be done after setting the context loader so that manager
        // will see script engines from user specified classpath
<span class="nc" id="L486">        engineManager = new ScriptEngineManager();</span>
<span class="nc" id="L487">    }</span>

    /**
     * Utility method for converting a search path string to an array
     * of directory and JAR file URLs.
     *
     * @param path the search path string
     * @return the resulting array of directory and JAR file URLs
     */
    private static URL[] pathToURLs(String path) {
<span class="nc" id="L497">        String[] components = path.split(File.pathSeparator);</span>
<span class="nc" id="L498">        URL[] urls = new URL[components.length];</span>
<span class="nc" id="L499">        int count = 0;</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">        while(count &lt; components.length) {</span>
<span class="nc" id="L501">            URL url = fileToURL(new File(components[count]));</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">            if (url != null) {</span>
<span class="nc" id="L503">                urls[count++] = url;</span>
            }
<span class="nc" id="L505">        }</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (urls.length != count) {</span>
<span class="nc" id="L507">            URL[] tmp = new URL[count];</span>
<span class="nc" id="L508">            System.arraycopy(urls, 0, tmp, 0, count);</span>
<span class="nc" id="L509">            urls = tmp;</span>
        }
<span class="nc" id="L511">        return urls;</span>
    }

    /**
     * Returns the directory or JAR file URL corresponding to the specified
     * local file name.
     *
     * @param file the File object
     * @return the resulting directory or JAR file URL, or null if unknown
     */
    private static URL fileToURL(File file) {
        String name;
        try {
<span class="nc" id="L524">            name = file.getCanonicalPath();</span>
<span class="nc" id="L525">        } catch (IOException e) {</span>
<span class="nc" id="L526">            name = file.getAbsolutePath();</span>
<span class="nc" id="L527">        }</span>
<span class="nc" id="L528">        name = name.replace(File.separatorChar, '/');</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (!name.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L530">            name = &quot;/&quot; + name;</span>
        }
        // If the file does not exist, then assume that it's a directory
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (!file.isFile()) {</span>
<span class="nc" id="L534">            name = name + &quot;/&quot;;</span>
        }
        try {
<span class="nc" id="L537">            return new URL(&quot;file&quot;, &quot;&quot;, name);</span>
<span class="nc" id="L538">        } catch (MalformedURLException e) {</span>
<span class="nc" id="L539">            throw new IllegalArgumentException(&quot;file&quot;);</span>
        }
    }

    private static void setScriptArguments(ScriptEngine se, String[] args) {
<span class="nc" id="L544">        se.put(&quot;arguments&quot;, args);</span>
<span class="nc" id="L545">        se.put(ScriptEngine.ARGV, args);</span>
<span class="nc" id="L546">    }</span>

    private static String setScriptFilename(ScriptEngine se, String name) {
<span class="nc" id="L549">        String oldName = (String) se.get(ScriptEngine.FILENAME);</span>
<span class="nc" id="L550">        se.put(ScriptEngine.FILENAME, name);</span>
<span class="nc" id="L551">        return oldName;</span>
    }

    // exit codes
    private static final int EXIT_SUCCESS            = 0;
    private static final int EXIT_CMD_NO_CLASSPATH   = 1;
    private static final int EXIT_CMD_NO_FILE        = 2;
    private static final int EXIT_CMD_NO_SCRIPT      = 3;
    private static final int EXIT_CMD_NO_LANG        = 4;
    private static final int EXIT_CMD_NO_ENCODING    = 5;
    private static final int EXIT_CMD_NO_PROPNAME    = 6;
    private static final int EXIT_UNKNOWN_OPTION     = 7;
    private static final int EXIT_ENGINE_NOT_FOUND   = 8;
    private static final int EXIT_NO_ENCODING_FOUND  = 9;
    private static final int EXIT_SCRIPT_ERROR       = 10;
    private static final int EXIT_FILE_NOT_FOUND     = 11;
    private static final int EXIT_MULTIPLE_STDIN     = 12;

    // default scripting language
    private static final String DEFAULT_LANGUAGE = &quot;js&quot;;
    // list of scripts to process
    private static List&lt;Command&gt; scripts;
    // the script engine manager
    private static ScriptEngineManager engineManager;
    // map of engines we loaded
    private static Map&lt;String, ScriptEngine&gt; engines;
    // error messages resource
    private static ResourceBundle msgRes;
<span class="nc" id="L579">    private static String BUNDLE_NAME = &quot;com.sun.tools.script.shell.messages&quot;;</span>
<span class="nc" id="L580">    private static String PROGRAM_NAME = &quot;jrunscript&quot;;</span>

    static {
<span class="nc" id="L583">        scripts = new ArrayList&lt;Command&gt;();</span>
<span class="nc" id="L584">        engines = new HashMap&lt;String, ScriptEngine&gt;();</span>
<span class="nc" id="L585">        msgRes = ResourceBundle.getBundle(BUNDLE_NAME, Locale.getDefault());</span>
<span class="nc" id="L586">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>