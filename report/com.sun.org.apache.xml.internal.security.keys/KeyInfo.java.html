<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>KeyInfo.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.org.apache.xml.internal.security.keys</a> &gt; <span class="el_source">KeyInfo.java</span></div><h1>KeyInfo.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package com.sun.org.apache.xml.internal.security.keys;

import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import javax.crypto.SecretKey;

import com.sun.org.apache.xml.internal.security.encryption.EncryptedKey;
import com.sun.org.apache.xml.internal.security.encryption.XMLCipher;
import com.sun.org.apache.xml.internal.security.encryption.XMLEncryptionException;
import com.sun.org.apache.xml.internal.security.exceptions.XMLSecurityException;
import com.sun.org.apache.xml.internal.security.keys.content.DEREncodedKeyValue;
import com.sun.org.apache.xml.internal.security.keys.content.KeyInfoReference;
import com.sun.org.apache.xml.internal.security.keys.content.KeyName;
import com.sun.org.apache.xml.internal.security.keys.content.KeyValue;
import com.sun.org.apache.xml.internal.security.keys.content.MgmtData;
import com.sun.org.apache.xml.internal.security.keys.content.PGPData;
import com.sun.org.apache.xml.internal.security.keys.content.RetrievalMethod;
import com.sun.org.apache.xml.internal.security.keys.content.SPKIData;
import com.sun.org.apache.xml.internal.security.keys.content.X509Data;
import com.sun.org.apache.xml.internal.security.keys.content.keyvalues.DSAKeyValue;
import com.sun.org.apache.xml.internal.security.keys.content.keyvalues.RSAKeyValue;
import com.sun.org.apache.xml.internal.security.keys.keyresolver.KeyResolver;
import com.sun.org.apache.xml.internal.security.keys.keyresolver.KeyResolverException;
import com.sun.org.apache.xml.internal.security.keys.keyresolver.KeyResolverSpi;
import com.sun.org.apache.xml.internal.security.keys.storage.StorageResolver;
import com.sun.org.apache.xml.internal.security.transforms.Transforms;
import com.sun.org.apache.xml.internal.security.utils.Constants;
import com.sun.org.apache.xml.internal.security.utils.EncryptionConstants;
import com.sun.org.apache.xml.internal.security.utils.SignatureElementProxy;
import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

/**
 * This class stand for KeyInfo Element that may contain keys, names,
 * certificates and other public key management information,
 * such as in-band key distribution or key agreement data.
 * &lt;BR /&gt;
 * KeyInfo Element has two basic functions:
 * One is KeyResolve for getting the public key in signature validation processing.
 * the other one is toElement for getting the element in signature generation processing.
 * &lt;BR /&gt;
 * The &lt;CODE&gt;lengthXXX()&lt;/CODE&gt; methods provide access to the internal Key
 * objects:
 * &lt;UL&gt;
 * &lt;LI&gt;If the &lt;CODE&gt;KeyInfo&lt;/CODE&gt; was constructed from an Element
 * (Signature verification), the &lt;CODE&gt;lengthXXX()&lt;/CODE&gt; methods searches
 * for child elements of &lt;CODE&gt;ds:KeyInfo&lt;/CODE&gt; for known types. &lt;/LI&gt;
 * &lt;LI&gt;If the &lt;CODE&gt;KeyInfo&lt;/CODE&gt; was constructed from scratch (during
 * Signature generation), the &lt;CODE&gt;lengthXXX()&lt;/CODE&gt; methods return the number
 * of &lt;CODE&gt;XXXs&lt;/CODE&gt; objects already passed to the KeyInfo&lt;/LI&gt;
 * &lt;/UL&gt;
 * &lt;BR /&gt;
 * The &lt;CODE&gt;addXXX()&lt;/CODE&gt; methods are used for adding Objects of the
 * appropriate type to the &lt;CODE&gt;KeyInfo&lt;/CODE&gt;. This is used during signature
 * generation.
 * &lt;BR /&gt;
 * The &lt;CODE&gt;itemXXX(int i)&lt;/CODE&gt; methods return the i'th object of the
 * corresponding type.
 * &lt;BR /&gt;
 * The &lt;CODE&gt;containsXXX()&lt;/CODE&gt; methods return &lt;I&gt;whether&lt;/I&gt; the KeyInfo
 * contains the corresponding type.
 *
 */
public class KeyInfo extends SignatureElementProxy {

    /** {@link org.apache.commons.logging} logging facility */
<span class="nc" id="L98">    private static java.util.logging.Logger log =</span>
<span class="nc" id="L99">        java.util.logging.Logger.getLogger(KeyInfo.class.getName());</span>

    // We need at least one StorageResolver otherwise
    // the KeyResolvers would not be called.
    // The default StorageResolver is null.

<span class="nc" id="L105">    private List&lt;X509Data&gt; x509Datas = null;</span>
<span class="nc" id="L106">    private List&lt;EncryptedKey&gt; encryptedKeys = null;</span>

    private static final List&lt;StorageResolver&gt; nullList;
    static {
<span class="nc" id="L110">        List&lt;StorageResolver&gt; list = new ArrayList&lt;StorageResolver&gt;(1);</span>
<span class="nc" id="L111">        list.add(null);</span>
<span class="nc" id="L112">        nullList = java.util.Collections.unmodifiableList(list);</span>
<span class="nc" id="L113">    }</span>

    /** Field storageResolvers */
<span class="nc" id="L116">    private List&lt;StorageResolver&gt; storageResolvers = nullList;</span>

    /**
     * Stores the individual (per-KeyInfo) {@link KeyResolverSpi}s
     */
<span class="nc" id="L121">    private List&lt;KeyResolverSpi&gt; internalKeyResolvers = new ArrayList&lt;KeyResolverSpi&gt;();</span>

    private boolean secureValidation;

    /**
     * Constructor KeyInfo
     * @param doc
     */
    public KeyInfo(Document doc) {
<span class="nc" id="L130">        super(doc);</span>

<span class="nc" id="L132">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L133">    }</span>

    /**
     * Constructor KeyInfo
     *
     * @param element
     * @param baseURI
     * @throws XMLSecurityException
     */
    public KeyInfo(Element element, String baseURI) throws XMLSecurityException {
<span class="nc" id="L143">        super(element, baseURI);</span>

<span class="nc" id="L145">        Attr attr = element.getAttributeNodeNS(null, &quot;Id&quot;);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (attr != null) {</span>
<span class="nc" id="L147">            element.setIdAttributeNode(attr, true);</span>
        }
<span class="nc" id="L149">    }</span>

    /**
     * Set whether secure processing is enabled or not. The default is false.
     */
    public void setSecureValidation(boolean secureValidation) {
<span class="nc" id="L155">        this.secureValidation = secureValidation;</span>
<span class="nc" id="L156">    }</span>

    /**
     * Sets the &lt;code&gt;Id&lt;/code&gt; attribute
     *
     * @param Id ID
     */
    public void setId(String id) {
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (id != null) {</span>
<span class="nc" id="L165">            this.constructionElement.setAttributeNS(null, Constants._ATT_ID, id);</span>
<span class="nc" id="L166">            this.constructionElement.setIdAttributeNS(null, Constants._ATT_ID, true);</span>
        }
<span class="nc" id="L168">    }</span>

    /**
     * Returns the &lt;code&gt;Id&lt;/code&gt; attribute
     *
     * @return the &lt;code&gt;Id&lt;/code&gt; attribute
     */
    public String getId() {
<span class="nc" id="L176">        return this.constructionElement.getAttributeNS(null, Constants._ATT_ID);</span>
    }

    /**
     * Method addKeyName
     *
     * @param keynameString
     */
    public void addKeyName(String keynameString) {
<span class="nc" id="L185">        this.add(new KeyName(this.doc, keynameString));</span>
<span class="nc" id="L186">    }</span>

    /**
     * Method add
     *
     * @param keyname
     */
    public void add(KeyName keyname) {
<span class="nc" id="L194">        this.constructionElement.appendChild(keyname.getElement());</span>
<span class="nc" id="L195">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L196">    }</span>

    /**
     * Method addKeyValue
     *
     * @param pk
     */
    public void addKeyValue(PublicKey pk) {
<span class="nc" id="L204">        this.add(new KeyValue(this.doc, pk));</span>
<span class="nc" id="L205">    }</span>

    /**
     * Method addKeyValue
     *
     * @param unknownKeyValueElement
     */
    public void addKeyValue(Element unknownKeyValueElement) {
<span class="nc" id="L213">        this.add(new KeyValue(this.doc, unknownKeyValueElement));</span>
<span class="nc" id="L214">    }</span>

    /**
     * Method add
     *
     * @param dsakeyvalue
     */
    public void add(DSAKeyValue dsakeyvalue) {
<span class="nc" id="L222">        this.add(new KeyValue(this.doc, dsakeyvalue));</span>
<span class="nc" id="L223">    }</span>

    /**
     * Method add
     *
     * @param rsakeyvalue
     */
    public void add(RSAKeyValue rsakeyvalue) {
<span class="nc" id="L231">        this.add(new KeyValue(this.doc, rsakeyvalue));</span>
<span class="nc" id="L232">    }</span>

    /**
     * Method add
     *
     * @param pk
     */
    public void add(PublicKey pk) {
<span class="nc" id="L240">        this.add(new KeyValue(this.doc, pk));</span>
<span class="nc" id="L241">    }</span>

    /**
     * Method add
     *
     * @param keyvalue
     */
    public void add(KeyValue keyvalue) {
<span class="nc" id="L249">        this.constructionElement.appendChild(keyvalue.getElement());</span>
<span class="nc" id="L250">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L251">    }</span>

    /**
     * Method addMgmtData
     *
     * @param mgmtdata
     */
    public void addMgmtData(String mgmtdata) {
<span class="nc" id="L259">        this.add(new MgmtData(this.doc, mgmtdata));</span>
<span class="nc" id="L260">    }</span>

    /**
     * Method add
     *
     * @param mgmtdata
     */
    public void add(MgmtData mgmtdata) {
<span class="nc" id="L268">        this.constructionElement.appendChild(mgmtdata.getElement());</span>
<span class="nc" id="L269">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L270">    }</span>

    /**
     * Method addPGPData
     *
     * @param pgpdata
     */
    public void add(PGPData pgpdata) {
<span class="nc" id="L278">        this.constructionElement.appendChild(pgpdata.getElement());</span>
<span class="nc" id="L279">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L280">    }</span>

    /**
     * Method addRetrievalMethod
     *
     * @param uri
     * @param transforms
     * @param Type
     */
    public void addRetrievalMethod(String uri, Transforms transforms, String Type) {
<span class="nc" id="L290">        this.add(new RetrievalMethod(this.doc, uri, transforms, Type));</span>
<span class="nc" id="L291">    }</span>

    /**
     * Method add
     *
     * @param retrievalmethod
     */
    public void add(RetrievalMethod retrievalmethod) {
<span class="nc" id="L299">        this.constructionElement.appendChild(retrievalmethod.getElement());</span>
<span class="nc" id="L300">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L301">    }</span>

    /**
     * Method add
     *
     * @param spkidata
     */
    public void add(SPKIData spkidata) {
<span class="nc" id="L309">        this.constructionElement.appendChild(spkidata.getElement());</span>
<span class="nc" id="L310">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L311">    }</span>

    /**
     * Method addX509Data
     *
     * @param x509data
     */
    public void add(X509Data x509data) {
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (x509Datas == null) {</span>
<span class="nc" id="L320">            x509Datas = new ArrayList&lt;X509Data&gt;();</span>
        }
<span class="nc" id="L322">        x509Datas.add(x509data);</span>
<span class="nc" id="L323">        this.constructionElement.appendChild(x509data.getElement());</span>
<span class="nc" id="L324">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L325">    }</span>

    /**
     * Method addEncryptedKey
     *
     * @param encryptedKey
     * @throws XMLEncryptionException
     */

    public void add(EncryptedKey encryptedKey) throws XMLEncryptionException {
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (encryptedKeys == null) {</span>
<span class="nc" id="L336">            encryptedKeys = new ArrayList&lt;EncryptedKey&gt;();</span>
        }
<span class="nc" id="L338">        encryptedKeys.add(encryptedKey);</span>
<span class="nc" id="L339">        XMLCipher cipher = XMLCipher.getInstance();</span>
<span class="nc" id="L340">        this.constructionElement.appendChild(cipher.martial(encryptedKey));</span>
<span class="nc" id="L341">    }</span>

    /**
     * Method addDEREncodedKeyValue
     *
     * @param pk
     * @throws XMLSecurityException
     */
    public void addDEREncodedKeyValue(PublicKey pk) throws XMLSecurityException {
<span class="nc" id="L350">        this.add(new DEREncodedKeyValue(this.doc, pk));</span>
<span class="nc" id="L351">    }</span>

    /**
     * Method add
     *
     * @param derEncodedKeyValue
     */
    public void add(DEREncodedKeyValue derEncodedKeyValue) {
<span class="nc" id="L359">        this.constructionElement.appendChild(derEncodedKeyValue.getElement());</span>
<span class="nc" id="L360">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L361">    }</span>

    /**
     * Method addKeyInfoReference
     *
     * @param URI
     * @throws XMLSecurityException
     */
    public void addKeyInfoReference(String URI) throws XMLSecurityException {
<span class="nc" id="L370">        this.add(new KeyInfoReference(this.doc, URI));</span>
<span class="nc" id="L371">    }</span>

    /**
     * Method add
     *
     * @param keyInfoReference
     */
    public void add(KeyInfoReference keyInfoReference) {
<span class="nc" id="L379">        this.constructionElement.appendChild(keyInfoReference.getElement());</span>
<span class="nc" id="L380">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L381">    }</span>

    /**
     * Method addUnknownElement
     *
     * @param element
     */
    public void addUnknownElement(Element element) {
<span class="nc" id="L389">        this.constructionElement.appendChild(element);</span>
<span class="nc" id="L390">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L391">    }</span>

    /**
     * Method lengthKeyName
     *
     * @return the number of the KeyName tags
     */
    public int lengthKeyName() {
<span class="nc" id="L399">        return this.length(Constants.SignatureSpecNS, Constants._TAG_KEYNAME);</span>
    }

    /**
     * Method lengthKeyValue
     *
     *@return the number of the KeyValue tags
     */
    public int lengthKeyValue() {
<span class="nc" id="L408">        return this.length(Constants.SignatureSpecNS, Constants._TAG_KEYVALUE);</span>
    }

    /**
     * Method lengthMgmtData
     *
     *@return the number of the MgmtData tags
     */
    public int lengthMgmtData() {
<span class="nc" id="L417">        return this.length(Constants.SignatureSpecNS, Constants._TAG_MGMTDATA);</span>
    }

    /**
     * Method lengthPGPData
     *
     *@return the number of the PGPDat. tags
     */
    public int lengthPGPData() {
<span class="nc" id="L426">        return this.length(Constants.SignatureSpecNS, Constants._TAG_PGPDATA);</span>
    }

    /**
     * Method lengthRetrievalMethod
     *
     *@return the number of the RetrievalMethod tags
     */
    public int lengthRetrievalMethod() {
<span class="nc" id="L435">        return this.length(Constants.SignatureSpecNS, Constants._TAG_RETRIEVALMETHOD);</span>
    }

    /**
     * Method lengthSPKIData
     *
     *@return the number of the SPKIData tags
     */
    public int lengthSPKIData() {
<span class="nc" id="L444">        return this.length(Constants.SignatureSpecNS, Constants._TAG_SPKIDATA);</span>
    }

    /**
     * Method lengthX509Data
     *
     *@return the number of the X509Data tags
     */
    public int lengthX509Data() {
<span class="nc bnc" id="L453" title="All 2 branches missed.">        if (x509Datas != null) {</span>
<span class="nc" id="L454">            return x509Datas.size();</span>
        }
<span class="nc" id="L456">        return this.length(Constants.SignatureSpecNS, Constants._TAG_X509DATA);</span>
    }

    /**
     * Method lengthDEREncodedKeyValue
     *
     *@return the number of the DEREncodedKeyValue tags
     */
    public int lengthDEREncodedKeyValue() {
<span class="nc" id="L465">        return this.length(Constants.SignatureSpec11NS, Constants._TAG_DERENCODEDKEYVALUE);</span>
    }

    /**
     * Method lengthKeyInfoReference
     *
     *@return the number of the KeyInfoReference tags
     */
    public int lengthKeyInfoReference() {
<span class="nc" id="L474">        return this.length(Constants.SignatureSpec11NS, Constants._TAG_KEYINFOREFERENCE);</span>
    }

    /**
     * Method lengthUnknownElement
     * NOTE possibly buggy.
     * @return the number of the UnknownElement tags
     */
    public int lengthUnknownElement() {
<span class="nc" id="L483">        int res = 0;</span>
<span class="nc" id="L484">        NodeList nl = this.constructionElement.getChildNodes();</span>

<span class="nc bnc" id="L486" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L487">            Node current = nl.item(i);</span>

            /**
             * $todo$ using this method, we don't see unknown Elements
             *  from Signature NS; revisit
             */
<span class="nc bnc" id="L493" title="All 2 branches missed.">            if ((current.getNodeType() == Node.ELEMENT_NODE)</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">                &amp;&amp; current.getNamespaceURI().equals(Constants.SignatureSpecNS)) {</span>
<span class="nc" id="L495">                res++;</span>
            }
        }

<span class="nc" id="L499">        return res;</span>
    }

    /**
     * Method itemKeyName
     *
     * @param i
     * @return the asked KeyName element, null if the index is too big
     * @throws XMLSecurityException
     */
    public KeyName itemKeyName(int i) throws XMLSecurityException {
<span class="nc" id="L510">        Element e =</span>
<span class="nc" id="L511">            XMLUtils.selectDsNode(</span>
<span class="nc" id="L512">                this.constructionElement.getFirstChild(), Constants._TAG_KEYNAME, i);</span>

<span class="nc bnc" id="L514" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L515">            return new KeyName(e, this.baseURI);</span>
        }
<span class="nc" id="L517">        return null;</span>
    }

    /**
     * Method itemKeyValue
     *
     * @param i
     * @return the asked KeyValue element, null if the index is too big
     * @throws XMLSecurityException
     */
    public KeyValue itemKeyValue(int i) throws XMLSecurityException {
<span class="nc" id="L528">        Element e =</span>
<span class="nc" id="L529">            XMLUtils.selectDsNode(</span>
<span class="nc" id="L530">                this.constructionElement.getFirstChild(), Constants._TAG_KEYVALUE, i);</span>

<span class="nc bnc" id="L532" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L533">            return new KeyValue(e, this.baseURI);</span>
        }
<span class="nc" id="L535">        return null;</span>
    }

    /**
     * Method itemMgmtData
     *
     * @param i
     * @return the asked MgmtData element, null if the index is too big
     * @throws XMLSecurityException
     */
    public MgmtData itemMgmtData(int i) throws XMLSecurityException {
<span class="nc" id="L546">        Element e =</span>
<span class="nc" id="L547">            XMLUtils.selectDsNode(</span>
<span class="nc" id="L548">                this.constructionElement.getFirstChild(), Constants._TAG_MGMTDATA, i);</span>

<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L551">            return new MgmtData(e, this.baseURI);</span>
        }
<span class="nc" id="L553">        return null;</span>
    }

    /**
     * Method itemPGPData
     *
     * @param i
     * @return the asked PGPData element, null if the index is too big
     * @throws XMLSecurityException
     */
    public PGPData itemPGPData(int i) throws XMLSecurityException {
<span class="nc" id="L564">        Element e =</span>
<span class="nc" id="L565">            XMLUtils.selectDsNode(</span>
<span class="nc" id="L566">                this.constructionElement.getFirstChild(), Constants._TAG_PGPDATA, i);</span>

<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L569">            return new PGPData(e, this.baseURI);</span>
        }
<span class="nc" id="L571">        return null;</span>
    }

    /**
     * Method itemRetrievalMethod
     *
     * @param i
     *@return the asked RetrievalMethod element, null if the index is too big
     * @throws XMLSecurityException
     */
    public RetrievalMethod itemRetrievalMethod(int i) throws XMLSecurityException {
<span class="nc" id="L582">        Element e =</span>
<span class="nc" id="L583">            XMLUtils.selectDsNode(</span>
<span class="nc" id="L584">                this.constructionElement.getFirstChild(), Constants._TAG_RETRIEVALMETHOD, i);</span>

<span class="nc bnc" id="L586" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L587">            return new RetrievalMethod(e, this.baseURI);</span>
        }
<span class="nc" id="L589">        return null;</span>
    }

    /**
     * Method itemSPKIData
     *
     * @param i
     * @return the asked SPKIData element, null if the index is too big
     * @throws XMLSecurityException
     */
    public SPKIData itemSPKIData(int i) throws XMLSecurityException {
<span class="nc" id="L600">        Element e =</span>
<span class="nc" id="L601">            XMLUtils.selectDsNode(</span>
<span class="nc" id="L602">                this.constructionElement.getFirstChild(), Constants._TAG_SPKIDATA, i);</span>

<span class="nc bnc" id="L604" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L605">            return new SPKIData(e, this.baseURI);</span>
        }
<span class="nc" id="L607">        return null;</span>
    }

    /**
     * Method itemX509Data
     *
     * @param i
     * @return the asked X509Data element, null if the index is too big
     * @throws XMLSecurityException
     */
    public X509Data itemX509Data(int i) throws XMLSecurityException {
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (x509Datas != null) {</span>
<span class="nc" id="L619">            return x509Datas.get(i);</span>
        }
<span class="nc" id="L621">        Element e =</span>
<span class="nc" id="L622">            XMLUtils.selectDsNode(</span>
<span class="nc" id="L623">                this.constructionElement.getFirstChild(), Constants._TAG_X509DATA, i);</span>

<span class="nc bnc" id="L625" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L626">            return new X509Data(e, this.baseURI);</span>
        }
<span class="nc" id="L628">        return null;</span>
    }

    /**
     * Method itemEncryptedKey
     *
     * @param i
     * @return the asked EncryptedKey element, null if the index is too big
     * @throws XMLSecurityException
     */
    public EncryptedKey itemEncryptedKey(int i) throws XMLSecurityException {
<span class="nc bnc" id="L639" title="All 2 branches missed.">        if (encryptedKeys != null) {</span>
<span class="nc" id="L640">            return encryptedKeys.get(i);</span>
        }
<span class="nc" id="L642">        Element e =</span>
<span class="nc" id="L643">            XMLUtils.selectXencNode(</span>
<span class="nc" id="L644">                this.constructionElement.getFirstChild(), EncryptionConstants._TAG_ENCRYPTEDKEY, i);</span>

<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L647">            XMLCipher cipher = XMLCipher.getInstance();</span>
<span class="nc" id="L648">            cipher.init(XMLCipher.UNWRAP_MODE, null);</span>
<span class="nc" id="L649">            return cipher.loadEncryptedKey(e);</span>
        }
<span class="nc" id="L651">        return null;</span>
    }

    /**
     * Method itemDEREncodedKeyValue
     *
     * @param i
     * @return the asked DEREncodedKeyValue element, null if the index is too big
     * @throws XMLSecurityException
     */
    public DEREncodedKeyValue itemDEREncodedKeyValue(int i) throws XMLSecurityException {
<span class="nc" id="L662">        Element e =</span>
<span class="nc" id="L663">            XMLUtils.selectDs11Node(</span>
<span class="nc" id="L664">                this.constructionElement.getFirstChild(), Constants._TAG_DERENCODEDKEYVALUE, i);</span>

<span class="nc bnc" id="L666" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L667">            return new DEREncodedKeyValue(e, this.baseURI);</span>
        }
<span class="nc" id="L669">        return null;</span>
    }

    /**
     * Method itemKeyInfoReference
     *
     * @param i
     * @return the asked KeyInfoReference element, null if the index is too big
     * @throws XMLSecurityException
     */
    public KeyInfoReference itemKeyInfoReference(int i) throws XMLSecurityException {
<span class="nc" id="L680">        Element e =</span>
<span class="nc" id="L681">            XMLUtils.selectDs11Node(</span>
<span class="nc" id="L682">                this.constructionElement.getFirstChild(), Constants._TAG_KEYINFOREFERENCE, i);</span>

<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L685">            return new KeyInfoReference(e, this.baseURI);</span>
        }
<span class="nc" id="L687">        return null;</span>
    }

    /**
     * Method itemUnknownElement
     *
     * @param i index
     * @return the element number of the unknown elements
     */
    public Element itemUnknownElement(int i) {
<span class="nc" id="L697">        NodeList nl = this.constructionElement.getChildNodes();</span>
<span class="nc" id="L698">        int res = 0;</span>

<span class="nc bnc" id="L700" title="All 2 branches missed.">        for (int j = 0; j &lt; nl.getLength(); j++) {</span>
<span class="nc" id="L701">            Node current = nl.item(j);</span>

            /**
             * $todo$ using this method, we don't see unknown Elements
             *  from Signature NS; revisit
             */
<span class="nc bnc" id="L707" title="All 2 branches missed.">            if ((current.getNodeType() == Node.ELEMENT_NODE)</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                &amp;&amp; current.getNamespaceURI().equals(Constants.SignatureSpecNS)) {</span>
<span class="nc" id="L709">                res++;</span>

<span class="nc bnc" id="L711" title="All 2 branches missed.">                if (res == i) {</span>
<span class="nc" id="L712">                    return (Element) current;</span>
                }
            }
        }

<span class="nc" id="L717">        return null;</span>
    }

    /**
     * Method isEmpty
     *
     * @return true if the element has no descendants.
     */
    public boolean isEmpty() {
<span class="nc bnc" id="L726" title="All 2 branches missed.">        return this.constructionElement.getFirstChild() == null;</span>
    }

    /**
     * Method containsKeyName
     *
     * @return If the KeyInfo contains a KeyName node
     */
    public boolean containsKeyName() {
<span class="nc bnc" id="L735" title="All 2 branches missed.">        return this.lengthKeyName() &gt; 0;</span>
    }

    /**
     * Method containsKeyValue
     *
     * @return If the KeyInfo contains a KeyValue node
     */
    public boolean containsKeyValue() {
<span class="nc bnc" id="L744" title="All 2 branches missed.">        return this.lengthKeyValue() &gt; 0;</span>
    }

    /**
     * Method containsMgmtData
     *
     * @return If the KeyInfo contains a MgmtData node
     */
    public boolean containsMgmtData() {
<span class="nc bnc" id="L753" title="All 2 branches missed.">        return this.lengthMgmtData() &gt; 0;</span>
    }

    /**
     * Method containsPGPData
     *
     * @return If the KeyInfo contains a PGPData node
     */
    public boolean containsPGPData() {
<span class="nc bnc" id="L762" title="All 2 branches missed.">        return this.lengthPGPData() &gt; 0;</span>
    }

    /**
     * Method containsRetrievalMethod
     *
     * @return If the KeyInfo contains a RetrievalMethod node
     */
    public boolean containsRetrievalMethod() {
<span class="nc bnc" id="L771" title="All 2 branches missed.">        return this.lengthRetrievalMethod() &gt; 0;</span>
    }

    /**
     * Method containsSPKIData
     *
     * @return If the KeyInfo contains a SPKIData node
     */
    public boolean containsSPKIData() {
<span class="nc bnc" id="L780" title="All 2 branches missed.">        return this.lengthSPKIData() &gt; 0;</span>
    }

    /**
     * Method containsUnknownElement
     *
     * @return If the KeyInfo contains a UnknownElement node
     */
    public boolean containsUnknownElement() {
<span class="nc bnc" id="L789" title="All 2 branches missed.">        return this.lengthUnknownElement() &gt; 0;</span>
    }

    /**
     * Method containsX509Data
     *
     * @return If the KeyInfo contains a X509Data node
     */
    public boolean containsX509Data() {
<span class="nc bnc" id="L798" title="All 2 branches missed.">        return this.lengthX509Data() &gt; 0;</span>
    }

    /**
     * Method containsDEREncodedKeyValue
     *
     * @return If the KeyInfo contains a DEREncodedKeyValue node
     */
    public boolean containsDEREncodedKeyValue() {
<span class="nc bnc" id="L807" title="All 2 branches missed.">        return this.lengthDEREncodedKeyValue() &gt; 0;</span>
    }

    /**
     * Method containsKeyInfoReference
     *
     * @return If the KeyInfo contains a KeyInfoReference node
     */
    public boolean containsKeyInfoReference() {
<span class="nc bnc" id="L816" title="All 2 branches missed.">        return this.lengthKeyInfoReference() &gt; 0;</span>
    }

    /**
     * This method returns the public key.
     *
     * @return If the KeyInfo contains a PublicKey node
     * @throws KeyResolverException
     */
    public PublicKey getPublicKey() throws KeyResolverException {
<span class="nc" id="L826">        PublicKey pk = this.getPublicKeyFromInternalResolvers();</span>

<span class="nc bnc" id="L828" title="All 2 branches missed.">        if (pk != null) {</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L830">                log.log(java.util.logging.Level.FINE, &quot;I could find a key using the per-KeyInfo key resolvers&quot;);</span>
            }

<span class="nc" id="L833">            return pk;</span>
        }
<span class="nc bnc" id="L835" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L836">            log.log(java.util.logging.Level.FINE, &quot;I couldn't find a key using the per-KeyInfo key resolvers&quot;);</span>
        }

<span class="nc" id="L839">        pk = this.getPublicKeyFromStaticResolvers();</span>

<span class="nc bnc" id="L841" title="All 2 branches missed.">        if (pk != null) {</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L843">                log.log(java.util.logging.Level.FINE, &quot;I could find a key using the system-wide key resolvers&quot;);</span>
            }

<span class="nc" id="L846">            return pk;</span>
        }
<span class="nc bnc" id="L848" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L849">            log.log(java.util.logging.Level.FINE, &quot;I couldn't find a key using the system-wide key resolvers&quot;);</span>
        }

<span class="nc" id="L852">        return null;</span>
    }

    /**
     * Searches the library wide KeyResolvers for public keys
     *
     * @return The public key contained in this Node.
     * @throws KeyResolverException
     */
    PublicKey getPublicKeyFromStaticResolvers() throws KeyResolverException {
<span class="nc" id="L862">        Iterator&lt;KeyResolverSpi&gt; it = KeyResolver.iterator();</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">        while (it.hasNext()) {</span>
<span class="nc" id="L864">            KeyResolverSpi keyResolver = it.next();</span>
<span class="nc" id="L865">            keyResolver.setSecureValidation(secureValidation);</span>
<span class="nc" id="L866">            Node currentChild = this.constructionElement.getFirstChild();</span>
<span class="nc" id="L867">            String uri = this.getBaseURI();</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">            while (currentChild != null) {</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">                if (currentChild.getNodeType() == Node.ELEMENT_NODE) {</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">                    for (StorageResolver storage : storageResolvers) {</span>
<span class="nc" id="L871">                        PublicKey pk =</span>
<span class="nc" id="L872">                            keyResolver.engineLookupAndResolvePublicKey(</span>
                                (Element) currentChild, uri, storage
                            );

<span class="nc bnc" id="L876" title="All 2 branches missed.">                        if (pk != null) {</span>
<span class="nc" id="L877">                            return pk;</span>
                        }
<span class="nc" id="L879">                    }</span>
                }
<span class="nc" id="L881">                currentChild = currentChild.getNextSibling();</span>
            }
<span class="nc" id="L883">        }</span>
<span class="nc" id="L884">        return null;</span>
    }

    /**
     * Searches the per-KeyInfo KeyResolvers for public keys
     *
     * @return The public key contained in this Node.
     * @throws KeyResolverException
     */
    PublicKey getPublicKeyFromInternalResolvers() throws KeyResolverException {
<span class="nc bnc" id="L894" title="All 2 branches missed.">        for (KeyResolverSpi keyResolver : internalKeyResolvers) {</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L896">                log.log(java.util.logging.Level.FINE, &quot;Try &quot; + keyResolver.getClass().getName());</span>
            }
<span class="nc" id="L898">            keyResolver.setSecureValidation(secureValidation);</span>
<span class="nc" id="L899">            Node currentChild = this.constructionElement.getFirstChild();</span>
<span class="nc" id="L900">            String uri = this.getBaseURI();</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">            while (currentChild != null)      {</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">                if (currentChild.getNodeType() == Node.ELEMENT_NODE) {</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">                    for (StorageResolver storage : storageResolvers) {</span>
<span class="nc" id="L904">                        PublicKey pk =</span>
<span class="nc" id="L905">                            keyResolver.engineLookupAndResolvePublicKey(</span>
                                (Element) currentChild, uri, storage
                            );

<span class="nc bnc" id="L909" title="All 2 branches missed.">                        if (pk != null) {</span>
<span class="nc" id="L910">                            return pk;</span>
                        }
<span class="nc" id="L912">                    }</span>
                }
<span class="nc" id="L914">                currentChild = currentChild.getNextSibling();</span>
            }
<span class="nc" id="L916">        }</span>

<span class="nc" id="L918">        return null;</span>
    }

    /**
     * Method getX509Certificate
     *
     * @return The certificate contained in this KeyInfo
     * @throws KeyResolverException
     */
    public X509Certificate getX509Certificate() throws KeyResolverException {
        // First search using the individual resolvers from the user
<span class="nc" id="L929">        X509Certificate cert = this.getX509CertificateFromInternalResolvers();</span>

<span class="nc bnc" id="L931" title="All 2 branches missed.">        if (cert != null) {</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L933">                log.log(java.util.logging.Level.FINE, &quot;I could find a X509Certificate using the per-KeyInfo key resolvers&quot;);</span>
            }

<span class="nc" id="L936">            return cert;</span>
        }
<span class="nc bnc" id="L938" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L939">            log.log(java.util.logging.Level.FINE, &quot;I couldn't find a X509Certificate using the per-KeyInfo key resolvers&quot;);</span>
        }

        // Then use the system-wide Resolvers
<span class="nc" id="L943">        cert = this.getX509CertificateFromStaticResolvers();</span>

<span class="nc bnc" id="L945" title="All 2 branches missed.">        if (cert != null) {</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L947">                log.log(java.util.logging.Level.FINE, &quot;I could find a X509Certificate using the system-wide key resolvers&quot;);</span>
            }

<span class="nc" id="L950">            return cert;</span>
        }
<span class="nc bnc" id="L952" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L953">            log.log(java.util.logging.Level.FINE, &quot;I couldn't find a X509Certificate using the system-wide key resolvers&quot;);</span>
        }

<span class="nc" id="L956">        return null;</span>
    }

    /**
     * This method uses each System-wide {@link KeyResolver} to search the
     * child elements. Each combination of {@link KeyResolver} and child element
     * is checked against all {@link StorageResolver}s.
     *
     * @return The certificate contained in this KeyInfo
     * @throws KeyResolverException
     */
    X509Certificate getX509CertificateFromStaticResolvers()
        throws KeyResolverException {
<span class="nc bnc" id="L969" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L970">            log.log(java.util.logging.Level.FINE,</span>
<span class="nc" id="L971">                &quot;Start getX509CertificateFromStaticResolvers() with &quot; + KeyResolver.length()</span>
                + &quot; resolvers&quot;
            );
        }
<span class="nc" id="L975">        String uri = this.getBaseURI();</span>
<span class="nc" id="L976">        Iterator&lt;KeyResolverSpi&gt; it = KeyResolver.iterator();</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">        while (it.hasNext()) {</span>
<span class="nc" id="L978">            KeyResolverSpi keyResolver = it.next();</span>
<span class="nc" id="L979">            keyResolver.setSecureValidation(secureValidation);</span>
<span class="nc" id="L980">            X509Certificate cert = applyCurrentResolver(uri, keyResolver);</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">            if (cert != null) {</span>
<span class="nc" id="L982">                return cert;</span>
            }
<span class="nc" id="L984">        }</span>
<span class="nc" id="L985">        return null;</span>
    }

    private X509Certificate applyCurrentResolver(
        String uri, KeyResolverSpi keyResolver
    ) throws KeyResolverException {
<span class="nc" id="L991">        Node currentChild = this.constructionElement.getFirstChild();</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">        while (currentChild != null)      {</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">            if (currentChild.getNodeType() == Node.ELEMENT_NODE) {</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">                for (StorageResolver storage : storageResolvers) {</span>
<span class="nc" id="L995">                    X509Certificate cert =</span>
<span class="nc" id="L996">                        keyResolver.engineLookupResolveX509Certificate(</span>
                            (Element) currentChild, uri, storage
                        );

<span class="nc bnc" id="L1000" title="All 2 branches missed.">                    if (cert != null) {</span>
<span class="nc" id="L1001">                        return cert;</span>
                    }
<span class="nc" id="L1003">                }</span>
            }
<span class="nc" id="L1005">            currentChild = currentChild.getNextSibling();</span>
        }
<span class="nc" id="L1007">        return null;</span>
    }

    /**
     * Method getX509CertificateFromInternalResolvers
     *
     * @return The certificate contained in this KeyInfo
     * @throws KeyResolverException
     */
    X509Certificate getX509CertificateFromInternalResolvers()
        throws KeyResolverException {
<span class="nc bnc" id="L1018" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1019">            log.log(java.util.logging.Level.FINE,</span>
                &quot;Start getX509CertificateFromInternalResolvers() with &quot;
<span class="nc" id="L1021">                + this.lengthInternalKeyResolver() + &quot; resolvers&quot;</span>
            );
        }
<span class="nc" id="L1024">        String uri = this.getBaseURI();</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">        for (KeyResolverSpi keyResolver : internalKeyResolvers) {</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1027">                log.log(java.util.logging.Level.FINE, &quot;Try &quot; + keyResolver.getClass().getName());</span>
            }
<span class="nc" id="L1029">            keyResolver.setSecureValidation(secureValidation);</span>
<span class="nc" id="L1030">            X509Certificate cert = applyCurrentResolver(uri, keyResolver);</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">            if (cert != null) {</span>
<span class="nc" id="L1032">                return cert;</span>
            }
<span class="nc" id="L1034">        }</span>

<span class="nc" id="L1036">        return null;</span>
    }

    /**
     * This method returns a secret (symmetric) key. This is for XML Encryption.
     * @return the secret key contained in this KeyInfo
     * @throws KeyResolverException
     */
    public SecretKey getSecretKey() throws KeyResolverException {
<span class="nc" id="L1045">        SecretKey sk = this.getSecretKeyFromInternalResolvers();</span>

<span class="nc bnc" id="L1047" title="All 2 branches missed.">        if (sk != null) {</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1049">                log.log(java.util.logging.Level.FINE, &quot;I could find a secret key using the per-KeyInfo key resolvers&quot;);</span>
            }

<span class="nc" id="L1052">            return sk;</span>
        }
<span class="nc bnc" id="L1054" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1055">            log.log(java.util.logging.Level.FINE, &quot;I couldn't find a secret key using the per-KeyInfo key resolvers&quot;);</span>
        }

<span class="nc" id="L1058">        sk = this.getSecretKeyFromStaticResolvers();</span>

<span class="nc bnc" id="L1060" title="All 2 branches missed.">        if (sk != null) {</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1062">                log.log(java.util.logging.Level.FINE, &quot;I could find a secret key using the system-wide key resolvers&quot;);</span>
            }

<span class="nc" id="L1065">            return sk;</span>
        }
<span class="nc bnc" id="L1067" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1068">            log.log(java.util.logging.Level.FINE, &quot;I couldn't find a secret key using the system-wide key resolvers&quot;);</span>
        }

<span class="nc" id="L1071">        return null;</span>
    }

    /**
     * Searches the library wide KeyResolvers for Secret keys
     *
     * @return the secret key contained in this KeyInfo
     * @throws KeyResolverException
     */
    SecretKey getSecretKeyFromStaticResolvers() throws KeyResolverException {
<span class="nc" id="L1081">        Iterator&lt;KeyResolverSpi&gt; it = KeyResolver.iterator();</span>
<span class="nc bnc" id="L1082" title="All 2 branches missed.">        while (it.hasNext()) {</span>
<span class="nc" id="L1083">            KeyResolverSpi keyResolver = it.next();</span>
<span class="nc" id="L1084">            keyResolver.setSecureValidation(secureValidation);</span>

<span class="nc" id="L1086">            Node currentChild = this.constructionElement.getFirstChild();</span>
<span class="nc" id="L1087">            String uri = this.getBaseURI();</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">            while (currentChild != null)      {</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">                if (currentChild.getNodeType() == Node.ELEMENT_NODE) {</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">                    for (StorageResolver storage : storageResolvers) {</span>
<span class="nc" id="L1091">                        SecretKey sk =</span>
<span class="nc" id="L1092">                            keyResolver.engineLookupAndResolveSecretKey(</span>
                                (Element) currentChild, uri, storage
                            );

<span class="nc bnc" id="L1096" title="All 2 branches missed.">                        if (sk != null) {</span>
<span class="nc" id="L1097">                            return sk;</span>
                        }
<span class="nc" id="L1099">                    }</span>
                }
<span class="nc" id="L1101">                currentChild = currentChild.getNextSibling();</span>
            }
<span class="nc" id="L1103">        }</span>
<span class="nc" id="L1104">        return null;</span>
    }

    /**
     * Searches the per-KeyInfo KeyResolvers for secret keys
     *
     * @return the secret key contained in this KeyInfo
     * @throws KeyResolverException
     */

    SecretKey getSecretKeyFromInternalResolvers() throws KeyResolverException {
<span class="nc bnc" id="L1115" title="All 2 branches missed.">        for (KeyResolverSpi keyResolver : internalKeyResolvers) {</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1117">                log.log(java.util.logging.Level.FINE, &quot;Try &quot; + keyResolver.getClass().getName());</span>
            }
<span class="nc" id="L1119">            keyResolver.setSecureValidation(secureValidation);</span>
<span class="nc" id="L1120">            Node currentChild = this.constructionElement.getFirstChild();</span>
<span class="nc" id="L1121">            String uri = this.getBaseURI();</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">            while (currentChild != null)      {</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                if (currentChild.getNodeType() == Node.ELEMENT_NODE) {</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">                    for (StorageResolver storage : storageResolvers) {</span>
<span class="nc" id="L1125">                        SecretKey sk =</span>
<span class="nc" id="L1126">                            keyResolver.engineLookupAndResolveSecretKey(</span>
                                (Element) currentChild, uri, storage
                            );

<span class="nc bnc" id="L1130" title="All 2 branches missed.">                        if (sk != null) {</span>
<span class="nc" id="L1131">                            return sk;</span>
                        }
<span class="nc" id="L1133">                    }</span>
                }
<span class="nc" id="L1135">                currentChild = currentChild.getNextSibling();</span>
            }
<span class="nc" id="L1137">        }</span>

<span class="nc" id="L1139">        return null;</span>
    }

    /**
     * This method returns a private key. This is for Key Transport in XML Encryption.
     * @return the private key contained in this KeyInfo
     * @throws KeyResolverException
     */
    public PrivateKey getPrivateKey() throws KeyResolverException {
<span class="nc" id="L1148">        PrivateKey pk = this.getPrivateKeyFromInternalResolvers();</span>

<span class="nc bnc" id="L1150" title="All 2 branches missed.">        if (pk != null) {</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1152">                log.log(java.util.logging.Level.FINE, &quot;I could find a private key using the per-KeyInfo key resolvers&quot;);</span>
            }
<span class="nc" id="L1154">            return pk;</span>
        }
<span class="nc bnc" id="L1156" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1157">            log.log(java.util.logging.Level.FINE, &quot;I couldn't find a secret key using the per-KeyInfo key resolvers&quot;);</span>
        }

<span class="nc" id="L1160">        pk = this.getPrivateKeyFromStaticResolvers();</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">        if (pk != null) {</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1163">                log.log(java.util.logging.Level.FINE, &quot;I could find a private key using the system-wide key resolvers&quot;);</span>
            }
<span class="nc" id="L1165">            return pk;</span>
        }
<span class="nc bnc" id="L1167" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1168">            log.log(java.util.logging.Level.FINE, &quot;I couldn't find a private key using the system-wide key resolvers&quot;);</span>
        }

<span class="nc" id="L1171">        return null;</span>
    }

    /**
     * Searches the library wide KeyResolvers for Private keys
     *
     * @return the private key contained in this KeyInfo
     * @throws KeyResolverException
     */
    PrivateKey getPrivateKeyFromStaticResolvers() throws KeyResolverException {
<span class="nc" id="L1181">        Iterator&lt;KeyResolverSpi&gt; it = KeyResolver.iterator();</span>
<span class="nc bnc" id="L1182" title="All 2 branches missed.">        while (it.hasNext()) {</span>
<span class="nc" id="L1183">            KeyResolverSpi keyResolver = it.next();</span>
<span class="nc" id="L1184">            keyResolver.setSecureValidation(secureValidation);</span>

<span class="nc" id="L1186">            Node currentChild = this.constructionElement.getFirstChild();</span>
<span class="nc" id="L1187">            String uri = this.getBaseURI();</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">            while (currentChild != null)      {</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">                if (currentChild.getNodeType() == Node.ELEMENT_NODE) {</span>
                    // not using StorageResolvers at the moment
                    // since they cannot return private keys
<span class="nc" id="L1192">                    PrivateKey pk =</span>
<span class="nc" id="L1193">                        keyResolver.engineLookupAndResolvePrivateKey(</span>
                            (Element) currentChild, uri, null
                        );

<span class="nc bnc" id="L1197" title="All 2 branches missed.">                    if (pk != null) {</span>
<span class="nc" id="L1198">                        return pk;</span>
                    }
                }
<span class="nc" id="L1201">                currentChild = currentChild.getNextSibling();</span>
            }
<span class="nc" id="L1203">        }</span>
<span class="nc" id="L1204">        return null;</span>
    }

    /**
     * Searches the per-KeyInfo KeyResolvers for private keys
     *
     * @return the private key contained in this KeyInfo
     * @throws KeyResolverException
     */
    PrivateKey getPrivateKeyFromInternalResolvers() throws KeyResolverException {
<span class="nc bnc" id="L1214" title="All 2 branches missed.">        for (KeyResolverSpi keyResolver : internalKeyResolvers) {</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L1216">                log.log(java.util.logging.Level.FINE, &quot;Try &quot; + keyResolver.getClass().getName());</span>
            }
<span class="nc" id="L1218">            keyResolver.setSecureValidation(secureValidation);</span>
<span class="nc" id="L1219">            Node currentChild = this.constructionElement.getFirstChild();</span>
<span class="nc" id="L1220">            String uri = this.getBaseURI();</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">            while (currentChild != null) {</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">                if (currentChild.getNodeType() == Node.ELEMENT_NODE) {</span>
                    // not using StorageResolvers at the moment
                    // since they cannot return private keys
<span class="nc" id="L1225">                    PrivateKey pk =</span>
<span class="nc" id="L1226">                        keyResolver.engineLookupAndResolvePrivateKey(</span>
                            (Element) currentChild, uri, null
                        );

<span class="nc bnc" id="L1230" title="All 2 branches missed.">                    if (pk != null) {</span>
<span class="nc" id="L1231">                        return pk;</span>
                    }
                }
<span class="nc" id="L1234">                currentChild = currentChild.getNextSibling();</span>
            }
<span class="nc" id="L1236">        }</span>

<span class="nc" id="L1238">        return null;</span>
    }

    /**
     * This method is used to add a custom {@link KeyResolverSpi} to a KeyInfo
     * object.
     *
     * @param realKeyResolver
     */
    public void registerInternalKeyResolver(KeyResolverSpi realKeyResolver) {
<span class="nc" id="L1248">        this.internalKeyResolvers.add(realKeyResolver);</span>
<span class="nc" id="L1249">    }</span>

    /**
     * Method lengthInternalKeyResolver
     * @return the length of the key
     */
    int lengthInternalKeyResolver() {
<span class="nc" id="L1256">        return this.internalKeyResolvers.size();</span>
    }

    /**
     * Method itemInternalKeyResolver
     *
     * @param i the index
     * @return the KeyResolverSpi for the index.
     */
    KeyResolverSpi itemInternalKeyResolver(int i) {
<span class="nc" id="L1266">        return this.internalKeyResolvers.get(i);</span>
    }

    /**
     * Method addStorageResolver
     *
     * @param storageResolver
     */
    public void addStorageResolver(StorageResolver storageResolver) {
<span class="nc bnc" id="L1275" title="All 2 branches missed.">        if (storageResolvers == nullList) {</span>
            // Replace the default null StorageResolver
<span class="nc" id="L1277">            storageResolvers = new ArrayList&lt;StorageResolver&gt;();</span>
        }
<span class="nc" id="L1279">        this.storageResolvers.add(storageResolver);</span>
<span class="nc" id="L1280">    }</span>


    /** @inheritDoc */
    public String getBaseLocalName() {
<span class="nc" id="L1285">        return Constants._TAG_KEYINFO;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>