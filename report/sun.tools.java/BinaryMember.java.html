<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BinaryMember.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.tools.java</a> &gt; <span class="el_source">BinaryMember.java</span></div><h1>BinaryMember.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1994, 2003, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.java;

import sun.tools.tree.*;
import java.util.Vector;
import java.util.Hashtable;
import java.io.IOException;
import java.io.DataInputStream;
import java.io.ByteArrayInputStream;

/**
 * This class represents a binary member
 *
 * WARNING: The contents of this source file are not part of any
 * supported API.  Code that depends on them does so at its own risk:
 * they are subject to change or removal without notice.
 */
public final
class BinaryMember extends MemberDefinition {
    Expression value;
    BinaryAttribute atts;

    /**
     * Constructor
     */
    public BinaryMember(ClassDefinition clazz, int modifiers, Type type,
                       Identifier name, BinaryAttribute atts) {
<span class="nc" id="L52">        super(0, clazz, modifiers, type, name, null, null);</span>
<span class="nc" id="L53">        this.atts = atts;</span>

        // Was it compiled as deprecated?
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (getAttribute(idDeprecated) != null) {</span>
<span class="nc" id="L57">            this.modifiers |= M_DEPRECATED;</span>
        }

        // Was it synthesized by the compiler?
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (getAttribute(idSynthetic) != null) {</span>
<span class="nc" id="L62">            this.modifiers |= M_SYNTHETIC;</span>
        }
<span class="nc" id="L64">    }</span>

    /**
     * Constructor for an inner class.
     */
    public BinaryMember(ClassDefinition innerClass) {
<span class="nc" id="L70">        super(innerClass);</span>
<span class="nc" id="L71">    }</span>

    /**
     * Inline allowed (currently only allowed for the constructor of Object).
     */
    public boolean isInlineable(Environment env, boolean fromFinal) {
        // It is possible for 'getSuperClass()' to return null due to error
        // recovery from cyclic inheritace.  Can this cause a problem here?
<span class="nc bnc" id="L79" title="All 4 branches missed.">        return isConstructor() &amp;&amp; (getClassDefinition().getSuperClass() == null);</span>
    }

    /**
     * Get arguments
     */
    public Vector getArguments() {
<span class="nc bnc" id="L86" title="All 4 branches missed.">        if (isConstructor() &amp;&amp; (getClassDefinition().getSuperClass() == null)) {</span>
<span class="nc" id="L87">            Vector v = new Vector();</span>
<span class="nc" id="L88">            v.addElement(new LocalMember(0, getClassDefinition(), 0,</span>
<span class="nc" id="L89">                                        getClassDefinition().getType(), idThis));</span>
<span class="nc" id="L90">            return v;</span>
        }
<span class="nc" id="L92">        return null;</span>
    }

    /**
     * Get exceptions
     */
    public ClassDeclaration[] getExceptions(Environment env) {
<span class="nc bnc" id="L99" title="All 4 branches missed.">        if ((!isMethod()) || (exp != null)) {</span>
<span class="nc" id="L100">            return exp;</span>
        }
<span class="nc" id="L102">        byte data[] = getAttribute(idExceptions);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (data == null) {</span>
<span class="nc" id="L104">            return new ClassDeclaration[0];</span>
        }

        try {
<span class="nc" id="L108">            BinaryConstantPool cpool = ((BinaryClass)getClassDefinition()).getConstants();</span>
<span class="nc" id="L109">            DataInputStream in = new DataInputStream(new ByteArrayInputStream(data));</span>
            // JVM 4.7.5 Exceptions_attribute.number_of_exceptions
<span class="nc" id="L111">            int n = in.readUnsignedShort();</span>
<span class="nc" id="L112">            exp = new ClassDeclaration[n];</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            for (int i = 0 ; i &lt; n ; i++) {</span>
                // JVM 4.7.5 Exceptions_attribute.exception_index_table[]
<span class="nc" id="L115">                exp[i] = cpool.getDeclaration(env, in.readUnsignedShort());</span>
            }
<span class="nc" id="L117">            return exp;</span>
<span class="nc" id="L118">        } catch (IOException e) {</span>
<span class="nc" id="L119">            throw new CompilerError(e);</span>
        }
    }

    /**
     * Get documentation
     */
    public String getDocumentation() {
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (documentation != null) {</span>
<span class="nc" id="L128">            return documentation;</span>
        }
<span class="nc" id="L130">        byte data[] = getAttribute(idDocumentation);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (data == null) {</span>
<span class="nc" id="L132">            return null;</span>
        }
        try {
<span class="nc" id="L135">            return documentation = new DataInputStream(new ByteArrayInputStream(data)).readUTF();</span>
<span class="nc" id="L136">        } catch (IOException e) {</span>
<span class="nc" id="L137">            throw new CompilerError(e);</span>
        }
    }

    /**
     * Check if constant:  Will it inline away to a constant?
     * This override is needed to solve bug 4128266.  It is also
     * integral to the solution of 4119776.
     */
<span class="nc" id="L146">    private boolean isConstantCache = false;</span>
<span class="nc" id="L147">    private boolean isConstantCached = false;</span>
    public boolean isConstant() {
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (!isConstantCached) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            isConstantCache = isFinal()</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                              &amp;&amp; isVariable()</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                              &amp;&amp; getAttribute(idConstantValue) != null;</span>
<span class="nc" id="L153">            isConstantCached = true;</span>
        }
<span class="nc" id="L155">        return isConstantCache;</span>
    }

    /**
     * Get the value
     */
    public Node getValue(Environment env) {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (isMethod()) {</span>
<span class="nc" id="L163">            return null;</span>
        }
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (!isFinal()) {</span>
<span class="nc" id="L166">            return null;</span>
        }
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (getValue() != null) {</span>
<span class="nc" id="L169">            return (Expression)getValue();</span>
        }
<span class="nc" id="L171">        byte data[] = getAttribute(idConstantValue);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (data == null) {</span>
<span class="nc" id="L173">            return null;</span>
        }

        try {
<span class="nc" id="L177">            BinaryConstantPool cpool = ((BinaryClass)getClassDefinition()).getConstants();</span>
            // JVM 4.7.3 ConstantValue.constantvalue_index
<span class="nc" id="L179">            Object obj = cpool.getValue(new DataInputStream(new ByteArrayInputStream(data)).readUnsignedShort());</span>
<span class="nc bnc" id="L180" title="All 7 branches missed.">            switch (getType().getTypeCode()) {</span>
              case TC_BOOLEAN:
<span class="nc bnc" id="L182" title="All 2 branches missed.">                setValue(new BooleanExpression(0, ((Number)obj).intValue() != 0));</span>
<span class="nc" id="L183">                break;</span>
              case TC_BYTE:
              case TC_SHORT:
              case TC_CHAR:
              case TC_INT:
<span class="nc" id="L188">                setValue(new IntExpression(0, ((Number)obj).intValue()));</span>
<span class="nc" id="L189">                break;</span>
              case TC_LONG:
<span class="nc" id="L191">                setValue(new LongExpression(0, ((Number)obj).longValue()));</span>
<span class="nc" id="L192">                break;</span>
              case TC_FLOAT:
<span class="nc" id="L194">                setValue(new FloatExpression(0, ((Number)obj).floatValue()));</span>
<span class="nc" id="L195">                break;</span>
              case TC_DOUBLE:
<span class="nc" id="L197">                setValue(new DoubleExpression(0, ((Number)obj).doubleValue()));</span>
<span class="nc" id="L198">                break;</span>
              case TC_CLASS:
<span class="nc" id="L200">                setValue(new StringExpression(0, (String)cpool.getValue(((Number)obj).intValue())));</span>
                break;
            }
<span class="nc" id="L203">            return (Expression)getValue();</span>
<span class="nc" id="L204">        } catch (IOException e) {</span>
<span class="nc" id="L205">            throw new CompilerError(e);</span>
        }
    }

    /**
     * Get a field attribute
     */
    public byte[] getAttribute(Identifier name) {
<span class="nc bnc" id="L213" title="All 2 branches missed.">        for (BinaryAttribute att = atts ; att != null ; att = att.next) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (att.name.equals(name)) {</span>
<span class="nc" id="L215">                return att.data;</span>
            }
        }
<span class="nc" id="L218">        return null;</span>
    }

    public boolean deleteAttribute(Identifier name) {
<span class="nc" id="L222">        BinaryAttribute walker = null, next = null;</span>

<span class="nc" id="L224">        boolean succeed = false;</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">        while (atts.name.equals(name)) {</span>
<span class="nc" id="L227">            atts = atts.next;</span>
<span class="nc" id="L228">            succeed = true;</span>
        }
<span class="nc bnc" id="L230" title="All 2 branches missed.">        for (walker = atts; walker != null; walker = next) {</span>
<span class="nc" id="L231">            next = walker.next;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (next != null) {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                if (next.name.equals(name)) {</span>
<span class="nc" id="L234">                    walker.next = next.next;</span>
<span class="nc" id="L235">                    next = next.next;</span>
<span class="nc" id="L236">                    succeed = true;</span>
                }
            }
        }
<span class="nc bnc" id="L240" title="All 2 branches missed.">        for (walker = atts; walker != null; walker = walker.next) {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            if (walker.name.equals(name)) {</span>
<span class="nc" id="L242">                throw new InternalError(&quot;Found attribute &quot; + name);</span>
            }
        }

<span class="nc" id="L246">        return succeed;</span>
    }



    /*
     * Add an attribute to a field
     */
    public void addAttribute(Identifier name, byte data[], Environment env) {
<span class="nc" id="L255">        this.atts = new BinaryAttribute(name, data, this.atts);</span>
        // Make sure that the new attribute is in the constant pool
<span class="nc" id="L257">        ((BinaryClass)(this.clazz)).cpool.indexString(name.toString(), env);</span>
<span class="nc" id="L258">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>