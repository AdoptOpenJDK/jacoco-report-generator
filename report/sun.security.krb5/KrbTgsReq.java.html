<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>KrbTgsReq.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.krb5</a> &gt; <span class="el_source">KrbTgsReq.java</span></div><h1>KrbTgsReq.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

/*
 *
 *  (C) Copyright IBM Corp. 1999 All Rights Reserved.
 *  Copyright 1997 The Open Group Research Institute.  All rights reserved.
 */

package sun.security.krb5;

import sun.security.krb5.internal.*;
import sun.security.krb5.internal.crypto.*;
import java.io.IOException;
import java.net.UnknownHostException;
import java.util.Arrays;

/**
 * This class encapsulates a Kerberos TGS-REQ that is sent from the
 * client to the KDC.
 */
public class KrbTgsReq {

    private PrincipalName princName;
    private PrincipalName servName;
    private TGSReq tgsReqMessg;
    private KerberosTime ctime;
<span class="fc" id="L50">    private Ticket secondTicket = null;</span>
<span class="fc" id="L51">    private boolean useSubkey = false;</span>
    EncryptionKey tgsReqKey;

<span class="fc" id="L54">    private static final boolean DEBUG = Krb5.DEBUG;</span>

    private byte[] obuf;
    private byte[] ibuf;

    // Used in CredentialsUtil
    public KrbTgsReq(Credentials asCreds,
                     PrincipalName sname)
        throws KrbException, IOException {
<span class="fc" id="L63">        this(new KDCOptions(),</span>
            asCreds,
            sname,
            null, // KerberosTime from
            null, // KerberosTime till
            null, // KerberosTime rtime
            null, // eTypes, // null, // int[] eTypes
            null, // HostAddresses addresses
            null, // AuthorizationData authorizationData
            null, // Ticket[] additionalTickets
            null); // EncryptionKey subSessionKey
<span class="fc" id="L74">    }</span>

    // S4U2proxy
    public KrbTgsReq(Credentials asCreds,
                     Ticket second,
                     PrincipalName sname)
            throws KrbException, IOException {
<span class="nc" id="L81">        this(KDCOptions.with(KDCOptions.CNAME_IN_ADDL_TKT,</span>
                KDCOptions.FORWARDABLE),
            asCreds,
            sname,
            null,
            null,
            null,
            null,
            null,
            null,
            new Ticket[] {second}, // the service ticket
            null);
<span class="nc" id="L93">    }</span>

    // S4U2user
    public KrbTgsReq(Credentials asCreds,
                     PrincipalName sname,
                     PAData extraPA)
        throws KrbException, IOException {
<span class="nc" id="L100">        this(KDCOptions.with(KDCOptions.FORWARDABLE),</span>
            asCreds,
<span class="nc" id="L102">            asCreds.getClient(),</span>
            sname,
            null,
            null,
            null,
            null,
            null,
            null,
            null,
            null,
            extraPA); // the PA-FOR-USER
<span class="nc" id="L113">    }</span>

    // Called by Credentials, KrbCred
    KrbTgsReq(
            KDCOptions options,
            Credentials asCreds,
            PrincipalName sname,
            KerberosTime from,
            KerberosTime till,
            KerberosTime rtime,
            int[] eTypes,
            HostAddresses addresses,
            AuthorizationData authorizationData,
            Ticket[] additionalTickets,
            EncryptionKey subKey) throws KrbException, IOException {
<span class="fc" id="L128">        this(options, asCreds, asCreds.getClient(), sname,</span>
                from, till, rtime, eTypes, addresses,
                authorizationData, additionalTickets, subKey, null);
<span class="fc" id="L131">    }</span>

    private KrbTgsReq(
            KDCOptions options,
            Credentials asCreds,
            PrincipalName cname,
            PrincipalName sname,
            KerberosTime from,
            KerberosTime till,
            KerberosTime rtime,
            int[] eTypes,
            HostAddresses addresses,
            AuthorizationData authorizationData,
            Ticket[] additionalTickets,
            EncryptionKey subKey,
<span class="fc" id="L146">            PAData extraPA) throws KrbException, IOException {</span>

<span class="fc" id="L148">        princName = cname;</span>
<span class="fc" id="L149">        servName = sname;</span>
<span class="fc" id="L150">        ctime = KerberosTime.now();</span>

        // check if they are valid arguments. The optional fields
        // should be  consistent with settings in KDCOptions.

        // TODO: Is this necessary? If the TGT is not FORWARDABLE,
        // you can still request for a FORWARDABLE ticket, just the
        // KDC will give you a non-FORWARDABLE one. Even if you
        // cannot use the ticket expected, it still contains info.
        // This means there will be problem later. We already have
        // flags check in KrbTgsRep. Of course, sometimes the KDC
        // will not issue the ticket at all.

<span class="fc bfc" id="L163" title="All 2 branches covered.">        if (options.get(KDCOptions.FORWARDABLE) &amp;&amp;</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                (!(asCreds.flags.get(Krb5.TKT_OPTS_FORWARDABLE)))) {</span>
<span class="nc" id="L165">            throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);</span>
        }
<span class="fc bfc" id="L167" title="All 2 branches covered.">        if (options.get(KDCOptions.FORWARDED)) {</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">            if (!(asCreds.flags.get(KDCOptions.FORWARDABLE)))</span>
<span class="nc" id="L169">                throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);</span>
        }
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        if (options.get(KDCOptions.PROXIABLE) &amp;&amp;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                (!(asCreds.flags.get(Krb5.TKT_OPTS_PROXIABLE)))) {</span>
<span class="nc" id="L173">            throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);</span>
        }
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (options.get(KDCOptions.PROXY)) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (!(asCreds.flags.get(KDCOptions.PROXIABLE)))</span>
<span class="nc" id="L177">                throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);</span>
        }
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (options.get(KDCOptions.ALLOW_POSTDATE) &amp;&amp;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                (!(asCreds.flags.get(Krb5.TKT_OPTS_MAY_POSTDATE)))) {</span>
<span class="nc" id="L181">            throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);</span>
        }
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (options.get(KDCOptions.RENEWABLE) &amp;&amp;</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                (!(asCreds.flags.get(Krb5.TKT_OPTS_RENEWABLE)))) {</span>
<span class="nc" id="L185">            throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);</span>
        }

<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if (options.get(KDCOptions.POSTDATED)) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (!(asCreds.flags.get(KDCOptions.POSTDATED)))</span>
<span class="nc" id="L190">                throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);</span>
        } else {
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            if (from != null)  from = null;</span>
        }
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if (options.get(KDCOptions.RENEWABLE)) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (!(asCreds.flags.get(KDCOptions.RENEWABLE)))</span>
<span class="nc" id="L196">                throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);</span>
        } else {
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">            if (rtime != null)  rtime = null;</span>
        }
<span class="pc bpc" id="L200" title="2 of 4 branches missed.">        if (options.get(KDCOptions.ENC_TKT_IN_SKEY) || options.get(KDCOptions.CNAME_IN_ADDL_TKT)) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (additionalTickets == null)</span>
<span class="nc" id="L202">                throw new KrbException(Krb5.KRB_AP_ERR_REQ_OPTIONS);</span>
            // in TGS_REQ there could be more than one additional
            // tickets,  but in file-based credential cache,
            // there is only one additional ticket field.
<span class="nc" id="L206">            secondTicket = additionalTickets[0];</span>
        } else {
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">            if (additionalTickets != null)</span>
<span class="nc" id="L209">                additionalTickets = null;</span>
        }

<span class="fc" id="L212">        tgsReqMessg = createRequest(</span>
                options,
                asCreds.ticket,
                asCreds.key,
                ctime,
                princName,
                servName,
                from,
                till,
                rtime,
                eTypes,
                addresses,
                authorizationData,
                additionalTickets,
                subKey,
                extraPA);
<span class="fc" id="L228">        obuf = tgsReqMessg.asn1Encode();</span>

        // XXX We need to revisit this to see if can't move it
        // up such that FORWARDED flag set in the options
        // is included in the marshaled request.
        /*
         * If this is based on a forwarded ticket, record that in the
         * options, because the returned TgsRep will contain the
         * FORWARDED flag set.
         */
<span class="fc bfc" id="L238" title="All 2 branches covered.">        if (asCreds.flags.get(KDCOptions.FORWARDED))</span>
<span class="fc" id="L239">            options.set(KDCOptions.FORWARDED, true);</span>


<span class="fc" id="L242">    }</span>

    /**
     * Sends a TGS request to the realm of the target.
     * @throws KrbException
     * @throws IOException
     */
    public void send() throws IOException, KrbException {
<span class="fc" id="L250">        String realmStr = null;</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">        if (servName != null)</span>
<span class="fc" id="L252">            realmStr = servName.getRealmString();</span>
<span class="fc" id="L253">        KdcComm comm = new KdcComm(realmStr);</span>
<span class="fc" id="L254">        ibuf = comm.send(obuf);</span>
<span class="fc" id="L255">    }</span>

    public KrbTgsRep getReply()
        throws KrbException, IOException {
<span class="fc" id="L259">        return new KrbTgsRep(ibuf, this);</span>
    }

    /**
     * Sends the request, waits for a reply, and returns the Credentials.
     * Used in Credentials, KrbCred, and internal/CredentialsUtil.
     */
    public Credentials sendAndGetCreds() throws IOException, KrbException {
<span class="fc" id="L267">        KrbTgsRep tgs_rep = null;</span>
<span class="fc" id="L268">        String kdc = null;</span>
<span class="fc" id="L269">        send();</span>
<span class="fc" id="L270">        tgs_rep = getReply();</span>
<span class="fc" id="L271">        return tgs_rep.getCreds();</span>
    }

    KerberosTime getCtime() {
<span class="nc" id="L275">        return ctime;</span>
    }

    private TGSReq createRequest(
                         KDCOptions kdc_options,
                         Ticket ticket,
                         EncryptionKey key,
                         KerberosTime ctime,
                         PrincipalName cname,
                         PrincipalName sname,
                         KerberosTime from,
                         KerberosTime till,
                         KerberosTime rtime,
                         int[] eTypes,
                         HostAddresses addresses,
                         AuthorizationData authorizationData,
                         Ticket[] additionalTickets,
                         EncryptionKey subKey,
                         PAData extraPA)
        throws IOException, KrbException, UnknownHostException {
<span class="fc" id="L295">        KerberosTime req_till = null;</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">        if (till == null) {</span>
<span class="fc" id="L297">            req_till = new KerberosTime(0);</span>
        } else {
<span class="nc" id="L299">            req_till = till;</span>
        }

        /*
         * RFC 4120, Section 5.4.2.
         * For KRB_TGS_REP, the ciphertext is encrypted in the
         * sub-session key from the Authenticator, or if absent,
         * the session key from the ticket-granting ticket used
         * in the request.
         *
         * To support this, use tgsReqKey to remember which key to use.
         */
<span class="fc" id="L311">        tgsReqKey = key;</span>

<span class="fc" id="L313">        int[] req_eTypes = null;</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">        if (eTypes == null) {</span>
<span class="fc" id="L315">            req_eTypes = EType.getDefaults(&quot;default_tgs_enctypes&quot;);</span>
        } else {
<span class="nc" id="L317">            req_eTypes = eTypes;</span>
        }

<span class="fc" id="L320">        EncryptionKey reqKey = null;</span>
<span class="fc" id="L321">        EncryptedData encAuthorizationData = null;</span>
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">        if (authorizationData != null) {</span>
<span class="nc" id="L323">            byte[] ad = authorizationData.asn1Encode();</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (subKey != null) {</span>
<span class="nc" id="L325">                reqKey = subKey;</span>
<span class="nc" id="L326">                tgsReqKey = subKey;    // Key to use to decrypt reply</span>
<span class="nc" id="L327">                useSubkey = true;</span>
<span class="nc" id="L328">                encAuthorizationData = new EncryptedData(reqKey, ad,</span>
                    KeyUsage.KU_TGS_REQ_AUTH_DATA_SUBKEY);
            } else
<span class="nc" id="L331">                encAuthorizationData = new EncryptedData(key, ad,</span>
                    KeyUsage.KU_TGS_REQ_AUTH_DATA_SESSKEY);
        }

<span class="fc" id="L335">        KDCReqBody reqBody = new KDCReqBody(</span>
                                            kdc_options,
                                            cname,
                                            sname,
                                            from,
                                            req_till,
                                            rtime,
<span class="fc" id="L342">                                            Nonce.value(),</span>
                                            req_eTypes,
                                            addresses,
                                            encAuthorizationData,
                                            additionalTickets);

<span class="fc" id="L348">        byte[] temp = reqBody.asn1Encode(Krb5.KRB_TGS_REQ);</span>
        // if the checksum type is one of the keyed checksum types,
        // use session key.
        Checksum cksum;
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">        switch (Checksum.CKSUMTYPE_DEFAULT) {</span>
        case Checksum.CKSUMTYPE_RSA_MD4_DES:
        case Checksum.CKSUMTYPE_DES_MAC:
        case Checksum.CKSUMTYPE_DES_MAC_K:
        case Checksum.CKSUMTYPE_RSA_MD4_DES_K:
        case Checksum.CKSUMTYPE_RSA_MD5_DES:
        case Checksum.CKSUMTYPE_HMAC_SHA1_DES3_KD:
        case Checksum.CKSUMTYPE_HMAC_MD5_ARCFOUR:
        case Checksum.CKSUMTYPE_HMAC_SHA1_96_AES128:
        case Checksum.CKSUMTYPE_HMAC_SHA1_96_AES256:
<span class="nc" id="L362">            cksum = new Checksum(Checksum.CKSUMTYPE_DEFAULT, temp, key,</span>
                KeyUsage.KU_PA_TGS_REQ_CKSUM);
<span class="nc" id="L364">            break;</span>
        case Checksum.CKSUMTYPE_CRC32:
        case Checksum.CKSUMTYPE_RSA_MD4:
        case Checksum.CKSUMTYPE_RSA_MD5:
        default:
<span class="fc" id="L369">            cksum = new Checksum(Checksum.CKSUMTYPE_DEFAULT, temp);</span>
        }

        // Usage will be KeyUsage.KU_PA_TGS_REQ_AUTHENTICATOR

<span class="fc" id="L374">        byte[] tgs_ap_req = new KrbApReq(</span>
                                         new APOptions(),
                                         ticket,
                                         key,
                                         cname,
                                         cksum,
                                         ctime,
                                         reqKey,
                                         null,
<span class="fc" id="L383">                                         null).getMessage();</span>

<span class="fc" id="L385">        PAData tgsPAData = new PAData(Krb5.PA_TGS_REQ, tgs_ap_req);</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">        return new TGSReq(</span>
                extraPA != null ?
                    new PAData[] {extraPA, tgsPAData } :
                    new PAData[] {tgsPAData},
                reqBody);
    }

    TGSReq getMessage() {
<span class="fc" id="L394">        return tgsReqMessg;</span>
    }

    Ticket getSecondTicket() {
<span class="fc" id="L398">        return secondTicket;</span>
    }

    private static void debug(String message) {
        //      System.err.println(&quot;&gt;&gt;&gt; KrbTgsReq: &quot; + message);
<span class="nc" id="L403">    }</span>

    boolean usedSubkey() {
<span class="fc" id="L406">        return useSubkey;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>