<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PerInterface.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.jmx.mbeanserver</a> &gt; <span class="el_source">PerInterface.java</span></div><h1>PerInterface.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, 2006, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.jmx.mbeanserver;

import java.security.AccessController;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import javax.management.AttributeNotFoundException;
import javax.management.InvalidAttributeValueException;
import javax.management.MBeanException;
import javax.management.MBeanInfo;
import javax.management.ReflectionException;

import static com.sun.jmx.mbeanserver.Util.*;

/**
 * Per-MBean-interface behavior.  A single instance of this class can be shared
 * by all MBeans of the same kind (Standard MBean or MXBean) that have the same
 * MBean interface.
 *
 * @since 1.6
 */
final class PerInterface&lt;M&gt; {
    PerInterface(Class&lt;?&gt; mbeanInterface, MBeanIntrospector&lt;M&gt; introspector,
<span class="nc" id="L50">                 MBeanAnalyzer&lt;M&gt; analyzer, MBeanInfo mbeanInfo) {</span>
<span class="nc" id="L51">        this.mbeanInterface = mbeanInterface;</span>
<span class="nc" id="L52">        this.introspector = introspector;</span>
<span class="nc" id="L53">        this.mbeanInfo = mbeanInfo;</span>
<span class="nc" id="L54">        analyzer.visit(new InitMaps());</span>
<span class="nc" id="L55">    }</span>

    Class&lt;?&gt; getMBeanInterface() {
<span class="nc" id="L58">        return mbeanInterface;</span>
    }

    MBeanInfo getMBeanInfo() {
<span class="nc" id="L62">        return mbeanInfo;</span>
    }

    boolean isMXBean() {
<span class="nc" id="L66">        return introspector.isMXBean();</span>
    }

    Object getAttribute(Object resource, String attribute, Object cookie)
            throws AttributeNotFoundException,
                   MBeanException,
                   ReflectionException {

<span class="nc" id="L74">        final M cm = getters.get(attribute);</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (cm == null) {</span>
            final String msg;
<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (setters.containsKey(attribute))</span>
<span class="nc" id="L78">                msg = &quot;Write-only attribute: &quot; + attribute;</span>
            else
<span class="nc" id="L80">                msg = &quot;No such attribute: &quot; + attribute;</span>
<span class="nc" id="L81">            throw new AttributeNotFoundException(msg);</span>
        }
<span class="nc" id="L83">        return introspector.invokeM(cm, resource, (Object[]) null, cookie);</span>
    }

    void setAttribute(Object resource, String attribute, Object value,
                      Object cookie)
            throws AttributeNotFoundException,
                   InvalidAttributeValueException,
                   MBeanException,
                   ReflectionException {

<span class="nc" id="L93">        final M cm = setters.get(attribute);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (cm == null) {</span>
            final String msg;
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (getters.containsKey(attribute))</span>
<span class="nc" id="L97">                msg = &quot;Read-only attribute: &quot; + attribute;</span>
            else
<span class="nc" id="L99">                msg = &quot;No such attribute: &quot; + attribute;</span>
<span class="nc" id="L100">            throw new AttributeNotFoundException(msg);</span>
        }
<span class="nc" id="L102">        introspector.invokeSetter(attribute, cm, resource, value, cookie);</span>
<span class="nc" id="L103">    }</span>

    Object invoke(Object resource, String operation, Object[] params,
                  String[] signature, Object cookie)
            throws MBeanException, ReflectionException {

<span class="nc" id="L109">        final List&lt;MethodAndSig&gt; list = ops.get(operation);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (list == null) {</span>
<span class="nc" id="L111">            final String msg = &quot;No such operation: &quot; + operation;</span>
<span class="nc" id="L112">            return noSuchMethod(msg, resource, operation, params, signature,</span>
                                cookie);
        }
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (signature == null)</span>
<span class="nc" id="L116">            signature = new String[0];</span>
<span class="nc" id="L117">        MethodAndSig found = null;</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        for (MethodAndSig mas : list) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (Arrays.equals(mas.signature, signature)) {</span>
<span class="nc" id="L120">                found = mas;</span>
<span class="nc" id="L121">                break;</span>
            }
<span class="nc" id="L123">        }</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (found == null) {</span>
<span class="nc" id="L125">            final String badSig = sigString(signature);</span>
            final String msg;
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (list.size() == 1) {  // helpful exception message</span>
<span class="nc" id="L128">                msg = &quot;Signature mismatch for operation &quot; + operation +</span>
                        &quot;: &quot; + badSig + &quot; should be &quot; +
<span class="nc" id="L130">                        sigString(list.get(0).signature);</span>
            } else {
<span class="nc" id="L132">                msg = &quot;Operation &quot; + operation + &quot; exists but not with &quot; +</span>
                        &quot;this signature: &quot; + badSig;
            }
<span class="nc" id="L135">            return noSuchMethod(msg, resource, operation, params, signature,</span>
                                cookie);
        }
<span class="nc" id="L138">        return introspector.invokeM(found.method, resource, params, cookie);</span>
    }

    /*
     * This method is called when invoke doesn't find the named method.
     * Before throwing an exception, we check to see whether the
     * jmx.invoke.getters property is set, and if so whether the method
     * being invoked might be a getter or a setter.  If so we invoke it
     * and return the result.  This is for compatibility
     * with code based on JMX RI 1.0 or 1.1 which allowed invoking getters
     * and setters.  It is *not* recommended that new code use this feature.
     *
     * Since this method is either going to throw an exception or use
     * functionality that is strongly discouraged, we consider that its
     * performance is not very important.
     *
     * A simpler way to implement the functionality would be to add the getters
     * and setters to the operations map when jmx.invoke.getters is set.
     * However, that means that the property is consulted when an MBean
     * interface is being introspected and not thereafter.  Previously,
     * the property was consulted on every invocation.  So this simpler
     * implementation could potentially break code that sets and unsets
     * the property at different times.
     */
    private Object noSuchMethod(String msg, Object resource, String operation,
                                Object[] params, String[] signature,
                                Object cookie)
            throws MBeanException, ReflectionException {

        // Construct the exception that we will probably throw
<span class="nc" id="L168">        final NoSuchMethodException nsme =</span>
<span class="nc" id="L169">            new NoSuchMethodException(operation + sigString(signature));</span>
<span class="nc" id="L170">        final ReflectionException exception =</span>
            new ReflectionException(nsme, msg);

<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (introspector.isMXBean())</span>
<span class="nc" id="L174">            throw exception; // No compatibility requirement here</span>

        // Is the compatibility property set?
<span class="nc" id="L177">        GetPropertyAction act = new GetPropertyAction(&quot;jmx.invoke.getters&quot;);</span>
        String invokeGettersS;
        try {
<span class="nc" id="L180">            invokeGettersS = AccessController.doPrivileged(act);</span>
<span class="nc" id="L181">        } catch (Exception e) {</span>
            // We don't expect an exception here but if we get one then
            // we'll simply assume that the property is not set.
<span class="nc" id="L184">            invokeGettersS = null;</span>
<span class="nc" id="L185">        }</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (invokeGettersS == null)</span>
<span class="nc" id="L187">            throw exception;</span>

<span class="nc" id="L189">        int rest = 0;</span>
<span class="nc" id="L190">        Map&lt;String, M&gt; methods = null;</span>
<span class="nc bnc" id="L191" title="All 4 branches missed.">        if (signature == null || signature.length == 0) {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (operation.startsWith(&quot;get&quot;))</span>
<span class="nc" id="L193">                rest = 3;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            else if (operation.startsWith(&quot;is&quot;))</span>
<span class="nc" id="L195">                rest = 2;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">            if (rest != 0)</span>
<span class="nc" id="L197">                methods = getters;</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        } else if (signature.length == 1 &amp;&amp;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                   operation.startsWith(&quot;set&quot;)) {</span>
<span class="nc" id="L200">            rest = 3;</span>
<span class="nc" id="L201">            methods = setters;</span>
        }

<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (rest != 0) {</span>
<span class="nc" id="L205">            String attrName = operation.substring(rest);</span>
<span class="nc" id="L206">            M method = methods.get(attrName);</span>
<span class="nc bnc" id="L207" title="All 4 branches missed.">            if (method != null &amp;&amp; introspector.getName(method).equals(operation)) {</span>
<span class="nc" id="L208">                String[] msig = introspector.getSignature(method);</span>
<span class="nc bnc" id="L209" title="All 4 branches missed.">                if ((signature == null &amp;&amp; msig.length == 0) ||</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                        Arrays.equals(signature, msig)) {</span>
<span class="nc" id="L211">                    return introspector.invokeM(method, resource, params, cookie);</span>
                }
            }
        }

<span class="nc" id="L216">        throw exception;</span>
    }

    private String sigString(String[] signature) {
<span class="nc" id="L220">        StringBuilder b = new StringBuilder(&quot;(&quot;);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (signature != null) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            for (String s : signature) {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                if (b.length() &gt; 1)</span>
<span class="nc" id="L224">                    b.append(&quot;, &quot;);</span>
<span class="nc" id="L225">                b.append(s);</span>
            }
        }
<span class="nc" id="L228">        return b.append(&quot;)&quot;).toString();</span>
    }

    /**
     * Visitor that sets up the method maps (operations, getters, setters).
     */
<span class="nc bnc" id="L234" title="All 2 branches missed.">    private class InitMaps implements MBeanAnalyzer.MBeanVisitor&lt;M&gt; {</span>
        public void visitAttribute(String attributeName,
                                   M getter,
                                   M setter) {
<span class="nc bnc" id="L238" title="All 2 branches missed.">            if (getter != null) {</span>
<span class="nc" id="L239">                introspector.checkMethod(getter);</span>
<span class="nc" id="L240">                final Object old = getters.put(attributeName, getter);</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">                assert(old == null);</span>
            }
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (setter != null) {</span>
<span class="nc" id="L244">                introspector.checkMethod(setter);</span>
<span class="nc" id="L245">                final Object old = setters.put(attributeName, setter);</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">                assert(old == null);</span>
            }
<span class="nc" id="L248">        }</span>

        public void visitOperation(String operationName,
                                   M operation) {
<span class="nc" id="L252">            introspector.checkMethod(operation);</span>
<span class="nc" id="L253">            final String[] sig = introspector.getSignature(operation);</span>
<span class="nc" id="L254">            final MethodAndSig mas = new MethodAndSig();</span>
<span class="nc" id="L255">            mas.method = operation;</span>
<span class="nc" id="L256">            mas.signature = sig;</span>
<span class="nc" id="L257">            List&lt;MethodAndSig&gt; list = ops.get(operationName);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (list == null)</span>
<span class="nc" id="L259">                list = Collections.singletonList(mas);</span>
            else {
<span class="nc bnc" id="L261" title="All 2 branches missed.">                if (list.size() == 1)</span>
<span class="nc" id="L262">                    list = newList(list);</span>
<span class="nc" id="L263">                list.add(mas);</span>
            }
<span class="nc" id="L265">            ops.put(operationName, list);</span>
<span class="nc" id="L266">        }</span>
    }

<span class="nc" id="L269">    private class MethodAndSig {</span>
        M method;
        String[] signature;
    }

    private final Class&lt;?&gt; mbeanInterface;
    private final MBeanIntrospector&lt;M&gt; introspector;
    private final MBeanInfo mbeanInfo;
<span class="nc" id="L277">    private final Map&lt;String, M&gt; getters = newMap();</span>
<span class="nc" id="L278">    private final Map&lt;String, M&gt; setters = newMap();</span>
<span class="nc" id="L279">    private final Map&lt;String, List&lt;MethodAndSig&gt;&gt; ops = newMap();</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>