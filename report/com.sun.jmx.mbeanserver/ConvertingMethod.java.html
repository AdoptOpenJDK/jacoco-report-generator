<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ConvertingMethod.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.jmx.mbeanserver</a> &gt; <span class="el_source">ConvertingMethod.java</span></div><h1>ConvertingMethod.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.jmx.mbeanserver;
import java.io.InvalidObjectException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.lang.reflect.Type;

import javax.management.Descriptor;
import javax.management.MBeanException;
import javax.management.openmbean.OpenDataException;
import javax.management.openmbean.OpenType;
import sun.reflect.misc.MethodUtil;

final class ConvertingMethod {
    static ConvertingMethod from(Method m) {
        try {
<span class="nc" id="L41">            return new ConvertingMethod(m);</span>
<span class="nc" id="L42">        } catch (OpenDataException ode) {</span>
<span class="nc" id="L43">            final String msg = &quot;Method &quot; + m.getDeclaringClass().getName() +</span>
<span class="nc" id="L44">                &quot;.&quot; + m.getName() + &quot; has parameter or return type that &quot; +</span>
                &quot;cannot be translated into an open type&quot;;
<span class="nc" id="L46">            throw new IllegalArgumentException(msg, ode);</span>
        }
    }

    Method getMethod() {
<span class="nc" id="L51">        return method;</span>
    }

    Descriptor getDescriptor() {
<span class="nc" id="L55">        return Introspector.descriptorForElement(method);</span>
    }

    Type getGenericReturnType() {
<span class="nc" id="L59">        return method.getGenericReturnType();</span>
    }

    Type[] getGenericParameterTypes() {
<span class="nc" id="L63">        return method.getGenericParameterTypes();</span>
    }

    String getName() {
<span class="nc" id="L67">        return method.getName();</span>
    }

    OpenType&lt;?&gt; getOpenReturnType() {
<span class="nc" id="L71">        return returnMapping.getOpenType();</span>
    }

    OpenType&lt;?&gt;[] getOpenParameterTypes() {
<span class="nc" id="L75">        final OpenType&lt;?&gt;[] types = new OpenType&lt;?&gt;[paramMappings.length];</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        for (int i = 0; i &lt; paramMappings.length; i++)</span>
<span class="nc" id="L77">            types[i] = paramMappings[i].getOpenType();</span>
<span class="nc" id="L78">        return types;</span>
    }

    /* Check that this method will be callable when we are going from
     * open types to Java types, for example when we are going from
     * an MXBean wrapper to the underlying resource.
     * The parameters will be converted to
     * Java types, so they must be &quot;reconstructible&quot;.  The return
     * value will be converted to an Open Type, so if it is convertible
     * at all there is no further check needed.
     */
    void checkCallFromOpen() {
        try {
<span class="nc bnc" id="L91" title="All 2 branches missed.">            for (MXBeanMapping paramConverter : paramMappings)</span>
<span class="nc" id="L92">                paramConverter.checkReconstructible();</span>
<span class="nc" id="L93">        } catch (InvalidObjectException e) {</span>
<span class="nc" id="L94">            throw new IllegalArgumentException(e);</span>
<span class="nc" id="L95">        }</span>
<span class="nc" id="L96">    }</span>

    /* Check that this method will be callable when we are going from
     * Java types to open types, for example when we are going from
     * an MXBean proxy to the open types that it will be mapped to.
     * The return type will be converted back to a Java type, so it
     * must be &quot;reconstructible&quot;.  The parameters will be converted to
     * open types, so if it is convertible at all there is no further
     * check needed.
     */
    void checkCallToOpen() {
        try {
<span class="nc" id="L108">            returnMapping.checkReconstructible();</span>
<span class="nc" id="L109">        } catch (InvalidObjectException e) {</span>
<span class="nc" id="L110">            throw new IllegalArgumentException(e);</span>
<span class="nc" id="L111">        }</span>
<span class="nc" id="L112">    }</span>

    String[] getOpenSignature() {
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (paramMappings.length == 0)</span>
<span class="nc" id="L116">            return noStrings;</span>

<span class="nc" id="L118">        String[] sig = new String[paramMappings.length];</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        for (int i = 0; i &lt; paramMappings.length; i++)</span>
<span class="nc" id="L120">            sig[i] = paramMappings[i].getOpenClass().getName();</span>
<span class="nc" id="L121">        return sig;</span>
    }

    final Object toOpenReturnValue(MXBeanLookup lookup, Object ret)
            throws OpenDataException {
<span class="nc" id="L126">        return returnMapping.toOpenValue(ret);</span>
    }

    final Object fromOpenReturnValue(MXBeanLookup lookup, Object ret)
            throws InvalidObjectException {
<span class="nc" id="L131">        return returnMapping.fromOpenValue(ret);</span>
    }

    final Object[] toOpenParameters(MXBeanLookup lookup, Object[] params)
            throws OpenDataException {
<span class="nc bnc" id="L136" title="All 4 branches missed.">        if (paramConversionIsIdentity || params == null)</span>
<span class="nc" id="L137">            return params;</span>
<span class="nc" id="L138">        final Object[] oparams = new Object[params.length];</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        for (int i = 0; i &lt; params.length; i++)</span>
<span class="nc" id="L140">            oparams[i] = paramMappings[i].toOpenValue(params[i]);</span>
<span class="nc" id="L141">        return oparams;</span>
    }

    final Object[] fromOpenParameters(Object[] params)
            throws InvalidObjectException {
<span class="nc bnc" id="L146" title="All 4 branches missed.">        if (paramConversionIsIdentity || params == null)</span>
<span class="nc" id="L147">            return params;</span>
<span class="nc" id="L148">        final Object[] jparams = new Object[params.length];</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        for (int i = 0; i &lt; params.length; i++)</span>
<span class="nc" id="L150">            jparams[i] = paramMappings[i].fromOpenValue(params[i]);</span>
<span class="nc" id="L151">        return jparams;</span>
    }

    final Object toOpenParameter(MXBeanLookup lookup,
                                 Object param,
                                 int paramNo)
        throws OpenDataException {
<span class="nc" id="L158">        return paramMappings[paramNo].toOpenValue(param);</span>
    }

    final Object fromOpenParameter(MXBeanLookup lookup,
                                   Object param,
                                   int paramNo)
        throws InvalidObjectException {
<span class="nc" id="L165">        return paramMappings[paramNo].fromOpenValue(param);</span>
    }

    Object invokeWithOpenReturn(MXBeanLookup lookup,
                                Object obj, Object[] params)
            throws MBeanException, IllegalAccessException,
                   InvocationTargetException {
<span class="nc" id="L172">        MXBeanLookup old = MXBeanLookup.getLookup();</span>
        try {
<span class="nc" id="L174">            MXBeanLookup.setLookup(lookup);</span>
<span class="nc" id="L175">            return invokeWithOpenReturn(obj, params);</span>
        } finally {
<span class="nc" id="L177">            MXBeanLookup.setLookup(old);</span>
        }
    }

    private Object invokeWithOpenReturn(Object obj, Object[] params)
            throws MBeanException, IllegalAccessException,
                   InvocationTargetException {
        final Object[] javaParams;
        try {
<span class="nc" id="L186">            javaParams = fromOpenParameters(params);</span>
<span class="nc" id="L187">        } catch (InvalidObjectException e) {</span>
            // probably can't happen
<span class="nc" id="L189">            final String msg = methodName() + &quot;: cannot convert parameters &quot; +</span>
                &quot;from open values: &quot; + e;
<span class="nc" id="L191">            throw new MBeanException(e, msg);</span>
<span class="nc" id="L192">        }</span>
<span class="nc" id="L193">        final Object javaReturn = MethodUtil.invoke(method, obj, javaParams);</span>
        try {
<span class="nc" id="L195">            return returnMapping.toOpenValue(javaReturn);</span>
<span class="nc" id="L196">        } catch (OpenDataException e) {</span>
            // probably can't happen
<span class="nc" id="L198">            final String msg = methodName() + &quot;: cannot convert return &quot; +</span>
                &quot;value to open value: &quot; + e;
<span class="nc" id="L200">            throw new MBeanException(e, msg);</span>
        }
    }

    private String methodName() {
<span class="nc" id="L205">        return method.getDeclaringClass() + &quot;.&quot; + method.getName();</span>
    }

<span class="nc" id="L208">    private ConvertingMethod(Method m) throws OpenDataException {</span>
<span class="nc" id="L209">        this.method = m;</span>
<span class="nc" id="L210">        MXBeanMappingFactory mappingFactory = MXBeanMappingFactory.DEFAULT;</span>
<span class="nc" id="L211">        returnMapping =</span>
<span class="nc" id="L212">                mappingFactory.mappingForType(m.getGenericReturnType(), mappingFactory);</span>
<span class="nc" id="L213">        Type[] params = m.getGenericParameterTypes();</span>
<span class="nc" id="L214">        paramMappings = new MXBeanMapping[params.length];</span>
<span class="nc" id="L215">        boolean identity = true;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        for (int i = 0; i &lt; params.length; i++) {</span>
<span class="nc" id="L217">            paramMappings[i] = mappingFactory.mappingForType(params[i], mappingFactory);</span>
<span class="nc" id="L218">            identity &amp;= DefaultMXBeanMappingFactory.isIdentity(paramMappings[i]);</span>
        }
<span class="nc" id="L220">        paramConversionIsIdentity = identity;</span>
<span class="nc" id="L221">    }</span>

<span class="nc" id="L223">    private static final String[] noStrings = new String[0];</span>

    private final Method method;
    private final MXBeanMapping returnMapping;
    private final MXBeanMapping[] paramMappings;
    private final boolean paramConversionIsIdentity;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>