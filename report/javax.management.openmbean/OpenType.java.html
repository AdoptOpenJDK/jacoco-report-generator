<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OpenType.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">javax.management.openmbean</a> &gt; <span class="el_source">OpenType.java</span></div><h1>OpenType.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2000, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.management.openmbean;

import com.sun.jmx.mbeanserver.GetPropertyAction;
import java.io.IOException;
import java.io.InvalidObjectException;
import java.io.ObjectInputStream;
import java.io.Serializable;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import javax.management.Descriptor;
import javax.management.ImmutableDescriptor;

/**
 * The &lt;code&gt;OpenType&lt;/code&gt; class is the parent abstract class of all classes which describe the actual &lt;i&gt;open type&lt;/i&gt;
 * of open data values.
 * &lt;p&gt;
 * An &lt;i&gt;open type&lt;/i&gt; is defined by:
 * &lt;ul&gt;
 *  &lt;li&gt;the fully qualified Java class name of the open data values this type describes;
 *      note that only a limited set of Java classes is allowed for open data values
 *      (see {@link #ALLOWED_CLASSNAMES_LIST ALLOWED_CLASSNAMES_LIST}),&lt;/li&gt;
 *  &lt;li&gt;its name,&lt;/li&gt;
 *  &lt;li&gt;its description.&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @param &lt;T&gt; the Java type that instances described by this type must
 * have.  For example, {@link SimpleType#INTEGER} is a {@code
 * SimpleType&lt;Integer&gt;} which is a subclass of {@code OpenType&lt;Integer&gt;},
 * meaning that an attribute, parameter, or return value that is described
 * as a {@code SimpleType.INTEGER} must have Java type
 * {@link Integer}.
 *
 * @since 1.5
 */
public abstract class OpenType&lt;T&gt; implements Serializable {

    /* Serial version */
    static final long serialVersionUID = -9195195325186646468L;


    /**
     * List of the fully qualified names of the Java classes allowed for open
     * data values. A multidimensional array of any one of these classes or
     * their corresponding primitive types is also an allowed class for open
     * data values.
     *
       &lt;pre&gt;ALLOWED_CLASSNAMES_LIST = {
        &quot;java.lang.Void&quot;,
        &quot;java.lang.Boolean&quot;,
        &quot;java.lang.Character&quot;,
        &quot;java.lang.Byte&quot;,
        &quot;java.lang.Short&quot;,
        &quot;java.lang.Integer&quot;,
        &quot;java.lang.Long&quot;,
        &quot;java.lang.Float&quot;,
        &quot;java.lang.Double&quot;,
        &quot;java.lang.String&quot;,
        &quot;java.math.BigDecimal&quot;,
        &quot;java.math.BigInteger&quot;,
        &quot;java.util.Date&quot;,
        &quot;javax.management.ObjectName&quot;,
        CompositeData.class.getName(),
        TabularData.class.getName() } ;
       &lt;/pre&gt;
     *
     */
<span class="nc" id="L95">    public static final List&lt;String&gt; ALLOWED_CLASSNAMES_LIST =</span>
<span class="nc" id="L96">      Collections.unmodifiableList(</span>
<span class="nc" id="L97">        Arrays.asList(</span>
          &quot;java.lang.Void&quot;,
          &quot;java.lang.Boolean&quot;,
          &quot;java.lang.Character&quot;,
          &quot;java.lang.Byte&quot;,
          &quot;java.lang.Short&quot;,
          &quot;java.lang.Integer&quot;,
          &quot;java.lang.Long&quot;,
          &quot;java.lang.Float&quot;,
          &quot;java.lang.Double&quot;,
          &quot;java.lang.String&quot;,
          &quot;java.math.BigDecimal&quot;,
          &quot;java.math.BigInteger&quot;,
          &quot;java.util.Date&quot;,
          &quot;javax.management.ObjectName&quot;,
<span class="nc" id="L112">          CompositeData.class.getName(),        // better refer to these two class names like this, rather than hardcoding a string,</span>
<span class="nc" id="L113">          TabularData.class.getName()) );       // in case the package of these classes should change (who knows...)</span>


    /**
     * @deprecated Use {@link #ALLOWED_CLASSNAMES_LIST ALLOWED_CLASSNAMES_LIST} instead.
     */
    @Deprecated
<span class="nc" id="L120">    public static final String[] ALLOWED_CLASSNAMES =</span>
<span class="nc" id="L121">        ALLOWED_CLASSNAMES_LIST.toArray(new String[0]);</span>


    /**
     * @serial The fully qualified Java class name of open data values this
     *         type describes.
     */
    private String className;

    /**
     * @serial The type description (should not be null or empty).
     */
    private String description;

    /**
     * @serial The name given to this type (should not be null or empty).
     */
    private String typeName;

    /**
     * Tells if this type describes an array (checked in constructor).
     */
<span class="nc" id="L143">    private transient boolean isArray = false;</span>

    /**
     * Cached Descriptor for this OpenType, constructed on demand.
     */
    private transient Descriptor descriptor;

    /* *** Constructor *** */

    /**
     * Constructs an &lt;code&gt;OpenType&lt;/code&gt; instance (actually a subclass instance as &lt;code&gt;OpenType&lt;/code&gt; is abstract),
     * checking for the validity of the given parameters.
     * The validity constraints are described below for each parameter.
     * &lt;br&gt;&amp;nbsp;
     * @param  className  The fully qualified Java class name of the open data values this open type describes.
     *                    The valid Java class names allowed for open data values are listed in
     *                    {@link #ALLOWED_CLASSNAMES_LIST ALLOWED_CLASSNAMES_LIST}.
     *                    A multidimensional array of any one of these classes
     *                    or their corresponding primitive types is also an allowed class,
     *                    in which case the class name follows the rules defined by the method
     *                    {@link Class#getName() getName()} of &lt;code&gt;java.lang.Class&lt;/code&gt;.
     *                    For example, a 3-dimensional array of Strings has for class name
     *                    &amp;quot;&lt;code&gt;[[[Ljava.lang.String;&lt;/code&gt;&amp;quot; (without the quotes).
     * &lt;br&gt;&amp;nbsp;
     * @param  typeName  The name given to the open type this instance represents; cannot be a null or empty string.
     * &lt;br&gt;&amp;nbsp;
     * @param  description  The human readable description of the open type this instance represents;
     *                      cannot be a null or empty string.
     * &lt;br&gt;&amp;nbsp;
     * @throws IllegalArgumentException  if &lt;var&gt;className&lt;/var&gt;, &lt;var&gt;typeName&lt;/var&gt; or &lt;var&gt;description&lt;/var&gt;
     *                                   is a null or empty string
     * &lt;br&gt;&amp;nbsp;
     * @throws OpenDataException  if &lt;var&gt;className&lt;/var&gt; is not one of the allowed Java class names for open data
     */
    protected OpenType(String  className,
                       String  typeName,
<span class="nc" id="L179">                       String  description) throws OpenDataException {</span>
<span class="nc" id="L180">        checkClassNameOverride();</span>
<span class="nc" id="L181">        this.typeName = valid(&quot;typeName&quot;, typeName);</span>
<span class="nc" id="L182">        this.description = valid(&quot;description&quot;, description);</span>
<span class="nc" id="L183">        this.className = validClassName(className);</span>
<span class="nc bnc" id="L184" title="All 4 branches missed.">        this.isArray = (this.className != null &amp;&amp; this.className.startsWith(&quot;[&quot;));</span>
<span class="nc" id="L185">    }</span>

    /* Package-private constructor for callers we trust to get it right. */
    OpenType(String className, String typeName, String description,
<span class="nc" id="L189">             boolean isArray) {</span>
<span class="nc" id="L190">        this.className   = valid(&quot;className&quot;,className);</span>
<span class="nc" id="L191">        this.typeName    = valid(&quot;typeName&quot;, typeName);</span>
<span class="nc" id="L192">        this.description = valid(&quot;description&quot;, description);</span>
<span class="nc" id="L193">        this.isArray     = isArray;</span>
<span class="nc" id="L194">    }</span>

    private void checkClassNameOverride() throws SecurityException {
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (this.getClass().getClassLoader() == null)</span>
<span class="nc" id="L198">            return;  // We trust bootstrap classes.</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (overridesGetClassName(this.getClass())) {</span>
<span class="nc" id="L200">            final GetPropertyAction getExtendOpenTypes =</span>
                new GetPropertyAction(&quot;jmx.extend.open.types&quot;);
<span class="nc bnc" id="L202" title="All 2 branches missed.">            if (AccessController.doPrivileged(getExtendOpenTypes) == null) {</span>
<span class="nc" id="L203">                throw new SecurityException(&quot;Cannot override getClassName() &quot; +</span>
                        &quot;unless -Djmx.extend.open.types&quot;);
            }
        }
<span class="nc" id="L207">    }</span>

    private static boolean overridesGetClassName(final Class&lt;?&gt; c) {
<span class="nc" id="L210">        return AccessController.doPrivileged(new PrivilegedAction&lt;Boolean&gt;() {</span>
            public Boolean run() {
                try {
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    return (c.getMethod(&quot;getClassName&quot;).getDeclaringClass() !=</span>
                            OpenType.class);
<span class="nc" id="L215">                } catch (Exception e) {</span>
<span class="nc" id="L216">                    return true;  // fail safe</span>
                }
            }
        });
    }

    private static String validClassName(String className) throws OpenDataException {
<span class="nc" id="L223">        className   = valid(&quot;className&quot;, className);</span>

        // Check if className describes an array class, and determines its elements' class name.
        // (eg: a 3-dimensional array of Strings has for class name: &quot;[[[Ljava.lang.String;&quot;)
        //
<span class="nc" id="L228">        int n = 0;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">        while (className.startsWith(&quot;[&quot;, n)) {</span>
<span class="nc" id="L230">            n++;</span>
        }
        String eltClassName; // class name of array elements
<span class="nc" id="L233">        boolean isPrimitiveArray = false;</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (n &gt; 0) {</span>
<span class="nc bnc" id="L235" title="All 4 branches missed.">            if (className.startsWith(&quot;L&quot;, n) &amp;&amp; className.endsWith(&quot;;&quot;)) {</span>
                // removes the n leading '[' + the 'L' characters
                // and the last ';' character
<span class="nc" id="L238">                eltClassName = className.substring(n+1, className.length()-1);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">            } else if (n == className.length() - 1) {</span>
                // removes the n leading '[' characters
<span class="nc" id="L241">                eltClassName = className.substring(n, className.length());</span>
<span class="nc" id="L242">                isPrimitiveArray = true;</span>
            } else {
<span class="nc" id="L244">                throw new OpenDataException(&quot;Argument className=\&quot;&quot; + className +</span>
                        &quot;\&quot; is not a valid class name&quot;);
            }
        } else {
            // not an array
<span class="nc" id="L249">            eltClassName = className;</span>
        }

        // Check that eltClassName's value is one of the allowed basic data types for open data
        //
<span class="nc" id="L254">        boolean ok = false;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (isPrimitiveArray) {</span>
<span class="nc" id="L256">            ok = ArrayType.isPrimitiveContentType(eltClassName);</span>
        } else {
<span class="nc" id="L258">            ok = ALLOWED_CLASSNAMES_LIST.contains(eltClassName);</span>
        }
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if ( ! ok ) {</span>
<span class="nc" id="L261">            throw new OpenDataException(&quot;Argument className=\&quot;&quot;+ className +</span>
                                        &quot;\&quot; is not one of the allowed Java class names for open data.&quot;);
        }

<span class="nc" id="L265">        return className;</span>
    }

    /* Return argValue.trim() provided argValue is neither null nor empty;
       otherwise throw IllegalArgumentException.  */
    private static String valid(String argName, String argValue) {
<span class="nc bnc" id="L271" title="All 4 branches missed.">        if (argValue == null || (argValue = argValue.trim()).equals(&quot;&quot;))</span>
<span class="nc" id="L272">            throw new IllegalArgumentException(&quot;Argument &quot; + argName +</span>
                                               &quot; cannot be null or empty&quot;);
<span class="nc" id="L274">        return argValue;</span>
    }

    /* Package-private access to a Descriptor containing this OpenType. */
    synchronized Descriptor getDescriptor() {
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (descriptor == null) {</span>
<span class="nc" id="L280">            descriptor = new ImmutableDescriptor(new String[] {&quot;openType&quot;},</span>
                                                 new Object[] {this});
        }
<span class="nc" id="L283">        return descriptor;</span>
    }

    /* *** Open type information methods *** */

    /**
     * Returns the fully qualified Java class name of the open data values
     * this open type describes.
     * The only possible Java class names for open data values are listed in
     * {@link #ALLOWED_CLASSNAMES_LIST ALLOWED_CLASSNAMES_LIST}.
     * A multidimensional array of any one of these classes or their
     * corresponding primitive types is also an allowed class,
     * in which case the class name follows the rules defined by the method
     * {@link Class#getName() getName()} of &lt;code&gt;java.lang.Class&lt;/code&gt;.
     * For example, a 3-dimensional array of Strings has for class name
     * &amp;quot;&lt;code&gt;[[[Ljava.lang.String;&lt;/code&gt;&amp;quot; (without the quotes),
     * a 3-dimensional array of Integers has for class name
     * &amp;quot;&lt;code&gt;[[[Ljava.lang.Integer;&lt;/code&gt;&amp;quot; (without the quotes),
     * and a 3-dimensional array of int has for class name
     * &amp;quot;&lt;code&gt;[[[I&lt;/code&gt;&amp;quot; (without the quotes)
     *
     * @return the class name.
     */
    public String getClassName() {
<span class="nc" id="L307">        return className;</span>
    }

    // A version of getClassName() that can only be called from within this
    // package and that cannot be overridden.
    String safeGetClassName() {
<span class="nc" id="L313">        return className;</span>
    }

    /**
     * Returns the name of this &lt;code&gt;OpenType&lt;/code&gt; instance.
     *
     * @return the type name.
     */
    public String getTypeName() {

<span class="nc" id="L323">        return typeName;</span>
    }

    /**
     * Returns the text description of this &lt;code&gt;OpenType&lt;/code&gt; instance.
     *
     * @return the description.
     */
    public String getDescription() {

<span class="nc" id="L333">        return description;</span>
    }

    /**
     * Returns &lt;code&gt;true&lt;/code&gt; if the open data values this open
     * type describes are arrays, &lt;code&gt;false&lt;/code&gt; otherwise.
     *
     * @return true if this is an array type.
     */
    public boolean isArray() {

<span class="nc" id="L344">        return isArray;</span>
    }

    /**
     * Tests whether &lt;var&gt;obj&lt;/var&gt; is a value for this open type.
     *
     * @param obj the object to be tested for validity.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if &lt;var&gt;obj&lt;/var&gt; is a value for this
     * open type, &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public abstract boolean isValue(Object obj) ;

    /**
     * Tests whether values of the given type can be assigned to this open type.
     * The default implementation of this method returns true only if the
     * types are equal.
     *
     * @param ot the type to be tested.
     *
     * @return true if {@code ot} is assignable to this open type.
     */
    boolean isAssignableFrom(OpenType&lt;?&gt; ot) {
<span class="nc" id="L367">        return this.equals(ot);</span>
    }

    /* *** Methods overriden from class Object *** */

    /**
     * Compares the specified &lt;code&gt;obj&lt;/code&gt; parameter with this
     * open type instance for equality.
     *
     * @param obj the object to compare to.
     *
     * @return true if this object and &lt;code&gt;obj&lt;/code&gt; are equal.
     */
    public abstract boolean equals(Object obj) ;

    public abstract int hashCode() ;

    /**
     * Returns a string representation of this open type instance.
     *
     * @return the string representation.
     */
    public abstract String toString() ;

    /**
     * Deserializes an {@link OpenType} from an {@link java.io.ObjectInputStream}.
     */
    private void readObject(ObjectInputStream in)
            throws IOException, ClassNotFoundException {
<span class="nc" id="L396">        checkClassNameOverride();</span>
<span class="nc" id="L397">        ObjectInputStream.GetField fields = in.readFields();</span>
        final String classNameField;
        final String descriptionField;
        final String typeNameField;
        try {
<span class="nc" id="L402">            classNameField =</span>
<span class="nc" id="L403">                validClassName((String) fields.get(&quot;className&quot;, null));</span>
<span class="nc" id="L404">            descriptionField =</span>
<span class="nc" id="L405">                valid(&quot;description&quot;, (String) fields.get(&quot;description&quot;, null));</span>
<span class="nc" id="L406">            typeNameField =</span>
<span class="nc" id="L407">                valid(&quot;typeName&quot;, (String) fields.get(&quot;typeName&quot;, null));</span>
<span class="nc" id="L408">        } catch (Exception e) {</span>
<span class="nc" id="L409">            IOException e2 = new InvalidObjectException(e.getMessage());</span>
<span class="nc" id="L410">            e2.initCause(e);</span>
<span class="nc" id="L411">            throw e2;</span>
<span class="nc" id="L412">        }</span>
<span class="nc" id="L413">        className = classNameField;</span>
<span class="nc" id="L414">        description = descriptionField;</span>
<span class="nc" id="L415">        typeName = typeNameField;</span>
<span class="nc" id="L416">        isArray = (className.startsWith(&quot;[&quot;));</span>
<span class="nc" id="L417">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>