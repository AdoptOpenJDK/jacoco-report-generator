<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>BasicTableUI.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.plaf.basic</a> &gt; <span class="el_source">BasicTableUI.java</span></div><h1>BasicTableUI.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing.plaf.basic;

import java.awt.*;
import java.awt.datatransfer.*;
import java.awt.dnd.*;
import java.awt.event.*;
import java.util.Enumeration;
import java.util.EventObject;
import java.util.Hashtable;
import java.util.TooManyListenersException;
import javax.swing.*;
import javax.swing.event.*;
import javax.swing.plaf.*;
import javax.swing.text.*;
import javax.swing.table.*;
import javax.swing.plaf.basic.DragRecognitionSupport.BeforeDrag;
import sun.swing.SwingUtilities2;


import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;

import sun.swing.DefaultLookup;
import sun.swing.UIAction;

/**
 * BasicTableUI implementation
 *
 * @author Philip Milne
 * @author Shannon Hickey (drag and drop)
 */
<span class="nc" id="L57">public class BasicTableUI extends TableUI</span>
{
<span class="nc" id="L59">    private static final StringBuilder BASELINE_COMPONENT_KEY =</span>
        new StringBuilder(&quot;Table.baselineComponent&quot;);

//
// Instance Variables
//

    // The JTable that is delegating the painting to this UI.
    protected JTable table;
    protected CellRendererPane rendererPane;

    // Listeners that are attached to the JTable
    protected KeyListener keyListener;
    protected FocusListener focusListener;
    protected MouseInputListener mouseInputListener;

    private Handler handler;

    /**
     * Local cache of Table's client property &quot;Table.isFileList&quot;
     */
<span class="nc" id="L80">    private boolean isFileList = false;</span>

//
//  Helper class for keyboard actions
//

<span class="nc bnc" id="L86" title="All 2 branches missed.">    private static class Actions extends UIAction {</span>
        private static final String CANCEL_EDITING = &quot;cancel&quot;;
        private static final String SELECT_ALL = &quot;selectAll&quot;;
        private static final String CLEAR_SELECTION = &quot;clearSelection&quot;;
        private static final String START_EDITING = &quot;startEditing&quot;;

        private static final String NEXT_ROW = &quot;selectNextRow&quot;;
        private static final String NEXT_ROW_CELL = &quot;selectNextRowCell&quot;;
        private static final String NEXT_ROW_EXTEND_SELECTION =
                &quot;selectNextRowExtendSelection&quot;;
        private static final String NEXT_ROW_CHANGE_LEAD =
                &quot;selectNextRowChangeLead&quot;;
        private static final String PREVIOUS_ROW = &quot;selectPreviousRow&quot;;
        private static final String PREVIOUS_ROW_CELL = &quot;selectPreviousRowCell&quot;;
        private static final String PREVIOUS_ROW_EXTEND_SELECTION =
                &quot;selectPreviousRowExtendSelection&quot;;
        private static final String PREVIOUS_ROW_CHANGE_LEAD =
                &quot;selectPreviousRowChangeLead&quot;;

        private static final String NEXT_COLUMN = &quot;selectNextColumn&quot;;
        private static final String NEXT_COLUMN_CELL = &quot;selectNextColumnCell&quot;;
        private static final String NEXT_COLUMN_EXTEND_SELECTION =
                &quot;selectNextColumnExtendSelection&quot;;
        private static final String NEXT_COLUMN_CHANGE_LEAD =
                &quot;selectNextColumnChangeLead&quot;;
        private static final String PREVIOUS_COLUMN = &quot;selectPreviousColumn&quot;;
        private static final String PREVIOUS_COLUMN_CELL =
                &quot;selectPreviousColumnCell&quot;;
        private static final String PREVIOUS_COLUMN_EXTEND_SELECTION =
                &quot;selectPreviousColumnExtendSelection&quot;;
        private static final String PREVIOUS_COLUMN_CHANGE_LEAD =
                &quot;selectPreviousColumnChangeLead&quot;;

        private static final String SCROLL_LEFT_CHANGE_SELECTION =
                &quot;scrollLeftChangeSelection&quot;;
        private static final String SCROLL_LEFT_EXTEND_SELECTION =
                &quot;scrollLeftExtendSelection&quot;;
        private static final String SCROLL_RIGHT_CHANGE_SELECTION =
                &quot;scrollRightChangeSelection&quot;;
        private static final String SCROLL_RIGHT_EXTEND_SELECTION =
                &quot;scrollRightExtendSelection&quot;;

        private static final String SCROLL_UP_CHANGE_SELECTION =
                &quot;scrollUpChangeSelection&quot;;
        private static final String SCROLL_UP_EXTEND_SELECTION =
                &quot;scrollUpExtendSelection&quot;;
        private static final String SCROLL_DOWN_CHANGE_SELECTION =
                &quot;scrollDownChangeSelection&quot;;
        private static final String SCROLL_DOWN_EXTEND_SELECTION =
                &quot;scrollDownExtendSelection&quot;;

        private static final String FIRST_COLUMN =
                &quot;selectFirstColumn&quot;;
        private static final String FIRST_COLUMN_EXTEND_SELECTION =
                &quot;selectFirstColumnExtendSelection&quot;;
        private static final String LAST_COLUMN =
                &quot;selectLastColumn&quot;;
        private static final String LAST_COLUMN_EXTEND_SELECTION =
                &quot;selectLastColumnExtendSelection&quot;;

        private static final String FIRST_ROW =
                &quot;selectFirstRow&quot;;
        private static final String FIRST_ROW_EXTEND_SELECTION =
                &quot;selectFirstRowExtendSelection&quot;;
        private static final String LAST_ROW =
                &quot;selectLastRow&quot;;
        private static final String LAST_ROW_EXTEND_SELECTION =
                &quot;selectLastRowExtendSelection&quot;;

        // add the lead item to the selection without changing lead or anchor
        private static final String ADD_TO_SELECTION = &quot;addToSelection&quot;;

        // toggle the selected state of the lead item and move the anchor to it
        private static final String TOGGLE_AND_ANCHOR = &quot;toggleAndAnchor&quot;;

        // extend the selection to the lead item
        private static final String EXTEND_TO = &quot;extendTo&quot;;

        // move the anchor to the lead and ensure only that item is selected
        private static final String MOVE_SELECTION_TO = &quot;moveSelectionTo&quot;;

        // give focus to the JTableHeader, if one exists
        private static final String FOCUS_HEADER = &quot;focusHeader&quot;;

        protected int dx;
        protected int dy;
        protected boolean extend;
        protected boolean inSelection;

        // horizontally, forwards always means right,
        // regardless of component orientation
        protected boolean forwards;
        protected boolean vertically;
        protected boolean toLimit;

        protected int leadRow;
        protected int leadColumn;

        Actions(String name) {
<span class="nc" id="L185">            super(name);</span>
<span class="nc" id="L186">        }</span>

        Actions(String name, int dx, int dy, boolean extend,
                boolean inSelection) {
<span class="nc" id="L190">            super(name);</span>

            // Actions spcifying true for &quot;inSelection&quot; are
            // fairly sensitive to bad parameter values. They require
            // that one of dx and dy be 0 and the other be -1 or 1.
            // Bogus parameter values could cause an infinite loop.
            // To prevent any problems we massage the params here
            // and complain if we get something we can't deal with.
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (inSelection) {</span>
<span class="nc" id="L199">                this.inSelection = true;</span>

                // look at the sign of dx and dy only
<span class="nc" id="L202">                dx = sign(dx);</span>
<span class="nc" id="L203">                dy = sign(dy);</span>

                // make sure one is zero, but not both
<span class="nc bnc" id="L206" title="All 10 branches missed.">                assert (dx == 0 || dy == 0) &amp;&amp; !(dx == 0 &amp;&amp; dy == 0);</span>
            }

<span class="nc" id="L209">            this.dx = dx;</span>
<span class="nc" id="L210">            this.dy = dy;</span>
<span class="nc" id="L211">            this.extend = extend;</span>
<span class="nc" id="L212">        }</span>

        Actions(String name, boolean extend, boolean forwards,
                boolean vertically, boolean toLimit) {
<span class="nc" id="L216">            this(name, 0, 0, extend, false);</span>
<span class="nc" id="L217">            this.forwards = forwards;</span>
<span class="nc" id="L218">            this.vertically = vertically;</span>
<span class="nc" id="L219">            this.toLimit = toLimit;</span>
<span class="nc" id="L220">        }</span>

        private static int clipToRange(int i, int a, int b) {
<span class="nc" id="L223">            return Math.min(Math.max(i, a), b-1);</span>
        }

        private void moveWithinTableRange(JTable table, int dx, int dy) {
<span class="nc" id="L227">            leadRow = clipToRange(leadRow+dy, 0, table.getRowCount());</span>
<span class="nc" id="L228">            leadColumn = clipToRange(leadColumn+dx, 0, table.getColumnCount());</span>
<span class="nc" id="L229">        }</span>

        private static int sign(int num) {
<span class="nc bnc" id="L232" title="All 4 branches missed.">            return (num &lt; 0) ? -1 : ((num == 0) ? 0 : 1);</span>
        }

        /**
         * Called to move within the selected range of the given JTable.
         * This method uses the table's notion of selection, which is
         * important to allow the user to navigate between items visually
         * selected on screen. This notion may or may not be the same as
         * what could be determined by directly querying the selection models.
         * It depends on certain table properties (such as whether or not
         * row or column selection is allowed). When performing modifications,
         * it is recommended that caution be taken in order to preserve
         * the intent of this method, especially when deciding whether to
         * query the selection models or interact with JTable directly.
         */
        private boolean moveWithinSelectedRange(JTable table, int dx, int dy,
                ListSelectionModel rsm, ListSelectionModel csm) {

            // Note: The Actions constructor ensures that only one of
            // dx and dy is 0, and the other is either -1 or 1

            // find out how many items the table is showing as selected
            // and the range of items to navigate through
            int totalCount;
            int minX, maxX, minY, maxY;

<span class="nc" id="L258">            boolean rs = table.getRowSelectionAllowed();</span>
<span class="nc" id="L259">            boolean cs = table.getColumnSelectionAllowed();</span>

            // both column and row selection
<span class="nc bnc" id="L262" title="All 4 branches missed.">            if (rs &amp;&amp; cs) {</span>
<span class="nc" id="L263">                totalCount = table.getSelectedRowCount() * table.getSelectedColumnCount();</span>
<span class="nc" id="L264">                minX = csm.getMinSelectionIndex();</span>
<span class="nc" id="L265">                maxX = csm.getMaxSelectionIndex();</span>
<span class="nc" id="L266">                minY = rsm.getMinSelectionIndex();</span>
<span class="nc" id="L267">                maxY = rsm.getMaxSelectionIndex();</span>
            // row selection only
<span class="nc bnc" id="L269" title="All 2 branches missed.">            } else if (rs) {</span>
<span class="nc" id="L270">                totalCount = table.getSelectedRowCount();</span>
<span class="nc" id="L271">                minX = 0;</span>
<span class="nc" id="L272">                maxX = table.getColumnCount() - 1;</span>
<span class="nc" id="L273">                minY = rsm.getMinSelectionIndex();</span>
<span class="nc" id="L274">                maxY = rsm.getMaxSelectionIndex();</span>
            // column selection only
<span class="nc bnc" id="L276" title="All 2 branches missed.">            } else if (cs) {</span>
<span class="nc" id="L277">                totalCount = table.getSelectedColumnCount();</span>
<span class="nc" id="L278">                minX = csm.getMinSelectionIndex();</span>
<span class="nc" id="L279">                maxX = csm.getMaxSelectionIndex();</span>
<span class="nc" id="L280">                minY = 0;</span>
<span class="nc" id="L281">                maxY = table.getRowCount() - 1;</span>
            // no selection allowed
            } else {
<span class="nc" id="L284">                totalCount = 0;</span>
                // A bogus assignment to stop javac from complaining
                // about unitialized values. In this case, these
                // won't even be used.
<span class="nc" id="L288">                minX = maxX = minY = maxY = 0;</span>
            }

            // For some cases, there is no point in trying to stay within the
            // selected area. Instead, move outside the selection, wrapping at
            // the table boundaries. The cases are:
            boolean stayInSelection;

            // - nothing selected
<span class="nc bnc" id="L297" title="All 4 branches missed.">            if (totalCount == 0 ||</span>
                    // - one item selected, and the lead is already selected
<span class="nc bnc" id="L299" title="All 2 branches missed.">                    (totalCount == 1 &amp;&amp; table.isCellSelected(leadRow, leadColumn))) {</span>

<span class="nc" id="L301">                stayInSelection = false;</span>

<span class="nc" id="L303">                maxX = table.getColumnCount() - 1;</span>
<span class="nc" id="L304">                maxY = table.getRowCount() - 1;</span>

                // the mins are calculated like this in case the max is -1
<span class="nc" id="L307">                minX = Math.min(0, maxX);</span>
<span class="nc" id="L308">                minY = Math.min(0, maxY);</span>
            } else {
<span class="nc" id="L310">                stayInSelection = true;</span>
            }

            // the algorithm below isn't prepared to deal with -1 lead/anchor
            // so massage appropriately here first
<span class="nc bnc" id="L315" title="All 4 branches missed.">            if (dy == 1 &amp;&amp; leadColumn == -1) {</span>
<span class="nc" id="L316">                leadColumn = minX;</span>
<span class="nc" id="L317">                leadRow = -1;</span>
<span class="nc bnc" id="L318" title="All 4 branches missed.">            } else if (dx == 1 &amp;&amp; leadRow == -1) {</span>
<span class="nc" id="L319">                leadRow = minY;</span>
<span class="nc" id="L320">                leadColumn = -1;</span>
<span class="nc bnc" id="L321" title="All 4 branches missed.">            } else if (dy == -1 &amp;&amp; leadColumn == -1) {</span>
<span class="nc" id="L322">                leadColumn = maxX;</span>
<span class="nc" id="L323">                leadRow = maxY + 1;</span>
<span class="nc bnc" id="L324" title="All 4 branches missed.">            } else if (dx == -1 &amp;&amp; leadRow == -1) {</span>
<span class="nc" id="L325">                leadRow = maxY;</span>
<span class="nc" id="L326">                leadColumn = maxX + 1;</span>
            }

            // In cases where the lead is not within the search range,
            // we need to bring it within one cell for the the search
            // to work properly. Check these here.
<span class="nc" id="L332">            leadRow = Math.min(Math.max(leadRow, minY - 1), maxY + 1);</span>
<span class="nc" id="L333">            leadColumn = Math.min(Math.max(leadColumn, minX - 1), maxX + 1);</span>

            // find the next position, possibly looping until it is selected
            do {
<span class="nc" id="L337">                calcNextPos(dx, minX, maxX, dy, minY, maxY);</span>
<span class="nc bnc" id="L338" title="All 4 branches missed.">            } while (stayInSelection &amp;&amp; !table.isCellSelected(leadRow, leadColumn));</span>

<span class="nc" id="L340">            return stayInSelection;</span>
        }

        /**
         * Find the next lead row and column based on the given
         * dx/dy and max/min values.
         */
        private void calcNextPos(int dx, int minX, int maxX,
                                 int dy, int minY, int maxY) {

<span class="nc bnc" id="L350" title="All 2 branches missed.">            if (dx != 0) {</span>
<span class="nc" id="L351">                leadColumn += dx;</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                if (leadColumn &gt; maxX) {</span>
<span class="nc" id="L353">                    leadColumn = minX;</span>
<span class="nc" id="L354">                    leadRow++;</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                    if (leadRow &gt; maxY) {</span>
<span class="nc" id="L356">                        leadRow = minY;</span>
                    }
<span class="nc bnc" id="L358" title="All 2 branches missed.">                } else if (leadColumn &lt; minX) {</span>
<span class="nc" id="L359">                    leadColumn = maxX;</span>
<span class="nc" id="L360">                    leadRow--;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                    if (leadRow &lt; minY) {</span>
<span class="nc" id="L362">                        leadRow = maxY;</span>
                    }
                }
            } else {
<span class="nc" id="L366">                leadRow += dy;</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                if (leadRow &gt; maxY) {</span>
<span class="nc" id="L368">                    leadRow = minY;</span>
<span class="nc" id="L369">                    leadColumn++;</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">                    if (leadColumn &gt; maxX) {</span>
<span class="nc" id="L371">                        leadColumn = minX;</span>
                    }
<span class="nc bnc" id="L373" title="All 2 branches missed.">                } else if (leadRow &lt; minY) {</span>
<span class="nc" id="L374">                    leadRow = maxY;</span>
<span class="nc" id="L375">                    leadColumn--;</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                    if (leadColumn &lt; minX) {</span>
<span class="nc" id="L377">                        leadColumn = maxX;</span>
                    }
                }
            }
<span class="nc" id="L381">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L384">            String key = getName();</span>
<span class="nc" id="L385">            JTable table = (JTable)e.getSource();</span>

<span class="nc" id="L387">            ListSelectionModel rsm = table.getSelectionModel();</span>
<span class="nc" id="L388">            leadRow = getAdjustedLead(table, true, rsm);</span>

<span class="nc" id="L390">            ListSelectionModel csm = table.getColumnModel().getSelectionModel();</span>
<span class="nc" id="L391">            leadColumn = getAdjustedLead(table, false, csm);</span>

<span class="nc bnc" id="L393" title="All 32 branches missed.">            if (key == SCROLL_LEFT_CHANGE_SELECTION ||        // Paging Actions</span>
                    key == SCROLL_LEFT_EXTEND_SELECTION ||
                    key == SCROLL_RIGHT_CHANGE_SELECTION ||
                    key == SCROLL_RIGHT_EXTEND_SELECTION ||
                    key == SCROLL_UP_CHANGE_SELECTION ||
                    key == SCROLL_UP_EXTEND_SELECTION ||
                    key == SCROLL_DOWN_CHANGE_SELECTION ||
                    key == SCROLL_DOWN_EXTEND_SELECTION ||
                    key == FIRST_COLUMN ||
                    key == FIRST_COLUMN_EXTEND_SELECTION ||
                    key == FIRST_ROW ||
                    key == FIRST_ROW_EXTEND_SELECTION ||
                    key == LAST_COLUMN ||
                    key == LAST_COLUMN_EXTEND_SELECTION ||
                    key == LAST_ROW ||
                    key == LAST_ROW_EXTEND_SELECTION) {
<span class="nc bnc" id="L409" title="All 2 branches missed.">                if (toLimit) {</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                    if (vertically) {</span>
<span class="nc" id="L411">                        int rowCount = table.getRowCount();</span>
<span class="nc" id="L412">                        this.dx = 0;</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">                        this.dy = forwards ? rowCount : -rowCount;</span>
<span class="nc" id="L414">                    }</span>
                    else {
<span class="nc" id="L416">                        int colCount = table.getColumnCount();</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                        this.dx = forwards ? colCount : -colCount;</span>
<span class="nc" id="L418">                        this.dy = 0;</span>
<span class="nc" id="L419">                    }</span>
                }
                else {
<span class="nc bnc" id="L422" title="All 2 branches missed.">                    if (!(SwingUtilities.getUnwrappedParent(table).getParent() instanceof</span>
                            JScrollPane)) {
<span class="nc" id="L424">                        return;</span>
                    }

<span class="nc" id="L427">                    Dimension delta = table.getParent().getSize();</span>

<span class="nc bnc" id="L429" title="All 2 branches missed.">                    if (vertically) {</span>
<span class="nc" id="L430">                        Rectangle r = table.getCellRect(leadRow, 0, true);</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">                        if (forwards) {</span>
                            // scroll by at least one cell
<span class="nc" id="L433">                            r.y += Math.max(delta.height, r.height);</span>
                        } else {
<span class="nc" id="L435">                            r.y -= delta.height;</span>
                        }

<span class="nc" id="L438">                        this.dx = 0;</span>
<span class="nc" id="L439">                        int newRow = table.rowAtPoint(r.getLocation());</span>
<span class="nc bnc" id="L440" title="All 4 branches missed.">                        if (newRow == -1 &amp;&amp; forwards) {</span>
<span class="nc" id="L441">                            newRow = table.getRowCount();</span>
                        }
<span class="nc" id="L443">                        this.dy = newRow - leadRow;</span>
<span class="nc" id="L444">                    }</span>
                    else {
<span class="nc" id="L446">                        Rectangle r = table.getCellRect(0, leadColumn, true);</span>

<span class="nc bnc" id="L448" title="All 2 branches missed.">                        if (forwards) {</span>
                            // scroll by at least one cell
<span class="nc" id="L450">                            r.x += Math.max(delta.width, r.width);</span>
                        } else {
<span class="nc" id="L452">                            r.x -= delta.width;</span>
                        }

<span class="nc" id="L455">                        int newColumn = table.columnAtPoint(r.getLocation());</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                        if (newColumn == -1) {</span>
<span class="nc" id="L457">                            boolean ltr = table.getComponentOrientation().isLeftToRight();</span>

<span class="nc bnc" id="L459" title="All 6 branches missed.">                            newColumn = forwards ? (ltr ? table.getColumnCount() : 0)</span>
<span class="nc" id="L460">                                                 : (ltr ? 0 : table.getColumnCount());</span>

                        }
<span class="nc" id="L463">                        this.dx = newColumn - leadColumn;</span>
<span class="nc" id="L464">                        this.dy = 0;</span>
                    }
                }
            }
<span class="nc bnc" id="L468" title="All 64 branches missed.">            if (key == NEXT_ROW ||  // Navigate Actions</span>
                    key == NEXT_ROW_CELL ||
                    key == NEXT_ROW_EXTEND_SELECTION ||
                    key == NEXT_ROW_CHANGE_LEAD ||
                    key == NEXT_COLUMN ||
                    key == NEXT_COLUMN_CELL ||
                    key == NEXT_COLUMN_EXTEND_SELECTION ||
                    key == NEXT_COLUMN_CHANGE_LEAD ||
                    key == PREVIOUS_ROW ||
                    key == PREVIOUS_ROW_CELL ||
                    key == PREVIOUS_ROW_EXTEND_SELECTION ||
                    key == PREVIOUS_ROW_CHANGE_LEAD ||
                    key == PREVIOUS_COLUMN ||
                    key == PREVIOUS_COLUMN_CELL ||
                    key == PREVIOUS_COLUMN_EXTEND_SELECTION ||
                    key == PREVIOUS_COLUMN_CHANGE_LEAD ||
                    // Paging Actions.
                    key == SCROLL_LEFT_CHANGE_SELECTION ||
                    key == SCROLL_LEFT_EXTEND_SELECTION ||
                    key == SCROLL_RIGHT_CHANGE_SELECTION ||
                    key == SCROLL_RIGHT_EXTEND_SELECTION ||
                    key == SCROLL_UP_CHANGE_SELECTION ||
                    key == SCROLL_UP_EXTEND_SELECTION ||
                    key == SCROLL_DOWN_CHANGE_SELECTION ||
                    key == SCROLL_DOWN_EXTEND_SELECTION ||
                    key == FIRST_COLUMN ||
                    key == FIRST_COLUMN_EXTEND_SELECTION ||
                    key == FIRST_ROW ||
                    key == FIRST_ROW_EXTEND_SELECTION ||
                    key == LAST_COLUMN ||
                    key == LAST_COLUMN_EXTEND_SELECTION ||
                    key == LAST_ROW ||
                    key == LAST_ROW_EXTEND_SELECTION) {

<span class="nc bnc" id="L502" title="All 2 branches missed.">                if (table.isEditing() &amp;&amp;</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">                        !table.getCellEditor().stopCellEditing()) {</span>
<span class="nc" id="L504">                    return;</span>
                }

                // Unfortunately, this strategy introduces bugs because
                // of the asynchronous nature of requestFocus() call below.
                // Introducing a delay with invokeLater() makes this work
                // in the typical case though race conditions then allow
                // focus to disappear altogether. The right solution appears
                // to be to fix requestFocus() so that it queues a request
                // for the focus regardless of who owns the focus at the
                // time the call to requestFocus() is made. The optimisation
                // to ignore the call to requestFocus() when the component
                // already has focus may ligitimately be made as the
                // request focus event is dequeued, not before.

                // boolean wasEditingWithFocus = table.isEditing() &amp;&amp;
                // table.getEditorComponent().isFocusOwner();

<span class="nc" id="L522">                boolean changeLead = false;</span>
<span class="nc bnc" id="L523" title="All 4 branches missed.">                if (key == NEXT_ROW_CHANGE_LEAD || key == PREVIOUS_ROW_CHANGE_LEAD) {</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">                    changeLead = (rsm.getSelectionMode()</span>
                                     == ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);
<span class="nc bnc" id="L526" title="All 4 branches missed.">                } else if (key == NEXT_COLUMN_CHANGE_LEAD || key == PREVIOUS_COLUMN_CHANGE_LEAD) {</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                    changeLead = (csm.getSelectionMode()</span>
                                     == ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);
                }

<span class="nc bnc" id="L531" title="All 2 branches missed.">                if (changeLead) {</span>
<span class="nc" id="L532">                    moveWithinTableRange(table, dx, dy);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">                    if (dy != 0) {</span>
                        // casting should be safe since the action is only enabled
                        // for DefaultListSelectionModel
<span class="nc" id="L536">                        ((DefaultListSelectionModel)rsm).moveLeadSelectionIndex(leadRow);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                        if (getAdjustedLead(table, false, csm) == -1</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">                                &amp;&amp; table.getColumnCount() &gt; 0) {</span>

<span class="nc" id="L540">                            ((DefaultListSelectionModel)csm).moveLeadSelectionIndex(0);</span>
                        }
                    } else {
                        // casting should be safe since the action is only enabled
                        // for DefaultListSelectionModel
<span class="nc" id="L545">                        ((DefaultListSelectionModel)csm).moveLeadSelectionIndex(leadColumn);</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                        if (getAdjustedLead(table, true, rsm) == -1</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                                &amp;&amp; table.getRowCount() &gt; 0) {</span>

<span class="nc" id="L549">                            ((DefaultListSelectionModel)rsm).moveLeadSelectionIndex(0);</span>
                        }
                    }

<span class="nc" id="L553">                    Rectangle cellRect = table.getCellRect(leadRow, leadColumn, false);</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">                    if (cellRect != null) {</span>
<span class="nc" id="L555">                        table.scrollRectToVisible(cellRect);</span>
                    }
<span class="nc bnc" id="L557" title="All 2 branches missed.">                } else if (!inSelection) {</span>
<span class="nc" id="L558">                    moveWithinTableRange(table, dx, dy);</span>
<span class="nc" id="L559">                    table.changeSelection(leadRow, leadColumn, false, extend);</span>
                }
                else {
<span class="nc bnc" id="L562" title="All 4 branches missed.">                    if (table.getRowCount() &lt;= 0 || table.getColumnCount() &lt;= 0) {</span>
                        // bail - don't try to move selection on an empty table
<span class="nc" id="L564">                        return;</span>
                    }

<span class="nc bnc" id="L567" title="All 2 branches missed.">                    if (moveWithinSelectedRange(table, dx, dy, rsm, csm)) {</span>
                        // this is the only way we have to set both the lead
                        // and the anchor without changing the selection
<span class="nc bnc" id="L570" title="All 2 branches missed.">                        if (rsm.isSelectedIndex(leadRow)) {</span>
<span class="nc" id="L571">                            rsm.addSelectionInterval(leadRow, leadRow);</span>
                        } else {
<span class="nc" id="L573">                            rsm.removeSelectionInterval(leadRow, leadRow);</span>
                        }

<span class="nc bnc" id="L576" title="All 2 branches missed.">                        if (csm.isSelectedIndex(leadColumn)) {</span>
<span class="nc" id="L577">                            csm.addSelectionInterval(leadColumn, leadColumn);</span>
                        } else {
<span class="nc" id="L579">                            csm.removeSelectionInterval(leadColumn, leadColumn);</span>
                        }

<span class="nc" id="L582">                        Rectangle cellRect = table.getCellRect(leadRow, leadColumn, false);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">                        if (cellRect != null) {</span>
<span class="nc" id="L584">                            table.scrollRectToVisible(cellRect);</span>
                        }
<span class="nc" id="L586">                    }</span>
                    else {
<span class="nc" id="L588">                        table.changeSelection(leadRow, leadColumn,</span>
                                false, false);
                    }
                }

                /*
                if (wasEditingWithFocus) {
                    table.editCellAt(leadRow, leadColumn);
                    final Component editorComp = table.getEditorComponent();
                    if (editorComp != null) {
                        SwingUtilities.invokeLater(new Runnable() {
                            public void run() {
                                editorComp.requestFocus();
                            }
                        });
                    }
                }
                */
<span class="nc bnc" id="L606" title="All 2 branches missed.">            } else if (key == CANCEL_EDITING) {</span>
<span class="nc" id="L607">                table.removeEditor();</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">            } else if (key == SELECT_ALL) {</span>
<span class="nc" id="L609">                table.selectAll();</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">            } else if (key == CLEAR_SELECTION) {</span>
<span class="nc" id="L611">                table.clearSelection();</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">            } else if (key == START_EDITING) {</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                if (!table.hasFocus()) {</span>
<span class="nc" id="L614">                    CellEditor cellEditor = table.getCellEditor();</span>
<span class="nc bnc" id="L615" title="All 4 branches missed.">                    if (cellEditor != null &amp;&amp; !cellEditor.stopCellEditing()) {</span>
<span class="nc" id="L616">                        return;</span>
                    }
<span class="nc" id="L618">                    table.requestFocus();</span>
<span class="nc" id="L619">                    return;</span>
                }
<span class="nc" id="L621">                table.editCellAt(leadRow, leadColumn, e);</span>
<span class="nc" id="L622">                Component editorComp = table.getEditorComponent();</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">                if (editorComp != null) {</span>
<span class="nc" id="L624">                    editorComp.requestFocus();</span>
                }
<span class="nc bnc" id="L626" title="All 2 branches missed.">            } else if (key == ADD_TO_SELECTION) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                if (!table.isCellSelected(leadRow, leadColumn)) {</span>
<span class="nc" id="L628">                    int oldAnchorRow = rsm.getAnchorSelectionIndex();</span>
<span class="nc" id="L629">                    int oldAnchorColumn = csm.getAnchorSelectionIndex();</span>
<span class="nc" id="L630">                    rsm.setValueIsAdjusting(true);</span>
<span class="nc" id="L631">                    csm.setValueIsAdjusting(true);</span>
<span class="nc" id="L632">                    table.changeSelection(leadRow, leadColumn, true, false);</span>
<span class="nc" id="L633">                    rsm.setAnchorSelectionIndex(oldAnchorRow);</span>
<span class="nc" id="L634">                    csm.setAnchorSelectionIndex(oldAnchorColumn);</span>
<span class="nc" id="L635">                    rsm.setValueIsAdjusting(false);</span>
<span class="nc" id="L636">                    csm.setValueIsAdjusting(false);</span>
<span class="nc" id="L637">                }</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">            } else if (key == TOGGLE_AND_ANCHOR) {</span>
<span class="nc" id="L639">                table.changeSelection(leadRow, leadColumn, true, false);</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">            } else if (key == EXTEND_TO) {</span>
<span class="nc" id="L641">                table.changeSelection(leadRow, leadColumn, false, true);</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">            } else if (key == MOVE_SELECTION_TO) {</span>
<span class="nc" id="L643">                table.changeSelection(leadRow, leadColumn, false, false);</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">            } else if (key == FOCUS_HEADER) {</span>
<span class="nc" id="L645">                JTableHeader th = table.getTableHeader();</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">                if (th != null) {</span>
                    //Set the header's selected column to match the table.
<span class="nc" id="L648">                    int col = table.getSelectedColumn();</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">                    if (col &gt;= 0) {</span>
<span class="nc" id="L650">                        TableHeaderUI thUI = th.getUI();</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">                        if (thUI instanceof BasicTableHeaderUI) {</span>
<span class="nc" id="L652">                            ((BasicTableHeaderUI)thUI).selectColumn(col);</span>
                        }
                    }

                    //Then give the header the focus.
<span class="nc" id="L657">                    th.requestFocusInWindow();</span>
                }
            }
<span class="nc" id="L660">        }</span>

        public boolean isEnabled(Object sender) {
<span class="nc" id="L663">            String key = getName();</span>

<span class="nc bnc" id="L665" title="All 2 branches missed.">            if (sender instanceof JTable &amp;&amp;</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">                Boolean.TRUE.equals(((JTable)sender).getClientProperty(&quot;Table.isFileList&quot;))) {</span>
<span class="nc bnc" id="L667" title="All 36 branches missed.">                if (key == NEXT_COLUMN ||</span>
                        key == NEXT_COLUMN_CELL ||
                        key == NEXT_COLUMN_EXTEND_SELECTION ||
                        key == NEXT_COLUMN_CHANGE_LEAD ||
                        key == PREVIOUS_COLUMN ||
                        key == PREVIOUS_COLUMN_CELL ||
                        key == PREVIOUS_COLUMN_EXTEND_SELECTION ||
                        key == PREVIOUS_COLUMN_CHANGE_LEAD ||
                        key == SCROLL_LEFT_CHANGE_SELECTION ||
                        key == SCROLL_LEFT_EXTEND_SELECTION ||
                        key == SCROLL_RIGHT_CHANGE_SELECTION ||
                        key == SCROLL_RIGHT_EXTEND_SELECTION ||
                        key == FIRST_COLUMN ||
                        key == FIRST_COLUMN_EXTEND_SELECTION ||
                        key == LAST_COLUMN ||
                        key == LAST_COLUMN_EXTEND_SELECTION ||
                        key == NEXT_ROW_CELL ||
                        key == PREVIOUS_ROW_CELL) {

<span class="nc" id="L686">                    return false;</span>
                }
            }

<span class="nc bnc" id="L690" title="All 4 branches missed.">            if (key == CANCEL_EDITING &amp;&amp; sender instanceof JTable) {</span>
<span class="nc" id="L691">                return ((JTable)sender).isEditing();</span>
<span class="nc bnc" id="L692" title="All 4 branches missed.">            } else if (key == NEXT_ROW_CHANGE_LEAD ||</span>
                       key == PREVIOUS_ROW_CHANGE_LEAD) {
                // discontinuous selection actions are only enabled for
                // DefaultListSelectionModel
<span class="nc bnc" id="L696" title="All 2 branches missed.">                return sender != null &amp;&amp;</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">                       ((JTable)sender).getSelectionModel()</span>
                           instanceof DefaultListSelectionModel;
<span class="nc bnc" id="L699" title="All 4 branches missed.">            } else if (key == NEXT_COLUMN_CHANGE_LEAD ||</span>
                       key == PREVIOUS_COLUMN_CHANGE_LEAD) {
                // discontinuous selection actions are only enabled for
                // DefaultListSelectionModel
<span class="nc bnc" id="L703" title="All 2 branches missed.">                return sender != null &amp;&amp;</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">                       ((JTable)sender).getColumnModel().getSelectionModel()</span>
                           instanceof DefaultListSelectionModel;
<span class="nc bnc" id="L706" title="All 4 branches missed.">            } else if (key == ADD_TO_SELECTION &amp;&amp; sender instanceof JTable) {</span>
                // This action is typically bound to SPACE.
                // If the table is already in an editing mode, SPACE should
                // simply enter a space character into the table, and not
                // select a cell. Likewise, if the lead cell is already selected
                // then hitting SPACE should just enter a space character
                // into the cell and begin editing. In both of these cases
                // this action will be disabled.
<span class="nc" id="L714">                JTable table = (JTable)sender;</span>
<span class="nc" id="L715">                int leadRow = getAdjustedLead(table, true);</span>
<span class="nc" id="L716">                int leadCol = getAdjustedLead(table, false);</span>
<span class="nc bnc" id="L717" title="All 4 branches missed.">                return !(table.isEditing() || table.isCellSelected(leadRow, leadCol));</span>
<span class="nc bnc" id="L718" title="All 4 branches missed.">            } else if (key == FOCUS_HEADER &amp;&amp; sender instanceof JTable) {</span>
<span class="nc" id="L719">                JTable table = (JTable)sender;</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">                return table.getTableHeader() != null;</span>
            }

<span class="nc" id="L723">            return true;</span>
        }
    }


//
//  The Table's Key listener
//

    /**
     * This class should be treated as a &amp;quot;protected&amp;quot; inner class.
     * Instantiate it only within subclasses of {@code BasicTableUI}.
     * &lt;p&gt;As of Java 2 platform v1.3 this class is no longer used.
     * Instead &lt;code&gt;JTable&lt;/code&gt;
     * overrides &lt;code&gt;processKeyBinding&lt;/code&gt; to dispatch the event to
     * the current &lt;code&gt;TableCellEditor&lt;/code&gt;.
     */
<span class="nc" id="L740">     public class KeyHandler implements KeyListener {</span>
        // NOTE: This class exists only for backward compatibility. All
        // its functionality has been moved into Handler. If you need to add
        // new functionality add it to the Handler, but make sure this
        // class calls into the Handler.
        public void keyPressed(KeyEvent e) {
<span class="nc" id="L746">            getHandler().keyPressed(e);</span>
<span class="nc" id="L747">        }</span>

        public void keyReleased(KeyEvent e) {
<span class="nc" id="L750">            getHandler().keyReleased(e);</span>
<span class="nc" id="L751">        }</span>

        public void keyTyped(KeyEvent e) {
<span class="nc" id="L754">            getHandler().keyTyped(e);</span>
<span class="nc" id="L755">        }</span>
    }

//
//  The Table's focus listener
//

    /**
     * This class should be treated as a &amp;quot;protected&amp;quot; inner class.
     * Instantiate it only within subclasses of {@code BasicTableUI}.
     */
<span class="nc" id="L766">    public class FocusHandler implements FocusListener {</span>
        // NOTE: This class exists only for backward compatibility. All
        // its functionality has been moved into Handler. If you need to add
        // new functionality add it to the Handler, but make sure this
        // class calls into the Handler.
        public void focusGained(FocusEvent e) {
<span class="nc" id="L772">            getHandler().focusGained(e);</span>
<span class="nc" id="L773">        }</span>

        public void focusLost(FocusEvent e) {
<span class="nc" id="L776">            getHandler().focusLost(e);</span>
<span class="nc" id="L777">        }</span>
    }

//
//  The Table's mouse and mouse motion listeners
//

    /**
     * This class should be treated as a &amp;quot;protected&amp;quot; inner class.
     * Instantiate it only within subclasses of BasicTableUI.
     */
<span class="nc" id="L788">    public class MouseInputHandler implements MouseInputListener {</span>
        // NOTE: This class exists only for backward compatibility. All
        // its functionality has been moved into Handler. If you need to add
        // new functionality add it to the Handler, but make sure this
        // class calls into the Handler.
        public void mouseClicked(MouseEvent e) {
<span class="nc" id="L794">            getHandler().mouseClicked(e);</span>
<span class="nc" id="L795">        }</span>

        public void mousePressed(MouseEvent e) {
<span class="nc" id="L798">            getHandler().mousePressed(e);</span>
<span class="nc" id="L799">        }</span>

        public void mouseReleased(MouseEvent e) {
<span class="nc" id="L802">            getHandler().mouseReleased(e);</span>
<span class="nc" id="L803">        }</span>

        public void mouseEntered(MouseEvent e) {
<span class="nc" id="L806">            getHandler().mouseEntered(e);</span>
<span class="nc" id="L807">        }</span>

        public void mouseExited(MouseEvent e) {
<span class="nc" id="L810">            getHandler().mouseExited(e);</span>
<span class="nc" id="L811">        }</span>

        public void mouseMoved(MouseEvent e) {
<span class="nc" id="L814">            getHandler().mouseMoved(e);</span>
<span class="nc" id="L815">        }</span>

        public void mouseDragged(MouseEvent e) {
<span class="nc" id="L818">            getHandler().mouseDragged(e);</span>
<span class="nc" id="L819">        }</span>
    }

<span class="nc" id="L822">    private class Handler implements FocusListener, MouseInputListener,</span>
            PropertyChangeListener, ListSelectionListener, ActionListener,
            BeforeDrag {

        // FocusListener
        private void repaintLeadCell( ) {
<span class="nc" id="L828">            int lr = getAdjustedLead(table, true);</span>
<span class="nc" id="L829">            int lc = getAdjustedLead(table, false);</span>

<span class="nc bnc" id="L831" title="All 4 branches missed.">            if (lr &lt; 0 || lc &lt; 0) {</span>
<span class="nc" id="L832">                return;</span>
            }

<span class="nc" id="L835">            Rectangle dirtyRect = table.getCellRect(lr, lc, false);</span>
<span class="nc" id="L836">            table.repaint(dirtyRect);</span>
<span class="nc" id="L837">        }</span>

        public void focusGained(FocusEvent e) {
<span class="nc" id="L840">            repaintLeadCell();</span>
<span class="nc" id="L841">        }</span>

        public void focusLost(FocusEvent e) {
<span class="nc" id="L844">            repaintLeadCell();</span>
<span class="nc" id="L845">        }</span>


        // KeyListener
<span class="nc" id="L849">        public void keyPressed(KeyEvent e) { }</span>

<span class="nc" id="L851">        public void keyReleased(KeyEvent e) { }</span>

        public void keyTyped(KeyEvent e) {
<span class="nc" id="L854">            KeyStroke keyStroke = KeyStroke.getKeyStroke(e.getKeyChar(),</span>
<span class="nc" id="L855">                    e.getModifiers());</span>

            // We register all actions using ANCESTOR_OF_FOCUSED_COMPONENT
            // which means that we might perform the appropriate action
            // in the table and then forward it to the editor if the editor
            // had focus. Make sure this doesn't happen by checking our
            // InputMaps.
<span class="nc" id="L862">            InputMap map = table.getInputMap(JComponent.WHEN_FOCUSED);</span>
<span class="nc bnc" id="L863" title="All 4 branches missed.">            if (map != null &amp;&amp; map.get(keyStroke) != null) {</span>
<span class="nc" id="L864">                return;</span>
            }
<span class="nc" id="L866">            map = table.getInputMap(JComponent.</span>
                                  WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
<span class="nc bnc" id="L868" title="All 4 branches missed.">            if (map != null &amp;&amp; map.get(keyStroke) != null) {</span>
<span class="nc" id="L869">                return;</span>
            }

<span class="nc" id="L872">            keyStroke = KeyStroke.getKeyStrokeForEvent(e);</span>

            // The AWT seems to generate an unconsumed \r event when
            // ENTER (\n) is pressed.
<span class="nc bnc" id="L876" title="All 2 branches missed.">            if (e.getKeyChar() == '\r') {</span>
<span class="nc" id="L877">                return;</span>
            }

<span class="nc" id="L880">            int leadRow = getAdjustedLead(table, true);</span>
<span class="nc" id="L881">            int leadColumn = getAdjustedLead(table, false);</span>
<span class="nc bnc" id="L882" title="All 6 branches missed.">            if (leadRow != -1 &amp;&amp; leadColumn != -1 &amp;&amp; !table.isEditing()) {</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">                if (!table.editCellAt(leadRow, leadColumn)) {</span>
<span class="nc" id="L884">                    return;</span>
                }
            }

            // Forwarding events this way seems to put the component
            // in a state where it believes it has focus. In reality
            // the table retains focus - though it is difficult for
            // a user to tell, since the caret is visible and flashing.

            // Calling table.requestFocus() here, to get the focus back to
            // the table, seems to have no effect.

<span class="nc" id="L896">            Component editorComp = table.getEditorComponent();</span>
<span class="nc bnc" id="L897" title="All 4 branches missed.">            if (table.isEditing() &amp;&amp; editorComp != null) {</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">                if (editorComp instanceof JComponent) {</span>
<span class="nc" id="L899">                    JComponent component = (JComponent)editorComp;</span>
<span class="nc" id="L900">                    map = component.getInputMap(JComponent.WHEN_FOCUSED);</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">                    Object binding = (map != null) ? map.get(keyStroke) : null;</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">                    if (binding == null) {</span>
<span class="nc" id="L903">                        map = component.getInputMap(JComponent.</span>
                                         WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
<span class="nc bnc" id="L905" title="All 2 branches missed.">                        binding = (map != null) ? map.get(keyStroke) : null;</span>
                    }
<span class="nc bnc" id="L907" title="All 2 branches missed.">                    if (binding != null) {</span>
<span class="nc" id="L908">                        ActionMap am = component.getActionMap();</span>
<span class="nc bnc" id="L909" title="All 2 branches missed.">                        Action action = (am != null) ? am.get(binding) : null;</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">                        if (action != null &amp;&amp; SwingUtilities.</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">                            notifyAction(action, keyStroke, e, component,</span>
<span class="nc" id="L912">                                         e.getModifiers())) {</span>
<span class="nc" id="L913">                            e.consume();</span>
                        }
                    }
                }
            }
<span class="nc" id="L918">        }</span>


        // MouseInputListener

        // Component receiving mouse events during editing.
        // May not be editorComponent.
        private Component dispatchComponent;

<span class="nc" id="L927">        public void mouseClicked(MouseEvent e) {}</span>

        private void setDispatchComponent(MouseEvent e) {
<span class="nc" id="L930">            Component editorComponent = table.getEditorComponent();</span>
<span class="nc" id="L931">            Point p = e.getPoint();</span>
<span class="nc" id="L932">            Point p2 = SwingUtilities.convertPoint(table, p, editorComponent);</span>
<span class="nc" id="L933">            dispatchComponent =</span>
<span class="nc" id="L934">                    SwingUtilities.getDeepestComponentAt(editorComponent,</span>
                            p2.x, p2.y);
<span class="nc" id="L936">            SwingUtilities2.setSkipClickCount(dispatchComponent,</span>
<span class="nc" id="L937">                                              e.getClickCount() - 1);</span>
<span class="nc" id="L938">        }</span>

        private boolean repostEvent(MouseEvent e) {
            // Check for isEditing() in case another event has
            // caused the editor to be removed. See bug #4306499.
<span class="nc bnc" id="L943" title="All 4 branches missed.">            if (dispatchComponent == null || !table.isEditing()) {</span>
<span class="nc" id="L944">                return false;</span>
            }
<span class="nc" id="L946">            MouseEvent e2 = SwingUtilities.convertMouseEvent(table, e,</span>
                    dispatchComponent);
<span class="nc" id="L948">            dispatchComponent.dispatchEvent(e2);</span>
<span class="nc" id="L949">            return true;</span>
        }

        private void setValueIsAdjusting(boolean flag) {
<span class="nc" id="L953">            table.getSelectionModel().setValueIsAdjusting(flag);</span>
<span class="nc" id="L954">            table.getColumnModel().getSelectionModel().</span>
<span class="nc" id="L955">                    setValueIsAdjusting(flag);</span>
<span class="nc" id="L956">        }</span>

        // The row and column where the press occurred and the
        // press event itself
        private int pressedRow;
        private int pressedCol;
        private MouseEvent pressedEvent;

        // Whether or not the mouse press (which is being considered as part
        // of a drag sequence) also caused the selection change to be fully
        // processed.
        private boolean dragPressDidSelection;

        // Set to true when a drag gesture has been fully recognized and DnD
        // begins. Use this to ignore further mouse events which could be
        // delivered if DnD is cancelled (via ESCAPE for example)
        private boolean dragStarted;

        // Whether or not we should start the editing timer on release
        private boolean shouldStartTimer;

        // To cache the return value of pointOutsidePrefSize since we use
        // it multiple times.
        private boolean outsidePrefSize;

        // Used to delay the start of editing.
<span class="nc" id="L982">        private Timer timer = null;</span>

        private boolean canStartDrag() {
<span class="nc bnc" id="L985" title="All 4 branches missed.">            if (pressedRow == -1 || pressedCol == -1) {</span>
<span class="nc" id="L986">                return false;</span>
            }

<span class="nc bnc" id="L989" title="All 2 branches missed.">            if (isFileList) {</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">                return !outsidePrefSize;</span>
            }

            // if this is a single selection table
<span class="nc bnc" id="L994" title="All 2 branches missed.">            if ((table.getSelectionModel().getSelectionMode() ==</span>
                     ListSelectionModel.SINGLE_SELECTION) &amp;&amp;
<span class="nc bnc" id="L996" title="All 2 branches missed.">                (table.getColumnModel().getSelectionModel().getSelectionMode() ==</span>
                     ListSelectionModel.SINGLE_SELECTION)) {

<span class="nc" id="L999">                return true;</span>
            }

<span class="nc" id="L1002">            return table.isCellSelected(pressedRow, pressedCol);</span>
        }

        public void mousePressed(MouseEvent e) {
<span class="nc bnc" id="L1006" title="All 2 branches missed.">            if (SwingUtilities2.shouldIgnore(e, table)) {</span>
<span class="nc" id="L1007">                return;</span>
            }

<span class="nc bnc" id="L1010" title="All 4 branches missed.">            if (table.isEditing() &amp;&amp; !table.getCellEditor().stopCellEditing()) {</span>
<span class="nc" id="L1011">                Component editorComponent = table.getEditorComponent();</span>
<span class="nc bnc" id="L1012" title="All 4 branches missed.">                if (editorComponent != null &amp;&amp; !editorComponent.hasFocus()) {</span>
<span class="nc" id="L1013">                    SwingUtilities2.compositeRequestFocus(editorComponent);</span>
                }
<span class="nc" id="L1015">                return;</span>
            }

<span class="nc" id="L1018">            Point p = e.getPoint();</span>
<span class="nc" id="L1019">            pressedRow = table.rowAtPoint(p);</span>
<span class="nc" id="L1020">            pressedCol = table.columnAtPoint(p);</span>
<span class="nc" id="L1021">            outsidePrefSize = pointOutsidePrefSize(pressedRow, pressedCol, p);</span>

<span class="nc bnc" id="L1023" title="All 2 branches missed.">            if (isFileList) {</span>
<span class="nc" id="L1024">                shouldStartTimer =</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">                    table.isCellSelected(pressedRow, pressedCol) &amp;&amp;</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">                    !e.isShiftDown() &amp;&amp;</span>
<span class="nc bnc" id="L1027" title="All 4 branches missed.">                    !BasicGraphicsUtils.isMenuShortcutKeyDown(e) &amp;&amp;</span>
                    !outsidePrefSize;
            }

<span class="nc bnc" id="L1031" title="All 2 branches missed.">            if (table.getDragEnabled()) {</span>
<span class="nc" id="L1032">                mousePressedDND(e);</span>
            } else {
<span class="nc" id="L1034">                SwingUtilities2.adjustFocus(table);</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">                if (!isFileList) {</span>
<span class="nc" id="L1036">                    setValueIsAdjusting(true);</span>
                }
<span class="nc" id="L1038">                adjustSelection(e);</span>
            }
<span class="nc" id="L1040">        }</span>

        private void mousePressedDND(MouseEvent e) {
<span class="nc" id="L1043">            pressedEvent = e;</span>
<span class="nc" id="L1044">            boolean grabFocus = true;</span>
<span class="nc" id="L1045">            dragStarted = false;</span>

<span class="nc bnc" id="L1047" title="All 4 branches missed.">            if (canStartDrag() &amp;&amp; DragRecognitionSupport.mousePressed(e)) {</span>

<span class="nc" id="L1049">                dragPressDidSelection = false;</span>

<span class="nc bnc" id="L1051" title="All 4 branches missed.">                if (BasicGraphicsUtils.isMenuShortcutKeyDown(e) &amp;&amp; isFileList) {</span>
                    // do nothing for control - will be handled on release
                    // or when drag starts
<span class="nc" id="L1054">                    return;</span>
<span class="nc bnc" id="L1055" title="All 4 branches missed.">                } else if (!e.isShiftDown() &amp;&amp; table.isCellSelected(pressedRow, pressedCol)) {</span>
                    // clicking on something that's already selected
                    // and need to make it the lead now
<span class="nc" id="L1058">                    table.getSelectionModel().addSelectionInterval(pressedRow,</span>
                                                                   pressedRow);
<span class="nc" id="L1060">                    table.getColumnModel().getSelectionModel().</span>
<span class="nc" id="L1061">                        addSelectionInterval(pressedCol, pressedCol);</span>

<span class="nc" id="L1063">                    return;</span>
                }

<span class="nc" id="L1066">                dragPressDidSelection = true;</span>

                // could be a drag initiating event - don't grab focus
<span class="nc" id="L1069">                grabFocus = false;</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">            } else if (!isFileList) {</span>
                // When drag can't happen, mouse drags might change the selection in the table
                // so we want the isAdjusting flag to be set
<span class="nc" id="L1073">                setValueIsAdjusting(true);</span>
            }

<span class="nc bnc" id="L1076" title="All 2 branches missed.">            if (grabFocus) {</span>
<span class="nc" id="L1077">                SwingUtilities2.adjustFocus(table);</span>
            }

<span class="nc" id="L1080">            adjustSelection(e);</span>
<span class="nc" id="L1081">        }</span>

        private void adjustSelection(MouseEvent e) {
            // Fix for 4835633
<span class="nc bnc" id="L1085" title="All 2 branches missed.">            if (outsidePrefSize) {</span>
                // If shift is down in multi-select, we should just return.
                // For single select or non-shift-click, clear the selection
<span class="nc bnc" id="L1088" title="All 2 branches missed.">                if (e.getID() ==  MouseEvent.MOUSE_PRESSED &amp;&amp;</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">                    (!e.isShiftDown() ||</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">                     table.getSelectionModel().getSelectionMode() ==</span>
                     ListSelectionModel.SINGLE_SELECTION)) {
<span class="nc" id="L1092">                    table.clearSelection();</span>
<span class="nc" id="L1093">                    TableCellEditor tce = table.getCellEditor();</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">                    if (tce != null) {</span>
<span class="nc" id="L1095">                        tce.stopCellEditing();</span>
                    }
                }
<span class="nc" id="L1098">                return;</span>
            }
            // The autoscroller can generate drag events outside the
            // table's range.
<span class="nc bnc" id="L1102" title="All 4 branches missed.">            if ((pressedCol == -1) || (pressedRow == -1)) {</span>
<span class="nc" id="L1103">                return;</span>
            }

<span class="nc" id="L1106">            boolean dragEnabled = table.getDragEnabled();</span>

<span class="nc bnc" id="L1108" title="All 6 branches missed.">            if (!dragEnabled &amp;&amp; !isFileList &amp;&amp; table.editCellAt(pressedRow, pressedCol, e)) {</span>
<span class="nc" id="L1109">                setDispatchComponent(e);</span>
<span class="nc" id="L1110">                repostEvent(e);</span>
            }

<span class="nc" id="L1113">            CellEditor editor = table.getCellEditor();</span>
<span class="nc bnc" id="L1114" title="All 6 branches missed.">            if (dragEnabled || editor == null || editor.shouldSelectCell(e)) {</span>
<span class="nc" id="L1115">                table.changeSelection(pressedRow, pressedCol,</span>
<span class="nc" id="L1116">                        BasicGraphicsUtils.isMenuShortcutKeyDown(e),</span>
<span class="nc" id="L1117">                        e.isShiftDown());</span>
            }
<span class="nc" id="L1119">        }</span>

        public void valueChanged(ListSelectionEvent e) {
<span class="nc bnc" id="L1122" title="All 2 branches missed.">            if (timer != null) {</span>
<span class="nc" id="L1123">                timer.stop();</span>
<span class="nc" id="L1124">                timer = null;</span>
            }
<span class="nc" id="L1126">        }</span>

        public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L1129">            table.editCellAt(pressedRow, pressedCol, null);</span>
<span class="nc" id="L1130">            Component editorComponent = table.getEditorComponent();</span>
<span class="nc bnc" id="L1131" title="All 4 branches missed.">            if (editorComponent != null &amp;&amp; !editorComponent.hasFocus()) {</span>
<span class="nc" id="L1132">                SwingUtilities2.compositeRequestFocus(editorComponent);</span>
            }
<span class="nc" id="L1134">            return;</span>
        }

        private void maybeStartTimer() {
<span class="nc bnc" id="L1138" title="All 2 branches missed.">            if (!shouldStartTimer) {</span>
<span class="nc" id="L1139">                return;</span>
            }

<span class="nc bnc" id="L1142" title="All 2 branches missed.">            if (timer == null) {</span>
<span class="nc" id="L1143">                timer = new Timer(1200, this);</span>
<span class="nc" id="L1144">                timer.setRepeats(false);</span>
            }

<span class="nc" id="L1147">            timer.start();</span>
<span class="nc" id="L1148">        }</span>

        public void mouseReleased(MouseEvent e) {
<span class="nc bnc" id="L1151" title="All 2 branches missed.">            if (SwingUtilities2.shouldIgnore(e, table)) {</span>
<span class="nc" id="L1152">                return;</span>
            }

<span class="nc bnc" id="L1155" title="All 2 branches missed.">            if (table.getDragEnabled()) {</span>
<span class="nc" id="L1156">                mouseReleasedDND(e);</span>
            } else {
<span class="nc bnc" id="L1158" title="All 2 branches missed.">                if (isFileList) {</span>
<span class="nc" id="L1159">                    maybeStartTimer();</span>
                }
            }

<span class="nc" id="L1163">            pressedEvent = null;</span>
<span class="nc" id="L1164">            repostEvent(e);</span>
<span class="nc" id="L1165">            dispatchComponent = null;</span>
<span class="nc" id="L1166">            setValueIsAdjusting(false);</span>
<span class="nc" id="L1167">        }</span>

        private void mouseReleasedDND(MouseEvent e) {
<span class="nc" id="L1170">            MouseEvent me = DragRecognitionSupport.mouseReleased(e);</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">            if (me != null) {</span>
<span class="nc" id="L1172">                SwingUtilities2.adjustFocus(table);</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">                if (!dragPressDidSelection) {</span>
<span class="nc" id="L1174">                    adjustSelection(me);</span>
                }
            }

<span class="nc bnc" id="L1178" title="All 2 branches missed.">            if (!dragStarted) {</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">                if (isFileList) {</span>
<span class="nc" id="L1180">                    maybeStartTimer();</span>
<span class="nc" id="L1181">                    return;</span>
                }

<span class="nc" id="L1184">                Point p = e.getPoint();</span>

<span class="nc bnc" id="L1186" title="All 2 branches missed.">                if (pressedEvent != null &amp;&amp;</span>
<span class="nc bnc" id="L1187" title="All 2 branches missed.">                        table.rowAtPoint(p) == pressedRow &amp;&amp;</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">                        table.columnAtPoint(p) == pressedCol &amp;&amp;</span>
<span class="nc bnc" id="L1189" title="All 2 branches missed.">                        table.editCellAt(pressedRow, pressedCol, pressedEvent)) {</span>

<span class="nc" id="L1191">                    setDispatchComponent(pressedEvent);</span>
<span class="nc" id="L1192">                    repostEvent(pressedEvent);</span>

                    // This may appear completely odd, but must be done for backward
                    // compatibility reasons. Developers have been known to rely on
                    // a call to shouldSelectCell after editing has begun.
<span class="nc" id="L1197">                    CellEditor ce = table.getCellEditor();</span>
<span class="nc bnc" id="L1198" title="All 2 branches missed.">                    if (ce != null) {</span>
<span class="nc" id="L1199">                        ce.shouldSelectCell(pressedEvent);</span>
                    }
                }
            }
<span class="nc" id="L1203">        }</span>

<span class="nc" id="L1205">        public void mouseEntered(MouseEvent e) {}</span>

<span class="nc" id="L1207">        public void mouseExited(MouseEvent e) {}</span>

<span class="nc" id="L1209">        public void mouseMoved(MouseEvent e) {}</span>

        public void dragStarting(MouseEvent me) {
<span class="nc" id="L1212">            dragStarted = true;</span>

<span class="nc bnc" id="L1214" title="All 4 branches missed.">            if (BasicGraphicsUtils.isMenuShortcutKeyDown(me) &amp;&amp; isFileList) {</span>
<span class="nc" id="L1215">                table.getSelectionModel().addSelectionInterval(pressedRow,</span>
                                                               pressedRow);
<span class="nc" id="L1217">                table.getColumnModel().getSelectionModel().</span>
<span class="nc" id="L1218">                    addSelectionInterval(pressedCol, pressedCol);</span>
            }

<span class="nc" id="L1221">            pressedEvent = null;</span>
<span class="nc" id="L1222">        }</span>

        public void mouseDragged(MouseEvent e) {
<span class="nc bnc" id="L1225" title="All 2 branches missed.">            if (SwingUtilities2.shouldIgnore(e, table)) {</span>
<span class="nc" id="L1226">                return;</span>
            }

<span class="nc bnc" id="L1229" title="All 2 branches missed.">            if (table.getDragEnabled() &amp;&amp;</span>
<span class="nc bnc" id="L1230" title="All 4 branches missed.">                    (DragRecognitionSupport.mouseDragged(e, this) || dragStarted)) {</span>

<span class="nc" id="L1232">                return;</span>
            }

<span class="nc" id="L1235">            repostEvent(e);</span>

            // Check isFileList:
            // Until we support drag-selection, dragging should not change
            // the selection (act like single-select).
<span class="nc bnc" id="L1240" title="All 4 branches missed.">            if (isFileList || table.isEditing()) {</span>
<span class="nc" id="L1241">                return;</span>
            }

<span class="nc" id="L1244">            Point p = e.getPoint();</span>
<span class="nc" id="L1245">            int row = table.rowAtPoint(p);</span>
<span class="nc" id="L1246">            int column = table.columnAtPoint(p);</span>
            // The autoscroller can generate drag events outside the
            // table's range.
<span class="nc bnc" id="L1249" title="All 4 branches missed.">            if ((column == -1) || (row == -1)) {</span>
<span class="nc" id="L1250">                return;</span>
            }

<span class="nc" id="L1253">            table.changeSelection(row, column,</span>
<span class="nc" id="L1254">                    BasicGraphicsUtils.isMenuShortcutKeyDown(e), true);</span>
<span class="nc" id="L1255">        }</span>


        // PropertyChangeListener
        public void propertyChange(PropertyChangeEvent event) {
<span class="nc" id="L1260">            String changeName = event.getPropertyName();</span>

<span class="nc bnc" id="L1262" title="All 2 branches missed.">            if (&quot;componentOrientation&quot; == changeName) {</span>
<span class="nc" id="L1263">                InputMap inputMap = getInputMap(</span>
                    JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);

<span class="nc" id="L1266">                SwingUtilities.replaceUIInputMap(table,</span>
                    JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT,
                    inputMap);

<span class="nc" id="L1270">                JTableHeader header = table.getTableHeader();</span>
<span class="nc bnc" id="L1271" title="All 2 branches missed.">                if (header != null) {</span>
<span class="nc" id="L1272">                    header.setComponentOrientation(</span>
<span class="nc" id="L1273">                            (ComponentOrientation)event.getNewValue());</span>
                }
<span class="nc bnc" id="L1275" title="All 2 branches missed.">            } else if (&quot;dropLocation&quot; == changeName) {</span>
<span class="nc" id="L1276">                JTable.DropLocation oldValue = (JTable.DropLocation)event.getOldValue();</span>
<span class="nc" id="L1277">                repaintDropLocation(oldValue);</span>
<span class="nc" id="L1278">                repaintDropLocation(table.getDropLocation());</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">            } else if (&quot;Table.isFileList&quot; == changeName) {</span>
<span class="nc" id="L1280">                isFileList = Boolean.TRUE.equals(table.getClientProperty(&quot;Table.isFileList&quot;));</span>
<span class="nc" id="L1281">                table.revalidate();</span>
<span class="nc" id="L1282">                table.repaint();</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">                if (isFileList) {</span>
<span class="nc" id="L1284">                    table.getSelectionModel().addListSelectionListener(getHandler());</span>
                } else {
<span class="nc" id="L1286">                    table.getSelectionModel().removeListSelectionListener(getHandler());</span>
<span class="nc" id="L1287">                    timer = null;</span>
                }
<span class="nc bnc" id="L1289" title="All 2 branches missed.">            } else if (&quot;selectionModel&quot; == changeName) {</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">                if (isFileList) {</span>
<span class="nc" id="L1291">                    ListSelectionModel old = (ListSelectionModel)event.getOldValue();</span>
<span class="nc" id="L1292">                    old.removeListSelectionListener(getHandler());</span>
<span class="nc" id="L1293">                    table.getSelectionModel().addListSelectionListener(getHandler());</span>
                }
            }
<span class="nc" id="L1296">        }</span>

        private void repaintDropLocation(JTable.DropLocation loc) {
<span class="nc bnc" id="L1299" title="All 2 branches missed.">            if (loc == null) {</span>
<span class="nc" id="L1300">                return;</span>
            }

<span class="nc bnc" id="L1303" title="All 4 branches missed.">            if (!loc.isInsertRow() &amp;&amp; !loc.isInsertColumn()) {</span>
<span class="nc" id="L1304">                Rectangle rect = table.getCellRect(loc.getRow(), loc.getColumn(), false);</span>
<span class="nc bnc" id="L1305" title="All 2 branches missed.">                if (rect != null) {</span>
<span class="nc" id="L1306">                    table.repaint(rect);</span>
                }
<span class="nc" id="L1308">                return;</span>
            }

<span class="nc bnc" id="L1311" title="All 2 branches missed.">            if (loc.isInsertRow()) {</span>
<span class="nc" id="L1312">                Rectangle rect = extendRect(getHDropLineRect(loc), true);</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">                if (rect != null) {</span>
<span class="nc" id="L1314">                    table.repaint(rect);</span>
                }
            }

<span class="nc bnc" id="L1318" title="All 2 branches missed.">            if (loc.isInsertColumn()) {</span>
<span class="nc" id="L1319">                Rectangle rect = extendRect(getVDropLineRect(loc), false);</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">                if (rect != null) {</span>
<span class="nc" id="L1321">                    table.repaint(rect);</span>
                }
            }
<span class="nc" id="L1324">        }</span>
    }


    /*
     * Returns true if the given point is outside the preferredSize of the
     * item at the given row of the table.  (Column must be 0).
     * Returns false if the &quot;Table.isFileList&quot; client property is not set.
     */
    private boolean pointOutsidePrefSize(int row, int column, Point p) {
<span class="nc bnc" id="L1334" title="All 2 branches missed.">        if (!isFileList) {</span>
<span class="nc" id="L1335">            return false;</span>
        }

<span class="nc" id="L1338">        return SwingUtilities2.pointOutsidePrefSize(table, row, column, p);</span>
    }

//
//  Factory methods for the Listeners
//

    private Handler getHandler() {
<span class="nc bnc" id="L1346" title="All 2 branches missed.">        if (handler == null) {</span>
<span class="nc" id="L1347">            handler = new Handler();</span>
        }
<span class="nc" id="L1349">        return handler;</span>
    }

    /**
     * Creates the key listener for handling keyboard navigation in the JTable.
     */
    protected KeyListener createKeyListener() {
<span class="nc" id="L1356">        return null;</span>
    }

    /**
     * Creates the focus listener for handling keyboard navigation in the JTable.
     */
    protected FocusListener createFocusListener() {
<span class="nc" id="L1363">        return getHandler();</span>
    }

    /**
     * Creates the mouse listener for the JTable.
     */
    protected MouseInputListener createMouseInputListener() {
<span class="nc" id="L1370">        return getHandler();</span>
    }

//
//  The installation/uninstall procedures and support
//

    public static ComponentUI createUI(JComponent c) {
<span class="nc" id="L1378">        return new BasicTableUI();</span>
    }

//  Installation

    public void installUI(JComponent c) {
<span class="nc" id="L1384">        table = (JTable)c;</span>

<span class="nc" id="L1386">        rendererPane = new CellRendererPane();</span>
<span class="nc" id="L1387">        table.add(rendererPane);</span>
<span class="nc" id="L1388">        installDefaults();</span>
<span class="nc" id="L1389">        installDefaults2();</span>
<span class="nc" id="L1390">        installListeners();</span>
<span class="nc" id="L1391">        installKeyboardActions();</span>
<span class="nc" id="L1392">    }</span>

    /**
     * Initialize JTable properties, e.g. font, foreground, and background.
     * The font, foreground, and background properties are only set if their
     * current value is either null or a UIResource, other properties are set
     * if the current value is null.
     *
     * @see #installUI
     */
    protected void installDefaults() {
<span class="nc" id="L1403">        LookAndFeel.installColorsAndFont(table, &quot;Table.background&quot;,</span>
                                         &quot;Table.foreground&quot;, &quot;Table.font&quot;);
        // JTable's original row height is 16.  To correctly display the
        // contents on Linux we should have set it to 18, Windows 19 and
        // Solaris 20.  As these values vary so much it's too hard to
        // be backward compatable and try to update the row height, we're
        // therefor NOT going to adjust the row height based on font.  If the
        // developer changes the font, it's there responsability to update
        // the row height.

<span class="nc" id="L1413">        LookAndFeel.installProperty(table, &quot;opaque&quot;, Boolean.TRUE);</span>

<span class="nc" id="L1415">        Color sbg = table.getSelectionBackground();</span>
<span class="nc bnc" id="L1416" title="All 4 branches missed.">        if (sbg == null || sbg instanceof UIResource) {</span>
<span class="nc" id="L1417">            sbg = UIManager.getColor(&quot;Table.selectionBackground&quot;);</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">            table.setSelectionBackground(sbg != null ? sbg : UIManager.getColor(&quot;textHighlight&quot;));</span>
        }

<span class="nc" id="L1421">        Color sfg = table.getSelectionForeground();</span>
<span class="nc bnc" id="L1422" title="All 4 branches missed.">        if (sfg == null || sfg instanceof UIResource) {</span>
<span class="nc" id="L1423">            sfg = UIManager.getColor(&quot;Table.selectionForeground&quot;);</span>
<span class="nc bnc" id="L1424" title="All 2 branches missed.">            table.setSelectionForeground(sfg != null ? sfg : UIManager.getColor(&quot;textHighlightText&quot;));</span>
        }

<span class="nc" id="L1427">        Color gridColor = table.getGridColor();</span>
<span class="nc bnc" id="L1428" title="All 4 branches missed.">        if (gridColor == null || gridColor instanceof UIResource) {</span>
<span class="nc" id="L1429">            gridColor = UIManager.getColor(&quot;Table.gridColor&quot;);</span>
<span class="nc bnc" id="L1430" title="All 2 branches missed.">            table.setGridColor(gridColor != null ? gridColor : Color.GRAY);</span>
        }

        // install the scrollpane border
<span class="nc" id="L1434">        Container parent = SwingUtilities.getUnwrappedParent(table);  // should be viewport</span>
<span class="nc bnc" id="L1435" title="All 2 branches missed.">        if (parent != null) {</span>
<span class="nc" id="L1436">            parent = parent.getParent();  // should be the scrollpane</span>
<span class="nc bnc" id="L1437" title="All 4 branches missed.">            if (parent != null &amp;&amp; parent instanceof JScrollPane) {</span>
<span class="nc" id="L1438">                LookAndFeel.installBorder((JScrollPane)parent, &quot;Table.scrollPaneBorder&quot;);</span>
            }
        }

<span class="nc" id="L1442">        isFileList = Boolean.TRUE.equals(table.getClientProperty(&quot;Table.isFileList&quot;));</span>
<span class="nc" id="L1443">    }</span>

    private void installDefaults2() {
<span class="nc" id="L1446">        TransferHandler th = table.getTransferHandler();</span>
<span class="nc bnc" id="L1447" title="All 4 branches missed.">        if (th == null || th instanceof UIResource) {</span>
<span class="nc" id="L1448">            table.setTransferHandler(defaultTransferHandler);</span>
            // default TransferHandler doesn't support drop
            // so we don't want drop handling
<span class="nc bnc" id="L1451" title="All 2 branches missed.">            if (table.getDropTarget() instanceof UIResource) {</span>
<span class="nc" id="L1452">                table.setDropTarget(null);</span>
            }
        }
<span class="nc" id="L1455">    }</span>

    /**
     * Attaches listeners to the JTable.
     */
    protected void installListeners() {
<span class="nc" id="L1461">        focusListener = createFocusListener();</span>
<span class="nc" id="L1462">        keyListener = createKeyListener();</span>
<span class="nc" id="L1463">        mouseInputListener = createMouseInputListener();</span>

<span class="nc" id="L1465">        table.addFocusListener(focusListener);</span>
<span class="nc" id="L1466">        table.addKeyListener(keyListener);</span>
<span class="nc" id="L1467">        table.addMouseListener(mouseInputListener);</span>
<span class="nc" id="L1468">        table.addMouseMotionListener(mouseInputListener);</span>
<span class="nc" id="L1469">        table.addPropertyChangeListener(getHandler());</span>
<span class="nc bnc" id="L1470" title="All 2 branches missed.">        if (isFileList) {</span>
<span class="nc" id="L1471">            table.getSelectionModel().addListSelectionListener(getHandler());</span>
        }
<span class="nc" id="L1473">    }</span>

    /**
     * Register all keyboard actions on the JTable.
     */
    protected void installKeyboardActions() {
<span class="nc" id="L1479">        LazyActionMap.installLazyActionMap(table, BasicTableUI.class,</span>
                &quot;Table.actionMap&quot;);

<span class="nc" id="L1482">        InputMap inputMap = getInputMap(JComponent.</span>
                                        WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
<span class="nc" id="L1484">        SwingUtilities.replaceUIInputMap(table,</span>
                                JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT,
                                inputMap);
<span class="nc" id="L1487">    }</span>

    InputMap getInputMap(int condition) {
<span class="nc bnc" id="L1490" title="All 2 branches missed.">        if (condition == JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT) {</span>
<span class="nc" id="L1491">            InputMap keyMap =</span>
<span class="nc" id="L1492">                (InputMap)DefaultLookup.get(table, this,</span>
                                            &quot;Table.ancestorInputMap&quot;);
            InputMap rtlKeyMap;

<span class="nc bnc" id="L1496" title="All 2 branches missed.">            if (table.getComponentOrientation().isLeftToRight() ||</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">                ((rtlKeyMap = (InputMap)DefaultLookup.get(table, this,</span>
                                            &quot;Table.ancestorInputMap.RightToLeft&quot;)) == null)) {
<span class="nc" id="L1499">                return keyMap;</span>
            } else {
<span class="nc" id="L1501">                rtlKeyMap.setParent(keyMap);</span>
<span class="nc" id="L1502">                return rtlKeyMap;</span>
            }
        }
<span class="nc" id="L1505">        return null;</span>
    }

    static void loadActionMap(LazyActionMap map) {
        // IMPORTANT: There is a very close coupling between the parameters
        // passed to the Actions constructor. Only certain parameter
        // combinations are supported. For example, the following Action would
        // not work as expected:
        //     new Actions(Actions.NEXT_ROW_CELL, 1, 4, false, true)
        // Actions which move within the selection only (having a true
        // inSelection parameter) require that one of dx or dy be
        // zero and the other be -1 or 1. The point of this warning is
        // that you should be very careful about making sure a particular
        // combination of parameters is supported before changing or
        // adding anything here.

<span class="nc" id="L1521">        map.put(new Actions(Actions.NEXT_COLUMN, 1, 0,</span>
                false, false));
<span class="nc" id="L1523">        map.put(new Actions(Actions.NEXT_COLUMN_CHANGE_LEAD, 1, 0,</span>
                false, false));
<span class="nc" id="L1525">        map.put(new Actions(Actions.PREVIOUS_COLUMN, -1, 0,</span>
                false, false));
<span class="nc" id="L1527">        map.put(new Actions(Actions.PREVIOUS_COLUMN_CHANGE_LEAD, -1, 0,</span>
                false, false));
<span class="nc" id="L1529">        map.put(new Actions(Actions.NEXT_ROW, 0, 1,</span>
                false, false));
<span class="nc" id="L1531">        map.put(new Actions(Actions.NEXT_ROW_CHANGE_LEAD, 0, 1,</span>
                false, false));
<span class="nc" id="L1533">        map.put(new Actions(Actions.PREVIOUS_ROW, 0, -1,</span>
                false, false));
<span class="nc" id="L1535">        map.put(new Actions(Actions.PREVIOUS_ROW_CHANGE_LEAD, 0, -1,</span>
                false, false));
<span class="nc" id="L1537">        map.put(new Actions(Actions.NEXT_COLUMN_EXTEND_SELECTION,</span>
                1, 0, true, false));
<span class="nc" id="L1539">        map.put(new Actions(Actions.PREVIOUS_COLUMN_EXTEND_SELECTION,</span>
                -1, 0, true, false));
<span class="nc" id="L1541">        map.put(new Actions(Actions.NEXT_ROW_EXTEND_SELECTION,</span>
                0, 1, true, false));
<span class="nc" id="L1543">        map.put(new Actions(Actions.PREVIOUS_ROW_EXTEND_SELECTION,</span>
                0, -1, true, false));
<span class="nc" id="L1545">        map.put(new Actions(Actions.SCROLL_UP_CHANGE_SELECTION,</span>
                false, false, true, false));
<span class="nc" id="L1547">        map.put(new Actions(Actions.SCROLL_DOWN_CHANGE_SELECTION,</span>
                false, true, true, false));
<span class="nc" id="L1549">        map.put(new Actions(Actions.FIRST_COLUMN,</span>
                false, false, false, true));
<span class="nc" id="L1551">        map.put(new Actions(Actions.LAST_COLUMN,</span>
                false, true, false, true));

<span class="nc" id="L1554">        map.put(new Actions(Actions.SCROLL_UP_EXTEND_SELECTION,</span>
                true, false, true, false));
<span class="nc" id="L1556">        map.put(new Actions(Actions.SCROLL_DOWN_EXTEND_SELECTION,</span>
                true, true, true, false));
<span class="nc" id="L1558">        map.put(new Actions(Actions.FIRST_COLUMN_EXTEND_SELECTION,</span>
                true, false, false, true));
<span class="nc" id="L1560">        map.put(new Actions(Actions.LAST_COLUMN_EXTEND_SELECTION,</span>
                true, true, false, true));

<span class="nc" id="L1563">        map.put(new Actions(Actions.FIRST_ROW, false, false, true, true));</span>
<span class="nc" id="L1564">        map.put(new Actions(Actions.LAST_ROW, false, true, true, true));</span>

<span class="nc" id="L1566">        map.put(new Actions(Actions.FIRST_ROW_EXTEND_SELECTION,</span>
                true, false, true, true));
<span class="nc" id="L1568">        map.put(new Actions(Actions.LAST_ROW_EXTEND_SELECTION,</span>
                true, true, true, true));

<span class="nc" id="L1571">        map.put(new Actions(Actions.NEXT_COLUMN_CELL,</span>
                1, 0, false, true));
<span class="nc" id="L1573">        map.put(new Actions(Actions.PREVIOUS_COLUMN_CELL,</span>
                -1, 0, false, true));
<span class="nc" id="L1575">        map.put(new Actions(Actions.NEXT_ROW_CELL, 0, 1, false, true));</span>
<span class="nc" id="L1576">        map.put(new Actions(Actions.PREVIOUS_ROW_CELL,</span>
                0, -1, false, true));

<span class="nc" id="L1579">        map.put(new Actions(Actions.SELECT_ALL));</span>
<span class="nc" id="L1580">        map.put(new Actions(Actions.CLEAR_SELECTION));</span>
<span class="nc" id="L1581">        map.put(new Actions(Actions.CANCEL_EDITING));</span>
<span class="nc" id="L1582">        map.put(new Actions(Actions.START_EDITING));</span>

<span class="nc" id="L1584">        map.put(TransferHandler.getCutAction().getValue(Action.NAME),</span>
<span class="nc" id="L1585">                TransferHandler.getCutAction());</span>
<span class="nc" id="L1586">        map.put(TransferHandler.getCopyAction().getValue(Action.NAME),</span>
<span class="nc" id="L1587">                TransferHandler.getCopyAction());</span>
<span class="nc" id="L1588">        map.put(TransferHandler.getPasteAction().getValue(Action.NAME),</span>
<span class="nc" id="L1589">                TransferHandler.getPasteAction());</span>

<span class="nc" id="L1591">        map.put(new Actions(Actions.SCROLL_LEFT_CHANGE_SELECTION,</span>
                false, false, false, false));
<span class="nc" id="L1593">        map.put(new Actions(Actions.SCROLL_RIGHT_CHANGE_SELECTION,</span>
                false, true, false, false));
<span class="nc" id="L1595">        map.put(new Actions(Actions.SCROLL_LEFT_EXTEND_SELECTION,</span>
                true, false, false, false));
<span class="nc" id="L1597">        map.put(new Actions(Actions.SCROLL_RIGHT_EXTEND_SELECTION,</span>
                true, true, false, false));

<span class="nc" id="L1600">        map.put(new Actions(Actions.ADD_TO_SELECTION));</span>
<span class="nc" id="L1601">        map.put(new Actions(Actions.TOGGLE_AND_ANCHOR));</span>
<span class="nc" id="L1602">        map.put(new Actions(Actions.EXTEND_TO));</span>
<span class="nc" id="L1603">        map.put(new Actions(Actions.MOVE_SELECTION_TO));</span>
<span class="nc" id="L1604">        map.put(new Actions(Actions.FOCUS_HEADER));</span>
<span class="nc" id="L1605">    }</span>

//  Uninstallation

    public void uninstallUI(JComponent c) {
<span class="nc" id="L1610">        uninstallDefaults();</span>
<span class="nc" id="L1611">        uninstallListeners();</span>
<span class="nc" id="L1612">        uninstallKeyboardActions();</span>

<span class="nc" id="L1614">        table.remove(rendererPane);</span>
<span class="nc" id="L1615">        rendererPane = null;</span>
<span class="nc" id="L1616">        table = null;</span>
<span class="nc" id="L1617">    }</span>

    protected void uninstallDefaults() {
<span class="nc bnc" id="L1620" title="All 2 branches missed.">        if (table.getTransferHandler() instanceof UIResource) {</span>
<span class="nc" id="L1621">            table.setTransferHandler(null);</span>
        }
<span class="nc" id="L1623">    }</span>

    protected void uninstallListeners() {
<span class="nc" id="L1626">        table.removeFocusListener(focusListener);</span>
<span class="nc" id="L1627">        table.removeKeyListener(keyListener);</span>
<span class="nc" id="L1628">        table.removeMouseListener(mouseInputListener);</span>
<span class="nc" id="L1629">        table.removeMouseMotionListener(mouseInputListener);</span>
<span class="nc" id="L1630">        table.removePropertyChangeListener(getHandler());</span>
<span class="nc bnc" id="L1631" title="All 2 branches missed.">        if (isFileList) {</span>
<span class="nc" id="L1632">            table.getSelectionModel().removeListSelectionListener(getHandler());</span>
        }

<span class="nc" id="L1635">        focusListener = null;</span>
<span class="nc" id="L1636">        keyListener = null;</span>
<span class="nc" id="L1637">        mouseInputListener = null;</span>
<span class="nc" id="L1638">        handler = null;</span>
<span class="nc" id="L1639">    }</span>

    protected void uninstallKeyboardActions() {
<span class="nc" id="L1642">        SwingUtilities.replaceUIInputMap(table, JComponent.</span>
                                   WHEN_ANCESTOR_OF_FOCUSED_COMPONENT, null);
<span class="nc" id="L1644">        SwingUtilities.replaceUIActionMap(table, null);</span>
<span class="nc" id="L1645">    }</span>

    /**
     * Returns the baseline.
     *
     * @throws NullPointerException {@inheritDoc}
     * @throws IllegalArgumentException {@inheritDoc}
     * @see javax.swing.JComponent#getBaseline(int, int)
     * @since 1.6
     */
    public int getBaseline(JComponent c, int width, int height) {
<span class="nc" id="L1656">        super.getBaseline(c, width, height);</span>
<span class="nc" id="L1657">        UIDefaults lafDefaults = UIManager.getLookAndFeelDefaults();</span>
<span class="nc" id="L1658">        Component renderer = (Component)lafDefaults.get(</span>
                BASELINE_COMPONENT_KEY);
<span class="nc bnc" id="L1660" title="All 2 branches missed.">        if (renderer == null) {</span>
<span class="nc" id="L1661">            DefaultTableCellRenderer tcr = new DefaultTableCellRenderer();</span>
<span class="nc" id="L1662">            renderer = tcr.getTableCellRendererComponent(</span>
                    table, &quot;a&quot;, false, false, -1, -1);
<span class="nc" id="L1664">            lafDefaults.put(BASELINE_COMPONENT_KEY, renderer);</span>
        }
<span class="nc" id="L1666">        renderer.setFont(table.getFont());</span>
<span class="nc" id="L1667">        int rowMargin = table.getRowMargin();</span>
<span class="nc" id="L1668">        return renderer.getBaseline(Integer.MAX_VALUE, table.getRowHeight() -</span>
                                    rowMargin) + rowMargin / 2;
    }

    /**
     * Returns an enum indicating how the baseline of the component
     * changes as the size changes.
     *
     * @throws NullPointerException {@inheritDoc}
     * @see javax.swing.JComponent#getBaseline(int, int)
     * @since 1.6
     */
    public Component.BaselineResizeBehavior getBaselineResizeBehavior(
            JComponent c) {
<span class="nc" id="L1682">        super.getBaselineResizeBehavior(c);</span>
<span class="nc" id="L1683">        return Component.BaselineResizeBehavior.CONSTANT_ASCENT;</span>
    }

//
// Size Methods
//

    private Dimension createTableSize(long width) {
<span class="nc" id="L1691">        int height = 0;</span>
<span class="nc" id="L1692">        int rowCount = table.getRowCount();</span>
<span class="nc bnc" id="L1693" title="All 4 branches missed.">        if (rowCount &gt; 0 &amp;&amp; table.getColumnCount() &gt; 0) {</span>
<span class="nc" id="L1694">            Rectangle r = table.getCellRect(rowCount-1, 0, true);</span>
<span class="nc" id="L1695">            height = r.y + r.height;</span>
        }
        // Width is always positive. The call to abs() is a workaround for
        // a bug in the 1.1.6 JIT on Windows.
<span class="nc" id="L1699">        long tmp = Math.abs(width);</span>
<span class="nc bnc" id="L1700" title="All 2 branches missed.">        if (tmp &gt; Integer.MAX_VALUE) {</span>
<span class="nc" id="L1701">            tmp = Integer.MAX_VALUE;</span>
        }
<span class="nc" id="L1703">        return new Dimension((int)tmp, height);</span>
    }

    /**
     * Return the minimum size of the table. The minimum height is the
     * row height times the number of rows.
     * The minimum width is the sum of the minimum widths of each column.
     */
    public Dimension getMinimumSize(JComponent c) {
<span class="nc" id="L1712">        long width = 0;</span>
<span class="nc" id="L1713">        Enumeration enumeration = table.getColumnModel().getColumns();</span>
<span class="nc bnc" id="L1714" title="All 2 branches missed.">        while (enumeration.hasMoreElements()) {</span>
<span class="nc" id="L1715">            TableColumn aColumn = (TableColumn)enumeration.nextElement();</span>
<span class="nc" id="L1716">            width = width + aColumn.getMinWidth();</span>
<span class="nc" id="L1717">        }</span>
<span class="nc" id="L1718">        return createTableSize(width);</span>
    }

    /**
     * Return the preferred size of the table. The preferred height is the
     * row height times the number of rows.
     * The preferred width is the sum of the preferred widths of each column.
     */
    public Dimension getPreferredSize(JComponent c) {
<span class="nc" id="L1727">        long width = 0;</span>
<span class="nc" id="L1728">        Enumeration enumeration = table.getColumnModel().getColumns();</span>
<span class="nc bnc" id="L1729" title="All 2 branches missed.">        while (enumeration.hasMoreElements()) {</span>
<span class="nc" id="L1730">            TableColumn aColumn = (TableColumn)enumeration.nextElement();</span>
<span class="nc" id="L1731">            width = width + aColumn.getPreferredWidth();</span>
<span class="nc" id="L1732">        }</span>
<span class="nc" id="L1733">        return createTableSize(width);</span>
    }

    /**
     * Return the maximum size of the table. The maximum height is the
     * row heighttimes the number of rows.
     * The maximum width is the sum of the maximum widths of each column.
     */
    public Dimension getMaximumSize(JComponent c) {
<span class="nc" id="L1742">        long width = 0;</span>
<span class="nc" id="L1743">        Enumeration enumeration = table.getColumnModel().getColumns();</span>
<span class="nc bnc" id="L1744" title="All 2 branches missed.">        while (enumeration.hasMoreElements()) {</span>
<span class="nc" id="L1745">            TableColumn aColumn = (TableColumn)enumeration.nextElement();</span>
<span class="nc" id="L1746">            width = width + aColumn.getMaxWidth();</span>
<span class="nc" id="L1747">        }</span>
<span class="nc" id="L1748">        return createTableSize(width);</span>
    }

//
//  Paint methods and support
//

    /** Paint a representation of the &lt;code&gt;table&lt;/code&gt; instance
     * that was set in installUI().
     */
    public void paint(Graphics g, JComponent c) {
<span class="nc" id="L1759">        Rectangle clip = g.getClipBounds();</span>

<span class="nc" id="L1761">        Rectangle bounds = table.getBounds();</span>
        // account for the fact that the graphics has already been translated
        // into the table's bounds
<span class="nc" id="L1764">        bounds.x = bounds.y = 0;</span>

<span class="nc bnc" id="L1766" title="All 4 branches missed.">        if (table.getRowCount() &lt;= 0 || table.getColumnCount() &lt;= 0 ||</span>
                // this check prevents us from painting the entire table
                // when the clip doesn't intersect our bounds at all
<span class="nc bnc" id="L1769" title="All 2 branches missed.">                !bounds.intersects(clip)) {</span>

<span class="nc" id="L1771">            paintDropLines(g);</span>
<span class="nc" id="L1772">            return;</span>
        }

<span class="nc" id="L1775">        boolean ltr = table.getComponentOrientation().isLeftToRight();</span>

<span class="nc" id="L1777">        Point upperLeft = clip.getLocation();</span>
<span class="nc" id="L1778">        Point lowerRight = new Point(clip.x + clip.width - 1,</span>
                                     clip.y + clip.height - 1);

<span class="nc" id="L1781">        int rMin = table.rowAtPoint(upperLeft);</span>
<span class="nc" id="L1782">        int rMax = table.rowAtPoint(lowerRight);</span>
        // This should never happen (as long as our bounds intersect the clip,
        // which is why we bail above if that is the case).
<span class="nc bnc" id="L1785" title="All 2 branches missed.">        if (rMin == -1) {</span>
<span class="nc" id="L1786">            rMin = 0;</span>
        }
        // If the table does not have enough rows to fill the view we'll get -1.
        // (We could also get -1 if our bounds don't intersect the clip,
        // which is why we bail above if that is the case).
        // Replace this with the index of the last row.
<span class="nc bnc" id="L1792" title="All 2 branches missed.">        if (rMax == -1) {</span>
<span class="nc" id="L1793">            rMax = table.getRowCount()-1;</span>
        }

<span class="nc bnc" id="L1796" title="All 2 branches missed.">        int cMin = table.columnAtPoint(ltr ? upperLeft : lowerRight);</span>
<span class="nc bnc" id="L1797" title="All 2 branches missed.">        int cMax = table.columnAtPoint(ltr ? lowerRight : upperLeft);</span>
        // This should never happen.
<span class="nc bnc" id="L1799" title="All 2 branches missed.">        if (cMin == -1) {</span>
<span class="nc" id="L1800">            cMin = 0;</span>
        }
        // If the table does not have enough columns to fill the view we'll get -1.
        // Replace this with the index of the last column.
<span class="nc bnc" id="L1804" title="All 2 branches missed.">        if (cMax == -1) {</span>
<span class="nc" id="L1805">            cMax = table.getColumnCount()-1;</span>
        }

        // Paint the grid.
<span class="nc" id="L1809">        paintGrid(g, rMin, rMax, cMin, cMax);</span>

        // Paint the cells.
<span class="nc" id="L1812">        paintCells(g, rMin, rMax, cMin, cMax);</span>

<span class="nc" id="L1814">        paintDropLines(g);</span>
<span class="nc" id="L1815">    }</span>

    private void paintDropLines(Graphics g) {
<span class="nc" id="L1818">        JTable.DropLocation loc = table.getDropLocation();</span>
<span class="nc bnc" id="L1819" title="All 2 branches missed.">        if (loc == null) {</span>
<span class="nc" id="L1820">            return;</span>
        }

<span class="nc" id="L1823">        Color color = UIManager.getColor(&quot;Table.dropLineColor&quot;);</span>
<span class="nc" id="L1824">        Color shortColor = UIManager.getColor(&quot;Table.dropLineShortColor&quot;);</span>
<span class="nc bnc" id="L1825" title="All 4 branches missed.">        if (color == null &amp;&amp; shortColor == null) {</span>
<span class="nc" id="L1826">            return;</span>
        }

        Rectangle rect;

<span class="nc" id="L1831">        rect = getHDropLineRect(loc);</span>
<span class="nc bnc" id="L1832" title="All 2 branches missed.">        if (rect != null) {</span>
<span class="nc" id="L1833">            int x = rect.x;</span>
<span class="nc" id="L1834">            int w = rect.width;</span>
<span class="nc bnc" id="L1835" title="All 2 branches missed.">            if (color != null) {</span>
<span class="nc" id="L1836">                extendRect(rect, true);</span>
<span class="nc" id="L1837">                g.setColor(color);</span>
<span class="nc" id="L1838">                g.fillRect(rect.x, rect.y, rect.width, rect.height);</span>
            }
<span class="nc bnc" id="L1840" title="All 4 branches missed.">            if (!loc.isInsertColumn() &amp;&amp; shortColor != null) {</span>
<span class="nc" id="L1841">                g.setColor(shortColor);</span>
<span class="nc" id="L1842">                g.fillRect(x, rect.y, w, rect.height);</span>
            }
        }

<span class="nc" id="L1846">        rect = getVDropLineRect(loc);</span>
<span class="nc bnc" id="L1847" title="All 2 branches missed.">        if (rect != null) {</span>
<span class="nc" id="L1848">            int y = rect.y;</span>
<span class="nc" id="L1849">            int h = rect.height;</span>
<span class="nc bnc" id="L1850" title="All 2 branches missed.">            if (color != null) {</span>
<span class="nc" id="L1851">                extendRect(rect, false);</span>
<span class="nc" id="L1852">                g.setColor(color);</span>
<span class="nc" id="L1853">                g.fillRect(rect.x, rect.y, rect.width, rect.height);</span>
            }
<span class="nc bnc" id="L1855" title="All 4 branches missed.">            if (!loc.isInsertRow() &amp;&amp; shortColor != null) {</span>
<span class="nc" id="L1856">                g.setColor(shortColor);</span>
<span class="nc" id="L1857">                g.fillRect(rect.x, y, rect.width, h);</span>
            }
        }
<span class="nc" id="L1860">    }</span>

    private Rectangle getHDropLineRect(JTable.DropLocation loc) {
<span class="nc bnc" id="L1863" title="All 2 branches missed.">        if (!loc.isInsertRow()) {</span>
<span class="nc" id="L1864">            return null;</span>
        }

<span class="nc" id="L1867">        int row = loc.getRow();</span>
<span class="nc" id="L1868">        int col = loc.getColumn();</span>
<span class="nc bnc" id="L1869" title="All 2 branches missed.">        if (col &gt;= table.getColumnCount()) {</span>
<span class="nc" id="L1870">            col--;</span>
        }

<span class="nc" id="L1873">        Rectangle rect = table.getCellRect(row, col, true);</span>

<span class="nc bnc" id="L1875" title="All 2 branches missed.">        if (row &gt;= table.getRowCount()) {</span>
<span class="nc" id="L1876">            row--;</span>
<span class="nc" id="L1877">            Rectangle prevRect = table.getCellRect(row, col, true);</span>
<span class="nc" id="L1878">            rect.y = prevRect.y + prevRect.height;</span>
        }

<span class="nc bnc" id="L1881" title="All 2 branches missed.">        if (rect.y == 0) {</span>
<span class="nc" id="L1882">            rect.y = -1;</span>
        } else {
<span class="nc" id="L1884">            rect.y -= 2;</span>
        }

<span class="nc" id="L1887">        rect.height = 3;</span>

<span class="nc" id="L1889">        return rect;</span>
    }

    private Rectangle getVDropLineRect(JTable.DropLocation loc) {
<span class="nc bnc" id="L1893" title="All 2 branches missed.">        if (!loc.isInsertColumn()) {</span>
<span class="nc" id="L1894">            return null;</span>
        }

<span class="nc" id="L1897">        boolean ltr = table.getComponentOrientation().isLeftToRight();</span>
<span class="nc" id="L1898">        int col = loc.getColumn();</span>
<span class="nc" id="L1899">        Rectangle rect = table.getCellRect(loc.getRow(), col, true);</span>

<span class="nc bnc" id="L1901" title="All 2 branches missed.">        if (col &gt;= table.getColumnCount()) {</span>
<span class="nc" id="L1902">            col--;</span>
<span class="nc" id="L1903">            rect = table.getCellRect(loc.getRow(), col, true);</span>
<span class="nc bnc" id="L1904" title="All 2 branches missed.">            if (ltr) {</span>
<span class="nc" id="L1905">                rect.x = rect.x + rect.width;</span>
            }
<span class="nc bnc" id="L1907" title="All 2 branches missed.">        } else if (!ltr) {</span>
<span class="nc" id="L1908">            rect.x = rect.x + rect.width;</span>
        }

<span class="nc bnc" id="L1911" title="All 2 branches missed.">        if (rect.x == 0) {</span>
<span class="nc" id="L1912">            rect.x = -1;</span>
        } else {
<span class="nc" id="L1914">            rect.x -= 2;</span>
        }

<span class="nc" id="L1917">        rect.width = 3;</span>

<span class="nc" id="L1919">        return rect;</span>
    }

    private Rectangle extendRect(Rectangle rect, boolean horizontal) {
<span class="nc bnc" id="L1923" title="All 2 branches missed.">        if (rect == null) {</span>
<span class="nc" id="L1924">            return rect;</span>
        }

<span class="nc bnc" id="L1927" title="All 2 branches missed.">        if (horizontal) {</span>
<span class="nc" id="L1928">            rect.x = 0;</span>
<span class="nc" id="L1929">            rect.width = table.getWidth();</span>
        } else {
<span class="nc" id="L1931">            rect.y = 0;</span>

<span class="nc bnc" id="L1933" title="All 2 branches missed.">            if (table.getRowCount() != 0) {</span>
<span class="nc" id="L1934">                Rectangle lastRect = table.getCellRect(table.getRowCount() - 1, 0, true);</span>
<span class="nc" id="L1935">                rect.height = lastRect.y + lastRect.height;</span>
<span class="nc" id="L1936">            } else {</span>
<span class="nc" id="L1937">                rect.height = table.getHeight();</span>
            }
        }

<span class="nc" id="L1941">        return rect;</span>
    }

    /*
     * Paints the grid lines within &lt;I&gt;aRect&lt;/I&gt;, using the grid
     * color set with &lt;I&gt;setGridColor&lt;/I&gt;. Paints vertical lines
     * if &lt;code&gt;getShowVerticalLines()&lt;/code&gt; returns true and paints
     * horizontal lines if &lt;code&gt;getShowHorizontalLines()&lt;/code&gt;
     * returns true.
     */
    private void paintGrid(Graphics g, int rMin, int rMax, int cMin, int cMax) {
<span class="nc" id="L1952">        g.setColor(table.getGridColor());</span>

<span class="nc" id="L1954">        Rectangle minCell = table.getCellRect(rMin, cMin, true);</span>
<span class="nc" id="L1955">        Rectangle maxCell = table.getCellRect(rMax, cMax, true);</span>
<span class="nc" id="L1956">        Rectangle damagedArea = minCell.union( maxCell );</span>

<span class="nc bnc" id="L1958" title="All 2 branches missed.">        if (table.getShowHorizontalLines()) {</span>
<span class="nc" id="L1959">            int tableWidth = damagedArea.x + damagedArea.width;</span>
<span class="nc" id="L1960">            int y = damagedArea.y;</span>
<span class="nc bnc" id="L1961" title="All 2 branches missed.">            for (int row = rMin; row &lt;= rMax; row++) {</span>
<span class="nc" id="L1962">                y += table.getRowHeight(row);</span>
<span class="nc" id="L1963">                g.drawLine(damagedArea.x, y - 1, tableWidth - 1, y - 1);</span>
            }
        }
<span class="nc bnc" id="L1966" title="All 2 branches missed.">        if (table.getShowVerticalLines()) {</span>
<span class="nc" id="L1967">            TableColumnModel cm = table.getColumnModel();</span>
<span class="nc" id="L1968">            int tableHeight = damagedArea.y + damagedArea.height;</span>
            int x;
<span class="nc bnc" id="L1970" title="All 2 branches missed.">            if (table.getComponentOrientation().isLeftToRight()) {</span>
<span class="nc" id="L1971">                x = damagedArea.x;</span>
<span class="nc bnc" id="L1972" title="All 2 branches missed.">                for (int column = cMin; column &lt;= cMax; column++) {</span>
<span class="nc" id="L1973">                    int w = cm.getColumn(column).getWidth();</span>
<span class="nc" id="L1974">                    x += w;</span>
<span class="nc" id="L1975">                    g.drawLine(x - 1, 0, x - 1, tableHeight - 1);</span>
                }
            } else {
<span class="nc" id="L1978">                x = damagedArea.x;</span>
<span class="nc bnc" id="L1979" title="All 2 branches missed.">                for (int column = cMax; column &gt;= cMin; column--) {</span>
<span class="nc" id="L1980">                    int w = cm.getColumn(column).getWidth();</span>
<span class="nc" id="L1981">                    x += w;</span>
<span class="nc" id="L1982">                    g.drawLine(x - 1, 0, x - 1, tableHeight - 1);</span>
                }
            }
        }
<span class="nc" id="L1986">    }</span>

    private int viewIndexForColumn(TableColumn aColumn) {
<span class="nc" id="L1989">        TableColumnModel cm = table.getColumnModel();</span>
<span class="nc bnc" id="L1990" title="All 2 branches missed.">        for (int column = 0; column &lt; cm.getColumnCount(); column++) {</span>
<span class="nc bnc" id="L1991" title="All 2 branches missed.">            if (cm.getColumn(column) == aColumn) {</span>
<span class="nc" id="L1992">                return column;</span>
            }
        }
<span class="nc" id="L1995">        return -1;</span>
    }

    private void paintCells(Graphics g, int rMin, int rMax, int cMin, int cMax) {
<span class="nc" id="L1999">        JTableHeader header = table.getTableHeader();</span>
<span class="nc bnc" id="L2000" title="All 2 branches missed.">        TableColumn draggedColumn = (header == null) ? null : header.getDraggedColumn();</span>

<span class="nc" id="L2002">        TableColumnModel cm = table.getColumnModel();</span>
<span class="nc" id="L2003">        int columnMargin = cm.getColumnMargin();</span>

        Rectangle cellRect;
        TableColumn aColumn;
        int columnWidth;
<span class="nc bnc" id="L2008" title="All 2 branches missed.">        if (table.getComponentOrientation().isLeftToRight()) {</span>
<span class="nc bnc" id="L2009" title="All 2 branches missed.">            for(int row = rMin; row &lt;= rMax; row++) {</span>
<span class="nc" id="L2010">                cellRect = table.getCellRect(row, cMin, false);</span>
<span class="nc bnc" id="L2011" title="All 2 branches missed.">                for(int column = cMin; column &lt;= cMax; column++) {</span>
<span class="nc" id="L2012">                    aColumn = cm.getColumn(column);</span>
<span class="nc" id="L2013">                    columnWidth = aColumn.getWidth();</span>
<span class="nc" id="L2014">                    cellRect.width = columnWidth - columnMargin;</span>
<span class="nc bnc" id="L2015" title="All 2 branches missed.">                    if (aColumn != draggedColumn) {</span>
<span class="nc" id="L2016">                        paintCell(g, cellRect, row, column);</span>
                    }
<span class="nc" id="L2018">                    cellRect.x += columnWidth;</span>
                }
            }
        } else {
<span class="nc bnc" id="L2022" title="All 2 branches missed.">            for(int row = rMin; row &lt;= rMax; row++) {</span>
<span class="nc" id="L2023">                cellRect = table.getCellRect(row, cMin, false);</span>
<span class="nc" id="L2024">                aColumn = cm.getColumn(cMin);</span>
<span class="nc bnc" id="L2025" title="All 2 branches missed.">                if (aColumn != draggedColumn) {</span>
<span class="nc" id="L2026">                    columnWidth = aColumn.getWidth();</span>
<span class="nc" id="L2027">                    cellRect.width = columnWidth - columnMargin;</span>
<span class="nc" id="L2028">                    paintCell(g, cellRect, row, cMin);</span>
                }
<span class="nc bnc" id="L2030" title="All 2 branches missed.">                for(int column = cMin+1; column &lt;= cMax; column++) {</span>
<span class="nc" id="L2031">                    aColumn = cm.getColumn(column);</span>
<span class="nc" id="L2032">                    columnWidth = aColumn.getWidth();</span>
<span class="nc" id="L2033">                    cellRect.width = columnWidth - columnMargin;</span>
<span class="nc" id="L2034">                    cellRect.x -= columnWidth;</span>
<span class="nc bnc" id="L2035" title="All 2 branches missed.">                    if (aColumn != draggedColumn) {</span>
<span class="nc" id="L2036">                        paintCell(g, cellRect, row, column);</span>
                    }
                }
            }
        }

        // Paint the dragged column if we are dragging.
<span class="nc bnc" id="L2043" title="All 2 branches missed.">        if (draggedColumn != null) {</span>
<span class="nc" id="L2044">            paintDraggedArea(g, rMin, rMax, draggedColumn, header.getDraggedDistance());</span>
        }

        // Remove any renderers that may be left in the rendererPane.
<span class="nc" id="L2048">        rendererPane.removeAll();</span>
<span class="nc" id="L2049">    }</span>

    private void paintDraggedArea(Graphics g, int rMin, int rMax, TableColumn draggedColumn, int distance) {
<span class="nc" id="L2052">        int draggedColumnIndex = viewIndexForColumn(draggedColumn);</span>

<span class="nc" id="L2054">        Rectangle minCell = table.getCellRect(rMin, draggedColumnIndex, true);</span>
<span class="nc" id="L2055">        Rectangle maxCell = table.getCellRect(rMax, draggedColumnIndex, true);</span>

<span class="nc" id="L2057">        Rectangle vacatedColumnRect = minCell.union(maxCell);</span>

        // Paint a gray well in place of the moving column.
<span class="nc" id="L2060">        g.setColor(table.getParent().getBackground());</span>
<span class="nc" id="L2061">        g.fillRect(vacatedColumnRect.x, vacatedColumnRect.y,</span>
                   vacatedColumnRect.width, vacatedColumnRect.height);

        // Move to the where the cell has been dragged.
<span class="nc" id="L2065">        vacatedColumnRect.x += distance;</span>

        // Fill the background.
<span class="nc" id="L2068">        g.setColor(table.getBackground());</span>
<span class="nc" id="L2069">        g.fillRect(vacatedColumnRect.x, vacatedColumnRect.y,</span>
                   vacatedColumnRect.width, vacatedColumnRect.height);

        // Paint the vertical grid lines if necessary.
<span class="nc bnc" id="L2073" title="All 2 branches missed.">        if (table.getShowVerticalLines()) {</span>
<span class="nc" id="L2074">            g.setColor(table.getGridColor());</span>
<span class="nc" id="L2075">            int x1 = vacatedColumnRect.x;</span>
<span class="nc" id="L2076">            int y1 = vacatedColumnRect.y;</span>
<span class="nc" id="L2077">            int x2 = x1 + vacatedColumnRect.width - 1;</span>
<span class="nc" id="L2078">            int y2 = y1 + vacatedColumnRect.height - 1;</span>
            // Left
<span class="nc" id="L2080">            g.drawLine(x1-1, y1, x1-1, y2);</span>
            // Right
<span class="nc" id="L2082">            g.drawLine(x2, y1, x2, y2);</span>
        }

<span class="nc bnc" id="L2085" title="All 2 branches missed.">        for(int row = rMin; row &lt;= rMax; row++) {</span>
            // Render the cell value
<span class="nc" id="L2087">            Rectangle r = table.getCellRect(row, draggedColumnIndex, false);</span>
<span class="nc" id="L2088">            r.x += distance;</span>
<span class="nc" id="L2089">            paintCell(g, r, row, draggedColumnIndex);</span>

            // Paint the (lower) horizontal grid line if necessary.
<span class="nc bnc" id="L2092" title="All 2 branches missed.">            if (table.getShowHorizontalLines()) {</span>
<span class="nc" id="L2093">                g.setColor(table.getGridColor());</span>
<span class="nc" id="L2094">                Rectangle rcr = table.getCellRect(row, draggedColumnIndex, true);</span>
<span class="nc" id="L2095">                rcr.x += distance;</span>
<span class="nc" id="L2096">                int x1 = rcr.x;</span>
<span class="nc" id="L2097">                int y1 = rcr.y;</span>
<span class="nc" id="L2098">                int x2 = x1 + rcr.width - 1;</span>
<span class="nc" id="L2099">                int y2 = y1 + rcr.height - 1;</span>
<span class="nc" id="L2100">                g.drawLine(x1, y2, x2, y2);</span>
            }
        }
<span class="nc" id="L2103">    }</span>

    private void paintCell(Graphics g, Rectangle cellRect, int row, int column) {
<span class="nc bnc" id="L2106" title="All 4 branches missed.">        if (table.isEditing() &amp;&amp; table.getEditingRow()==row &amp;&amp;</span>
<span class="nc bnc" id="L2107" title="All 2 branches missed.">                                 table.getEditingColumn()==column) {</span>
<span class="nc" id="L2108">            Component component = table.getEditorComponent();</span>
<span class="nc" id="L2109">            component.setBounds(cellRect);</span>
<span class="nc" id="L2110">            component.validate();</span>
<span class="nc" id="L2111">        }</span>
        else {
<span class="nc" id="L2113">            TableCellRenderer renderer = table.getCellRenderer(row, column);</span>
<span class="nc" id="L2114">            Component component = table.prepareRenderer(renderer, row, column);</span>
<span class="nc" id="L2115">            rendererPane.paintComponent(g, component, table, cellRect.x, cellRect.y,</span>
                                        cellRect.width, cellRect.height, true);
        }
<span class="nc" id="L2118">    }</span>

    private static int getAdjustedLead(JTable table,
                                       boolean row,
                                       ListSelectionModel model) {

<span class="nc" id="L2124">        int index = model.getLeadSelectionIndex();</span>
<span class="nc bnc" id="L2125" title="All 2 branches missed.">        int compare = row ? table.getRowCount() : table.getColumnCount();</span>
<span class="nc bnc" id="L2126" title="All 2 branches missed.">        return index &lt; compare ? index : -1;</span>
    }

    private static int getAdjustedLead(JTable table, boolean row) {
<span class="nc bnc" id="L2130" title="All 2 branches missed.">        return row ? getAdjustedLead(table, row, table.getSelectionModel())</span>
<span class="nc" id="L2131">                   : getAdjustedLead(table, row, table.getColumnModel().getSelectionModel());</span>
    }


<span class="nc" id="L2135">    private static final TransferHandler defaultTransferHandler = new TableTransferHandler();</span>

<span class="nc" id="L2137">    static class TableTransferHandler extends TransferHandler implements UIResource {</span>

        /**
         * Create a Transferable to use as the source for a data transfer.
         *
         * @param c  The component holding the data to be transfered.  This
         *  argument is provided to enable sharing of TransferHandlers by
         *  multiple components.
         * @return  The representation of the data to be transfered.
         *
         */
        protected Transferable createTransferable(JComponent c) {
<span class="nc bnc" id="L2149" title="All 2 branches missed.">            if (c instanceof JTable) {</span>
<span class="nc" id="L2150">                JTable table = (JTable) c;</span>
                int[] rows;
                int[] cols;

<span class="nc bnc" id="L2154" title="All 4 branches missed.">                if (!table.getRowSelectionAllowed() &amp;&amp; !table.getColumnSelectionAllowed()) {</span>
<span class="nc" id="L2155">                    return null;</span>
                }

<span class="nc bnc" id="L2158" title="All 2 branches missed.">                if (!table.getRowSelectionAllowed()) {</span>
<span class="nc" id="L2159">                    int rowCount = table.getRowCount();</span>

<span class="nc" id="L2161">                    rows = new int[rowCount];</span>
<span class="nc bnc" id="L2162" title="All 2 branches missed.">                    for (int counter = 0; counter &lt; rowCount; counter++) {</span>
<span class="nc" id="L2163">                        rows[counter] = counter;</span>
                    }
<span class="nc" id="L2165">                } else {</span>
<span class="nc" id="L2166">                    rows = table.getSelectedRows();</span>
                }

<span class="nc bnc" id="L2169" title="All 2 branches missed.">                if (!table.getColumnSelectionAllowed()) {</span>
<span class="nc" id="L2170">                    int colCount = table.getColumnCount();</span>

<span class="nc" id="L2172">                    cols = new int[colCount];</span>
<span class="nc bnc" id="L2173" title="All 2 branches missed.">                    for (int counter = 0; counter &lt; colCount; counter++) {</span>
<span class="nc" id="L2174">                        cols[counter] = counter;</span>
                    }
<span class="nc" id="L2176">                } else {</span>
<span class="nc" id="L2177">                    cols = table.getSelectedColumns();</span>
                }

<span class="nc bnc" id="L2180" title="All 8 branches missed.">                if (rows == null || cols == null || rows.length == 0 || cols.length == 0) {</span>
<span class="nc" id="L2181">                    return null;</span>
                }

<span class="nc" id="L2184">                StringBuffer plainBuf = new StringBuffer();</span>
<span class="nc" id="L2185">                StringBuffer htmlBuf = new StringBuffer();</span>

<span class="nc" id="L2187">                htmlBuf.append(&quot;&lt;html&gt;\n&lt;body&gt;\n&lt;table&gt;\n&quot;);</span>

<span class="nc bnc" id="L2189" title="All 2 branches missed.">                for (int row = 0; row &lt; rows.length; row++) {</span>
<span class="nc" id="L2190">                    htmlBuf.append(&quot;&lt;tr&gt;\n&quot;);</span>
<span class="nc bnc" id="L2191" title="All 2 branches missed.">                    for (int col = 0; col &lt; cols.length; col++) {</span>
<span class="nc" id="L2192">                        Object obj = table.getValueAt(rows[row], cols[col]);</span>
<span class="nc bnc" id="L2193" title="All 2 branches missed.">                        String val = ((obj == null) ? &quot;&quot; : obj.toString());</span>
<span class="nc" id="L2194">                        plainBuf.append(val + &quot;\t&quot;);</span>
<span class="nc" id="L2195">                        htmlBuf.append(&quot;  &lt;td&gt;&quot; + val + &quot;&lt;/td&gt;\n&quot;);</span>
                    }
                    // we want a newline at the end of each line and not a tab
<span class="nc" id="L2198">                    plainBuf.deleteCharAt(plainBuf.length() - 1).append(&quot;\n&quot;);</span>
<span class="nc" id="L2199">                    htmlBuf.append(&quot;&lt;/tr&gt;\n&quot;);</span>
                }

                // remove the last newline
<span class="nc" id="L2203">                plainBuf.deleteCharAt(plainBuf.length() - 1);</span>
<span class="nc" id="L2204">                htmlBuf.append(&quot;&lt;/table&gt;\n&lt;/body&gt;\n&lt;/html&gt;&quot;);</span>

<span class="nc" id="L2206">                return new BasicTransferable(plainBuf.toString(), htmlBuf.toString());</span>
            }

<span class="nc" id="L2209">            return null;</span>
        }

        public int getSourceActions(JComponent c) {
<span class="nc" id="L2213">            return COPY;</span>
        }

    }
}  // End of Class BasicTableUI
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>