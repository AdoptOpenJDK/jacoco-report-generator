<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BasicComboPopup.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">javax.swing.plaf.basic</a> &gt; <span class="el_source">BasicComboPopup.java</span></div><h1>BasicComboPopup.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1998, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing.plaf.basic;

import javax.accessibility.AccessibleContext;
import javax.swing.*;
import javax.swing.border.Border;
import javax.swing.border.LineBorder;
import javax.swing.event.*;
import java.awt.*;
import java.awt.event.*;
import java.beans.PropertyChangeListener;
import java.beans.PropertyChangeEvent;
import java.io.Serializable;


/**
 * This is a basic implementation of the &lt;code&gt;ComboPopup&lt;/code&gt; interface.
 *
 * This class represents the ui for the popup portion of the combo box.
 * &lt;p&gt;
 * All event handling is handled by listener classes created with the
 * &lt;code&gt;createxxxListener()&lt;/code&gt; methods and internal classes.
 * You can change the behavior of this class by overriding the
 * &lt;code&gt;createxxxListener()&lt;/code&gt; methods and supplying your own
 * event listeners or subclassing from the ones supplied in this class.
 * &lt;p&gt;
 * &lt;strong&gt;Warning:&lt;/strong&gt;
 * Serialized objects of this class will not be compatible with
 * future Swing releases. The current serialization support is
 * appropriate for short term storage or RMI between applications running
 * the same version of Swing.  As of 1.4, support for long term storage
 * of all JavaBeans&amp;trade;
 * has been added to the &lt;code&gt;java.beans&lt;/code&gt; package.
 * Please see {@link java.beans.XMLEncoder}.
 *
 * @author Tom Santos
 * @author Mark Davidson
 */
public class BasicComboPopup extends JPopupMenu implements ComboPopup {
    // An empty ListMode, this is used when the UI changes to allow
    // the JList to be gc'ed.
<span class="nc" id="L66">    private static class EmptyListModelClass implements ListModel&lt;Object&gt;, Serializable {</span>
<span class="nc" id="L67">        public int getSize() { return 0; }</span>
<span class="nc" id="L68">        public Object getElementAt(int index) { return null; }</span>
<span class="nc" id="L69">        public void addListDataListener(ListDataListener l) {}</span>
<span class="nc" id="L70">        public void removeListDataListener(ListDataListener l) {}</span>
    };

<span class="nc" id="L73">    static final ListModel EmptyListModel = new EmptyListModelClass();</span>

<span class="nc" id="L75">    private static Border LIST_BORDER = new LineBorder(Color.BLACK, 1);</span>

    protected JComboBox                comboBox;
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the accessor methods instead.
     *
     * @see #getList
     * @see #createList
     */
    protected JList                    list;
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the create method instead
     *
     * @see #createScroller
     */
    protected JScrollPane              scroller;

    /**
     * As of Java 2 platform v1.4 this previously undocumented field is no
     * longer used.
     */
<span class="nc" id="L98">    protected boolean                  valueIsAdjusting = false;</span>

    // Listeners that are required by the ComboPopup interface

    /**
     * Implementation of all the listener classes.
     */
    private Handler handler;

    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the accessor or create methods instead.
     *
     * @see #getMouseMotionListener
     * @see #createMouseMotionListener
     */
    protected MouseMotionListener      mouseMotionListener;
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the accessor or create methods instead.
     *
     * @see #getMouseListener
     * @see #createMouseListener
     */
    protected MouseListener            mouseListener;

    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the accessor or create methods instead.
     *
     * @see #getKeyListener
     * @see #createKeyListener
     */
    protected KeyListener              keyListener;

    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the create method instead.
     *
     * @see #createListSelectionListener
     */
    protected ListSelectionListener    listSelectionListener;

    // Listeners that are attached to the list
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the create method instead.
     *
     * @see #createListMouseListener
     */
    protected MouseListener            listMouseListener;
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the create method instead
     *
     * @see #createListMouseMotionListener
     */
    protected MouseMotionListener      listMouseMotionListener;

    // Added to the combo box for bound properties
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the create method instead
     *
     * @see #createPropertyChangeListener
     */
    protected PropertyChangeListener   propertyChangeListener;

    // Added to the combo box model
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the create method instead
     *
     * @see #createListDataListener
     */
    protected ListDataListener         listDataListener;

    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Use the create method instead
     *
     * @see #createItemListener
     */
    protected ItemListener             itemListener;

    /**
     * This protected field is implementation specific. Do not access directly
     * or override.
     */
    protected Timer                    autoscrollTimer;
<span class="nc" id="L188">    protected boolean                  hasEntered = false;</span>
<span class="nc" id="L189">    protected boolean                  isAutoScrolling = false;</span>
<span class="nc" id="L190">    protected int                      scrollDirection = SCROLL_UP;</span>

    protected static final int         SCROLL_UP = 0;
    protected static final int         SCROLL_DOWN = 1;


    //========================================
    // begin ComboPopup method implementations
    //

    /**
     * Implementation of ComboPopup.show().
     */
    public void show() {
<span class="nc" id="L204">        comboBox.firePopupMenuWillBecomeVisible();</span>
<span class="nc" id="L205">        setListSelection(comboBox.getSelectedIndex());</span>
<span class="nc" id="L206">        Point location = getPopupLocation();</span>
<span class="nc" id="L207">        show( comboBox, location.x, location.y );</span>
<span class="nc" id="L208">    }</span>


    /**
     * Implementation of ComboPopup.hide().
     */
    public void hide() {
<span class="nc" id="L215">        MenuSelectionManager manager = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L216">        MenuElement [] selection = manager.getSelectedPath();</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        for ( int i = 0 ; i &lt; selection.length ; i++ ) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if ( selection[i] == this ) {</span>
<span class="nc" id="L219">                manager.clearSelectedPath();</span>
<span class="nc" id="L220">                break;</span>
            }
        }
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (selection.length &gt; 0) {</span>
<span class="nc" id="L224">            comboBox.repaint();</span>
        }
<span class="nc" id="L226">    }</span>

    /**
     * Implementation of ComboPopup.getList().
     */
    public JList getList() {
<span class="nc" id="L232">        return list;</span>
    }

    /**
     * Implementation of ComboPopup.getMouseListener().
     *
     * @return a &lt;code&gt;MouseListener&lt;/code&gt; or null
     * @see ComboPopup#getMouseListener
     */
    public MouseListener getMouseListener() {
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (mouseListener == null) {</span>
<span class="nc" id="L243">            mouseListener = createMouseListener();</span>
        }
<span class="nc" id="L245">        return mouseListener;</span>
    }

    /**
     * Implementation of ComboPopup.getMouseMotionListener().
     *
     * @return a &lt;code&gt;MouseMotionListener&lt;/code&gt; or null
     * @see ComboPopup#getMouseMotionListener
     */
    public MouseMotionListener getMouseMotionListener() {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (mouseMotionListener == null) {</span>
<span class="nc" id="L256">            mouseMotionListener = createMouseMotionListener();</span>
        }
<span class="nc" id="L258">        return mouseMotionListener;</span>
    }

    /**
     * Implementation of ComboPopup.getKeyListener().
     *
     * @return a &lt;code&gt;KeyListener&lt;/code&gt; or null
     * @see ComboPopup#getKeyListener
     */
    public KeyListener getKeyListener() {
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (keyListener == null) {</span>
<span class="nc" id="L269">            keyListener = createKeyListener();</span>
        }
<span class="nc" id="L271">        return keyListener;</span>
    }

    /**
     * Called when the UI is uninstalling.  Since this popup isn't in the component
     * tree, it won't get it's uninstallUI() called.  It removes the listeners that
     * were added in addComboBoxListeners().
     */
    public void uninstallingUI() {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (propertyChangeListener != null) {</span>
<span class="nc" id="L281">            comboBox.removePropertyChangeListener( propertyChangeListener );</span>
        }
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (itemListener != null) {</span>
<span class="nc" id="L284">            comboBox.removeItemListener( itemListener );</span>
        }
<span class="nc" id="L286">        uninstallComboBoxModelListeners(comboBox.getModel());</span>
<span class="nc" id="L287">        uninstallKeyboardActions();</span>
<span class="nc" id="L288">        uninstallListListeners();</span>
        // We do this, otherwise the listener the ui installs on
        // the model (the combobox model in this case) will keep a
        // reference to the list, causing the list (and us) to never get gced.
<span class="nc" id="L292">        list.setModel(EmptyListModel);</span>
<span class="nc" id="L293">    }</span>

    //
    // end ComboPopup method implementations
    //======================================

    /**
     * Removes the listeners from the combo box model
     *
     * @param model The combo box model to install listeners
     * @see #installComboBoxModelListeners
     */
    protected void uninstallComboBoxModelListeners( ComboBoxModel model ) {
<span class="nc bnc" id="L306" title="All 4 branches missed.">        if (model != null &amp;&amp; listDataListener != null) {</span>
<span class="nc" id="L307">            model.removeListDataListener(listDataListener);</span>
        }
<span class="nc" id="L309">    }</span>

    protected void uninstallKeyboardActions() {
        // XXX - shouldn't call this method
//        comboBox.unregisterKeyboardAction( KeyStroke.getKeyStroke( KeyEvent.VK_ENTER, 0 ) );
<span class="nc" id="L314">    }</span>



    //===================================================================
    // begin Initialization routines
    //
    public BasicComboPopup( JComboBox combo ) {
<span class="nc" id="L322">        super();</span>
<span class="nc" id="L323">        setName(&quot;ComboPopup.popup&quot;);</span>
<span class="nc" id="L324">        comboBox = combo;</span>

<span class="nc" id="L326">        setLightWeightPopupEnabled( comboBox.isLightWeightPopupEnabled() );</span>

        // UI construction of the popup.
<span class="nc" id="L329">        list = createList();</span>
<span class="nc" id="L330">        list.setName(&quot;ComboBox.list&quot;);</span>
<span class="nc" id="L331">        configureList();</span>
<span class="nc" id="L332">        scroller = createScroller();</span>
<span class="nc" id="L333">        scroller.setName(&quot;ComboBox.scrollPane&quot;);</span>
<span class="nc" id="L334">        configureScroller();</span>
<span class="nc" id="L335">        configurePopup();</span>

<span class="nc" id="L337">        installComboBoxListeners();</span>
<span class="nc" id="L338">        installKeyboardActions();</span>
<span class="nc" id="L339">    }</span>

    // Overriden PopupMenuListener notification methods to inform combo box
    // PopupMenuListeners.

    protected void firePopupMenuWillBecomeVisible() {
<span class="nc" id="L345">        super.firePopupMenuWillBecomeVisible();</span>
        // comboBox.firePopupMenuWillBecomeVisible() is called from BasicComboPopup.show() method
        // to let the user change the popup menu from the PopupMenuListener.popupMenuWillBecomeVisible()
<span class="nc" id="L348">    }</span>

    protected void firePopupMenuWillBecomeInvisible() {
<span class="nc" id="L351">        super.firePopupMenuWillBecomeInvisible();</span>
<span class="nc" id="L352">        comboBox.firePopupMenuWillBecomeInvisible();</span>
<span class="nc" id="L353">    }</span>

    protected void firePopupMenuCanceled() {
<span class="nc" id="L356">        super.firePopupMenuCanceled();</span>
<span class="nc" id="L357">        comboBox.firePopupMenuCanceled();</span>
<span class="nc" id="L358">    }</span>

    /**
     * Creates a listener
     * that will watch for mouse-press and release events on the combo box.
     *
     * &lt;strong&gt;Warning:&lt;/strong&gt;
     * When overriding this method, make sure to maintain the existing
     * behavior.
     *
     * @return a &lt;code&gt;MouseListener&lt;/code&gt; which will be added to
     * the combo box or null
     */
    protected MouseListener createMouseListener() {
<span class="nc" id="L372">        return getHandler();</span>
    }

    /**
     * Creates the mouse motion listener which will be added to the combo
     * box.
     *
     * &lt;strong&gt;Warning:&lt;/strong&gt;
     * When overriding this method, make sure to maintain the existing
     * behavior.
     *
     * @return a &lt;code&gt;MouseMotionListener&lt;/code&gt; which will be added to
     *         the combo box or null
     */
    protected MouseMotionListener createMouseMotionListener() {
<span class="nc" id="L387">        return getHandler();</span>
    }

    /**
     * Creates the key listener that will be added to the combo box. If
     * this method returns null then it will not be added to the combo box.
     *
     * @return a &lt;code&gt;KeyListener&lt;/code&gt; or null
     */
    protected KeyListener createKeyListener() {
<span class="nc" id="L397">        return null;</span>
    }

    /**
     * Creates a list selection listener that watches for selection changes in
     * the popup's list.  If this method returns null then it will not
     * be added to the popup list.
     *
     * @return an instance of a &lt;code&gt;ListSelectionListener&lt;/code&gt; or null
     */
    protected ListSelectionListener createListSelectionListener() {
<span class="nc" id="L408">        return null;</span>
    }

    /**
     * Creates a list data listener which will be added to the
     * &lt;code&gt;ComboBoxModel&lt;/code&gt;. If this method returns null then
     * it will not be added to the combo box model.
     *
     * @return an instance of a &lt;code&gt;ListDataListener&lt;/code&gt; or null
     */
    protected ListDataListener createListDataListener() {
<span class="nc" id="L419">        return null;</span>
    }

    /**
     * Creates a mouse listener that watches for mouse events in
     * the popup's list. If this method returns null then it will
     * not be added to the combo box.
     *
     * @return an instance of a &lt;code&gt;MouseListener&lt;/code&gt; or null
     */
    protected MouseListener createListMouseListener() {
<span class="nc" id="L430">        return getHandler();</span>
    }

    /**
     * Creates a mouse motion listener that watches for mouse motion
     * events in the popup's list. If this method returns null then it will
     * not be added to the combo box.
     *
     * @return an instance of a &lt;code&gt;MouseMotionListener&lt;/code&gt; or null
     */
    protected MouseMotionListener createListMouseMotionListener() {
<span class="nc" id="L441">        return getHandler();</span>
    }

    /**
     * Creates a &lt;code&gt;PropertyChangeListener&lt;/code&gt; which will be added to
     * the combo box. If this method returns null then it will not
     * be added to the combo box.
     *
     * @return an instance of a &lt;code&gt;PropertyChangeListener&lt;/code&gt; or null
     */
    protected PropertyChangeListener createPropertyChangeListener() {
<span class="nc" id="L452">        return getHandler();</span>
    }

    /**
     * Creates an &lt;code&gt;ItemListener&lt;/code&gt; which will be added to the
     * combo box. If this method returns null then it will not
     * be added to the combo box.
     * &lt;p&gt;
     * Subclasses may override this method to return instances of their own
     * ItemEvent handlers.
     *
     * @return an instance of an &lt;code&gt;ItemListener&lt;/code&gt; or null
     */
    protected ItemListener createItemListener() {
<span class="nc" id="L466">        return getHandler();</span>
    }

    private Handler getHandler() {
<span class="nc bnc" id="L470" title="All 2 branches missed.">        if (handler == null) {</span>
<span class="nc" id="L471">            handler = new Handler();</span>
        }
<span class="nc" id="L473">        return handler;</span>
    }

    /**
     * Creates the JList used in the popup to display
     * the items in the combo box model. This method is called when the UI class
     * is created.
     *
     * @return a &lt;code&gt;JList&lt;/code&gt; used to display the combo box items
     */
    protected JList createList() {
<span class="nc" id="L484">        return new JList( comboBox.getModel() ) {</span>
            public void processMouseEvent(MouseEvent e)  {
<span class="nc bnc" id="L486" title="All 2 branches missed.">                if (BasicGraphicsUtils.isMenuShortcutKeyDown(e))  {</span>
                    // Fix for 4234053. Filter out the Control Key from the list.
                    // ie., don't allow CTRL key deselection.
<span class="nc" id="L489">                    Toolkit toolkit = Toolkit.getDefaultToolkit();</span>
<span class="nc" id="L490">                    e = new MouseEvent((Component)e.getSource(), e.getID(), e.getWhen(),</span>
<span class="nc" id="L491">                                       e.getModifiers() ^ toolkit.getMenuShortcutKeyMask(),</span>
<span class="nc" id="L492">                                       e.getX(), e.getY(),</span>
<span class="nc" id="L493">                                       e.getXOnScreen(), e.getYOnScreen(),</span>
<span class="nc" id="L494">                                       e.getClickCount(),</span>
<span class="nc" id="L495">                                       e.isPopupTrigger(),</span>
                                       MouseEvent.NOBUTTON);
                }
<span class="nc" id="L498">                super.processMouseEvent(e);</span>
<span class="nc" id="L499">            }</span>
        };
    }

    /**
     * Configures the list which is used to hold the combo box items in the
     * popup. This method is called when the UI class
     * is created.
     *
     * @see #createList
     */
    protected void configureList() {
<span class="nc" id="L511">        list.setFont( comboBox.getFont() );</span>
<span class="nc" id="L512">        list.setForeground( comboBox.getForeground() );</span>
<span class="nc" id="L513">        list.setBackground( comboBox.getBackground() );</span>
<span class="nc" id="L514">        list.setSelectionForeground( UIManager.getColor( &quot;ComboBox.selectionForeground&quot; ) );</span>
<span class="nc" id="L515">        list.setSelectionBackground( UIManager.getColor( &quot;ComboBox.selectionBackground&quot; ) );</span>
<span class="nc" id="L516">        list.setBorder( null );</span>
<span class="nc" id="L517">        list.setCellRenderer( comboBox.getRenderer() );</span>
<span class="nc" id="L518">        list.setFocusable( false );</span>
<span class="nc" id="L519">        list.setSelectionMode( ListSelectionModel.SINGLE_SELECTION );</span>
<span class="nc" id="L520">        setListSelection( comboBox.getSelectedIndex() );</span>
<span class="nc" id="L521">        installListListeners();</span>
<span class="nc" id="L522">    }</span>

    /**
     * Adds the listeners to the list control.
     */
    protected void installListListeners() {
<span class="nc bnc" id="L528" title="All 2 branches missed.">        if ((listMouseListener = createListMouseListener()) != null) {</span>
<span class="nc" id="L529">            list.addMouseListener( listMouseListener );</span>
        }
<span class="nc bnc" id="L531" title="All 2 branches missed.">        if ((listMouseMotionListener = createListMouseMotionListener()) != null) {</span>
<span class="nc" id="L532">            list.addMouseMotionListener( listMouseMotionListener );</span>
        }
<span class="nc bnc" id="L534" title="All 2 branches missed.">        if ((listSelectionListener = createListSelectionListener()) != null) {</span>
<span class="nc" id="L535">            list.addListSelectionListener( listSelectionListener );</span>
        }
<span class="nc" id="L537">    }</span>

    void uninstallListListeners() {
<span class="nc bnc" id="L540" title="All 2 branches missed.">        if (listMouseListener != null) {</span>
<span class="nc" id="L541">            list.removeMouseListener(listMouseListener);</span>
<span class="nc" id="L542">            listMouseListener = null;</span>
        }
<span class="nc bnc" id="L544" title="All 2 branches missed.">        if (listMouseMotionListener != null) {</span>
<span class="nc" id="L545">            list.removeMouseMotionListener(listMouseMotionListener);</span>
<span class="nc" id="L546">            listMouseMotionListener = null;</span>
        }
<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (listSelectionListener != null) {</span>
<span class="nc" id="L549">            list.removeListSelectionListener(listSelectionListener);</span>
<span class="nc" id="L550">            listSelectionListener = null;</span>
        }
<span class="nc" id="L552">        handler = null;</span>
<span class="nc" id="L553">    }</span>

    /**
     * Creates the scroll pane which houses the scrollable list.
     */
    protected JScrollPane createScroller() {
<span class="nc" id="L559">        JScrollPane sp = new JScrollPane( list,</span>
                                ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,
                                ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER );
<span class="nc" id="L562">        sp.setHorizontalScrollBar(null);</span>
<span class="nc" id="L563">        return sp;</span>
    }

    /**
     * Configures the scrollable portion which holds the list within
     * the combo box popup. This method is called when the UI class
     * is created.
     */
    protected void configureScroller() {
<span class="nc" id="L572">        scroller.setFocusable( false );</span>
<span class="nc" id="L573">        scroller.getVerticalScrollBar().setFocusable( false );</span>
<span class="nc" id="L574">        scroller.setBorder( null );</span>
<span class="nc" id="L575">    }</span>

    /**
     * Configures the popup portion of the combo box. This method is called
     * when the UI class is created.
     */
    protected void configurePopup() {
<span class="nc" id="L582">        setLayout( new BoxLayout( this, BoxLayout.Y_AXIS ) );</span>
<span class="nc" id="L583">        setBorderPainted( true );</span>
<span class="nc" id="L584">        setBorder(LIST_BORDER);</span>
<span class="nc" id="L585">        setOpaque( false );</span>
<span class="nc" id="L586">        add( scroller );</span>
<span class="nc" id="L587">        setDoubleBuffered( true );</span>
<span class="nc" id="L588">        setFocusable( false );</span>
<span class="nc" id="L589">    }</span>

    /**
     * This method adds the necessary listeners to the JComboBox.
     */
    protected void installComboBoxListeners() {
<span class="nc bnc" id="L595" title="All 2 branches missed.">        if ((propertyChangeListener = createPropertyChangeListener()) != null) {</span>
<span class="nc" id="L596">            comboBox.addPropertyChangeListener(propertyChangeListener);</span>
        }
<span class="nc bnc" id="L598" title="All 2 branches missed.">        if ((itemListener = createItemListener()) != null) {</span>
<span class="nc" id="L599">            comboBox.addItemListener(itemListener);</span>
        }
<span class="nc" id="L601">        installComboBoxModelListeners(comboBox.getModel());</span>
<span class="nc" id="L602">    }</span>

    /**
     * Installs the listeners on the combo box model. Any listeners installed
     * on the combo box model should be removed in
     * &lt;code&gt;uninstallComboBoxModelListeners&lt;/code&gt;.
     *
     * @param model The combo box model to install listeners
     * @see #uninstallComboBoxModelListeners
     */
    protected void installComboBoxModelListeners( ComboBoxModel model ) {
<span class="nc bnc" id="L613" title="All 4 branches missed.">        if (model != null &amp;&amp; (listDataListener = createListDataListener()) != null) {</span>
<span class="nc" id="L614">            model.addListDataListener(listDataListener);</span>
        }
<span class="nc" id="L616">    }</span>

    protected void installKeyboardActions() {

        /* XXX - shouldn't call this method. take it out for testing.
        ActionListener action = new ActionListener() {
            public void actionPerformed(ActionEvent e){
            }
        };

        comboBox.registerKeyboardAction( action,
                                         KeyStroke.getKeyStroke( KeyEvent.VK_ENTER, 0 ),
                                         JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT ); */

<span class="nc" id="L630">    }</span>

    //
    // end Initialization routines
    //=================================================================


    //===================================================================
    // begin Event Listenters
    //

    /**
     * A listener to be registered upon the combo box
     * (&lt;em&gt;not&lt;/em&gt; its popup menu)
     * to handle mouse events
     * that affect the state of the popup menu.
     * The main purpose of this listener is to make the popup menu
     * appear and disappear.
     * This listener also helps
     * with click-and-drag scenarios by setting the selection if the mouse was
     * released over the list during a drag.
     *
     * &lt;p&gt;
     * &lt;strong&gt;Warning:&lt;/strong&gt;
     * We recommend that you &lt;em&gt;not&lt;/em&gt;
     * create subclasses of this class.
     * If you absolutely must create a subclass,
     * be sure to invoke the superclass
     * version of each method.
     *
     * @see BasicComboPopup#createMouseListener
     */
<span class="nc" id="L662">    protected class InvocationMouseHandler extends MouseAdapter {</span>
        /**
         * Responds to mouse-pressed events on the combo box.
         *
         * @param e the mouse-press event to be handled
         */
        public void mousePressed( MouseEvent e ) {
<span class="nc" id="L669">            getHandler().mousePressed(e);</span>
<span class="nc" id="L670">        }</span>

        /**
         * Responds to the user terminating
         * a click or drag that began on the combo box.
         *
         * @param e the mouse-release event to be handled
         */
        public void mouseReleased( MouseEvent e ) {
<span class="nc" id="L679">            getHandler().mouseReleased(e);</span>
<span class="nc" id="L680">        }</span>
    }

    /**
     * This listener watches for dragging and updates the current selection in the
     * list if it is dragging over the list.
     */
<span class="nc" id="L687">    protected class InvocationMouseMotionHandler extends MouseMotionAdapter {</span>
        public void mouseDragged( MouseEvent e ) {
<span class="nc" id="L689">            getHandler().mouseDragged(e);</span>
<span class="nc" id="L690">        }</span>
    }

    /**
     * As of Java 2 platform v 1.4, this class is now obsolete and is only included for
     * backwards API compatibility. Do not instantiate or subclass.
     * &lt;p&gt;
     * All the functionality of this class has been included in
     * BasicComboBoxUI ActionMap/InputMap methods.
     */
<span class="nc" id="L700">    public class InvocationKeyHandler extends KeyAdapter {</span>
<span class="nc" id="L701">        public void keyReleased( KeyEvent e ) {}</span>
    }

    /**
     * As of Java 2 platform v 1.4, this class is now obsolete, doesn't do anything, and
     * is only included for backwards API compatibility. Do not call or
     * override.
     */
<span class="nc" id="L709">    protected class ListSelectionHandler implements ListSelectionListener {</span>
<span class="nc" id="L710">        public void valueChanged( ListSelectionEvent e ) {}</span>
    }

    /**
     * As of 1.4, this class is now obsolete, doesn't do anything, and
     * is only included for backwards API compatibility. Do not call or
     * override.
     * &lt;p&gt;
     * The functionality has been migrated into &lt;code&gt;ItemHandler&lt;/code&gt;.
     *
     * @see #createItemListener
     */
<span class="nc" id="L722">    public class ListDataHandler implements ListDataListener {</span>
<span class="nc" id="L723">        public void contentsChanged( ListDataEvent e ) {}</span>

        public void intervalAdded( ListDataEvent e ) {
<span class="nc" id="L726">        }</span>

        public void intervalRemoved( ListDataEvent e ) {
<span class="nc" id="L729">        }</span>
    }

    /**
     * This listener hides the popup when the mouse is released in the list.
     */
<span class="nc" id="L735">    protected class ListMouseHandler extends MouseAdapter {</span>
        public void mousePressed( MouseEvent e ) {
<span class="nc" id="L737">        }</span>
        public void mouseReleased(MouseEvent anEvent) {
<span class="nc" id="L739">            getHandler().mouseReleased(anEvent);</span>
<span class="nc" id="L740">        }</span>
    }

    /**
     * This listener changes the selected item as you move the mouse over the list.
     * The selection change is not committed to the model, this is for user feedback only.
     */
<span class="nc" id="L747">    protected class ListMouseMotionHandler extends MouseMotionAdapter {</span>
        public void mouseMoved( MouseEvent anEvent ) {
<span class="nc" id="L749">            getHandler().mouseMoved(anEvent);</span>
<span class="nc" id="L750">        }</span>
    }

    /**
     * This listener watches for changes to the selection in the
     * combo box.
     */
<span class="nc" id="L757">    protected class ItemHandler implements ItemListener {</span>
        public void itemStateChanged( ItemEvent e ) {
<span class="nc" id="L759">            getHandler().itemStateChanged(e);</span>
<span class="nc" id="L760">        }</span>
    }

    /**
     * This listener watches for bound properties that have changed in the
     * combo box.
     * &lt;p&gt;
     * Subclasses which wish to listen to combo box property changes should
     * call the superclass methods to ensure that the combo popup correctly
     * handles property changes.
     *
     * @see #createPropertyChangeListener
     */
<span class="nc" id="L773">    protected class PropertyChangeHandler implements PropertyChangeListener {</span>
        public void propertyChange( PropertyChangeEvent e ) {
<span class="nc" id="L775">            getHandler().propertyChange(e);</span>
<span class="nc" id="L776">        }</span>
    }


    private class AutoScrollActionHandler implements ActionListener {
        private int direction;

<span class="nc" id="L783">        AutoScrollActionHandler(int direction) {</span>
<span class="nc" id="L784">            this.direction = direction;</span>
<span class="nc" id="L785">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L788" title="All 2 branches missed.">            if (direction == SCROLL_UP) {</span>
<span class="nc" id="L789">                autoScrollUp();</span>
            }
            else {
<span class="nc" id="L792">                autoScrollDown();</span>
            }
<span class="nc" id="L794">        }</span>
    }


<span class="nc" id="L798">    private class Handler implements ItemListener, MouseListener,</span>
                          MouseMotionListener, PropertyChangeListener,
                          Serializable {
        //
        // MouseListener
        // NOTE: this is added to both the JList and JComboBox
        //
        public void mouseClicked(MouseEvent e) {
<span class="nc" id="L806">        }</span>

        public void mousePressed(MouseEvent e) {
<span class="nc bnc" id="L809" title="All 2 branches missed.">            if (e.getSource() == list) {</span>
<span class="nc" id="L810">                return;</span>
            }
<span class="nc bnc" id="L812" title="All 4 branches missed.">            if (!SwingUtilities.isLeftMouseButton(e) || !comboBox.isEnabled())</span>
<span class="nc" id="L813">                return;</span>

<span class="nc bnc" id="L815" title="All 2 branches missed.">            if ( comboBox.isEditable() ) {</span>
<span class="nc" id="L816">                Component comp = comboBox.getEditor().getEditorComponent();</span>
<span class="nc bnc" id="L817" title="All 4 branches missed.">                if ((!(comp instanceof JComponent)) || ((JComponent)comp).isRequestFocusEnabled()) {</span>
<span class="nc" id="L818">                    comp.requestFocus();</span>
                }
<span class="nc" id="L820">            }</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">            else if (comboBox.isRequestFocusEnabled()) {</span>
<span class="nc" id="L822">                comboBox.requestFocus();</span>
            }
<span class="nc" id="L824">            togglePopup();</span>
<span class="nc" id="L825">        }</span>

        public void mouseReleased(MouseEvent e) {
<span class="nc bnc" id="L828" title="All 2 branches missed.">            if (e.getSource() == list) {</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                if (list.getModel().getSize() &gt; 0) {</span>
                    // JList mouse listener
<span class="nc bnc" id="L831" title="All 2 branches missed.">                    if (comboBox.getSelectedIndex() == list.getSelectedIndex()) {</span>
<span class="nc" id="L832">                        comboBox.getEditor().setItem(list.getSelectedValue());</span>
                    }
<span class="nc" id="L834">                    comboBox.setSelectedIndex(list.getSelectedIndex());</span>
                }
<span class="nc" id="L836">                comboBox.setPopupVisible(false);</span>
                // workaround for cancelling an edited item (bug 4530953)
<span class="nc bnc" id="L838" title="All 4 branches missed.">                if (comboBox.isEditable() &amp;&amp; comboBox.getEditor() != null) {</span>
<span class="nc" id="L839">                    comboBox.configureEditor(comboBox.getEditor(),</span>
<span class="nc" id="L840">                                             comboBox.getSelectedItem());</span>
                }
<span class="nc" id="L842">                return;</span>
            }
            // JComboBox mouse listener
<span class="nc" id="L845">            Component source = (Component)e.getSource();</span>
<span class="nc" id="L846">            Dimension size = source.getSize();</span>
<span class="nc" id="L847">            Rectangle bounds = new Rectangle( 0, 0, size.width - 1, size.height - 1 );</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">            if ( !bounds.contains( e.getPoint() ) ) {</span>
<span class="nc" id="L849">                MouseEvent newEvent = convertMouseEvent( e );</span>
<span class="nc" id="L850">                Point location = newEvent.getPoint();</span>
<span class="nc" id="L851">                Rectangle r = new Rectangle();</span>
<span class="nc" id="L852">                list.computeVisibleRect( r );</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">                if ( r.contains( location ) ) {</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">                    if (comboBox.getSelectedIndex() == list.getSelectedIndex()) {</span>
<span class="nc" id="L855">                        comboBox.getEditor().setItem(list.getSelectedValue());</span>
                    }
<span class="nc" id="L857">                    comboBox.setSelectedIndex(list.getSelectedIndex());</span>
                }
<span class="nc" id="L859">                comboBox.setPopupVisible(false);</span>
            }
<span class="nc" id="L861">            hasEntered = false;</span>
<span class="nc" id="L862">            stopAutoScrolling();</span>
<span class="nc" id="L863">        }</span>

        public void mouseEntered(MouseEvent e) {
<span class="nc" id="L866">        }</span>

        public void mouseExited(MouseEvent e) {
<span class="nc" id="L869">        }</span>

        //
        // MouseMotionListener:
        // NOTE: this is added to both the List and ComboBox
        //
        public void mouseMoved(MouseEvent anEvent) {
<span class="nc bnc" id="L876" title="All 2 branches missed.">            if (anEvent.getSource() == list) {</span>
<span class="nc" id="L877">                Point location = anEvent.getPoint();</span>
<span class="nc" id="L878">                Rectangle r = new Rectangle();</span>
<span class="nc" id="L879">                list.computeVisibleRect( r );</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">                if ( r.contains( location ) ) {</span>
<span class="nc" id="L881">                    updateListBoxSelectionForEvent( anEvent, false );</span>
                }
            }
<span class="nc" id="L884">        }</span>

        public void mouseDragged( MouseEvent e ) {
<span class="nc bnc" id="L887" title="All 2 branches missed.">            if (e.getSource() == list) {</span>
<span class="nc" id="L888">                return;</span>
            }
<span class="nc bnc" id="L890" title="All 2 branches missed.">            if ( isVisible() ) {</span>
<span class="nc" id="L891">                MouseEvent newEvent = convertMouseEvent( e );</span>
<span class="nc" id="L892">                Rectangle r = new Rectangle();</span>
<span class="nc" id="L893">                list.computeVisibleRect( r );</span>

<span class="nc bnc" id="L895" title="All 4 branches missed.">                if ( newEvent.getPoint().y &gt;= r.y &amp;&amp; newEvent.getPoint().y &lt;= r.y + r.height - 1 ) {</span>
<span class="nc" id="L896">                    hasEntered = true;</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">                    if ( isAutoScrolling ) {</span>
<span class="nc" id="L898">                        stopAutoScrolling();</span>
                    }
<span class="nc" id="L900">                    Point location = newEvent.getPoint();</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">                    if ( r.contains( location ) ) {</span>
<span class="nc" id="L902">                        updateListBoxSelectionForEvent( newEvent, false );</span>
                    }
<span class="nc" id="L904">                }</span>
                else {
<span class="nc bnc" id="L906" title="All 2 branches missed.">                    if ( hasEntered ) {</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">                        int directionToScroll = newEvent.getPoint().y &lt; r.y ? SCROLL_UP : SCROLL_DOWN;</span>
<span class="nc bnc" id="L908" title="All 4 branches missed.">                        if ( isAutoScrolling &amp;&amp; scrollDirection != directionToScroll ) {</span>
<span class="nc" id="L909">                            stopAutoScrolling();</span>
<span class="nc" id="L910">                            startAutoScrolling( directionToScroll );</span>
                        }
<span class="nc bnc" id="L912" title="All 2 branches missed.">                        else if ( !isAutoScrolling ) {</span>
<span class="nc" id="L913">                            startAutoScrolling( directionToScroll );</span>
                        }
<span class="nc" id="L915">                    }</span>
                    else {
<span class="nc bnc" id="L917" title="All 2 branches missed.">                        if ( e.getPoint().y &lt; 0 ) {</span>
<span class="nc" id="L918">                            hasEntered = true;</span>
<span class="nc" id="L919">                            startAutoScrolling( SCROLL_UP );</span>
                        }
                    }
                }
            }
<span class="nc" id="L924">        }</span>

        //
        // PropertyChangeListener
        //
        public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L930">            JComboBox comboBox = (JComboBox)e.getSource();</span>
<span class="nc" id="L931">            String propertyName = e.getPropertyName();</span>

<span class="nc bnc" id="L933" title="All 2 branches missed.">            if ( propertyName == &quot;model&quot; ) {</span>
<span class="nc" id="L934">                ComboBoxModel oldModel = (ComboBoxModel)e.getOldValue();</span>
<span class="nc" id="L935">                ComboBoxModel newModel = (ComboBoxModel)e.getNewValue();</span>
<span class="nc" id="L936">                uninstallComboBoxModelListeners(oldModel);</span>
<span class="nc" id="L937">                installComboBoxModelListeners(newModel);</span>

<span class="nc" id="L939">                list.setModel(newModel);</span>

<span class="nc bnc" id="L941" title="All 2 branches missed.">                if ( isVisible() ) {</span>
<span class="nc" id="L942">                    hide();</span>
                }
<span class="nc" id="L944">            }</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">            else if ( propertyName == &quot;renderer&quot; ) {</span>
<span class="nc" id="L946">                list.setCellRenderer( comboBox.getRenderer() );</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">                if ( isVisible() ) {</span>
<span class="nc" id="L948">                    hide();</span>
                }
            }
<span class="nc bnc" id="L951" title="All 2 branches missed.">            else if (propertyName == &quot;componentOrientation&quot;) {</span>
                // Pass along the new component orientation
                // to the list and the scroller

<span class="nc" id="L955">                ComponentOrientation o =(ComponentOrientation)e.getNewValue();</span>

<span class="nc" id="L957">                JList list = getList();</span>
<span class="nc bnc" id="L958" title="All 4 branches missed.">                if (list!=null &amp;&amp; list.getComponentOrientation()!=o) {</span>
<span class="nc" id="L959">                    list.setComponentOrientation(o);</span>
                }

<span class="nc bnc" id="L962" title="All 4 branches missed.">                if (scroller!=null &amp;&amp; scroller.getComponentOrientation()!=o) {</span>
<span class="nc" id="L963">                    scroller.setComponentOrientation(o);</span>
                }

<span class="nc bnc" id="L966" title="All 2 branches missed.">                if (o!=getComponentOrientation()) {</span>
<span class="nc" id="L967">                    setComponentOrientation(o);</span>
                }
<span class="nc" id="L969">            }</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">            else if (propertyName == &quot;lightWeightPopupEnabled&quot;) {</span>
<span class="nc" id="L971">                setLightWeightPopupEnabled(comboBox.isLightWeightPopupEnabled());</span>
            }
<span class="nc" id="L973">        }</span>

        //
        // ItemListener
        //
        public void itemStateChanged( ItemEvent e ) {
<span class="nc bnc" id="L979" title="All 2 branches missed.">            if (e.getStateChange() == ItemEvent.SELECTED) {</span>
<span class="nc" id="L980">                JComboBox comboBox = (JComboBox)e.getSource();</span>
<span class="nc" id="L981">                setListSelection(comboBox.getSelectedIndex());</span>
            }
<span class="nc" id="L983">        }</span>
    }

    //
    // end Event Listeners
    //=================================================================


    /**
     * Overridden to unconditionally return false.
     */
    public boolean isFocusTraversable() {
<span class="nc" id="L995">        return false;</span>
    }

    //===================================================================
    // begin Autoscroll methods
    //

    /**
     * This protected method is implementation specific and should be private.
     * do not call or override.
     */
    protected void startAutoScrolling( int direction ) {
        // XXX - should be a private method within InvocationMouseMotionHandler
        // if possible.
<span class="nc bnc" id="L1009" title="All 2 branches missed.">        if ( isAutoScrolling ) {</span>
<span class="nc" id="L1010">            autoscrollTimer.stop();</span>
        }

<span class="nc" id="L1013">        isAutoScrolling = true;</span>

<span class="nc bnc" id="L1015" title="All 2 branches missed.">        if ( direction == SCROLL_UP ) {</span>
<span class="nc" id="L1016">            scrollDirection = SCROLL_UP;</span>
<span class="nc" id="L1017">            Point convertedPoint = SwingUtilities.convertPoint( scroller, new Point( 1, 1 ), list );</span>
<span class="nc" id="L1018">            int top = list.locationToIndex( convertedPoint );</span>
<span class="nc" id="L1019">            list.setSelectedIndex( top );</span>

<span class="nc" id="L1021">            autoscrollTimer = new Timer( 100, new AutoScrollActionHandler(</span>
                                             SCROLL_UP) );
<span class="nc" id="L1023">        }</span>
<span class="nc bnc" id="L1024" title="All 2 branches missed.">        else if ( direction == SCROLL_DOWN ) {</span>
<span class="nc" id="L1025">            scrollDirection = SCROLL_DOWN;</span>
<span class="nc" id="L1026">            Dimension size = scroller.getSize();</span>
<span class="nc" id="L1027">            Point convertedPoint = SwingUtilities.convertPoint( scroller,</span>
                                                                new Point( 1, (size.height - 1) - 2 ),
                                                                list );
<span class="nc" id="L1030">            int bottom = list.locationToIndex( convertedPoint );</span>
<span class="nc" id="L1031">            list.setSelectedIndex( bottom );</span>

<span class="nc" id="L1033">            autoscrollTimer = new Timer(100, new AutoScrollActionHandler(</span>
                                            SCROLL_DOWN));
        }
<span class="nc" id="L1036">        autoscrollTimer.start();</span>
<span class="nc" id="L1037">    }</span>

    /**
     * This protected method is implementation specific and should be private.
     * do not call or override.
     */
    protected void stopAutoScrolling() {
<span class="nc" id="L1044">        isAutoScrolling = false;</span>

<span class="nc bnc" id="L1046" title="All 2 branches missed.">        if ( autoscrollTimer != null ) {</span>
<span class="nc" id="L1047">            autoscrollTimer.stop();</span>
<span class="nc" id="L1048">            autoscrollTimer = null;</span>
        }
<span class="nc" id="L1050">    }</span>

    /**
     * This protected method is implementation specific and should be private.
     * do not call or override.
     */
    protected void autoScrollUp() {
<span class="nc" id="L1057">        int index = list.getSelectedIndex();</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">        if ( index &gt; 0 ) {</span>
<span class="nc" id="L1059">            list.setSelectedIndex( index - 1 );</span>
<span class="nc" id="L1060">            list.ensureIndexIsVisible( index - 1 );</span>
        }
<span class="nc" id="L1062">    }</span>

    /**
     * This protected method is implementation specific and should be private.
     * do not call or override.
     */
    protected void autoScrollDown() {
<span class="nc" id="L1069">        int index = list.getSelectedIndex();</span>
<span class="nc" id="L1070">        int lastItem = list.getModel().getSize() - 1;</span>
<span class="nc bnc" id="L1071" title="All 2 branches missed.">        if ( index &lt; lastItem ) {</span>
<span class="nc" id="L1072">            list.setSelectedIndex( index + 1 );</span>
<span class="nc" id="L1073">            list.ensureIndexIsVisible( index + 1 );</span>
        }
<span class="nc" id="L1075">    }</span>

    //
    // end Autoscroll methods
    //=================================================================


    //===================================================================
    // begin Utility methods
    //

    /**
     * Gets the AccessibleContext associated with this BasicComboPopup.
     * The AccessibleContext will have its parent set to the ComboBox.
     *
     * @return an AccessibleContext for the BasicComboPopup
     * @since 1.5
     */
    public AccessibleContext getAccessibleContext() {
<span class="nc" id="L1094">        AccessibleContext context = super.getAccessibleContext();</span>
<span class="nc" id="L1095">        context.setAccessibleParent(comboBox);</span>
<span class="nc" id="L1096">        return context;</span>
    }


    /**
     * This is is a utility method that helps event handlers figure out where to
     * send the focus when the popup is brought up.  The standard implementation
     * delegates the focus to the editor (if the combo box is editable) or to
     * the JComboBox if it is not editable.
     */
    protected void delegateFocus( MouseEvent e ) {
<span class="nc bnc" id="L1107" title="All 2 branches missed.">        if ( comboBox.isEditable() ) {</span>
<span class="nc" id="L1108">            Component comp = comboBox.getEditor().getEditorComponent();</span>
<span class="nc bnc" id="L1109" title="All 4 branches missed.">            if ((!(comp instanceof JComponent)) || ((JComponent)comp).isRequestFocusEnabled()) {</span>
<span class="nc" id="L1110">                comp.requestFocus();</span>
            }
<span class="nc" id="L1112">        }</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">        else if (comboBox.isRequestFocusEnabled()) {</span>
<span class="nc" id="L1114">            comboBox.requestFocus();</span>
        }
<span class="nc" id="L1116">    }</span>

    /**
     * Makes the popup visible if it is hidden and makes it hidden if it is
     * visible.
     */
    protected void togglePopup() {
<span class="nc bnc" id="L1123" title="All 2 branches missed.">        if ( isVisible() ) {</span>
<span class="nc" id="L1124">            hide();</span>
        }
        else {
<span class="nc" id="L1127">            show();</span>
        }
<span class="nc" id="L1129">    }</span>

    /**
     * Sets the list selection index to the selectedIndex. This
     * method is used to synchronize the list selection with the
     * combo box selection.
     *
     * @param selectedIndex the index to set the list
     */
    private void setListSelection(int selectedIndex) {
<span class="nc bnc" id="L1139" title="All 2 branches missed.">        if ( selectedIndex == -1 ) {</span>
<span class="nc" id="L1140">            list.clearSelection();</span>
        }
        else {
<span class="nc" id="L1143">            list.setSelectedIndex( selectedIndex );</span>
<span class="nc" id="L1144">            list.ensureIndexIsVisible( selectedIndex );</span>
        }
<span class="nc" id="L1146">    }</span>

    protected MouseEvent convertMouseEvent( MouseEvent e ) {
<span class="nc" id="L1149">        Point convertedPoint = SwingUtilities.convertPoint( (Component)e.getSource(),</span>
<span class="nc" id="L1150">                                                            e.getPoint(), list );</span>
<span class="nc" id="L1151">        MouseEvent newEvent = new MouseEvent( (Component)e.getSource(),</span>
<span class="nc" id="L1152">                                              e.getID(),</span>
<span class="nc" id="L1153">                                              e.getWhen(),</span>
<span class="nc" id="L1154">                                              e.getModifiers(),</span>
                                              convertedPoint.x,
                                              convertedPoint.y,
<span class="nc" id="L1157">                                              e.getXOnScreen(),</span>
<span class="nc" id="L1158">                                              e.getYOnScreen(),</span>
<span class="nc" id="L1159">                                              e.getClickCount(),</span>
<span class="nc" id="L1160">                                              e.isPopupTrigger(),</span>
                                              MouseEvent.NOBUTTON );
<span class="nc" id="L1162">        return newEvent;</span>
    }


    /**
     * Retrieves the height of the popup based on the current
     * ListCellRenderer and the maximum row count.
     */
    protected int getPopupHeightForRowCount(int maxRowCount) {
        // Set the cached value of the minimum row count
<span class="nc" id="L1172">        int minRowCount = Math.min( maxRowCount, comboBox.getItemCount() );</span>
<span class="nc" id="L1173">        int height = 0;</span>
<span class="nc" id="L1174">        ListCellRenderer renderer = list.getCellRenderer();</span>
<span class="nc" id="L1175">        Object value = null;</span>

<span class="nc bnc" id="L1177" title="All 2 branches missed.">        for ( int i = 0; i &lt; minRowCount; ++i ) {</span>
<span class="nc" id="L1178">            value = list.getModel().getElementAt( i );</span>
<span class="nc" id="L1179">            Component c = renderer.getListCellRendererComponent( list, value, i, false, false );</span>
<span class="nc" id="L1180">            height += c.getPreferredSize().height;</span>
        }

<span class="nc bnc" id="L1183" title="All 2 branches missed.">        if (height == 0) {</span>
<span class="nc" id="L1184">            height = comboBox.getHeight();</span>
        }

<span class="nc" id="L1187">        Border border = scroller.getViewportBorder();</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">        if (border != null) {</span>
<span class="nc" id="L1189">            Insets insets = border.getBorderInsets(null);</span>
<span class="nc" id="L1190">            height += insets.top + insets.bottom;</span>
        }

<span class="nc" id="L1193">        border = scroller.getBorder();</span>
<span class="nc bnc" id="L1194" title="All 2 branches missed.">        if (border != null) {</span>
<span class="nc" id="L1195">            Insets insets = border.getBorderInsets(null);</span>
<span class="nc" id="L1196">            height += insets.top + insets.bottom;</span>
        }

<span class="nc" id="L1199">        return height;</span>
    }

    /**
     * Calculate the placement and size of the popup portion of the combo box based
     * on the combo box location and the enclosing screen bounds. If
     * no transformations are required, then the returned rectangle will
     * have the same values as the parameters.
     *
     * @param px starting x location
     * @param py starting y location
     * @param pw starting width
     * @param ph starting height
     * @return a rectangle which represents the placement and size of the popup
     */
    protected Rectangle computePopupBounds(int px,int py,int pw,int ph) {
<span class="nc" id="L1215">        Toolkit toolkit = Toolkit.getDefaultToolkit();</span>
        Rectangle screenBounds;

        // Calculate the desktop dimensions relative to the combo box.
<span class="nc" id="L1219">        GraphicsConfiguration gc = comboBox.getGraphicsConfiguration();</span>
<span class="nc" id="L1220">        Point p = new Point();</span>
<span class="nc" id="L1221">        SwingUtilities.convertPointFromScreen(p, comboBox);</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">        if (gc != null) {</span>
<span class="nc" id="L1223">            Insets screenInsets = toolkit.getScreenInsets(gc);</span>
<span class="nc" id="L1224">            screenBounds = gc.getBounds();</span>
<span class="nc" id="L1225">            screenBounds.width -= (screenInsets.left + screenInsets.right);</span>
<span class="nc" id="L1226">            screenBounds.height -= (screenInsets.top + screenInsets.bottom);</span>
<span class="nc" id="L1227">            screenBounds.x += (p.x + screenInsets.left);</span>
<span class="nc" id="L1228">            screenBounds.y += (p.y + screenInsets.top);</span>
<span class="nc" id="L1229">        }</span>
        else {
<span class="nc" id="L1231">            screenBounds = new Rectangle(p, toolkit.getScreenSize());</span>
        }

<span class="nc" id="L1234">        Rectangle rect = new Rectangle(px,py,pw,ph);</span>
<span class="nc bnc" id="L1235" title="All 4 branches missed.">        if (py+ph &gt; screenBounds.y+screenBounds.height</span>
            &amp;&amp; ph &lt; screenBounds.height) {
<span class="nc" id="L1237">            rect.y = -rect.height;</span>
        }
<span class="nc" id="L1239">        return rect;</span>
    }

    /**
     * Calculates the upper left location of the Popup.
     */
    private Point getPopupLocation() {
<span class="nc" id="L1246">        Dimension popupSize = comboBox.getSize();</span>
<span class="nc" id="L1247">        Insets insets = getInsets();</span>

        // reduce the width of the scrollpane by the insets so that the popup
        // is the same width as the combo box.
<span class="nc" id="L1251">        popupSize.setSize(popupSize.width - (insets.right + insets.left),</span>
<span class="nc" id="L1252">                          getPopupHeightForRowCount( comboBox.getMaximumRowCount()));</span>
<span class="nc" id="L1253">        Rectangle popupBounds = computePopupBounds( 0, comboBox.getBounds().height,</span>
                                                    popupSize.width, popupSize.height);
<span class="nc" id="L1255">        Dimension scrollSize = popupBounds.getSize();</span>
<span class="nc" id="L1256">        Point popupLocation = popupBounds.getLocation();</span>

<span class="nc" id="L1258">        scroller.setMaximumSize( scrollSize );</span>
<span class="nc" id="L1259">        scroller.setPreferredSize( scrollSize );</span>
<span class="nc" id="L1260">        scroller.setMinimumSize( scrollSize );</span>

<span class="nc" id="L1262">        list.revalidate();</span>

<span class="nc" id="L1264">        return popupLocation;</span>
    }

    /**
     * A utility method used by the event listeners.  Given a mouse event, it changes
     * the list selection to the list item below the mouse.
     */
    protected void updateListBoxSelectionForEvent(MouseEvent anEvent,boolean shouldScroll) {
        // XXX - only seems to be called from this class. shouldScroll flag is
        // never true
<span class="nc" id="L1274">        Point location = anEvent.getPoint();</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">        if ( list == null )</span>
<span class="nc" id="L1276">            return;</span>
<span class="nc" id="L1277">        int index = list.locationToIndex(location);</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">        if ( index == -1 ) {</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">            if ( location.y &lt; 0 )</span>
<span class="nc" id="L1280">                index = 0;</span>
            else
<span class="nc" id="L1282">                index = comboBox.getModel().getSize() - 1;</span>
        }
<span class="nc bnc" id="L1284" title="All 2 branches missed.">        if ( list.getSelectedIndex() != index ) {</span>
<span class="nc" id="L1285">            list.setSelectedIndex(index);</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">            if ( shouldScroll )</span>
<span class="nc" id="L1287">                list.ensureIndexIsVisible(index);</span>
        }
<span class="nc" id="L1289">    }</span>

    //
    // end Utility methods
    //=================================================================
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>