<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>BasicButtonListener.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.plaf.basic</a> &gt; <span class="el_source">BasicButtonListener.java</span></div><h1>BasicButtonListener.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing.plaf.basic;

import sun.swing.DefaultLookup;
import sun.swing.UIAction;
import java.awt.*;
import java.awt.event.*;
import java.beans.*;
import javax.swing.*;
import javax.swing.event.*;
import javax.swing.plaf.ActionMapUIResource;
import javax.swing.plaf.ButtonUI;
import javax.swing.plaf.ComponentInputMapUIResource;

/**
 * Button Listener
 *
 * @author Jeff Dinkins
 * @author Arnaud Weber (keyboard UI support)
 */

public class BasicButtonListener implements MouseListener, MouseMotionListener,
                                   FocusListener, ChangeListener, PropertyChangeListener
{
<span class="nc" id="L49">    private long lastPressedTimestamp = -1;</span>
<span class="nc" id="L50">    private boolean shouldDiscardRelease = false;</span>

    /**
     * Populates Buttons actions.
     */
    static void loadActionMap(LazyActionMap map) {
<span class="nc" id="L56">        map.put(new Actions(Actions.PRESS));</span>
<span class="nc" id="L57">        map.put(new Actions(Actions.RELEASE));</span>
<span class="nc" id="L58">    }</span>


<span class="nc" id="L61">    public BasicButtonListener(AbstractButton b) {</span>
<span class="nc" id="L62">    }</span>

    public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L65">        String prop = e.getPropertyName();</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if(prop == AbstractButton.MNEMONIC_CHANGED_PROPERTY) {</span>
<span class="nc" id="L67">            updateMnemonicBinding((AbstractButton)e.getSource());</span>
        }
<span class="nc bnc" id="L69" title="All 2 branches missed.">        else if(prop == AbstractButton.CONTENT_AREA_FILLED_CHANGED_PROPERTY) {</span>
<span class="nc" id="L70">            checkOpacity((AbstractButton) e.getSource() );</span>
        }
<span class="nc bnc" id="L72" title="All 6 branches missed.">        else if(prop == AbstractButton.TEXT_CHANGED_PROPERTY ||</span>
                &quot;font&quot; == prop || &quot;foreground&quot; == prop) {
<span class="nc" id="L74">            AbstractButton b = (AbstractButton) e.getSource();</span>
<span class="nc" id="L75">            BasicHTML.updateRenderer(b, b.getText());</span>
        }
<span class="nc" id="L77">    }</span>

    protected void checkOpacity(AbstractButton b) {
<span class="nc" id="L80">        b.setOpaque( b.isContentAreaFilled() );</span>
<span class="nc" id="L81">    }</span>

    /**
     * Register default key actions: pressing space to &quot;click&quot; a
     * button and registring the keyboard mnemonic (if any).
     */
    public void installKeyboardActions(JComponent c) {
<span class="nc" id="L88">        AbstractButton b = (AbstractButton)c;</span>
        // Update the mnemonic binding.
<span class="nc" id="L90">        updateMnemonicBinding(b);</span>

<span class="nc" id="L92">        LazyActionMap.installLazyActionMap(c, BasicButtonListener.class,</span>
                                           &quot;Button.actionMap&quot;);

<span class="nc" id="L95">        InputMap km = getInputMap(JComponent.WHEN_FOCUSED, c);</span>

<span class="nc" id="L97">        SwingUtilities.replaceUIInputMap(c, JComponent.WHEN_FOCUSED, km);</span>
<span class="nc" id="L98">    }</span>

    /**
     * Unregister's default key actions
     */
    public void uninstallKeyboardActions(JComponent c) {
<span class="nc" id="L104">        SwingUtilities.replaceUIInputMap(c, JComponent.</span>
                                         WHEN_IN_FOCUSED_WINDOW, null);
<span class="nc" id="L106">        SwingUtilities.replaceUIInputMap(c, JComponent.WHEN_FOCUSED, null);</span>
<span class="nc" id="L107">        SwingUtilities.replaceUIActionMap(c, null);</span>
<span class="nc" id="L108">    }</span>

    /**
     * Returns the InputMap for condition &lt;code&gt;condition&lt;/code&gt;. Called as
     * part of &lt;code&gt;installKeyboardActions&lt;/code&gt;.
     */
    InputMap getInputMap(int condition, JComponent c) {
<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (condition == JComponent.WHEN_FOCUSED) {</span>
<span class="nc" id="L116">            BasicButtonUI ui = (BasicButtonUI)BasicLookAndFeel.getUIOfType(</span>
<span class="nc" id="L117">                         ((AbstractButton)c).getUI(), BasicButtonUI.class);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (ui != null) {</span>
<span class="nc" id="L119">                return (InputMap)DefaultLookup.get(</span>
<span class="nc" id="L120">                             c, ui, ui.getPropertyPrefix() + &quot;focusInputMap&quot;);</span>
            }
        }
<span class="nc" id="L123">        return null;</span>
    }

    /**
     * Resets the binding for the mnemonic in the WHEN_IN_FOCUSED_WINDOW
     * UI InputMap.
     */
    void updateMnemonicBinding(AbstractButton b) {
<span class="nc" id="L131">        int m = b.getMnemonic();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if(m != 0) {</span>
<span class="nc" id="L133">            InputMap map = SwingUtilities.getUIInputMap(</span>
                                b, JComponent.WHEN_IN_FOCUSED_WINDOW);

<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (map == null) {</span>
<span class="nc" id="L137">                map = new ComponentInputMapUIResource(b);</span>
<span class="nc" id="L138">                SwingUtilities.replaceUIInputMap(b,</span>
                               JComponent.WHEN_IN_FOCUSED_WINDOW, map);
            }
<span class="nc" id="L141">            map.clear();</span>
<span class="nc" id="L142">            map.put(KeyStroke.getKeyStroke(m, BasicLookAndFeel.getFocusAcceleratorKeyMask(), false),</span>
                    &quot;pressed&quot;);
<span class="nc" id="L144">            map.put(KeyStroke.getKeyStroke(m, BasicLookAndFeel.getFocusAcceleratorKeyMask(), true),</span>
                    &quot;released&quot;);
<span class="nc" id="L146">            map.put(KeyStroke.getKeyStroke(m, 0, true), &quot;released&quot;);</span>
<span class="nc" id="L147">        }</span>
        else {
<span class="nc" id="L149">            InputMap map = SwingUtilities.getUIInputMap(b, JComponent.</span>
                                             WHEN_IN_FOCUSED_WINDOW);
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if (map != null) {</span>
<span class="nc" id="L152">                map.clear();</span>
            }
        }
<span class="nc" id="L155">    }</span>

    public void stateChanged(ChangeEvent e) {
<span class="nc" id="L158">        AbstractButton b = (AbstractButton) e.getSource();</span>
<span class="nc" id="L159">        b.repaint();</span>
<span class="nc" id="L160">    }</span>

    public void focusGained(FocusEvent e) {
<span class="nc" id="L163">        AbstractButton b = (AbstractButton) e.getSource();</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">        if (b instanceof JButton &amp;&amp; ((JButton)b).isDefaultCapable()) {</span>
<span class="nc" id="L165">            JRootPane root = b.getRootPane();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (root != null) {</span>
<span class="nc" id="L167">               BasicButtonUI ui = (BasicButtonUI)BasicLookAndFeel.getUIOfType(</span>
<span class="nc" id="L168">                         b.getUI(), BasicButtonUI.class);</span>
<span class="nc bnc" id="L169" title="All 4 branches missed.">               if (ui != null &amp;&amp; DefaultLookup.getBoolean(b, ui,</span>
<span class="nc" id="L170">                                   ui.getPropertyPrefix() +</span>
                                   &quot;defaultButtonFollowsFocus&quot;, true)) {
<span class="nc" id="L172">                   root.putClientProperty(&quot;temporaryDefaultButton&quot;, b);</span>
<span class="nc" id="L173">                   root.setDefaultButton((JButton)b);</span>
<span class="nc" id="L174">                   root.putClientProperty(&quot;temporaryDefaultButton&quot;, null);</span>
               }
            }
        }
<span class="nc" id="L178">        b.repaint();</span>
<span class="nc" id="L179">    }</span>

    public void focusLost(FocusEvent e) {
<span class="nc" id="L182">        AbstractButton b = (AbstractButton) e.getSource();</span>
<span class="nc" id="L183">        JRootPane root = b.getRootPane();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (root != null) {</span>
<span class="nc" id="L185">           JButton initialDefault = (JButton)root.getClientProperty(&quot;initialDefaultButton&quot;);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">           if (b != initialDefault) {</span>
<span class="nc" id="L187">               BasicButtonUI ui = (BasicButtonUI)BasicLookAndFeel.getUIOfType(</span>
<span class="nc" id="L188">                         b.getUI(), BasicButtonUI.class);</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">               if (ui != null &amp;&amp; DefaultLookup.getBoolean(b, ui,</span>
<span class="nc" id="L190">                                   ui.getPropertyPrefix() +</span>
                                   &quot;defaultButtonFollowsFocus&quot;, true)) {
<span class="nc" id="L192">                   root.setDefaultButton(initialDefault);</span>
               }
           }
        }

<span class="nc" id="L197">        ButtonModel model = b.getModel();</span>
<span class="nc" id="L198">        model.setPressed(false);</span>
<span class="nc" id="L199">        model.setArmed(false);</span>
<span class="nc" id="L200">        b.repaint();</span>
<span class="nc" id="L201">    }</span>

    public void mouseMoved(MouseEvent e) {
<span class="nc" id="L204">    }</span>


    public void mouseDragged(MouseEvent e) {
<span class="nc" id="L208">    }</span>

    public void mouseClicked(MouseEvent e) {
<span class="nc" id="L211">    }</span>

    public void mousePressed(MouseEvent e) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">       if (SwingUtilities.isLeftMouseButton(e) ) {</span>
<span class="nc" id="L215">          AbstractButton b = (AbstractButton) e.getSource();</span>

<span class="nc bnc" id="L217" title="All 2 branches missed.">          if(b.contains(e.getX(), e.getY())) {</span>
<span class="nc" id="L218">              long multiClickThreshhold = b.getMultiClickThreshhold();</span>
<span class="nc" id="L219">              long lastTime = lastPressedTimestamp;</span>
<span class="nc" id="L220">              long currentTime = lastPressedTimestamp = e.getWhen();</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">              if (lastTime != -1 &amp;&amp; currentTime - lastTime &lt; multiClickThreshhold) {</span>
<span class="nc" id="L222">                  shouldDiscardRelease = true;</span>
<span class="nc" id="L223">                  return;</span>
              }

<span class="nc" id="L226">             ButtonModel model = b.getModel();</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">             if (!model.isEnabled()) {</span>
                // Disabled buttons ignore all input...
<span class="nc" id="L229">                return;</span>
             }
<span class="nc bnc" id="L231" title="All 2 branches missed.">             if (!model.isArmed()) {</span>
                // button not armed, should be
<span class="nc" id="L233">                model.setArmed(true);</span>
             }
<span class="nc" id="L235">             model.setPressed(true);</span>
<span class="nc bnc" id="L236" title="All 4 branches missed.">             if(!b.hasFocus() &amp;&amp; b.isRequestFocusEnabled()) {</span>
<span class="nc" id="L237">                b.requestFocus();</span>
             }
          }
       }
<span class="nc" id="L241">    }</span>

    public void mouseReleased(MouseEvent e) {
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (SwingUtilities.isLeftMouseButton(e)) {</span>
            // Support for multiClickThreshhold
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (shouldDiscardRelease) {</span>
<span class="nc" id="L247">                shouldDiscardRelease = false;</span>
<span class="nc" id="L248">                return;</span>
            }
<span class="nc" id="L250">            AbstractButton b = (AbstractButton) e.getSource();</span>
<span class="nc" id="L251">            ButtonModel model = b.getModel();</span>
<span class="nc" id="L252">            model.setPressed(false);</span>
<span class="nc" id="L253">            model.setArmed(false);</span>
        }
<span class="nc" id="L255">    }</span>

    public void mouseEntered(MouseEvent e) {
<span class="nc" id="L258">        AbstractButton b = (AbstractButton) e.getSource();</span>
<span class="nc" id="L259">        ButtonModel model = b.getModel();</span>
<span class="nc bnc" id="L260" title="All 4 branches missed.">        if (b.isRolloverEnabled() &amp;&amp; !SwingUtilities.isLeftMouseButton(e)) {</span>
<span class="nc" id="L261">            model.setRollover(true);</span>
        }
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (model.isPressed())</span>
<span class="nc" id="L264">                model.setArmed(true);</span>
<span class="nc" id="L265">    }</span>

    public void mouseExited(MouseEvent e) {
<span class="nc" id="L268">        AbstractButton b = (AbstractButton) e.getSource();</span>
<span class="nc" id="L269">        ButtonModel model = b.getModel();</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if(b.isRolloverEnabled()) {</span>
<span class="nc" id="L271">            model.setRollover(false);</span>
        }
<span class="nc" id="L273">        model.setArmed(false);</span>
<span class="nc" id="L274">    }</span>


    /**
     * Actions for Buttons. Two types of action are supported:
     * pressed: Moves the button to a pressed state
     * released: Disarms the button.
     */
    private static class Actions extends UIAction {
        private static final String PRESS = &quot;pressed&quot;;
        private static final String RELEASE = &quot;released&quot;;

        Actions(String name) {
<span class="nc" id="L287">            super(name);</span>
<span class="nc" id="L288">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L291">            AbstractButton b = (AbstractButton)e.getSource();</span>
<span class="nc" id="L292">            String key = getName();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (key == PRESS) {</span>
<span class="nc" id="L294">                ButtonModel model = b.getModel();</span>
<span class="nc" id="L295">                model.setArmed(true);</span>
<span class="nc" id="L296">                model.setPressed(true);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">                if(!b.hasFocus()) {</span>
<span class="nc" id="L298">                    b.requestFocus();</span>
                }
<span class="nc" id="L300">            }</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">            else if (key == RELEASE) {</span>
<span class="nc" id="L302">                ButtonModel model = b.getModel();</span>
<span class="nc" id="L303">                model.setPressed(false);</span>
<span class="nc" id="L304">                model.setArmed(false);</span>
            }
<span class="nc" id="L306">        }</span>

        public boolean isEnabled(Object sender) {
<span class="nc bnc" id="L309" title="All 4 branches missed.">            if(sender != null &amp;&amp; (sender instanceof AbstractButton) &amp;&amp;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                      !((AbstractButton)sender).getModel().isEnabled()) {</span>
<span class="nc" id="L311">                return false;</span>
            } else {
<span class="nc" id="L313">                return true;</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>