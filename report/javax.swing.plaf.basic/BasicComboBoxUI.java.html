<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BasicComboBoxUI.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.plaf.basic</a> &gt; <span class="el_source">BasicComboBoxUI.java</span></div><h1>BasicComboBoxUI.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing.plaf.basic;

import java.awt.*;
import java.awt.event.*;
import javax.swing.*;
import javax.accessibility.*;
import javax.swing.plaf.*;
import javax.swing.text.*;
import javax.swing.event.*;
import java.beans.PropertyChangeListener;
import java.beans.PropertyChangeEvent;
import sun.awt.AppContext;
import sun.swing.DefaultLookup;
import sun.swing.UIAction;

/**
 * Basic UI implementation for JComboBox.
 * &lt;p&gt;
 * The combo box is a compound component which means that it is an aggregate of
 * many simpler components. This class creates and manages the listeners
 * on the combo box and the combo box model. These listeners update the user
 * interface in response to changes in the properties and state of the combo box.
 * &lt;p&gt;
 * All event handling is handled by listener classes created with the
 * &lt;code&gt;createxxxListener()&lt;/code&gt; methods and internal classes.
 * You can change the behavior of this class by overriding the
 * &lt;code&gt;createxxxListener()&lt;/code&gt; methods and supplying your own
 * event listeners or subclassing from the ones supplied in this class.
 * &lt;p&gt;
 * For adding specific actions,
 * overide &lt;code&gt;installKeyboardActions&lt;/code&gt; to add actions in response to
 * KeyStroke bindings. See the article &lt;a href=&quot;http://docs.oracle.com/javase/tutorial/uiswing/misc/keybinding.html&quot;&gt;How to Use Key Bindings&lt;/a&gt;
 *
 * @author Arnaud Weber
 * @author Tom Santos
 * @author Mark Davidson
 */
<span class="nc" id="L63">public class BasicComboBoxUI extends ComboBoxUI {</span>
    protected JComboBox comboBox;
    /**
     * This protected field is implementation specific. Do not access directly
     * or override.
     */
<span class="nc" id="L69">    protected boolean   hasFocus = false;</span>

    // Control the selection behavior of the JComboBox when it is used
    // in the JTable DefaultCellEditor.
<span class="nc" id="L73">    private boolean isTableCellEditor = false;</span>
    private static final String IS_TABLE_CELL_EDITOR = &quot;JComboBox.isTableCellEditor&quot;;

    // This list is for drawing the current item in the combo box.
    protected JList   listBox;

    // Used to render the currently selected item in the combo box.
    // It doesn't have anything to do with the popup's rendering.
<span class="nc" id="L81">    protected CellRendererPane currentValuePane = new CellRendererPane();</span>

    // The implementation of ComboPopup that is used to show the popup.
    protected ComboPopup popup;

    // The Component that the ComboBoxEditor uses for editing
    protected Component editor;

    // The arrow button that invokes the popup.
    protected JButton   arrowButton;

    // Listeners that are attached to the JComboBox
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Override the listener construction method instead.
     *
     * @see #createKeyListener
     */
    protected KeyListener keyListener;
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Override the listener construction method instead.
     *
     * @see #createFocusListener
     */
    protected FocusListener focusListener;
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Override the listener construction method instead.
     *
     * @see #createPropertyChangeListener
     */
    protected PropertyChangeListener propertyChangeListener;

    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Override the listener construction method instead.
     *
     * @see #createItemListener
     */
    protected ItemListener itemListener;

    // Listeners that the ComboPopup produces.
    protected MouseListener popupMouseListener;
    protected MouseMotionListener popupMouseMotionListener;
    protected KeyListener popupKeyListener;

    // This is used for knowing when to cache the minimum preferred size.
    // If the data in the list changes, the cached value get marked for recalc.
    // Added to the current JComboBox model
    /**
     * This protected field is implementation specific. Do not access directly
     * or override. Override the listener construction method instead.
     *
     * @see #createListDataListener
     */
    protected ListDataListener listDataListener;

    /**
     * Implements all the Listeners needed by this class, all existing
     * listeners redirect to it.
     */
    private Handler handler;

    /**
     * The time factor to treate the series of typed alphanumeric key
     * as prefix for first letter navigation.
     */
<span class="nc" id="L149">    private long timeFactor = 1000L;</span>

    /**
     * This is tricky, this variables is needed for DefaultKeySelectionManager
     * to take into account time factor.
     */
<span class="nc" id="L155">    private long lastTime = 0L;</span>
<span class="nc" id="L156">    private long time = 0L;</span>

    /**
     * The default key selection manager
     */
    JComboBox.KeySelectionManager keySelectionManager;

    // Flag for recalculating the minimum preferred size.
<span class="nc" id="L164">    protected boolean isMinimumSizeDirty = true;</span>

    // Cached minimum preferred size.
<span class="nc" id="L167">    protected Dimension cachedMinimumSize = new Dimension( 0, 0 );</span>

    // Flag for calculating the display size
<span class="nc" id="L170">    private boolean isDisplaySizeDirty = true;</span>

    // Cached the size that the display needs to render the largest item
<span class="nc" id="L173">    private Dimension cachedDisplaySize = new Dimension( 0, 0 );</span>

    // Key used for lookup of the DefaultListCellRenderer in the AppContext.
<span class="nc" id="L176">    private static final Object COMBO_UI_LIST_CELL_RENDERER_KEY =</span>
                        new StringBuffer(&quot;DefaultListCellRendererKey&quot;);

<span class="nc" id="L179">    static final StringBuffer HIDE_POPUP_KEY</span>
                  = new StringBuffer(&quot;HidePopupKey&quot;);

    /**
     * Whether or not all cells have the same baseline.
     */
    private boolean sameBaseline;

    /**
     * Indicates whether or not the combo box button should be square.
     * If square, then the width and height are equal, and are both set to
     * the height of the combo minus appropriate insets.
     *
     * @since 1.7
     */
<span class="nc" id="L194">    protected boolean squareButton = true;</span>

    /**
     * If specified, these insets act as padding around the cell renderer when
     * laying out and painting the &quot;selected&quot; item in the combo box. These
     * insets add to those specified by the cell renderer.
     *
     * @since 1.7
     */
    protected Insets padding;

    // Used for calculating the default size.
    private static ListCellRenderer getDefaultListCellRenderer() {
        ListCellRenderer renderer = (ListCellRenderer)AppContext.
<span class="nc" id="L208">                         getAppContext().get(COMBO_UI_LIST_CELL_RENDERER_KEY);</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (renderer == null) {</span>
<span class="nc" id="L211">            renderer = new DefaultListCellRenderer();</span>
<span class="nc" id="L212">            AppContext.getAppContext().put(COMBO_UI_LIST_CELL_RENDERER_KEY,</span>
                                           new DefaultListCellRenderer());
        }
<span class="nc" id="L215">        return renderer;</span>
    }

    /**
     * Populates ComboBox's actions.
     */
    static void loadActionMap(LazyActionMap map) {
<span class="nc" id="L222">        map.put(new Actions(Actions.HIDE));</span>
<span class="nc" id="L223">        map.put(new Actions(Actions.PAGE_DOWN));</span>
<span class="nc" id="L224">        map.put(new Actions(Actions.PAGE_UP));</span>
<span class="nc" id="L225">        map.put(new Actions(Actions.HOME));</span>
<span class="nc" id="L226">        map.put(new Actions(Actions.END));</span>
<span class="nc" id="L227">        map.put(new Actions(Actions.DOWN));</span>
<span class="nc" id="L228">        map.put(new Actions(Actions.DOWN_2));</span>
<span class="nc" id="L229">        map.put(new Actions(Actions.TOGGLE));</span>
<span class="nc" id="L230">        map.put(new Actions(Actions.TOGGLE_2));</span>
<span class="nc" id="L231">        map.put(new Actions(Actions.UP));</span>
<span class="nc" id="L232">        map.put(new Actions(Actions.UP_2));</span>
<span class="nc" id="L233">        map.put(new Actions(Actions.ENTER));</span>
<span class="nc" id="L234">    }</span>

    //========================
    // begin UI Initialization
    //

    public static ComponentUI createUI(JComponent c) {
<span class="nc" id="L241">        return new BasicComboBoxUI();</span>
    }

    @Override
    public void installUI( JComponent c ) {
<span class="nc" id="L246">        isMinimumSizeDirty = true;</span>

<span class="nc" id="L248">        comboBox = (JComboBox)c;</span>
<span class="nc" id="L249">        installDefaults();</span>
<span class="nc" id="L250">        popup = createPopup();</span>
<span class="nc" id="L251">        listBox = popup.getList();</span>

        // Is this combo box a cell editor?
<span class="nc" id="L254">        Boolean inTable = (Boolean)c.getClientProperty(IS_TABLE_CELL_EDITOR );</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (inTable != null) {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            isTableCellEditor = inTable.equals(Boolean.TRUE) ? true : false;</span>
        }

<span class="nc bnc" id="L259" title="All 4 branches missed.">        if ( comboBox.getRenderer() == null || comboBox.getRenderer() instanceof UIResource ) {</span>
<span class="nc" id="L260">            comboBox.setRenderer( createRenderer() );</span>
        }

<span class="nc bnc" id="L263" title="All 4 branches missed.">        if ( comboBox.getEditor() == null || comboBox.getEditor() instanceof UIResource ) {</span>
<span class="nc" id="L264">            comboBox.setEditor( createEditor() );</span>
        }

<span class="nc" id="L267">        installListeners();</span>
<span class="nc" id="L268">        installComponents();</span>

<span class="nc" id="L270">        comboBox.setLayout( createLayoutManager() );</span>

<span class="nc" id="L272">        comboBox.setRequestFocusEnabled( true );</span>

<span class="nc" id="L274">        installKeyboardActions();</span>

<span class="nc" id="L276">        comboBox.putClientProperty(&quot;doNotCancelPopup&quot;, HIDE_POPUP_KEY);</span>

<span class="nc bnc" id="L278" title="All 4 branches missed.">        if (keySelectionManager == null || keySelectionManager instanceof UIResource) {</span>
<span class="nc" id="L279">            keySelectionManager = new DefaultKeySelectionManager();</span>
        }
<span class="nc" id="L281">        comboBox.setKeySelectionManager(keySelectionManager);</span>
<span class="nc" id="L282">    }</span>

    @Override
    public void uninstallUI( JComponent c ) {
<span class="nc" id="L286">        setPopupVisible( comboBox, false);</span>
<span class="nc" id="L287">        popup.uninstallingUI();</span>

<span class="nc" id="L289">        uninstallKeyboardActions();</span>

<span class="nc" id="L291">        comboBox.setLayout( null );</span>

<span class="nc" id="L293">        uninstallComponents();</span>
<span class="nc" id="L294">        uninstallListeners();</span>
<span class="nc" id="L295">        uninstallDefaults();</span>

<span class="nc bnc" id="L297" title="All 4 branches missed.">        if ( comboBox.getRenderer() == null || comboBox.getRenderer() instanceof UIResource ) {</span>
<span class="nc" id="L298">            comboBox.setRenderer( null );</span>
        }

<span class="nc" id="L301">        ComboBoxEditor comboBoxEditor = comboBox.getEditor();</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (comboBoxEditor instanceof UIResource ) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (comboBoxEditor.getEditorComponent().hasFocus()) {</span>
                // Leave focus in JComboBox.
<span class="nc" id="L305">                comboBox.requestFocusInWindow();</span>
            }
<span class="nc" id="L307">            comboBox.setEditor( null );</span>
        }

<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (keySelectionManager instanceof UIResource) {</span>
<span class="nc" id="L311">            comboBox.setKeySelectionManager(null);</span>
        }

<span class="nc" id="L314">        handler = null;</span>
<span class="nc" id="L315">        keyListener = null;</span>
<span class="nc" id="L316">        focusListener = null;</span>
<span class="nc" id="L317">        listDataListener = null;</span>
<span class="nc" id="L318">        propertyChangeListener = null;</span>
<span class="nc" id="L319">        popup = null;</span>
<span class="nc" id="L320">        listBox = null;</span>
<span class="nc" id="L321">        comboBox = null;</span>
<span class="nc" id="L322">    }</span>

    /**
     * Installs the default colors, default font, default renderer, and default
     * editor into the JComboBox.
     */
    protected void installDefaults() {
<span class="nc" id="L329">        LookAndFeel.installColorsAndFont( comboBox,</span>
                                          &quot;ComboBox.background&quot;,
                                          &quot;ComboBox.foreground&quot;,
                                          &quot;ComboBox.font&quot; );
<span class="nc" id="L333">        LookAndFeel.installBorder( comboBox, &quot;ComboBox.border&quot; );</span>
<span class="nc" id="L334">        LookAndFeel.installProperty( comboBox, &quot;opaque&quot;, Boolean.TRUE);</span>

<span class="nc" id="L336">        Long l = (Long)UIManager.get(&quot;ComboBox.timeFactor&quot;);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">        timeFactor = l == null ? 1000L : l.longValue();</span>

        //NOTE: this needs to default to true if not specified
<span class="nc" id="L340">        Boolean b = (Boolean)UIManager.get(&quot;ComboBox.squareButton&quot;);</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        squareButton = b == null ? true : b;</span>

<span class="nc" id="L343">        padding = UIManager.getInsets(&quot;ComboBox.padding&quot;);</span>
<span class="nc" id="L344">    }</span>

    /**
     * Creates and installs listeners for the combo box and its model.
     * This method is called when the UI is installed.
     */
    protected void installListeners() {
<span class="nc bnc" id="L351" title="All 2 branches missed.">        if ( (itemListener = createItemListener()) != null) {</span>
<span class="nc" id="L352">            comboBox.addItemListener( itemListener );</span>
        }
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if ( (propertyChangeListener = createPropertyChangeListener()) != null ) {</span>
<span class="nc" id="L355">            comboBox.addPropertyChangeListener( propertyChangeListener );</span>
        }
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if ( (keyListener = createKeyListener()) != null ) {</span>
<span class="nc" id="L358">            comboBox.addKeyListener( keyListener );</span>
        }
<span class="nc bnc" id="L360" title="All 2 branches missed.">        if ( (focusListener = createFocusListener()) != null ) {</span>
<span class="nc" id="L361">            comboBox.addFocusListener( focusListener );</span>
        }
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if ((popupMouseListener = popup.getMouseListener()) != null) {</span>
<span class="nc" id="L364">            comboBox.addMouseListener( popupMouseListener );</span>
        }
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if ((popupMouseMotionListener = popup.getMouseMotionListener()) != null) {</span>
<span class="nc" id="L367">            comboBox.addMouseMotionListener( popupMouseMotionListener );</span>
        }
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if ((popupKeyListener = popup.getKeyListener()) != null) {</span>
<span class="nc" id="L370">            comboBox.addKeyListener(popupKeyListener);</span>
        }

<span class="nc bnc" id="L373" title="All 2 branches missed.">        if ( comboBox.getModel() != null ) {</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">            if ( (listDataListener = createListDataListener()) != null ) {</span>
<span class="nc" id="L375">                comboBox.getModel().addListDataListener( listDataListener );</span>
            }
        }
<span class="nc" id="L378">    }</span>

    /**
     * Uninstalls the default colors, default font, default renderer,
     * and default editor from the combo box.
     */
    protected void uninstallDefaults() {
<span class="nc" id="L385">        LookAndFeel.installColorsAndFont( comboBox,</span>
                                          &quot;ComboBox.background&quot;,
                                          &quot;ComboBox.foreground&quot;,
                                          &quot;ComboBox.font&quot; );
<span class="nc" id="L389">        LookAndFeel.uninstallBorder( comboBox );</span>
<span class="nc" id="L390">    }</span>

    /**
     * Removes the installed listeners from the combo box and its model.
     * The number and types of listeners removed and in this method should be
     * the same that was added in &lt;code&gt;installListeners&lt;/code&gt;
     */
    protected void uninstallListeners() {
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if ( keyListener != null ) {</span>
<span class="nc" id="L399">            comboBox.removeKeyListener( keyListener );</span>
        }
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if ( itemListener != null) {</span>
<span class="nc" id="L402">            comboBox.removeItemListener( itemListener );</span>
        }
<span class="nc bnc" id="L404" title="All 2 branches missed.">        if ( propertyChangeListener != null ) {</span>
<span class="nc" id="L405">            comboBox.removePropertyChangeListener( propertyChangeListener );</span>
        }
<span class="nc bnc" id="L407" title="All 2 branches missed.">        if ( focusListener != null) {</span>
<span class="nc" id="L408">            comboBox.removeFocusListener( focusListener );</span>
        }
<span class="nc bnc" id="L410" title="All 2 branches missed.">        if ( popupMouseListener != null) {</span>
<span class="nc" id="L411">            comboBox.removeMouseListener( popupMouseListener );</span>
        }
<span class="nc bnc" id="L413" title="All 2 branches missed.">        if ( popupMouseMotionListener != null) {</span>
<span class="nc" id="L414">            comboBox.removeMouseMotionListener( popupMouseMotionListener );</span>
        }
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (popupKeyListener != null) {</span>
<span class="nc" id="L417">            comboBox.removeKeyListener(popupKeyListener);</span>
        }
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if ( comboBox.getModel() != null ) {</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">            if ( listDataListener != null ) {</span>
<span class="nc" id="L421">                comboBox.getModel().removeListDataListener( listDataListener );</span>
            }
        }
<span class="nc" id="L424">    }</span>

    /**
     * Creates the popup portion of the combo box.
     *
     * @return an instance of &lt;code&gt;ComboPopup&lt;/code&gt;
     * @see ComboPopup
     */
    protected ComboPopup createPopup() {
<span class="nc" id="L433">        return new BasicComboPopup( comboBox );</span>
    }

    /**
     * Creates a &lt;code&gt;KeyListener&lt;/code&gt; which will be added to the
     * combo box. If this method returns null then it will not be added
     * to the combo box.
     *
     * @return an instance &lt;code&gt;KeyListener&lt;/code&gt; or null
     */
    protected KeyListener createKeyListener() {
<span class="nc" id="L444">        return getHandler();</span>
    }

    /**
     * Creates a &lt;code&gt;FocusListener&lt;/code&gt; which will be added to the combo box.
     * If this method returns null then it will not be added to the combo box.
     *
     * @return an instance of a &lt;code&gt;FocusListener&lt;/code&gt; or null
     */
    protected FocusListener createFocusListener() {
<span class="nc" id="L454">        return getHandler();</span>
    }

    /**
     * Creates a list data listener which will be added to the
     * &lt;code&gt;ComboBoxModel&lt;/code&gt;. If this method returns null then
     * it will not be added to the combo box model.
     *
     * @return an instance of a &lt;code&gt;ListDataListener&lt;/code&gt; or null
     */
    protected ListDataListener createListDataListener() {
<span class="nc" id="L465">        return getHandler();</span>
    }

    /**
     * Creates an &lt;code&gt;ItemListener&lt;/code&gt; which will be added to the
     * combo box. If this method returns null then it will not
     * be added to the combo box.
     * &lt;p&gt;
     * Subclasses may override this method to return instances of their own
     * ItemEvent handlers.
     *
     * @return an instance of an &lt;code&gt;ItemListener&lt;/code&gt; or null
     */
    protected ItemListener createItemListener() {
<span class="nc" id="L479">        return null;</span>
    }

    /**
     * Creates a &lt;code&gt;PropertyChangeListener&lt;/code&gt; which will be added to
     * the combo box. If this method returns null then it will not
     * be added to the combo box.
     *
     * @return an instance of a &lt;code&gt;PropertyChangeListener&lt;/code&gt; or null
     */
    protected PropertyChangeListener createPropertyChangeListener() {
<span class="nc" id="L490">        return getHandler();</span>
    }

    /**
     * Creates a layout manager for managing the components which make up the
     * combo box.
     *
     * @return an instance of a layout manager
     */
    protected LayoutManager createLayoutManager() {
<span class="nc" id="L500">        return getHandler();</span>
    }

    /**
     * Creates the default renderer that will be used in a non-editiable combo
     * box. A default renderer will used only if a renderer has not been
     * explicitly set with &lt;code&gt;setRenderer&lt;/code&gt;.
     *
     * @return a &lt;code&gt;ListCellRender&lt;/code&gt; used for the combo box
     * @see javax.swing.JComboBox#setRenderer
     */
    protected ListCellRenderer createRenderer() {
<span class="nc" id="L512">        return new BasicComboBoxRenderer.UIResource();</span>
    }

    /**
     * Creates the default editor that will be used in editable combo boxes.
     * A default editor will be used only if an editor has not been
     * explicitly set with &lt;code&gt;setEditor&lt;/code&gt;.
     *
     * @return a &lt;code&gt;ComboBoxEditor&lt;/code&gt; used for the combo box
     * @see javax.swing.JComboBox#setEditor
     */
    protected ComboBoxEditor createEditor() {
<span class="nc" id="L524">        return new BasicComboBoxEditor.UIResource();</span>
    }

    /**
     * Returns the shared listener.
     */
    private Handler getHandler() {
<span class="nc bnc" id="L531" title="All 2 branches missed.">        if (handler == null) {</span>
<span class="nc" id="L532">            handler = new Handler();</span>
        }
<span class="nc" id="L534">        return handler;</span>
    }

    //
    // end UI Initialization
    //======================


    //======================
    // begin Inner classes
    //

    /**
     * This listener checks to see if the key event isn't a navigation key.  If
     * it finds a key event that wasn't a navigation key it dispatches it to
     * JComboBox.selectWithKeyChar() so that it can do type-ahead.
     *
     * This public inner class should be treated as protected.
     * Instantiate it only within subclasses of
     * &lt;code&gt;BasicComboBoxUI&lt;/code&gt;.
     */
<span class="nc" id="L555">    public class KeyHandler extends KeyAdapter {</span>
        @Override
        public void keyPressed( KeyEvent e ) {
<span class="nc" id="L558">            getHandler().keyPressed(e);</span>
<span class="nc" id="L559">        }</span>
    }

    /**
     * This listener hides the popup when the focus is lost.  It also repaints
     * when focus is gained or lost.
     *
     * This public inner class should be treated as protected.
     * Instantiate it only within subclasses of
     * &lt;code&gt;BasicComboBoxUI&lt;/code&gt;.
     */
<span class="nc" id="L570">    public class FocusHandler implements FocusListener {</span>
        public void focusGained( FocusEvent e ) {
<span class="nc" id="L572">            getHandler().focusGained(e);</span>
<span class="nc" id="L573">        }</span>

        public void focusLost( FocusEvent e ) {
<span class="nc" id="L576">            getHandler().focusLost(e);</span>
<span class="nc" id="L577">        }</span>
    }

    /**
     * This listener watches for changes in the
     * &lt;code&gt;ComboBoxModel&lt;/code&gt;.
     * &lt;p&gt;
     * This public inner class should be treated as protected.
     * Instantiate it only within subclasses of
     * &lt;code&gt;BasicComboBoxUI&lt;/code&gt;.
     *
     * @see #createListDataListener
     */
<span class="nc" id="L590">    public class ListDataHandler implements ListDataListener {</span>
        public void contentsChanged( ListDataEvent e ) {
<span class="nc" id="L592">            getHandler().contentsChanged(e);</span>
<span class="nc" id="L593">        }</span>

        public void intervalAdded( ListDataEvent e ) {
<span class="nc" id="L596">            getHandler().intervalAdded(e);</span>
<span class="nc" id="L597">        }</span>

        public void intervalRemoved( ListDataEvent e ) {
<span class="nc" id="L600">            getHandler().intervalRemoved(e);</span>
<span class="nc" id="L601">        }</span>
    }

    /**
     * This listener watches for changes to the selection in the
     * combo box.
     * &lt;p&gt;
     * This public inner class should be treated as protected.
     * Instantiate it only within subclasses of
     * &lt;code&gt;BasicComboBoxUI&lt;/code&gt;.
     *
     * @see #createItemListener
     */
<span class="nc" id="L614">    public class ItemHandler implements ItemListener {</span>
        // This class used to implement behavior which is now redundant.
<span class="nc" id="L616">        public void itemStateChanged(ItemEvent e) {}</span>
    }

    /**
     * This listener watches for bound properties that have changed in the
     * combo box.
     * &lt;p&gt;
     * Subclasses which wish to listen to combo box property changes should
     * call the superclass methods to ensure that the combo box ui correctly
     * handles property changes.
     * &lt;p&gt;
     * This public inner class should be treated as protected.
     * Instantiate it only within subclasses of
     * &lt;code&gt;BasicComboBoxUI&lt;/code&gt;.
     *
     * @see #createPropertyChangeListener
     */
<span class="nc" id="L633">    public class PropertyChangeHandler implements PropertyChangeListener {</span>
        public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L635">            getHandler().propertyChange(e);</span>
<span class="nc" id="L636">        }</span>
    }


    // Syncronizes the ToolTip text for the components within the combo box to be the
    // same value as the combo box ToolTip text.
    private void updateToolTipTextForChildren() {
<span class="nc" id="L643">        Component[] children = comboBox.getComponents();</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">        for ( int i = 0; i &lt; children.length; ++i ) {</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">            if ( children[i] instanceof JComponent ) {</span>
<span class="nc" id="L646">                ((JComponent)children[i]).setToolTipText( comboBox.getToolTipText() );</span>
            }
        }
<span class="nc" id="L649">    }</span>

    /**
     * This layout manager handles the 'standard' layout of combo boxes.  It puts
     * the arrow button to the right and the editor to the left.  If there is no
     * editor it still keeps the arrow button to the right.
     *
     * This public inner class should be treated as protected.
     * Instantiate it only within subclasses of
     * &lt;code&gt;BasicComboBoxUI&lt;/code&gt;.
     */
<span class="nc" id="L660">    public class ComboBoxLayoutManager implements LayoutManager {</span>
<span class="nc" id="L661">        public void addLayoutComponent(String name, Component comp) {}</span>

<span class="nc" id="L663">        public void removeLayoutComponent(Component comp) {}</span>

        public Dimension preferredLayoutSize(Container parent) {
<span class="nc" id="L666">            return getHandler().preferredLayoutSize(parent);</span>
        }

        public Dimension minimumLayoutSize(Container parent) {
<span class="nc" id="L670">            return getHandler().minimumLayoutSize(parent);</span>
        }

        public void layoutContainer(Container parent) {
<span class="nc" id="L674">            getHandler().layoutContainer(parent);</span>
<span class="nc" id="L675">        }</span>
    }

    //
    // end Inner classes
    //====================


    //===============================
    // begin Sub-Component Management
    //

    /**
     * Creates and initializes the components which make up the
     * aggregate combo box. This method is called as part of the UI
     * installation process.
     */
    protected void installComponents() {
<span class="nc" id="L693">        arrowButton = createArrowButton();</span>

<span class="nc bnc" id="L695" title="All 2 branches missed.">        if (arrowButton != null)  {</span>
<span class="nc" id="L696">            comboBox.add(arrowButton);</span>
<span class="nc" id="L697">            configureArrowButton();</span>
        }

<span class="nc bnc" id="L700" title="All 2 branches missed.">        if ( comboBox.isEditable() ) {</span>
<span class="nc" id="L701">            addEditor();</span>
        }

<span class="nc" id="L704">        comboBox.add( currentValuePane );</span>
<span class="nc" id="L705">    }</span>

    /**
     * The aggregate components which comprise the combo box are
     * unregistered and uninitialized. This method is called as part of the
     * UI uninstallation process.
     */
    protected void uninstallComponents() {
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if ( arrowButton != null ) {</span>
<span class="nc" id="L714">            unconfigureArrowButton();</span>
        }
<span class="nc bnc" id="L716" title="All 2 branches missed.">        if ( editor != null ) {</span>
<span class="nc" id="L717">            unconfigureEditor();</span>
        }
<span class="nc" id="L719">        comboBox.removeAll(); // Just to be safe.</span>
<span class="nc" id="L720">        arrowButton = null;</span>
<span class="nc" id="L721">    }</span>

    /**
     * This public method is implementation specific and should be private.
     * do not call or override. To implement a specific editor create a
     * custom &lt;code&gt;ComboBoxEditor&lt;/code&gt;
     *
     * @see #createEditor
     * @see javax.swing.JComboBox#setEditor
     * @see javax.swing.ComboBoxEditor
     */
    public void addEditor() {
<span class="nc" id="L733">        removeEditor();</span>
<span class="nc" id="L734">        editor = comboBox.getEditor().getEditorComponent();</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">        if ( editor != null ) {</span>
<span class="nc" id="L736">            configureEditor();</span>
<span class="nc" id="L737">            comboBox.add(editor);</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">            if(comboBox.isFocusOwner()) {</span>
                // Switch focus to the editor component
<span class="nc" id="L740">                editor.requestFocusInWindow();</span>
            }
        }
<span class="nc" id="L743">    }</span>

    /**
     * This public method is implementation specific and should be private.
     * do not call or override.
     *
     * @see #addEditor
     */
    public void removeEditor() {
<span class="nc bnc" id="L752" title="All 2 branches missed.">        if ( editor != null ) {</span>
<span class="nc" id="L753">            unconfigureEditor();</span>
<span class="nc" id="L754">            comboBox.remove( editor );</span>
<span class="nc" id="L755">            editor = null;</span>
        }
<span class="nc" id="L757">    }</span>

    /**
     * This protected method is implementation specific and should be private.
     * do not call or override.
     *
     * @see #addEditor
     */
    protected void configureEditor() {
        // Should be in the same state as the combobox
<span class="nc" id="L767">        editor.setEnabled(comboBox.isEnabled());</span>

<span class="nc" id="L769">        editor.setFocusable(comboBox.isFocusable());</span>

<span class="nc" id="L771">        editor.setFont( comboBox.getFont() );</span>

<span class="nc bnc" id="L773" title="All 2 branches missed.">        if (focusListener != null) {</span>
<span class="nc" id="L774">            editor.addFocusListener(focusListener);</span>
        }

<span class="nc" id="L777">        editor.addFocusListener( getHandler() );</span>

<span class="nc" id="L779">        comboBox.getEditor().addActionListener(getHandler());</span>

<span class="nc bnc" id="L781" title="All 2 branches missed.">        if(editor instanceof JComponent) {</span>
<span class="nc" id="L782">            ((JComponent)editor).putClientProperty(&quot;doNotCancelPopup&quot;,</span>
                                                   HIDE_POPUP_KEY);
<span class="nc" id="L784">            ((JComponent)editor).setInheritsPopupMenu(true);</span>
        }

<span class="nc" id="L787">        comboBox.configureEditor(comboBox.getEditor(),comboBox.getSelectedItem());</span>

<span class="nc" id="L789">        editor.addPropertyChangeListener(propertyChangeListener);</span>
<span class="nc" id="L790">    }</span>

    /**
     * This protected method is implementation specific and should be private.
     * Do not call or override.
     *
     * @see #addEditor
     */
    protected void unconfigureEditor() {
<span class="nc bnc" id="L799" title="All 2 branches missed.">        if (focusListener != null) {</span>
<span class="nc" id="L800">            editor.removeFocusListener(focusListener);</span>
        }

<span class="nc" id="L803">        editor.removePropertyChangeListener(propertyChangeListener);</span>
<span class="nc" id="L804">        editor.removeFocusListener(getHandler());</span>
<span class="nc" id="L805">        comboBox.getEditor().removeActionListener(getHandler());</span>
<span class="nc" id="L806">    }</span>

    /**
     * This public method is implementation specific and should be private. Do
     * not call or override.
     *
     * @see #createArrowButton
     */
    public void configureArrowButton() {
<span class="nc bnc" id="L815" title="All 2 branches missed.">        if ( arrowButton != null ) {</span>
<span class="nc" id="L816">            arrowButton.setEnabled( comboBox.isEnabled() );</span>
<span class="nc" id="L817">            arrowButton.setFocusable(comboBox.isFocusable());</span>
<span class="nc" id="L818">            arrowButton.setRequestFocusEnabled(false);</span>
<span class="nc" id="L819">            arrowButton.addMouseListener( popup.getMouseListener() );</span>
<span class="nc" id="L820">            arrowButton.addMouseMotionListener( popup.getMouseMotionListener() );</span>
<span class="nc" id="L821">            arrowButton.resetKeyboardActions();</span>
<span class="nc" id="L822">            arrowButton.putClientProperty(&quot;doNotCancelPopup&quot;, HIDE_POPUP_KEY);</span>
<span class="nc" id="L823">            arrowButton.setInheritsPopupMenu(true);</span>
        }
<span class="nc" id="L825">    }</span>

    /**
     * This public method is implementation specific and should be private. Do
     * not call or override.
     *
     * @see #createArrowButton
     */
    public void unconfigureArrowButton() {
<span class="nc bnc" id="L834" title="All 2 branches missed.">        if ( arrowButton != null ) {</span>
<span class="nc" id="L835">            arrowButton.removeMouseListener( popup.getMouseListener() );</span>
<span class="nc" id="L836">            arrowButton.removeMouseMotionListener( popup.getMouseMotionListener() );</span>
        }
<span class="nc" id="L838">    }</span>

    /**
     * Creates a button which will be used as the control to show or hide
     * the popup portion of the combo box.
     *
     * @return a button which represents the popup control
     */
    protected JButton createArrowButton() {
<span class="nc" id="L847">        JButton button = new BasicArrowButton(BasicArrowButton.SOUTH,</span>
<span class="nc" id="L848">                                    UIManager.getColor(&quot;ComboBox.buttonBackground&quot;),</span>
<span class="nc" id="L849">                                    UIManager.getColor(&quot;ComboBox.buttonShadow&quot;),</span>
<span class="nc" id="L850">                                    UIManager.getColor(&quot;ComboBox.buttonDarkShadow&quot;),</span>
<span class="nc" id="L851">                                    UIManager.getColor(&quot;ComboBox.buttonHighlight&quot;));</span>
<span class="nc" id="L852">        button.setName(&quot;ComboBox.arrowButton&quot;);</span>
<span class="nc" id="L853">        return button;</span>
    }

    //
    // end Sub-Component Management
    //===============================


    //================================
    // begin ComboBoxUI Implementation
    //

    /**
     * Tells if the popup is visible or not.
     */
    public boolean isPopupVisible( JComboBox c ) {
<span class="nc" id="L869">        return popup.isVisible();</span>
    }

    /**
     * Hides the popup.
     */
    public void setPopupVisible( JComboBox c, boolean v ) {
<span class="nc bnc" id="L876" title="All 2 branches missed.">        if ( v ) {</span>
<span class="nc" id="L877">            popup.show();</span>
        } else {
<span class="nc" id="L879">            popup.hide();</span>
        }
<span class="nc" id="L881">    }</span>

    /**
     * Determines if the JComboBox is focus traversable.  If the JComboBox is editable
     * this returns false, otherwise it returns true.
     */
    public boolean isFocusTraversable( JComboBox c ) {
<span class="nc bnc" id="L888" title="All 2 branches missed.">        return !comboBox.isEditable();</span>
    }

    //
    // end ComboBoxUI Implementation
    //==============================


    //=================================
    // begin ComponentUI Implementation
    @Override
    public void paint( Graphics g, JComponent c ) {
<span class="nc" id="L900">        hasFocus = comboBox.hasFocus();</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">        if ( !comboBox.isEditable() ) {</span>
<span class="nc" id="L902">            Rectangle r = rectangleForCurrentValue();</span>
<span class="nc" id="L903">            paintCurrentValueBackground(g,r,hasFocus);</span>
<span class="nc" id="L904">            paintCurrentValue(g,r,hasFocus);</span>
        }
<span class="nc" id="L906">    }</span>

    @Override
    public Dimension getPreferredSize( JComponent c ) {
<span class="nc" id="L910">        return getMinimumSize(c);</span>
    }

    /**
     * The minimum size is the size of the display area plus insets plus the button.
     */
    @Override
    public Dimension getMinimumSize( JComponent c ) {
<span class="nc bnc" id="L918" title="All 2 branches missed.">        if ( !isMinimumSizeDirty ) {</span>
<span class="nc" id="L919">            return new Dimension(cachedMinimumSize);</span>
        }
<span class="nc" id="L921">        Dimension size = getDisplaySize();</span>
<span class="nc" id="L922">        Insets insets = getInsets();</span>
        //calculate the width and height of the button
<span class="nc" id="L924">        int buttonHeight = size.height;</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">        int buttonWidth = squareButton ? buttonHeight : arrowButton.getPreferredSize().width;</span>
        //adjust the size based on the button width
<span class="nc" id="L927">        size.height += insets.top + insets.bottom;</span>
<span class="nc" id="L928">        size.width +=  insets.left + insets.right + buttonWidth;</span>

<span class="nc" id="L930">        cachedMinimumSize.setSize( size.width, size.height );</span>
<span class="nc" id="L931">        isMinimumSizeDirty = false;</span>

<span class="nc" id="L933">        return new Dimension(size);</span>
    }

    @Override
    public Dimension getMaximumSize( JComponent c ) {
<span class="nc" id="L938">        return new Dimension(Short.MAX_VALUE, Short.MAX_VALUE);</span>
    }

    /**
     * Returns the baseline.
     *
     * @throws NullPointerException {@inheritDoc}
     * @throws IllegalArgumentException {@inheritDoc}
     * @see javax.swing.JComponent#getBaseline(int, int)
     * @since 1.6
     */
    @Override
    public int getBaseline(JComponent c, int width, int height) {
<span class="nc" id="L951">        super.getBaseline(c, width, height);</span>
<span class="nc" id="L952">        int baseline = -1;</span>
        // force sameBaseline to be updated.
<span class="nc" id="L954">        getDisplaySize();</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">        if (sameBaseline) {</span>
<span class="nc" id="L956">            Insets insets = c.getInsets();</span>
<span class="nc" id="L957">            height = height - insets.top - insets.bottom;</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">            if (!comboBox.isEditable()) {</span>
<span class="nc" id="L959">                ListCellRenderer renderer = comboBox.getRenderer();</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">                if (renderer == null)  {</span>
<span class="nc" id="L961">                    renderer = new DefaultListCellRenderer();</span>
                }
<span class="nc" id="L963">                Object value = null;</span>
<span class="nc" id="L964">                Object prototypeValue = comboBox.getPrototypeDisplayValue();</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">                if (prototypeValue != null)  {</span>
<span class="nc" id="L966">                    value = prototypeValue;</span>
                }
<span class="nc bnc" id="L968" title="All 2 branches missed.">                else if (comboBox.getModel().getSize() &gt; 0) {</span>
                    // Note, we're assuming the baseline is the same for all
                    // cells, if not, this needs to loop through all.
<span class="nc" id="L971">                    value = comboBox.getModel().getElementAt(0);</span>
                }
<span class="nc" id="L973">                Component component = renderer.</span>
<span class="nc" id="L974">                        getListCellRendererComponent(listBox, value, -1,</span>
                                                     false, false);
<span class="nc bnc" id="L976" title="All 2 branches missed.">                if (component instanceof JLabel) {</span>
<span class="nc" id="L977">                    JLabel label = (JLabel) component;</span>
<span class="nc" id="L978">                    String text = label.getText();</span>
<span class="nc bnc" id="L979" title="All 4 branches missed.">                    if ((text == null) || text.isEmpty()) {</span>
<span class="nc" id="L980">                        label.setText(&quot; &quot;);</span>
                    }
                }
<span class="nc bnc" id="L983" title="All 2 branches missed.">                if (component instanceof JComponent) {</span>
<span class="nc" id="L984">                    component.setFont(comboBox.getFont());</span>
                }
<span class="nc" id="L986">                baseline = component.getBaseline(width, height);</span>
<span class="nc" id="L987">            }</span>
            else {
<span class="nc" id="L989">                baseline = editor.getBaseline(width, height);</span>
            }
<span class="nc bnc" id="L991" title="All 2 branches missed.">            if (baseline &gt; 0) {</span>
<span class="nc" id="L992">                baseline += insets.top;</span>
            }
        }
<span class="nc" id="L995">        return baseline;</span>
    }

    /**
     * Returns an enum indicating how the baseline of the component
     * changes as the size changes.
     *
     * @throws NullPointerException {@inheritDoc}
     * @see javax.swing.JComponent#getBaseline(int, int)
     * @since 1.6
     */
    @Override
    public Component.BaselineResizeBehavior getBaselineResizeBehavior(
            JComponent c) {
<span class="nc" id="L1009">        super.getBaselineResizeBehavior(c);</span>
        // Force sameBaseline to be updated.
<span class="nc" id="L1011">        getDisplaySize();</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">        if (comboBox.isEditable()) {</span>
<span class="nc" id="L1013">            return editor.getBaselineResizeBehavior();</span>
        }
<span class="nc bnc" id="L1015" title="All 2 branches missed.">        else if (sameBaseline) {</span>
<span class="nc" id="L1016">            ListCellRenderer renderer = comboBox.getRenderer();</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">            if (renderer == null)  {</span>
<span class="nc" id="L1018">                renderer = new DefaultListCellRenderer();</span>
            }
<span class="nc" id="L1020">            Object value = null;</span>
<span class="nc" id="L1021">            Object prototypeValue = comboBox.getPrototypeDisplayValue();</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">            if (prototypeValue != null)  {</span>
<span class="nc" id="L1023">                value = prototypeValue;</span>
            }
<span class="nc bnc" id="L1025" title="All 2 branches missed.">            else if (comboBox.getModel().getSize() &gt; 0) {</span>
                // Note, we're assuming the baseline is the same for all
                // cells, if not, this needs to loop through all.
<span class="nc" id="L1028">                value = comboBox.getModel().getElementAt(0);</span>
            }
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if (value != null) {</span>
<span class="nc" id="L1031">                Component component = renderer.</span>
<span class="nc" id="L1032">                        getListCellRendererComponent(listBox, value, -1,</span>
                                                     false, false);
<span class="nc" id="L1034">                return component.getBaselineResizeBehavior();</span>
            }
        }
<span class="nc" id="L1037">        return Component.BaselineResizeBehavior.OTHER;</span>
    }

    // This is currently hacky...
    @Override
    public int getAccessibleChildrenCount(JComponent c) {
<span class="nc bnc" id="L1043" title="All 2 branches missed.">        if ( comboBox.isEditable() ) {</span>
<span class="nc" id="L1044">            return 2;</span>
        }
        else {
<span class="nc" id="L1047">            return 1;</span>
        }
    }

    // This is currently hacky...
    @Override
    public Accessible getAccessibleChild(JComponent c, int i) {
        // 0 = the popup
        // 1 = the editor
<span class="nc bnc" id="L1056" title="All 3 branches missed.">        switch ( i ) {</span>
        case 0:
<span class="nc bnc" id="L1058" title="All 2 branches missed.">            if ( popup instanceof Accessible ) {</span>
<span class="nc" id="L1059">                AccessibleContext ac = ((Accessible) popup).getAccessibleContext();</span>
<span class="nc" id="L1060">                ac.setAccessibleParent(comboBox);</span>
<span class="nc" id="L1061">                return(Accessible) popup;</span>
            }
            break;
        case 1:
<span class="nc bnc" id="L1065" title="All 4 branches missed.">            if ( comboBox.isEditable()</span>
                 &amp;&amp; (editor instanceof Accessible) ) {
<span class="nc" id="L1067">                AccessibleContext ac = ((Accessible) editor).getAccessibleContext();</span>
<span class="nc" id="L1068">                ac.setAccessibleParent(comboBox);</span>
<span class="nc" id="L1069">                return(Accessible) editor;</span>
            }
            break;
        }
<span class="nc" id="L1073">        return null;</span>
    }

    //
    // end ComponentUI Implementation
    //===============================


    //======================
    // begin Utility Methods
    //

    /**
     * Returns whether or not the supplied keyCode maps to a key that is used for
     * navigation.  This is used for optimizing key input by only passing non-
     * navigation keys to the type-ahead mechanism.  Subclasses should override this
     * if they change the navigation keys.
     */
    protected boolean isNavigationKey( int keyCode ) {
<span class="nc bnc" id="L1092" title="All 8 branches missed.">        return keyCode == KeyEvent.VK_UP || keyCode == KeyEvent.VK_DOWN ||</span>
               keyCode == KeyEvent.VK_KP_UP || keyCode == KeyEvent.VK_KP_DOWN;
    }

    private boolean isNavigationKey(int keyCode, int modifiers) {
<span class="nc" id="L1097">        InputMap inputMap = comboBox.getInputMap(JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);</span>
<span class="nc" id="L1098">        KeyStroke key = KeyStroke.getKeyStroke(keyCode, modifiers);</span>

<span class="nc bnc" id="L1100" title="All 4 branches missed.">        if (inputMap != null &amp;&amp; inputMap.get(key) != null) {</span>
<span class="nc" id="L1101">            return true;</span>
        }
<span class="nc" id="L1103">        return false;</span>
    }

    /**
     * Selects the next item in the list.  It won't change the selection if the
     * currently selected item is already the last item.
     */
    protected void selectNextPossibleValue() {
        int si;

<span class="nc bnc" id="L1113" title="All 2 branches missed.">        if ( comboBox.isPopupVisible() ) {</span>
<span class="nc" id="L1114">            si = listBox.getSelectedIndex();</span>
        }
        else {
<span class="nc" id="L1117">            si = comboBox.getSelectedIndex();</span>
        }

<span class="nc bnc" id="L1120" title="All 2 branches missed.">        if ( si &lt; comboBox.getModel().getSize() - 1 ) {</span>
<span class="nc" id="L1121">            listBox.setSelectedIndex( si + 1 );</span>
<span class="nc" id="L1122">            listBox.ensureIndexIsVisible( si + 1 );</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">            if ( !isTableCellEditor ) {</span>
<span class="nc bnc" id="L1124" title="All 4 branches missed.">                if (!(UIManager.getBoolean(&quot;ComboBox.noActionOnKeyNavigation&quot;) &amp;&amp; comboBox.isPopupVisible())) {</span>
<span class="nc" id="L1125">                    comboBox.setSelectedIndex(si+1);</span>
                }
            }
<span class="nc" id="L1128">            comboBox.repaint();</span>
        }
<span class="nc" id="L1130">    }</span>

    /**
     * Selects the previous item in the list.  It won't change the selection if the
     * currently selected item is already the first item.
     */
    protected void selectPreviousPossibleValue() {
        int si;

<span class="nc bnc" id="L1139" title="All 2 branches missed.">        if ( comboBox.isPopupVisible() ) {</span>
<span class="nc" id="L1140">            si = listBox.getSelectedIndex();</span>
        }
        else {
<span class="nc" id="L1143">            si = comboBox.getSelectedIndex();</span>
        }

<span class="nc bnc" id="L1146" title="All 2 branches missed.">        if ( si &gt; 0 ) {</span>
<span class="nc" id="L1147">            listBox.setSelectedIndex( si - 1 );</span>
<span class="nc" id="L1148">            listBox.ensureIndexIsVisible( si - 1 );</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">            if ( !isTableCellEditor ) {</span>
<span class="nc bnc" id="L1150" title="All 4 branches missed.">                if (!(UIManager.getBoolean(&quot;ComboBox.noActionOnKeyNavigation&quot;) &amp;&amp; comboBox.isPopupVisible())) {</span>
<span class="nc" id="L1151">                    comboBox.setSelectedIndex(si-1);</span>
                }
            }
<span class="nc" id="L1154">            comboBox.repaint();</span>
        }
<span class="nc" id="L1156">    }</span>

    /**
     * Hides the popup if it is showing and shows the popup if it is hidden.
     */
    protected void toggleOpenClose() {
<span class="nc bnc" id="L1162" title="All 2 branches missed.">        setPopupVisible(comboBox, !isPopupVisible(comboBox));</span>
<span class="nc" id="L1163">    }</span>

    /**
     * Returns the area that is reserved for drawing the currently selected item.
     */
    protected Rectangle rectangleForCurrentValue() {
<span class="nc" id="L1169">        int width = comboBox.getWidth();</span>
<span class="nc" id="L1170">        int height = comboBox.getHeight();</span>
<span class="nc" id="L1171">        Insets insets = getInsets();</span>
<span class="nc" id="L1172">        int buttonSize = height - (insets.top + insets.bottom);</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">        if ( arrowButton != null ) {</span>
<span class="nc" id="L1174">            buttonSize = arrowButton.getWidth();</span>
        }
<span class="nc bnc" id="L1176" title="All 2 branches missed.">        if(BasicGraphicsUtils.isLeftToRight(comboBox)) {</span>
<span class="nc" id="L1177">            return new Rectangle(insets.left, insets.top,</span>
                             width - (insets.left + insets.right + buttonSize),
                             height - (insets.top + insets.bottom));
        }
        else {
<span class="nc" id="L1182">            return new Rectangle(insets.left + buttonSize, insets.top,</span>
                             width - (insets.left + insets.right + buttonSize),
                             height - (insets.top + insets.bottom));
        }
    }

    /**
     * Gets the insets from the JComboBox.
     */
    protected Insets getInsets() {
<span class="nc" id="L1192">        return comboBox.getInsets();</span>
    }

    //
    // end Utility Methods
    //====================


    //===============================
    // begin Painting Utility Methods
    //

    /**
     * Paints the currently selected item.
     */
    public void paintCurrentValue(Graphics g,Rectangle bounds,boolean hasFocus) {
<span class="nc" id="L1208">        ListCellRenderer renderer = comboBox.getRenderer();</span>
        Component c;

<span class="nc bnc" id="L1211" title="All 4 branches missed.">        if ( hasFocus &amp;&amp; !isPopupVisible(comboBox) ) {</span>
<span class="nc" id="L1212">            c = renderer.getListCellRendererComponent( listBox,</span>
<span class="nc" id="L1213">                                                       comboBox.getSelectedItem(),</span>
                                                       -1,
                                                       true,
                                                       false );
        }
        else {
<span class="nc" id="L1219">            c = renderer.getListCellRendererComponent( listBox,</span>
<span class="nc" id="L1220">                                                       comboBox.getSelectedItem(),</span>
                                                       -1,
                                                       false,
                                                       false );
<span class="nc" id="L1224">            c.setBackground(UIManager.getColor(&quot;ComboBox.background&quot;));</span>
        }
<span class="nc" id="L1226">        c.setFont(comboBox.getFont());</span>
<span class="nc bnc" id="L1227" title="All 4 branches missed.">        if ( hasFocus &amp;&amp; !isPopupVisible(comboBox) ) {</span>
<span class="nc" id="L1228">            c.setForeground(listBox.getSelectionForeground());</span>
<span class="nc" id="L1229">            c.setBackground(listBox.getSelectionBackground());</span>
        }
        else {
<span class="nc bnc" id="L1232" title="All 2 branches missed.">            if ( comboBox.isEnabled() ) {</span>
<span class="nc" id="L1233">                c.setForeground(comboBox.getForeground());</span>
<span class="nc" id="L1234">                c.setBackground(comboBox.getBackground());</span>
            }
            else {
<span class="nc" id="L1237">                c.setForeground(DefaultLookup.getColor(</span>
                         comboBox, this, &quot;ComboBox.disabledForeground&quot;, null));
<span class="nc" id="L1239">                c.setBackground(DefaultLookup.getColor(</span>
                         comboBox, this, &quot;ComboBox.disabledBackground&quot;, null));
            }
        }

        // Fix for 4238829: should lay out the JPanel.
<span class="nc" id="L1245">        boolean shouldValidate = false;</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">        if (c instanceof JPanel)  {</span>
<span class="nc" id="L1247">            shouldValidate = true;</span>
        }

<span class="nc" id="L1250">        int x = bounds.x, y = bounds.y, w = bounds.width, h = bounds.height;</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">        if (padding != null) {</span>
<span class="nc" id="L1252">            x = bounds.x + padding.left;</span>
<span class="nc" id="L1253">            y = bounds.y + padding.top;</span>
<span class="nc" id="L1254">            w = bounds.width - (padding.left + padding.right);</span>
<span class="nc" id="L1255">            h = bounds.height - (padding.top + padding.bottom);</span>
        }

<span class="nc" id="L1258">        currentValuePane.paintComponent(g,c,comboBox,x,y,w,h,shouldValidate);</span>
<span class="nc" id="L1259">    }</span>

    /**
     * Paints the background of the currently selected item.
     */
    public void paintCurrentValueBackground(Graphics g,Rectangle bounds,boolean hasFocus) {
<span class="nc" id="L1265">        Color t = g.getColor();</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">        if ( comboBox.isEnabled() )</span>
<span class="nc" id="L1267">            g.setColor(DefaultLookup.getColor(comboBox, this,</span>
                                              &quot;ComboBox.background&quot;, null));
        else
<span class="nc" id="L1270">            g.setColor(DefaultLookup.getColor(comboBox, this,</span>
                                     &quot;ComboBox.disabledBackground&quot;, null));
<span class="nc" id="L1272">        g.fillRect(bounds.x,bounds.y,bounds.width,bounds.height);</span>
<span class="nc" id="L1273">        g.setColor(t);</span>
<span class="nc" id="L1274">    }</span>

    /**
     * Repaint the currently selected item.
     */
    void repaintCurrentValue() {
<span class="nc" id="L1280">        Rectangle r = rectangleForCurrentValue();</span>
<span class="nc" id="L1281">        comboBox.repaint(r.x,r.y,r.width,r.height);</span>
<span class="nc" id="L1282">    }</span>

    //
    // end Painting Utility Methods
    //=============================


    //===============================
    // begin Size Utility Methods
    //

    /**
     * Return the default size of an empty display area of the combo box using
     * the current renderer and font.
     *
     * @return the size of an empty display area
     * @see #getDisplaySize
     */
    protected Dimension getDefaultSize() {
        // Calculates the height and width using the default text renderer
<span class="nc" id="L1302">        Dimension d = getSizeForComponent(getDefaultListCellRenderer().getListCellRendererComponent(listBox, &quot; &quot;, -1, false, false));</span>

<span class="nc" id="L1304">        return new Dimension(d.width, d.height);</span>
    }

    /**
     * Returns the calculated size of the display area. The display area is the
     * portion of the combo box in which the selected item is displayed. This
     * method will use the prototype display value if it has been set.
     * &lt;p&gt;
     * For combo boxes with a non trivial number of items, it is recommended to
     * use a prototype display value to significantly speed up the display
     * size calculation.
     *
     * @return the size of the display area calculated from the combo box items
     * @see javax.swing.JComboBox#setPrototypeDisplayValue
     */
    protected Dimension getDisplaySize() {
<span class="nc bnc" id="L1320" title="All 2 branches missed.">        if (!isDisplaySizeDirty)  {</span>
<span class="nc" id="L1321">            return new Dimension(cachedDisplaySize);</span>
        }
<span class="nc" id="L1323">        Dimension result = new Dimension();</span>

<span class="nc" id="L1325">        ListCellRenderer renderer = comboBox.getRenderer();</span>
<span class="nc bnc" id="L1326" title="All 2 branches missed.">        if (renderer == null)  {</span>
<span class="nc" id="L1327">            renderer = new DefaultListCellRenderer();</span>
        }

<span class="nc" id="L1330">        sameBaseline = true;</span>

<span class="nc" id="L1332">        Object prototypeValue = comboBox.getPrototypeDisplayValue();</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">        if (prototypeValue != null)  {</span>
            // Calculates the dimension based on the prototype value
<span class="nc" id="L1335">            result = getSizeForComponent(renderer.getListCellRendererComponent(listBox,</span>
                                                                               prototypeValue,
                                                                               -1, false, false));
        } else {
            // Calculate the dimension by iterating over all the elements in the combo
            // box list.
<span class="nc" id="L1341">            ComboBoxModel model = comboBox.getModel();</span>
<span class="nc" id="L1342">            int modelSize = model.getSize();</span>
<span class="nc" id="L1343">            int baseline = -1;</span>
            Dimension d;

            Component cpn;

<span class="nc bnc" id="L1348" title="All 2 branches missed.">            if (modelSize &gt; 0 ) {</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">                for (int i = 0; i &lt; modelSize ; i++ ) {</span>
                    // Calculates the maximum height and width based on the largest
                    // element
<span class="nc" id="L1352">                    Object value = model.getElementAt(i);</span>
<span class="nc" id="L1353">                    Component c = renderer.getListCellRendererComponent(</span>
                            listBox, value, -1, false, false);
<span class="nc" id="L1355">                    d = getSizeForComponent(c);</span>
<span class="nc bnc" id="L1356" title="All 6 branches missed.">                    if (sameBaseline &amp;&amp; value != null &amp;&amp;</span>
<span class="nc bnc" id="L1357" title="All 2 branches missed.">                            (!(value instanceof String) || !&quot;&quot;.equals(value))) {</span>
<span class="nc" id="L1358">                        int newBaseline = c.getBaseline(d.width, d.height);</span>
<span class="nc bnc" id="L1359" title="All 2 branches missed.">                        if (newBaseline == -1) {</span>
<span class="nc" id="L1360">                            sameBaseline = false;</span>
                        }
<span class="nc bnc" id="L1362" title="All 2 branches missed.">                        else if (baseline == -1) {</span>
<span class="nc" id="L1363">                            baseline = newBaseline;</span>
                        }
<span class="nc bnc" id="L1365" title="All 2 branches missed.">                        else if (baseline != newBaseline) {</span>
<span class="nc" id="L1366">                            sameBaseline = false;</span>
                        }
                    }
<span class="nc" id="L1369">                    result.width = Math.max(result.width,d.width);</span>
<span class="nc" id="L1370">                    result.height = Math.max(result.height,d.height);</span>
                }
            } else {
<span class="nc" id="L1373">                result = getDefaultSize();</span>
<span class="nc bnc" id="L1374" title="All 2 branches missed.">                if (comboBox.isEditable()) {</span>
<span class="nc" id="L1375">                    result.width = 100;</span>
                }
            }
        }

<span class="nc bnc" id="L1380" title="All 2 branches missed.">        if ( comboBox.isEditable() ) {</span>
<span class="nc" id="L1381">            Dimension d = editor.getPreferredSize();</span>
<span class="nc" id="L1382">            result.width = Math.max(result.width,d.width);</span>
<span class="nc" id="L1383">            result.height = Math.max(result.height,d.height);</span>
        }

        // calculate in the padding
<span class="nc bnc" id="L1387" title="All 2 branches missed.">        if (padding != null) {</span>
<span class="nc" id="L1388">            result.width += padding.left + padding.right;</span>
<span class="nc" id="L1389">            result.height += padding.top + padding.bottom;</span>
        }

        // Set the cached value
<span class="nc" id="L1393">        cachedDisplaySize.setSize(result.width, result.height);</span>
<span class="nc" id="L1394">        isDisplaySizeDirty = false;</span>

<span class="nc" id="L1396">        return result;</span>
    }

    /**
     * Returns the size a component would have if used as a cell renderer.
     *
     * @param comp a {@code Component} to check
     * @return size of the component
     * @since 1.7
     */
    protected Dimension getSizeForComponent(Component comp) {
        // This has been refactored out in hopes that it may be investigated and
        // simplified for the next major release. adding/removing
        // the component to the currentValuePane and changing the font may be
        // redundant operations.
<span class="nc" id="L1411">        currentValuePane.add(comp);</span>
<span class="nc" id="L1412">        comp.setFont(comboBox.getFont());</span>
<span class="nc" id="L1413">        Dimension d = comp.getPreferredSize();</span>
<span class="nc" id="L1414">        currentValuePane.remove(comp);</span>
<span class="nc" id="L1415">        return d;</span>
    }


    //
    // end Size Utility Methods
    //=============================


    //=================================
    // begin Keyboard Action Management
    //

    /**
     * Adds keyboard actions to the JComboBox.  Actions on enter and esc are already
     * supplied.  Add more actions as you need them.
     */
    protected void installKeyboardActions() {
<span class="nc" id="L1433">        InputMap km = getInputMap(JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);</span>
<span class="nc" id="L1434">        SwingUtilities.replaceUIInputMap(comboBox, JComponent.</span>
                             WHEN_ANCESTOR_OF_FOCUSED_COMPONENT, km);


<span class="nc" id="L1438">        LazyActionMap.installLazyActionMap(comboBox, BasicComboBoxUI.class,</span>
                                           &quot;ComboBox.actionMap&quot;);
<span class="nc" id="L1440">    }</span>

    InputMap getInputMap(int condition) {
<span class="nc bnc" id="L1443" title="All 2 branches missed.">        if (condition == JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT) {</span>
<span class="nc" id="L1444">            return (InputMap)DefaultLookup.get(comboBox, this,</span>
                                               &quot;ComboBox.ancestorInputMap&quot;);
        }
<span class="nc" id="L1447">        return null;</span>
    }

    boolean isTableCellEditor() {
<span class="nc" id="L1451">        return isTableCellEditor;</span>
    }

    /**
     * Removes the focus InputMap and ActionMap.
     */
    protected void uninstallKeyboardActions() {
<span class="nc" id="L1458">        SwingUtilities.replaceUIInputMap(comboBox, JComponent.</span>
                                 WHEN_ANCESTOR_OF_FOCUSED_COMPONENT, null);
<span class="nc" id="L1460">        SwingUtilities.replaceUIActionMap(comboBox, null);</span>
<span class="nc" id="L1461">    }</span>


    //
    // Actions
    //
    private static class Actions extends UIAction {
        private static final String HIDE = &quot;hidePopup&quot;;
        private static final String DOWN = &quot;selectNext&quot;;
        private static final String DOWN_2 = &quot;selectNext2&quot;;
        private static final String TOGGLE = &quot;togglePopup&quot;;
        private static final String TOGGLE_2 = &quot;spacePopup&quot;;
        private static final String UP = &quot;selectPrevious&quot;;
        private static final String UP_2 = &quot;selectPrevious2&quot;;
        private static final String ENTER = &quot;enterPressed&quot;;
        private static final String PAGE_DOWN = &quot;pageDownPassThrough&quot;;
        private static final String PAGE_UP = &quot;pageUpPassThrough&quot;;
        private static final String HOME = &quot;homePassThrough&quot;;
        private static final String END = &quot;endPassThrough&quot;;

        Actions(String name) {
<span class="nc" id="L1482">            super(name);</span>
<span class="nc" id="L1483">        }</span>

        public void actionPerformed( ActionEvent e ) {
<span class="nc" id="L1486">            String key = getName();</span>
<span class="nc" id="L1487">            JComboBox comboBox = (JComboBox)e.getSource();</span>
<span class="nc" id="L1488">            BasicComboBoxUI ui = (BasicComboBoxUI)BasicLookAndFeel.getUIOfType(</span>
<span class="nc" id="L1489">                                  comboBox.getUI(), BasicComboBoxUI.class);</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">            if (key == HIDE) {</span>
<span class="nc" id="L1491">                comboBox.firePopupMenuCanceled();</span>
<span class="nc" id="L1492">                comboBox.setPopupVisible(false);</span>
            }
<span class="nc bnc" id="L1494" title="All 8 branches missed.">            else if (key == PAGE_DOWN || key == PAGE_UP ||</span>
                     key == HOME || key == END) {
<span class="nc" id="L1496">                int index = getNextIndex(comboBox, key);</span>
<span class="nc bnc" id="L1497" title="All 4 branches missed.">                if (index &gt;= 0 &amp;&amp; index &lt; comboBox.getItemCount()) {</span>
<span class="nc bnc" id="L1498" title="All 4 branches missed.">                    if (UIManager.getBoolean(&quot;ComboBox.noActionOnKeyNavigation&quot;) &amp;&amp; comboBox.isPopupVisible()) {</span>
<span class="nc" id="L1499">                        ui.listBox.setSelectedIndex(index);</span>
<span class="nc" id="L1500">                        ui.listBox.ensureIndexIsVisible(index);</span>
<span class="nc" id="L1501">                        comboBox.repaint();</span>
                    } else {
<span class="nc" id="L1503">                        comboBox.setSelectedIndex(index);</span>
                    }
                }
<span class="nc" id="L1506">            }</span>
<span class="nc bnc" id="L1507" title="All 2 branches missed.">            else if (key == DOWN) {</span>
<span class="nc bnc" id="L1508" title="All 2 branches missed.">                if (comboBox.isShowing() ) {</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">                    if ( comboBox.isPopupVisible() ) {</span>
<span class="nc bnc" id="L1510" title="All 2 branches missed.">                        if (ui != null) {</span>
<span class="nc" id="L1511">                            ui.selectNextPossibleValue();</span>
                        }
                    } else {
<span class="nc" id="L1514">                        comboBox.setPopupVisible(true);</span>
                    }
                }
            }
<span class="nc bnc" id="L1518" title="All 2 branches missed.">            else if (key == DOWN_2) {</span>
                // Special case in which pressing the arrow keys will not
                // make the popup appear - except for editable combo boxes
                // and combo boxes inside a table.
<span class="nc bnc" id="L1522" title="All 2 branches missed.">                if (comboBox.isShowing() ) {</span>
<span class="nc bnc" id="L1523" title="All 4 branches missed.">                    if ( (comboBox.isEditable() ||</span>
<span class="nc bnc" id="L1524" title="All 2 branches missed.">                            (ui != null &amp;&amp; ui.isTableCellEditor()))</span>
<span class="nc bnc" id="L1525" title="All 2 branches missed.">                         &amp;&amp; !comboBox.isPopupVisible() ) {</span>
<span class="nc" id="L1526">                        comboBox.setPopupVisible(true);</span>
                    } else {
<span class="nc bnc" id="L1528" title="All 2 branches missed.">                        if (ui != null) {</span>
<span class="nc" id="L1529">                            ui.selectNextPossibleValue();</span>
                        }
                    }
                }
            }
<span class="nc bnc" id="L1534" title="All 4 branches missed.">            else if (key == TOGGLE || key == TOGGLE_2) {</span>
<span class="nc bnc" id="L1535" title="All 6 branches missed.">                if (ui != null &amp;&amp; (key == TOGGLE || !comboBox.isEditable())) {</span>
<span class="nc bnc" id="L1536" title="All 2 branches missed.">                    if ( ui.isTableCellEditor() ) {</span>
                        // Forces the selection of the list item if the
                        // combo box is in a JTable.
<span class="nc" id="L1539">                        comboBox.setSelectedIndex(ui.popup.getList().</span>
<span class="nc" id="L1540">                                                  getSelectedIndex());</span>
                    }
                    else {
<span class="nc bnc" id="L1543" title="All 2 branches missed.">                        comboBox.setPopupVisible(!comboBox.isPopupVisible());</span>
                    }
                }
            }
<span class="nc bnc" id="L1547" title="All 2 branches missed.">            else if (key == UP) {</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">                if (ui != null) {</span>
<span class="nc bnc" id="L1549" title="All 2 branches missed.">                    if (ui.isPopupVisible(comboBox)) {</span>
<span class="nc" id="L1550">                        ui.selectPreviousPossibleValue();</span>
                    }
<span class="nc bnc" id="L1552" title="All 2 branches missed.">                    else if (DefaultLookup.getBoolean(comboBox, ui,</span>
                                    &quot;ComboBox.showPopupOnNavigation&quot;, false)) {
<span class="nc" id="L1554">                        ui.setPopupVisible(comboBox, true);</span>
                    }
                }
            }
<span class="nc bnc" id="L1558" title="All 2 branches missed.">            else if (key == UP_2) {</span>
                 // Special case in which pressing the arrow keys will not
                 // make the popup appear - except for editable combo boxes.
<span class="nc bnc" id="L1561" title="All 4 branches missed.">                 if (comboBox.isShowing() &amp;&amp; ui != null) {</span>
<span class="nc bnc" id="L1562" title="All 4 branches missed.">                     if ( comboBox.isEditable() &amp;&amp; !comboBox.isPopupVisible()) {</span>
<span class="nc" id="L1563">                         comboBox.setPopupVisible(true);</span>
                     } else {
<span class="nc" id="L1565">                         ui.selectPreviousPossibleValue();</span>
                     }
                 }
             }

<span class="nc bnc" id="L1570" title="All 2 branches missed.">            else if (key == ENTER) {</span>
<span class="nc bnc" id="L1571" title="All 2 branches missed.">                if (comboBox.isPopupVisible()) {</span>
                    // If ComboBox.noActionOnKeyNavigation is set,
                    // forse selection of list item
<span class="nc bnc" id="L1574" title="All 2 branches missed.">                    if (UIManager.getBoolean(&quot;ComboBox.noActionOnKeyNavigation&quot;)) {</span>
<span class="nc" id="L1575">                        Object listItem = ui.popup.getList().getSelectedValue();</span>
<span class="nc bnc" id="L1576" title="All 2 branches missed.">                        if (listItem != null) {</span>
<span class="nc" id="L1577">                            comboBox.getEditor().setItem(listItem);</span>
<span class="nc" id="L1578">                            comboBox.setSelectedItem(listItem);</span>
                        }
<span class="nc" id="L1580">                        comboBox.setPopupVisible(false);</span>
<span class="nc" id="L1581">                    } else {</span>
                        // Forces the selection of the list item
<span class="nc" id="L1583">                        boolean isEnterSelectablePopup =</span>
<span class="nc" id="L1584">                                UIManager.getBoolean(&quot;ComboBox.isEnterSelectablePopup&quot;);</span>
<span class="nc bnc" id="L1585" title="All 4 branches missed.">                        if (!comboBox.isEditable() || isEnterSelectablePopup</span>
<span class="nc bnc" id="L1586" title="All 2 branches missed.">                                || ui.isTableCellEditor) {</span>
<span class="nc" id="L1587">                            Object listItem = ui.popup.getList().getSelectedValue();</span>
<span class="nc bnc" id="L1588" title="All 2 branches missed.">                            if (listItem != null) {</span>
                                // Use the selected value from popup
                                // to set the selected item in combo box,
                                // but ensure before that JComboBox.actionPerformed()
                                // won't use editor's value to set the selected item
<span class="nc" id="L1593">                                comboBox.getEditor().setItem(listItem);</span>
<span class="nc" id="L1594">                                comboBox.setSelectedItem(listItem);</span>
                            }
                        }
<span class="nc" id="L1597">                        comboBox.setPopupVisible(false);</span>
<span class="nc" id="L1598">                    }</span>
                }
                else {
                    // Hide combo box if it is a table cell editor
<span class="nc bnc" id="L1602" title="All 4 branches missed.">                    if (ui.isTableCellEditor &amp;&amp; !comboBox.isEditable()) {</span>
<span class="nc" id="L1603">                        comboBox.setSelectedItem(comboBox.getSelectedItem());</span>
                    }
                    // Call the default button binding.
                    // This is a pretty messy way of passing an event through
                    // to the root pane.
<span class="nc" id="L1608">                    JRootPane root = SwingUtilities.getRootPane(comboBox);</span>
<span class="nc bnc" id="L1609" title="All 2 branches missed.">                    if (root != null) {</span>
<span class="nc" id="L1610">                        InputMap im = root.getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW);</span>
<span class="nc" id="L1611">                        ActionMap am = root.getActionMap();</span>
<span class="nc bnc" id="L1612" title="All 4 branches missed.">                        if (im != null &amp;&amp; am != null) {</span>
<span class="nc" id="L1613">                            Object obj = im.get(KeyStroke.getKeyStroke(KeyEvent.VK_ENTER,0));</span>
<span class="nc bnc" id="L1614" title="All 2 branches missed.">                            if (obj != null) {</span>
<span class="nc" id="L1615">                                Action action = am.get(obj);</span>
<span class="nc bnc" id="L1616" title="All 2 branches missed.">                                if (action != null) {</span>
<span class="nc" id="L1617">                                    action.actionPerformed(new ActionEvent(</span>
<span class="nc" id="L1618">                                     root, e.getID(), e.getActionCommand(),</span>
<span class="nc" id="L1619">                                     e.getWhen(), e.getModifiers()));</span>
                                }
                            }
                        }
                    }
                }
            }
<span class="nc" id="L1626">        }</span>

        private int getNextIndex(JComboBox comboBox, String key) {
<span class="nc" id="L1629">            int listHeight = comboBox.getMaximumRowCount();</span>

<span class="nc" id="L1631">            int selectedIndex = comboBox.getSelectedIndex();</span>
<span class="nc bnc" id="L1632" title="All 2 branches missed.">            if (UIManager.getBoolean(&quot;ComboBox.noActionOnKeyNavigation&quot;)</span>
<span class="nc bnc" id="L1633" title="All 2 branches missed.">                    &amp;&amp; (comboBox.getUI() instanceof BasicComboBoxUI)) {</span>
<span class="nc" id="L1634">                selectedIndex = ((BasicComboBoxUI) comboBox.getUI()).listBox.getSelectedIndex();</span>
            }

<span class="nc bnc" id="L1637" title="All 2 branches missed.">            if (key == PAGE_UP) {</span>
<span class="nc" id="L1638">                int index = selectedIndex - listHeight;</span>
<span class="nc bnc" id="L1639" title="All 2 branches missed.">                return (index &lt; 0 ? 0: index);</span>
            }
<span class="nc bnc" id="L1641" title="All 2 branches missed.">            else if (key == PAGE_DOWN) {</span>
<span class="nc" id="L1642">                int index = selectedIndex + listHeight;</span>
<span class="nc" id="L1643">                int max = comboBox.getItemCount();</span>
<span class="nc bnc" id="L1644" title="All 2 branches missed.">                return (index &lt; max ? index: max-1);</span>
            }
<span class="nc bnc" id="L1646" title="All 2 branches missed.">            else if (key == HOME) {</span>
<span class="nc" id="L1647">                return 0;</span>
            }
<span class="nc bnc" id="L1649" title="All 2 branches missed.">            else if (key == END) {</span>
<span class="nc" id="L1650">                return comboBox.getItemCount() - 1;</span>
            }
<span class="nc" id="L1652">            return comboBox.getSelectedIndex();</span>
        }

        public boolean isEnabled(Object c) {
<span class="nc bnc" id="L1656" title="All 2 branches missed.">            if (getName() == HIDE) {</span>
<span class="nc bnc" id="L1657" title="All 4 branches missed.">                return (c != null &amp;&amp; ((JComboBox)c).isPopupVisible());</span>
            }
<span class="nc" id="L1659">            return true;</span>
        }
    }
    //
    // end Keyboard Action Management
    //===============================


    //
    // Shared Handler, implements all listeners
    //
<span class="nc" id="L1670">    private class Handler implements ActionListener, FocusListener,</span>
                                     KeyListener, LayoutManager,
                                     ListDataListener, PropertyChangeListener {
        //
        // PropertyChangeListener
        //
        public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L1677">            String propertyName = e.getPropertyName();</span>
<span class="nc bnc" id="L1678" title="All 2 branches missed.">            if (e.getSource() == editor){</span>
                // If the border of the editor changes then this can effect
                // the size of the editor which can cause the combo's size to
                // become invalid so we need to clear size caches
<span class="nc bnc" id="L1682" title="All 2 branches missed.">                if (&quot;border&quot;.equals(propertyName)){</span>
<span class="nc" id="L1683">                    isMinimumSizeDirty = true;</span>
<span class="nc" id="L1684">                    isDisplaySizeDirty = true;</span>
<span class="nc" id="L1685">                    comboBox.revalidate();</span>
                }
            } else {
<span class="nc" id="L1688">                JComboBox comboBox = (JComboBox)e.getSource();</span>
<span class="nc bnc" id="L1689" title="All 2 branches missed.">                if ( propertyName == &quot;model&quot; ) {</span>
<span class="nc" id="L1690">                    ComboBoxModel newModel = (ComboBoxModel)e.getNewValue();</span>
<span class="nc" id="L1691">                    ComboBoxModel oldModel = (ComboBoxModel)e.getOldValue();</span>

<span class="nc bnc" id="L1693" title="All 4 branches missed.">                    if ( oldModel != null &amp;&amp; listDataListener != null ) {</span>
<span class="nc" id="L1694">                        oldModel.removeListDataListener( listDataListener );</span>
                    }

<span class="nc bnc" id="L1697" title="All 4 branches missed.">                    if ( newModel != null &amp;&amp; listDataListener != null ) {</span>
<span class="nc" id="L1698">                        newModel.addListDataListener( listDataListener );</span>
                    }

<span class="nc bnc" id="L1701" title="All 2 branches missed.">                    if ( editor != null ) {</span>
<span class="nc" id="L1702">                        comboBox.configureEditor( comboBox.getEditor(), comboBox.getSelectedItem() );</span>
                    }
<span class="nc" id="L1704">                    isMinimumSizeDirty = true;</span>
<span class="nc" id="L1705">                    isDisplaySizeDirty = true;</span>
<span class="nc" id="L1706">                    comboBox.revalidate();</span>
<span class="nc" id="L1707">                    comboBox.repaint();</span>
<span class="nc" id="L1708">                }</span>
<span class="nc bnc" id="L1709" title="All 4 branches missed.">                else if ( propertyName == &quot;editor&quot; &amp;&amp; comboBox.isEditable() ) {</span>
<span class="nc" id="L1710">                    addEditor();</span>
<span class="nc" id="L1711">                    comboBox.revalidate();</span>
                }
<span class="nc bnc" id="L1713" title="All 2 branches missed.">                else if ( propertyName == &quot;editable&quot; ) {</span>
<span class="nc bnc" id="L1714" title="All 2 branches missed.">                    if ( comboBox.isEditable() ) {</span>
<span class="nc" id="L1715">                        comboBox.setRequestFocusEnabled( false );</span>
<span class="nc" id="L1716">                        addEditor();</span>
                    } else {
<span class="nc" id="L1718">                        comboBox.setRequestFocusEnabled( true );</span>
<span class="nc" id="L1719">                        removeEditor();</span>
                    }
<span class="nc" id="L1721">                    updateToolTipTextForChildren();</span>
<span class="nc" id="L1722">                    comboBox.revalidate();</span>
                }
<span class="nc bnc" id="L1724" title="All 2 branches missed.">                else if ( propertyName == &quot;enabled&quot; ) {</span>
<span class="nc" id="L1725">                    boolean enabled = comboBox.isEnabled();</span>
<span class="nc bnc" id="L1726" title="All 2 branches missed.">                    if ( editor != null )</span>
<span class="nc" id="L1727">                        editor.setEnabled(enabled);</span>
<span class="nc bnc" id="L1728" title="All 2 branches missed.">                    if ( arrowButton != null )</span>
<span class="nc" id="L1729">                        arrowButton.setEnabled(enabled);</span>
<span class="nc" id="L1730">                    comboBox.repaint();</span>
<span class="nc" id="L1731">                }</span>
<span class="nc bnc" id="L1732" title="All 2 branches missed.">                else if ( propertyName == &quot;focusable&quot; ) {</span>
<span class="nc" id="L1733">                    boolean focusable = comboBox.isFocusable();</span>
<span class="nc bnc" id="L1734" title="All 2 branches missed.">                    if ( editor != null )</span>
<span class="nc" id="L1735">                        editor.setFocusable(focusable);</span>
<span class="nc bnc" id="L1736" title="All 2 branches missed.">                    if ( arrowButton != null )</span>
<span class="nc" id="L1737">                        arrowButton.setFocusable(focusable);</span>
<span class="nc" id="L1738">                    comboBox.repaint();</span>
<span class="nc" id="L1739">                }</span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">                else if ( propertyName == &quot;maximumRowCount&quot; ) {</span>
<span class="nc bnc" id="L1741" title="All 2 branches missed.">                    if ( isPopupVisible( comboBox ) ) {</span>
<span class="nc" id="L1742">                        setPopupVisible(comboBox, false);</span>
<span class="nc" id="L1743">                        setPopupVisible(comboBox, true);</span>
                    }
                }
<span class="nc bnc" id="L1746" title="All 2 branches missed.">                else if ( propertyName == &quot;font&quot; ) {</span>
<span class="nc" id="L1747">                    listBox.setFont( comboBox.getFont() );</span>
<span class="nc bnc" id="L1748" title="All 2 branches missed.">                    if ( editor != null ) {</span>
<span class="nc" id="L1749">                        editor.setFont( comboBox.getFont() );</span>
                    }
<span class="nc" id="L1751">                    isMinimumSizeDirty = true;</span>
<span class="nc" id="L1752">                    isDisplaySizeDirty = true;</span>
<span class="nc" id="L1753">                    comboBox.validate();</span>
                }
<span class="nc bnc" id="L1755" title="All 2 branches missed.">                else if ( propertyName == JComponent.TOOL_TIP_TEXT_KEY ) {</span>
<span class="nc" id="L1756">                    updateToolTipTextForChildren();</span>
                }
<span class="nc bnc" id="L1758" title="All 2 branches missed.">                else if ( propertyName == BasicComboBoxUI.IS_TABLE_CELL_EDITOR ) {</span>
<span class="nc" id="L1759">                    Boolean inTable = (Boolean)e.getNewValue();</span>
<span class="nc bnc" id="L1760" title="All 2 branches missed.">                    isTableCellEditor = inTable.equals(Boolean.TRUE) ? true : false;</span>
<span class="nc" id="L1761">                }</span>
<span class="nc bnc" id="L1762" title="All 2 branches missed.">                else if (propertyName == &quot;prototypeDisplayValue&quot;) {</span>
<span class="nc" id="L1763">                    isMinimumSizeDirty = true;</span>
<span class="nc" id="L1764">                    isDisplaySizeDirty = true;</span>
<span class="nc" id="L1765">                    comboBox.revalidate();</span>
                }
<span class="nc bnc" id="L1767" title="All 2 branches missed.">                else if (propertyName == &quot;renderer&quot;) {</span>
<span class="nc" id="L1768">                    isMinimumSizeDirty = true;</span>
<span class="nc" id="L1769">                    isDisplaySizeDirty = true;</span>
<span class="nc" id="L1770">                    comboBox.revalidate();</span>
                }
            }
<span class="nc" id="L1773">        }</span>


        //
        // KeyListener
        //

        // This listener checks to see if the key event isn't a navigation
        // key.  If it finds a key event that wasn't a navigation key it
        // dispatches it to JComboBox.selectWithKeyChar() so that it can do
        // type-ahead.
        public void keyPressed( KeyEvent e ) {
<span class="nc bnc" id="L1785" title="All 2 branches missed.">            if ( isNavigationKey(e.getKeyCode(), e.getModifiers()) ) {</span>
<span class="nc" id="L1786">                lastTime = 0L;</span>
<span class="nc bnc" id="L1787" title="All 4 branches missed.">            } else if ( comboBox.isEnabled() &amp;&amp; comboBox.getModel().getSize()!=0 &amp;&amp;</span>
<span class="nc bnc" id="L1788" title="All 4 branches missed.">                        isTypeAheadKey( e ) &amp;&amp; e.getKeyChar() != KeyEvent.CHAR_UNDEFINED) {</span>
<span class="nc" id="L1789">                time = e.getWhen();</span>
<span class="nc bnc" id="L1790" title="All 2 branches missed.">                if ( comboBox.selectWithKeyChar(e.getKeyChar()) ) {</span>
<span class="nc" id="L1791">                    e.consume();</span>
                }
            }
<span class="nc" id="L1794">        }</span>

        public void keyTyped(KeyEvent e) {
<span class="nc" id="L1797">        }</span>

        public void keyReleased(KeyEvent e) {
<span class="nc" id="L1800">        }</span>

        private boolean isTypeAheadKey( KeyEvent e ) {
<span class="nc bnc" id="L1803" title="All 4 branches missed.">            return !e.isAltDown() &amp;&amp; !BasicGraphicsUtils.isMenuShortcutKeyDown(e);</span>
        }

        //
        // FocusListener
        //
        // NOTE: The class is added to both the Editor and ComboBox.
        // The combo box listener hides the popup when the focus is lost.
        // It also repaints when focus is gained or lost.

        public void focusGained( FocusEvent e ) {
<span class="nc" id="L1814">            ComboBoxEditor comboBoxEditor = comboBox.getEditor();</span>

<span class="nc bnc" id="L1816" title="All 2 branches missed.">            if ( (comboBoxEditor != null) &amp;&amp;</span>
<span class="nc bnc" id="L1817" title="All 2 branches missed.">                 (e.getSource() == comboBoxEditor.getEditorComponent()) ) {</span>
<span class="nc" id="L1818">                return;</span>
            }
<span class="nc" id="L1820">            hasFocus = true;</span>
<span class="nc" id="L1821">            comboBox.repaint();</span>

<span class="nc bnc" id="L1823" title="All 4 branches missed.">            if (comboBox.isEditable() &amp;&amp; editor != null) {</span>
<span class="nc" id="L1824">                editor.requestFocus();</span>
            }
<span class="nc" id="L1826">        }</span>

        public void focusLost( FocusEvent e ) {
<span class="nc" id="L1829">            ComboBoxEditor editor = comboBox.getEditor();</span>
<span class="nc bnc" id="L1830" title="All 2 branches missed.">            if ( (editor != null) &amp;&amp;</span>
<span class="nc bnc" id="L1831" title="All 2 branches missed.">                 (e.getSource() == editor.getEditorComponent()) ) {</span>
<span class="nc" id="L1832">                Object item = editor.getItem();</span>

<span class="nc" id="L1834">                Object selectedItem = comboBox.getSelectedItem();</span>
<span class="nc bnc" id="L1835" title="All 6 branches missed.">                if (!e.isTemporary() &amp;&amp; item != null &amp;&amp;</span>
<span class="nc bnc" id="L1836" title="All 2 branches missed.">                    !item.equals((selectedItem == null) ? &quot;&quot; : selectedItem )) {</span>
<span class="nc" id="L1837">                    comboBox.actionPerformed</span>
<span class="nc" id="L1838">                        (new ActionEvent(editor, 0, &quot;&quot;,</span>
<span class="nc" id="L1839">                                      EventQueue.getMostRecentEventTime(), 0));</span>
                }
            }

<span class="nc" id="L1843">            hasFocus = false;</span>
<span class="nc bnc" id="L1844" title="All 2 branches missed.">            if (!e.isTemporary()) {</span>
<span class="nc" id="L1845">                setPopupVisible(comboBox, false);</span>
            }
<span class="nc" id="L1847">            comboBox.repaint();</span>
<span class="nc" id="L1848">        }</span>

        //
        // ListDataListener
        //

        // This listener watches for changes in the ComboBoxModel
        public void contentsChanged( ListDataEvent e ) {
<span class="nc bnc" id="L1856" title="All 4 branches missed.">            if ( !(e.getIndex0() == -1 &amp;&amp; e.getIndex1() == -1) ) {</span>
<span class="nc" id="L1857">                isMinimumSizeDirty = true;</span>
<span class="nc" id="L1858">                comboBox.revalidate();</span>
            }

            // set the editor with the selected item since this
            // is the event handler for a selected item change.
<span class="nc bnc" id="L1863" title="All 4 branches missed.">            if (comboBox.isEditable() &amp;&amp; editor != null) {</span>
<span class="nc" id="L1864">                comboBox.configureEditor( comboBox.getEditor(),</span>
<span class="nc" id="L1865">                                          comboBox.getSelectedItem() );</span>
            }

<span class="nc" id="L1868">            isDisplaySizeDirty = true;</span>
<span class="nc" id="L1869">            comboBox.repaint();</span>
<span class="nc" id="L1870">        }</span>

        public void intervalAdded( ListDataEvent e ) {
<span class="nc" id="L1873">            contentsChanged( e );</span>
<span class="nc" id="L1874">        }</span>

        public void intervalRemoved( ListDataEvent e ) {
<span class="nc" id="L1877">            contentsChanged( e );</span>
<span class="nc" id="L1878">        }</span>

        //
        // LayoutManager
        //

        // This layout manager handles the 'standard' layout of combo boxes.
        // It puts the arrow button to the right and the editor to the left.
        // If there is no editor it still keeps the arrow button to the right.
<span class="nc" id="L1887">        public void addLayoutComponent(String name, Component comp) {}</span>

<span class="nc" id="L1889">        public void removeLayoutComponent(Component comp) {}</span>

        public Dimension preferredLayoutSize(Container parent) {
<span class="nc" id="L1892">            return parent.getPreferredSize();</span>
        }

        public Dimension minimumLayoutSize(Container parent) {
<span class="nc" id="L1896">            return parent.getMinimumSize();</span>
        }

        public void layoutContainer(Container parent) {
<span class="nc" id="L1900">            JComboBox cb = (JComboBox)parent;</span>
<span class="nc" id="L1901">            int width = cb.getWidth();</span>
<span class="nc" id="L1902">            int height = cb.getHeight();</span>

<span class="nc" id="L1904">            Insets insets = getInsets();</span>
<span class="nc" id="L1905">            int buttonHeight = height - (insets.top + insets.bottom);</span>
<span class="nc" id="L1906">            int buttonWidth = buttonHeight;</span>
<span class="nc bnc" id="L1907" title="All 2 branches missed.">            if (arrowButton != null) {</span>
<span class="nc" id="L1908">                Insets arrowInsets = arrowButton.getInsets();</span>
<span class="nc bnc" id="L1909" title="All 2 branches missed.">                buttonWidth = squareButton ?</span>
                    buttonHeight :
<span class="nc" id="L1911">                    arrowButton.getPreferredSize().width + arrowInsets.left + arrowInsets.right;</span>
            }
            Rectangle cvb;

<span class="nc bnc" id="L1915" title="All 2 branches missed.">            if (arrowButton != null) {</span>
<span class="nc bnc" id="L1916" title="All 2 branches missed.">                if (BasicGraphicsUtils.isLeftToRight(cb)) {</span>
<span class="nc" id="L1917">                    arrowButton.setBounds(width - (insets.right + buttonWidth),</span>
                            insets.top, buttonWidth, buttonHeight);
                } else {
<span class="nc" id="L1920">                    arrowButton.setBounds(insets.left, insets.top,</span>
                            buttonWidth, buttonHeight);
                }
            }
<span class="nc bnc" id="L1924" title="All 2 branches missed.">            if ( editor != null ) {</span>
<span class="nc" id="L1925">                cvb = rectangleForCurrentValue();</span>
<span class="nc" id="L1926">                editor.setBounds(cvb);</span>
            }
<span class="nc" id="L1928">        }</span>

        //
        // ActionListener
        //
        // Fix for 4515752: Forward the Enter pressed on the
        // editable combo box to the default button

        // Note: This could depend on event ordering. The first ActionEvent
        // from the editor may be handled by the JComboBox in which case, the
        // enterPressed action will always be invoked.
        public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L1940">            Object item = comboBox.getEditor().getItem();</span>
<span class="nc bnc" id="L1941" title="All 2 branches missed.">            if (item != null) {</span>
<span class="nc bnc" id="L1942" title="All 4 branches missed.">             if(!comboBox.isPopupVisible() &amp;&amp; !item.equals(comboBox.getSelectedItem())) {</span>
<span class="nc" id="L1943">              comboBox.setSelectedItem(comboBox.getEditor().getItem());</span>
             }
<span class="nc" id="L1945">             ActionMap am = comboBox.getActionMap();</span>
<span class="nc bnc" id="L1946" title="All 2 branches missed.">             if (am != null) {</span>
<span class="nc" id="L1947">                Action action = am.get(&quot;enterPressed&quot;);</span>
<span class="nc bnc" id="L1948" title="All 2 branches missed.">                if (action != null) {</span>
<span class="nc" id="L1949">                    action.actionPerformed(new ActionEvent(comboBox, evt.getID(),</span>
<span class="nc" id="L1950">                                           evt.getActionCommand(),</span>
<span class="nc" id="L1951">                                           evt.getModifiers()));</span>
                }
            }
       }
<span class="nc" id="L1955">   }</span>
  }

<span class="nc" id="L1958">    class DefaultKeySelectionManager implements JComboBox.KeySelectionManager, UIResource {</span>
<span class="nc" id="L1959">        private String prefix = &quot;&quot;;</span>
<span class="nc" id="L1960">        private String typedString = &quot;&quot;;</span>

        public int selectionForKey(char aKey,ComboBoxModel aModel) {
<span class="nc bnc" id="L1963" title="All 2 branches missed.">            if (lastTime == 0L) {</span>
<span class="nc" id="L1964">                prefix = &quot;&quot;;</span>
<span class="nc" id="L1965">                typedString = &quot;&quot;;</span>
            }
<span class="nc" id="L1967">            boolean startingFromSelection = true;</span>

<span class="nc" id="L1969">            int startIndex = comboBox.getSelectedIndex();</span>
<span class="nc bnc" id="L1970" title="All 2 branches missed.">            if (time - lastTime &lt; timeFactor) {</span>
<span class="nc" id="L1971">                typedString += aKey;</span>
<span class="nc bnc" id="L1972" title="All 4 branches missed.">                if((prefix.length() == 1) &amp;&amp; (aKey == prefix.charAt(0))) {</span>
                    // Subsequent same key presses move the keyboard focus to the next
                    // object that starts with the same letter.
<span class="nc" id="L1975">                    startIndex++;</span>
                } else {
<span class="nc" id="L1977">                    prefix = typedString;</span>
                }
            } else {
<span class="nc" id="L1980">                startIndex++;</span>
<span class="nc" id="L1981">                typedString = &quot;&quot; + aKey;</span>
<span class="nc" id="L1982">                prefix = typedString;</span>
            }
<span class="nc" id="L1984">            lastTime = time;</span>

<span class="nc bnc" id="L1986" title="All 4 branches missed.">            if (startIndex &lt; 0 || startIndex &gt;= aModel.getSize()) {</span>
<span class="nc" id="L1987">                startingFromSelection = false;</span>
<span class="nc" id="L1988">                startIndex = 0;</span>
            }
<span class="nc" id="L1990">            int index = listBox.getNextMatch(prefix, startIndex,</span>
                                             Position.Bias.Forward);
<span class="nc bnc" id="L1992" title="All 4 branches missed.">            if (index &lt; 0 &amp;&amp; startingFromSelection) { // wrap</span>
<span class="nc" id="L1993">                index = listBox.getNextMatch(prefix, 0,</span>
                                             Position.Bias.Forward);
            }
<span class="nc" id="L1996">            return index;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>