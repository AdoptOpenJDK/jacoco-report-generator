<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>BasicPopupMenuUI.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.plaf.basic</a> &gt; <span class="el_source">BasicPopupMenuUI.java</span></div><h1>BasicPopupMenuUI.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing.plaf.basic;

import javax.swing.*;
import javax.swing.event.*;
import javax.swing.plaf.*;
import javax.swing.plaf.basic.*;
import javax.swing.border.*;

import java.applet.Applet;

import java.awt.Component;
import java.awt.Container;
import java.awt.Dimension;
import java.awt.KeyboardFocusManager;
import java.awt.Window;
import java.awt.event.*;
import java.awt.AWTEvent;
import java.awt.Toolkit;

import java.beans.PropertyChangeListener;
import java.beans.PropertyChangeEvent;

import java.util.*;

import sun.swing.DefaultLookup;
import sun.swing.UIAction;

import sun.awt.AppContext;

/**
 * A Windows L&amp;amp;F implementation of PopupMenuUI.  This implementation
 * is a &quot;combined&quot; view/controller.
 *
 * @author Georges Saab
 * @author David Karlton
 * @author Arnaud Weber
 */
public class BasicPopupMenuUI extends PopupMenuUI {
<span class="nc" id="L64">    static final StringBuilder MOUSE_GRABBER_KEY = new StringBuilder(</span>
                   &quot;javax.swing.plaf.basic.BasicPopupMenuUI.MouseGrabber&quot;);
<span class="nc" id="L66">    static final StringBuilder MENU_KEYBOARD_HELPER_KEY = new StringBuilder(</span>
                   &quot;javax.swing.plaf.basic.BasicPopupMenuUI.MenuKeyboardHelper&quot;);

<span class="nc" id="L69">    protected JPopupMenu popupMenu = null;</span>
<span class="nc" id="L70">    private transient PopupMenuListener popupMenuListener = null;</span>
<span class="nc" id="L71">    private MenuKeyListener menuKeyListener = null;</span>

    private static boolean checkedUnpostPopup;
    private static boolean unpostPopup;

    public static ComponentUI createUI(JComponent x) {
<span class="nc" id="L77">        return new BasicPopupMenuUI();</span>
    }

<span class="nc" id="L80">    public BasicPopupMenuUI() {</span>
<span class="nc" id="L81">        BasicLookAndFeel.needsEventHelper = true;</span>
<span class="nc" id="L82">        LookAndFeel laf = UIManager.getLookAndFeel();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (laf instanceof BasicLookAndFeel) {</span>
<span class="nc" id="L84">            ((BasicLookAndFeel)laf).installAWTEventListener();</span>
        }
<span class="nc" id="L86">    }</span>

    public void installUI(JComponent c) {
<span class="nc" id="L89">        popupMenu = (JPopupMenu) c;</span>

<span class="nc" id="L91">        installDefaults();</span>
<span class="nc" id="L92">        installListeners();</span>
<span class="nc" id="L93">        installKeyboardActions();</span>
<span class="nc" id="L94">    }</span>

    public void installDefaults() {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (popupMenu.getLayout() == null ||</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            popupMenu.getLayout() instanceof UIResource)</span>
<span class="nc" id="L99">            popupMenu.setLayout(new DefaultMenuLayout(popupMenu, BoxLayout.Y_AXIS));</span>

<span class="nc" id="L101">        LookAndFeel.installProperty(popupMenu, &quot;opaque&quot;, Boolean.TRUE);</span>
<span class="nc" id="L102">        LookAndFeel.installBorder(popupMenu, &quot;PopupMenu.border&quot;);</span>
<span class="nc" id="L103">        LookAndFeel.installColorsAndFont(popupMenu,</span>
                                         &quot;PopupMenu.background&quot;,
                                         &quot;PopupMenu.foreground&quot;,
                                         &quot;PopupMenu.font&quot;);
<span class="nc" id="L107">    }</span>

    protected void installListeners() {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (popupMenuListener == null) {</span>
<span class="nc" id="L111">            popupMenuListener = new BasicPopupMenuListener();</span>
        }
<span class="nc" id="L113">        popupMenu.addPopupMenuListener(popupMenuListener);</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (menuKeyListener == null) {</span>
<span class="nc" id="L116">            menuKeyListener = new BasicMenuKeyListener();</span>
        }
<span class="nc" id="L118">        popupMenu.addMenuKeyListener(menuKeyListener);</span>

<span class="nc" id="L120">        AppContext context = AppContext.getAppContext();</span>
<span class="nc" id="L121">        synchronized (MOUSE_GRABBER_KEY) {</span>
<span class="nc" id="L122">            MouseGrabber mouseGrabber = (MouseGrabber)context.get(</span>
                                                     MOUSE_GRABBER_KEY);
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (mouseGrabber == null) {</span>
<span class="nc" id="L125">                mouseGrabber = new MouseGrabber();</span>
<span class="nc" id="L126">                context.put(MOUSE_GRABBER_KEY, mouseGrabber);</span>
            }
<span class="nc" id="L128">        }</span>
<span class="nc" id="L129">        synchronized (MENU_KEYBOARD_HELPER_KEY) {</span>
<span class="nc" id="L130">            MenuKeyboardHelper helper =</span>
<span class="nc" id="L131">                    (MenuKeyboardHelper)context.get(MENU_KEYBOARD_HELPER_KEY);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            if (helper == null) {</span>
<span class="nc" id="L133">                helper = new MenuKeyboardHelper();</span>
<span class="nc" id="L134">                context.put(MENU_KEYBOARD_HELPER_KEY, helper);</span>
<span class="nc" id="L135">                MenuSelectionManager msm = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L136">                msm.addChangeListener(helper);</span>
            }
<span class="nc" id="L138">        }</span>
<span class="nc" id="L139">    }</span>

    protected void installKeyboardActions() {
<span class="nc" id="L142">    }</span>

    static InputMap getInputMap(JPopupMenu popup, JComponent c) {
<span class="nc" id="L145">        InputMap windowInputMap = null;</span>
<span class="nc" id="L146">        Object[] bindings = (Object[])UIManager.get(&quot;PopupMenu.selectedWindowInputMapBindings&quot;);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (bindings != null) {</span>
<span class="nc" id="L148">            windowInputMap = LookAndFeel.makeComponentInputMap(c, bindings);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">            if (!popup.getComponentOrientation().isLeftToRight()) {</span>
<span class="nc" id="L150">                Object[] km = (Object[])UIManager.get(&quot;PopupMenu.selectedWindowInputMapBindings.RightToLeft&quot;);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                if (km != null) {</span>
<span class="nc" id="L152">                    InputMap rightToLeftInputMap = LookAndFeel.makeComponentInputMap(c, km);</span>
<span class="nc" id="L153">                    rightToLeftInputMap.setParent(windowInputMap);</span>
<span class="nc" id="L154">                    windowInputMap = rightToLeftInputMap;</span>
                }
            }
        }
<span class="nc" id="L158">        return windowInputMap;</span>
    }

    static ActionMap getActionMap() {
<span class="nc" id="L162">        return LazyActionMap.getActionMap(BasicPopupMenuUI.class,</span>
                                          &quot;PopupMenu.actionMap&quot;);
    }

    static void loadActionMap(LazyActionMap map) {
<span class="nc" id="L167">        map.put(new Actions(Actions.CANCEL));</span>
<span class="nc" id="L168">        map.put(new Actions(Actions.SELECT_NEXT));</span>
<span class="nc" id="L169">        map.put(new Actions(Actions.SELECT_PREVIOUS));</span>
<span class="nc" id="L170">        map.put(new Actions(Actions.SELECT_PARENT));</span>
<span class="nc" id="L171">        map.put(new Actions(Actions.SELECT_CHILD));</span>
<span class="nc" id="L172">        map.put(new Actions(Actions.RETURN));</span>
<span class="nc" id="L173">        BasicLookAndFeel.installAudioActionMap(map);</span>
<span class="nc" id="L174">    }</span>

    public void uninstallUI(JComponent c) {
<span class="nc" id="L177">        uninstallDefaults();</span>
<span class="nc" id="L178">        uninstallListeners();</span>
<span class="nc" id="L179">        uninstallKeyboardActions();</span>

<span class="nc" id="L181">        popupMenu = null;</span>
<span class="nc" id="L182">    }</span>

    protected void uninstallDefaults() {
<span class="nc" id="L185">        LookAndFeel.uninstallBorder(popupMenu);</span>
<span class="nc" id="L186">    }</span>

    protected void uninstallListeners() {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (popupMenuListener != null) {</span>
<span class="nc" id="L190">            popupMenu.removePopupMenuListener(popupMenuListener);</span>
        }
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (menuKeyListener != null) {</span>
<span class="nc" id="L193">            popupMenu.removeMenuKeyListener(menuKeyListener);</span>
        }
<span class="nc" id="L195">    }</span>

    protected void uninstallKeyboardActions() {
<span class="nc" id="L198">        SwingUtilities.replaceUIActionMap(popupMenu, null);</span>
<span class="nc" id="L199">        SwingUtilities.replaceUIInputMap(popupMenu,</span>
                                  JComponent.WHEN_IN_FOCUSED_WINDOW, null);
<span class="nc" id="L201">    }</span>

    static MenuElement getFirstPopup() {
<span class="nc" id="L204">        MenuSelectionManager msm = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L205">        MenuElement[] p = msm.getSelectedPath();</span>
<span class="nc" id="L206">        MenuElement me = null;</span>

<span class="nc bnc" id="L208" title="All 4 branches missed.">        for(int i = 0 ; me == null &amp;&amp; i &lt; p.length ; i++) {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (p[i] instanceof JPopupMenu)</span>
<span class="nc" id="L210">                me = p[i];</span>
        }

<span class="nc" id="L213">        return me;</span>
    }

    static JPopupMenu getLastPopup() {
<span class="nc" id="L217">        MenuSelectionManager msm = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L218">        MenuElement[] p = msm.getSelectedPath();</span>
<span class="nc" id="L219">        JPopupMenu popup = null;</span>

<span class="nc bnc" id="L221" title="All 4 branches missed.">        for(int i = p.length - 1; popup == null &amp;&amp; i &gt;= 0; i--) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (p[i] instanceof JPopupMenu)</span>
<span class="nc" id="L223">                popup = (JPopupMenu)p[i];</span>
        }
<span class="nc" id="L225">        return popup;</span>
    }

    static List&lt;JPopupMenu&gt; getPopups() {
<span class="nc" id="L229">        MenuSelectionManager msm = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L230">        MenuElement[] p = msm.getSelectedPath();</span>

<span class="nc" id="L232">        List&lt;JPopupMenu&gt; list = new ArrayList&lt;JPopupMenu&gt;(p.length);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        for (MenuElement element : p) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if (element instanceof JPopupMenu) {</span>
<span class="nc" id="L235">                list.add((JPopupMenu) element);</span>
            }
        }
<span class="nc" id="L238">        return list;</span>
    }

    public boolean isPopupTrigger(MouseEvent e) {
<span class="nc bnc" id="L242" title="All 2 branches missed.">        return ((e.getID()==MouseEvent.MOUSE_RELEASED)</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                &amp;&amp; ((e.getModifiers() &amp; MouseEvent.BUTTON3_MASK)!=0));</span>
    }

    private static boolean checkInvokerEqual(MenuElement present, MenuElement last) {
<span class="nc" id="L247">        Component invokerPresent = present.getComponent();</span>
<span class="nc" id="L248">        Component invokerLast = last.getComponent();</span>

<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (invokerPresent instanceof JPopupMenu) {</span>
<span class="nc" id="L251">            invokerPresent = ((JPopupMenu)invokerPresent).getInvoker();</span>
    }
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (invokerLast instanceof JPopupMenu) {</span>
<span class="nc" id="L254">            invokerLast = ((JPopupMenu)invokerLast).getInvoker();</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        return (invokerPresent == invokerLast);</span>
    }


    /**
     * This Listener fires the Action that provides the correct auditory
     * feedback.
     *
     * @since 1.4
     */
<span class="nc" id="L266">    private class BasicPopupMenuListener implements PopupMenuListener {</span>
        public void popupMenuCanceled(PopupMenuEvent e) {
<span class="nc" id="L268">        }</span>

        public void popupMenuWillBecomeInvisible(PopupMenuEvent e) {
<span class="nc" id="L271">        }</span>

        public void popupMenuWillBecomeVisible(PopupMenuEvent e) {
<span class="nc" id="L274">            BasicLookAndFeel.playSound((JPopupMenu)e.getSource(),</span>
                                       &quot;PopupMenu.popupSound&quot;);
<span class="nc" id="L276">        }</span>
    }

    /**
     * Handles mnemonic for children JMenuItems.
     * @since 1.5
     */
<span class="nc" id="L283">    private class BasicMenuKeyListener implements MenuKeyListener {</span>
<span class="nc" id="L284">        MenuElement menuToOpen = null;</span>

        public void menuKeyTyped(MenuKeyEvent e) {
<span class="nc bnc" id="L287" title="All 2 branches missed.">            if (menuToOpen != null) {</span>
                // we have a submenu to open
<span class="nc" id="L289">                JPopupMenu subpopup = ((JMenu)menuToOpen).getPopupMenu();</span>
<span class="nc" id="L290">                MenuElement subitem = findEnabledChild(</span>
<span class="nc" id="L291">                        subpopup.getSubElements(), -1, true);</span>

<span class="nc" id="L293">                ArrayList&lt;MenuElement&gt; lst = new ArrayList&lt;MenuElement&gt;(Arrays.asList(e.getPath()));</span>
<span class="nc" id="L294">                lst.add(menuToOpen);</span>
<span class="nc" id="L295">                lst.add(subpopup);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                if (subitem != null) {</span>
<span class="nc" id="L297">                    lst.add(subitem);</span>
                }
<span class="nc" id="L299">                MenuElement newPath[] = new MenuElement[0];</span>
<span class="nc" id="L300">                newPath = lst.toArray(newPath);</span>
<span class="nc" id="L301">                MenuSelectionManager.defaultManager().setSelectedPath(newPath);</span>
<span class="nc" id="L302">                e.consume();</span>
            }
<span class="nc" id="L304">            menuToOpen = null;</span>
<span class="nc" id="L305">        }</span>

        public void menuKeyPressed(MenuKeyEvent e) {
<span class="nc" id="L308">            char keyChar = e.getKeyChar();</span>

            // Handle the case for Escape or Enter...
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if (!Character.isLetterOrDigit(keyChar)) {</span>
<span class="nc" id="L312">                return;</span>
            }

<span class="nc" id="L315">            MenuSelectionManager manager = e.getMenuSelectionManager();</span>
<span class="nc" id="L316">            MenuElement path[] = e.getPath();</span>
<span class="nc" id="L317">            MenuElement items[] = popupMenu.getSubElements();</span>
<span class="nc" id="L318">            int currentIndex = -1;</span>
<span class="nc" id="L319">            int matches = 0;</span>
<span class="nc" id="L320">            int firstMatch = -1;</span>
<span class="nc" id="L321">            int indexes[] = null;</span>

<span class="nc bnc" id="L323" title="All 2 branches missed.">            for (int j = 0; j &lt; items.length; j++) {</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                if (! (items[j] instanceof JMenuItem)) {</span>
<span class="nc" id="L325">                    continue;</span>
                }
<span class="nc" id="L327">                JMenuItem item = (JMenuItem)items[j];</span>
<span class="nc" id="L328">                int mnemonic = item.getMnemonic();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                if (item.isEnabled() &amp;&amp;</span>
<span class="nc bnc" id="L330" title="All 4 branches missed.">                    item.isVisible() &amp;&amp; lower(keyChar) == lower(mnemonic)) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                    if (matches == 0) {</span>
<span class="nc" id="L332">                        firstMatch = j;</span>
<span class="nc" id="L333">                        matches++;</span>
                    } else {
<span class="nc bnc" id="L335" title="All 2 branches missed.">                        if (indexes == null) {</span>
<span class="nc" id="L336">                            indexes = new int[items.length];</span>
<span class="nc" id="L337">                            indexes[0] = firstMatch;</span>
                        }
<span class="nc" id="L339">                        indexes[matches++] = j;</span>
                    }
                }
<span class="nc bnc" id="L342" title="All 4 branches missed.">                if (item.isArmed() || item.isSelected()) {</span>
<span class="nc" id="L343">                    currentIndex = matches - 1;</span>
                }
            }

<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (matches == 0) {</span>
                // no op
<span class="nc bnc" id="L349" title="All 2 branches missed.">            } else if (matches == 1) {</span>
                // Invoke the menu action
<span class="nc" id="L351">                JMenuItem item = (JMenuItem)items[firstMatch];</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                if (item instanceof JMenu) {</span>
                    // submenus are handled in menuKeyTyped
<span class="nc" id="L354">                    menuToOpen = item;</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                } else if (item.isEnabled()) {</span>
                    // we have a menu item
<span class="nc" id="L357">                    manager.clearSelectedPath();</span>
<span class="nc" id="L358">                    item.doClick();</span>
                }
<span class="nc" id="L360">                e.consume();</span>
<span class="nc" id="L361">            } else {</span>
                // Select the menu item with the matching mnemonic. If
                // the same mnemonic has been invoked then select the next
                // menu item in the cycle.
                MenuElement newItem;

<span class="nc" id="L367">                newItem = items[indexes[(currentIndex + 1) % matches]];</span>

<span class="nc" id="L369">                MenuElement newPath[] = new MenuElement[path.length+1];</span>
<span class="nc" id="L370">                System.arraycopy(path, 0, newPath, 0, path.length);</span>
<span class="nc" id="L371">                newPath[path.length] = newItem;</span>
<span class="nc" id="L372">                manager.setSelectedPath(newPath);</span>
<span class="nc" id="L373">                e.consume();</span>
            }
<span class="nc" id="L375">        }</span>

        public void menuKeyReleased(MenuKeyEvent e) {
<span class="nc" id="L378">        }</span>

        private char lower(char keyChar) {
<span class="nc" id="L381">            return Character.toLowerCase(keyChar);</span>
        }

        private char lower(int mnemonic) {
<span class="nc" id="L385">            return Character.toLowerCase((char) mnemonic);</span>
        }
    }

    private static class Actions extends UIAction {
        // Types of actions
        private static final String CANCEL = &quot;cancel&quot;;
        private static final String SELECT_NEXT = &quot;selectNext&quot;;
        private static final String SELECT_PREVIOUS = &quot;selectPrevious&quot;;
        private static final String SELECT_PARENT = &quot;selectParent&quot;;
        private static final String SELECT_CHILD = &quot;selectChild&quot;;
        private static final String RETURN = &quot;return&quot;;

        // Used for next/previous actions
        private static final boolean FORWARD = true;
        private static final boolean BACKWARD = false;

        // Used for parent/child actions
        private static final boolean PARENT = false;
        private static final boolean CHILD = true;


        Actions(String key) {
<span class="nc" id="L408">            super(key);</span>
<span class="nc" id="L409">        }</span>

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L412">            String key = getName();</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">            if (key == CANCEL) {</span>
<span class="nc" id="L414">                cancel();</span>
            }
<span class="nc bnc" id="L416" title="All 2 branches missed.">            else if (key == SELECT_NEXT) {</span>
<span class="nc" id="L417">                selectItem(FORWARD);</span>
            }
<span class="nc bnc" id="L419" title="All 2 branches missed.">            else if (key == SELECT_PREVIOUS) {</span>
<span class="nc" id="L420">                selectItem(BACKWARD);</span>
            }
<span class="nc bnc" id="L422" title="All 2 branches missed.">            else if (key == SELECT_PARENT) {</span>
<span class="nc" id="L423">                selectParentChild(PARENT);</span>
            }
<span class="nc bnc" id="L425" title="All 2 branches missed.">            else if (key == SELECT_CHILD) {</span>
<span class="nc" id="L426">                selectParentChild(CHILD);</span>
            }
<span class="nc bnc" id="L428" title="All 2 branches missed.">            else if (key == RETURN) {</span>
<span class="nc" id="L429">                doReturn();</span>
            }
<span class="nc" id="L431">        }</span>

        private void doReturn() {
            KeyboardFocusManager fmgr =
<span class="nc" id="L435">                KeyboardFocusManager.getCurrentKeyboardFocusManager();</span>
<span class="nc" id="L436">            Component focusOwner = fmgr.getFocusOwner();</span>
<span class="nc bnc" id="L437" title="All 4 branches missed.">            if(focusOwner != null &amp;&amp; !(focusOwner instanceof JRootPane)) {</span>
<span class="nc" id="L438">                return;</span>
            }

<span class="nc" id="L441">            MenuSelectionManager msm = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L442">            MenuElement path[] = msm.getSelectedPath();</span>
            MenuElement lastElement;
<span class="nc bnc" id="L444" title="All 2 branches missed.">            if(path.length &gt; 0) {</span>
<span class="nc" id="L445">                lastElement = path[path.length-1];</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                if(lastElement instanceof JMenu) {</span>
<span class="nc" id="L447">                    MenuElement newPath[] = new MenuElement[path.length+1];</span>
<span class="nc" id="L448">                    System.arraycopy(path,0,newPath,0,path.length);</span>
<span class="nc" id="L449">                    newPath[path.length] = ((JMenu)lastElement).getPopupMenu();</span>
<span class="nc" id="L450">                    msm.setSelectedPath(newPath);</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">                } else if(lastElement instanceof JMenuItem) {</span>
<span class="nc" id="L452">                    JMenuItem mi = (JMenuItem)lastElement;</span>

<span class="nc bnc" id="L454" title="All 2 branches missed.">                    if (mi.getUI() instanceof BasicMenuItemUI) {</span>
<span class="nc" id="L455">                        ((BasicMenuItemUI)mi.getUI()).doClick(msm);</span>
                    }
                    else {
<span class="nc" id="L458">                        msm.clearSelectedPath();</span>
<span class="nc" id="L459">                        mi.doClick(0);</span>
                    }
                }
            }
<span class="nc" id="L463">        }</span>
        private void selectParentChild(boolean direction) {
<span class="nc" id="L465">            MenuSelectionManager msm = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L466">            MenuElement path[] = msm.getSelectedPath();</span>
<span class="nc" id="L467">            int len = path.length;</span>

<span class="nc bnc" id="L469" title="All 2 branches missed.">            if (direction == PARENT) {</span>
                // selecting parent
<span class="nc" id="L471">                int popupIndex = len-1;</span>

<span class="nc bnc" id="L473" title="All 6 branches missed.">                if (len &gt; 2 &amp;&amp;</span>
                    // check if we have an open submenu. A submenu item may or
                    // may not be selected, so submenu popup can be either the
                    // last or next to the last item.
                    (path[popupIndex] instanceof JPopupMenu ||
                     path[--popupIndex] instanceof JPopupMenu) &amp;&amp;
<span class="nc bnc" id="L479" title="All 2 branches missed.">                    !((JMenu)path[popupIndex-1]).isTopLevelMenu()) {</span>

                    // we have a submenu, just close it
<span class="nc" id="L482">                    MenuElement newPath[] = new MenuElement[popupIndex];</span>
<span class="nc" id="L483">                    System.arraycopy(path, 0, newPath, 0, popupIndex);</span>
<span class="nc" id="L484">                    msm.setSelectedPath(newPath);</span>
<span class="nc" id="L485">                    return;</span>
                }
<span class="nc" id="L487">            } else {</span>
                // selecting child
<span class="nc bnc" id="L489" title="All 4 branches missed.">                if (len &gt; 0 &amp;&amp; path[len-1] instanceof JMenu &amp;&amp;</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">                    !((JMenu)path[len-1]).isTopLevelMenu()) {</span>

                    // we have a submenu, open it
<span class="nc" id="L493">                    JMenu menu = (JMenu)path[len-1];</span>
<span class="nc" id="L494">                    JPopupMenu popup = menu.getPopupMenu();</span>
<span class="nc" id="L495">                    MenuElement[] subs = popup.getSubElements();</span>
<span class="nc" id="L496">                    MenuElement item = findEnabledChild(subs, -1, true);</span>
                    MenuElement[] newPath;

<span class="nc bnc" id="L499" title="All 2 branches missed.">                    if (item == null) {</span>
<span class="nc" id="L500">                        newPath = new MenuElement[len+1];</span>
                    } else {
<span class="nc" id="L502">                        newPath = new MenuElement[len+2];</span>
<span class="nc" id="L503">                        newPath[len+1] = item;</span>
                    }
<span class="nc" id="L505">                    System.arraycopy(path, 0, newPath, 0, len);</span>
<span class="nc" id="L506">                    newPath[len] = popup;</span>
<span class="nc" id="L507">                    msm.setSelectedPath(newPath);</span>
<span class="nc" id="L508">                    return;</span>
                }
            }

            // check if we have a toplevel menu selected.
            // If this is the case, we select another toplevel menu
<span class="nc bnc" id="L514" title="All 4 branches missed.">            if (len &gt; 1 &amp;&amp; path[0] instanceof JMenuBar) {</span>
<span class="nc" id="L515">                MenuElement currentMenu = path[1];</span>
<span class="nc" id="L516">                MenuElement nextMenu = findEnabledChild(</span>
<span class="nc" id="L517">                    path[0].getSubElements(), currentMenu, direction);</span>

<span class="nc bnc" id="L519" title="All 4 branches missed.">                if (nextMenu != null &amp;&amp; nextMenu != currentMenu) {</span>
                    MenuElement newSelection[];
<span class="nc bnc" id="L521" title="All 2 branches missed.">                    if (len == 2) {</span>
                        // menu is selected but its popup not shown
<span class="nc" id="L523">                        newSelection = new MenuElement[2];</span>
<span class="nc" id="L524">                        newSelection[0] = path[0];</span>
<span class="nc" id="L525">                        newSelection[1] = nextMenu;</span>
                    } else {
                        // menu is selected and its popup is shown
<span class="nc" id="L528">                        newSelection = new MenuElement[3];</span>
<span class="nc" id="L529">                        newSelection[0] = path[0];</span>
<span class="nc" id="L530">                        newSelection[1] = nextMenu;</span>
<span class="nc" id="L531">                        newSelection[2] = ((JMenu)nextMenu).getPopupMenu();</span>
                    }
<span class="nc" id="L533">                    msm.setSelectedPath(newSelection);</span>
                }
            }
<span class="nc" id="L536">        }</span>

        private void selectItem(boolean direction) {
<span class="nc" id="L539">            MenuSelectionManager msm = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L540">            MenuElement path[] = msm.getSelectedPath();</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (path.length == 0) {</span>
<span class="nc" id="L542">                return;</span>
            }
<span class="nc" id="L544">            int len = path.length;</span>
<span class="nc bnc" id="L545" title="All 4 branches missed.">            if (len == 1 &amp;&amp; path[0] instanceof JPopupMenu) {</span>

<span class="nc" id="L547">                JPopupMenu popup = (JPopupMenu) path[0];</span>
<span class="nc" id="L548">                MenuElement[] newPath = new MenuElement[2];</span>
<span class="nc" id="L549">                newPath[0] = popup;</span>
<span class="nc" id="L550">                newPath[1] = findEnabledChild(popup.getSubElements(), -1, direction);</span>
<span class="nc" id="L551">                msm.setSelectedPath(newPath);</span>
<span class="nc bnc" id="L552" title="All 6 branches missed.">            } else if (len == 2 &amp;&amp;</span>
                    path[0] instanceof JMenuBar &amp;&amp; path[1] instanceof JMenu) {

                // a toplevel menu is selected, but its popup not shown.
                // Show the popup and select the first item
<span class="nc" id="L557">                JPopupMenu popup = ((JMenu)path[1]).getPopupMenu();</span>
<span class="nc" id="L558">                MenuElement next =</span>
<span class="nc" id="L559">                    findEnabledChild(popup.getSubElements(), -1, FORWARD);</span>
                MenuElement[] newPath;

<span class="nc bnc" id="L562" title="All 2 branches missed.">                if (next != null) {</span>
                    // an enabled item found -- include it in newPath
<span class="nc" id="L564">                    newPath = new MenuElement[4];</span>
<span class="nc" id="L565">                    newPath[3] = next;</span>
                } else {
                    // menu has no enabled items -- still must show the popup
<span class="nc" id="L568">                    newPath = new MenuElement[3];</span>
                }
<span class="nc" id="L570">                System.arraycopy(path, 0, newPath, 0, 2);</span>
<span class="nc" id="L571">                newPath[2] = popup;</span>
<span class="nc" id="L572">                msm.setSelectedPath(newPath);</span>

<span class="nc bnc" id="L574" title="All 4 branches missed.">            } else if (path[len-1] instanceof JPopupMenu &amp;&amp;</span>
                       path[len-2] instanceof JMenu) {

                // a menu (not necessarily toplevel) is open and its popup
                // shown. Select the appropriate menu item
<span class="nc" id="L579">                JMenu menu = (JMenu)path[len-2];</span>
<span class="nc" id="L580">                JPopupMenu popup = menu.getPopupMenu();</span>
<span class="nc" id="L581">                MenuElement next =</span>
<span class="nc" id="L582">                    findEnabledChild(popup.getSubElements(), -1, direction);</span>

<span class="nc bnc" id="L584" title="All 2 branches missed.">                if (next != null) {</span>
<span class="nc" id="L585">                    MenuElement[] newPath = new MenuElement[len+1];</span>
<span class="nc" id="L586">                    System.arraycopy(path, 0, newPath, 0, len);</span>
<span class="nc" id="L587">                    newPath[len] = next;</span>
<span class="nc" id="L588">                    msm.setSelectedPath(newPath);</span>
<span class="nc" id="L589">                } else {</span>
                    // all items in the popup are disabled.
                    // We're going to find the parent popup menu and select
                    // its next item. If there's no parent popup menu (i.e.
                    // current menu is toplevel), do nothing
<span class="nc bnc" id="L594" title="All 4 branches missed.">                    if (len &gt; 2 &amp;&amp; path[len-3] instanceof JPopupMenu) {</span>
<span class="nc" id="L595">                        popup = ((JPopupMenu)path[len-3]);</span>
<span class="nc" id="L596">                        next = findEnabledChild(popup.getSubElements(),</span>
                                                menu, direction);

<span class="nc bnc" id="L599" title="All 4 branches missed.">                        if (next != null &amp;&amp; next != menu) {</span>
<span class="nc" id="L600">                            MenuElement[] newPath = new MenuElement[len-1];</span>
<span class="nc" id="L601">                            System.arraycopy(path, 0, newPath, 0, len-2);</span>
<span class="nc" id="L602">                            newPath[len-2] = next;</span>
<span class="nc" id="L603">                            msm.setSelectedPath(newPath);</span>
                        }
                    }
                }

<span class="nc" id="L608">            } else {</span>
                // just select the next item, no path expansion needed
<span class="nc" id="L610">                MenuElement subs[] = path[len-2].getSubElements();</span>
<span class="nc" id="L611">                MenuElement nextChild =</span>
<span class="nc" id="L612">                    findEnabledChild(subs, path[len-1], direction);</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                if (nextChild == null) {</span>
<span class="nc" id="L614">                    nextChild = findEnabledChild(subs, -1, direction);</span>
                }
<span class="nc bnc" id="L616" title="All 2 branches missed.">                if (nextChild != null) {</span>
<span class="nc" id="L617">                    path[len-1] = nextChild;</span>
<span class="nc" id="L618">                    msm.setSelectedPath(path);</span>
                }
            }
<span class="nc" id="L621">        }</span>

        private void cancel() {
            // 4234793: This action should call JPopupMenu.firePopupMenuCanceled but it's
            // a protected method. The real solution could be to make
            // firePopupMenuCanceled public and call it directly.
<span class="nc" id="L627">            JPopupMenu lastPopup = getLastPopup();</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">            if (lastPopup != null) {</span>
<span class="nc" id="L629">                lastPopup.putClientProperty(&quot;JPopupMenu.firePopupMenuCanceled&quot;, Boolean.TRUE);</span>
            }
<span class="nc" id="L631">            String mode = UIManager.getString(&quot;Menu.cancelMode&quot;);</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">            if (&quot;hideMenuTree&quot;.equals(mode)) {</span>
<span class="nc" id="L633">                MenuSelectionManager.defaultManager().clearSelectedPath();</span>
            } else {
<span class="nc" id="L635">                shortenSelectedPath();</span>
            }
<span class="nc" id="L637">        }</span>

        private void shortenSelectedPath() {
<span class="nc" id="L640">            MenuElement path[] = MenuSelectionManager.defaultManager().getSelectedPath();</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">            if (path.length &lt;= 2) {</span>
<span class="nc" id="L642">                MenuSelectionManager.defaultManager().clearSelectedPath();</span>
<span class="nc" id="L643">                return;</span>
            }
            // unselect MenuItem and its Popup by default
<span class="nc" id="L646">            int value = 2;</span>
<span class="nc" id="L647">            MenuElement lastElement = path[path.length - 1];</span>
<span class="nc" id="L648">            JPopupMenu lastPopup = getLastPopup();</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (lastElement == lastPopup) {</span>
<span class="nc" id="L650">                MenuElement previousElement = path[path.length - 2];</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">                if (previousElement instanceof JMenu) {</span>
<span class="nc" id="L652">                    JMenu lastMenu = (JMenu) previousElement;</span>
<span class="nc bnc" id="L653" title="All 4 branches missed.">                    if (lastMenu.isEnabled() &amp;&amp; lastPopup.getComponentCount() &gt; 0) {</span>
                        // unselect the last visible popup only
<span class="nc" id="L655">                        value = 1;</span>
                    } else {
                        // unselect invisible popup and two visible elements
<span class="nc" id="L658">                        value = 3;</span>
                    }
                }
            }
<span class="nc bnc" id="L662" title="All 2 branches missed.">            if (path.length - value &lt;= 2</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">                    &amp;&amp; !UIManager.getBoolean(&quot;Menu.preserveTopLevelSelection&quot;)) {</span>
                // clear selection for the topLevelMenu
<span class="nc" id="L665">                value = path.length;</span>
            }
<span class="nc" id="L667">            MenuElement newPath[] = new MenuElement[path.length - value];</span>
<span class="nc" id="L668">            System.arraycopy(path, 0, newPath, 0, path.length - value);</span>
<span class="nc" id="L669">            MenuSelectionManager.defaultManager().setSelectedPath(newPath);</span>
<span class="nc" id="L670">        }</span>
    }

    private static MenuElement nextEnabledChild(MenuElement e[],
                                                int fromIndex, int toIndex) {
<span class="nc bnc" id="L675" title="All 2 branches missed.">        for (int i=fromIndex; i&lt;=toIndex; i++) {</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">            if (e[i] != null) {</span>
<span class="nc" id="L677">                Component comp = e[i].getComponent();</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">                if ( comp != null</span>
<span class="nc bnc" id="L679" title="All 4 branches missed.">                        &amp;&amp; (comp.isEnabled() || UIManager.getBoolean(&quot;MenuItem.disabledAreNavigable&quot;))</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                        &amp;&amp; comp.isVisible()) {</span>
<span class="nc" id="L681">                    return e[i];</span>
                }
            }
        }
<span class="nc" id="L685">        return null;</span>
    }

    private static MenuElement previousEnabledChild(MenuElement e[],
                                                int fromIndex, int toIndex) {
<span class="nc bnc" id="L690" title="All 2 branches missed.">        for (int i=fromIndex; i&gt;=toIndex; i--) {</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">            if (e[i] != null) {</span>
<span class="nc" id="L692">                Component comp = e[i].getComponent();</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                if ( comp != null</span>
<span class="nc bnc" id="L694" title="All 4 branches missed.">                        &amp;&amp; (comp.isEnabled() || UIManager.getBoolean(&quot;MenuItem.disabledAreNavigable&quot;))</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">                        &amp;&amp; comp.isVisible()) {</span>
<span class="nc" id="L696">                    return e[i];</span>
                }
            }
        }
<span class="nc" id="L700">        return null;</span>
    }

    static MenuElement findEnabledChild(MenuElement e[], int fromIndex,
                                                boolean forward) {
        MenuElement result;
<span class="nc bnc" id="L706" title="All 2 branches missed.">        if (forward) {</span>
<span class="nc" id="L707">            result = nextEnabledChild(e, fromIndex+1, e.length-1);</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">            if (result == null) result = nextEnabledChild(e, 0, fromIndex-1);</span>
        } else {
<span class="nc" id="L710">            result = previousEnabledChild(e, fromIndex-1, 0);</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">            if (result == null) result = previousEnabledChild(e, e.length-1,</span>
                                                              fromIndex+1);
        }
<span class="nc" id="L714">        return result;</span>
    }

    static MenuElement findEnabledChild(MenuElement e[],
                                   MenuElement elem, boolean forward) {
<span class="nc bnc" id="L719" title="All 2 branches missed.">        for (int i=0; i&lt;e.length; i++) {</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">            if (e[i] == elem) {</span>
<span class="nc" id="L721">                return findEnabledChild(e, i, forward);</span>
            }
        }
<span class="nc" id="L724">        return null;</span>
    }

    static class MouseGrabber implements ChangeListener,
        AWTEventListener, ComponentListener, WindowListener {

        Window grabbedWindow;
        MenuElement[] lastPathSelected;

<span class="nc" id="L733">        public MouseGrabber() {</span>
<span class="nc" id="L734">            MenuSelectionManager msm = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L735">            msm.addChangeListener(this);</span>
<span class="nc" id="L736">            this.lastPathSelected = msm.getSelectedPath();</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">            if(this.lastPathSelected.length != 0) {</span>
<span class="nc" id="L738">                grabWindow(this.lastPathSelected);</span>
            }
<span class="nc" id="L740">        }</span>

        void uninstall() {
<span class="nc" id="L743">            synchronized (MOUSE_GRABBER_KEY) {</span>
<span class="nc" id="L744">                MenuSelectionManager.defaultManager().removeChangeListener(this);</span>
<span class="nc" id="L745">                ungrabWindow();</span>
<span class="nc" id="L746">                AppContext.getAppContext().remove(MOUSE_GRABBER_KEY);</span>
<span class="nc" id="L747">            }</span>
<span class="nc" id="L748">        }</span>

        void grabWindow(MenuElement[] newPath) {
            // A grab needs to be added
<span class="nc" id="L752">            final Toolkit tk = Toolkit.getDefaultToolkit();</span>
<span class="nc" id="L753">            java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L754">                new java.security.PrivilegedAction&lt;Object&gt;() {</span>
                    public Object run() {
<span class="nc" id="L756">                        tk.addAWTEventListener(MouseGrabber.this,</span>
                                AWTEvent.MOUSE_EVENT_MASK |
                                AWTEvent.MOUSE_MOTION_EVENT_MASK |
                                AWTEvent.MOUSE_WHEEL_EVENT_MASK |
                                AWTEvent.WINDOW_EVENT_MASK | sun.awt.SunToolkit.GRAB_EVENT_MASK);
<span class="nc" id="L761">                        return null;</span>
                    }
                }
            );

<span class="nc" id="L766">            Component invoker = newPath[0].getComponent();</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">            if (invoker instanceof JPopupMenu) {</span>
<span class="nc" id="L768">                invoker = ((JPopupMenu)invoker).getInvoker();</span>
            }
<span class="nc bnc" id="L770" title="All 2 branches missed.">            grabbedWindow = invoker instanceof Window?</span>
                    (Window)invoker :
<span class="nc" id="L772">                    SwingUtilities.getWindowAncestor(invoker);</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">            if(grabbedWindow != null) {</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">                if(tk instanceof sun.awt.SunToolkit) {</span>
<span class="nc" id="L775">                    ((sun.awt.SunToolkit)tk).grab(grabbedWindow);</span>
                } else {
<span class="nc" id="L777">                    grabbedWindow.addComponentListener(this);</span>
<span class="nc" id="L778">                    grabbedWindow.addWindowListener(this);</span>
                }
            }
<span class="nc" id="L781">        }</span>

        void ungrabWindow() {
<span class="nc" id="L784">            final Toolkit tk = Toolkit.getDefaultToolkit();</span>
            // The grab should be removed
<span class="nc" id="L786">             java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L787">                new java.security.PrivilegedAction&lt;Object&gt;() {</span>
                    public Object run() {
<span class="nc" id="L789">                        tk.removeAWTEventListener(MouseGrabber.this);</span>
<span class="nc" id="L790">                        return null;</span>
                    }
                }
            );
<span class="nc" id="L794">            realUngrabWindow();</span>
<span class="nc" id="L795">        }</span>

        void realUngrabWindow() {
<span class="nc" id="L798">            Toolkit tk = Toolkit.getDefaultToolkit();</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">            if(grabbedWindow != null) {</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">                if(tk instanceof sun.awt.SunToolkit) {</span>
<span class="nc" id="L801">                    ((sun.awt.SunToolkit)tk).ungrab(grabbedWindow);</span>
                } else {
<span class="nc" id="L803">                    grabbedWindow.removeComponentListener(this);</span>
<span class="nc" id="L804">                    grabbedWindow.removeWindowListener(this);</span>
                }
<span class="nc" id="L806">                grabbedWindow = null;</span>
            }
<span class="nc" id="L808">        }</span>

        public void stateChanged(ChangeEvent e) {
<span class="nc" id="L811">            MenuSelectionManager msm = MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L812">            MenuElement[] p = msm.getSelectedPath();</span>

<span class="nc bnc" id="L814" title="All 4 branches missed.">            if (lastPathSelected.length == 0 &amp;&amp; p.length != 0) {</span>
<span class="nc" id="L815">                grabWindow(p);</span>
            }

<span class="nc bnc" id="L818" title="All 4 branches missed.">            if (lastPathSelected.length != 0 &amp;&amp; p.length == 0) {</span>
<span class="nc" id="L819">                ungrabWindow();</span>
            }

<span class="nc" id="L822">            lastPathSelected = p;</span>
<span class="nc" id="L823">        }</span>

        public void eventDispatched(AWTEvent ev) {
<span class="nc bnc" id="L826" title="All 2 branches missed.">            if(ev instanceof sun.awt.UngrabEvent) {</span>
                // Popup should be canceled in case of ungrab event
<span class="nc" id="L828">                cancelPopupMenu( );</span>
<span class="nc" id="L829">                return;</span>
            }
<span class="nc bnc" id="L831" title="All 2 branches missed.">            if (!(ev instanceof MouseEvent)) {</span>
                // We are interested in MouseEvents only
<span class="nc" id="L833">                return;</span>
            }
<span class="nc" id="L835">            MouseEvent me = (MouseEvent) ev;</span>
<span class="nc" id="L836">            Component src = me.getComponent();</span>
<span class="nc bnc" id="L837" title="All 5 branches missed.">            switch (me.getID()) {</span>
            case MouseEvent.MOUSE_PRESSED:
<span class="nc bnc" id="L839" title="All 4 branches missed.">                if (isInPopup(src) ||</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">                    (src instanceof JMenu &amp;&amp; ((JMenu)src).isSelected())) {</span>
<span class="nc" id="L841">                    return;</span>
                }
<span class="nc bnc" id="L843" title="All 2 branches missed.">                if (!(src instanceof JComponent) ||</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">                   ! (((JComponent)src).getClientProperty(&quot;doNotCancelPopup&quot;)</span>
                         == BasicComboBoxUI.HIDE_POPUP_KEY)) {
                    // Cancel popup only if this property was not set.
                    // If this property is set to TRUE component wants
                    // to deal with this event by himself.
<span class="nc" id="L849">                    cancelPopupMenu();</span>
                    // Ask UIManager about should we consume event that closes
                    // popup. This made to match native apps behaviour.
<span class="nc" id="L852">                    boolean consumeEvent =</span>
<span class="nc" id="L853">                        UIManager.getBoolean(&quot;PopupMenu.consumeEventOnClose&quot;);</span>
                    // Consume the event so that normal processing stops.
<span class="nc bnc" id="L855" title="All 4 branches missed.">                    if(consumeEvent &amp;&amp; !(src instanceof MenuElement)) {</span>
<span class="nc" id="L856">                        me.consume();</span>
                    }
<span class="nc" id="L858">                }</span>
                break;

            case MouseEvent.MOUSE_RELEASED:
<span class="nc bnc" id="L862" title="All 2 branches missed.">                if(!(src instanceof MenuElement)) {</span>
                    // Do not forward event to MSM, let component handle it
<span class="nc bnc" id="L864" title="All 2 branches missed.">                    if (isInPopup(src)) {</span>
<span class="nc" id="L865">                        break;</span>
                    }
                }
<span class="nc bnc" id="L868" title="All 4 branches missed.">                if(src instanceof JMenu || !(src instanceof JMenuItem)) {</span>
<span class="nc" id="L869">                    MenuSelectionManager.defaultManager().</span>
<span class="nc" id="L870">                        processMouseEvent(me);</span>
                }
                break;
            case MouseEvent.MOUSE_DRAGGED:
<span class="nc bnc" id="L874" title="All 2 branches missed.">                if(!(src instanceof MenuElement)) {</span>
                    // For the MOUSE_DRAGGED event the src is
                    // the Component in which mouse button was pressed.
                    // If the src is in popupMenu,
                    // do not forward event to MSM, let component handle it.
<span class="nc bnc" id="L879" title="All 2 branches missed.">                    if (isInPopup(src)) {</span>
<span class="nc" id="L880">                        break;</span>
                    }
                }
<span class="nc" id="L883">                MenuSelectionManager.defaultManager().</span>
<span class="nc" id="L884">                    processMouseEvent(me);</span>
<span class="nc" id="L885">                break;</span>
            case MouseEvent.MOUSE_WHEEL:
<span class="nc bnc" id="L887" title="All 2 branches missed.">                if (isInPopup(src)) {</span>
<span class="nc" id="L888">                    return;</span>
                }
<span class="nc" id="L890">                cancelPopupMenu();</span>
                break;
            }
<span class="nc" id="L893">        }</span>

        boolean isInPopup(Component src) {
<span class="nc bnc" id="L896" title="All 2 branches missed.">            for (Component c=src; c!=null; c=c.getParent()) {</span>
<span class="nc bnc" id="L897" title="All 4 branches missed.">                if (c instanceof Applet || c instanceof Window) {</span>
<span class="nc" id="L898">                    break;</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">                } else if (c instanceof JPopupMenu) {</span>
<span class="nc" id="L900">                    return true;</span>
                }
            }
<span class="nc" id="L903">            return false;</span>
        }

        void cancelPopupMenu() {
            // We should ungrab window if a user code throws
            // an unexpected runtime exception. See 6495920.
            try {
                // 4234793: This action should call firePopupMenuCanceled but it's
                // a protected method. The real solution could be to make
                // firePopupMenuCanceled public and call it directly.
<span class="nc" id="L913">                List&lt;JPopupMenu&gt; popups = getPopups();</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">                for (JPopupMenu popup : popups) {</span>
<span class="nc" id="L915">                    popup.putClientProperty(&quot;JPopupMenu.firePopupMenuCanceled&quot;, Boolean.TRUE);</span>
<span class="nc" id="L916">                }</span>
<span class="nc" id="L917">                MenuSelectionManager.defaultManager().clearSelectedPath();</span>
<span class="nc" id="L918">            } catch (RuntimeException ex) {</span>
<span class="nc" id="L919">                realUngrabWindow();</span>
<span class="nc" id="L920">                throw ex;</span>
<span class="nc" id="L921">            } catch (Error err) {</span>
<span class="nc" id="L922">                realUngrabWindow();</span>
<span class="nc" id="L923">                throw err;</span>
<span class="nc" id="L924">            }</span>
<span class="nc" id="L925">        }</span>

        public void componentResized(ComponentEvent e) {
<span class="nc" id="L928">            cancelPopupMenu();</span>
<span class="nc" id="L929">        }</span>
        public void componentMoved(ComponentEvent e) {
<span class="nc" id="L931">            cancelPopupMenu();</span>
<span class="nc" id="L932">        }</span>
        public void componentShown(ComponentEvent e) {
<span class="nc" id="L934">            cancelPopupMenu();</span>
<span class="nc" id="L935">        }</span>
        public void componentHidden(ComponentEvent e) {
<span class="nc" id="L937">            cancelPopupMenu();</span>
<span class="nc" id="L938">        }</span>
        public void windowClosing(WindowEvent e) {
<span class="nc" id="L940">            cancelPopupMenu();</span>
<span class="nc" id="L941">        }</span>
        public void windowClosed(WindowEvent e) {
<span class="nc" id="L943">            cancelPopupMenu();</span>
<span class="nc" id="L944">        }</span>
        public void windowIconified(WindowEvent e) {
<span class="nc" id="L946">            cancelPopupMenu();</span>
<span class="nc" id="L947">        }</span>
        public void windowDeactivated(WindowEvent e) {
<span class="nc" id="L949">            cancelPopupMenu();</span>
<span class="nc" id="L950">        }</span>
<span class="nc" id="L951">        public void windowOpened(WindowEvent e) {}</span>
<span class="nc" id="L952">        public void windowDeiconified(WindowEvent e) {}</span>
<span class="nc" id="L953">        public void windowActivated(WindowEvent e) {}</span>
    }

    /**
     * This helper is added to MenuSelectionManager as a ChangeListener to
     * listen to menu selection changes. When a menu is activated, it passes
     * focus to its parent JRootPane, and installs an ActionMap/InputMap pair
     * on that JRootPane. Those maps are necessary in order for menu
     * navigation to work. When menu is being deactivated, it restores focus
     * to the component that has had it before menu activation, and uninstalls
     * the maps.
     * This helper is also installed as a KeyListener on root pane when menu
     * is active. It forwards key events to MenuSelectionManager for mnemonic
     * keys handling.
     */
<span class="nc" id="L968">    static class MenuKeyboardHelper</span>
        implements ChangeListener, KeyListener {

<span class="nc" id="L971">        private Component lastFocused = null;</span>
<span class="nc" id="L972">        private MenuElement[] lastPathSelected = new MenuElement[0];</span>
        private JPopupMenu lastPopup;

        private JRootPane invokerRootPane;
<span class="nc" id="L976">        private ActionMap menuActionMap = getActionMap();</span>
        private InputMap menuInputMap;
        private boolean focusTraversalKeysEnabled;

        /*
         * Fix for 4213634
         * If this is false, KEY_TYPED and KEY_RELEASED events are NOT
         * processed. This is needed to avoid activating a menuitem when
         * the menu and menuitem share the same mnemonic.
         */
<span class="nc" id="L986">        private boolean receivedKeyPressed = false;</span>

        void removeItems() {
<span class="nc bnc" id="L989" title="All 2 branches missed.">            if (lastFocused != null) {</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">                if(!lastFocused.requestFocusInWindow()) {</span>
                    // Workarounr for 4810575.
                    // If lastFocused is not in currently focused window
                    // requestFocusInWindow will fail. In this case we must
                    // request focus by requestFocus() if it was not
                    // transferred from our popup.
                    Window cfw = KeyboardFocusManager
<span class="nc" id="L997">                                 .getCurrentKeyboardFocusManager()</span>
<span class="nc" id="L998">                                  .getFocusedWindow();</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">                    if(cfw != null &amp;&amp;</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">                       &quot;###focusableSwingPopup###&quot;.equals(cfw.getName())) {</span>
<span class="nc" id="L1001">                        lastFocused.requestFocus();</span>
                    }

                }
<span class="nc" id="L1005">                lastFocused = null;</span>
            }
<span class="nc bnc" id="L1007" title="All 2 branches missed.">            if (invokerRootPane != null) {</span>
<span class="nc" id="L1008">                invokerRootPane.removeKeyListener(this);</span>
<span class="nc" id="L1009">                invokerRootPane.setFocusTraversalKeysEnabled(focusTraversalKeysEnabled);</span>
<span class="nc" id="L1010">                removeUIInputMap(invokerRootPane, menuInputMap);</span>
<span class="nc" id="L1011">                removeUIActionMap(invokerRootPane, menuActionMap);</span>
<span class="nc" id="L1012">                invokerRootPane = null;</span>
            }
<span class="nc" id="L1014">            receivedKeyPressed = false;</span>
<span class="nc" id="L1015">        }</span>

<span class="nc" id="L1017">        private FocusListener rootPaneFocusListener = new FocusAdapter() {</span>
                public void focusGained(FocusEvent ev) {
<span class="nc" id="L1019">                    Component opposite = ev.getOppositeComponent();</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">                    if (opposite != null) {</span>
<span class="nc" id="L1021">                        lastFocused = opposite;</span>
                    }
<span class="nc" id="L1023">                    ev.getComponent().removeFocusListener(this);</span>
<span class="nc" id="L1024">                }</span>
            };

        /**
         * Return the last JPopupMenu in &lt;code&gt;path&lt;/code&gt;,
         * or &lt;code&gt;null&lt;/code&gt; if none found
         */
        JPopupMenu getActivePopup(MenuElement[] path) {
<span class="nc bnc" id="L1032" title="All 2 branches missed.">            for (int i=path.length-1; i&gt;=0; i--) {</span>
<span class="nc" id="L1033">                MenuElement elem = path[i];</span>
<span class="nc bnc" id="L1034" title="All 2 branches missed.">                if (elem instanceof JPopupMenu) {</span>
<span class="nc" id="L1035">                    return (JPopupMenu)elem;</span>
                }
            }
<span class="nc" id="L1038">            return null;</span>
        }

        void addUIInputMap(JComponent c, InputMap map) {
<span class="nc" id="L1042">            InputMap lastNonUI = null;</span>
<span class="nc" id="L1043">            InputMap parent = c.getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc bnc" id="L1045" title="All 4 branches missed.">            while (parent != null &amp;&amp; !(parent instanceof UIResource)) {</span>
<span class="nc" id="L1046">                lastNonUI = parent;</span>
<span class="nc" id="L1047">                parent = parent.getParent();</span>
            }

<span class="nc bnc" id="L1050" title="All 2 branches missed.">            if (lastNonUI == null) {</span>
<span class="nc" id="L1051">                c.setInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW, map);</span>
            } else {
<span class="nc" id="L1053">                lastNonUI.setParent(map);</span>
            }
<span class="nc" id="L1055">            map.setParent(parent);</span>
<span class="nc" id="L1056">        }</span>

        void addUIActionMap(JComponent c, ActionMap map) {
<span class="nc" id="L1059">            ActionMap lastNonUI = null;</span>
<span class="nc" id="L1060">            ActionMap parent = c.getActionMap();</span>

<span class="nc bnc" id="L1062" title="All 4 branches missed.">            while (parent != null &amp;&amp; !(parent instanceof UIResource)) {</span>
<span class="nc" id="L1063">                lastNonUI = parent;</span>
<span class="nc" id="L1064">                parent = parent.getParent();</span>
            }

<span class="nc bnc" id="L1067" title="All 2 branches missed.">            if (lastNonUI == null) {</span>
<span class="nc" id="L1068">                c.setActionMap(map);</span>
            } else {
<span class="nc" id="L1070">                lastNonUI.setParent(map);</span>
            }
<span class="nc" id="L1072">            map.setParent(parent);</span>
<span class="nc" id="L1073">        }</span>

        void removeUIInputMap(JComponent c, InputMap map) {
<span class="nc" id="L1076">            InputMap im = null;</span>
<span class="nc" id="L1077">            InputMap parent = c.getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc bnc" id="L1079" title="All 2 branches missed.">            while (parent != null) {</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">                if (parent == map) {</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">                    if (im == null) {</span>
<span class="nc" id="L1082">                        c.setInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW,</span>
<span class="nc" id="L1083">                                      map.getParent());</span>
                    } else {
<span class="nc" id="L1085">                        im.setParent(map.getParent());</span>
                    }
<span class="nc" id="L1087">                    break;</span>
                }
<span class="nc" id="L1089">                im = parent;</span>
<span class="nc" id="L1090">                parent = parent.getParent();</span>
            }
<span class="nc" id="L1092">        }</span>

        void removeUIActionMap(JComponent c, ActionMap map) {
<span class="nc" id="L1095">            ActionMap im = null;</span>
<span class="nc" id="L1096">            ActionMap parent = c.getActionMap();</span>

<span class="nc bnc" id="L1098" title="All 2 branches missed.">            while (parent != null) {</span>
<span class="nc bnc" id="L1099" title="All 2 branches missed.">                if (parent == map) {</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">                    if (im == null) {</span>
<span class="nc" id="L1101">                        c.setActionMap(map.getParent());</span>
                    } else {
<span class="nc" id="L1103">                        im.setParent(map.getParent());</span>
                    }
<span class="nc" id="L1105">                    break;</span>
                }
<span class="nc" id="L1107">                im = parent;</span>
<span class="nc" id="L1108">                parent = parent.getParent();</span>
            }
<span class="nc" id="L1110">        }</span>

        public void stateChanged(ChangeEvent ev) {
<span class="nc bnc" id="L1113" title="All 2 branches missed.">            if (!(UIManager.getLookAndFeel() instanceof BasicLookAndFeel)) {</span>
<span class="nc" id="L1114">                uninstall();</span>
<span class="nc" id="L1115">                return;</span>
            }
<span class="nc" id="L1117">            MenuSelectionManager msm = (MenuSelectionManager)ev.getSource();</span>
<span class="nc" id="L1118">            MenuElement[] p = msm.getSelectedPath();</span>
<span class="nc" id="L1119">            JPopupMenu popup = getActivePopup(p);</span>
<span class="nc bnc" id="L1120" title="All 4 branches missed.">            if (popup != null &amp;&amp; !popup.isFocusable()) {</span>
                // Do nothing for non-focusable popups
<span class="nc" id="L1122">                return;</span>
            }

<span class="nc bnc" id="L1125" title="All 4 branches missed.">            if (lastPathSelected.length != 0 &amp;&amp; p.length != 0 ) {</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">                if (!checkInvokerEqual(p[0],lastPathSelected[0])) {</span>
<span class="nc" id="L1127">                    removeItems();</span>
<span class="nc" id="L1128">                    lastPathSelected = new MenuElement[0];</span>
                }
            }

<span class="nc bnc" id="L1132" title="All 4 branches missed.">            if (lastPathSelected.length == 0 &amp;&amp; p.length &gt; 0) {</span>
                // menu posted
                JComponent invoker;

<span class="nc bnc" id="L1136" title="All 2 branches missed.">                if (popup == null) {</span>
<span class="nc bnc" id="L1137" title="All 6 branches missed.">                    if (p.length == 2 &amp;&amp; p[0] instanceof JMenuBar &amp;&amp;</span>
                        p[1] instanceof JMenu) {
                        // a menu has been selected but not open
<span class="nc" id="L1140">                        invoker = (JComponent)p[1];</span>
<span class="nc" id="L1141">                        popup = ((JMenu)invoker).getPopupMenu();</span>
                    } else {
<span class="nc" id="L1143">                        return;</span>
                    }
                } else {
<span class="nc" id="L1146">                    Component c = popup.getInvoker();</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">                    if(c instanceof JFrame) {</span>
<span class="nc" id="L1148">                        invoker = ((JFrame)c).getRootPane();</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">                    } else if(c instanceof JDialog) {</span>
<span class="nc" id="L1150">                        invoker = ((JDialog)c).getRootPane();</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">                    } else if(c instanceof JApplet) {</span>
<span class="nc" id="L1152">                        invoker = ((JApplet)c).getRootPane();</span>
                    } else {
<span class="nc bnc" id="L1154" title="All 2 branches missed.">                        while (!(c instanceof JComponent)) {</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">                            if (c == null) {</span>
<span class="nc" id="L1156">                                return;</span>
                            }
<span class="nc" id="L1158">                            c = c.getParent();</span>
                        }
<span class="nc" id="L1160">                        invoker = (JComponent)c;</span>
                    }
                }

                // remember current focus owner
<span class="nc" id="L1165">                lastFocused = KeyboardFocusManager.</span>
<span class="nc" id="L1166">                    getCurrentKeyboardFocusManager().getFocusOwner();</span>

                // request focus on root pane and install keybindings
                // used for menu navigation
<span class="nc" id="L1170">                invokerRootPane = SwingUtilities.getRootPane(invoker);</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">                if (invokerRootPane != null) {</span>
<span class="nc" id="L1172">                    invokerRootPane.addFocusListener(rootPaneFocusListener);</span>
<span class="nc" id="L1173">                    invokerRootPane.requestFocus(true);</span>
<span class="nc" id="L1174">                    invokerRootPane.addKeyListener(this);</span>
<span class="nc" id="L1175">                    focusTraversalKeysEnabled = invokerRootPane.</span>
<span class="nc" id="L1176">                                      getFocusTraversalKeysEnabled();</span>
<span class="nc" id="L1177">                    invokerRootPane.setFocusTraversalKeysEnabled(false);</span>

<span class="nc" id="L1179">                    menuInputMap = getInputMap(popup, invokerRootPane);</span>
<span class="nc" id="L1180">                    addUIInputMap(invokerRootPane, menuInputMap);</span>
<span class="nc" id="L1181">                    addUIActionMap(invokerRootPane, menuActionMap);</span>
                }
<span class="nc bnc" id="L1183" title="All 4 branches missed.">            } else if (lastPathSelected.length != 0 &amp;&amp; p.length == 0) {</span>
                // menu hidden -- return focus to where it had been before
                // and uninstall menu keybindings
<span class="nc" id="L1186">                   removeItems();</span>
            } else {
<span class="nc bnc" id="L1188" title="All 2 branches missed.">                if (popup != lastPopup) {</span>
<span class="nc" id="L1189">                    receivedKeyPressed = false;</span>
                }
            }

            // Remember the last path selected
<span class="nc" id="L1194">            lastPathSelected = p;</span>
<span class="nc" id="L1195">            lastPopup = popup;</span>
<span class="nc" id="L1196">        }</span>

        public void keyPressed(KeyEvent ev) {
<span class="nc" id="L1199">            receivedKeyPressed = true;</span>
<span class="nc" id="L1200">            MenuSelectionManager.defaultManager().processKeyEvent(ev);</span>
<span class="nc" id="L1201">        }</span>

        public void keyReleased(KeyEvent ev) {
<span class="nc bnc" id="L1204" title="All 2 branches missed.">            if (receivedKeyPressed) {</span>
<span class="nc" id="L1205">                receivedKeyPressed = false;</span>
<span class="nc" id="L1206">                MenuSelectionManager.defaultManager().processKeyEvent(ev);</span>
            }
<span class="nc" id="L1208">        }</span>

        public void keyTyped(KeyEvent ev) {
<span class="nc bnc" id="L1211" title="All 2 branches missed.">            if (receivedKeyPressed) {</span>
<span class="nc" id="L1212">                MenuSelectionManager.defaultManager().processKeyEvent(ev);</span>
            }
<span class="nc" id="L1214">        }</span>

        void uninstall() {
<span class="nc" id="L1217">            synchronized (MENU_KEYBOARD_HELPER_KEY) {</span>
<span class="nc" id="L1218">                MenuSelectionManager.defaultManager().removeChangeListener(this);</span>
<span class="nc" id="L1219">                AppContext.getAppContext().remove(MENU_KEYBOARD_HELPER_KEY);</span>
<span class="nc" id="L1220">            }</span>
<span class="nc" id="L1221">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>