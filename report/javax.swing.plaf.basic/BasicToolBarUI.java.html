<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BasicToolBarUI.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">javax.swing.plaf.basic</a> &gt; <span class="el_source">BasicToolBarUI.java</span></div><h1>BasicToolBarUI.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing.plaf.basic;

import javax.swing.*;
import javax.swing.event.*;
import java.awt.*;
import java.awt.event.*;

import java.beans.*;

import java.util.Hashtable;
import java.util.HashMap;

import javax.swing.border.*;
import javax.swing.plaf.*;
import sun.swing.DefaultLookup;
import sun.swing.UIAction;


/**
 * A Basic L&amp;amp;F implementation of ToolBarUI.  This implementation
 * is a &quot;combined&quot; view/controller.
 * &lt;p&gt;
 *
 * @author Georges Saab
 * @author Jeff Shapiro
 */
<span class="nc" id="L52">public class BasicToolBarUI extends ToolBarUI implements SwingConstants</span>
{
    protected JToolBar toolBar;
    private boolean floating;
    private int floatingX;
    private int floatingY;
    private JFrame floatingFrame;
    private RootPaneContainer floatingToolBar;
    protected DragWindow dragWindow;
    private Container dockingSource;
<span class="nc" id="L62">    private int dockingSensitivity = 0;</span>
<span class="nc" id="L63">    protected int focusedCompIndex = -1;</span>

<span class="nc" id="L65">    protected Color dockingColor = null;</span>
<span class="nc" id="L66">    protected Color floatingColor = null;</span>
<span class="nc" id="L67">    protected Color dockingBorderColor = null;</span>
<span class="nc" id="L68">    protected Color floatingBorderColor = null;</span>

    protected MouseInputListener dockingListener;
    protected PropertyChangeListener propertyListener;

    protected ContainerListener toolBarContListener;
    protected FocusListener toolBarFocusListener;
    private Handler handler;

<span class="nc" id="L77">    protected String constraintBeforeFloating = BorderLayout.NORTH;</span>

    // Rollover button implementation.
<span class="nc" id="L80">    private static String IS_ROLLOVER = &quot;JToolBar.isRollover&quot;;</span>
    private static Border rolloverBorder;
    private static Border nonRolloverBorder;
    private static Border nonRolloverToggleBorder;
<span class="nc" id="L84">    private boolean rolloverBorders = false;</span>

<span class="nc" id="L86">    private HashMap&lt;AbstractButton, Border&gt; borderTable = new HashMap&lt;AbstractButton, Border&gt;();</span>
<span class="nc" id="L87">    private Hashtable&lt;AbstractButton, Boolean&gt; rolloverTable = new Hashtable&lt;AbstractButton, Boolean&gt;();</span>


    /**
     * As of Java 2 platform v1.3 this previously undocumented field is no
     * longer used.
     * Key bindings are now defined by the LookAndFeel, please refer to
     * the key bindings specification for further details.
     *
     * @deprecated As of Java 2 platform v1.3.
     */
    @Deprecated
    protected KeyStroke upKey;
    /**
     * As of Java 2 platform v1.3 this previously undocumented field is no
     * longer used.
     * Key bindings are now defined by the LookAndFeel, please refer to
     * the key bindings specification for further details.
     *
     * @deprecated As of Java 2 platform v1.3.
     */
    @Deprecated
    protected KeyStroke downKey;
    /**
     * As of Java 2 platform v1.3 this previously undocumented field is no
     * longer used.
     * Key bindings are now defined by the LookAndFeel, please refer to
     * the key bindings specification for further details.
     *
     * @deprecated As of Java 2 platform v1.3.
     */
    @Deprecated
    protected KeyStroke leftKey;
    /**
     * As of Java 2 platform v1.3 this previously undocumented field is no
     * longer used.
     * Key bindings are now defined by the LookAndFeel, please refer to
     * the key bindings specification for further details.
     *
     * @deprecated As of Java 2 platform v1.3.
     */
    @Deprecated
    protected KeyStroke rightKey;


<span class="nc" id="L132">    private static String FOCUSED_COMP_INDEX = &quot;JToolBar.focusedCompIndex&quot;;</span>

    public static ComponentUI createUI( JComponent c )
    {
<span class="nc" id="L136">        return new BasicToolBarUI();</span>
    }

    public void installUI( JComponent c )
    {
<span class="nc" id="L141">        toolBar = (JToolBar) c;</span>

        // Set defaults
<span class="nc" id="L144">        installDefaults();</span>
<span class="nc" id="L145">        installComponents();</span>
<span class="nc" id="L146">        installListeners();</span>
<span class="nc" id="L147">        installKeyboardActions();</span>

        // Initialize instance vars
<span class="nc" id="L150">        dockingSensitivity = 0;</span>
<span class="nc" id="L151">        floating = false;</span>
<span class="nc" id="L152">        floatingX = floatingY = 0;</span>
<span class="nc" id="L153">        floatingToolBar = null;</span>

<span class="nc" id="L155">        setOrientation( toolBar.getOrientation() );</span>
<span class="nc" id="L156">        LookAndFeel.installProperty(c, &quot;opaque&quot;, Boolean.TRUE);</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">        if ( c.getClientProperty( FOCUSED_COMP_INDEX ) != null )</span>
        {
<span class="nc" id="L160">            focusedCompIndex = ( (Integer) ( c.getClientProperty( FOCUSED_COMP_INDEX ) ) ).intValue();</span>
        }
<span class="nc" id="L162">    }</span>

    public void uninstallUI( JComponent c )
    {

        // Clear defaults
<span class="nc" id="L168">        uninstallDefaults();</span>
<span class="nc" id="L169">        uninstallComponents();</span>
<span class="nc" id="L170">        uninstallListeners();</span>
<span class="nc" id="L171">        uninstallKeyboardActions();</span>

        // Clear instance vars
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (isFloating())</span>
<span class="nc" id="L175">            setFloating(false, null);</span>

<span class="nc" id="L177">        floatingToolBar = null;</span>
<span class="nc" id="L178">        dragWindow = null;</span>
<span class="nc" id="L179">        dockingSource = null;</span>

<span class="nc" id="L181">        c.putClientProperty( FOCUSED_COMP_INDEX, Integer.valueOf( focusedCompIndex ) );</span>
<span class="nc" id="L182">    }</span>

    protected void installDefaults( )
    {
<span class="nc" id="L186">        LookAndFeel.installBorder(toolBar,&quot;ToolBar.border&quot;);</span>
<span class="nc" id="L187">        LookAndFeel.installColorsAndFont(toolBar,</span>
                                              &quot;ToolBar.background&quot;,
                                              &quot;ToolBar.foreground&quot;,
                                              &quot;ToolBar.font&quot;);
        // Toolbar specific defaults
<span class="nc bnc" id="L192" title="All 4 branches missed.">        if ( dockingColor == null || dockingColor instanceof UIResource )</span>
<span class="nc" id="L193">            dockingColor = UIManager.getColor(&quot;ToolBar.dockingBackground&quot;);</span>
<span class="nc bnc" id="L194" title="All 4 branches missed.">        if ( floatingColor == null || floatingColor instanceof UIResource )</span>
<span class="nc" id="L195">            floatingColor = UIManager.getColor(&quot;ToolBar.floatingBackground&quot;);</span>
<span class="nc bnc" id="L196" title="All 4 branches missed.">        if ( dockingBorderColor == null ||</span>
             dockingBorderColor instanceof UIResource )
<span class="nc" id="L198">            dockingBorderColor = UIManager.getColor(&quot;ToolBar.dockingForeground&quot;);</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">        if ( floatingBorderColor == null ||</span>
             floatingBorderColor instanceof UIResource )
<span class="nc" id="L201">            floatingBorderColor = UIManager.getColor(&quot;ToolBar.floatingForeground&quot;);</span>

        // ToolBar rollover button borders
<span class="nc" id="L204">        Object rolloverProp = toolBar.getClientProperty( IS_ROLLOVER );</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (rolloverProp == null) {</span>
<span class="nc" id="L206">            rolloverProp = UIManager.get(&quot;ToolBar.isRollover&quot;);</span>
        }
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if ( rolloverProp != null ) {</span>
<span class="nc" id="L209">            rolloverBorders = ((Boolean)rolloverProp).booleanValue();</span>
        }

<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (rolloverBorder == null) {</span>
<span class="nc" id="L213">            rolloverBorder = createRolloverBorder();</span>
        }
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (nonRolloverBorder == null) {</span>
<span class="nc" id="L216">            nonRolloverBorder = createNonRolloverBorder();</span>
        }
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (nonRolloverToggleBorder == null) {</span>
<span class="nc" id="L219">            nonRolloverToggleBorder = createNonRolloverToggleBorder();</span>
        }


<span class="nc" id="L223">        setRolloverBorders( isRolloverBorders() );</span>
<span class="nc" id="L224">    }</span>

    protected void uninstallDefaults( )
    {
<span class="nc" id="L228">        LookAndFeel.uninstallBorder(toolBar);</span>
<span class="nc" id="L229">        dockingColor = null;</span>
<span class="nc" id="L230">        floatingColor = null;</span>
<span class="nc" id="L231">        dockingBorderColor = null;</span>
<span class="nc" id="L232">        floatingBorderColor = null;</span>

<span class="nc" id="L234">        installNormalBorders(toolBar);</span>

<span class="nc" id="L236">        rolloverBorder = null;</span>
<span class="nc" id="L237">        nonRolloverBorder = null;</span>
<span class="nc" id="L238">        nonRolloverToggleBorder = null;</span>
<span class="nc" id="L239">    }</span>

    protected void installComponents( )
    {
<span class="nc" id="L243">    }</span>

    protected void uninstallComponents( )
    {
<span class="nc" id="L247">    }</span>

    protected void installListeners( )
    {
<span class="nc" id="L251">        dockingListener = createDockingListener( );</span>

<span class="nc bnc" id="L253" title="All 2 branches missed.">        if ( dockingListener != null )</span>
        {
<span class="nc" id="L255">            toolBar.addMouseMotionListener( dockingListener );</span>
<span class="nc" id="L256">            toolBar.addMouseListener( dockingListener );</span>
        }

<span class="nc" id="L259">        propertyListener = createPropertyListener();  // added in setFloating</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (propertyListener != null) {</span>
<span class="nc" id="L261">            toolBar.addPropertyChangeListener(propertyListener);</span>
        }

<span class="nc" id="L264">        toolBarContListener = createToolBarContListener();</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if ( toolBarContListener != null ) {</span>
<span class="nc" id="L266">            toolBar.addContainerListener( toolBarContListener );</span>
        }

<span class="nc" id="L269">        toolBarFocusListener = createToolBarFocusListener();</span>

<span class="nc bnc" id="L271" title="All 2 branches missed.">        if ( toolBarFocusListener != null )</span>
        {
            // Put focus listener on all components in toolbar
<span class="nc" id="L274">            Component[] components = toolBar.getComponents();</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">            for (Component component : components) {</span>
<span class="nc" id="L277">                component.addFocusListener(toolBarFocusListener);</span>
            }
        }
<span class="nc" id="L280">    }</span>

    protected void uninstallListeners( )
    {
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if ( dockingListener != null )</span>
        {
<span class="nc" id="L286">            toolBar.removeMouseMotionListener(dockingListener);</span>
<span class="nc" id="L287">            toolBar.removeMouseListener(dockingListener);</span>

<span class="nc" id="L289">            dockingListener = null;</span>
        }

<span class="nc bnc" id="L292" title="All 2 branches missed.">        if ( propertyListener != null )</span>
        {
<span class="nc" id="L294">            toolBar.removePropertyChangeListener(propertyListener);</span>
<span class="nc" id="L295">            propertyListener = null;  // removed in setFloating</span>
        }

<span class="nc bnc" id="L298" title="All 2 branches missed.">        if ( toolBarContListener != null )</span>
        {
<span class="nc" id="L300">            toolBar.removeContainerListener( toolBarContListener );</span>
<span class="nc" id="L301">            toolBarContListener = null;</span>
        }

<span class="nc bnc" id="L304" title="All 2 branches missed.">        if ( toolBarFocusListener != null )</span>
        {
            // Remove focus listener from all components in toolbar
<span class="nc" id="L307">            Component[] components = toolBar.getComponents();</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">            for (Component component : components) {</span>
<span class="nc" id="L310">                component.removeFocusListener(toolBarFocusListener);</span>
            }

<span class="nc" id="L313">            toolBarFocusListener = null;</span>
        }
<span class="nc" id="L315">        handler = null;</span>
<span class="nc" id="L316">    }</span>

    protected void installKeyboardActions( )
    {
<span class="nc" id="L320">        InputMap km = getInputMap(JComponent.</span>
                                  WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);

<span class="nc" id="L323">        SwingUtilities.replaceUIInputMap(toolBar, JComponent.</span>
                                         WHEN_ANCESTOR_OF_FOCUSED_COMPONENT,
                                         km);

<span class="nc" id="L327">    LazyActionMap.installLazyActionMap(toolBar, BasicToolBarUI.class,</span>
            &quot;ToolBar.actionMap&quot;);
<span class="nc" id="L329">    }</span>

    InputMap getInputMap(int condition) {
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (condition == JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT) {</span>
<span class="nc" id="L333">            return (InputMap)DefaultLookup.get(toolBar, this,</span>
                    &quot;ToolBar.ancestorInputMap&quot;);
        }
<span class="nc" id="L336">        return null;</span>
    }

    static void loadActionMap(LazyActionMap map) {
<span class="nc" id="L340">        map.put(new Actions(Actions.NAVIGATE_RIGHT));</span>
<span class="nc" id="L341">        map.put(new Actions(Actions.NAVIGATE_LEFT));</span>
<span class="nc" id="L342">        map.put(new Actions(Actions.NAVIGATE_UP));</span>
<span class="nc" id="L343">        map.put(new Actions(Actions.NAVIGATE_DOWN));</span>
<span class="nc" id="L344">    }</span>

    protected void uninstallKeyboardActions( )
    {
<span class="nc" id="L348">        SwingUtilities.replaceUIActionMap(toolBar, null);</span>
<span class="nc" id="L349">        SwingUtilities.replaceUIInputMap(toolBar, JComponent.</span>
                                         WHEN_ANCESTOR_OF_FOCUSED_COMPONENT,
                                         null);
<span class="nc" id="L352">    }</span>

    protected void navigateFocusedComp( int direction )
    {
<span class="nc" id="L356">        int nComp = toolBar.getComponentCount();</span>
        int j;

<span class="nc bnc" id="L359" title="All 3 branches missed.">        switch ( direction )</span>
        {
            case EAST:
            case SOUTH:

<span class="nc bnc" id="L364" title="All 4 branches missed.">                if ( focusedCompIndex &lt; 0 || focusedCompIndex &gt;= nComp ) break;</span>

<span class="nc" id="L366">                j = focusedCompIndex + 1;</span>

<span class="nc bnc" id="L368" title="All 2 branches missed.">                while ( j != focusedCompIndex )</span>
                {
<span class="nc bnc" id="L370" title="All 2 branches missed.">                    if ( j &gt;= nComp ) j = 0;</span>
<span class="nc" id="L371">                    Component comp = toolBar.getComponentAtIndex( j++ );</span>

<span class="nc bnc" id="L373" title="All 6 branches missed.">                    if ( comp != null &amp;&amp; comp.isFocusTraversable() &amp;&amp; comp.isEnabled() )</span>
                    {
<span class="nc" id="L375">                        comp.requestFocus();</span>
<span class="nc" id="L376">                        break;</span>
                    }
<span class="nc" id="L378">                }</span>

                break;

            case WEST:
            case NORTH:

<span class="nc bnc" id="L385" title="All 4 branches missed.">                if ( focusedCompIndex &lt; 0 || focusedCompIndex &gt;= nComp ) break;</span>

<span class="nc" id="L387">                j = focusedCompIndex - 1;</span>

<span class="nc bnc" id="L389" title="All 2 branches missed.">                while ( j != focusedCompIndex )</span>
                {
<span class="nc bnc" id="L391" title="All 2 branches missed.">                    if ( j &lt; 0 ) j = nComp - 1;</span>
<span class="nc" id="L392">                    Component comp = toolBar.getComponentAtIndex( j-- );</span>

<span class="nc bnc" id="L394" title="All 6 branches missed.">                    if ( comp != null &amp;&amp; comp.isFocusTraversable() &amp;&amp; comp.isEnabled() )</span>
                    {
<span class="nc" id="L396">                        comp.requestFocus();</span>
<span class="nc" id="L397">                        break;</span>
                    }
<span class="nc" id="L399">                }</span>

                break;

            default:
                break;
        }
<span class="nc" id="L406">    }</span>

    /**
     * Creates a rollover border for toolbar components. The
     * rollover border will be installed if rollover borders are
     * enabled.
     * &lt;p&gt;
     * Override this method to provide an alternate rollover border.
     *
     * @since 1.4
     */
    protected Border createRolloverBorder() {
<span class="nc" id="L418">        Object border = UIManager.get(&quot;ToolBar.rolloverBorder&quot;);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (border != null) {</span>
<span class="nc" id="L420">            return (Border)border;</span>
        }
<span class="nc" id="L422">        UIDefaults table = UIManager.getLookAndFeelDefaults();</span>
<span class="nc" id="L423">        return new CompoundBorder(new BasicBorders.RolloverButtonBorder(</span>
<span class="nc" id="L424">                                           table.getColor(&quot;controlShadow&quot;),</span>
<span class="nc" id="L425">                                           table.getColor(&quot;controlDkShadow&quot;),</span>
<span class="nc" id="L426">                                           table.getColor(&quot;controlHighlight&quot;),</span>
<span class="nc" id="L427">                                           table.getColor(&quot;controlLtHighlight&quot;)),</span>
                                  new BasicBorders.RolloverMarginBorder());
    }

    /**
     * Creates the non rollover border for toolbar components. This
     * border will be installed as the border for components added
     * to the toolbar if rollover borders are not enabled.
     * &lt;p&gt;
     * Override this method to provide an alternate rollover border.
     *
     * @since 1.4
     */
    protected Border createNonRolloverBorder() {
<span class="nc" id="L441">        Object border = UIManager.get(&quot;ToolBar.nonrolloverBorder&quot;);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (border != null) {</span>
<span class="nc" id="L443">            return (Border)border;</span>
        }
<span class="nc" id="L445">        UIDefaults table = UIManager.getLookAndFeelDefaults();</span>
<span class="nc" id="L446">        return new CompoundBorder(new BasicBorders.ButtonBorder(</span>
<span class="nc" id="L447">                                           table.getColor(&quot;Button.shadow&quot;),</span>
<span class="nc" id="L448">                                           table.getColor(&quot;Button.darkShadow&quot;),</span>
<span class="nc" id="L449">                                           table.getColor(&quot;Button.light&quot;),</span>
<span class="nc" id="L450">                                           table.getColor(&quot;Button.highlight&quot;)),</span>
                                  new BasicBorders.RolloverMarginBorder());
    }

    /**
     * Creates a non rollover border for Toggle buttons in the toolbar.
     */
    private Border createNonRolloverToggleBorder() {
<span class="nc" id="L458">        UIDefaults table = UIManager.getLookAndFeelDefaults();</span>
<span class="nc" id="L459">        return new CompoundBorder(new BasicBorders.RadioButtonBorder(</span>
<span class="nc" id="L460">                                           table.getColor(&quot;ToggleButton.shadow&quot;),</span>
<span class="nc" id="L461">                                           table.getColor(&quot;ToggleButton.darkShadow&quot;),</span>
<span class="nc" id="L462">                                           table.getColor(&quot;ToggleButton.light&quot;),</span>
<span class="nc" id="L463">                                           table.getColor(&quot;ToggleButton.highlight&quot;)),</span>
                                  new BasicBorders.RolloverMarginBorder());
    }

    /**
     * No longer used, use BasicToolBarUI.createFloatingWindow(JToolBar)
     * @see #createFloatingWindow
     */
    protected JFrame createFloatingFrame(JToolBar toolbar) {
<span class="nc" id="L472">        Window window = SwingUtilities.getWindowAncestor(toolbar);</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">        JFrame frame = new JFrame(toolbar.getName(),</span>
<span class="nc" id="L474">                                  (window != null) ? window.getGraphicsConfiguration() : null) {</span>
            // Override createRootPane() to automatically resize
            // the frame when contents change
            protected JRootPane createRootPane() {
<span class="nc" id="L478">                JRootPane rootPane = new JRootPane() {</span>
<span class="nc" id="L479">                    private boolean packing = false;</span>

                    public void validate() {
<span class="nc" id="L482">                        super.validate();</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">                        if (!packing) {</span>
<span class="nc" id="L484">                            packing = true;</span>
<span class="nc" id="L485">                            pack();</span>
<span class="nc" id="L486">                            packing = false;</span>
                        }
<span class="nc" id="L488">                    }</span>
                };
<span class="nc" id="L490">                rootPane.setOpaque(true);</span>
<span class="nc" id="L491">                return rootPane;</span>
            }
        };
<span class="nc" id="L494">        frame.getRootPane().setName(&quot;ToolBar.FloatingFrame&quot;);</span>
<span class="nc" id="L495">        frame.setResizable(false);</span>
<span class="nc" id="L496">        WindowListener wl = createFrameListener();</span>
<span class="nc" id="L497">        frame.addWindowListener(wl);</span>
<span class="nc" id="L498">        return frame;</span>
    }

    /**
     * Creates a window which contains the toolbar after it has been
     * dragged out from its container
     * @return a &lt;code&gt;RootPaneContainer&lt;/code&gt; object, containing the toolbar.
     * @since 1.4
     */
    protected RootPaneContainer createFloatingWindow(JToolBar toolbar) {
        class ToolBarDialog extends JDialog {
<span class="nc" id="L509">            public ToolBarDialog(Frame owner, String title, boolean modal) {</span>
<span class="nc" id="L510">                super(owner, title, modal);</span>
<span class="nc" id="L511">            }</span>

<span class="nc" id="L513">            public ToolBarDialog(Dialog owner, String title, boolean modal) {</span>
<span class="nc" id="L514">                super(owner, title, modal);</span>
<span class="nc" id="L515">            }</span>

            // Override createRootPane() to automatically resize
            // the frame when contents change
            protected JRootPane createRootPane() {
<span class="nc" id="L520">                JRootPane rootPane = new JRootPane() {</span>
<span class="nc" id="L521">                    private boolean packing = false;</span>

                    public void validate() {
<span class="nc" id="L524">                        super.validate();</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">                        if (!packing) {</span>
<span class="nc" id="L526">                            packing = true;</span>
<span class="nc" id="L527">                            pack();</span>
<span class="nc" id="L528">                            packing = false;</span>
                        }
<span class="nc" id="L530">                    }</span>
                };
<span class="nc" id="L532">                rootPane.setOpaque(true);</span>
<span class="nc" id="L533">                return rootPane;</span>
            }
        }

        JDialog dialog;
<span class="nc" id="L538">        Window window = SwingUtilities.getWindowAncestor(toolbar);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (window instanceof Frame) {</span>
<span class="nc" id="L540">            dialog = new ToolBarDialog((Frame)window, toolbar.getName(), false);</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">        } else if (window instanceof Dialog) {</span>
<span class="nc" id="L542">            dialog = new ToolBarDialog((Dialog)window, toolbar.getName(), false);</span>
        } else {
<span class="nc" id="L544">            dialog = new ToolBarDialog((Frame)null, toolbar.getName(), false);</span>
        }

<span class="nc" id="L547">        dialog.getRootPane().setName(&quot;ToolBar.FloatingWindow&quot;);</span>
<span class="nc" id="L548">        dialog.setTitle(toolbar.getName());</span>
<span class="nc" id="L549">        dialog.setResizable(false);</span>
<span class="nc" id="L550">        WindowListener wl = createFrameListener();</span>
<span class="nc" id="L551">        dialog.addWindowListener(wl);</span>
<span class="nc" id="L552">        return dialog;</span>
    }

    protected DragWindow createDragWindow(JToolBar toolbar) {
<span class="nc" id="L556">        Window frame = null;</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">        if(toolBar != null) {</span>
            Container p;
<span class="nc bnc" id="L559" title="All 4 branches missed.">            for(p = toolBar.getParent() ; p != null &amp;&amp; !(p instanceof Window) ;</span>
<span class="nc" id="L560">                p = p.getParent());</span>
<span class="nc bnc" id="L561" title="All 4 branches missed.">            if(p != null &amp;&amp; p instanceof Window)</span>
<span class="nc" id="L562">                frame = (Window) p;</span>
        }
<span class="nc bnc" id="L564" title="All 2 branches missed.">        if(floatingToolBar == null) {</span>
<span class="nc" id="L565">            floatingToolBar = createFloatingWindow(toolBar);</span>
        }
<span class="nc bnc" id="L567" title="All 2 branches missed.">        if (floatingToolBar instanceof Window) frame = (Window) floatingToolBar;</span>
<span class="nc" id="L568">        DragWindow dragWindow = new DragWindow(frame);</span>
<span class="nc" id="L569">        return dragWindow;</span>
    }

    /**
     * Returns a flag to determine whether rollover button borders
     * are enabled.
     *
     * @return true if rollover borders are enabled; false otherwise
     * @see #setRolloverBorders
     * @since 1.4
     */
    public boolean isRolloverBorders() {
<span class="nc" id="L581">        return rolloverBorders;</span>
    }

    /**
     * Sets the flag for enabling rollover borders on the toolbar and it will
     * also install the appropriate border depending on the state of the flag.
     *
     * @param rollover if true, rollover borders are installed.
     *        Otherwise non-rollover borders are installed
     * @see #isRolloverBorders
     * @since 1.4
     */
    public void setRolloverBorders( boolean rollover ) {
<span class="nc" id="L594">        rolloverBorders = rollover;</span>

<span class="nc bnc" id="L596" title="All 2 branches missed.">        if ( rolloverBorders )  {</span>
<span class="nc" id="L597">            installRolloverBorders( toolBar );</span>
        } else  {
<span class="nc" id="L599">            installNonRolloverBorders( toolBar );</span>
        }
<span class="nc" id="L601">    }</span>

    /**
     * Installs rollover borders on all the child components of the JComponent.
     * &lt;p&gt;
     * This is a convenience method to call &lt;code&gt;setBorderToRollover&lt;/code&gt;
     * for each child component.
     *
     * @param c container which holds the child components (usually a JToolBar)
     * @see #setBorderToRollover
     * @since 1.4
     */
    protected void installRolloverBorders ( JComponent c )  {
        // Put rollover borders on buttons
<span class="nc" id="L615">        Component[] components = c.getComponents();</span>

<span class="nc bnc" id="L617" title="All 2 branches missed.">        for (Component component : components) {</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">            if (component instanceof JComponent) {</span>
<span class="nc" id="L619">                ((JComponent) component).updateUI();</span>
<span class="nc" id="L620">                setBorderToRollover(component);</span>
            }
        }
<span class="nc" id="L623">    }</span>

    /**
     * Installs non-rollover borders on all the child components of the JComponent.
     * A non-rollover border is the border that is installed on the child component
     * while it is in the toolbar.
     * &lt;p&gt;
     * This is a convenience method to call &lt;code&gt;setBorderToNonRollover&lt;/code&gt;
     * for each child component.
     *
     * @param c container which holds the child components (usually a JToolBar)
     * @see #setBorderToNonRollover
     * @since 1.4
     */
    protected void installNonRolloverBorders ( JComponent c )  {
        // Put non-rollover borders on buttons. These borders reduce the margin.
<span class="nc" id="L639">        Component[] components = c.getComponents();</span>

<span class="nc bnc" id="L641" title="All 2 branches missed.">        for (Component component : components) {</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">            if (component instanceof JComponent) {</span>
<span class="nc" id="L643">                ((JComponent) component).updateUI();</span>
<span class="nc" id="L644">                setBorderToNonRollover(component);</span>
            }
        }
<span class="nc" id="L647">    }</span>

    /**
     * Installs normal borders on all the child components of the JComponent.
     * A normal border is the original border that was installed on the child
     * component before it was added to the toolbar.
     * &lt;p&gt;
     * This is a convenience method to call &lt;code&gt;setBorderNormal&lt;/code&gt;
     * for each child component.
     *
     * @param c container which holds the child components (usually a JToolBar)
     * @see #setBorderToNonRollover
     * @since 1.4
     */
    protected void installNormalBorders ( JComponent c )  {
        // Put back the normal borders on buttons
<span class="nc" id="L663">        Component[] components = c.getComponents();</span>

<span class="nc bnc" id="L665" title="All 2 branches missed.">        for (Component component : components) {</span>
<span class="nc" id="L666">            setBorderToNormal(component);</span>
        }
<span class="nc" id="L668">    }</span>

    /**
     * Sets the border of the component to have a rollover border which
     * was created by the {@link #createRolloverBorder} method.
     *
     * @param c component which will have a rollover border installed
     * @see #createRolloverBorder
     * @since 1.4
     */
    protected void setBorderToRollover(Component c) {
<span class="nc bnc" id="L679" title="All 2 branches missed.">        if (c instanceof AbstractButton) {</span>
<span class="nc" id="L680">            AbstractButton b = (AbstractButton)c;</span>

<span class="nc" id="L682">            Border border = borderTable.get(b);</span>
<span class="nc bnc" id="L683" title="All 4 branches missed.">            if (border == null || border instanceof UIResource) {</span>
<span class="nc" id="L684">                borderTable.put(b, b.getBorder());</span>
            }

            // Only set the border if its the default border
<span class="nc bnc" id="L688" title="All 2 branches missed.">            if (b.getBorder() instanceof UIResource) {</span>
<span class="nc" id="L689">                b.setBorder(getRolloverBorder(b));</span>
            }

<span class="nc bnc" id="L692" title="All 2 branches missed.">            rolloverTable.put(b, b.isRolloverEnabled()?</span>
                              Boolean.TRUE: Boolean.FALSE);
<span class="nc" id="L694">            b.setRolloverEnabled(true);</span>
        }
<span class="nc" id="L696">    }</span>

    /**
     * Returns a rollover border for the button.
     *
     * @param b the button to calculate the rollover border for
     * @return the rollover border
     * @see #setBorderToRollover
     * @since 1.6
     */
    protected Border getRolloverBorder(AbstractButton b) {
<span class="nc" id="L707">        return rolloverBorder;</span>
    }

    /**
     * Sets the border of the component to have a non-rollover border which
     * was created by the {@link #createNonRolloverBorder} method.
     *
     * @param c component which will have a non-rollover border installed
     * @see #createNonRolloverBorder
     * @since 1.4
     */
    protected void setBorderToNonRollover(Component c) {
<span class="nc bnc" id="L719" title="All 2 branches missed.">        if (c instanceof AbstractButton) {</span>
<span class="nc" id="L720">            AbstractButton b = (AbstractButton)c;</span>

<span class="nc" id="L722">            Border border = borderTable.get(b);</span>
<span class="nc bnc" id="L723" title="All 4 branches missed.">            if (border == null || border instanceof UIResource) {</span>
<span class="nc" id="L724">                borderTable.put(b, b.getBorder());</span>
            }

            // Only set the border if its the default border
<span class="nc bnc" id="L728" title="All 2 branches missed.">            if (b.getBorder() instanceof UIResource) {</span>
<span class="nc" id="L729">                b.setBorder(getNonRolloverBorder(b));</span>
            }
<span class="nc bnc" id="L731" title="All 2 branches missed.">            rolloverTable.put(b, b.isRolloverEnabled()?</span>
                              Boolean.TRUE: Boolean.FALSE);
<span class="nc" id="L733">            b.setRolloverEnabled(false);</span>
        }
<span class="nc" id="L735">    }</span>

    /**
     * Returns a non-rollover border for the button.
     *
     * @param b the button to calculate the non-rollover border for
     * @return the non-rollover border
     * @see #setBorderToNonRollover
     * @since 1.6
     */
    protected Border getNonRolloverBorder(AbstractButton b) {
<span class="nc bnc" id="L746" title="All 2 branches missed.">        if (b instanceof JToggleButton) {</span>
<span class="nc" id="L747">            return nonRolloverToggleBorder;</span>
        } else {
<span class="nc" id="L749">            return nonRolloverBorder;</span>
        }
    }

    /**
     * Sets the border of the component to have a normal border.
     * A normal border is the original border that was installed on the child
     * component before it was added to the toolbar.
     *
     * @param c component which will have a normal border re-installed
     * @see #createNonRolloverBorder
     * @since 1.4
     */
    protected void setBorderToNormal(Component c) {
<span class="nc bnc" id="L763" title="All 2 branches missed.">        if (c instanceof AbstractButton) {</span>
<span class="nc" id="L764">            AbstractButton b = (AbstractButton)c;</span>

<span class="nc" id="L766">            Border border = borderTable.remove(b);</span>
<span class="nc" id="L767">            b.setBorder(border);</span>

<span class="nc" id="L769">            Boolean value = rolloverTable.remove(b);</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">            if (value != null) {</span>
<span class="nc" id="L771">                b.setRolloverEnabled(value.booleanValue());</span>
            }
        }
<span class="nc" id="L774">    }</span>

    public void setFloatingLocation(int x, int y) {
<span class="nc" id="L777">        floatingX = x;</span>
<span class="nc" id="L778">        floatingY = y;</span>
<span class="nc" id="L779">    }</span>

    public boolean isFloating() {
<span class="nc" id="L782">        return floating;</span>
    }

    public void setFloating(boolean b, Point p) {
<span class="nc bnc" id="L786" title="All 2 branches missed.">        if (toolBar.isFloatable()) {</span>
<span class="nc" id="L787">            boolean visible = false;</span>
<span class="nc" id="L788">            Window ancestor = SwingUtilities.getWindowAncestor(toolBar);</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">            if (ancestor != null) {</span>
<span class="nc" id="L790">                visible = ancestor.isVisible();</span>
            }
<span class="nc bnc" id="L792" title="All 2 branches missed.">            if (dragWindow != null)</span>
<span class="nc" id="L793">                dragWindow.setVisible(false);</span>
<span class="nc" id="L794">            this.floating = b;</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">            if (floatingToolBar == null) {</span>
<span class="nc" id="L796">                floatingToolBar = createFloatingWindow(toolBar);</span>
            }
<span class="nc bnc" id="L798" title="All 2 branches missed.">            if (b == true)</span>
            {
<span class="nc bnc" id="L800" title="All 2 branches missed.">                if (dockingSource == null)</span>
                {
<span class="nc" id="L802">                    dockingSource = toolBar.getParent();</span>
<span class="nc" id="L803">                    dockingSource.remove(toolBar);</span>
                }
<span class="nc" id="L805">                constraintBeforeFloating = calculateConstraint();</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">                if ( propertyListener != null )</span>
<span class="nc" id="L807">                    UIManager.addPropertyChangeListener( propertyListener );</span>
<span class="nc" id="L808">                floatingToolBar.getContentPane().add(toolBar,BorderLayout.CENTER);</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">                if (floatingToolBar instanceof Window) {</span>
<span class="nc" id="L810">                    ((Window)floatingToolBar).pack();</span>
<span class="nc" id="L811">                    ((Window)floatingToolBar).setLocation(floatingX, floatingY);</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">                    if (visible) {</span>
<span class="nc" id="L813">                        ((Window)floatingToolBar).show();</span>
                    } else {
<span class="nc" id="L815">                        ancestor.addWindowListener(new WindowAdapter() {</span>
                            public void windowOpened(WindowEvent e) {
<span class="nc" id="L817">                                ((Window)floatingToolBar).show();</span>
<span class="nc" id="L818">                            }</span>
                        });
                    }
                }
            } else {
<span class="nc bnc" id="L823" title="All 2 branches missed.">                if (floatingToolBar == null)</span>
<span class="nc" id="L824">                    floatingToolBar = createFloatingWindow(toolBar);</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">                if (floatingToolBar instanceof Window) ((Window)floatingToolBar).setVisible(false);</span>
<span class="nc" id="L826">                floatingToolBar.getContentPane().remove(toolBar);</span>
<span class="nc" id="L827">                String constraint = getDockingConstraint(dockingSource,</span>
                                                         p);
<span class="nc bnc" id="L829" title="All 2 branches missed.">                if (constraint == null) {</span>
<span class="nc" id="L830">                    constraint = BorderLayout.NORTH;</span>
                }
<span class="nc" id="L832">                int orientation = mapConstraintToOrientation(constraint);</span>
<span class="nc" id="L833">                setOrientation(orientation);</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">                if (dockingSource== null)</span>
<span class="nc" id="L835">                    dockingSource = toolBar.getParent();</span>
<span class="nc bnc" id="L836" title="All 2 branches missed.">                if ( propertyListener != null )</span>
<span class="nc" id="L837">                    UIManager.removePropertyChangeListener( propertyListener );</span>
<span class="nc" id="L838">                dockingSource.add(constraint, toolBar);</span>
            }
<span class="nc" id="L840">            dockingSource.invalidate();</span>
<span class="nc" id="L841">            Container dockingSourceParent = dockingSource.getParent();</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">            if (dockingSourceParent != null)</span>
<span class="nc" id="L843">                dockingSourceParent.validate();</span>
<span class="nc" id="L844">            dockingSource.repaint();</span>
        }
<span class="nc" id="L846">    }</span>

    private int mapConstraintToOrientation(String constraint)
    {
<span class="nc" id="L850">        int orientation = toolBar.getOrientation();</span>

<span class="nc bnc" id="L852" title="All 2 branches missed.">        if ( constraint != null )</span>
        {
<span class="nc bnc" id="L854" title="All 4 branches missed.">            if ( constraint.equals(BorderLayout.EAST) || constraint.equals(BorderLayout.WEST) )</span>
<span class="nc" id="L855">                orientation = JToolBar.VERTICAL;</span>
<span class="nc bnc" id="L856" title="All 4 branches missed.">            else if ( constraint.equals(BorderLayout.NORTH) || constraint.equals(BorderLayout.SOUTH) )</span>
<span class="nc" id="L857">                orientation = JToolBar.HORIZONTAL;</span>
        }

<span class="nc" id="L860">        return orientation;</span>
    }

    public void setOrientation(int orientation)
    {
<span class="nc" id="L865">        toolBar.setOrientation( orientation );</span>

<span class="nc bnc" id="L867" title="All 2 branches missed.">        if (dragWindow !=null)</span>
<span class="nc" id="L868">            dragWindow.setOrientation(orientation);</span>
<span class="nc" id="L869">    }</span>

    /**
     * Gets the color displayed when over a docking area
     */
    public Color getDockingColor() {
<span class="nc" id="L875">        return dockingColor;</span>
    }

    /**
     * Sets the color displayed when over a docking area
     */
   public void setDockingColor(Color c) {
<span class="nc" id="L882">        this.dockingColor = c;</span>
<span class="nc" id="L883">    }</span>

    /**
     * Gets the color displayed when over a floating area
     */
    public Color getFloatingColor() {
<span class="nc" id="L889">        return floatingColor;</span>
    }

    /**
     * Sets the color displayed when over a floating area
     */
    public void setFloatingColor(Color c) {
<span class="nc" id="L896">        this.floatingColor = c;</span>
<span class="nc" id="L897">    }</span>

    private boolean isBlocked(Component comp, Object constraint) {
<span class="nc bnc" id="L900" title="All 2 branches missed.">        if (comp instanceof Container) {</span>
<span class="nc" id="L901">            Container cont = (Container)comp;</span>
<span class="nc" id="L902">            LayoutManager lm = cont.getLayout();</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">            if (lm instanceof BorderLayout) {</span>
<span class="nc" id="L904">                BorderLayout blm = (BorderLayout)lm;</span>
<span class="nc" id="L905">                Component c = blm.getLayoutComponent(cont, constraint);</span>
<span class="nc bnc" id="L906" title="All 4 branches missed.">                return (c != null &amp;&amp; c != toolBar);</span>
            }
        }
<span class="nc" id="L909">        return false;</span>
    }

    public boolean canDock(Component c, Point p) {
<span class="nc bnc" id="L913" title="All 4 branches missed.">        return (p != null &amp;&amp; getDockingConstraint(c, p) != null);</span>
    }

    private String calculateConstraint() {
<span class="nc" id="L917">        String constraint = null;</span>
<span class="nc" id="L918">        LayoutManager lm = dockingSource.getLayout();</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">        if (lm instanceof BorderLayout) {</span>
<span class="nc" id="L920">            constraint = (String)((BorderLayout)lm).getConstraints(toolBar);</span>
        }
<span class="nc bnc" id="L922" title="All 2 branches missed.">        return (constraint != null) ? constraint : constraintBeforeFloating;</span>
    }



    private String getDockingConstraint(Component c, Point p) {
<span class="nc bnc" id="L928" title="All 2 branches missed.">        if (p == null) return constraintBeforeFloating;</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">        if (c.contains(p)) {</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">            dockingSensitivity = (toolBar.getOrientation() == JToolBar.HORIZONTAL)</span>
<span class="nc" id="L931">                                                ? toolBar.getSize().height</span>
<span class="nc" id="L932">                                                : toolBar.getSize().width;</span>
            // North  (Base distance on height for now!)
<span class="nc bnc" id="L934" title="All 4 branches missed.">            if (p.y &lt; dockingSensitivity &amp;&amp; !isBlocked(c, BorderLayout.NORTH)) {</span>
<span class="nc" id="L935">                return BorderLayout.NORTH;</span>
            }
            // East  (Base distance on height for now!)
<span class="nc bnc" id="L938" title="All 4 branches missed.">            if (p.x &gt;= c.getWidth() - dockingSensitivity &amp;&amp; !isBlocked(c, BorderLayout.EAST)) {</span>
<span class="nc" id="L939">                return BorderLayout.EAST;</span>
            }
            // West  (Base distance on height for now!)
<span class="nc bnc" id="L942" title="All 4 branches missed.">            if (p.x &lt; dockingSensitivity &amp;&amp; !isBlocked(c, BorderLayout.WEST)) {</span>
<span class="nc" id="L943">                return BorderLayout.WEST;</span>
            }
<span class="nc bnc" id="L945" title="All 4 branches missed.">            if (p.y &gt;= c.getHeight() - dockingSensitivity &amp;&amp; !isBlocked(c, BorderLayout.SOUTH)) {</span>
<span class="nc" id="L946">                return BorderLayout.SOUTH;</span>
            }
        }
<span class="nc" id="L949">        return null;</span>
    }

    protected void dragTo(Point position, Point origin)
    {
<span class="nc bnc" id="L954" title="All 2 branches missed.">        if (toolBar.isFloatable())</span>
        {
          try
          {
<span class="nc bnc" id="L958" title="All 2 branches missed.">            if (dragWindow == null)</span>
<span class="nc" id="L959">                dragWindow = createDragWindow(toolBar);</span>
<span class="nc" id="L960">            Point offset = dragWindow.getOffset();</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">            if (offset == null) {</span>
<span class="nc" id="L962">                Dimension size = toolBar.getPreferredSize();</span>
<span class="nc" id="L963">                offset = new Point(size.width/2, size.height/2);</span>
<span class="nc" id="L964">                dragWindow.setOffset(offset);</span>
            }
<span class="nc" id="L966">            Point global = new Point(origin.x+ position.x,</span>
                                     origin.y+position.y);
<span class="nc" id="L968">            Point dragPoint = new Point(global.x- offset.x,</span>
                                        global.y- offset.y);
<span class="nc bnc" id="L970" title="All 2 branches missed.">            if (dockingSource == null)</span>
<span class="nc" id="L971">                dockingSource = toolBar.getParent();</span>
<span class="nc" id="L972">                constraintBeforeFloating = calculateConstraint();</span>
<span class="nc" id="L973">            Point dockingPosition = dockingSource.getLocationOnScreen();</span>
<span class="nc" id="L974">            Point comparisonPoint = new Point(global.x-dockingPosition.x,</span>
                                              global.y-dockingPosition.y);
<span class="nc bnc" id="L976" title="All 2 branches missed.">            if (canDock(dockingSource, comparisonPoint)) {</span>
<span class="nc" id="L977">                dragWindow.setBackground(getDockingColor());</span>
<span class="nc" id="L978">                String constraint = getDockingConstraint(dockingSource,</span>
                                                         comparisonPoint);
<span class="nc" id="L980">                int orientation = mapConstraintToOrientation(constraint);</span>
<span class="nc" id="L981">                dragWindow.setOrientation(orientation);</span>
<span class="nc" id="L982">                dragWindow.setBorderColor(dockingBorderColor);</span>
<span class="nc" id="L983">            } else {</span>
<span class="nc" id="L984">                dragWindow.setBackground(getFloatingColor());</span>
<span class="nc" id="L985">                dragWindow.setBorderColor(floatingBorderColor);</span>
<span class="nc" id="L986">                dragWindow.setOrientation(toolBar.getOrientation());</span>
            }

<span class="nc" id="L989">            dragWindow.setLocation(dragPoint.x, dragPoint.y);</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">            if (dragWindow.isVisible() == false) {</span>
<span class="nc" id="L991">                Dimension size = toolBar.getPreferredSize();</span>
<span class="nc" id="L992">                dragWindow.setSize(size.width, size.height);</span>
<span class="nc" id="L993">                dragWindow.show();</span>
            }
          }
<span class="nc" id="L996">          catch ( IllegalComponentStateException e )</span>
          {
<span class="nc" id="L998">          }</span>
        }
<span class="nc" id="L1000">    }</span>

    protected void floatAt(Point position, Point origin)
    {
<span class="nc bnc" id="L1004" title="All 2 branches missed.">        if(toolBar.isFloatable())</span>
        {
          try
          {
<span class="nc" id="L1008">            Point offset = dragWindow.getOffset();</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">            if (offset == null) {</span>
<span class="nc" id="L1010">                offset = position;</span>
<span class="nc" id="L1011">                dragWindow.setOffset(offset);</span>
            }
<span class="nc" id="L1013">            Point global = new Point(origin.x+ position.x,</span>
                                     origin.y+position.y);
<span class="nc" id="L1015">            setFloatingLocation(global.x-offset.x,</span>
                                global.y-offset.y);
<span class="nc bnc" id="L1017" title="All 2 branches missed.">            if (dockingSource != null) {</span>
<span class="nc" id="L1018">                Point dockingPosition = dockingSource.getLocationOnScreen();</span>
<span class="nc" id="L1019">                Point comparisonPoint = new Point(global.x-dockingPosition.x,</span>
                                                  global.y-dockingPosition.y);
<span class="nc bnc" id="L1021" title="All 2 branches missed.">                if (canDock(dockingSource, comparisonPoint)) {</span>
<span class="nc" id="L1022">                    setFloating(false, comparisonPoint);</span>
                } else {
<span class="nc" id="L1024">                    setFloating(true, null);</span>
                }
<span class="nc" id="L1026">            } else {</span>
<span class="nc" id="L1027">                setFloating(true, null);</span>
            }
<span class="nc" id="L1029">            dragWindow.setOffset(null);</span>
          }
<span class="nc" id="L1031">          catch ( IllegalComponentStateException e )</span>
          {
<span class="nc" id="L1033">          }</span>
        }
<span class="nc" id="L1035">    }</span>

    private Handler getHandler() {
<span class="nc bnc" id="L1038" title="All 2 branches missed.">        if (handler == null) {</span>
<span class="nc" id="L1039">            handler = new Handler();</span>
        }
<span class="nc" id="L1041">        return handler;</span>
    }

    protected ContainerListener createToolBarContListener( )
    {
<span class="nc" id="L1046">        return getHandler();</span>
    }

    protected FocusListener createToolBarFocusListener( )
    {
<span class="nc" id="L1051">        return getHandler();</span>
    }

    protected PropertyChangeListener createPropertyListener()
    {
<span class="nc" id="L1056">        return getHandler();</span>
    }

    protected MouseInputListener createDockingListener( ) {
<span class="nc" id="L1060">        getHandler().tb = toolBar;</span>
<span class="nc" id="L1061">        return getHandler();</span>
    }

    protected WindowListener createFrameListener() {
<span class="nc" id="L1065">        return new FrameListener();</span>
    }

    /**
     * Paints the contents of the window used for dragging.
     *
     * @param g Graphics to paint to.
     * @throws NullPointerException is &lt;code&gt;g&lt;/code&gt; is null
     * @since 1.5
     */
    protected void paintDragWindow(Graphics g) {
<span class="nc" id="L1076">        g.setColor(dragWindow.getBackground());</span>
<span class="nc" id="L1077">        int w = dragWindow.getWidth();</span>
<span class="nc" id="L1078">        int h = dragWindow.getHeight();</span>
<span class="nc" id="L1079">        g.fillRect(0, 0, w, h);</span>
<span class="nc" id="L1080">        g.setColor(dragWindow.getBorderColor());</span>
<span class="nc" id="L1081">        g.drawRect(0, 0, w - 1, h - 1);</span>
<span class="nc" id="L1082">    }</span>


    private static class Actions extends UIAction {
        private static final String NAVIGATE_RIGHT = &quot;navigateRight&quot;;
        private static final String NAVIGATE_LEFT = &quot;navigateLeft&quot;;
        private static final String NAVIGATE_UP = &quot;navigateUp&quot;;
        private static final String NAVIGATE_DOWN = &quot;navigateDown&quot;;

        public Actions(String name) {
<span class="nc" id="L1092">            super(name);</span>
<span class="nc" id="L1093">        }</span>

        public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L1096">            String key = getName();</span>
<span class="nc" id="L1097">            JToolBar toolBar = (JToolBar)evt.getSource();</span>
<span class="nc" id="L1098">            BasicToolBarUI ui = (BasicToolBarUI)BasicLookAndFeel.getUIOfType(</span>
<span class="nc" id="L1099">                     toolBar.getUI(), BasicToolBarUI.class);</span>

<span class="nc bnc" id="L1101" title="All 2 branches missed.">            if (NAVIGATE_RIGHT == key) {</span>
<span class="nc" id="L1102">                ui.navigateFocusedComp(EAST);</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">            } else if (NAVIGATE_LEFT == key) {</span>
<span class="nc" id="L1104">                ui.navigateFocusedComp(WEST);</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">            } else if (NAVIGATE_UP == key) {</span>
<span class="nc" id="L1106">                ui.navigateFocusedComp(NORTH);</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">            } else if (NAVIGATE_DOWN == key) {</span>
<span class="nc" id="L1108">                ui.navigateFocusedComp(SOUTH);</span>
            }
<span class="nc" id="L1110">        }</span>
    }


<span class="nc" id="L1114">    private class Handler implements ContainerListener,</span>
            FocusListener, MouseInputListener, PropertyChangeListener {

        //
        // ContainerListener
        //
        public void componentAdded(ContainerEvent evt) {
<span class="nc" id="L1121">            Component c = evt.getChild();</span>

<span class="nc bnc" id="L1123" title="All 2 branches missed.">            if (toolBarFocusListener != null) {</span>
<span class="nc" id="L1124">                c.addFocusListener(toolBarFocusListener);</span>
            }

<span class="nc bnc" id="L1127" title="All 2 branches missed.">            if (isRolloverBorders()) {</span>
<span class="nc" id="L1128">                setBorderToRollover(c);</span>
            } else {
<span class="nc" id="L1130">                setBorderToNonRollover(c);</span>
            }
<span class="nc" id="L1132">        }</span>

        public void componentRemoved(ContainerEvent evt) {
<span class="nc" id="L1135">            Component c = evt.getChild();</span>

<span class="nc bnc" id="L1137" title="All 2 branches missed.">            if (toolBarFocusListener != null) {</span>
<span class="nc" id="L1138">                c.removeFocusListener(toolBarFocusListener);</span>
            }

            // Revert the button border
<span class="nc" id="L1142">            setBorderToNormal(c);</span>
<span class="nc" id="L1143">        }</span>


        //
        // FocusListener
        //
        public void focusGained(FocusEvent evt) {
<span class="nc" id="L1150">            Component c = evt.getComponent();</span>
<span class="nc" id="L1151">            focusedCompIndex = toolBar.getComponentIndex(c);</span>
<span class="nc" id="L1152">        }</span>

<span class="nc" id="L1154">        public void focusLost(FocusEvent evt) { }</span>


        //
        // MouseInputListener (DockingListener)
        //
        JToolBar tb;
<span class="nc" id="L1161">        boolean isDragging = false;</span>
<span class="nc" id="L1162">        Point origin = null;</span>

        public void mousePressed(MouseEvent evt) {
<span class="nc bnc" id="L1165" title="All 2 branches missed.">            if (!tb.isEnabled()) {</span>
<span class="nc" id="L1166">                return;</span>
            }
<span class="nc" id="L1168">            isDragging = false;</span>
<span class="nc" id="L1169">        }</span>

        public void mouseReleased(MouseEvent evt) {
<span class="nc bnc" id="L1172" title="All 2 branches missed.">            if (!tb.isEnabled()) {</span>
<span class="nc" id="L1173">                return;</span>
            }
<span class="nc bnc" id="L1175" title="All 2 branches missed.">            if (isDragging) {</span>
<span class="nc" id="L1176">                Point position = evt.getPoint();</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">                if (origin == null)</span>
<span class="nc" id="L1178">                    origin = evt.getComponent().getLocationOnScreen();</span>
<span class="nc" id="L1179">                floatAt(position, origin);</span>
            }
<span class="nc" id="L1181">            origin = null;</span>
<span class="nc" id="L1182">            isDragging = false;</span>
<span class="nc" id="L1183">        }</span>

        public void mouseDragged(MouseEvent evt) {
<span class="nc bnc" id="L1186" title="All 2 branches missed.">            if (!tb.isEnabled()) {</span>
<span class="nc" id="L1187">                return;</span>
            }
<span class="nc" id="L1189">            isDragging = true;</span>
<span class="nc" id="L1190">            Point position = evt.getPoint();</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">            if (origin == null) {</span>
<span class="nc" id="L1192">                origin = evt.getComponent().getLocationOnScreen();</span>
            }
<span class="nc" id="L1194">            dragTo(position, origin);</span>
<span class="nc" id="L1195">        }</span>

<span class="nc" id="L1197">        public void mouseClicked(MouseEvent evt) {}</span>
<span class="nc" id="L1198">        public void mouseEntered(MouseEvent evt) {}</span>
<span class="nc" id="L1199">        public void mouseExited(MouseEvent evt) {}</span>
<span class="nc" id="L1200">        public void mouseMoved(MouseEvent evt) {}</span>


        //
        // PropertyChangeListener
        //
        public void propertyChange(PropertyChangeEvent evt) {
<span class="nc" id="L1207">            String propertyName = evt.getPropertyName();</span>
<span class="nc bnc" id="L1208" title="All 2 branches missed.">            if (propertyName == &quot;lookAndFeel&quot;) {</span>
<span class="nc" id="L1209">                toolBar.updateUI();</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">            } else if (propertyName == &quot;orientation&quot;) {</span>
                // Search for JSeparator components and change it's orientation
                // to match the toolbar and flip it's orientation.
<span class="nc" id="L1213">                Component[] components = toolBar.getComponents();</span>
<span class="nc" id="L1214">                int orientation = ((Integer)evt.getNewValue()).intValue();</span>
                JToolBar.Separator separator;

<span class="nc bnc" id="L1217" title="All 2 branches missed.">                for (int i = 0; i &lt; components.length; ++i) {</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">                    if (components[i] instanceof JToolBar.Separator) {</span>
<span class="nc" id="L1219">                        separator = (JToolBar.Separator)components[i];</span>
<span class="nc bnc" id="L1220" title="All 2 branches missed.">                        if ((orientation == JToolBar.HORIZONTAL)) {</span>
<span class="nc" id="L1221">                            separator.setOrientation(JSeparator.VERTICAL);</span>
                        } else {
<span class="nc" id="L1223">                            separator.setOrientation(JSeparator.HORIZONTAL);</span>
                        }
<span class="nc" id="L1225">                        Dimension size = separator.getSeparatorSize();</span>
<span class="nc bnc" id="L1226" title="All 4 branches missed.">                        if (size != null &amp;&amp; size.width != size.height) {</span>
                            // Flip the orientation.
<span class="nc" id="L1228">                            Dimension newSize =</span>
                                new Dimension(size.height, size.width);
<span class="nc" id="L1230">                            separator.setSeparatorSize(newSize);</span>
                        }
                    }
                }
<span class="nc bnc" id="L1234" title="All 2 branches missed.">            } else if (propertyName == IS_ROLLOVER) {</span>
<span class="nc" id="L1235">                installNormalBorders(toolBar);</span>
<span class="nc" id="L1236">                setRolloverBorders(((Boolean)evt.getNewValue()).booleanValue());</span>
            }
<span class="nc" id="L1238">        }</span>
    }

<span class="nc" id="L1241">    protected class FrameListener extends WindowAdapter {</span>
        public void windowClosing(WindowEvent w) {
<span class="nc bnc" id="L1243" title="All 2 branches missed.">            if (toolBar.isFloatable()) {</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">                if (dragWindow != null)</span>
<span class="nc" id="L1245">                    dragWindow.setVisible(false);</span>
<span class="nc" id="L1246">                floating = false;</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">                if (floatingToolBar == null)</span>
<span class="nc" id="L1248">                    floatingToolBar = createFloatingWindow(toolBar);</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">                if (floatingToolBar instanceof Window) ((Window)floatingToolBar).setVisible(false);</span>
<span class="nc" id="L1250">                floatingToolBar.getContentPane().remove(toolBar);</span>
<span class="nc" id="L1251">                String constraint = constraintBeforeFloating;</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">                if (toolBar.getOrientation() == JToolBar.HORIZONTAL) {</span>
<span class="nc bnc" id="L1253" title="All 4 branches missed.">                    if (constraint == &quot;West&quot; || constraint == &quot;East&quot;) {</span>
<span class="nc" id="L1254">                        constraint = &quot;North&quot;;</span>
                    }
                } else {
<span class="nc bnc" id="L1257" title="All 4 branches missed.">                    if (constraint == &quot;North&quot; || constraint == &quot;South&quot;) {</span>
<span class="nc" id="L1258">                        constraint = &quot;West&quot;;</span>
                    }
                }
<span class="nc bnc" id="L1261" title="All 2 branches missed.">                if (dockingSource == null)</span>
<span class="nc" id="L1262">                    dockingSource = toolBar.getParent();</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed.">                if (propertyListener != null)</span>
<span class="nc" id="L1264">                    UIManager.removePropertyChangeListener(propertyListener);</span>
<span class="nc" id="L1265">                dockingSource.add(toolBar, constraint);</span>
<span class="nc" id="L1266">                dockingSource.invalidate();</span>
<span class="nc" id="L1267">                Container dockingSourceParent = dockingSource.getParent();</span>
<span class="nc bnc" id="L1268" title="All 2 branches missed.">                if (dockingSourceParent != null)</span>
<span class="nc" id="L1269">                        dockingSourceParent.validate();</span>
<span class="nc" id="L1270">                dockingSource.repaint();</span>
            }
<span class="nc" id="L1272">        }</span>

    }

<span class="nc" id="L1276">    protected class ToolBarContListener implements ContainerListener {</span>
        // NOTE: This class exists only for backward compatibility. All
        // its functionality has been moved into Handler. If you need to add
        // new functionality add it to the Handler, but make sure this
        // class calls into the Handler.
        public void componentAdded( ContainerEvent e )  {
<span class="nc" id="L1282">            getHandler().componentAdded(e);</span>
<span class="nc" id="L1283">        }</span>

        public void componentRemoved( ContainerEvent e ) {
<span class="nc" id="L1286">            getHandler().componentRemoved(e);</span>
<span class="nc" id="L1287">        }</span>

    }

<span class="nc" id="L1291">    protected class ToolBarFocusListener implements FocusListener {</span>
        // NOTE: This class exists only for backward compatibility. All
        // its functionality has been moved into Handler. If you need to add
        // new functionality add it to the Handler, but make sure this
        // class calls into the Handler.
        public void focusGained( FocusEvent e ) {
<span class="nc" id="L1297">            getHandler().focusGained(e);</span>
<span class="nc" id="L1298">            }</span>

        public void focusLost( FocusEvent e ) {
<span class="nc" id="L1301">            getHandler().focusLost(e);</span>
<span class="nc" id="L1302">            }</span>
    }

<span class="nc" id="L1305">    protected class PropertyListener implements PropertyChangeListener {</span>
        // NOTE: This class exists only for backward compatibility. All
        // its functionality has been moved into Handler. If you need to add
        // new functionality add it to the Handler, but make sure this
        // class calls into the Handler.
        public void propertyChange( PropertyChangeEvent e ) {
<span class="nc" id="L1311">            getHandler().propertyChange(e);</span>
<span class="nc" id="L1312">            }</span>
    }

    /**
     * This class should be treated as a &amp;quot;protected&amp;quot; inner class.
     * Instantiate it only within subclasses of BasicToolBarUI.
     */
    public class DockingListener implements MouseInputListener {
        // NOTE: This class exists only for backward compatibility. All
        // its functionality has been moved into Handler. If you need to add
        // new functionality add it to the Handler, but make sure this
        // class calls into the Handler.
        protected JToolBar toolBar;
<span class="nc" id="L1325">        protected boolean isDragging = false;</span>
<span class="nc" id="L1326">        protected Point origin = null;</span>

<span class="nc" id="L1328">        public DockingListener(JToolBar t) {</span>
<span class="nc" id="L1329">            this.toolBar = t;</span>
<span class="nc" id="L1330">            getHandler().tb = t;</span>
<span class="nc" id="L1331">        }</span>

        public void mouseClicked(MouseEvent e) {
<span class="nc" id="L1334">        getHandler().mouseClicked(e);</span>
<span class="nc" id="L1335">    }</span>

        public void mousePressed(MouseEvent e) {
<span class="nc" id="L1338">        getHandler().tb = toolBar;</span>
<span class="nc" id="L1339">        getHandler().mousePressed(e);</span>
<span class="nc" id="L1340">        isDragging = getHandler().isDragging;</span>
<span class="nc" id="L1341">        }</span>

        public void mouseReleased(MouseEvent e) {
<span class="nc" id="L1344">        getHandler().tb = toolBar;</span>
<span class="nc" id="L1345">        getHandler().isDragging = isDragging;</span>
<span class="nc" id="L1346">        getHandler().origin = origin;</span>
<span class="nc" id="L1347">        getHandler().mouseReleased(e);</span>
<span class="nc" id="L1348">        isDragging = getHandler().isDragging;</span>
<span class="nc" id="L1349">        origin = getHandler().origin;</span>
<span class="nc" id="L1350">        }</span>

        public void mouseEntered(MouseEvent e) {
<span class="nc" id="L1353">        getHandler().mouseEntered(e);</span>
<span class="nc" id="L1354">    }</span>

        public void mouseExited(MouseEvent e) {
<span class="nc" id="L1357">        getHandler().mouseExited(e);</span>
<span class="nc" id="L1358">    }</span>

        public void mouseDragged(MouseEvent e) {
<span class="nc" id="L1361">        getHandler().tb = toolBar;</span>
<span class="nc" id="L1362">        getHandler().origin = origin;</span>
<span class="nc" id="L1363">        getHandler().mouseDragged(e);</span>
<span class="nc" id="L1364">        isDragging = getHandler().isDragging;</span>
<span class="nc" id="L1365">        origin = getHandler().origin;</span>
<span class="nc" id="L1366">        }</span>

        public void mouseMoved(MouseEvent e) {
<span class="nc" id="L1369">        getHandler().mouseMoved(e);</span>
<span class="nc" id="L1370">        }</span>
    }

<span class="nc" id="L1373">    protected class DragWindow extends Window</span>
    {
<span class="nc" id="L1375">        Color borderColor = Color.gray;</span>
<span class="nc" id="L1376">        int orientation = toolBar.getOrientation();</span>
        Point offset; // offset of the mouse cursor inside the DragWindow

<span class="nc" id="L1379">        DragWindow(Window w) {</span>
<span class="nc" id="L1380">            super(w);</span>
<span class="nc" id="L1381">        }</span>

    /**
     * Returns the orientation of the toolbar window when the toolbar is
     * floating. The orientation is either one of &lt;code&gt;JToolBar.HORIZONTAL&lt;/code&gt;
     * or &lt;code&gt;JToolBar.VERTICAL&lt;/code&gt;.
     *
     * @return the orientation of the toolbar window
     * @since 1.6
     */
    public int getOrientation() {
<span class="nc" id="L1392">        return orientation;</span>
    }

        public void setOrientation(int o) {
<span class="nc bnc" id="L1396" title="All 2 branches missed.">            if(isShowing()) {</span>
<span class="nc bnc" id="L1397" title="All 2 branches missed.">                if (o == this.orientation)</span>
<span class="nc" id="L1398">                    return;</span>
<span class="nc" id="L1399">                this.orientation = o;</span>
<span class="nc" id="L1400">                Dimension size = getSize();</span>
<span class="nc" id="L1401">                setSize(new Dimension(size.height, size.width));</span>
<span class="nc bnc" id="L1402" title="All 2 branches missed.">                if (offset!=null) {</span>
<span class="nc bnc" id="L1403" title="All 2 branches missed.">                    if( BasicGraphicsUtils.isLeftToRight(toolBar) ) {</span>
<span class="nc" id="L1404">                        setOffset(new Point(offset.y, offset.x));</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">                    } else if( o == JToolBar.HORIZONTAL ) {</span>
<span class="nc" id="L1406">                        setOffset(new Point( size.height-offset.y, offset.x));</span>
                    } else {
<span class="nc" id="L1408">                        setOffset(new Point(offset.y, size.width-offset.x));</span>
                    }
                }
<span class="nc" id="L1411">                repaint();</span>
            }
<span class="nc" id="L1413">        }</span>

        public Point getOffset() {
<span class="nc" id="L1416">            return offset;</span>
        }

        public void setOffset(Point p) {
<span class="nc" id="L1420">            this.offset = p;</span>
<span class="nc" id="L1421">        }</span>

        public void setBorderColor(Color c) {
<span class="nc bnc" id="L1424" title="All 2 branches missed.">            if (this.borderColor == c)</span>
<span class="nc" id="L1425">                return;</span>
<span class="nc" id="L1426">            this.borderColor = c;</span>
<span class="nc" id="L1427">            repaint();</span>
<span class="nc" id="L1428">        }</span>

        public Color getBorderColor() {
<span class="nc" id="L1431">            return this.borderColor;</span>
        }

        public void paint(Graphics g) {
<span class="nc" id="L1435">            paintDragWindow(g);</span>
            // Paint the children
<span class="nc" id="L1437">            super.paint(g);</span>
<span class="nc" id="L1438">        }</span>
        public Insets getInsets() {
<span class="nc" id="L1440">            return new Insets(1,1,1,1);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>