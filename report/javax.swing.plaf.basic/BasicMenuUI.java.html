<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BasicMenuUI.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">javax.swing.plaf.basic</a> &gt; <span class="el_source">BasicMenuUI.java</span></div><h1>BasicMenuUI.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.swing.plaf.basic;

import sun.swing.DefaultLookup;
import sun.swing.UIAction;
import java.awt.*;
import java.awt.event.*;
import java.beans.*;
import javax.swing.*;
import javax.swing.event.*;
import javax.swing.plaf.*;
import javax.swing.border.*;
import java.util.Arrays;
import java.util.ArrayList;


/**
 * A default L&amp;amp;F implementation of MenuUI.  This implementation
 * is a &quot;combined&quot; view/controller.
 *
 * @author Georges Saab
 * @author David Karlton
 * @author Arnaud Weber
 */
<span class="nc" id="L49">public class BasicMenuUI extends BasicMenuItemUI</span>
{
    protected ChangeListener         changeListener;
    protected MenuListener           menuListener;

<span class="nc" id="L54">    private int lastMnemonic = 0;</span>

    /** Uses as the parent of the windowInputMap when selected. */
    private InputMap selectedWindowInputMap;

    /* diagnostic aids -- should be false for production builds. */
    private static final boolean TRACE =   false; // trace creates and disposes
    private static final boolean VERBOSE = false; // show reuse hits/misses
    private static final boolean DEBUG =   false;  // show bad params, misc.

<span class="nc" id="L64">    private static boolean crossMenuMnemonic = true;</span>

    public static ComponentUI createUI(JComponent x) {
<span class="nc" id="L67">        return new BasicMenuUI();</span>
    }

    static void loadActionMap(LazyActionMap map) {
<span class="nc" id="L71">        BasicMenuItemUI.loadActionMap(map);</span>
<span class="nc" id="L72">        map.put(new Actions(Actions.SELECT, null, true));</span>
<span class="nc" id="L73">    }</span>


    protected void installDefaults() {
<span class="nc" id="L77">        super.installDefaults();</span>
<span class="nc" id="L78">        updateDefaultBackgroundColor();</span>
<span class="nc" id="L79">        ((JMenu)menuItem).setDelay(200);</span>
<span class="nc" id="L80">        crossMenuMnemonic = UIManager.getBoolean(&quot;Menu.crossMenuMnemonic&quot;);</span>
<span class="nc" id="L81">    }</span>

    protected String getPropertyPrefix() {
<span class="nc" id="L84">        return &quot;Menu&quot;;</span>
    }

    protected void installListeners() {
<span class="nc" id="L88">        super.installListeners();</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (changeListener == null)</span>
<span class="nc" id="L91">            changeListener = createChangeListener(menuItem);</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (changeListener != null)</span>
<span class="nc" id="L94">            menuItem.addChangeListener(changeListener);</span>

<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (menuListener == null)</span>
<span class="nc" id="L97">            menuListener = createMenuListener(menuItem);</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (menuListener != null)</span>
<span class="nc" id="L100">            ((JMenu)menuItem).addMenuListener(menuListener);</span>
<span class="nc" id="L101">    }</span>

    protected void installKeyboardActions() {
<span class="nc" id="L104">        super.installKeyboardActions();</span>
<span class="nc" id="L105">        updateMnemonicBinding();</span>
<span class="nc" id="L106">    }</span>

    void installLazyActionMap() {
<span class="nc" id="L109">        LazyActionMap.installLazyActionMap(menuItem, BasicMenuUI.class,</span>
<span class="nc" id="L110">                                           getPropertyPrefix() + &quot;.actionMap&quot;);</span>
<span class="nc" id="L111">    }</span>

    void updateMnemonicBinding() {
<span class="nc" id="L114">        int mnemonic = menuItem.getModel().getMnemonic();</span>
<span class="nc" id="L115">        int[] shortcutKeys = (int[])DefaultLookup.get(menuItem, this,</span>
                                                   &quot;Menu.shortcutKeys&quot;);
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (shortcutKeys == null) {</span>
<span class="nc" id="L118">            shortcutKeys = new int[] {KeyEvent.ALT_MASK};</span>
        }
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (mnemonic == lastMnemonic) {</span>
<span class="nc" id="L121">            return;</span>
        }
<span class="nc" id="L123">        InputMap windowInputMap = SwingUtilities.getUIInputMap(</span>
                       menuItem, JComponent.WHEN_IN_FOCUSED_WINDOW);
<span class="nc bnc" id="L125" title="All 4 branches missed.">        if (lastMnemonic != 0 &amp;&amp; windowInputMap != null) {</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            for (int shortcutKey : shortcutKeys) {</span>
<span class="nc" id="L127">                windowInputMap.remove(KeyStroke.getKeyStroke</span>
<span class="nc" id="L128">                        (lastMnemonic, shortcutKey, false));</span>
            }
        }
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (mnemonic != 0) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            if (windowInputMap == null) {</span>
<span class="nc" id="L133">                windowInputMap = createInputMap(JComponent.</span>
                                              WHEN_IN_FOCUSED_WINDOW);
<span class="nc" id="L135">                SwingUtilities.replaceUIInputMap(menuItem, JComponent.</span>
                                       WHEN_IN_FOCUSED_WINDOW, windowInputMap);
            }
<span class="nc bnc" id="L138" title="All 2 branches missed.">            for (int shortcutKey : shortcutKeys) {</span>
<span class="nc" id="L139">                windowInputMap.put(KeyStroke.getKeyStroke(mnemonic,</span>
                        shortcutKey, false), &quot;selectMenu&quot;);
            }
        }
<span class="nc" id="L143">        lastMnemonic = mnemonic;</span>
<span class="nc" id="L144">    }</span>

    protected void uninstallKeyboardActions() {
<span class="nc" id="L147">        super.uninstallKeyboardActions();</span>
<span class="nc" id="L148">        lastMnemonic = 0;</span>
<span class="nc" id="L149">    }</span>

    protected MouseInputListener createMouseInputListener(JComponent c) {
<span class="nc" id="L152">        return getHandler();</span>
    }

    protected MenuListener createMenuListener(JComponent c) {
<span class="nc" id="L156">        return null;</span>
    }

    protected ChangeListener createChangeListener(JComponent c) {
<span class="nc" id="L160">        return null;</span>
    }

    protected PropertyChangeListener createPropertyChangeListener(JComponent c) {
<span class="nc" id="L164">        return getHandler();</span>
    }

    BasicMenuItemUI.Handler getHandler() {
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (handler == null) {</span>
<span class="nc" id="L169">            handler = new Handler();</span>
        }
<span class="nc" id="L171">        return handler;</span>
    }

    protected void uninstallDefaults() {
<span class="nc" id="L175">        menuItem.setArmed(false);</span>
<span class="nc" id="L176">        menuItem.setSelected(false);</span>
<span class="nc" id="L177">        menuItem.resetKeyboardActions();</span>
<span class="nc" id="L178">        super.uninstallDefaults();</span>
<span class="nc" id="L179">    }</span>

    protected void uninstallListeners() {
<span class="nc" id="L182">        super.uninstallListeners();</span>

<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (changeListener != null)</span>
<span class="nc" id="L185">            menuItem.removeChangeListener(changeListener);</span>

<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (menuListener != null)</span>
<span class="nc" id="L188">            ((JMenu)menuItem).removeMenuListener(menuListener);</span>

<span class="nc" id="L190">        changeListener = null;</span>
<span class="nc" id="L191">        menuListener = null;</span>
<span class="nc" id="L192">        handler = null;</span>
<span class="nc" id="L193">    }</span>

    protected MenuDragMouseListener createMenuDragMouseListener(JComponent c) {
<span class="nc" id="L196">        return getHandler();</span>
    }

    protected MenuKeyListener createMenuKeyListener(JComponent c) {
<span class="nc" id="L200">        return (MenuKeyListener)getHandler();</span>
    }

    public Dimension getMaximumSize(JComponent c) {
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (((JMenu)menuItem).isTopLevelMenu() == true) {</span>
<span class="nc" id="L205">            Dimension d = c.getPreferredSize();</span>
<span class="nc" id="L206">            return new Dimension(d.width, Short.MAX_VALUE);</span>
        }
<span class="nc" id="L208">        return null;</span>
    }

    protected void setupPostTimer(JMenu menu) {
<span class="nc" id="L212">        Timer timer = new Timer(menu.getDelay(), new Actions(</span>
                                    Actions.SELECT, menu,false));
<span class="nc" id="L214">        timer.setRepeats(false);</span>
<span class="nc" id="L215">        timer.start();</span>
<span class="nc" id="L216">    }</span>

    private static void appendPath(MenuElement[] path, MenuElement elem) {
<span class="nc" id="L219">        MenuElement newPath[] = new MenuElement[path.length+1];</span>
<span class="nc" id="L220">        System.arraycopy(path, 0, newPath, 0, path.length);</span>
<span class="nc" id="L221">        newPath[path.length] = elem;</span>
<span class="nc" id="L222">        MenuSelectionManager.defaultManager().setSelectedPath(newPath);</span>
<span class="nc" id="L223">    }</span>

    private static class Actions extends UIAction {
        private static final String SELECT = &quot;selectMenu&quot;;

        // NOTE: This will be null if the action is registered in the
        // ActionMap. For the timer use it will be non-null.
        private JMenu menu;
<span class="nc" id="L231">        private boolean force=false;</span>

        Actions(String key, JMenu menu, boolean shouldForce) {
<span class="nc" id="L234">            super(key);</span>
<span class="nc" id="L235">            this.menu = menu;</span>
<span class="nc" id="L236">            this.force = shouldForce;</span>
<span class="nc" id="L237">        }</span>

        private JMenu getMenu(ActionEvent e) {
<span class="nc bnc" id="L240" title="All 2 branches missed.">            if (e.getSource() instanceof JMenu) {</span>
<span class="nc" id="L241">                return (JMenu)e.getSource();</span>
            }
<span class="nc" id="L243">            return menu;</span>
        }

        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L247">            JMenu menu = getMenu(e);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (!crossMenuMnemonic) {</span>
<span class="nc" id="L249">                JPopupMenu pm = BasicPopupMenuUI.getLastPopup();</span>
<span class="nc bnc" id="L250" title="All 4 branches missed.">                if (pm != null &amp;&amp; pm != menu.getParent()) {</span>
<span class="nc" id="L251">                    return;</span>
                }
            }

<span class="nc" id="L255">            final MenuSelectionManager defaultManager = MenuSelectionManager.defaultManager();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if(force) {</span>
<span class="nc" id="L257">                Container cnt = menu.getParent();</span>
<span class="nc bnc" id="L258" title="All 4 branches missed.">                if(cnt != null &amp;&amp; cnt instanceof JMenuBar) {</span>
                    MenuElement me[];
                    MenuElement subElements[];

<span class="nc" id="L262">                    subElements = menu.getPopupMenu().getSubElements();</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                    if(subElements.length &gt; 0) {</span>
<span class="nc" id="L264">                        me = new MenuElement[4];</span>
<span class="nc" id="L265">                        me[0] = (MenuElement) cnt;</span>
<span class="nc" id="L266">                        me[1] = menu;</span>
<span class="nc" id="L267">                        me[2] = menu.getPopupMenu();</span>
<span class="nc" id="L268">                        me[3] = subElements[0];</span>
                    } else {
<span class="nc" id="L270">                        me = new MenuElement[3];</span>
<span class="nc" id="L271">                        me[0] = (MenuElement)cnt;</span>
<span class="nc" id="L272">                        me[1] = menu;</span>
<span class="nc" id="L273">                        me[2] = menu.getPopupMenu();</span>
                    }
<span class="nc" id="L275">                    defaultManager.setSelectedPath(me);</span>
                }
<span class="nc" id="L277">            } else {</span>
<span class="nc" id="L278">                MenuElement path[] = defaultManager.getSelectedPath();</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">                if(path.length &gt; 0 &amp;&amp; path[path.length-1] == menu) {</span>
<span class="nc" id="L280">                    appendPath(path, menu.getPopupMenu());</span>
                }
            }
<span class="nc" id="L283">        }</span>

        public boolean isEnabled(Object c) {
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (c instanceof JMenu) {</span>
<span class="nc" id="L287">                return ((JMenu)c).isEnabled();</span>
            }
<span class="nc" id="L289">            return true;</span>
        }
    }

    /*
     * Set the background color depending on whether this is a toplevel menu
     * in a menubar or a submenu of another menu.
     */
    private void updateDefaultBackgroundColor() {
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (!UIManager.getBoolean(&quot;Menu.useMenuBarBackgroundForTopLevel&quot;)) {</span>
<span class="nc" id="L299">           return;</span>
        }
<span class="nc" id="L301">        JMenu menu = (JMenu)menuItem;</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (menu.getBackground() instanceof UIResource) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if (menu.isTopLevelMenu()) {</span>
<span class="nc" id="L304">                menu.setBackground(UIManager.getColor(&quot;MenuBar.background&quot;));</span>
            } else {
<span class="nc" id="L306">                menu.setBackground(UIManager.getColor(getPropertyPrefix() + &quot;.background&quot;));</span>
            }
        }
<span class="nc" id="L309">    }</span>

    /**
     * Instantiated and used by a menu item to handle the current menu selection
     * from mouse events. A MouseInputHandler processes and forwards all mouse events
     * to a shared instance of the MenuSelectionManager.
     * &lt;p&gt;
     * This class is protected so that it can be subclassed by other look and
     * feels to implement their own mouse handling behavior. All overridden
     * methods should call the parent methods so that the menu selection
     * is correct.
     *
     * @see javax.swing.MenuSelectionManager
     * @since 1.4
     */
<span class="nc" id="L324">    protected class MouseInputHandler implements MouseInputListener {</span>
        // NOTE: This class exists only for backward compatibility. All
        // its functionality has been moved into Handler. If you need to add
        // new functionality add it to the Handler, but make sure this
        // class calls into the Handler.

        public void mouseClicked(MouseEvent e) {
<span class="nc" id="L331">            getHandler().mouseClicked(e);</span>
<span class="nc" id="L332">        }</span>

        /**
         * Invoked when the mouse has been clicked on the menu. This
         * method clears or sets the selection path of the
         * MenuSelectionManager.
         *
         * @param e the mouse event
         */
        public void mousePressed(MouseEvent e) {
<span class="nc" id="L342">            getHandler().mousePressed(e);</span>
<span class="nc" id="L343">        }</span>

        /**
         * Invoked when the mouse has been released on the menu. Delegates the
         * mouse event to the MenuSelectionManager.
         *
         * @param e the mouse event
         */
        public void mouseReleased(MouseEvent e) {
<span class="nc" id="L352">            getHandler().mouseReleased(e);</span>
<span class="nc" id="L353">        }</span>

        /**
         * Invoked when the cursor enters the menu. This method sets the selected
         * path for the MenuSelectionManager and handles the case
         * in which a menu item is used to pop up an additional menu, as in a
         * hierarchical menu system.
         *
         * @param e the mouse event; not used
         */
        public void mouseEntered(MouseEvent e) {
<span class="nc" id="L364">            getHandler().mouseEntered(e);</span>
<span class="nc" id="L365">        }</span>
        public void mouseExited(MouseEvent e) {
<span class="nc" id="L367">            getHandler().mouseExited(e);</span>
<span class="nc" id="L368">        }</span>

        /**
         * Invoked when a mouse button is pressed on the menu and then dragged.
         * Delegates the mouse event to the MenuSelectionManager.
         *
         * @param e the mouse event
         * @see java.awt.event.MouseMotionListener#mouseDragged
         */
        public void mouseDragged(MouseEvent e) {
<span class="nc" id="L378">            getHandler().mouseDragged(e);</span>
<span class="nc" id="L379">        }</span>

        public void mouseMoved(MouseEvent e) {
<span class="nc" id="L382">            getHandler().mouseMoved(e);</span>
<span class="nc" id="L383">        }</span>
    }

    /**
     * As of Java 2 platform 1.4, this previously undocumented class
     * is now obsolete. KeyBindings are now managed by the popup menu.
     */
    public class ChangeHandler implements ChangeListener {
        public JMenu    menu;
        public BasicMenuUI ui;
<span class="nc" id="L393">        public boolean  isSelected = false;</span>
        public Component wasFocused;

<span class="nc" id="L396">        public ChangeHandler(JMenu m, BasicMenuUI ui) {</span>
<span class="nc" id="L397">            menu = m;</span>
<span class="nc" id="L398">            this.ui = ui;</span>
<span class="nc" id="L399">        }</span>

<span class="nc" id="L401">        public void stateChanged(ChangeEvent e) { }</span>
    }

<span class="nc" id="L404">    private class Handler extends BasicMenuItemUI.Handler implements MenuKeyListener {</span>
        //
        // PropertyChangeListener
        //
        public void propertyChange(PropertyChangeEvent e) {
<span class="nc bnc" id="L409" title="All 2 branches missed.">            if (e.getPropertyName() == AbstractButton.</span>
                             MNEMONIC_CHANGED_PROPERTY) {
<span class="nc" id="L411">                updateMnemonicBinding();</span>
            }
            else {
<span class="nc bnc" id="L414" title="All 2 branches missed.">                if (e.getPropertyName().equals(&quot;ancestor&quot;)) {</span>
<span class="nc" id="L415">                    updateDefaultBackgroundColor();</span>
                }
<span class="nc" id="L417">                super.propertyChange(e);</span>
            }
<span class="nc" id="L419">        }</span>

        //
        // MouseInputListener
        //
        public void mouseClicked(MouseEvent e) {
<span class="nc" id="L425">        }</span>

        /**
         * Invoked when the mouse has been clicked on the menu. This
         * method clears or sets the selection path of the
         * MenuSelectionManager.
         *
         * @param e the mouse event
         */
        public void mousePressed(MouseEvent e) {
<span class="nc" id="L435">            JMenu menu = (JMenu)menuItem;</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">            if (!menu.isEnabled())</span>
<span class="nc" id="L437">                return;</span>

            MenuSelectionManager manager =
<span class="nc" id="L440">                MenuSelectionManager.defaultManager();</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            if(menu.isTopLevelMenu()) {</span>
<span class="nc bnc" id="L442" title="All 4 branches missed.">                if(menu.isSelected() &amp;&amp; menu.getPopupMenu().isShowing()) {</span>
<span class="nc" id="L443">                    manager.clearSelectedPath();</span>
                } else {
<span class="nc" id="L445">                    Container cnt = menu.getParent();</span>
<span class="nc bnc" id="L446" title="All 4 branches missed.">                    if(cnt != null &amp;&amp; cnt instanceof JMenuBar) {</span>
<span class="nc" id="L447">                        MenuElement me[] = new MenuElement[2];</span>
<span class="nc" id="L448">                        me[0]=(MenuElement)cnt;</span>
<span class="nc" id="L449">                        me[1]=menu;</span>
<span class="nc" id="L450">                        manager.setSelectedPath(me);</span>
                    }
                }
            }

<span class="nc" id="L455">            MenuElement selectedPath[] = manager.getSelectedPath();</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">            if (selectedPath.length &gt; 0 &amp;&amp;</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">                selectedPath[selectedPath.length-1] != menu.getPopupMenu()) {</span>

<span class="nc bnc" id="L459" title="All 2 branches missed.">                if(menu.isTopLevelMenu() ||</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                   menu.getDelay() == 0) {</span>
<span class="nc" id="L461">                    appendPath(selectedPath, menu.getPopupMenu());</span>
                } else {
<span class="nc" id="L463">                    setupPostTimer(menu);</span>
                }
            }
<span class="nc" id="L466">        }</span>

        /**
         * Invoked when the mouse has been released on the menu. Delegates the
         * mouse event to the MenuSelectionManager.
         *
         * @param e the mouse event
         */
        public void mouseReleased(MouseEvent e) {
<span class="nc" id="L475">            JMenu menu = (JMenu)menuItem;</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">            if (!menu.isEnabled())</span>
<span class="nc" id="L477">                return;</span>
            MenuSelectionManager manager =
<span class="nc" id="L479">                MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L480">            manager.processMouseEvent(e);</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">            if (!e.isConsumed())</span>
<span class="nc" id="L482">                manager.clearSelectedPath();</span>
<span class="nc" id="L483">        }</span>

        /**
         * Invoked when the cursor enters the menu. This method sets the selected
         * path for the MenuSelectionManager and handles the case
         * in which a menu item is used to pop up an additional menu, as in a
         * hierarchical menu system.
         *
         * @param e the mouse event; not used
         */
        public void mouseEntered(MouseEvent e) {
<span class="nc" id="L494">            JMenu menu = (JMenu)menuItem;</span>
            // only disable the menu highlighting if it's disabled and the property isn't
            // true. This allows disabled rollovers to work in WinL&amp;F
<span class="nc bnc" id="L497" title="All 4 branches missed.">            if (!menu.isEnabled() &amp;&amp; !UIManager.getBoolean(&quot;MenuItem.disabledAreNavigable&quot;)) {</span>
<span class="nc" id="L498">                return;</span>
            }

            MenuSelectionManager manager =
<span class="nc" id="L502">                MenuSelectionManager.defaultManager();</span>
<span class="nc" id="L503">            MenuElement selectedPath[] = manager.getSelectedPath();</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">            if (!menu.isTopLevelMenu()) {</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                if(!(selectedPath.length &gt; 0 &amp;&amp;</span>
                     selectedPath[selectedPath.length-1] ==
<span class="nc bnc" id="L507" title="All 2 branches missed.">                     menu.getPopupMenu())) {</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                    if(menu.getDelay() == 0) {</span>
<span class="nc" id="L509">                        appendPath(getPath(), menu.getPopupMenu());</span>
                    } else {
<span class="nc" id="L511">                        manager.setSelectedPath(getPath());</span>
<span class="nc" id="L512">                        setupPostTimer(menu);</span>
                    }
                }
            } else {
<span class="nc bnc" id="L516" title="All 2 branches missed.">                if(selectedPath.length &gt; 0 &amp;&amp;</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">                   selectedPath[0] == menu.getParent()) {</span>
<span class="nc" id="L518">                    MenuElement newPath[] = new MenuElement[3];</span>
                    // A top level menu's parent is by definition
                    // a JMenuBar
<span class="nc" id="L521">                    newPath[0] = (MenuElement)menu.getParent();</span>
<span class="nc" id="L522">                    newPath[1] = menu;</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">                    if (BasicPopupMenuUI.getLastPopup() != null) {</span>
<span class="nc" id="L524">                        newPath[2] = menu.getPopupMenu();</span>
                    }
<span class="nc" id="L526">                    manager.setSelectedPath(newPath);</span>
                }
            }
<span class="nc" id="L529">        }</span>
        public void mouseExited(MouseEvent e) {
<span class="nc" id="L531">        }</span>

        /**
         * Invoked when a mouse button is pressed on the menu and then dragged.
         * Delegates the mouse event to the MenuSelectionManager.
         *
         * @param e the mouse event
         * @see java.awt.event.MouseMotionListener#mouseDragged
         */
        public void mouseDragged(MouseEvent e) {
<span class="nc" id="L541">            JMenu menu = (JMenu)menuItem;</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">            if (!menu.isEnabled())</span>
<span class="nc" id="L543">                return;</span>
<span class="nc" id="L544">            MenuSelectionManager.defaultManager().processMouseEvent(e);</span>
<span class="nc" id="L545">        }</span>
        public void mouseMoved(MouseEvent e) {
<span class="nc" id="L547">        }</span>


        //
        // MenuDragHandler
        //
<span class="nc" id="L553">        public void menuDragMouseEntered(MenuDragMouseEvent e) {}</span>
        public void menuDragMouseDragged(MenuDragMouseEvent e) {
<span class="nc bnc" id="L555" title="All 2 branches missed.">            if (menuItem.isEnabled() == false)</span>
<span class="nc" id="L556">                return;</span>

<span class="nc" id="L558">            MenuSelectionManager manager = e.getMenuSelectionManager();</span>
<span class="nc" id="L559">            MenuElement path[] = e.getPath();</span>

<span class="nc" id="L561">            Point p = e.getPoint();</span>
<span class="nc bnc" id="L562" title="All 6 branches missed.">            if(p.x &gt;= 0 &amp;&amp; p.x &lt; menuItem.getWidth() &amp;&amp;</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">               p.y &gt;= 0 &amp;&amp; p.y &lt; menuItem.getHeight()) {</span>
<span class="nc" id="L564">                JMenu menu = (JMenu)menuItem;</span>
<span class="nc" id="L565">                MenuElement selectedPath[] = manager.getSelectedPath();</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">                if(!(selectedPath.length &gt; 0 &amp;&amp;</span>
                     selectedPath[selectedPath.length-1] ==
<span class="nc bnc" id="L568" title="All 2 branches missed.">                     menu.getPopupMenu())) {</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">                    if(menu.isTopLevelMenu() ||</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                       menu.getDelay() == 0  ||</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">                       e.getID() == MouseEvent.MOUSE_DRAGGED) {</span>
<span class="nc" id="L572">                        appendPath(path, menu.getPopupMenu());</span>
                    } else {
<span class="nc" id="L574">                        manager.setSelectedPath(path);</span>
<span class="nc" id="L575">                        setupPostTimer(menu);</span>
                    }
                }
<span class="nc bnc" id="L578" title="All 2 branches missed.">            } else if(e.getID() == MouseEvent.MOUSE_RELEASED) {</span>
<span class="nc" id="L579">                Component comp = manager.componentForPoint(e.getComponent(), e.getPoint());</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">                if (comp == null)</span>
<span class="nc" id="L581">                    manager.clearSelectedPath();</span>
            }

<span class="nc" id="L584">        }</span>
<span class="nc" id="L585">        public void menuDragMouseExited(MenuDragMouseEvent e) {}</span>
<span class="nc" id="L586">        public void menuDragMouseReleased(MenuDragMouseEvent e) {}</span>

        //
        // MenuKeyListener
        //
        /**
         * Open the Menu
         */
        public void menuKeyTyped(MenuKeyEvent e) {
<span class="nc bnc" id="L595" title="All 4 branches missed.">            if (!crossMenuMnemonic &amp;&amp; BasicPopupMenuUI.getLastPopup() != null) {</span>
                // when crossMenuMnemonic is not set, we don't open a toplevel
                // menu if another toplevel menu is already open
<span class="nc" id="L598">                return;</span>
            }

<span class="nc bnc" id="L601" title="All 2 branches missed.">            if (BasicPopupMenuUI.getPopups().size() != 0) {</span>
                //Fix 6939261: to return in case not on the main menu
                //and has a pop-up.
                //after return code will be handled in BasicPopupMenuUI.java
<span class="nc" id="L605">                return;</span>
            }

<span class="nc" id="L608">            char key = Character.toLowerCase((char)menuItem.getMnemonic());</span>
<span class="nc" id="L609">            MenuElement path[] = e.getPath();</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">            if (key == Character.toLowerCase(e.getKeyChar())) {</span>
<span class="nc" id="L611">                JPopupMenu popupMenu = ((JMenu)menuItem).getPopupMenu();</span>
<span class="nc" id="L612">                ArrayList newList = new ArrayList(Arrays.asList(path));</span>
<span class="nc" id="L613">                newList.add(popupMenu);</span>
<span class="nc" id="L614">                MenuElement subs[] = popupMenu.getSubElements();</span>
<span class="nc" id="L615">                MenuElement sub =</span>
<span class="nc" id="L616">                        BasicPopupMenuUI.findEnabledChild(subs, -1, true);</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                if(sub != null) {</span>
<span class="nc" id="L618">                    newList.add(sub);</span>
                }
<span class="nc" id="L620">                MenuSelectionManager manager = e.getMenuSelectionManager();</span>
<span class="nc" id="L621">                MenuElement newPath[] = new MenuElement[0];;</span>
<span class="nc" id="L622">                newPath = (MenuElement[]) newList.toArray(newPath);</span>
<span class="nc" id="L623">                manager.setSelectedPath(newPath);</span>
<span class="nc" id="L624">                e.consume();</span>
            }
<span class="nc" id="L626">        }</span>

<span class="nc" id="L628">        public void menuKeyPressed(MenuKeyEvent e) {}</span>
<span class="nc" id="L629">        public void menuKeyReleased(MenuKeyEvent e) {}</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>