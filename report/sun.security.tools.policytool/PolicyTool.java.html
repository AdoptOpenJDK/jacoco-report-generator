<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>PolicyTool.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.security.tools.policytool</a> &gt; <span class="el_source">PolicyTool.java</span></div><h1>PolicyTool.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1997, 2012, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.security.tools.policytool;

import java.io.*;
import java.util.LinkedList;
import java.util.ListIterator;
import java.util.Vector;
import java.util.Enumeration;
import java.net.URL;
import java.net.MalformedURLException;
import java.lang.reflect.*;
import java.text.Collator;
import java.text.MessageFormat;
import sun.security.util.PropertyExpander;
import sun.security.util.PropertyExpander.ExpandException;
import java.awt.Component;
import java.awt.Container;
import java.awt.Dimension;
import java.awt.FileDialog;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.Point;
import java.awt.Toolkit;
import java.awt.Window;
import java.awt.event.*;
import java.security.cert.Certificate;
import java.security.cert.CertificateException;
import java.security.*;
import sun.security.provider.*;
import sun.security.util.PolicyUtil;
import javax.security.auth.x500.X500Principal;
import javax.swing.*;
import javax.swing.border.EmptyBorder;

/**
 * PolicyTool may be used by users and administrators to configure the
 * overall java security policy (currently stored in the policy file).
 * Using PolicyTool administrators may add and remove policies from
 * the policy file. &lt;p&gt;
 *
 * @see java.security.Policy
 * @since   1.2
 */

public class PolicyTool {

    // for i18n
<span class="nc" id="L73">    static final java.util.ResourceBundle rb =</span>
<span class="nc" id="L74">        java.util.ResourceBundle.getBundle(</span>
            &quot;sun.security.tools.policytool.Resources&quot;);
<span class="nc" id="L76">    static final Collator collator = Collator.getInstance();</span>
    static {
        // this is for case insensitive string comparisons
<span class="nc" id="L79">        collator.setStrength(Collator.PRIMARY);</span>

        // Support for Apple menu bar
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (System.getProperty(&quot;apple.laf.useScreenMenuBar&quot;) == null) {</span>
<span class="nc" id="L83">            System.setProperty(&quot;apple.laf.useScreenMenuBar&quot;, &quot;true&quot;);</span>
        }
<span class="nc" id="L85">        System.setProperty(&quot;apple.awt.application.name&quot;, getMessage(&quot;Policy.Tool&quot;));</span>

        // Apply the system L&amp;F if not specified with a system property.
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (System.getProperty(&quot;swing.defaultlaf&quot;) == null) {</span>
            try {
<span class="nc" id="L90">                UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());</span>
<span class="nc" id="L91">            } catch (Exception e) {</span>
                // ignore
<span class="nc" id="L93">            }</span>
        }
    }

    // anyone can add warnings
    Vector&lt;String&gt; warnings;
<span class="nc" id="L99">    boolean newWarning = false;</span>

    // set to true if policy modified.
    // this way upon exit we know if to ask the user to save changes
<span class="nc" id="L103">    boolean modified = false;</span>

    private static final boolean testing = false;
<span class="nc" id="L106">    private static final Class&lt;?&gt;[] TWOPARAMS = { String.class, String.class };</span>
<span class="nc" id="L107">    private static final Class&lt;?&gt;[] ONEPARAMS = { String.class };</span>
<span class="nc" id="L108">    private static final Class&lt;?&gt;[] NOPARAMS  = {};</span>
    /*
     * All of the policy entries are read in from the
     * policy file and stored here.  Updates to the policy entries
     * using addEntry() and removeEntry() are made here.  To ultimately save
     * the policy entries back to the policy file, the SavePolicy button
     * must be clicked.
     **/
<span class="nc" id="L116">    private static String policyFileName = null;</span>
<span class="nc" id="L117">    private Vector&lt;PolicyEntry&gt; policyEntries = null;</span>
<span class="nc" id="L118">    private PolicyParser parser = null;</span>

    /* The public key alias information is stored here.  */
<span class="nc" id="L121">    private KeyStore keyStore = null;</span>
<span class="nc" id="L122">    private String keyStoreName = &quot; &quot;;</span>
<span class="nc" id="L123">    private String keyStoreType = &quot; &quot;;</span>
<span class="nc" id="L124">    private String keyStoreProvider = &quot; &quot;;</span>
<span class="nc" id="L125">    private String keyStorePwdURL = &quot; &quot;;</span>

    /* standard PKCS11 KeyStore type */
    private static final String P11KEYSTORE = &quot;PKCS11&quot;;

    /* reserved word for PKCS11 KeyStores */
    private static final String NONE = &quot;NONE&quot;;

    /**
     * default constructor
     */
<span class="nc" id="L136">    private PolicyTool() {</span>
<span class="nc" id="L137">        policyEntries = new Vector&lt;PolicyEntry&gt;();</span>
<span class="nc" id="L138">        parser = new PolicyParser();</span>
<span class="nc" id="L139">        warnings = new Vector&lt;String&gt;();</span>
<span class="nc" id="L140">    }</span>

    /**
     * get the PolicyFileName
     */
    String getPolicyFileName() {
<span class="nc" id="L146">        return policyFileName;</span>
    }

    /**
     * set the PolicyFileName
     */
    void setPolicyFileName(String policyFileName) {
<span class="nc" id="L153">        PolicyTool.policyFileName = policyFileName;</span>
<span class="nc" id="L154">    }</span>

   /**
    * clear keyStore info
    */
    void clearKeyStoreInfo() {
<span class="nc" id="L160">        this.keyStoreName = null;</span>
<span class="nc" id="L161">        this.keyStoreType = null;</span>
<span class="nc" id="L162">        this.keyStoreProvider = null;</span>
<span class="nc" id="L163">        this.keyStorePwdURL = null;</span>

<span class="nc" id="L165">        this.keyStore = null;</span>
<span class="nc" id="L166">    }</span>

    /**
     * get the keyStore URL name
     */
    String getKeyStoreName() {
<span class="nc" id="L172">        return keyStoreName;</span>
    }

    /**
     * get the keyStore Type
     */
    String getKeyStoreType() {
<span class="nc" id="L179">        return keyStoreType;</span>
    }

    /**
     * get the keyStore Provider
     */
    String getKeyStoreProvider() {
<span class="nc" id="L186">        return keyStoreProvider;</span>
    }

    /**
     * get the keyStore password URL
     */
    String getKeyStorePwdURL() {
<span class="nc" id="L193">        return keyStorePwdURL;</span>
    }

    /**
     * Open and read a policy file
     */
    void openPolicy(String filename) throws FileNotFoundException,
                                        PolicyParser.ParsingException,
                                        KeyStoreException,
                                        CertificateException,
                                        InstantiationException,
                                        MalformedURLException,
                                        IOException,
                                        NoSuchAlgorithmException,
                                        IllegalAccessException,
                                        NoSuchMethodException,
                                        UnrecoverableKeyException,
                                        NoSuchProviderException,
                                        ClassNotFoundException,
                                        PropertyExpander.ExpandException,
                                        InvocationTargetException {

<span class="nc" id="L215">        newWarning = false;</span>

        // start fresh - blow away the current state
<span class="nc" id="L218">        policyEntries = new Vector&lt;PolicyEntry&gt;();</span>
<span class="nc" id="L219">        parser = new PolicyParser();</span>
<span class="nc" id="L220">        warnings = new Vector&lt;String&gt;();</span>
<span class="nc" id="L221">        setPolicyFileName(null);</span>
<span class="nc" id="L222">        clearKeyStoreInfo();</span>

        // see if user is opening a NEW policy file
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (filename == null) {</span>
<span class="nc" id="L226">            modified = false;</span>
<span class="nc" id="L227">            return;</span>
        }

        // Read in the policy entries from the file and
        // populate the parser vector table.  The parser vector
        // table only holds the entries as strings, so it only
        // guarantees that the policies are syntactically
        // correct.
<span class="nc" id="L235">        setPolicyFileName(filename);</span>
<span class="nc" id="L236">        parser.read(new FileReader(filename));</span>

        // open the keystore
<span class="nc" id="L239">        openKeyStore(parser.getKeyStoreUrl(), parser.getKeyStoreType(),</span>
<span class="nc" id="L240">                parser.getKeyStoreProvider(), parser.getStorePassURL());</span>

        // Update the local vector with the same policy entries.
        // This guarantees that the policy entries are not only
        // syntactically correct, but semantically valid as well.
<span class="nc" id="L245">        Enumeration&lt;PolicyParser.GrantEntry&gt; enum_ = parser.grantElements();</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        while (enum_.hasMoreElements()) {</span>
<span class="nc" id="L247">            PolicyParser.GrantEntry ge = enum_.nextElement();</span>

            // see if all the signers have public keys
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (ge.signedBy != null) {</span>

<span class="nc" id="L252">                String signers[] = parseSigners(ge.signedBy);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">                for (int i = 0; i &lt; signers.length; i++) {</span>
<span class="nc" id="L254">                    PublicKey pubKey = getPublicKeyAlias(signers[i]);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                    if (pubKey == null) {</span>
<span class="nc" id="L256">                        newWarning = true;</span>
<span class="nc" id="L257">                        MessageFormat form = new MessageFormat(getMessage</span>
<span class="nc" id="L258">                            (&quot;Warning.A.public.key.for.alias.signers.i.does.not.exist.Make.sure.a.KeyStore.is.properly.configured.&quot;));</span>
<span class="nc" id="L259">                        Object[] source = {signers[i]};</span>
<span class="nc" id="L260">                        warnings.addElement(form.format(source));</span>
                    }
                }
            }

            // check to see if the Principals are valid
<span class="nc" id="L266">            ListIterator&lt;PolicyParser.PrincipalEntry&gt; prinList =</span>
<span class="nc" id="L267">                                                ge.principals.listIterator(0);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            while (prinList.hasNext()) {</span>
<span class="nc" id="L269">                PolicyParser.PrincipalEntry pe = prinList.next();</span>
                try {
<span class="nc" id="L271">                    verifyPrincipal(pe.getPrincipalClass(),</span>
<span class="nc" id="L272">                                pe.getPrincipalName());</span>
<span class="nc" id="L273">                } catch (ClassNotFoundException fnfe) {</span>
<span class="nc" id="L274">                    newWarning = true;</span>
<span class="nc" id="L275">                    MessageFormat form = new MessageFormat(getMessage</span>
<span class="nc" id="L276">                                (&quot;Warning.Class.not.found.class&quot;));</span>
<span class="nc" id="L277">                    Object[] source = {pe.getPrincipalClass()};</span>
<span class="nc" id="L278">                    warnings.addElement(form.format(source));</span>
<span class="nc" id="L279">                }</span>
<span class="nc" id="L280">            }</span>

            // check to see if the Permissions are valid
<span class="nc" id="L283">            Enumeration&lt;PolicyParser.PermissionEntry&gt; perms =</span>
<span class="nc" id="L284">                                                ge.permissionElements();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            while (perms.hasMoreElements()) {</span>
<span class="nc" id="L286">                PolicyParser.PermissionEntry pe = perms.nextElement();</span>
                try {
<span class="nc" id="L288">                    verifyPermission(pe.permission, pe.name, pe.action);</span>
<span class="nc" id="L289">                } catch (ClassNotFoundException fnfe) {</span>
<span class="nc" id="L290">                    newWarning = true;</span>
<span class="nc" id="L291">                    MessageFormat form = new MessageFormat(getMessage</span>
<span class="nc" id="L292">                                (&quot;Warning.Class.not.found.class&quot;));</span>
<span class="nc" id="L293">                    Object[] source = {pe.permission};</span>
<span class="nc" id="L294">                    warnings.addElement(form.format(source));</span>
<span class="nc" id="L295">                } catch (InvocationTargetException ite) {</span>
<span class="nc" id="L296">                    newWarning = true;</span>
<span class="nc" id="L297">                    MessageFormat form = new MessageFormat(getMessage</span>
<span class="nc" id="L298">                        (&quot;Warning.Invalid.argument.s.for.constructor.arg&quot;));</span>
<span class="nc" id="L299">                    Object[] source = {pe.permission};</span>
<span class="nc" id="L300">                    warnings.addElement(form.format(source));</span>
<span class="nc" id="L301">                }</span>

                // see if all the permission signers have public keys
<span class="nc bnc" id="L304" title="All 2 branches missed.">                if (pe.signedBy != null) {</span>

<span class="nc" id="L306">                    String signers[] = parseSigners(pe.signedBy);</span>

<span class="nc bnc" id="L308" title="All 2 branches missed.">                    for (int i = 0; i &lt; signers.length; i++) {</span>
<span class="nc" id="L309">                        PublicKey pubKey = getPublicKeyAlias(signers[i]);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                        if (pubKey == null) {</span>
<span class="nc" id="L311">                            newWarning = true;</span>
<span class="nc" id="L312">                            MessageFormat form = new MessageFormat(getMessage</span>
<span class="nc" id="L313">                                (&quot;Warning.A.public.key.for.alias.signers.i.does.not.exist.Make.sure.a.KeyStore.is.properly.configured.&quot;));</span>
<span class="nc" id="L314">                            Object[] source = {signers[i]};</span>
<span class="nc" id="L315">                            warnings.addElement(form.format(source));</span>
                        }
                    }
                }
<span class="nc" id="L319">            }</span>
<span class="nc" id="L320">            PolicyEntry pEntry = new PolicyEntry(this, ge);</span>
<span class="nc" id="L321">            policyEntries.addElement(pEntry);</span>
<span class="nc" id="L322">        }</span>

        // just read in the policy -- nothing has been modified yet
<span class="nc" id="L325">        modified = false;</span>
<span class="nc" id="L326">    }</span>


    /**
     * Save a policy to a file
     */
    void savePolicy(String filename)
    throws FileNotFoundException, IOException {
        // save the policy entries to a file
<span class="nc" id="L335">        parser.setKeyStoreUrl(keyStoreName);</span>
<span class="nc" id="L336">        parser.setKeyStoreType(keyStoreType);</span>
<span class="nc" id="L337">        parser.setKeyStoreProvider(keyStoreProvider);</span>
<span class="nc" id="L338">        parser.setStorePassURL(keyStorePwdURL);</span>
<span class="nc" id="L339">        parser.write(new FileWriter(filename));</span>
<span class="nc" id="L340">        modified = false;</span>
<span class="nc" id="L341">    }</span>

    /**
     * Open the KeyStore
     */
    void openKeyStore(String name,
                String type,
                String provider,
                String pwdURL) throws   KeyStoreException,
                                        NoSuchAlgorithmException,
                                        UnrecoverableKeyException,
                                        IOException,
                                        CertificateException,
                                        NoSuchProviderException,
                                        ExpandException {

<span class="nc bnc" id="L357" title="All 8 branches missed.">        if (name == null &amp;&amp; type == null &amp;&amp;</span>
            provider == null &amp;&amp; pwdURL == null) {

            // policy did not specify a keystore during open
            // or use wants to reset keystore values

<span class="nc" id="L363">            this.keyStoreName = null;</span>
<span class="nc" id="L364">            this.keyStoreType = null;</span>
<span class="nc" id="L365">            this.keyStoreProvider = null;</span>
<span class="nc" id="L366">            this.keyStorePwdURL = null;</span>

            // caller will set (tool.modified = true) if appropriate

<span class="nc" id="L370">            return;</span>
        }

<span class="nc" id="L373">        URL policyURL = null;</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (policyFileName != null) {</span>
<span class="nc" id="L375">            File pfile = new File(policyFileName);</span>
<span class="nc" id="L376">            policyURL = new URL(&quot;file:&quot; + pfile.getCanonicalPath());</span>
        }

        // although PolicyUtil.getKeyStore may properly handle
        // defaults and property expansion, we do it here so that
        // if the call is successful, we can set the proper values
        // (PolicyUtil.getKeyStore does not return expanded values)

<span class="nc bnc" id="L384" title="All 4 branches missed.">        if (name != null &amp;&amp; name.length() &gt; 0) {</span>
<span class="nc" id="L385">            name = PropertyExpander.expand(name).replace</span>
<span class="nc" id="L386">                                        (File.separatorChar, '/');</span>
        }
<span class="nc bnc" id="L388" title="All 4 branches missed.">        if (type == null || type.length() == 0) {</span>
<span class="nc" id="L389">            type = KeyStore.getDefaultType();</span>
        }
<span class="nc bnc" id="L391" title="All 4 branches missed.">        if (pwdURL != null &amp;&amp; pwdURL.length() &gt; 0) {</span>
<span class="nc" id="L392">            pwdURL = PropertyExpander.expand(pwdURL).replace</span>
<span class="nc" id="L393">                                        (File.separatorChar, '/');</span>
        }

        try {
<span class="nc" id="L397">            this.keyStore = PolicyUtil.getKeyStore(policyURL,</span>
                                                name,
                                                type,
                                                provider,
                                                pwdURL,
                                                null);
<span class="nc" id="L403">        } catch (IOException ioe) {</span>

            // copied from sun.security.pkcs11.SunPKCS11
<span class="nc" id="L406">            String MSG = &quot;no password provided, and no callback handler &quot; +</span>
                        &quot;available for retrieving password&quot;;

<span class="nc" id="L409">            Throwable cause = ioe.getCause();</span>
<span class="nc bnc" id="L410" title="All 4 branches missed.">            if (cause != null &amp;&amp;</span>
                cause instanceof javax.security.auth.login.LoginException &amp;&amp;
<span class="nc bnc" id="L412" title="All 2 branches missed.">                MSG.equals(cause.getMessage())) {</span>

                // throw a more friendly exception message
<span class="nc" id="L415">                throw new IOException(MSG);</span>
            } else {
<span class="nc" id="L417">                throw ioe;</span>
            }
<span class="nc" id="L419">        }</span>

<span class="nc" id="L421">        this.keyStoreName = name;</span>
<span class="nc" id="L422">        this.keyStoreType = type;</span>
<span class="nc" id="L423">        this.keyStoreProvider = provider;</span>
<span class="nc" id="L424">        this.keyStorePwdURL = pwdURL;</span>

        // caller will set (tool.modified = true)
<span class="nc" id="L427">    }</span>

    /**
     * Add a Grant entry to the overall policy at the specified index.
     * A policy entry consists of a CodeSource.
     */
    boolean addEntry(PolicyEntry pe, int index) {

<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (index &lt; 0) {</span>
            // new entry -- just add it to the end
<span class="nc" id="L437">            policyEntries.addElement(pe);</span>
<span class="nc" id="L438">            parser.add(pe.getGrantEntry());</span>
        } else {
            // existing entry -- replace old one
<span class="nc" id="L441">            PolicyEntry origPe = policyEntries.elementAt(index);</span>
<span class="nc" id="L442">            parser.replace(origPe.getGrantEntry(), pe.getGrantEntry());</span>
<span class="nc" id="L443">            policyEntries.setElementAt(pe, index);</span>
        }
<span class="nc" id="L445">        return true;</span>
    }

    /**
     * Add a Principal entry to an existing PolicyEntry at the specified index.
     * A Principal entry consists of a class, and name.
     *
     * If the principal already exists, it is not added again.
     */
    boolean addPrinEntry(PolicyEntry pe,
                        PolicyParser.PrincipalEntry newPrin,
                        int index) {

        // first add the principal to the Policy Parser entry
<span class="nc" id="L459">        PolicyParser.GrantEntry grantEntry = pe.getGrantEntry();</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">        if (grantEntry.contains(newPrin) == true)</span>
<span class="nc" id="L461">            return false;</span>

<span class="nc" id="L463">        LinkedList&lt;PolicyParser.PrincipalEntry&gt; prinList =</span>
                                                grantEntry.principals;
<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (index != -1)</span>
<span class="nc" id="L466">            prinList.set(index, newPrin);</span>
        else
<span class="nc" id="L468">            prinList.add(newPrin);</span>

<span class="nc" id="L470">        modified = true;</span>
<span class="nc" id="L471">        return true;</span>
    }

    /**
     * Add a Permission entry to an existing PolicyEntry at the specified index.
     * A Permission entry consists of a permission, name, and actions.
     *
     * If the permission already exists, it is not added again.
     */
    boolean addPermEntry(PolicyEntry pe,
                        PolicyParser.PermissionEntry newPerm,
                        int index) {

        // first add the permission to the Policy Parser Vector
<span class="nc" id="L485">        PolicyParser.GrantEntry grantEntry = pe.getGrantEntry();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (grantEntry.contains(newPerm) == true)</span>
<span class="nc" id="L487">            return false;</span>

<span class="nc" id="L489">        Vector&lt;PolicyParser.PermissionEntry&gt; permList =</span>
                                                grantEntry.permissionEntries;
<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (index != -1)</span>
<span class="nc" id="L492">            permList.setElementAt(newPerm, index);</span>
        else
<span class="nc" id="L494">            permList.addElement(newPerm);</span>

<span class="nc" id="L496">        modified = true;</span>
<span class="nc" id="L497">        return true;</span>
    }

    /**
     * Remove a Permission entry from an existing PolicyEntry.
     */
    boolean removePermEntry(PolicyEntry pe,
                        PolicyParser.PermissionEntry perm) {

        // remove the Permission from the GrantEntry
<span class="nc" id="L507">        PolicyParser.GrantEntry ppge = pe.getGrantEntry();</span>
<span class="nc" id="L508">        modified = ppge.remove(perm);</span>
<span class="nc" id="L509">        return modified;</span>
    }

    /**
     * remove an entry from the overall policy
     */
    boolean removeEntry(PolicyEntry pe) {

<span class="nc" id="L517">        parser.remove(pe.getGrantEntry());</span>
<span class="nc" id="L518">        modified = true;</span>
<span class="nc" id="L519">        return (policyEntries.removeElement(pe));</span>
    }

    /**
     * retrieve all Policy Entries
     */
    PolicyEntry[] getEntry() {

<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (policyEntries.size() &gt; 0) {</span>
<span class="nc" id="L528">            PolicyEntry entries[] = new PolicyEntry[policyEntries.size()];</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">            for (int i = 0; i &lt; policyEntries.size(); i++)</span>
<span class="nc" id="L530">                entries[i] = policyEntries.elementAt(i);</span>
<span class="nc" id="L531">            return entries;</span>
        }
<span class="nc" id="L533">        return null;</span>
    }

    /**
     * Retrieve the public key mapped to a particular name.
     * If the key has expired, a KeyException is thrown.
     */
    PublicKey getPublicKeyAlias(String name) throws KeyStoreException {
<span class="nc bnc" id="L541" title="All 2 branches missed.">        if (keyStore == null) {</span>
<span class="nc" id="L542">            return null;</span>
        }

<span class="nc" id="L545">        Certificate cert = keyStore.getCertificate(name);</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">        if (cert == null) {</span>
<span class="nc" id="L547">            return null;</span>
        }
<span class="nc" id="L549">        PublicKey pubKey = cert.getPublicKey();</span>
<span class="nc" id="L550">        return pubKey;</span>
    }

    /**
     * Retrieve all the alias names stored in the certificate database
     */
    String[] getPublicKeyAlias() throws KeyStoreException {

<span class="nc" id="L558">        int numAliases = 0;</span>
<span class="nc" id="L559">        String aliases[] = null;</span>

<span class="nc bnc" id="L561" title="All 2 branches missed.">        if (keyStore == null) {</span>
<span class="nc" id="L562">            return null;</span>
        }
<span class="nc" id="L564">        Enumeration&lt;String&gt; enum_ = keyStore.aliases();</span>

        // first count the number of elements
<span class="nc bnc" id="L567" title="All 2 branches missed.">        while (enum_.hasMoreElements()) {</span>
<span class="nc" id="L568">            enum_.nextElement();</span>
<span class="nc" id="L569">            numAliases++;</span>
        }

<span class="nc bnc" id="L572" title="All 2 branches missed.">        if (numAliases &gt; 0) {</span>
            // now copy them into an array
<span class="nc" id="L574">            aliases = new String[numAliases];</span>
<span class="nc" id="L575">            numAliases = 0;</span>
<span class="nc" id="L576">            enum_ = keyStore.aliases();</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">            while (enum_.hasMoreElements()) {</span>
<span class="nc" id="L578">                aliases[numAliases] = new String(enum_.nextElement());</span>
<span class="nc" id="L579">                numAliases++;</span>
            }
        }
<span class="nc" id="L582">        return aliases;</span>
    }

    /**
     * This method parses a single string of signers separated by commas
     * (&quot;jordan, duke, pippen&quot;) into an array of individual strings.
     */
    String[] parseSigners(String signedBy) {

<span class="nc" id="L591">        String signers[] = null;</span>
<span class="nc" id="L592">        int numSigners = 1;</span>
<span class="nc" id="L593">        int signedByIndex = 0;</span>
<span class="nc" id="L594">        int commaIndex = 0;</span>
<span class="nc" id="L595">        int signerNum = 0;</span>

        // first pass thru &quot;signedBy&quot; counts the number of signers
<span class="nc bnc" id="L598" title="All 2 branches missed.">        while (commaIndex &gt;= 0) {</span>
<span class="nc" id="L599">            commaIndex = signedBy.indexOf(',', signedByIndex);</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">            if (commaIndex &gt;= 0) {</span>
<span class="nc" id="L601">                numSigners++;</span>
<span class="nc" id="L602">                signedByIndex = commaIndex + 1;</span>
            }
        }
<span class="nc" id="L605">        signers = new String[numSigners];</span>

        // second pass thru &quot;signedBy&quot; transfers signers to array
<span class="nc" id="L608">        commaIndex = 0;</span>
<span class="nc" id="L609">        signedByIndex = 0;</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">        while (commaIndex &gt;= 0) {</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">            if ((commaIndex = signedBy.indexOf(',', signedByIndex)) &gt;= 0) {</span>
                // transfer signer and ignore trailing part of the string
<span class="nc" id="L613">                signers[signerNum] =</span>
<span class="nc" id="L614">                        signedBy.substring(signedByIndex, commaIndex).trim();</span>
<span class="nc" id="L615">                signerNum++;</span>
<span class="nc" id="L616">                signedByIndex = commaIndex + 1;</span>
            } else {
                // we are at the end of the string -- transfer signer
<span class="nc" id="L619">                signers[signerNum] = signedBy.substring(signedByIndex).trim();</span>
            }
        }
<span class="nc" id="L622">        return signers;</span>
    }

    /**
     * Check to see if the Principal contents are OK
     */
    void verifyPrincipal(String type, String name)
        throws ClassNotFoundException,
               InstantiationException
    {
<span class="nc bnc" id="L632" title="All 2 branches missed.">        if (type.equals(PolicyParser.PrincipalEntry.WILDCARD_CLASS) ||</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">            type.equals(PolicyParser.PrincipalEntry.REPLACE_NAME)) {</span>
<span class="nc" id="L634">            return;</span>
        }
<span class="nc" id="L636">        Class&lt;?&gt; PRIN = Class.forName(&quot;java.security.Principal&quot;);</span>
<span class="nc" id="L637">        Class&lt;?&gt; pc = Class.forName(type, true,</span>
<span class="nc" id="L638">                Thread.currentThread().getContextClassLoader());</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">        if (!PRIN.isAssignableFrom(pc)) {</span>
<span class="nc" id="L640">            MessageFormat form = new MessageFormat(getMessage</span>
<span class="nc" id="L641">                        (&quot;Illegal.Principal.Type.type&quot;));</span>
<span class="nc" id="L642">            Object[] source = {type};</span>
<span class="nc" id="L643">            throw new InstantiationException(form.format(source));</span>
        }

<span class="nc bnc" id="L646" title="All 2 branches missed.">        if (ToolDialog.X500_PRIN_CLASS.equals(pc.getName())) {</span>
            // PolicyParser checks validity of X500Principal name
            // - PolicyTool needs to as well so that it doesn't store
            //   an invalid name that can't be read in later
            //
            // this can throw an IllegalArgumentException
<span class="nc" id="L652">            X500Principal newP = new X500Principal(name);</span>
        }
<span class="nc" id="L654">    }</span>

    /**
     * Check to see if the Permission contents are OK
     */
    @SuppressWarnings(&quot;fallthrough&quot;)
    void verifyPermission(String type,
                                    String name,
                                    String actions)
        throws ClassNotFoundException,
               InstantiationException,
               IllegalAccessException,
               NoSuchMethodException,
               InvocationTargetException
    {

        //XXX we might want to keep a hash of created factories...
<span class="nc" id="L671">        Class&lt;?&gt; pc = Class.forName(type, true,</span>
<span class="nc" id="L672">                Thread.currentThread().getContextClassLoader());</span>
<span class="nc" id="L673">        Constructor&lt;?&gt; c = null;</span>
<span class="nc" id="L674">        Vector&lt;String&gt; objects = new Vector&lt;&gt;(2);</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (name != null) objects.add(name);</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">        if (actions != null) objects.add(actions);</span>
<span class="nc bnc" id="L677" title="All 4 branches missed.">        switch (objects.size()) {</span>
        case 0:
            try {
<span class="nc" id="L680">                c = pc.getConstructor(NOPARAMS);</span>
<span class="nc" id="L681">                break;</span>
<span class="nc" id="L682">            } catch (NoSuchMethodException ex) {</span>
                // proceed to the one-param constructor
<span class="nc" id="L684">                objects.add(null);</span>
            }
            /* fall through */
        case 1:
            try {
<span class="nc" id="L689">                c = pc.getConstructor(ONEPARAMS);</span>
<span class="nc" id="L690">                break;</span>
<span class="nc" id="L691">            } catch (NoSuchMethodException ex) {</span>
                // proceed to the two-param constructor
<span class="nc" id="L693">                objects.add(null);</span>
            }
            /* fall through */
        case 2:
<span class="nc" id="L697">            c = pc.getConstructor(TWOPARAMS);</span>
            break;
        }
<span class="nc" id="L700">        Object parameters[] = objects.toArray();</span>
<span class="nc" id="L701">        Permission p = (Permission)c.newInstance(parameters);</span>
<span class="nc" id="L702">    }</span>

    /*
     * Parse command line arguments.
     */
    static void parseArgs(String args[]) {
        /* parse flags */
<span class="nc" id="L709">        int n = 0;</span>

<span class="nc bnc" id="L711" title="All 4 branches missed.">        for (n=0; (n &lt; args.length) &amp;&amp; args[n].startsWith(&quot;-&quot;); n++) {</span>

<span class="nc" id="L713">            String flags = args[n];</span>

<span class="nc bnc" id="L715" title="All 2 branches missed.">            if (collator.compare(flags, &quot;-file&quot;) == 0) {</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">                if (++n == args.length) usage();</span>
<span class="nc" id="L717">                policyFileName = args[n];</span>
            } else {
<span class="nc" id="L719">                MessageFormat form = new MessageFormat(getMessage</span>
<span class="nc" id="L720">                                (&quot;Illegal.option.option&quot;));</span>
<span class="nc" id="L721">                Object[] source = { flags };</span>
<span class="nc" id="L722">                System.err.println(form.format(source));</span>
<span class="nc" id="L723">                usage();</span>
            }
        }
<span class="nc" id="L726">    }</span>

    static void usage() {
<span class="nc" id="L729">        System.out.println(getMessage(&quot;Usage.policytool.options.&quot;));</span>
<span class="nc" id="L730">        System.out.println();</span>
<span class="nc" id="L731">        System.out.println(getMessage</span>
<span class="nc" id="L732">                (&quot;.file.file.policy.file.location&quot;));</span>
<span class="nc" id="L733">        System.out.println();</span>

<span class="nc" id="L735">        System.exit(1);</span>
<span class="nc" id="L736">    }</span>

    /**
     * run the PolicyTool
     */
    public static void main(String args[]) {
<span class="nc" id="L742">        parseArgs(args);</span>
<span class="nc" id="L743">        SwingUtilities.invokeLater(new Runnable() {</span>
            public void run() {
<span class="nc" id="L745">                ToolWindow tw = new ToolWindow(new PolicyTool());</span>
<span class="nc" id="L746">                tw.displayToolWindow(args);</span>
<span class="nc" id="L747">            }</span>
        });
<span class="nc" id="L749">    }</span>

    // split instr to words according to capitalization,
    // like, AWTControl -&gt; A W T Control
    // this method is for easy pronounciation
    static String splitToWords(String instr) {
<span class="nc" id="L755">        return instr.replaceAll(&quot;([A-Z])&quot;, &quot; $1&quot;);</span>
    }

    /**
     * Returns the message corresponding to the key in the bundle.
     * This is preferred over {@link #getString} because it removes
     * any mnemonic '&amp;' character in the string.
     *
     * @param key the key
     *
     * @return the message
     */
    static String getMessage(String key) {
<span class="nc" id="L768">        return removeMnemonicAmpersand(rb.getString(key));</span>
    }


    /**
     * Returns the mnemonic for a message.
     *
     * @param key the key
     *
     * @return the mnemonic &lt;code&gt;int&lt;/code&gt;
     */
    static int getMnemonicInt(String key) {
<span class="nc" id="L780">        String message = rb.getString(key);</span>
<span class="nc" id="L781">        return (findMnemonicInt(message));</span>
    }

    /**
     * Returns the mnemonic display index for a message.
     *
     * @param key the key
     *
     * @return the mnemonic display index
     */
    static int getDisplayedMnemonicIndex(String key) {
<span class="nc" id="L792">        String message = rb.getString(key);</span>
<span class="nc" id="L793">        return (findMnemonicIndex(message));</span>
    }

    /**
     * Finds the mnemonic character in a message.
     *
     * The mnemonic character is the first character followed by the first
     * &lt;code&gt;&amp;&lt;/code&gt; that is not followed by another &lt;code&gt;&amp;&lt;/code&gt;.
     *
     * @return the mnemonic as an &lt;code&gt;int&lt;/code&gt;, or &lt;code&gt;0&lt;/code&gt; if it
     *         can't be found.
     */
    private static int findMnemonicInt(String s) {
<span class="nc bnc" id="L806" title="All 2 branches missed.">        for (int i = 0; i &lt; s.length() - 1; i++) {</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">            if (s.charAt(i) == '&amp;') {</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">                if (s.charAt(i + 1) != '&amp;') {</span>
<span class="nc" id="L809">                    return KeyEvent.getExtendedKeyCodeForChar(s.charAt(i + 1));</span>
                } else {
<span class="nc" id="L811">                    i++;</span>
                }
            }
        }
<span class="nc" id="L815">        return 0;</span>
    }

    /**
     * Finds the index of the mnemonic character in a message.
     *
     * The mnemonic character is the first character followed by the first
     * &lt;code&gt;&amp;&lt;/code&gt; that is not followed by another &lt;code&gt;&amp;&lt;/code&gt;.
     *
     * @return the mnemonic character index as an &lt;code&gt;int&lt;/code&gt;, or &lt;code&gt;-1&lt;/code&gt; if it
     *         can't be found.
     */
    private static int findMnemonicIndex(String s) {
<span class="nc bnc" id="L828" title="All 2 branches missed.">        for (int i = 0; i &lt; s.length() - 1; i++) {</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">            if (s.charAt(i) == '&amp;') {</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">                if (s.charAt(i + 1) != '&amp;') {</span>
                    // Return the index of the '&amp;' since it will be removed
<span class="nc" id="L832">                    return i;</span>
                } else {
<span class="nc" id="L834">                    i++;</span>
                }
            }
        }
<span class="nc" id="L838">        return -1;</span>
    }

    /**
     * Removes the mnemonic identifier (&lt;code&gt;&amp;&lt;/code&gt;) from a string unless
     * it's escaped by &lt;code&gt;&amp;&amp;&lt;/code&gt; or placed at the end.
     *
     * @param message the message
     *
     * @return a message with the mnemonic identifier removed
     */
    private static String removeMnemonicAmpersand(String message) {
<span class="nc" id="L850">        StringBuilder s = new StringBuilder();</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">        for (int i = 0; i &lt; message.length(); i++) {</span>
<span class="nc" id="L852">            char current = message.charAt(i);</span>
<span class="nc bnc" id="L853" title="All 4 branches missed.">            if (current != '&amp;' || i == message.length() - 1</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">                    || message.charAt(i + 1) == '&amp;') {</span>
<span class="nc" id="L855">                s.append(current);</span>
            }
        }
<span class="nc" id="L858">        return s.toString();</span>
    }
}

/**
 * Each entry in the policy configuration file is represented by a
 * PolicyEntry object.
 *
 * A PolicyEntry is a (CodeSource,Permission) pair.  The
 * CodeSource contains the (URL, PublicKey) that together identify
 * where the Java bytecodes come from and who (if anyone) signed
 * them.  The URL could refer to localhost.  The URL could also be
 * null, meaning that this policy entry is given to all comers, as
 * long as they match the signer field.  The signer could be null,
 * meaning the code is not signed.
 *
 * The Permission contains the (Type, Name, Action) triplet.
 *
 */
class PolicyEntry {

    private CodeSource codesource;
    private PolicyTool tool;
    private PolicyParser.GrantEntry grantEntry;
<span class="nc" id="L882">    private boolean testing = false;</span>

    /**
     * Create a PolicyEntry object from the information read in
     * from a policy file.
     */
    PolicyEntry(PolicyTool tool, PolicyParser.GrantEntry ge)
    throws MalformedURLException, NoSuchMethodException,
    ClassNotFoundException, InstantiationException, IllegalAccessException,
    InvocationTargetException, CertificateException,
<span class="nc" id="L892">    IOException, NoSuchAlgorithmException, UnrecoverableKeyException {</span>

<span class="nc" id="L894">        this.tool = tool;</span>

<span class="nc" id="L896">        URL location = null;</span>

        // construct the CodeSource
<span class="nc bnc" id="L899" title="All 2 branches missed.">        if (ge.codeBase != null)</span>
<span class="nc" id="L900">            location = new URL(ge.codeBase);</span>
<span class="nc" id="L901">        this.codesource = new CodeSource(location,</span>
            (java.security.cert.Certificate[]) null);

<span class="nc bnc" id="L904" title="All 2 branches missed.">        if (testing) {</span>
<span class="nc" id="L905">            System.out.println(&quot;Adding Policy Entry:&quot;);</span>
<span class="nc" id="L906">            System.out.println(&quot;    CodeBase = &quot; + location);</span>
<span class="nc" id="L907">            System.out.println(&quot;    Signers = &quot; + ge.signedBy);</span>
<span class="nc" id="L908">            System.out.println(&quot;    with &quot; + ge.principals.size() +</span>
                    &quot; Principals&quot;);
        }

<span class="nc" id="L912">        this.grantEntry = ge;</span>
<span class="nc" id="L913">    }</span>

    /**
     * get the codesource associated with this PolicyEntry
     */
    CodeSource getCodeSource() {
<span class="nc" id="L919">        return codesource;</span>
    }

    /**
     * get the GrantEntry associated with this PolicyEntry
     */
    PolicyParser.GrantEntry getGrantEntry() {
<span class="nc" id="L926">        return grantEntry;</span>
    }

    /**
     * convert the header portion, i.e. codebase, signer, principals, of
     * this policy entry into a string
     */
    String headerToString() {
<span class="nc" id="L934">        String pString = principalsToString();</span>
<span class="nc bnc" id="L935" title="All 2 branches missed.">        if (pString.length() == 0) {</span>
<span class="nc" id="L936">            return codebaseToString();</span>
        } else {
<span class="nc" id="L938">            return codebaseToString() + &quot;, &quot; + pString;</span>
        }
    }

    /**
     * convert the Codebase/signer portion of this policy entry into a string
     */
    String codebaseToString() {

<span class="nc" id="L947">        String stringEntry = new String();</span>

<span class="nc bnc" id="L949" title="All 2 branches missed.">        if (grantEntry.codeBase != null &amp;&amp;</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">            grantEntry.codeBase.equals(&quot;&quot;) == false)</span>
<span class="nc" id="L951">            stringEntry = stringEntry.concat</span>
<span class="nc" id="L952">                                (&quot;CodeBase \&quot;&quot; +</span>
                                grantEntry.codeBase +
                                &quot;\&quot;&quot;);

<span class="nc bnc" id="L956" title="All 2 branches missed.">        if (grantEntry.signedBy != null &amp;&amp;</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">            grantEntry.signedBy.equals(&quot;&quot;) == false)</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">            stringEntry = ((stringEntry.length() &gt; 0) ?</span>
<span class="nc" id="L959">                stringEntry.concat(&quot;, SignedBy \&quot;&quot; +</span>
                                grantEntry.signedBy +
                                &quot;\&quot;&quot;) :
<span class="nc" id="L962">                stringEntry.concat(&quot;SignedBy \&quot;&quot; +</span>
                                grantEntry.signedBy +
                                &quot;\&quot;&quot;));

<span class="nc bnc" id="L966" title="All 2 branches missed.">        if (stringEntry.length() == 0)</span>
<span class="nc" id="L967">            return new String(&quot;CodeBase &lt;ALL&gt;&quot;);</span>
<span class="nc" id="L968">        return stringEntry;</span>
    }

    /**
     * convert the Principals portion of this policy entry into a string
     */
    String principalsToString() {
<span class="nc" id="L975">        String result = &quot;&quot;;</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">        if ((grantEntry.principals != null) &amp;&amp;</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">            (!grantEntry.principals.isEmpty())) {</span>
<span class="nc" id="L978">            StringBuffer buffer = new StringBuffer(200);</span>
<span class="nc" id="L979">            ListIterator&lt;PolicyParser.PrincipalEntry&gt; list =</span>
<span class="nc" id="L980">                                grantEntry.principals.listIterator();</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">            while (list.hasNext()) {</span>
<span class="nc" id="L982">                PolicyParser.PrincipalEntry pppe = list.next();</span>
<span class="nc" id="L983">                buffer.append(&quot; Principal &quot; + pppe.getDisplayClass() + &quot; &quot; +</span>
<span class="nc" id="L984">                    pppe.getDisplayName(true));</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">                if (list.hasNext()) buffer.append(&quot;, &quot;);</span>
<span class="nc" id="L986">            }</span>
<span class="nc" id="L987">            result = buffer.toString();</span>
        }
<span class="nc" id="L989">        return result;</span>
    }

    /**
     * convert this policy entry into a PolicyParser.PermissionEntry
     */
    PolicyParser.PermissionEntry toPermissionEntry(Permission perm) {

<span class="nc" id="L997">        String actions = null;</span>

        // get the actions
<span class="nc bnc" id="L1000" title="All 2 branches missed.">        if (perm.getActions() != null &amp;&amp;</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">            perm.getActions().trim() != &quot;&quot;)</span>
<span class="nc" id="L1002">                actions = perm.getActions();</span>

<span class="nc" id="L1004">        PolicyParser.PermissionEntry pe = new PolicyParser.PermissionEntry</span>
<span class="nc" id="L1005">                        (perm.getClass().getName(),</span>
<span class="nc" id="L1006">                        perm.getName(),</span>
                        actions);
<span class="nc" id="L1008">        return pe;</span>
    }
}

/**
 * The main window for the PolicyTool
 */
class ToolWindow extends JFrame {
    // use serialVersionUID from JDK 1.2.2 for interoperability
    private static final long serialVersionUID = 5682568601210376777L;

    /* ESCAPE key */
<span class="nc" id="L1020">    static final KeyStroke escKey = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0);</span>

    /* external paddings */
<span class="nc" id="L1023">    public static final Insets TOP_PADDING = new Insets(25,0,0,0);</span>
<span class="nc" id="L1024">    public static final Insets BOTTOM_PADDING = new Insets(0,0,25,0);</span>
<span class="nc" id="L1025">    public static final Insets LITE_BOTTOM_PADDING = new Insets(0,0,10,0);</span>
<span class="nc" id="L1026">    public static final Insets LR_PADDING = new Insets(0,10,0,10);</span>
<span class="nc" id="L1027">    public static final Insets TOP_BOTTOM_PADDING = new Insets(15, 0, 15, 0);</span>
<span class="nc" id="L1028">    public static final Insets L_TOP_BOTTOM_PADDING = new Insets(5,10,15,0);</span>
<span class="nc" id="L1029">    public static final Insets LR_TOP_BOTTOM_PADDING = new Insets(15, 4, 15, 4);</span>
<span class="nc" id="L1030">    public static final Insets LR_BOTTOM_PADDING = new Insets(0,10,5,10);</span>
<span class="nc" id="L1031">    public static final Insets L_BOTTOM_PADDING = new Insets(0,10,5,0);</span>
<span class="nc" id="L1032">    public static final Insets R_BOTTOM_PADDING = new Insets(0, 0, 25, 5);</span>
<span class="nc" id="L1033">    public static final Insets R_PADDING = new Insets(0, 0, 0, 5);</span>

    /* buttons and menus */
    public static final String NEW_POLICY_FILE          = &quot;New&quot;;
    public static final String OPEN_POLICY_FILE         = &quot;Open&quot;;
    public static final String SAVE_POLICY_FILE         = &quot;Save&quot;;
    public static final String SAVE_AS_POLICY_FILE      = &quot;Save.As&quot;;
    public static final String VIEW_WARNINGS            = &quot;View.Warning.Log&quot;;
    public static final String QUIT                     = &quot;Exit&quot;;
    public static final String ADD_POLICY_ENTRY         = &quot;Add.Policy.Entry&quot;;
    public static final String EDIT_POLICY_ENTRY        = &quot;Edit.Policy.Entry&quot;;
    public static final String REMOVE_POLICY_ENTRY      = &quot;Remove.Policy.Entry&quot;;
    public static final String EDIT_KEYSTORE            = &quot;Edit&quot;;
    public static final String ADD_PUBKEY_ALIAS         = &quot;Add.Public.Key.Alias&quot;;
    public static final String REMOVE_PUBKEY_ALIAS      = &quot;Remove.Public.Key.Alias&quot;;

    /* gridbag index for components in the main window (MW) */
    public static final int MW_FILENAME_LABEL           = 0;
    public static final int MW_FILENAME_TEXTFIELD       = 1;
    public static final int MW_PANEL                    = 2;
    public static final int MW_ADD_BUTTON               = 0;
    public static final int MW_EDIT_BUTTON              = 1;
    public static final int MW_REMOVE_BUTTON            = 2;
    public static final int MW_POLICY_LIST              = 3; // follows MW_PANEL

    /* The preferred height of JTextField should match JComboBox. */
<span class="nc" id="L1059">    static final int TEXTFIELD_HEIGHT = new JComboBox().getPreferredSize().height;</span>

    private PolicyTool tool;

    /**
     * Constructor
     */
<span class="nc" id="L1066">    ToolWindow(PolicyTool tool) {</span>
<span class="nc" id="L1067">        this.tool = tool;</span>
<span class="nc" id="L1068">    }</span>

    /**
     * Don't call getComponent directly on the window
     */
    public Component getComponent(int n) {
<span class="nc" id="L1074">        Component c = getContentPane().getComponent(n);</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">        if (c instanceof JScrollPane) {</span>
<span class="nc" id="L1076">            c = ((JScrollPane)c).getViewport().getView();</span>
        }
<span class="nc" id="L1078">        return c;</span>
    }

    /**
     * Initialize the PolicyTool window with the necessary components
     */
    private void initWindow() {
        // The ToolWindowListener will handle closing the window.
<span class="nc" id="L1086">        setDefaultCloseOperation(JFrame.DO_NOTHING_ON_CLOSE);</span>

        // create the top menu bar
<span class="nc" id="L1089">        JMenuBar menuBar = new JMenuBar();</span>

        // create a File menu
<span class="nc" id="L1092">        JMenu menu = new JMenu();</span>
<span class="nc" id="L1093">        configureButton(menu, &quot;File&quot;);</span>
<span class="nc" id="L1094">        ActionListener actionListener = new FileMenuListener(tool, this);</span>
<span class="nc" id="L1095">        addMenuItem(menu, NEW_POLICY_FILE, actionListener, &quot;N&quot;);</span>
<span class="nc" id="L1096">        addMenuItem(menu, OPEN_POLICY_FILE, actionListener, &quot;O&quot;);</span>
<span class="nc" id="L1097">        addMenuItem(menu, SAVE_POLICY_FILE, actionListener, &quot;S&quot;);</span>
<span class="nc" id="L1098">        addMenuItem(menu, SAVE_AS_POLICY_FILE, actionListener, null);</span>
<span class="nc" id="L1099">        addMenuItem(menu, VIEW_WARNINGS, actionListener, null);</span>
<span class="nc" id="L1100">        addMenuItem(menu, QUIT, actionListener, null);</span>
<span class="nc" id="L1101">        menuBar.add(menu);</span>

        // create a KeyStore menu
<span class="nc" id="L1104">        menu = new JMenu();</span>
<span class="nc" id="L1105">        configureButton(menu, &quot;KeyStore&quot;);</span>
<span class="nc" id="L1106">        actionListener = new MainWindowListener(tool, this);</span>
<span class="nc" id="L1107">        addMenuItem(menu, EDIT_KEYSTORE, actionListener, null);</span>
<span class="nc" id="L1108">        menuBar.add(menu);</span>
<span class="nc" id="L1109">        setJMenuBar(menuBar);</span>

        // Create some space around components
<span class="nc" id="L1112">        ((JPanel)getContentPane()).setBorder(new EmptyBorder(6, 6, 6, 6));</span>

        // policy entry listing
<span class="nc" id="L1115">        JLabel label = new JLabel(PolicyTool.getMessage(&quot;Policy.File.&quot;));</span>
<span class="nc" id="L1116">        addNewComponent(this, label, MW_FILENAME_LABEL,</span>
                        0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                        LR_TOP_BOTTOM_PADDING);
<span class="nc" id="L1119">        JTextField tf = new JTextField(50);</span>
<span class="nc" id="L1120">        tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L1121">        tf.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1122">                PolicyTool.getMessage(&quot;Policy.File.&quot;));</span>
<span class="nc" id="L1123">        tf.setEditable(false);</span>
<span class="nc" id="L1124">        addNewComponent(this, tf, MW_FILENAME_TEXTFIELD,</span>
                        1, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                        LR_TOP_BOTTOM_PADDING);


        // add ADD/REMOVE/EDIT buttons in a new panel
<span class="nc" id="L1130">        JPanel panel = new JPanel();</span>
<span class="nc" id="L1131">        panel.setLayout(new GridBagLayout());</span>

<span class="nc" id="L1133">        JButton button = new JButton();</span>
<span class="nc" id="L1134">        configureButton(button, ADD_POLICY_ENTRY);</span>
<span class="nc" id="L1135">        button.addActionListener(new MainWindowListener(tool, this));</span>
<span class="nc" id="L1136">        addNewComponent(panel, button, MW_ADD_BUTTON,</span>
                        0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                        LR_PADDING);

<span class="nc" id="L1140">        button = new JButton();</span>
<span class="nc" id="L1141">        configureButton(button, EDIT_POLICY_ENTRY);</span>
<span class="nc" id="L1142">        button.addActionListener(new MainWindowListener(tool, this));</span>
<span class="nc" id="L1143">        addNewComponent(panel, button, MW_EDIT_BUTTON,</span>
                        1, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                        LR_PADDING);

<span class="nc" id="L1147">        button = new JButton();</span>
<span class="nc" id="L1148">        configureButton(button, REMOVE_POLICY_ENTRY);</span>
<span class="nc" id="L1149">        button.addActionListener(new MainWindowListener(tool, this));</span>
<span class="nc" id="L1150">        addNewComponent(panel, button, MW_REMOVE_BUTTON,</span>
                        2, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                        LR_PADDING);

<span class="nc" id="L1154">        addNewComponent(this, panel, MW_PANEL,</span>
                        0, 2, 2, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                        BOTTOM_PADDING);


<span class="nc" id="L1159">        String policyFile = tool.getPolicyFileName();</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">        if (policyFile == null) {</span>
            String userHome;
<span class="nc" id="L1162">            userHome = java.security.AccessController.doPrivileged(</span>
                    new sun.security.action.GetPropertyAction(&quot;user.home&quot;));
<span class="nc" id="L1164">            policyFile = userHome + File.separatorChar + &quot;.java.policy&quot;;</span>
        }

        try {
            // open the policy file
<span class="nc" id="L1169">            tool.openPolicy(policyFile);</span>

            // display the policy entries via the policy list textarea
<span class="nc" id="L1172">            DefaultListModel listModel = new DefaultListModel();</span>
<span class="nc" id="L1173">            JList list = new JList(listModel);</span>
<span class="nc" id="L1174">            list.setVisibleRowCount(15);</span>
<span class="nc" id="L1175">            list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L1176">            list.addMouseListener(new PolicyListListener(tool, this));</span>
<span class="nc" id="L1177">            PolicyEntry entries[] = tool.getEntry();</span>
<span class="nc bnc" id="L1178" title="All 2 branches missed.">            if (entries != null) {</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">                for (int i = 0; i &lt; entries.length; i++) {</span>
<span class="nc" id="L1180">                    listModel.addElement(entries[i].headerToString());</span>
                }
            }
<span class="nc" id="L1183">            JTextField newFilename = (JTextField)</span>
<span class="nc" id="L1184">                                getComponent(MW_FILENAME_TEXTFIELD);</span>
<span class="nc" id="L1185">            newFilename.setText(policyFile);</span>
<span class="nc" id="L1186">            initPolicyList(list);</span>

<span class="nc" id="L1188">        } catch (FileNotFoundException fnfe) {</span>
            // add blank policy listing
<span class="nc" id="L1190">            JList list = new JList(new DefaultListModel());</span>
<span class="nc" id="L1191">            list.setVisibleRowCount(15);</span>
<span class="nc" id="L1192">            list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L1193">            list.addMouseListener(new PolicyListListener(tool, this));</span>
<span class="nc" id="L1194">            initPolicyList(list);</span>
<span class="nc" id="L1195">            tool.setPolicyFileName(null);</span>
<span class="nc" id="L1196">            tool.modified = false;</span>

            // just add warning
<span class="nc" id="L1199">            tool.warnings.addElement(fnfe.toString());</span>

<span class="nc" id="L1201">        } catch (Exception e) {</span>
            // add blank policy listing
<span class="nc" id="L1203">            JList list = new JList(new DefaultListModel());</span>
<span class="nc" id="L1204">            list.setVisibleRowCount(15);</span>
<span class="nc" id="L1205">            list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L1206">            list.addMouseListener(new PolicyListListener(tool, this));</span>
<span class="nc" id="L1207">            initPolicyList(list);</span>
<span class="nc" id="L1208">            tool.setPolicyFileName(null);</span>
<span class="nc" id="L1209">            tool.modified = false;</span>

            // display the error
<span class="nc" id="L1212">            MessageFormat form = new MessageFormat(PolicyTool.getMessage</span>
<span class="nc" id="L1213">                (&quot;Could.not.open.policy.file.policyFile.e.toString.&quot;));</span>
<span class="nc" id="L1214">            Object[] source = {policyFile, e.toString()};</span>
<span class="nc" id="L1215">            displayErrorDialog(null, form.format(source));</span>
<span class="nc" id="L1216">        }</span>
<span class="nc" id="L1217">    }</span>


    // Platform specific modifier (control / command).
<span class="nc" id="L1221">    private int shortCutModifier = Toolkit.getDefaultToolkit().getMenuShortcutKeyMask();</span>

    private void addMenuItem(JMenu menu, String key, ActionListener actionListener, String accelerator) {
<span class="nc" id="L1224">        JMenuItem menuItem = new JMenuItem();</span>
<span class="nc" id="L1225">        configureButton(menuItem, key);</span>

<span class="nc bnc" id="L1227" title="All 2 branches missed.">        if (PolicyTool.rb.containsKey(key + &quot;.accelerator&quot;)) {</span>
            // Accelerator from resources takes precedence
<span class="nc" id="L1229">            accelerator = PolicyTool.getMessage(key + &quot;.accelerator&quot;);</span>
        }

<span class="nc bnc" id="L1232" title="All 4 branches missed.">        if (accelerator != null &amp;&amp; !accelerator.isEmpty()) {</span>
            KeyStroke keyStroke;
<span class="nc bnc" id="L1234" title="All 2 branches missed.">            if (accelerator.length() == 1) {</span>
<span class="nc" id="L1235">                keyStroke = KeyStroke.getKeyStroke(KeyEvent.getExtendedKeyCodeForChar(accelerator.charAt(0)),</span>
                                                   shortCutModifier);
            } else {
<span class="nc" id="L1238">                keyStroke = KeyStroke.getKeyStroke(accelerator);</span>
            }
<span class="nc" id="L1240">            menuItem.setAccelerator(keyStroke);</span>
        }

<span class="nc" id="L1243">        menuItem.addActionListener(actionListener);</span>
<span class="nc" id="L1244">        menu.add(menuItem);</span>
<span class="nc" id="L1245">    }</span>

    static void configureButton(AbstractButton button, String key) {
<span class="nc" id="L1248">        button.setText(PolicyTool.getMessage(key));</span>
<span class="nc" id="L1249">        button.setActionCommand(key);</span>

<span class="nc" id="L1251">        int mnemonicInt = PolicyTool.getMnemonicInt(key);</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">        if (mnemonicInt &gt; 0) {</span>
<span class="nc" id="L1253">            button.setMnemonic(mnemonicInt);</span>
<span class="nc" id="L1254">            button.setDisplayedMnemonicIndex(PolicyTool.getDisplayedMnemonicIndex(key));</span>
         }
<span class="nc" id="L1256">    }</span>

    static void configureLabelFor(JLabel label, JComponent component, String key) {
<span class="nc" id="L1259">        label.setText(PolicyTool.getMessage(key));</span>
<span class="nc" id="L1260">        label.setLabelFor(component);</span>

<span class="nc" id="L1262">        int mnemonicInt = PolicyTool.getMnemonicInt(key);</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed.">        if (mnemonicInt &gt; 0) {</span>
<span class="nc" id="L1264">            label.setDisplayedMnemonic(mnemonicInt);</span>
<span class="nc" id="L1265">            label.setDisplayedMnemonicIndex(PolicyTool.getDisplayedMnemonicIndex(key));</span>
         }
<span class="nc" id="L1267">    }</span>


    /**
     * Add a component to the PolicyTool window
     */
    void addNewComponent(Container container, JComponent component,
        int index, int gridx, int gridy, int gridwidth, int gridheight,
        double weightx, double weighty, int fill, Insets is) {

<span class="nc bnc" id="L1277" title="All 2 branches missed.">        if (container instanceof JFrame) {</span>
<span class="nc" id="L1278">            container = ((JFrame)container).getContentPane();</span>
<span class="nc bnc" id="L1279" title="All 2 branches missed.">        } else if (container instanceof JDialog) {</span>
<span class="nc" id="L1280">            container = ((JDialog)container).getContentPane();</span>
        }

        // add the component at the specified gridbag index
<span class="nc" id="L1284">        container.add(component, index);</span>

        // set the constraints
<span class="nc" id="L1287">        GridBagLayout gbl = (GridBagLayout)container.getLayout();</span>
<span class="nc" id="L1288">        GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L1289">        gbc.gridx = gridx;</span>
<span class="nc" id="L1290">        gbc.gridy = gridy;</span>
<span class="nc" id="L1291">        gbc.gridwidth = gridwidth;</span>
<span class="nc" id="L1292">        gbc.gridheight = gridheight;</span>
<span class="nc" id="L1293">        gbc.weightx = weightx;</span>
<span class="nc" id="L1294">        gbc.weighty = weighty;</span>
<span class="nc" id="L1295">        gbc.fill = fill;</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">        if (is != null) gbc.insets = is;</span>
<span class="nc" id="L1297">        gbl.setConstraints(component, gbc);</span>
<span class="nc" id="L1298">    }</span>


    /**
     * Add a component to the PolicyTool window without external padding
     */
    void addNewComponent(Container container, JComponent component,
        int index, int gridx, int gridy, int gridwidth, int gridheight,
        double weightx, double weighty, int fill) {

        // delegate with &quot;null&quot; external padding
<span class="nc" id="L1309">        addNewComponent(container, component, index, gridx, gridy,</span>
                        gridwidth, gridheight, weightx, weighty,
                        fill, null);
<span class="nc" id="L1312">    }</span>


    /**
     * Init the policy_entry_list TEXTAREA component in the
     * PolicyTool window
     */
    void initPolicyList(JList policyList) {

        // add the policy list to the window
        //policyList.setPreferredSize(new Dimension(500, 350));
<span class="nc" id="L1323">        JScrollPane scrollPane = new JScrollPane(policyList);</span>
<span class="nc" id="L1324">        addNewComponent(this, scrollPane, MW_POLICY_LIST,</span>
                        0, 3, 2, 1, 1.0, 1.0, GridBagConstraints.BOTH);
<span class="nc" id="L1326">    }</span>

    /**
     * Replace the policy_entry_list TEXTAREA component in the
     * PolicyTool window with an updated one.
     */
    void replacePolicyList(JList policyList) {

        // remove the original list of Policy Entries
        // and add the new list of entries
<span class="nc" id="L1336">        JList list = (JList)getComponent(MW_POLICY_LIST);</span>
<span class="nc" id="L1337">        list.setModel(policyList.getModel());</span>
<span class="nc" id="L1338">    }</span>

    /**
     * display the main PolicyTool window
     */
    void displayToolWindow(String args[]) {

<span class="nc" id="L1345">        setTitle(PolicyTool.getMessage(&quot;Policy.Tool&quot;));</span>
<span class="nc" id="L1346">        setResizable(true);</span>
<span class="nc" id="L1347">        addWindowListener(new ToolWindowListener(tool, this));</span>
        //setBounds(135, 80, 500, 500);
<span class="nc" id="L1349">        getContentPane().setLayout(new GridBagLayout());</span>

<span class="nc" id="L1351">        initWindow();</span>
<span class="nc" id="L1352">        pack();</span>
<span class="nc" id="L1353">        setLocationRelativeTo(null);</span>

        // display it
<span class="nc" id="L1356">        setVisible(true);</span>

<span class="nc bnc" id="L1358" title="All 2 branches missed.">        if (tool.newWarning == true) {</span>
<span class="nc" id="L1359">            displayStatusDialog(this, PolicyTool.getMessage</span>
<span class="nc" id="L1360">                (&quot;Errors.have.occurred.while.opening.the.policy.configuration.View.the.Warning.Log.for.more.information.&quot;));</span>
        }
<span class="nc" id="L1362">    }</span>

    /**
     * displays a dialog box describing an error which occurred.
     */
    void displayErrorDialog(Window w, String error) {
<span class="nc" id="L1368">        ToolDialog ed = new ToolDialog</span>
<span class="nc" id="L1369">                (PolicyTool.getMessage(&quot;Error&quot;), tool, this, true);</span>

        // find where the PolicyTool gui is
<span class="nc bnc" id="L1372" title="All 2 branches missed.">        Point location = ((w == null) ?</span>
<span class="nc" id="L1373">                getLocationOnScreen() : w.getLocationOnScreen());</span>
        //ed.setBounds(location.x + 50, location.y + 50, 600, 100);
<span class="nc" id="L1375">        ed.setLayout(new GridBagLayout());</span>

<span class="nc" id="L1377">        JLabel label = new JLabel(error);</span>
<span class="nc" id="L1378">        addNewComponent(ed, label, 0,</span>
                        0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH);

<span class="nc" id="L1381">        JButton okButton = new JButton(PolicyTool.getMessage(&quot;OK&quot;));</span>
<span class="nc" id="L1382">        ActionListener okListener = new ErrorOKButtonListener(ed);</span>
<span class="nc" id="L1383">        okButton.addActionListener(okListener);</span>
<span class="nc" id="L1384">        addNewComponent(ed, okButton, 1,</span>
                        0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL);

<span class="nc" id="L1387">        ed.getRootPane().setDefaultButton(okButton);</span>
<span class="nc" id="L1388">        ed.getRootPane().registerKeyboardAction(okListener, escKey, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc" id="L1390">        ed.pack();</span>
<span class="nc" id="L1391">        ed.setLocationRelativeTo(w);</span>
<span class="nc" id="L1392">        ed.setVisible(true);</span>
<span class="nc" id="L1393">    }</span>

    /**
     * displays a dialog box describing an error which occurred.
     */
    void displayErrorDialog(Window w, Throwable t) {
<span class="nc bnc" id="L1399" title="All 2 branches missed.">        if (t instanceof NoDisplayException) {</span>
<span class="nc" id="L1400">            return;</span>
        }
<span class="nc" id="L1402">        displayErrorDialog(w, t.toString());</span>
<span class="nc" id="L1403">    }</span>

    /**
     * displays a dialog box describing the status of an event
     */
    void displayStatusDialog(Window w, String status) {
<span class="nc" id="L1409">        ToolDialog sd = new ToolDialog</span>
<span class="nc" id="L1410">                (PolicyTool.getMessage(&quot;Status&quot;), tool, this, true);</span>

        // find the location of the PolicyTool gui
<span class="nc bnc" id="L1413" title="All 2 branches missed.">        Point location = ((w == null) ?</span>
<span class="nc" id="L1414">                getLocationOnScreen() : w.getLocationOnScreen());</span>
        //sd.setBounds(location.x + 50, location.y + 50, 500, 100);
<span class="nc" id="L1416">        sd.setLayout(new GridBagLayout());</span>

<span class="nc" id="L1418">        JLabel label = new JLabel(status);</span>
<span class="nc" id="L1419">        addNewComponent(sd, label, 0,</span>
                        0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH);

<span class="nc" id="L1422">        JButton okButton = new JButton(PolicyTool.getMessage(&quot;OK&quot;));</span>
<span class="nc" id="L1423">        ActionListener okListener = new StatusOKButtonListener(sd);</span>
<span class="nc" id="L1424">        okButton.addActionListener(okListener);</span>
<span class="nc" id="L1425">        addNewComponent(sd, okButton, 1,</span>
                        0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL);

<span class="nc" id="L1428">        sd.getRootPane().setDefaultButton(okButton);</span>
<span class="nc" id="L1429">        sd.getRootPane().registerKeyboardAction(okListener, escKey, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc" id="L1431">        sd.pack();</span>
<span class="nc" id="L1432">        sd.setLocationRelativeTo(w);</span>
<span class="nc" id="L1433">        sd.setVisible(true);</span>
<span class="nc" id="L1434">    }</span>

    /**
     * display the warning log
     */
    void displayWarningLog(Window w) {

<span class="nc" id="L1441">        ToolDialog wd = new ToolDialog</span>
<span class="nc" id="L1442">                (PolicyTool.getMessage(&quot;Warning&quot;), tool, this, true);</span>

        // find the location of the PolicyTool gui
<span class="nc bnc" id="L1445" title="All 2 branches missed.">        Point location = ((w == null) ?</span>
<span class="nc" id="L1446">                getLocationOnScreen() : w.getLocationOnScreen());</span>
        //wd.setBounds(location.x + 50, location.y + 50, 500, 100);
<span class="nc" id="L1448">        wd.setLayout(new GridBagLayout());</span>

<span class="nc" id="L1450">        JTextArea ta = new JTextArea();</span>
<span class="nc" id="L1451">        ta.setEditable(false);</span>
<span class="nc bnc" id="L1452" title="All 2 branches missed.">        for (int i = 0; i &lt; tool.warnings.size(); i++) {</span>
<span class="nc" id="L1453">            ta.append(tool.warnings.elementAt(i));</span>
<span class="nc" id="L1454">            ta.append(PolicyTool.getMessage(&quot;NEWLINE&quot;));</span>
        }
<span class="nc" id="L1456">        addNewComponent(wd, ta, 0,</span>
                        0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                        BOTTOM_PADDING);
<span class="nc" id="L1459">        ta.setFocusable(false);</span>

<span class="nc" id="L1461">        JButton okButton = new JButton(PolicyTool.getMessage(&quot;OK&quot;));</span>
<span class="nc" id="L1462">        ActionListener okListener = new CancelButtonListener(wd);</span>
<span class="nc" id="L1463">        okButton.addActionListener(okListener);</span>
<span class="nc" id="L1464">        addNewComponent(wd, okButton, 1,</span>
                        0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL,
                        LR_PADDING);

<span class="nc" id="L1468">        wd.getRootPane().setDefaultButton(okButton);</span>
<span class="nc" id="L1469">        wd.getRootPane().registerKeyboardAction(okListener, escKey, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc" id="L1471">        wd.pack();</span>
<span class="nc" id="L1472">        wd.setLocationRelativeTo(w);</span>
<span class="nc" id="L1473">        wd.setVisible(true);</span>
<span class="nc" id="L1474">    }</span>

    char displayYesNoDialog(Window w, String title, String prompt, String yes, String no) {

<span class="nc" id="L1478">        final ToolDialog tw = new ToolDialog</span>
                (title, tool, this, true);
<span class="nc bnc" id="L1480" title="All 2 branches missed.">        Point location = ((w == null) ?</span>
<span class="nc" id="L1481">                getLocationOnScreen() : w.getLocationOnScreen());</span>
        //tw.setBounds(location.x + 75, location.y + 100, 400, 150);
<span class="nc" id="L1483">        tw.setLayout(new GridBagLayout());</span>

<span class="nc" id="L1485">        JTextArea ta = new JTextArea(prompt, 10, 50);</span>
<span class="nc" id="L1486">        ta.setEditable(false);</span>
<span class="nc" id="L1487">        ta.setLineWrap(true);</span>
<span class="nc" id="L1488">        ta.setWrapStyleWord(true);</span>
<span class="nc" id="L1489">        JScrollPane scrollPane = new JScrollPane(ta,</span>
                                                 JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED,
                                                 JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
<span class="nc" id="L1492">        addNewComponent(tw, scrollPane, 0,</span>
                0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH);
<span class="nc" id="L1494">        ta.setFocusable(false);</span>

<span class="nc" id="L1496">        JPanel panel = new JPanel();</span>
<span class="nc" id="L1497">        panel.setLayout(new GridBagLayout());</span>

        // StringBuffer to store button press. Must be final.
<span class="nc" id="L1500">        final StringBuffer chooseResult = new StringBuffer();</span>

<span class="nc" id="L1502">        JButton button = new JButton(yes);</span>
<span class="nc" id="L1503">        button.addActionListener(new ActionListener() {</span>
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1505">                chooseResult.append('Y');</span>
<span class="nc" id="L1506">                tw.setVisible(false);</span>
<span class="nc" id="L1507">                tw.dispose();</span>
<span class="nc" id="L1508">            }</span>
        });
<span class="nc" id="L1510">        addNewComponent(panel, button, 0,</span>
                           0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL,
                           LR_PADDING);

<span class="nc" id="L1514">        button = new JButton(no);</span>
<span class="nc" id="L1515">        button.addActionListener(new ActionListener() {</span>
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1517">                chooseResult.append('N');</span>
<span class="nc" id="L1518">                tw.setVisible(false);</span>
<span class="nc" id="L1519">                tw.dispose();</span>
<span class="nc" id="L1520">            }</span>
        });
<span class="nc" id="L1522">        addNewComponent(panel, button, 1,</span>
                           1, 0, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL,
                           LR_PADDING);

<span class="nc" id="L1526">        addNewComponent(tw, panel, 1,</span>
                0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL);

<span class="nc" id="L1529">        tw.pack();</span>
<span class="nc" id="L1530">        tw.setLocationRelativeTo(w);</span>
<span class="nc" id="L1531">        tw.setVisible(true);</span>
<span class="nc bnc" id="L1532" title="All 2 branches missed.">        if (chooseResult.length() &gt; 0) {</span>
<span class="nc" id="L1533">            return chooseResult.charAt(0);</span>
        } else {
            // I did encounter this once, don't why.
<span class="nc" id="L1536">            return 'N';</span>
        }
    }

}

/**
 * General dialog window
 */
class ToolDialog extends JDialog {
    // use serialVersionUID from JDK 1.2.2 for interoperability
    private static final long serialVersionUID = -372244357011301190L;

    /* ESCAPE key */
<span class="nc" id="L1550">    static final KeyStroke escKey = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0);</span>

    /* necessary constants */
    public static final int NOACTION            = 0;
    public static final int QUIT                = 1;
    public static final int NEW                 = 2;
    public static final int OPEN                = 3;

    public static final String ALL_PERM_CLASS   =
                &quot;java.security.AllPermission&quot;;
    public static final String FILE_PERM_CLASS  =
                &quot;java.io.FilePermission&quot;;

    public static final String X500_PRIN_CLASS         =
                &quot;javax.security.auth.x500.X500Principal&quot;;

    /* popup menus */
<span class="nc" id="L1567">    public static final String PERM             =</span>
        PolicyTool.getMessage
<span class="nc" id="L1569">        (&quot;Permission.&quot;);</span>

<span class="nc" id="L1571">    public static final String PRIN_TYPE        =</span>
<span class="nc" id="L1572">        PolicyTool.getMessage(&quot;Principal.Type.&quot;);</span>
<span class="nc" id="L1573">    public static final String PRIN_NAME        =</span>
<span class="nc" id="L1574">        PolicyTool.getMessage(&quot;Principal.Name.&quot;);</span>

    /* more popu menus */
<span class="nc" id="L1577">    public static final String PERM_NAME        =</span>
        PolicyTool.getMessage
<span class="nc" id="L1579">        (&quot;Target.Name.&quot;);</span>

    /* and more popup menus */
<span class="nc" id="L1582">    public static final String PERM_ACTIONS             =</span>
      PolicyTool.getMessage
<span class="nc" id="L1584">      (&quot;Actions.&quot;);</span>

    /* gridbag index for display PolicyEntry (PE) components */
    public static final int PE_CODEBASE_LABEL           = 0;
    public static final int PE_CODEBASE_TEXTFIELD       = 1;
    public static final int PE_SIGNEDBY_LABEL           = 2;
    public static final int PE_SIGNEDBY_TEXTFIELD       = 3;

    public static final int PE_PANEL0                   = 4;
    public static final int PE_ADD_PRIN_BUTTON          = 0;
    public static final int PE_EDIT_PRIN_BUTTON         = 1;
    public static final int PE_REMOVE_PRIN_BUTTON       = 2;

    public static final int PE_PRIN_LABEL               = 5;
    public static final int PE_PRIN_LIST                = 6;

    public static final int PE_PANEL1                   = 7;
    public static final int PE_ADD_PERM_BUTTON          = 0;
    public static final int PE_EDIT_PERM_BUTTON         = 1;
    public static final int PE_REMOVE_PERM_BUTTON       = 2;

    public static final int PE_PERM_LIST                = 8;

    public static final int PE_PANEL2                   = 9;
    public static final int PE_CANCEL_BUTTON            = 1;
    public static final int PE_DONE_BUTTON              = 0;

    /* the gridbag index for components in the Principal Dialog (PRD) */
    public static final int PRD_DESC_LABEL              = 0;
    public static final int PRD_PRIN_CHOICE             = 1;
    public static final int PRD_PRIN_TEXTFIELD          = 2;
    public static final int PRD_NAME_LABEL              = 3;
    public static final int PRD_NAME_TEXTFIELD          = 4;
    public static final int PRD_CANCEL_BUTTON           = 6;
    public static final int PRD_OK_BUTTON               = 5;

    /* the gridbag index for components in the Permission Dialog (PD) */
    public static final int PD_DESC_LABEL               = 0;
    public static final int PD_PERM_CHOICE              = 1;
    public static final int PD_PERM_TEXTFIELD           = 2;
    public static final int PD_NAME_CHOICE              = 3;
    public static final int PD_NAME_TEXTFIELD           = 4;
    public static final int PD_ACTIONS_CHOICE           = 5;
    public static final int PD_ACTIONS_TEXTFIELD        = 6;
    public static final int PD_SIGNEDBY_LABEL           = 7;
    public static final int PD_SIGNEDBY_TEXTFIELD       = 8;
    public static final int PD_CANCEL_BUTTON            = 10;
    public static final int PD_OK_BUTTON                = 9;

    /* modes for KeyStore */
    public static final int EDIT_KEYSTORE               = 0;

    /* the gridbag index for components in the Change KeyStore Dialog (KSD) */
    public static final int KSD_NAME_LABEL              = 0;
    public static final int KSD_NAME_TEXTFIELD          = 1;
    public static final int KSD_TYPE_LABEL              = 2;
    public static final int KSD_TYPE_TEXTFIELD          = 3;
    public static final int KSD_PROVIDER_LABEL          = 4;
    public static final int KSD_PROVIDER_TEXTFIELD      = 5;
    public static final int KSD_PWD_URL_LABEL           = 6;
    public static final int KSD_PWD_URL_TEXTFIELD       = 7;
    public static final int KSD_CANCEL_BUTTON           = 9;
    public static final int KSD_OK_BUTTON               = 8;

    /* the gridbag index for components in the User Save Changes Dialog (USC) */
    public static final int USC_LABEL                   = 0;
    public static final int USC_PANEL                   = 1;
    public static final int USC_YES_BUTTON              = 0;
    public static final int USC_NO_BUTTON               = 1;
    public static final int USC_CANCEL_BUTTON           = 2;

    /* gridbag index for the ConfirmRemovePolicyEntryDialog (CRPE) */
    public static final int CRPE_LABEL1                 = 0;
    public static final int CRPE_LABEL2                 = 1;
    public static final int CRPE_PANEL                  = 2;
    public static final int CRPE_PANEL_OK               = 0;
    public static final int CRPE_PANEL_CANCEL           = 1;

    /* some private static finals */
    private static final int PERMISSION                 = 0;
    private static final int PERMISSION_NAME            = 1;
    private static final int PERMISSION_ACTIONS         = 2;
    private static final int PERMISSION_SIGNEDBY        = 3;
    private static final int PRINCIPAL_TYPE             = 4;
    private static final int PRINCIPAL_NAME             = 5;

    /* The preferred height of JTextField should match JComboBox. */
<span class="nc" id="L1671">    static final int TEXTFIELD_HEIGHT = new JComboBox().getPreferredSize().height;</span>

    public static java.util.ArrayList&lt;Perm&gt; PERM_ARRAY;
    public static java.util.ArrayList&lt;Prin&gt; PRIN_ARRAY;
    PolicyTool tool;
    ToolWindow tw;

    static {

        // set up permission objects

<span class="nc" id="L1682">        PERM_ARRAY = new java.util.ArrayList&lt;Perm&gt;();</span>
<span class="nc" id="L1683">        PERM_ARRAY.add(new AllPerm());</span>
<span class="nc" id="L1684">        PERM_ARRAY.add(new AudioPerm());</span>
<span class="nc" id="L1685">        PERM_ARRAY.add(new AuthPerm());</span>
<span class="nc" id="L1686">        PERM_ARRAY.add(new AWTPerm());</span>
<span class="nc" id="L1687">        PERM_ARRAY.add(new DelegationPerm());</span>
<span class="nc" id="L1688">        PERM_ARRAY.add(new FilePerm());</span>
<span class="nc" id="L1689">        PERM_ARRAY.add(new URLPerm());</span>
<span class="nc" id="L1690">        PERM_ARRAY.add(new InqSecContextPerm());</span>
<span class="nc" id="L1691">        PERM_ARRAY.add(new LogPerm());</span>
<span class="nc" id="L1692">        PERM_ARRAY.add(new MgmtPerm());</span>
<span class="nc" id="L1693">        PERM_ARRAY.add(new MBeanPerm());</span>
<span class="nc" id="L1694">        PERM_ARRAY.add(new MBeanSvrPerm());</span>
<span class="nc" id="L1695">        PERM_ARRAY.add(new MBeanTrustPerm());</span>
<span class="nc" id="L1696">        PERM_ARRAY.add(new NetPerm());</span>
<span class="nc" id="L1697">        PERM_ARRAY.add(new PrivCredPerm());</span>
<span class="nc" id="L1698">        PERM_ARRAY.add(new PropPerm());</span>
<span class="nc" id="L1699">        PERM_ARRAY.add(new ReflectPerm());</span>
<span class="nc" id="L1700">        PERM_ARRAY.add(new RuntimePerm());</span>
<span class="nc" id="L1701">        PERM_ARRAY.add(new SecurityPerm());</span>
<span class="nc" id="L1702">        PERM_ARRAY.add(new SerialPerm());</span>
<span class="nc" id="L1703">        PERM_ARRAY.add(new ServicePerm());</span>
<span class="nc" id="L1704">        PERM_ARRAY.add(new SocketPerm());</span>
<span class="nc" id="L1705">        PERM_ARRAY.add(new SQLPerm());</span>
<span class="nc" id="L1706">        PERM_ARRAY.add(new SSLPerm());</span>
<span class="nc" id="L1707">        PERM_ARRAY.add(new SubjDelegPerm());</span>

        // set up principal objects

<span class="nc" id="L1711">        PRIN_ARRAY = new java.util.ArrayList&lt;Prin&gt;();</span>
<span class="nc" id="L1712">        PRIN_ARRAY.add(new KrbPrin());</span>
<span class="nc" id="L1713">        PRIN_ARRAY.add(new X500Prin());</span>
<span class="nc" id="L1714">    }</span>

    ToolDialog(String title, PolicyTool tool, ToolWindow tw, boolean modal) {
<span class="nc" id="L1717">        super(tw, modal);</span>
<span class="nc" id="L1718">        setTitle(title);</span>
<span class="nc" id="L1719">        this.tool = tool;</span>
<span class="nc" id="L1720">        this.tw = tw;</span>
<span class="nc" id="L1721">        addWindowListener(new ChildWindowListener(this));</span>

        // Create some space around components
<span class="nc" id="L1724">        ((JPanel)getContentPane()).setBorder(new EmptyBorder(6, 6, 6, 6));</span>
<span class="nc" id="L1725">    }</span>

    /**
     * Don't call getComponent directly on the window
     */
    public Component getComponent(int n) {
<span class="nc" id="L1731">        Component c = getContentPane().getComponent(n);</span>
<span class="nc bnc" id="L1732" title="All 2 branches missed.">        if (c instanceof JScrollPane) {</span>
<span class="nc" id="L1733">            c = ((JScrollPane)c).getViewport().getView();</span>
        }
<span class="nc" id="L1735">        return c;</span>
    }

    /**
     * get the Perm instance based on either the (shortened) class name
     * or the fully qualified class name
     */
    static Perm getPerm(String clazz, boolean fullClassName) {
<span class="nc bnc" id="L1743" title="All 2 branches missed.">        for (int i = 0; i &lt; PERM_ARRAY.size(); i++) {</span>
<span class="nc" id="L1744">            Perm next = PERM_ARRAY.get(i);</span>
<span class="nc bnc" id="L1745" title="All 2 branches missed.">            if (fullClassName) {</span>
<span class="nc bnc" id="L1746" title="All 2 branches missed.">                if (next.FULL_CLASS.equals(clazz)) {</span>
<span class="nc" id="L1747">                    return next;</span>
                }
            } else {
<span class="nc bnc" id="L1750" title="All 2 branches missed.">                if (next.CLASS.equals(clazz)) {</span>
<span class="nc" id="L1751">                    return next;</span>
                }
            }
        }
<span class="nc" id="L1755">        return null;</span>
    }

    /**
     * get the Prin instance based on either the (shortened) class name
     * or the fully qualified class name
     */
    static Prin getPrin(String clazz, boolean fullClassName) {
<span class="nc bnc" id="L1763" title="All 2 branches missed.">        for (int i = 0; i &lt; PRIN_ARRAY.size(); i++) {</span>
<span class="nc" id="L1764">            Prin next = PRIN_ARRAY.get(i);</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">            if (fullClassName) {</span>
<span class="nc bnc" id="L1766" title="All 2 branches missed.">                if (next.FULL_CLASS.equals(clazz)) {</span>
<span class="nc" id="L1767">                    return next;</span>
                }
            } else {
<span class="nc bnc" id="L1770" title="All 2 branches missed.">                if (next.CLASS.equals(clazz)) {</span>
<span class="nc" id="L1771">                    return next;</span>
                }
            }
        }
<span class="nc" id="L1775">        return null;</span>
    }

    /**
     * pop up a dialog so the user can enter info to add a new PolicyEntry
     * - if edit is TRUE, then the user is editing an existing entry
     *   and we should display the original info as well.
     *
     * - the other reason we need the 'edit' boolean is we need to know
     *   when we are adding a NEW policy entry.  in this case, we can
     *   not simply update the existing entry, because it doesn't exist.
     *   we ONLY update the GUI listing/info, and then when the user
     *   finally clicks 'OK' or 'DONE', then we can collect that info
     *   and add it to the policy.
     */
    void displayPolicyEntryDialog(boolean edit) {

<span class="nc" id="L1792">        int listIndex = 0;</span>
<span class="nc" id="L1793">        PolicyEntry entries[] = null;</span>
<span class="nc" id="L1794">        TaggedList prinList = new TaggedList(3, false);</span>
<span class="nc" id="L1795">        prinList.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1796">                PolicyTool.getMessage(&quot;Principal.List&quot;));</span>
<span class="nc" id="L1797">        prinList.addMouseListener</span>
<span class="nc" id="L1798">                (new EditPrinButtonListener(tool, tw, this, edit));</span>
<span class="nc" id="L1799">        TaggedList permList = new TaggedList(10, false);</span>
<span class="nc" id="L1800">        permList.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1801">                PolicyTool.getMessage(&quot;Permission.List&quot;));</span>
<span class="nc" id="L1802">        permList.addMouseListener</span>
<span class="nc" id="L1803">                (new EditPermButtonListener(tool, tw, this, edit));</span>

        // find where the PolicyTool gui is
<span class="nc" id="L1806">        Point location = tw.getLocationOnScreen();</span>
        //setBounds(location.x + 75, location.y + 200, 650, 500);
<span class="nc" id="L1808">        setLayout(new GridBagLayout());</span>
<span class="nc" id="L1809">        setResizable(true);</span>

<span class="nc bnc" id="L1811" title="All 2 branches missed.">        if (edit) {</span>
            // get the selected item
<span class="nc" id="L1813">            entries = tool.getEntry();</span>
<span class="nc" id="L1814">            JList policyList = (JList)tw.getComponent(ToolWindow.MW_POLICY_LIST);</span>
<span class="nc" id="L1815">            listIndex = policyList.getSelectedIndex();</span>

            // get principal list
<span class="nc" id="L1818">            LinkedList&lt;PolicyParser.PrincipalEntry&gt; principals =</span>
<span class="nc" id="L1819">                entries[listIndex].getGrantEntry().principals;</span>
<span class="nc bnc" id="L1820" title="All 2 branches missed.">            for (int i = 0; i &lt; principals.size(); i++) {</span>
<span class="nc" id="L1821">                String prinString = null;</span>
<span class="nc" id="L1822">                PolicyParser.PrincipalEntry nextPrin = principals.get(i);</span>
<span class="nc" id="L1823">                prinList.addTaggedItem(PrincipalEntryToUserFriendlyString(nextPrin), nextPrin);</span>
            }

            // get permission list
<span class="nc" id="L1827">            Vector&lt;PolicyParser.PermissionEntry&gt; permissions =</span>
<span class="nc" id="L1828">                entries[listIndex].getGrantEntry().permissionEntries;</span>
<span class="nc bnc" id="L1829" title="All 2 branches missed.">            for (int i = 0; i &lt; permissions.size(); i++) {</span>
<span class="nc" id="L1830">                String permString = null;</span>
<span class="nc" id="L1831">                PolicyParser.PermissionEntry nextPerm =</span>
<span class="nc" id="L1832">                                                permissions.elementAt(i);</span>
<span class="nc" id="L1833">                permList.addTaggedItem(ToolDialog.PermissionEntryToUserFriendlyString(nextPerm), nextPerm);</span>
            }
        }

        // codebase label and textfield
<span class="nc" id="L1838">        JLabel label = new JLabel();</span>
<span class="nc" id="L1839">        tw.addNewComponent(this, label, PE_CODEBASE_LABEL,</span>
                0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                ToolWindow.R_PADDING);
        JTextField tf;
<span class="nc bnc" id="L1843" title="All 2 branches missed.">        tf = (edit ?</span>
<span class="nc" id="L1844">                new JTextField(entries[listIndex].getGrantEntry().codeBase) :</span>
                new JTextField());
<span class="nc" id="L1846">        ToolWindow.configureLabelFor(label, tf, &quot;CodeBase.&quot;);</span>
<span class="nc" id="L1847">        tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L1848">        tf.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1849">                PolicyTool.getMessage(&quot;Code.Base&quot;));</span>
<span class="nc" id="L1850">        tw.addNewComponent(this, tf, PE_CODEBASE_TEXTFIELD,</span>
                1, 0, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH);

        // signedby label and textfield
<span class="nc" id="L1854">        label = new JLabel();</span>
<span class="nc" id="L1855">        tw.addNewComponent(this, label, PE_SIGNEDBY_LABEL,</span>
                           0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.R_PADDING);
<span class="nc bnc" id="L1858" title="All 2 branches missed.">        tf = (edit ?</span>
<span class="nc" id="L1859">                new JTextField(entries[listIndex].getGrantEntry().signedBy) :</span>
                new JTextField());
<span class="nc" id="L1861">        ToolWindow.configureLabelFor(label, tf, &quot;SignedBy.&quot;);</span>
<span class="nc" id="L1862">        tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L1863">        tf.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L1864">                PolicyTool.getMessage(&quot;Signed.By.&quot;));</span>
<span class="nc" id="L1865">        tw.addNewComponent(this, tf, PE_SIGNEDBY_TEXTFIELD,</span>
                           1, 1, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH);

        // panel for principal buttons
<span class="nc" id="L1869">        JPanel panel = new JPanel();</span>
<span class="nc" id="L1870">        panel.setLayout(new GridBagLayout());</span>

<span class="nc" id="L1872">        JButton button = new JButton();</span>
<span class="nc" id="L1873">        ToolWindow.configureButton(button, &quot;Add.Principal&quot;);</span>
<span class="nc" id="L1874">        button.addActionListener</span>
<span class="nc" id="L1875">                (new AddPrinButtonListener(tool, tw, this, edit));</span>
<span class="nc" id="L1876">        tw.addNewComponent(panel, button, PE_ADD_PRIN_BUTTON,</span>
                0, 0, 1, 1, 100.0, 0.0, GridBagConstraints.HORIZONTAL);

<span class="nc" id="L1879">        button = new JButton();</span>
<span class="nc" id="L1880">        ToolWindow.configureButton(button, &quot;Edit.Principal&quot;);</span>
<span class="nc" id="L1881">        button.addActionListener(new EditPrinButtonListener</span>
                                                (tool, tw, this, edit));
<span class="nc" id="L1883">        tw.addNewComponent(panel, button, PE_EDIT_PRIN_BUTTON,</span>
                1, 0, 1, 1, 100.0, 0.0, GridBagConstraints.HORIZONTAL);

<span class="nc" id="L1886">        button = new JButton();</span>
<span class="nc" id="L1887">        ToolWindow.configureButton(button, &quot;Remove.Principal&quot;);</span>
<span class="nc" id="L1888">        button.addActionListener(new RemovePrinButtonListener</span>
                                        (tool, tw, this, edit));
<span class="nc" id="L1890">        tw.addNewComponent(panel, button, PE_REMOVE_PRIN_BUTTON,</span>
                2, 0, 1, 1, 100.0, 0.0, GridBagConstraints.HORIZONTAL);

<span class="nc" id="L1893">        tw.addNewComponent(this, panel, PE_PANEL0,</span>
                1, 2, 1, 1, 0.0, 0.0, GridBagConstraints.HORIZONTAL,
                           ToolWindow.LITE_BOTTOM_PADDING);

        // principal label and list
<span class="nc" id="L1898">        label = new JLabel();</span>
<span class="nc" id="L1899">        tw.addNewComponent(this, label, PE_PRIN_LABEL,</span>
                           0, 3, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.R_BOTTOM_PADDING);
<span class="nc" id="L1902">        JScrollPane scrollPane = new JScrollPane(prinList);</span>
<span class="nc" id="L1903">        ToolWindow.configureLabelFor(label, scrollPane, &quot;Principals.&quot;);</span>
<span class="nc" id="L1904">        tw.addNewComponent(this, scrollPane, PE_PRIN_LIST,</span>
<span class="nc" id="L1905">                           1, 3, 3, 1, 0.0, prinList.getVisibleRowCount(), GridBagConstraints.BOTH,</span>
                           ToolWindow.BOTTOM_PADDING);

        // panel for permission buttons
<span class="nc" id="L1909">        panel = new JPanel();</span>
<span class="nc" id="L1910">        panel.setLayout(new GridBagLayout());</span>

<span class="nc" id="L1912">        button = new JButton();</span>
<span class="nc" id="L1913">        ToolWindow.configureButton(button, &quot;.Add.Permission&quot;);</span>
<span class="nc" id="L1914">        button.addActionListener(new AddPermButtonListener</span>
                                                (tool, tw, this, edit));
<span class="nc" id="L1916">        tw.addNewComponent(panel, button, PE_ADD_PERM_BUTTON,</span>
                0, 0, 1, 1, 100.0, 0.0, GridBagConstraints.HORIZONTAL);

<span class="nc" id="L1919">        button = new JButton();</span>
<span class="nc" id="L1920">        ToolWindow.configureButton(button, &quot;.Edit.Permission&quot;);</span>
<span class="nc" id="L1921">        button.addActionListener(new EditPermButtonListener</span>
                                                (tool, tw, this, edit));
<span class="nc" id="L1923">        tw.addNewComponent(panel, button, PE_EDIT_PERM_BUTTON,</span>
                1, 0, 1, 1, 100.0, 0.0, GridBagConstraints.HORIZONTAL);


<span class="nc" id="L1927">        button = new JButton();</span>
<span class="nc" id="L1928">        ToolWindow.configureButton(button, &quot;Remove.Permission&quot;);</span>
<span class="nc" id="L1929">        button.addActionListener(new RemovePermButtonListener</span>
                                        (tool, tw, this, edit));
<span class="nc" id="L1931">        tw.addNewComponent(panel, button, PE_REMOVE_PERM_BUTTON,</span>
                2, 0, 1, 1, 100.0, 0.0, GridBagConstraints.HORIZONTAL);

<span class="nc" id="L1934">        tw.addNewComponent(this, panel, PE_PANEL1,</span>
                0, 4, 2, 1, 0.0, 0.0, GridBagConstraints.HORIZONTAL,
                ToolWindow.LITE_BOTTOM_PADDING);

        // permission list
<span class="nc" id="L1939">        scrollPane = new JScrollPane(permList);</span>
<span class="nc" id="L1940">        tw.addNewComponent(this, scrollPane, PE_PERM_LIST,</span>
<span class="nc" id="L1941">                           0, 5, 3, 1, 0.0, permList.getVisibleRowCount(), GridBagConstraints.BOTH,</span>
                           ToolWindow.BOTTOM_PADDING);


        // panel for Done and Cancel buttons
<span class="nc" id="L1946">        panel = new JPanel();</span>
<span class="nc" id="L1947">        panel.setLayout(new GridBagLayout());</span>

        // Done Button
<span class="nc" id="L1950">        JButton okButton = new JButton(PolicyTool.getMessage(&quot;Done&quot;));</span>
<span class="nc" id="L1951">        okButton.addActionListener</span>
<span class="nc" id="L1952">                (new AddEntryDoneButtonListener(tool, tw, this, edit));</span>
<span class="nc" id="L1953">        tw.addNewComponent(panel, okButton, PE_DONE_BUTTON,</span>
                           0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL,
                           ToolWindow.LR_PADDING);

        // Cancel Button
<span class="nc" id="L1958">        JButton cancelButton = new JButton(PolicyTool.getMessage(&quot;Cancel&quot;));</span>
<span class="nc" id="L1959">        ActionListener cancelListener = new CancelButtonListener(this);</span>
<span class="nc" id="L1960">        cancelButton.addActionListener(cancelListener);</span>
<span class="nc" id="L1961">        tw.addNewComponent(panel, cancelButton, PE_CANCEL_BUTTON,</span>
                           1, 0, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL,
                           ToolWindow.LR_PADDING);

        // add the panel
<span class="nc" id="L1966">        tw.addNewComponent(this, panel, PE_PANEL2,</span>
                0, 6, 2, 1, 0.0, 0.0, GridBagConstraints.VERTICAL);

<span class="nc" id="L1969">        getRootPane().setDefaultButton(okButton);</span>
<span class="nc" id="L1970">        getRootPane().registerKeyboardAction(cancelListener, escKey, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc" id="L1972">        pack();</span>
<span class="nc" id="L1973">        setLocationRelativeTo(tw);</span>
<span class="nc" id="L1974">        setVisible(true);</span>
<span class="nc" id="L1975">    }</span>

    /**
     * Read all the Policy information data in the dialog box
     * and construct a PolicyEntry object with it.
     */
    PolicyEntry getPolicyEntryFromDialog()
        throws InvalidParameterException, MalformedURLException,
        NoSuchMethodException, ClassNotFoundException, InstantiationException,
        IllegalAccessException, InvocationTargetException,
        CertificateException, IOException, Exception {

        // get the Codebase
<span class="nc" id="L1988">        JTextField tf = (JTextField)getComponent(PE_CODEBASE_TEXTFIELD);</span>
<span class="nc" id="L1989">        String codebase = null;</span>
<span class="nc bnc" id="L1990" title="All 2 branches missed.">        if (tf.getText().trim().equals(&quot;&quot;) == false)</span>
<span class="nc" id="L1991">                codebase = new String(tf.getText().trim());</span>

        // get the SignedBy
<span class="nc" id="L1994">        tf = (JTextField)getComponent(PE_SIGNEDBY_TEXTFIELD);</span>
<span class="nc" id="L1995">        String signedby = null;</span>
<span class="nc bnc" id="L1996" title="All 2 branches missed.">        if (tf.getText().trim().equals(&quot;&quot;) == false)</span>
<span class="nc" id="L1997">                signedby = new String(tf.getText().trim());</span>

        // construct a new GrantEntry
<span class="nc" id="L2000">        PolicyParser.GrantEntry ge =</span>
                        new PolicyParser.GrantEntry(signedby, codebase);

        // get the new Principals
<span class="nc" id="L2004">        LinkedList&lt;PolicyParser.PrincipalEntry&gt; prins = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L2005">        TaggedList prinList = (TaggedList)getComponent(PE_PRIN_LIST);</span>
<span class="nc bnc" id="L2006" title="All 2 branches missed.">        for (int i = 0; i &lt; prinList.getModel().getSize(); i++) {</span>
<span class="nc" id="L2007">            prins.add((PolicyParser.PrincipalEntry)prinList.getObject(i));</span>
        }
<span class="nc" id="L2009">        ge.principals = prins;</span>

        // get the new Permissions
<span class="nc" id="L2012">        Vector&lt;PolicyParser.PermissionEntry&gt; perms = new Vector&lt;&gt;();</span>
<span class="nc" id="L2013">        TaggedList permList = (TaggedList)getComponent(PE_PERM_LIST);</span>
<span class="nc bnc" id="L2014" title="All 2 branches missed.">        for (int i = 0; i &lt; permList.getModel().getSize(); i++) {</span>
<span class="nc" id="L2015">            perms.addElement((PolicyParser.PermissionEntry)permList.getObject(i));</span>
        }
<span class="nc" id="L2017">        ge.permissionEntries = perms;</span>

        // construct a new PolicyEntry object
<span class="nc" id="L2020">        PolicyEntry entry = new PolicyEntry(tool, ge);</span>

<span class="nc" id="L2022">        return entry;</span>
    }

    /**
     * display a dialog box for the user to enter KeyStore information
     */
    void keyStoreDialog(int mode) {

        // find where the PolicyTool gui is
<span class="nc" id="L2031">        Point location = tw.getLocationOnScreen();</span>
        //setBounds(location.x + 25, location.y + 100, 500, 300);
<span class="nc" id="L2033">        setLayout(new GridBagLayout());</span>

<span class="nc bnc" id="L2035" title="All 2 branches missed.">        if (mode == EDIT_KEYSTORE) {</span>

            // KeyStore label and textfield
<span class="nc" id="L2038">            JLabel label = new JLabel();</span>
<span class="nc" id="L2039">            tw.addNewComponent(this, label, KSD_NAME_LABEL,</span>
                               0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                               ToolWindow.R_BOTTOM_PADDING);
<span class="nc" id="L2042">            JTextField tf = new JTextField(tool.getKeyStoreName(), 30);</span>
<span class="nc" id="L2043">            ToolWindow.configureLabelFor(label, tf, &quot;KeyStore.URL.&quot;);</span>
<span class="nc" id="L2044">            tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>

            // URL to U R L, so that accessibility reader will pronounce well
<span class="nc" id="L2047">            tf.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L2048">                PolicyTool.getMessage(&quot;KeyStore.U.R.L.&quot;));</span>
<span class="nc" id="L2049">            tw.addNewComponent(this, tf, KSD_NAME_TEXTFIELD,</span>
                               1, 0, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                               ToolWindow.BOTTOM_PADDING);

            // KeyStore type and textfield
<span class="nc" id="L2054">            label = new JLabel();</span>
<span class="nc" id="L2055">            tw.addNewComponent(this, label, KSD_TYPE_LABEL,</span>
                               0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                               ToolWindow.R_BOTTOM_PADDING);
<span class="nc" id="L2058">            tf = new JTextField(tool.getKeyStoreType(), 30);</span>
<span class="nc" id="L2059">            ToolWindow.configureLabelFor(label, tf, &quot;KeyStore.Type.&quot;);</span>
<span class="nc" id="L2060">            tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L2061">            tf.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L2062">                PolicyTool.getMessage(&quot;KeyStore.Type.&quot;));</span>
<span class="nc" id="L2063">            tw.addNewComponent(this, tf, KSD_TYPE_TEXTFIELD,</span>
                               1, 1, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                               ToolWindow.BOTTOM_PADDING);

            // KeyStore provider and textfield
<span class="nc" id="L2068">            label = new JLabel();</span>
<span class="nc" id="L2069">            tw.addNewComponent(this, label, KSD_PROVIDER_LABEL,</span>
                               0, 2, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                               ToolWindow.R_BOTTOM_PADDING);
<span class="nc" id="L2072">            tf = new JTextField(tool.getKeyStoreProvider(), 30);</span>
<span class="nc" id="L2073">            ToolWindow.configureLabelFor(label, tf, &quot;KeyStore.Provider.&quot;);</span>
<span class="nc" id="L2074">            tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L2075">            tf.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L2076">                PolicyTool.getMessage(&quot;KeyStore.Provider.&quot;));</span>
<span class="nc" id="L2077">            tw.addNewComponent(this, tf, KSD_PROVIDER_TEXTFIELD,</span>
                               1, 2, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                               ToolWindow.BOTTOM_PADDING);

            // KeyStore password URL and textfield
<span class="nc" id="L2082">            label = new JLabel();</span>
<span class="nc" id="L2083">            tw.addNewComponent(this, label, KSD_PWD_URL_LABEL,</span>
                               0, 3, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                               ToolWindow.R_BOTTOM_PADDING);
<span class="nc" id="L2086">            tf = new JTextField(tool.getKeyStorePwdURL(), 30);</span>
<span class="nc" id="L2087">            ToolWindow.configureLabelFor(label, tf, &quot;KeyStore.Password.URL.&quot;);</span>
<span class="nc" id="L2088">            tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L2089">            tf.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L2090">                PolicyTool.getMessage(&quot;KeyStore.Password.U.R.L.&quot;));</span>
<span class="nc" id="L2091">            tw.addNewComponent(this, tf, KSD_PWD_URL_TEXTFIELD,</span>
                               1, 3, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                               ToolWindow.BOTTOM_PADDING);

            // OK button
<span class="nc" id="L2096">            JButton okButton = new JButton(PolicyTool.getMessage(&quot;OK&quot;));</span>
<span class="nc" id="L2097">            okButton.addActionListener</span>
<span class="nc" id="L2098">                        (new ChangeKeyStoreOKButtonListener(tool, tw, this));</span>
<span class="nc" id="L2099">            tw.addNewComponent(this, okButton, KSD_OK_BUTTON,</span>
                        0, 4, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL);

            // cancel button
<span class="nc" id="L2103">            JButton cancelButton = new JButton(PolicyTool.getMessage(&quot;Cancel&quot;));</span>
<span class="nc" id="L2104">            ActionListener cancelListener = new CancelButtonListener(this);</span>
<span class="nc" id="L2105">            cancelButton.addActionListener(cancelListener);</span>
<span class="nc" id="L2106">            tw.addNewComponent(this, cancelButton, KSD_CANCEL_BUTTON,</span>
                        1, 4, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL);

<span class="nc" id="L2109">            getRootPane().setDefaultButton(okButton);</span>
<span class="nc" id="L2110">            getRootPane().registerKeyboardAction(cancelListener, escKey, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>
        }

<span class="nc" id="L2113">        pack();</span>
<span class="nc" id="L2114">        setLocationRelativeTo(tw);</span>
<span class="nc" id="L2115">        setVisible(true);</span>
<span class="nc" id="L2116">    }</span>

    /**
     * display a dialog box for the user to input Principal info
     *
     * if editPolicyEntry is false, then we are adding Principals to
     * a new PolicyEntry, and we only update the GUI listing
     * with the new Principal.
     *
     * if edit is true, then we are editing an existing Policy entry.
     */
    void displayPrincipalDialog(boolean editPolicyEntry, boolean edit) {

<span class="nc" id="L2129">        PolicyParser.PrincipalEntry editMe = null;</span>

        // get the Principal selected from the Principal List
<span class="nc" id="L2132">        TaggedList prinList = (TaggedList)getComponent(PE_PRIN_LIST);</span>
<span class="nc" id="L2133">        int prinIndex = prinList.getSelectedIndex();</span>

<span class="nc bnc" id="L2135" title="All 2 branches missed.">        if (edit) {</span>
<span class="nc" id="L2136">            editMe = (PolicyParser.PrincipalEntry)prinList.getObject(prinIndex);</span>
        }

<span class="nc" id="L2139">        ToolDialog newTD = new ToolDialog</span>
<span class="nc" id="L2140">                (PolicyTool.getMessage(&quot;Principals&quot;), tool, tw, true);</span>
<span class="nc" id="L2141">        newTD.addWindowListener(new ChildWindowListener(newTD));</span>

        // find where the PolicyTool gui is
<span class="nc" id="L2144">        Point location = getLocationOnScreen();</span>
        //newTD.setBounds(location.x + 50, location.y + 100, 650, 190);
<span class="nc" id="L2146">        newTD.setLayout(new GridBagLayout());</span>
<span class="nc" id="L2147">        newTD.setResizable(true);</span>

        // description label
<span class="nc bnc" id="L2150" title="All 2 branches missed.">        JLabel label = (edit ?</span>
<span class="nc" id="L2151">                new JLabel(PolicyTool.getMessage(&quot;.Edit.Principal.&quot;)) :</span>
<span class="nc" id="L2152">                new JLabel(PolicyTool.getMessage(&quot;.Add.New.Principal.&quot;)));</span>
<span class="nc" id="L2153">        tw.addNewComponent(newTD, label, PRD_DESC_LABEL,</span>
                           0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.TOP_BOTTOM_PADDING);

        // principal choice
<span class="nc" id="L2158">        JComboBox choice = new JComboBox();</span>
<span class="nc" id="L2159">        choice.addItem(PRIN_TYPE);</span>
<span class="nc" id="L2160">        choice.getAccessibleContext().setAccessibleName(PRIN_TYPE);</span>
<span class="nc bnc" id="L2161" title="All 2 branches missed.">        for (int i = 0; i &lt; PRIN_ARRAY.size(); i++) {</span>
<span class="nc" id="L2162">            Prin next = PRIN_ARRAY.get(i);</span>
<span class="nc" id="L2163">            choice.addItem(next.CLASS);</span>
        }

<span class="nc bnc" id="L2166" title="All 2 branches missed.">        if (edit) {</span>
<span class="nc" id="L2167">            if (PolicyParser.PrincipalEntry.WILDCARD_CLASS.equals</span>
<span class="nc bnc" id="L2168" title="All 2 branches missed.">                                (editMe.getPrincipalClass())) {</span>
<span class="nc" id="L2169">                choice.setSelectedItem(PRIN_TYPE);</span>
            } else {
<span class="nc" id="L2171">                Prin inputPrin = getPrin(editMe.getPrincipalClass(), true);</span>
<span class="nc bnc" id="L2172" title="All 2 branches missed.">                if (inputPrin != null) {</span>
<span class="nc" id="L2173">                    choice.setSelectedItem(inputPrin.CLASS);</span>
                }
            }
        }
        // Add listener after selected item is set
<span class="nc" id="L2178">        choice.addItemListener(new PrincipalTypeMenuListener(newTD));</span>

<span class="nc" id="L2180">        tw.addNewComponent(newTD, choice, PRD_PRIN_CHOICE,</span>
                           0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_PADDING);

        // principal textfield
        JTextField tf;
<span class="nc bnc" id="L2186" title="All 2 branches missed.">        tf = (edit ?</span>
<span class="nc" id="L2187">                new JTextField(editMe.getDisplayClass(), 30) :</span>
                new JTextField(30));
<span class="nc" id="L2189">        tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L2190">        tf.getAccessibleContext().setAccessibleName(PRIN_TYPE);</span>
<span class="nc" id="L2191">        tw.addNewComponent(newTD, tf, PRD_PRIN_TEXTFIELD,</span>
                           1, 1, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_PADDING);

        // name label and textfield
<span class="nc" id="L2196">        label = new JLabel(PRIN_NAME);</span>
<span class="nc bnc" id="L2197" title="All 2 branches missed.">        tf = (edit ?</span>
<span class="nc" id="L2198">                new JTextField(editMe.getDisplayName(), 40) :</span>
                new JTextField(40));
<span class="nc" id="L2200">        tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L2201">        tf.getAccessibleContext().setAccessibleName(PRIN_NAME);</span>

<span class="nc" id="L2203">        tw.addNewComponent(newTD, label, PRD_NAME_LABEL,</span>
                           0, 2, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_PADDING);
<span class="nc" id="L2206">        tw.addNewComponent(newTD, tf, PRD_NAME_TEXTFIELD,</span>
                           1, 2, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_PADDING);

        // OK button
<span class="nc" id="L2211">        JButton okButton = new JButton(PolicyTool.getMessage(&quot;OK&quot;));</span>
<span class="nc" id="L2212">        okButton.addActionListener(</span>
            new NewPolicyPrinOKButtonListener
                                        (tool, tw, this, newTD, edit));
<span class="nc" id="L2215">        tw.addNewComponent(newTD, okButton, PRD_OK_BUTTON,</span>
                           0, 3, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL,
                           ToolWindow.TOP_BOTTOM_PADDING);
        // cancel button
<span class="nc" id="L2219">        JButton cancelButton = new JButton(PolicyTool.getMessage(&quot;Cancel&quot;));</span>
<span class="nc" id="L2220">        ActionListener cancelListener = new CancelButtonListener(newTD);</span>
<span class="nc" id="L2221">        cancelButton.addActionListener(cancelListener);</span>
<span class="nc" id="L2222">        tw.addNewComponent(newTD, cancelButton, PRD_CANCEL_BUTTON,</span>
                           1, 3, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL,
                           ToolWindow.TOP_BOTTOM_PADDING);

<span class="nc" id="L2226">        newTD.getRootPane().setDefaultButton(okButton);</span>
<span class="nc" id="L2227">        newTD.getRootPane().registerKeyboardAction(cancelListener, escKey, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc" id="L2229">        newTD.pack();</span>
<span class="nc" id="L2230">        newTD.setLocationRelativeTo(tw);</span>
<span class="nc" id="L2231">        newTD.setVisible(true);</span>
<span class="nc" id="L2232">    }</span>

    /**
     * display a dialog box for the user to input Permission info
     *
     * if editPolicyEntry is false, then we are adding Permissions to
     * a new PolicyEntry, and we only update the GUI listing
     * with the new Permission.
     *
     * if edit is true, then we are editing an existing Permission entry.
     */
    void displayPermissionDialog(boolean editPolicyEntry, boolean edit) {

<span class="nc" id="L2245">        PolicyParser.PermissionEntry editMe = null;</span>

        // get the Permission selected from the Permission List
<span class="nc" id="L2248">        TaggedList permList = (TaggedList)getComponent(PE_PERM_LIST);</span>
<span class="nc" id="L2249">        int permIndex = permList.getSelectedIndex();</span>

<span class="nc bnc" id="L2251" title="All 2 branches missed.">        if (edit) {</span>
<span class="nc" id="L2252">            editMe = (PolicyParser.PermissionEntry)permList.getObject(permIndex);</span>
        }

<span class="nc" id="L2255">        ToolDialog newTD = new ToolDialog</span>
<span class="nc" id="L2256">                (PolicyTool.getMessage(&quot;Permissions&quot;), tool, tw, true);</span>
<span class="nc" id="L2257">        newTD.addWindowListener(new ChildWindowListener(newTD));</span>

        // find where the PolicyTool gui is
<span class="nc" id="L2260">        Point location = getLocationOnScreen();</span>
        //newTD.setBounds(location.x + 50, location.y + 100, 700, 250);
<span class="nc" id="L2262">        newTD.setLayout(new GridBagLayout());</span>
<span class="nc" id="L2263">        newTD.setResizable(true);</span>

        // description label
<span class="nc bnc" id="L2266" title="All 2 branches missed.">        JLabel label = (edit ?</span>
<span class="nc" id="L2267">                new JLabel(PolicyTool.getMessage(&quot;.Edit.Permission.&quot;)) :</span>
<span class="nc" id="L2268">                new JLabel(PolicyTool.getMessage(&quot;.Add.New.Permission.&quot;)));</span>
<span class="nc" id="L2269">        tw.addNewComponent(newTD, label, PD_DESC_LABEL,</span>
                           0, 0, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.TOP_BOTTOM_PADDING);

        // permission choice (added in alphabetical order)
<span class="nc" id="L2274">        JComboBox choice = new JComboBox();</span>
<span class="nc" id="L2275">        choice.addItem(PERM);</span>
<span class="nc" id="L2276">        choice.getAccessibleContext().setAccessibleName(PERM);</span>
<span class="nc bnc" id="L2277" title="All 2 branches missed.">        for (int i = 0; i &lt; PERM_ARRAY.size(); i++) {</span>
<span class="nc" id="L2278">            Perm next = PERM_ARRAY.get(i);</span>
<span class="nc" id="L2279">            choice.addItem(next.CLASS);</span>
        }
<span class="nc" id="L2281">        tw.addNewComponent(newTD, choice, PD_PERM_CHOICE,</span>
                           0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_BOTTOM_PADDING);

        // permission textfield
        JTextField tf;
<span class="nc bnc" id="L2287" title="All 2 branches missed.">        tf = (edit ? new JTextField(editMe.permission, 30) : new JTextField(30));</span>
<span class="nc" id="L2288">        tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L2289">        tf.getAccessibleContext().setAccessibleName(PERM);</span>
<span class="nc bnc" id="L2290" title="All 2 branches missed.">        if (edit) {</span>
<span class="nc" id="L2291">            Perm inputPerm = getPerm(editMe.permission, true);</span>
<span class="nc bnc" id="L2292" title="All 2 branches missed.">            if (inputPerm != null) {</span>
<span class="nc" id="L2293">                choice.setSelectedItem(inputPerm.CLASS);</span>
            }
        }
<span class="nc" id="L2296">        tw.addNewComponent(newTD, tf, PD_PERM_TEXTFIELD,</span>
                           1, 1, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_BOTTOM_PADDING);
<span class="nc" id="L2299">        choice.addItemListener(new PermissionMenuListener(newTD));</span>

        // name label and textfield
<span class="nc" id="L2302">        choice = new JComboBox();</span>
<span class="nc" id="L2303">        choice.addItem(PERM_NAME);</span>
<span class="nc" id="L2304">        choice.getAccessibleContext().setAccessibleName(PERM_NAME);</span>
<span class="nc bnc" id="L2305" title="All 2 branches missed.">        tf = (edit ? new JTextField(editMe.name, 40) : new JTextField(40));</span>
<span class="nc" id="L2306">        tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L2307">        tf.getAccessibleContext().setAccessibleName(PERM_NAME);</span>
<span class="nc bnc" id="L2308" title="All 2 branches missed.">        if (edit) {</span>
<span class="nc" id="L2309">            setPermissionNames(getPerm(editMe.permission, true), choice, tf);</span>
        }
<span class="nc" id="L2311">        tw.addNewComponent(newTD, choice, PD_NAME_CHOICE,</span>
                           0, 2, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_BOTTOM_PADDING);
<span class="nc" id="L2314">        tw.addNewComponent(newTD, tf, PD_NAME_TEXTFIELD,</span>
                           1, 2, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_BOTTOM_PADDING);
<span class="nc" id="L2317">        choice.addItemListener(new PermissionNameMenuListener(newTD));</span>

        // actions label and textfield
<span class="nc" id="L2320">        choice = new JComboBox();</span>
<span class="nc" id="L2321">        choice.addItem(PERM_ACTIONS);</span>
<span class="nc" id="L2322">        choice.getAccessibleContext().setAccessibleName(PERM_ACTIONS);</span>
<span class="nc bnc" id="L2323" title="All 2 branches missed.">        tf = (edit ? new JTextField(editMe.action, 40) : new JTextField(40));</span>
<span class="nc" id="L2324">        tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L2325">        tf.getAccessibleContext().setAccessibleName(PERM_ACTIONS);</span>
<span class="nc bnc" id="L2326" title="All 2 branches missed.">        if (edit) {</span>
<span class="nc" id="L2327">            setPermissionActions(getPerm(editMe.permission, true), choice, tf);</span>
        }
<span class="nc" id="L2329">        tw.addNewComponent(newTD, choice, PD_ACTIONS_CHOICE,</span>
                           0, 3, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_BOTTOM_PADDING);
<span class="nc" id="L2332">        tw.addNewComponent(newTD, tf, PD_ACTIONS_TEXTFIELD,</span>
                           1, 3, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_BOTTOM_PADDING);
<span class="nc" id="L2335">        choice.addItemListener(new PermissionActionsMenuListener(newTD));</span>

        // signedby label and textfield
<span class="nc" id="L2338">        label = new JLabel(PolicyTool.getMessage(&quot;Signed.By.&quot;));</span>
<span class="nc" id="L2339">        tw.addNewComponent(newTD, label, PD_SIGNEDBY_LABEL,</span>
                           0, 4, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_BOTTOM_PADDING);
<span class="nc bnc" id="L2342" title="All 2 branches missed.">        tf = (edit ? new JTextField(editMe.signedBy, 40) : new JTextField(40));</span>
<span class="nc" id="L2343">        tf.setPreferredSize(new Dimension(tf.getPreferredSize().width, TEXTFIELD_HEIGHT));</span>
<span class="nc" id="L2344">        tf.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L2345">                PolicyTool.getMessage(&quot;Signed.By.&quot;));</span>
<span class="nc" id="L2346">        tw.addNewComponent(newTD, tf, PD_SIGNEDBY_TEXTFIELD,</span>
                           1, 4, 1, 1, 1.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.LR_BOTTOM_PADDING);

        // OK button
<span class="nc" id="L2351">        JButton okButton = new JButton(PolicyTool.getMessage(&quot;OK&quot;));</span>
<span class="nc" id="L2352">        okButton.addActionListener(</span>
            new NewPolicyPermOKButtonListener
                                    (tool, tw, this, newTD, edit));
<span class="nc" id="L2355">        tw.addNewComponent(newTD, okButton, PD_OK_BUTTON,</span>
                           0, 5, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL,
                           ToolWindow.TOP_BOTTOM_PADDING);

        // cancel button
<span class="nc" id="L2360">        JButton cancelButton = new JButton(PolicyTool.getMessage(&quot;Cancel&quot;));</span>
<span class="nc" id="L2361">        ActionListener cancelListener = new CancelButtonListener(newTD);</span>
<span class="nc" id="L2362">        cancelButton.addActionListener(cancelListener);</span>
<span class="nc" id="L2363">        tw.addNewComponent(newTD, cancelButton, PD_CANCEL_BUTTON,</span>
                           1, 5, 1, 1, 0.0, 0.0, GridBagConstraints.VERTICAL,
                           ToolWindow.TOP_BOTTOM_PADDING);

<span class="nc" id="L2367">        newTD.getRootPane().setDefaultButton(okButton);</span>
<span class="nc" id="L2368">        newTD.getRootPane().registerKeyboardAction(cancelListener, escKey, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc" id="L2370">        newTD.pack();</span>
<span class="nc" id="L2371">        newTD.setLocationRelativeTo(tw);</span>
<span class="nc" id="L2372">        newTD.setVisible(true);</span>
<span class="nc" id="L2373">    }</span>

    /**
     * construct a Principal object from the Principal Info Dialog Box
     */
    PolicyParser.PrincipalEntry getPrinFromDialog() throws Exception {

<span class="nc" id="L2380">        JTextField tf = (JTextField)getComponent(PRD_PRIN_TEXTFIELD);</span>
<span class="nc" id="L2381">        String pclass = new String(tf.getText().trim());</span>
<span class="nc" id="L2382">        tf = (JTextField)getComponent(PRD_NAME_TEXTFIELD);</span>
<span class="nc" id="L2383">        String pname = new String(tf.getText().trim());</span>
<span class="nc bnc" id="L2384" title="All 2 branches missed.">        if (pclass.equals(&quot;*&quot;)) {</span>
<span class="nc" id="L2385">            pclass = PolicyParser.PrincipalEntry.WILDCARD_CLASS;</span>
        }
<span class="nc bnc" id="L2387" title="All 2 branches missed.">        if (pname.equals(&quot;*&quot;)) {</span>
<span class="nc" id="L2388">            pname = PolicyParser.PrincipalEntry.WILDCARD_NAME;</span>
        }

<span class="nc" id="L2391">        PolicyParser.PrincipalEntry pppe = null;</span>

<span class="nc bnc" id="L2393" title="All 2 branches missed.">        if ((pclass.equals(PolicyParser.PrincipalEntry.WILDCARD_CLASS)) &amp;&amp;</span>
<span class="nc bnc" id="L2394" title="All 2 branches missed.">            (!pname.equals(PolicyParser.PrincipalEntry.WILDCARD_NAME))) {</span>
<span class="nc" id="L2395">            throw new Exception</span>
<span class="nc" id="L2396">                        (PolicyTool.getMessage(&quot;Cannot.Specify.Principal.with.a.Wildcard.Class.without.a.Wildcard.Name&quot;));</span>
<span class="nc bnc" id="L2397" title="All 2 branches missed.">        } else if (pname.equals(&quot;&quot;)) {</span>
<span class="nc" id="L2398">            throw new Exception</span>
<span class="nc" id="L2399">                        (PolicyTool.getMessage(&quot;Cannot.Specify.Principal.without.a.Name&quot;));</span>
<span class="nc bnc" id="L2400" title="All 2 branches missed.">        } else if (pclass.equals(&quot;&quot;)) {</span>
            // make this consistent with what PolicyParser does
            // when it sees an empty principal class
<span class="nc" id="L2403">            pclass = PolicyParser.PrincipalEntry.REPLACE_NAME;</span>
<span class="nc" id="L2404">            tool.warnings.addElement(</span>
                        &quot;Warning: Principal name '&quot; + pname +
                                &quot;' specified without a Principal class.\n&quot; +
                        &quot;\t'&quot; + pname + &quot;' will be interpreted &quot; +
                                &quot;as a key store alias.\n&quot; +
                        &quot;\tThe final principal class will be &quot; +
                                ToolDialog.X500_PRIN_CLASS + &quot;.\n&quot; +
                        &quot;\tThe final principal name will be &quot; +
                                &quot;determined by the following:\n&quot; +
                        &quot;\n&quot; +
                        &quot;\tIf the key store entry identified by '&quot;
                                + pname + &quot;'\n&quot; +
                        &quot;\tis a key entry, then the principal name will be\n&quot; +
                        &quot;\tthe subject distinguished name from the first\n&quot; +
                        &quot;\tcertificate in the entry's certificate chain.\n&quot; +
                        &quot;\n&quot; +
                        &quot;\tIf the key store entry identified by '&quot; +
                                pname + &quot;'\n&quot; +
                        &quot;\tis a trusted certificate entry, then the\n&quot; +
                        &quot;\tprincipal name will be the subject distinguished\n&quot; +
                        &quot;\tname from the trusted public key certificate.&quot;);
<span class="nc" id="L2425">            tw.displayStatusDialog(this,</span>
                        &quot;'&quot; + pname + &quot;' will be interpreted as a key &quot; +
                        &quot;store alias.  View Warning Log for details.&quot;);
        }
<span class="nc" id="L2429">        return new PolicyParser.PrincipalEntry(pclass, pname);</span>
    }


    /**
     * construct a Permission object from the Permission Info Dialog Box
     */
    PolicyParser.PermissionEntry getPermFromDialog() {

<span class="nc" id="L2438">        JTextField tf = (JTextField)getComponent(PD_PERM_TEXTFIELD);</span>
<span class="nc" id="L2439">        String permission = new String(tf.getText().trim());</span>
<span class="nc" id="L2440">        tf = (JTextField)getComponent(PD_NAME_TEXTFIELD);</span>
<span class="nc" id="L2441">        String name = null;</span>
<span class="nc bnc" id="L2442" title="All 2 branches missed.">        if (tf.getText().trim().equals(&quot;&quot;) == false)</span>
<span class="nc" id="L2443">            name = new String(tf.getText().trim());</span>
<span class="nc bnc" id="L2444" title="All 2 branches missed.">        if (permission.equals(&quot;&quot;) ||</span>
<span class="nc bnc" id="L2445" title="All 4 branches missed.">            (!permission.equals(ALL_PERM_CLASS) &amp;&amp; name == null)) {</span>
<span class="nc" id="L2446">            throw new InvalidParameterException(PolicyTool.getMessage</span>
<span class="nc" id="L2447">                (&quot;Permission.and.Target.Name.must.have.a.value&quot;));</span>
        }

        // When the permission is FilePermission, we need to check the name
        // to make sure it's not escaped. We believe --
        //
        // String             name.lastIndexOf(&quot;\\\\&quot;)
        // ----------------   ------------------------
        // c:\foo\bar         -1, legal
        // c:\\foo\\bar       2, illegal
        // \\server\share     0, legal
        // \\\\server\share   2, illegal

<span class="nc bnc" id="L2460" title="All 4 branches missed.">        if (permission.equals(FILE_PERM_CLASS) &amp;&amp; name.lastIndexOf(&quot;\\\\&quot;) &gt; 0) {</span>
<span class="nc" id="L2461">            char result = tw.displayYesNoDialog(this,</span>
<span class="nc" id="L2462">                    PolicyTool.getMessage(&quot;Warning&quot;),</span>
<span class="nc" id="L2463">                    PolicyTool.getMessage(</span>
                        &quot;Warning.File.name.may.include.escaped.backslash.characters.It.is.not.necessary.to.escape.backslash.characters.the.tool.escapes&quot;),
<span class="nc" id="L2465">                    PolicyTool.getMessage(&quot;Retain&quot;),</span>
<span class="nc" id="L2466">                    PolicyTool.getMessage(&quot;Edit&quot;)</span>
                    );
<span class="nc bnc" id="L2468" title="All 2 branches missed.">            if (result != 'Y') {</span>
                // an invisible exception
<span class="nc" id="L2470">                throw new NoDisplayException();</span>
            }
        }
        // get the Actions
<span class="nc" id="L2474">        tf = (JTextField)getComponent(PD_ACTIONS_TEXTFIELD);</span>
<span class="nc" id="L2475">        String actions = null;</span>
<span class="nc bnc" id="L2476" title="All 2 branches missed.">        if (tf.getText().trim().equals(&quot;&quot;) == false)</span>
<span class="nc" id="L2477">            actions = new String(tf.getText().trim());</span>

        // get the Signed By
<span class="nc" id="L2480">        tf = (JTextField)getComponent(PD_SIGNEDBY_TEXTFIELD);</span>
<span class="nc" id="L2481">        String signedBy = null;</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">        if (tf.getText().trim().equals(&quot;&quot;) == false)</span>
<span class="nc" id="L2483">            signedBy = new String(tf.getText().trim());</span>

<span class="nc" id="L2485">        PolicyParser.PermissionEntry pppe = new PolicyParser.PermissionEntry</span>
                                (permission, name, actions);
<span class="nc" id="L2487">        pppe.signedBy = signedBy;</span>

        // see if the signers have public keys
<span class="nc bnc" id="L2490" title="All 2 branches missed.">        if (signedBy != null) {</span>
<span class="nc" id="L2491">                String signers[] = tool.parseSigners(pppe.signedBy);</span>
<span class="nc bnc" id="L2492" title="All 2 branches missed.">                for (int i = 0; i &lt; signers.length; i++) {</span>
                try {
<span class="nc" id="L2494">                    PublicKey pubKey = tool.getPublicKeyAlias(signers[i]);</span>
<span class="nc bnc" id="L2495" title="All 2 branches missed.">                    if (pubKey == null) {</span>
<span class="nc" id="L2496">                        MessageFormat form = new MessageFormat</span>
                            (PolicyTool.getMessage
<span class="nc" id="L2498">                            (&quot;Warning.A.public.key.for.alias.signers.i.does.not.exist.Make.sure.a.KeyStore.is.properly.configured.&quot;));</span>
<span class="nc" id="L2499">                        Object[] source = {signers[i]};</span>
<span class="nc" id="L2500">                        tool.warnings.addElement(form.format(source));</span>
<span class="nc" id="L2501">                        tw.displayStatusDialog(this, form.format(source));</span>
                    }
<span class="nc" id="L2503">                } catch (Exception e) {</span>
<span class="nc" id="L2504">                    tw.displayErrorDialog(this, e);</span>
<span class="nc" id="L2505">                }</span>
            }
        }
<span class="nc" id="L2508">        return pppe;</span>
    }

    /**
     * confirm that the user REALLY wants to remove the Policy Entry
     */
    void displayConfirmRemovePolicyEntry() {

        // find the entry to be removed
<span class="nc" id="L2517">        JList list = (JList)tw.getComponent(ToolWindow.MW_POLICY_LIST);</span>
<span class="nc" id="L2518">        int index = list.getSelectedIndex();</span>
<span class="nc" id="L2519">        PolicyEntry entries[] = tool.getEntry();</span>

        // find where the PolicyTool gui is
<span class="nc" id="L2522">        Point location = tw.getLocationOnScreen();</span>
        //setBounds(location.x + 25, location.y + 100, 600, 400);
<span class="nc" id="L2524">        setLayout(new GridBagLayout());</span>

        // ask the user do they really want to do this?
<span class="nc" id="L2527">        JLabel label = new JLabel</span>
<span class="nc" id="L2528">                (PolicyTool.getMessage(&quot;Remove.this.Policy.Entry.&quot;));</span>
<span class="nc" id="L2529">        tw.addNewComponent(this, label, CRPE_LABEL1,</span>
                           0, 0, 2, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                           ToolWindow.BOTTOM_PADDING);

        // display the policy entry
<span class="nc" id="L2534">        label = new JLabel(entries[index].codebaseToString());</span>
<span class="nc" id="L2535">        tw.addNewComponent(this, label, CRPE_LABEL2,</span>
                        0, 1, 2, 1, 0.0, 0.0, GridBagConstraints.BOTH);
<span class="nc" id="L2537">        label = new JLabel(entries[index].principalsToString().trim());</span>
<span class="nc" id="L2538">        tw.addNewComponent(this, label, CRPE_LABEL2+1,</span>
                        0, 2, 2, 1, 0.0, 0.0, GridBagConstraints.BOTH);
<span class="nc" id="L2540">        Vector&lt;PolicyParser.PermissionEntry&gt; perms =</span>
<span class="nc" id="L2541">                        entries[index].getGrantEntry().permissionEntries;</span>
<span class="nc bnc" id="L2542" title="All 2 branches missed.">        for (int i = 0; i &lt; perms.size(); i++) {</span>
<span class="nc" id="L2543">            PolicyParser.PermissionEntry nextPerm = perms.elementAt(i);</span>
<span class="nc" id="L2544">            String permString = ToolDialog.PermissionEntryToUserFriendlyString(nextPerm);</span>
<span class="nc" id="L2545">            label = new JLabel(&quot;    &quot; + permString);</span>
<span class="nc bnc" id="L2546" title="All 2 branches missed.">            if (i == (perms.size()-1)) {</span>
<span class="nc" id="L2547">                tw.addNewComponent(this, label, CRPE_LABEL2 + 2 + i,</span>
                                 1, 3 + i, 1, 1, 0.0, 0.0,
                                 GridBagConstraints.BOTH,
                                 ToolWindow.BOTTOM_PADDING);
            } else {
<span class="nc" id="L2552">                tw.addNewComponent(this, label, CRPE_LABEL2 + 2 + i,</span>
                                 1, 3 + i, 1, 1, 0.0, 0.0,
                                 GridBagConstraints.BOTH);
            }
        }


        // add OK/CANCEL buttons in a new panel
<span class="nc" id="L2560">        JPanel panel = new JPanel();</span>
<span class="nc" id="L2561">        panel.setLayout(new GridBagLayout());</span>

        // OK button
<span class="nc" id="L2564">        JButton okButton = new JButton(PolicyTool.getMessage(&quot;OK&quot;));</span>
<span class="nc" id="L2565">        okButton.addActionListener</span>
<span class="nc" id="L2566">                (new ConfirmRemovePolicyEntryOKButtonListener(tool, tw, this));</span>
<span class="nc" id="L2567">        tw.addNewComponent(panel, okButton, CRPE_PANEL_OK,</span>
                           0, 0, 1, 1, 0.0, 0.0,
                           GridBagConstraints.VERTICAL, ToolWindow.LR_PADDING);

        // cancel button
<span class="nc" id="L2572">        JButton cancelButton = new JButton(PolicyTool.getMessage(&quot;Cancel&quot;));</span>
<span class="nc" id="L2573">        ActionListener cancelListener = new CancelButtonListener(this);</span>
<span class="nc" id="L2574">        cancelButton.addActionListener(cancelListener);</span>
<span class="nc" id="L2575">        tw.addNewComponent(panel, cancelButton, CRPE_PANEL_CANCEL,</span>
                           1, 0, 1, 1, 0.0, 0.0,
                           GridBagConstraints.VERTICAL, ToolWindow.LR_PADDING);

<span class="nc" id="L2579">        tw.addNewComponent(this, panel, CRPE_LABEL2 + 2 + perms.size(),</span>
<span class="nc" id="L2580">                           0, 3 + perms.size(), 2, 1, 0.0, 0.0,</span>
                           GridBagConstraints.VERTICAL, ToolWindow.TOP_BOTTOM_PADDING);

<span class="nc" id="L2583">        getRootPane().setDefaultButton(okButton);</span>
<span class="nc" id="L2584">        getRootPane().registerKeyboardAction(cancelListener, escKey, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc" id="L2586">        pack();</span>
<span class="nc" id="L2587">        setLocationRelativeTo(tw);</span>
<span class="nc" id="L2588">        setVisible(true);</span>
<span class="nc" id="L2589">    }</span>

    /**
     * perform SAVE AS
     */
    void displaySaveAsDialog(int nextEvent) {

        // pop up a dialog box for the user to enter a filename.
<span class="nc" id="L2597">        FileDialog fd = new FileDialog</span>
<span class="nc" id="L2598">                (tw, PolicyTool.getMessage(&quot;Save.As&quot;), FileDialog.SAVE);</span>
<span class="nc" id="L2599">        fd.addWindowListener(new WindowAdapter() {</span>
            public void windowClosing(WindowEvent e) {
<span class="nc" id="L2601">                e.getWindow().setVisible(false);</span>
<span class="nc" id="L2602">            }</span>
        });
<span class="nc" id="L2604">        fd.setVisible(true);</span>

        // see if the user hit cancel
<span class="nc bnc" id="L2607" title="All 2 branches missed.">        if (fd.getFile() == null ||</span>
<span class="nc bnc" id="L2608" title="All 2 branches missed.">            fd.getFile().equals(&quot;&quot;))</span>
<span class="nc" id="L2609">            return;</span>

        // get the entered filename
<span class="nc" id="L2612">        File saveAsFile = new File(fd.getDirectory(), fd.getFile());</span>
<span class="nc" id="L2613">        String filename = saveAsFile.getPath();</span>
<span class="nc" id="L2614">        fd.dispose();</span>

        try {
            // save the policy entries to a file
<span class="nc" id="L2618">            tool.savePolicy(filename);</span>

            // display status
<span class="nc" id="L2621">            MessageFormat form = new MessageFormat(PolicyTool.getMessage</span>
<span class="nc" id="L2622">                    (&quot;Policy.successfully.written.to.filename&quot;));</span>
<span class="nc" id="L2623">            Object[] source = {filename};</span>
<span class="nc" id="L2624">            tw.displayStatusDialog(null, form.format(source));</span>

            // display the new policy filename
<span class="nc" id="L2627">            JTextField newFilename = (JTextField)tw.getComponent</span>
<span class="nc" id="L2628">                            (ToolWindow.MW_FILENAME_TEXTFIELD);</span>
<span class="nc" id="L2629">            newFilename.setText(filename);</span>
<span class="nc" id="L2630">            tw.setVisible(true);</span>

            // now continue with the originally requested command
            // (QUIT, NEW, or OPEN)
<span class="nc" id="L2634">            userSaveContinue(tool, tw, this, nextEvent);</span>

<span class="nc" id="L2636">        } catch (FileNotFoundException fnfe) {</span>
<span class="nc bnc" id="L2637" title="All 4 branches missed.">            if (filename == null || filename.equals(&quot;&quot;)) {</span>
<span class="nc" id="L2638">                tw.displayErrorDialog(null, new FileNotFoundException</span>
<span class="nc" id="L2639">                            (PolicyTool.getMessage(&quot;null.filename&quot;)));</span>
            } else {
<span class="nc" id="L2641">                tw.displayErrorDialog(null, fnfe);</span>
            }
<span class="nc" id="L2643">        } catch (Exception ee) {</span>
<span class="nc" id="L2644">            tw.displayErrorDialog(null, ee);</span>
<span class="nc" id="L2645">        }</span>
<span class="nc" id="L2646">    }</span>

    /**
     * ask user if they want to save changes
     */
    void displayUserSave(int select) {

<span class="nc bnc" id="L2653" title="All 2 branches missed.">        if (tool.modified == true) {</span>

            // find where the PolicyTool gui is
<span class="nc" id="L2656">            Point location = tw.getLocationOnScreen();</span>
            //setBounds(location.x + 75, location.y + 100, 400, 150);
<span class="nc" id="L2658">            setLayout(new GridBagLayout());</span>

<span class="nc" id="L2660">            JLabel label = new JLabel</span>
<span class="nc" id="L2661">                (PolicyTool.getMessage(&quot;Save.changes.&quot;));</span>
<span class="nc" id="L2662">            tw.addNewComponent(this, label, USC_LABEL,</span>
                               0, 0, 3, 1, 0.0, 0.0, GridBagConstraints.BOTH,
                               ToolWindow.L_TOP_BOTTOM_PADDING);

<span class="nc" id="L2666">            JPanel panel = new JPanel();</span>
<span class="nc" id="L2667">            panel.setLayout(new GridBagLayout());</span>

<span class="nc" id="L2669">            JButton yesButton = new JButton();</span>
<span class="nc" id="L2670">            ToolWindow.configureButton(yesButton, &quot;Yes&quot;);</span>
<span class="nc" id="L2671">            yesButton.addActionListener</span>
<span class="nc" id="L2672">                        (new UserSaveYesButtonListener(this, tool, tw, select));</span>
<span class="nc" id="L2673">            tw.addNewComponent(panel, yesButton, USC_YES_BUTTON,</span>
                               0, 0, 1, 1, 0.0, 0.0,
                               GridBagConstraints.VERTICAL,
                               ToolWindow.LR_BOTTOM_PADDING);
<span class="nc" id="L2677">            JButton noButton = new JButton();</span>
<span class="nc" id="L2678">            ToolWindow.configureButton(noButton, &quot;No&quot;);</span>
<span class="nc" id="L2679">            noButton.addActionListener</span>
<span class="nc" id="L2680">                        (new UserSaveNoButtonListener(this, tool, tw, select));</span>
<span class="nc" id="L2681">            tw.addNewComponent(panel, noButton, USC_NO_BUTTON,</span>
                               1, 0, 1, 1, 0.0, 0.0,
                               GridBagConstraints.VERTICAL,
                               ToolWindow.LR_BOTTOM_PADDING);
<span class="nc" id="L2685">            JButton cancelButton = new JButton();</span>
<span class="nc" id="L2686">            ToolWindow.configureButton(cancelButton, &quot;Cancel&quot;);</span>
<span class="nc" id="L2687">            ActionListener cancelListener = new CancelButtonListener(this);</span>
<span class="nc" id="L2688">            cancelButton.addActionListener(cancelListener);</span>
<span class="nc" id="L2689">            tw.addNewComponent(panel, cancelButton, USC_CANCEL_BUTTON,</span>
                               2, 0, 1, 1, 0.0, 0.0,
                               GridBagConstraints.VERTICAL,
                               ToolWindow.LR_BOTTOM_PADDING);

<span class="nc" id="L2694">            tw.addNewComponent(this, panel, USC_PANEL,</span>
                               0, 1, 1, 1, 0.0, 0.0, GridBagConstraints.BOTH);

<span class="nc" id="L2697">            getRootPane().registerKeyboardAction(cancelListener, escKey, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>

<span class="nc" id="L2699">            pack();</span>
<span class="nc" id="L2700">            setLocationRelativeTo(tw);</span>
<span class="nc" id="L2701">            setVisible(true);</span>
<span class="nc" id="L2702">        } else {</span>
            // just do the original request (QUIT, NEW, or OPEN)
<span class="nc" id="L2704">            userSaveContinue(tool, tw, this, select);</span>
        }
<span class="nc" id="L2706">    }</span>

    /**
     * when the user sees the 'YES', 'NO', 'CANCEL' buttons on the
     * displayUserSave dialog, and the click on one of them,
     * we need to continue the originally requested action
     * (either QUITting, opening NEW policy file, or OPENing an existing
     * policy file.  do that now.
     */
    @SuppressWarnings(&quot;fallthrough&quot;)
    void userSaveContinue(PolicyTool tool, ToolWindow tw,
                        ToolDialog us, int select) {

        // now either QUIT, open a NEW policy file, or OPEN an existing policy
<span class="nc bnc" id="L2720" title="All 4 branches missed.">        switch(select) {</span>
        case ToolDialog.QUIT:

<span class="nc" id="L2723">            tw.setVisible(false);</span>
<span class="nc" id="L2724">            tw.dispose();</span>
<span class="nc" id="L2725">            System.exit(0);</span>

        case ToolDialog.NEW:

            try {
<span class="nc" id="L2730">                tool.openPolicy(null);</span>
<span class="nc" id="L2731">            } catch (Exception ee) {</span>
<span class="nc" id="L2732">                tool.modified = false;</span>
<span class="nc" id="L2733">                tw.displayErrorDialog(null, ee);</span>
<span class="nc" id="L2734">            }</span>

            // display the policy entries via the policy list textarea
<span class="nc" id="L2737">            JList list = new JList(new DefaultListModel());</span>
<span class="nc" id="L2738">            list.setVisibleRowCount(15);</span>
<span class="nc" id="L2739">            list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L2740">            list.addMouseListener(new PolicyListListener(tool, tw));</span>
<span class="nc" id="L2741">            tw.replacePolicyList(list);</span>

            // display null policy filename and keystore
<span class="nc" id="L2744">            JTextField newFilename = (JTextField)tw.getComponent(</span>
                    ToolWindow.MW_FILENAME_TEXTFIELD);
<span class="nc" id="L2746">            newFilename.setText(&quot;&quot;);</span>
<span class="nc" id="L2747">            tw.setVisible(true);</span>
<span class="nc" id="L2748">            break;</span>

        case ToolDialog.OPEN:

            // pop up a dialog box for the user to enter a filename.
<span class="nc" id="L2753">            FileDialog fd = new FileDialog</span>
<span class="nc" id="L2754">                (tw, PolicyTool.getMessage(&quot;Open&quot;), FileDialog.LOAD);</span>
<span class="nc" id="L2755">            fd.addWindowListener(new WindowAdapter() {</span>
                public void windowClosing(WindowEvent e) {
<span class="nc" id="L2757">                    e.getWindow().setVisible(false);</span>
<span class="nc" id="L2758">                }</span>
            });
<span class="nc" id="L2760">            fd.setVisible(true);</span>

            // see if the user hit 'cancel'
<span class="nc bnc" id="L2763" title="All 2 branches missed.">            if (fd.getFile() == null ||</span>
<span class="nc bnc" id="L2764" title="All 2 branches missed.">                fd.getFile().equals(&quot;&quot;))</span>
<span class="nc" id="L2765">                return;</span>

            // get the entered filename
<span class="nc" id="L2768">            String policyFile = new File(fd.getDirectory(), fd.getFile()).getPath();</span>

            try {
                // open the policy file
<span class="nc" id="L2772">                tool.openPolicy(policyFile);</span>

                // display the policy entries via the policy list textarea
<span class="nc" id="L2775">                DefaultListModel listModel = new DefaultListModel();</span>
<span class="nc" id="L2776">                list = new JList(listModel);</span>
<span class="nc" id="L2777">                list.setVisibleRowCount(15);</span>
<span class="nc" id="L2778">                list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L2779">                list.addMouseListener(new PolicyListListener(tool, tw));</span>
<span class="nc" id="L2780">                PolicyEntry entries[] = tool.getEntry();</span>
<span class="nc bnc" id="L2781" title="All 2 branches missed.">                if (entries != null) {</span>
<span class="nc bnc" id="L2782" title="All 2 branches missed.">                    for (int i = 0; i &lt; entries.length; i++) {</span>
<span class="nc" id="L2783">                        listModel.addElement(entries[i].headerToString());</span>
                    }
                }
<span class="nc" id="L2786">                tw.replacePolicyList(list);</span>
<span class="nc" id="L2787">                tool.modified = false;</span>

                // display the new policy filename
<span class="nc" id="L2790">                newFilename = (JTextField)tw.getComponent(</span>
                        ToolWindow.MW_FILENAME_TEXTFIELD);
<span class="nc" id="L2792">                newFilename.setText(policyFile);</span>
<span class="nc" id="L2793">                tw.setVisible(true);</span>

                // inform user of warnings
<span class="nc bnc" id="L2796" title="All 2 branches missed.">                if (tool.newWarning == true) {</span>
<span class="nc" id="L2797">                    tw.displayStatusDialog(null, PolicyTool.getMessage</span>
<span class="nc" id="L2798">                        (&quot;Errors.have.occurred.while.opening.the.policy.configuration.View.the.Warning.Log.for.more.information.&quot;));</span>
                }

<span class="nc" id="L2801">            } catch (Exception e) {</span>
                // add blank policy listing
<span class="nc" id="L2803">                list = new JList(new DefaultListModel());</span>
<span class="nc" id="L2804">                list.setVisibleRowCount(15);</span>
<span class="nc" id="L2805">                list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L2806">                list.addMouseListener(new PolicyListListener(tool, tw));</span>
<span class="nc" id="L2807">                tw.replacePolicyList(list);</span>
<span class="nc" id="L2808">                tool.setPolicyFileName(null);</span>
<span class="nc" id="L2809">                tool.modified = false;</span>

                // display a null policy filename
<span class="nc" id="L2812">                newFilename = (JTextField)tw.getComponent(</span>
                        ToolWindow.MW_FILENAME_TEXTFIELD);
<span class="nc" id="L2814">                newFilename.setText(&quot;&quot;);</span>
<span class="nc" id="L2815">                tw.setVisible(true);</span>

                // display the error
<span class="nc" id="L2818">                MessageFormat form = new MessageFormat(PolicyTool.getMessage</span>
<span class="nc" id="L2819">                    (&quot;Could.not.open.policy.file.policyFile.e.toString.&quot;));</span>
<span class="nc" id="L2820">                Object[] source = {policyFile, e.toString()};</span>
<span class="nc" id="L2821">                tw.displayErrorDialog(null, form.format(source));</span>
<span class="nc" id="L2822">            }</span>
            break;
        }
<span class="nc" id="L2825">    }</span>

    /**
     * Return a Menu list of names for a given permission
     *
     * If inputPerm's TARGETS are null, then this means TARGETS are
     * not allowed to be entered (and the TextField is set to be
     * non-editable).
     *
     * If TARGETS are valid but there are no standard ones
     * (user must enter them by hand) then the TARGETS array may be empty
     * (and of course non-null).
     */
    void setPermissionNames(Perm inputPerm, JComboBox names, JTextField field) {
<span class="nc" id="L2839">        names.removeAllItems();</span>
<span class="nc" id="L2840">        names.addItem(PERM_NAME);</span>

<span class="nc bnc" id="L2842" title="All 2 branches missed.">        if (inputPerm == null) {</span>
            // custom permission
<span class="nc" id="L2844">            field.setEditable(true);</span>
<span class="nc bnc" id="L2845" title="All 2 branches missed.">        } else if (inputPerm.TARGETS == null) {</span>
            // standard permission with no targets
<span class="nc" id="L2847">            field.setEditable(false);</span>
        } else {
            // standard permission with standard targets
<span class="nc" id="L2850">            field.setEditable(true);</span>
<span class="nc bnc" id="L2851" title="All 2 branches missed.">            for (int i = 0; i &lt; inputPerm.TARGETS.length; i++) {</span>
<span class="nc" id="L2852">                names.addItem(inputPerm.TARGETS[i]);</span>
            }
        }
<span class="nc" id="L2855">    }</span>

    /**
     * Return a Menu list of actions for a given permission
     *
     * If inputPerm's ACTIONS are null, then this means ACTIONS are
     * not allowed to be entered (and the TextField is set to be
     * non-editable).  This is typically true for BasicPermissions.
     *
     * If ACTIONS are valid but there are no standard ones
     * (user must enter them by hand) then the ACTIONS array may be empty
     * (and of course non-null).
     */
    void setPermissionActions(Perm inputPerm, JComboBox actions, JTextField field) {
<span class="nc" id="L2869">        actions.removeAllItems();</span>
<span class="nc" id="L2870">        actions.addItem(PERM_ACTIONS);</span>

<span class="nc bnc" id="L2872" title="All 2 branches missed.">        if (inputPerm == null) {</span>
            // custom permission
<span class="nc" id="L2874">            field.setEditable(true);</span>
<span class="nc bnc" id="L2875" title="All 2 branches missed.">        } else if (inputPerm.ACTIONS == null) {</span>
            // standard permission with no actions
<span class="nc" id="L2877">            field.setEditable(false);</span>
        } else {
            // standard permission with standard actions
<span class="nc" id="L2880">            field.setEditable(true);</span>
<span class="nc bnc" id="L2881" title="All 2 branches missed.">            for (int i = 0; i &lt; inputPerm.ACTIONS.length; i++) {</span>
<span class="nc" id="L2882">                actions.addItem(inputPerm.ACTIONS[i]);</span>
            }
        }
<span class="nc" id="L2885">    }</span>

    static String PermissionEntryToUserFriendlyString(PolicyParser.PermissionEntry pppe) {
<span class="nc" id="L2888">        String result = pppe.permission;</span>
<span class="nc bnc" id="L2889" title="All 2 branches missed.">        if (pppe.name != null) {</span>
<span class="nc" id="L2890">            result += &quot; &quot; + pppe.name;</span>
        }
<span class="nc bnc" id="L2892" title="All 2 branches missed.">        if (pppe.action != null) {</span>
<span class="nc" id="L2893">            result += &quot;, \&quot;&quot; + pppe.action + &quot;\&quot;&quot;;</span>
        }
<span class="nc bnc" id="L2895" title="All 2 branches missed.">        if (pppe.signedBy != null) {</span>
<span class="nc" id="L2896">            result += &quot;, signedBy &quot; + pppe.signedBy;</span>
        }
<span class="nc" id="L2898">        return result;</span>
    }

    static String PrincipalEntryToUserFriendlyString(PolicyParser.PrincipalEntry pppe) {
<span class="nc" id="L2902">        StringWriter sw = new StringWriter();</span>
<span class="nc" id="L2903">        PrintWriter pw = new PrintWriter(sw);</span>
<span class="nc" id="L2904">        pppe.write(pw);</span>
<span class="nc" id="L2905">        return sw.toString();</span>
    }
}

/**
 * Event handler for the PolicyTool window
 */
class ToolWindowListener implements WindowListener {

    private PolicyTool tool;
    private ToolWindow tw;

<span class="nc" id="L2917">    ToolWindowListener(PolicyTool tool, ToolWindow tw) {</span>
<span class="nc" id="L2918">        this.tool = tool;</span>
<span class="nc" id="L2919">        this.tw = tw;</span>
<span class="nc" id="L2920">    }</span>

    public void windowOpened(WindowEvent we) {
<span class="nc" id="L2923">    }</span>

    public void windowClosing(WindowEvent we) {
        // Closing the window acts the same as choosing Menu-&gt;Exit.

        // ask user if they want to save changes
<span class="nc" id="L2929">        ToolDialog td = new ToolDialog(PolicyTool.getMessage(&quot;Save.Changes&quot;), tool, tw, true);</span>
<span class="nc" id="L2930">        td.displayUserSave(ToolDialog.QUIT);</span>

        // the above method will perform the QUIT as long as the
        // user does not CANCEL the request
<span class="nc" id="L2934">    }</span>

    public void windowClosed(WindowEvent we) {
<span class="nc" id="L2937">        System.exit(0);</span>
<span class="nc" id="L2938">    }</span>

    public void windowIconified(WindowEvent we) {
<span class="nc" id="L2941">    }</span>

    public void windowDeiconified(WindowEvent we) {
<span class="nc" id="L2944">    }</span>

    public void windowActivated(WindowEvent we) {
<span class="nc" id="L2947">    }</span>

    public void windowDeactivated(WindowEvent we) {
<span class="nc" id="L2950">    }</span>
}

/**
 * Event handler for the Policy List
 */
class PolicyListListener extends MouseAdapter implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;

<span class="nc" id="L2961">    PolicyListListener(PolicyTool tool, ToolWindow tw) {</span>
<span class="nc" id="L2962">        this.tool = tool;</span>
<span class="nc" id="L2963">        this.tw = tw;</span>

<span class="nc" id="L2965">    }</span>

    public void actionPerformed(ActionEvent e) {

        // display the permission list for a policy entry
<span class="nc" id="L2970">        ToolDialog td = new ToolDialog</span>
<span class="nc" id="L2971">                (PolicyTool.getMessage(&quot;Policy.Entry&quot;), tool, tw, true);</span>
<span class="nc" id="L2972">        td.displayPolicyEntryDialog(true);</span>
<span class="nc" id="L2973">    }</span>

    public void mouseClicked(MouseEvent evt) {
<span class="nc bnc" id="L2976" title="All 2 branches missed.">        if (evt.getClickCount() == 2) {</span>
<span class="nc" id="L2977">            actionPerformed(null);</span>
        }
<span class="nc" id="L2979">    }</span>
}

/**
 * Event handler for the File Menu
 */
class FileMenuListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;

<span class="nc" id="L2990">    FileMenuListener(PolicyTool tool, ToolWindow tw) {</span>
<span class="nc" id="L2991">        this.tool = tool;</span>
<span class="nc" id="L2992">        this.tw = tw;</span>
<span class="nc" id="L2993">    }</span>

    public void actionPerformed(ActionEvent e) {

<span class="nc bnc" id="L2997" title="All 2 branches missed.">        if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                                       ToolWindow.QUIT) == 0) {

            // ask user if they want to save changes
<span class="nc" id="L3001">            ToolDialog td = new ToolDialog</span>
<span class="nc" id="L3002">                (PolicyTool.getMessage(&quot;Save.Changes&quot;), tool, tw, true);</span>
<span class="nc" id="L3003">            td.displayUserSave(ToolDialog.QUIT);</span>

            // the above method will perform the QUIT as long as the
            // user does not CANCEL the request

<span class="nc bnc" id="L3008" title="All 2 branches missed.">        } else if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                                   ToolWindow.NEW_POLICY_FILE) == 0) {

            // ask user if they want to save changes
<span class="nc" id="L3012">            ToolDialog td = new ToolDialog</span>
<span class="nc" id="L3013">                (PolicyTool.getMessage(&quot;Save.Changes&quot;), tool, tw, true);</span>
<span class="nc" id="L3014">            td.displayUserSave(ToolDialog.NEW);</span>

            // the above method will perform the NEW as long as the
            // user does not CANCEL the request

<span class="nc bnc" id="L3019" title="All 2 branches missed.">        } else if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                                  ToolWindow.OPEN_POLICY_FILE) == 0) {

            // ask user if they want to save changes
<span class="nc" id="L3023">            ToolDialog td = new ToolDialog</span>
<span class="nc" id="L3024">                (PolicyTool.getMessage(&quot;Save.Changes&quot;), tool, tw, true);</span>
<span class="nc" id="L3025">            td.displayUserSave(ToolDialog.OPEN);</span>

            // the above method will perform the OPEN as long as the
            // user does not CANCEL the request

<span class="nc bnc" id="L3030" title="All 2 branches missed.">        } else if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                                  ToolWindow.SAVE_POLICY_FILE) == 0) {

            // get the previously entered filename
<span class="nc" id="L3034">            String filename = ((JTextField)tw.getComponent(</span>
<span class="nc" id="L3035">                    ToolWindow.MW_FILENAME_TEXTFIELD)).getText();</span>

            // if there is no filename, do a SAVE_AS
<span class="nc bnc" id="L3038" title="All 4 branches missed.">            if (filename == null || filename.length() == 0) {</span>
                // user wants to SAVE AS
<span class="nc" id="L3040">                ToolDialog td = new ToolDialog</span>
<span class="nc" id="L3041">                        (PolicyTool.getMessage(&quot;Save.As&quot;), tool, tw, true);</span>
<span class="nc" id="L3042">                td.displaySaveAsDialog(ToolDialog.NOACTION);</span>
<span class="nc" id="L3043">            } else {</span>
                try {
                    // save the policy entries to a file
<span class="nc" id="L3046">                    tool.savePolicy(filename);</span>

                    // display status
<span class="nc" id="L3049">                    MessageFormat form = new MessageFormat</span>
                        (PolicyTool.getMessage
<span class="nc" id="L3051">                        (&quot;Policy.successfully.written.to.filename&quot;));</span>
<span class="nc" id="L3052">                    Object[] source = {filename};</span>
<span class="nc" id="L3053">                    tw.displayStatusDialog(null, form.format(source));</span>
<span class="nc" id="L3054">                } catch (FileNotFoundException fnfe) {</span>
<span class="nc bnc" id="L3055" title="All 4 branches missed.">                    if (filename == null || filename.equals(&quot;&quot;)) {</span>
<span class="nc" id="L3056">                        tw.displayErrorDialog(null, new FileNotFoundException</span>
<span class="nc" id="L3057">                                (PolicyTool.getMessage(&quot;null.filename&quot;)));</span>
                    } else {
<span class="nc" id="L3059">                        tw.displayErrorDialog(null, fnfe);</span>
                    }
<span class="nc" id="L3061">                } catch (Exception ee) {</span>
<span class="nc" id="L3062">                    tw.displayErrorDialog(null, ee);</span>
<span class="nc" id="L3063">                }</span>
            }
<span class="nc bnc" id="L3065" title="All 2 branches missed.">        } else if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                               ToolWindow.SAVE_AS_POLICY_FILE) == 0) {

            // user wants to SAVE AS
<span class="nc" id="L3069">            ToolDialog td = new ToolDialog</span>
<span class="nc" id="L3070">                (PolicyTool.getMessage(&quot;Save.As&quot;), tool, tw, true);</span>
<span class="nc" id="L3071">            td.displaySaveAsDialog(ToolDialog.NOACTION);</span>

<span class="nc bnc" id="L3073" title="All 2 branches missed.">        } else if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                                     ToolWindow.VIEW_WARNINGS) == 0) {
<span class="nc" id="L3075">            tw.displayWarningLog(null);</span>
        }
<span class="nc" id="L3077">    }</span>
}

/**
 * Event handler for the main window buttons and Edit Menu
 */
class MainWindowListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;

<span class="nc" id="L3088">    MainWindowListener(PolicyTool tool, ToolWindow tw) {</span>
<span class="nc" id="L3089">        this.tool = tool;</span>
<span class="nc" id="L3090">        this.tw = tw;</span>
<span class="nc" id="L3091">    }</span>

    public void actionPerformed(ActionEvent e) {

<span class="nc bnc" id="L3095" title="All 2 branches missed.">        if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                           ToolWindow.ADD_POLICY_ENTRY) == 0) {

            // display a dialog box for the user to enter policy info
<span class="nc" id="L3099">            ToolDialog td = new ToolDialog</span>
<span class="nc" id="L3100">                (PolicyTool.getMessage(&quot;Policy.Entry&quot;), tool, tw, true);</span>
<span class="nc" id="L3101">            td.displayPolicyEntryDialog(false);</span>

<span class="nc bnc" id="L3103" title="All 2 branches missed.">        } else if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                               ToolWindow.REMOVE_POLICY_ENTRY) == 0) {

            // get the selected entry
<span class="nc" id="L3107">            JList list = (JList)tw.getComponent(ToolWindow.MW_POLICY_LIST);</span>
<span class="nc" id="L3108">            int index = list.getSelectedIndex();</span>
<span class="nc bnc" id="L3109" title="All 2 branches missed.">            if (index &lt; 0) {</span>
<span class="nc" id="L3110">                tw.displayErrorDialog(null, new Exception</span>
<span class="nc" id="L3111">                        (PolicyTool.getMessage(&quot;No.Policy.Entry.selected&quot;)));</span>
<span class="nc" id="L3112">                return;</span>
            }

            // ask the user if they really want to remove the policy entry
<span class="nc" id="L3116">            ToolDialog td = new ToolDialog(PolicyTool.getMessage</span>
<span class="nc" id="L3117">                (&quot;Remove.Policy.Entry&quot;), tool, tw, true);</span>
<span class="nc" id="L3118">            td.displayConfirmRemovePolicyEntry();</span>

<span class="nc bnc" id="L3120" title="All 2 branches missed.">        } else if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                                 ToolWindow.EDIT_POLICY_ENTRY) == 0) {

            // get the selected entry
<span class="nc" id="L3124">            JList list = (JList)tw.getComponent(ToolWindow.MW_POLICY_LIST);</span>
<span class="nc" id="L3125">            int index = list.getSelectedIndex();</span>
<span class="nc bnc" id="L3126" title="All 2 branches missed.">            if (index &lt; 0) {</span>
<span class="nc" id="L3127">                tw.displayErrorDialog(null, new Exception</span>
<span class="nc" id="L3128">                        (PolicyTool.getMessage(&quot;No.Policy.Entry.selected&quot;)));</span>
<span class="nc" id="L3129">                return;</span>
            }

            // display the permission list for a policy entry
<span class="nc" id="L3133">            ToolDialog td = new ToolDialog</span>
<span class="nc" id="L3134">                (PolicyTool.getMessage(&quot;Policy.Entry&quot;), tool, tw, true);</span>
<span class="nc" id="L3135">            td.displayPolicyEntryDialog(true);</span>

<span class="nc bnc" id="L3137" title="All 2 branches missed.">        } else if (PolicyTool.collator.compare(e.getActionCommand(),</span>
                                     ToolWindow.EDIT_KEYSTORE) == 0) {

            // display a dialog box for the user to enter keystore info
<span class="nc" id="L3141">            ToolDialog td = new ToolDialog</span>
<span class="nc" id="L3142">                (PolicyTool.getMessage(&quot;KeyStore&quot;), tool, tw, true);</span>
<span class="nc" id="L3143">            td.keyStoreDialog(ToolDialog.EDIT_KEYSTORE);</span>
        }
<span class="nc" id="L3145">    }</span>
}

/**
 * Event handler for AddEntryDoneButton button
 *
 * -- if edit is TRUE, then we are EDITing an existing PolicyEntry
 *    and we need to update both the policy and the GUI listing.
 *    if edit is FALSE, then we are ADDing a new PolicyEntry,
 *    so we only need to update the GUI listing.
 */
class AddEntryDoneButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog td;
    private boolean edit;

    AddEntryDoneButtonListener(PolicyTool tool, ToolWindow tw,
<span class="nc" id="L3164">                                ToolDialog td, boolean edit) {</span>
<span class="nc" id="L3165">        this.tool = tool;</span>
<span class="nc" id="L3166">        this.tw = tw;</span>
<span class="nc" id="L3167">        this.td = td;</span>
<span class="nc" id="L3168">        this.edit = edit;</span>
<span class="nc" id="L3169">    }</span>

    public void actionPerformed(ActionEvent e) {

        try {
            // get a PolicyEntry object from the dialog policy info
<span class="nc" id="L3175">            PolicyEntry newEntry = td.getPolicyEntryFromDialog();</span>
<span class="nc" id="L3176">            PolicyParser.GrantEntry newGe = newEntry.getGrantEntry();</span>

            // see if all the signers have public keys
<span class="nc bnc" id="L3179" title="All 2 branches missed.">            if (newGe.signedBy != null) {</span>
<span class="nc" id="L3180">                String signers[] = tool.parseSigners(newGe.signedBy);</span>
<span class="nc bnc" id="L3181" title="All 2 branches missed.">                for (int i = 0; i &lt; signers.length; i++) {</span>
<span class="nc" id="L3182">                    PublicKey pubKey = tool.getPublicKeyAlias(signers[i]);</span>
<span class="nc bnc" id="L3183" title="All 2 branches missed.">                    if (pubKey == null) {</span>
<span class="nc" id="L3184">                        MessageFormat form = new MessageFormat</span>
                            (PolicyTool.getMessage
<span class="nc" id="L3186">                            (&quot;Warning.A.public.key.for.alias.signers.i.does.not.exist.Make.sure.a.KeyStore.is.properly.configured.&quot;));</span>
<span class="nc" id="L3187">                        Object[] source = {signers[i]};</span>
<span class="nc" id="L3188">                        tool.warnings.addElement(form.format(source));</span>
<span class="nc" id="L3189">                        tw.displayStatusDialog(td, form.format(source));</span>
                    }
                }
            }

            // add the entry
<span class="nc" id="L3195">            JList policyList = (JList)tw.getComponent(ToolWindow.MW_POLICY_LIST);</span>
<span class="nc bnc" id="L3196" title="All 2 branches missed.">            if (edit) {</span>
<span class="nc" id="L3197">                int listIndex = policyList.getSelectedIndex();</span>
<span class="nc" id="L3198">                tool.addEntry(newEntry, listIndex);</span>
<span class="nc" id="L3199">                String newCodeBaseStr = newEntry.headerToString();</span>
<span class="nc" id="L3200">                if (PolicyTool.collator.compare</span>
<span class="nc bnc" id="L3201" title="All 2 branches missed.">                        (newCodeBaseStr, policyList.getModel().getElementAt(listIndex)) != 0)</span>
<span class="nc" id="L3202">                    tool.modified = true;</span>
<span class="nc" id="L3203">                ((DefaultListModel)policyList.getModel()).set(listIndex, newCodeBaseStr);</span>
<span class="nc" id="L3204">            } else {</span>
<span class="nc" id="L3205">                tool.addEntry(newEntry, -1);</span>
<span class="nc" id="L3206">                ((DefaultListModel)policyList.getModel()).addElement(newEntry.headerToString());</span>
<span class="nc" id="L3207">                tool.modified = true;</span>
            }
<span class="nc" id="L3209">            td.setVisible(false);</span>
<span class="nc" id="L3210">            td.dispose();</span>

<span class="nc" id="L3212">        } catch (Exception eee) {</span>
<span class="nc" id="L3213">            tw.displayErrorDialog(td, eee);</span>
<span class="nc" id="L3214">        }</span>
<span class="nc" id="L3215">    }</span>
}

/**
 * Event handler for ChangeKeyStoreOKButton button
 */
class ChangeKeyStoreOKButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog td;

    ChangeKeyStoreOKButtonListener(PolicyTool tool, ToolWindow tw,
<span class="nc" id="L3228">                ToolDialog td) {</span>
<span class="nc" id="L3229">        this.tool = tool;</span>
<span class="nc" id="L3230">        this.tw = tw;</span>
<span class="nc" id="L3231">        this.td = td;</span>
<span class="nc" id="L3232">    }</span>

    public void actionPerformed(ActionEvent e) {

<span class="nc" id="L3236">        String URLString = ((JTextField)td.getComponent(</span>
<span class="nc" id="L3237">                ToolDialog.KSD_NAME_TEXTFIELD)).getText().trim();</span>
<span class="nc" id="L3238">        String type = ((JTextField)td.getComponent(</span>
<span class="nc" id="L3239">                ToolDialog.KSD_TYPE_TEXTFIELD)).getText().trim();</span>
<span class="nc" id="L3240">        String provider = ((JTextField)td.getComponent(</span>
<span class="nc" id="L3241">                ToolDialog.KSD_PROVIDER_TEXTFIELD)).getText().trim();</span>
<span class="nc" id="L3242">        String pwdURL = ((JTextField)td.getComponent(</span>
<span class="nc" id="L3243">                ToolDialog.KSD_PWD_URL_TEXTFIELD)).getText().trim();</span>

        try {
<span class="nc" id="L3246">            tool.openKeyStore</span>
<span class="nc bnc" id="L3247" title="All 2 branches missed.">                        ((URLString.length() == 0 ? null : URLString),</span>
<span class="nc bnc" id="L3248" title="All 2 branches missed.">                        (type.length() == 0 ? null : type),</span>
<span class="nc bnc" id="L3249" title="All 2 branches missed.">                        (provider.length() == 0 ? null : provider),</span>
<span class="nc bnc" id="L3250" title="All 2 branches missed.">                        (pwdURL.length() == 0 ? null : pwdURL));</span>
<span class="nc" id="L3251">            tool.modified = true;</span>
<span class="nc" id="L3252">        } catch (Exception ex) {</span>
<span class="nc" id="L3253">            MessageFormat form = new MessageFormat(PolicyTool.getMessage</span>
<span class="nc" id="L3254">                (&quot;Unable.to.open.KeyStore.ex.toString.&quot;));</span>
<span class="nc" id="L3255">            Object[] source = {ex.toString()};</span>
<span class="nc" id="L3256">            tw.displayErrorDialog(td, form.format(source));</span>
<span class="nc" id="L3257">            return;</span>
<span class="nc" id="L3258">        }</span>

<span class="nc" id="L3260">        td.dispose();</span>
<span class="nc" id="L3261">    }</span>
}

/**
 * Event handler for AddPrinButton button
 */
class AddPrinButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog td;
    private boolean editPolicyEntry;

    AddPrinButtonListener(PolicyTool tool, ToolWindow tw,
<span class="nc" id="L3275">                                ToolDialog td, boolean editPolicyEntry) {</span>
<span class="nc" id="L3276">        this.tool = tool;</span>
<span class="nc" id="L3277">        this.tw = tw;</span>
<span class="nc" id="L3278">        this.td = td;</span>
<span class="nc" id="L3279">        this.editPolicyEntry = editPolicyEntry;</span>
<span class="nc" id="L3280">    }</span>

    public void actionPerformed(ActionEvent e) {

        // display a dialog box for the user to enter principal info
<span class="nc" id="L3285">        td.displayPrincipalDialog(editPolicyEntry, false);</span>
<span class="nc" id="L3286">    }</span>
}

/**
 * Event handler for AddPermButton button
 */
class AddPermButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog td;
    private boolean editPolicyEntry;

    AddPermButtonListener(PolicyTool tool, ToolWindow tw,
<span class="nc" id="L3300">                                ToolDialog td, boolean editPolicyEntry) {</span>
<span class="nc" id="L3301">        this.tool = tool;</span>
<span class="nc" id="L3302">        this.tw = tw;</span>
<span class="nc" id="L3303">        this.td = td;</span>
<span class="nc" id="L3304">        this.editPolicyEntry = editPolicyEntry;</span>
<span class="nc" id="L3305">    }</span>

    public void actionPerformed(ActionEvent e) {

        // display a dialog box for the user to enter permission info
<span class="nc" id="L3310">        td.displayPermissionDialog(editPolicyEntry, false);</span>
<span class="nc" id="L3311">    }</span>
}

/**
 * Event handler for AddPrinOKButton button
 */
class NewPolicyPrinOKButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog listDialog;
    private ToolDialog infoDialog;
    private boolean edit;

    NewPolicyPrinOKButtonListener(PolicyTool tool,
                                ToolWindow tw,
                                ToolDialog listDialog,
                                ToolDialog infoDialog,
<span class="nc" id="L3329">                                boolean edit) {</span>
<span class="nc" id="L3330">        this.tool = tool;</span>
<span class="nc" id="L3331">        this.tw = tw;</span>
<span class="nc" id="L3332">        this.listDialog = listDialog;</span>
<span class="nc" id="L3333">        this.infoDialog = infoDialog;</span>
<span class="nc" id="L3334">        this.edit = edit;</span>
<span class="nc" id="L3335">    }</span>

    public void actionPerformed(ActionEvent e) {

        try {
            // read in the new principal info from Dialog Box
<span class="nc" id="L3341">            PolicyParser.PrincipalEntry pppe =</span>
<span class="nc" id="L3342">                        infoDialog.getPrinFromDialog();</span>
<span class="nc bnc" id="L3343" title="All 2 branches missed.">            if (pppe != null) {</span>
                try {
<span class="nc" id="L3345">                    tool.verifyPrincipal(pppe.getPrincipalClass(),</span>
<span class="nc" id="L3346">                                        pppe.getPrincipalName());</span>
<span class="nc" id="L3347">                } catch (ClassNotFoundException cnfe) {</span>
<span class="nc" id="L3348">                    MessageFormat form = new MessageFormat</span>
                                (PolicyTool.getMessage
<span class="nc" id="L3350">                                (&quot;Warning.Class.not.found.class&quot;));</span>
<span class="nc" id="L3351">                    Object[] source = {pppe.getPrincipalClass()};</span>
<span class="nc" id="L3352">                    tool.warnings.addElement(form.format(source));</span>
<span class="nc" id="L3353">                    tw.displayStatusDialog(infoDialog, form.format(source));</span>
<span class="nc" id="L3354">                }</span>

                // add the principal to the GUI principal list
<span class="nc" id="L3357">                TaggedList prinList =</span>
<span class="nc" id="L3358">                    (TaggedList)listDialog.getComponent(ToolDialog.PE_PRIN_LIST);</span>

<span class="nc" id="L3360">                String prinString = ToolDialog.PrincipalEntryToUserFriendlyString(pppe);</span>
<span class="nc bnc" id="L3361" title="All 2 branches missed.">                if (edit) {</span>
                    // if editing, replace the original principal
<span class="nc" id="L3363">                    int index = prinList.getSelectedIndex();</span>
<span class="nc" id="L3364">                    prinList.replaceTaggedItem(prinString, pppe, index);</span>
<span class="nc" id="L3365">                } else {</span>
                    // if adding, just add it to the end
<span class="nc" id="L3367">                    prinList.addTaggedItem(prinString, pppe);</span>
                }
            }
<span class="nc" id="L3370">            infoDialog.dispose();</span>
<span class="nc" id="L3371">        } catch (Exception ee) {</span>
<span class="nc" id="L3372">            tw.displayErrorDialog(infoDialog, ee);</span>
<span class="nc" id="L3373">        }</span>
<span class="nc" id="L3374">    }</span>
}

/**
 * Event handler for AddPermOKButton button
 */
class NewPolicyPermOKButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog listDialog;
    private ToolDialog infoDialog;
    private boolean edit;

    NewPolicyPermOKButtonListener(PolicyTool tool,
                                ToolWindow tw,
                                ToolDialog listDialog,
                                ToolDialog infoDialog,
<span class="nc" id="L3392">                                boolean edit) {</span>
<span class="nc" id="L3393">        this.tool = tool;</span>
<span class="nc" id="L3394">        this.tw = tw;</span>
<span class="nc" id="L3395">        this.listDialog = listDialog;</span>
<span class="nc" id="L3396">        this.infoDialog = infoDialog;</span>
<span class="nc" id="L3397">        this.edit = edit;</span>
<span class="nc" id="L3398">    }</span>

    public void actionPerformed(ActionEvent e) {

        try {
            // read in the new permission info from Dialog Box
<span class="nc" id="L3404">            PolicyParser.PermissionEntry pppe =</span>
<span class="nc" id="L3405">                        infoDialog.getPermFromDialog();</span>

            try {
<span class="nc" id="L3408">                tool.verifyPermission(pppe.permission, pppe.name, pppe.action);</span>
<span class="nc" id="L3409">            } catch (ClassNotFoundException cnfe) {</span>
<span class="nc" id="L3410">                MessageFormat form = new MessageFormat(PolicyTool.getMessage</span>
<span class="nc" id="L3411">                                (&quot;Warning.Class.not.found.class&quot;));</span>
<span class="nc" id="L3412">                Object[] source = {pppe.permission};</span>
<span class="nc" id="L3413">                tool.warnings.addElement(form.format(source));</span>
<span class="nc" id="L3414">                tw.displayStatusDialog(infoDialog, form.format(source));</span>
<span class="nc" id="L3415">            }</span>

            // add the permission to the GUI permission list
<span class="nc" id="L3418">            TaggedList permList =</span>
<span class="nc" id="L3419">                (TaggedList)listDialog.getComponent(ToolDialog.PE_PERM_LIST);</span>

<span class="nc" id="L3421">            String permString = ToolDialog.PermissionEntryToUserFriendlyString(pppe);</span>
<span class="nc bnc" id="L3422" title="All 2 branches missed.">            if (edit) {</span>
                // if editing, replace the original permission
<span class="nc" id="L3424">                int which = permList.getSelectedIndex();</span>
<span class="nc" id="L3425">                permList.replaceTaggedItem(permString, pppe, which);</span>
<span class="nc" id="L3426">            } else {</span>
                // if adding, just add it to the end
<span class="nc" id="L3428">                permList.addTaggedItem(permString, pppe);</span>
            }
<span class="nc" id="L3430">            infoDialog.dispose();</span>

<span class="nc" id="L3432">        } catch (InvocationTargetException ite) {</span>
<span class="nc" id="L3433">            tw.displayErrorDialog(infoDialog, ite.getTargetException());</span>
<span class="nc" id="L3434">        } catch (Exception ee) {</span>
<span class="nc" id="L3435">            tw.displayErrorDialog(infoDialog, ee);</span>
<span class="nc" id="L3436">        }</span>
<span class="nc" id="L3437">    }</span>
}

/**
 * Event handler for RemovePrinButton button
 */
class RemovePrinButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog td;
    private boolean edit;

    RemovePrinButtonListener(PolicyTool tool, ToolWindow tw,
<span class="nc" id="L3451">                                ToolDialog td, boolean edit) {</span>
<span class="nc" id="L3452">        this.tool = tool;</span>
<span class="nc" id="L3453">        this.tw = tw;</span>
<span class="nc" id="L3454">        this.td = td;</span>
<span class="nc" id="L3455">        this.edit = edit;</span>
<span class="nc" id="L3456">    }</span>

    public void actionPerformed(ActionEvent e) {

        // get the Principal selected from the Principal List
<span class="nc" id="L3461">        TaggedList prinList = (TaggedList)td.getComponent(</span>
                ToolDialog.PE_PRIN_LIST);
<span class="nc" id="L3463">        int prinIndex = prinList.getSelectedIndex();</span>

<span class="nc bnc" id="L3465" title="All 2 branches missed.">        if (prinIndex &lt; 0) {</span>
<span class="nc" id="L3466">            tw.displayErrorDialog(td, new Exception</span>
<span class="nc" id="L3467">                (PolicyTool.getMessage(&quot;No.principal.selected&quot;)));</span>
<span class="nc" id="L3468">            return;</span>
        }
        // remove the principal from the display
<span class="nc" id="L3471">        prinList.removeTaggedItem(prinIndex);</span>
<span class="nc" id="L3472">    }</span>
}

/**
 * Event handler for RemovePermButton button
 */
class RemovePermButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog td;
    private boolean edit;

    RemovePermButtonListener(PolicyTool tool, ToolWindow tw,
<span class="nc" id="L3486">                                ToolDialog td, boolean edit) {</span>
<span class="nc" id="L3487">        this.tool = tool;</span>
<span class="nc" id="L3488">        this.tw = tw;</span>
<span class="nc" id="L3489">        this.td = td;</span>
<span class="nc" id="L3490">        this.edit = edit;</span>
<span class="nc" id="L3491">    }</span>

    public void actionPerformed(ActionEvent e) {

        // get the Permission selected from the Permission List
<span class="nc" id="L3496">        TaggedList permList = (TaggedList)td.getComponent(</span>
                ToolDialog.PE_PERM_LIST);
<span class="nc" id="L3498">        int permIndex = permList.getSelectedIndex();</span>

<span class="nc bnc" id="L3500" title="All 2 branches missed.">        if (permIndex &lt; 0) {</span>
<span class="nc" id="L3501">            tw.displayErrorDialog(td, new Exception</span>
<span class="nc" id="L3502">                (PolicyTool.getMessage(&quot;No.permission.selected&quot;)));</span>
<span class="nc" id="L3503">            return;</span>
        }
        // remove the permission from the display
<span class="nc" id="L3506">        permList.removeTaggedItem(permIndex);</span>

<span class="nc" id="L3508">    }</span>
}

/**
 * Event handler for Edit Principal button
 *
 * We need the editPolicyEntry boolean to tell us if the user is
 * adding a new PolicyEntry at this time, or editing an existing entry.
 * If the user is adding a new PolicyEntry, we ONLY update the
 * GUI listing.  If the user is editing an existing PolicyEntry, we
 * update both the GUI listing and the actual PolicyEntry.
 */
class EditPrinButtonListener extends MouseAdapter implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog td;
    private boolean editPolicyEntry;

    EditPrinButtonListener(PolicyTool tool, ToolWindow tw,
<span class="nc" id="L3528">                                ToolDialog td, boolean editPolicyEntry) {</span>
<span class="nc" id="L3529">        this.tool = tool;</span>
<span class="nc" id="L3530">        this.tw = tw;</span>
<span class="nc" id="L3531">        this.td = td;</span>
<span class="nc" id="L3532">        this.editPolicyEntry = editPolicyEntry;</span>
<span class="nc" id="L3533">    }</span>

    public void actionPerformed(ActionEvent e) {

        // get the Principal selected from the Principal List
<span class="nc" id="L3538">        TaggedList list = (TaggedList)td.getComponent(</span>
                ToolDialog.PE_PRIN_LIST);
<span class="nc" id="L3540">        int prinIndex = list.getSelectedIndex();</span>

<span class="nc bnc" id="L3542" title="All 2 branches missed.">        if (prinIndex &lt; 0) {</span>
<span class="nc" id="L3543">            tw.displayErrorDialog(td, new Exception</span>
<span class="nc" id="L3544">                (PolicyTool.getMessage(&quot;No.principal.selected&quot;)));</span>
<span class="nc" id="L3545">            return;</span>
        }
<span class="nc" id="L3547">        td.displayPrincipalDialog(editPolicyEntry, true);</span>
<span class="nc" id="L3548">    }</span>

    public void mouseClicked(MouseEvent evt) {
<span class="nc bnc" id="L3551" title="All 2 branches missed.">        if (evt.getClickCount() == 2) {</span>
<span class="nc" id="L3552">            actionPerformed(null);</span>
        }
<span class="nc" id="L3554">    }</span>
}

/**
 * Event handler for Edit Permission button
 *
 * We need the editPolicyEntry boolean to tell us if the user is
 * adding a new PolicyEntry at this time, or editing an existing entry.
 * If the user is adding a new PolicyEntry, we ONLY update the
 * GUI listing.  If the user is editing an existing PolicyEntry, we
 * update both the GUI listing and the actual PolicyEntry.
 */
class EditPermButtonListener extends MouseAdapter implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog td;
    private boolean editPolicyEntry;

    EditPermButtonListener(PolicyTool tool, ToolWindow tw,
<span class="nc" id="L3574">                                ToolDialog td, boolean editPolicyEntry) {</span>
<span class="nc" id="L3575">        this.tool = tool;</span>
<span class="nc" id="L3576">        this.tw = tw;</span>
<span class="nc" id="L3577">        this.td = td;</span>
<span class="nc" id="L3578">        this.editPolicyEntry = editPolicyEntry;</span>
<span class="nc" id="L3579">    }</span>

    public void actionPerformed(ActionEvent e) {

        // get the Permission selected from the Permission List
<span class="nc" id="L3584">        JList list = (JList)td.getComponent(ToolDialog.PE_PERM_LIST);</span>
<span class="nc" id="L3585">        int permIndex = list.getSelectedIndex();</span>

<span class="nc bnc" id="L3587" title="All 2 branches missed.">        if (permIndex &lt; 0) {</span>
<span class="nc" id="L3588">            tw.displayErrorDialog(td, new Exception</span>
<span class="nc" id="L3589">                (PolicyTool.getMessage(&quot;No.permission.selected&quot;)));</span>
<span class="nc" id="L3590">            return;</span>
        }
<span class="nc" id="L3592">        td.displayPermissionDialog(editPolicyEntry, true);</span>
<span class="nc" id="L3593">    }</span>

    public void mouseClicked(MouseEvent evt) {
<span class="nc bnc" id="L3596" title="All 2 branches missed.">        if (evt.getClickCount() == 2) {</span>
<span class="nc" id="L3597">            actionPerformed(null);</span>
        }
<span class="nc" id="L3599">    }</span>
}

/**
 * Event handler for Principal Popup Menu
 */
class PrincipalTypeMenuListener implements ItemListener {

    private ToolDialog td;

<span class="nc" id="L3609">    PrincipalTypeMenuListener(ToolDialog td) {</span>
<span class="nc" id="L3610">        this.td = td;</span>
<span class="nc" id="L3611">    }</span>

    public void itemStateChanged(ItemEvent e) {
<span class="nc bnc" id="L3614" title="All 2 branches missed.">        if (e.getStateChange() == ItemEvent.DESELECTED) {</span>
            // We're only interested in SELECTED events
<span class="nc" id="L3616">            return;</span>
        }

<span class="nc" id="L3619">        JComboBox prin = (JComboBox)td.getComponent(ToolDialog.PRD_PRIN_CHOICE);</span>
<span class="nc" id="L3620">        JTextField prinField = (JTextField)td.getComponent(</span>
                ToolDialog.PRD_PRIN_TEXTFIELD);
<span class="nc" id="L3622">        JTextField nameField = (JTextField)td.getComponent(</span>
                ToolDialog.PRD_NAME_TEXTFIELD);

<span class="nc" id="L3625">        prin.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L3626">            PolicyTool.splitToWords((String)e.getItem()));</span>
<span class="nc bnc" id="L3627" title="All 2 branches missed.">        if (((String)e.getItem()).equals(ToolDialog.PRIN_TYPE)) {</span>
            // ignore if they choose &quot;Principal Type:&quot; item
<span class="nc bnc" id="L3629" title="All 2 branches missed.">            if (prinField.getText() != null &amp;&amp;</span>
<span class="nc bnc" id="L3630" title="All 2 branches missed.">                prinField.getText().length() &gt; 0) {</span>
<span class="nc" id="L3631">                Prin inputPrin = ToolDialog.getPrin(prinField.getText(), true);</span>
<span class="nc" id="L3632">                prin.setSelectedItem(inputPrin.CLASS);</span>
            }
<span class="nc" id="L3634">            return;</span>
        }

        // if you change the principal, clear the name
<span class="nc bnc" id="L3638" title="All 2 branches missed.">        if (prinField.getText().indexOf((String)e.getItem()) == -1) {</span>
<span class="nc" id="L3639">            nameField.setText(&quot;&quot;);</span>
        }

        // set the text in the textfield and also modify the
        // pull-down choice menus to reflect the correct possible
        // set of names and actions
<span class="nc" id="L3645">        Prin inputPrin = ToolDialog.getPrin((String)e.getItem(), false);</span>
<span class="nc bnc" id="L3646" title="All 2 branches missed.">        if (inputPrin != null) {</span>
<span class="nc" id="L3647">            prinField.setText(inputPrin.FULL_CLASS);</span>
        }
<span class="nc" id="L3649">    }</span>
}

/**
 * Event handler for Permission Popup Menu
 */
class PermissionMenuListener implements ItemListener {

    private ToolDialog td;

<span class="nc" id="L3659">    PermissionMenuListener(ToolDialog td) {</span>
<span class="nc" id="L3660">        this.td = td;</span>
<span class="nc" id="L3661">    }</span>

    public void itemStateChanged(ItemEvent e) {
<span class="nc bnc" id="L3664" title="All 2 branches missed.">        if (e.getStateChange() == ItemEvent.DESELECTED) {</span>
            // We're only interested in SELECTED events
<span class="nc" id="L3666">            return;</span>
        }

<span class="nc" id="L3669">        JComboBox perms = (JComboBox)td.getComponent(</span>
                ToolDialog.PD_PERM_CHOICE);
<span class="nc" id="L3671">        JComboBox names = (JComboBox)td.getComponent(</span>
                ToolDialog.PD_NAME_CHOICE);
<span class="nc" id="L3673">        JComboBox actions = (JComboBox)td.getComponent(</span>
                ToolDialog.PD_ACTIONS_CHOICE);
<span class="nc" id="L3675">        JTextField nameField = (JTextField)td.getComponent(</span>
                ToolDialog.PD_NAME_TEXTFIELD);
<span class="nc" id="L3677">        JTextField actionsField = (JTextField)td.getComponent(</span>
                ToolDialog.PD_ACTIONS_TEXTFIELD);
<span class="nc" id="L3679">        JTextField permField = (JTextField)td.getComponent(</span>
                ToolDialog.PD_PERM_TEXTFIELD);
<span class="nc" id="L3681">        JTextField signedbyField = (JTextField)td.getComponent(</span>
                ToolDialog.PD_SIGNEDBY_TEXTFIELD);

<span class="nc" id="L3684">        perms.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L3685">            PolicyTool.splitToWords((String)e.getItem()));</span>

        // ignore if they choose the 'Permission:' item
<span class="nc bnc" id="L3688" title="All 2 branches missed.">        if (PolicyTool.collator.compare((String)e.getItem(),</span>
                                      ToolDialog.PERM) == 0) {
<span class="nc bnc" id="L3690" title="All 2 branches missed.">            if (permField.getText() != null &amp;&amp;</span>
<span class="nc bnc" id="L3691" title="All 2 branches missed.">                permField.getText().length() &gt; 0) {</span>

<span class="nc" id="L3693">                Perm inputPerm = ToolDialog.getPerm(permField.getText(), true);</span>
<span class="nc bnc" id="L3694" title="All 2 branches missed.">                if (inputPerm != null) {</span>
<span class="nc" id="L3695">                    perms.setSelectedItem(inputPerm.CLASS);</span>
                }
            }
<span class="nc" id="L3698">            return;</span>
        }

        // if you change the permission, clear the name, actions, and signedBy
<span class="nc bnc" id="L3702" title="All 2 branches missed.">        if (permField.getText().indexOf((String)e.getItem()) == -1) {</span>
<span class="nc" id="L3703">            nameField.setText(&quot;&quot;);</span>
<span class="nc" id="L3704">            actionsField.setText(&quot;&quot;);</span>
<span class="nc" id="L3705">            signedbyField.setText(&quot;&quot;);</span>
        }

        // set the text in the textfield and also modify the
        // pull-down choice menus to reflect the correct possible
        // set of names and actions

<span class="nc" id="L3712">        Perm inputPerm = ToolDialog.getPerm((String)e.getItem(), false);</span>
<span class="nc bnc" id="L3713" title="All 2 branches missed.">        if (inputPerm == null) {</span>
<span class="nc" id="L3714">            permField.setText(&quot;&quot;);</span>
        } else {
<span class="nc" id="L3716">            permField.setText(inputPerm.FULL_CLASS);</span>
        }
<span class="nc" id="L3718">        td.setPermissionNames(inputPerm, names, nameField);</span>
<span class="nc" id="L3719">        td.setPermissionActions(inputPerm, actions, actionsField);</span>
<span class="nc" id="L3720">    }</span>
}

/**
 * Event handler for Permission Name Popup Menu
 */
class PermissionNameMenuListener implements ItemListener {

    private ToolDialog td;

<span class="nc" id="L3730">    PermissionNameMenuListener(ToolDialog td) {</span>
<span class="nc" id="L3731">        this.td = td;</span>
<span class="nc" id="L3732">    }</span>

    public void itemStateChanged(ItemEvent e) {
<span class="nc bnc" id="L3735" title="All 2 branches missed.">        if (e.getStateChange() == ItemEvent.DESELECTED) {</span>
            // We're only interested in SELECTED events
<span class="nc" id="L3737">            return;</span>
        }

<span class="nc" id="L3740">        JComboBox names = (JComboBox)td.getComponent(ToolDialog.PD_NAME_CHOICE);</span>
<span class="nc" id="L3741">        names.getAccessibleContext().setAccessibleName(</span>
<span class="nc" id="L3742">            PolicyTool.splitToWords((String)e.getItem()));</span>

<span class="nc bnc" id="L3744" title="All 2 branches missed.">        if (((String)e.getItem()).indexOf(ToolDialog.PERM_NAME) != -1)</span>
<span class="nc" id="L3745">            return;</span>

<span class="nc" id="L3747">        JTextField tf = (JTextField)td.getComponent(ToolDialog.PD_NAME_TEXTFIELD);</span>
<span class="nc" id="L3748">        tf.setText((String)e.getItem());</span>
<span class="nc" id="L3749">    }</span>
}

/**
 * Event handler for Permission Actions Popup Menu
 */
class PermissionActionsMenuListener implements ItemListener {

    private ToolDialog td;

<span class="nc" id="L3759">    PermissionActionsMenuListener(ToolDialog td) {</span>
<span class="nc" id="L3760">        this.td = td;</span>
<span class="nc" id="L3761">    }</span>

    public void itemStateChanged(ItemEvent e) {
<span class="nc bnc" id="L3764" title="All 2 branches missed.">        if (e.getStateChange() == ItemEvent.DESELECTED) {</span>
            // We're only interested in SELECTED events
<span class="nc" id="L3766">            return;</span>
        }

<span class="nc" id="L3769">        JComboBox actions = (JComboBox)td.getComponent(</span>
                ToolDialog.PD_ACTIONS_CHOICE);
<span class="nc" id="L3771">        actions.getAccessibleContext().setAccessibleName((String)e.getItem());</span>

<span class="nc bnc" id="L3773" title="All 2 branches missed.">        if (((String)e.getItem()).indexOf(ToolDialog.PERM_ACTIONS) != -1)</span>
<span class="nc" id="L3774">            return;</span>

<span class="nc" id="L3776">        JTextField tf = (JTextField)td.getComponent(</span>
                ToolDialog.PD_ACTIONS_TEXTFIELD);
<span class="nc bnc" id="L3778" title="All 4 branches missed.">        if (tf.getText() == null || tf.getText().equals(&quot;&quot;)) {</span>
<span class="nc" id="L3779">            tf.setText((String)e.getItem());</span>
        } else {
<span class="nc bnc" id="L3781" title="All 2 branches missed.">            if (tf.getText().indexOf((String)e.getItem()) == -1)</span>
<span class="nc" id="L3782">                tf.setText(tf.getText() + &quot;, &quot; + (String)e.getItem());</span>
        }
<span class="nc" id="L3784">    }</span>
}

/**
 * Event handler for all the children dialogs/windows
 */
class ChildWindowListener implements WindowListener {

    private ToolDialog td;

<span class="nc" id="L3794">    ChildWindowListener(ToolDialog td) {</span>
<span class="nc" id="L3795">        this.td = td;</span>
<span class="nc" id="L3796">    }</span>

    public void windowOpened(WindowEvent we) {
<span class="nc" id="L3799">    }</span>

    public void windowClosing(WindowEvent we) {
        // same as pressing the &quot;cancel&quot; button
<span class="nc" id="L3803">        td.setVisible(false);</span>
<span class="nc" id="L3804">        td.dispose();</span>
<span class="nc" id="L3805">    }</span>

    public void windowClosed(WindowEvent we) {
<span class="nc" id="L3808">    }</span>

    public void windowIconified(WindowEvent we) {
<span class="nc" id="L3811">    }</span>

    public void windowDeiconified(WindowEvent we) {
<span class="nc" id="L3814">    }</span>

    public void windowActivated(WindowEvent we) {
<span class="nc" id="L3817">    }</span>

    public void windowDeactivated(WindowEvent we) {
<span class="nc" id="L3820">    }</span>
}

/**
 * Event handler for CancelButton button
 */
class CancelButtonListener implements ActionListener {

    private ToolDialog td;

<span class="nc" id="L3830">    CancelButtonListener(ToolDialog td) {</span>
<span class="nc" id="L3831">        this.td = td;</span>
<span class="nc" id="L3832">    }</span>

    public void actionPerformed(ActionEvent e) {
<span class="nc" id="L3835">        td.setVisible(false);</span>
<span class="nc" id="L3836">        td.dispose();</span>
<span class="nc" id="L3837">    }</span>
}

/**
 * Event handler for ErrorOKButton button
 */
class ErrorOKButtonListener implements ActionListener {

    private ToolDialog ed;

<span class="nc" id="L3847">    ErrorOKButtonListener(ToolDialog ed) {</span>
<span class="nc" id="L3848">        this.ed = ed;</span>
<span class="nc" id="L3849">    }</span>

    public void actionPerformed(ActionEvent e) {
<span class="nc" id="L3852">        ed.setVisible(false);</span>
<span class="nc" id="L3853">        ed.dispose();</span>
<span class="nc" id="L3854">    }</span>
}

/**
 * Event handler for StatusOKButton button
 */
class StatusOKButtonListener implements ActionListener {

    private ToolDialog sd;

<span class="nc" id="L3864">    StatusOKButtonListener(ToolDialog sd) {</span>
<span class="nc" id="L3865">        this.sd = sd;</span>
<span class="nc" id="L3866">    }</span>

    public void actionPerformed(ActionEvent e) {
<span class="nc" id="L3869">        sd.setVisible(false);</span>
<span class="nc" id="L3870">        sd.dispose();</span>
<span class="nc" id="L3871">    }</span>
}

/**
 * Event handler for UserSaveYes button
 */
class UserSaveYesButtonListener implements ActionListener {

    private ToolDialog us;
    private PolicyTool tool;
    private ToolWindow tw;
    private int select;

    UserSaveYesButtonListener(ToolDialog us, PolicyTool tool,
<span class="nc" id="L3885">                        ToolWindow tw, int select) {</span>
<span class="nc" id="L3886">        this.us = us;</span>
<span class="nc" id="L3887">        this.tool = tool;</span>
<span class="nc" id="L3888">        this.tw = tw;</span>
<span class="nc" id="L3889">        this.select = select;</span>
<span class="nc" id="L3890">    }</span>

    public void actionPerformed(ActionEvent e) {

        // first get rid of the window
<span class="nc" id="L3895">        us.setVisible(false);</span>
<span class="nc" id="L3896">        us.dispose();</span>

        try {
<span class="nc" id="L3899">            String filename = ((JTextField)tw.getComponent(</span>
<span class="nc" id="L3900">                    ToolWindow.MW_FILENAME_TEXTFIELD)).getText();</span>
<span class="nc bnc" id="L3901" title="All 4 branches missed.">            if (filename == null || filename.equals(&quot;&quot;)) {</span>
<span class="nc" id="L3902">                us.displaySaveAsDialog(select);</span>

                // the above dialog will continue with the originally
                // requested command if necessary
            } else {
                // save the policy entries to a file
<span class="nc" id="L3908">                tool.savePolicy(filename);</span>

                // display status
<span class="nc" id="L3911">                MessageFormat form = new MessageFormat</span>
                        (PolicyTool.getMessage
<span class="nc" id="L3913">                        (&quot;Policy.successfully.written.to.filename&quot;));</span>
<span class="nc" id="L3914">                Object[] source = {filename};</span>
<span class="nc" id="L3915">                tw.displayStatusDialog(null, form.format(source));</span>

                // now continue with the originally requested command
                // (QUIT, NEW, or OPEN)
<span class="nc" id="L3919">                us.userSaveContinue(tool, tw, us, select);</span>
            }
<span class="nc" id="L3921">        } catch (Exception ee) {</span>
            // error -- just report it and bail
<span class="nc" id="L3923">            tw.displayErrorDialog(null, ee);</span>
<span class="nc" id="L3924">        }</span>
<span class="nc" id="L3925">    }</span>
}

/**
 * Event handler for UserSaveNoButton
 */
class UserSaveNoButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog us;
    private int select;

    UserSaveNoButtonListener(ToolDialog us, PolicyTool tool,
<span class="nc" id="L3939">                        ToolWindow tw, int select) {</span>
<span class="nc" id="L3940">        this.us = us;</span>
<span class="nc" id="L3941">        this.tool = tool;</span>
<span class="nc" id="L3942">        this.tw = tw;</span>
<span class="nc" id="L3943">        this.select = select;</span>
<span class="nc" id="L3944">    }</span>

    public void actionPerformed(ActionEvent e) {
<span class="nc" id="L3947">        us.setVisible(false);</span>
<span class="nc" id="L3948">        us.dispose();</span>

        // now continue with the originally requested command
        // (QUIT, NEW, or OPEN)
<span class="nc" id="L3952">        us.userSaveContinue(tool, tw, us, select);</span>
<span class="nc" id="L3953">    }</span>
}

/**
 * Event handler for UserSaveCancelButton
 */
class UserSaveCancelButtonListener implements ActionListener {

    private ToolDialog us;

<span class="nc" id="L3963">    UserSaveCancelButtonListener(ToolDialog us) {</span>
<span class="nc" id="L3964">        this.us = us;</span>
<span class="nc" id="L3965">    }</span>

    public void actionPerformed(ActionEvent e) {
<span class="nc" id="L3968">        us.setVisible(false);</span>
<span class="nc" id="L3969">        us.dispose();</span>

        // do NOT continue with the originally requested command
        // (QUIT, NEW, or OPEN)
<span class="nc" id="L3973">    }</span>
}

/**
 * Event handler for ConfirmRemovePolicyEntryOKButtonListener
 */
class ConfirmRemovePolicyEntryOKButtonListener implements ActionListener {

    private PolicyTool tool;
    private ToolWindow tw;
    private ToolDialog us;

    ConfirmRemovePolicyEntryOKButtonListener(PolicyTool tool,
<span class="nc" id="L3986">                                ToolWindow tw, ToolDialog us) {</span>
<span class="nc" id="L3987">        this.tool = tool;</span>
<span class="nc" id="L3988">        this.tw = tw;</span>
<span class="nc" id="L3989">        this.us = us;</span>
<span class="nc" id="L3990">    }</span>

    public void actionPerformed(ActionEvent e) {
        // remove the entry
<span class="nc" id="L3994">        JList list = (JList)tw.getComponent(ToolWindow.MW_POLICY_LIST);</span>
<span class="nc" id="L3995">        int index = list.getSelectedIndex();</span>
<span class="nc" id="L3996">        PolicyEntry entries[] = tool.getEntry();</span>
<span class="nc" id="L3997">        tool.removeEntry(entries[index]);</span>

        // redraw the window listing
<span class="nc" id="L4000">        DefaultListModel listModel = new DefaultListModel();</span>
<span class="nc" id="L4001">        list = new JList(listModel);</span>
<span class="nc" id="L4002">        list.setVisibleRowCount(15);</span>
<span class="nc" id="L4003">        list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L4004">        list.addMouseListener(new PolicyListListener(tool, tw));</span>
<span class="nc" id="L4005">        entries = tool.getEntry();</span>
<span class="nc bnc" id="L4006" title="All 2 branches missed.">        if (entries != null) {</span>
<span class="nc bnc" id="L4007" title="All 2 branches missed.">                for (int i = 0; i &lt; entries.length; i++) {</span>
<span class="nc" id="L4008">                    listModel.addElement(entries[i].headerToString());</span>
                }
        }
<span class="nc" id="L4011">        tw.replacePolicyList(list);</span>
<span class="nc" id="L4012">        us.setVisible(false);</span>
<span class="nc" id="L4013">        us.dispose();</span>
<span class="nc" id="L4014">    }</span>
}

/**
 * Just a special name, so that the codes dealing with this exception knows
 * it's special, and does not pop out a warning box.
 */
<span class="nc" id="L4021">class NoDisplayException extends RuntimeException {</span>
    private static final long serialVersionUID = -4611761427108719794L;
}

/**
 * This is a java.awt.List that bind an Object to each String it holds.
 */
class TaggedList extends JList {
    private static final long serialVersionUID = -5676238110427785853L;

<span class="nc" id="L4031">    private java.util.List&lt;Object&gt; data = new LinkedList&lt;&gt;();</span>
    public TaggedList(int i, boolean b) {
<span class="nc" id="L4033">        super(new DefaultListModel());</span>
<span class="nc" id="L4034">        setVisibleRowCount(i);</span>
<span class="nc bnc" id="L4035" title="All 2 branches missed.">        setSelectionMode(b ? ListSelectionModel.MULTIPLE_INTERVAL_SELECTION : ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L4036">    }</span>

    public Object getObject(int index) {
<span class="nc" id="L4039">        return data.get(index);</span>
    }

    public void addTaggedItem(String string, Object object) {
<span class="nc" id="L4043">        ((DefaultListModel)getModel()).addElement(string);</span>
<span class="nc" id="L4044">        data.add(object);</span>
<span class="nc" id="L4045">    }</span>

    public void replaceTaggedItem(String string, Object object, int index) {
<span class="nc" id="L4048">        ((DefaultListModel)getModel()).set(index, string);</span>
<span class="nc" id="L4049">        data.set(index, object);</span>
<span class="nc" id="L4050">    }</span>

    public void removeTaggedItem(int index) {
<span class="nc" id="L4053">        ((DefaultListModel)getModel()).remove(index);</span>
<span class="nc" id="L4054">        data.remove(index);</span>
<span class="nc" id="L4055">    }</span>
}

/**
 * Convenience Principal Classes
 */

class Prin {
    public final String CLASS;
    public final String FULL_CLASS;

<span class="nc" id="L4066">    public Prin(String clazz, String fullClass) {</span>
<span class="nc" id="L4067">        this.CLASS = clazz;</span>
<span class="nc" id="L4068">        this.FULL_CLASS = fullClass;</span>
<span class="nc" id="L4069">    }</span>
}

class KrbPrin extends Prin {
    public KrbPrin() {
<span class="nc" id="L4074">        super(&quot;KerberosPrincipal&quot;,</span>
                &quot;javax.security.auth.kerberos.KerberosPrincipal&quot;);
<span class="nc" id="L4076">    }</span>
}

class X500Prin extends Prin {
    public X500Prin() {
<span class="nc" id="L4081">        super(&quot;X500Principal&quot;,</span>
                &quot;javax.security.auth.x500.X500Principal&quot;);
<span class="nc" id="L4083">    }</span>
}

/**
 * Convenience Permission Classes
 */

class Perm {
    public final String CLASS;
    public final String FULL_CLASS;
    public final String[] TARGETS;
    public final String[] ACTIONS;

    public Perm(String clazz, String fullClass,
<span class="nc" id="L4097">                String[] targets, String[] actions) {</span>

<span class="nc" id="L4099">        this.CLASS = clazz;</span>
<span class="nc" id="L4100">        this.FULL_CLASS = fullClass;</span>
<span class="nc" id="L4101">        this.TARGETS = targets;</span>
<span class="nc" id="L4102">        this.ACTIONS = actions;</span>
<span class="nc" id="L4103">    }</span>
}

class AllPerm extends Perm {
    public AllPerm() {
<span class="nc" id="L4108">        super(&quot;AllPermission&quot;, &quot;java.security.AllPermission&quot;, null, null);</span>
<span class="nc" id="L4109">    }</span>
}

class AudioPerm extends Perm {
    public AudioPerm() {
<span class="nc" id="L4114">        super(&quot;AudioPermission&quot;,</span>
        &quot;javax.sound.sampled.AudioPermission&quot;,
        new String[]    {
                &quot;play&quot;,
                &quot;record&quot;
                },
        null);
<span class="nc" id="L4121">    }</span>
}

class AuthPerm extends Perm {
    public AuthPerm() {
<span class="nc" id="L4126">    super(&quot;AuthPermission&quot;,</span>
        &quot;javax.security.auth.AuthPermission&quot;,
        new String[]    {
                &quot;doAs&quot;,
                &quot;doAsPrivileged&quot;,
                &quot;getSubject&quot;,
                &quot;getSubjectFromDomainCombiner&quot;,
                &quot;setReadOnly&quot;,
                &quot;modifyPrincipals&quot;,
                &quot;modifyPublicCredentials&quot;,
                &quot;modifyPrivateCredentials&quot;,
                &quot;refreshCredential&quot;,
                &quot;destroyCredential&quot;,
<span class="nc" id="L4139">                &quot;createLoginContext.&lt;&quot; + PolicyTool.getMessage(&quot;name&quot;) + &quot;&gt;&quot;,</span>
                &quot;getLoginConfiguration&quot;,
                &quot;setLoginConfiguration&quot;,
                &quot;createLoginConfiguration.&lt;&quot; +
<span class="nc" id="L4143">                        PolicyTool.getMessage(&quot;configuration.type&quot;) + &quot;&gt;&quot;,</span>
                &quot;refreshLoginConfiguration&quot;
                },
        null);
<span class="nc" id="L4147">    }</span>
}

class AWTPerm extends Perm {
    public AWTPerm() {
<span class="nc" id="L4152">    super(&quot;AWTPermission&quot;,</span>
        &quot;java.awt.AWTPermission&quot;,
        new String[]    {
                &quot;accessClipboard&quot;,
                &quot;accessEventQueue&quot;,
                &quot;accessSystemTray&quot;,
                &quot;createRobot&quot;,
                &quot;fullScreenExclusive&quot;,
                &quot;listenToAllAWTEvents&quot;,
                &quot;readDisplayPixels&quot;,
                &quot;replaceKeyboardFocusManager&quot;,
                &quot;setAppletStub&quot;,
                &quot;setWindowAlwaysOnTop&quot;,
                &quot;showWindowWithoutWarningBanner&quot;,
                &quot;toolkitModality&quot;,
                &quot;watchMousePointer&quot;
        },
        null);
<span class="nc" id="L4170">    }</span>
}

class DelegationPerm extends Perm {
    public DelegationPerm() {
<span class="nc" id="L4175">    super(&quot;DelegationPermission&quot;,</span>
        &quot;javax.security.auth.kerberos.DelegationPermission&quot;,
        new String[]    {
                // allow user input
                },
        null);
<span class="nc" id="L4181">    }</span>
}

class FilePerm extends Perm {
    public FilePerm() {
<span class="nc" id="L4186">    super(&quot;FilePermission&quot;,</span>
        &quot;java.io.FilePermission&quot;,
        new String[]    {
                &quot;&lt;&lt;ALL FILES&gt;&gt;&quot;
                },
        new String[]    {
                &quot;read&quot;,
                &quot;write&quot;,
                &quot;delete&quot;,
                &quot;execute&quot;
                });
<span class="nc" id="L4197">    }</span>
}

class URLPerm extends Perm {
    public URLPerm() {
<span class="nc" id="L4202">        super(&quot;URLPermission&quot;,</span>
                &quot;java.net.URLPermission&quot;,
                new String[]    {
<span class="nc" id="L4205">                    &quot;&lt;&quot;+ PolicyTool.getMessage(&quot;url&quot;) + &quot;&gt;&quot;,</span>
                },
                new String[]    {
<span class="nc" id="L4208">                    &quot;&lt;&quot; + PolicyTool.getMessage(&quot;method.list&quot;) + &quot;&gt;:&lt;&quot;</span>
<span class="nc" id="L4209">                        + PolicyTool.getMessage(&quot;request.headers.list&quot;) + &quot;&gt;&quot;,</span>
                });
<span class="nc" id="L4211">    }</span>
}

class InqSecContextPerm extends Perm {
    public InqSecContextPerm() {
<span class="nc" id="L4216">    super(&quot;InquireSecContextPermission&quot;,</span>
        &quot;com.sun.security.jgss.InquireSecContextPermission&quot;,
        new String[]    {
                &quot;KRB5_GET_SESSION_KEY&quot;,
                &quot;KRB5_GET_TKT_FLAGS&quot;,
                &quot;KRB5_GET_AUTHZ_DATA&quot;,
                &quot;KRB5_GET_AUTHTIME&quot;
                },
        null);
<span class="nc" id="L4225">    }</span>
}

class LogPerm extends Perm {
    public LogPerm() {
<span class="nc" id="L4230">    super(&quot;LoggingPermission&quot;,</span>
        &quot;java.util.logging.LoggingPermission&quot;,
        new String[]    {
                &quot;control&quot;
                },
        null);
<span class="nc" id="L4236">    }</span>
}

class MgmtPerm extends Perm {
    public MgmtPerm() {
<span class="nc" id="L4241">    super(&quot;ManagementPermission&quot;,</span>
        &quot;java.lang.management.ManagementPermission&quot;,
        new String[]    {
                &quot;control&quot;,
                &quot;monitor&quot;
                },
        null);
<span class="nc" id="L4248">    }</span>
}

class MBeanPerm extends Perm {
    public MBeanPerm() {
<span class="nc" id="L4253">    super(&quot;MBeanPermission&quot;,</span>
        &quot;javax.management.MBeanPermission&quot;,
        new String[]    {
                // allow user input
                },
        new String[]    {
                &quot;addNotificationListener&quot;,
                &quot;getAttribute&quot;,
                &quot;getClassLoader&quot;,
                &quot;getClassLoaderFor&quot;,
                &quot;getClassLoaderRepository&quot;,
                &quot;getDomains&quot;,
                &quot;getMBeanInfo&quot;,
                &quot;getObjectInstance&quot;,
                &quot;instantiate&quot;,
                &quot;invoke&quot;,
                &quot;isInstanceOf&quot;,
                &quot;queryMBeans&quot;,
                &quot;queryNames&quot;,
                &quot;registerMBean&quot;,
                &quot;removeNotificationListener&quot;,
                &quot;setAttribute&quot;,
                &quot;unregisterMBean&quot;
                });
<span class="nc" id="L4277">    }</span>
}

class MBeanSvrPerm extends Perm {
    public MBeanSvrPerm() {
<span class="nc" id="L4282">    super(&quot;MBeanServerPermission&quot;,</span>
        &quot;javax.management.MBeanServerPermission&quot;,
        new String[]    {
                &quot;createMBeanServer&quot;,
                &quot;findMBeanServer&quot;,
                &quot;newMBeanServer&quot;,
                &quot;releaseMBeanServer&quot;
                },
        null);
<span class="nc" id="L4291">    }</span>
}

class MBeanTrustPerm extends Perm {
    public MBeanTrustPerm() {
<span class="nc" id="L4296">    super(&quot;MBeanTrustPermission&quot;,</span>
        &quot;javax.management.MBeanTrustPermission&quot;,
        new String[]    {
                &quot;register&quot;
                },
        null);
<span class="nc" id="L4302">    }</span>
}

class NetPerm extends Perm {
    public NetPerm() {
<span class="nc" id="L4307">    super(&quot;NetPermission&quot;,</span>
        &quot;java.net.NetPermission&quot;,
        new String[]    {
                &quot;setDefaultAuthenticator&quot;,
                &quot;requestPasswordAuthentication&quot;,
                &quot;specifyStreamHandler&quot;,
                &quot;setProxySelector&quot;,
                &quot;getProxySelector&quot;,
                &quot;setCookieHandler&quot;,
                &quot;getCookieHandler&quot;,
                &quot;setResponseCache&quot;,
                &quot;getResponseCache&quot;
                },
        null);
<span class="nc" id="L4321">    }</span>
}

class PrivCredPerm extends Perm {
    public PrivCredPerm() {
<span class="nc" id="L4326">    super(&quot;PrivateCredentialPermission&quot;,</span>
        &quot;javax.security.auth.PrivateCredentialPermission&quot;,
        new String[]    {
                // allow user input
                },
        new String[]    {
                &quot;read&quot;
                });
<span class="nc" id="L4334">    }</span>
}

class PropPerm extends Perm {
    public PropPerm() {
<span class="nc" id="L4339">    super(&quot;PropertyPermission&quot;,</span>
        &quot;java.util.PropertyPermission&quot;,
        new String[]    {
                // allow user input
                },
        new String[]    {
                &quot;read&quot;,
                &quot;write&quot;
                });
<span class="nc" id="L4348">    }</span>
}

class ReflectPerm extends Perm {
    public ReflectPerm() {
<span class="nc" id="L4353">    super(&quot;ReflectPermission&quot;,</span>
        &quot;java.lang.reflect.ReflectPermission&quot;,
        new String[]    {
                &quot;suppressAccessChecks&quot;
                },
        null);
<span class="nc" id="L4359">    }</span>
}

class RuntimePerm extends Perm {
    public RuntimePerm() {
<span class="nc" id="L4364">    super(&quot;RuntimePermission&quot;,</span>
        &quot;java.lang.RuntimePermission&quot;,
        new String[]    {
                &quot;createClassLoader&quot;,
                &quot;getClassLoader&quot;,
                &quot;setContextClassLoader&quot;,
                &quot;enableContextClassLoaderOverride&quot;,
                &quot;setSecurityManager&quot;,
                &quot;createSecurityManager&quot;,
                &quot;getenv.&lt;&quot; +
<span class="nc" id="L4374">                    PolicyTool.getMessage(&quot;environment.variable.name&quot;) + &quot;&gt;&quot;,</span>
                &quot;exitVM&quot;,
                &quot;shutdownHooks&quot;,
                &quot;setFactory&quot;,
                &quot;setIO&quot;,
                &quot;modifyThread&quot;,
                &quot;stopThread&quot;,
                &quot;modifyThreadGroup&quot;,
                &quot;getProtectionDomain&quot;,
                &quot;readFileDescriptor&quot;,
                &quot;writeFileDescriptor&quot;,
                &quot;loadLibrary.&lt;&quot; +
<span class="nc" id="L4386">                    PolicyTool.getMessage(&quot;library.name&quot;) + &quot;&gt;&quot;,</span>
                &quot;accessClassInPackage.&lt;&quot; +
<span class="nc" id="L4388">                    PolicyTool.getMessage(&quot;package.name&quot;)+&quot;&gt;&quot;,</span>
                &quot;defineClassInPackage.&lt;&quot; +
<span class="nc" id="L4390">                    PolicyTool.getMessage(&quot;package.name&quot;)+&quot;&gt;&quot;,</span>
                &quot;accessDeclaredMembers&quot;,
                &quot;queuePrintJob&quot;,
                &quot;getStackTrace&quot;,
                &quot;setDefaultUncaughtExceptionHandler&quot;,
                &quot;preferences&quot;,
                &quot;usePolicy&quot;,
                // &quot;inheritedChannel&quot;
                },
        null);
<span class="nc" id="L4400">    }</span>
}

class SecurityPerm extends Perm {
    public SecurityPerm() {
<span class="nc" id="L4405">    super(&quot;SecurityPermission&quot;,</span>
        &quot;java.security.SecurityPermission&quot;,
        new String[]    {
                &quot;createAccessControlContext&quot;,
                &quot;getDomainCombiner&quot;,
                &quot;getPolicy&quot;,
                &quot;setPolicy&quot;,
                &quot;createPolicy.&lt;&quot; +
<span class="nc" id="L4413">                    PolicyTool.getMessage(&quot;policy.type&quot;) + &quot;&gt;&quot;,</span>
                &quot;getProperty.&lt;&quot; +
<span class="nc" id="L4415">                    PolicyTool.getMessage(&quot;property.name&quot;) + &quot;&gt;&quot;,</span>
                &quot;setProperty.&lt;&quot; +
<span class="nc" id="L4417">                    PolicyTool.getMessage(&quot;property.name&quot;) + &quot;&gt;&quot;,</span>
                &quot;insertProvider.&lt;&quot; +
<span class="nc" id="L4419">                    PolicyTool.getMessage(&quot;provider.name&quot;) + &quot;&gt;&quot;,</span>
                &quot;removeProvider.&lt;&quot; +
<span class="nc" id="L4421">                    PolicyTool.getMessage(&quot;provider.name&quot;) + &quot;&gt;&quot;,</span>
                //&quot;setSystemScope&quot;,
                //&quot;setIdentityPublicKey&quot;,
                //&quot;setIdentityInfo&quot;,
                //&quot;addIdentityCertificate&quot;,
                //&quot;removeIdentityCertificate&quot;,
                //&quot;printIdentity&quot;,
                &quot;clearProviderProperties.&lt;&quot; +
<span class="nc" id="L4429">                    PolicyTool.getMessage(&quot;provider.name&quot;) + &quot;&gt;&quot;,</span>
                &quot;putProviderProperty.&lt;&quot; +
<span class="nc" id="L4431">                    PolicyTool.getMessage(&quot;provider.name&quot;) + &quot;&gt;&quot;,</span>
                &quot;removeProviderProperty.&lt;&quot; +
<span class="nc" id="L4433">                    PolicyTool.getMessage(&quot;provider.name&quot;) + &quot;&gt;&quot;,</span>
                //&quot;getSignerPrivateKey&quot;,
                //&quot;setSignerKeyPair&quot;
                },
        null);
<span class="nc" id="L4438">    }</span>
}

class SerialPerm extends Perm {
    public SerialPerm() {
<span class="nc" id="L4443">    super(&quot;SerializablePermission&quot;,</span>
        &quot;java.io.SerializablePermission&quot;,
        new String[]    {
                &quot;enableSubclassImplementation&quot;,
                &quot;enableSubstitution&quot;
                },
        null);
<span class="nc" id="L4450">    }</span>
}

class ServicePerm extends Perm {
    public ServicePerm() {
<span class="nc" id="L4455">    super(&quot;ServicePermission&quot;,</span>
        &quot;javax.security.auth.kerberos.ServicePermission&quot;,
        new String[]    {
                // allow user input
                },
        new String[]    {
                &quot;initiate&quot;,
                &quot;accept&quot;
                });
<span class="nc" id="L4464">    }</span>
}

class SocketPerm extends Perm {
    public SocketPerm() {
<span class="nc" id="L4469">    super(&quot;SocketPermission&quot;,</span>
        &quot;java.net.SocketPermission&quot;,
        new String[]    {
                // allow user input
                },
        new String[]    {
                &quot;accept&quot;,
                &quot;connect&quot;,
                &quot;listen&quot;,
                &quot;resolve&quot;
                });
<span class="nc" id="L4480">    }</span>
}

class SQLPerm extends Perm {
    public SQLPerm() {
<span class="nc" id="L4485">    super(&quot;SQLPermission&quot;,</span>
        &quot;java.sql.SQLPermission&quot;,
        new String[]    {
                &quot;setLog&quot;,
                &quot;callAbort&quot;,
                &quot;setSyncFactory&quot;,
                &quot;setNetworkTimeout&quot;,
                },
        null);
<span class="nc" id="L4494">    }</span>
}

class SSLPerm extends Perm {
    public SSLPerm() {
<span class="nc" id="L4499">    super(&quot;SSLPermission&quot;,</span>
        &quot;javax.net.ssl.SSLPermission&quot;,
        new String[]    {
                &quot;setHostnameVerifier&quot;,
                &quot;getSSLSessionContext&quot;
                },
        null);
<span class="nc" id="L4506">    }</span>
}

class SubjDelegPerm extends Perm {
    public SubjDelegPerm() {
<span class="nc" id="L4511">    super(&quot;SubjectDelegationPermission&quot;,</span>
        &quot;javax.management.remote.SubjectDelegationPermission&quot;,
        new String[]    {
                // allow user input
                },
        null);
<span class="nc" id="L4517">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>