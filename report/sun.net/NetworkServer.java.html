<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>NetworkServer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.net</a> &gt; <span class="el_source">NetworkServer.java</span></div><h1>NetworkServer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1995, 2011, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */
package sun.net;

import java.io.*;
import java.net.Socket;
import java.net.ServerSocket;

/**
 * This is the base class for network servers.  To define a new type
 * of server define a new subclass of NetworkServer with a serviceRequest
 * method that services one request.  Start the server by executing:
 * &lt;pre&gt;
 *      new MyServerClass().startServer(port);
 * &lt;/pre&gt;
 */
public class NetworkServer implements Runnable, Cloneable {
    /** Socket for communicating with client. */
<span class="nc" id="L41">    public Socket clientSocket = null;</span>
    private Thread serverInstance;
    private ServerSocket serverSocket;

    /** Stream for printing to the client. */
    public PrintStream clientOutput;

    /** Buffered stream for reading replies from client. */
    public InputStream clientInput;

    /** Close an open connection to the client. */
    public void close() throws IOException {
<span class="nc" id="L53">        clientSocket.close();</span>
<span class="nc" id="L54">        clientSocket = null;</span>
<span class="nc" id="L55">        clientInput = null;</span>
<span class="nc" id="L56">        clientOutput = null;</span>
<span class="nc" id="L57">    }</span>

    /** Return client connection status */
    public boolean clientIsOpen() {
<span class="nc bnc" id="L61" title="All 2 branches missed.">        return clientSocket != null;</span>
    }

    final public void run() {
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (serverSocket != null) {</span>
<span class="nc" id="L66">            Thread.currentThread().setPriority(Thread.MAX_PRIORITY);</span>
            // System.out.print(&quot;Server starts &quot; + serverSocket + &quot;\n&quot;);
            while (true) {
                try {
<span class="nc" id="L70">                    Socket ns = serverSocket.accept();</span>
//                  System.out.print(&quot;New connection &quot; + ns + &quot;\n&quot;);
<span class="nc" id="L72">                    NetworkServer n = (NetworkServer)clone();</span>
<span class="nc" id="L73">                    n.serverSocket = null;</span>
<span class="nc" id="L74">                    n.clientSocket = ns;</span>
<span class="nc" id="L75">                    new Thread(n).start();</span>
<span class="nc" id="L76">                } catch(Exception e) {</span>
<span class="nc" id="L77">                    System.out.print(&quot;Server failure\n&quot;);</span>
<span class="nc" id="L78">                    e.printStackTrace();</span>
                    try {
<span class="nc" id="L80">                        serverSocket.close();</span>
<span class="nc" id="L81">                    } catch(IOException e2) {}</span>
<span class="nc" id="L82">                    System.out.print(&quot;cs=&quot;+serverSocket+&quot;\n&quot;);</span>
<span class="nc" id="L83">                    break;</span>
<span class="nc" id="L84">                }</span>
            }
//          close();
        } else {
            try {
<span class="nc" id="L89">                clientOutput = new PrintStream(</span>
<span class="nc" id="L90">                        new BufferedOutputStream(clientSocket.getOutputStream()),</span>
                                               false, &quot;ISO8859_1&quot;);
<span class="nc" id="L92">                clientInput = new BufferedInputStream(clientSocket.getInputStream());</span>
<span class="nc" id="L93">                serviceRequest();</span>
                // System.out.print(&quot;Service handler exits
                // &quot;+clientSocket+&quot;\n&quot;);
<span class="nc" id="L96">            } catch(Exception e) {</span>
                // System.out.print(&quot;Service handler failure\n&quot;);
                // e.printStackTrace();
<span class="nc" id="L99">            }</span>
            try {
<span class="nc" id="L101">                close();</span>
<span class="nc" id="L102">            } catch(IOException e2) {}</span>
        }
<span class="nc" id="L104">    }</span>

    /** Start a server on port &lt;i&gt;port&lt;/i&gt;.  It will call serviceRequest()
        for each new connection. */
    final public void startServer(int port) throws IOException {
<span class="nc" id="L109">        serverSocket = new ServerSocket(port, 50);</span>
<span class="nc" id="L110">        serverInstance = new Thread(this);</span>
<span class="nc" id="L111">        serverInstance.start();</span>
<span class="nc" id="L112">    }</span>

    /** Service one request.  It is invoked with the clientInput and
        clientOutput streams initialized.  This method handles one client
        connection. When it is done, it can simply exit. The default
        server just echoes it's input. It is invoked in it's own private
        thread. */
    public void serviceRequest() throws IOException {
<span class="nc" id="L120">        byte buf[] = new byte[300];</span>
        int n;
<span class="nc" id="L122">        clientOutput.print(&quot;Echo server &quot; + getClass().getName() + &quot;\n&quot;);</span>
<span class="nc" id="L123">        clientOutput.flush();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        while ((n = clientInput.read(buf, 0, buf.length)) &gt;= 0) {</span>
<span class="nc" id="L125">            clientOutput.write(buf, 0, n);</span>
        }
<span class="nc" id="L127">    }</span>

    public static void main(String argv[]) {
        try {
<span class="nc" id="L131">            new NetworkServer ().startServer(8888);</span>
<span class="nc" id="L132">        } catch (IOException e) {</span>
<span class="nc" id="L133">            System.out.print(&quot;Server failed: &quot;+e+&quot;\n&quot;);</span>
<span class="nc" id="L134">        }</span>
<span class="nc" id="L135">    }</span>

    /**
     * Clone this object;
     */
    public Object clone() {
        try {
<span class="nc" id="L142">            return super.clone();</span>
<span class="nc" id="L143">        } catch (CloneNotSupportedException e) {</span>
            // this shouldn't happen, since we are Cloneable
<span class="nc" id="L145">            throw new InternalError(e);</span>
        }
    }

<span class="nc" id="L149">    public NetworkServer () {</span>
<span class="nc" id="L150">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>