<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>UTF_32Coder.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.nio.cs</a> &gt; <span class="el_source">UTF_32Coder.java</span></div><h1>UTF_32Coder.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.nio.cs;

import java.nio.ByteBuffer;
import java.nio.CharBuffer;
import java.nio.charset.Charset;
import java.nio.charset.CoderResult;
import java.nio.charset.CharsetDecoder;
import java.nio.charset.CharsetEncoder;

<span class="nc" id="L35">class UTF_32Coder {</span>
    protected static final int BOM_BIG = 0xFEFF;
    protected static final int BOM_LITTLE = 0xFFFE0000;
    protected static final int NONE = 0;
    protected static final int BIG = 1;
    protected static final int LITTLE = 2;

    protected static class Decoder extends CharsetDecoder {
        private int currentBO;
        private int expectedBO;

        protected Decoder(Charset cs, int bo) {
<span class="fc" id="L47">            super(cs, 0.25f, 1.0f);</span>
<span class="fc" id="L48">            this.expectedBO = bo;</span>
<span class="fc" id="L49">            this.currentBO = NONE;</span>
<span class="fc" id="L50">        }</span>

        private int getCP(ByteBuffer src) {
<span class="fc bfc" id="L53" title="All 2 branches covered.">            return (currentBO==BIG)</span>
<span class="fc" id="L54">              ?(((src.get() &amp; 0xff) &lt;&lt; 24) |</span>
<span class="fc" id="L55">                ((src.get() &amp; 0xff) &lt;&lt; 16) |</span>
<span class="fc" id="L56">                ((src.get() &amp; 0xff) &lt;&lt;  8) |</span>
<span class="fc" id="L57">                (src.get() &amp; 0xff))</span>
<span class="fc" id="L58">              :((src.get() &amp; 0xff) |</span>
<span class="fc" id="L59">                ((src.get() &amp; 0xff) &lt;&lt;  8) |</span>
<span class="fc" id="L60">                ((src.get() &amp; 0xff) &lt;&lt; 16) |</span>
<span class="fc" id="L61">                ((src.get() &amp; 0xff) &lt;&lt; 24));</span>
        }

        protected CoderResult decodeLoop(ByteBuffer src, CharBuffer dst) {
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">            if (src.remaining() &lt; 4)</span>
<span class="nc" id="L66">                return CoderResult.UNDERFLOW;</span>
<span class="fc" id="L67">            int mark = src.position();</span>
            int cp;
            try {
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">                if (currentBO == NONE) {</span>
<span class="fc" id="L71">                    cp = ((src.get() &amp; 0xff) &lt;&lt; 24) |</span>
<span class="fc" id="L72">                         ((src.get() &amp; 0xff) &lt;&lt; 16) |</span>
<span class="fc" id="L73">                         ((src.get() &amp; 0xff) &lt;&lt;  8) |</span>
<span class="fc" id="L74">                         (src.get() &amp; 0xff);</span>
<span class="pc bpc" id="L75" title="3 of 4 branches missed.">                    if (cp == BOM_BIG &amp;&amp; expectedBO != LITTLE) {</span>
<span class="nc" id="L76">                        currentBO = BIG;</span>
<span class="nc" id="L77">                        mark += 4;</span>
<span class="pc bpc" id="L78" title="3 of 4 branches missed.">                    } else if (cp == BOM_LITTLE &amp;&amp; expectedBO != BIG) {</span>
<span class="nc" id="L79">                        currentBO = LITTLE;</span>
<span class="nc" id="L80">                        mark += 4;</span>
                    } else {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">                        if (expectedBO == NONE)</span>
<span class="nc" id="L83">                            currentBO = BIG;</span>
                        else
<span class="fc" id="L85">                            currentBO = expectedBO;</span>
<span class="fc" id="L86">                        src.position(mark);</span>
                    }
                }
<span class="fc bfc" id="L89" title="All 2 branches covered.">                while (src.remaining() &gt;= 4) {</span>
<span class="fc" id="L90">                    cp = getCP(src);</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">                    if (Character.isBmpCodePoint(cp)) {</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">                        if (!dst.hasRemaining())</span>
<span class="nc" id="L93">                            return CoderResult.OVERFLOW;</span>
<span class="fc" id="L94">                        mark += 4;</span>
<span class="fc" id="L95">                        dst.put((char) cp);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                    } else if (Character.isValidCodePoint(cp)) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">                        if (dst.remaining() &lt; 2)</span>
<span class="nc" id="L98">                            return CoderResult.OVERFLOW;</span>
<span class="nc" id="L99">                        mark += 4;</span>
<span class="nc" id="L100">                        dst.put(Character.highSurrogate(cp));</span>
<span class="nc" id="L101">                        dst.put(Character.lowSurrogate(cp));</span>
                    } else {
<span class="nc" id="L103">                        return CoderResult.malformedForLength(4);</span>
                    }
                }
<span class="fc" id="L106">                return CoderResult.UNDERFLOW;</span>
            } finally {
<span class="pc" id="L108">                src.position(mark);</span>
            }
        }
        protected void implReset() {
<span class="nc" id="L112">            currentBO = NONE;</span>
<span class="nc" id="L113">        }</span>
    }

<span class="nc" id="L116">    protected static class Encoder extends CharsetEncoder {</span>
<span class="fc" id="L117">        private boolean doBOM = false;</span>
<span class="fc" id="L118">        private boolean doneBOM = true;</span>
        private int byteOrder;

        protected void put(int cp, ByteBuffer dst) {
<span class="fc bfc" id="L122" title="All 2 branches covered.">            if (byteOrder==BIG) {</span>
<span class="fc" id="L123">                dst.put((byte)(cp &gt;&gt; 24));</span>
<span class="fc" id="L124">                dst.put((byte)(cp &gt;&gt; 16));</span>
<span class="fc" id="L125">                dst.put((byte)(cp &gt;&gt; 8));</span>
<span class="fc" id="L126">                dst.put((byte)cp);</span>
            } else {
<span class="fc" id="L128">                dst.put((byte)cp);</span>
<span class="fc" id="L129">                dst.put((byte)(cp &gt;&gt;  8));</span>
<span class="fc" id="L130">                dst.put((byte)(cp &gt;&gt; 16));</span>
<span class="fc" id="L131">                dst.put((byte)(cp &gt;&gt; 24));</span>
            }
<span class="fc" id="L133">        }</span>

        protected Encoder(Charset cs, int byteOrder, boolean doBOM) {
<span class="pc bpc" id="L136" title="1 of 4 branches missed.">            super(cs, 4.0f,</span>
                  doBOM?8.0f:4.0f,
                  (byteOrder==BIG)?new byte[]{(byte)0, (byte)0, (byte)0xff, (byte)0xfd}
                                  :new byte[]{(byte)0xfd, (byte)0xff, (byte)0, (byte)0});
<span class="fc" id="L140">            this.byteOrder = byteOrder;</span>
<span class="fc" id="L141">            this.doBOM = doBOM;</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">            this.doneBOM = !doBOM;</span>
<span class="fc" id="L143">        }</span>

        protected CoderResult encodeLoop(CharBuffer src, ByteBuffer dst) {
<span class="fc" id="L146">            int mark = src.position();</span>
<span class="pc bpc" id="L147" title="3 of 4 branches missed.">            if (!doneBOM &amp;&amp; src.hasRemaining()) {</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                if (dst.remaining() &lt; 4)</span>
<span class="nc" id="L149">                    return CoderResult.OVERFLOW;</span>
<span class="nc" id="L150">                put(BOM_BIG, dst);</span>
<span class="nc" id="L151">                doneBOM = true;</span>
            }
            try {
<span class="fc bfc" id="L154" title="All 2 branches covered.">                while (src.hasRemaining()) {</span>
<span class="fc" id="L155">                    char c = src.get();</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">                    if (!Character.isSurrogate(c)) {</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">                        if (dst.remaining() &lt; 4)</span>
<span class="nc" id="L158">                            return CoderResult.OVERFLOW;</span>
<span class="fc" id="L159">                        mark++;</span>
<span class="fc" id="L160">                        put(c, dst);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                    } else if (Character.isHighSurrogate(c)) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                        if (!src.hasRemaining())</span>
<span class="nc" id="L163">                            return CoderResult.UNDERFLOW;</span>
<span class="nc" id="L164">                        char low = src.get();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                        if (Character.isLowSurrogate(low)) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                            if (dst.remaining() &lt; 4)</span>
<span class="nc" id="L167">                                return CoderResult.OVERFLOW;</span>
<span class="nc" id="L168">                            mark += 2;</span>
<span class="nc" id="L169">                            put(Character.toCodePoint(c, low), dst);</span>
                        } else {
<span class="nc" id="L171">                            return CoderResult.malformedForLength(1);</span>
                        }
<span class="nc" id="L173">                    } else {</span>
                        // assert Character.isLowSurrogate(c);
<span class="nc" id="L175">                        return CoderResult.malformedForLength(1);</span>
                    }
<span class="fc" id="L177">                }</span>
<span class="fc" id="L178">                return CoderResult.UNDERFLOW;</span>
            } finally {
<span class="pc" id="L180">                src.position(mark);</span>
            }
        }

        protected void implReset() {
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">            doneBOM = !doBOM;</span>
<span class="fc" id="L186">        }</span>

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>