<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>AppletPanel.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.applet</a> &gt; <span class="el_source">AppletPanel.java</span></div><h1>AppletPanel.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1995, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.applet;

import java.applet.*;
import java.awt.*;
import java.awt.event.*;
import java.awt.image.ColorModel;
import java.awt.image.MemoryImageSource;
import java.io.*;
import java.lang.ref.WeakReference;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.net.InetAddress;
import java.net.JarURLConnection;
import java.net.MalformedURLException;
import java.net.SocketPermission;
import java.net.URL;
import java.net.UnknownHostException;
import java.security.*;
import java.util.*;
import java.util.Collections;
import java.util.Locale;
import java.util.WeakHashMap;
import sun.awt.AWTAccessor;
import sun.awt.AppContext;
import sun.awt.EmbeddedFrame;
import sun.awt.SunToolkit;
import sun.misc.MessageUtils;
import sun.misc.PerformanceLogger;
import sun.misc.Queue;
import sun.security.util.SecurityConstants;

/**
 * Applet panel class. The panel manages and manipulates the
 * applet as it is being loaded. It forks a separate thread in a new
 * thread group to call the applet's init(), start(), stop(), and
 * destroy() methods.
 *
 * @author      Arthur van Hoff
 */
public
<span class="nc" id="L66">abstract class AppletPanel extends Panel implements AppletStub, Runnable {</span>

    /**
     * The applet (if loaded).
     */
    Applet applet;

    /**
     * Applet will allow initialization.  Should be
     * set to false if loading a serialized applet
     * that was pickled in the init=true state.
     */
<span class="nc" id="L78">    protected boolean doInit = true;</span>


    /**
     * The classloader for the applet.
     */
    protected AppletClassLoader loader;

    /* applet event ids */
    public final static int APPLET_DISPOSE = 0;
    public final static int APPLET_LOAD = 1;
    public final static int APPLET_INIT = 2;
    public final static int APPLET_START = 3;
    public final static int APPLET_STOP = 4;
    public final static int APPLET_DESTROY = 5;
    public final static int APPLET_QUIT = 6;
    public final static int APPLET_ERROR = 7;

    /* send to the parent to force relayout */
    public final static int APPLET_RESIZE = 51234;

    /* sent to a (distant) parent to indicate that the applet is being
     * loaded or as completed loading
     */
    public final static int APPLET_LOADING = 51235;
    public final static int APPLET_LOADING_COMPLETED = 51236;

    /**
     * The current status. One of:
     *    APPLET_DISPOSE,
     *    APPLET_LOAD,
     *    APPLET_INIT,
     *    APPLET_START,
     *    APPLET_STOP,
     *    APPLET_DESTROY,
     *    APPLET_ERROR.
     */
    protected int status;

    /**
     * The thread for the applet.
     */
    protected Thread handler;


    /**
     * The initial applet size.
     */
<span class="nc" id="L126">    Dimension defaultAppletSize = new Dimension(10, 10);</span>

    /**
     * The current applet size.
     */
<span class="nc" id="L131">    Dimension currentAppletSize = new Dimension(10, 10);</span>

<span class="nc" id="L133">    MessageUtils mu = new MessageUtils();</span>

    /**
     * The thread to use during applet loading
     */

<span class="nc" id="L139">    Thread loaderThread = null;</span>

    /**
     * Flag to indicate that a loading has been cancelled
     */
<span class="nc" id="L144">    boolean loadAbortRequest = false;</span>

    /* abstract classes */
    abstract protected String getCode();
    abstract protected String getJarFiles();
    abstract protected String getSerializedObject();

    abstract public int    getWidth();
    abstract public int    getHeight();
    abstract public boolean hasInitialFocus();

<span class="nc" id="L155">    private static int threadGroupNumber = 0;</span>

    protected void setupAppletAppContext() {
        // do nothing
<span class="nc" id="L159">    }</span>

    /*
     * Creates a thread to run the applet. This method is called
     * each time an applet is loaded and reloaded.
     */
    synchronized void createAppletThread() {
        // Create a thread group for the applet, and start a new
        // thread to load the applet.
<span class="nc" id="L168">        String nm = &quot;applet-&quot; + getCode();</span>
<span class="nc" id="L169">        loader = getClassLoader(getCodeBase(), getClassLoaderCacheKey());</span>
<span class="nc" id="L170">        loader.grab(); // Keep this puppy around!</span>

        // 4668479: Option to turn off codebase lookup in AppletClassLoader
        // during resource requests. [stanley.ho]
<span class="nc" id="L174">        String param = getParameter(&quot;codebase_lookup&quot;);</span>

<span class="nc bnc" id="L176" title="All 4 branches missed.">        if (param != null &amp;&amp; param.equals(&quot;false&quot;))</span>
<span class="nc" id="L177">            loader.setCodebaseLookup(false);</span>
        else
<span class="nc" id="L179">            loader.setCodebaseLookup(true);</span>


<span class="nc" id="L182">        ThreadGroup appletGroup = loader.getThreadGroup();</span>

<span class="nc" id="L184">        handler = new Thread(appletGroup, this, &quot;thread &quot; + nm);</span>
        // set the context class loader for this thread
<span class="nc" id="L186">        AccessController.doPrivileged(new PrivilegedAction() {</span>
                public Object run() {
<span class="nc" id="L188">                    handler.setContextClassLoader(loader);</span>
<span class="nc" id="L189">                    return null;</span>
                }
            });
<span class="nc" id="L192">        handler.start();</span>
<span class="nc" id="L193">    }</span>

    void joinAppletThread() throws InterruptedException {
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (handler != null) {</span>
<span class="nc" id="L197">            handler.join();</span>
<span class="nc" id="L198">            handler = null;</span>
        }
<span class="nc" id="L200">    }</span>

    void release() {
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (loader != null) {</span>
<span class="nc" id="L204">            loader.release();</span>
<span class="nc" id="L205">            loader = null;</span>
        }
<span class="nc" id="L207">    }</span>

    /**
     * Construct an applet viewer and start the applet.
     */
    public void init() {
        try {
            // Get the width (if any)
<span class="nc" id="L215">            defaultAppletSize.width = getWidth();</span>
<span class="nc" id="L216">            currentAppletSize.width = defaultAppletSize.width;</span>

            // Get the height (if any)
<span class="nc" id="L219">            defaultAppletSize.height = getHeight();</span>
<span class="nc" id="L220">            currentAppletSize.height = defaultAppletSize.height;</span>

<span class="nc" id="L222">        } catch (NumberFormatException e) {</span>
            // Turn on the error flag and let TagAppletPanel
            // do the right thing.
<span class="nc" id="L225">            status = APPLET_ERROR;</span>
<span class="nc" id="L226">            showAppletStatus(&quot;badattribute.exception&quot;);</span>
<span class="nc" id="L227">            showAppletLog(&quot;badattribute.exception&quot;);</span>
<span class="nc" id="L228">            showAppletException(e);</span>
<span class="nc" id="L229">        }</span>

<span class="nc" id="L231">        setLayout(new BorderLayout());</span>

<span class="nc" id="L233">        createAppletThread();</span>
<span class="nc" id="L234">    }</span>

    /**
     * Minimum size
     */
    public Dimension minimumSize() {
<span class="nc" id="L240">        return new Dimension(defaultAppletSize.width,</span>
                             defaultAppletSize.height);
    }

    /**
     * Preferred size
     */
    public Dimension preferredSize() {
<span class="nc" id="L248">        return new Dimension(currentAppletSize.width,</span>
                             currentAppletSize.height);
    }

    private AppletListener listeners;

    /**
     * AppletEvent Queue
     */
<span class="nc" id="L257">    private Queue queue = null;</span>


    synchronized public void addAppletListener(AppletListener l) {
<span class="nc" id="L261">        listeners = AppletEventMulticaster.add(listeners, l);</span>
<span class="nc" id="L262">    }</span>

    synchronized public void removeAppletListener(AppletListener l) {
<span class="nc" id="L265">        listeners = AppletEventMulticaster.remove(listeners, l);</span>
<span class="nc" id="L266">    }</span>

    /**
     * Dispatch event to the listeners..
     */
    public void dispatchAppletEvent(int id, Object argument) {
        //System.out.println(&quot;SEND= &quot; + id);
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (listeners != null) {</span>
<span class="nc" id="L274">            AppletEvent evt = new AppletEvent(this, id, argument);</span>
<span class="nc" id="L275">            listeners.appletStateChanged(evt);</span>
        }
<span class="nc" id="L277">    }</span>

    /**
     * Send an event. Queue it for execution by the handler thread.
     */
    public void sendEvent(int id) {
<span class="nc" id="L283">        synchronized(this) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (queue == null) {</span>
                //System.out.println(&quot;SEND0= &quot; + id);
<span class="nc" id="L286">                queue = new Queue();</span>
            }
<span class="nc" id="L288">            Integer eventId = Integer.valueOf(id);</span>
<span class="nc" id="L289">            queue.enqueue(eventId);</span>
<span class="nc" id="L290">            notifyAll();</span>
<span class="nc" id="L291">        }</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (id == APPLET_QUIT) {</span>
            try {
<span class="nc" id="L294">                joinAppletThread(); // Let the applet event handler exit</span>
<span class="nc" id="L295">            } catch (InterruptedException e) {</span>
<span class="nc" id="L296">            }</span>

            // AppletClassLoader.release() must be called by a Thread
            // not within the applet's ThreadGroup
<span class="nc bnc" id="L300" title="All 2 branches missed.">            if (loader == null)</span>
<span class="nc" id="L301">                loader = getClassLoader(getCodeBase(), getClassLoaderCacheKey());</span>
<span class="nc" id="L302">            release();</span>
        }
<span class="nc" id="L304">    }</span>

    /**
     * Get an event from the queue.
     */
    synchronized AppletEvent getNextEvent() throws InterruptedException {
<span class="nc bnc" id="L310" title="All 4 branches missed.">        while (queue == null || queue.isEmpty()) {</span>
<span class="nc" id="L311">            wait();</span>
        }
<span class="nc" id="L313">        Integer eventId = (Integer)queue.dequeue();</span>
<span class="nc" id="L314">        return new AppletEvent(this, eventId.intValue(), null);</span>
    }

    boolean emptyEventQueue() {
<span class="nc bnc" id="L318" title="All 4 branches missed.">        if ((queue == null) || (queue.isEmpty()))</span>
<span class="nc" id="L319">            return true;</span>
        else
<span class="nc" id="L321">            return false;</span>
    }

    /**
     * This kludge is specific to get over AccessControlException thrown during
     * Applet.stop() or destroy() when static thread is suspended.  Set a flag
     * in AppletClassLoader to indicate that an
     * AccessControlException for RuntimePermission &quot;modifyThread&quot; or
     * &quot;modifyThreadGroup&quot; had occurred.
     */
     private void setExceptionStatus(AccessControlException e) {
<span class="nc" id="L332">     Permission p = e.getPermission();</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">     if (p instanceof RuntimePermission) {</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">         if (p.getName().startsWith(&quot;modifyThread&quot;)) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">             if (loader == null)</span>
<span class="nc" id="L336">                 loader = getClassLoader(getCodeBase(), getClassLoaderCacheKey());</span>
<span class="nc" id="L337">             loader.setExceptionStatus();</span>
         }
     }
<span class="nc" id="L340">     }</span>

    /**
     * Execute applet events.
     * Here is the state transition diagram
     *
     *   Note: (XXX) is the action
     *         APPLET_XXX is the state
     *  (applet code loaded) --&gt; APPLET_LOAD -- (applet init called)--&gt; APPLET_INIT -- (
     *   applet start called) --&gt; APPLET_START -- (applet stop called) --&gt;APPLET_STOP --(applet
     *   destroyed called) --&gt; APPLET_DESTROY --&gt;(applet gets disposed) --&gt;
     *   APPLET_DISPOSE --&gt;....
     *
     * In the legacy lifecycle model. The applet gets loaded, inited and started. So it stays
     * in the APPLET_START state unless the applet goes away(refresh page or leave the page).
     * So the applet stop method called and the applet enters APPLET_STOP state. Then if the applet
     * is revisited, it will call applet start method and enter the APPLET_START state and stay there.
     *
     * In the modern lifecycle model. When the applet first time visited, it is same as legacy lifecycle
     * model. However, when the applet page goes away. It calls applet stop method and enters APPLET_STOP
     * state and then applet destroyed method gets called and enters APPLET_DESTROY state.
     *
     * This code is also called by AppletViewer. In AppletViewer &quot;Restart&quot; menu, the applet is jump from
     * APPLET_STOP to APPLET_DESTROY and to APPLET_INIT .
     *
     * Also, the applet can jump from APPLET_INIT state to APPLET_DESTROY (in Netscape/Mozilla case).
         * Same as APPLET_LOAD to
     * APPLET_DISPOSE since all of this are triggered by browser.
     *
     *
     */
    public void run() {

<span class="nc" id="L373">        Thread curThread = Thread.currentThread();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (curThread == loaderThread) {</span>
            // if we are in the loader thread, cause
            // loading to occur.  We may exit this with
            // status being APPLET_DISPOSE, APPLET_ERROR,
            // or APPLET_LOAD
<span class="nc" id="L379">            runLoader();</span>
<span class="nc" id="L380">            return;</span>
        }

<span class="nc" id="L383">        boolean disposed = false;</span>
<span class="nc bnc" id="L384" title="All 4 branches missed.">        while (!disposed &amp;&amp; !curThread.isInterrupted()) {</span>
            AppletEvent evt;
            try {
<span class="nc" id="L387">                evt = getNextEvent();</span>
<span class="nc" id="L388">            } catch (InterruptedException e) {</span>
<span class="nc" id="L389">                showAppletStatus(&quot;bail&quot;);</span>
<span class="nc" id="L390">                return;</span>
<span class="nc" id="L391">            }</span>

            //showAppletStatus(&quot;EVENT = &quot; + evt.getID());
            try {
<span class="nc bnc" id="L395" title="All 8 branches missed.">                switch (evt.getID()) {</span>
                  case APPLET_LOAD:
<span class="nc bnc" id="L397" title="All 2 branches missed.">                      if (!okToLoad()) {</span>
<span class="nc" id="L398">                          break;</span>
                      }
                      // This complexity allows loading of applets to be
                      // interruptable.  The actual thread loading runs
                      // in a separate thread, so it can be interrupted
                      // without harming the applet thread.
                      // So that we don't have to worry about
                      // concurrency issues, the main applet thread waits
                      // until the loader thread terminates.
                      // (one way or another).
<span class="nc bnc" id="L408" title="All 2 branches missed.">                      if (loaderThread == null) {</span>
                          // REMIND: do we want a name?
                          //System.out.println(&quot;------------------- loading applet&quot;);
<span class="nc" id="L411">                          setLoaderThread(new Thread(this));</span>
<span class="nc" id="L412">                          loaderThread.start();</span>
                          // we get to go to sleep while this runs
<span class="nc" id="L414">                          loaderThread.join();</span>
<span class="nc" id="L415">                          setLoaderThread(null);</span>
                      } else {
                          // REMIND: issue an error -- this case should never
                          // occur.
                      }
                      break;

                  case APPLET_INIT:
                    // AppletViewer &quot;Restart&quot; will jump from destroy method to
                    // init, that is why we need to check status w/ APPLET_DESTROY
<span class="nc bnc" id="L425" title="All 4 branches missed.">                      if (status != APPLET_LOAD &amp;&amp; status != APPLET_DESTROY) {</span>
<span class="nc" id="L426">                          showAppletStatus(&quot;notloaded&quot;);</span>
<span class="nc" id="L427">                          break;</span>
                      }
<span class="nc" id="L429">                      applet.resize(defaultAppletSize);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">                      if (doInit) {</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">                          if (PerformanceLogger.loggingEnabled()) {</span>
<span class="nc" id="L432">                              PerformanceLogger.setTime(&quot;Applet Init&quot;);</span>
<span class="nc" id="L433">                              PerformanceLogger.outputLog();</span>
                          }
<span class="nc" id="L435">                          applet.init();</span>
                      }

                      //Need the default(fallback) font to be created in this AppContext
<span class="nc" id="L439">                      Font f = getFont();</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                      if (f == null ||</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                          &quot;dialog&quot;.equals(f.getFamily().toLowerCase(Locale.ENGLISH)) &amp;&amp;</span>
<span class="nc bnc" id="L442" title="All 4 branches missed.">                          f.getSize() == 12 &amp;&amp; f.getStyle() == Font.PLAIN) {</span>
<span class="nc" id="L443">                          setFont(new Font(Font.DIALOG, Font.PLAIN, 12));</span>
                      }

<span class="nc" id="L446">                      doInit = true;    // allow restarts</span>

                      // Validate the applet in event dispatch thread
                      // to avoid deadlock.
                      try {
<span class="nc" id="L451">                          final AppletPanel p = this;</span>
<span class="nc" id="L452">                          Runnable r = new Runnable() {</span>
                              public void run() {
<span class="nc" id="L454">                                  p.validate();</span>
<span class="nc" id="L455">                              }</span>
                          };
<span class="nc" id="L457">                          AWTAccessor.getEventQueueAccessor().invokeAndWait(applet, r);</span>
                      }
<span class="nc" id="L459">                      catch(InterruptedException ie) {</span>
                      }
<span class="nc" id="L461">                      catch(InvocationTargetException ite) {</span>
<span class="nc" id="L462">                      }</span>

<span class="nc" id="L464">                      status = APPLET_INIT;</span>
<span class="nc" id="L465">                      showAppletStatus(&quot;inited&quot;);</span>
<span class="nc" id="L466">                      break;</span>

                  case APPLET_START:
                  {
<span class="nc bnc" id="L470" title="All 4 branches missed.">                      if (status != APPLET_INIT &amp;&amp; status != APPLET_STOP) {</span>
<span class="nc" id="L471">                          showAppletStatus(&quot;notinited&quot;);</span>
<span class="nc" id="L472">                          break;</span>
                      }
<span class="nc" id="L474">                      applet.resize(currentAppletSize);</span>
<span class="nc" id="L475">                      applet.start();</span>

                      // Validate and show the applet in event dispatch thread
                      // to avoid deadlock.
                      try {
<span class="nc" id="L480">                          final AppletPanel p = this;</span>
<span class="nc" id="L481">                          final Applet a = applet;</span>
<span class="nc" id="L482">                          Runnable r = new Runnable() {</span>
                              public void run() {
<span class="nc" id="L484">                                  p.validate();</span>
<span class="nc" id="L485">                                  a.setVisible(true);</span>

                                  // Fix for BugTraq ID 4041703.
                                  // Set the default focus for an applet.
<span class="nc bnc" id="L489" title="All 2 branches missed.">                                  if (hasInitialFocus()) {</span>
<span class="nc" id="L490">                                      setDefaultFocus();</span>
                                  }
<span class="nc" id="L492">                              }</span>
                          };
<span class="nc" id="L494">                          AWTAccessor.getEventQueueAccessor().invokeAndWait(applet, r);</span>
                      }
<span class="nc" id="L496">                      catch(InterruptedException ie) {</span>
                      }
<span class="nc" id="L498">                      catch(InvocationTargetException ite) {</span>
<span class="nc" id="L499">                      }</span>

<span class="nc" id="L501">                      status = APPLET_START;</span>
<span class="nc" id="L502">                      showAppletStatus(&quot;started&quot;);</span>
<span class="nc" id="L503">                      break;</span>
                  }

                case APPLET_STOP:
<span class="nc bnc" id="L507" title="All 2 branches missed.">                    if (status != APPLET_START) {</span>
<span class="nc" id="L508">                        showAppletStatus(&quot;notstarted&quot;);</span>
<span class="nc" id="L509">                        break;</span>
                    }
<span class="nc" id="L511">                    status = APPLET_STOP;</span>

                    // Hide the applet in event dispatch thread
                    // to avoid deadlock.
                    try {
<span class="nc" id="L516">                        final Applet a = applet;</span>
<span class="nc" id="L517">                        Runnable r = new Runnable() {</span>
                            public void run() {
<span class="nc" id="L519">                                a.setVisible(false);</span>
<span class="nc" id="L520">                            }</span>
                        };
<span class="nc" id="L522">                        AWTAccessor.getEventQueueAccessor().invokeAndWait(applet, r);</span>
                    }
<span class="nc" id="L524">                    catch(InterruptedException ie) {</span>
                    }
<span class="nc" id="L526">                    catch(InvocationTargetException ite) {</span>
<span class="nc" id="L527">                    }</span>


                    // During Applet.stop(), any AccessControlException on an involved Class remains in
                    // the &quot;memory&quot; of the AppletClassLoader.  If the same instance of the ClassLoader is
                    // reused, the same exception will occur during class loading.  Set the AppletClassLoader's
                    // exceptionStatusSet flag to allow recognition of what had happened
                    // when reusing AppletClassLoader object.
                    try {
<span class="nc" id="L536">                        applet.stop();</span>
<span class="nc" id="L537">                    } catch (java.security.AccessControlException e) {</span>
<span class="nc" id="L538">                        setExceptionStatus(e);</span>
                        // rethrow exception to be handled as it normally would be.
<span class="nc" id="L540">                        throw e;</span>
<span class="nc" id="L541">                    }</span>
<span class="nc" id="L542">                    showAppletStatus(&quot;stopped&quot;);</span>
<span class="nc" id="L543">                    break;</span>

                case APPLET_DESTROY:
<span class="nc bnc" id="L546" title="All 4 branches missed.">                    if (status != APPLET_STOP &amp;&amp; status != APPLET_INIT) {</span>
<span class="nc" id="L547">                        showAppletStatus(&quot;notstopped&quot;);</span>
<span class="nc" id="L548">                        break;</span>
                    }
<span class="nc" id="L550">                    status = APPLET_DESTROY;</span>

                    // During Applet.destroy(), any AccessControlException on an involved Class remains in
                    // the &quot;memory&quot; of the AppletClassLoader.  If the same instance of the ClassLoader is
                    // reused, the same exception will occur during class loading.  Set the AppletClassLoader's
                    // exceptionStatusSet flag to allow recognition of what had happened
                    // when reusing AppletClassLoader object.
                    try {
<span class="nc" id="L558">                        applet.destroy();</span>
<span class="nc" id="L559">                    } catch (java.security.AccessControlException e) {</span>
<span class="nc" id="L560">                        setExceptionStatus(e);</span>
                        // rethrow exception to be handled as it normally would be.
<span class="nc" id="L562">                        throw e;</span>
<span class="nc" id="L563">                    }</span>
<span class="nc" id="L564">                    showAppletStatus(&quot;destroyed&quot;);</span>
<span class="nc" id="L565">                    break;</span>

                case APPLET_DISPOSE:
<span class="nc bnc" id="L568" title="All 4 branches missed.">                    if (status != APPLET_DESTROY &amp;&amp; status != APPLET_LOAD) {</span>
<span class="nc" id="L569">                        showAppletStatus(&quot;notdestroyed&quot;);</span>
<span class="nc" id="L570">                        break;</span>
                    }
<span class="nc" id="L572">                    status = APPLET_DISPOSE;</span>

                    try {
<span class="nc" id="L575">                        final Applet a = applet;</span>
<span class="nc" id="L576">                        Runnable r = new Runnable() {</span>
                            public void run() {
<span class="nc" id="L578">                                remove(a);</span>
<span class="nc" id="L579">                            }</span>
                        };
<span class="nc" id="L581">                        AWTAccessor.getEventQueueAccessor().invokeAndWait(applet, r);</span>
                    }
<span class="nc" id="L583">                    catch(InterruptedException ie)</span>
                    {
                    }
<span class="nc" id="L586">                    catch(InvocationTargetException ite)</span>
                    {
<span class="nc" id="L588">                    }</span>
<span class="nc" id="L589">                    applet = null;</span>
<span class="nc" id="L590">                    showAppletStatus(&quot;disposed&quot;);</span>
<span class="nc" id="L591">                    disposed = true;</span>
<span class="nc" id="L592">                    break;</span>

                case APPLET_QUIT:
<span class="nc" id="L595">                    return;</span>
                }
<span class="nc" id="L597">            } catch (Exception e) {</span>
<span class="nc" id="L598">                status = APPLET_ERROR;</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                if (e.getMessage() != null) {</span>
<span class="nc" id="L600">                    showAppletStatus(&quot;exception2&quot;, e.getClass().getName(),</span>
<span class="nc" id="L601">                                     e.getMessage());</span>
                } else {
<span class="nc" id="L603">                    showAppletStatus(&quot;exception&quot;, e.getClass().getName());</span>
                }
<span class="nc" id="L605">                showAppletException(e);</span>
<span class="nc" id="L606">            } catch (ThreadDeath e) {</span>
<span class="nc" id="L607">                showAppletStatus(&quot;death&quot;);</span>
<span class="nc" id="L608">                return;</span>
<span class="nc" id="L609">            } catch (Error e) {</span>
<span class="nc" id="L610">                status = APPLET_ERROR;</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">                if (e.getMessage() != null) {</span>
<span class="nc" id="L612">                    showAppletStatus(&quot;error2&quot;, e.getClass().getName(),</span>
<span class="nc" id="L613">                                     e.getMessage());</span>
                } else {
<span class="nc" id="L615">                    showAppletStatus(&quot;error&quot;, e.getClass().getName());</span>
                }
<span class="nc" id="L617">                showAppletException(e);</span>
<span class="nc" id="L618">            }</span>
<span class="nc" id="L619">            clearLoadAbortRequest();</span>
<span class="nc" id="L620">        }</span>
<span class="nc" id="L621">    }</span>

    /**
     * Gets most recent focus owner component associated with the given window.
     * It does that without calling Window.getMostRecentFocusOwner since it
     * provides its own logic contradicting with setDefautlFocus. Instead, it
     * calls KeyboardFocusManager directly.
     */
    private Component getMostRecentFocusOwnerForWindow(Window w) {
<span class="nc" id="L630">        Method meth = (Method)AccessController.doPrivileged(new PrivilegedAction() {</span>
                public Object run() {
<span class="nc" id="L632">                    Method meth = null;</span>
                    try {
<span class="nc" id="L634">                        meth = KeyboardFocusManager.class.getDeclaredMethod(&quot;getMostRecentFocusOwner&quot;, new Class[] {Window.class});</span>
<span class="nc" id="L635">                        meth.setAccessible(true);</span>
<span class="nc" id="L636">                    } catch (Exception e) {</span>
                        // Must never happen
<span class="nc" id="L638">                        e.printStackTrace();</span>
<span class="nc" id="L639">                    }</span>
<span class="nc" id="L640">                    return meth;</span>
                }
            });
<span class="nc bnc" id="L643" title="All 2 branches missed.">        if (meth != null) {</span>
            // Meth refers static method
            try {
<span class="nc" id="L646">                return (Component)meth.invoke(null, new Object[] {w});</span>
<span class="nc" id="L647">            } catch (Exception e) {</span>
                // Must never happen
<span class="nc" id="L649">                e.printStackTrace();</span>
            }
        }
        // Will get here if exception was thrown or meth is null
<span class="nc" id="L653">        return w.getMostRecentFocusOwner();</span>
    }

    /*
     * Fix for BugTraq ID 4041703.
     * Set the focus to a reasonable default for an Applet.
     */
    private void setDefaultFocus() {
<span class="nc" id="L661">        Component toFocus = null;</span>
<span class="nc" id="L662">        Container parent = getParent();</span>

<span class="nc bnc" id="L664" title="All 2 branches missed.">        if(parent != null) {</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">            if (parent instanceof Window) {</span>
<span class="nc" id="L666">                toFocus = getMostRecentFocusOwnerForWindow((Window)parent);</span>
<span class="nc bnc" id="L667" title="All 4 branches missed.">                if (toFocus == parent || toFocus == null) {</span>
<span class="nc" id="L668">                    toFocus = parent.getFocusTraversalPolicy().</span>
<span class="nc" id="L669">                        getInitialComponent((Window)parent);</span>
                }
<span class="nc bnc" id="L671" title="All 2 branches missed.">            } else if (parent.isFocusCycleRoot()) {</span>
<span class="nc" id="L672">                toFocus = parent.getFocusTraversalPolicy().</span>
<span class="nc" id="L673">                    getDefaultComponent(parent);</span>
            }
        }

<span class="nc bnc" id="L677" title="All 2 branches missed.">        if (toFocus != null) {</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">            if (parent instanceof EmbeddedFrame) {</span>
<span class="nc" id="L679">                ((EmbeddedFrame)parent).synthesizeWindowActivation(true);</span>
            }
            // EmbeddedFrame might have focus before the applet was added.
            // Thus after its activation the most recent focus owner will be
            // restored. We need the applet's initial focusabled component to
            // be focused here.
<span class="nc" id="L685">            toFocus.requestFocusInWindow();</span>
        }
<span class="nc" id="L687">    }</span>

    /**
     * Load the applet into memory.
     * Runs in a seperate (and interruptible) thread from the rest of the
     * applet event processing so that it can be gracefully interrupted from
     * things like HotJava.
     */
    private void runLoader() {
<span class="nc bnc" id="L696" title="All 2 branches missed.">        if (status != APPLET_DISPOSE) {</span>
<span class="nc" id="L697">            showAppletStatus(&quot;notdisposed&quot;);</span>
<span class="nc" id="L698">            return;</span>
        }

<span class="nc" id="L701">        dispatchAppletEvent(APPLET_LOADING, null);</span>

        // REMIND -- might be cool to visually indicate loading here --
        // maybe do animation?
<span class="nc" id="L705">        status = APPLET_LOAD;</span>

        // Create a class loader
<span class="nc" id="L708">        loader = getClassLoader(getCodeBase(), getClassLoaderCacheKey());</span>

        // Load the archives if present.
        // REMIND - this probably should be done in a separate thread,
        // or at least the additional archives (epll).

<span class="nc" id="L714">        String code = getCode();</span>

        // setup applet AppContext
        // this must be called before loadJarFiles
<span class="nc" id="L718">        setupAppletAppContext();</span>

        try {
<span class="nc" id="L721">            loadJarFiles(loader);</span>
<span class="nc" id="L722">            applet = createApplet(loader);</span>
<span class="nc" id="L723">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L724">            status = APPLET_ERROR;</span>
<span class="nc" id="L725">            showAppletStatus(&quot;notfound&quot;, code);</span>
<span class="nc" id="L726">            showAppletLog(&quot;notfound&quot;, code);</span>
<span class="nc" id="L727">            showAppletException(e);</span>
<span class="nc" id="L728">            return;</span>
<span class="nc" id="L729">        } catch (InstantiationException e) {</span>
<span class="nc" id="L730">            status = APPLET_ERROR;</span>
<span class="nc" id="L731">            showAppletStatus(&quot;nocreate&quot;, code);</span>
<span class="nc" id="L732">            showAppletLog(&quot;nocreate&quot;, code);</span>
<span class="nc" id="L733">            showAppletException(e);</span>
<span class="nc" id="L734">            return;</span>
<span class="nc" id="L735">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L736">            status = APPLET_ERROR;</span>
<span class="nc" id="L737">            showAppletStatus(&quot;noconstruct&quot;, code);</span>
<span class="nc" id="L738">            showAppletLog(&quot;noconstruct&quot;, code);</span>
<span class="nc" id="L739">            showAppletException(e);</span>
            // sbb -- I added a return here
<span class="nc" id="L741">            return;</span>
<span class="nc" id="L742">        } catch (Exception e) {</span>
<span class="nc" id="L743">            status = APPLET_ERROR;</span>
<span class="nc" id="L744">            showAppletStatus(&quot;exception&quot;, e.getMessage());</span>
<span class="nc" id="L745">            showAppletException(e);</span>
<span class="nc" id="L746">            return;</span>
<span class="nc" id="L747">        } catch (ThreadDeath e) {</span>
<span class="nc" id="L748">            status = APPLET_ERROR;</span>
<span class="nc" id="L749">            showAppletStatus(&quot;death&quot;);</span>
<span class="nc" id="L750">            return;</span>
<span class="nc" id="L751">        } catch (Error e) {</span>
<span class="nc" id="L752">            status = APPLET_ERROR;</span>
<span class="nc" id="L753">            showAppletStatus(&quot;error&quot;, e.getMessage());</span>
<span class="nc" id="L754">            showAppletException(e);</span>
<span class="nc" id="L755">            return;</span>
        } finally {
            // notify that loading is no longer going on
<span class="nc" id="L758">            dispatchAppletEvent(APPLET_LOADING_COMPLETED, null);</span>
<span class="nc" id="L759">        }</span>

        // Fixed #4508194: NullPointerException thrown during
        // quick page switch
        //
<span class="nc bnc" id="L764" title="All 2 branches missed.">        if (applet != null)</span>
        {
            // Stick it in the frame
<span class="nc" id="L767">            applet.setStub(this);</span>
<span class="nc" id="L768">            applet.hide();</span>
<span class="nc" id="L769">            add(&quot;Center&quot;, applet);</span>
<span class="nc" id="L770">            showAppletStatus(&quot;loaded&quot;);</span>
<span class="nc" id="L771">            validate();</span>
        }
<span class="nc" id="L773">    }</span>

    protected Applet createApplet(final AppletClassLoader loader) throws ClassNotFoundException,
                                                                         IllegalAccessException, IOException, InstantiationException, InterruptedException {
<span class="nc" id="L777">        final String serName = getSerializedObject();</span>
<span class="nc" id="L778">        String code = getCode();</span>

<span class="nc bnc" id="L780" title="All 4 branches missed.">        if (code != null &amp;&amp; serName != null) {</span>
<span class="nc" id="L781">            System.err.println(amh.getMessage(&quot;runloader.err&quot;));</span>
//          return null;
<span class="nc" id="L783">            throw new InstantiationException(&quot;Either \&quot;code\&quot; or \&quot;object\&quot; should be specified, but not both.&quot;);</span>
        }
<span class="nc bnc" id="L785" title="All 4 branches missed.">        if (code == null &amp;&amp; serName == null) {</span>
<span class="nc" id="L786">            String msg = &quot;nocode&quot;;</span>
<span class="nc" id="L787">            status = APPLET_ERROR;</span>
<span class="nc" id="L788">            showAppletStatus(msg);</span>
<span class="nc" id="L789">            showAppletLog(msg);</span>
<span class="nc" id="L790">            repaint();</span>
        }
<span class="nc bnc" id="L792" title="All 2 branches missed.">        if (code != null) {</span>
<span class="nc" id="L793">            applet = (Applet)loader.loadCode(code).newInstance();</span>
<span class="nc" id="L794">            doInit = true;</span>
        } else {
            // serName is not null;
<span class="nc" id="L797">            InputStream is = (InputStream)</span>
<span class="nc" id="L798">                java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L799">                                                            new java.security.PrivilegedAction() {</span>
                                                                public Object run() {
<span class="nc" id="L801">                                                                    return loader.getResourceAsStream(serName);</span>
                                                                }
                                                            });
<span class="nc" id="L804">            ObjectInputStream ois =</span>
                new AppletObjectInputStream(is, loader);
<span class="nc" id="L806">            Object serObject = ois.readObject();</span>
<span class="nc" id="L807">            applet = (Applet) serObject;</span>
<span class="nc" id="L808">            doInit = false; // skip over the first init</span>
        }

        // Determine the JDK level that the applet targets.
        // This is critical for enabling certain backward
        // compatibility switch if an applet is a JDK 1.1
        // applet. [stanley.ho]
<span class="nc" id="L815">        findAppletJDKLevel(applet);</span>

<span class="nc bnc" id="L817" title="All 2 branches missed.">        if (Thread.interrupted()) {</span>
            try {
<span class="nc" id="L819">                status = APPLET_DISPOSE; // APPLET_ERROR?</span>
<span class="nc" id="L820">                applet = null;</span>
                // REMIND: This may not be exactly the right thing: the
                // status is set by the stop button and not necessarily
                // here.
<span class="nc" id="L824">                showAppletStatus(&quot;death&quot;);</span>
            } finally {
<span class="nc" id="L826">                Thread.currentThread().interrupt(); // resignal interrupt</span>
<span class="nc" id="L827">            }</span>
<span class="nc" id="L828">            return null;</span>
        }
<span class="nc" id="L830">        return applet;</span>
    }

    protected void loadJarFiles(AppletClassLoader loader) throws IOException,
                                                                 InterruptedException {
        // Load the archives if present.
        // REMIND - this probably should be done in a separate thread,
        // or at least the additional archives (epll).
<span class="nc" id="L838">        String jarFiles = getJarFiles();</span>

<span class="nc bnc" id="L840" title="All 2 branches missed.">        if (jarFiles != null) {</span>
<span class="nc" id="L841">            StringTokenizer st = new StringTokenizer(jarFiles, &quot;,&quot;, false);</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">            while(st.hasMoreTokens()) {</span>
<span class="nc" id="L843">                String tok = st.nextToken().trim();</span>
                try {
<span class="nc" id="L845">                    loader.addJar(tok);</span>
<span class="nc" id="L846">                } catch (IllegalArgumentException e) {</span>
                    // bad archive name
<span class="nc" id="L848">                    continue;</span>
<span class="nc" id="L849">                }</span>
<span class="nc" id="L850">            }</span>
        }
<span class="nc" id="L852">    }</span>

    /**
     * Request that the loading of the applet be stopped.
     */
    protected synchronized void stopLoading() {
        // REMIND: fill in the body
<span class="nc bnc" id="L859" title="All 2 branches missed.">        if (loaderThread != null) {</span>
            //System.out.println(&quot;Interrupting applet loader thread: &quot; + loaderThread);
<span class="nc" id="L861">            loaderThread.interrupt();</span>
        } else {
<span class="nc" id="L863">            setLoadAbortRequest();</span>
        }
<span class="nc" id="L865">    }</span>


    protected synchronized boolean okToLoad() {
<span class="nc bnc" id="L869" title="All 2 branches missed.">        return !loadAbortRequest;</span>
    }

    protected synchronized void clearLoadAbortRequest() {
<span class="nc" id="L873">        loadAbortRequest = false;</span>
<span class="nc" id="L874">    }</span>

    protected synchronized void setLoadAbortRequest() {
<span class="nc" id="L877">        loadAbortRequest = true;</span>
<span class="nc" id="L878">    }</span>


    private synchronized void setLoaderThread(Thread loaderThread) {
<span class="nc" id="L882">        this.loaderThread = loaderThread;</span>
<span class="nc" id="L883">    }</span>

    /**
     * Return true when the applet has been started.
     */
    public boolean isActive() {
<span class="nc bnc" id="L889" title="All 2 branches missed.">        return status == APPLET_START;</span>
    }


<span class="nc" id="L893">    private EventQueue appEvtQ = null;</span>
    /**
     * Is called when the applet wants to be resized.
     */
    public void appletResize(int width, int height) {
<span class="nc" id="L898">        currentAppletSize.width = width;</span>
<span class="nc" id="L899">        currentAppletSize.height = height;</span>
<span class="nc" id="L900">        final Dimension currentSize = new Dimension(currentAppletSize.width,</span>
                                                    currentAppletSize.height);

<span class="nc bnc" id="L903" title="All 2 branches missed.">        if(loader != null) {</span>
<span class="nc" id="L904">            AppContext appCtxt = loader.getAppContext();</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">            if(appCtxt != null)</span>
<span class="nc" id="L906">                appEvtQ = (java.awt.EventQueue)appCtxt.get(AppContext.EVENT_QUEUE_KEY);</span>
        }

<span class="nc" id="L909">        final AppletPanel ap = this;</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">        if (appEvtQ != null){</span>
<span class="nc" id="L911">            appEvtQ.postEvent(new InvocationEvent(Toolkit.getDefaultToolkit(),</span>
<span class="nc" id="L912">                                                  new Runnable(){</span>
                                                      public void run(){
<span class="nc bnc" id="L914" title="All 2 branches missed.">                                                          if(ap != null)</span>
                                                          {
<span class="nc" id="L916">                                                              ap.dispatchAppletEvent(APPLET_RESIZE, currentSize);</span>
                                                          }
<span class="nc" id="L918">                                                      }</span>
                                                  }));
        }
<span class="nc" id="L921">    }</span>

    public void setBounds(int x, int y, int width, int height) {
<span class="nc" id="L924">        super.setBounds(x, y, width, height);</span>
<span class="nc" id="L925">        currentAppletSize.width = width;</span>
<span class="nc" id="L926">        currentAppletSize.height = height;</span>
<span class="nc" id="L927">    }</span>

    public Applet getApplet() {
<span class="nc" id="L930">        return applet;</span>
    }

    /**
     * Status line. Called by the AppletPanel to provide
     * feedback on the Applet's state.
     */
    protected void showAppletStatus(String status) {
<span class="nc" id="L938">        getAppletContext().showStatus(amh.getMessage(status));</span>
<span class="nc" id="L939">    }</span>

    protected void showAppletStatus(String status, Object arg) {
<span class="nc" id="L942">        getAppletContext().showStatus(amh.getMessage(status, arg));</span>
<span class="nc" id="L943">    }</span>
    protected void showAppletStatus(String status, Object arg1, Object arg2) {
<span class="nc" id="L945">        getAppletContext().showStatus(amh.getMessage(status, arg1, arg2));</span>
<span class="nc" id="L946">    }</span>

    /**
     * Called by the AppletPanel to print to the log.
     */
    protected void showAppletLog(String msg) {
<span class="nc" id="L952">        System.out.println(amh.getMessage(msg));</span>
<span class="nc" id="L953">    }</span>

    protected void showAppletLog(String msg, Object arg) {
<span class="nc" id="L956">        System.out.println(amh.getMessage(msg, arg));</span>
<span class="nc" id="L957">    }</span>

    /**
     * Called by the AppletPanel to provide
     * feedback when an exception has happened.
     */
    protected void showAppletException(Throwable t) {
<span class="nc" id="L964">        t.printStackTrace();</span>
<span class="nc" id="L965">        repaint();</span>
<span class="nc" id="L966">    }</span>

    /**
     * Get caching key for classloader cache
     */
    public String getClassLoaderCacheKey()
    {
        /**
         * Fixed #4501142: Classlaoder sharing policy doesn't
         * take &quot;archive&quot; into account. This will be overridden
         * by Java Plug-in.                     [stanleyh]
         */
<span class="nc" id="L978">        return getCodeBase().toString();</span>
    }

    /**
     * The class loaders
     */
<span class="nc" id="L984">    private static HashMap classloaders = new HashMap();</span>

    /**
     * Flush a class loader.
     */
    public static synchronized void flushClassLoader(String key) {
<span class="nc" id="L990">        classloaders.remove(key);</span>
<span class="nc" id="L991">    }</span>

    /**
     * Flush all class loaders.
     */
    public static synchronized void flushClassLoaders() {
<span class="nc" id="L997">        classloaders = new HashMap();</span>
<span class="nc" id="L998">    }</span>

    /**
     * This method actually creates an AppletClassLoader.
     *
     * It can be override by subclasses (such as the Plug-in)
     * to provide different classloaders.
     */
    protected AppletClassLoader createClassLoader(final URL codebase) {
<span class="nc" id="L1007">        return new AppletClassLoader(codebase);</span>
    }

    /**
     * Get a class loader. Create in a restricted context
     */
    synchronized AppletClassLoader getClassLoader(final URL codebase, final String key) {
<span class="nc" id="L1014">        AppletClassLoader c = (AppletClassLoader)classloaders.get(key);</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L1016">            AccessControlContext acc =</span>
<span class="nc" id="L1017">                getAccessControlContext(codebase);</span>
<span class="nc" id="L1018">            c = (AppletClassLoader)</span>
<span class="nc" id="L1019">                AccessController.doPrivileged(new PrivilegedAction() {</span>
                        public Object run() {
<span class="nc" id="L1021">                            AppletClassLoader ac = createClassLoader(codebase);</span>
                            /* Should the creation of the classloader be
                             * within the class synchronized block?  Since
                             * this class is used by the plugin, take care
                             * to avoid deadlocks, or specialize
                             * AppletPanel within the plugin.  It may take
                             * an arbitrary amount of time to create a
                             * class loader (involving getting Jar files
                             * etc.) and may block unrelated applets from
                             * finishing createAppletThread (due to the
                             * class synchronization). If
                             * createAppletThread does not finish quickly,
                             * the applet cannot process other messages,
                             * particularly messages such as destroy
                             * (which timeout when called from the browser).
                             */
<span class="nc" id="L1037">                            synchronized (getClass()) {</span>
                                AppletClassLoader res =
<span class="nc" id="L1039">                                    (AppletClassLoader)classloaders.get(key);</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">                                if (res == null) {</span>
<span class="nc" id="L1041">                                    classloaders.put(key, ac);</span>
<span class="nc" id="L1042">                                    return ac;</span>
                                } else {
<span class="nc" id="L1044">                                    return res;</span>
                                }
<span class="nc" id="L1046">                            }</span>
                        }
                    },acc);
        }
<span class="nc" id="L1050">        return c;</span>
    }

    /**
     * get the context for the AppletClassLoader we are creating.
     * the context is granted permission to create the class loader,
     * connnect to the codebase, and whatever else the policy grants
     * to all codebases.
     */
    private AccessControlContext getAccessControlContext(final URL codebase) {

<span class="nc" id="L1061">        PermissionCollection perms = (PermissionCollection)</span>
<span class="nc" id="L1062">            AccessController.doPrivileged(new PrivilegedAction() {</span>
                    public Object run() {
<span class="nc" id="L1064">                        Policy p = java.security.Policy.getPolicy();</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">                        if (p != null) {</span>
<span class="nc" id="L1066">                            return p.getPermissions(new CodeSource(null,</span>
                                                                   (java.security.cert.Certificate[]) null));
                        } else {
<span class="nc" id="L1069">                            return null;</span>
                        }
                    }
                });

<span class="nc bnc" id="L1074" title="All 2 branches missed.">        if (perms == null)</span>
<span class="nc" id="L1075">            perms = new Permissions();</span>

        //XXX: this is needed to be able to create the classloader itself!

<span class="nc" id="L1079">        perms.add(SecurityConstants.CREATE_CLASSLOADER_PERMISSION);</span>

        Permission p;
<span class="nc" id="L1082">        java.net.URLConnection urlConnection = null;</span>
        try {
<span class="nc" id="L1084">            urlConnection = codebase.openConnection();</span>
<span class="nc" id="L1085">            p = urlConnection.getPermission();</span>
<span class="nc" id="L1086">        } catch (java.io.IOException ioe) {</span>
<span class="nc" id="L1087">            p = null;</span>
<span class="nc" id="L1088">        }</span>

<span class="nc bnc" id="L1090" title="All 2 branches missed.">        if (p != null)</span>
<span class="nc" id="L1091">            perms.add(p);</span>

<span class="nc bnc" id="L1093" title="All 2 branches missed.">        if (p instanceof FilePermission) {</span>

<span class="nc" id="L1095">            String path = p.getName();</span>

<span class="nc" id="L1097">            int endIndex = path.lastIndexOf(File.separatorChar);</span>

<span class="nc bnc" id="L1099" title="All 2 branches missed.">            if (endIndex != -1) {</span>
<span class="nc" id="L1100">                path = path.substring(0, endIndex+1);</span>

<span class="nc bnc" id="L1102" title="All 2 branches missed.">                if (path.endsWith(File.separator)) {</span>
<span class="nc" id="L1103">                    path += &quot;-&quot;;</span>
                }
<span class="nc" id="L1105">                perms.add(new FilePermission(path,</span>
                                             SecurityConstants.FILE_READ_ACTION));
            }
<span class="nc" id="L1108">        } else {</span>
<span class="nc" id="L1109">            URL locUrl = codebase;</span>
<span class="nc bnc" id="L1110" title="All 2 branches missed.">            if (urlConnection instanceof JarURLConnection) {</span>
<span class="nc" id="L1111">                locUrl = ((JarURLConnection)urlConnection).getJarFileURL();</span>
            }
<span class="nc" id="L1113">            String host = locUrl.getHost();</span>
<span class="nc bnc" id="L1114" title="All 4 branches missed.">            if (host != null &amp;&amp; (host.length() &gt; 0))</span>
<span class="nc" id="L1115">                perms.add(new SocketPermission(host,</span>
                                               SecurityConstants.SOCKET_CONNECT_ACCEPT_ACTION));
        }

<span class="nc" id="L1119">        ProtectionDomain domain =</span>
            new ProtectionDomain(new CodeSource(codebase,
                                                (java.security.cert.Certificate[]) null), perms);
<span class="nc" id="L1122">        AccessControlContext acc =</span>
            new AccessControlContext(new ProtectionDomain[] { domain });

<span class="nc" id="L1125">        return acc;</span>
    }

    public Thread getAppletHandlerThread() {
<span class="nc" id="L1129">        return handler;</span>
    }

    public int getAppletWidth() {
<span class="nc" id="L1133">        return currentAppletSize.width;</span>
    }

    public int getAppletHeight() {
<span class="nc" id="L1137">        return currentAppletSize.height;</span>
    }

    public static void changeFrameAppContext(Frame frame, AppContext newAppContext)
    {
        // Fixed #4754451: Applet can have methods running on main
        // thread event queue.
        //
        // The cause of this bug is that the frame of the applet
        // is created in main thread group. Thus, when certain
        // AWT/Swing events are generated, the events will be
        // dispatched through the wrong event dispatch thread.
        //
        // To fix this, we rearrange the AppContext with the frame,
        // so the proper event queue will be looked up.
        //
        // Swing also maintains a Frame list for the AppContext,
        // so we will have to rearrange it as well.

        // Check if frame's AppContext has already been set properly
<span class="nc" id="L1157">        AppContext oldAppContext = SunToolkit.targetToAppContext(frame);</span>

<span class="nc bnc" id="L1159" title="All 2 branches missed.">        if (oldAppContext == newAppContext)</span>
<span class="nc" id="L1160">            return;</span>

        // Synchronization on Window.class is needed for locking the
        // critical section of the window list in AppContext.
<span class="nc" id="L1164">        synchronized (Window.class)</span>
        {
<span class="nc" id="L1166">            WeakReference weakRef = null;</span>
            // Remove frame from the Window list in wrong AppContext
            {
                // Lookup current frame's AppContext
<span class="nc" id="L1170">                Vector&lt;WeakReference&lt;Window&gt;&gt; windowList = (Vector&lt;WeakReference&lt;Window&gt;&gt;)oldAppContext.get(Window.class);</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">                if (windowList != null) {</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">                    for (WeakReference ref : windowList) {</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">                        if (ref.get() == frame) {</span>
<span class="nc" id="L1174">                            weakRef = ref;</span>
<span class="nc" id="L1175">                            break;</span>
                        }
<span class="nc" id="L1177">                    }</span>
                    // Remove frame from wrong AppContext
<span class="nc bnc" id="L1179" title="All 2 branches missed.">                    if (weakRef != null)</span>
<span class="nc" id="L1180">                        windowList.remove(weakRef);</span>
                }
            }

            // Put the frame into the applet's AppContext map
<span class="nc" id="L1185">            SunToolkit.insertTargetMapping(frame, newAppContext);</span>

            // Insert frame into the Window list in the applet's AppContext map
            {
<span class="nc" id="L1189">                Vector&lt;WeakReference&lt;Window&gt;&gt; windowList = (Vector)newAppContext.get(Window.class);</span>
<span class="nc bnc" id="L1190" title="All 2 branches missed.">                if (windowList == null) {</span>
<span class="nc" id="L1191">                    windowList = new Vector&lt;WeakReference&lt;Window&gt;&gt;();</span>
<span class="nc" id="L1192">                    newAppContext.put(Window.class, windowList);</span>
                }
                // use the same weakRef here as it is used elsewhere
<span class="nc" id="L1195">                windowList.add(weakRef);</span>
            }
<span class="nc" id="L1197">        }</span>
<span class="nc" id="L1198">    }</span>

    // Flag to indicate if applet is targeted for JDK 1.1.
<span class="nc" id="L1201">    private boolean jdk11Applet = false;</span>

    // Flag to indicate if applet is targeted for JDK 1.2.
<span class="nc" id="L1204">    private boolean jdk12Applet = false;</span>

    /**
     * Determine JDK level of an applet.
     */
    private void findAppletJDKLevel(Applet applet)
    {
        // To determine the JDK level of an applet, the
        // most reliable way is to check the major version
        // of the applet class file.

        // synchronized on applet class object, so calling from
        // different instances of the same applet will be
        // serialized.
<span class="nc" id="L1218">        Class appletClass = applet.getClass();</span>

<span class="nc" id="L1220">        synchronized(appletClass)  {</span>
            // Determine if the JDK level of an applet has been
            // checked before.
<span class="nc" id="L1223">            Boolean jdk11Target = (Boolean) loader.isJDK11Target(appletClass);</span>
<span class="nc" id="L1224">            Boolean jdk12Target = (Boolean) loader.isJDK12Target(appletClass);</span>

            // if applet JDK level has been checked before, retrieve
            // value and return.
<span class="nc bnc" id="L1228" title="All 4 branches missed.">            if (jdk11Target != null || jdk12Target != null) {</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">                jdk11Applet = (jdk11Target == null) ? false : jdk11Target.booleanValue();</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">                jdk12Applet = (jdk12Target == null) ? false : jdk12Target.booleanValue();</span>
<span class="nc" id="L1231">                return;</span>
            }

<span class="nc" id="L1234">            String name = appletClass.getName();</span>

            // first convert any '.' to '/'
<span class="nc" id="L1237">            name = name.replace('.', '/');</span>

            // append .class
<span class="nc" id="L1240">            final String resourceName = name + &quot;.class&quot;;</span>

<span class="nc" id="L1242">            InputStream is = null;</span>
<span class="nc" id="L1243">            byte[] classHeader = new byte[8];</span>

            try {
<span class="nc" id="L1246">                is = (InputStream) java.security.AccessController.doPrivileged(</span>
<span class="nc" id="L1247">                    new java.security.PrivilegedAction() {</span>
                        public Object run() {
<span class="nc" id="L1249">                            return loader.getResourceAsStream(resourceName);</span>
                        }
                    });

                // Read the first 8 bytes of the class file
<span class="nc" id="L1254">                int byteRead = is.read(classHeader, 0, 8);</span>
<span class="nc" id="L1255">                is.close();</span>

                // return if the header is not read in entirely
                // for some reasons.
<span class="nc bnc" id="L1259" title="All 2 branches missed.">                if (byteRead != 8)</span>
<span class="nc" id="L1260">                    return;</span>
            }
<span class="nc" id="L1262">            catch (IOException e)   {</span>
<span class="nc" id="L1263">                return;</span>
<span class="nc" id="L1264">            }</span>

            // Check major version in class file header
<span class="nc" id="L1267">            int major_version = readShort(classHeader, 6);</span>

            // Major version in class file is as follows:
            //   45 - JDK 1.1
            //   46 - JDK 1.2
            //   47 - JDK 1.3
            //   48 - JDK 1.4
            //   49 - JDK 1.5
<span class="nc bnc" id="L1275" title="All 2 branches missed.">            if (major_version &lt; 46)</span>
<span class="nc" id="L1276">                jdk11Applet = true;</span>
<span class="nc bnc" id="L1277" title="All 2 branches missed.">            else if (major_version == 46)</span>
<span class="nc" id="L1278">                jdk12Applet = true;</span>

            // Store applet JDK level in AppContext for later lookup,
            // e.g. page switch.
<span class="nc" id="L1282">            loader.setJDK11Target(appletClass, jdk11Applet);</span>
<span class="nc" id="L1283">            loader.setJDK12Target(appletClass, jdk12Applet);</span>
<span class="nc" id="L1284">        }</span>
<span class="nc" id="L1285">    }</span>

    /**
     * Return true if applet is targeted to JDK 1.1.
     */
    protected boolean isJDK11Applet()   {
<span class="nc" id="L1291">        return jdk11Applet;</span>
    }

    /**
     * Return true if applet is targeted to JDK1.2.
     */
    protected boolean isJDK12Applet()   {
<span class="nc" id="L1298">        return jdk12Applet;</span>
    }

    /**
     * Read short from byte array.
     */
    private int readShort(byte[] b, int off)    {
<span class="nc" id="L1305">        int hi = readByte(b[off]);</span>
<span class="nc" id="L1306">        int lo = readByte(b[off + 1]);</span>
<span class="nc" id="L1307">        return (hi &lt;&lt; 8) | lo;</span>
    }

    private int readByte(byte b) {
<span class="nc" id="L1311">        return ((int)b) &amp; 0xFF;</span>
    }


<span class="nc" id="L1315">    private static AppletMessageHandler amh = new AppletMessageHandler(&quot;appletpanel&quot;);</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>