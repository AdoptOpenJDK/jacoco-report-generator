<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AppletSecurity.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">sun.applet</a> &gt; <span class="el_source">AppletSecurity.java</span></div><h1>AppletSecurity.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1995, 2006, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.applet;

import java.io.File;
import java.io.FilePermission;
import java.io.IOException;
import java.io.FileDescriptor;
import java.net.URL;
import java.net.URLClassLoader;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.net.SocketPermission;
import java.util.Enumeration;
import java.util.Iterator;
import java.util.HashSet;
import java.util.StringTokenizer;
import java.security.*;
import java.lang.reflect.*;
import sun.awt.AWTSecurityManager;
import sun.awt.AppContext;
import sun.security.provider.*;
import sun.security.util.SecurityConstants;


/**
 * This class defines an applet security policy
 *
 */
public
class AppletSecurity extends AWTSecurityManager {

    //URLClassLoader.acc
<span class="nc" id="L57">    private static Field facc = null;</span>

    //AccessControlContext.context;
<span class="nc" id="L60">    private static Field fcontext = null;</span>

    static {
        try {
<span class="nc" id="L64">            facc = URLClassLoader.class.getDeclaredField(&quot;acc&quot;);</span>
<span class="nc" id="L65">            facc.setAccessible(true);</span>
<span class="nc" id="L66">            fcontext = AccessControlContext.class.getDeclaredField(&quot;context&quot;);</span>
<span class="nc" id="L67">            fcontext.setAccessible(true);</span>
<span class="nc" id="L68">        } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L69">            throw new UnsupportedOperationException(e);</span>
<span class="nc" id="L70">        }</span>
<span class="nc" id="L71">    }</span>


    /**
     * Construct and initialize.
     */
<span class="nc" id="L77">    public AppletSecurity() {</span>
<span class="nc" id="L78">        reset();</span>
<span class="nc" id="L79">    }</span>

    // Cache to store known restricted packages
<span class="nc" id="L82">    private HashSet restrictedPackages = new HashSet();</span>

    /**
     * Reset from Properties
     */
    public void reset()
    {
        // Clear cache
<span class="nc" id="L90">        restrictedPackages.clear();</span>

<span class="nc" id="L92">        AccessController.doPrivileged(new PrivilegedAction() {</span>
            public Object run()
            {
                // Enumerate system properties
<span class="nc" id="L96">                Enumeration e = System.getProperties().propertyNames();</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">                while (e.hasMoreElements())</span>
                {
<span class="nc" id="L100">                    String name = (String) e.nextElement();</span>

<span class="nc bnc" id="L102" title="All 4 branches missed.">                    if (name != null &amp;&amp; name.startsWith(&quot;package.restrict.access.&quot;))</span>
                    {
<span class="nc" id="L104">                        String value = System.getProperty(name);</span>

<span class="nc bnc" id="L106" title="All 4 branches missed.">                        if (value != null &amp;&amp; value.equalsIgnoreCase(&quot;true&quot;))</span>
                        {
<span class="nc" id="L108">                            String pkg = name.substring(24);</span>

                            // Cache restricted packages
<span class="nc" id="L111">                            restrictedPackages.add(pkg);</span>
                        }
                    }
<span class="nc" id="L114">                }</span>
<span class="nc" id="L115">                return null;</span>
            }
        });
<span class="nc" id="L118">    }</span>

    /**
     * get the current (first) instance of an AppletClassLoader on the stack.
     */
    private AppletClassLoader currentAppletClassLoader()
    {
        // try currentClassLoader first
<span class="nc" id="L126">        ClassLoader loader = currentClassLoader();</span>

<span class="nc bnc" id="L128" title="All 4 branches missed.">        if ((loader == null) || (loader instanceof AppletClassLoader))</span>
<span class="nc" id="L129">            return (AppletClassLoader)loader;</span>

        // if that fails, get all the classes on the stack and check them.
<span class="nc" id="L132">        Class[] context = getClassContext();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        for (int i = 0; i &lt; context.length; i++) {</span>
<span class="nc" id="L134">            loader = context[i].getClassLoader();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (loader instanceof AppletClassLoader)</span>
<span class="nc" id="L136">                return (AppletClassLoader)loader;</span>
        }

        /*
         * fix bug # 6433620 the logic here is : try to find URLClassLoader from
         * class context, check its AccessControlContext to see if
         * AppletClassLoader is in stack when it's created. for this kind of
         * URLClassLoader, return the AppContext associated with the
         * AppletClassLoader.
         */
<span class="nc bnc" id="L146" title="All 2 branches missed.">        for (int i = 0; i &lt; context.length; i++) {</span>
<span class="nc" id="L147">            final ClassLoader currentLoader = context[i].getClassLoader();</span>

<span class="nc bnc" id="L149" title="All 2 branches missed.">            if (currentLoader instanceof URLClassLoader) {</span>
<span class="nc" id="L150">                loader = (ClassLoader) AccessController.doPrivileged(new PrivilegedAction() {</span>
                    public Object run() {

<span class="nc" id="L153">                        AccessControlContext acc = null;</span>
<span class="nc" id="L154">                        ProtectionDomain[] pds = null;</span>

                        try {
<span class="nc" id="L157">                            acc = (AccessControlContext) facc.get(currentLoader);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                            if (acc == null) {</span>
<span class="nc" id="L159">                                return null;</span>
                            }

<span class="nc" id="L162">                            pds = (ProtectionDomain[]) fcontext.get(acc);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                            if (pds == null) {</span>
<span class="nc" id="L164">                                return null;</span>
                            }
<span class="nc" id="L166">                        } catch (Exception e) {</span>
<span class="nc" id="L167">                            throw new UnsupportedOperationException(e);</span>
<span class="nc" id="L168">                        }</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">                        for (int i=0; i&lt;pds.length; i++) {</span>
<span class="nc" id="L171">                            ClassLoader cl = pds[i].getClassLoader();</span>

<span class="nc bnc" id="L173" title="All 2 branches missed.">                            if (cl instanceof AppletClassLoader) {</span>
<span class="nc" id="L174">                                    return cl;</span>
                            }
                        }

<span class="nc" id="L178">                        return null;</span>
                    }
                });

<span class="nc bnc" id="L182" title="All 2 branches missed.">                if (loader != null) {</span>
<span class="nc" id="L183">                    return (AppletClassLoader) loader;</span>
                }
            }
        }

        // if that fails, try the context class loader
<span class="nc" id="L189">        loader = Thread.currentThread().getContextClassLoader();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (loader instanceof AppletClassLoader)</span>
<span class="nc" id="L191">            return (AppletClassLoader)loader;</span>

        // no AppletClassLoaders on the stack
<span class="nc" id="L194">        return (AppletClassLoader)null;</span>
    }

    /**
     * Returns true if this threadgroup is in the applet's own thread
     * group. This will return false if there is no current class
     * loader.
     */
    protected boolean inThreadGroup(ThreadGroup g) {
<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (currentAppletClassLoader() == null)</span>
<span class="nc" id="L204">            return false;</span>
        else
<span class="nc" id="L206">            return getThreadGroup().parentOf(g);</span>
    }

    /**
     * Returns true of the threadgroup of thread is in the applet's
     * own threadgroup.
     */
    protected boolean inThreadGroup(Thread thread) {
<span class="nc" id="L214">        return inThreadGroup(thread.getThreadGroup());</span>
    }

    /**
     * Applets are not allowed to manipulate threads outside
     * applet thread groups. However a terminated thread no longer belongs
     * to any group.
     */
    public void checkAccess(Thread t) {
        /* When multiple applets is reloaded simultaneously, there will be
         * multiple invocations to this method from plugin's SecurityManager.
         * This method should not be synchronized to avoid deadlock when
         * a page with multiple applets is reloaded
         */
<span class="nc bnc" id="L228" title="All 4 branches missed.">        if ((t.getState() != Thread.State.TERMINATED) &amp;&amp; !inThreadGroup(t)) {</span>
<span class="nc" id="L229">            checkPermission(SecurityConstants.MODIFY_THREAD_PERMISSION);</span>
        }
<span class="nc" id="L231">    }</span>

<span class="nc" id="L233">    private boolean inThreadGroupCheck = false;</span>

    /**
     * Applets are not allowed to manipulate thread groups outside
     * applet thread groups.
     */
    public synchronized void checkAccess(ThreadGroup g) {
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (inThreadGroupCheck) {</span>
            // if we are in a recursive check, it is because
            // inThreadGroup is calling appletLoader.getThreadGroup
            // in that case, only do the super check, as appletLoader
            // has a begin/endPrivileged
<span class="nc" id="L245">            checkPermission(SecurityConstants.MODIFY_THREADGROUP_PERMISSION);</span>
        } else {
            try {
<span class="nc" id="L248">                inThreadGroupCheck = true;</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (!inThreadGroup(g)) {</span>
<span class="nc" id="L250">                    checkPermission(SecurityConstants.MODIFY_THREADGROUP_PERMISSION);</span>
                }
            } finally {
<span class="nc" id="L253">                inThreadGroupCheck = false;</span>
<span class="nc" id="L254">            }</span>
        }
<span class="nc" id="L256">    }</span>


    /**
     * Throws a &lt;code&gt;SecurityException&lt;/code&gt; if the
     * calling thread is not allowed to access the package specified by
     * the argument.
     * &lt;p&gt;
     * This method is used by the &lt;code&gt;loadClass&lt;/code&gt; method of class
     * loaders.
     * &lt;p&gt;
     * The &lt;code&gt;checkPackageAccess&lt;/code&gt; method for class
     * &lt;code&gt;SecurityManager&lt;/code&gt;  calls
     * &lt;code&gt;checkPermission&lt;/code&gt; with the
     * &lt;code&gt;RuntimePermission(&quot;accessClassInPackage.&quot;+pkg)&lt;/code&gt;
     * permission.
     *
     * @param      pkg   the package name.
     * @exception  SecurityException  if the caller does not have
     *             permission to access the specified package.
     * @see        java.lang.ClassLoader#loadClass(java.lang.String, boolean)
     */
    public void checkPackageAccess(final String pkgname) {

        // first see if the VM-wide policy allows access to this package
<span class="nc" id="L281">        super.checkPackageAccess(pkgname);</span>

        // now check the list of restricted packages
<span class="nc bnc" id="L284" title="All 2 branches missed.">        for (Iterator iter = restrictedPackages.iterator(); iter.hasNext();)</span>
        {
<span class="nc" id="L286">            String pkg = (String) iter.next();</span>

            // Prevent matching &quot;sun&quot; and &quot;sunir&quot; even if they
            // starts with similar beginning characters
            //
<span class="nc bnc" id="L291" title="All 4 branches missed.">            if (pkgname.equals(pkg) || pkgname.startsWith(pkg + &quot;.&quot;))</span>
            {
<span class="nc" id="L293">                checkPermission(new java.lang.RuntimePermission</span>
                            (&quot;accessClassInPackage.&quot; + pkgname));
            }
<span class="nc" id="L296">        }</span>
<span class="nc" id="L297">    }</span>

    /**
     * Tests if a client can get access to the AWT event queue.
     * &lt;p&gt;
     * This method calls &lt;code&gt;checkPermission&lt;/code&gt; with the
     * &lt;code&gt;AWTPermission(&quot;accessEventQueue&quot;)&lt;/code&gt; permission.
     *
     * @since   JDK1.1
     * @exception  SecurityException  if the caller does not have
     *             permission to access the AWT event queue.
     */
    public void checkAwtEventQueueAccess() {
<span class="nc" id="L310">        AppContext appContext = AppContext.getAppContext();</span>
<span class="nc" id="L311">        AppletClassLoader appletClassLoader = currentAppletClassLoader();</span>

<span class="nc bnc" id="L313" title="All 4 branches missed.">        if (AppContext.isMainContext(appContext) &amp;&amp; (appletClassLoader != null)) {</span>
            // If we're about to allow access to the main EventQueue,
            // and anything untrusted is on the class context stack,
            // disallow access.
<span class="nc" id="L317">            super.checkPermission(SecurityConstants.AWT.CHECK_AWT_EVENTQUEUE_PERMISSION);</span>
        }
<span class="nc" id="L319">    } // checkAwtEventQueueAccess()</span>

    /**
     * Returns the thread group of the applet. We consult the classloader
     * if there is one.
     */
    public ThreadGroup getThreadGroup() {
        /* If any applet code is on the execution stack, we return
           that applet's ThreadGroup.  Otherwise, we use the default
           behavior. */
<span class="nc" id="L329">        AppletClassLoader appletLoader = currentAppletClassLoader();</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">        ThreadGroup loaderGroup = (appletLoader == null) ? null</span>
<span class="nc" id="L331">                                          : appletLoader.getThreadGroup();</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (loaderGroup != null) {</span>
<span class="nc" id="L333">            return loaderGroup;</span>
        } else {
<span class="nc" id="L335">            return super.getThreadGroup();</span>
        }
    } // getThreadGroup()

    /**
      * Get the AppContext corresponding to the current context.
      * The default implementation returns null, but this method
      * may be overridden by various SecurityManagers
      * (e.g. AppletSecurity) to index AppContext objects by the
      * calling context.
      *
      * @return  the AppContext corresponding to the current context.
      * @see     sun.awt.AppContext
      * @see     java.lang.SecurityManager
      * @since   JDK1.2.1
      */
    public AppContext getAppContext() {
<span class="nc" id="L352">        AppletClassLoader appletLoader = currentAppletClassLoader();</span>

<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (appletLoader == null) {</span>
<span class="nc" id="L355">            return null;</span>
        } else {
<span class="nc" id="L357">            AppContext context =  appletLoader.getAppContext();</span>

            // context == null when some thread in applet thread group
            // has not been destroyed in AppContext.dispose()
<span class="nc bnc" id="L361" title="All 2 branches missed.">            if (context == null) {</span>
<span class="nc" id="L362">                throw new SecurityException(&quot;Applet classloader has invalid AppContext&quot;);</span>
            }

<span class="nc" id="L365">            return context;</span>
        }
    }

} // class AppletSecurity
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>