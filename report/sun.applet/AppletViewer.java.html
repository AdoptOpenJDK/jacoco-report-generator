<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>AppletViewer.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">sun.applet</a> &gt; <span class="el_source">AppletViewer.java</span></div><h1>AppletViewer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 1995, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.applet;

import java.util.*;
import java.io.*;
import java.awt.*;
import java.awt.event.*;
import java.awt.print.*;
import javax.print.attribute.*;
import java.applet.*;
import java.net.URL;
import java.net.MalformedURLException;
import java.net.SocketPermission;
import sun.misc.Ref;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import sun.awt.SunToolkit;
import sun.awt.AppContext;
import java.lang.ref.WeakReference;

/**
 * A frame to show the applet tag in.
 */
class TextFrame extends Frame {

    /**
     * Create the tag frame.
     */
<span class="nc" id="L55">    TextFrame(int x, int y, String title, String text) {</span>
<span class="nc" id="L56">        setTitle(title);</span>
<span class="nc" id="L57">        TextArea txt = new TextArea(20, 60);</span>
<span class="nc" id="L58">        txt.setText(text);</span>
<span class="nc" id="L59">        txt.setEditable(false);</span>

<span class="nc" id="L61">        add(&quot;Center&quot;, txt);</span>

<span class="nc" id="L63">        Panel p = new Panel();</span>
<span class="nc" id="L64">        add(&quot;South&quot;, p);</span>
<span class="nc" id="L65">        Button b = new Button(amh.getMessage(&quot;button.dismiss&quot;, &quot;Dismiss&quot;));</span>
<span class="nc" id="L66">        p.add(b);</span>

<span class="nc" id="L68">        class ActionEventListener implements ActionListener {</span>
            public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L70">                dispose();</span>
<span class="nc" id="L71">            }</span>
        }
<span class="nc" id="L73">        b.addActionListener(new ActionEventListener());</span>

<span class="nc" id="L75">        pack();</span>
<span class="nc" id="L76">        move(x, y);</span>
<span class="nc" id="L77">        setVisible(true);</span>

<span class="nc" id="L79">        WindowListener windowEventListener = new WindowAdapter() {</span>

            public void windowClosing(WindowEvent evt) {
<span class="nc" id="L82">                dispose();</span>
<span class="nc" id="L83">            }</span>
        };

<span class="nc" id="L86">        addWindowListener(windowEventListener);</span>
<span class="nc" id="L87">    }</span>
<span class="nc" id="L88">    private static AppletMessageHandler amh = new AppletMessageHandler(&quot;textframe&quot;);</span>

}

/**
 * Lets us construct one using unix-style one shot behaviors
 */

<span class="nc" id="L96">class StdAppletViewerFactory implements AppletViewerFactory</span>
{
    public AppletViewer createAppletViewer(int x, int y,
                                           URL doc, Hashtable atts) {
<span class="nc" id="L100">        return new AppletViewer(x, y, doc, atts, System.out, this);</span>
    }

    public MenuBar getBaseMenuBar() {
<span class="nc" id="L104">        return new MenuBar();</span>
    }

    public boolean isStandalone() {
<span class="nc" id="L108">        return true;</span>
    }
}

/**
 * The applet viewer makes it possible to run a Java applet without using a browser.
 * For details on the syntax that &lt;B&gt;appletviewer&lt;/B&gt; supports, see
 * &lt;a href=&quot;../../../docs/tooldocs/appletviewertags.html&quot;&gt;AppletViewer Tags&lt;/a&gt;.
 * (The document named appletviewertags.html in the JDK's docs/tooldocs directory,
 *  once the JDK docs have been installed.)
 */
public class AppletViewer extends Frame implements AppletContext,
                                                   Printable {

    /**
     * Some constants...
     */
<span class="nc" id="L125">    private static String defaultSaveFile = &quot;Applet.ser&quot;;</span>

    /**
     * The panel in which the applet is being displayed.
     */
    AppletViewerPanel panel;

    /**
     * The status line.
     */
    Label label;

    /**
     * output status messages to this stream
     */

    PrintStream statusMsgStream;

    /**
     * For cloning
     */
    AppletViewerFactory factory;


<span class="nc" id="L149">    private final class UserActionListener implements ActionListener {</span>
        public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L151">            processUserAction(evt);</span>
<span class="nc" id="L152">        }</span>
    }

    /**
     * Create the applet viewer
     */
    public AppletViewer(int x, int y, URL doc, Hashtable atts,
<span class="nc" id="L159">                        PrintStream statusMsgStream, AppletViewerFactory factory) {</span>
<span class="nc" id="L160">        this.factory = factory;</span>
<span class="nc" id="L161">        this.statusMsgStream = statusMsgStream;</span>
<span class="nc" id="L162">        setTitle(amh.getMessage(&quot;tool.title&quot;, atts.get(&quot;code&quot;)));</span>

<span class="nc" id="L164">        MenuBar mb = factory.getBaseMenuBar();</span>

<span class="nc" id="L166">        Menu m = new Menu(amh.getMessage(&quot;menu.applet&quot;));</span>

<span class="nc" id="L168">        addMenuItem(m, &quot;menuitem.restart&quot;);</span>
<span class="nc" id="L169">        addMenuItem(m, &quot;menuitem.reload&quot;);</span>
<span class="nc" id="L170">        addMenuItem(m, &quot;menuitem.stop&quot;);</span>
<span class="nc" id="L171">        addMenuItem(m, &quot;menuitem.save&quot;);</span>
<span class="nc" id="L172">        addMenuItem(m, &quot;menuitem.start&quot;);</span>
<span class="nc" id="L173">        addMenuItem(m, &quot;menuitem.clone&quot;);</span>
<span class="nc" id="L174">        m.add(new MenuItem(&quot;-&quot;));</span>
<span class="nc" id="L175">        addMenuItem(m, &quot;menuitem.tag&quot;);</span>
<span class="nc" id="L176">        addMenuItem(m, &quot;menuitem.info&quot;);</span>
<span class="nc" id="L177">        addMenuItem(m, &quot;menuitem.edit&quot;).disable();</span>
<span class="nc" id="L178">        addMenuItem(m, &quot;menuitem.encoding&quot;);</span>
<span class="nc" id="L179">        m.add(new MenuItem(&quot;-&quot;));</span>
<span class="nc" id="L180">        addMenuItem(m, &quot;menuitem.print&quot;);</span>
<span class="nc" id="L181">        m.add(new MenuItem(&quot;-&quot;));</span>
<span class="nc" id="L182">        addMenuItem(m, &quot;menuitem.props&quot;);</span>
<span class="nc" id="L183">        m.add(new MenuItem(&quot;-&quot;));</span>
<span class="nc" id="L184">        addMenuItem(m, &quot;menuitem.close&quot;);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (factory.isStandalone()) {</span>
<span class="nc" id="L186">            addMenuItem(m, &quot;menuitem.quit&quot;);</span>
        }

<span class="nc" id="L189">        mb.add(m);</span>

<span class="nc" id="L191">        setMenuBar(mb);</span>

<span class="nc" id="L193">        add(&quot;Center&quot;, panel = new AppletViewerPanel(doc, atts));</span>
<span class="nc" id="L194">        add(&quot;South&quot;, label = new Label(amh.getMessage(&quot;label.hello&quot;)));</span>
<span class="nc" id="L195">        panel.init();</span>
<span class="nc" id="L196">        appletPanels.addElement(panel);</span>

<span class="nc" id="L198">        pack();</span>
<span class="nc" id="L199">        move(x, y);</span>
<span class="nc" id="L200">        setVisible(true);</span>

<span class="nc" id="L202">        WindowListener windowEventListener = new WindowAdapter() {</span>

            public void windowClosing(WindowEvent evt) {
<span class="nc" id="L205">                appletClose();</span>
<span class="nc" id="L206">            }</span>

            public void windowIconified(WindowEvent evt) {
<span class="nc" id="L209">                appletStop();</span>
<span class="nc" id="L210">            }</span>

            public void windowDeiconified(WindowEvent evt) {
<span class="nc" id="L213">                appletStart();</span>
<span class="nc" id="L214">            }</span>
        };

        class AppletEventListener implements AppletListener
        {
            final Frame frame;

            public AppletEventListener(Frame frame)
<span class="nc" id="L222">            {</span>
<span class="nc" id="L223">                this.frame = frame;</span>
<span class="nc" id="L224">            }</span>

            public void appletStateChanged(AppletEvent evt)
            {
<span class="nc" id="L228">                AppletPanel src = (AppletPanel)evt.getSource();</span>

<span class="nc bnc" id="L230" title="All 3 branches missed.">                switch (evt.getID()) {</span>
                    case AppletPanel.APPLET_RESIZE: {
<span class="nc bnc" id="L232" title="All 2 branches missed.">                        if(src != null) {</span>
<span class="nc" id="L233">                            resize(preferredSize());</span>
<span class="nc" id="L234">                            validate();</span>
                        }
                        break;
                    }
                    case AppletPanel.APPLET_LOADING_COMPLETED: {
<span class="nc" id="L239">                        Applet a = src.getApplet(); // sun.applet.AppletPanel</span>

                        // Fixed #4754451: Applet can have methods running on main
                        // thread event queue.
                        //
                        // The cause of this bug is that the frame of the applet
                        // is created in main thread group. Thus, when certain
                        // AWT/Swing events are generated, the events will be
                        // dispatched through the wrong event dispatch thread.
                        //
                        // To fix this, we rearrange the AppContext with the frame,
                        // so the proper event queue will be looked up.
                        //
                        // Swing also maintains a Frame list for the AppContext,
                        // so we will have to rearrange it as well.
                        //
<span class="nc bnc" id="L255" title="All 2 branches missed.">                        if (a != null)</span>
<span class="nc" id="L256">                            AppletPanel.changeFrameAppContext(frame, SunToolkit.targetToAppContext(a));</span>
                        else
<span class="nc" id="L258">                            AppletPanel.changeFrameAppContext(frame, AppContext.getAppContext());</span>

<span class="nc" id="L260">                        break;</span>
                    }
                }
<span class="nc" id="L263">            }</span>
        };

<span class="nc" id="L266">        addWindowListener(windowEventListener);</span>
<span class="nc" id="L267">        panel.addAppletListener(new AppletEventListener(this));</span>

        // Start the applet
<span class="nc" id="L270">        showStatus(amh.getMessage(&quot;status.start&quot;));</span>
<span class="nc" id="L271">        initEventQueue();</span>
<span class="nc" id="L272">    }</span>

    // XXX 99/9/10 probably should be &quot;private&quot;
    public MenuItem addMenuItem(Menu m, String s) {
<span class="nc" id="L276">        MenuItem mItem = new MenuItem(amh.getMessage(s));</span>
<span class="nc" id="L277">        mItem.addActionListener(new UserActionListener());</span>
<span class="nc" id="L278">        return m.add(mItem);</span>
    }

    /**
     * Send the initial set of events to the appletviewer event queue.
     * On start-up the current behaviour is to load the applet and call
     * Applet.init() and Applet.start().
     */
    private void initEventQueue() {
        // appletviewer.send.event is an undocumented and unsupported system
        // property which is used exclusively for testing purposes.
<span class="nc" id="L289">        String eventList = System.getProperty(&quot;appletviewer.send.event&quot;);</span>

<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (eventList == null) {</span>
            // Add the standard events onto the event queue.
<span class="nc" id="L293">            panel.sendEvent(AppletPanel.APPLET_LOAD);</span>
<span class="nc" id="L294">            panel.sendEvent(AppletPanel.APPLET_INIT);</span>
<span class="nc" id="L295">            panel.sendEvent(AppletPanel.APPLET_START);</span>
        } else {
            // We're testing AppletViewer.  Force the specified set of events
            // onto the event queue, wait for the events to be processed, and
            // exit.

            // The list of events that will be executed is provided as a
            // &quot;,&quot;-separated list.  No error-checking will be done on the list.
<span class="nc" id="L303">            String [] events = splitSeparator(&quot;,&quot;, eventList);</span>

<span class="nc bnc" id="L305" title="All 2 branches missed.">            for (int i = 0; i &lt; events.length; i++) {</span>
<span class="nc" id="L306">                System.out.println(&quot;Adding event to queue: &quot; + events[i]);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                if (events[i].equals(&quot;dispose&quot;))</span>
<span class="nc" id="L308">                    panel.sendEvent(AppletPanel.APPLET_DISPOSE);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">                else if (events[i].equals(&quot;load&quot;))</span>
<span class="nc" id="L310">                    panel.sendEvent(AppletPanel.APPLET_LOAD);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                else if (events[i].equals(&quot;init&quot;))</span>
<span class="nc" id="L312">                    panel.sendEvent(AppletPanel.APPLET_INIT);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">                else if (events[i].equals(&quot;start&quot;))</span>
<span class="nc" id="L314">                    panel.sendEvent(AppletPanel.APPLET_START);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                else if (events[i].equals(&quot;stop&quot;))</span>
<span class="nc" id="L316">                    panel.sendEvent(AppletPanel.APPLET_STOP);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                else if (events[i].equals(&quot;destroy&quot;))</span>
<span class="nc" id="L318">                    panel.sendEvent(AppletPanel.APPLET_DESTROY);</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                else if (events[i].equals(&quot;quit&quot;))</span>
<span class="nc" id="L320">                    panel.sendEvent(AppletPanel.APPLET_QUIT);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                else if (events[i].equals(&quot;error&quot;))</span>
<span class="nc" id="L322">                    panel.sendEvent(AppletPanel.APPLET_ERROR);</span>
                else
                    // non-fatal error if we get an unrecognized event
<span class="nc" id="L325">                    System.out.println(&quot;Unrecognized event name: &quot; + events[i]);</span>
            }

<span class="nc bnc" id="L328" title="All 2 branches missed.">            while (!panel.emptyEventQueue()) ;</span>
<span class="nc" id="L329">            appletSystemExit();</span>
        }
<span class="nc" id="L331">    }</span>

    /**
     * Split a string based on the presence of a specified separator.  Returns
     * an array of arbitrary length.  The end of each element in the array is
     * indicated by the separator of the end of the string.  If there is a
     * separator immediately before the end of the string, the final element
     * will be empty.  None of the strings will contain the separator.  Useful
     * when separating strings such as &quot;foo/bar/bas&quot; using separator &quot;/&quot;.
     *
     * @param sep  The separator.
     * @param s    The string to split.
     * @return     An array of strings.  Each string in the array is determined
     *             by the location of the provided sep in the original string,
     *             s.  Whitespace not stripped.
     */
    private String [] splitSeparator(String sep, String s) {
<span class="nc" id="L348">        Vector v = new Vector();</span>
<span class="nc" id="L349">        int tokenStart = 0;</span>
<span class="nc" id="L350">        int tokenEnd   = 0;</span>

<span class="nc bnc" id="L352" title="All 2 branches missed.">        while ((tokenEnd = s.indexOf(sep, tokenStart)) != -1) {</span>
<span class="nc" id="L353">            v.addElement(s.substring(tokenStart, tokenEnd));</span>
<span class="nc" id="L354">            tokenStart = tokenEnd+1;</span>
        }
        // Add the final element.
<span class="nc" id="L357">        v.addElement(s.substring(tokenStart));</span>

<span class="nc" id="L359">        String [] retVal = new String[v.size()];</span>
<span class="nc" id="L360">        v.copyInto(retVal);</span>
<span class="nc" id="L361">        return retVal;</span>
    }

    /*
     * Methods for java.applet.AppletContext
     */

<span class="nc" id="L368">    private static Map audioClips = new HashMap();</span>

    /**
     * Get an audio clip.
     */
    public AudioClip getAudioClip(URL url) {
<span class="nc" id="L374">        checkConnect(url);</span>
<span class="nc" id="L375">        synchronized (audioClips) {</span>
<span class="nc" id="L376">            AudioClip clip = (AudioClip)audioClips.get(url);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            if (clip == null) {</span>
<span class="nc" id="L378">                audioClips.put(url, clip = new AppletAudioClip(url));</span>
            }
<span class="nc" id="L380">            return clip;</span>
<span class="nc" id="L381">        }</span>
    }

<span class="nc" id="L384">    private static Map imageRefs = new HashMap();</span>

    /**
     * Get an image.
     */
    public Image getImage(URL url) {
<span class="nc" id="L390">        return getCachedImage(url);</span>
    }

    static Image getCachedImage(URL url) {
        // System.getSecurityManager().checkConnection(url.getHost(), url.getPort());
<span class="nc" id="L395">        return (Image)getCachedImageRef(url).get();</span>
    }

    /**
     * Get an image ref.
     */
    static Ref getCachedImageRef(URL url) {
<span class="nc" id="L402">        synchronized (imageRefs) {</span>
<span class="nc" id="L403">            AppletImageRef ref = (AppletImageRef)imageRefs.get(url);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (ref == null) {</span>
<span class="nc" id="L405">                ref = new AppletImageRef(url);</span>
<span class="nc" id="L406">                imageRefs.put(url, ref);</span>
            }
<span class="nc" id="L408">            return ref;</span>
<span class="nc" id="L409">        }</span>
    }

    /**
     * Flush the image cache.
     */
    static void flushImageCache() {
<span class="nc" id="L416">        imageRefs.clear();</span>
<span class="nc" id="L417">    }</span>

<span class="nc" id="L419">    static Vector appletPanels = new Vector();</span>

    /**
     * Get an applet by name.
     */
    public Applet getApplet(String name) {
<span class="nc" id="L425">        AppletSecurity security = (AppletSecurity)System.getSecurityManager();</span>
<span class="nc" id="L426">        name = name.toLowerCase();</span>
<span class="nc" id="L427">        SocketPermission panelSp =</span>
<span class="nc" id="L428">            new SocketPermission(panel.getCodeBase().getHost(), &quot;connect&quot;);</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">        for (Enumeration e = appletPanels.elements() ; e.hasMoreElements() ;) {</span>
<span class="nc" id="L430">            AppletPanel p = (AppletPanel)e.nextElement();</span>
<span class="nc" id="L431">            String param = p.getParameter(&quot;name&quot;);</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">            if (param != null) {</span>
<span class="nc" id="L433">                param = param.toLowerCase();</span>
            }
<span class="nc bnc" id="L435" title="All 2 branches missed.">            if (name.equals(param) &amp;&amp;</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">                p.getDocumentBase().equals(panel.getDocumentBase())) {</span>

<span class="nc" id="L438">                SocketPermission sp =</span>
<span class="nc" id="L439">                    new SocketPermission(p.getCodeBase().getHost(), &quot;connect&quot;);</span>

<span class="nc bnc" id="L441" title="All 2 branches missed.">                if (panelSp.implies(sp)) {</span>
<span class="nc" id="L442">                    return p.applet;</span>
                }
            }
<span class="nc" id="L445">        }</span>
<span class="nc" id="L446">        return null;</span>
    }

    /**
     * Return an enumeration of all the accessible
     * applets on this page.
     */
    public Enumeration getApplets() {
<span class="nc" id="L454">        AppletSecurity security = (AppletSecurity)System.getSecurityManager();</span>
<span class="nc" id="L455">        Vector v = new Vector();</span>
<span class="nc" id="L456">        SocketPermission panelSp =</span>
<span class="nc" id="L457">            new SocketPermission(panel.getCodeBase().getHost(), &quot;connect&quot;);</span>

<span class="nc bnc" id="L459" title="All 2 branches missed.">        for (Enumeration e = appletPanels.elements() ; e.hasMoreElements() ;) {</span>
<span class="nc" id="L460">            AppletPanel p = (AppletPanel)e.nextElement();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">            if (p.getDocumentBase().equals(panel.getDocumentBase())) {</span>

<span class="nc" id="L463">                SocketPermission sp =</span>
<span class="nc" id="L464">                    new SocketPermission(p.getCodeBase().getHost(), &quot;connect&quot;);</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">                if (panelSp.implies(sp)) {</span>
<span class="nc" id="L466">                    v.addElement(p.applet);</span>
                }
            }
<span class="nc" id="L469">        }</span>
<span class="nc" id="L470">        return v.elements();</span>
    }

    /**
     * Ignore.
     */
    public void showDocument(URL url) {
<span class="nc" id="L477">    }</span>

    /**
     * Ignore.
     */
    public void showDocument(URL url, String target) {
<span class="nc" id="L483">    }</span>

    /**
     * Show status.
     */
    public void showStatus(String status) {
<span class="nc" id="L489">        label.setText(status);</span>
<span class="nc" id="L490">    }</span>

    public void setStream(String key, InputStream stream)throws IOException{
        // We do nothing.
<span class="nc" id="L494">    }</span>

    public InputStream getStream(String key){
        // We do nothing.
<span class="nc" id="L498">        return null;</span>
    }

    public Iterator getStreamKeys(){
        // We do nothing.
<span class="nc" id="L503">        return null;</span>
    }

    /**
     * System parameters.
     */
<span class="nc" id="L509">    static Hashtable systemParam = new Hashtable();</span>

    static {
<span class="nc" id="L512">        systemParam.put(&quot;codebase&quot;, &quot;codebase&quot;);</span>
<span class="nc" id="L513">        systemParam.put(&quot;code&quot;, &quot;code&quot;);</span>
<span class="nc" id="L514">        systemParam.put(&quot;alt&quot;, &quot;alt&quot;);</span>
<span class="nc" id="L515">        systemParam.put(&quot;width&quot;, &quot;width&quot;);</span>
<span class="nc" id="L516">        systemParam.put(&quot;height&quot;, &quot;height&quot;);</span>
<span class="nc" id="L517">        systemParam.put(&quot;align&quot;, &quot;align&quot;);</span>
<span class="nc" id="L518">        systemParam.put(&quot;vspace&quot;, &quot;vspace&quot;);</span>
<span class="nc" id="L519">        systemParam.put(&quot;hspace&quot;, &quot;hspace&quot;);</span>
    }

    /**
     * Print the HTML tag.
     */
    public static void printTag(PrintStream out, Hashtable atts) {
<span class="nc" id="L526">        out.print(&quot;&lt;applet&quot;);</span>

<span class="nc" id="L528">        String v = (String)atts.get(&quot;codebase&quot;);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (v != null) {</span>
<span class="nc" id="L530">            out.print(&quot; codebase=\&quot;&quot; + v + &quot;\&quot;&quot;);</span>
        }

<span class="nc" id="L533">        v = (String)atts.get(&quot;code&quot;);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">        if (v == null) {</span>
<span class="nc" id="L535">            v = &quot;applet.class&quot;;</span>
        }
<span class="nc" id="L537">        out.print(&quot; code=\&quot;&quot; + v + &quot;\&quot;&quot;);</span>
<span class="nc" id="L538">        v = (String)atts.get(&quot;width&quot;);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">        if (v == null) {</span>
<span class="nc" id="L540">            v = &quot;150&quot;;</span>
        }
<span class="nc" id="L542">        out.print(&quot; width=&quot; + v);</span>

<span class="nc" id="L544">        v = (String)atts.get(&quot;height&quot;);</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if (v == null) {</span>
<span class="nc" id="L546">            v = &quot;100&quot;;</span>
        }
<span class="nc" id="L548">        out.print(&quot; height=&quot; + v);</span>

<span class="nc" id="L550">        v = (String)atts.get(&quot;name&quot;);</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">        if (v != null) {</span>
<span class="nc" id="L552">            out.print(&quot; name=\&quot;&quot; + v + &quot;\&quot;&quot;);</span>
        }
<span class="nc" id="L554">        out.println(&quot;&gt;&quot;);</span>

        // A very slow sorting algorithm
<span class="nc" id="L557">        int len = atts.size();</span>
<span class="nc" id="L558">        String params[] = new String[len];</span>
<span class="nc" id="L559">        len = 0;</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">        for (Enumeration e = atts.keys() ; e.hasMoreElements() ;) {</span>
<span class="nc" id="L561">            String param = (String)e.nextElement();</span>
<span class="nc" id="L562">            int i = 0;</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">            for (; i &lt; len ; i++) {</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">                if (params[i].compareTo(param) &gt;= 0) {</span>
<span class="nc" id="L565">                    break;</span>
                }
            }
<span class="nc" id="L568">            System.arraycopy(params, i, params, i + 1, len - i);</span>
<span class="nc" id="L569">            params[i] = param;</span>
<span class="nc" id="L570">            len++;</span>
<span class="nc" id="L571">        }</span>

<span class="nc bnc" id="L573" title="All 2 branches missed.">        for (int i = 0 ; i &lt; len ; i++) {</span>
<span class="nc" id="L574">            String param = params[i];</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">            if (systemParam.get(param) == null) {</span>
<span class="nc" id="L576">                out.println(&quot;&lt;param name=&quot; + param +</span>
<span class="nc" id="L577">                            &quot; value=\&quot;&quot; + atts.get(param) + &quot;\&quot;&gt;&quot;);</span>
            }
        }
<span class="nc" id="L580">        out.println(&quot;&lt;/applet&gt;&quot;);</span>
<span class="nc" id="L581">    }</span>

    /**
     * Make sure the atrributes are uptodate.
     */
    public void updateAtts() {
<span class="nc" id="L587">        Dimension d = panel.size();</span>
<span class="nc" id="L588">        Insets in = panel.insets();</span>
<span class="nc" id="L589">        panel.atts.put(&quot;width&quot;,</span>
<span class="nc" id="L590">                       Integer.toString(d.width - (in.left + in.right)));</span>
<span class="nc" id="L591">        panel.atts.put(&quot;height&quot;,</span>
<span class="nc" id="L592">                       Integer.toString(d.height - (in.top + in.bottom)));</span>
<span class="nc" id="L593">    }</span>

    /**
     * Restart the applet.
     */
    void appletRestart() {
<span class="nc" id="L599">        panel.sendEvent(AppletPanel.APPLET_STOP);</span>
<span class="nc" id="L600">        panel.sendEvent(AppletPanel.APPLET_DESTROY);</span>
<span class="nc" id="L601">        panel.sendEvent(AppletPanel.APPLET_INIT);</span>
<span class="nc" id="L602">        panel.sendEvent(AppletPanel.APPLET_START);</span>
<span class="nc" id="L603">    }</span>

    /**
     * Reload the applet.
     */
    void appletReload() {
<span class="nc" id="L609">        panel.sendEvent(AppletPanel.APPLET_STOP);</span>
<span class="nc" id="L610">        panel.sendEvent(AppletPanel.APPLET_DESTROY);</span>
<span class="nc" id="L611">        panel.sendEvent(AppletPanel.APPLET_DISPOSE);</span>

        /**
         * Fixed #4501142: Classlaoder sharing policy doesn't
         * take &quot;archive&quot; into account. This will be overridden
         * by Java Plug-in.                     [stanleyh]
         */
<span class="nc" id="L618">        AppletPanel.flushClassLoader(panel.getClassLoaderCacheKey());</span>

        /*
         * Make sure we don't have two threads running through the event queue
         * at the same time.
         */
        try {
<span class="nc" id="L625">            panel.joinAppletThread();</span>
<span class="nc" id="L626">            panel.release();</span>
<span class="nc" id="L627">        } catch (InterruptedException e) {</span>
<span class="nc" id="L628">            return;   // abort the reload</span>
<span class="nc" id="L629">        }</span>

<span class="nc" id="L631">        panel.createAppletThread();</span>
<span class="nc" id="L632">        panel.sendEvent(AppletPanel.APPLET_LOAD);</span>
<span class="nc" id="L633">        panel.sendEvent(AppletPanel.APPLET_INIT);</span>
<span class="nc" id="L634">        panel.sendEvent(AppletPanel.APPLET_START);</span>
<span class="nc" id="L635">    }</span>

    /**
     * Save the applet to a well known file (for now) as a serialized object
     */
    void appletSave() {
<span class="nc" id="L641">        AccessController.doPrivileged(new PrivilegedAction() {</span>

            public Object run() {
                // XXX: this privileged block should be made smaller
                // by initializing a private static variable with &quot;user.dir&quot;

                // Applet needs to be stopped for serialization to succeed.
                // Since panel.sendEvent only queues the event, there is a
                // chance that the event will not be processed before
                // serialization begins.  However, by sending the event before
                // FileDialog is created, enough time is given such that this
                // situation is unlikely to ever occur.

<span class="nc" id="L654">                panel.sendEvent(AppletPanel.APPLET_STOP);</span>
<span class="nc" id="L655">                FileDialog fd = new FileDialog(AppletViewer.this,</span>
<span class="nc" id="L656">                                               amh.getMessage(&quot;appletsave.filedialogtitle&quot;),</span>
                                               FileDialog.SAVE);
                // needed for a bug under Solaris...
<span class="nc" id="L659">                fd.setDirectory(System.getProperty(&quot;user.dir&quot;));</span>
<span class="nc" id="L660">                fd.setFile(defaultSaveFile);</span>
<span class="nc" id="L661">                fd.show();</span>
<span class="nc" id="L662">                String fname = fd.getFile();</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">                if (fname == null) {</span>
                    // Restart applet if Save is cancelled.
<span class="nc" id="L665">                    panel.sendEvent(AppletPanel.APPLET_START);</span>
<span class="nc" id="L666">                    return null;                // cancelled</span>
                }
<span class="nc" id="L668">                String dname = fd.getDirectory();</span>
<span class="nc" id="L669">                File file = new File(dname, fname);</span>

                try {
<span class="nc" id="L672">                    BufferedOutputStream s = new BufferedOutputStream(new FileOutputStream(file));</span>
<span class="nc" id="L673">                    ObjectOutputStream os = new ObjectOutputStream(s);</span>
<span class="nc" id="L674">                    showStatus(amh.getMessage(&quot;appletsave.err1&quot;,</span>
<span class="nc" id="L675">                                              panel.applet.toString(), file.toString()));</span>
<span class="nc" id="L676">                    os.writeObject(panel.applet);</span>
<span class="nc" id="L677">                } catch (IOException ex) {</span>
<span class="nc" id="L678">                    System.err.println(amh.getMessage(&quot;appletsave.err2&quot;, ex));</span>
                } finally {
<span class="nc" id="L680">                    panel.sendEvent(AppletPanel.APPLET_START);</span>
<span class="nc" id="L681">                }</span>
<span class="nc" id="L682">                return null;</span>
            }
        });
<span class="nc" id="L685">    }</span>

    /**
     * Clone the viewer and the applet.
     */
    void appletClone() {
<span class="nc" id="L691">        Point p = location();</span>
<span class="nc" id="L692">        updateAtts();</span>
<span class="nc" id="L693">        factory.createAppletViewer(p.x + XDELTA, p.y + YDELTA,</span>
<span class="nc" id="L694">                                   panel.documentURL, (Hashtable)panel.atts.clone());</span>
<span class="nc" id="L695">    }</span>

    /**
     * Show the applet tag.
     */
    void appletTag() {
<span class="nc" id="L701">        ByteArrayOutputStream out = new ByteArrayOutputStream();</span>
<span class="nc" id="L702">        updateAtts();</span>
<span class="nc" id="L703">        printTag(new PrintStream(out), panel.atts);</span>
<span class="nc" id="L704">        showStatus(amh.getMessage(&quot;applettag&quot;));</span>

<span class="nc" id="L706">        Point p = location();</span>
<span class="nc" id="L707">        new TextFrame(p.x + XDELTA, p.y + YDELTA, amh.getMessage(&quot;applettag.textframe&quot;), out.toString());</span>
<span class="nc" id="L708">    }</span>

    /**
     * Show the applet info.
     */
    void appletInfo() {
<span class="nc" id="L714">        String str = panel.applet.getAppletInfo();</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">        if (str == null) {</span>
<span class="nc" id="L716">            str = amh.getMessage(&quot;appletinfo.applet&quot;);</span>
        }
<span class="nc" id="L718">        str += &quot;\n\n&quot;;</span>

<span class="nc" id="L720">        String atts[][] = panel.applet.getParameterInfo();</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (atts != null) {</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">            for (int i = 0 ; i &lt; atts.length ; i++) {</span>
<span class="nc" id="L723">                str += atts[i][0] + &quot; -- &quot; + atts[i][1] + &quot; -- &quot; + atts[i][2] + &quot;\n&quot;;</span>
            }
        } else {
<span class="nc" id="L726">            str += amh.getMessage(&quot;appletinfo.param&quot;);</span>
        }

<span class="nc" id="L729">        Point p = location();</span>
<span class="nc" id="L730">        new TextFrame(p.x + XDELTA, p.y + YDELTA, amh.getMessage(&quot;appletinfo.textframe&quot;), str);</span>

<span class="nc" id="L732">    }</span>

    /**
     * Show character encoding type
     */
    void appletCharacterEncoding() {
<span class="nc" id="L738">        showStatus(amh.getMessage(&quot;appletencoding&quot;, encoding));</span>
<span class="nc" id="L739">    }</span>

    /**
     * Edit the applet.
     */
    void appletEdit() {
<span class="nc" id="L745">    }</span>

    /**
     * Print the applet.
     */
    void appletPrint() {
<span class="nc" id="L751">        PrinterJob pj = PrinterJob.getPrinterJob();</span>

<span class="nc bnc" id="L753" title="All 2 branches missed.">        if (pj != null) {</span>
<span class="nc" id="L754">            PrintRequestAttributeSet aset = new HashPrintRequestAttributeSet();</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">            if (pj.printDialog(aset)) {</span>
<span class="nc" id="L756">                pj.setPrintable(this);</span>
                try {
<span class="nc" id="L758">                    pj.print(aset);</span>
<span class="nc" id="L759">                    statusMsgStream.println(amh.getMessage(&quot;appletprint.finish&quot;));</span>
<span class="nc" id="L760">                } catch (PrinterException e) {</span>
<span class="nc" id="L761">                   statusMsgStream.println(amh.getMessage(&quot;appletprint.fail&quot;));</span>
<span class="nc" id="L762">                }</span>
            } else {
<span class="nc" id="L764">                statusMsgStream.println(amh.getMessage(&quot;appletprint.cancel&quot;));</span>
            }
<span class="nc" id="L766">        } else {</span>
<span class="nc" id="L767">            statusMsgStream.println(amh.getMessage(&quot;appletprint.fail&quot;));</span>
        }
<span class="nc" id="L769">    }</span>

    public int print(Graphics graphics, PageFormat pf, int pageIndex) {
<span class="nc bnc" id="L772" title="All 2 branches missed.">        if (pageIndex &gt; 0) {</span>
<span class="nc" id="L773">            return Printable.NO_SUCH_PAGE;</span>
        } else {
<span class="nc" id="L775">            Graphics2D g2d = (Graphics2D)graphics;</span>
<span class="nc" id="L776">            g2d.translate(pf.getImageableX(), pf.getImageableY());</span>
<span class="nc" id="L777">            panel.applet.printAll(graphics);</span>
<span class="nc" id="L778">            return Printable.PAGE_EXISTS;</span>
        }
    }

    /**
     * Properties.
     */
    static AppletProps props;
    public static synchronized void networkProperties() {
<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (props == null) {</span>
<span class="nc" id="L788">            props = new AppletProps();</span>
        }
<span class="nc" id="L790">        props.addNotify();</span>
<span class="nc" id="L791">        props.setVisible(true);</span>
<span class="nc" id="L792">    }</span>

    /**
     * Start the applet.
     */
    void appletStart() {
<span class="nc" id="L798">        panel.sendEvent(AppletPanel.APPLET_START);</span>
<span class="nc" id="L799">    }</span>

    /**
     * Stop the applet.
     */
    void appletStop() {
<span class="nc" id="L805">        panel.sendEvent(AppletPanel.APPLET_STOP);</span>
<span class="nc" id="L806">    }</span>

    /**
     * Shutdown a viewer.
     * Stop, Destroy, Dispose and Quit a viewer
     */
    private void appletShutdown(AppletPanel p) {
<span class="nc" id="L813">        p.sendEvent(AppletPanel.APPLET_STOP);</span>
<span class="nc" id="L814">        p.sendEvent(AppletPanel.APPLET_DESTROY);</span>
<span class="nc" id="L815">        p.sendEvent(AppletPanel.APPLET_DISPOSE);</span>
<span class="nc" id="L816">        p.sendEvent(AppletPanel.APPLET_QUIT);</span>
<span class="nc" id="L817">    }</span>

    /**
     * Close this viewer.
     * Stop, Destroy, Dispose and Quit an AppletView, then
     * reclaim resources and exit the program if this is
     * the last applet.
     */
    void appletClose() {

        // The caller thread is event dispatch thread, so
        // spawn a new thread to avoid blocking the event queue
        // when calling appletShutdown.
        //
<span class="nc" id="L831">        final AppletPanel p = panel;</span>

<span class="nc" id="L833">        new Thread(new Runnable()</span>
<span class="nc" id="L834">        {</span>
            public void run()
            {
<span class="nc" id="L837">                appletShutdown(p);</span>
<span class="nc" id="L838">                appletPanels.removeElement(p);</span>
<span class="nc" id="L839">                dispose();</span>

<span class="nc bnc" id="L841" title="All 2 branches missed.">                if (countApplets() == 0) {</span>
<span class="nc" id="L842">                    appletSystemExit();</span>
                }
<span class="nc" id="L844">            }</span>
<span class="nc" id="L845">        }).start();</span>
<span class="nc" id="L846">    }</span>

    /**
     * Exit the program.
     * Exit from the program (if not stand alone) - do no clean-up
     */
    private void appletSystemExit() {
<span class="nc bnc" id="L853" title="All 2 branches missed.">        if (factory.isStandalone())</span>
<span class="nc" id="L854">            System.exit(0);</span>
<span class="nc" id="L855">    }</span>

    /**
     * Quit all viewers.
     * Shutdown all viewers properly then
     * exit from the program (if not stand alone)
     */
    protected void appletQuit()
    {
        // The caller thread is event dispatch thread, so
        // spawn a new thread to avoid blocking the event queue
        // when calling appletShutdown.
        //
<span class="nc" id="L868">        new Thread(new Runnable()</span>
<span class="nc" id="L869">        {</span>
            public void run()
            {
<span class="nc bnc" id="L872" title="All 2 branches missed.">                for (Enumeration e = appletPanels.elements() ; e.hasMoreElements() ;) {</span>
<span class="nc" id="L873">                    AppletPanel p = (AppletPanel)e.nextElement();</span>
<span class="nc" id="L874">                    appletShutdown(p);</span>
<span class="nc" id="L875">                }</span>
<span class="nc" id="L876">                appletSystemExit();</span>
<span class="nc" id="L877">            }</span>
<span class="nc" id="L878">        }).start();</span>
<span class="nc" id="L879">    }</span>

    /**
     * Handle events.
     */
    public void processUserAction(ActionEvent evt) {

<span class="nc" id="L886">        String label = ((MenuItem)evt.getSource()).getLabel();</span>

<span class="nc bnc" id="L888" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.restart&quot;).equals(label)) {</span>
<span class="nc" id="L889">            appletRestart();</span>
<span class="nc" id="L890">            return;</span>
        }

<span class="nc bnc" id="L893" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.reload&quot;).equals(label)) {</span>
<span class="nc" id="L894">            appletReload();</span>
<span class="nc" id="L895">            return;</span>
        }

<span class="nc bnc" id="L898" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.clone&quot;).equals(label)) {</span>
<span class="nc" id="L899">            appletClone();</span>
<span class="nc" id="L900">            return;</span>
        }

<span class="nc bnc" id="L903" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.stop&quot;).equals(label)) {</span>
<span class="nc" id="L904">            appletStop();</span>
<span class="nc" id="L905">            return;</span>
        }

<span class="nc bnc" id="L908" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.save&quot;).equals(label)) {</span>
<span class="nc" id="L909">            appletSave();</span>
<span class="nc" id="L910">            return;</span>
        }

<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.start&quot;).equals(label)) {</span>
<span class="nc" id="L914">            appletStart();</span>
<span class="nc" id="L915">            return;</span>
        }

<span class="nc bnc" id="L918" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.tag&quot;).equals(label)) {</span>
<span class="nc" id="L919">            appletTag();</span>
<span class="nc" id="L920">            return;</span>
        }

<span class="nc bnc" id="L923" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.info&quot;).equals(label)) {</span>
<span class="nc" id="L924">            appletInfo();</span>
<span class="nc" id="L925">            return;</span>
        }

<span class="nc bnc" id="L928" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.encoding&quot;).equals(label)) {</span>
<span class="nc" id="L929">            appletCharacterEncoding();</span>
<span class="nc" id="L930">            return;</span>
        }

<span class="nc bnc" id="L933" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.edit&quot;).equals(label)) {</span>
<span class="nc" id="L934">            appletEdit();</span>
<span class="nc" id="L935">            return;</span>
        }

<span class="nc bnc" id="L938" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.print&quot;).equals(label)) {</span>
<span class="nc" id="L939">            appletPrint();</span>
<span class="nc" id="L940">            return;</span>
        }

<span class="nc bnc" id="L943" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.props&quot;).equals(label)) {</span>
<span class="nc" id="L944">            networkProperties();</span>
<span class="nc" id="L945">            return;</span>
        }

<span class="nc bnc" id="L948" title="All 2 branches missed.">        if (amh.getMessage(&quot;menuitem.close&quot;).equals(label)) {</span>
<span class="nc" id="L949">            appletClose();</span>
<span class="nc" id="L950">            return;</span>
        }

<span class="nc bnc" id="L953" title="All 4 branches missed.">        if (factory.isStandalone() &amp;&amp; amh.getMessage(&quot;menuitem.quit&quot;).equals(label)) {</span>
<span class="nc" id="L954">            appletQuit();</span>
<span class="nc" id="L955">            return;</span>
        }
        //statusMsgStream.println(&quot;evt = &quot; + evt);
<span class="nc" id="L958">    }</span>

    /**
     * How many applets are running?
     */

    public static int countApplets() {
<span class="nc" id="L965">        return appletPanels.size();</span>
    }


    /**
     * The current character.
     */
    static int c;

    /**
     * Scan spaces.
     */
    public static void skipSpace(Reader in) throws IOException {
<span class="nc bnc" id="L978" title="All 10 branches missed.">        while ((c &gt;= 0) &amp;&amp;</span>
               ((c == ' ') || (c == '\t') || (c == '\n') || (c == '\r'))) {
<span class="nc" id="L980">            c = in.read();</span>
        }
<span class="nc" id="L982">    }</span>

    /**
     * Scan identifier
     */
    public static String scanIdentifier(Reader in) throws IOException {
<span class="nc" id="L988">        StringBuffer buf = new StringBuffer();</span>
        while (true) {
<span class="nc bnc" id="L990" title="All 14 branches missed.">            if (((c &gt;= 'a') &amp;&amp; (c &lt;= 'z')) ||</span>
                ((c &gt;= 'A') &amp;&amp; (c &lt;= 'Z')) ||
                ((c &gt;= '0') &amp;&amp; (c &lt;= '9')) || (c == '_')) {
<span class="nc" id="L993">                buf.append((char)c);</span>
<span class="nc" id="L994">                c = in.read();</span>
            } else {
<span class="nc" id="L996">                return buf.toString();</span>
            }
        }
    }

    /**
     * Scan tag
     */
    public static Hashtable scanTag(Reader in) throws IOException {
<span class="nc" id="L1005">        Hashtable atts = new Hashtable();</span>
<span class="nc" id="L1006">        skipSpace(in);</span>
<span class="nc bnc" id="L1007" title="All 4 branches missed.">        while (c &gt;= 0 &amp;&amp; c != '&gt;') {</span>
<span class="nc" id="L1008">            String att = scanIdentifier(in);</span>
<span class="nc" id="L1009">            String val = &quot;&quot;;</span>
<span class="nc" id="L1010">            skipSpace(in);</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">            if (c == '=') {</span>
<span class="nc" id="L1012">                int quote = -1;</span>
<span class="nc" id="L1013">                c = in.read();</span>
<span class="nc" id="L1014">                skipSpace(in);</span>
<span class="nc bnc" id="L1015" title="All 4 branches missed.">                if ((c == '\'') || (c == '\&quot;')) {</span>
<span class="nc" id="L1016">                    quote = c;</span>
<span class="nc" id="L1017">                    c = in.read();</span>
                }
<span class="nc" id="L1019">                StringBuffer buf = new StringBuffer();</span>
<span class="nc bnc" id="L1020" title="All 18 branches missed.">                while ((c &gt; 0) &amp;&amp;</span>
                       (((quote &lt; 0) &amp;&amp; (c != ' ') &amp;&amp; (c != '\t') &amp;&amp;
                         (c != '\n') &amp;&amp; (c != '\r') &amp;&amp; (c != '&gt;'))
                        || ((quote &gt;= 0) &amp;&amp; (c != quote)))) {
<span class="nc" id="L1024">                    buf.append((char)c);</span>
<span class="nc" id="L1025">                    c = in.read();</span>
                }
<span class="nc bnc" id="L1027" title="All 2 branches missed.">                if (c == quote) {</span>
<span class="nc" id="L1028">                    c = in.read();</span>
                }
<span class="nc" id="L1030">                skipSpace(in);</span>
<span class="nc" id="L1031">                val = buf.toString();</span>
            }
            //statusMsgStream.println(&quot;PUT &quot; + att + &quot; = '&quot; + val + &quot;'&quot;);
<span class="nc bnc" id="L1034" title="All 2 branches missed.">            if (! val.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1035">                atts.put(att.toLowerCase(java.util.Locale.ENGLISH), val);</span>
            }
            while (true) {
<span class="nc bnc" id="L1038" title="All 18 branches missed.">                if ((c == '&gt;') || (c &lt; 0) ||</span>
                    ((c &gt;= 'a') &amp;&amp; (c &lt;= 'z')) ||
                    ((c &gt;= 'A') &amp;&amp; (c &lt;= 'Z')) ||
                    ((c &gt;= '0') &amp;&amp; (c &lt;= '9')) || (c == '_'))
<span class="nc" id="L1042">                    break;</span>
<span class="nc" id="L1043">                c = in.read();</span>
            }
            //skipSpace(in);
<span class="nc" id="L1046">        }</span>
<span class="nc" id="L1047">        return atts;</span>
    }

    /* values used for placement of AppletViewer's frames */
<span class="nc" id="L1051">    private static int x = 0;</span>
<span class="nc" id="L1052">    private static int y = 0;</span>
    private static final int XDELTA = 30;
    private static final int YDELTA = XDELTA;

<span class="nc" id="L1056">    static String encoding = null;</span>

    static private Reader makeReader(InputStream is) {
<span class="nc bnc" id="L1059" title="All 2 branches missed.">        if (encoding != null) {</span>
            try {
<span class="nc" id="L1061">                return new BufferedReader(new InputStreamReader(is, encoding));</span>
<span class="nc" id="L1062">            } catch (IOException x) { }</span>
        }
<span class="nc" id="L1064">        InputStreamReader r = new InputStreamReader(is);</span>
<span class="nc" id="L1065">        encoding = r.getEncoding();</span>
<span class="nc" id="L1066">        return new BufferedReader(r);</span>
    }

    /**
     * Scan an html file for &lt;applet&gt; tags
     */
    public static void parse(URL url, String enc) throws IOException {
<span class="nc" id="L1073">        encoding = enc;</span>
<span class="nc" id="L1074">        parse(url, System.out, new StdAppletViewerFactory());</span>
<span class="nc" id="L1075">    }</span>

    public static void parse(URL url) throws IOException {
<span class="nc" id="L1078">        parse(url, System.out, new StdAppletViewerFactory());</span>
<span class="nc" id="L1079">    }</span>

    public static void parse(URL url, PrintStream statusMsgStream,
                             AppletViewerFactory factory) throws IOException {
        // &lt;OBJECT&gt; &lt;EMBED&gt; tag flags
<span class="nc" id="L1084">        boolean isAppletTag = false;</span>
<span class="nc" id="L1085">        boolean isObjectTag = false;</span>
<span class="nc" id="L1086">        boolean isEmbedTag = false;</span>

        // warning messages
<span class="nc" id="L1089">        String requiresNameWarning = amh.getMessage(&quot;parse.warning.requiresname&quot;);</span>
<span class="nc" id="L1090">        String paramOutsideWarning = amh.getMessage(&quot;parse.warning.paramoutside&quot;);</span>
<span class="nc" id="L1091">        String appletRequiresCodeWarning = amh.getMessage(&quot;parse.warning.applet.requirescode&quot;);</span>
<span class="nc" id="L1092">        String appletRequiresHeightWarning = amh.getMessage(&quot;parse.warning.applet.requiresheight&quot;);</span>
<span class="nc" id="L1093">        String appletRequiresWidthWarning = amh.getMessage(&quot;parse.warning.applet.requireswidth&quot;);</span>
<span class="nc" id="L1094">        String objectRequiresCodeWarning = amh.getMessage(&quot;parse.warning.object.requirescode&quot;);</span>
<span class="nc" id="L1095">        String objectRequiresHeightWarning = amh.getMessage(&quot;parse.warning.object.requiresheight&quot;);</span>
<span class="nc" id="L1096">        String objectRequiresWidthWarning = amh.getMessage(&quot;parse.warning.object.requireswidth&quot;);</span>
<span class="nc" id="L1097">        String embedRequiresCodeWarning = amh.getMessage(&quot;parse.warning.embed.requirescode&quot;);</span>
<span class="nc" id="L1098">        String embedRequiresHeightWarning = amh.getMessage(&quot;parse.warning.embed.requiresheight&quot;);</span>
<span class="nc" id="L1099">        String embedRequiresWidthWarning = amh.getMessage(&quot;parse.warning.embed.requireswidth&quot;);</span>
<span class="nc" id="L1100">        String appNotLongerSupportedWarning = amh.getMessage(&quot;parse.warning.appnotLongersupported&quot;);</span>

<span class="nc" id="L1102">        java.net.URLConnection conn = url.openConnection();</span>
<span class="nc" id="L1103">        Reader in = makeReader(conn.getInputStream());</span>
        /* The original URL may have been redirected - this
         * sets it to whatever URL/codebase we ended up getting
         */
<span class="nc" id="L1107">        url = conn.getURL();</span>

<span class="nc" id="L1109">        int ydisp = 1;</span>
<span class="nc" id="L1110">        Hashtable atts = null;</span>

        while(true) {
<span class="nc" id="L1113">            c = in.read();</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">            if (c == -1)</span>
<span class="nc" id="L1115">                break;</span>

<span class="nc bnc" id="L1117" title="All 2 branches missed.">            if (c == '&lt;') {</span>
<span class="nc" id="L1118">                c = in.read();</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">                if (c == '/') {</span>
<span class="nc" id="L1120">                    c = in.read();</span>
<span class="nc" id="L1121">                    String nm = scanIdentifier(in);</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">                    if (nm.equalsIgnoreCase(&quot;applet&quot;) ||</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                        nm.equalsIgnoreCase(&quot;object&quot;) ||</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">                        nm.equalsIgnoreCase(&quot;embed&quot;)) {</span>

                        // We can't test for a code tag until &lt;/OBJECT&gt;
                        // because it is a parameter, not an attribute.
<span class="nc bnc" id="L1128" title="All 2 branches missed.">                        if(isObjectTag) {</span>
<span class="nc bnc" id="L1129" title="All 4 branches missed.">                            if (atts.get(&quot;code&quot;) == null &amp;&amp; atts.get(&quot;object&quot;) == null) {</span>
<span class="nc" id="L1130">                                statusMsgStream.println(objectRequiresCodeWarning);</span>
<span class="nc" id="L1131">                                atts = null;</span>
                            }
                        }

<span class="nc bnc" id="L1135" title="All 2 branches missed.">                        if (atts != null) {</span>
                            // XXX 5/18 In general this code just simply
                            // shouldn't be part of parsing.  It's presence
                            // causes things to be a little too much of a
                            // hack.
<span class="nc" id="L1140">                            factory.createAppletViewer(x, y, url, atts);</span>
<span class="nc" id="L1141">                            x += XDELTA;</span>
<span class="nc" id="L1142">                            y += YDELTA;</span>
                            // make sure we don't go too far!
<span class="nc" id="L1144">                            Dimension d = Toolkit.getDefaultToolkit().getScreenSize();</span>
<span class="nc bnc" id="L1145" title="All 4 branches missed.">                            if ((x &gt; d.width - 300) || (y &gt; d.height - 300)) {</span>
<span class="nc" id="L1146">                                x = 0;</span>
<span class="nc" id="L1147">                                y = 2 * ydisp * YDELTA;</span>
<span class="nc" id="L1148">                                ydisp++;</span>
                            }
                        }
<span class="nc" id="L1151">                        atts = null;</span>
<span class="nc" id="L1152">                        isAppletTag = false;</span>
<span class="nc" id="L1153">                        isObjectTag = false;</span>
<span class="nc" id="L1154">                        isEmbedTag = false;</span>
                    }
<span class="nc" id="L1156">                }</span>
                else {
<span class="nc" id="L1158">                    String nm = scanIdentifier(in);</span>
<span class="nc bnc" id="L1159" title="All 2 branches missed.">                    if (nm.equalsIgnoreCase(&quot;param&quot;)) {</span>
<span class="nc" id="L1160">                        Hashtable t = scanTag(in);</span>
<span class="nc" id="L1161">                        String att = (String)t.get(&quot;name&quot;);</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">                        if (att == null) {</span>
<span class="nc" id="L1163">                            statusMsgStream.println(requiresNameWarning);</span>
                        } else {
<span class="nc" id="L1165">                            String val = (String)t.get(&quot;value&quot;);</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">                            if (val == null) {</span>
<span class="nc" id="L1167">                                statusMsgStream.println(requiresNameWarning);</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">                            } else if (atts != null) {</span>
<span class="nc" id="L1169">                                atts.put(att.toLowerCase(), val);</span>
                            } else {
<span class="nc" id="L1171">                                statusMsgStream.println(paramOutsideWarning);</span>
                            }
                        }
<span class="nc" id="L1174">                    }</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">                    else if (nm.equalsIgnoreCase(&quot;applet&quot;)) {</span>
<span class="nc" id="L1176">                        isAppletTag = true;</span>
<span class="nc" id="L1177">                        atts = scanTag(in);</span>
<span class="nc bnc" id="L1178" title="All 4 branches missed.">                        if (atts.get(&quot;code&quot;) == null &amp;&amp; atts.get(&quot;object&quot;) == null) {</span>
<span class="nc" id="L1179">                            statusMsgStream.println(appletRequiresCodeWarning);</span>
<span class="nc" id="L1180">                            atts = null;</span>
<span class="nc bnc" id="L1181" title="All 2 branches missed.">                        } else if (atts.get(&quot;width&quot;) == null) {</span>
<span class="nc" id="L1182">                            statusMsgStream.println(appletRequiresWidthWarning);</span>
<span class="nc" id="L1183">                            atts = null;</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">                        } else if (atts.get(&quot;height&quot;) == null) {</span>
<span class="nc" id="L1185">                            statusMsgStream.println(appletRequiresHeightWarning);</span>
<span class="nc" id="L1186">                            atts = null;</span>
                        }
                    }
<span class="nc bnc" id="L1189" title="All 2 branches missed.">                    else if (nm.equalsIgnoreCase(&quot;object&quot;)) {</span>
<span class="nc" id="L1190">                        isObjectTag = true;</span>
<span class="nc" id="L1191">                        atts = scanTag(in);</span>
                        // The &lt;OBJECT&gt; attribute codebase isn't what
                        // we want. If its defined, remove it.
<span class="nc bnc" id="L1194" title="All 2 branches missed.">                        if(atts.get(&quot;codebase&quot;) != null) {</span>
<span class="nc" id="L1195">                            atts.remove(&quot;codebase&quot;);</span>
                        }

<span class="nc bnc" id="L1198" title="All 2 branches missed.">                        if (atts.get(&quot;width&quot;) == null) {</span>
<span class="nc" id="L1199">                            statusMsgStream.println(objectRequiresWidthWarning);</span>
<span class="nc" id="L1200">                            atts = null;</span>
<span class="nc bnc" id="L1201" title="All 2 branches missed.">                        } else if (atts.get(&quot;height&quot;) == null) {</span>
<span class="nc" id="L1202">                            statusMsgStream.println(objectRequiresHeightWarning);</span>
<span class="nc" id="L1203">                            atts = null;</span>
                        }
                    }
<span class="nc bnc" id="L1206" title="All 2 branches missed.">                    else if (nm.equalsIgnoreCase(&quot;embed&quot;)) {</span>
<span class="nc" id="L1207">                        isEmbedTag = true;</span>
<span class="nc" id="L1208">                        atts = scanTag(in);</span>

<span class="nc bnc" id="L1210" title="All 4 branches missed.">                        if (atts.get(&quot;code&quot;) == null &amp;&amp; atts.get(&quot;object&quot;) == null) {</span>
<span class="nc" id="L1211">                            statusMsgStream.println(embedRequiresCodeWarning);</span>
<span class="nc" id="L1212">                            atts = null;</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">                        } else if (atts.get(&quot;width&quot;) == null) {</span>
<span class="nc" id="L1214">                            statusMsgStream.println(embedRequiresWidthWarning);</span>
<span class="nc" id="L1215">                            atts = null;</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">                        } else if (atts.get(&quot;height&quot;) == null) {</span>
<span class="nc" id="L1217">                            statusMsgStream.println(embedRequiresHeightWarning);</span>
<span class="nc" id="L1218">                            atts = null;</span>
                        }
                    }
<span class="nc bnc" id="L1221" title="All 2 branches missed.">                    else if (nm.equalsIgnoreCase(&quot;app&quot;)) {</span>
<span class="nc" id="L1222">                        statusMsgStream.println(appNotLongerSupportedWarning);</span>
<span class="nc" id="L1223">                        Hashtable atts2 = scanTag(in);</span>
<span class="nc" id="L1224">                        nm = (String)atts2.get(&quot;class&quot;);</span>
<span class="nc bnc" id="L1225" title="All 2 branches missed.">                        if (nm != null) {</span>
<span class="nc" id="L1226">                            atts2.remove(&quot;class&quot;);</span>
<span class="nc" id="L1227">                            atts2.put(&quot;code&quot;, nm + &quot;.class&quot;);</span>
                        }
<span class="nc" id="L1229">                        nm = (String)atts2.get(&quot;src&quot;);</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">                        if (nm != null) {</span>
<span class="nc" id="L1231">                            atts2.remove(&quot;src&quot;);</span>
<span class="nc" id="L1232">                            atts2.put(&quot;codebase&quot;, nm);</span>
                        }
<span class="nc bnc" id="L1234" title="All 2 branches missed.">                        if (atts2.get(&quot;width&quot;) == null) {</span>
<span class="nc" id="L1235">                            atts2.put(&quot;width&quot;, &quot;100&quot;);</span>
                        }
<span class="nc bnc" id="L1237" title="All 2 branches missed.">                        if (atts2.get(&quot;height&quot;) == null) {</span>
<span class="nc" id="L1238">                            atts2.put(&quot;height&quot;, &quot;100&quot;);</span>
                        }
<span class="nc" id="L1240">                        printTag(statusMsgStream, atts2);</span>
<span class="nc" id="L1241">                        statusMsgStream.println();</span>
                    }
<span class="nc" id="L1243">                }</span>
            }
        }
<span class="nc" id="L1246">        in.close();</span>
<span class="nc" id="L1247">    }</span>

    /**
     * Old main entry point.
     *
     * @deprecated
     */
    @Deprecated
    public static void main(String argv[]) {
        // re-route everything to the new main entry point
<span class="nc" id="L1257">        Main.main(argv);</span>
<span class="nc" id="L1258">    }</span>

<span class="nc" id="L1260">    private static AppletMessageHandler amh = new AppletMessageHandler(&quot;appletviewer&quot;);</span>

    private static void checkConnect(URL url)
    {
<span class="nc" id="L1264">        SecurityManager security = System.getSecurityManager();</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed.">        if (security != null) {</span>
            try {
<span class="nc" id="L1267">                java.security.Permission perm =</span>
<span class="nc" id="L1268">                    url.openConnection().getPermission();</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">                if (perm != null)</span>
<span class="nc" id="L1270">                    security.checkPermission(perm);</span>
                else
<span class="nc" id="L1272">                    security.checkConnect(url.getHost(), url.getPort());</span>
<span class="nc" id="L1273">            } catch (java.io.IOException ioe) {</span>
<span class="nc" id="L1274">                    security.checkConnect(url.getHost(), url.getPort());</span>
<span class="nc" id="L1275">            }</span>
        }
<span class="nc" id="L1277">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>