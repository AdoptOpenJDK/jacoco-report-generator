<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>GIFMetadata.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.imageio.plugins.gif</a> &gt; <span class="el_source">GIFMetadata.java</span></div><h1>GIFMetadata.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.imageio.plugins.gif;

import javax.imageio.metadata.IIOInvalidTreeException;
import javax.imageio.metadata.IIOMetadata;
import javax.imageio.metadata.IIOMetadataFormatImpl;
import org.w3c.dom.Node;

/**
 * Class which adds utility DOM element attribute access methods to
 * &lt;code&gt;IIOMetadata&lt;/code&gt; for subclass use.
 */
abstract class GIFMetadata extends IIOMetadata {

    /**
     * Represents an undefined value of integer attributes.
     */
    static final int UNDEFINED_INTEGER_VALUE = -1;

    //
    // Note: These attribute methods were shamelessly lifted from
    // com.sun.imageio.plugins.png.PNGMetadata and modified.
    //

    // Shorthand for throwing an IIOInvalidTreeException
    protected static void fatal(Node node, String reason)
      throws IIOInvalidTreeException {
<span class="nc" id="L52">        throw new IIOInvalidTreeException(reason, node);</span>
    }

    // Get an integer-valued attribute
    protected static String getStringAttribute(Node node, String name,
                                               String defaultValue,
                                               boolean required,
                                               String[] range)
      throws IIOInvalidTreeException {
<span class="nc" id="L61">        Node attr = node.getAttributes().getNamedItem(name);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (attr == null) {</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (!required) {</span>
<span class="nc" id="L64">                return defaultValue;</span>
            } else {
<span class="nc" id="L66">                fatal(node, &quot;Required attribute &quot; + name + &quot; not present!&quot;);</span>
            }
        }
<span class="nc" id="L69">        String value = attr.getNodeValue();</span>

<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (range != null) {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (value == null) {</span>
<span class="nc" id="L73">                fatal(node,</span>
<span class="nc" id="L74">                      &quot;Null value for &quot;+node.getNodeName()+</span>
                      &quot; attribute &quot;+name+&quot;!&quot;);
            }
<span class="nc" id="L77">            boolean validValue = false;</span>
<span class="nc" id="L78">            int len = range.length;</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                if (value.equals(range[i])) {</span>
<span class="nc" id="L81">                    validValue = true;</span>
<span class="nc" id="L82">                    break;</span>
                }
            }
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (!validValue) {</span>
<span class="nc" id="L86">                fatal(node,</span>
<span class="nc" id="L87">                      &quot;Bad value for &quot;+node.getNodeName()+</span>
                      &quot; attribute &quot;+name+&quot;!&quot;);
            }
        }

<span class="nc" id="L92">        return value;</span>
    }


    // Get an integer-valued attribute
    protected static int getIntAttribute(Node node, String name,
                                         int defaultValue, boolean required,
                                         boolean bounded, int min, int max)
      throws IIOInvalidTreeException {
<span class="nc" id="L101">        String value = getStringAttribute(node, name, null, required, null);</span>
<span class="nc bnc" id="L102" title="All 4 branches missed.">        if (value == null || &quot;&quot;.equals(value)) {</span>
<span class="nc" id="L103">            return defaultValue;</span>
        }

<span class="nc" id="L106">        int intValue = defaultValue;</span>
        try {
<span class="nc" id="L108">            intValue = Integer.parseInt(value);</span>
<span class="nc" id="L109">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L110">            fatal(node,</span>
<span class="nc" id="L111">                  &quot;Bad value for &quot;+node.getNodeName()+</span>
                  &quot; attribute &quot;+name+&quot;!&quot;);
<span class="nc" id="L113">        }</span>
<span class="nc bnc" id="L114" title="All 6 branches missed.">        if (bounded &amp;&amp; (intValue &lt; min || intValue &gt; max)) {</span>
<span class="nc" id="L115">            fatal(node,</span>
<span class="nc" id="L116">                  &quot;Bad value for &quot;+node.getNodeName()+</span>
                  &quot; attribute &quot;+name+&quot;!&quot;);
        }
<span class="nc" id="L119">        return intValue;</span>
    }

    // Get a float-valued attribute
    protected static float getFloatAttribute(Node node, String name,
                                             float defaultValue,
                                             boolean required)
      throws IIOInvalidTreeException {
<span class="nc" id="L127">        String value = getStringAttribute(node, name, null, required, null);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L129">            return defaultValue;</span>
        }
<span class="nc" id="L131">        return Float.parseFloat(value);</span>
    }

    // Get a required integer-valued attribute
    protected static int getIntAttribute(Node node, String name,
                                         boolean bounded, int min, int max)
      throws IIOInvalidTreeException {
<span class="nc" id="L138">        return getIntAttribute(node, name, -1, true, bounded, min, max);</span>
    }

    // Get a required float-valued attribute
    protected static float getFloatAttribute(Node node, String name)
      throws IIOInvalidTreeException {
<span class="nc" id="L144">        return getFloatAttribute(node, name, -1.0F, true);</span>
    }

    // Get a boolean-valued attribute
    protected static boolean getBooleanAttribute(Node node, String name,
                                                 boolean defaultValue,
                                                 boolean required)
      throws IIOInvalidTreeException {
<span class="nc" id="L152">        Node attr = node.getAttributes().getNamedItem(name);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (attr == null) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (!required) {</span>
<span class="nc" id="L155">                return defaultValue;</span>
            } else {
<span class="nc" id="L157">                fatal(node, &quot;Required attribute &quot; + name + &quot; not present!&quot;);</span>
            }
        }
<span class="nc" id="L160">        String value = attr.getNodeValue();</span>
        // Allow lower case booleans for backward compatibility, #5082756
<span class="nc bnc" id="L162" title="All 4 branches missed.">        if (value.equals(&quot;TRUE&quot;) || value.equals(&quot;true&quot;)) {</span>
<span class="nc" id="L163">            return true;</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">        } else if (value.equals(&quot;FALSE&quot;) || value.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L165">            return false;</span>
        } else {
<span class="nc" id="L167">            fatal(node, &quot;Attribute &quot; + name + &quot; must be 'TRUE' or 'FALSE'!&quot;);</span>
<span class="nc" id="L168">            return false;</span>
        }
    }

    // Get a required boolean-valued attribute
    protected static boolean getBooleanAttribute(Node node, String name)
      throws IIOInvalidTreeException {
<span class="nc" id="L175">        return getBooleanAttribute(node, name, false, true);</span>
    }

    // Get an enumerated attribute as an index into a String array
    protected static int getEnumeratedAttribute(Node node,
                                                String name,
                                                String[] legalNames,
                                                int defaultValue,
                                                boolean required)
      throws IIOInvalidTreeException {
<span class="nc" id="L185">        Node attr = node.getAttributes().getNamedItem(name);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (attr == null) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (!required) {</span>
<span class="nc" id="L188">                return defaultValue;</span>
            } else {
<span class="nc" id="L190">                fatal(node, &quot;Required attribute &quot; + name + &quot; not present!&quot;);</span>
            }
        }
<span class="nc" id="L193">        String value = attr.getNodeValue();</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        for (int i = 0; i &lt; legalNames.length; i++) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if(value.equals(legalNames[i])) {</span>
<span class="nc" id="L196">                return i;</span>
            }
        }

<span class="nc" id="L200">        fatal(node, &quot;Illegal value for attribute &quot; + name + &quot;!&quot;);</span>
<span class="nc" id="L201">        return -1;</span>
    }

    // Get a required enumerated attribute as an index into a String array
    protected static int getEnumeratedAttribute(Node node,
                                                String name,
                                                String[] legalNames)
      throws IIOInvalidTreeException {
<span class="nc" id="L209">        return getEnumeratedAttribute(node, name, legalNames, -1, true);</span>
    }

    // Get a String-valued attribute
    protected static String getAttribute(Node node, String name,
                                         String defaultValue, boolean required)
      throws IIOInvalidTreeException {
<span class="nc" id="L216">        Node attr = node.getAttributes().getNamedItem(name);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (attr == null) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (!required) {</span>
<span class="nc" id="L219">                return defaultValue;</span>
            } else {
<span class="nc" id="L221">                fatal(node, &quot;Required attribute &quot; + name + &quot; not present!&quot;);</span>
            }
        }
<span class="nc" id="L224">        return attr.getNodeValue();</span>
    }

    // Get a required String-valued attribute
    protected static String getAttribute(Node node, String name)
      throws IIOInvalidTreeException {
<span class="nc" id="L230">        return getAttribute(node, name, null, true);</span>
    }

    protected GIFMetadata(boolean standardMetadataFormatSupported,
                          String nativeMetadataFormatName,
                          String nativeMetadataFormatClassName,
                          String[] extraMetadataFormatNames,
                          String[] extraMetadataFormatClassNames) {
<span class="nc" id="L238">        super(standardMetadataFormatSupported,</span>
              nativeMetadataFormatName,
              nativeMetadataFormatClassName,
              extraMetadataFormatNames,
              extraMetadataFormatClassNames);
<span class="nc" id="L243">    }</span>

    public void mergeTree(String formatName, Node root)
      throws IIOInvalidTreeException {
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (formatName.equals(nativeMetadataFormatName)) {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (root == null) {</span>
<span class="nc" id="L249">                throw new IllegalArgumentException(&quot;root == null!&quot;);</span>
            }
<span class="nc" id="L251">            mergeNativeTree(root);</span>
<span class="nc" id="L252">        } else if (formatName.equals</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">                  (IIOMetadataFormatImpl.standardMetadataFormatName)) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (root == null) {</span>
<span class="nc" id="L255">                throw new IllegalArgumentException(&quot;root == null!&quot;);</span>
            }
<span class="nc" id="L257">            mergeStandardTree(root);</span>
        } else {
<span class="nc" id="L259">            throw new IllegalArgumentException(&quot;Not a recognized format!&quot;);</span>
        }
<span class="nc" id="L261">    }</span>

    protected byte[] getColorTable(Node colorTableNode,
                                   String entryNodeName,
                                   boolean lengthExpected,
                                   int expectedLength)
      throws IIOInvalidTreeException {
<span class="nc" id="L268">        byte[] red = new byte[256];</span>
<span class="nc" id="L269">        byte[] green  = new byte[256];</span>
<span class="nc" id="L270">        byte[] blue = new byte[256];</span>
<span class="nc" id="L271">        int maxIndex = -1;</span>

<span class="nc" id="L273">        Node entry = colorTableNode.getFirstChild();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (entry == null) {</span>
<span class="nc" id="L275">            fatal(colorTableNode, &quot;Palette has no entries!&quot;);</span>
        }

<span class="nc bnc" id="L278" title="All 2 branches missed.">        while (entry != null) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            if (!entry.getNodeName().equals(entryNodeName)) {</span>
<span class="nc" id="L280">                fatal(colorTableNode,</span>
                      &quot;Only a &quot;+entryNodeName+&quot; may be a child of a &quot;+
<span class="nc" id="L282">                      entry.getNodeName()+&quot;!&quot;);</span>
            }

<span class="nc" id="L285">            int index = getIntAttribute(entry, &quot;index&quot;, true, 0, 255);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (index &gt; maxIndex) {</span>
<span class="nc" id="L287">                maxIndex = index;</span>
            }
<span class="nc" id="L289">            red[index] = (byte)getIntAttribute(entry, &quot;red&quot;, true, 0, 255);</span>
<span class="nc" id="L290">            green[index] = (byte)getIntAttribute(entry, &quot;green&quot;, true, 0, 255);</span>
<span class="nc" id="L291">            blue[index] = (byte)getIntAttribute(entry, &quot;blue&quot;, true, 0, 255);</span>

<span class="nc" id="L293">            entry = entry.getNextSibling();</span>
<span class="nc" id="L294">        }</span>

<span class="nc" id="L296">        int numEntries = maxIndex + 1;</span>

<span class="nc bnc" id="L298" title="All 4 branches missed.">        if (lengthExpected &amp;&amp; numEntries != expectedLength) {</span>
<span class="nc" id="L299">            fatal(colorTableNode, &quot;Unexpected length for palette!&quot;);</span>
        }

<span class="nc" id="L302">        byte[] colorTable = new byte[3*numEntries];</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        for (int i = 0, j = 0; i &lt; numEntries; i++) {</span>
<span class="nc" id="L304">            colorTable[j++] = red[i];</span>
<span class="nc" id="L305">            colorTable[j++] = green[i];</span>
<span class="nc" id="L306">            colorTable[j++] = blue[i];</span>
        }

<span class="nc" id="L309">        return colorTable;</span>
    }

    protected abstract void mergeNativeTree(Node root)
      throws IIOInvalidTreeException;

   protected abstract void mergeStandardTree(Node root)
      throws IIOInvalidTreeException;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>