<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>GIFWritableStreamMetadata.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Foo</a> &gt; <a href="index.html" class="el_package">com.sun.imageio.plugins.gif</a> &gt; <span class="el_source">GIFWritableStreamMetadata.java</span></div><h1>GIFWritableStreamMetadata.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2005, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.imageio.plugins.gif;

/*
 * The source for this class was copied verbatim from the source for
 * package com.sun.imageio.plugins.gif.GIFImageMetadata and then modified
 * to make the class read-write capable.
 */

import javax.imageio.ImageTypeSpecifier;
import javax.imageio.metadata.IIOInvalidTreeException;
import javax.imageio.metadata.IIOMetadata;
import javax.imageio.metadata.IIOMetadataNode;
import javax.imageio.metadata.IIOMetadataFormat;
import javax.imageio.metadata.IIOMetadataFormatImpl;
import org.w3c.dom.Node;

class GIFWritableStreamMetadata extends GIFStreamMetadata {

    // package scope
    static final String
    NATIVE_FORMAT_NAME = &quot;javax_imageio_gif_stream_1.0&quot;;

    public GIFWritableStreamMetadata() {
<span class="nc" id="L49">        super(true,</span>
              NATIVE_FORMAT_NAME,
              &quot;com.sun.imageio.plugins.gif.GIFStreamMetadataFormat&quot;, // XXX J2SE
              null, null);

        // initialize metadata fields by default values
<span class="nc" id="L55">        reset();</span>
<span class="nc" id="L56">    }</span>

    public boolean isReadOnly() {
<span class="nc" id="L59">        return false;</span>
    }

    public void mergeTree(String formatName, Node root)
      throws IIOInvalidTreeException {
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (formatName.equals(nativeMetadataFormatName)) {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (root == null) {</span>
<span class="nc" id="L66">                throw new IllegalArgumentException(&quot;root == null!&quot;);</span>
            }
<span class="nc" id="L68">            mergeNativeTree(root);</span>
<span class="nc" id="L69">        } else if (formatName.equals</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                   (IIOMetadataFormatImpl.standardMetadataFormatName)) {</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (root == null) {</span>
<span class="nc" id="L72">                throw new IllegalArgumentException(&quot;root == null!&quot;);</span>
            }
<span class="nc" id="L74">            mergeStandardTree(root);</span>
        } else {
<span class="nc" id="L76">            throw new IllegalArgumentException(&quot;Not a recognized format!&quot;);</span>
        }
<span class="nc" id="L78">    }</span>

    public void reset() {
<span class="nc" id="L81">        version = null;</span>

<span class="nc" id="L83">        logicalScreenWidth = UNDEFINED_INTEGER_VALUE;</span>
<span class="nc" id="L84">        logicalScreenHeight = UNDEFINED_INTEGER_VALUE;</span>
<span class="nc" id="L85">        colorResolution = UNDEFINED_INTEGER_VALUE;</span>
<span class="nc" id="L86">        pixelAspectRatio = 0;</span>

<span class="nc" id="L88">        backgroundColorIndex = 0;</span>
<span class="nc" id="L89">        sortFlag = false;</span>
<span class="nc" id="L90">        globalColorTable = null;</span>
<span class="nc" id="L91">    }</span>

    protected void mergeNativeTree(Node root) throws IIOInvalidTreeException {
<span class="nc" id="L94">        Node node = root;</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (!node.getNodeName().equals(nativeMetadataFormatName)) {</span>
<span class="nc" id="L96">            fatal(node, &quot;Root must be &quot; + nativeMetadataFormatName);</span>
        }

<span class="nc" id="L99">        node = node.getFirstChild();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        while (node != null) {</span>
<span class="nc" id="L101">            String name = node.getNodeName();</span>

<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (name.equals(&quot;Version&quot;)) {</span>
<span class="nc" id="L104">                version = getStringAttribute(node, &quot;value&quot;, null,</span>
                                             true, versionStrings);
<span class="nc bnc" id="L106" title="All 2 branches missed.">            } else if (name.equals(&quot;LogicalScreenDescriptor&quot;)) {</span>
                /* NB: At the moment we use empty strings to support undefined
                 * integer values in tree representation.
                 * We need to add better support for undefined/default values
                 * later.
                 */
<span class="nc" id="L112">                logicalScreenWidth = getIntAttribute(node,</span>
                                                     &quot;logicalScreenWidth&quot;,
                                                     UNDEFINED_INTEGER_VALUE,
                                                     true,
                                                     true, 1, 65535);

<span class="nc" id="L118">                logicalScreenHeight = getIntAttribute(node,</span>
                                                      &quot;logicalScreenHeight&quot;,
                                                      UNDEFINED_INTEGER_VALUE,
                                                      true,
                                                      true, 1, 65535);

<span class="nc" id="L124">                colorResolution = getIntAttribute(node,</span>
                                                  &quot;colorResolution&quot;,
                                                  UNDEFINED_INTEGER_VALUE,
                                                  true,
                                                  true, 1, 8);

<span class="nc" id="L130">                pixelAspectRatio = getIntAttribute(node,</span>
                                                   &quot;pixelAspectRatio&quot;,
                                                   0, true,
                                                   true, 0, 255);
<span class="nc bnc" id="L134" title="All 2 branches missed.">            } else if (name.equals(&quot;GlobalColorTable&quot;)) {</span>
<span class="nc" id="L135">                int sizeOfGlobalColorTable =</span>
<span class="nc" id="L136">                    getIntAttribute(node, &quot;sizeOfGlobalColorTable&quot;,</span>
                                    true, 2, 256);
<span class="nc bnc" id="L138" title="All 16 branches missed.">                if (sizeOfGlobalColorTable != 2 &amp;&amp;</span>
                   sizeOfGlobalColorTable != 4 &amp;&amp;
                   sizeOfGlobalColorTable != 8 &amp;&amp;
                   sizeOfGlobalColorTable != 16 &amp;&amp;
                   sizeOfGlobalColorTable != 32 &amp;&amp;
                   sizeOfGlobalColorTable != 64 &amp;&amp;
                   sizeOfGlobalColorTable != 128 &amp;&amp;
                   sizeOfGlobalColorTable != 256) {
<span class="nc" id="L146">                    fatal(node,</span>
                          &quot;Bad value for GlobalColorTable attribute sizeOfGlobalColorTable!&quot;);
                }

<span class="nc" id="L150">                backgroundColorIndex = getIntAttribute(node,</span>
                                                       &quot;backgroundColorIndex&quot;,
                                                       0, true,
                                                       true, 0, 255);

<span class="nc" id="L155">                sortFlag = getBooleanAttribute(node, &quot;sortFlag&quot;, false, true);</span>

<span class="nc" id="L157">                globalColorTable = getColorTable(node, &quot;ColorTableEntry&quot;,</span>
                                                 true, sizeOfGlobalColorTable);
<span class="nc" id="L159">            } else {</span>
<span class="nc" id="L160">                fatal(node, &quot;Unknown child of root node!&quot;);</span>
            }

<span class="nc" id="L163">            node = node.getNextSibling();</span>
<span class="nc" id="L164">        }</span>
<span class="nc" id="L165">    }</span>

    protected void mergeStandardTree(Node root)
      throws IIOInvalidTreeException {
<span class="nc" id="L169">        Node node = root;</span>
<span class="nc" id="L170">        if (!node.getNodeName()</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            .equals(IIOMetadataFormatImpl.standardMetadataFormatName)) {</span>
<span class="nc" id="L172">            fatal(node, &quot;Root must be &quot; +</span>
                  IIOMetadataFormatImpl.standardMetadataFormatName);
        }

<span class="nc" id="L176">        node = node.getFirstChild();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        while (node != null) {</span>
<span class="nc" id="L178">            String name = node.getNodeName();</span>

<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (name.equals(&quot;Chroma&quot;)) {</span>
<span class="nc" id="L181">                Node childNode = node.getFirstChild();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                while(childNode != null) {</span>
<span class="nc" id="L183">                    String childName = childNode.getNodeName();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                    if (childName.equals(&quot;Palette&quot;)) {</span>
<span class="nc" id="L185">                        globalColorTable = getColorTable(childNode,</span>
                                                         &quot;PaletteEntry&quot;,
                                                         false, -1);

<span class="nc bnc" id="L189" title="All 2 branches missed.">                    } else if (childName.equals(&quot;BackgroundIndex&quot;)) {</span>
<span class="nc" id="L190">                        backgroundColorIndex = getIntAttribute(childNode,</span>
                                                               &quot;value&quot;,
                                                               -1, true,
                                                               true, 0, 255);
                    }
<span class="nc" id="L195">                    childNode = childNode.getNextSibling();</span>
<span class="nc" id="L196">                }</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">            } else if (name.equals(&quot;Data&quot;)) {</span>
<span class="nc" id="L198">                Node childNode = node.getFirstChild();</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                while(childNode != null) {</span>
<span class="nc" id="L200">                    String childName = childNode.getNodeName();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                    if (childName.equals(&quot;BitsPerSample&quot;)) {</span>
<span class="nc" id="L202">                        colorResolution = getIntAttribute(childNode,</span>
                                                          &quot;value&quot;,
                                                          -1, true,
                                                          true, 1, 8);
<span class="nc" id="L206">                        break;</span>
                    }
<span class="nc" id="L208">                    childNode = childNode.getNextSibling();</span>
<span class="nc" id="L209">                }</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            } else if (name.equals(&quot;Dimension&quot;)) {</span>
<span class="nc" id="L211">                Node childNode = node.getFirstChild();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                while(childNode != null) {</span>
<span class="nc" id="L213">                    String childName = childNode.getNodeName();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                    if (childName.equals(&quot;PixelAspectRatio&quot;)) {</span>
<span class="nc" id="L215">                        float aspectRatio = getFloatAttribute(childNode,</span>
                                                              &quot;value&quot;);
<span class="nc bnc" id="L217" title="All 2 branches missed.">                        if (aspectRatio == 1.0F) {</span>
<span class="nc" id="L218">                            pixelAspectRatio = 0;</span>
                        } else {
<span class="nc" id="L220">                            int ratio = (int)(aspectRatio*64.0F - 15.0F);</span>
<span class="nc" id="L221">                            pixelAspectRatio =</span>
<span class="nc" id="L222">                                Math.max(Math.min(ratio, 255), 0);</span>
                        }
<span class="nc bnc" id="L224" title="All 2 branches missed.">                    } else if (childName.equals(&quot;HorizontalScreenSize&quot;)) {</span>
<span class="nc" id="L225">                        logicalScreenWidth = getIntAttribute(childNode,</span>
                                                             &quot;value&quot;,
                                                             -1, true,
                                                             true, 1, 65535);
<span class="nc bnc" id="L229" title="All 2 branches missed.">                    } else if (childName.equals(&quot;VerticalScreenSize&quot;)) {</span>
<span class="nc" id="L230">                        logicalScreenHeight = getIntAttribute(childNode,</span>
                                                              &quot;value&quot;,
                                                              -1, true,
                                                              true, 1, 65535);
                    }
<span class="nc" id="L235">                    childNode = childNode.getNextSibling();</span>
<span class="nc" id="L236">                }</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            } else if (name.equals(&quot;Document&quot;)) {</span>
<span class="nc" id="L238">                Node childNode = node.getFirstChild();</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                while(childNode != null) {</span>
<span class="nc" id="L240">                    String childName = childNode.getNodeName();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">                    if (childName.equals(&quot;FormatVersion&quot;)) {</span>
<span class="nc" id="L242">                        String formatVersion =</span>
<span class="nc" id="L243">                            getStringAttribute(childNode, &quot;value&quot;, null,</span>
                                               true, null);
<span class="nc bnc" id="L245" title="All 2 branches missed.">                        for (int i = 0; i &lt; versionStrings.length; i++) {</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">                            if (formatVersion.equals(versionStrings[i])) {</span>
<span class="nc" id="L247">                                version = formatVersion;</span>
<span class="nc" id="L248">                                break;</span>
                            }
                        }
<span class="nc" id="L251">                        break;</span>
                    }
<span class="nc" id="L253">                    childNode = childNode.getNextSibling();</span>
<span class="nc" id="L254">                }</span>
            }

<span class="nc" id="L257">            node = node.getNextSibling();</span>
<span class="nc" id="L258">        }</span>
<span class="nc" id="L259">    }</span>

    public void setFromTree(String formatName, Node root)
        throws IIOInvalidTreeException
    {
<span class="nc" id="L264">        reset();</span>
<span class="nc" id="L265">        mergeTree(formatName, root);</span>
<span class="nc" id="L266">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>