<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Transforms.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JDK</a> &gt; <a href="index.html" class="el_package">com.sun.org.apache.xml.internal.security.transforms</a> &gt; <span class="el_source">Transforms.java</span></div><h1>Transforms.java</h1><pre class="source lang-java linenums">/*
 * reserved comment block
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package com.sun.org.apache.xml.internal.security.transforms;

import java.io.IOException;
import java.io.OutputStream;

import com.sun.org.apache.xml.internal.security.c14n.CanonicalizationException;
import com.sun.org.apache.xml.internal.security.c14n.Canonicalizer;
import com.sun.org.apache.xml.internal.security.c14n.InvalidCanonicalizerException;
import com.sun.org.apache.xml.internal.security.exceptions.XMLSecurityException;
import com.sun.org.apache.xml.internal.security.signature.XMLSignatureException;
import com.sun.org.apache.xml.internal.security.signature.XMLSignatureInput;
import com.sun.org.apache.xml.internal.security.utils.Constants;
import com.sun.org.apache.xml.internal.security.utils.SignatureElementProxy;
import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
import org.w3c.dom.DOMException;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;

/**
 * Holder of the {@link com.sun.org.apache.xml.internal.security.transforms.Transform} steps to
 * be performed on the data.
 * The input to the first Transform is the result of dereferencing the
 * &lt;code&gt;URI&lt;/code&gt; attribute of the &lt;code&gt;Reference&lt;/code&gt; element.
 * The output from the last Transform is the input for the
 * &lt;code&gt;DigestMethod algorithm&lt;/code&gt;
 *
 * @author Christian Geuer-Pollmann
 * @see Transform
 * @see com.sun.org.apache.xml.internal.security.signature.Reference
 */
public class Transforms extends SignatureElementProxy {

    /** Canonicalization - Required Canonical XML (omits comments) */
    public static final String TRANSFORM_C14N_OMIT_COMMENTS
        = Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS;

    /** Canonicalization - Recommended Canonical XML with Comments */
    public static final String TRANSFORM_C14N_WITH_COMMENTS
        = Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS;

    /** Canonicalization - Required Canonical XML 1.1 (omits comments) */
    public static final String TRANSFORM_C14N11_OMIT_COMMENTS
        = Canonicalizer.ALGO_ID_C14N11_OMIT_COMMENTS;

    /** Canonicalization - Recommended Canonical XML 1.1 with Comments */
    public static final String TRANSFORM_C14N11_WITH_COMMENTS
        = Canonicalizer.ALGO_ID_C14N11_WITH_COMMENTS;

    /** Canonicalization - Required Exclusive Canonicalization (omits comments) */
    public static final String TRANSFORM_C14N_EXCL_OMIT_COMMENTS
        = Canonicalizer.ALGO_ID_C14N_EXCL_OMIT_COMMENTS;

    /** Canonicalization - Recommended Exclusive Canonicalization with Comments */
    public static final String TRANSFORM_C14N_EXCL_WITH_COMMENTS
        = Canonicalizer.ALGO_ID_C14N_EXCL_WITH_COMMENTS;

    /** Transform - Optional XSLT */
    public static final String TRANSFORM_XSLT
        = &quot;http://www.w3.org/TR/1999/REC-xslt-19991116&quot;;

    /** Transform - Required base64 decoding */
    public static final String TRANSFORM_BASE64_DECODE
        = Constants.SignatureSpecNS + &quot;base64&quot;;

    /** Transform - Recommended XPath */
    public static final String TRANSFORM_XPATH
        = &quot;http://www.w3.org/TR/1999/REC-xpath-19991116&quot;;

    /** Transform - Required Enveloped Signature */
    public static final String TRANSFORM_ENVELOPED_SIGNATURE
        = Constants.SignatureSpecNS + &quot;enveloped-signature&quot;;

    /** Transform - XPointer */
    public static final String TRANSFORM_XPOINTER
        = &quot;http://www.w3.org/TR/2001/WD-xptr-20010108&quot;;

    /** Transform - XPath Filter */
    public static final String TRANSFORM_XPATH2FILTER
        = &quot;http://www.w3.org/2002/06/xmldsig-filter2&quot;;

    /** {@link org.apache.commons.logging} logging facility */
<span class="nc" id="L105">    private static java.util.logging.Logger log =</span>
<span class="nc" id="L106">        java.util.logging.Logger.getLogger(Transforms.class.getName());</span>

    private Element[] transforms;

<span class="nc" id="L110">    protected Transforms() { };</span>

    private boolean secureValidation;

    /**
     * Constructs {@link Transforms}.
     *
     * @param doc the {@link Document} in which &lt;code&gt;XMLSignature&lt;/code&gt; will
     * be placed
     */
    public Transforms(Document doc) {
<span class="nc" id="L121">        super(doc);</span>
<span class="nc" id="L122">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L123">    }</span>

    /**
     * Constructs {@link Transforms} from {@link Element} which is
     * &lt;code&gt;Transforms&lt;/code&gt; Element
     *
     * @param element  is &lt;code&gt;Transforms&lt;/code&gt; element
     * @param BaseURI the URI where the XML instance was stored
     * @throws DOMException
     * @throws InvalidTransformException
     * @throws TransformationException
     * @throws XMLSecurityException
     * @throws XMLSignatureException
     */
    public Transforms(Element element, String BaseURI)
        throws DOMException, XMLSignatureException, InvalidTransformException,
            TransformationException, XMLSecurityException {
<span class="nc" id="L140">        super(element, BaseURI);</span>

<span class="nc" id="L142">        int numberOfTransformElems = this.getLength();</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (numberOfTransformElems == 0) {</span>
            // At least one Transform element must be present. Bad.
<span class="nc" id="L146">            Object exArgs[] = { Constants._TAG_TRANSFORM, Constants._TAG_TRANSFORMS };</span>

<span class="nc" id="L148">            throw new TransformationException(&quot;xml.WrongContent&quot;, exArgs);</span>
        }
<span class="nc" id="L150">    }</span>

    /**
     * Set whether secure validation is enabled or not. The default is false.
     */
    public void setSecureValidation(boolean secureValidation) {
<span class="nc" id="L156">        this.secureValidation = secureValidation;</span>
<span class="nc" id="L157">    }</span>

    /**
     * Adds the &lt;code&gt;Transform&lt;/code&gt; with the specified &lt;code&gt;Transform
     * algorithm URI&lt;/code&gt;
     *
     * @param transformURI the URI form of transform that indicates which
     * transformation is applied to data
     * @throws TransformationException
     */
    public void addTransform(String transformURI) throws TransformationException {
        try {
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L170">                log.log(java.util.logging.Level.FINE, &quot;Transforms.addTransform(&quot; + transformURI + &quot;)&quot;);</span>
            }

<span class="nc" id="L173">            Transform transform = new Transform(this.doc, transformURI);</span>

<span class="nc" id="L175">            this.addTransform(transform);</span>
<span class="nc" id="L176">        } catch (InvalidTransformException ex) {</span>
<span class="nc" id="L177">            throw new TransformationException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L178">        }</span>
<span class="nc" id="L179">    }</span>

    /**
     * Adds the &lt;code&gt;Transform&lt;/code&gt; with the specified &lt;code&gt;Transform
     * algorithm URI&lt;/code&gt;
     *
     * @param transformURI the URI form of transform that indicates which
     * transformation is applied to data
     * @param contextElement
     * @throws TransformationException
     */
    public void addTransform(String transformURI, Element contextElement)
       throws TransformationException {
        try {
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L194">                log.log(java.util.logging.Level.FINE, &quot;Transforms.addTransform(&quot; + transformURI + &quot;)&quot;);</span>
            }

<span class="nc" id="L197">            Transform transform = new Transform(this.doc, transformURI, contextElement);</span>

<span class="nc" id="L199">            this.addTransform(transform);</span>
<span class="nc" id="L200">        } catch (InvalidTransformException ex) {</span>
<span class="nc" id="L201">            throw new TransformationException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L202">        }</span>
<span class="nc" id="L203">    }</span>

    /**
     * Adds the &lt;code&gt;Transform&lt;/code&gt; with the specified &lt;code&gt;Transform
     * algorithm URI&lt;/code&gt;.
     *
     * @param transformURI the URI form of transform that indicates which
     * transformation is applied to data
     * @param contextNodes
     * @throws TransformationException
     */
    public void addTransform(String transformURI, NodeList contextNodes)
       throws TransformationException {

        try {
<span class="nc" id="L218">            Transform transform = new Transform(this.doc, transformURI, contextNodes);</span>
<span class="nc" id="L219">            this.addTransform(transform);</span>
<span class="nc" id="L220">        } catch (InvalidTransformException ex) {</span>
<span class="nc" id="L221">            throw new TransformationException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L222">        }</span>
<span class="nc" id="L223">    }</span>

    /**
     * Adds a user-provided Transform step.
     *
     * @param transform {@link Transform} object
     */
    private void addTransform(Transform transform) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L232">            log.log(java.util.logging.Level.FINE, &quot;Transforms.addTransform(&quot; + transform.getURI() + &quot;)&quot;);</span>
        }

<span class="nc" id="L235">        Element transformElement = transform.getElement();</span>

<span class="nc" id="L237">        this.constructionElement.appendChild(transformElement);</span>
<span class="nc" id="L238">        XMLUtils.addReturnToElement(this.constructionElement);</span>
<span class="nc" id="L239">    }</span>

    /**
     * Applies all included &lt;code&gt;Transform&lt;/code&gt;s to xmlSignatureInput and
     * returns the result of these transformations.
     *
     * @param xmlSignatureInput the input for the &lt;code&gt;Transform&lt;/code&gt;s
     * @return the result of the &lt;code&gt;Transforms&lt;/code&gt;
     * @throws TransformationException
     */
    public XMLSignatureInput performTransforms(
        XMLSignatureInput xmlSignatureInput
    ) throws TransformationException {
<span class="nc" id="L252">        return performTransforms(xmlSignatureInput, null);</span>
    }

    /**
     * Applies all included &lt;code&gt;Transform&lt;/code&gt;s to xmlSignatureInput and
     * returns the result of these transformations.
     *
     * @param xmlSignatureInput the input for the &lt;code&gt;Transform&lt;/code&gt;s
     * @param os where to output the last transformation.
     * @return the result of the &lt;code&gt;Transforms&lt;/code&gt;
     * @throws TransformationException
     */
    public XMLSignatureInput performTransforms(
        XMLSignatureInput xmlSignatureInput, OutputStream os
    ) throws TransformationException {
        try {
<span class="nc" id="L268">            int last = this.getLength() - 1;</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">            for (int i = 0; i &lt; last; i++) {</span>
<span class="nc" id="L270">                Transform t = this.item(i);</span>
<span class="nc" id="L271">                String uri = t.getURI();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                if (log.isLoggable(java.util.logging.Level.FINE)) {</span>
<span class="nc" id="L273">                    log.log(java.util.logging.Level.FINE, &quot;Perform the (&quot; + i + &quot;)th &quot; + uri + &quot; transform&quot;);</span>
                }
<span class="nc" id="L275">                checkSecureValidation(t);</span>
<span class="nc" id="L276">                xmlSignatureInput = t.performTransform(xmlSignatureInput);</span>
            }
<span class="nc bnc" id="L278" title="All 2 branches missed.">            if (last &gt;= 0) {</span>
<span class="nc" id="L279">                Transform t = this.item(last);</span>
<span class="nc" id="L280">                checkSecureValidation(t);</span>
<span class="nc" id="L281">                xmlSignatureInput = t.performTransform(xmlSignatureInput, os);</span>
            }

<span class="nc" id="L284">            return xmlSignatureInput;</span>
<span class="nc" id="L285">        } catch (IOException ex) {</span>
<span class="nc" id="L286">            throw new TransformationException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L287">        } catch (CanonicalizationException ex) {</span>
<span class="nc" id="L288">            throw new TransformationException(&quot;empty&quot;, ex);</span>
<span class="nc" id="L289">        } catch (InvalidCanonicalizerException ex) {</span>
<span class="nc" id="L290">            throw new TransformationException(&quot;empty&quot;, ex);</span>
        }
    }

    private void checkSecureValidation(Transform transform) throws TransformationException {
<span class="nc" id="L295">        String uri = transform.getURI();</span>
<span class="nc bnc" id="L296" title="All 4 branches missed.">        if (secureValidation &amp;&amp; Transforms.TRANSFORM_XSLT.equals(uri)) {</span>
<span class="nc" id="L297">            Object exArgs[] = { uri };</span>

<span class="nc" id="L299">            throw new TransformationException(</span>
                &quot;signature.Transform.ForbiddenTransform&quot;, exArgs
            );
        }
<span class="nc" id="L303">    }</span>

    /**
     * Return the nonnegative number of transformations.
     *
     * @return the number of transformations
     */
    public int getLength() {
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if (transforms == null) {</span>
<span class="nc" id="L312">            transforms =</span>
<span class="nc" id="L313">                XMLUtils.selectDsNodes(this.constructionElement.getFirstChild(), &quot;Transform&quot;);</span>
        }
<span class="nc" id="L315">        return transforms.length;</span>
    }

    /**
     * Return the &lt;it&gt;i&lt;/it&gt;&lt;sup&gt;th&lt;/sup&gt; &lt;code&gt;{@link Transform}&lt;/code&gt;.
     * Valid &lt;code&gt;i&lt;/code&gt; values are 0 to &lt;code&gt;{@link #getLength}-1&lt;/code&gt;.
     *
     * @param i index of {@link Transform} to return
     * @return the &lt;it&gt;i&lt;/it&gt;&lt;sup&gt;th&lt;/sup&gt; Transform
     * @throws TransformationException
     */
    public Transform item(int i) throws TransformationException {
        try {
<span class="nc bnc" id="L328" title="All 2 branches missed.">            if (transforms == null) {</span>
<span class="nc" id="L329">                transforms =</span>
<span class="nc" id="L330">                    XMLUtils.selectDsNodes(this.constructionElement.getFirstChild(), &quot;Transform&quot;);</span>
            }
<span class="nc" id="L332">            return new Transform(transforms[i], this.baseURI);</span>
<span class="nc" id="L333">        } catch (XMLSecurityException ex) {</span>
<span class="nc" id="L334">            throw new TransformationException(&quot;empty&quot;, ex);</span>
        }
    }

    /** @inheritDoc */
    public String getBaseLocalName() {
<span class="nc" id="L340">        return Constants._TAG_TRANSFORMS;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312031056</span></div></body></html>